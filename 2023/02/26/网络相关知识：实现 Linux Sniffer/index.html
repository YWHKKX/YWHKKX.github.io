<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="Sniffer 总述Sniffer，中文可以翻译为嗅探器，也叫抓数据包软件，是一种基于被动侦听原理的网络分析方式  使用这种技术方式，可以监视网络的状态、数据流动情况以及网络上传输的信息  与 Sniffer 相关的知识网络信息通过 TCP&#x2F;IP 来定位网络中计算机的位置：  应用程序的 IP 报文被封装成以太网帧（底层链路层报文上面的一层报文，包含有源地址，报文和一些需要用来传送至目标主机的信息">
<meta property="og:type" content="article">
<meta property="og:title" content="网络相关知识：实现 Linux Sniffer">
<meta property="og:url" content="http://example.com/2023/02/26/%E7%BD%91%E7%BB%9C%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%EF%BC%9A%E5%AE%9E%E7%8E%B0%20Linux%20Sniffer/index.html">
<meta property="og:site_name" content="Pwn进你的心">
<meta property="og:description" content="Sniffer 总述Sniffer，中文可以翻译为嗅探器，也叫抓数据包软件，是一种基于被动侦听原理的网络分析方式  使用这种技术方式，可以监视网络的状态、数据流动情况以及网络上传输的信息  与 Sniffer 相关的知识网络信息通过 TCP&#x2F;IP 来定位网络中计算机的位置：  应用程序的 IP 报文被封装成以太网帧（底层链路层报文上面的一层报文，包含有源地址，报文和一些需要用来传送至目标主机的信息">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2023/02/26/%E7%BD%91%E7%BB%9C%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%EF%BC%9A%E5%AE%9E%E7%8E%B0%20Linux%20Sniffer/1677393531035.png">
<meta property="article:published_time" content="2023-02-26T14:25:38.000Z">
<meta property="article:modified_time" content="2023-03-08T12:32:28.000Z">
<meta property="article:author" content="yhellow">
<meta property="article:tag" content="coding">
<meta property="article:tag" content="Net Knowledge">
<meta property="article:tag" content="Sniffer">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2023/02/26/%E7%BD%91%E7%BB%9C%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%EF%BC%9A%E5%AE%9E%E7%8E%B0%20Linux%20Sniffer/1677393531035.png">

<link rel="canonical" href="http://example.com/2023/02/26/%E7%BD%91%E7%BB%9C%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%EF%BC%9A%E5%AE%9E%E7%8E%B0%20Linux%20Sniffer/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>网络相关知识：实现 Linux Sniffer | Pwn进你的心</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Pwn进你的心</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/02/26/%E7%BD%91%E7%BB%9C%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%EF%BC%9A%E5%AE%9E%E7%8E%B0%20Linux%20Sniffer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          网络相关知识：实现 Linux Sniffer
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-02-26 22:25:38" itemprop="dateCreated datePublished" datetime="2023-02-26T22:25:38+08:00">2023-02-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-08 20:32:28" itemprop="dateModified" datetime="2023-03-08T20:32:28+08:00">2023-03-08</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>13k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>12 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="Sniffer-总述"><a href="#Sniffer-总述" class="headerlink" title="Sniffer 总述"></a>Sniffer 总述</h2><p>Sniffer，中文可以翻译为嗅探器，也叫抓数据包软件，是一种基于被动侦听原理的网络分析方式</p>
<ul>
<li>使用这种技术方式，可以监视网络的状态、数据流动情况以及网络上传输的信息</li>
</ul>
<h2 id="与-Sniffer-相关的知识"><a href="#与-Sniffer-相关的知识" class="headerlink" title="与 Sniffer 相关的知识"></a>与 Sniffer 相关的知识</h2><p>网络信息通过 <code>TCP/IP</code> 来定位网络中计算机的位置：</p>
<ul>
<li>应用程序的 IP 报文被封装成以太网帧（底层链路层报文上面的一层报文，包含有源地址，报文和一些需要用来传送至目标主机的信息）</li>
<li>目的 IP 地址对应着一个6字节的目的以太网址（MAC 地址)，它们之间通过 ARP/RARP 协议进行映射<ul>
<li>ARP（Address Resolution Protocol）地址解析协议：IP地址转换为MAC物理地址</li>
<li>RARP（Reverse Address Resolution Protocol）反向地址转换协议：将MAC物理地址转换为IP地址</li>
</ul>
</li>
<li>包含着以太网帧的报文从源主机传输到目的主机，中间经过一些网络设备，如交换机，路由器等</li>
</ul>
<p>源主机发出的太网帧基于广播方式传播（网络中的所有网卡都能看到它的传输）</p>
<ul>
<li>每个网卡会检查帧开始的6个字节（目的主机的 MAC 地址），但是只有一个网卡会发现自己的地址和其相符合，然后它接收这个帧</li>
<li>读取该太网帧中的 IP 报文</li>
<li>网络驱动程序会检查帧中报文头部的协议标识，以确定接收数据的上层协议 </li>
<li>然后通过对应的网络协议栈传送至接收的应用程序<ul>
<li>大多数情况下，上层就是 IP 协议，所以接收机制将去掉 IP 报文头部，然后把剩下的传送至 UDP 或者 TCP 接收机制，这些协议将把报文送到 <code>socket-handling</code> 机制</li>
<li>然后把报文数据变成应用程序可接收的方式发送出去，在这个过程中，报文将失去所有的和其有关的网络信息（比如：IP，MAC，端口号，IP 选择，TCP 参数 ……），所以如果目的主机没有一个包含正确参数的打开端口，那么这个报文将被丢弃而且永远不会被送到应用层去</li>
</ul>
</li>
</ul>
<p><strong>数据传输经过的各层协议过程</strong></p>
<img src="/2023/02/26/%E7%BD%91%E7%BB%9C%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%EF%BC%9A%E5%AE%9E%E7%8E%B0%20Linux%20Sniffer/1677393531035.png" class width="1677393531035"> 
<ul>
<li>ARP/RARP 用于实现 MAC/IP 之间的切换 </li>
</ul>
<p><strong>太网帧大致结构</strong></p>
<figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">[</span><span class="comment">MAC头</span><span class="string">,</span>--<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">&#123;数据&#125;</span>--<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="string">,</span><span class="comment">MAC尾</span><span class="title">]</span><span class="comment">		</span>&gt;&gt;&gt;&gt; <span class="comment">以太网驱动</span></span><br><span class="line">--<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="title">[</span><span class="comment">IP头</span><span class="string">,</span>--<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">&#123;数据&#125;</span>--<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="title">]</span>--<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">	</span>&gt;&gt;&gt;&gt;&gt; <span class="comment">IP</span></span><br><span class="line">--<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="title">[</span><span class="comment">TCP/UDP头</span><span class="string">,</span>--<span class="literal">-</span><span class="literal">-</span><span class="comment">&#123;应用数据&#125;</span>--<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="title">]</span>--<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">		</span>&gt;&gt;&gt; <span class="comment">TCP/UDP</span></span><br><span class="line">--<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="title">[</span><span class="comment">应用软件头</span><span class="string">,</span><span class="comment">用户数据</span><span class="title">]</span>--<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">		</span>&gt;&gt;&gt;&gt; <span class="comment">应用程序</span></span><br></pre></td></tr></table></figure>
<p>通信过程中，每层协议都要加上一个数据首部（用于存储信息），称为封装 Encapsulation，常见头部如下：</p>
<ul>
<li>以太网帧头部 - 14字节（也叫 MAC 头部）：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __UAPI_DEF_ETHHDR</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __UAPI_DEF_ETHHDR		1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> __UAPI_DEF_ETHHDR</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ethhdr</span> &#123;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span>	h_dest[ETH_ALEN];	<span class="comment">/* 目标以太网地址 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span>	h_source[ETH_ALEN];	<span class="comment">/* 源以太网地址 */</span></span><br><span class="line">	__be16		h_proto;		<span class="comment">/* 数据包类型ID字段 */</span></span><br><span class="line">&#125; __attribute__((packed));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li>IP 头部 - 20~60字节（取决于有没有 options）：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">iphdr</span> &#123;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(__LITTLE_ENDIAN_BITFIELD)</span></span><br><span class="line">	__u8	ihl:<span class="number">4</span>,			<span class="comment">/* 首部长度 */</span></span><br><span class="line">		version:<span class="number">4</span>;			<span class="comment">/* 版本(IPv4/IPv6) */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined (__BIG_ENDIAN_BITFIELD)</span></span><br><span class="line">	__u8	version:<span class="number">4</span>,		<span class="comment">/* 版本(IPv4/IPv6) */</span></span><br><span class="line">  		ihl:<span class="number">4</span>;				<span class="comment">/* 首部长度 */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">error</span>	<span class="meta-string">&quot;Please fix &lt;asm/byteorder.h&gt;&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	__u8	tos;			<span class="comment">/* 服务类型 */</span></span><br><span class="line">	__be16	tot_len;		<span class="comment">/* 总长度(指首部加上数据的总长度) */</span></span><br><span class="line">	__be16	id;				<span class="comment">/* 标识(标识主机发送的每一份数据报) */</span></span><br><span class="line">	__be16	frag_off;		<span class="comment">/* 标志-偏移量 */</span></span><br><span class="line">	__u8	ttl;			<span class="comment">/* 生存时间(数据报在网络中的寿命) */</span></span><br><span class="line">	__u8	protocol;		<span class="comment">/* 协议(数据报携带的数据时使用何种协议) */</span></span><br><span class="line">	__sum16	check;			<span class="comment">/* 首部校验和(只校验数据报的首部) */</span></span><br><span class="line">	__be32	saddr;			<span class="comment">/* 源地址(发送方IP地址) */</span></span><br><span class="line">	__be32	daddr;			<span class="comment">/* 目标地址(接收方IP地址) */</span></span><br><span class="line">	<span class="comment">/*The options start here. */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>UDP 头部 - 20字节（8字节真头部，12字节假头部）：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">udphdr</span> &#123;</span></span><br><span class="line">	__be16	source;		<span class="comment">/* 源主机端口 */</span></span><br><span class="line">	__be16	dest;		<span class="comment">/* 目标主机端口 */</span></span><br><span class="line">	__be16	len;		<span class="comment">/* UDP长度 */</span></span><br><span class="line">	__sum16	check;		<span class="comment">/* UDP效验和 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>TCP 头部 - 20~60字节（取决于有没有 options）：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tcphdr</span> &#123;</span></span><br><span class="line">	__be16	source;		<span class="comment">/* 源主机端口 */</span></span><br><span class="line">	__be16	dest;		<span class="comment">/* 目标主机端口 */</span></span><br><span class="line">	__be32	seq;		<span class="comment">/* 队列数目 */</span></span><br><span class="line">	__be32	ack_seq;	<span class="comment">/* 确认编号 */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(__LITTLE_ENDIAN_BITFIELD)</span></span><br><span class="line">	__u16	res1:<span class="number">4</span>,</span><br><span class="line">		doff:<span class="number">4</span>,</span><br><span class="line">		fin:<span class="number">1</span>,</span><br><span class="line">		syn:<span class="number">1</span>,</span><br><span class="line">		rst:<span class="number">1</span>,</span><br><span class="line">		psh:<span class="number">1</span>,</span><br><span class="line">		ack:<span class="number">1</span>,</span><br><span class="line">		urg:<span class="number">1</span>,</span><br><span class="line">		ece:<span class="number">1</span>,</span><br><span class="line">		cwr:<span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined(__BIG_ENDIAN_BITFIELD)</span></span><br><span class="line">	__u16	doff:<span class="number">4</span>,</span><br><span class="line">		res1:<span class="number">4</span>,</span><br><span class="line">		cwr:<span class="number">1</span>,</span><br><span class="line">		ece:<span class="number">1</span>,</span><br><span class="line">		urg:<span class="number">1</span>,</span><br><span class="line">		ack:<span class="number">1</span>,</span><br><span class="line">		psh:<span class="number">1</span>,</span><br><span class="line">		rst:<span class="number">1</span>,</span><br><span class="line">		syn:<span class="number">1</span>,</span><br><span class="line">		fin:<span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">error</span>	<span class="meta-string">&quot;Adjust your &lt;asm/byteorder.h&gt; defines&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>	</span></span><br><span class="line">	__be16	window;	</span><br><span class="line">	__sum16	check;		<span class="comment">/* 效验和 */</span></span><br><span class="line">	__be16	urg_ptr;	<span class="comment">/* 紧急指针 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>网络工具 netwox 简述</strong></p>
<p>netwox 是由 lauconstantin 开发的一款网络工具集，适用群体为网络管理员和网络黑客，它可以创造任意的 TCP、UDP 和 IP 数据报文，以实现网络欺骗，并且可以在 Linux 和 Windows 系统中运行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  Sniffer sudo netwox 32</span><br><span class="line">Ethernet________________________________________________________.</span><br><span class="line">| 00:0C:29:BF:5F:3F-&gt;00:08:09:0A:0B:0C type:0x0000              |</span><br><span class="line">|_______________________________________________________________|</span><br></pre></td></tr></table></figure>
<ul>
<li><code>00:0C:29:BF:5F:3F</code>：源 MAC 地址，是当前主机的 MAC 地址</li>
<li><code>00:08:09:0A:0B:0C</code>：目标 MAC 地址</li>
<li><code>0x0000</code>：以太网类型 </li>
</ul>
<p>启动 netwox 显示它提供的功能：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">➜  Sniffer netwox                                           </span><br><span class="line">Netwox toolbox version <span class="number">5.39</span><span class="number">.0</span>. Netwib library version <span class="number">5.39</span><span class="number">.0</span>.</span><br><span class="line"></span><br><span class="line">######################## MAIN MENU #########################</span><br><span class="line"> <span class="number">0</span> - leave netwox</span><br><span class="line"> <span class="number">3</span> - search tools</span><br><span class="line"> <span class="number">4</span> - display help of one tool</span><br><span class="line"> <span class="number">5</span> - run a tool selecting parameters on command line</span><br><span class="line"> <span class="number">6</span> - run a tool selecting parameters from keyboard</span><br><span class="line"> a + information</span><br><span class="line"> b + network protocol</span><br><span class="line"> c + application protocol</span><br><span class="line"> d + sniff (capture network packets)</span><br><span class="line"> e + spoof (create <span class="keyword">and</span> send packets)</span><br><span class="line"> f + record (file containing captured packets)</span><br><span class="line"> g + client</span><br><span class="line"> h + server</span><br><span class="line"> i + ping (check <span class="keyword">if</span> a computer <span class="keyword">if</span> reachable)</span><br><span class="line"> j + traceroute (obtain <span class="built_in">list</span> of gateways)</span><br><span class="line"> k + scan (computer <span class="keyword">and</span> port discovery)</span><br><span class="line"> l + network audit</span><br><span class="line"> m + <span class="function">brute <span class="title">force</span> <span class="params">(check <span class="keyword">if</span> passwords are weak)</span></span></span><br><span class="line"><span class="function"> n + remote administration</span></span><br><span class="line"><span class="function"> o + tools <span class="keyword">not</span> related to network</span></span><br><span class="line"><span class="function">Select a <span class="title">node</span> <span class="params">(key in <span class="number">03456</span>abcdefghijklmno)</span>:</span></span><br></pre></td></tr></table></figure>
<ul>
<li>这不是本篇博客的重点，以后有机会慢慢看</li>
</ul>
<p><strong>网络编程基础</strong></p>
<p>Linux 实现网络通信的核心函数 <code>socket</code> 如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">socket</span><span class="params">(<span class="keyword">int</span> domain, <span class="keyword">int</span> type, <span class="keyword">int</span> protocol)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>domain：即协议域，又称为协议族（family）<ul>
<li>常用的协议族有：AF_INET、AF_INET6、AF_LOCAL（或称AF_UNIX，Unix域socket）、AF_ROUTE</li>
<li>协议族决定了 socket 的地址类型，在通信中必须采用对应的地址：<ul>
<li>AF_INET：用 ipv4 地址（32位的）与端口号（16位的）的组合</li>
<li>AF_UNIX：用一个绝对路径名作为地址</li>
</ul>
</li>
</ul>
</li>
<li>type：指定 socket 类型<ul>
<li>常用的 socket 类型有：SOCK_STREAM、SOCK_DGRAM、SOCK_RAW、SOCK_PACKET、SOCK_SEQPACKET</li>
<li>不同 socket 类型有不同的功能：<ul>
<li>SOCK_STREAM：提供面向连接的稳定数据传输，即TCP协议　</li>
<li>OOB：在所有数据传送前必须使用 connect() 来建立连接状态　</li>
<li>SOCK_SEQPACKET：提供连续可靠的数据包连接　</li>
<li>SOCK_RDM：提供可靠的数据包连接　　</li>
<li>SOCK_PACKET：与网络驱动程序直接通信</li>
<li>SOCK_DGRAM：使用不连续不可靠的数据包连接（去除以太网报文头部）</li>
<li>SOCK_RAW：提供原始网络协议存取（让应用程序对以太网报文头部有完全的控制）</li>
</ul>
</li>
</ul>
</li>
<li>protocol：<ul>
<li>指定协议</li>
<li>常用的协议有，IPPROTO_TCP（TCP传输协议）、IPPTOTO_UDP（UDP传输协议）、IPPROTO_SCTP（STCP传输协议）、IPPROTO_TIPC（TIPC传输协议）</li>
</ul>
</li>
</ul>
<p>服务端需要 <code>bind</code> 函数来“绑定”一个端口</p>
<p>客户端需要 <code>connect</code> 函数来连接指定的服务端（通过 <code>IP:port</code>）</p>
<h2 id="实现-Sniffer"><a href="#实现-Sniffer" class="headerlink" title="实现 Sniffer"></a>实现 Sniffer</h2><p>Sniffer 需要一个 socket 去监听每个端口，得到那些没有被丢弃的报文，使用 PF_PACKET 的协议簇，应用程序可以直接利用网络驱动程序发送和接收报文，避免了原来的协议栈处理过程 </p>
<p><strong>Sniffer 案例一</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/if_ether.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> sock, n;</span><br><span class="line">    <span class="keyword">char</span> buffer[<span class="number">2048</span>];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *iphead, *ethhead;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((sock=socket(PF_PACKET, SOCK_RAW,htons(ETH_P_IP)))&lt;<span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">/* 使用PF_PACKET协议族</span></span><br><span class="line"><span class="comment">        socket类型为SOCK_RAW</span></span><br><span class="line"><span class="comment">        使用ETH_P_IP来处理IP的一组协议 */</span></span><br><span class="line">        perror(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;----------\n&quot;</span>);</span><br><span class="line">        n = recvfrom(sock,buffer,<span class="number">2048</span>,<span class="number">0</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>); <span class="comment">/* 接收数据报并存储源地址 */</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d bytes read\n&quot;</span>,n);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 检查数据包是否至少包含完整的MAC标头(14),IP标头(20)和TCP/UDP标头(8) */</span></span><br><span class="line">        <span class="keyword">if</span> (n&lt;<span class="number">42</span>) &#123;</span><br><span class="line">            perror(<span class="string">&quot;recvfrom():&quot;</span>);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Incomplete packet (errno is %d)\n&quot;</span>,errno);</span><br><span class="line">            close(sock);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ethhead = buffer;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Source MAC address: &quot;</span></span><br><span class="line">                <span class="string">&quot;%02x:%02x:%02x:%02x:%02x:%02x\n&quot;</span>,</span><br><span class="line">                ethhead[<span class="number">0</span>],ethhead[<span class="number">1</span>],ethhead[<span class="number">2</span>],</span><br><span class="line">                ethhead[<span class="number">3</span>],ethhead[<span class="number">4</span>],ethhead[<span class="number">5</span>]);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Destination MAC address: &quot;</span></span><br><span class="line">                <span class="string">&quot;%02x:%02x:%02x:%02x:%02x:%02x\n&quot;</span>,</span><br><span class="line">                ethhead[<span class="number">6</span>],ethhead[<span class="number">7</span>],ethhead[<span class="number">8</span>],</span><br><span class="line">                ethhead[<span class="number">9</span>],ethhead[<span class="number">10</span>],ethhead[<span class="number">11</span>]);</span><br><span class="line"></span><br><span class="line">        iphead = buffer+<span class="number">14</span>; <span class="comment">/* 跳过MAC头 */</span></span><br><span class="line">        <span class="keyword">if</span> (*iphead==<span class="number">0x45</span>) &#123; <span class="comment">/* 再次检查IPv4且不存在任何options */</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Source host %d.%d.%d.%d\n&quot;</span>,</span><br><span class="line">                    iphead[<span class="number">12</span>],iphead[<span class="number">13</span>],</span><br><span class="line">                    iphead[<span class="number">14</span>],iphead[<span class="number">15</span>]);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Dest host %d.%d.%d.%d\n&quot;</span>,</span><br><span class="line">                    iphead[<span class="number">16</span>],iphead[<span class="number">17</span>],</span><br><span class="line">                    iphead[<span class="number">18</span>],iphead[<span class="number">19</span>]);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Source,Dest ports %d,%d\n&quot;</span>,</span><br><span class="line">                    (iphead[<span class="number">20</span>]&lt;&lt;<span class="number">8</span>)+iphead[<span class="number">21</span>],</span><br><span class="line">                    (iphead[<span class="number">22</span>]&lt;&lt;<span class="number">8</span>)+iphead[<span class="number">23</span>]);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Layer-4 protocol %d\n&quot;</span>,iphead[<span class="number">9</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>使用 PF_PACKET 协议族嗅探所有发往自己主机的报文</li>
<li>通过简单的格式化输出 MAC 头与 IP 头的信息</li>
</ul>
<p>运行结果如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">➜  Sniffer sudo ./test1  </span><br><span class="line">----------</span><br><span class="line"><span class="number">66</span> bytes read</span><br><span class="line">Source MAC address: <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span></span><br><span class="line">Destination MAC address: <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span></span><br><span class="line">Source host <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">Dest host <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">Source,Dest ports <span class="number">54530</span>,<span class="number">34372</span></span><br><span class="line">Layer<span class="number">-4</span> protocol <span class="number">6</span></span><br><span class="line">----------</span><br><span class="line"><span class="number">66</span> bytes read</span><br><span class="line">Source MAC address: <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span></span><br><span class="line">Destination MAC address: <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span></span><br><span class="line">Source host <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">Dest host <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">Source,Dest ports <span class="number">34372</span>,<span class="number">54530</span></span><br><span class="line">Layer<span class="number">-4</span> protocol <span class="number">6</span></span><br><span class="line">----------</span><br><span class="line"><span class="number">66</span> bytes read</span><br><span class="line">Source MAC address: <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span></span><br><span class="line">Destination MAC address: <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span></span><br><span class="line">Source host <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">Dest host <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">Source,Dest ports <span class="number">54530</span>,<span class="number">34372</span></span><br><span class="line">Layer<span class="number">-4</span> protocol <span class="number">6</span></span><br><span class="line">----------</span><br></pre></td></tr></table></figure>
<ul>
<li>本地进程通信的太网帧</li>
</ul>
<p><strong>Sniffer 案例二</strong></p>
<p>在上述案例中（非混杂模式），网卡丢弃所有不含有主机 MAC 地址的数据包，只有三个例外：</p>
<ul>
<li>如果一个帧的目的 MAC 地址是一个受限的广播地址 <code>255.255.255.255</code> 那么它将被所有的网卡接收</li>
<li>如果一个帧的目的地址是组播地址，那么它将被那些打开组播接收功能的网卡所接收</li>
<li>网卡如被设置成混杂模式，那么它将接收所有流经它的数据包 </li>
</ul>
<p>在 Linux 中可以使用如下代码 开启/关闭 混杂模式：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo ifconfig ens33 promisc</span><br><span class="line">sudo ifconfig ens33 -promisc</span><br></pre></td></tr></table></figure>
<ul>
<li>我的 VMware 上使用 ens33 虚拟网卡</li>
</ul>
<p>使用如下代码来查看目标网卡是否处于混杂模式：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /sys/class/net/ens33/flags</span><br></pre></td></tr></table></figure>
<ul>
<li><code>0x1103</code>：开启</li>
<li><code>0x1003</code>：关闭</li>
</ul>
<p>在C语言中使用如下代码也可以开启混杂模式：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ifreq</span> <span class="title">ethreq</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">strncpy</span>(ethreq.ifr_name,<span class="string">&quot;eth0&quot;</span>,IFNAMSIZ);</span><br><span class="line"><span class="keyword">if</span> (ioctl(sock,SIOCGIFFLAGS,&amp;ethreq) == <span class="number">-1</span>) &#123;</span><br><span class="line">    perror(<span class="string">&quot;ioctl&quot;</span>);</span><br><span class="line">    close(sock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ethreq.ifr_flags|=IFF_PROMISC;</span><br><span class="line"><span class="keyword">if</span> (ioctl(sock,SIOCSIFFLAGS,&amp;ethreq) == <span class="number">-1</span>) &#123;</span><br><span class="line">    perror(<span class="string">&quot;ioctl&quot;</span>);</span><br><span class="line">    close(sock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Sniffer 案例三</strong></p>
<p>接下来要实现数据包的过滤，Linux 内核允许我们把一个名为 LPF 的过滤器直接放到 PF_PACKET 协议处理例程中（在网卡接收中断执行后立即执行）</p>
<ul>
<li>该过滤程序可以根据使用者的定义来运行</li>
<li>由一种名为 BPF（Berkely Packet Filter 伯克利数据包过滤器）的伪机器码写成的 </li>
</ul>
<p>使用 <code>tcpdump</code> 可以快速生成 BPF 代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">➜  Sniffer sudo tcpdump -d host <span class="number">192.168</span><span class="number">.157</span><span class="number">.136</span> </span><br><span class="line">(<span class="number">000</span>) ldh      [<span class="number">12</span>]</span><br><span class="line">(<span class="number">001</span>) jeq      #<span class="number">0x800</span>           jt <span class="number">2</span>	jf <span class="number">6</span></span><br><span class="line">(<span class="number">002</span>) ld       [<span class="number">26</span>]</span><br><span class="line">(<span class="number">003</span>) jeq      #<span class="number">0xc0a89d88</span>      jt <span class="number">12</span>	jf <span class="number">4</span></span><br><span class="line">(<span class="number">004</span>) ld       [<span class="number">30</span>]</span><br><span class="line">(<span class="number">005</span>) jeq      #<span class="number">0xc0a89d88</span>      jt <span class="number">12</span>	jf <span class="number">13</span></span><br><span class="line">(<span class="number">006</span>) jeq      #<span class="number">0x806</span>           jt <span class="number">8</span>	jf <span class="number">7</span></span><br><span class="line">(<span class="number">007</span>) jeq      #<span class="number">0x8035</span>          jt <span class="number">8</span>	jf <span class="number">13</span></span><br><span class="line">(<span class="number">008</span>) ld       [<span class="number">28</span>]</span><br><span class="line">(<span class="number">009</span>) jeq      #<span class="number">0xc0a89d88</span>      jt <span class="number">12</span>	jf <span class="number">10</span></span><br><span class="line">(<span class="number">010</span>) ld       [<span class="number">38</span>]</span><br><span class="line">(<span class="number">011</span>) jeq      #<span class="number">0xc0a89d88</span>      jt <span class="number">12</span>	jf <span class="number">13</span></span><br><span class="line">(<span class="number">012</span>) ret      #<span class="number">262144</span></span><br><span class="line">(<span class="number">013</span>) ret      #<span class="number">0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>第 0-1,6-7 行：确定被抓到的帧是否在传输着 IP，ARP 或者 RARP 协议 </li>
<li>第 2-5,8-11 行：比较源地址或者目的地址是否与 <code>192.168.157.1</code> 相同  </li>
<li>将第12格的值与协议的特征值比较，如果比较失败，那么丢弃这个包</li>
</ul>
<p>在C语言中，建立一个 <code>sock_filter</code> 并为它绑定一个打开的端口，就可以使用该 BPF</p>
<p>使用 <code>tcpdump</code> 可以生成 BPF 对应的C代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">➜  Sniffer sudo tcpdump -dd host <span class="number">192.168</span><span class="number">.157</span><span class="number">.136</span>             </span><br><span class="line">&#123; <span class="number">0x28</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0x0000000c</span> &#125;,</span><br><span class="line">&#123; <span class="number">0x15</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">0x00000800</span> &#125;,</span><br><span class="line">&#123; <span class="number">0x20</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0x0000001a</span> &#125;,</span><br><span class="line">&#123; <span class="number">0x15</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">0xc0a89d88</span> &#125;,</span><br><span class="line">&#123; <span class="number">0x20</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0x0000001e</span> &#125;,</span><br><span class="line">&#123; <span class="number">0x15</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">0xc0a89d88</span> &#125;,</span><br><span class="line">&#123; <span class="number">0x15</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0x00000806</span> &#125;,</span><br><span class="line">&#123; <span class="number">0x15</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">0x00008035</span> &#125;,</span><br><span class="line">&#123; <span class="number">0x20</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0x0000001c</span> &#125;,</span><br><span class="line">&#123; <span class="number">0x15</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">0xc0a89d88</span> &#125;,</span><br><span class="line">&#123; <span class="number">0x20</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0x00000026</span> &#125;,</span><br><span class="line">&#123; <span class="number">0x15</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0xc0a89d88</span> &#125;,</span><br><span class="line">&#123; <span class="number">0x6</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0x00040000</span> &#125;,</span><br><span class="line">&#123; <span class="number">0x6</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0x00000000</span> &#125;,</span><br></pre></td></tr></table></figure>
<p>最后得到最终的代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">➜  Sniffer sudo ./test2</span><br><span class="line">----------</span><br><span class="line"><span class="number">199</span> bytes read</span><br><span class="line">Source MAC address: <span class="number">00</span>:<span class="number">0</span>c:<span class="number">29</span>:bf:<span class="number">5f</span>:<span class="number">3f</span></span><br><span class="line">Destination MAC address: <span class="number">00</span>:<span class="number">50</span>:<span class="number">56</span>:ef:<span class="number">45</span>:fa</span><br><span class="line">Source host <span class="number">192.168</span><span class="number">.157</span><span class="number">.2</span></span><br><span class="line">Dest host <span class="number">192.168</span><span class="number">.157</span><span class="number">.136</span></span><br><span class="line">Source,Dest ports <span class="number">53</span>,<span class="number">36313</span></span><br><span class="line">Layer<span class="number">-4</span> protocol <span class="number">17</span></span><br><span class="line">----------</span><br><span class="line"><span class="number">102</span> bytes read</span><br><span class="line">Source MAC address: <span class="number">00</span>:<span class="number">0</span>c:<span class="number">29</span>:bf:<span class="number">5f</span>:<span class="number">3f</span></span><br><span class="line">Destination MAC address: <span class="number">00</span>:<span class="number">50</span>:<span class="number">56</span>:ef:<span class="number">45</span>:fa</span><br><span class="line">Source host <span class="number">192.168</span><span class="number">.157</span><span class="number">.2</span></span><br><span class="line">Dest host <span class="number">192.168</span><span class="number">.157</span><span class="number">.136</span></span><br><span class="line">Source,Dest ports <span class="number">53</span>,<span class="number">46817</span></span><br><span class="line">Layer<span class="number">-4</span> protocol <span class="number">17</span></span><br><span class="line">----------</span><br><span class="line"><span class="number">213</span> bytes read</span><br><span class="line">Source MAC address: <span class="number">00</span>:<span class="number">0</span>c:<span class="number">29</span>:bf:<span class="number">5f</span>:<span class="number">3f</span></span><br><span class="line">Destination MAC address: <span class="number">00</span>:<span class="number">50</span>:<span class="number">56</span>:ef:<span class="number">45</span>:fa</span><br><span class="line">Source host <span class="number">192.168</span><span class="number">.157</span><span class="number">.2</span></span><br><span class="line">Dest host <span class="number">192.168</span><span class="number">.157</span><span class="number">.136</span></span><br><span class="line">Source,Dest ports <span class="number">53</span>,<span class="number">59949</span></span><br><span class="line">Layer<span class="number">-4</span> protocol <span class="number">17</span></span><br><span class="line">----------</span><br></pre></td></tr></table></figure>
<p><strong>Sniffer 代码</strong></p>
<p>下面给出我写的 Sniffer 代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/if_ether.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/if_ether.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/tcp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;net/if.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/ip.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/filter.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">backupInit</span><span class="params">(FILE **file)</span></span>&#123;</span><br><span class="line">	*file = fopen(<span class="string">&quot;log&quot;</span>,<span class="string">&quot;w+&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(file == <span class="literal">NULL</span>)&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">printLog</span><span class="params">(<span class="keyword">char</span> *str,FILE* file)</span></span>&#123;</span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stdout</span>,str);</span><br><span class="line">	<span class="built_in">fprintf</span>(file,str);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getNowtime</span><span class="params">(FILE* file)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">char</span> str[<span class="number">60</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">char</span> YMD[<span class="number">15</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">char</span> HMS[<span class="number">10</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">time_t</span> current_time;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tm</span>* <span class="title">now_time</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *cur_time = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">21</span>*<span class="keyword">sizeof</span>(<span class="keyword">char</span>));</span><br><span class="line">    time(&amp;current_time);</span><br><span class="line">    now_time = localtime(&amp;current_time);</span><br><span class="line"></span><br><span class="line">    strftime(YMD, <span class="keyword">sizeof</span>(YMD), <span class="string">&quot;%F &quot;</span>, now_time);</span><br><span class="line">    strftime(HMS, <span class="keyword">sizeof</span>(HMS), <span class="string">&quot;%T&quot;</span>, now_time);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">strncat</span>(cur_time, YMD, <span class="number">11</span>);</span><br><span class="line">    <span class="built_in">strncat</span>(cur_time, HMS, <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sprintf</span>(str,<span class="string">&quot;==========\nCurrent time: %s\n==========\n&quot;</span>, cur_time);</span><br><span class="line">	printLog(str,file);</span><br><span class="line">    <span class="built_in">free</span>(cur_time);</span><br><span class="line"></span><br><span class="line">    cur_time = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">change</span><span class="params">(<span class="keyword">size_t</span> num,<span class="keyword">int</span> key)</span></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> (num &gt;&gt; (key*<span class="number">8</span>))&amp;<span class="number">0x000000ff</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> sock, n;</span><br><span class="line">	FILE* file;</span><br><span class="line">	<span class="keyword">char</span> buffer[<span class="number">2048</span>];</span><br><span class="line">	<span class="keyword">char</span> str[<span class="number">512</span>];</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> *ethhead;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">iphdr</span> *<span class="title">iphead</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tcphdr</span> *<span class="title">tcphead</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sock_filter</span> <span class="title">BPF_code</span>[]=</span> &#123;</span><br><span class="line">		&#123; <span class="number">0x28</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0x0000000c</span> &#125;,</span><br><span class="line">		&#123; <span class="number">0x15</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">0x00000800</span> &#125;,</span><br><span class="line">		&#123; <span class="number">0x20</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0x0000001a</span> &#125;,</span><br><span class="line">		&#123; <span class="number">0x15</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">0xc0a89d88</span> &#125;,</span><br><span class="line">		&#123; <span class="number">0x20</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0x0000001e</span> &#125;,</span><br><span class="line">		&#123; <span class="number">0x15</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">0xc0a89d88</span> &#125;,</span><br><span class="line">		&#123; <span class="number">0x15</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0x00000806</span> &#125;,</span><br><span class="line">		&#123; <span class="number">0x15</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">0x00008035</span> &#125;,</span><br><span class="line">		&#123; <span class="number">0x20</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0x0000001c</span> &#125;,</span><br><span class="line">		&#123; <span class="number">0x15</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">0xc0a89d88</span> &#125;,</span><br><span class="line">		&#123; <span class="number">0x20</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0x00000026</span> &#125;,</span><br><span class="line">		&#123; <span class="number">0x15</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0xc0a89d88</span> &#125;,</span><br><span class="line">		&#123; <span class="number">0x6</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0x00040000</span> &#125;,</span><br><span class="line">		&#123; <span class="number">0x6</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0x00000000</span> &#125;,</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sock_fprog</span> <span class="title">Filter</span>;</span></span><br><span class="line"></span><br><span class="line">	Filter.len = <span class="number">14</span>;</span><br><span class="line">	Filter.filter = BPF_code;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ((sock=socket(PF_PACKET, SOCK_RAW,htons(ETH_P_IP)))&lt;<span class="number">0</span>)&#123;</span><br><span class="line">		perror(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(backupInit(&amp;file)&lt;<span class="number">0</span>)&#123;</span><br><span class="line">		perror(<span class="string">&quot;backup&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(setsockopt(sock, SOL_SOCKET, SO_ATTACH_FILTER,&amp;Filter, <span class="keyword">sizeof</span>(Filter))&lt;<span class="number">0</span>)&#123;</span><br><span class="line">		perror(<span class="string">&quot;setsockopt&quot;</span>);</span><br><span class="line">		close(sock);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	getNowtime(file);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">		n = recvfrom(sock,buffer,<span class="number">2048</span>,<span class="number">0</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>); </span><br><span class="line">		<span class="built_in">sprintf</span>(str,<span class="string">&quot;%d bytes read\n&quot;</span>,n);</span><br><span class="line">		printLog(str,file);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (n&lt;<span class="number">42</span>) &#123;</span><br><span class="line">			perror(<span class="string">&quot;recvfrom():&quot;</span>);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;Incomplete packet (errno is %d)\n&quot;</span>,errno);</span><br><span class="line">			close(sock);</span><br><span class="line">			<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		ethhead = buffer;</span><br><span class="line">		<span class="built_in">sprintf</span>(str,<span class="string">&quot;Source MAC address: &quot;</span></span><br><span class="line">				<span class="string">&quot;%02x:%02x:%02x:%02x:%02x:%02x\n&quot;</span>,</span><br><span class="line">				ethhead[<span class="number">0</span>],ethhead[<span class="number">1</span>],ethhead[<span class="number">2</span>],</span><br><span class="line">				ethhead[<span class="number">3</span>],ethhead[<span class="number">4</span>],ethhead[<span class="number">5</span>]);</span><br><span class="line">		printLog(str,file);</span><br><span class="line"></span><br><span class="line">		<span class="built_in">sprintf</span>(str,<span class="string">&quot;Destination MAC address: &quot;</span></span><br><span class="line">				<span class="string">&quot;%02x:%02x:%02x:%02x:%02x:%02x\n&quot;</span>,</span><br><span class="line">				ethhead[<span class="number">6</span>],ethhead[<span class="number">7</span>],ethhead[<span class="number">8</span>],</span><br><span class="line">				ethhead[<span class="number">9</span>],ethhead[<span class="number">10</span>],ethhead[<span class="number">11</span>]);</span><br><span class="line">		printLog(str,file);</span><br><span class="line"></span><br><span class="line">		iphead = (struct iphdr*)(buffer+<span class="number">14</span>);</span><br><span class="line">		tcphead = (struct tcphdr*)(buffer+<span class="number">14</span>+<span class="number">20</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (iphead-&gt;version &gt; <span class="number">0</span>) &#123; </span><br><span class="line">			<span class="built_in">sprintf</span>(str,<span class="string">&quot;Source host %d.%d.%d.%d\n&quot;</span>,</span><br><span class="line">					change(iphead-&gt;saddr,<span class="number">0</span>),change(iphead-&gt;saddr,<span class="number">1</span>),</span><br><span class="line">					change(iphead-&gt;saddr,<span class="number">2</span>),change(iphead-&gt;saddr,<span class="number">3</span>));</span><br><span class="line">			printLog(str,file);</span><br><span class="line"></span><br><span class="line">			<span class="built_in">sprintf</span>(str,<span class="string">&quot;Dest host %d.%d.%d.%d\n&quot;</span>,</span><br><span class="line">					change(iphead-&gt;daddr,<span class="number">0</span>),change(iphead-&gt;daddr,<span class="number">1</span>),</span><br><span class="line">					change(iphead-&gt;daddr,<span class="number">2</span>),change(iphead-&gt;daddr,<span class="number">3</span>));</span><br><span class="line">			printLog(str,file);</span><br><span class="line">			</span><br><span class="line">			<span class="built_in">sprintf</span>(str,<span class="string">&quot;Source ports:%d\nDest ports:%d\n&quot;</span>,</span><br><span class="line">					tcphead-&gt;source,tcphead-&gt;dest);</span><br><span class="line">			printLog(str,file);</span><br><span class="line">	</span><br><span class="line">			<span class="built_in">sprintf</span>(str,<span class="string">&quot;Layer-4 protocol %d\n&quot;</span>,iphead-&gt;protocol);</span><br><span class="line">			printLog(str,file);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="built_in">sprintf</span>(str,<span class="string">&quot;----------\n&quot;</span>);</span><br><span class="line">		printLog(str,file);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>参考：<a target="_blank" rel="noopener" href="http://www.nsfocus.net/index.php?act=magazine&amp;do=view&amp;mid=1797">NSFOCUS绿盟科技</a> </p>

    </div>

    
    
    

      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/coding/" rel="tag"><i class="fa fa-tag"></i> coding</a>
              <a href="/tags/Net-Knowledge/" rel="tag"><i class="fa fa-tag"></i> Net Knowledge</a>
              <a href="/tags/Sniffer/" rel="tag"><i class="fa fa-tag"></i> Sniffer</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2023/02/19/seq_operations%20+%20pt_regs/" rel="prev" title="seq_operations+pt_regs">
      <i class="fa fa-chevron-left"></i> seq_operations+pt_regs
    </a></div>
      <div class="post-nav-item">
    <a href="/2023/02/27/ldt_struct+modify_ldt/" rel="next" title="ldt_struct+modify_ldt">
      ldt_struct+modify_ldt <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Sniffer-%E6%80%BB%E8%BF%B0"><span class="nav-number">1.</span> <span class="nav-text">Sniffer 总述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%8E-Sniffer-%E7%9B%B8%E5%85%B3%E7%9A%84%E7%9F%A5%E8%AF%86"><span class="nav-number">2.</span> <span class="nav-text">与 Sniffer 相关的知识</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0-Sniffer"><span class="nav-number">3.</span> <span class="nav-text">实现 Sniffer</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yhellow"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">yhellow</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">311</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">162</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yhellow</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">4.6m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">69:50</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
