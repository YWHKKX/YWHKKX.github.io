<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="FTP 协议简析 FTP（File Transfer Protocol）是 TCP&#x2F;IP 协议组中的协议之一，FTP 的工作就是完成两台计算机之间的拷贝 在 TCP&#x2F;IP 协议中， 需要两个端口，一个是数据端口，一个是控制端口  控制端口一般为21，而数据端口不一定是20，这和 FTP 的应用模式有关： 如果是主动模式，应该为20 如果为被动模式，由服务器端和客户端协商而定   FTP 协议要用到">
<meta property="og:type" content="article">
<meta property="og:title" content="网络相关知识：FTP协议">
<meta property="og:url" content="http://example.com/2023/01/21/%E7%BD%91%E7%BB%9C%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%EF%BC%9AFTP%E5%8D%8F%E8%AE%AE/index.html">
<meta property="og:site_name" content="Pwn进你的心">
<meta property="og:description" content="FTP 协议简析 FTP（File Transfer Protocol）是 TCP&#x2F;IP 协议组中的协议之一，FTP 的工作就是完成两台计算机之间的拷贝 在 TCP&#x2F;IP 协议中， 需要两个端口，一个是数据端口，一个是控制端口  控制端口一般为21，而数据端口不一定是20，这和 FTP 的应用模式有关： 如果是主动模式，应该为20 如果为被动模式，由服务器端和客户端协商而定   FTP 协议要用到">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2023-01-21T03:05:04.000Z">
<meta property="article:modified_time" content="2023-01-21T03:06:36.662Z">
<meta property="article:author" content="yhellow">
<meta property="article:tag" content="FTP">
<meta property="article:tag" content="Net Knowledge">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/2023/01/21/%E7%BD%91%E7%BB%9C%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%EF%BC%9AFTP%E5%8D%8F%E8%AE%AE/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>网络相关知识：FTP协议 | Pwn进你的心</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Pwn进你的心</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/01/21/%E7%BD%91%E7%BB%9C%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%EF%BC%9AFTP%E5%8D%8F%E8%AE%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          网络相关知识：FTP协议
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-01-21 11:05:04 / Modified: 11:06:36" itemprop="dateCreated datePublished" datetime="2023-01-21T11:05:04+08:00">2023-01-21</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>14k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>13 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p><strong>FTP 协议简析</strong></p>
<p>FTP（File Transfer Protocol）是 TCP/IP 协议组中的协议之一，FTP 的工作就是完成两台计算机之间的拷贝</p>
<p>在 TCP/IP 协议中， 需要两个端口，一个是数据端口，一个是控制端口</p>
<ul>
<li>控制端口一般为21，而数据端口不一定是20，这和 FTP 的应用模式有关：<ul>
<li>如果是主动模式，应该为20</li>
<li>如果为被动模式，由服务器端和客户端协商而定</li>
</ul>
</li>
<li>FTP 协议要用到两个 TCP 连接：<ul>
<li>一个是命令链路，用来在 FTP 客户端与服务器之间传递命令</li>
<li>另一个是数据链路，用来上传或下载数据 </li>
</ul>
</li>
</ul>
<p><strong>主动模式与被动模式</strong></p>
<p>FTP 支持两种模式，一种方式叫做 Standard（也就是 PORT 方式，主动方式），一种是 Passive（也就是 PASV，被动方式），下面介绍一个这两种方式的工作原理：</p>
<p>主动 FTP ：</p>
<ul>
<li>命令连接：客户端向服务器的 FTP 端口（默认是21）发送连接请求，服务器接受连接，建立一条命令链路<ul>
<li>客户端 &gt;1024 端口 → 服务器 21 端口</li>
</ul>
</li>
<li>数据连接：客户端在命令链路上用 PORT 命令告诉服务器自己开启的端口，于是服务器从自己的 20 端口去连接客户端开启的端口并传输数据<ul>
<li>客户端 &gt;1024 端口 ← 服务器 20 端口</li>
</ul>
</li>
</ul>
<p>被动 FTP ：</p>
<ul>
<li>命令连接：客户端向服务器的 FTP 端口（默认是21）发送连接请求，服务器接受连接，建立一条命令链路 <ul>
<li>客户端 &gt;1024 端口 → 服务器 21 端口</li>
</ul>
</li>
<li>数据连接：客户端在命令链路上用 PASV 命令告诉服务器使用被动模式，于是服务器开启一个端口专门提供给客户端使用，然后客户端主动连接服务器端口来传输数据<ul>
<li>客户端 &gt;1024 端口 → 服务器 &gt; 1024 端口</li>
</ul>
</li>
</ul>
<p><strong>FTP 服务器的代码实现</strong></p>
<p>FTP 需要实现的功能如下：</p>
<ul>
<li>读取配置信息</li>
<li>与目标主机建立连接（使用 socket）</li>
<li>实现 FTP 命令集</li>
</ul>
<p>这里就以轻量级的 FTP 服务器 <code>LightFTP</code> 为例，来学习一下 FTP 服务器的代码实现</p>
<p><strong>LightFTP 读取配置信息</strong></p>
<p>在 <code>LightFTP</code> 中，使用 <code>config_parse</code> 函数来读取文件信息：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">config_parse</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">const</span> <span class="keyword">char</span>      *pcfg,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">const</span> <span class="keyword">char</span>      *section_name,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">const</span> <span class="keyword">char</span>      *key_name,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">char</span>            *value,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">unsigned</span> <span class="keyword">long</span>   value_size_max)</span></span></span><br></pre></td></tr></table></figure>
<p>该函数的参数如下：</p>
<ul>
<li><code>pcfg</code>：初始化函数 <code>config_init</code> 返回的缓冲区（配置文件 <code>fftp.conf</code> 中的内容被 Read 入其中）</li>
<li><code>section_name</code>：配置段名称，在配置文件 <code>fftp.conf</code> 中被大括号 <code>[]</code> 括起来的内容，用于区分某段配置（初始化配置名称为 <code>ftpconfig</code>）</li>
<li><code>key_name</code>：关键字名称，记录有在配置文件 <code>fftp.conf</code> 中写入的关键信息，程序初始化时会把等号 <code>=</code> 后面的内容读入内存</li>
<li><code>value</code>：用于外传数据的指针（程序会把目标 <code>key_name</code> 对应的值写入 <code>value</code> 中）</li>
<li><code>value_size_max</code>：用于表示 <code>value</code> 的最大值</li>
</ul>
<p>为了理解这些参数，我们需要其他代码进行辅助，就从 <code>config_init</code> 函数开始：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">config_init</span><span class="params">(<span class="keyword">char</span> *cfg_filename)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span>		f_config;</span><br><span class="line">	<span class="keyword">char</span>	*buffer = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">off_t</span>	fsz;</span><br><span class="line"></span><br><span class="line">	f_config = open(cfg_filename, O_RDONLY);</span><br><span class="line">	<span class="keyword">while</span> (f_config != <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		fsz = lseek(f_config, <span class="number">0L</span>, SEEK_END) + <span class="number">1</span>;</span><br><span class="line">		lseek(f_config, <span class="number">0L</span>, SEEK_SET);</span><br><span class="line"></span><br><span class="line">		buffer = x_malloc(fsz);</span><br><span class="line"></span><br><span class="line">		fsz = read(f_config, buffer, fsz);</span><br><span class="line">		buffer[fsz] = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (f_config != <span class="number">-1</span>)</span><br><span class="line">		close(f_config);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> buffer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>程序默认的 <code>cfg_filename</code> 就是 <code>fftp.conf</code></li>
<li>这个函数的功能就是把配置文件读取到本地内存 <code>buffer</code> 中，然后返回 <code>buffer</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (argc &gt; <span class="number">1</span>)</span><br><span class="line">	cfg = config_init(argv[<span class="number">1</span>]);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	cfg = config_init(CONFIG_FILE_NAME);</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">	g_cfg.BindToInterface = inet_addr(<span class="string">&quot;127.0.0.1&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (config_parse(cfg, CONFIG_SECTION_NAME, <span class="string">&quot;interface&quot;</span>, textbuf, bufsize))</span><br><span class="line">		g_cfg.BindToInterface = inet_addr(textbuf);</span><br><span class="line"></span><br><span class="line">	g_cfg.ExternalInterface = inet_addr(<span class="string">&quot;0.0.0.0&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (config_parse(cfg, CONFIG_SECTION_NAME, <span class="string">&quot;external_ip&quot;</span>, textbuf, bufsize))</span><br><span class="line">		g_cfg.ExternalInterface = inet_addr(textbuf);</span><br></pre></td></tr></table></figure>
<ul>
<li><code>config_init</code> 的返回值，将会放入 <code>config_parse</code> 中（作为第一个参数 <code>pcfg</code>）</li>
</ul>
<p>接下来看一看配置文件 <code>fftp.conf</code> 的内容：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[ftpconfig]</span><br><span class="line">port=<span class="number">21</span> <span class="comment">/* 要将服务器绑定到的端口号 */</span></span><br><span class="line">maxusers=<span class="number">10</span> <span class="comment">/* 与服务器的最大连接数,可同时建立 */</span></span><br><span class="line">interface=<span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span> <span class="comment">/* 要绑定到的接口IP,使用0.0.0.0侦听任何可用接口,默认值:127.0.0.1 */</span></span><br><span class="line">local_mask=<span class="number">255.255</span><span class="number">.255</span><span class="number">.255</span> <span class="comment">/* 本地网络的IP掩码,这将有助于服务器区分本地客户端和互联网客户端,默认值:255.255.255.0 */</span></span><br><span class="line"></span><br><span class="line">minport=<span class="number">30000</span> <span class="comment">/* 数据连接的端口范围,您可以使用它在网关设备上配置端口转发 */</span></span><br><span class="line">maxport=<span class="number">60000</span></span><br><span class="line"></span><br><span class="line">goodbyemsg=Goodbye!</span><br><span class="line">keepalive=<span class="number">1</span> <span class="comment">/* 发送激活数据包(某些NAT可能需要这样做) */</span></span><br><span class="line"></span><br><span class="line">[anonymous]</span><br><span class="line">pswd=* <span class="comment">/* 表示“任何密码都匹配” */</span></span><br><span class="line">accs=readonly <span class="comment">/* 不允许登录 */</span></span><br><span class="line">root=/server/data/</span><br><span class="line">    </span><br><span class="line">[uploader]</span><br><span class="line">pswd=Weakuploaderpassword111</span><br><span class="line">accs=upload</span><br><span class="line">root=/home/user/ftpshare</span><br><span class="line"></span><br><span class="line">[webadmin]</span><br><span class="line">pswd=VeryStrongadminpassword222</span><br><span class="line">accs=admin</span><br><span class="line">root=/home/user/ftpshare</span><br></pre></td></tr></table></figure>
<ul>
<li>大括号容就是 <code>section_name</code></li>
<li>等号左边的内容就是 <code>key_name</code>，右边的内容就是将要被设置的值</li>
</ul>
<p>使用函数 <code>config_parse</code> 需要指定 <code>section_name</code> 和 <code>key_name</code>，该函数会把对应的值提取到参数 <code>value</code> 中，然后外传到上层函数中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">config_parse</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">const</span> <span class="keyword">char</span>      *pcfg,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">const</span> <span class="keyword">char</span>      *section_name,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">const</span> <span class="keyword">char</span>      *key_name,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">char</span>            *value,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">unsigned</span> <span class="keyword">long</span>   value_size_max)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>	sp;</span><br><span class="line">	<span class="keyword">char</span>			vname[<span class="number">256</span>], *p = (<span class="keyword">char</span> *)pcfg;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (value_size_max == <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	--value_size_max;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (*p != <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		p = skip_comments_and_blanks(p);</span><br><span class="line">		<span class="keyword">if</span> (*p == <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">if</span> (*p != <span class="string">&#x27;[&#x27;</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			++p;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		++p;</span><br><span class="line">		sp = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">while</span> (</span><br><span class="line">				(*p != <span class="string">&#x27;]&#x27;</span>) &amp;&amp;</span><br><span class="line">				(*p != <span class="number">0</span>) &amp;&amp;</span><br><span class="line">				(*p != <span class="string">&#x27;\n&#x27;</span>) &amp;&amp;</span><br><span class="line">				(sp &lt; <span class="number">255</span>)</span><br><span class="line">				)</span><br><span class="line">		&#123;</span><br><span class="line">			vname[sp] = *p;</span><br><span class="line">			++sp;</span><br><span class="line">			++p;</span><br><span class="line">		&#125;</span><br><span class="line">		vname[sp] = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">if</span> (*p == <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">if</span> (*p == <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		++p;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">strcmp</span>(vname, section_name) == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">do</span> &#123;</span><br><span class="line">				p = skip_comments_and_blanks(p);</span><br><span class="line">				<span class="keyword">if</span> ((*p == <span class="number">0</span>) || (*p == <span class="string">&#x27;[&#x27;</span>))</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				sp = <span class="number">0</span>;</span><br><span class="line">				<span class="keyword">while</span> (</span><br><span class="line">						(*p != <span class="string">&#x27;=&#x27;</span>) &amp;&amp;</span><br><span class="line">						(*p != <span class="string">&#x27; &#x27;</span>) &amp;&amp;</span><br><span class="line">						(*p != <span class="number">0</span>) &amp;&amp;</span><br><span class="line">						(*p != <span class="string">&#x27;\n&#x27;</span>) &amp;&amp;</span><br><span class="line">						(sp &lt; <span class="number">255</span>)</span><br><span class="line">						)</span><br><span class="line">				&#123;</span><br><span class="line">					vname[sp] = *p;</span><br><span class="line">					++sp;</span><br><span class="line">					++p;</span><br><span class="line">				&#125;</span><br><span class="line">				vname[sp] = <span class="number">0</span>;</span><br><span class="line">				<span class="keyword">if</span> (*p == <span class="number">0</span>)</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				<span class="keyword">while</span> (*p == <span class="string">&#x27; &#x27;</span>)</span><br><span class="line">					++p;</span><br><span class="line">				<span class="keyword">if</span> (*p != <span class="string">&#x27;=&#x27;</span>)</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				p++;</span><br><span class="line">				<span class="keyword">if</span> (<span class="built_in">strcmp</span>(vname, key_name) == <span class="number">0</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					sp = <span class="number">0</span>;</span><br><span class="line">					<span class="keyword">while</span> (</span><br><span class="line">							(*p != <span class="string">&#x27;\n&#x27;</span>) &amp;&amp;</span><br><span class="line">							(*p != <span class="number">0</span>)</span><br><span class="line">							)</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="keyword">if</span> (sp &lt; value_size_max)</span><br><span class="line">							value[sp] = *p;</span><br><span class="line">						<span class="keyword">else</span></span><br><span class="line">							<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">						++sp;</span><br><span class="line">						++p;</span><br><span class="line">					&#125;</span><br><span class="line">					value[sp] = <span class="number">0</span>;</span><br><span class="line">					<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">				&#123;</span><br><span class="line">					<span class="keyword">while</span> (</span><br><span class="line">							(*p != <span class="string">&#x27;\n&#x27;</span>) &amp;&amp;</span><br><span class="line">							(*p != <span class="number">0</span>)</span><br><span class="line">							)</span><br><span class="line">						++p;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; <span class="keyword">while</span> (*p != <span class="number">0</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">do</span> &#123;</span><br><span class="line">				p = skip_comments_and_blanks(p);</span><br><span class="line">				<span class="keyword">if</span> ((*p == <span class="number">0</span>) || (*p == <span class="string">&#x27;[&#x27;</span>))</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				<span class="keyword">while</span> (</span><br><span class="line">						(*p != <span class="string">&#x27;\n&#x27;</span>) &amp;&amp;</span><br><span class="line">						(*p != <span class="number">0</span>)</span><br><span class="line">						)</span><br><span class="line">					++p;</span><br><span class="line">			&#125; <span class="keyword">while</span> (<span class="number">1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>函数 <code>config_parse</code> 总体的思路就是利用2个 <code>while</code> 循环来变量所有的 <code>section_name</code> 和 <code>key_name</code>：</p>
<ul>
<li>外层的循环会匹配大括号 <code>[]</code>，用一个 <code>while</code> 读取出 <code>section_name</code> 然后进行匹配：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">strcmp</span>(vname, section_name) == <span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>内层的循环会匹配等号 <code>=</code>，用一个 <code>while</code> 读取出 <code>key_name</code> 然后进行匹配：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">strcmp</span>(vname, key_name) == <span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>最后用一个 <code>while</code> 把等号右边的数据存储到 <code>value</code> 中：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> ((*p != <span class="string">&#x27;\n&#x27;</span>) &amp;&amp;(*p != <span class="number">0</span>)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (sp &lt; value_size_max)</span><br><span class="line">        value[sp] = *p;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    ++sp;</span><br><span class="line">    ++p;</span><br><span class="line">&#125;</span><br><span class="line">value[sp] = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p>函数 <code>config_parse</code> 最后返回的 <code>value</code> 将被会存储在结构体 <code>FTP_CONFIG</code> 中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">FTP_CONFIG</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span>*           ConfigFile;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>    MaxUsers;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>    EnableKeepalive;</span><br><span class="line">    <span class="keyword">in_port_t</span>       Port;</span><br><span class="line">    <span class="keyword">in_port_t</span>       PasvPortBase;</span><br><span class="line">    <span class="keyword">in_port_t</span>       PasvPortMax;</span><br><span class="line">    <span class="keyword">in_addr_t</span>       BindToInterface;</span><br><span class="line">    <span class="keyword">in_addr_t</span>       ExternalInterface;</span><br><span class="line">    <span class="keyword">in_addr_t</span>       LocalIPMask;</span><br><span class="line">&#125; FTP_CONFIG, *PFTP_CONFIG;</span><br></pre></td></tr></table></figure>
<p><strong>LightFTP 与目标主机建立连接</strong></p>
<p>把服务器中 <code>socket bind listen</code> 的代码提取出来：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">    ftpsocket = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP); <span class="comment">/* 基于IPv4和TCP */</span></span><br><span class="line">    <span class="keyword">if</span> ( ftpsocket == INVALID_SOCKET )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\r\n socket create error\r\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    rv = <span class="number">1</span>;</span><br><span class="line">    setsockopt(ftpsocket, SOL_SOCKET, SO_REUSEADDR, &amp;rv, <span class="keyword">sizeof</span>(rv)); </span><br><span class="line"><span class="comment">/* SO_REUSEADDR:打开或关闭地址复用功能 */</span></span><br><span class="line"></span><br><span class="line">    scb = (SOCKET *)x_malloc(<span class="keyword">sizeof</span>(SOCKET)*g_cfg.MaxUsers);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i&lt;g_cfg.MaxUsers; i++)</span><br><span class="line">        scb[i] = INVALID_SOCKET; <span class="comment">/* 初始化为&#x27;-1&#x27; */</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;laddr, <span class="number">0</span>, <span class="keyword">sizeof</span>(laddr));</span><br><span class="line">    laddr.sin_family = AF_INET;</span><br><span class="line">    laddr.sin_port = htons(g_cfg.Port);</span><br><span class="line">    laddr.sin_addr.s_addr = g_cfg.BindToInterface;</span><br><span class="line">    socketret = bind(ftpsocket, (struct sockaddr *)&amp;laddr, <span class="keyword">sizeof</span>(laddr));</span><br><span class="line">    <span class="keyword">if</span>  ( socketret != <span class="number">0</span> ) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\r\n Failed to start server. Can not bind to address\r\n\r\n&quot;</span>);</span><br><span class="line">        <span class="built_in">free</span>(scb);</span><br><span class="line">        close(ftpsocket);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    writelogentry(<span class="literal">NULL</span>, success220, <span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    socketret = listen(ftpsocket, SOMAXCONN); <span class="comment">/* socket的排队个数为SOMAXCONN,内核规定的最大连接数 */</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>setsockopt</code> 函数可以对 socket 进行详细的设置</li>
<li><code>SO_REUSEADDR</code> 参数提供如下四个功能： <ul>
<li><code>SO_REUSEADDR</code> 允许启动一个监听服务器并捆绑其众所周知端口，即使以前建立的将此端口用做他们的本地端口的连接仍存在（这通常是重启监听服务器时出现，若不设置此选项，则 <code>bind</code> 时将出错）</li>
<li><code>SO_REUSEADDR</code> 允许在同一端口上启动同一服务器的多个实例，只要每个实例捆绑一个不同的本地 IP 地址即可（对于 TCP，我们根本不可能启动捆绑相同 IP 地址和相同端口号的多个服务器）</li>
<li><code>SO_REUSEADDR</code> 允许单个进程捆绑同一端口到多个套接口上，只要每个捆绑指定不同的本地 IP 地址即可。这一般不用于 TCP 服务器</li>
<li><code>SO_REUSEADDR</code> 允许完全重复的捆绑：当一个 IP 地址和端口绑定到某个套接口上时，还允许此 IP 地址和端口捆绑到另一个套接口上（一般来说，这个特性仅在支持多播的系统上才有，而且只对UDP套接口而言，TCP不支持多播）</li>
</ul>
</li>
</ul>
<p>然后再循环里面 <code>accept</code> 客户端的请求：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> ( socketret == <span class="number">0</span> ) &#123;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;laddr, <span class="number">0</span>, <span class="keyword">sizeof</span>(laddr));</span><br><span class="line">    asz = <span class="keyword">sizeof</span>(laddr);</span><br><span class="line">    clientsocket = accept(ftpsocket, (struct sockaddr *)&amp;laddr, &amp;asz); </span><br><span class="line">    <span class="comment">/* 一次大循环连接一台客户端主机 */</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (clientsocket == INVALID_SOCKET) <span class="comment">/* 没有accept时则直接continue */</span></span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">    rv = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;g_cfg.MaxUsers; i++)</span><br><span class="line">        <span class="keyword">if</span> ( scb[i] == INVALID_SOCKET ) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (g_cfg.EnableKeepalive != <span class="number">0</span>)</span><br><span class="line">                socket_set_keepalive(clientsocket); </span><br><span class="line">            <span class="comment">/* 调用setsockopt对socket进行设置 */</span></span><br><span class="line">            </span><br><span class="line">            scb[i] = clientsocket;</span><br><span class="line">            rv = pthread_create(&amp;th, <span class="literal">NULL</span>, (<span class="keyword">void</span> * (*)(<span class="keyword">void</span> *))ftp_client_thread, &amp;scb[i]);</span><br><span class="line">            <span class="keyword">if</span> ( rv != <span class="number">0</span> ) <span class="comment">/* pthread_create返回&#x27;0&#x27;代表创建成功 */</span></span><br><span class="line">                scb[i] = INVALID_SOCKET;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( rv != <span class="number">0</span> ) &#123;</span><br><span class="line">        sendstring_plaintext(clientsocket, NOSLOTS);</span><br><span class="line">        close(clientsocket);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>g_cfg.MaxUsers</code>：服务器可以并发处理的客户端最大数目</li>
</ul>
<p><strong>LightFTP 实现 FTP 命令集</strong></p>
<p>实现 FTP 命令集的函数就是 <code>ftp_client_thread</code></p>
<p>在此之前需要介绍一下 LightFTP 中的一个结构体数组：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> FTPROUTINE_ENTRY ftpprocs[MAX_CMDS] = &#123;</span><br><span class="line">        &#123;<span class="string">&quot;USER&quot;</span>, ftpUSER&#125;, &#123;<span class="string">&quot;QUIT&quot;</span>, ftpQUIT&#125;, &#123;<span class="string">&quot;NOOP&quot;</span>, ftpNOOP&#125;, &#123;<span class="string">&quot;PWD&quot;</span>,  ftpPWD &#125;,</span><br><span class="line">        &#123;<span class="string">&quot;TYPE&quot;</span>, ftpTYPE&#125;, &#123;<span class="string">&quot;PORT&quot;</span>, ftpPORT&#125;, &#123;<span class="string">&quot;LIST&quot;</span>, ftpLIST&#125;, &#123;<span class="string">&quot;CDUP&quot;</span>, ftpCDUP&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;CWD&quot;</span>,  ftpCWD &#125;, &#123;<span class="string">&quot;RETR&quot;</span>, ftpRETR&#125;, &#123;<span class="string">&quot;ABOR&quot;</span>, ftpABOR&#125;, &#123;<span class="string">&quot;DELE&quot;</span>, ftpDELE&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;PASV&quot;</span>, ftpPASV&#125;, &#123;<span class="string">&quot;PASS&quot;</span>, ftpPASS&#125;, &#123;<span class="string">&quot;REST&quot;</span>, ftpREST&#125;, &#123;<span class="string">&quot;SIZE&quot;</span>, ftpSIZE&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;MKD&quot;</span>,  ftpMKD &#125;, &#123;<span class="string">&quot;RMD&quot;</span>,  ftpRMD &#125;, &#123;<span class="string">&quot;STOR&quot;</span>, ftpSTOR&#125;, &#123;<span class="string">&quot;SYST&quot;</span>, ftpSYST&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;FEAT&quot;</span>, ftpFEAT&#125;, &#123;<span class="string">&quot;APPE&quot;</span>, ftpAPPE&#125;, &#123;<span class="string">&quot;RNFR&quot;</span>, ftpRNFR&#125;, &#123;<span class="string">&quot;RNTO&quot;</span>, ftpRNTO&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;OPTS&quot;</span>, ftpOPTS&#125;, &#123;<span class="string">&quot;MLSD&quot;</span>, ftpMLSD&#125;, &#123;<span class="string">&quot;AUTH&quot;</span>, ftpAUTH&#125;, &#123;<span class="string">&quot;PBSZ&quot;</span>, ftpPBSZ&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;PROT&quot;</span>, ftpPROT&#125;, &#123;<span class="string">&quot;EPSV&quot;</span>, ftpEPSV&#125;, &#123;<span class="string">&quot;HELP&quot;</span>, ftpHELP&#125;, &#123;<span class="string">&quot;SITE&quot;</span>, ftpSITE&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>乍一看这个结构有点像 Python 中的字典（用于把 “FTP 命令名称” 和 “对应的函数指针” 绑定）</li>
<li>但这其实是 <code>FTPROUTINE_ENTRY</code> 类型的数组</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">FTPROUTINE_ENTRY</span> &#123;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* Name;</span><br><span class="line">    FTPROUTINE  Proc;</span><br><span class="line">&#125; FTPROUTINE_ENTRY, *PFTPROUTINE_ENTRY;</span><br></pre></td></tr></table></figure>
<p>使用这个结构体数组的代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> ( ctx.ControlSocket != INVALID_SOCKET ) &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !recvcmd(&amp;ctx, rcvbuf, <span class="keyword">sizeof</span>(rcvbuf)) ) <span class="comment">/* 从客服端中读取数据 */</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> ((rcvbuf[i] != <span class="number">0</span>) &amp;&amp; (<span class="built_in">isalpha</span>(rcvbuf[i]) == <span class="number">0</span>)) <span class="comment">/* 检查输入值是否为字母,并用while跳过所有的非字母 */</span></span><br><span class="line">        ++i;</span><br><span class="line"></span><br><span class="line">    cmd = &amp;rcvbuf[i]; <span class="comment">/* 确定ftp命令的起始地址 */</span></span><br><span class="line">    <span class="keyword">while</span> ((rcvbuf[i] != <span class="number">0</span>) &amp;&amp; (rcvbuf[i] != <span class="string">&#x27; &#x27;</span>)) <span class="comment">/* 用while跳过所有的非空格(方便计算出ftp命令的长度) */</span></span><br><span class="line">        ++i;</span><br><span class="line"></span><br><span class="line">    cmdlen = &amp;rcvbuf[i] - cmd;</span><br><span class="line">    <span class="keyword">while</span> (rcvbuf[i] == <span class="string">&#x27; &#x27;</span>)</span><br><span class="line">        ++i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rcvbuf[i] == <span class="number">0</span>)</span><br><span class="line">        params = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        params = &amp;rcvbuf[i];</span><br><span class="line"></span><br><span class="line">    cmdno = <span class="number">-1</span>;</span><br><span class="line">    rv = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (c=<span class="number">0</span>; c&lt;MAX_CMDS; c++)</span><br><span class="line">        <span class="keyword">if</span> (strncasecmp(cmd, ftpprocs[c].Name, cmdlen) == <span class="number">0</span>)</span><br><span class="line">        &#123; <span class="comment">/* 遍历数组ftpprocs中所有的ftp命令,并执行目标命令 */</span></span><br><span class="line">            cmdno = c;</span><br><span class="line">            rv = ftpprocs[c].Proc(&amp;ctx, params);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( cmdno != FTP_PASSCMD_INDEX )</span><br><span class="line">        writelogentry(&amp;ctx, <span class="string">&quot; @@ CMD: &quot;</span>, rcvbuf);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        writelogentry(&amp;ctx, <span class="string">&quot; @@ CMD: &quot;</span>, <span class="string">&quot;PASS ***&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( cmdno == <span class="number">-1</span> )</span><br><span class="line">        sendstring(&amp;ctx, error500);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( rv &lt;= <span class="number">0</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>一个简单的遍历匹配</li>
</ul>
<p>最后单独介绍几个 FTP 命令的实现：</p>
<ul>
<li>匹配密码和登录设置：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ftpPASS</span><span class="params">(PFTPCONTEXT context, <span class="keyword">const</span> <span class="keyword">char</span> *params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span>	temptext[<span class="number">256</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( params == <span class="literal">NULL</span> )</span><br><span class="line">        <span class="keyword">return</span> sendstring(context, error501);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(temptext, <span class="number">0</span>, <span class="keyword">sizeof</span>(temptext));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * we have login name saved in context-&gt;FileName from USER command</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (!config_parse(g_cfg.ConfigFile, context-&gt;FileName, <span class="string">&quot;pswd&quot;</span>, temptext, <span class="keyword">sizeof</span>(temptext))) <span class="comment">/* 提取密码 */</span></span><br><span class="line">        <span class="keyword">return</span> sendstring(context, error530_r);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( (<span class="built_in">strcmp</span>(temptext, params) == <span class="number">0</span>) || (temptext[<span class="number">0</span>] == <span class="string">&#x27;*&#x27;</span>) )</span><br><span class="line">    &#123; <span class="comment">/* 密码匹配成功,或者密码设置为&#x27;*&#x27; */</span></span><br><span class="line">        <span class="built_in">memset</span>(context-&gt;RootDir, <span class="number">0</span>, <span class="keyword">sizeof</span>(context-&gt;RootDir));</span><br><span class="line">        <span class="built_in">memset</span>(temptext, <span class="number">0</span>, <span class="keyword">sizeof</span>(temptext));</span><br><span class="line"></span><br><span class="line">        config_parse(g_cfg.ConfigFile, context-&gt;FileName, <span class="string">&quot;root&quot;</span>, context-&gt;RootDir, <span class="keyword">sizeof</span>(context-&gt;RootDir)); <span class="comment">/* 提取根目录路径 */</span></span><br><span class="line">        config_parse(g_cfg.ConfigFile, context-&gt;FileName, <span class="string">&quot;accs&quot;</span>, temptext, <span class="keyword">sizeof</span>(temptext)); <span class="comment">/* 提取登录设置 */</span></span><br><span class="line"></span><br><span class="line">        context-&gt;Access = FTP_ACCESS_NOT_LOGGED_IN;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ( strcasecmp(temptext, <span class="string">&quot;admin&quot;</span>) == <span class="number">0</span> ) &#123; </span><br><span class="line">                <span class="comment">/* 登录设置为&quot;admin&quot;:启用所有功能 */</span></span><br><span class="line">                context-&gt;Access = FTP_ACCESS_FULL;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ( strcasecmp(temptext, <span class="string">&quot;upload&quot;</span>) == <span class="number">0</span> ) &#123; </span><br><span class="line">                <span class="comment">/* 登录设置为&quot;upload&quot;:</span></span><br><span class="line"><span class="comment">                允许:创建新目录,存储新文件附加</span></span><br><span class="line"><span class="comment">                禁用:重命名,删除 */</span></span><br><span class="line">                context-&gt;Access = FTP_ACCESS_CREATENEW;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ( strcasecmp(temptext, <span class="string">&quot;readonly&quot;</span>) == <span class="number">0</span> ) &#123; </span><br><span class="line">                <span class="comment">/* 登录设置为&quot;readonly&quot;:只需读取目录和下载文件 */</span></span><br><span class="line">                context-&gt;Access = FTP_ACCESS_READONLY;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> sendstring(context, error530_b);</span><br><span class="line">        &#125; <span class="keyword">while</span> (<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        writelogentry(context, <span class="string">&quot; PASS-&gt;successful logon&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> sendstring(context, error530_r);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> sendstring(context, success230);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>列出目标目录中所有的文件：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ftpLIST</span><span class="params">(PFTPCONTEXT context, <span class="keyword">const</span> <span class="keyword">char</span> *params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span>	<span class="title">stat</span>	<span class="title">filestats</span>;</span></span><br><span class="line">    <span class="keyword">pthread_t</span>		tid;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (context-&gt;Access == FTP_ACCESS_NOT_LOGGED_IN)</span><br><span class="line">        <span class="keyword">return</span> sendstring(context, error530); </span><br><span class="line">    <span class="keyword">if</span> (context-&gt;WorkerThreadValid == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> sendstring(context, <span class="keyword">error550_t</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (params != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ((<span class="built_in">strcmp</span>(params, <span class="string">&quot;-a&quot;</span>) == <span class="number">0</span>) || (<span class="built_in">strcmp</span>(params, <span class="string">&quot;-l&quot;</span>) == <span class="number">0</span>))</span><br><span class="line">            params = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ftp_effective_path(context-&gt;RootDir, context-&gt;CurrentDir, params, <span class="keyword">sizeof</span>(context-&gt;FileName), context-&gt;FileName); <span class="comment">/* 通过设置的根目录来获取目标目录的绝对路径(结果存放于context-&gt;FileName) */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (stat(context-&gt;FileName, &amp;filestats) == <span class="number">0</span>)</span><br><span class="line">    &#123; <span class="comment">/* 使用stat函数获取文件信息(已经获取了文件的绝对路径) */</span> </span><br><span class="line">        <span class="keyword">if</span> ( !S_ISDIR(filestats.st_mode) ) <span class="comment">/* filestats.st_mode是否是一个目录 */</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        sendstring(context, interm150);</span><br><span class="line">        writelogentry(context, <span class="string">&quot; LIST&quot;</span>, (<span class="keyword">char</span> *)params);</span><br><span class="line">        context-&gt;WorkerThreadAbort = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        pthread_mutex_lock(&amp;context-&gt;MTLock);</span><br><span class="line"></span><br><span class="line">        context-&gt;WorkerThreadValid = pthread_create(&amp;tid, <span class="literal">NULL</span>, (<span class="keyword">void</span> * (*)(<span class="keyword">void</span> *))list_thread, context); </span><br><span class="line">        <span class="comment">/* 设置一个线程</span></span><br><span class="line"><span class="comment">        用于完成:打开目录,读取文件信息,组织输出等一系列工作 */</span></span><br><span class="line">        <span class="keyword">if</span> ( context-&gt;WorkerThreadValid == <span class="number">0</span> )</span><br><span class="line">            context-&gt;WorkerThreadId = tid;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            sendstring(context, error451);</span><br><span class="line"></span><br><span class="line">        pthread_mutex_unlock(&amp;context-&gt;MTLock);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> sendstring(context, error550);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>从服务器上下载目标文件：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ftpRETR</span><span class="params">(PFTPCONTEXT context, <span class="keyword">const</span> <span class="keyword">char</span> *params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span>	<span class="title">stat</span>	<span class="title">filestats</span>;</span></span><br><span class="line">    <span class="keyword">pthread_t</span>		tid;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (context-&gt;Access == FTP_ACCESS_NOT_LOGGED_IN)</span><br><span class="line">        <span class="keyword">return</span> sendstring(context, error530);</span><br><span class="line">    <span class="keyword">if</span> (context-&gt;WorkerThreadValid == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> sendstring(context, <span class="keyword">error550_t</span>);</span><br><span class="line">    <span class="keyword">if</span> ( params == <span class="literal">NULL</span> )</span><br><span class="line">        <span class="keyword">return</span> sendstring(context, error501);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( context-&gt;File != <span class="number">-1</span> ) &#123;</span><br><span class="line">        close(context-&gt;File);</span><br><span class="line">        context-&gt;File = <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ftp_effective_path(context-&gt;RootDir, context-&gt;CurrentDir, params, <span class="keyword">sizeof</span>(context-&gt;FileName), context-&gt;FileName); <span class="comment">/* 获取目标文件的绝对路径 */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (stat(context-&gt;FileName, &amp;filestats) == <span class="number">0</span>)</span><br><span class="line">    &#123; <span class="comment">/* 获取该文件的状态 */</span></span><br><span class="line">        <span class="keyword">if</span> ( S_ISDIR(filestats.st_mode) )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        sendstring(context, interm150);</span><br><span class="line">        writelogentry(context, <span class="string">&quot; RETR: &quot;</span>, (<span class="keyword">char</span> *)params);</span><br><span class="line">        context-&gt;WorkerThreadAbort = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        pthread_mutex_lock(&amp;context-&gt;MTLock);</span><br><span class="line"></span><br><span class="line">        context-&gt;WorkerThreadValid = pthread_create(&amp;tid, <span class="literal">NULL</span>, (<span class="keyword">void</span> * (*)(<span class="keyword">void</span> *))retr_thread, context); <span class="comment">/* 设置一个线程来完成下载操作 */</span></span><br><span class="line">        <span class="keyword">if</span> ( context-&gt;WorkerThreadValid == <span class="number">0</span> )</span><br><span class="line">            context-&gt;WorkerThreadId = tid;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            sendstring(context, error451);</span><br><span class="line"></span><br><span class="line">        pthread_mutex_unlock(&amp;context-&gt;MTLock);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> sendstring(context, error550);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">f = open(context-&gt;FileName, O_RDONLY); <span class="comment">/* 打开目标文件 */</span></span><br><span class="line">context-&gt;File = f;</span><br><span class="line"><span class="keyword">if</span> (f == <span class="number">-1</span>)</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">offset = lseek(f, context-&gt;RestPoint, SEEK_SET); <span class="comment">/* 重新设置文件指针(如果文件过大则需要分多次进行传输) */</span></span><br><span class="line"><span class="keyword">if</span> (offset != context-&gt;RestPoint)</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">sent_ok = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">while</span> ( context-&gt;WorkerThreadAbort == <span class="number">0</span> ) &#123;</span><br><span class="line">    sz = read(f, buffer, buffer_size); <span class="comment">/* 把文件内容读取到本地内存 */</span></span><br><span class="line">    <span class="keyword">if</span> (sz == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sz &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        sent_ok = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (send_auto(clientsocket, TLS_datasession, buffer, sz) == sz) </span><br><span class="line">    &#123; <span class="comment">/* 发送数据到客户端 */</span></span><br><span class="line">        sz_total += sz; </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        sent_ok = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

    </div>

    
    
    

      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/FTP/" rel="tag"><i class="fa fa-tag"></i> FTP</a>
              <a href="/tags/Net-Knowledge/" rel="tag"><i class="fa fa-tag"></i> Net Knowledge</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2023/01/12/%E6%9D%A1%E4%BB%B6%E7%AB%9E%E4%BA%89+FTP%E5%8D%8F%E8%AE%AE%E7%AE%80%E6%9E%90/" rel="prev" title="条件竞争+FTP协议简析">
      <i class="fa fa-chevron-left"></i> 条件竞争+FTP协议简析
    </a></div>
      <div class="post-nav-item">
    <a href="/2023/02/01/userfaultfd+setxattr+pt_regs/" rel="next" title="userfaultfd+setxattr+pt_regs">
      userfaultfd+setxattr+pt_regs <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yhellow"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">yhellow</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">297</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">155</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yhellow</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">4.2m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">63:11</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
