<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="Triton 的安装与使用二进制分析框架 Triton 主要用于分析和检查二进制文件，包括可执行文件、动态链接库等 它的主要功能包括:  反汇编和分析: Triton 可以反汇编二进制文件,生成汇编代码，供安全研究人员分析 它支持多种指令集架构，如 x86、ARM 等   自动化分析: Triton 提供了丰富的 API，支持开发者编写自动化的二进制分析脚本 这些脚本可用于检测二进制文件中的漏洞、">
<meta property="og:type" content="article">
<meta property="og:title" content="Triton以及基于它实现的工具">
<meta property="og:url" content="http://example.com/2024/07/15/Triton%E4%BB%A5%E5%8F%8A%E5%9F%BA%E4%BA%8E%E5%AE%83%E5%AE%9E%E7%8E%B0%E7%9A%84%E5%B7%A5%E5%85%B7/index.html">
<meta property="og:site_name" content="Pwn进你的心">
<meta property="og:description" content="Triton 的安装与使用二进制分析框架 Triton 主要用于分析和检查二进制文件，包括可执行文件、动态链接库等 它的主要功能包括:  反汇编和分析: Triton 可以反汇编二进制文件,生成汇编代码，供安全研究人员分析 它支持多种指令集架构，如 x86、ARM 等   自动化分析: Triton 提供了丰富的 API，支持开发者编写自动化的二进制分析脚本 这些脚本可用于检测二进制文件中的漏洞、">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2024-07-15T14:20:40.000Z">
<meta property="article:modified_time" content="2024-07-15T14:22:11.377Z">
<meta property="article:author" content="yhellow">
<meta property="article:tag" content="triton">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/2024/07/15/Triton%E4%BB%A5%E5%8F%8A%E5%9F%BA%E4%BA%8E%E5%AE%83%E5%AE%9E%E7%8E%B0%E7%9A%84%E5%B7%A5%E5%85%B7/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>Triton以及基于它实现的工具 | Pwn进你的心</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Pwn进你的心</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/07/15/Triton%E4%BB%A5%E5%8F%8A%E5%9F%BA%E4%BA%8E%E5%AE%83%E5%AE%9E%E7%8E%B0%E7%9A%84%E5%B7%A5%E5%85%B7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Triton以及基于它实现的工具
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2024-07-15 22:20:40 / Modified: 22:22:11" itemprop="dateCreated datePublished" datetime="2024-07-15T22:20:40+08:00">2024-07-15</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>38k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>34 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="Triton-的安装与使用"><a href="#Triton-的安装与使用" class="headerlink" title="Triton 的安装与使用"></a>Triton 的安装与使用</h2><p>二进制分析框架 Triton 主要用于分析和检查二进制文件，包括可执行文件、动态链接库等</p>
<p>它的主要功能包括:</p>
<ol>
<li><strong>反汇编和分析</strong>:<ul>
<li>Triton 可以反汇编二进制文件,生成汇编代码，供安全研究人员分析</li>
<li>它支持多种指令集架构，如 x86、ARM 等</li>
</ul>
</li>
<li><strong>自动化分析</strong>:<ul>
<li>Triton 提供了丰富的 API，支持开发者编写自动化的二进制分析脚本</li>
<li>这些脚本可用于检测二进制文件中的漏洞、恶意代码等安全隐患</li>
</ul>
</li>
<li><strong>插件扩展</strong>:<ul>
<li>Triton 支持通过插件的方式扩展其功能，满足不同安全研究人员的特定需求</li>
<li>开发者可以编写自定义的分析插件，集成到 Triton 中使用</li>
</ul>
</li>
<li><strong>交互式分析</strong>:<ul>
<li>Triton 提供了交互式的命令行界面，安全研究人员可以在此进行手工分析、调试等操作</li>
<li>它支持设置断点、单步执行等调试功能</li>
</ul>
</li>
<li><strong>跨平台支持</strong>:<ul>
<li>Triton 可以运行在 Windows、Linux、macOS 等多种操作系统上，为安全研究提供跨平台的分析能力</li>
</ul>
</li>
</ol>
<p>在 Triton 中执行的执行是由我们控制的，污点分析和符号执行都是基于模拟执行实现的</p>
<p>Triton 需要的依赖如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">* libcapstone                &gt;= 4.0.x   https://github.com/capstone-engine/capstone</span><br><span class="line">* libboost      (optional)   &gt;= 1.68</span><br><span class="line">* libpython     (optional)   &gt;= 3.6</span><br><span class="line">* libz3         (optional)   &gt;= 4.6.0   https://github.com/Z3Prover/z3</span><br><span class="line">* libbitwuzla   (optional)   &gt;= 0.4.x   https://github.com/bitwuzla/bitwuzla</span><br><span class="line">* llvm          (optional)   &gt;= 12</span><br></pre></td></tr></table></figure>
<ul>
<li>如果编译生成的 /usr/lib/python3.8/site-packages/triton.so 出现段错误，则大概率是 libcapstone 的版本问题</li>
</ul>
<p>使用 vcpkg 下载 Triton 以及依赖：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/Microsoft/vcpkg.git</span><br><span class="line">cd vcpkg</span><br><span class="line">./bootstrap-vcpkg.sh  # ./bootstrap-vcpkg.bat for Windows</span><br><span class="line">./vcpkg integrate install</span><br><span class="line">./vcpkg install triton</span><br></pre></td></tr></table></figure>
<ul>
<li>Vcpkg（Visual C++ Package Manager）是一个由微软开发的命令行包管理器，用于C++语言</li>
<li>它旨在简化在各种平台上获取和安装C++库的过程，特别是 Windows</li>
<li>Vcpkg 支持多种编译器和构建系统，并且可以与 Visual Studio 集成</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./vcpkg list				# 列出已安装的库</span><br><span class="line">./vcpkg search &lt;keyword&gt;	 # 搜索可用的库</span><br><span class="line">./vcpkg update				# 更新vcpkg</span><br></pre></td></tr></table></figure>
<p>在安装 Triton 此之前需要先安装 z3（在 vcpkg 中可以找到）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">python scripts/mk_make.py --prefix=/home/yhellow --python --pypkgdir=/home/yhellow/.local/lib/python3.8/site-packages/</span><br><span class="line">cd build</span><br><span class="line">make -j8</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>
<p>然后使用如下命令安装 Triton：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mkdir build</span><br><span class="line">cd build</span><br><span class="line">cmake ..</span><br><span class="line">make -j8</span><br><span class="line">sudo make install</span><br><span class="line">sudo mv /usr/lib/python3.8/site-packages/triton.so /home/yhellow/.local/lib/python3.8/site-packages/</span><br></pre></td></tr></table></figure>
<h3 id="Triton-模拟执行"><a href="#Triton-模拟执行" class="headerlink" title="Triton 模拟执行"></a>Triton 模拟执行</h3><p>模拟执行（Emulation）是一种技术，它允许软件或硬件模拟另一系统的行为，以便在不同的环境中运行程序或执行任务 </p>
<p>使用案例如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</span><br><span class="line"><span class="keyword">from</span> triton <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">code = [ <span class="comment"># 每一项的结构是 (指令的地址， 指令的字节码)</span></span><br><span class="line">    (<span class="number">0x400000</span>, <span class="string">b&quot;\x48\x8b\x05\xb8\x13\x00\x00&quot;</span>), <span class="comment"># mov        rax, QWORD PTR [rip+0x13b8]</span></span><br><span class="line">    (<span class="number">0x400007</span>, <span class="string">b&quot;\x48\x8d\x34\xc3&quot;</span>),             <span class="comment"># lea        rsi, [rbx+rax*8]</span></span><br><span class="line">    (<span class="number">0x40000b</span>, <span class="string">b&quot;\x67\x48\x8D\x74\xC3\x0A&quot;</span>),     <span class="comment"># lea        rsi, [ebx+eax*8+0xa]</span></span><br><span class="line">    (<span class="number">0x400011</span>, <span class="string">b&quot;\x66\x0F\xD7\xD1&quot;</span>),             <span class="comment"># pmovmskb   edx, xmm1</span></span><br><span class="line">    (<span class="number">0x400015</span>, <span class="string">b&quot;\x89\xd0&quot;</span>),                     <span class="comment"># mov        eax, edx</span></span><br><span class="line">    (<span class="number">0x400017</span>, <span class="string">b&quot;\x80\xf4\x99&quot;</span>),                 <span class="comment"># xor        ah, 0x99</span></span><br><span class="line">    (<span class="number">0x40001a</span>, <span class="string">b&quot;\xC5\xFD\x6F\xCA&quot;</span>),             <span class="comment"># vmovdqa    ymm1, ymm2</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    ctx = TritonContext()</span><br><span class="line">    ctx.setArchitecture(ARCH.X86_64) <span class="comment"># 设置模拟执行的代码架构</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (addr, opcode) <span class="keyword">in</span> code:</span><br><span class="line">        inst = Instruction()   <span class="comment"># 新建一个指令对象</span></span><br><span class="line">        inst.setOpcode(opcode) <span class="comment"># 传递字节码</span></span><br><span class="line">        inst.setAddress(addr)  <span class="comment"># 传递指令的地址</span></span><br><span class="line">        ctx.processing(inst)   <span class="comment"># 执行指令</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(inst)	<span class="comment"># 打印指令的信息</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;    ---------------&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;    Is memory read :&#x27;</span>, inst.isMemoryRead())</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;    Is memory write:&#x27;</span>, inst.isMemoryWrite())</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;    ---------------&#x27;</span>)</span><br><span class="line">        <span class="keyword">for</span> op <span class="keyword">in</span> inst.getOperands():</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;    Operand:&#x27;</span>, op)</span><br><span class="line">            <span class="keyword">if</span> op.getType() == OPERAND.MEM:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;    - segment :&#x27;</span>, op.getSegmentRegister())</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;    - base    :&#x27;</span>, op.getBaseRegister())</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;    - index   :&#x27;</span>, op.getIndexRegister())</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;    - scale   :&#x27;</span>, op.getScale())</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;    - disp    :&#x27;</span>, op.getDisplacement())</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;    ---------------&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>()</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x400000</span>: mov rax, qword ptr [rip + <span class="number">0x13b8</span>]</span><br><span class="line">    ---------------</span><br><span class="line">    Is memory read : True</span><br><span class="line">    Is memory write: False</span><br><span class="line">    ---------------</span><br><span class="line">    Operand: rax:<span class="number">64</span> bv[<span class="number">63.</span><span class="number">.0</span>]</span><br><span class="line">    ---------------</span><br><span class="line">    Operand: [@<span class="number">0x4013bf</span>]:<span class="number">64</span> bv[<span class="number">63.</span><span class="number">.0</span>]</span><br><span class="line">    - segment : unknown:<span class="number">1</span> bv[<span class="number">0.</span><span class="number">.0</span>]</span><br><span class="line">    - base    : rip:<span class="number">64</span> bv[<span class="number">63.</span><span class="number">.0</span>]</span><br><span class="line">    - index   : unknown:<span class="number">1</span> bv[<span class="number">0.</span><span class="number">.0</span>]</span><br><span class="line">    - scale   : <span class="number">0x1</span>:<span class="number">64</span> bv[<span class="number">63.</span><span class="number">.0</span>]</span><br><span class="line">    - disp    : <span class="number">0x13b8</span>:<span class="number">64</span> bv[<span class="number">63.</span><span class="number">.0</span>]</span><br><span class="line">    ---------------</span><br><span class="line"></span><br><span class="line"><span class="number">0x400007</span>: lea rsi, [rbx + rax*<span class="number">8</span>]</span><br><span class="line">    ---------------</span><br><span class="line">    Is memory read : False</span><br><span class="line">    Is memory write: False</span><br><span class="line">    ---------------</span><br><span class="line">    Operand: rsi:<span class="number">64</span> bv[<span class="number">63.</span><span class="number">.0</span>]</span><br><span class="line">    ---------------</span><br><span class="line">    Operand: [@<span class="number">0x0</span>]:<span class="number">64</span> bv[<span class="number">63.</span><span class="number">.0</span>]</span><br><span class="line">    - segment : unknown:<span class="number">1</span> bv[<span class="number">0.</span><span class="number">.0</span>]</span><br><span class="line">    - base    : rbx:<span class="number">64</span> bv[<span class="number">63.</span><span class="number">.0</span>]</span><br><span class="line">    - index   : rax:<span class="number">64</span> bv[<span class="number">63.</span><span class="number">.0</span>]</span><br><span class="line">    - scale   : <span class="number">0x8</span>:<span class="number">64</span> bv[<span class="number">63.</span><span class="number">.0</span>]</span><br><span class="line">    - disp    : <span class="number">0x0</span>:<span class="number">64</span> bv[<span class="number">63.</span><span class="number">.0</span>]</span><br><span class="line">    ---------------</span><br><span class="line"></span><br><span class="line"><span class="number">0x40000b</span>: lea rsi, [ebx + eax*<span class="number">8</span> + <span class="number">0xa</span>]</span><br><span class="line">    ---------------</span><br><span class="line">    Is memory read : False</span><br><span class="line">    Is memory write: False</span><br><span class="line">    ---------------</span><br><span class="line">    Operand: rsi:<span class="number">64</span> bv[<span class="number">63.</span><span class="number">.0</span>]</span><br><span class="line">    ---------------</span><br><span class="line">    Operand: [@<span class="number">0xa</span>]:<span class="number">64</span> bv[<span class="number">63.</span><span class="number">.0</span>]</span><br><span class="line">    - segment : unknown:<span class="number">1</span> bv[<span class="number">0.</span><span class="number">.0</span>]</span><br><span class="line">    - base    : ebx:<span class="number">32</span> bv[<span class="number">31.</span><span class="number">.0</span>]</span><br><span class="line">    - index   : eax:<span class="number">32</span> bv[<span class="number">31.</span><span class="number">.0</span>]</span><br><span class="line">    - scale   : <span class="number">0x8</span>:<span class="number">32</span> bv[<span class="number">31.</span><span class="number">.0</span>]</span><br><span class="line">    - disp    : <span class="number">0xa</span>:<span class="number">32</span> bv[<span class="number">31.</span><span class="number">.0</span>]</span><br><span class="line">    ---------------</span><br><span class="line"></span><br><span class="line"><span class="number">0x400011</span>: pmovmskb edx, xmm1</span><br><span class="line">    ---------------</span><br><span class="line">    Is memory read : False</span><br><span class="line">    Is memory write: False</span><br><span class="line">    ---------------</span><br><span class="line">    Operand: edx:<span class="number">32</span> bv[<span class="number">31.</span><span class="number">.0</span>]</span><br><span class="line">    ---------------</span><br><span class="line">    Operand: xmm1:<span class="number">128</span> bv[<span class="number">127.</span><span class="number">.0</span>]</span><br><span class="line">    ---------------</span><br><span class="line"></span><br><span class="line"><span class="number">0x400015</span>: mov eax, edx</span><br><span class="line">    ---------------</span><br><span class="line">    Is memory read : False</span><br><span class="line">    Is memory write: False</span><br><span class="line">    ---------------</span><br><span class="line">    Operand: eax:<span class="number">32</span> bv[<span class="number">31.</span><span class="number">.0</span>]</span><br><span class="line">    ---------------</span><br><span class="line">    Operand: edx:<span class="number">32</span> bv[<span class="number">31.</span><span class="number">.0</span>]</span><br><span class="line">    ---------------</span><br><span class="line"></span><br><span class="line"><span class="number">0x400017</span>: <span class="keyword">xor</span> ah, <span class="number">0x99</span></span><br><span class="line">    ---------------</span><br><span class="line">    Is memory read : False</span><br><span class="line">    Is memory write: False</span><br><span class="line">    ---------------</span><br><span class="line">    Operand: ah:<span class="number">8</span> bv[<span class="number">15.</span><span class="number">.8</span>]</span><br><span class="line">    ---------------</span><br><span class="line">    Operand: <span class="number">0x99</span>:<span class="number">8</span> bv[<span class="number">7.</span><span class="number">.0</span>]</span><br><span class="line">    ---------------</span><br><span class="line"></span><br><span class="line"><span class="number">0x40001a</span>: vmovdqa ymm1, ymm2</span><br><span class="line">    ---------------</span><br><span class="line">    Is memory read : False</span><br><span class="line">    Is memory write: False</span><br><span class="line">    ---------------</span><br><span class="line">    Operand: ymm1:<span class="number">256</span> bv[<span class="number">255.</span><span class="number">.0</span>]</span><br><span class="line">    ---------------</span><br><span class="line">    Operand: ymm2:<span class="number">256</span> bv[<span class="number">255.</span><span class="number">.0</span>]</span><br><span class="line">    ---------------</span><br></pre></td></tr></table></figure>
<p>上述案例还没有展示模拟执行的精髓，下面这个案例将对一个二进制文件进行模拟执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc test.c -o test -static</span><br></pre></td></tr></table></figure>
<ul>
<li>设置静态，因为模拟执行没法识别 .got.plt（某些 <code>stdio.h</code> 库中的函数会被编译器优化，进而在调用时可以直接 call，并不需要借助 .got.plt）</li>
<li>另外设置静态可以关闭 PIE，不需要程序进行格外的偏移计算</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x10</span>];</span><br><span class="line"></span><br><span class="line">    read(<span class="number">0</span>,buf,<span class="number">0x200</span>);</span><br><span class="line">    <span class="keyword">int</span> fd = open(buf,<span class="number">0</span>);</span><br><span class="line">    read(fd ,buf, <span class="number">0x10</span>);</span><br><span class="line">    write(<span class="number">1</span> ,buf, <span class="number">0x10</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>.got.plt 中的地址在磁盘上的二进制文件中可能是占位符，但在内存中会被实际的地址所替换（实际地址从 .rela.plt 中获取）</li>
<li>IDA 会自动分析这些地址，因此在 IDA 中看到的并不是磁盘上的数据</li>
</ul>
<p>模拟执行的脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> triton <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">taint_analysis2</span>(<span class="params">start, end</span>):</span></span><br><span class="line">    ctx = TritonContext()</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;./test&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        bin1 = f.read()</span><br><span class="line"></span><br><span class="line">    ctx.setArchitecture(ARCH.X86_64)</span><br><span class="line">    ctx.setConcreteMemoryAreaValue(<span class="number">0x400000</span>, bin1) <span class="comment"># 将二进制文件加载到0x400000处(这个地址由IDA分析得出,是程序的基地址)</span></span><br><span class="line">    RBP_ADDR = <span class="number">0x60000000</span></span><br><span class="line">    RSP_ADDR = RBP_ADDR - <span class="number">0x20000000</span></span><br><span class="line">    INPUT_ADDR = <span class="number">0x10000000</span></span><br><span class="line"></span><br><span class="line">    ctx.setConcreteRegisterValue(ctx.registers.rip, start) 	  <span class="comment"># 设置rip寄存器</span></span><br><span class="line">    ctx.setConcreteRegisterValue(ctx.registers.rsp, RSP_ADDR) <span class="comment"># 设置rsp寄存器</span></span><br><span class="line">    ctx.setConcreteRegisterValue(ctx.registers.rbp, RBP_ADDR) <span class="comment"># 设置rbp寄存器</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">input</span> = <span class="string">b&quot;yhellow\x00&quot;</span></span><br><span class="line">    ctx.setConcreteMemoryAreaValue(INPUT_ADDR, <span class="built_in">input</span>) <span class="comment"># 将字符串加载到INPUT_ADDR</span></span><br><span class="line">    pc = start</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> pc:</span><br><span class="line">        inst = Instruction()</span><br><span class="line">        opcode = ctx.getConcreteMemoryAreaValue(pc, <span class="number">16</span>) <span class="comment"># 读取opcode</span></span><br><span class="line">        inst.setOpcode(opcode)</span><br><span class="line">        inst.setAddress(pc)</span><br><span class="line">        ctx.processing(inst)</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">str</span>(inst))</span><br><span class="line"></span><br><span class="line">        pc = ctx.getConcreteRegisterValue(ctx.registers.rip) <span class="comment"># 读取rip寄存器</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    taint_analysis2(<span class="number">0x401CD5</span>, <span class="number">0x401D74</span>) <span class="comment"># main的地址范围(在IDA中查看)</span></span><br></pre></td></tr></table></figure>
<p>最终结果如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x401cd5</span>: endbr64</span><br><span class="line"><span class="number">0x401cd9</span>: push rbp</span><br><span class="line"><span class="number">0x401cda</span>: mov rbp, rsp</span><br><span class="line"><span class="number">0x401cdd</span>: sub rsp, <span class="number">0x30</span></span><br><span class="line"><span class="number">0x401ce1</span>: mov rax, qword ptr fs:[<span class="number">0x28</span>]</span><br><span class="line"><span class="number">0x401cea</span>: mov qword ptr [rbp - <span class="number">8</span>], rax</span><br><span class="line"><span class="number">0x401cee</span>: <span class="keyword">xor</span> eax, eax</span><br><span class="line"><span class="number">0x401cf0</span>: lea rax, [rbp - <span class="number">0x20</span>]</span><br><span class="line"><span class="number">0x401cf4</span>: mov edx, <span class="number">0x200</span></span><br><span class="line"><span class="number">0x401cf9</span>: mov rsi, rax</span><br><span class="line"><span class="number">0x401cfc</span>: mov edi, <span class="number">0</span></span><br><span class="line"><span class="number">0x401d01</span>: mov eax, <span class="number">0</span></span><br><span class="line"><span class="number">0x401d06</span>: call <span class="number">0x4483f0</span> <span class="comment">/* 执行call时会跳转到对应的代码 */</span></span><br><span class="line"><span class="number">0x4483f0</span>: endbr64</span><br><span class="line"><span class="number">0x4483f4</span>: mov eax, dword ptr fs:[<span class="number">0x18</span>]</span><br><span class="line"><span class="number">0x4483fc</span>: test eax, eax</span><br><span class="line"><span class="number">0x4483fe</span>: jne <span class="number">0x448410</span></span><br><span class="line"><span class="number">0x448400</span>: syscall</span><br><span class="line"><span class="number">0x448402</span>: cmp rax, <span class="number">-0x1000</span></span><br><span class="line"><span class="number">0x448408</span>: ja <span class="number">0x448460</span></span><br><span class="line"><span class="number">0x44840a</span>: ret <span class="comment">/* 返回原函数 */</span></span><br><span class="line"><span class="number">0x401d0b</span>: lea rax, [rbp - <span class="number">0x20</span>]</span><br><span class="line"><span class="number">0x401d0f</span>: mov esi, <span class="number">0</span></span><br><span class="line"><span class="number">0x401d14</span>: mov rdi, rax</span><br><span class="line"><span class="number">0x401d17</span>: mov eax, <span class="number">0</span></span><br><span class="line"><span class="number">0x401d1c</span>: call <span class="number">0x4482c0</span></span><br><span class="line"><span class="number">0x4482c0</span>: endbr64</span><br><span class="line"><span class="number">0x4482c4</span>: push r12</span><br><span class="line"><span class="number">0x4482c6</span>: mov r10d, esi</span><br><span class="line"><span class="number">0x4482c9</span>: mov r12d, esi</span><br><span class="line"><span class="number">0x4482cc</span>: push rbp</span><br><span class="line"><span class="number">0x4482cd</span>: mov rbp, rdi</span><br><span class="line"><span class="number">0x4482d0</span>: sub rsp, <span class="number">0x68</span></span><br><span class="line"><span class="number">0x4482d4</span>: mov qword ptr [rsp + <span class="number">0x40</span>], rdx</span><br><span class="line"><span class="number">0x4482d9</span>: mov rax, qword ptr fs:[<span class="number">0x28</span>]</span><br><span class="line"><span class="number">0x4482e2</span>: mov qword ptr [rsp + <span class="number">0x28</span>], rax</span><br><span class="line"><span class="number">0x4482e7</span>: <span class="keyword">xor</span> eax, eax</span><br><span class="line"><span class="number">0x4482e9</span>: <span class="keyword">and</span> r10d, <span class="number">0x40</span></span><br><span class="line"><span class="number">0x4482ed</span>: jne <span class="number">0x448348</span></span><br><span class="line"><span class="number">0x4482ef</span>: mov eax, esi</span><br><span class="line"><span class="number">0x4482f1</span>: <span class="keyword">and</span> eax, <span class="number">0x410000</span></span><br><span class="line"><span class="number">0x4482f6</span>: cmp eax, <span class="number">0x410000</span></span><br><span class="line"><span class="number">0x4482fb</span>: je <span class="number">0x448348</span></span><br><span class="line"><span class="number">0x4482fd</span>: mov eax, dword ptr fs:[<span class="number">0x18</span>]</span><br><span class="line"><span class="number">0x448305</span>: test eax, eax</span><br><span class="line"><span class="number">0x448307</span>: jne <span class="number">0x448370</span></span><br><span class="line"><span class="number">0x448309</span>: mov edx, r12d</span><br><span class="line"><span class="number">0x44830c</span>: mov rsi, rbp</span><br><span class="line"><span class="number">0x44830f</span>: mov edi, <span class="number">0xffffff9c</span></span><br><span class="line"><span class="number">0x448314</span>: mov eax, <span class="number">0x101</span></span><br><span class="line"><span class="number">0x448319</span>: syscall</span><br><span class="line"><span class="number">0x44831b</span>: cmp rax, <span class="number">-0x1000</span></span><br><span class="line"><span class="number">0x448321</span>: ja <span class="number">0x4483b8</span></span><br><span class="line"><span class="number">0x448327</span>: mov rcx, qword ptr [rsp + <span class="number">0x28</span>]</span><br><span class="line"><span class="number">0x44832c</span>: <span class="keyword">xor</span> rcx, qword ptr fs:[<span class="number">0x28</span>]</span><br><span class="line"><span class="number">0x448335</span>: jne <span class="number">0x4483e1</span></span><br><span class="line"><span class="number">0x44833b</span>: add rsp, <span class="number">0x68</span></span><br><span class="line"><span class="number">0x44833f</span>: pop rbp</span><br><span class="line"><span class="number">0x448340</span>: pop r12</span><br><span class="line"><span class="number">0x448342</span>: ret</span><br><span class="line"><span class="number">0x401d21</span>: mov dword ptr [rbp - <span class="number">0x24</span>], eax</span><br><span class="line"><span class="number">0x401d24</span>: lea rcx, [rbp - <span class="number">0x20</span>]</span><br><span class="line"><span class="number">0x401d28</span>: mov eax, dword ptr [rbp - <span class="number">0x24</span>]</span><br><span class="line"><span class="number">0x401d2b</span>: mov edx, <span class="number">0x10</span></span><br><span class="line"><span class="number">0x401d30</span>: mov rsi, rcx</span><br><span class="line"><span class="number">0x401d33</span>: mov edi, eax</span><br><span class="line"><span class="number">0x401d35</span>: mov eax, <span class="number">0</span></span><br><span class="line"><span class="number">0x401d3a</span>: call <span class="number">0x4483f0</span></span><br><span class="line"><span class="number">0x4483f0</span>: endbr64</span><br><span class="line"><span class="number">0x4483f4</span>: mov eax, dword ptr fs:[<span class="number">0x18</span>]</span><br><span class="line"><span class="number">0x4483fc</span>: test eax, eax</span><br><span class="line"><span class="number">0x4483fe</span>: jne <span class="number">0x448410</span></span><br><span class="line"><span class="number">0x448400</span>: syscall</span><br><span class="line"><span class="number">0x448402</span>: cmp rax, <span class="number">-0x1000</span></span><br><span class="line"><span class="number">0x448408</span>: ja <span class="number">0x448460</span></span><br><span class="line"><span class="number">0x44840a</span>: ret</span><br><span class="line"><span class="number">0x401d3f</span>: lea rax, [rbp - <span class="number">0x20</span>]</span><br><span class="line"><span class="number">0x401d43</span>: mov edx, <span class="number">0x10</span></span><br><span class="line"><span class="number">0x401d48</span>: mov rsi, rax</span><br><span class="line"><span class="number">0x401d4b</span>: mov edi, <span class="number">1</span></span><br><span class="line"><span class="number">0x401d50</span>: mov eax, <span class="number">0</span></span><br><span class="line"><span class="number">0x401d55</span>: call <span class="number">0x448490</span></span><br><span class="line"><span class="number">0x448490</span>: endbr64</span><br><span class="line"><span class="number">0x448494</span>: mov eax, dword ptr fs:[<span class="number">0x18</span>]</span><br><span class="line"><span class="number">0x44849c</span>: test eax, eax</span><br><span class="line"><span class="number">0x44849e</span>: jne <span class="number">0x4484b0</span></span><br><span class="line"><span class="number">0x4484a0</span>: mov eax, <span class="number">1</span></span><br><span class="line"><span class="number">0x4484a5</span>: syscall</span><br><span class="line"><span class="number">0x4484a7</span>: cmp rax, <span class="number">-0x1000</span></span><br><span class="line"><span class="number">0x4484ad</span>: ja <span class="number">0x448500</span></span><br><span class="line"><span class="number">0x4484af</span>: ret</span><br><span class="line"><span class="number">0x401d5a</span>: mov eax, <span class="number">0</span></span><br><span class="line"><span class="number">0x401d5f</span>: mov rdx, qword ptr [rbp - <span class="number">8</span>]</span><br><span class="line"><span class="number">0x401d63</span>: sub rdx, qword ptr fs:[<span class="number">0x28</span>]</span><br><span class="line"><span class="number">0x401d6c</span>: je <span class="number">0x401d73</span></span><br><span class="line"><span class="number">0x401d73</span>: leave</span><br><span class="line"><span class="number">0x401d74</span>: ret</span><br></pre></td></tr></table></figure>
<h3 id="Triton-污点分析"><a href="#Triton-污点分析" class="headerlink" title="Triton 污点分析"></a>Triton 污点分析</h3><p>污点分析（Taint Analysis）是一种计算机安全分析技术，用于追踪数据在程序中的流动情况，特别是那些可能来源于不信任的输入的数据，这种技术可以帮助识别和预防安全漏洞，如跨站脚本（XSS）、SQL注入、命令注入等</p>
<p>污点分析的脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> triton <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">taint_analysis2</span>(<span class="params">start, end</span>):</span></span><br><span class="line">    ctx = TritonContext()</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;./test&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        bin1 = f.read()</span><br><span class="line"></span><br><span class="line">    ctx.setArchitecture(ARCH.X86_64)</span><br><span class="line">    ctx.setConcreteMemoryAreaValue(<span class="number">0x400000</span>, bin1)</span><br><span class="line">    RBP_ADDR = <span class="number">0x7ffffffde000</span></span><br><span class="line">    RSP_ADDR = RBP_ADDR - <span class="number">0x21000</span></span><br><span class="line">    INPUT_ADDR = <span class="number">0x4C2290</span></span><br><span class="line"></span><br><span class="line">    ctx.setConcreteRegisterValue(ctx.registers.rip, start)</span><br><span class="line">    ctx.setConcreteRegisterValue(ctx.registers.rsp, RSP_ADDR)</span><br><span class="line">    ctx.setConcreteRegisterValue(ctx.registers.rbp, RBP_ADDR)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">input</span> = <span class="string">b&quot;./flag\x00&quot;</span></span><br><span class="line">    ctx.setConcreteMemoryAreaValue(INPUT_ADDR, <span class="built_in">input</span>)</span><br><span class="line">    </span><br><span class="line">    pc = start</span><br><span class="line">    nop_addrs = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> pc:</span><br><span class="line">        inst = Instruction()</span><br><span class="line">        opcode = ctx.getConcreteMemoryAreaValue(pc, <span class="number">16</span>)</span><br><span class="line">        </span><br><span class="line">        inst.setOpcode(opcode)</span><br><span class="line">        inst.setAddress(pc)</span><br><span class="line">        ctx.processing(inst)</span><br><span class="line">    </span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">str</span>(inst))</span><br><span class="line">        <span class="keyword">if</span> pc == <span class="number">0x401cf5</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;--------------&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;taint target: &quot;</span>+<span class="built_in">hex</span>(ctx.getConcreteRegisterValue(ctx.registers.rdi))) <span class="comment"># 获取寄存器的数据</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;--------------&quot;</span>)</span><br><span class="line">            ctx.taintRegister(ctx.registers.rdi) <span class="comment"># 将rdi中的地址数据标记为污点</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> inst.isTainted(): <span class="comment"># 检测该指令是否被污染</span></span><br><span class="line">            nop_addrs.append(<span class="built_in">hex</span>(pc))</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;--------------&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> inst.isMemoryRead():</span><br><span class="line">                <span class="keyword">for</span> op <span class="keyword">in</span> inst.getOperands():</span><br><span class="line">                    <span class="keyword">if</span> op.getType() == OPERAND.MEM:</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">&quot;read:0x&#123;:08x&#125;, size:&#123;&#125;&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">                            op.getAddress(), op.getSize()))</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> inst.isMemoryWrite():</span><br><span class="line">                <span class="keyword">for</span> op <span class="keyword">in</span> inst.getOperands():</span><br><span class="line">                    <span class="keyword">if</span> op.getType() == OPERAND.MEM:</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">&quot;write:0x&#123;:08x&#125;, size:&#123;&#125;&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">                            op.getAddress(), op.getSize()))</span><br><span class="line">                    </span><br><span class="line">        pc = ctx.getConcreteRegisterValue(ctx.registers.rip)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(nop_addrs)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    taint_analysis2(<span class="number">0x401CD5</span>, <span class="number">0x401D3F</span>)</span><br></pre></td></tr></table></figure>
<p>最终结果如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x401cd5</span>: endbr64</span><br><span class="line"><span class="number">0x401cd9</span>: push rbp</span><br><span class="line"><span class="number">0x401cda</span>: mov rbp, rsp</span><br><span class="line"><span class="number">0x401cdd</span>: sub rsp, <span class="number">0x10</span></span><br><span class="line"><span class="number">0x401ce1</span>: mov esi, <span class="number">0</span></span><br><span class="line"><span class="number">0x401ce6</span>: lea rax, [rip + <span class="number">0xc05a3</span>]</span><br><span class="line"><span class="number">0x401ced</span>: mov rdi, rax</span><br><span class="line"><span class="number">0x401cf0</span>: mov eax, <span class="number">0</span></span><br><span class="line"><span class="number">0x401cf5</span>: call <span class="number">0x448280</span></span><br><span class="line">--------------</span><br><span class="line">taint target: <span class="number">0x4c2290</span></span><br><span class="line">--------------</span><br><span class="line"><span class="number">0x448280</span>: endbr64</span><br><span class="line"><span class="number">0x448284</span>: push r12</span><br><span class="line"><span class="number">0x448286</span>: mov r10d, esi</span><br><span class="line"><span class="number">0x448289</span>: mov r12d, esi</span><br><span class="line"><span class="number">0x44828c</span>: push rbp</span><br><span class="line"><span class="number">0x44828d</span>: mov rbp, rdi</span><br><span class="line">--------------</span><br><span class="line"><span class="number">0x448290</span>: sub rsp, <span class="number">0x68</span></span><br><span class="line"><span class="number">0x448294</span>: mov qword ptr [rsp + <span class="number">0x40</span>], rdx</span><br><span class="line"><span class="number">0x448299</span>: mov rax, qword ptr fs:[<span class="number">0x28</span>]</span><br><span class="line"><span class="number">0x4482a2</span>: mov qword ptr [rsp + <span class="number">0x28</span>], rax</span><br><span class="line"><span class="number">0x4482a7</span>: <span class="keyword">xor</span> eax, eax</span><br><span class="line"><span class="number">0x4482a9</span>: <span class="keyword">and</span> r10d, <span class="number">0x40</span></span><br><span class="line"><span class="number">0x4482ad</span>: jne <span class="number">0x448308</span></span><br><span class="line"><span class="number">0x4482af</span>: mov eax, esi</span><br><span class="line"><span class="number">0x4482b1</span>: <span class="keyword">and</span> eax, <span class="number">0x410000</span></span><br><span class="line"><span class="number">0x4482b6</span>: cmp eax, <span class="number">0x410000</span></span><br><span class="line"><span class="number">0x4482bb</span>: je <span class="number">0x448308</span></span><br><span class="line"><span class="number">0x4482bd</span>: mov eax, dword ptr fs:[<span class="number">0x18</span>]</span><br><span class="line"><span class="number">0x4482c5</span>: test eax, eax</span><br><span class="line"><span class="number">0x4482c7</span>: jne <span class="number">0x448330</span></span><br><span class="line"><span class="number">0x4482c9</span>: mov edx, r12d</span><br><span class="line"><span class="number">0x4482cc</span>: mov rsi, rbp</span><br><span class="line">--------------</span><br><span class="line"><span class="number">0x4482cf</span>: mov edi, <span class="number">0xffffff9c</span></span><br><span class="line"><span class="number">0x4482d4</span>: mov eax, <span class="number">0x101</span></span><br><span class="line"><span class="number">0x4482d9</span>: syscall</span><br><span class="line"><span class="number">0x4482db</span>: cmp rax, <span class="number">-0x1000</span></span><br><span class="line"><span class="number">0x4482e1</span>: ja <span class="number">0x448378</span></span><br><span class="line"><span class="number">0x4482e7</span>: mov rcx, qword ptr [rsp + <span class="number">0x28</span>]</span><br><span class="line"><span class="number">0x4482ec</span>: <span class="keyword">xor</span> rcx, qword ptr fs:[<span class="number">0x28</span>]</span><br><span class="line"><span class="number">0x4482f5</span>: jne <span class="number">0x4483a1</span></span><br><span class="line"><span class="number">0x4482fb</span>: add rsp, <span class="number">0x68</span></span><br><span class="line"><span class="number">0x4482ff</span>: pop rbp</span><br><span class="line"><span class="number">0x448300</span>: pop r12</span><br><span class="line"><span class="number">0x448302</span>: ret</span><br><span class="line"><span class="number">0x401cfa</span>: mov dword ptr [rbp - <span class="number">4</span>], eax</span><br><span class="line"><span class="number">0x401cfd</span>: mov eax, dword ptr [rbp - <span class="number">4</span>]</span><br><span class="line"><span class="number">0x401d00</span>: mov edx, <span class="number">0x10</span></span><br><span class="line"><span class="number">0x401d05</span>: lea rcx, [rip + <span class="number">0xc0584</span>]</span><br><span class="line"><span class="number">0x401d0c</span>: mov rsi, rcx</span><br><span class="line"><span class="number">0x401d0f</span>: mov edi, eax</span><br><span class="line"><span class="number">0x401d11</span>: mov eax, <span class="number">0</span></span><br><span class="line"><span class="number">0x401d16</span>: call <span class="number">0x4483b0</span></span><br><span class="line"><span class="number">0x4483b0</span>: endbr64</span><br><span class="line"><span class="number">0x4483b4</span>: mov eax, dword ptr fs:[<span class="number">0x18</span>]</span><br><span class="line"><span class="number">0x4483bc</span>: test eax, eax</span><br><span class="line"><span class="number">0x4483be</span>: jne <span class="number">0x4483d0</span></span><br><span class="line"><span class="number">0x4483c0</span>: syscall</span><br><span class="line"><span class="number">0x4483c2</span>: cmp rax, <span class="number">-0x1000</span></span><br><span class="line"><span class="number">0x4483c8</span>: ja <span class="number">0x448420</span></span><br><span class="line"><span class="number">0x4483ca</span>: ret</span><br><span class="line"><span class="number">0x401d1b</span>: mov edx, <span class="number">0x10</span></span><br><span class="line"><span class="number">0x401d20</span>: lea rax, [rip + <span class="number">0xc0569</span>]</span><br><span class="line"><span class="number">0x401d27</span>: mov rsi, rax</span><br><span class="line"><span class="number">0x401d2a</span>: mov edi, <span class="number">1</span></span><br><span class="line"><span class="number">0x401d2f</span>: mov eax, <span class="number">0</span></span><br><span class="line"><span class="number">0x401d34</span>: call <span class="number">0x448450</span></span><br><span class="line"><span class="number">0x448450</span>: endbr64</span><br><span class="line"><span class="number">0x448454</span>: mov eax, dword ptr fs:[<span class="number">0x18</span>]</span><br><span class="line"><span class="number">0x44845c</span>: test eax, eax</span><br><span class="line"><span class="number">0x44845e</span>: jne <span class="number">0x448470</span></span><br><span class="line"><span class="number">0x448460</span>: mov eax, <span class="number">1</span></span><br><span class="line"><span class="number">0x448465</span>: syscall</span><br><span class="line"><span class="number">0x448467</span>: cmp rax, <span class="number">-0x1000</span></span><br><span class="line"><span class="number">0x44846d</span>: ja <span class="number">0x4484c0</span></span><br><span class="line"><span class="number">0x44846f</span>: ret</span><br><span class="line"><span class="number">0x401d39</span>: mov eax, <span class="number">0</span></span><br><span class="line"><span class="number">0x401d3e</span>: leave</span><br><span class="line"><span class="number">0x401d3f</span>: ret</span><br><span class="line">[<span class="string">&#x27;0x44828d&#x27;</span>, <span class="string">&#x27;0x4482cc&#x27;</span>]</span><br></pre></td></tr></table></figure>
<ul>
<li>在 GDB 中可以查看这两处地址的数据：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">	......</span><br><span class="line">*RDI  <span class="number">0x4c2290</span> (buf) ◂— <span class="number">0x0</span></span><br><span class="line">    ......</span><br><span class="line">*RBP  <span class="number">0x7fffffffdb40</span> —▸ <span class="number">0x402d20</span> (__libc_csu_init) ◂— endbr64 </span><br><span class="line">*RSP  <span class="number">0x7fffffffdb18</span> —▸ <span class="number">0x7fffffffdb40</span> —▸ <span class="number">0x402d20</span> (__libc_csu_init) ◂— endbr64 </span><br><span class="line">*RIP  <span class="number">0x44828d</span> (open64+<span class="number">13</span>) ◂— mov    rbp, rdi</span><br><span class="line">───────────────────────────────────[ DISASM ]───────────────────────────────────</span><br><span class="line"> ► <span class="number">0x44828d</span> &lt;open64+<span class="number">13</span>&gt;     mov    rbp, rdi                      &lt;buf&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">	......</span><br><span class="line"> RSI  <span class="number">0x0</span></span><br><span class="line">	......</span><br><span class="line">*RBP  <span class="number">0x4c2290</span> (buf) ◂— <span class="number">0x0</span></span><br><span class="line">*RSP  <span class="number">0x7fffffffdab0</span> ◂— <span class="number">0x1b</span></span><br><span class="line">*RIP  <span class="number">0x4482cc</span> (open64+<span class="number">76</span>) ◂— mov    rsi, rbp</span><br><span class="line">───────────────────────────────────[ DISASM ]───────────────────────────────────</span><br><span class="line"> ► <span class="number">0x4482cc</span> &lt;open64+<span class="number">76</span>&gt;     mov    rsi, rbp                      &lt;buf&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>可以发现两处被污染的指令都是引用了 0x4c2290 这处数据，但这并不意味着只要有 0x4c2290 就会被污染</li>
<li>可以分析如下数据：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">	......</span><br><span class="line">*RCX  <span class="number">0x4c2290</span> (buf) ◂— <span class="number">0x0</span></span><br><span class="line">	......</span><br><span class="line"> RSI  <span class="number">0x4c2290</span> (buf) ◂— <span class="number">0x0</span></span><br><span class="line">	......</span><br><span class="line"> RBP  <span class="number">0x7fffffffdb40</span> —▸ <span class="number">0x402d20</span> (__libc_csu_init) ◂— endbr64 </span><br><span class="line"> RSP  <span class="number">0x7fffffffdb30</span> ◂— <span class="number">0x0</span></span><br><span class="line">*RIP  <span class="number">0x401d0c</span> (main+<span class="number">55</span>) ◂— mov    rsi, rcx</span><br><span class="line">───────────────────────────────────[ DISASM ]───────────────────────────────────</span><br><span class="line"> ► <span class="number">0x401d0c</span> &lt;main+<span class="number">55</span>&gt;       mov    rsi, rcx</span><br></pre></td></tr></table></figure>
<ul>
<li>虽然也是引用了 0x4c2290，但这个 0x4c2290 的来源不同：<ul>
<li>被污染指令的 0x4c2290 源自于 <code>0x401ce6: lea rax, [rip + 0xc05a3]</code></li>
<li>而这里的 0x4c2290 源自于 <code>0x401d05: lea rcx, [rip + 0xc0584]</code></li>
</ul>
</li>
</ul>
<h3 id="Triton-代码插桩"><a href="#Triton-代码插桩" class="headerlink" title="Triton 代码插桩"></a>Triton 代码插桩</h3><p>为了解决 Triton 模拟执行没法识别 .got.plt 的问题，可以使用 Triton 自带的插桩模块将 .got.plt 中的函数给替换为自定义的函数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc test.c -o test</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span>* buf = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line"></span><br><span class="line">    read(<span class="number">0</span>,buf,<span class="number">0x200</span>);</span><br><span class="line">    <span class="built_in">printf</span>(buf);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fd = open(buf,<span class="number">0</span>);</span><br><span class="line">    read(fd ,buf, <span class="number">0x10</span>);</span><br><span class="line">    write(<span class="number">1</span> ,buf, <span class="number">0x10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(buf);</span><br><span class="line">    <span class="built_in">free</span>(buf);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>可以发现堆溢出，格式化字符串，double free 等多个漏洞</li>
</ul>
<p>代码插桩的脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> triton <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> lief</span><br><span class="line"></span><br><span class="line">BASE_GOT   = <span class="number">0x10000000</span></span><br><span class="line">BASE_ARGV  = <span class="number">0x20000000</span></span><br><span class="line">BASE_STACK = <span class="number">0x7ffffffde000</span></span><br><span class="line"></span><br><span class="line">heap_addr = <span class="number">0x555555559000</span></span><br><span class="line">heap_size = <span class="number">0</span></span><br><span class="line">is_free   = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hookingHandler</span>(<span class="params">ctx</span>):</span></span><br><span class="line">    pc = ctx.getConcreteRegisterValue(ctx.registers.rip)</span><br><span class="line">    <span class="keyword">for</span> rel <span class="keyword">in</span> customRelocation:</span><br><span class="line">        <span class="keyword">if</span> rel[<span class="number">2</span>] == pc:</span><br><span class="line">            ret_value = rel[<span class="number">1</span>](ctx) <span class="comment"># 调用hook函数,并获取其返回值</span></span><br><span class="line">            <span class="keyword">if</span> ret_value <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                ctx.setConcreteRegisterValue(ctx.registers.rax, ret_value) <span class="comment"># 返回值将会被设置到ctx.registers.rax中</span></span><br><span class="line">            ret_addr = ctx.getConcreteMemoryValue(MemoryAccess(ctx.getConcreteRegisterValue(ctx.registers.rsp), CPUSIZE.QWORD)) <span class="comment"># 返回地址位于栈顶</span></span><br><span class="line">            ctx.setConcreteRegisterValue(ctx.registers.rip, ret_addr) <span class="comment"># 设置rip</span></span><br><span class="line">            ctx.setConcreteRegisterValue(ctx.registers.rsp, ctx.getConcreteRegisterValue(ctx.registers.rsp)+CPUSIZE.QWORD) <span class="comment"># 调整rsp</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mymalloc</span>(<span class="params">ctx</span>):</span></span><br><span class="line">    <span class="keyword">global</span> heap_size </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;[+] malloc hooked&#x27;</span>)</span><br><span class="line">    heap_size = ctx.getConcreteRegisterValue(ctx.registers.rdi)</span><br><span class="line">    <span class="keyword">return</span> heap_addr</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">myfree</span>(<span class="params">ctx</span>):</span></span><br><span class="line">    <span class="keyword">global</span> is_free</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;[+] free hooked&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> is_free:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;[-] free BUG&#x27;</span>)</span><br><span class="line">    is_free = <span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mylibc</span>(<span class="params">ctx</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;[+] __libc_start_main hooked&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">myopen</span>(<span class="params">ctx</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] open hooked&quot;</span>)</span><br><span class="line">    arg1 = ctx.getConcreteRegisterValue(ctx.registers.rdi)</span><br><span class="line">    arg2 = ctx.getConcreteRegisterValue(ctx.registers.rsi)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">myread</span>(<span class="params">ctx</span>):</span></span><br><span class="line">    <span class="keyword">global</span> heap_size</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] read hooked&quot;</span>)</span><br><span class="line">    read_size = ctx.getConcreteRegisterValue(ctx.registers.rdx)</span><br><span class="line">    <span class="keyword">if</span> read_size &gt; heap_size:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[-] read BUG&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mywrite</span>(<span class="params">ctx</span>):</span></span><br><span class="line">    <span class="keyword">global</span> heap_size</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] write hooked&quot;</span>)</span><br><span class="line">    read_size = ctx.getConcreteRegisterValue(ctx.registers.rdx)</span><br><span class="line">    <span class="keyword">if</span> read_size &gt; heap_size:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[-] write BUG&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">myprintf</span>(<span class="params">ctx</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] printf hooked&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">customRelocation = [</span><br><span class="line">    [<span class="string">&#x27;__libc_start_main&#x27;</span>,   mylibc,   <span class="literal">None</span>],</span><br><span class="line">    [<span class="string">&#x27;malloc&#x27;</span>,              mymalloc, <span class="literal">None</span>],</span><br><span class="line">    [<span class="string">&#x27;free&#x27;</span>,                myfree,   <span class="literal">None</span>],</span><br><span class="line">    [<span class="string">&#x27;open&#x27;</span>,                myopen,   <span class="literal">None</span>],</span><br><span class="line">    [<span class="string">&#x27;read&#x27;</span>,                myread,   <span class="literal">None</span>],</span><br><span class="line">    [<span class="string">&#x27;write&#x27;</span>,               mywrite,  <span class="literal">None</span>],</span><br><span class="line">    [<span class="string">&#x27;printf&#x27;</span>,              myprintf, <span class="literal">None</span>],</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">makeRelocation</span>(<span class="params">ctx, binary</span>):</span></span><br><span class="line">    <span class="keyword">for</span> pltIndex <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(customRelocation)):</span><br><span class="line">        customRelocation[pltIndex][<span class="number">2</span>] = BASE_GOT + pltIndex <span class="comment"># 设置自定义got地址</span></span><br><span class="line"></span><br><span class="line">    relocations = [x <span class="keyword">for</span> x <span class="keyword">in</span> binary.pltgot_relocations] <span class="comment"># 读取pltgot重定位符号</span></span><br><span class="line">    relocations.extend([x <span class="keyword">for</span> x <span class="keyword">in</span> binary.dynamic_relocations]) <span class="comment"># 读取dynamic重定位符号</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> rel <span class="keyword">in</span> relocations:</span><br><span class="line">        symbolName = rel.symbol.name</span><br><span class="line">        symbolRelo = rel.address</span><br><span class="line">        <span class="keyword">for</span> crel <span class="keyword">in</span> customRelocation:</span><br><span class="line">            <span class="keyword">if</span> symbolName == crel[<span class="number">0</span>]:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;Hooking %-10s:0x%x&#x27;</span> %(symbolName,symbolRelo))</span><br><span class="line">                ctx.setConcreteMemoryValue(MemoryAccess(symbolRelo, CPUSIZE.QWORD), crel[<span class="number">2</span>]) <span class="comment"># 将模拟执行的got表修改为基于BASE_GOT的自定义got表</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">loadBinary</span>(<span class="params">ctx, binary</span>):</span></span><br><span class="line">    phdrs = binary.segments <span class="comment"># 读取所有segment</span></span><br><span class="line">    <span class="keyword">for</span> phdr <span class="keyword">in</span> phdrs:</span><br><span class="line">        size   = phdr.physical_size</span><br><span class="line">        vaddr  = phdr.virtual_address</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;[+] Loading 0x%06x - 0x%06x&#x27;</span> %(vaddr, vaddr+size))</span><br><span class="line">        ctx.setConcreteMemoryAreaValue(vaddr, <span class="built_in">list</span>(phdr.content))</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    ctx = TritonContext(ARCH.X86_64)</span><br><span class="line">    ctx.setMode(MODE.ALIGNED_MEMORY, <span class="literal">True</span>)</span><br><span class="line">    ctx.setMode(MODE.CONSTANT_FOLDING, <span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    binary = lief.ELF.parse(<span class="string">&quot;./test&quot;</span>) </span><br><span class="line">    </span><br><span class="line">    loadBinary(ctx, binary)</span><br><span class="line">    makeRelocation(ctx, binary)</span><br><span class="line">    ctx.setConcreteRegisterValue(ctx.registers.rbp, BASE_STACK)</span><br><span class="line">    ctx.setConcreteRegisterValue(ctx.registers.rsp, BASE_STACK)</span><br><span class="line"></span><br><span class="line">    pc = <span class="number">0x11E9</span></span><br><span class="line">    <span class="keyword">while</span> pc:</span><br><span class="line">        inst = Instruction()</span><br><span class="line">        opcode = ctx.getConcreteMemoryAreaValue(pc, <span class="number">16</span>)</span><br><span class="line">        </span><br><span class="line">        inst.setOpcode(opcode)</span><br><span class="line">        inst.setAddress(pc)</span><br><span class="line">        ctx.processing(inst)</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">str</span>(inst))</span><br><span class="line"></span><br><span class="line">        hookingHandler(ctx) <span class="comment"># 处理hook</span></span><br><span class="line">        pc = ctx.getConcreteRegisterValue(ctx.registers.rip)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> pc == <span class="number">0x11ff</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[+] rax: &quot;</span>+<span class="built_in">hex</span>(ctx.getConcreteRegisterValue(ctx.registers.rax)))</span><br></pre></td></tr></table></figure>
<p>最终结果如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">[+] Loading <span class="number">0x000040</span> - <span class="number">0x000318</span></span><br><span class="line">[+] Loading <span class="number">0x000318</span> - <span class="number">0x000334</span></span><br><span class="line">[+] Loading <span class="number">0x000000</span> - <span class="number">0x000710</span></span><br><span class="line">[+] Loading <span class="number">0x001000</span> - <span class="number">0x001325</span></span><br><span class="line">[+] Loading <span class="number">0x002000</span> - <span class="number">0x002150</span></span><br><span class="line">[+] Loading <span class="number">0x003d90</span> - <span class="number">0x004010</span></span><br><span class="line">[+] Loading <span class="number">0x003da0</span> - <span class="number">0x003f90</span></span><br><span class="line">[+] Loading <span class="number">0x000338</span> - <span class="number">0x000358</span></span><br><span class="line">[+] Loading <span class="number">0x000358</span> - <span class="number">0x00039c</span></span><br><span class="line">[+] Loading <span class="number">0x000338</span> - <span class="number">0x000358</span></span><br><span class="line">[+] Loading <span class="number">0x002004</span> - <span class="number">0x002048</span></span><br><span class="line">[+] Loading <span class="number">0x000000</span> - <span class="number">0x000000</span></span><br><span class="line">[+] Loading <span class="number">0x003d90</span> - <span class="number">0x004000</span></span><br><span class="line">Hooking <span class="built_in">free</span></span><br><span class="line">Hooking write</span><br><span class="line">Hooking <span class="built_in">printf</span></span><br><span class="line">Hooking read</span><br><span class="line">Hooking <span class="built_in">malloc</span></span><br><span class="line">Hooking open</span><br><span class="line">Hooking __libc_start_main</span><br><span class="line"><span class="number">0x11e9</span>: endbr64</span><br><span class="line"><span class="number">0x11ed</span>: push rbp</span><br><span class="line"><span class="number">0x11ee</span>: mov rbp, rsp</span><br><span class="line"><span class="number">0x11f1</span>: sub rsp, <span class="number">0x10</span></span><br><span class="line"><span class="number">0x11f5</span>: mov edi, <span class="number">0x10</span></span><br><span class="line"><span class="number">0x11fa</span>: call <span class="number">0x10e0</span></span><br><span class="line"><span class="number">0x10e0</span>: endbr64</span><br><span class="line"><span class="number">0x10e4</span>: bnd jmp qword ptr [rip + <span class="number">0x2edd</span>]</span><br><span class="line">[+] <span class="built_in">malloc</span> hooked</span><br><span class="line">[+] rax: <span class="number">0x555555559000</span></span><br><span class="line"><span class="number">0x11ff</span>: mov qword ptr [rbp - <span class="number">8</span>], rax</span><br><span class="line"><span class="number">0x1203</span>: mov rax, qword ptr [rbp - <span class="number">8</span>]</span><br><span class="line"><span class="number">0x1207</span>: mov edx, <span class="number">0x200</span></span><br><span class="line"><span class="number">0x120c</span>: mov rsi, rax</span><br><span class="line"><span class="number">0x120f</span>: mov edi, <span class="number">0</span></span><br><span class="line"><span class="number">0x1214</span>: mov eax, <span class="number">0</span></span><br><span class="line"><span class="number">0x1219</span>: call <span class="number">0x10d0</span></span><br><span class="line"><span class="number">0x10d0</span>: endbr64</span><br><span class="line"><span class="number">0x10d4</span>: bnd jmp qword ptr [rip + <span class="number">0x2ee5</span>]</span><br><span class="line">[+] read hooked</span><br><span class="line">[-] read BUG</span><br><span class="line"><span class="number">0x121e</span>: mov rax, qword ptr [rbp - <span class="number">8</span>]</span><br><span class="line"><span class="number">0x1222</span>: mov rdi, rax</span><br><span class="line"><span class="number">0x1225</span>: mov eax, <span class="number">0</span></span><br><span class="line"><span class="number">0x122a</span>: call <span class="number">0x10c0</span></span><br><span class="line"><span class="number">0x10c0</span>: endbr64</span><br><span class="line"><span class="number">0x10c4</span>: bnd jmp qword ptr [rip + <span class="number">0x2eed</span>]</span><br><span class="line">[+] <span class="built_in">printf</span> hooked</span><br><span class="line"><span class="number">0x122f</span>: mov rax, qword ptr [rbp - <span class="number">8</span>]</span><br><span class="line"><span class="number">0x1233</span>: mov esi, <span class="number">0</span></span><br><span class="line"><span class="number">0x1238</span>: mov rdi, rax</span><br><span class="line"><span class="number">0x123b</span>: mov eax, <span class="number">0</span></span><br><span class="line"><span class="number">0x1240</span>: call <span class="number">0x10f0</span></span><br><span class="line"><span class="number">0x10f0</span>: endbr64</span><br><span class="line"><span class="number">0x10f4</span>: bnd jmp qword ptr [rip + <span class="number">0x2ed5</span>]</span><br><span class="line">[+] open hooked</span><br><span class="line"><span class="number">0x1245</span>: mov dword ptr [rbp - <span class="number">0xc</span>], eax</span><br><span class="line"><span class="number">0x1248</span>: mov rcx, qword ptr [rbp - <span class="number">8</span>]</span><br><span class="line"><span class="number">0x124c</span>: mov eax, dword ptr [rbp - <span class="number">0xc</span>]</span><br><span class="line"><span class="number">0x124f</span>: mov edx, <span class="number">0x10</span></span><br><span class="line"><span class="number">0x1254</span>: mov rsi, rcx</span><br><span class="line"><span class="number">0x1257</span>: mov edi, eax</span><br><span class="line"><span class="number">0x1259</span>: mov eax, <span class="number">0</span></span><br><span class="line"><span class="number">0x125e</span>: call <span class="number">0x10d0</span></span><br><span class="line"><span class="number">0x10d0</span>: endbr64</span><br><span class="line"><span class="number">0x10d4</span>: bnd jmp qword ptr [rip + <span class="number">0x2ee5</span>]</span><br><span class="line">[+] read hooked</span><br><span class="line"><span class="number">0x1263</span>: mov rax, qword ptr [rbp - <span class="number">8</span>]</span><br><span class="line"><span class="number">0x1267</span>: mov edx, <span class="number">0x10</span></span><br><span class="line"><span class="number">0x126c</span>: mov rsi, rax</span><br><span class="line"><span class="number">0x126f</span>: mov edi, <span class="number">1</span></span><br><span class="line"><span class="number">0x1274</span>: mov eax, <span class="number">0</span></span><br><span class="line"><span class="number">0x1279</span>: call <span class="number">0x10b0</span></span><br><span class="line"><span class="number">0x10b0</span>: endbr64</span><br><span class="line"><span class="number">0x10b4</span>: bnd jmp qword ptr [rip + <span class="number">0x2ef5</span>]</span><br><span class="line">[+] write hooked</span><br><span class="line"><span class="number">0x127e</span>: mov rax, qword ptr [rbp - <span class="number">8</span>]</span><br><span class="line"><span class="number">0x1282</span>: mov rdi, rax</span><br><span class="line"><span class="number">0x1285</span>: call <span class="number">0x10a0</span></span><br><span class="line"><span class="number">0x10a0</span>: endbr64</span><br><span class="line"><span class="number">0x10a4</span>: bnd jmp qword ptr [rip + <span class="number">0x2efd</span>]</span><br><span class="line">[+] <span class="built_in">free</span> hooked</span><br><span class="line"><span class="number">0x128a</span>: mov rax, qword ptr [rbp - <span class="number">8</span>]</span><br><span class="line"><span class="number">0x128e</span>: mov rdi, rax</span><br><span class="line"><span class="number">0x1291</span>: call <span class="number">0x10a0</span></span><br><span class="line"><span class="number">0x10a0</span>: endbr64</span><br><span class="line"><span class="number">0x10a4</span>: bnd jmp qword ptr [rip + <span class="number">0x2efd</span>]</span><br><span class="line">[+] <span class="built_in">free</span> hooked</span><br><span class="line">[-] <span class="built_in">free</span> BUG</span><br><span class="line"><span class="number">0x1296</span>: mov eax, <span class="number">0</span></span><br><span class="line"><span class="number">0x129b</span>: leave</span><br><span class="line"><span class="number">0x129c</span>: ret</span><br></pre></td></tr></table></figure>
<h3 id="Triton-符号执行"><a href="#Triton-符号执行" class="headerlink" title="Triton 符号执行"></a>Triton 符号执行</h3><p>符号执行（Symbolic Execution）是一种程序分析技术，它使用符号值代替具体数值来探索程序的所有可能执行路径，这种方法可以帮助分析者或自动化工具理解程序的行为，发现潜在的错误或安全漏洞</p>
<p>符号执行的脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> triton <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> lief</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">AnalysisBinary</span>(<span class="params">path</span>):</span></span><br><span class="line">    binary = lief.ELF.parse(path) <span class="comment"># 使用lief加载二进制文件</span></span><br><span class="line"></span><br><span class="line">    sections = binary.sections</span><br><span class="line">    <span class="keyword">for</span> section <span class="keyword">in</span> sections: <span class="comment"># 读取所有section</span></span><br><span class="line">        name = section.name</span><br><span class="line">        size = section.size</span><br><span class="line">        vaddr = section.virtual_address</span><br><span class="line">        <span class="keyword">if</span> name != <span class="string">&quot;&quot;</span>: </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;[+] %-28s 0x%06x - 0x%06x&#x27;</span> % (name+<span class="string">&quot;:&quot;</span>, vaddr, vaddr+size))</span><br><span class="line">            data = <span class="built_in">bytes</span>(section.content[<span class="number">0</span>:<span class="number">0x20</span>])</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(data)):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;data[i]:02x&#125;</span>&quot;</span>, end=<span class="string">&quot; &quot;</span>)</span><br><span class="line">                <span class="keyword">if</span> i % <span class="number">0x10</span> == <span class="number">0xf</span>: <span class="built_in">print</span>()</span><br><span class="line">            <span class="keyword">if</span> i % <span class="number">0x10</span> != <span class="number">0xf</span>: <span class="built_in">print</span>()</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;-------------------------------------------------&quot;</span>)</span><br><span class="line">            ctx.setConcreteMemoryAreaValue(vaddr, <span class="built_in">bytes</span>(section.content)) <span class="comment"># 加载所有section</span></span><br><span class="line"></span><br><span class="line">    symbols = binary.symbols <span class="comment"># 读取所有symbol</span></span><br><span class="line">    <span class="keyword">for</span> symbol <span class="keyword">in</span> symbols:</span><br><span class="line">        <span class="keyword">if</span> symbol.name == <span class="string">&#x27;main&#x27;</span>:</span><br><span class="line">            main_address = symbol.value</span><br><span class="line">            <span class="built_in">print</span>()</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;[+] Address of main function: 0x&#123;:x&#125;&#x27;</span>.<span class="built_in">format</span>(main_address))</span><br><span class="line">            <span class="built_in">print</span>()</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;&#x27;main&#x27; function not found&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    ctx = TritonContext()</span><br><span class="line">    ctx.setArchitecture(ARCH.X86_64)</span><br><span class="line">    ast = ctx.getAstContext()</span><br><span class="line"></span><br><span class="line">    AnalysisBinary(os.path.join(os.path.dirname(__file__), <span class="string">&#x27;./test&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    start = <span class="number">0x401DE0</span> <span class="comment"># 执行关键匹配函数之前的某个地址(从IDA中得出)</span></span><br><span class="line">    RBP_ADDR = <span class="number">0x7ffffffde000</span></span><br><span class="line">    RSP_ADDR = RBP_ADDR - <span class="number">0x21000</span></span><br><span class="line"></span><br><span class="line">    ctx.setAstRepresentationMode(AST_REPRESENTATION.PYTHON)</span><br><span class="line"></span><br><span class="line">    ctx.setConcreteRegisterValue(ctx.registers.rip, start)</span><br><span class="line">    ctx.setConcreteRegisterValue(ctx.registers.rsp, RSP_ADDR)</span><br><span class="line">    ctx.setConcreteRegisterValue(ctx.registers.rbp, RBP_ADDR)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">        input_addr = ctx.getConcreteRegisterValue(ctx.registers.rbp) - <span class="number">0x20</span></span><br><span class="line">        ctx.setConcreteMemoryValue(MemoryAccess(input_addr + i, CPUSIZE.BYTE), <span class="built_in">ord</span>(<span class="string">&#x27;a&#x27;</span>))</span><br><span class="line">        ctx.symbolizeMemory(MemoryAccess(input_addr + i, CPUSIZE.BYTE)) <span class="comment"># 将目标地址的数据设置为符号变量</span></span><br><span class="line"></span><br><span class="line">    pc = start</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> pc:</span><br><span class="line">        inst = Instruction()</span><br><span class="line">        opcode = ctx.getConcreteMemoryAreaValue(pc, <span class="number">16</span>)</span><br><span class="line">        </span><br><span class="line">        inst.setOpcode(opcode)</span><br><span class="line">        inst.setAddress(pc)</span><br><span class="line">        ctx.processing(inst)</span><br><span class="line">    </span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">str</span>(inst))</span><br><span class="line">        <span class="keyword">if</span> inst.getAddress() == <span class="number">0x401DEC</span>:</span><br><span class="line">            rdata = ctx.getRegisterAst(ctx.registers.rax) <span class="comment"># 获取rax寄存器的AST结构,可以添加到后续的约束条件中</span></span><br><span class="line">            </span><br><span class="line">            sv1 = ast.variable(ctx.getSymbolicVariable(<span class="number">0</span>)) <span class="comment"># 读取设置的符号变量</span></span><br><span class="line">            sv2 = ast.variable(ctx.getSymbolicVariable(<span class="number">1</span>))</span><br><span class="line">            sv3 = ast.variable(ctx.getSymbolicVariable(<span class="number">2</span>))</span><br><span class="line">            sv4 = ast.variable(ctx.getSymbolicVariable(<span class="number">3</span>))</span><br><span class="line">            sv5 = ast.variable(ctx.getSymbolicVariable(<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line">            cstr = ast.land([rdata == <span class="number">0xAD6D</span>] <span class="comment"># 添加约束条件</span></span><br><span class="line">            + [sv1 &gt;= <span class="built_in">ord</span>(<span class="string">b&#x27;A&#x27;</span>), sv1 &lt;= <span class="built_in">ord</span>(<span class="string">b&#x27;z&#x27;</span>)]</span><br><span class="line">            + [sv2 &gt;= <span class="built_in">ord</span>(<span class="string">b&#x27;A&#x27;</span>), sv2 &lt;= <span class="built_in">ord</span>(<span class="string">b&#x27;z&#x27;</span>)]</span><br><span class="line">            + [sv3 &gt;= <span class="built_in">ord</span>(<span class="string">b&#x27;A&#x27;</span>), sv3 &lt;= <span class="built_in">ord</span>(<span class="string">b&#x27;z&#x27;</span>)]</span><br><span class="line">            + [sv4 &gt;= <span class="built_in">ord</span>(<span class="string">b&#x27;A&#x27;</span>), sv4 &lt;= <span class="built_in">ord</span>(<span class="string">b&#x27;z&#x27;</span>)]</span><br><span class="line">            + [sv5 &gt;= <span class="built_in">ord</span>(<span class="string">b&#x27;A&#x27;</span>), sv5 &lt;= <span class="built_in">ord</span>(<span class="string">b&#x27;z&#x27;</span>)]</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">            model = ctx.getModel(cstr) <span class="comment"># 进行约束求解</span></span><br><span class="line">            answer = <span class="string">&quot;&quot;</span></span><br><span class="line">            <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">sorted</span>(model.items()):</span><br><span class="line">                value = v.getValue()</span><br><span class="line">                answer += <span class="built_in">chr</span>(value)</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(answer)==<span class="number">5</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;answer: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(answer))  </span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span> </span><br><span class="line"></span><br><span class="line">        pc = ctx.getConcreteRegisterValue(ctx.registers.rip)</span><br></pre></td></tr></table></figure>
<p>测试脚本如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> *serial = <span class="string">&quot;\x31\x3e\x3d\x26\x31&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">check</span><span class="params">(<span class="keyword">char</span> *ptr)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">int</span> hash = <span class="number">0xABCD</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; ptr[i]; i++)</span><br><span class="line">        hash += ptr[i] ^ serial[i % <span class="number">5</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> hash;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x10</span>];</span><br><span class="line">    read(<span class="number">0</span>, buf, <span class="number">5</span>); <span class="comment">// TyrbP</span></span><br><span class="line"></span><br><span class="line">    ret = check(buf);</span><br><span class="line">    <span class="keyword">if</span> (ret == <span class="number">0xad6d</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Win\n&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;fail\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先用 IDA 分析程序起始地址 0x401DE0：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0000000000401</span>DE0 <span class="number">48</span> <span class="number">8</span>D <span class="number">45</span> E0                   lea     rax, [rbp+var_20]</span><br><span class="line">.text:<span class="number">0000000000401</span>DE4 <span class="number">48</span> <span class="number">89</span> C7                      mov     rdi, rax</span><br><span class="line">.text:<span class="number">0000000000401</span>DE7 E8 <span class="number">39</span> FF FF FF                call    check</span><br><span class="line">.text:<span class="number">0000000000401</span>DE7</span><br><span class="line">.text:<span class="number">0000000000401</span>DEC <span class="number">89</span> <span class="number">45</span> DC                      mov     [rbp+var_24], eax</span><br><span class="line">.text:<span class="number">0000000000401</span>DEF <span class="number">81</span> <span class="number">7</span>D DC <span class="number">6</span>D AD <span class="number">00</span> <span class="number">00</span>          cmp     [rbp+var_24], <span class="number">0</span>AD6Dh</span><br><span class="line">.text:<span class="number">0000000000401</span>DF6 <span class="number">75</span> <span class="number">11</span>                         jnz     <span class="keyword">short</span> loc_401E09</span><br></pre></td></tr></table></figure>
<ul>
<li>可以发现只要 check 函数的返回值为 0xAD6D 就可以输出 Win，利用这一点可以添加约束</li>
</ul>
<h3 id="Triton-解决-CTF-问题"><a href="#Triton-解决-CTF-问题" class="headerlink" title="Triton 解决 CTF 问题"></a>Triton 解决 CTF 问题</h3><p>题目为：alexctf-2017-re2-cpp-is-awesome</p>
<p>核心加密逻辑如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">i = <span class="number">0</span>;</span><br><span class="line">flag[<span class="number">0</span>] = <span class="built_in">std</span>::<span class="built_in">string</span>::begin(<span class="built_in">string</span>);</span><br><span class="line"><span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">&#123;</span><br><span class="line">  v13 = <span class="built_in">std</span>::<span class="built_in">string</span>::end(<span class="built_in">string</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !sub_400D3D((__int64)flag, (__int64)&amp;v13) )</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  v8 = *(<span class="keyword">unsigned</span> __int8 *)get_char((__int64)flag);</span><br><span class="line">  <span class="keyword">if</span> ( (_BYTE)v8 != key[index[i]] )</span><br><span class="line">    fail((__int64)flag, (__int64)&amp;v13, v8);</span><br><span class="line">  ++i;</span><br><span class="line">  sub_400D7A(flag);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>其实就是简单的换位</li>
</ul>
<p>本题目需要使用符号执行，首先在 IDA 中分析决定程序流程的代码片段：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0000000000400</span>C4B <span class="number">48</span> <span class="number">8</span>D <span class="number">45</span> A0                   lea     rax, [rbp+flag]</span><br><span class="line">.text:<span class="number">0000000000400</span>C4F <span class="number">48</span> <span class="number">89</span> C7                      mov     rdi, rax</span><br><span class="line">.text:<span class="number">0000000000400</span>C52 E8 <span class="number">43</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span>                call    get_char</span><br><span class="line">.text:<span class="number">0000000000400</span>C52</span><br><span class="line">.text:<span class="number">0000000000400</span>C57 <span class="number">0F</span> B6 <span class="number">10</span>                      movzx   edx, byte ptr [rax]</span><br><span class="line">.text:<span class="number">0000000000400</span>C5A <span class="number">48</span> <span class="number">8B</span> <span class="number">0</span>D <span class="number">3F</span> <span class="number">14</span> <span class="number">20</span> <span class="number">00</span>          mov     rcx, cs:key</span><br><span class="line">.text:<span class="number">0000000000400</span>C61 <span class="number">8B</span> <span class="number">45</span> EC                      mov     eax, [rbp+i]</span><br><span class="line">.text:<span class="number">0000000000400</span>C64 <span class="number">48</span> <span class="number">98</span>                         cdqe</span><br><span class="line">.text:<span class="number">0000000000400</span>C66 <span class="number">8B</span> <span class="number">04</span> <span class="number">85</span> C0 <span class="number">20</span> <span class="number">60</span> <span class="number">00</span>          mov     eax, index[rax*<span class="number">4</span>]</span><br><span class="line">.text:<span class="number">0000000000400</span>C6D <span class="number">48</span> <span class="number">98</span>                         cdqe</span><br><span class="line">.text:<span class="number">0000000000400</span>C6F <span class="number">48</span> <span class="number">01</span> C8                      add     rax, rcx</span><br><span class="line">.text:<span class="number">0000000000400</span>C72 <span class="number">0F</span> B6 <span class="number">00</span>                      movzx   eax, byte ptr [rax]</span><br><span class="line">.text:<span class="number">0000000000400</span>C75 <span class="number">38</span> C2                         cmp     dl, al</span><br><span class="line">.text:<span class="number">0000000000400</span>C77 <span class="number">0F</span> <span class="number">95</span> C0                      setnz   al</span><br><span class="line">.text:<span class="number">0000000000400</span>C7A <span class="number">84</span> C0                         test    al, al</span><br><span class="line">.text:<span class="number">0000000000400</span>C7C <span class="number">74</span> <span class="number">05</span>                         jz      <span class="keyword">short</span> loc_400C83</span><br><span class="line">.text:<span class="number">0000000000400</span>C7C</span><br><span class="line">.text:<span class="number">0000000000400</span>C7E                               ;   <span class="keyword">try</span> &#123;</span><br><span class="line">.text:<span class="number">0000000000400</span>C7E E8 D3 FE FF FF                call    fail</span><br></pre></td></tr></table></figure>
<ul>
<li>从 <code>lea rax, [rbp+flag]</code> 加载 flag 地址，到 <code>test al, al</code> 判断是否继续循环，程序的核心约束条件就是要使 <code>zf == 1</code>（指令 <code>test al, al</code> 返回“0”，也就是 <code>cmp dl, al</code> 返回“0”）</li>
</ul>
<p>基于约束条件，解题脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> triton <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> lief</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">AnalysisBinary</span>(<span class="params">path</span>):</span></span><br><span class="line">    binary = lief.ELF.parse(path)</span><br><span class="line">    sections = binary.sections</span><br><span class="line">    <span class="keyword">for</span> section <span class="keyword">in</span> sections:</span><br><span class="line">        name = section.name</span><br><span class="line">        size = section.size</span><br><span class="line">        vaddr = section.virtual_address</span><br><span class="line">        <span class="keyword">if</span> name != <span class="string">&quot;&quot;</span>: </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;[+] %-28s 0x%06x - 0x%06x&#x27;</span> % (name+<span class="string">&quot;:&quot;</span>, vaddr, vaddr+size))</span><br><span class="line">            data = <span class="built_in">bytes</span>(section.content[<span class="number">0</span>:<span class="number">0x20</span>])</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(data)):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;data[i]:02x&#125;</span>&quot;</span>, end=<span class="string">&quot; &quot;</span>)</span><br><span class="line">                <span class="keyword">if</span> i % <span class="number">0x10</span> == <span class="number">0xf</span>: <span class="built_in">print</span>()</span><br><span class="line">            <span class="keyword">if</span> i % <span class="number">0x10</span> != <span class="number">0xf</span>: <span class="built_in">print</span>()</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;-------------------------------------------------&quot;</span>)</span><br><span class="line">            ctx.setConcreteMemoryAreaValue(vaddr, <span class="built_in">bytes</span>(section.content))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    ctx = TritonContext(ARCH.X86_64)</span><br><span class="line">    ctx.setMode(MODE.ALIGNED_MEMORY, <span class="literal">True</span>)</span><br><span class="line">    ctx.setMode(MODE.ONLY_ON_SYMBOLIZED, <span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    AnalysisBinary(<span class="string">&quot;./test&quot;</span>)</span><br><span class="line"></span><br><span class="line">    start = <span class="number">0x400c4b</span></span><br><span class="line">    end   = <span class="number">0x400C7C</span></span><br><span class="line">    <span class="built_in">input</span> = <span class="number">0x002000</span> <span class="comment"># 输入字符串的地址</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">31</span>):</span><br><span class="line">        ctx.setConcreteMemoryValue(MemoryAccess(<span class="built_in">input</span> + i, CPUSIZE.BYTE), <span class="number">0x61</span>)</span><br><span class="line">        ctx.symbolizeMemory(MemoryAccess(<span class="built_in">input</span> + i, CPUSIZE.BYTE)) <span class="comment"># 将输入字符串设置为符号变量</span></span><br><span class="line"></span><br><span class="line">    rbp = <span class="number">0x7fffffffe460</span></span><br><span class="line">    ctx.setConcreteRegisterValue(ctx.registers.rbp, rbp)</span><br><span class="line">    ctx.setConcreteRegisterValue(ctx.registers.rip, start)</span><br><span class="line">    ctx.setConcreteMemoryValue(MemoryAccess(rbp - <span class="number">96</span>, CPUSIZE.QWORD), <span class="built_in">input</span>) <span class="comment"># 初始化&quot;rbp - 96&quot;为输入字符串的地址 </span></span><br><span class="line">    ctx.setConcreteMemoryValue(MemoryAccess(rbp - <span class="number">20</span>, CPUSIZE.DWORD), <span class="number">0</span>) <span class="comment"># 初始化&quot;rbp - 20&quot;为&quot;0&quot;(这里是解密输入值时使用的索引)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> count <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">31</span>):</span><br><span class="line">        pc = start</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> pc: <span class="comment"># 进行模拟执行,直到遇到约束条件</span></span><br><span class="line">            inst = Instruction()</span><br><span class="line">            opcode = ctx.getConcreteMemoryAreaValue(pc, <span class="number">16</span>)</span><br><span class="line">            inst.setOpcode(opcode)</span><br><span class="line">            inst.setAddress(pc)</span><br><span class="line">            ctx.processing(inst)</span><br><span class="line">            pc = ctx.getConcreteRegisterValue(ctx.registers.rip)</span><br><span class="line">            <span class="built_in">print</span>(inst)</span><br><span class="line">            <span class="keyword">if</span> pc == end:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;------------------------------------------&quot;</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        zf  = ctx.getRegisterAst(ctx.registers.zf)</span><br><span class="line">        ctx.pushPathConstraint(zf == <span class="number">1</span>) <span class="comment"># 添加约束条件</span></span><br><span class="line"></span><br><span class="line">        ctx.setConcreteMemoryValue(MemoryAccess(rbp - <span class="number">20</span>, CPUSIZE.DWORD), count + <span class="number">1</span>) <span class="comment"># 更新索引</span></span><br><span class="line">        ctx.setConcreteMemoryValue(MemoryAccess(rbp - <span class="number">96</span>, CPUSIZE.DWORD), <span class="built_in">input</span> + count + <span class="number">1</span>) <span class="comment"># 更新输入值</span></span><br><span class="line"></span><br><span class="line">	mod = ctx.getModel(ctx.getPathPredicate()) <span class="comment"># 进行约束求解</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> mod:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;[-] Failed&#x27;</span>)</span><br><span class="line">        sys.exit(-<span class="number">1</span>)    </span><br><span class="line">        </span><br><span class="line">    flag = <span class="string">&quot;&quot;</span> </span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">sorted</span>(mod.items()):</span><br><span class="line">        ctx.setConcreteVariableValue(ctx.getSymbolicVariable(v.getId()), v.getValue())</span><br><span class="line">        value = v.getValue()</span><br><span class="line">        flag += <span class="built_in">chr</span>(value)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;flag: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(flag))  </span><br></pre></td></tr></table></figure>
<ul>
<li>这种加密的加密逻辑与输入值无关，与输入的顺序也无关，因此可以单独为每一位添加约束条件</li>
</ul>
<h2 id="exrop-的安装与使用"><a href="#exrop-的安装与使用" class="headerlink" title="exrop 的安装与使用"></a>exrop 的安装与使用</h2><p>安装 exrop：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/d4em0n/exrop</span><br></pre></td></tr></table></figure>
<ul>
<li>最后在 /home/yhellow 目录的 .zshenv 中写入 <code>export PYTHONPATH=/home/yhellow/Tools/exrop:$PYTHONPATH</code> 即可</li>
</ul>
<p>第一次使用 exrop 可能会遇到如下报错：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TypeError: Z3ToTriton::visit(): &#x27;SymVar_0&#x27; AST node not supported yet</span><br></pre></td></tr></table></figure>
<p>经过多方查证，这个报错源自于 Z3_OP_UNINTERPRETED 变量，其在 C++ 绑定和 Python 绑定之间具有不同的值：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/Z3Prover/z3/issues/4326">Z3_OP_UNINTERPRETED has different value between C++ and Python bindings · Issue #4326 · Z3Prover/z3 (github.com)</a> </li>
<li><a target="_blank" rel="noopener" href="https://github.com/JonathanSalwan/Triton/issues/904">TypeError: Z3ToTritonAst::visit(): ‘SymVar_1’ AST node not supported yet · Issue #904 · JonathanSalwan/Triton (github.com)</a> </li>
</ul>
<p>这就导致了 Triton 将 Z3_OP_UNINTERPRETED 给识别为 Z3_OP_RECURSIVE，为了解决这个 BUG 我选择修改 Triton 源码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> Z3_OP_RECURSIVE: <span class="comment">/* 添加对Z3_OP_RECURSIVE的识别 */</span></span><br><span class="line"><span class="keyword">case</span> Z3_OP_UNINTERPRETED: &#123;</span><br><span class="line">  std::string name = function.<span class="built_in">name</span>().<span class="built_in">str</span>();</span><br><span class="line"></span><br><span class="line">  node = <span class="keyword">this</span>-&gt;astCtxt-&gt;<span class="built_in">getVariableNode</span>(name);</span><br><span class="line">  <span class="keyword">if</span> (node == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    node = <span class="keyword">this</span>-&gt;astCtxt-&gt;<span class="built_in">string</span>(name);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">  <span class="keyword">throw</span> triton::exceptions::<span class="built_in">AstLifting</span>(<span class="string">&quot;Z3ToTriton::visit(): &#x27;&quot;</span> + function.<span class="built_in">name</span>().<span class="built_in">str</span>() + <span class="string">&quot;&#x27; AST node not supported yet&quot;</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>原本 Triton 不会对 Z3_OP_RECURSIVE 进行处理</li>
</ul>
<p>exrop 的主要功能是自动生成 ROP 链</p>
<p>exrop 的使用案例如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> Exrop <span class="keyword">import</span> Exrop</span><br><span class="line"></span><br><span class="line">binname = <span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span></span><br><span class="line">libc = ELF(binname, checksec=<span class="literal">False</span>)</span><br><span class="line">binsh = <span class="built_in">next</span>(libc.search(<span class="string">b&quot;/bin/sh&quot;</span>))</span><br><span class="line">open_libc = libc.symbols[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">read_libc = libc.symbols[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">write_libc = libc.symbols[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">bss = libc.bss()</span><br><span class="line"></span><br><span class="line">t = time.mktime(time.gmtime())</span><br><span class="line">rop = Exrop(binname)</span><br><span class="line">rop.find_gadgets(cache=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;execve(&#x27;/bin/sh&#x27;, 0, 0)&quot;</span>)</span><br><span class="line">chain = rop.syscall(<span class="number">59</span>, (<span class="string">&quot;/bin/sh&quot;</span>, <span class="number">0</span>, <span class="number">0</span>), bss) <span class="comment"># 字符串会写到第3个参数上</span></span><br><span class="line">chain.set_base_addr(<span class="number">0</span>)</span><br><span class="line">chain.dump()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;execve(&#x27;/bin/sh&#x27;, 0, 0)&quot;</span>)</span><br><span class="line">chain = rop.syscall(<span class="number">59</span>, (binsh, <span class="number">0</span>, <span class="number">0</span>)) <span class="comment"># 如果没设置第3个参数,则不能直接写入字符串</span></span><br><span class="line">chain.set_base_addr(<span class="number">0</span>) <span class="comment"># 设置基地址</span></span><br><span class="line"><span class="built_in">print</span>(chain.payload_str()) <span class="comment"># 将ROP链转化为bytes字符串</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;open(&#x27;/etc/passwd&#x27;, 0)&quot;</span>)</span><br><span class="line">chain = rop.func_call(open_libc, (<span class="string">&quot;/etc/passwd&quot;</span>, <span class="number">0</span>), bss)</span><br><span class="line">chain.set_base_addr(<span class="number">0</span>)</span><br><span class="line">chain.dump()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;read(&#x27;rax&#x27;, bss, 0x100)&quot;</span>) </span><br><span class="line">chain = rop.func_call(read_libc, (<span class="string">&#x27;rax&#x27;</span>, bss, <span class="number">0x100</span>)) <span class="comment"># 可以直接使用寄存器</span></span><br><span class="line">chain.set_base_addr(<span class="number">0</span>)</span><br><span class="line">chain.dump()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;write(1, bss, 0x100)&quot;</span>)</span><br><span class="line">chain = rop.func_call(write_libc, (<span class="number">1</span>, bss, <span class="number">0x100</span>))</span><br><span class="line">chain.set_base_addr(<span class="number">0</span>)</span><br><span class="line">chain.dump()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;done in &#123;&#125;s&quot;</span>.<span class="built_in">format</span>(time.mktime(time.gmtime()) - t))</span><br></pre></td></tr></table></figure>
<ul>
<li>结果如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">execve(<span class="string">&#x27;/bin/sh&#x27;</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">$RSP+<span class="number">0x0000</span> : <span class="number">0x0000000000036174</span> <span class="meta"># pop rax ; ret</span></span><br><span class="line">$RSP+<span class="number">0x0008</span> : <span class="number">0x00000000001ed7a0</span></span><br><span class="line">$RSP+<span class="number">0x0010</span> : <span class="number">0x0000000000023b6a</span> <span class="meta"># pop rdi ; ret</span></span><br><span class="line">$RSP+<span class="number">0x0018</span> : <span class="number">0x0068732f6e69622f</span></span><br><span class="line">$RSP+<span class="number">0x0020</span> : <span class="number">0x000000000009a0cf</span> <span class="meta"># mov qword ptr [rax], rdi ; ret</span></span><br><span class="line">$RSP+<span class="number">0x0028</span> : <span class="number">0x0000000000036174</span> <span class="meta"># pop rax ; ret</span></span><br><span class="line">$RSP+<span class="number">0x0030</span> : <span class="number">0x000000000000003b</span></span><br><span class="line">$RSP+<span class="number">0x0038</span> : <span class="number">0x0000000000023b6a</span> <span class="meta"># pop rdi ; ret</span></span><br><span class="line">$RSP+<span class="number">0x0040</span> : <span class="number">0x00000000001ed7a0</span></span><br><span class="line">$RSP+<span class="number">0x0048</span> : <span class="number">0x000000000002601f</span> <span class="meta"># pop rsi ; ret</span></span><br><span class="line">$RSP+<span class="number">0x0050</span> : <span class="number">0x0000000000000000</span></span><br><span class="line">$RSP+<span class="number">0x0058</span> : <span class="number">0x000000000015fae6</span> <span class="meta"># pop rdx ; pop rbx ; ret</span></span><br><span class="line">$RSP+<span class="number">0x0060</span> : <span class="number">0x0000000000000000</span></span><br><span class="line">$RSP+<span class="number">0x0068</span> : <span class="number">0x0000000000000000</span></span><br><span class="line">$RSP+<span class="number">0x0070</span> : <span class="number">0x00000000000630a9</span> <span class="meta"># syscall ; ret</span></span><br><span class="line"></span><br><span class="line">execve(<span class="string">&#x27;/bin/sh&#x27;</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">b<span class="number">&#x27;</span>ta\x03\x00\x00\x00\x00\x00;\x00\x00\x00\x00\x00\x00\x00j;\x02\x00\x00\x00\x00\x00\xbdE\x1b\x00\x00\x00\x00\x00\x1f`\x02\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xe6\xfa\x15\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xa90\x06\x00\x00\x00\x00\x00<span class="number">&#x27;</span></span><br><span class="line">open(<span class="string">&#x27;/etc/passwd&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">$RSP+<span class="number">0x0000</span> : <span class="number">0x0000000000036174</span> <span class="meta"># pop rax ; ret</span></span><br><span class="line">$RSP+<span class="number">0x0008</span> : <span class="number">0x00000000001ed7a0</span></span><br><span class="line">$RSP+<span class="number">0x0010</span> : <span class="number">0x0000000000023b6a</span> <span class="meta"># pop rdi ; ret</span></span><br><span class="line">$RSP+<span class="number">0x0018</span> : <span class="number">0x7361702f6374652f</span></span><br><span class="line">$RSP+<span class="number">0x0020</span> : <span class="number">0x000000000009a0cf</span> <span class="meta"># mov qword ptr [rax], rdi ; ret</span></span><br><span class="line">$RSP+<span class="number">0x0028</span> : <span class="number">0x0000000000036174</span> <span class="meta"># pop rax ; ret</span></span><br><span class="line">$RSP+<span class="number">0x0030</span> : <span class="number">0x00000000001ed7a8</span></span><br><span class="line">$RSP+<span class="number">0x0038</span> : <span class="number">0x0000000000023b6a</span> <span class="meta"># pop rdi ; ret</span></span><br><span class="line">$RSP+<span class="number">0x0040</span> : <span class="number">0x0000000000647773</span></span><br><span class="line">$RSP+<span class="number">0x0048</span> : <span class="number">0x000000000009a0cf</span> <span class="meta"># mov qword ptr [rax], rdi ; ret</span></span><br><span class="line">$RSP+<span class="number">0x0050</span> : <span class="number">0x0000000000023b6a</span> <span class="meta"># pop rdi ; ret</span></span><br><span class="line">$RSP+<span class="number">0x0058</span> : <span class="number">0x00000000001ed7a0</span></span><br><span class="line">$RSP+<span class="number">0x0060</span> : <span class="number">0x000000000002601f</span> <span class="meta"># pop rsi ; ret</span></span><br><span class="line">$RSP+<span class="number">0x0068</span> : <span class="number">0x0000000000000000</span></span><br><span class="line">$RSP+<span class="number">0x0070</span> : <span class="number">0x000000000010df00</span></span><br><span class="line"></span><br><span class="line">read(<span class="string">&#x27;rax&#x27;</span>, bss, <span class="number">0x100</span>)</span><br><span class="line">$RSP+<span class="number">0x0000</span> : <span class="number">0x000000000015fae6</span> <span class="meta"># pop rdx ; pop rbx ; ret</span></span><br><span class="line">$RSP+<span class="number">0x0008</span> : <span class="number">0x0000000000000000</span></span><br><span class="line">$RSP+<span class="number">0x0010</span> : <span class="number">0x0000000000023b6a</span></span><br><span class="line">$RSP+<span class="number">0x0018</span> : <span class="number">0x0000000000044808</span> <span class="meta"># mov r13, rax ; mov rdi, r12 ; call rbx: next -&gt; (0x00023b6a) # pop rdi ; ret</span></span><br><span class="line">$RSP+<span class="number">0x0020</span> : <span class="number">0x0000000000036174</span> <span class="meta"># pop rax ; ret</span></span><br><span class="line">$RSP+<span class="number">0x0028</span> : <span class="number">0x000000000002601f</span></span><br><span class="line">$RSP+<span class="number">0x0030</span> : <span class="number">0x0000000000045872</span> <span class="meta"># mov rdi, r13 ; call rax: next -&gt; (0x0002601f) # pop rsi ; ret</span></span><br><span class="line">$RSP+<span class="number">0x0038</span> : <span class="number">0x000000000002601f</span> <span class="meta"># pop rsi ; ret</span></span><br><span class="line">$RSP+<span class="number">0x0040</span> : <span class="number">0x00000000001ed7a0</span></span><br><span class="line">$RSP+<span class="number">0x0048</span> : <span class="number">0x000000000015fae6</span> <span class="meta"># pop rdx ; pop rbx ; ret</span></span><br><span class="line">$RSP+<span class="number">0x0050</span> : <span class="number">0x0000000000000100</span></span><br><span class="line">$RSP+<span class="number">0x0058</span> : <span class="number">0x0000000000000000</span></span><br><span class="line">$RSP+<span class="number">0x0060</span> : <span class="number">0x000000000010e1e0</span></span><br><span class="line"></span><br><span class="line">write(<span class="number">1</span>, bss, <span class="number">0x100</span>)</span><br><span class="line">$RSP+<span class="number">0x0000</span> : <span class="number">0x0000000000023b6a</span> <span class="meta"># pop rdi ; ret</span></span><br><span class="line">$RSP+<span class="number">0x0008</span> : <span class="number">0x0000000000000001</span></span><br><span class="line">$RSP+<span class="number">0x0010</span> : <span class="number">0x000000000002601f</span> <span class="meta"># pop rsi ; ret</span></span><br><span class="line">$RSP+<span class="number">0x0018</span> : <span class="number">0x00000000001ed7a0</span></span><br><span class="line">$RSP+<span class="number">0x0020</span> : <span class="number">0x000000000015fae6</span> <span class="meta"># pop rdx ; pop rbx ; ret</span></span><br><span class="line">$RSP+<span class="number">0x0028</span> : <span class="number">0x0000000000000100</span></span><br><span class="line">$RSP+<span class="number">0x0030</span> : <span class="number">0x0000000000000000</span></span><br><span class="line">$RSP+<span class="number">0x0038</span> : <span class="number">0x000000000010e280</span></span><br><span class="line"></span><br><span class="line">done in <span class="number">2.0</span>s</span><br></pre></td></tr></table></figure>
<p>在不使用缓存的情况下 rop.find_gadgets 将会执行非常久的时间（特别是处理 libc.so.6），下面方法可以提高其运行速度：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parseRopGadget</span>(<span class="params">filename, opt=<span class="string">&quot;&quot;</span></span>):</span></span><br><span class="line">    <span class="keyword">from</span> subprocess <span class="keyword">import</span> Popen, PIPE, STDOUT</span><br><span class="line">    <span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">    cmd = [<span class="string">&#x27;ROPgadget&#x27;</span>, <span class="string">&#x27;--binary&#x27;</span>, filename, <span class="string">&#x27;--multibr&#x27;</span>, <span class="string">&#x27;--only&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;pop|xchg|add|sub|xor|mov|ret|jmp|call|syscall|leave&#x27;</span>, <span class="string">&#x27;--dump&#x27;</span>]</span><br><span class="line">    <span class="keyword">if</span> opt:</span><br><span class="line">        cmd.append(opt)</span><br><span class="line">    process = Popen(cmd, stdout=PIPE, stderr=STDOUT)</span><br><span class="line">    stdout, _ = process.communicate()</span><br><span class="line">    ......</span><br></pre></td></tr></table></figure>
<ul>
<li>在 Exrop.py 的 parseRopGadget 函数中会使用 ROPgadget，减少不必要的查找指令可以大幅度提高运行速度</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cmd = [<span class="string">&#x27;ROPgadget&#x27;</span>, <span class="string">&#x27;--binary&#x27;</span>, filename, <span class="string">&#x27;--multibr&#x27;</span>, <span class="string">&#x27;--only&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;pop|mov|ret|call|syscall&#x27;</span>, <span class="string">&#x27;--dump&#x27;</span>]</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">done in <span class="number">28.0</span>s</span><br></pre></td></tr></table></figure>
<h2 id="qsynthesis-的安装与使用"><a href="#qsynthesis-的安装与使用" class="headerlink" title="qsynthesis 的安装与使用"></a>qsynthesis 的安装与使用</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/quarkslab/qsynthesis.git</span><br><span class="line">cd qsynthesis</span><br><span class="line">pip3 install &#x27;.[all]&#x27;</span><br></pre></td></tr></table></figure>
<p>QSynthesis 是一个 Python3 API，用于执行基于 I/O 的程序合成的 bitvector 表达式，旨在促进代码反混淆</p>
<ul>
<li>该算法是灰盒方法，结合了基于黑盒 I/O 的算法合成和白盒 AST 搜索以合成子表达式</li>
</ul>
<p>核心合成基于 Triton 符号引擎，在此基础上构建整个框架，它提供以下功能：</p>
<ul>
<li>位向量表达式的合成</li>
<li>能够通过 SMT 检查合成表达式的语义等价性</li>
<li>能够合成常量（如果表达式编码常量）</li>
<li>通过学习机制加班改进预言机（预计算表）的能力</li>
<li>能够将合成表达重新组合回组装</li>
<li>能够通过 REST API 提供预言机以方便合成使用</li>
<li>一个 IDA 插件，提供合成的集成</li>
</ul>
<p>使用工具生成表：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qsynthesis-table-manager generate -bs 64 --var-num 3 --input-num 16 --random-level 5 --ops AND,NEG,MUL,XOR,NOT --watchdog 80 --limit 5000000 my_oracle_table</span><br></pre></td></tr></table></figure>
<p>qsynthesis 的使用案例如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> triton <span class="keyword">import</span> ARCH</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> qsynthesis <span class="keyword">import</span> SimpleSymExec, TopDownSynthesizer, InputOutputOracleLevelDB</span><br><span class="line"><span class="keyword">import</span> qsynthesis</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> pkg_resources</span><br><span class="line">logging.basicConfig(level=logging.DEBUG)</span><br><span class="line"></span><br><span class="line">qsynthesis.enable_logging()</span><br><span class="line"></span><br><span class="line">RIP_ADDR = <span class="number">0x40B160</span></span><br><span class="line">RSP_ADDR = <span class="number">0x800000</span></span><br><span class="line"></span><br><span class="line">INSTRUCTIONS = [<span class="string">b&#x27;U&#x27;</span>, <span class="string">b&#x27;H\x89\xe5&#x27;</span>, <span class="string">b&#x27;H\x89&#125;\xf8&#x27;</span>, <span class="string">b&#x27;H\x89u\xf0&#x27;</span>, <span class="string">b&#x27;H\x89U\xe8&#x27;</span>, <span class="string">b&#x27;H\x89M\xe0&#x27;</span>, <span class="string">b&#x27;L\x89E\xd8&#x27;</span>,</span><br><span class="line">                <span class="string">b&#x27;H\x8bE\xf0&#x27;</span>, <span class="string">b&#x27;H#E\xe0&#x27;</span>, <span class="string">b&#x27;H\x89\xc2&#x27;</span>, <span class="string">b&#x27;H\x8bE\xf0&#x27;</span>, <span class="string">b&#x27;H\x0bE\xe0&#x27;</span>, <span class="string">b&#x27;H\x0f\xaf\xd0&#x27;</span>, <span class="string">b&#x27;H\x8bE\xe0&#x27;</span>,</span><br><span class="line">                <span class="string">b&#x27;H\xf7\xd0&#x27;</span>, <span class="string">b&#x27;H#E\xf0&#x27;</span>, <span class="string">b&#x27;H\x89\xc1&#x27;</span>, <span class="string">b&#x27;H\x8bE\xf0&#x27;</span>, <span class="string">b&#x27;H\xf7\xd0&#x27;</span>, <span class="string">b&#x27;H#E\xe0&#x27;</span>, <span class="string">b&#x27;H\x0f\xaf\xc1&#x27;</span>,</span><br><span class="line">                <span class="string">b&#x27;H\x01\xc2&#x27;</span>, <span class="string">b&#x27;H\x8bE\xe0&#x27;</span>, <span class="string">b&#x27;H\x0f\xaf\xc0&#x27;</span>, <span class="string">b&#x27;H\x89\xd6&#x27;</span>, <span class="string">b&#x27;H!\xc6&#x27;</span>, <span class="string">b&#x27;H\x8bE\xf0&#x27;</span>, <span class="string">b&#x27;H#E\xe0&#x27;</span>,</span><br><span class="line">                <span class="string">b&#x27;H\x89\xc2&#x27;</span>, <span class="string">b&#x27;H\x8bE\xf0&#x27;</span>, <span class="string">b&#x27;H\x0bE\xe0&#x27;</span>, <span class="string">b&#x27;H\x0f\xaf\xd0&#x27;</span>, <span class="string">b&#x27;H\x8bE\xe0&#x27;</span>, <span class="string">b&#x27;H\xf7\xd0&#x27;</span>, <span class="string">b&#x27;H#E\xf0&#x27;</span>,</span><br><span class="line">                <span class="string">b&#x27;H\x89\xc1&#x27;</span>, <span class="string">b&#x27;H\x8bE\xf0&#x27;</span>, <span class="string">b&#x27;H\xf7\xd0&#x27;</span>, <span class="string">b&#x27;H#E\xe0&#x27;</span>, <span class="string">b&#x27;H\x0f\xaf\xc1&#x27;</span>, <span class="string">b&#x27;H\x01\xc2&#x27;</span>, <span class="string">b&#x27;H\x8bE\xe0&#x27;</span>,</span><br><span class="line">                <span class="string">b&#x27;H\x0f\xaf\xc0&#x27;</span>, <span class="string">b&#x27;H\t\xd0&#x27;</span>, <span class="string">b&#x27;H)\xc6&#x27;</span>, <span class="string">b&#x27;H\x89\xf0&#x27;</span>, <span class="string">b&#x27;H\x83\xe8\x01&#x27;</span>, <span class="string">b&#x27;H3E\xf0&#x27;</span>, <span class="string">b&#x27;H\x89\xc2&#x27;</span>,</span><br><span class="line">                <span class="string">b&#x27;H\x8bE\xf0&#x27;</span>, <span class="string">b&#x27;H#E\xe0&#x27;</span>, <span class="string">b&#x27;H\x89\xc1&#x27;</span>, <span class="string">b&#x27;H\x8bE\xf0&#x27;</span>, <span class="string">b&#x27;H\x0bE\xe0&#x27;</span>, <span class="string">b&#x27;H\x0f\xaf\xc8&#x27;</span>, <span class="string">b&#x27;H\x8bE\xe0&#x27;</span>,</span><br><span class="line">                <span class="string">b&#x27;H\xf7\xd0&#x27;</span>, <span class="string">b&#x27;H#E\xf0&#x27;</span>, <span class="string">b&#x27;H\x89\xc6&#x27;</span>, <span class="string">b&#x27;H\x8bE\xf0&#x27;</span>, <span class="string">b&#x27;H\xf7\xd0&#x27;</span>, <span class="string">b&#x27;H#E\xe0&#x27;</span>, <span class="string">b&#x27;H\x0f\xaf\xc6&#x27;</span>,</span><br><span class="line">                <span class="string">b&#x27;H\x01\xc1&#x27;</span>, <span class="string">b&#x27;H\x8bE\xe0&#x27;</span>, <span class="string">b&#x27;H\x0f\xaf\xc0&#x27;</span>, <span class="string">b&#x27;H1\xc8&#x27;</span>, <span class="string">b&#x27;H#E\xf0&#x27;</span>, <span class="string">b&#x27;H\x01\xc0&#x27;</span>, <span class="string">b&#x27;H)\xc2&#x27;</span>,</span><br><span class="line">                <span class="string">b&#x27;H\x89\xd0&#x27;</span>, <span class="string">b&#x27;]&#x27;</span>, <span class="string">b&#x27;\xc3&#x27;</span>]</span><br><span class="line"></span><br><span class="line">qsynthesis_version = pkg_resources.get_distribution(<span class="string">&quot;qsynthesis&quot;</span>).version <span class="comment"># 读取qsynthesis的版本</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;The version of qsynthesis is: <span class="subst">&#123;qsynthesis_version&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span>(<span class="params">oracle_file</span>):</span></span><br><span class="line">    <span class="comment"># Perform symbolic execution of the instructions</span></span><br><span class="line">    symexec = SimpleSymExec(ARCH.X86_64) <span class="comment"># 使用预期的体系结构对其进行初始化</span></span><br><span class="line">    symexec.initialize_register(<span class="string">&#x27;rip&#x27;</span>, RIP_ADDR) <span class="comment"># 初始化寄存器</span></span><br><span class="line">    symexec.initialize_register(<span class="string">&#x27;rsp&#x27;</span>, RSP_ADDR)</span><br><span class="line">    <span class="keyword">for</span> opcode <span class="keyword">in</span> INSTRUCTIONS:</span><br><span class="line">       symexec.execute(opcode) <span class="comment"># 执行给定的操作码</span></span><br><span class="line">    rax = symexec.get_register_ast(<span class="string">&quot;rax&quot;</span>) <span class="comment"># 执行指令后检索rax AST</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Load lookup tables</span></span><br><span class="line">    ltm = InputOutputOracleLevelDB.load(oracle_file) <span class="comment"># 加载查找表数据库</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Perform Synthesis of the expression</span></span><br><span class="line">    synthesizer = TopDownSynthesizer(ltm) <span class="comment"># 实例化表的综合大小</span></span><br><span class="line">    synt_rax, simp = synthesizer.synthesize(rax) <span class="comment"># 触发rax表达式的合成</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Print synthesis results</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;simplified: <span class="subst">&#123;simp&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;synthesized expression: <span class="subst">&#123;synt_rax.pp_str&#125;</span>&quot;</span>)</span><br><span class="line">    sz, nsz = rax.node_count, synt_rax.node_count</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;size: <span class="subst">&#123;rax.node_count&#125;</span> -&gt; <span class="subst">&#123;synt_rax.node_count&#125;</span>\nsize reduction:<span class="subst">&#123;((sz-nsz)*<span class="number">100</span>)/sz:<span class="number">.2</span>f&#125;</span>%&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> symexec, rax, synt_rax</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    sx, rax, srax = test(<span class="string">&quot;my_oracle_table/&quot;</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>结果如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">The version of qsynthesis is: <span class="number">0.2</span><span class="number">.0</span></span><br><span class="line">DEBUG:qsynthesis:<span class="keyword">try</span> synthesis lookup: (((((((((((((rsi &amp; rcx) * (rsi | rcx))) + ((((~(rsi)) &amp; rcx) * ((~(rcx)) &amp; rsi))))) &amp; ((rcx * rcx))) - (((rcx * rcx)) | (((((rsi &amp; rcx) * (rsi | rcx))) + ((((~(rsi)) &amp; rcx) * ((~(rcx)) &amp; rsi)))))))) - <span class="number">0x1</span>)) ^ rsi) - ((((((rcx * rcx)) ^ (((((rsi &amp; rcx) * (rsi | rcx))) + ((((~(rsi)) &amp; rcx) * ((~(rcx)) &amp; rsi)))))) &amp; rsi) + ((((rcx * rcx)) ^ (((((rsi &amp; rcx) * (rsi | rcx))) + ((((~(rsi)) &amp; rcx) * ((~(rcx)) &amp; rsi)))))) &amp; rsi))))) [<span class="number">2</span>]</span><br><span class="line">DEBUG:qsynthesis:<span class="keyword">try</span> synthesis lookup: (((((((((((rsi &amp; rcx) * (rsi | rcx))) + ((((~(rsi)) &amp; rcx) * ((~(rcx)) &amp; rsi))))) &amp; ((rcx * rcx))) - (((rcx * rcx)) | (((((rsi &amp; rcx) * (rsi | rcx))) + ((((~(rsi)) &amp; rcx) * ((~(rcx)) &amp; rsi)))))))) - <span class="number">0x1</span>)) ^ rsi) [<span class="number">2</span>]</span><br><span class="line">DEBUG:qsynthesis:[base] candidate expr accepted: current:<span class="number">47</span> candidate:<span class="number">10</span> (best:<span class="number">0</span>)  =&gt; ((((rcx * rsi)) ^ (~(rsi))) ^ ((rcx * rcx)))</span><br><span class="line">DEBUG:qsynthesis:Replace: (((((((((((rsi &amp; rcx) * (rsi | rcx))) + ((((~(rsi)) &amp; rcx) * ((~(rcx)) &amp; rsi))))) &amp; ((rcx * rcx))) - (((rcx * rcx)) | (((((rsi &amp; rcx) * (rsi | rcx))) + ((((~(rsi)) &amp; rcx) * ((~(rcx)) &amp; rsi)))))))) - <span class="number">0x1</span>)) ^ rsi) ===&gt; ((((rcx * rsi)) ^ (~(rsi))) ^ ((rcx * rcx)))</span><br><span class="line">DEBUG:qsynthesis:<span class="keyword">try</span> synthesis lookup: ((((((rcx * rcx)) ^ (((((rsi &amp; rcx) * (rsi | rcx))) + ((((~(rsi)) &amp; rcx) * ((~(rcx)) &amp; rsi)))))) &amp; rsi) + ((((rcx * rcx)) ^ (((((rsi &amp; rcx) * (rsi | rcx))) + ((((~(rsi)) &amp; rcx) * ((~(rcx)) &amp; rsi)))))) &amp; rsi))) [<span class="number">2</span>]</span><br><span class="line">DEBUG:qsynthesis:<span class="keyword">try</span> synthesis lookup: ((((rcx * rcx)) ^ (((((rsi &amp; rcx) * (rsi | rcx))) + ((((~(rsi)) &amp; rcx) * ((~(rcx)) &amp; rsi)))))) &amp; rsi) [<span class="number">2</span>]</span><br><span class="line">DEBUG:qsynthesis:[base] candidate expr accepted: current:<span class="number">23</span> candidate:<span class="number">11</span> (best:<span class="number">0</span>)  =&gt; ((((rsi * rcx)) &amp; rsi) ^ (((rcx * rcx)) &amp; rsi))</span><br><span class="line">DEBUG:qsynthesis:Replace: ((((rcx * rcx)) ^ (((((rsi &amp; rcx) * (rsi | rcx))) + ((((~(rsi)) &amp; rcx) * ((~(rcx)) &amp; rsi)))))) &amp; rsi) ===&gt; ((((rsi * rcx)) &amp; rsi) ^ (((rcx * rcx)) &amp; rsi))</span><br><span class="line">DEBUG:qsynthesis:<span class="keyword">try</span> synthesis lookup: ((((rcx * rcx)) ^ (((((rsi &amp; rcx) * (rsi | rcx))) + ((((~(rsi)) &amp; rcx) * ((~(rcx)) &amp; rsi)))))) &amp; rsi) [<span class="number">2</span>]</span><br><span class="line">DEBUG:qsynthesis:expression cache found !</span><br><span class="line">DEBUG:qsynthesis:Replace: ((((rcx * rcx)) ^ (((((rsi &amp; rcx) * (rsi | rcx))) + ((((~(rsi)) &amp; rcx) * ((~(rcx)) &amp; rsi)))))) &amp; rsi) ===&gt; ((((rsi * rcx)) &amp; rsi) ^ (((rcx * rcx)) &amp; rsi))</span><br><span class="line">simplified: True</span><br><span class="line">synthesized expression: ((((((rcx * rsi)) ^ (~(rsi))) ^ ((rcx * rcx))) - ((((((rsi * rcx)) &amp; rsi) ^ (((rcx * rcx)) &amp; rsi)) + ((((rsi * rcx)) &amp; rsi) ^ (((rcx * rcx)) &amp; rsi))))))</span><br><span class="line">size: <span class="number">95</span> -&gt; <span class="number">34</span></span><br><span class="line">size reduction:<span class="number">64.21</span>%</span><br></pre></td></tr></table></figure>

    </div>

    
    
    

      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/triton/" rel="tag"><i class="fa fa-tag"></i> triton</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2024/06/27/Js-Go%EF%BC%9A%E5%AE%8C%E5%96%84%E8%AF%AD%E5%8F%A5+%E5%AE%9E%E7%8E%B0%E7%B1%BB/" rel="prev" title="Js-Go：完善语句+实现类">
      <i class="fa fa-chevron-left"></i> Js-Go：完善语句+实现类
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Triton-%E7%9A%84%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8"><span class="nav-number">1.</span> <span class="nav-text">Triton 的安装与使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Triton-%E6%A8%A1%E6%8B%9F%E6%89%A7%E8%A1%8C"><span class="nav-number">1.1.</span> <span class="nav-text">Triton 模拟执行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Triton-%E6%B1%A1%E7%82%B9%E5%88%86%E6%9E%90"><span class="nav-number">1.2.</span> <span class="nav-text">Triton 污点分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Triton-%E4%BB%A3%E7%A0%81%E6%8F%92%E6%A1%A9"><span class="nav-number">1.3.</span> <span class="nav-text">Triton 代码插桩</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Triton-%E7%AC%A6%E5%8F%B7%E6%89%A7%E8%A1%8C"><span class="nav-number">1.4.</span> <span class="nav-text">Triton 符号执行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Triton-%E8%A7%A3%E5%86%B3-CTF-%E9%97%AE%E9%A2%98"><span class="nav-number">1.5.</span> <span class="nav-text">Triton 解决 CTF 问题</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#exrop-%E7%9A%84%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8"><span class="nav-number">2.</span> <span class="nav-text">exrop 的安装与使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#qsynthesis-%E7%9A%84%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8"><span class="nav-number">3.</span> <span class="nav-text">qsynthesis 的安装与使用</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yhellow"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">yhellow</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">333</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">171</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yhellow</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">5m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">75:28</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
