<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="Jemalloc 安装&amp;使用jemalloc 是 Facebook 推出的一种通用 malloc 实现，在 FreeBSD、firefox 中被广泛使用，比起 ptmalloc2 具有更高的性能 编译安装 12345wget https:&#x2F;&#x2F;github.com&#x2F;jemalloc&#x2F;jemalloc&#x2F;releases&#x2F;download&#x2F;5.0.1&#x2F;jemalloc-5.0.1.tar.bz2">
<meta property="og:type" content="article">
<meta property="og:title" content="Jemalloc">
<meta property="og:url" content="http://example.com/2022/05/31/Jemalloc/index.html">
<meta property="og:site_name" content="Pwn进你的心">
<meta property="og:description" content="Jemalloc 安装&amp;使用jemalloc 是 Facebook 推出的一种通用 malloc 实现，在 FreeBSD、firefox 中被广泛使用，比起 ptmalloc2 具有更高的性能 编译安装 12345wget https:&#x2F;&#x2F;github.com&#x2F;jemalloc&#x2F;jemalloc&#x2F;releases&#x2F;download&#x2F;5.0.1&#x2F;jemalloc-5.0.1.tar.bz2">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2022/05/31/Jemalloc/1653930266235-1654524704680.png">
<meta property="article:published_time" content="2022-05-31T15:08:03.000Z">
<meta property="article:modified_time" content="2022-06-06T14:12:26.000Z">
<meta property="article:author" content="yhellow">
<meta property="article:tag" content="Jemalloc">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2022/05/31/Jemalloc/1653930266235-1654524704680.png">

<link rel="canonical" href="http://example.com/2022/05/31/Jemalloc/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>Jemalloc | Pwn进你的心</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Pwn进你的心</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/31/Jemalloc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Jemalloc
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-05-31 23:08:03" itemprop="dateCreated datePublished" datetime="2022-05-31T23:08:03+08:00">2022-05-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-06-06 22:12:26" itemprop="dateModified" datetime="2022-06-06T22:12:26+08:00">2022-06-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>34k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>31 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="Jemalloc-安装-amp-使用"><a href="#Jemalloc-安装-amp-使用" class="headerlink" title="Jemalloc 安装&amp;使用"></a>Jemalloc 安装&amp;使用</h2><p>jemalloc 是 Facebook 推出的一种通用 malloc 实现，在 FreeBSD、firefox 中被广泛使用，比起 ptmalloc2 具有更高的性能</p>
<p><strong>编译安装</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/jemalloc/jemalloc/releases/download/5.0.1/jemalloc-5.0.1.tar.bz2</span><br><span class="line">tar -xjvf jemalloc-5.0.1.tar.bz2</span><br><span class="line">cd jemalloc-5.0.1</span><br><span class="line">./configure --prefix=/usr/local/jemalloc --enable-debug</span><br><span class="line">make -j4 &amp;&amp; sudo make install</span><br></pre></td></tr></table></figure>
<p>接下来修改链接信息： </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo bash</span><br><span class="line">echo /usr/local/jemalloc/ &gt;&gt; /etc/ld.so.conf.d/jemalloc.conf</span><br><span class="line">echo /usr/local/lib &gt;&gt; /etc/ld.so.conf</span><br><span class="line">ldconfig</span><br></pre></td></tr></table></figure>
<p><strong>使用</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jemalloc/jemalloc.h&gt;</span></span></span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">jemalloc_test</span><span class="params">(<span class="keyword">int</span> i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="built_in">malloc</span>(i*<span class="number">100</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i;</span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">1000</span>;i++)</span><br><span class="line">        &#123;</span><br><span class="line">                jemalloc_test(i);</span><br><span class="line">        &#125;</span><br><span class="line">        malloc_stats_print(<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用 GCC 进行编译：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc jemalloc.c -o jemalloc -ljemalloc</span><br></pre></td></tr></table></figure>
<p>演示：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="built_in">exp</span> gcc test.c -o jemalloc -ljemalloc</span><br><span class="line">➜  <span class="built_in">exp</span> ldd jemalloc</span><br><span class="line">	linux-vdso.so<span class="number">.1</span> (<span class="number">0x00007fff753f8000</span>)</span><br><span class="line">	libjemalloc.so<span class="number">.2</span> =&gt; /usr/local/lib/libjemalloc.so<span class="number">.2</span> (<span class="number">0x00007f6caa002000</span>)</span><br><span class="line">	libc.so<span class="number">.6</span> =&gt; /lib/x86_64-linux-gnu/libc.so<span class="number">.6</span> (<span class="number">0x00007f6ca9e10000</span>)</span><br><span class="line">	libstdc++.so<span class="number">.6</span> =&gt; /lib/x86_64-linux-gnu/libstdc++.so<span class="number">.6</span> (<span class="number">0x00007f6ca9bf6000</span>)</span><br><span class="line">	libpthread.so<span class="number">.0</span> =&gt; /lib/x86_64-linux-gnu/libpthread.so<span class="number">.0</span> (<span class="number">0x00007f6ca9bd3000</span>)</span><br><span class="line">	libdl.so<span class="number">.2</span> =&gt; /lib/x86_64-linux-gnu/libdl.so<span class="number">.2</span> (<span class="number">0x00007f6ca9bcd000</span>)</span><br><span class="line">	libgcc_s.so<span class="number">.1</span> =&gt; /lib/x86_64-linux-gnu/libgcc_s.so<span class="number">.1</span> (<span class="number">0x00007f6ca9bb0000</span>)</span><br><span class="line">	/lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span> (<span class="number">0x00007f6caa2a6000</span>)</span><br><span class="line">	libm.so<span class="number">.6</span> =&gt; /lib/x86_64-linux-gnu/libm.so<span class="number">.6</span> (<span class="number">0x00007f6ca9a61000</span>)</span><br></pre></td></tr></table></figure>
<p>对于 Jemalloc 堆的调试，最好使用 shadow：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/CENSUS/shadow">CENSUS/shadow： jemalloc heap exploitation framework (github.com)</a> </p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/hl09083253cy/article/details/79147625">使用 GDB 查看 Jemalloc 内存布局</a> </p>
<h2 id="Jemalloc-架构设计"><a href="#Jemalloc-架构设计" class="headerlink" title="Jemalloc 架构设计"></a>Jemalloc 架构设计</h2><img src="/2022/05/31/Jemalloc/1653930266235-1654524704680.png" class width="1653930266235"> 
<p>上图中涉及 jemalloc 的几个核心概念，例如 arena、bin、chunk、run、region、tcache 等，我们下面逐一进行介绍：</p>
<ul>
<li><strong>arena 是 jemalloc 最重要的部分</strong>，内存由一定数量的 arenas 负责管理，每个用户线程都会被绑定到一个 arena 上，线程采用 round-robin 轮询的方式选择可用的 arena 进行内存分配，为了减少线程之间的锁竞争，默认每个 CPU 会分配 4 个 arena</li>
<li><strong>bin 用于管理不同档位的内存单元</strong>，每个 bin 管理的内存大小是按分类依次递增，因为 jemalloc 中小内存的分配是基于 Slab 算法完成的，所以会产生不同类别的内存块</li>
<li><strong>chunk 是负责管理用户内存块的数据结构</strong>，chunk 以 Page 为单位管理内存，默认大小是 4M，即 1024 个连续 Page，每个 chunk 可被用于多次小内存的申请，但是在大内存分配的场景下只能分配一次</li>
<li><strong>run 实际上是 chunk 中的一块内存区域</strong>，每个 bin 管理相同类型的 run，最终通过操作 run 完成内存分配，run 结构具体的大小由不同的 bin 决定（例如 8 字节的 bin 对应的 run 只有一个 Page，可以从中选取 8 字节的块分配给 regions）</li>
<li><strong>region 是每个 run 中的对应的若干个小内存块</strong>，每个 run 会将划分为若干个等长的 region，每次内存分配也是按照 region 进行分发</li>
<li><strong>tcache 是每个线程私有的缓存</strong>，用于 small 和 large 场景下的内存分配，每个 tcahe 会对应一个 arena，tcache 本身也会有一个 bin 数组，称为tbin，与 arena 中 bin 不同的是，它不会有 run 的概念，tcache 每次从 arena 申请一批内存，在分配内存时首先在 tcache 查找，从而避免锁竞争，如果分配失败才会通过 run 执行内存分配</li>
</ul>
<p>重新梳理下它们之间的关系：</p>
<ul>
<li>内存是由一定数量的 arenas 负责管理，线程均匀分布在 arenas 当中</li>
<li>每个 arena 都包含一个 bin 数组，每个 bin 管理不同档位的内存块</li>
<li>每个 arena 被划分为若干个 chunks，每个 chunk 又包含若干个 runs，每个 run 由连续的 Page 组成，run 才是实际分配内存的操作对象</li>
<li>每个 run 会被划分为一定数量的 regions，在小内存的分配场景，region 相当于用户内存</li>
<li>每个 tcache 对应 一个 arena，tcache 中包含多种类型的 bin</li>
</ul>
<p>简单来说：首先是 arena 是最顶层的，会有多个 arena 结构（一般是一个线程对应一个），arena 内储存 chunk，每个 chunk 大小为 4M，chunk 被分为 run，run 内是 region（用户分配到的数据）</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">  Chunk <span class="comment">#0                           Chunk #1</span></span><br><span class="line">.--------------------------------. .--------------------------------.</span><br><span class="line">|<span class="string">   Run #0         Run #1        </span>|<span class="string"> </span>|<span class="string">   Run #0         Run #1        </span>|</span><br><span class="line">|<span class="string"> .-------------..-------------. </span>|<span class="string"> </span>|<span class="string"> .-------------..-------------. </span>|</span><br><span class="line">|<span class="string"> </span>|<span class="string">   Page      </span>||<span class="string">   Page      </span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string">   Page      </span>||<span class="string">   Page      </span>|<span class="string"> </span>|</span><br><span class="line">|<span class="string"> </span>|<span class="string"> .---------. </span>||<span class="string"> .---------. </span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string"> .---------. </span>||<span class="string"> .---------. </span>|<span class="string"> </span>|</span><br><span class="line">|<span class="string"> </span>|<span class="string"> </span>|<span class="string"> Regions </span>|<span class="string"> </span>||<span class="string"> </span>|<span class="string"> Regions </span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string"> Regions </span>|<span class="string"> </span>||<span class="string"> </span>|<span class="string"> Regions </span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string">	...</span></span><br><span class="line"><span class="string"></span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string">[] [] [] </span>|<span class="string"> </span>||<span class="string"> </span>|<span class="string">[] [] [] </span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string">[] [] [] </span>|<span class="string"> </span>||<span class="string"> </span>|<span class="string">[] [] [] </span>|<span class="string"> </span>|<span class="string"> </span>|</span><br><span class="line">|<span class="string"> </span>|<span class="string"> `-</span>|<span class="string">-----</span>|<span class="string">-&#x27; </span>||<span class="string"> `---------&#x27; </span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string"> `-</span>|<span class="string">-----</span>|<span class="string">-&#x27; </span>||<span class="string"> `---------&#x27; </span>|<span class="string"> </span>|</span><br><span class="line">|<span class="string"> `---</span>|<span class="string">-----</span>|<span class="string">---&#x27;`-------------&#x27; </span>|<span class="string"> </span>|<span class="string"> `---</span>|<span class="string">-----</span>|<span class="string">---&#x27;`-------------&#x27; </span>|</span><br><span class="line">`-----|<span class="string">-----</span>|<span class="string">--------------------&#x27; `-----</span>|<span class="string">-----</span>|<span class="string">--------------------&#x27;</span></span><br><span class="line"><span class="string">      </span>|<span class="string">     </span>|<span class="string">                            </span>|<span class="string">     </span>|</span><br><span class="line">  .---|<span class="string">-----</span>|<span class="string">----------.             .---</span>|<span class="string">-----</span>|<span class="string">----------.</span></span><br><span class="line"><span class="string">  </span>|<span class="string"> free regions&#x27; tree </span>|<span class="string"> ...         </span>|<span class="string"> free regions&#x27; tree </span>|<span class="string"> ...</span></span><br><span class="line"><span class="string">  `--------------------&#x27;             `--------------------&#x27;</span></span><br><span class="line"><span class="string">  bin[Chunk #0][Run #0]              bin[Chunk #1][Run #0]</span></span><br></pre></td></tr></table></figure>
<h2 id="Jemalloc-数据结构"><a href="#Jemalloc-数据结构" class="headerlink" title="Jemalloc 数据结构"></a>Jemalloc 数据结构</h2><p><strong>arena_t</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">arena_s</span> <span class="title">arena_t</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">arena_s</span> &#123;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> JEMALLOC_DEBUG</span></span><br><span class="line">	<span class="keyword">uint32_t</span>		magic;</span><br><span class="line"><span class="meta">#  <span class="meta-keyword">define</span> ARENA_MAGIC 0x947d3d24</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    </span><br><span class="line">	<span class="keyword">unsigned</span>		ind; <span class="comment">/* 这个arena在arenas数组中的索引 */</span></span><br><span class="line">	<span class="keyword">unsigned</span>		nthreads; <span class="comment">/* 当前分配给此竞技场的线程数(该字段受arenas_lock保护) */</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    arena的锁操作分为三类:</span></span><br><span class="line"><span class="comment">    1.线程分配(修改nthreads): 受arenas_lock保护</span></span><br><span class="line"><span class="comment">    2.与bin相关的操作: 受到bin锁的保护</span></span><br><span class="line"><span class="comment">    3.与chunk和run相关的操作: 受此互斥锁保护</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">	<span class="keyword">malloc_mutex_t</span>		lock;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> JEMALLOC_STATS</span></span><br><span class="line">	<span class="keyword">arena_stats_t</span>		stats;</span><br><span class="line"><span class="meta">#  <span class="meta-keyword">ifdef</span> JEMALLOC_TCACHE</span></span><br><span class="line">	ql_head(<span class="keyword">tcache_t</span>)	tcache_ql; <span class="comment">/* 与此arena关联的现有线程的tcache列表(来自这些的统计信息会逐渐合并,并在退出时合并) */</span></span><br><span class="line"><span class="meta">#  <span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> JEMALLOC_PROF</span></span><br><span class="line">	<span class="keyword">uint64_t</span>		prof_accumbytes;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    </span><br><span class="line">	ql_head(<span class="keyword">arena_chunk_t</span>)	chunks_dirty; <span class="comment">/* 此arena管理的&quot;包含脏页的块&quot;列表 */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* </span></span><br><span class="line"><span class="comment">    为了避免当竞技场在需要新块的风口浪尖时快速分配/释放,spare(备用块)用于缓存最近释放的块</span></span><br><span class="line"><span class="comment">    spare将留在竞技场的chunk树中,直到它被删除</span></span><br><span class="line"><span class="comment">    每个arena都有一个spare(以避免多个线程之间的交互),这可能使单个spare不足</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">	<span class="keyword">arena_chunk_t</span>		*spare; </span><br><span class="line">	<span class="keyword">size_t</span>			nactive; <span class="comment">/* active run(已使用的run)的页数 */</span></span><br><span class="line">	<span class="keyword">size_t</span>			ndirty; <span class="comment">/* 当前未使用的run中,可能脏的页面计数(通过跟踪这一点,我们可以限制为每个arena映射脏内存的多少) */</span></span><br><span class="line">	<span class="keyword">size_t</span>			npurgatory; <span class="comment">/* 正在清除的大概页数(多个线程可以同时清除脏页,它们使用npurgatory来指示所有线程试图清除的页面总数) */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    runs_avail_clean用于执行最适合的run分配,干净树包含的run的page要么没有关联的物理页面,要么具有内核可以随时回收的页面</span></span><br><span class="line"><span class="comment">    runs_avail_dirty脏树包含带有脏页的run(即很可能已被触及并因此具有关联的物理页面)</span></span><br><span class="line"><span class="comment">    脏树优先于清洁树进行分配,因为使用脏页减少了将活动: 脏页比率保持在清除阈值以下所需的脏清除量</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">	<span class="keyword">arena_avail_tree_t</span>	runs_avail_clean; <span class="comment">/* 此竞技场可用run的大小/地址排序树 */</span></span><br><span class="line">	<span class="keyword">arena_avail_tree_t</span>	runs_avail_dirty; <span class="comment">/* 脏树包含带有脏页的run */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * bins用于存储以下大小的自由区域的树:</span></span><br><span class="line"><span class="comment">	 * 假设: 64位系统, 具有16字节quantum, 4KB页面大小, 默认MALLOC_CONF</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 *   bins[i] |   size |</span></span><br><span class="line"><span class="comment">	 *   --------+--------+</span></span><br><span class="line"><span class="comment">	 *        0  |      8 |</span></span><br><span class="line"><span class="comment">	 *   --------+--------+</span></span><br><span class="line"><span class="comment">	 *        1  |     16 |</span></span><br><span class="line"><span class="comment">	 *        2  |     32 |</span></span><br><span class="line"><span class="comment">	 *        3  |     48 |</span></span><br><span class="line"><span class="comment">	 *           :        :</span></span><br><span class="line"><span class="comment">	 *        6  |     96 |</span></span><br><span class="line"><span class="comment">	 *        7  |    112 |</span></span><br><span class="line"><span class="comment">	 *        8  |    128 |</span></span><br><span class="line"><span class="comment">	 *   --------+--------+</span></span><br><span class="line"><span class="comment">	 *        9  |    192 |</span></span><br><span class="line"><span class="comment">	 *       10  |    256 |</span></span><br><span class="line"><span class="comment">	 *       11  |    320 |</span></span><br><span class="line"><span class="comment">	 *       12  |    384 |</span></span><br><span class="line"><span class="comment">	 *       13  |    448 |</span></span><br><span class="line"><span class="comment">	 *       14  |    512 |</span></span><br><span class="line"><span class="comment">	 *   --------+--------+</span></span><br><span class="line"><span class="comment">	 *       15  |    768 |</span></span><br><span class="line"><span class="comment">	 *       16  |   1024 |</span></span><br><span class="line"><span class="comment">	 *       17  |   1280 |</span></span><br><span class="line"><span class="comment">	 *           :        :</span></span><br><span class="line"><span class="comment">	 *       25  |   3328 |</span></span><br><span class="line"><span class="comment">	 *       26  |   3584 |</span></span><br><span class="line"><span class="comment">	 *       27  |   3840 |</span></span><br><span class="line"><span class="comment">	 *   --------+--------+</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">arena_bin_t</span>		bins[<span class="number">1</span>]; <span class="comment">/* bins的动态大小 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>用于描述 Arenas 的结构体</li>
</ul>
<p><strong>arena_chunk_t</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">arena_chunk_s</span> <span class="title">arena_chunk_t</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Arena chunk header. */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">arena_chunk_s</span> &#123;</span></span><br><span class="line">	<span class="keyword">arena_t</span>		*arena; <span class="comment">/* 指向拥有该chunk的arena */</span></span><br><span class="line">	ql_elm(<span class="keyword">arena_chunk_t</span>) link_dirty; <span class="comment">/* arena的chunk_dirty列表的链接 */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">bool</span>		dirtied; <span class="comment">/* 如果当前chunk在chunks_dirty列表中,则为真 */</span></span><br><span class="line">	<span class="keyword">size_t</span>		ndirty; <span class="comment">/* 脏页的数目 */</span></span><br><span class="line">    </span><br><span class="line">	<span class="keyword">arena_chunk_map_t</span> <span class="built_in">map</span>[<span class="number">1</span>]; <span class="comment">/* map的动态大小 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>用于描述 Chunk 的结构体</li>
<li>块映射与块的内存对齐结合的主要用途是：实现对空闲和大/小堆分配（区域）的管理元数据的恒定时间访问</li>
</ul>
<p><strong>arena_bin_t</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">arena_bin_s</span> <span class="title">arena_bin_t</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">arena_bin_s</span> &#123;</span></span><br><span class="line">	<span class="keyword">malloc_mutex_t</span>	lock; <span class="comment">/* runcur,runs和stats上的所有操作都需要锁定该锁(run分配/解除分配受arena锁保护,可以在持有一个或多个bin锁时获取,但反之则不然) */</span></span><br><span class="line">    </span><br><span class="line">	<span class="keyword">arena_run_t</span>	*runcur; <span class="comment">/* 表示服务于此bin的run(对应arena_run_t结构体的地址) */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	当runcur不再可用,需要查找现有run时才使用此树(我们选择内存最低的非完整运行)</span></span><br><span class="line"><span class="comment">	这个策略倾向于保持对象打包好,它还可以帮助减少几乎空的块的数量</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">arena_run_tree_t</span> runs; <span class="comment">/* 与bin相关运行的树(非完整运行树) */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> JEMALLOC_STATS</span></span><br><span class="line">	<span class="keyword">malloc_bin_stats_t</span> stats; <span class="comment">/* Bin统计信息 */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>用于描述 Bins 的结构体</li>
<li>每个 bin 都有一个关联的大小类别，并存储/管理该类别的区域大小类</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffff7800c30</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffff7800c30</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffff7800c38</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7ffff7800c40</span> ◂— <span class="number">0x200</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7ffff7800c48</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7ffff7800c50</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x7ffff7800c58</span> —▸ <span class="number">0x7ffff7006000</span> ◂— <span class="number">0x384adf93</span> <span class="comment">// runcur</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x7ffff7800c60</span> —▸ <span class="number">0x7ffff7800c68</span> ◂— <span class="number">0x7ffff7800c68</span> <span class="comment">// runs</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x7ffff7800c68</span> ◂— <span class="number">0x7ffff7800c68</span></span><br><span class="line"></span><br><span class="line">pwndbg&gt; p (<span class="keyword">arena_bin_t</span>)*<span class="number">0x7ffff7800c30</span></span><br><span class="line">$<span class="number">5</span> = &#123;</span><br><span class="line">  lock = &#123;</span><br><span class="line">    __data = &#123;</span><br><span class="line">      __lock = <span class="number">0</span>,</span><br><span class="line">      __count = <span class="number">0</span>,</span><br><span class="line">      __owner = <span class="number">0</span>,</span><br><span class="line">      __nusers = <span class="number">0</span>,</span><br><span class="line">      __kind = <span class="number">512</span>,</span><br><span class="line">      __spins = <span class="number">0</span>,</span><br><span class="line">      __elision = <span class="number">0</span>,</span><br><span class="line">      __list = &#123;</span><br><span class="line">        __prev = <span class="number">0x0</span>,</span><br><span class="line">        __next = <span class="number">0x0</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    __size = <span class="string">&#x27;\000&#x27;</span> &lt;repeats <span class="number">17</span> times&gt;, <span class="string">&quot;\002&quot;</span>, <span class="string">&#x27;\000&#x27;</span> &lt;repeats <span class="number">21</span> times&gt;,</span><br><span class="line">    __align = <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  runcur = <span class="number">0x7ffff7006000</span>,</span><br><span class="line">  runs = &#123; <span class="comment">/* 这是一个&quot;树结构&quot; */</span></span><br><span class="line">    rbt_root = <span class="number">0x7ffff7800c68</span>,</span><br><span class="line">    rbt_nil = &#123;</span><br><span class="line">      u = &#123;</span><br><span class="line">        rb_link = &#123;</span><br><span class="line">          rbn_left = <span class="number">0x7ffff7800c68</span>,</span><br><span class="line">          rbn_right_red = <span class="number">0x7ffff7800c68</span></span><br><span class="line">        &#125;,</span><br><span class="line">        ql_link = &#123;</span><br><span class="line">          qre_next = <span class="number">0x7ffff7800c68</span>,</span><br><span class="line">          qre_prev = <span class="number">0x7ffff7800c68</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      bits = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>arena_bin_info_t</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">arena_bin_info_s</span> <span class="title">arena_bin_info_t</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">arena_bin_info_s</span> &#123;</span></span><br><span class="line">	<span class="keyword">size_t</span>		reg_size; <span class="comment">/* 属于该bin的,run所对应的区域大小 */</span></span><br><span class="line">	<span class="keyword">size_t</span>		run_size; <span class="comment">/* 此bin对应的,run的大小 */</span></span><br><span class="line">	<span class="keyword">uint32_t</span>	nregs; <span class="comment">/* 此bin对应的,run的区域总数 */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">uint32_t</span>	bitmap_offset; <span class="comment">/* 此bin对应的,run标头中第一个bitmap_t元素的偏移量 */</span></span><br><span class="line">    </span><br><span class="line">	<span class="keyword">bitmap_info_t</span>	bitmap_info; <span class="comment">/* 用于操作与此bin关联的run的位图的元数据 */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> JEMALLOC_PROF</span></span><br><span class="line">	<span class="keyword">uint32_t</span>	ctx0_offset; <span class="comment">/* 此bin对应的,run标头中第一个(prof_ctx_t *)的偏移量,如果(opt_prof==false)则为&#x27;0&#x27; */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">uint32_t</span>	reg0_offset; <span class="comment">/* 此bin对应的,run中第一个区域的偏移量 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>用于阐释 Bins 的信息</li>
</ul>
<p><strong>arena_run_t</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">arena_run_s</span> <span class="title">arena_run_t</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">arena_run_s</span> &#123;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> JEMALLOC_DEBUG</span></span><br><span class="line">	<span class="keyword">uint32_t</span>	magic;</span><br><span class="line"><span class="meta">#  <span class="meta-keyword">define</span> ARENA_RUN_MAGIC 0x384adf93</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">arena_bin_t</span>	*bin; <span class="comment">/* 与此run关联的bin */</span></span><br><span class="line">	<span class="keyword">uint32_t</span>	nextind; <span class="comment">/* 下一个从未分配过的区域或nregs的索引 */</span></span><br><span class="line">	<span class="keyword">unsigned</span>	nfree; <span class="comment">/* run中的空闲区域数 */</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 本次运行中区域的位掩码,每个位对应一个区域,&#x27;0&#x27;表示该区域已使用,&#x27;1&#x27;位值表示相应区域空闲,变量nextind是该数组的第一个非零元素的索引 */</span></span><br><span class="line">    <span class="keyword">unsigned</span> regs_mask[];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>用于描述 Runs 的结构体</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffff7006000</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffff7006000</span> ◂— <span class="number">0x384adf93</span> <span class="comment">// magic</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffff7006008</span> —▸ <span class="number">0x7ffff7800c30</span> ◂— <span class="number">0x0</span> <span class="comment">// bin</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7ffff7006010</span> ◂— <span class="number">0xfa00000002</span> <span class="comment">// nextind &amp; nfree</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7ffff7006018</span> ◂— <span class="number">0xfffffffffffffffc</span> <span class="comment">// regs_mask</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7ffff7006020</span> ◂— <span class="number">0xffffffffffffffff</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x7ffff7006028</span> ◂— <span class="number">0xffffffffffffffff</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x7ffff7006030</span> ◂— <span class="number">0xfffffffffffffff</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x7ffff7006038</span> ◂— <span class="number">0xf</span></span><br><span class="line">    </span><br><span class="line">pwndbg&gt; p (<span class="keyword">arena_run_t</span>)*<span class="number">0x7ffff7006000</span></span><br><span class="line">$<span class="number">4</span> = &#123;</span><br><span class="line">  magic = <span class="number">944430995</span>,</span><br><span class="line">  bin = <span class="number">0x7ffff7800c30</span>,</span><br><span class="line">  nextind = <span class="number">2</span>,</span><br><span class="line">  nfree = <span class="number">250</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>extent_node_t</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">extent_node_s</span> <span class="title">extent_node_t</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Tree of extents. */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">extent_node_s</span> &#123;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (defined(JEMALLOC_SWAP) || defined(JEMALLOC_DSS))</span></span><br><span class="line">	rb_node(<span class="keyword">extent_node_t</span>)	link_szad; <span class="comment">/* 大小/地址排序树的链接 */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	rb_node(<span class="keyword">extent_node_t</span>)	link_ad; <span class="comment">/* 地址排序树的链接 */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> JEMALLOC_PROF</span></span><br><span class="line">	<span class="keyword">prof_ctx_t</span>		*prof_ctx; <span class="comment">/* 配置文件计数器,用于huge的对象 */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    </span><br><span class="line">	<span class="keyword">void</span>			*addr; <span class="comment">/* 指向此树节点负责的范围的指针 */</span></span><br><span class="line">	<span class="keyword">size_t</span>			size; <span class="comment">/* 总区域大小 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>huge 的分配由 “extent_node_t” 结构表示，在所有线程共有的全局红黑树中排序</li>
<li>“extent_node_t” 结构分配在称为基节点的小内存区域中</li>
<li>基本节点不会影响最终用户堆分配的布局，因为它们由 DSS 或由 “mmap()” 获取的单个内存映射提供服务</li>
<li>用于分配空闲空间的实际方法取决于 jemalloc 是如何编译的，而 “mmap()” 是默认值</li>
</ul>
<p><strong>Regions/Allocations</strong></p>
<p>Jemalloc 实际分配给用户的内存空间就是 Regions，根据 Regions 的大小，可以把它区分为3个种类：</p>
<ul>
<li>Small/Medium</li>
<li>Large</li>
<li>Huge</li>
</ul>
<p>下图总结了到目前为止我们对 jemalloc 的分析：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">   .----------------------------------.       .---------------------------.</span><br><span class="line"> .----------------------------------. |<span class="string">    +--+-----&gt; arena_chunk_t       </span>|</span><br><span class="line">.---------------------------------. |<span class="string"> </span>|<span class="string">    </span>|<span class="string">  </span>|<span class="string">                           </span>|</span><br><span class="line">|<span class="string">             arena_t             </span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string">    </span>|<span class="string">  </span>|<span class="string">  .---------------------.  </span>|</span><br><span class="line">|<span class="string">                                 </span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string">    </span>|<span class="string">  </span>|<span class="string">  </span>|<span class="string">                     </span>|<span class="string">  </span>|</span><br><span class="line">|<span class="string"> .--------------------.          </span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string">    </span>|<span class="string">  </span>|<span class="string">  </span>|<span class="string">     arena_run_t     </span>|<span class="string">  </span>|</span><br><span class="line">|<span class="string"> </span>|<span class="string"> arena_chunk_t list </span>|<span class="string">-----+    </span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string">    </span>|<span class="string">  </span>|<span class="string">  </span>|<span class="string">                     </span>|<span class="string">  </span>|</span><br><span class="line">|<span class="string"> `--------------------&#x27;     </span>|<span class="string">    </span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string">    </span>|<span class="string">  </span>|<span class="string">  </span>|<span class="string">    .-----------.    </span>|<span class="string">  </span>|</span><br><span class="line">|<span class="string">                            </span>|<span class="string">    </span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string">    </span>|<span class="string">  </span>|<span class="string">  </span>|<span class="string">    </span>|<span class="string">   page    </span>|<span class="string">    </span>|<span class="string">  </span>|</span><br><span class="line">|<span class="string">   arena_bin_t bins[];      </span>|<span class="string">    </span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string">    </span>|<span class="string">  </span>|<span class="string">  </span>|<span class="string">    +-----------+    </span>|<span class="string">  </span>|</span><br><span class="line">|<span class="string"> .------------------------. </span>|<span class="string">    </span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string">    </span>|<span class="string">  </span>|<span class="string">  </span>|<span class="string">    </span>|<span class="string">  region   </span>|<span class="string">    </span>|<span class="string">  </span>|</span><br><span class="line">|<span class="string"> </span>|<span class="string"> bins[0]  ...  bins[27] </span>|<span class="string"> </span>|<span class="string">    </span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string">    </span>|<span class="string">  </span>|<span class="string">  </span>|<span class="string">    +-----------+    </span>|<span class="string">  </span>|</span><br><span class="line">|<span class="string"> `------------------------&#x27; </span>|<span class="string">    </span>|<span class="string"> </span>|<span class="string">.&#x27;    </span>|<span class="string">  </span>|<span class="string">  </span>|<span class="string">    </span>|<span class="string">  region   </span>|<span class="string">    </span>|<span class="string">  </span>|</span><br><span class="line">|<span class="string">     </span>|<span class="string">                      </span>|<span class="string">    </span>|<span class="string">.&#x27;      </span>|<span class="string">  </span>|<span class="string">  </span>|<span class="string">    +-----------+    </span>|<span class="string">  </span>|</span><br><span class="line">`-----+----------------------+----&#x27;        |<span class="string">  </span>|<span class="string">  </span>|<span class="string">    </span>|<span class="string">  region   </span>|<span class="string">    </span>|<span class="string">  </span>|</span><br><span class="line">      |<span class="string">                      </span>|<span class="string">             </span>|<span class="string">  </span>|<span class="string">  </span>|<span class="string">    +-----------+    </span>|<span class="string">  </span>|</span><br><span class="line">      |<span class="string">                      </span>|<span class="string">             </span>|<span class="string">  </span>|<span class="string">  </span>|<span class="string">        . . .        </span>|<span class="string">  </span>|</span><br><span class="line">      |<span class="string">                      v             </span>|<span class="string">  </span>|<span class="string">  </span>|<span class="string">    .-----------.    </span>|<span class="string">  </span>|</span><br><span class="line">      |<span class="string">            .-------------------.   </span>|<span class="string">  </span>|<span class="string">  </span>|<span class="string">    </span>|<span class="string">   page    </span>|<span class="string">    </span>|<span class="string">  </span>|</span><br><span class="line">      |<span class="string">            </span>|<span class="string"> .---------------. </span>|<span class="string">   </span>|<span class="string">  </span>|<span class="string">  </span>|<span class="string">    +-----------+    </span>|<span class="string">  </span>|</span><br><span class="line">      |<span class="string">            </span>|<span class="string"> </span>|<span class="string"> arena_chunk_t </span>|<span class="string">-+---+  </span>|<span class="string">  </span>|<span class="string">    </span>|<span class="string">  region   </span>|<span class="string">    </span>|<span class="string">  </span>|</span><br><span class="line">      |<span class="string">            </span>|<span class="string"> `---------------&#x27; </span>|<span class="string">      </span>|<span class="string">  </span>|<span class="string">    +-----------+    </span>|<span class="string">  </span>|</span><br><span class="line">      |<span class="string">     [2-5]  </span>|<span class="string"> .---------------. </span>|<span class="string">      </span>|<span class="string">  </span>|<span class="string">    </span>|<span class="string">  region   </span>|<span class="string">    </span>|<span class="string">  </span>|</span><br><span class="line">      |<span class="string">            </span>|<span class="string"> </span>|<span class="string"> arena_chunk_t </span>|<span class="string"> </span>|<span class="string">      </span>|<span class="string">  </span>|<span class="string">    +-----------+    </span>|<span class="string">  </span>|</span><br><span class="line">      |<span class="string">            </span>|<span class="string"> `---------------&#x27; </span>|<span class="string">      </span>|<span class="string">  </span>|<span class="string">    </span>|<span class="string">  region   </span>|<span class="string">    </span>|<span class="string">  </span>|</span><br><span class="line">      |<span class="string">            </span>|<span class="string">       . . .       </span>|<span class="string">      </span>|<span class="string">  </span>|<span class="string">    +-----------+    </span>|<span class="string">  </span>|</span><br><span class="line">      |<span class="string">            </span>|<span class="string"> .---------------. </span>|<span class="string">      </span>|<span class="string">  </span>|<span class="string">                     </span>|<span class="string">  </span>|</span><br><span class="line">      |<span class="string">            </span>|<span class="string"> </span>|<span class="string"> arena_chunk_t </span>|<span class="string"> </span>|<span class="string">      </span>|<span class="string">  `---------------------&#x27;  </span>|</span><br><span class="line">      |<span class="string">            </span>|<span class="string"> `---------------&#x27; </span>|<span class="string">      </span>|<span class="string">          [2-6]            </span>|</span><br><span class="line">      |<span class="string">            </span>|<span class="string">       . . .       </span>|<span class="string">      </span>|<span class="string">  .---------------------.  </span>|</span><br><span class="line">      |<span class="string">            `-------------------&#x27;      </span>|<span class="string">  </span>|<span class="string">                     </span>|<span class="string">  </span>|</span><br><span class="line">      |<span class="string">                                  +----+--+---&gt; arena_run_t     </span>|<span class="string">  </span>|</span><br><span class="line">      |<span class="string">                                  </span>|<span class="string">    </span>|<span class="string">  </span>|<span class="string">                     </span>|<span class="string">  </span>|</span><br><span class="line">      +----------+                       |<span class="string">    </span>|<span class="string">  </span>|<span class="string">    .-----------.    </span>|<span class="string">  </span>|</span><br><span class="line">                 |<span class="string">                       </span>|<span class="string">    </span>|<span class="string">  </span>|<span class="string">    </span>|<span class="string">   page    </span>|<span class="string">    </span>|<span class="string">  </span>|</span><br><span class="line">                 |<span class="string">                       </span>|<span class="string">    </span>|<span class="string">  </span>|<span class="string">    +-----------+    </span>|<span class="string">  </span>|</span><br><span class="line">                 |<span class="string">                       </span>|<span class="string">    </span>|<span class="string">  </span>|<span class="string">    </span>|<span class="string">  region   </span>|<span class="string">    </span>|<span class="string">  </span>|</span><br><span class="line">                 v                       |<span class="string">    </span>|<span class="string">  </span>|<span class="string">    +-----------+    </span>|<span class="string">  </span>|</span><br><span class="line">    .--------------------------.         |<span class="string">    </span>|<span class="string">  </span>|<span class="string">    </span>|<span class="string">  region   </span>|<span class="string">    </span>|<span class="string">  </span>|</span><br><span class="line">    |<span class="string">       arena_bin_t        </span>|<span class="string">         </span>|<span class="string">    </span>|<span class="string">  </span>|<span class="string">    +-----------+    </span>|<span class="string">  </span>|</span><br><span class="line">    |<span class="string">     bins[0] (size 8)     </span>|<span class="string">         </span>|<span class="string">    </span>|<span class="string">  </span>|<span class="string">    </span>|<span class="string">  region   </span>|<span class="string">    </span>|<span class="string">  </span>|</span><br><span class="line">    |<span class="string">                          </span>|<span class="string">         </span>|<span class="string">    </span>|<span class="string">  </span>|<span class="string">    +-----------+    </span>|<span class="string">  </span>|</span><br><span class="line">    |<span class="string"> .----------------------. </span>|<span class="string">         </span>|<span class="string">    </span>|<span class="string">  </span>|<span class="string">        . . .        </span>|<span class="string">  </span>|</span><br><span class="line">    |<span class="string"> </span>|<span class="string"> arena_run_t *runcur; </span>|<span class="string">-+---------+    </span>|<span class="string">  </span>|<span class="string">    .-----------.    </span>|<span class="string">  </span>|</span><br><span class="line">    |<span class="string"> `----------------------&#x27; </span>|<span class="string">              </span>|<span class="string">  </span>|<span class="string">    </span>|<span class="string">   page    </span>|<span class="string">    </span>|<span class="string">  </span>|</span><br><span class="line">    `--------------------------&#x27;              |<span class="string">  </span>|<span class="string">    +-----------+    </span>|<span class="string">  </span>|</span><br><span class="line">                                              |<span class="string">  </span>|<span class="string">    </span>|<span class="string">  region   </span>|<span class="string">    </span>|<span class="string">  </span>|</span><br><span class="line">                                              |<span class="string">  </span>|<span class="string">    +-----------+    </span>|<span class="string">  </span>|</span><br><span class="line">                                              |<span class="string">  </span>|<span class="string">    </span>|<span class="string">  region   </span>|<span class="string">    </span>|<span class="string">  </span>|</span><br><span class="line">                                              |<span class="string">  </span>|<span class="string">    +-----------+    </span>|<span class="string">  </span>|</span><br><span class="line">                                              |<span class="string">  </span>|<span class="string">    </span>|<span class="string">  region   </span>|<span class="string">    </span>|<span class="string">  </span>|</span><br><span class="line">                                              |<span class="string">  </span>|<span class="string">    +-----------+    </span>|<span class="string">  </span>|</span><br><span class="line">                                              |<span class="string">  </span>|<span class="string">                     </span>|<span class="string">  </span>|</span><br><span class="line">                                              |<span class="string">  `---------------------&#x27;  </span>|</span><br><span class="line">                                              `---------------------------&#x27;</span><br></pre></td></tr></table></figure>
<h2 id="Jemalloc-分配机制"><a href="#Jemalloc-分配机制" class="headerlink" title="Jemalloc 分配机制"></a>Jemalloc 分配机制</h2><p>Jemalloc 把内存分配分为了 <strong>三个部分</strong>：</p>
<ul>
<li>第一部分类似 tcmalloc，是分别以8字节，16字节，64字节 …… 等分隔开的 <strong>small class</strong></li>
<li>第二部分以分页为单位，等差间隔开的 <strong>large class</strong></li>
<li>然后就是 <strong>huge class</strong></li>
</ul>
<p>内存块的管理也通过一种 chunk 进行，一个 chunk 的大小是 2^k (默认4 MB)，通过这种分配实现常数时间地分配 small 和 large 对象，对数时间地查询 huge 对象的 meta（使用红黑树） </p>
<p>默认64位系统的划分方式如下：</p>
<ul>
<li><strong>Small：</strong>[8]，[16,32,48,…,128]（16字节等分），[128,192,256,320, …,512]（64字节等分），[512,768,1024,1280,…,3840]（256字节等分）</li>
<li><strong>Large：</strong>[4 KB, 8 KB, 12 KB,…, 4072 KB]（4KB 等分，一页等分）</li>
<li><strong>Huge：</strong>[4 MB, 8 MB, 12 MB,…]（大于 4MB 的超大内存）</li>
</ul>
<p>接下来我们分析下 jemalloc 的整体内存分配和释放流程，主要分为 <strong>Samll</strong>、<strong>Large</strong> 和 <strong>Huge</strong> 三种场景：</p>
<ul>
<li><strong>Small 场景</strong><ul>
<li>如果请求分配内存的大小小于 arena 中的最小的 bin，那么优先从线程中对应的 tcache 中进行分配</li>
<li>首先确定查找对应的 tbin 中是否存在缓存的内存块，如果存在则分配成功，否则找到 tbin 对应的 arena</li>
<li>从 arena 中对应的 bin 中分配 region 保存在 tbin 的 avail 数组中，最终从 availl 数组中选取一个地址进行内存分配，当内存释放时也会将被回收的内存块进行缓存</li>
</ul>
</li>
<li><strong>Large 场景</strong><ul>
<li>Large 的内存分配与 Samll 类似，如果请求分配内存的大小大于 arena 中的最小的 bin，但是不大于 tcache 中能够缓存的最大块，依然会通过 tcache 进行分配，但是不同的是此时会分配 chunk 以及所对应的 run，从 chunk 中找到相应的内存空间进行分配</li>
<li>内存释放时也跟 samll 场景类似，会把释放的内存块缓存在 tacache 的 tbin 中</li>
<li>此外还有一种情况，当请求分配内存的大小大于 tcache 中能够缓存的最大块，但是不大于 chunk 的大小，那么将不会采用 tcache 机制，直接在 chunk 中进行内存分配</li>
</ul>
</li>
<li><strong>Huge 场景</strong><ul>
<li>如果请求分配内存的大小大于 chunk 的大小，那么直接通过 mmap 进行分配，调用 munmap 进行回收</li>
</ul>
</li>
</ul>
<p><strong>分配流程</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">MALLOC(size): <span class="comment">/* 如果size在huge的范围,则调用mmap进行分配 */</span></span><br><span class="line">    IF size CAN BE SERVICED BY AN ARENA: <span class="comment">/* 如果size在&#x27;arena&#x27;的范围内 */</span></span><br><span class="line">        IF size IS SMALL OR MEDIUM: <span class="comment">/* 如果size在&#x27;small/medium&#x27;的范围内 */</span></span><br><span class="line">            bin = get_bin_for_size(size)</span><br><span class="line"></span><br><span class="line">            IF bin-&gt;runcur EXISTS AND NOT FULL: <span class="comment">/* 如果对应的bin存在且未满 */</span></span><br><span class="line">                run = bin-&gt;runcur</span><br><span class="line">            ELSE:</span><br><span class="line">                run = lookup_or_allocate_nonfull_run() </span><br><span class="line">                bin-&gt;runcur = run</span><br><span class="line"></span><br><span class="line">            bit = get_first_set_bit(run-&gt;regs_mask)</span><br><span class="line">            region = get_region(run, bit)</span><br><span class="line"></span><br><span class="line">        ELIF size IS LARGE: <span class="comment">/* 如果size在&#x27;large&#x27;的范围内 */</span></span><br><span class="line">            region = allocate_new_run()</span><br><span class="line">    ELSE:</span><br><span class="line">        region = allocate_new_chunk()</span><br><span class="line">    RETURN region <span class="comment">/* 返回分配的区域 */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>如果不在 arena 的范围内：<ul>
<li>则调用 allocate_new_chunk 分配一个新的 chunk，返回给用户</li>
</ul>
</li>
<li>如果在 arena 的范围内，并且在 small/medium 的范围内：<ul>
<li>调用 get_bin_for_size 获取对应大小的 bin</li>
<li>如果对应的 bin 存在且未满：<ul>
<li>直接从 bin 中摘下一个 run</li>
</ul>
</li>
<li>如果对应的 bin 不存在或者已满：<ul>
<li>调用 lookup_or_allocate_nonfull_run 申请一个 run，并接在 bin 的后面</li>
</ul>
</li>
<li>调用 get_first_set_bit 从 bin 中获取 bit（每个位对应一个区域，0 表示该区域已使用，1 位值表示相应区域空闲）</li>
<li>最后调用 get_region 从 bin 中获取一个 run</li>
</ul>
</li>
<li>否则调用 allocate_new_run 分配一个新的 run，返回给用户</li>
</ul>
<p><strong>释放流程</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">FREE(addr):</span><br><span class="line">    IF addr IS NOT EQUAL TO THE CHUNK IT BELONGS: <span class="comment">/* 如果addr不属于chunk */</span></span><br><span class="line">        IF addr IS A SMALL ALLOCATION: <span class="comment">/* 如果addr的大小范围为small */</span></span><br><span class="line">            run = get_run_addr_belongs_to(addr);</span><br><span class="line">            bin = run-&gt;bin;</span><br><span class="line">            size = bin-&gt;reg_size;</span><br><span class="line">            element = get_element_index(addr, run, bin)</span><br><span class="line">            unset_bit(run-&gt;regs_mask[element])</span><br><span class="line"></span><br><span class="line">        ELSE: <span class="comment">/* 如果addr的大小范围为large(以page为单位) */</span></span><br><span class="line">            run = get_run_addr_belongs_to(addr)</span><br><span class="line">            chunk = get_chunk_run_belongs_to(run)</span><br><span class="line">            run_index = get_run_index(run, chunk)</span><br><span class="line">            mark_pages_of_run_as_free(run_index)</span><br><span class="line"></span><br><span class="line">            IF ALL THE PAGES OF chunk ARE MARKED AS FREE: <span class="comment">/* 如果chunk的所有page都标记为空闲 */</span></span><br><span class="line">                unmap_the_chunk_s_pages(chunk)</span><br><span class="line"></span><br><span class="line">    ELSE: <span class="comment">/* 如果addr的大小范围为huge(通过mmap进行分配的) */</span></span><br><span class="line">        unmap_the_huge_allocation_s_pages(addr)</span><br></pre></td></tr></table></figure>
<ul>
<li>根据 addr 对应的 size 大小来选择释放的方法：<ul>
<li>huge：<ul>
<li>采用 unmap_the_huge_allocation_s_pages 进行释放</li>
</ul>
</li>
<li>small：<ul>
<li>调用 get_run_addr_belongs_to 获取该 addr 对应的 run</li>
<li>通过 run 获取对应的 bin</li>
<li>通过 bin 获取对应的 reg_size</li>
<li>调用 get_element_index 获取 region（大小为 byte）在 run 中的偏移</li>
<li>调用 unset_bit 进行释放</li>
</ul>
</li>
<li>large：<ul>
<li>调用 get_run_addr_belongs_to 获取该 addr 对应的 run</li>
<li>调用 get_chunk_run_belongs_to 获取该 addr 对应的 chunk</li>
<li>调用 get_run_index 获取 region（大小为 page）在 chunk 中的偏移</li>
<li>调用 mark_pages_of_run_as_free 进行释放</li>
<li>如果 chunk 的所有 page 都标记为 free（空闲）：<ul>
<li>调用 unmap_the_chunk_s_pages 释放该 chunk</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>分配 region</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* jemalloc-2.2.5/src/arena.c */</span></span><br><span class="line">ret = (<span class="keyword">void</span> *)((<span class="keyword">uintptr_t</span>)run + (<span class="keyword">uintptr_t</span>)bin_info-&gt;reg0_offset +</span><br><span class="line">    (<span class="keyword">uintptr_t</span>)(bin_info-&gt;reg_size * regind));</span><br></pre></td></tr></table></figure>
<ul>
<li>region 的值可以理解为“3”部分相加：<ul>
<li>run：对应 run 的基地址</li>
<li>bin_info-&gt;reg0_offset：此 bin 对应的 run 中第一个 region 的偏移量</li>
<li>bin_info-&gt;reg_size * regind：目标 region 在 run 中的偏移量</li>
</ul>
</li>
<li>可以说，ptmalloc 就是通过偏移 regind 来获取 region 的位置的</li>
</ul>
<p>在 jemalloc-2.2.5 分配 region 前，会在目标 run 的范围的头部申请一个 arena_run_t 结构体来管理 run（但 jemalloc-5.0.1 是不会分配 arena_run_t 的）</p>
<ul>
<li>因为 run 以 page 为单位，所以 arena_run_t 的地址后3位为“0”</li>
<li>由此可以快速判断 arena_run_t 的位置</li>
</ul>
<p><strong>分配 run</strong></p>
<p>run 以 page 为单位，如果 size 比较小，run 的大小范围往往就是一页</p>
<ul>
<li>默认64位系统的划分方式：<ul>
<li><strong>Small：</strong>[8]，[16,32,48,…,128]（16字节等分），[128,192,256,320, …,512]（64字节等分），[512,768,1024,1280,…,3840]（256字节等分）</li>
</ul>
</li>
<li>通过以下案例，来看看不同 run 的地址范围：（jemalloc-5.0.1）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;jemalloc/jemalloc.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *foo[<span class="number">20</span>];</span><br><span class="line">    <span class="keyword">char</span> *bar[<span class="number">20</span>];</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;foo &gt;&gt; %p\n&quot;</span>,foo);</span><br><span class="line"></span><br><span class="line">    foo[<span class="number">0</span>] = <span class="built_in">malloc</span>(<span class="number">8</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;foo[%d]:  size:%d \t%p\n&quot;</span>,<span class="number">0</span>,<span class="number">8</span>,(<span class="keyword">unsigned</span> <span class="keyword">int</span>)foo[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">1</span>;i&lt;=<span class="number">8</span>;i++)&#123;</span><br><span class="line">        foo[i] = <span class="built_in">malloc</span>(<span class="number">16</span>*i);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;&gt;&gt; foo[%d]-foo[%d]=%d\n&quot;</span>,i,i<span class="number">-1</span>,(foo[i]-foo[i<span class="number">-1</span>])/<span class="number">4096</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;foo[%d]:  size:%d\t%p\n&quot;</span>,i,<span class="number">16</span>*i,(<span class="keyword">unsigned</span> <span class="keyword">int</span>)foo[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">9</span>;i&lt;=<span class="number">14</span>;i++)&#123;</span><br><span class="line">        foo[i] = <span class="built_in">malloc</span>(<span class="number">128</span>+<span class="number">64</span>*(i<span class="number">-8</span>));</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;&gt;&gt; foo[%d]-foo[%d]=%d\n&quot;</span>,i,i<span class="number">-1</span>,(foo[i]-foo[i<span class="number">-1</span>])/<span class="number">4096</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;foo[%d]:  size:%d\t%p\n&quot;</span>,i,<span class="number">128</span>+<span class="number">64</span>*(i<span class="number">-8</span>),(<span class="keyword">unsigned</span> <span class="keyword">int</span>)foo[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>结果：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="built_in">exp</span> ./jemalloc                                  </span><br><span class="line">foo &gt;&gt; <span class="number">0x7ffe3a4b1330</span></span><br><span class="line">foo[<span class="number">0</span>]:  size:<span class="number">8</span> 	<span class="number">0x91c2d008</span></span><br><span class="line">&gt;&gt; foo[<span class="number">1</span>]-foo[<span class="number">0</span>]=<span class="number">25</span></span><br><span class="line">foo[<span class="number">1</span>]:  size:<span class="number">16</span>	<span class="number">0x91c47000</span></span><br><span class="line">&gt;&gt; foo[<span class="number">2</span>]-foo[<span class="number">1</span>]=<span class="number">-24</span> <span class="comment">// 反常</span></span><br><span class="line">foo[<span class="number">2</span>]:  size:<span class="number">32</span>	<span class="number">0x91c2e020</span></span><br><span class="line">&gt;&gt; foo[<span class="number">3</span>]-foo[<span class="number">2</span>]=<span class="number">25</span></span><br><span class="line">foo[<span class="number">3</span>]:  size:<span class="number">48</span>	<span class="number">0x91c48000</span></span><br><span class="line">&gt;&gt; foo[<span class="number">4</span>]-foo[<span class="number">3</span>]=<span class="number">3</span></span><br><span class="line">foo[<span class="number">4</span>]:  size:<span class="number">64</span>	<span class="number">0x91c4b000</span></span><br><span class="line">&gt;&gt; foo[<span class="number">5</span>]-foo[<span class="number">4</span>]=<span class="number">1</span></span><br><span class="line">foo[<span class="number">5</span>]:  size:<span class="number">80</span>	<span class="number">0x91c4c000</span></span><br><span class="line">&gt;&gt; foo[<span class="number">6</span>]-foo[<span class="number">5</span>]=<span class="number">5</span></span><br><span class="line">foo[<span class="number">6</span>]:  size:<span class="number">96</span>	<span class="number">0x91c51000</span></span><br><span class="line">&gt;&gt; foo[<span class="number">7</span>]-foo[<span class="number">6</span>]=<span class="number">3</span></span><br><span class="line">foo[<span class="number">7</span>]:  size:<span class="number">112</span>	<span class="number">0x91c54000</span></span><br><span class="line">&gt;&gt; foo[<span class="number">8</span>]-foo[<span class="number">7</span>]=<span class="number">7</span></span><br><span class="line">foo[<span class="number">8</span>]:  size:<span class="number">128</span>	<span class="number">0x91c5b000</span></span><br><span class="line">&gt;&gt; foo[<span class="number">9</span>]-foo[<span class="number">8</span>]=<span class="number">1</span></span><br><span class="line">foo[<span class="number">9</span>]:  size:<span class="number">192</span>	<span class="number">0x91c5c000</span></span><br><span class="line">&gt;&gt; foo[<span class="number">10</span>]-foo[<span class="number">9</span>]=<span class="number">3</span></span><br><span class="line">foo[<span class="number">10</span>]:  size:<span class="number">256</span>	<span class="number">0x91c5f000</span></span><br><span class="line">&gt;&gt; foo[<span class="number">11</span>]-foo[<span class="number">10</span>]=<span class="number">1</span></span><br><span class="line">foo[<span class="number">11</span>]:  size:<span class="number">320</span>	<span class="number">0x91c60000</span></span><br><span class="line">&gt;&gt; foo[<span class="number">12</span>]-foo[<span class="number">11</span>]=<span class="number">5</span></span><br><span class="line">foo[<span class="number">12</span>]:  size:<span class="number">384</span>	<span class="number">0x91c65000</span></span><br><span class="line">&gt;&gt; foo[<span class="number">13</span>]-foo[<span class="number">12</span>]=<span class="number">3</span></span><br><span class="line">foo[<span class="number">13</span>]:  size:<span class="number">448</span>	<span class="number">0x91c68000</span></span><br><span class="line">&gt;&gt; foo[<span class="number">14</span>]-foo[<span class="number">13</span>]=<span class="number">7</span></span><br><span class="line">foo[<span class="number">14</span>]:  size:<span class="number">512</span>	<span class="number">0x91c6f000</span></span><br></pre></td></tr></table></figure>
<ul>
<li>不管重复多少次后5位始终不变，说明 jemalloc 的分配以 100page 为单位</li>
<li>地址的分配似乎没有什么规律，可能是 jemalloc 的保护机制吧</li>
</ul>
<h2 id="Jemalloc-GDB"><a href="#Jemalloc-GDB" class="headerlink" title="Jemalloc GDB"></a>Jemalloc GDB</h2><p>GDB 可以用来打印 jemalloc 里面的符号（各种全局变量和结构体），前提如下：</p>
<ul>
<li>在GCC编译时加上 “-ljemalloc” </li>
<li>用 directory 导入对应版本的 jemalloc 源码文件</li>
</ul>
<p>arena 是 jemalloc 的总的管理块，一个进程中可以有多个 arena，arena 的最大个可以通过静态变量 narenas_total 得知，可以在 GDB 中进行打印：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p narenas_total </span><br><span class="line">$<span class="number">1</span> = &#123;</span><br><span class="line">  repr = <span class="number">8</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可通过静态数组 arenas 获取进程中所有 arena 的指针： </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p *je_arenas@<span class="number">2</span> <span class="comment">/* 添加@n可以使GDB一次显示n个数据块 */</span></span><br><span class="line">$<span class="number">6</span> = &#123;&#123;</span><br><span class="line">    repr = <span class="number">0x7ffff757e980</span></span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    repr = <span class="number">0x0</span></span><br><span class="line">  &#125;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p (<span class="keyword">arena_t</span> **)je_arenas</span><br><span class="line">$<span class="number">7</span> = (<span class="keyword">arena_t</span> **) <span class="number">0x7ffff7da2a80</span> &lt;je_arenas&gt;</span><br><span class="line">    </span><br><span class="line">pwndbg&gt; telescope <span class="number">0x7ffff7da2a80</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffff7da2a80</span> (je_arenas) —▸ <span class="number">0x7ffff757e980</span> ◂— <span class="number">0x100000001</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffff7da2a88</span> (je_arenas+<span class="number">8</span>) ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">6</span> skipped</span><br></pre></td></tr></table></figure>
<ul>
<li>在结构体 arena_t 中有个类型为 arena_bin_t 的数组 bins（动态分配数组 bins 的大小），数组 bins 的每个条目对应1种大小的 region 和 run </li>
<li>binind 表示 bins 中的偏移，每一个 binind 对应一个固定大小的 region，其对应关系为：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">binind = arena_bin_index(chunk-&gt;arena, run-&gt;bin);</span><br><span class="line">bin_info = &amp;arena_bin_info[binind];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">szind_t</span></span></span><br><span class="line"><span class="function">    <span class="title">arena_bin_index</span><span class="params">(<span class="keyword">arena_t</span> *arena, <span class="keyword">arena_bin_t</span> *bin)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">szind_t</span> binind = (<span class="keyword">szind_t</span>)(bin - arena-&gt;bins);</span><br><span class="line">    assert(binind &lt; NBINS);</span><br><span class="line">    <span class="keyword">return</span> binind;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 GDB 中，我们可以通过静态变量 arena_bin_info 获取对应 bin 的其他信息：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p je_arena_bin_info</span><br><span class="line">$<span class="number">11</span> = &#123;&#123;</span><br><span class="line">    reg_size = <span class="number">8</span>,</span><br><span class="line">    slab_size = <span class="number">4096</span>,</span><br><span class="line">    nregs = <span class="number">512</span>,</span><br><span class="line">    bitmap_info = &#123;</span><br><span class="line">      nbits = <span class="number">512</span>,</span><br><span class="line">      ngroups = <span class="number">8</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    reg_size = <span class="number">16</span>,</span><br><span class="line">    slab_size = <span class="number">4096</span>,</span><br><span class="line">    nregs = <span class="number">256</span>,</span><br><span class="line">    bitmap_info = &#123;</span><br><span class="line">      nbits = <span class="number">256</span>,</span><br><span class="line">      ngroups = <span class="number">4</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    reg_size = <span class="number">32</span>,</span><br><span class="line">    slab_size = <span class="number">4096</span>,</span><br><span class="line">    nregs = <span class="number">128</span>,</span><br><span class="line">    bitmap_info = &#123;</span><br><span class="line">      nbits = <span class="number">128</span>,</span><br><span class="line">      ngroups = <span class="number">2</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    reg_size = <span class="number">48</span>,</span><br><span class="line">    slab_size = <span class="number">12288</span>,</span><br><span class="line">    nregs = <span class="number">256</span>,</span><br><span class="line">    bitmap_info = &#123;</span><br><span class="line">      nbits = <span class="number">256</span>,</span><br><span class="line">      ngroups = <span class="number">4</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">        </span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    reg_size = <span class="number">12288</span>,</span><br><span class="line">    slab_size = <span class="number">12288</span>,</span><br><span class="line">    nregs = <span class="number">1</span>,</span><br><span class="line">    bitmap_info = &#123;</span><br><span class="line">      nbits = <span class="number">1</span>,</span><br><span class="line">      ngroups = <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    reg_size = <span class="number">14336</span>,</span><br><span class="line">    slab_size = <span class="number">28672</span>,</span><br><span class="line">    nregs = <span class="number">2</span>,</span><br><span class="line">    bitmap_info = &#123;</span><br><span class="line">      nbits = <span class="number">2</span>,</span><br><span class="line">      ngroups = <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;&#125;</span><br></pre></td></tr></table></figure>
<p>可以通过指定 index 来获取对应 size 范围的 arena_bin_info：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p je_arena_bin_info[<span class="number">2</span>]</span><br><span class="line">$<span class="number">12</span> = &#123;</span><br><span class="line">  reg_size = <span class="number">32</span>,</span><br><span class="line">  slab_size = <span class="number">4096</span>,</span><br><span class="line">  nregs = <span class="number">128</span>,</span><br><span class="line">  bitmap_info = &#123;</span><br><span class="line">    nbits = <span class="number">128</span>,</span><br><span class="line">    ngroups = <span class="number">2</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">pwndbg&gt; p je_arena_bin_info[<span class="number">3</span>]</span><br><span class="line">$<span class="number">13</span> = &#123;</span><br><span class="line">  reg_size = <span class="number">48</span>,</span><br><span class="line">  slab_size = <span class="number">12288</span>,</span><br><span class="line">  nregs = <span class="number">256</span>,</span><br><span class="line">  bitmap_info = &#123;</span><br><span class="line">    nbits = <span class="number">256</span>,</span><br><span class="line">    ngroups = <span class="number">4</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在结构体 arena_bin_t 中有个类型为 arena_run_t 的指针 runcur，指向当前可用于分配的 run </li>
<li>runs 是个红黑树，链接当前 arena 中，所有可用的相同大小 region 对应的 run，如果 runcur 已满，就会从 runs 里找可用的 run</li>
<li>stats 是当前 bin 对应的 run 和 region 的状态信息</li>
</ul>
<h2 id="Adjacent-region-corruption（相邻区域冲突）"><a href="#Adjacent-region-corruption（相邻区域冲突）" class="headerlink" title="Adjacent region corruption（相邻区域冲突）"></a>Adjacent region corruption（相邻区域冲突）</h2><p>Adjacent region corruption 的核心思想为：利用了堆管理器将用户空间相邻放置的事实，在 jemalloc 中，相同大小类别的区域被放置在同一个 bin 上，如果它们也被放置在 bin 的同一 run 中，则它们之间没有 inline metadata</p>
<p>现在，让我们假设相同大小类新分配的 region 被放置在同一次 run 中：</p>
<ul>
<li>我可以放置一个 victim object/structure 到某个 object/structure 旁边</li>
<li>我们选择的 object/structure 必须是：在同一个 run 中，相邻的，大小相同的，易受伤害的</li>
<li>唯一的要求是：“受害对象” 和 “易受攻击对象” 的大小必须能够放入它们，并且有相同的 size class，方便我们继续溢出</li>
<li>通常受害区域是可以帮助我们实现任意代码执行的东西，例如函数指针</li>
</ul>
<p><strong>利用案例一：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jemalloc/jemalloc.h&gt;</span></span></span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> *one, *two, *three;</span><br><span class="line">	<span class="keyword">char</span> padding[<span class="number">30</span>];</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[*] before overflowing\n&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">memset</span>(padding, <span class="number">0x58</span>, <span class="number">30</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;padding:\t\t%s\n&quot;</span>,padding);	</span><br><span class="line"></span><br><span class="line">	one = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">	<span class="built_in">memset</span>(one, <span class="number">0x41</span>, <span class="number">0x10</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[+] region one:\t\t0x%x: %s\n&quot;</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)one, one);</span><br><span class="line"></span><br><span class="line">	two = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">	<span class="built_in">memset</span>(two, <span class="number">0x42</span>, <span class="number">0x10</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[+] region two:\t\t0x%x: %s\n&quot;</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)two, two);</span><br><span class="line"></span><br><span class="line">	three = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">	<span class="built_in">memset</span>(three, <span class="number">0x43</span>, <span class="number">0x10</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[+] region three:\t0x%x: %s\n&quot;</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)three, three);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* [3-1] */</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[+] copying padding to region two\n&quot;</span>);</span><br><span class="line">	<span class="built_in">strcpy</span>(two, padding);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[*] after overflowing\n&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[+] region one:\t\t0x%x: %s\n&quot;</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)one, one);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[+] region two:\t\t0x%x: %s\n&quot;</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)two, two);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[+] region three:\t0x%x: %s\n&quot;</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)three, three);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* [3-2] */</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">free</span>(one);</span><br><span class="line">	<span class="built_in">free</span>(two);</span><br><span class="line">	<span class="built_in">free</span>(three);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[*] after freeing all regions\n&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[+] region one:\t\t0x%x: %s\n&quot;</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)one, one);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[+] region two:\t\t0x%x: %s\n&quot;</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)two, two);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[+] region three:\t0x%x: %s\n&quot;</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)three, three);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/* [3-3] */</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>申请了三片区域：“one”，“two”，“three”</li>
<li>在区域 “two” 中制造溢出</li>
<li>释放这三片区域</li>
</ul>
<p>执行结果：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="built_in">exp</span> gcc test.c -o jemalloc -ljemalloc -g -no-pie</span><br><span class="line">➜  <span class="built_in">exp</span> ./jemalloc                                  </span><br><span class="line">[*] before overflowing</span><br><span class="line">[+] padding:		XXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span><br><span class="line">[+] region one:		<span class="number">0x115a7000</span>: AAAAAAAAAAAAAAAA</span><br><span class="line">[+] region two:		<span class="number">0x115a7010</span>: BBBBBBBBBBBBBBBB</span><br><span class="line">[+] region three:	<span class="number">0x115a7020</span>: CCCCCCCCCCCCCCCC</span><br><span class="line">[+] copying padding to region two</span><br><span class="line">[*] after overflowing</span><br><span class="line">[+] region one:		<span class="number">0x115a7000</span>: AAAAAAAAAAAAAAAAXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span><br><span class="line">[+] region two:		<span class="number">0x115a7010</span>: XXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span><br><span class="line">[+] region three:	<span class="number">0x115a7020</span>: XXXXXXXXXXXXXX</span><br><span class="line">[*] after freeing all regions</span><br><span class="line">[+] region one:		<span class="number">0x115a7000</span>: AAAAAAAAAAAAAAAAXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span><br><span class="line">[+] region two:		<span class="number">0x115a7010</span>: XXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span><br><span class="line">[+] region three:	<span class="number">0x115a7020</span>: XXXXXXXXXXXXXX</span><br></pre></td></tr></table></figure>
<ul>
<li>关键点1：“one”，“two”，“three” 的数据地址刚好相差 0x10，说明数据连续</li>
<li>关键点2：“two” 中溢出了30字节的“0x58”后，printf 的 “打印边界” 似乎出问题了</li>
<li>关键点3：释放之后，“one”，“two”，“three” 的数据没有置空（UAF预备）</li>
</ul>
<p>接下来就进行单步调试，分析一下以上这些疑点：</p>
<p>断点在 [3-1] 处：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>wx <span class="number">0x7ffff73a0000</span></span><br><span class="line"><span class="number">0x7ffff73a0000</span>:	<span class="number">0x41414141</span>	<span class="number">0x41414141</span>	<span class="number">0x41414141</span>	<span class="number">0x41414141</span></span><br><span class="line"><span class="number">0x7ffff73a0010</span>:	<span class="number">0x42424242</span>	<span class="number">0x42424242</span>	<span class="number">0x42424242</span>	<span class="number">0x42424242</span></span><br><span class="line"><span class="number">0x7ffff73a0020</span>:	<span class="number">0x43434343</span>	<span class="number">0x43434343</span>	<span class="number">0x43434343</span>	<span class="number">0x43434343</span></span><br></pre></td></tr></table></figure>
<ul>
<li>可以发现，“one”，“two”，“three” 的数据真的是连续的</li>
</ul>
<p>断点在 [3-2] 处：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>wx <span class="number">0x7ffff73a0000</span></span><br><span class="line"><span class="number">0x7ffff73a0000</span>:	<span class="number">0x41414141</span>	<span class="number">0x41414141</span>	<span class="number">0x41414141</span>	<span class="number">0x41414141</span></span><br><span class="line"><span class="number">0x7ffff73a0010</span>:	<span class="number">0x58585858</span>	<span class="number">0x58585858</span>	<span class="number">0x58585858</span>	<span class="number">0x58585858</span></span><br><span class="line"><span class="number">0x7ffff73a0020</span>:	<span class="number">0x58585858</span>	<span class="number">0x58585858</span>	<span class="number">0x58585858</span>	<span class="number">0x43005858</span></span><br></pre></td></tr></table></figure>
<ul>
<li>padding 的30个“0x58”完全覆盖了 “two”，并且在 “three” 上持续了15字节（包括最后的“\x00”）</li>
<li>这似乎扰乱了 printf 的打印（不知道是 printf 本身的性质，还是 Regions 的问题），从结果来看，一旦溢出现象发生后，printf 就会分不清楚 Regions 之间的界限，然后用“\x00”来区分 Regions 的范围</li>
<li>利用这个特性，可以溢出一些重要数据</li>
</ul>
<p>断点在 [3-3] 处：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>wx <span class="number">0x7ffff73a0000</span></span><br><span class="line"><span class="number">0x7ffff73a0000</span>:	<span class="number">0x41414141</span>	<span class="number">0x41414141</span>	<span class="number">0x41414141</span>	<span class="number">0x41414141</span></span><br><span class="line"><span class="number">0x7ffff73a0010</span>:	<span class="number">0x58585858</span>	<span class="number">0x58585858</span>	<span class="number">0x58585858</span>	<span class="number">0x58585858</span></span><br><span class="line"><span class="number">0x7ffff73a0020</span>:	<span class="number">0x58585858</span>	<span class="number">0x58585858</span>	<span class="number">0x58585858</span>	<span class="number">0x43005858</span></span><br></pre></td></tr></table></figure>
<ul>
<li>free 执行完成后，heap 上的数据没有收到任何的影响</li>
</ul>
<p><strong>利用案例二：</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jemalloc/jemalloc.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">base</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">        <span class="keyword">char</span> buf[<span class="number">32</span>];</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">copy</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *str)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="built_in">strcpy</span>(buf, str);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;buf: 0x%lx: %s\n&quot;</span>, (<span class="keyword">char</span>*)buf, buf);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">derived_a</span> :</span> <span class="keyword">public</span> base</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[+] derived_a: &quot;</span>);</span><br><span class="line">            base::<span class="built_in">print</span>();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">derived_b</span> :</span> <span class="keyword">public</span> base</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[+] derived_b: &quot;</span>);</span><br><span class="line">            base::<span class="built_in">print</span>();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">uintptr_t</span>  argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    base *obj_a;</span><br><span class="line">    base *obj_b;</span><br><span class="line">    <span class="keyword">char</span> padding1[<span class="number">49</span>];</span><br><span class="line">    <span class="keyword">char</span> padding2[<span class="number">11</span>];</span><br><span class="line"></span><br><span class="line">    obj_a = <span class="keyword">new</span> derived_a;</span><br><span class="line">    obj_b = <span class="keyword">new</span> derived_b;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(padding1, <span class="number">0x41</span>, <span class="number">48</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;padding1:\t%s\n&quot;</span>,padding1);	</span><br><span class="line">    <span class="built_in">memset</span>(padding2, <span class="number">0x42</span>, <span class="number">10</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;padding2:\t%s\n&quot;</span>,padding2);	</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] obj_a:\t0x%lx\n&quot;</span>, (<span class="keyword">uintptr_t</span> )obj_a);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] obj_b:\t0x%lx\n&quot;</span>, (<span class="keyword">uintptr_t</span> )obj_b);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] overflowing from obj_a into obj_b\n&quot;</span>);</span><br><span class="line">    obj_a-&gt;<span class="built_in">copy</span>(padding1);</span><br><span class="line">    obj_b-&gt;<span class="built_in">copy</span>(padding2);</span><br><span class="line"></span><br><span class="line">    obj_a-&gt;<span class="built_in">print</span>();</span><br><span class="line">    obj_b-&gt;<span class="built_in">print</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>定义了 base 类：<ul>
<li>函数 copy：用于在 buf 中制造溢出</li>
<li>虚函数 print：用于打印 buf</li>
</ul>
</li>
<li>定义了 derived_a，derived_b 类继承 base 类：<ul>
<li>重写虚函数 print </li>
</ul>
</li>
</ul>
<p>执行结果：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="built_in">exp</span> gcc test.c -o jemalloc -ljemalloc -g -no-pie</span><br><span class="line">➜  <span class="built_in">exp</span> ./jemalloc                                    </span><br><span class="line">padding1:	AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span><br><span class="line">padding2:	BBBBBBBBBB</span><br><span class="line">[+] obj_a:	<span class="number">0x7f4b750ae000</span></span><br><span class="line">[+] obj_b:	<span class="number">0x7f4b750ae030</span></span><br><span class="line">[+] overflowing from obj_a into obj_b</span><br><span class="line">[+] derived_a: buf: <span class="number">0x7f4b750ae008</span>: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBBBBBBBB</span><br><span class="line">[<span class="number">1</span>]    <span class="number">7331</span> segmentation fault  ./jemalloc</span><br></pre></td></tr></table></figure>
<ul>
<li>derived_b 的 print 一执行就直接报错了，很有可能是虚表的问题</li>
</ul>
<p>接下来就进行单步调试：</p>
<p>断点一，“new derived_a” 执行前：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">0x4011eb</span> &lt;main+<span class="number">21</span>&gt;    mov    rax, qword ptr fs:[<span class="number">0x28</span>]</span><br><span class="line">  <span class="number">0x4011f4</span> &lt;main+<span class="number">30</span>&gt;    mov    qword ptr [rbp - <span class="number">0x18</span>], rax</span><br><span class="line">  <span class="number">0x4011f8</span> &lt;main+<span class="number">34</span>&gt;    <span class="keyword">xor</span>    eax, eax</span><br><span class="line">  <span class="number">0x4011fa</span> &lt;main+<span class="number">36</span>&gt;    mov    edi, <span class="number">0x28</span></span><br><span class="line">► <span class="number">0x4011ff</span> &lt;main+<span class="number">41</span>&gt;    call   <span class="number">0x4010a0</span>                      &lt;<span class="number">0x4010a0</span>&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>这个 “0x4010a0” 就是 new 的 PLT 表地址</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg  <span class="number">0x4010a0</span></span><br><span class="line"><span class="number">0x4010a0</span> &lt;<span class="function"><span class="keyword">operator</span> <span class="title">new</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span>)</span>@plt&gt;:	0x7525fff2fa1e0ff3	0x0000441f0f00002f</span></span><br><span class="line"><span class="function">0x4010b0 &lt;<span class="built_in">memset</span>@plt&gt;:	0x6d25fff2fa1e0ff3	0x0000441f0f00002f</span></span><br><span class="line"><span class="function">0x4010c0 &lt;<span class="built_in">strcpy</span>@plt&gt;:	0x6525fff2fa1e0ff3	0x0000441f0f00002f</span></span><br></pre></td></tr></table></figure>
<ul>
<li>调用 “0x4010a0” 前，需要把 “它将要创建的对象的大小” 作为参数，即 0x28 字节（buf[32]+VPTR）</li>
<li>可以发现：buf[32] 和 VPTR 是连续的，完全可以把 buf 中的数据溢出到 VPTR 中</li>
</ul>
<p>断点二，“obj_a-&gt;copy(padding1)” 执行前：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">0x4012c4</span> &lt;main+<span class="number">238</span>&gt;    lea    rdx, [rbp - <span class="number">0x50</span>]</span><br><span class="line">  <span class="number">0x4012c8</span> &lt;main+<span class="number">242</span>&gt;    mov    rax, qword ptr [rbp - <span class="number">0x70</span>]</span><br><span class="line">  <span class="number">0x4012cc</span> &lt;main+<span class="number">246</span>&gt;    mov    rsi, rdx</span><br><span class="line">  <span class="number">0x4012cf</span> &lt;main+<span class="number">249</span>&gt;    mov    rdi, rax</span><br><span class="line">► <span class="number">0x4012d2</span> &lt;main+<span class="number">252</span>&gt;    call   <span class="number">0x401330</span>                      &lt;<span class="number">0x401330</span>&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>这个 “0x401330” 就是 base::copy() 的代码地址</li>
<li>下面是 heap 的空间排列：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">02</span>:<span class="number">0010</span>│     <span class="number">0x7fffffffde20</span> —▸ <span class="number">0x7ffff739d000</span> —▸ <span class="number">0x403da0</span> —▸ <span class="number">0x401396</span> (derived_a::print()) ◂— endbr64 </span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│     <span class="number">0x7fffffffde28</span> —▸ <span class="number">0x7ffff739d030</span> —▸ <span class="number">0x403d88</span> —▸ <span class="number">0x4013c6</span> (derived_b::print()) ◂— endbr64 </span><br></pre></td></tr></table></figure>
<ul>
<li>“0x7ffff739d000” 就是 new 为 derived_a 申请的 heap 空间：<ul>
<li>大小为 0x30（0x28：0x10字节对齐）</li>
<li>“0x403da0” 就是 derived_a 的虚表（只装有 “derived_a::print()”，以“\x00”结尾）</li>
<li>剩下的都是 buf 的空间</li>
</ul>
</li>
<li>“0x7ffff739d030” 就是 new 为 derived_b 申请的 heap 空间：<ul>
<li>大小为 0x30（0x28：0x10字节对齐）</li>
<li>“0x403d88” 就是 derived_b 的虚表（只装有 “derived_b::print()”，以“\x00”结尾）</li>
<li>剩下的都是 buf 的空间</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffff739d000</span> <span class="comment">/* derived_a on heap */</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│     <span class="number">0x7ffff739d000</span> —▸ <span class="number">0x403da0</span> —▸ <span class="number">0x401396</span> (derived_a::print()) ◂— endbr64 </span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│     <span class="number">0x7ffff739d008</span> ◂— <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line">pwndbg&gt; telescope <span class="number">0x7ffff739d030</span> <span class="comment">/* derived_b on heap */</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rbx <span class="number">0x7ffff739d030</span> —▸ <span class="number">0x403d88</span> —▸ <span class="number">0x4013c6</span> (derived_b::print()) ◂— endbr64 </span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│     <span class="number">0x7ffff739d038</span> ◂— <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line">pwndbg&gt; telescope <span class="number">0x403da0</span> <span class="comment">/* vtable of derived_a */</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x403da0</span> —▸ <span class="number">0x401396</span> (derived_a::print()) ◂— endbr64 </span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x403da8</span> ◂— <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line">pwndbg&gt; telescope <span class="number">0x403d88</span> <span class="comment">/* vtable of derived_b */</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x403d88</span> —▸ <span class="number">0x4013c6</span> (derived_b::print()) ◂— endbr64 </span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x403d90</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>断点三，“obj_a-&gt;print()” 执行前：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">RDX  <span class="number">0x401396</span> (derived_a::print()) ◂— endbr64 </span><br><span class="line">    ....</span><br><span class="line">  <span class="number">0x4012f8</span> &lt;main+<span class="number">290</span>&gt;    mov    rdi, rax</span><br><span class="line">► <span class="number">0x4012fb</span> &lt;main+<span class="number">293</span>&gt;    call   rdx                           &lt;derived_a::print()&gt;</span><br><span class="line">       rdi: <span class="number">0x7ffff739d000</span> —▸ <span class="number">0x403da0</span> —▸ <span class="number">0x401396</span> (derived_a::print()) ◂— endbr64 </span><br></pre></td></tr></table></figure>
<ul>
<li>rdx 装有 “0x401396”，就是 derived_a::print() 的代码地址</li>
<li>下面是 heap 的空间排列：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffff739d000</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rax rdi <span class="number">0x7ffff739d000</span> —▸ <span class="number">0x403da0</span> —▸ <span class="number">0x401396</span> (derived_a::print()) ◂— endbr64 </span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│         <span class="number">0x7ffff739d008</span> ◂— <span class="string">&#x27;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBBBBBBBB&#x27;</span></span><br><span class="line">... ↓            <span class="number">5</span> skipped</span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│         <span class="number">0x7ffff739d038</span> ◂— <span class="string">&#x27;BBBBBBBBBB&#x27;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>可以发现 derived_a-&gt;buf 中溢出的数据，已经把 derived_b-&gt;VPTR 覆盖了</li>
<li>执行 derived_a::print() 时没有问题，执行 derived_b::print() 时肯定就会报错</li>
<li>如果 VPTR 被我们控制为 shellcode，就可以 get shell</li>
</ul>
<h2 id="Heap-manipulation（堆风水）"><a href="#Heap-manipulation（堆风水）" class="headerlink" title="Heap manipulation（堆风水）"></a>Heap manipulation（堆风水）</h2><p>为了能够将 jemalloc 堆安排在可预测的状态，我们需要了解分配器的行为并使用堆操作策略来影响它，使其对我们有利，堆操作策略在 Alexander Sotirov 的推广之后被称为“堆风水”</p>
<p>先看以下代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TSIZE   0x10            <span class="comment">/* target size class */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NALLOC  500             <span class="comment">/* number of allocations */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NFREE   (NALLOC / 10)   <span class="comment">/* number of deallocations */</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *foo[NALLOC];</span><br><span class="line">    <span class="keyword">char</span> *bar[NALLOC];</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;step 1: controlled allocations of victim objects\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; NALLOC; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        foo[i] = <span class="built_in">malloc</span>(TSIZE);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;foo[%d]:\t\t%p\n&quot;</span>, i, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)foo[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;-------------------------------------------------&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;step 2: creating holes in between the victim objects\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i = (NALLOC - NFREE); i &lt; NALLOC; i += <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;freeing foo[%d]:\t%p\n&quot;</span>, i, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)foo[i]);</span><br><span class="line">        <span class="built_in">free</span>(foo[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;-------------------------------------------------&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;step 3: fill holes with vulnerable objects\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i = (NALLOC - NFREE + <span class="number">1</span>); i &lt; NALLOC; i += <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        bar[i] = <span class="built_in">malloc</span>(TSIZE);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;bar[%d]:\t%p\n&quot;</span>, i, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)bar[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;-------------------------------------------------&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="built_in">exp</span> gcc test.c -o jemalloc -ljemalloc -g -no-pie</span><br><span class="line">➜  <span class="built_in">exp</span> ./jemalloc</span><br><span class="line">step <span class="number">1</span>: controlled allocations of victim objects</span><br><span class="line">foo[<span class="number">0</span>]:		<span class="number">0xa2ae000</span></span><br><span class="line">foo[<span class="number">1</span>]:		<span class="number">0xa2ae010</span></span><br><span class="line">foo[<span class="number">2</span>]:		<span class="number">0xa2ae020</span></span><br><span class="line">foo[<span class="number">3</span>]:		<span class="number">0xa2ae030</span></span><br><span class="line">foo[<span class="number">4</span>]:		<span class="number">0xa2ae040</span></span><br><span class="line">foo[<span class="number">5</span>]:		<span class="number">0xa2ae050</span></span><br><span class="line">foo[<span class="number">6</span>]:		<span class="number">0xa2ae060</span></span><br><span class="line">foo[<span class="number">7</span>]:		<span class="number">0xa2ae070</span></span><br><span class="line">foo[<span class="number">8</span>]:		<span class="number">0xa2ae080</span></span><br><span class="line">foo[<span class="number">9</span>]:		<span class="number">0xa2ae090</span></span><br><span class="line">foo[<span class="number">10</span>]:		<span class="number">0xa2ae0a0</span></span><br><span class="line">foo[<span class="number">11</span>]:		<span class="number">0xa2ae0b0</span></span><br><span class="line">foo[<span class="number">12</span>]:		<span class="number">0xa2ae0c0</span></span><br><span class="line">foo[<span class="number">13</span>]:		<span class="number">0xa2ae0d0</span></span><br><span class="line">foo[<span class="number">14</span>]:		<span class="number">0xa2ae0e0</span></span><br><span class="line">foo[<span class="number">15</span>]:		<span class="number">0xa2ae0f0</span></span><br><span class="line">foo[<span class="number">16</span>]:		<span class="number">0xa2ae100</span></span><br><span class="line">......</span><br><span class="line">foo[<span class="number">489</span>]:		<span class="number">0xa2afe90</span></span><br><span class="line">foo[<span class="number">490</span>]:		<span class="number">0xa2afea0</span></span><br><span class="line">foo[<span class="number">491</span>]:		<span class="number">0xa2afeb0</span></span><br><span class="line">foo[<span class="number">492</span>]:		<span class="number">0xa2afec0</span></span><br><span class="line">foo[<span class="number">493</span>]:		<span class="number">0xa2afed0</span></span><br><span class="line">foo[<span class="number">494</span>]:		<span class="number">0xa2afee0</span></span><br><span class="line">foo[<span class="number">495</span>]:		<span class="number">0xa2afef0</span></span><br><span class="line">foo[<span class="number">496</span>]:		<span class="number">0xa2aff00</span></span><br><span class="line">foo[<span class="number">497</span>]:		<span class="number">0xa2aff10</span></span><br><span class="line">foo[<span class="number">498</span>]:		<span class="number">0xa2aff20</span></span><br><span class="line">foo[<span class="number">499</span>]:		<span class="number">0xa2aff30</span></span><br><span class="line">-------------------------------------------------</span><br><span class="line">step <span class="number">2</span>: creating holes in between the victim objects</span><br><span class="line">freeing foo[<span class="number">450</span>]:	<span class="number">0xa2afc20</span></span><br><span class="line">freeing foo[<span class="number">452</span>]:	<span class="number">0xa2afc40</span></span><br><span class="line">freeing foo[<span class="number">454</span>]:	<span class="number">0xa2afc60</span></span><br><span class="line">freeing foo[<span class="number">456</span>]:	<span class="number">0xa2afc80</span></span><br><span class="line">freeing foo[<span class="number">458</span>]:	<span class="number">0xa2afca0</span></span><br><span class="line">freeing foo[<span class="number">460</span>]:	<span class="number">0xa2afcc0</span></span><br><span class="line">freeing foo[<span class="number">462</span>]:	<span class="number">0xa2afce0</span></span><br><span class="line">freeing foo[<span class="number">464</span>]:	<span class="number">0xa2afd00</span></span><br><span class="line">......</span><br><span class="line">freeing foo[<span class="number">486</span>]:	<span class="number">0xa2afe60</span></span><br><span class="line">freeing foo[<span class="number">488</span>]:	<span class="number">0xa2afe80</span></span><br><span class="line">freeing foo[<span class="number">490</span>]:	<span class="number">0xa2afea0</span></span><br><span class="line">freeing foo[<span class="number">492</span>]:	<span class="number">0xa2afec0</span></span><br><span class="line">freeing foo[<span class="number">494</span>]:	<span class="number">0xa2afee0</span></span><br><span class="line">freeing foo[<span class="number">496</span>]:	<span class="number">0xa2aff00</span></span><br><span class="line">freeing foo[<span class="number">498</span>]:	<span class="number">0xa2aff20</span></span><br><span class="line">-------------------------------------------------</span><br><span class="line">step <span class="number">3</span>: fill holes with vulnerable objects</span><br><span class="line">bar[<span class="number">451</span>]:	<span class="number">0xa2aff20</span></span><br><span class="line">bar[<span class="number">453</span>]:	<span class="number">0xa2aff00</span></span><br><span class="line">bar[<span class="number">455</span>]:	<span class="number">0xa2afee0</span></span><br><span class="line">bar[<span class="number">457</span>]:	<span class="number">0xa2afec0</span></span><br><span class="line">bar[<span class="number">459</span>]:	<span class="number">0xa2afea0</span></span><br><span class="line">bar[<span class="number">461</span>]:	<span class="number">0xa2afe80</span></span><br><span class="line">bar[<span class="number">463</span>]:	<span class="number">0xa2afe60</span></span><br><span class="line">bar[<span class="number">465</span>]:	<span class="number">0xa2afe40</span></span><br><span class="line">......</span><br><span class="line">bar[<span class="number">487</span>]:	<span class="number">0xa2afce0</span></span><br><span class="line">bar[<span class="number">489</span>]:	<span class="number">0xa2afcc0</span></span><br><span class="line">bar[<span class="number">491</span>]:	<span class="number">0xa2afca0</span></span><br><span class="line">bar[<span class="number">493</span>]:	<span class="number">0xa2afc80</span></span><br><span class="line">bar[<span class="number">495</span>]:	<span class="number">0xa2afc60</span></span><br><span class="line">bar[<span class="number">497</span>]:	<span class="number">0xa2afc40</span></span><br><span class="line">bar[<span class="number">499</span>]:	<span class="number">0xa2afc20</span></span><br><span class="line">-------------------------------------------------</span><br></pre></td></tr></table></figure>
<p>这里有很大的争议，我在网上看到了两种声音：</p>
<ul>
<li>从 5.0.1 版本的测试来看，jemalloc 采用了 LIFO 队列</li>
<li>但网上有人认为 jemalloc 采用了 FIFO 队列，从他们的数据截图来看也的确是 FIFO 队列，我猜测可能是因为 jemalloc 的版本导致了分配次序的不同</li>
</ul>
<p>最后说一下我自己的观点：（我只测试了两个版本）</p>
<p>我觉得 jemalloc-2.2.5 既不是 FIFO 也不是 LIFO，它只会在 run 所属的空间中，从低地址到高地址挨个找寻合适的 region 并分配出来</p>
<ul>
<li>以下代码可以证明：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x30</span>, <span class="string">&#x27;0&#x27;</span> * <span class="number">0x30</span>) </span><br><span class="line">add(<span class="number">0x30</span>, <span class="string">&#x27;1&#x27;</span> * <span class="number">0x30</span>) </span><br><span class="line">add(<span class="number">0x30</span>, <span class="string">&#x27;2&#x27;</span> * <span class="number">0x30</span>) </span><br><span class="line">add(<span class="number">0x30</span>, <span class="string">&#x27;3&#x27;</span> * <span class="number">0x30</span>) </span><br><span class="line">add(<span class="number">0x30</span>, <span class="string">&#x27;4&#x27;</span> * <span class="number">0x30</span>) </span><br><span class="line"></span><br><span class="line">kill(<span class="number">4</span>)</span><br><span class="line">kill(<span class="number">2</span>)</span><br><span class="line">kill(<span class="number">3</span>)</span><br><span class="line">kill(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x30</span>, <span class="string">&#x27;a&#x27;</span> * <span class="number">0x30</span>) </span><br><span class="line">add(<span class="number">0x30</span>, <span class="string">&#x27;b&#x27;</span> * <span class="number">0x30</span>) </span><br><span class="line">add(<span class="number">0x30</span>, <span class="string">&#x27;c&#x27;</span> * <span class="number">0x30</span>) </span><br><span class="line">add(<span class="number">0x30</span>, <span class="string">&#x27;d&#x27;</span> * <span class="number">0x30</span>) </span><br></pre></td></tr></table></figure>
<ul>
<li>结果：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0x7fa34240b040</span></span><br><span class="line"><span class="number">0x7fa34240b040</span>:	<span class="number">0x3030303030303030</span>	<span class="number">0x3030303030303030</span> <span class="comment">/* 0 */</span></span><br><span class="line"><span class="number">0x7fa34240b050</span>:	<span class="number">0x3030303030303030</span>	<span class="number">0x3030303030303030</span></span><br><span class="line"><span class="number">0x7fa34240b060</span>:	<span class="number">0x3030303030303030</span>	<span class="number">0x3030303030303030</span></span><br><span class="line"><span class="number">0x7fa34240b070</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span> <span class="comment">/* a */</span></span><br><span class="line"><span class="number">0x7fa34240b080</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x7fa34240b090</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x7fa34240b0a0</span>:	<span class="number">0x6262626262626262</span>	<span class="number">0x6262626262626262</span> <span class="comment">/* b */</span></span><br><span class="line"><span class="number">0x7fa34240b0b0</span>:	<span class="number">0x6262626262626262</span>	<span class="number">0x6262626262626262</span></span><br><span class="line"><span class="number">0x7fa34240b0c0</span>:	<span class="number">0x6262626262626262</span>	<span class="number">0x6262626262626262</span></span><br><span class="line"><span class="number">0x7fa34240b0d0</span>:	<span class="number">0x6363636363636363</span>	<span class="number">0x6363636363636363</span> <span class="comment">/* c */</span></span><br><span class="line"><span class="number">0x7fa34240b0e0</span>:	<span class="number">0x6363636363636363</span>	<span class="number">0x6363636363636363</span></span><br><span class="line"><span class="number">0x7fa34240b0f0</span>:	<span class="number">0x6363636363636363</span>	<span class="number">0x6363636363636363</span></span><br><span class="line"><span class="number">0x7fa34240b100</span>:	<span class="number">0x6464646464646464</span>	<span class="number">0x6464646464646464</span> <span class="comment">/* d */</span></span><br><span class="line"><span class="number">0x7fa34240b110</span>:	<span class="number">0x6464646464646464</span>	<span class="number">0x6464646464646464</span></span><br><span class="line"><span class="number">0x7fa34240b120</span>:	<span class="number">0x6464646464646464</span>	<span class="number">0x6464646464646464</span></span><br></pre></td></tr></table></figure>
<ul>
<li>我还尝试了其他的组合，不管释放的顺序如何改变，“a，b，c，d” 的顺序是不变的</li>
<li>也就是说，jemalloc-2.2.5 的释放和链表没有关系，分配时，就是从低地址到高地址遍历就行了</li>
</ul>
<p>而 jemalloc-5.0.1 的确是 LIFO 队列，空闲 region 可能是用链表组织起来的</p>
<ul>
<li>以下代码可以证明：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TSIZE   0x10            <span class="comment">/* target size class */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NALLOC  10             <span class="comment">/* number of allocations */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NFREE   (NALLOC / 10)   <span class="comment">/* number of deallocations */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jemalloc/jemalloc.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *foo[NALLOC];</span><br><span class="line">    <span class="keyword">char</span> *bar[NALLOC];</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;step 1: controlled allocations of victim objects\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; NALLOC; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        foo[i] = <span class="built_in">malloc</span>(TSIZE);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;foo[%d]:\t\t%p\n&quot;</span>, i, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)foo[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;step 2: creating holes in between the victim objects\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(foo[<span class="number">8</span>]);</span><br><span class="line">    <span class="built_in">free</span>(foo[<span class="number">5</span>]);</span><br><span class="line">    <span class="built_in">free</span>(foo[<span class="number">7</span>]);</span><br><span class="line">    <span class="built_in">free</span>(foo[<span class="number">6</span>]);</span><br><span class="line">    <span class="built_in">free</span>(foo[<span class="number">9</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;foo[%d]:\t\t%p\n&quot;</span>, <span class="number">8</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)foo[<span class="number">8</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;foo[%d]:\t\t%p\n&quot;</span>, <span class="number">5</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)foo[<span class="number">5</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;foo[%d]:\t\t%p\n&quot;</span>, <span class="number">7</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)foo[<span class="number">7</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;foo[%d]:\t\t%p\n&quot;</span>, <span class="number">6</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)foo[<span class="number">6</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;foo[%d]:\t\t%p\n&quot;</span>, <span class="number">9</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)foo[<span class="number">9</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;step 3: fill holes with vulnerable objects\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; NALLOC/<span class="number">2</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        bar[i] = <span class="built_in">malloc</span>(TSIZE);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;bar[%d]:\t\t%p\n&quot;</span>, i, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)bar[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>结果：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="built_in">exp</span> ./jemalloc                                                           </span><br><span class="line">step <span class="number">1</span>: controlled allocations of victim objects</span><br><span class="line">foo[<span class="number">0</span>]:		<span class="number">0x175f9000</span></span><br><span class="line">foo[<span class="number">1</span>]:		<span class="number">0x175f9010</span></span><br><span class="line">foo[<span class="number">2</span>]:		<span class="number">0x175f9020</span></span><br><span class="line">foo[<span class="number">3</span>]:		<span class="number">0x175f9030</span></span><br><span class="line">foo[<span class="number">4</span>]:		<span class="number">0x175f9040</span></span><br><span class="line">foo[<span class="number">5</span>]:		<span class="number">0x175f9050</span></span><br><span class="line">foo[<span class="number">6</span>]:		<span class="number">0x175f9060</span></span><br><span class="line">foo[<span class="number">7</span>]:		<span class="number">0x175f9070</span></span><br><span class="line">foo[<span class="number">8</span>]:		<span class="number">0x175f9080</span></span><br><span class="line">foo[<span class="number">9</span>]:		<span class="number">0x175f9090</span></span><br><span class="line">step <span class="number">2</span>: creating holes in between the victim objects</span><br><span class="line">foo[<span class="number">8</span>]:		<span class="number">0x175f9080</span></span><br><span class="line">foo[<span class="number">5</span>]:		<span class="number">0x175f9050</span></span><br><span class="line">foo[<span class="number">7</span>]:		<span class="number">0x175f9070</span></span><br><span class="line">foo[<span class="number">6</span>]:		<span class="number">0x175f9060</span></span><br><span class="line">foo[<span class="number">9</span>]:		<span class="number">0x175f9090</span></span><br><span class="line">step <span class="number">3</span>: fill holes with vulnerable objects</span><br><span class="line">bar[<span class="number">0</span>]:		<span class="number">0x175f9090</span></span><br><span class="line">bar[<span class="number">1</span>]:		<span class="number">0x175f9060</span></span><br><span class="line">bar[<span class="number">2</span>]:		<span class="number">0x175f9070</span></span><br><span class="line">bar[<span class="number">3</span>]:		<span class="number">0x175f9050</span></span><br><span class="line">bar[<span class="number">4</span>]:		<span class="number">0x175f9080</span></span><br></pre></td></tr></table></figure>
<ul>
<li>我故意打乱了释放的顺序，但是 jemalloc-5.0.1 还是可以“记住”我的释放顺序</li>
<li>也就是说，jemalloc-5.0.1 中一定有一个结构来我的释放顺序，极有可能是链表（我在源码中没有找到）</li>
<li>从结果上分析，jemalloc-5.0.1 采用了 LIFO</li>
</ul>
<h2 id="Metadata-corruption（元数据损坏）"><a href="#Metadata-corruption（元数据损坏）" class="headerlink" title="Metadata corruption（元数据损坏）"></a>Metadata corruption（元数据损坏）</h2><p>由于 jemalloc 不是基于 freelists（它使用基于宏的红黑树代替），因此无法使用 unlink 和 frontlink 漏洞利用技术，相反，我们将关注如何强制 “malloc()” 返回一个指向已初始化堆区域的指针</p>
<p><strong>Run (arena_run_t)</strong></p>
<p>run 只是一些相同 size 的 regions 的集合，run 的元数据遵循 arena_run_t 的结构，每个<br>run 包含一个指向它所在区域的 bin 的指针</p>
<p>在解除分配时，区域大小是未知的，因此无法直接计算 bin 索引，相反，jemalloc 将首先找到要释放的内存所在的 run，然后取消引用存储在 run 的 header 中的 bin 指针：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* jemalloc-2.2.5/src/arena.c */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">arena_dalloc_bin_run</span><span class="params">(<span class="keyword">arena_t</span> *arena, <span class="keyword">arena_chunk_t</span> *chunk, <span class="keyword">arena_run_t</span> *run,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">arena_bin_t</span> *bin)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">size_t</span> binind;</span><br><span class="line">	<span class="keyword">arena_bin_info_t</span> *bin_info;</span><br><span class="line">	<span class="keyword">size_t</span> npages, run_ind, past;</span><br><span class="line"></span><br><span class="line">	assert(run != bin-&gt;runcur);</span><br><span class="line">	assert(arena_run_tree_search(&amp;bin-&gt;runs, &amp;chunk-&gt;<span class="built_in">map</span>[</span><br><span class="line">	    (((<span class="keyword">uintptr_t</span>)run-(<span class="keyword">uintptr_t</span>)chunk)&gt;&gt;PAGE_SHIFT)-map_bias]) == <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">	binind = arena_bin_index(chunk-&gt;arena, run-&gt;bin);</span><br><span class="line">	bin_info = &amp;arena_bin_info[binind];</span><br><span class="line"></span><br><span class="line">	malloc_mutex_unlock(&amp;bin-&gt;lock);</span><br><span class="line">	<span class="comment">/******************************/</span></span><br><span class="line">	npages = bin_info-&gt;run_size &gt;&gt; PAGE_SHIFT;</span><br><span class="line">	run_ind = (<span class="keyword">size_t</span>)(((<span class="keyword">uintptr_t</span>)run - (<span class="keyword">uintptr_t</span>)chunk) &gt;&gt; PAGE_SHIFT);</span><br><span class="line">	past = (<span class="keyword">size_t</span>)(PAGE_CEILING((<span class="keyword">uintptr_t</span>)run +</span><br><span class="line">	    (<span class="keyword">uintptr_t</span>)bin_info-&gt;reg0_offset + (<span class="keyword">uintptr_t</span>)(run-&gt;nextind *</span><br><span class="line">	    bin_info-&gt;reg_size) - (<span class="keyword">uintptr_t</span>)chunk) &gt;&gt; PAGE_SHIFT);</span><br><span class="line">	malloc_mutex_lock(&amp;arena-&gt;lock);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 如果run最初是干净的,并且某些页面未被使用,则释放run的脏部分之前,修剪干净的页面 */</span></span><br><span class="line">	<span class="keyword">if</span> ((chunk-&gt;<span class="built_in">map</span>[run_ind-map_bias].bits &amp; CHUNK_MAP_DIRTY) == <span class="number">0</span> &amp;&amp; past</span><br><span class="line">	    - run_ind &lt; npages) &#123;</span><br><span class="line">        <span class="comment">/* 修剪干净的页面,事先转换为large run,首先设置最后一个map元素,以防这是one-page run */</span></span><br><span class="line">		chunk-&gt;<span class="built_in">map</span>[run_ind+npages<span class="number">-1</span>-map_bias].bits = CHUNK_MAP_LARGE |</span><br><span class="line">		    (chunk-&gt;<span class="built_in">map</span>[run_ind+npages<span class="number">-1</span>-map_bias].bits &amp;</span><br><span class="line">		    CHUNK_MAP_FLAGS_MASK);</span><br><span class="line">		chunk-&gt;<span class="built_in">map</span>[run_ind-map_bias].bits = bin_info-&gt;run_size |</span><br><span class="line">		    CHUNK_MAP_LARGE | (chunk-&gt;<span class="built_in">map</span>[run_ind-map_bias].bits &amp;</span><br><span class="line">		    CHUNK_MAP_FLAGS_MASK);</span><br><span class="line">		arena_run_trim_tail(arena, chunk, run, (npages &lt;&lt; PAGE_SHIFT),</span><br><span class="line">		    ((past - run_ind) &lt;&lt; PAGE_SHIFT), <span class="literal">false</span>);</span><br><span class="line">        <span class="comment">/* npages = past - run_ind; */</span></span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> JEMALLOC_DEBUG</span></span><br><span class="line">	run-&gt;magic = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	arena_run_dalloc(arena, run, <span class="literal">true</span>);</span><br><span class="line">	malloc_mutex_unlock(&amp;arena-&gt;lock);</span><br><span class="line">	<span class="comment">/****************************/</span></span><br><span class="line">	malloc_mutex_lock(&amp;bin-&gt;lock);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> JEMALLOC_STATS</span></span><br><span class="line">	bin-&gt;stats.curruns--;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>malloc 的分配相当依赖 arena_run_t 结构体，而 jemalloc-2.2.5 分配 region 前，会在目标 run 的范围的头部申请一个 arena_run_t 结构体来管理 run（jemalloc-5.0.1 不会分配）</li>
<li>如果有堆溢出，就可以劫持 arena_run_t 结构体</li>
<li>主要是劫持 arena_run_t-&gt;nfree：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p (<span class="keyword">arena_run_t</span>)*<span class="number">0x7fc184808000</span></span><br><span class="line">$<span class="number">1</span> = &#123;</span><br><span class="line">  magic = <span class="number">944430995</span>,</span><br><span class="line">  bin = <span class="number">0x7fc185000d70</span>,</span><br><span class="line">  nextind = <span class="number">1</span>,</span><br><span class="line">  nfree = <span class="number">49</span> <span class="comment">/* target */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>如果 nfree 为初始值，jemalloc.2.2.5 就会认为该 run 没有进行分配，然后无视之前已经在 run 中分配的部分，从头开始申请</li>
<li>这样就可以覆盖一些关键数据</li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/Jemalloc/" rel="tag"><i class="fa fa-tag"></i> Jemalloc</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/05/30/LLVM%20pass%20pwn/" rel="prev" title="LLVM pass pwn">
      <i class="fa fa-chevron-left"></i> LLVM pass pwn
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/06/02/gadget+ORA+CMP%20trick/" rel="next" title="gadget+ORA+CMP trick">
      gadget+ORA+CMP trick <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Jemalloc-%E5%AE%89%E8%A3%85-amp-%E4%BD%BF%E7%94%A8"><span class="nav-number">1.</span> <span class="nav-text">Jemalloc 安装&amp;使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Jemalloc-%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="nav-number">2.</span> <span class="nav-text">Jemalloc 架构设计</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Jemalloc-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-number">3.</span> <span class="nav-text">Jemalloc 数据结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Jemalloc-%E5%88%86%E9%85%8D%E6%9C%BA%E5%88%B6"><span class="nav-number">4.</span> <span class="nav-text">Jemalloc 分配机制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Jemalloc-GDB"><span class="nav-number">5.</span> <span class="nav-text">Jemalloc GDB</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Adjacent-region-corruption%EF%BC%88%E7%9B%B8%E9%82%BB%E5%8C%BA%E5%9F%9F%E5%86%B2%E7%AA%81%EF%BC%89"><span class="nav-number">6.</span> <span class="nav-text">Adjacent region corruption（相邻区域冲突）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Heap-manipulation%EF%BC%88%E5%A0%86%E9%A3%8E%E6%B0%B4%EF%BC%89"><span class="nav-number">7.</span> <span class="nav-text">Heap manipulation（堆风水）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Metadata-corruption%EF%BC%88%E5%85%83%E6%95%B0%E6%8D%AE%E6%8D%9F%E5%9D%8F%EF%BC%89"><span class="nav-number">8.</span> <span class="nav-text">Metadata corruption（元数据损坏）</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yhellow"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">yhellow</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">325</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">169</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yhellow</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">4.9m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">74:01</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
