<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="共享内存基础知识 共享内存有两个，一个 mmap，一个 systemV 的 shm 由于所有用户进程总的虚拟地址空间比可用的物理内存大很多，因此只有最常用的部分才与物理页帧关联（这不是问题，因为大多数程序只占用实际可用内存的一小部分）  在将磁盘上的数据映射到进程的虚拟地址空间的时，内核必须提供数据结构，以建立虚拟地址空间的区域和相关数据所在位置之间的关联，Linux 软件系统多级页表映射机制 共">
<meta property="og:type" content="article">
<meta property="og:title" content="Principles：共享内存shm底层原理">
<meta property="og:url" content="http://example.com/2022/09/22/Principles%EF%BC%9A%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98shm%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/index.html">
<meta property="og:site_name" content="Pwn进你的心">
<meta property="og:description" content="共享内存基础知识 共享内存有两个，一个 mmap，一个 systemV 的 shm 由于所有用户进程总的虚拟地址空间比可用的物理内存大很多，因此只有最常用的部分才与物理页帧关联（这不是问题，因为大多数程序只占用实际可用内存的一小部分）  在将磁盘上的数据映射到进程的虚拟地址空间的时，内核必须提供数据结构，以建立虚拟地址空间的区域和相关数据所在位置之间的关联，Linux 软件系统多级页表映射机制 共">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2022-09-22T09:56:28.000Z">
<meta property="article:modified_time" content="2022-11-16T13:14:56.000Z">
<meta property="article:author" content="yhellow">
<meta property="article:tag" content="Principles">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/2022/09/22/Principles%EF%BC%9A%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98shm%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>Principles：共享内存shm底层原理 | Pwn进你的心</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Pwn进你的心</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/09/22/Principles%EF%BC%9A%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98shm%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Principles：共享内存shm底层原理
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-09-22 17:56:28" itemprop="dateCreated datePublished" datetime="2022-09-22T17:56:28+08:00">2022-09-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-11-16 21:14:56" itemprop="dateModified" datetime="2022-11-16T21:14:56+08:00">2022-11-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Principles/" itemprop="url" rel="index"><span itemprop="name">Principles</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>23k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>21 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p><strong>共享内存基础知识</strong></p>
<p>共享内存有两个，一个 mmap，一个 systemV 的 shm</p>
<p>由于所有用户进程总的虚拟地址空间比可用的物理内存大很多，因此只有最常用的部分才与物理页帧关联（这不是问题，因为大多数程序只占用实际可用内存的一小部分）</p>
<ul>
<li>在将磁盘上的数据映射到进程的虚拟地址空间的时，内核必须提供数据结构，以建立虚拟地址空间的区域和相关数据所在位置之间的关联，Linux 软件系统多级页表映射机制</li>
<li>共享内存使得多个进程可以访问同一块内存空间（节约了内存空间），不同进程可以及时看到对方进程中对共享内存中数据得更新（多个进程可以同时操作，所以需要进行同步 ，一般与信号量配合使用）</li>
</ul>
<p>本文主要介绍 shm</p>
<p><strong>共享内存的 API</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">shmget</span><span class="params">(<span class="keyword">key_t</span> key, <span class="keyword">size_t</span> size, <span class="keyword">int</span> shmflg)</span></span>; <span class="comment">/* 获取一个新的共享内存段 */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>key：<ul>
<li>IPC_PRIVATE - “0”：会建立新共享内存对象 </li>
<li>大于0的32位整数：视参数 shmflg 来确定操作（通常要求此值来源于 <code>ftok</code> 返回的IPC键值）</li>
</ul>
</li>
<li>size：<ul>
<li>“0”：获取共享内存时指定为“0”</li>
<li>大于0的整数：新建的共享内存大小，以字节为单位</li>
</ul>
</li>
<li>shmflg：<ul>
<li>“0”：取共享内存标识符，若不存在则函数会报错</li>
<li>IPC_CREAT：如果内核中不存在键值与key相等的共享内存，则新建一个共享内存，如果存在这样的共享内存，返回此共享内存的标识符</li>
<li>IPC_CREAT | IPC_EXCL：如果内核中不存在键值与 key 相等的共享内存，则新建一个共享内存，如果存在这样的共享内存则报错</li>
</ul>
</li>
<li>return：<ul>
<li>成功：返回消息队列的标识符 </li>
<li>出错：返回 “-1”，错误原因存于 error 中</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">shmat</span><span class="params">(<span class="keyword">int</span> shmid, <span class="keyword">const</span> <span class="keyword">void</span> *shmaddr, <span class="keyword">int</span> shmflg)</span></span>; <span class="comment">/* 进行内存映射 */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>shmid：<ul>
<li>共享内存的标识符</li>
</ul>
</li>
<li>shmaddr：<ul>
<li>如果 <code>shmaddr</code> 为“0”则此段连接到由内核选择的第一个可用地址上</li>
<li>如果 <code>shmaddr</code> 非零，并且没有指定 SHM_RND，则此段链接到 <code>shmaddr</code> 所指的地址上，但是 <code>shmaddr</code> 必须是发生附加的页对齐地址</li>
<li>如果 <code>shmaddr</code> 非零且指定 SHM_RND，系统会自动对 <code>shmaddr</code> 进行页对齐</li>
</ul>
</li>
<li>shmflg：<ul>
<li>“0”：读写模式 </li>
<li>SHM_RDONLY：为只读模式</li>
<li>SHM_EXEC：指定对共享内存段的执行权限（对共享内存而言，所谓的执行权限实际上和读权限是一样的）</li>
<li>SHM_RND：取整，取向下一个 SHMLBA 边界 （shmaddr 非空时有效）</li>
<li>SHM_REMAP：附加上的接管区域 </li>
</ul>
</li>
<li>return：<ul>
<li>成功：返回共享内存地址</li>
<li>出错：返回 “-1”，错误原因存于 error 中</li>
</ul>
</li>
<li>PS：<ul>
<li><code>fork</code> 后子进程继承已连接的共享内存地址</li>
<li><code>exec</code> 后该子进程与已连接的共享内存地址自动脱离(detach)</li>
<li>目标进程结束后，已连接的共享内存地址会自动脱离(detach) </li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">shmdt</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *shmaddr)</span></span>; <span class="comment">/* 删除内存映射 */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>shmaddr：<ul>
<li>连接的共享内存的起始地址</li>
</ul>
</li>
<li>return：<ul>
<li>成功：返回消息队列的标识符 </li>
<li>出错：返回 “-1”，错误原因存于 error 中</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">shmctl</span><span class="params">(<span class="keyword">int</span> shmid, <span class="keyword">int</span> cmd, struct shmid_ds *buf)</span></span>; <span class="comment">/* 对共享内存段进行操作 */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>msqid：<ul>
<li>共享内存的标识符</li>
</ul>
</li>
<li>cmd：<ul>
<li>IPC_STAT：得到共享内存的状态，把共享内存的 shmid_ds 结构复制到 buf 中</li>
<li>IPC_SET：改变共享内存的状态，把 buf 所指的 shmid_ds 结构中的 uid、gid、mode 复制到共享内存的 shmid_ds 结构内 </li>
<li>IPC_RMID：删除这片共享内存（销毁 <code>shmget</code> 创建的 <code>shmid</code>）</li>
</ul>
</li>
<li>buf：<ul>
<li>共享内存管理结构体 </li>
</ul>
</li>
<li>return：<ul>
<li>成功：返回 “0”</li>
<li>出错：返回 “-1”，错误原因存于 error 中</li>
</ul>
</li>
</ul>
<p><strong>共享内存使用案例</strong></p>
<p>shm 写内存：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> shmid;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span> *pshm;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">key_t</span> key = ftok(<span class="string">&quot;.&quot;</span>,<span class="string">&#x27;z&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;key = 0x%x\n&quot;</span>,key);</span><br><span class="line">    shmid = shmget(key, <span class="number">1024</span> * <span class="number">10</span>, <span class="number">0666</span> | IPC_CREAT);</span><br><span class="line">    pshm = shmat(shmid, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;input node 0-9\n&quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;i);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;node is %d\n&quot;</span>, i);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;input data\n&quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, buf);</span><br><span class="line">    <span class="built_in">memcpy</span>(pshm + i * <span class="number">1024</span>, buf, <span class="number">1024</span>);</span><br><span class="line">    shmdt(pshm);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>shm 读内存：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">char</span> *pshm;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">int</span> shmid;</span><br><span class="line">    <span class="keyword">key_t</span> key = ftok(<span class="string">&quot;.&quot;</span>,<span class="string">&#x27;z&#x27;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;key = 0x%x\n&quot;</span>,key);</span><br><span class="line">    shmid = shmget(key, <span class="number">1024</span> * <span class="number">10</span>, <span class="number">0666</span> | IPC_CREAT);</span><br><span class="line">    pshm = shmat(shmid, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;input node 0-9\n&quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;i);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;node is %d\n&quot;</span>,i);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="number">1024</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(buf, pshm + i * <span class="number">1024</span>, <span class="number">1024</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">&quot;data [%s]\n&quot;</span>, buf);</span><br><span class="line">    shmdt(pshm);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>效果：（这里把 R/W 分为两个文件，体现其通信的特性）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="built_in">exp</span> ./send</span><br><span class="line">key = <span class="number">0x7a05274f</span></span><br><span class="line">input node <span class="number">0</span><span class="number">-9</span></span><br><span class="line"><span class="number">0</span></span><br><span class="line">node is <span class="number">0</span></span><br><span class="line">input data</span><br><span class="line">yhellow </span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="built_in">exp</span> ./read</span><br><span class="line">key = <span class="number">0x7a05274f</span></span><br><span class="line">input node <span class="number">0</span><span class="number">-9</span></span><br><span class="line"><span class="number">0</span></span><br><span class="line">node is <span class="number">0</span></span><br><span class="line">data [yhellow]</span><br></pre></td></tr></table></figure>
<ul>
<li>表面和 msg 的效果很像：<ul>
<li>“共享内存段-<code>shmid_kernel</code>” 类似于 “消息队列-<code>msg_queue</code>”</li>
<li>“映射的内存-<code>shm_file_data</code>” 类似于 “消息-<code>msg_msg</code>”</li>
<li>但是</li>
</ul>
</li>
<li>只是多了片虚拟内存空间：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">    <span class="number">0x7ffff7fb0000</span>     <span class="number">0x7ffff7fb6000</span> rw-p     <span class="number">6000</span> <span class="number">0</span>      [anon_7ffff7fb0]</span><br><span class="line">    <span class="number">0x7ffff7fc6000</span>     <span class="number">0x7ffff7fc9000</span> rw-p     <span class="number">3000</span> <span class="number">0</span>      /SYSV7a05274f (deleted)</span><br><span class="line">    <span class="number">0x7ffff7fc9000</span>     <span class="number">0x7ffff7fcd000</span> r--p     <span class="number">4000</span> <span class="number">0</span>      [vvar]</span><br><span class="line">    <span class="number">0x7ffff7fcd000</span>     <span class="number">0x7ffff7fcf000</span> r-xp     <span class="number">2000</span> <span class="number">0</span>      [vdso]</span><br><span class="line">pwndbg&gt; telescope <span class="number">0x7ffff7fc6000</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffff7fc6000</span> ◂— <span class="number">0x776f6c6c656879</span> <span class="comment">/* &#x27;yhellow&#x27; */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffff7fc6008</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>shm 父子进程通信：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUFFER_SIZE 2048</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">pid_t</span> pid;</span><br><span class="line">	<span class="keyword">int</span> shmid;</span><br><span class="line">	<span class="keyword">char</span> *shm_addr;</span><br><span class="line">	<span class="keyword">char</span> flag[] = <span class="string">&quot;WROTE&quot;</span>;</span><br><span class="line">	<span class="keyword">char</span> buff[<span class="number">2048</span>];</span><br><span class="line">	</span><br><span class="line">	system(<span class="string">&quot;ipcs -m&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> ((shmid = shmget(IPC_PRIVATE, BUFFER_SIZE, <span class="number">0666</span>)) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">		perror(<span class="string">&quot;shmget&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Create shared-memory: %d\n&quot;</span>,shmid);</span><br><span class="line">	&#125;</span><br><span class="line">	system(<span class="string">&quot;ipcs -m&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	pid = fork();</span><br><span class="line">	<span class="keyword">if</span> (pid == <span class="number">-1</span>)&#123;</span><br><span class="line">		perror(<span class="string">&quot;fork&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123; <span class="comment">/* 子进程处理 */</span></span><br><span class="line">		<span class="keyword">if</span> ((shm_addr = shmat(shmid, <span class="number">0</span>, <span class="number">0</span>)) == (<span class="keyword">void</span>*)<span class="number">-1</span>)&#123;</span><br><span class="line">			perror(<span class="string">&quot;Child: shmat&quot;</span>);</span><br><span class="line">			<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;Child: Attach shared-memory addr: %p\n&quot;</span>, shm_addr);</span><br><span class="line">		&#125;</span><br><span class="line">		system(<span class="string">&quot;ipcs -m&quot;</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">while</span> (<span class="built_in">strncmp</span>(shm_addr, flag, <span class="built_in">strlen</span>(flag)))&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;Child: Wait for enable data...\n&quot;</span>);</span><br><span class="line">			sleep(<span class="number">5</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="built_in">strcpy</span>(buff, shm_addr + <span class="built_in">strlen</span>(flag));</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Child: Shared-memory :%s\n&quot;</span>, buff);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> ((shmdt(shm_addr)) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">			perror(<span class="string">&quot;shmdt&quot;</span>);</span><br><span class="line">			<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;Child: Deattach shared-memory\n&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	  	system(<span class="string">&quot;ipcs -m&quot;</span>);</span><br><span class="line">	  	</span><br><span class="line">	  	<span class="keyword">if</span> (shmctl(shmid, IPC_RMID, <span class="literal">NULL</span>) == <span class="number">-1</span>)&#123;</span><br><span class="line">			perror(<span class="string">&quot;Child: shmctl(IPC_RMID)\n&quot;</span>);</span><br><span class="line">			<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;Delete shared-memory\n&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		system(<span class="string">&quot;ipcs -m&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123; <span class="comment">/* 父进程处理 */</span></span><br><span class="line">		sleep(<span class="number">1</span>);</span><br><span class="line">		<span class="keyword">if</span> ((shm_addr = shmat(shmid, <span class="number">0</span>, <span class="number">0</span>)) == (<span class="keyword">void</span>*)<span class="number">-1</span>)&#123;</span><br><span class="line">			perror(<span class="string">&quot;Parent: shmat&quot;</span>);</span><br><span class="line">			<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;Parent: Attach shared-memory addr: %p\n&quot;</span>, shm_addr);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;\nInput some string:(Parent)\n&quot;</span>);</span><br><span class="line">		fgets(buff, BUFFER_SIZE, <span class="built_in">stdin</span>);</span><br><span class="line">		<span class="built_in">strncpy</span>(shm_addr + <span class="built_in">strlen</span>(flag), buff, <span class="built_in">strlen</span>(buff));</span><br><span class="line">		<span class="built_in">strncpy</span>(shm_addr, flag, <span class="built_in">strlen</span>(flag));</span><br><span class="line">		system(<span class="string">&quot;ipcs -m&quot;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> ((shmdt(shm_addr)) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">			perror(<span class="string">&quot;Parent: shmdt&quot;</span>);</span><br><span class="line">			<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;Parent: Deattach shared-memory\n&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		system(<span class="string">&quot;ipcs -m&quot;</span>);</span><br><span class="line">		</span><br><span class="line">		waitpid(pid, <span class="literal">NULL</span>, <span class="number">0</span>);		</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Finished\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">  	<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>效果：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="built_in">exp</span> ./shmem</span><br><span class="line"></span><br><span class="line">------------ 共享内存段 -------------- <span class="comment">/* 初始状态 */</span></span><br><span class="line">键        shmid      拥有者  权限     字节     连接数  状态      </span><br><span class="line"><span class="number">0x00000000</span> <span class="number">4</span>          yhellow    <span class="number">600</span>        <span class="number">524288</span>     <span class="number">2</span>          目标       </span><br><span class="line"><span class="number">0x00000000</span> <span class="number">7</span>          yhellow    <span class="number">600</span>        <span class="number">524288</span>     <span class="number">2</span>          目标       </span><br><span class="line"><span class="number">0x00000000</span> <span class="number">11</span>         yhellow    <span class="number">600</span>        <span class="number">524288</span>     <span class="number">2</span>          目标       </span><br><span class="line"></span><br><span class="line">Create shared-memory: <span class="number">13</span></span><br><span class="line"></span><br><span class="line">------------ 共享内存段 -------------- <span class="comment">/* shmget新创建的共享内存段(shmid==13) */</span></span><br><span class="line">键        shmid      拥有者  权限     字节     连接数  状态      </span><br><span class="line"><span class="number">0x00000000</span> <span class="number">4</span>          yhellow    <span class="number">600</span>        <span class="number">524288</span>     <span class="number">2</span>          目标       </span><br><span class="line"><span class="number">0x00000000</span> <span class="number">7</span>          yhellow    <span class="number">600</span>        <span class="number">524288</span>     <span class="number">2</span>          目标       </span><br><span class="line"><span class="number">0x00000000</span> <span class="number">11</span>         yhellow    <span class="number">600</span>        <span class="number">524288</span>     <span class="number">2</span>          目标       </span><br><span class="line"><span class="number">0x00000000</span> <span class="number">13</span>         yhellow    <span class="number">666</span>        <span class="number">2048</span>       <span class="number">0</span>                       </span><br><span class="line"></span><br><span class="line">Child: Attach shared-memory addr: <span class="number">0x7fe24a52d000</span></span><br><span class="line"></span><br><span class="line">------------ 共享内存段 -------------- <span class="comment">/* 子进程连接该共享内存段,使其[连接数]加一 */</span></span><br><span class="line">键        shmid      拥有者  权限     字节     连接数  状态      </span><br><span class="line"><span class="number">0x00000000</span> <span class="number">4</span>          yhellow    <span class="number">600</span>        <span class="number">524288</span>     <span class="number">2</span>          目标       </span><br><span class="line"><span class="number">0x00000000</span> <span class="number">7</span>          yhellow    <span class="number">600</span>        <span class="number">524288</span>     <span class="number">2</span>          目标       </span><br><span class="line"><span class="number">0x00000000</span> <span class="number">11</span>         yhellow    <span class="number">600</span>        <span class="number">524288</span>     <span class="number">2</span>          目标       </span><br><span class="line"><span class="number">0x00000000</span> <span class="number">13</span>         yhellow    <span class="number">666</span>        <span class="number">2048</span>       <span class="number">1</span>                       </span><br><span class="line"></span><br><span class="line">Child: Wait <span class="keyword">for</span> enable data...</span><br><span class="line">Parent: Attach shared-memory addr: <span class="number">0x7fe24a52d000</span></span><br><span class="line"></span><br><span class="line">Input some <span class="built_in">string</span>:(Parent)</span><br><span class="line">yhellow <span class="comment">/* 在父进程上的输入 */</span></span><br><span class="line"></span><br><span class="line">------------ 共享内存段 -------------- <span class="comment">/* 父进程连接该共享内存段,使其[连接数]加一 */</span></span><br><span class="line">键        shmid      拥有者  权限     字节     连接数  状态      </span><br><span class="line"><span class="number">0x00000000</span> <span class="number">4</span>          yhellow    <span class="number">600</span>        <span class="number">524288</span>     <span class="number">2</span>          目标       </span><br><span class="line"><span class="number">0x00000000</span> <span class="number">7</span>          yhellow    <span class="number">600</span>        <span class="number">524288</span>     <span class="number">2</span>          目标       </span><br><span class="line"><span class="number">0x00000000</span> <span class="number">11</span>         yhellow    <span class="number">600</span>        <span class="number">524288</span>     <span class="number">2</span>          目标       </span><br><span class="line"><span class="number">0x00000000</span> <span class="number">13</span>         yhellow    <span class="number">666</span>        <span class="number">2048</span>       <span class="number">2</span>                       </span><br><span class="line"></span><br><span class="line">Parent: Deattach shared-memory</span><br><span class="line"></span><br><span class="line">------------ 共享内存段 -------------- <span class="comment">/* 父进程断开该共享内存段,使其[连接数]减一 */</span></span><br><span class="line">键        shmid      拥有者  权限     字节     连接数  状态      </span><br><span class="line"><span class="number">0x00000000</span> <span class="number">4</span>          yhellow    <span class="number">600</span>        <span class="number">524288</span>     <span class="number">2</span>          目标       </span><br><span class="line"><span class="number">0x00000000</span> <span class="number">7</span>          yhellow    <span class="number">600</span>        <span class="number">524288</span>     <span class="number">2</span>          目标       </span><br><span class="line"><span class="number">0x00000000</span> <span class="number">11</span>         yhellow    <span class="number">600</span>        <span class="number">524288</span>     <span class="number">2</span>          目标       </span><br><span class="line"><span class="number">0x00000000</span> <span class="number">13</span>         yhellow    <span class="number">666</span>        <span class="number">2048</span>       <span class="number">1</span>                       </span><br><span class="line"></span><br><span class="line">Child: Shared-memory :yhellow <span class="comment">/* 在子进程上的输出 */</span></span><br><span class="line"></span><br><span class="line">Child: Deattach shared-memory</span><br><span class="line"></span><br><span class="line">------------ 共享内存段 -------------- <span class="comment">/* 子进程断开该共享内存段,使其[连接数]减一 */</span></span><br><span class="line">键        shmid      拥有者  权限     字节     连接数  状态      </span><br><span class="line"><span class="number">0x00000000</span> <span class="number">4</span>          yhellow    <span class="number">600</span>        <span class="number">524288</span>     <span class="number">2</span>          目标       </span><br><span class="line"><span class="number">0x00000000</span> <span class="number">7</span>          yhellow    <span class="number">600</span>        <span class="number">524288</span>     <span class="number">2</span>          目标       </span><br><span class="line"><span class="number">0x00000000</span> <span class="number">11</span>         yhellow    <span class="number">600</span>        <span class="number">524288</span>     <span class="number">2</span>          目标       </span><br><span class="line"><span class="number">0x00000000</span> <span class="number">13</span>         yhellow    <span class="number">666</span>        <span class="number">2048</span>       <span class="number">0</span>                       </span><br><span class="line"></span><br><span class="line">Delete shared-memory</span><br><span class="line"></span><br><span class="line">------------ 共享内存段 -------------- <span class="comment">/* shmctl销毁了指定的共享内存段 */</span></span><br><span class="line">键        shmid      拥有者  权限     字节     连接数  状态      </span><br><span class="line"><span class="number">0x00000000</span> <span class="number">4</span>          yhellow    <span class="number">600</span>        <span class="number">524288</span>     <span class="number">2</span>          目标       </span><br><span class="line"><span class="number">0x00000000</span> <span class="number">7</span>          yhellow    <span class="number">600</span>        <span class="number">524288</span>     <span class="number">2</span>          目标       </span><br><span class="line"><span class="number">0x00000000</span> <span class="number">11</span>         yhellow    <span class="number">600</span>        <span class="number">524288</span>     <span class="number">2</span>          目标       </span><br><span class="line"></span><br><span class="line">Finished</span><br></pre></td></tr></table></figure>
<p><strong>Linux 中 shm 的实现</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x7ffff7ee11fc</span> &lt;shmget+<span class="number">12</span>&gt;       syscall  &lt;SYS_shmget&gt;</span><br><span class="line">       key: <span class="number">0x7a05274f</span></span><br><span class="line">       size: <span class="number">0x2800</span></span><br><span class="line">       shmflg: <span class="number">0x3b6</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ipc_ops</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> (*getnew)(struct ipc_namespace *, struct ipc_params *);</span><br><span class="line">	<span class="keyword">int</span> (*associate)(struct kern_ipc_perm *, <span class="keyword">int</span>);</span><br><span class="line">	<span class="keyword">int</span> (*more_checks)(struct kern_ipc_perm *, struct ipc_params *);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">ksys_shmget</span><span class="params">(<span class="keyword">key_t</span> key, <span class="keyword">size_t</span> size, <span class="keyword">int</span> shmflg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ipc_namespace</span> *<span class="title">ns</span>;</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">ipc_ops</span> <span class="title">shm_ops</span> =</span> &#123;</span><br><span class="line">		.getnew = newseg,</span><br><span class="line">		.associate = security_shm_associate,</span><br><span class="line">		.more_checks = shm_more_checks,</span><br><span class="line">	&#125;; <span class="comment">/* 初始化&quot;创建例程&quot; */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ipc_params</span> <span class="title">shm_params</span>;</span></span><br><span class="line"></span><br><span class="line">	ns = current-&gt;nsproxy-&gt;ipc_ns; <span class="comment">/* 获取当前IPC命名空间 */</span></span><br><span class="line"></span><br><span class="line">	shm_params.key = key; <span class="comment">/* 键值 */</span></span><br><span class="line">	shm_params.flg = shmflg; <span class="comment">/* 标识符 */</span></span><br><span class="line">	shm_params.u.size = size; <span class="comment">/* 大小 */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ipcget(ns, &amp;shm_ids(ns), &amp;shm_ops, &amp;shm_params); <span class="comment">/* 核心函数 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ipcget</span><span class="params">(struct ipc_namespace *ns, struct ipc_ids *ids,</span></span></span><br><span class="line"><span class="params"><span class="function">			<span class="keyword">const</span> struct ipc_ops *ops, struct ipc_params *params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (params-&gt;key == IPC_PRIVATE) <span class="comment">/* 是否私有 */</span></span><br><span class="line">		<span class="keyword">return</span> ipcget_new(ns, ids, ops, params); <span class="comment">/* 创建一个新的ipc对象 */</span></span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> ipcget_public(ns, ids, ops, params); <span class="comment">/* 获取一个ipc对象或创建一个新对象 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">ipcget_public</span><span class="params">(struct ipc_namespace *ns, struct ipc_ids *ids,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">const</span> struct ipc_ops *ops, struct ipc_params *params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// *ns: ipc命名空间</span></span><br><span class="line">    <span class="comment">// *ids: ipc标识符集</span></span><br><span class="line">    <span class="comment">// *ops: 要调用的实际创建例程</span></span><br><span class="line">    <span class="comment">// *params: 它的参数</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kern_ipc_perm</span> *<span class="title">ipcp</span>;</span></span><br><span class="line">	<span class="keyword">int</span> flg = params-&gt;flg;</span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Take the lock as a writer since we are potentially going to add</span></span><br><span class="line"><span class="comment">	 * a new entry + read locks are not &quot;upgradable&quot;</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	down_write(&amp;ids-&gt;rwsem);</span><br><span class="line">	ipcp = ipc_findkey(ids, params-&gt;key); <span class="comment">/* 通过key值查找一个ids对象 */</span></span><br><span class="line">	<span class="keyword">if</span> (ipcp == <span class="literal">NULL</span>) &#123; </span><br><span class="line">		<span class="keyword">if</span> (!(flg &amp; IPC_CREAT)) <span class="comment">/* IPC_CREAT:如果内核中不存在键值与key相等的共享内存,则新建一个共享内存 */</span></span><br><span class="line">			err = -ENOENT;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			err = ops-&gt;getnew(ns, params); <span class="comment">/* 新建一个共享内存 */</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (flg &amp; IPC_CREAT &amp;&amp; flg &amp; IPC_EXCL) <span class="comment">/* IPC_CREAT|IPC_EXCL:如果存在key值相同的共享内存则报错 */</span></span><br><span class="line">			err = -EEXIST;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			err = <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">if</span> (ops-&gt;more_checks)</span><br><span class="line">				err = ops-&gt;more_checks(ipcp, params);</span><br><span class="line">			<span class="keyword">if</span> (!err)</span><br><span class="line">				<span class="comment">/* ipc_check_perms returns the IPC id on success */</span></span><br><span class="line">				err = ipc_check_perms(ns, ipcp, ops, params); </span><br><span class="line">		&#125;</span><br><span class="line">		ipc_unlock(ipcp);</span><br><span class="line">	&#125;</span><br><span class="line">	up_write(&amp;ids-&gt;rwsem);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>前面这些可以说是 “共享内存”，“信号量”，“消息队列” 的通用部分，只是 <code>ipc_ops</code> 结构体的初始化不同</li>
<li>这里其实运用了面向对象的思想，用一系列函数和数据结构来描述 IPC 这个类（只是没法单独定义为一个类而已）</li>
<li>函数 <code>newseg</code> 的源码如下：（创建一个新的共享内存）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">newseg</span><span class="params">(struct ipc_namespace *ns, struct ipc_params *params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// *ns: 命名空间</span></span><br><span class="line">    <span class="comment">// *params: 指向包含key和msgflg的结构体(ipc_params)</span></span><br><span class="line">	<span class="keyword">key_t</span> key = params-&gt;key;</span><br><span class="line">	<span class="keyword">int</span> shmflg = params-&gt;flg;</span><br><span class="line">	<span class="keyword">size_t</span> size = params-&gt;u.size;</span><br><span class="line">	<span class="keyword">int</span> error;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">shmid_kernel</span> *<span class="title">shp</span>;</span></span><br><span class="line">	<span class="keyword">size_t</span> numpages = (size + PAGE_SIZE - <span class="number">1</span>) &gt;&gt; PAGE_SHIFT;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span>;</span></span><br><span class="line">	<span class="keyword">char</span> name[<span class="number">13</span>];</span><br><span class="line">	<span class="keyword">vm_flags_t</span> acctflag = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (size &lt; SHMMIN || size &gt; ns-&gt;shm_ctlmax)</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (numpages &lt;&lt; PAGE_SHIFT &lt; size)</span><br><span class="line">		<span class="keyword">return</span> -ENOSPC;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (ns-&gt;shm_tot + numpages &lt; ns-&gt;shm_tot ||</span><br><span class="line">			ns-&gt;shm_tot + numpages &gt; ns-&gt;shm_ctlall)</span><br><span class="line">		<span class="keyword">return</span> -ENOSPC;</span><br><span class="line"></span><br><span class="line">	shp = kvmalloc(<span class="keyword">sizeof</span>(*shp), GFP_KERNEL); <span class="comment">/* 为shmid_kernel分配内核堆空间 */</span></span><br><span class="line">	<span class="keyword">if</span> (unlikely(!shp))</span><br><span class="line">		<span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">	shp-&gt;shm_perm.key = key; <span class="comment">/* 设置shmid_kernel-&gt;shm_perm(参数) */</span></span><br><span class="line">	shp-&gt;shm_perm.mode = (shmflg &amp; S_IRWXUGO);</span><br><span class="line">	shp-&gt;mlock_user = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	shp-&gt;shm_perm.security = <span class="literal">NULL</span>;</span><br><span class="line">	error = security_shm_alloc(&amp;shp-&gt;shm_perm); <span class="comment">/* 将shmid_kernel添加到消息队列基数树中,并取回基数树id */</span></span><br><span class="line">	<span class="keyword">if</span> (error) &#123;</span><br><span class="line">		kvfree(shp);</span><br><span class="line">		<span class="keyword">return</span> error;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">sprintf</span>(name, <span class="string">&quot;SYSV%08x&quot;</span>, key); <span class="comment">/* PS:在GDB中使用&quot;vmmap&quot;命令就可以看到name */</span></span><br><span class="line">	<span class="keyword">if</span> (shmflg &amp; SHM_HUGETLB) &#123; <span class="comment">/* SHM_HUGETLB:大页面映射 */</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">hstate</span> *<span class="title">hs</span>;</span></span><br><span class="line">		<span class="keyword">size_t</span> hugesize;</span><br><span class="line"></span><br><span class="line">		hs = hstate_sizelog((shmflg &gt;&gt; SHM_HUGE_SHIFT) &amp; SHM_HUGE_MASK); <span class="comment">/* 生成状态日志 */</span></span><br><span class="line">		<span class="keyword">if</span> (!hs) &#123;</span><br><span class="line">			error = -EINVAL;</span><br><span class="line">			<span class="keyword">goto</span> no_file;</span><br><span class="line">		&#125;</span><br><span class="line">		hugesize = ALIGN(size, huge_page_size(hs)); <span class="comment">/* 对齐 */</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">/* hugetlb_file_setup applies strict accounting */</span></span><br><span class="line">		<span class="keyword">if</span> (shmflg &amp; SHM_NORESERVE)</span><br><span class="line">			acctflag = VM_NORESERVE;</span><br><span class="line">		file = hugetlb_file_setup(name, hugesize, acctflag,</span><br><span class="line">				  &amp;shp-&gt;mlock_user, HUGETLB_SHMFS_INODE,</span><br><span class="line">				(shmflg &gt;&gt; SHM_HUGE_SHIFT) &amp; SHM_HUGE_MASK); <span class="comment">/* 启用严格记账 */</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * Do not allow no accounting for OVERCOMMIT_NEVER, even</span></span><br><span class="line"><span class="comment">		 * if it&#x27;s asked for.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">if</span>  ((shmflg &amp; SHM_NORESERVE) &amp;&amp;</span><br><span class="line">				sysctl_overcommit_memory != OVERCOMMIT_NEVER)</span><br><span class="line">			acctflag = VM_NORESERVE;</span><br><span class="line">		file = shmem_kernel_file_setup(name, size, acctflag); <span class="comment">/* 会在shmem文件系统里面创建一个文件 */</span></span><br><span class="line">        <span class="comment">/* 会创建新的shmem文件对应的dentry和inode,并将它们两个关联起来,然后分配一个struct file结构来表示新的shmem文件 */</span></span><br><span class="line">	&#125;</span><br><span class="line">	error = PTR_ERR(file);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(file))</span><br><span class="line">		<span class="keyword">goto</span> no_file;</span><br><span class="line"></span><br><span class="line">	shp-&gt;shm_cprid = get_pid(task_tgid(current)); <span class="comment">/* 获取pid */</span></span><br><span class="line">	shp-&gt;shm_lprid = <span class="literal">NULL</span>;</span><br><span class="line">	shp-&gt;shm_atim = shp-&gt;shm_dtim = <span class="number">0</span>;</span><br><span class="line">	shp-&gt;shm_ctim = ktime_get_real_seconds();</span><br><span class="line">	shp-&gt;shm_segsz = size;</span><br><span class="line">	shp-&gt;shm_nattch = <span class="number">0</span>;</span><br><span class="line">	shp-&gt;shm_file = file;</span><br><span class="line">	shp-&gt;shm_creator = current;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* ipc_addid() locks shp upon success. */</span></span><br><span class="line">	error = ipc_addid(&amp;shm_ids(ns), &amp;shp-&gt;shm_perm, ns-&gt;shm_ctlmni); <span class="comment">/* 新创建的shmid_kernel结构挂到shm_ids里面的基数树上 */</span></span><br><span class="line">	<span class="keyword">if</span> (error &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">goto</span> no_id;</span><br><span class="line"></span><br><span class="line">	list_add(&amp;shp-&gt;shm_clist, &amp;current-&gt;sysvshm.shm_clist); <span class="comment">/* 插入shm链表 */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * shmid gets reported as &quot;inode#&quot; in /proc/pid/maps.</span></span><br><span class="line"><span class="comment">	 * proc-ps tools use this. Changing this will break them.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	file_inode(file)-&gt;i_ino = shp-&gt;shm_perm.id;</span><br><span class="line"></span><br><span class="line">	ns-&gt;shm_tot += numpages;</span><br><span class="line">	error = shp-&gt;shm_perm.id;</span><br><span class="line"></span><br><span class="line">	ipc_unlock_object(&amp;shp-&gt;shm_perm);</span><br><span class="line">	rcu_read_unlock();</span><br><span class="line">	<span class="keyword">return</span> error;</span><br><span class="line"></span><br><span class="line">no_id:</span><br><span class="line">	ipc_update_pid(&amp;shp-&gt;shm_cprid, <span class="literal">NULL</span>);</span><br><span class="line">	ipc_update_pid(&amp;shp-&gt;shm_lprid, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (is_file_hugepages(file) &amp;&amp; shp-&gt;mlock_user)</span><br><span class="line">		user_shm_unlock(size, shp-&gt;mlock_user);</span><br><span class="line">	fput(file);</span><br><span class="line">	ipc_rcu_putref(&amp;shp-&gt;shm_perm, shm_rcu_free); <span class="comment">/* 释放目标 */</span></span><br><span class="line">	<span class="keyword">return</span> error;</span><br><span class="line">no_file:</span><br><span class="line">	call_rcu(&amp;shp-&gt;shm_perm.rcu, shm_rcu_free);</span><br><span class="line">	<span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>接下来看一下 <code>shmem_kernel_file_setup</code> 生成文件的过程：（新创建的 <code>struct file</code> 则专门用于做内存映射）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct file *<span class="title">shmem_kernel_file_setup</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">loff_t</span> size, <span class="keyword">unsigned</span> <span class="keyword">long</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> __shmem_file_setup(shm_mnt, name, size, flags, S_PRIVATE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *__<span class="title">shmem_file_setup</span>(<span class="keyword">struct</span> <span class="title">vfsmount</span> *<span class="title">mnt</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">name</span>, <span class="title">loff_t</span> <span class="title">size</span>,</span></span><br><span class="line"><span class="class">				       <span class="title">unsigned</span> <span class="title">long</span> <span class="title">flags</span>, <span class="title">unsigned</span> <span class="title">int</span> <span class="title">i_flags</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">inode</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">res</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(mnt))</span><br><span class="line">		<span class="keyword">return</span> ERR_CAST(mnt);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (size &lt; <span class="number">0</span> || size &gt; MAX_LFS_FILESIZE)</span><br><span class="line">		<span class="keyword">return</span> ERR_PTR(-EINVAL);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (shmem_acct_size(flags, size))</span><br><span class="line">		<span class="keyword">return</span> ERR_PTR(-ENOMEM);</span><br><span class="line"></span><br><span class="line">	inode = shmem_get_inode(mnt-&gt;mnt_sb, <span class="literal">NULL</span>, S_IFREG | S_IRWXUGO, <span class="number">0</span>,</span><br><span class="line">				flags); <span class="comment">/* 分配一个inode并进行一系列的初始化设置 */</span></span><br><span class="line">	<span class="keyword">if</span> (unlikely(!inode)) &#123;</span><br><span class="line">		shmem_unacct_size(flags, size);</span><br><span class="line">		<span class="keyword">return</span> ERR_PTR(-ENOSPC);</span><br><span class="line">	&#125;</span><br><span class="line">	inode-&gt;i_flags |= i_flags;</span><br><span class="line">	inode-&gt;i_size = size;</span><br><span class="line">	clear_nlink(inode);	<span class="comment">/* It is unlinked */</span></span><br><span class="line">	res = ERR_PTR(ramfs_nommu_expand_for_mapping(inode, size));</span><br><span class="line">	<span class="keyword">if</span> (!IS_ERR(res))</span><br><span class="line">		res = alloc_file_pseudo(inode, mnt, name, O_RDWR,</span><br><span class="line">				&amp;shmem_file_operations); <span class="comment">/* 基于inode分配一个file(伪) */</span></span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(res))</span><br><span class="line">		iput(inode);</span><br><span class="line">	<span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>除了生成新的一个文件（这并不是真正的文件，而是 <strong>保存在内存上</strong> 的抽象文件，这也是 shm 和 mmap 根本上的不同点），<code>newseg</code> 还会在内核堆空间中创建一个重要的结构体</li>
<li>结构体 <code>shmid_kernel</code>，用于管理 <code>shmget</code> 生成的共享内存段：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">shmid_kernel</span> /* <span class="title">private</span> <span class="title">to</span> <span class="title">the</span> <span class="title">kernel</span> */</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kern_ipc_perm</span>	<span class="title">shm_perm</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">file</span>		*<span class="title">shm_file</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		shm_nattch;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		shm_segsz;</span><br><span class="line">	<span class="keyword">time64_t</span>		shm_atim;</span><br><span class="line">	<span class="keyword">time64_t</span>		shm_dtim;</span><br><span class="line">	<span class="keyword">time64_t</span>		shm_ctim;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pid</span>		*<span class="title">shm_cprid</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pid</span>		*<span class="title">shm_lprid</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_struct</span>	*<span class="title">mlock_user</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* The task created the shm object.  NULL if the task is dead. */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span>	*<span class="title">shm_creator</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">shm_clist</span>;</span>	<span class="comment">/* list by creator */</span></span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>shmat</code> 和 <code>shmdt</code> 都依靠另一个重要的结构体 - <code>shm_file_data</code>：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">shm_file_data</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> id;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ipc_namespace</span> *<span class="title">ns</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">vm_operations_struct</span> *<span class="title">vm_ops</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>映射共享内存的核心函数 <code>shmat</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x7ffff7ee1199</span> &lt;shmat+<span class="number">9</span>&gt;        syscall  &lt;SYS_shmat&gt;</span><br><span class="line">       shmid: <span class="number">0x24</span></span><br><span class="line">       shmaddr: <span class="number">0x0</span></span><br><span class="line">       shmflg: <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>shmat</code> 底层会调用 <code>do_shmat</code>：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">do_shmat</span><span class="params">(<span class="keyword">int</span> shmid, <span class="keyword">char</span> __user *shmaddr, <span class="keyword">int</span> shmflg,</span></span></span><br><span class="line"><span class="params"><span class="function">	      ulong *raddr, <span class="keyword">unsigned</span> <span class="keyword">long</span> shmlba)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">shmid_kernel</span> *<span class="title">shp</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> addr = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)shmaddr;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> size;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span>, *<span class="title">base</span>;</span></span><br><span class="line">	<span class="keyword">int</span>    err;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> flags = MAP_SHARED;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> prot;</span><br><span class="line">	<span class="keyword">int</span> acc_mode;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ipc_namespace</span> *<span class="title">ns</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">shm_file_data</span> *<span class="title">sfd</span>;</span></span><br><span class="line">	<span class="keyword">int</span> f_flags;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> populate = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	err = -EINVAL;</span><br><span class="line">	<span class="keyword">if</span> (shmid &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (addr) &#123; <span class="comment">/* shmaddr不为空(不常用) */</span></span><br><span class="line">		<span class="keyword">if</span> (addr &amp; (shmlba - <span class="number">1</span>)) &#123;</span><br><span class="line">			<span class="keyword">if</span> (shmflg &amp; SHM_RND) &#123;</span><br><span class="line">				addr &amp;= ~(shmlba - <span class="number">1</span>);  <span class="comment">/* round down */</span></span><br><span class="line"></span><br><span class="line">				<span class="comment">/*</span></span><br><span class="line"><span class="comment">				 * Ensure that the round-down is non-nil</span></span><br><span class="line"><span class="comment">				 * when remapping. This can happen for</span></span><br><span class="line"><span class="comment">				 * cases when addr &lt; shmlba.</span></span><br><span class="line"><span class="comment">				 */</span></span><br><span class="line">				<span class="keyword">if</span> (!addr &amp;&amp; (shmflg &amp; SHM_REMAP))</span><br><span class="line">					<span class="keyword">goto</span> out;</span><br><span class="line">			&#125; <span class="keyword">else</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __ARCH_FORCE_SHMLBA</span></span><br><span class="line">				<span class="keyword">if</span> (addr &amp; ~PAGE_MASK)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">					<span class="keyword">goto</span> out;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		flags |= MAP_FIXED;</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> ((shmflg &amp; SHM_REMAP)) </span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (shmflg &amp; SHM_RDONLY) &#123; <span class="comment">/* SHM_RDONLY:为只读模式 */</span></span><br><span class="line">		prot = PROT_READ;</span><br><span class="line">		acc_mode = S_IRUGO;</span><br><span class="line">		f_flags = O_RDONLY;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		prot = PROT_READ | PROT_WRITE;</span><br><span class="line">		acc_mode = S_IRUGO | S_IWUGO;</span><br><span class="line">		f_flags = O_RDWR;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (shmflg &amp; SHM_EXEC) &#123; <span class="comment">/* SHM_EXEC:指定对共享内存段的执行权限 */</span></span><br><span class="line">		prot |= PROT_EXEC;</span><br><span class="line">		acc_mode |= S_IXUGO;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * We cannot rely on the fs check since SYSV IPC does have an</span></span><br><span class="line"><span class="comment">	 * additional creator id...</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	ns = current-&gt;nsproxy-&gt;ipc_ns;</span><br><span class="line">	rcu_read_lock();</span><br><span class="line">	shp = shm_obtain_object_check(ns, shmid); <span class="comment">/* 通过共享内存的shmid,在基数树中找到对应的struct shmid_kernel结构 */</span></span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(shp)) &#123;</span><br><span class="line">		err = PTR_ERR(shp);</span><br><span class="line">		<span class="keyword">goto</span> out_unlock;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = -EACCES;</span><br><span class="line">	<span class="keyword">if</span> (ipcperms(ns, &amp;shp-&gt;shm_perm, acc_mode))</span><br><span class="line">		<span class="keyword">goto</span> out_unlock;</span><br><span class="line"></span><br><span class="line">	err = security_shm_shmat(&amp;shp-&gt;shm_perm, shmaddr, shmflg);</span><br><span class="line">	<span class="keyword">if</span> (err)</span><br><span class="line">		<span class="keyword">goto</span> out_unlock;</span><br><span class="line"></span><br><span class="line">	ipc_lock_object(&amp;shp-&gt;shm_perm);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* check if shm_destroy() is tearing down shp */</span></span><br><span class="line">	<span class="keyword">if</span> (!ipc_valid_object(&amp;shp-&gt;shm_perm)) &#123;</span><br><span class="line">		ipc_unlock_object(&amp;shp-&gt;shm_perm);</span><br><span class="line">		err = -EIDRM;</span><br><span class="line">		<span class="keyword">goto</span> out_unlock;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * We need to take a reference to the real shm file to prevent the</span></span><br><span class="line"><span class="comment">	 * pointer from becoming stale in cases where the lifetime of the outer</span></span><br><span class="line"><span class="comment">	 * file extends beyond that of the shm segment.  It&#x27;s not usually</span></span><br><span class="line"><span class="comment">	 * possible, but it can happen during remap_file_pages() emulation as</span></span><br><span class="line"><span class="comment">	 * that unmaps the memory, then does -&gt;mmap() via file reference only.</span></span><br><span class="line"><span class="comment">	 * We&#x27;ll deny the -&gt;mmap() if the shm segment was since removed, but to</span></span><br><span class="line"><span class="comment">	 * detect shm ID reuse we need to compare the file pointers.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	base = get_file(shp-&gt;shm_file); <span class="comment">/* 找到shmem上的内存文件base */</span></span><br><span class="line">	shp-&gt;shm_nattch++;</span><br><span class="line">	size = i_size_read(file_inode(base)); <span class="comment">/* 获取shm_file的size */</span></span><br><span class="line">	ipc_unlock_object(&amp;shp-&gt;shm_perm);</span><br><span class="line">	rcu_read_unlock();</span><br><span class="line"></span><br><span class="line">	err = -ENOMEM;</span><br><span class="line">	sfd = kzalloc(<span class="keyword">sizeof</span>(*sfd), GFP_KERNEL); <span class="comment">/* 为shm_file_data分配内存 */</span></span><br><span class="line">	<span class="keyword">if</span> (!sfd) &#123;</span><br><span class="line">		fput(base);</span><br><span class="line">		<span class="keyword">goto</span> out_nattch;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	file = alloc_file_clone(base, f_flags,</span><br><span class="line">			  is_file_hugepages(base) ?</span><br><span class="line">				&amp;shm_file_operations_huge :</span><br><span class="line">				&amp;shm_file_operations); </span><br><span class="line">    <span class="comment">/* 拷贝一个struct file实例,同样将其private_data字段的值设置为inode-&gt;i_pipe的值 */</span></span><br><span class="line">	err = PTR_ERR(file);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(file)) &#123;</span><br><span class="line">		kfree(sfd);</span><br><span class="line">		fput(base);</span><br><span class="line">		<span class="keyword">goto</span> out_nattch;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	sfd-&gt;id = shp-&gt;shm_perm.id;</span><br><span class="line">	sfd-&gt;ns = get_ipc_ns(ns);</span><br><span class="line">	sfd-&gt;file = base;</span><br><span class="line">	sfd-&gt;vm_ops = <span class="literal">NULL</span>;</span><br><span class="line">	file-&gt;private_data = sfd;</span><br><span class="line"></span><br><span class="line">	err = security_mmap_file(file, prot, flags);</span><br><span class="line">	<span class="keyword">if</span> (err)</span><br><span class="line">		<span class="keyword">goto</span> out_fput;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (down_write_killable(&amp;current-&gt;mm-&gt;mmap_sem)) &#123;</span><br><span class="line">		err = -EINTR;</span><br><span class="line">		<span class="keyword">goto</span> out_fput;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (addr &amp;&amp; !(shmflg &amp; SHM_REMAP)) &#123;</span><br><span class="line">		err = -EINVAL;</span><br><span class="line">		<span class="keyword">if</span> (addr + size &lt; addr)</span><br><span class="line">			<span class="keyword">goto</span> invalid;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (find_vma_intersection(current-&gt;mm, addr, addr + size))</span><br><span class="line">			<span class="keyword">goto</span> invalid;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	addr = do_mmap_pgoff(file, addr, size, prot, flags, <span class="number">0</span>, &amp;populate, <span class="literal">NULL</span>); <span class="comment">/* 内存分配核心函数(在mmap的底层也会调用) */</span></span><br><span class="line">	*raddr = addr;</span><br><span class="line">	err = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR_VALUE(addr))</span><br><span class="line">		err = (<span class="keyword">long</span>)addr;</span><br><span class="line">invalid:</span><br><span class="line">	up_write(&amp;current-&gt;mm-&gt;mmap_sem);</span><br><span class="line">	<span class="keyword">if</span> (populate)</span><br><span class="line">		mm_populate(addr, populate);</span><br><span class="line"></span><br><span class="line">out_fput:</span><br><span class="line">	fput(file);</span><br><span class="line"></span><br><span class="line">out_nattch:</span><br><span class="line">	down_write(&amp;shm_ids(ns).rwsem);</span><br><span class="line">	shp = shm_lock(ns, shmid);</span><br><span class="line">	shp-&gt;shm_nattch--;</span><br><span class="line">	<span class="keyword">if</span> (shm_may_destroy(ns, shp))</span><br><span class="line">		shm_destroy(ns, shp);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		shm_unlock(shp);</span><br><span class="line">	up_write(&amp;shm_ids(ns).rwsem);</span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">out_unlock:</span><br><span class="line">	rcu_read_unlock();</span><br><span class="line">out:</span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>其实 <code>do_shmat</code> 底层申请内存的部分和 <code>mmap</code> 一样，至于 <code>do_mmap_pgoff</code> 已经在之前的博客中已经分析过了</li>
<li>PS：因为 <code>do_mmap_pgoff</code> 的底层还是调用了 <code>do_mmap</code>，所以可以通过 <code>do_munmap</code> 释放该内存，函数 <code>shmdt</code> 底层就是利用了这一点</li>
</ul>
<p>解除共享内存的核心函数 <code>shmdt</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x7ffff7ee11c9</span> &lt;shmdt+<span class="number">9</span>&gt;        syscall  &lt;SYS_shmdt&gt;</span><br><span class="line">       shmaddr: <span class="number">0x7ffff7ffb000</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>shmdt</code> 底层会调用 <code>ksys_shmdt</code>：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">ksys_shmdt</span><span class="params">(<span class="keyword">char</span> __user *shmaddr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">mm</span> =</span> current-&gt;mm;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">vm_area_struct</span> *<span class="title">vma</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> addr = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)shmaddr;</span><br><span class="line">	<span class="keyword">int</span> retval = -EINVAL;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_MMU</span></span><br><span class="line">	<span class="keyword">loff_t</span> size = <span class="number">0</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">vm_area_struct</span> *<span class="title">next</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (addr &amp; ~PAGE_MASK)</span><br><span class="line">		<span class="keyword">return</span> retval;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (down_write_killable(&amp;mm-&gt;mmap_sem))</span><br><span class="line">		<span class="keyword">return</span> -EINTR;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * This function tries to be smart and unmap shm segments that</span></span><br><span class="line"><span class="comment">	 * were modified by partial mlock or munmap calls:</span></span><br><span class="line"><span class="comment">	 * - It first determines the size of the shm segment that should be</span></span><br><span class="line"><span class="comment">	 *   unmapped: It searches for a vma that is backed by shm and that</span></span><br><span class="line"><span class="comment">	 *   started at address shmaddr. It records it&#x27;s size and then unmaps</span></span><br><span class="line"><span class="comment">	 *   it.</span></span><br><span class="line"><span class="comment">	 * - Then it unmaps all shm vmas that started at shmaddr and that</span></span><br><span class="line"><span class="comment">	 *   are within the initially determined size and that are from the</span></span><br><span class="line"><span class="comment">	 *   same shm segment from which we determined the size.</span></span><br><span class="line"><span class="comment">	 * Errors from do_munmap are ignored: the function only fails if</span></span><br><span class="line"><span class="comment">	 * it&#x27;s called with invalid parameters or if it&#x27;s called to unmap</span></span><br><span class="line"><span class="comment">	 * a part of a vma. Both calls in this function are for full vmas,</span></span><br><span class="line"><span class="comment">	 * the parameters are directly copied from the vma itself and always</span></span><br><span class="line"><span class="comment">	 * valid - therefore do_munmap cannot fail. (famous last words?)</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * If it had been mremap()&#x27;d, the starting address would not</span></span><br><span class="line"><span class="comment">	 * match the usual checks anyway. So assume all vma&#x27;s are</span></span><br><span class="line"><span class="comment">	 * above the starting address given.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	vma = find_vma(mm, addr); <span class="comment">/* 根据一个属于某个进程的虚拟地址,找到其所属的进程虚拟区间,并返回相应的vma_area_struct结构体指针 */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_MMU</span></span><br><span class="line">	<span class="keyword">while</span> (vma) &#123;</span><br><span class="line">		next = vma-&gt;vm_next;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * Check if the starting address would match, i.e. it&#x27;s</span></span><br><span class="line"><span class="comment">		 * a fragment created by mprotect() and/or munmap(), or it</span></span><br><span class="line"><span class="comment">		 * otherwise it starts at this address with no hassles.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">if</span> ((vma-&gt;vm_ops == &amp;shm_vm_ops) &amp;&amp;</span><br><span class="line">			(vma-&gt;vm_start - addr)/PAGE_SIZE == vma-&gt;vm_pgoff) &#123;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * Record the file of the shm segment being</span></span><br><span class="line"><span class="comment">			 * unmapped.  With mremap(), someone could place</span></span><br><span class="line"><span class="comment">			 * page from another segment but with equal offsets</span></span><br><span class="line"><span class="comment">			 * in the range we are unmapping.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			file = vma-&gt;vm_file;</span><br><span class="line">			size = i_size_read(file_inode(vma-&gt;vm_file));</span><br><span class="line">			do_munmap(mm, vma-&gt;vm_start, vma-&gt;vm_end - vma-&gt;vm_start, <span class="literal">NULL</span>); <span class="comment">/* 释放调用do_mmap生成的内存空间 */</span></span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * We discovered the size of the shm segment, so</span></span><br><span class="line"><span class="comment">			 * break out of here and fall through to the next</span></span><br><span class="line"><span class="comment">			 * loop that uses the size information to stop</span></span><br><span class="line"><span class="comment">			 * searching for matching vma&#x27;s.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			retval = <span class="number">0</span>;</span><br><span class="line">			vma = next;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		vma = next;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * We need look no further than the maximum address a fragment</span></span><br><span class="line"><span class="comment">	 * could possibly have landed at. Also cast things to loff_t to</span></span><br><span class="line"><span class="comment">	 * prevent overflows and make comparisons vs. equal-width types.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	size = PAGE_ALIGN(size);</span><br><span class="line">	<span class="keyword">while</span> (vma &amp;&amp; (<span class="keyword">loff_t</span>)(vma-&gt;vm_end - addr) &lt;= size) &#123;</span><br><span class="line">		next = vma-&gt;vm_next;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* finding a matching vma now does not alter retval */</span></span><br><span class="line">		<span class="keyword">if</span> ((vma-&gt;vm_ops == &amp;shm_vm_ops) &amp;&amp;</span><br><span class="line">		    ((vma-&gt;vm_start - addr)/PAGE_SIZE == vma-&gt;vm_pgoff) &amp;&amp;</span><br><span class="line">		    (vma-&gt;vm_file == file))</span><br><span class="line">			do_munmap(mm, vma-&gt;vm_start, vma-&gt;vm_end - vma-&gt;vm_start, <span class="literal">NULL</span>); <span class="comment">/* 释放调用do_mmap生成的内存空间 */</span></span><br><span class="line">		vma = next;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span>	<span class="comment">/* CONFIG_MMU */</span></span></span><br><span class="line">	<span class="comment">/* under NOMMU conditions, the exact address to be destroyed must be</span></span><br><span class="line"><span class="comment">	 * given</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (vma &amp;&amp; vma-&gt;vm_start == addr &amp;&amp; vma-&gt;vm_ops == &amp;shm_vm_ops) &#123;</span><br><span class="line">		do_munmap(mm, vma-&gt;vm_start, vma-&gt;vm_end - vma-&gt;vm_start, <span class="literal">NULL</span>); <span class="comment">/* 释放调用do_mmap生成的内存空间 */</span></span><br><span class="line">		retval = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	up_write(&amp;mm-&gt;mmap_sem);</span><br><span class="line">	<span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>内核开发人员已经把遍历释放的过程写好注释了，这些操作要么为了安全，要么为了效率</li>
</ul>
<p><strong>mmap VS shm</strong></p>
<ul>
<li>mmap 的机制：<ul>
<li>就是在磁盘上建立一个文件，每个进程存储器里面，单独开辟一个空间来进行映射，如果多进程的话，那么不会对实际的内存消耗太大</li>
<li>数据保存到实际硬盘，实际存储并没有反映到主存上（不耗内存，但速度慢）</li>
</ul>
</li>
<li>shm 的机制：<ul>
<li>每个进程的共享内存都直接映射到内存里面</li>
<li>数据保存到内存中，实际的储存量直接反映到主存上（速度快，但耗内存）</li>
</ul>
</li>
</ul>
<p>令我好奇的一点是：不管是 <code>shm</code> 还是 <code>mmap</code> 底层都要依靠文件（匿名的 <code>mmap</code> 底层也会使用 <code>/dev/zero</code> 文件）</p>
<ul>
<li>mmap 直接使用文件来存储数据</li>
<li>shm 利用文件来完成映射</li>
</ul>
<p>另外匿名管道也会使用 <code>alloc_file_pseudo</code> 来生成一个“抽象文件”，并使用它进行数据传输</p>
<ul>
<li>其实这也可以理解，因为 <code>file</code> 中管理的 <code>inode</code> 直接和内存相关，并且 <code>file-&gt;f_op</code> 中还会提供许多与驱动程序相关的内核函数（例如：在 <code>do_mmap_pgoff</code> 的调用链中会使用 <code>file-&gt;f_op-&gt;get_unmapped_area</code>）</li>
</ul>
<p><strong>POSIX 共享内存</strong></p>
<p>传统的 systemV 的 shm 共享内存有个升级版的 API：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">shm_open</span><span class="params">(struct vm_area_struct *vma)</span></span>; <span class="comment">/* 在/dev/shm/下建立一个文件,作为该进程的共享内存 */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">shm_close</span><span class="params">(struct vm_area_struct *vma)</span></span>; <span class="comment">/* 释放目标共享内存 */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">shm_destroy</span><span class="params">(struct ipc_namespace *ns, struct shmid_kernel *shp)</span></span>; <span class="comment">/* 销毁/dev/shm/中对应的文件 */</span></span><br></pre></td></tr></table></figure>
<p><code>/dev/shm/</code> 是一个使用就是 tmpfs 文件系统的设备，可以理解为只存在于内存上的文件</p>

    </div>

    
    
    

      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/Principles/" rel="tag"><i class="fa fa-tag"></i> Principles</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/09/21/Principles%EF%BC%9A%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98mmap%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/" rel="prev" title="Principles：共享内存mmap底层原理">
      <i class="fa fa-chevron-left"></i> Principles：共享内存mmap底层原理
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/09/30/%E5%A0%86%E6%BA%A2%E5%87%BA+Tcache%20Attack/" rel="next" title="堆溢出+Tcache Attack">
      堆溢出+Tcache Attack <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yhellow"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">yhellow</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">329</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">170</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yhellow</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">4.9m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">74:32</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
