<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="Networking 实验目标：  了解 Linux 内核网络体系结构 使用数据包过滤器或防火墙，学习 IP 数据包管理技能 熟悉如何在 Linux 内核级别使用套接字  互联网的发展导致网络应用的指数级增长，从而增加了操作系统网络子系统的速度和生产力要求  网络子系统不是操作系统内核的基本组件（Linux 内核可以在没有网络支持的情况下编译） 然而，计算系统（甚至是嵌入式设备）不太可能具有非网络">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux-Lab8-Networking">
<meta property="og:url" content="http://example.com/2022/10/21/Linux-Lab8-Networking/index.html">
<meta property="og:site_name" content="Pwn进你的心">
<meta property="og:description" content="Networking 实验目标：  了解 Linux 内核网络体系结构 使用数据包过滤器或防火墙，学习 IP 数据包管理技能 熟悉如何在 Linux 内核级别使用套接字  互联网的发展导致网络应用的指数级增长，从而增加了操作系统网络子系统的速度和生产力要求  网络子系统不是操作系统内核的基本组件（Linux 内核可以在没有网络支持的情况下编译） 然而，计算系统（甚至是嵌入式设备）不太可能具有非网络">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2022-10-21T12:44:35.000Z">
<meta property="article:modified_time" content="2022-10-21T12:45:26.248Z">
<meta property="article:author" content="yhellow">
<meta property="article:tag" content="labs">
<meta property="article:tag" content="Kernel">
<meta property="article:tag" content="Linux">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/2022/10/21/Linux-Lab8-Networking/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>Linux-Lab8-Networking | Pwn进你的心</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Pwn进你的心</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/21/Linux-Lab8-Networking/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Linux-Lab8-Networking
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-10-21 20:44:35 / Modified: 20:45:26" itemprop="dateCreated datePublished" datetime="2022-10-21T20:44:35+08:00">2022-10-21</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>22k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>20 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p><strong>Networking</strong></p>
<p>实验目标：</p>
<ul>
<li>了解 Linux 内核网络体系结构</li>
<li>使用数据包过滤器或防火墙，学习 IP 数据包管理技能</li>
<li>熟悉如何在 Linux 内核级别使用套接字</li>
</ul>
<p>互联网的发展导致网络应用的指数级增长，从而增加了操作系统网络子系统的速度和生产力要求</p>
<ul>
<li>网络子系统不是操作系统内核的基本组件（Linux 内核可以在没有网络支持的情况下编译）</li>
<li>然而，计算系统（甚至是嵌入式设备）不太可能具有非网络操作系统</li>
<li>现代操作系统使用 TCP/IP 堆栈，由内核实现传输层的协议，而应用层协议通常在用户空间（HTTP，FTP，SSH等）中实现</li>
</ul>
<p><strong>Networking in user space</strong></p>
<p>在用户空间中，网络通信的抽象是套接字 socket</p>
<p>套接字 socket 抽象了一个通信通道，是基于内核的 TCP/IP 堆栈交互接口（其实 TCP/IP 的底层就是发包，通过发包实现计算机网络之间的交互，而 socket 让发包变得更简单了）</p>
<p><strong>Networking in Linux kernel</strong></p>
<p>Linux 内核为处理网络数据包提供了三种基本结构：</p>
<p><code>struct socket</code>：</p>
<ul>
<li>一个非常接近用户空间的抽象，即用于编程网络应用的 BSD 套接字</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">socket</span> &#123;</span></span><br><span class="line">	socket_state		state; <span class="comment">/* 表示socket所处的状态 */</span></span><br><span class="line">	<span class="keyword">short</span>			type; <span class="comment">/* 该socket的类型 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		flags; <span class="comment">/* 标志位 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">socket_wq</span>	*<span class="title">wq</span>;</span> <span class="comment">/* 等待该socket的进程队列和异步通知队列 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">file</span>		*<span class="title">file</span>;</span> <span class="comment">/* 与之关联的file */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sock</span>		*<span class="title">sk</span>;</span> <span class="comment">/* 与之关联的sock */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">proto_ops</span>	*<span class="title">ops</span>;</span> <span class="comment">/* 协议相关的一组操作集 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>相关联的 API 如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* socket create/delete */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sock_create</span><span class="params">(<span class="keyword">int</span> family, <span class="keyword">int</span> type, <span class="keyword">int</span> protocol, struct socket **res)</span></span>; <span class="comment">/* 在系统调用socket()执行后创建一个socket结构体 */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sock_create_kern</span><span class="params">(struct net *net, <span class="keyword">int</span> family, <span class="keyword">int</span> type, <span class="keyword">int</span> protocol, struct socket **res)</span></span>; <span class="comment">/* 创建一个内核套接字 */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sock_create_lite</span><span class="params">(<span class="keyword">int</span> family, <span class="keyword">int</span> type, <span class="keyword">int</span> protocol, struct socket **res)</span></span>; <span class="comment">/* 创建不进行参数健全性检查的内核套接字 */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sock_release</span><span class="params">(struct socket *sock)</span></span>; <span class="comment">/* 关闭socket并释放关联的资源 */</span></span><br></pre></td></tr></table></figure>
<p><code>struct sock</code>：</p>
<ul>
<li>在 Linux 术语中是套接字的网络表示形式，又称为 INET 套接字</li>
<li>该结构用于存储有关连接状态的信息</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sock</span> &#123;</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Now struct inet_timewait_sock also uses sock_common, so please just</span></span><br><span class="line"><span class="comment">	 * don&#x27;t add nothing before this first member (__sk_common) --acme</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sock_common</span>	__<span class="title">sk_common</span>;</span></span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">        </span><br><span class="line">	<span class="keyword">socket_lock_t</span>		sk_lock;</span><br><span class="line">	<span class="keyword">atomic_t</span>		sk_drops;</span><br><span class="line">	<span class="keyword">int</span>			sk_rcvlowat;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff_head</span>	<span class="title">sk_error_queue</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff_head</span>	<span class="title">sk_receive_queue</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">		<span class="keyword">atomic_t</span>	rmem_alloc;</span><br><span class="line">		<span class="keyword">int</span>		len;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span>	*<span class="title">head</span>;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span>	*<span class="title">tail</span>;</span></span><br><span class="line">	&#125; sk_backlog;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> sk_rmem_alloc sk_backlog.rmem_alloc</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span>			sk_forward_alloc;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NET_RX_BUSY_POLL</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		sk_ll_usec;</span><br><span class="line">	<span class="comment">/* ===== mostly read cache line ===== */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		sk_napi_id;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">int</span>			sk_rcvbuf;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sk_filter</span> __<span class="title">rcu</span>	*<span class="title">sk_filter</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">socket_wq</span> __<span class="title">rcu</span>	*<span class="title">sk_wq</span>;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">socket_wq</span>	*<span class="title">sk_wq_raw</span>;</span></span><br><span class="line">	&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_XFRM</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">xfrm_policy</span> __<span class="title">rcu</span> *<span class="title">sk_policy</span>[2];</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dst_entry</span>	*<span class="title">sk_rx_dst</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dst_entry</span> __<span class="title">rcu</span>	*<span class="title">sk_dst_cache</span>;</span></span><br><span class="line">	<span class="keyword">atomic_t</span>		sk_omem_alloc;</span><br><span class="line">	<span class="keyword">int</span>			sk_sndbuf;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* ===== cache line for TX ===== */</span></span><br><span class="line">	<span class="keyword">int</span>			sk_wmem_queued;</span><br><span class="line">	<span class="keyword">refcount_t</span>		sk_wmem_alloc;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		sk_tsq_flags;</span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span>	*<span class="title">sk_send_head</span>;</span> <span class="comment">/* 是用于数据传输的sk_buff列表 */</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">rb_root</span>	<span class="title">tcp_rtx_queue</span>;</span></span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff_head</span>	<span class="title">sk_write_queue</span>;</span></span><br><span class="line">	__s32			sk_peek_off;</span><br><span class="line">	<span class="keyword">int</span>			sk_write_pending;</span><br><span class="line">	__u32			sk_dst_pending_confirm;</span><br><span class="line">	u32			sk_pacing_status; <span class="comment">/* see enum sk_pacing */</span></span><br><span class="line">	<span class="keyword">long</span>			sk_sndtimeo;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">timer_list</span>	<span class="title">sk_timer</span>;</span></span><br><span class="line">	__u32			sk_priority;</span><br><span class="line">	__u32			sk_mark;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		sk_pacing_rate; <span class="comment">/* bytes per second */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		sk_max_pacing_rate;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page_frag</span>	<span class="title">sk_frag</span>;</span></span><br><span class="line">	<span class="keyword">netdev_features_t</span>	sk_route_caps;</span><br><span class="line">	<span class="keyword">netdev_features_t</span>	sk_route_nocaps;</span><br><span class="line">	<span class="keyword">netdev_features_t</span>	sk_route_forced_caps;</span><br><span class="line">	<span class="keyword">int</span>			sk_gso_type;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		sk_gso_max_size;</span><br><span class="line">	<span class="keyword">gfp_t</span>			sk_allocation;</span><br><span class="line">	__u32			sk_txhash;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Because of non atomicity rules, all</span></span><br><span class="line"><span class="comment">	 * changes are protected by socket lock.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		__sk_flags_offset[<span class="number">0</span>];</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		sk_padding : <span class="number">1</span>,</span><br><span class="line">				sk_kern_sock : <span class="number">1</span>,</span><br><span class="line">				sk_no_check_tx : <span class="number">1</span>,</span><br><span class="line">				sk_no_check_rx : <span class="number">1</span>,</span><br><span class="line">				sk_userlocks : <span class="number">4</span>, </span><br><span class="line">				sk_protocol  : <span class="number">8</span>, <span class="comment">/* 套接字使用的协议类型 */</span></span><br><span class="line">				sk_type      : <span class="number">16</span>; <span class="comment">/* 套接字类型(SOCK_STREAM,SOCK_DGRAM等) */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SK_PROTOCOL_MAX U8_MAX</span></span><br><span class="line">	u16			sk_gso_max_segs;</span><br><span class="line">	u8			sk_pacing_shift;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>	        sk_lingertime;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">proto</span>		*<span class="title">sk_prot_creator</span>;</span></span><br><span class="line">	<span class="keyword">rwlock_t</span>		sk_callback_lock;</span><br><span class="line">	<span class="keyword">int</span>			sk_err,</span><br><span class="line">				sk_err_soft;</span><br><span class="line">	u32			sk_ack_backlog;</span><br><span class="line">	u32			sk_max_ack_backlog;</span><br><span class="line">	<span class="keyword">kuid_t</span>			sk_uid;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pid</span>		*<span class="title">sk_peer_pid</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span>	*<span class="title">sk_peer_cred</span>;</span></span><br><span class="line">	<span class="keyword">long</span>			sk_rcvtimeo;</span><br><span class="line">	<span class="keyword">ktime_t</span>			sk_stamp;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> BITS_PER_LONG==32</span></span><br><span class="line">	<span class="keyword">seqlock_t</span>		sk_stamp_seq;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	u16			sk_tsflags;</span><br><span class="line">	u8			sk_shutdown;</span><br><span class="line">	u32			sk_tskey;</span><br><span class="line">	<span class="keyword">atomic_t</span>		sk_zckey;</span><br><span class="line"></span><br><span class="line">	u8			sk_clockid;</span><br><span class="line">	u8			sk_txtime_deadline_mode : <span class="number">1</span>,</span><br><span class="line">				sk_txtime_report_errors : <span class="number">1</span>,</span><br><span class="line">				sk_txtime_unused : <span class="number">6</span>;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">socket</span>		*<span class="title">sk_socket</span>;</span> <span class="comment">/* 容纳它的BSD socket */</span></span><br><span class="line">	<span class="keyword">void</span>			*sk_user_data;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line">	<span class="keyword">void</span>			*sk_security;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sock_cgroup_data</span>	<span class="title">sk_cgrp_data</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mem_cgroup</span>	*<span class="title">sk_memcg</span>;</span></span><br><span class="line">	<span class="keyword">void</span>			(*sk_state_change)(struct sock *sk);</span><br><span class="line">	<span class="keyword">void</span>			(*sk_data_ready)(struct sock *sk);</span><br><span class="line">	<span class="keyword">void</span>			(*sk_write_space)(struct sock *sk);</span><br><span class="line">	<span class="keyword">void</span>			(*sk_error_report)(struct sock *sk);</span><br><span class="line">	<span class="keyword">int</span>			(*sk_backlog_rcv)(struct sock *sk,</span><br><span class="line">						  struct sk_buff *skb);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SOCK_VALIDATE_XMIT</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span>*		(*<span class="title">sk_validate_xmit_skb</span>)(<span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk</span>,</span></span><br><span class="line"><span class="class">							<span class="keyword">struct</span> <span class="title">net_device</span> *<span class="title">dev</span>,</span></span><br><span class="line"><span class="class">							<span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">skb</span>);</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">void</span>                    (*sk_destruct)(struct sock *sk);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sock_reuseport</span> __<span class="title">rcu</span>	*<span class="title">sk_reuseport_cb</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span>		<span class="title">sk_rcu</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>相关 API 如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* sending/receiving messages */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sock_recvmsg</span><span class="params">(struct socket *sock, struct msghdr *msg, <span class="keyword">int</span> flags)</span></span>; <span class="comment">/* 从套接字socket(内核空间)接收消息 */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sock_sendmsg</span><span class="params">(struct socket *sock, struct msghdr *msg)</span></span>; <span class="comment">/* 利用套接字socket(内核空间)发送消息 */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">kernel_recvmsg</span><span class="params">(struct socket *sock, struct msghdr *msg, struct kvec *vec, <span class="keyword">size_t</span> num, <span class="keyword">size_t</span> size, <span class="keyword">int</span> flags)</span></span>; <span class="comment">/* 从套接字socket(内核空间)接收消息 */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">kernel_sendmsg</span><span class="params">(struct socket *sock, struct msghdr *msg, struct kvec *vec, <span class="keyword">size_t</span> num, <span class="keyword">size_t</span> size)</span></span>; <span class="comment">/* 利用套接字socket(内核空间)发送消息 */</span></span><br></pre></td></tr></table></figure>
<p><code>struct sk_buff</code>：</p>
<ul>
<li>用于描述一个网络数据包及其状态</li>
<li>该结构是在用户空间或网络接口接收到内核数据包时创建的</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">			<span class="comment">/* These two members must be first. */</span></span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span>		*<span class="title">next</span>;</span> <span class="comment">/* 用于链接sk_buff的链表 */</span></span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span>		*<span class="title">prev</span>;</span></span><br><span class="line"></span><br><span class="line">			<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">				<span class="class"><span class="keyword">struct</span> <span class="title">net_device</span>	*<span class="title">dev</span>;</span> <span class="comment">/* 发送或接收缓冲区的网络设备 */</span></span><br><span class="line">				<span class="keyword">unsigned</span> <span class="keyword">long</span>		dev_scratch;</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span>		<span class="title">rbnode</span>;</span> <span class="comment">/* used in netem, ip4 defrag, and tcp stack */</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">list</span>;</span></span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">sock</span>		*<span class="title">sk</span>;</span> <span class="comment">/* 与缓冲区关联的sock */</span></span><br><span class="line">		<span class="keyword">int</span>			ip_defrag_offset;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="keyword">ktime_t</span>		tstamp;</span><br><span class="line">		u64		skb_mstamp_ns; <span class="comment">/* earliest departure time */</span></span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="keyword">char</span>			cb[<span class="number">48</span>] __aligned(<span class="number">8</span>);</span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">			<span class="keyword">unsigned</span> <span class="keyword">long</span>	_skb_refdst;</span><br><span class="line">			<span class="keyword">void</span>		(*destructor)(struct sk_buff *skb);</span><br><span class="line">		&#125;;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">tcp_tsorted_anchor</span>;</span></span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_XFRM</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span>	<span class="title">sec_path</span>	*<span class="title">sp</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(CONFIG_NF_CONNTRACK) || defined(CONFIG_NF_CONNTRACK_MODULE)</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		 _nfct;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> IS_ENABLED(CONFIG_BRIDGE_NETFILTER)</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nf_bridge_info</span>	*<span class="title">nf_bridge</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		len, data_len;</span><br><span class="line">	__u16			mac_len, hdr_len;</span><br><span class="line">	__u16			queue_mapping;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* if you move cloned around you also must adapt those constants */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __BIG_ENDIAN_BITFIELD</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLONED_MASK	(1 &lt;&lt; 7)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLONED_MASK	1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLONED_OFFSET()		offsetof(struct sk_buff, __cloned_offset)</span></span><br><span class="line"></span><br><span class="line">	__u8			__cloned_offset[<span class="number">0</span>];</span><br><span class="line">	__u8			cloned:<span class="number">1</span>,</span><br><span class="line">                    nohdr:<span class="number">1</span>,</span><br><span class="line">                    fclone:<span class="number">2</span>,</span><br><span class="line">                    peeked:<span class="number">1</span>,</span><br><span class="line">                    head_frag:<span class="number">1</span>,</span><br><span class="line">                    xmit_more:<span class="number">1</span>,</span><br><span class="line">                    pfmemalloc:<span class="number">1</span>;</span><br><span class="line">	<span class="comment">/* private: */</span></span><br><span class="line">	__u32			headers_start[<span class="number">0</span>];</span><br><span class="line">	<span class="comment">/* public: */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* if you move pkt_type around you also must adapt those constants */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __BIG_ENDIAN_BITFIELD</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PKT_TYPE_MAX	(7 &lt;&lt; 5)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PKT_TYPE_MAX	7</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PKT_TYPE_OFFSET()	offsetof(struct sk_buff, __pkt_type_offset)</span></span><br><span class="line"></span><br><span class="line">	__u8			__pkt_type_offset[<span class="number">0</span>];</span><br><span class="line">	__u8			pkt_type:<span class="number">3</span>;</span><br><span class="line">	__u8			ignore_df:<span class="number">1</span>;</span><br><span class="line">	__u8			nf_trace:<span class="number">1</span>;</span><br><span class="line">	__u8			ip_summed:<span class="number">2</span>;</span><br><span class="line">	__u8			ooo_okay:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	__u8			l4_hash:<span class="number">1</span>;</span><br><span class="line">	__u8			sw_hash:<span class="number">1</span>;</span><br><span class="line">	__u8			wifi_acked_valid:<span class="number">1</span>;</span><br><span class="line">	__u8			wifi_acked:<span class="number">1</span>;</span><br><span class="line">	__u8			no_fcs:<span class="number">1</span>;</span><br><span class="line">	<span class="comment">/* Indicates the inner headers are valid in the skbuff. */</span></span><br><span class="line">	__u8			encapsulation:<span class="number">1</span>;</span><br><span class="line">	__u8			encap_hdr_csum:<span class="number">1</span>;</span><br><span class="line">	__u8			csum_valid:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	__u8			csum_complete_sw:<span class="number">1</span>;</span><br><span class="line">	__u8			csum_level:<span class="number">2</span>;</span><br><span class="line">	__u8			csum_not_inet:<span class="number">1</span>;</span><br><span class="line">	__u8			dst_pending_confirm:<span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_IPV6_NDISC_NODETYPE</span></span><br><span class="line">	__u8			ndisc_nodetype:<span class="number">2</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	__u8			ipvs_property:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	__u8			inner_protocol_type:<span class="number">1</span>;</span><br><span class="line">	__u8			remcsum_offload:<span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NET_SWITCHDEV</span></span><br><span class="line">	__u8			offload_fwd_mark:<span class="number">1</span>;</span><br><span class="line">	__u8			offload_mr_fwd_mark:<span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NET_CLS_ACT</span></span><br><span class="line">	__u8			tc_skip_classify:<span class="number">1</span>;</span><br><span class="line">	__u8			tc_at_ingress:<span class="number">1</span>;</span><br><span class="line">	__u8			tc_redirected:<span class="number">1</span>;</span><br><span class="line">	__u8			tc_from_ingress:<span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_TLS_DEVICE</span></span><br><span class="line">	__u8			decrypted:<span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NET_SCHED</span></span><br><span class="line">	__u16			tc_index;	<span class="comment">/* traffic control index */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		__wsum		csum;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">			__u16	csum_start;</span><br><span class="line">			__u16	csum_offset;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;;</span><br><span class="line">	__u32			priority;</span><br><span class="line">	<span class="keyword">int</span>			skb_iif;</span><br><span class="line">	__u32			hash;</span><br><span class="line">	__be16			vlan_proto;</span><br><span class="line">	__u16			vlan_tci;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(CONFIG_NET_RX_BUSY_POLL) || defined(CONFIG_XPS)</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">int</span>	napi_id;</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">int</span>	sender_cpu;</span><br><span class="line">	&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NETWORK_SECMARK</span></span><br><span class="line">	__u32		secmark;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		__u32		mark;</span><br><span class="line">		__u32		reserved_tailroom;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		__be16		inner_protocol;</span><br><span class="line">		__u8		inner_ipproto;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	__u16			inner_transport_header;</span><br><span class="line">	__u16			inner_network_header;</span><br><span class="line">	__u16			inner_mac_header;</span><br><span class="line"></span><br><span class="line">	__be16			protocol;</span><br><span class="line">	__u16			transport_header;</span><br><span class="line">	__u16			network_header;</span><br><span class="line">	__u16			mac_header;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* private: */</span></span><br><span class="line">	__u32			headers_end[<span class="number">0</span>];</span><br><span class="line">	<span class="comment">/* public: */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* These elements must be at the end, see alloc_skb() for details.  */</span></span><br><span class="line">	<span class="keyword">sk_buff_data_t</span>		tail;</span><br><span class="line">	<span class="keyword">sk_buff_data_t</span>		end;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span>		*head,</span><br><span class="line">				*data;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		truesize;</span><br><span class="line">	<span class="keyword">refcount_t</span>		users;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>Conversions</strong></p>
<p>在不同的系统中，有几种方法可以对单词中的字节进行排序（字节序），包括：</p>
<ul>
<li>Big Endian 大端</li>
<li>Little Endian 小端</li>
</ul>
<p>由于网络将系统与不同的平台互连，因此互联网已经为数字数据的存储强加了一个标准的顺序，被称为 network byte-order 网络字节顺序</p>
<ul>
<li>网络字节序就是 Big Endian 大端字节序 </li>
<li>对于转换大小端，我们使用以下宏：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">u16 <span class="title">htons</span><span class="params">(u16 x)</span> <span class="comment">/* 将16位整数从主机字节顺序转换为网络字节顺序 */</span></span></span><br><span class="line"><span class="function">u32 <span class="title">htonl</span><span class="params">(u32 x)</span> <span class="comment">/* 将32位整数从主机字节顺序转换为网络字节顺序 */</span></span></span><br><span class="line"><span class="function">u16 <span class="title">ntohs</span><span class="params">(u16 x)</span> <span class="comment">/* 将16位整数从网络字节顺序转换为主机字节顺序 */</span></span></span><br><span class="line"><span class="function">u32 <span class="title">ntohl</span><span class="params">(u32 x)</span> <span class="comment">/* 将32位整数从网络字节顺序转换为主机字节顺序 */</span></span></span><br></pre></td></tr></table></figure>
<p><strong>netfilter</strong></p>
<p>网络过滤器 netfilter 是内核接口的名称，用于捕获网络数据包以修改/分析它们（用于过滤，NAT等）</p>
<p>用户空间通过 iptable 使用网络过滤器接口</p>
<p>在 Linux 内核中，使用网络过滤器的数据包捕获是通过附加钩子来完成的：</p>
<ul>
<li>可以根据需要在路径中的不同位置指定钩子，后跟内核网络数据包</li>
<li>可以在此处找到组织结构图，其中包含路线后跟包裹以及钩子的可能区域</li>
</ul>
<p>钩子 hook 是通过以下结构定义的：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">nf_hookfn</span><span class="params">(<span class="keyword">void</span> *priv,</span></span></span><br><span class="line"><span class="params"><span class="function">			       struct sk_buff *skb,</span></span></span><br><span class="line"><span class="params"><span class="function">			       <span class="keyword">const</span> struct nf_hook_state *state)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nf_hook_ops</span> &#123;</span></span><br><span class="line">      nf_hookfn               *hook; <span class="comment">/* 捕获网络数据包(作为结构发送的数据包)时,调用的处理程序(该字段是传递给处理程序的私有信息) */</span></span><br><span class="line">      <span class="class"><span class="keyword">struct</span> <span class="title">net_device</span>       *<span class="title">dev</span>;</span> <span class="comment">/* 要捕获的设备(网络接口) */</span></span><br><span class="line">      <span class="keyword">void</span>                    *priv; </span><br><span class="line">      <span class="keyword">u_int8_t</span>                pf; <span class="comment">/* 包装类型(PF_INET等) */</span></span><br><span class="line">      <span class="keyword">unsigned</span> <span class="keyword">int</span>            hooknum; <span class="comment">/* hook编号 */</span></span><br><span class="line">      <span class="keyword">int</span>                     priority; <span class="comment">/* 优先级 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>钩子函数 hook 的签名中有一个 <code>nf_hook_state</code> 结构体，用于描述 hook 的状态信息，关键条目如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nf_hook_state</span> &#123;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> hook;	   <span class="comment">/* hook编号 */</span></span><br><span class="line">	<span class="keyword">u_int8_t</span> pf; 		  <span class="comment">/* 包装类型 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">net_device</span> *<span class="title">in</span>;</span> <span class="comment">/* 输入接口 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">net_device</span> *<span class="title">out</span>;</span> <span class="comment">/* 输出接口 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk</span>;</span> <span class="comment">/* 对应的sock(INET套接字) */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">net</span> *<span class="title">net</span>;</span>  <span class="comment">/* 对应的net(内核网络命名空间) */</span></span><br><span class="line">	<span class="keyword">int</span> (*okfn)(struct net *, struct sock *, struct sk_buff *);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>相关 API 如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">nf_register_net_hook</span><span class="params">(struct net *net, <span class="keyword">const</span> struct nf_hook_ops *ops)</span></span>; <span class="comment">/* 用于注册挂钩点 */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">nf_unregister_net_hook</span><span class="params">(struct net *net, <span class="keyword">const</span> struct nf_hook_ops *ops)</span></span>; <span class="comment">/* 用于注销挂钩点 */</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">nf_register_net_hooks</span><span class="params">(struct net *net, <span class="keyword">const</span> struct nf_hook_ops *reg,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="keyword">unsigned</span> <span class="keyword">int</span> n)</span></span>; <span class="comment">/* 调用n次nf_register_net_hook */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">nf_unregister_net_hooks</span><span class="params">(struct net *net, <span class="keyword">const</span> struct nf_hook_ops *reg,</span></span></span><br><span class="line"><span class="params"><span class="function">                           <span class="keyword">unsigned</span> <span class="keyword">int</span> n)</span></span>; <span class="comment">/* 调用n次nf_unregister_net_hook */</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">nf_register_net_hooks</span><span class="params">(struct net *net, <span class="keyword">const</span> struct nf_hook_ops *reg,</span></span></span><br><span class="line"><span class="params"><span class="function">			  <span class="keyword">unsigned</span> <span class="keyword">int</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> i;</span><br><span class="line">	<span class="keyword">int</span> err = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">		err = nf_register_net_hook(net, &amp;reg[i]);</span><br><span class="line">		<span class="keyword">if</span> (err)</span><br><span class="line">			<span class="keyword">goto</span> err;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">err:</span><br><span class="line">	<span class="keyword">if</span> (i &gt; <span class="number">0</span>)</span><br><span class="line">		nf_unregister_net_hooks(net, reg, i);</span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(nf_register_net_hooks);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">nf_unregister_net_hooks</span><span class="params">(struct net *net, <span class="keyword">const</span> struct nf_hook_ops *reg,</span></span></span><br><span class="line"><span class="params"><span class="function">			     <span class="keyword">unsigned</span> <span class="keyword">int</span> hookcount)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; hookcount; i++)</span><br><span class="line">		nf_unregister_net_hook(net, &amp;reg[i]);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(nf_unregister_net_hooks);</span><br></pre></td></tr></table></figure>
<p>使用案例如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/netfilter.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/netfilter_ipv4.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/net.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/skbuff.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/ip.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/tcp.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">my_nf_hookfn</span><span class="params">(<span class="keyword">void</span> *priv,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 struct sk_buff *skb,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 <span class="keyword">const</span> struct nf_hook_state *state)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iphdr</span> *<span class="title">iph</span> =</span> ip_hdr(skb); <span class="comment">/* IP header */</span></span><br><span class="line">    <span class="comment">/* iph-&gt;saddr  - source IP address */</span></span><br><span class="line">    <span class="comment">/* iph-&gt;daddr  - destination IP address */</span></span><br><span class="line">    <span class="keyword">if</span> (iph-&gt;protocol == IPPROTO_TCP &amp;&amp; test_daddr(iph-&gt;daddr)) &#123;              </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">tcphdr</span> *<span class="title">tcph</span> =</span> tcp_hdr(skb); <span class="comment">/* TCP header */</span></span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (iph-&gt;protocol == IPPROTO_UDP) &#123;      </span><br><span class="line">        struct udphdr *udph = udp_hdr(skb); <span class="comment">/* UDP header */</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NF_ACCEPT;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">nf_hook_ops</span> <span class="title">my_nfho</span> =</span> &#123;</span><br><span class="line">    .hook        = my_nf_hookfn,</span><br><span class="line">    .hooknum     = NF_INET_LOCAL_OUT,</span><br><span class="line">    .pf          = PF_INET,</span><br><span class="line">    .priority    = NF_IP_PRI_FIRST</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> __init <span class="title">my_hook_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> nf_register_net_hook(&amp;init_net, &amp;my_nfho);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> __exit <span class="title">my_hook_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    nf_unregister_net_hook(&amp;init_net, &amp;my_nfho);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(my_hook_init);</span><br><span class="line">module_exit(my_hook_exit);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>netcat</strong></p>
<p>在开发包含网络代码的应用程序时，最常用的工具之一是 netcat（也被称为“用于 TCP/IP 的瑞士军刀”），它允许：</p>
<ul>
<li>启动 TCP 连接</li>
<li>等待 TCP 连接</li>
<li>发送和接收 UDP 数据包</li>
<li>以十六进制转储格式显示流量</li>
<li>建立连接后运行程序（例如，shell）</li>
<li>在已发送的包中设置特殊选项</li>
</ul>
<p><strong>Exercises</strong></p>
<p>要解决练习，您需要执行以下步骤：</p>
<ul>
<li>从模板准备 skeletons </li>
<li>构建模块</li>
<li>将模块复制到虚拟机</li>
<li>启动 VM 并在 VM 中测试模块</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">make clean</span><br><span class="line">LABS=networking make skels</span><br><span class="line">make build</span><br></pre></td></tr></table></figure>
<p>1.netfilter：</p>
<ul>
<li>编写一个内核模块，该模块显示启动出站连接的 TCP 数据包的源地址和端口</li>
<li>可以通过 MY_IOCTL_FILTER_ADDRESS ioctl 调用来指定目标地址</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * SO2 - Networking Lab (#10)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Exercise #1, #2: simple netfilter module</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Code skeleton.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/uaccess.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/atomic.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/netfilter.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/netfilter_ipv4.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/net.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/skbuff.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/ip.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/tcp.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;filter.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;Simple netfilter module&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;SO2&quot;</span>);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOG_LEVEL		KERN_ALERT</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MY_DEVICE		<span class="meta-string">&quot;filter&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">my_cdev</span>;</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">atomic_t</span> ioctl_set;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> ioctl_set_addr;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Test ioctl_set_addr if it has been set.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">test_daddr</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> dst_addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* TODO 2: return non-zero if address has been set</span></span><br><span class="line"><span class="comment">	 * *and* matches dst_addr</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (atomic_read(&amp;ioctl_set) == <span class="number">1</span>)</span><br><span class="line">		ret = (ioctl_set_addr == dst_addr);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		ret = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* TODO 1: netfilter hook function */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">my_nf_hookfn</span><span class="params">(<span class="keyword">void</span> *priv,</span></span></span><br><span class="line"><span class="params"><span class="function">            struct sk_buff *skb,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="keyword">const</span> struct nf_hook_state *state)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">iphdr</span> *<span class="title">iph</span> =</span> ip_hdr(skb);  </span><br><span class="line">    </span><br><span class="line">	<span class="keyword">if</span> (iph-&gt;protocol == IPPROTO_TCP &amp;&amp; test_daddr(iph-&gt;daddr)) &#123;              </span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">tcphdr</span> *<span class="title">tcph</span> =</span> tcp_hdr(skb); </span><br><span class="line">		<span class="keyword">if</span> (tcph-&gt;syn &amp;&amp; !tcph-&gt;ack)</span><br><span class="line">			printk(LOG_LEVEL <span class="string">&quot;IP address is %pI4:%u\n&quot;</span>, &amp;iph-&gt;saddr,ntohs(tcph-&gt;source));</span><br><span class="line">	&#125; </span><br><span class="line">	</span><br><span class="line">    <span class="keyword">return</span> NF_ACCEPT;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">my_open</span><span class="params">(struct inode *inode, struct file *file)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">my_close</span><span class="params">(struct inode *inode, struct file *file)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">my_ioctl</span><span class="params">(struct file *file, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line">	<span class="keyword">case</span> MY_IOCTL_FILTER_ADDRESS:</span><br><span class="line">		<span class="comment">/* TODO 2: set filter address from arg */</span></span><br><span class="line">		<span class="keyword">if</span>(copy_from_user(&amp;ioctl_set_addr,(<span class="keyword">void</span>*)arg,<span class="keyword">sizeof</span>(ioctl_set_addr)))&#123;</span><br><span class="line">			<span class="keyword">return</span> -EFAULT;</span><br><span class="line">		&#125;</span><br><span class="line">		atomic_set(&amp;ioctl_set,<span class="number">1</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="keyword">return</span> -ENOTTY;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">my_fops</span> =</span> &#123;</span><br><span class="line">	.owner = THIS_MODULE,</span><br><span class="line">	.open = my_open,</span><br><span class="line">	.release = my_close,</span><br><span class="line">	.unlocked_ioctl = my_ioctl</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* TODO 1: define netfilter hook operations structure */</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">nf_hook_ops</span> <span class="title">my_nfho</span> =</span> &#123;</span><br><span class="line">	.hook = my_nf_hookfn,</span><br><span class="line">	.hooknum = NF_INET_LOCAL_OUT,</span><br><span class="line">	.pf = PF_INET,</span><br><span class="line">	.priority = NF_IP_PRI_FIRST</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> __init <span class="title">my_hook_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* register filter device */</span></span><br><span class="line">	err = register_chrdev_region(MKDEV(MY_MAJOR, <span class="number">0</span>), <span class="number">1</span>, MY_DEVICE);</span><br><span class="line">	<span class="keyword">if</span> (err != <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">	atomic_set(&amp;ioctl_set, <span class="number">0</span>);</span><br><span class="line">	ioctl_set_addr = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* init &amp; add device */</span></span><br><span class="line">	cdev_init(&amp;my_cdev, &amp;my_fops);</span><br><span class="line">	cdev_add(&amp;my_cdev, MKDEV(MY_MAJOR, <span class="number">0</span>), <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* TODO 1: register netfilter hook */</span></span><br><span class="line">	err = nf_register_net_hook(&amp;init_net,&amp;my_nfho);</span><br><span class="line">	<span class="keyword">if</span> (err)</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line">	<span class="comment">/* cleanup */</span></span><br><span class="line">	cdev_del(&amp;my_cdev);</span><br><span class="line">	unregister_chrdev_region(MKDEV(MY_MAJOR, <span class="number">0</span>), <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> __exit <span class="title">my_hook_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">/* TODO 1: unregister hook */</span></span><br><span class="line">	nf_unregister_net_hook(&amp;init_net,&amp;my_nfho);</span><br><span class="line">	<span class="comment">/* cleanup device */</span></span><br><span class="line">	cdev_del(&amp;my_cdev);</span><br><span class="line">	unregister_chrdev_region(MKDEV(MY_MAJOR, <span class="number">0</span>), <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(my_hook_init);</span><br><span class="line">module_exit(my_hook_exit);</span><br></pre></td></tr></table></figure>
<ul>
<li>结果：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@qemux86:~/skels/networking/<span class="number">1</span><span class="number">-2</span>-netfilter/user# ./test<span class="number">-1.</span>sh                 </span><br><span class="line">filter: loading out-of-tree <span class="keyword">module</span> taints kernel.                               </span><br><span class="line">IP address is <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">45934</span>                                                   </span><br><span class="line">Should show up in filter.                                                       </span><br><span class="line">Check dmesg output.   </span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@qemux86:~/skels/networking/<span class="number">1</span><span class="number">-2</span>-netfilter/user# ./test<span class="number">-2.</span>sh                 </span><br><span class="line">IP address is <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">45936</span>                                                   </span><br><span class="line">Should show up in filter.                                                       </span><br><span class="line">Should NOT show up in filter.                                                   </span><br><span class="line">Check dmesg output.  </span><br></pre></td></tr></table></figure>
<ul>
<li>使用 <code>nc</code> 命令时，hook 函数 <code>my_nf_hookfn</code> 被执行了</li>
<li>当 <code>my_ioctl</code> 的 MY_IOCTL_FILTER_ADDRESS 命令执行以后，效验模块开启，由于 <code>ioctl_set_addr != iph-&gt;daddr</code> 因此 hook 函数没有执行</li>
<li>PS：当时眼瞎把 <code>nf_hook_ops</code> 初始化错了，导致后面一直报错，调试了很久</li>
</ul>
<p>2.tcp-sock：</p>
<ul>
<li>编写一个内核模块，该模块创建一个 TCP 套接字，该套接字侦听环回接口上的端口 60000 上的连接（以 init_module 为单位）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * SO2 - Networking Lab (#10)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Exercise #3, #4: simple kernel TCP socket</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Code skeleton.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/net.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;net/sock.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;Simple kernel TCP socket&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;SO2&quot;</span>);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOG_LEVEL		KERN_ALERT</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MY_TCP_PORT		60000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LISTEN_BACKLOG		5</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ON			1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> OFF			0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEBUG			ON</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> DEBUG == ON</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOG(s)					\</span></span><br><span class="line"><span class="meta">	do &#123;					\</span></span><br><span class="line"><span class="meta">		printk(KERN_DEBUG s <span class="meta-string">&quot;\n&quot;</span>);	\</span></span><br><span class="line"><span class="meta">	&#125; while (0)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOG(s)					\</span></span><br><span class="line"><span class="meta">	do &#123;&#125; while (0)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> print_sock_address(addr)		\</span></span><br><span class="line"><span class="meta">	do &#123;					\</span></span><br><span class="line"><span class="meta">		printk(LOG_LEVEL <span class="meta-string">&quot;connection established to &quot;</span>	\</span></span><br><span class="line"><span class="meta">				<span class="meta-string">&quot;%pI4:%d\n&quot;</span>,	 		\</span></span><br><span class="line"><span class="meta">				&amp;addr.sin_addr.s_addr,		\</span></span><br><span class="line"><span class="meta">				ntohs(addr.sin_port));		\</span></span><br><span class="line"><span class="meta">	&#125; while (0)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">socket</span> *<span class="title">sock</span>;</span>	<span class="comment">/* listening (server) socket */</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">socket</span> *<span class="title">new_sock</span>;</span>	<span class="comment">/* communication socket */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> __init <span class="title">my_tcp_sock_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line">	<span class="comment">/* address to bind on */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">addr</span> =</span> &#123;</span><br><span class="line">		.sin_family	= AF_INET,</span><br><span class="line">		.sin_port	= htons(MY_TCP_PORT),</span><br><span class="line">		.sin_addr	= &#123; htonl(INADDR_LOOPBACK) &#125;</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="keyword">int</span> addrlen = <span class="keyword">sizeof</span>(addr);</span><br><span class="line">	<span class="comment">/* address of peer */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">raddr</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* TODO 1: create listening socket */</span></span><br><span class="line">	err = sock_create_kern(&amp;init_net, PF_INET, SOCK_STREAM, IPPROTO_TCP, &amp;sock);</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		printk(<span class="string">&quot;socket create wrong&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/* TODO 1: bind socket to loopback on port MY_TCP_PORT */</span></span><br><span class="line">	err = sock-&gt;ops-&gt;bind(sock, (struct sockaddr *) &amp;addr, <span class="keyword">sizeof</span>(addr));</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		printk(<span class="string">&quot;bind wrong!&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> out_release;             </span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">/* TODO 1: start listening */</span></span><br><span class="line">	err = sock-&gt;ops-&gt;listen(sock, LISTEN_BACKLOG);</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		printk(<span class="string">&quot;listen wrong!&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> out_release;             </span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">/* TODO 2: create new socket for the accepted connection */</span></span><br><span class="line">	err = sock_create_lite(PF_INET, SOCK_STREAM, IPPROTO_TCP, &amp;new_sock);</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		printk(<span class="string">&quot;create socket&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">	&#125;</span><br><span class="line">	new_sock-&gt;ops = sock-&gt;ops;</span><br><span class="line">	<span class="comment">/* TODO 2: accept a connection */</span></span><br><span class="line">	err = sock-&gt;ops-&gt;accept(sock, new_sock, <span class="number">0</span>, <span class="literal">true</span>);</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		printk(<span class="string">&quot;accept wrong&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> out_release_new_sock;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/* TODO 2: get the address of the peer and print it */</span></span><br><span class="line">	err = sock-&gt;ops-&gt;getname(new_sock, (struct sockaddr *) &amp;raddr, <span class="number">1</span>);</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		printk(<span class="string">&quot;not find name&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> out_release_new_sock;</span><br><span class="line">	&#125;</span><br><span class="line">	print_sock_address(raddr);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">out_release_new_sock:</span><br><span class="line">	<span class="comment">/* TODO 2: cleanup socket for accepted connection */</span></span><br><span class="line">	sock_release(new_sock);</span><br><span class="line">out_release:</span><br><span class="line">	<span class="comment">/* TODO 1: cleanup listening socket */</span></span><br><span class="line">	sock_release(sock);</span><br><span class="line">out:</span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> __exit <span class="title">my_tcp_sock_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">/* TODO 2: cleanup socket for accepted connection */</span></span><br><span class="line">	sock_release(new_sock);</span><br><span class="line">	<span class="comment">/* TODO 1: cleanup listening socket */</span></span><br><span class="line">	sock_release(sock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(my_tcp_sock_init);</span><br><span class="line">module_exit(my_tcp_sock_exit);</span><br></pre></td></tr></table></figure>
<ul>
<li>PS：这里的 <code>sock-&gt;ops-&gt;bind</code> <code>sock-&gt;ops-&gt;listen</code> <code>sock-&gt;ops-&gt;accept</code> 就是用户态同名函数的底层实现</li>
<li>结果：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@qemux86:~/skels/networking/<span class="number">3</span><span class="number">-4</span>-tcp-sock# ./test<span class="number">-4.</span>sh                       </span><br><span class="line">+ sleep <span class="number">1</span>                                                                       </span><br><span class="line">+ insmod tcp_sock.ko                                                            </span><br><span class="line">+ netstat -<span class="function">tuan                                                                 </span></span><br><span class="line"><span class="function">Active Internet <span class="title">connections</span> <span class="params">(servers <span class="keyword">and</span> established)</span>                           </span></span><br><span class="line"><span class="function">Proto Recv-Q Send-Q Local Address           Foreign Address         State       </span></span><br><span class="line"><span class="function">tcp        0      0 127.0.0.1:60000         0.0.0.0:*               LISTEN      </span></span><br><span class="line"><span class="function">+ echo+ sleep 3                                                                 </span></span><br><span class="line"><span class="function">+ ../netcat -q 4 127.0.0.1 60000 Should connect.                                </span></span><br><span class="line"><span class="function"> -p 60001                                                                       </span></span><br><span class="line"><span class="function">accept wrong                                                                    </span></span><br><span class="line"><span class="function">connection established to 127.0.0.1:60001                                       </span></span><br><span class="line"><span class="function">+ rmmod tcp_sock     </span></span><br></pre></td></tr></table></figure>
<ul>
<li>成功监听了目标端口</li>
</ul>
<p>3.udp-sock：</p>
<ul>
<li>编写一个内核模块，用于创建 UDP 套接字，并将消息从套接字上的 MY_TEST_MESSAGE 宏发送到端口 60001 上的环回地址</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * SO2 - Networking Lab (#10)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Bonus: simple kernel UDP socket</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Code skeleton.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/net.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;net/sock.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;Simple kernel UDP socket&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;SO2&quot;</span>);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOG_LEVEL		KERN_ALERT</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MY_UDP_LOCAL_PORT	60000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MY_UDP_REMOTE_PORT	60001</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MY_TEST_MESSAGE		<span class="meta-string">&quot;kernelsocket\n&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ON			1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> OFF			0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEBUG			ON</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> DEBUG == ON</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOG(s)					\</span></span><br><span class="line"><span class="meta">	do &#123;					\</span></span><br><span class="line"><span class="meta">		printk(KERN_DEBUG s <span class="meta-string">&quot;\n&quot;</span>);	\</span></span><br><span class="line"><span class="meta">	&#125; while (0)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOG(s)					\</span></span><br><span class="line"><span class="meta">	do &#123;&#125; while (0)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> print_sock_address(addr)		\</span></span><br><span class="line"><span class="meta">	do &#123;					\</span></span><br><span class="line"><span class="meta">		printk(LOG_LEVEL <span class="meta-string">&quot;connection established to &quot;</span>	\</span></span><br><span class="line"><span class="meta">				NIPQUAD_FMT <span class="meta-string">&quot;:%d\n&quot;</span>, 		\</span></span><br><span class="line"><span class="meta">				NIPQUAD(addr.sin_addr.s_addr),	\</span></span><br><span class="line"><span class="meta">				ntohs(addr.sin_port));		\</span></span><br><span class="line"><span class="meta">	&#125; while (0)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">socket</span> *<span class="title">sock</span>;</span>	<span class="comment">/* UDP server */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* send datagram */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">my_udp_msgsend</span><span class="params">(struct socket *s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">/* address to send to */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">raddr</span> =</span> &#123;</span><br><span class="line">		.sin_family	= AF_INET,</span><br><span class="line">		.sin_port	= htons(MY_UDP_REMOTE_PORT),</span><br><span class="line">		.sin_addr	= &#123; htonl(INADDR_LOOPBACK) &#125;</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="keyword">int</span> raddrlen = <span class="keyword">sizeof</span>(raddr);</span><br><span class="line">	<span class="comment">/* message */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msghdr</span> <span class="title">msg</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">iov</span>;</span></span><br><span class="line">	<span class="keyword">char</span> *buffer = MY_TEST_MESSAGE;</span><br><span class="line">	<span class="keyword">int</span> len = <span class="built_in">strlen</span>(buffer) + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* TODO 1: build message */</span></span><br><span class="line">	iov.iov_base = buffer;</span><br><span class="line">	iov.iov_len = len;</span><br><span class="line">	msg.msg_flags = <span class="number">0</span>;</span><br><span class="line">	msg.msg_name = &amp;raddr;</span><br><span class="line">	msg.msg_namelen = raddrlen;</span><br><span class="line">	msg.msg_control = <span class="literal">NULL</span>;</span><br><span class="line">	msg.msg_controllen = <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/* TODO 1: send the message down the socket and return the</span></span><br><span class="line"><span class="comment">	 * error code.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">return</span> kernel_sendmsg(s, &amp;msg, (struct kvec *) &amp;iov, <span class="number">1</span>, len);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> __init <span class="title">my_udp_sock_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line">	<span class="comment">/* address to bind on */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">addr</span> =</span> &#123;</span><br><span class="line">		.sin_family	= AF_INET,</span><br><span class="line">		.sin_port	= htons(MY_UDP_LOCAL_PORT),</span><br><span class="line">		.sin_addr	= &#123; htonl(INADDR_LOOPBACK) &#125;</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="keyword">int</span> addrlen = <span class="keyword">sizeof</span>(addr);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* TODO 1: create UDP socket */</span></span><br><span class="line">	err = sock_create_kern(&amp;init_net, PF_INET, SOCK_DGRAM, IPPROTO_UDP, &amp;sock);</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		printk(LOG_LEVEL <span class="string">&quot;can&#x27;t create socket\n&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/* TODO 1: bind socket to loopback on port MY_UDP_LOCAL_PORT */</span></span><br><span class="line">	err = sock-&gt;ops-&gt;bind(sock, (struct sockaddr *) &amp;addr, addrlen);</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		printk(LOG_LEVEL <span class="string">&quot;can&#x27;t bind socket\n&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> out_release;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/* send message */</span></span><br><span class="line">	err = my_udp_msgsend(sock);</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		printk(LOG_LEVEL <span class="string">&quot;can&#x27;t send message\n&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> out_release;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">out_release:</span><br><span class="line">	<span class="comment">/* TODO 1: release socket */</span></span><br><span class="line">	sock_release(sock);</span><br><span class="line">out:</span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> __exit <span class="title">my_udp_sock_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">/* TODO 1: release socket */</span></span><br><span class="line">	sock_release(sock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(my_udp_sock_init);</span><br><span class="line">module_exit(my_udp_sock_exit);</span><br></pre></td></tr></table></figure>
<ul>
<li>本实验算一个比较套路的过程，把 <code>msghdr</code> 和 <code>iovec</code> 填充好就行了</li>
<li>结果：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@qemux86:~/skels/networking/<span class="number">5</span>-udp-sock# ./test<span class="number">-5.</span>sh                         </span><br><span class="line">+ pid=<span class="number">241</span>                                                                       </span><br><span class="line">+ sleep <span class="number">1</span>                                                                       </span><br><span class="line">+ ../netcat -l -u -p <span class="number">60001</span>                                                      </span><br><span class="line">+ insmod udp_sock.ko                                                            </span><br><span class="line">udp_sock: loading out-of-tree <span class="keyword">module</span> taints kernel.                             </span><br><span class="line">kernelsocket                                                                    </span><br><span class="line">+ rmmod udp_sock                                                                </span><br><span class="line">+ kill <span class="number">241</span>           </span><br></pre></td></tr></table></figure>
<ul>
<li>感觉本实验的侧重点是对协议栈 API 的使用</li>
<li>之后有时间去专门分析一下这些 API 的底层，了解一下协议堆栈具体的处理过程</li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/labs/" rel="tag"><i class="fa fa-tag"></i> labs</a>
              <a href="/tags/Kernel/" rel="tag"><i class="fa fa-tag"></i> Kernel</a>
              <a href="/tags/Linux/" rel="tag"><i class="fa fa-tag"></i> Linux</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/10/19/Linux-Lab7-File%20system%20drivers/" rel="prev" title="Linux-Lab7-File system drivers">
      <i class="fa fa-chevron-left"></i> Linux-Lab7-File system drivers
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/10/23/Linux-Lab9-Kernel%20Development%20on%20ARM/" rel="next" title="Linux-Lab9-Kernel Development on ARM">
      Linux-Lab9-Kernel Development on ARM <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yhellow"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">yhellow</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">221</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">134</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yhellow</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">2.9m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">44:08</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
